multiline_comment|/*&n; * sysfs.c - The filesystem to export kernel objects.&n; *&n; * Copyright (c) 2001, 2002 Patrick Mochel&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; *&n; * This is a simple, ramfs-based filesystem, designed to export kernel &n; * objects, their attributes, and the linkgaes between each other.&n; *&n; * Please see Documentation/filesystems/sysfs.txt for more information.&n; */
DECL|macro|DEBUG
macro_line|#undef DEBUG 
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/dcache.h&gt;
macro_line|#include &lt;linux/namei.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/backing-dev.h&gt;
macro_line|#include &lt;linux/kobject.h&gt;
macro_line|#include &lt;linux/mount.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
multiline_comment|/* Random magic number */
DECL|macro|SYSFS_MAGIC
mdefine_line|#define SYSFS_MAGIC 0x62656572
DECL|variable|sysfs_ops
r_static
r_struct
id|super_operations
id|sysfs_ops
suffix:semicolon
DECL|variable|sysfs_file_operations
r_static
r_struct
id|file_operations
id|sysfs_file_operations
suffix:semicolon
DECL|variable|sysfs_aops
r_static
r_struct
id|address_space_operations
id|sysfs_aops
suffix:semicolon
DECL|variable|sysfs_mount
r_static
r_struct
id|vfsmount
op_star
id|sysfs_mount
suffix:semicolon
DECL|variable|sysfs_backing_dev_info
r_static
r_struct
id|backing_dev_info
id|sysfs_backing_dev_info
op_assign
(brace
dot
id|ra_pages
op_assign
l_int|0
comma
multiline_comment|/* No readahead */
dot
id|memory_backed
op_assign
l_int|1
comma
multiline_comment|/* Does not contribute to dirty memory */
)brace
suffix:semicolon
DECL|function|sysfs_get_inode
r_static
r_struct
id|inode
op_star
id|sysfs_get_inode
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
id|mode
comma
r_int
id|dev
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|new_inode
c_func
(paren
id|sb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode
)paren
(brace
id|inode-&gt;i_mode
op_assign
id|mode
suffix:semicolon
id|inode-&gt;i_uid
op_assign
id|current-&gt;fsuid
suffix:semicolon
id|inode-&gt;i_gid
op_assign
id|current-&gt;fsgid
suffix:semicolon
id|inode-&gt;i_blksize
op_assign
id|PAGE_CACHE_SIZE
suffix:semicolon
id|inode-&gt;i_blocks
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_rdev
op_assign
id|NODEV
suffix:semicolon
id|inode-&gt;i_atime
op_assign
id|inode-&gt;i_mtime
op_assign
id|inode-&gt;i_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|inode-&gt;i_mapping-&gt;a_ops
op_assign
op_amp
id|sysfs_aops
suffix:semicolon
id|inode-&gt;i_mapping-&gt;backing_dev_info
op_assign
op_amp
id|sysfs_backing_dev_info
suffix:semicolon
r_switch
c_cond
(paren
id|mode
op_amp
id|S_IFMT
)paren
(brace
r_default
suffix:colon
id|init_special_inode
c_func
(paren
id|inode
comma
id|mode
comma
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|S_IFREG
suffix:colon
id|inode-&gt;i_fop
op_assign
op_amp
id|sysfs_file_operations
suffix:semicolon
r_break
suffix:semicolon
r_case
id|S_IFDIR
suffix:colon
id|inode-&gt;i_op
op_assign
op_amp
id|simple_dir_inode_operations
suffix:semicolon
id|inode-&gt;i_fop
op_assign
op_amp
id|simple_dir_operations
suffix:semicolon
multiline_comment|/* directory inodes start off with i_nlink == 2 (for &quot;.&quot; entry) */
id|inode-&gt;i_nlink
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|S_IFLNK
suffix:colon
id|inode-&gt;i_op
op_assign
op_amp
id|page_symlink_inode_operations
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|inode
suffix:semicolon
)brace
DECL|function|sysfs_mknod
r_static
r_int
id|sysfs_mknod
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|mode
comma
id|dev_t
id|dev
)paren
(brace
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dentry-&gt;d_inode
)paren
(brace
id|inode
op_assign
id|sysfs_get_inode
c_func
(paren
id|dir-&gt;i_sb
comma
id|mode
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode
)paren
(brace
id|d_instantiate
c_func
(paren
id|dentry
comma
id|inode
)paren
suffix:semicolon
id|dget
c_func
(paren
id|dentry
)paren
suffix:semicolon
)brace
r_else
id|error
op_assign
op_minus
id|ENOSPC
suffix:semicolon
)brace
r_else
id|error
op_assign
op_minus
id|EEXIST
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|sysfs_mkdir
r_static
r_int
id|sysfs_mkdir
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|mode
)paren
(brace
r_int
id|res
suffix:semicolon
id|mode
op_assign
(paren
id|mode
op_amp
(paren
id|S_IRWXUGO
op_or
id|S_ISVTX
)paren
)paren
op_or
id|S_IFDIR
suffix:semicolon
id|res
op_assign
id|sysfs_mknod
c_func
(paren
id|dir
comma
id|dentry
comma
id|mode
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
id|dir-&gt;i_nlink
op_increment
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|sysfs_create
r_static
r_int
id|sysfs_create
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|mode
)paren
(brace
r_int
id|res
suffix:semicolon
id|mode
op_assign
(paren
id|mode
op_amp
id|S_IALLUGO
)paren
op_or
id|S_IFREG
suffix:semicolon
id|res
op_assign
id|sysfs_mknod
c_func
(paren
id|dir
comma
id|dentry
comma
id|mode
comma
l_int|0
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|sysfs_symlink
r_static
r_int
id|sysfs_symlink
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_const
r_char
op_star
id|symname
)paren
(brace
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_int
id|error
op_assign
op_minus
id|ENOSPC
suffix:semicolon
r_if
c_cond
(paren
id|dentry-&gt;d_inode
)paren
r_return
op_minus
id|EEXIST
suffix:semicolon
id|inode
op_assign
id|sysfs_get_inode
c_func
(paren
id|dir-&gt;i_sb
comma
id|S_IFLNK
op_or
id|S_IRWXUGO
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode
)paren
(brace
r_int
id|l
op_assign
id|strlen
c_func
(paren
id|symname
)paren
op_plus
l_int|1
suffix:semicolon
id|error
op_assign
id|page_symlink
c_func
(paren
id|inode
comma
id|symname
comma
id|l
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
(brace
id|d_instantiate
c_func
(paren
id|dentry
comma
id|inode
)paren
suffix:semicolon
id|dget
c_func
(paren
id|dentry
)paren
suffix:semicolon
)brace
r_else
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
r_return
id|error
suffix:semicolon
)brace
DECL|macro|to_subsys
mdefine_line|#define to_subsys(k) container_of(k,struct subsystem,kobj)
DECL|macro|to_sattr
mdefine_line|#define to_sattr(a) container_of(a,struct subsys_attribute,attr)
multiline_comment|/**&n; * Subsystem file operations.&n; * These operations allow subsystems to have files that can be &n; * read/written. &n; */
DECL|function|subsys_attr_show
id|ssize_t
id|subsys_attr_show
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
comma
r_struct
id|attribute
op_star
id|attr
comma
r_char
op_star
id|page
comma
r_int
id|count
comma
id|loff_t
id|off
)paren
(brace
r_struct
id|subsystem
op_star
id|s
op_assign
id|to_subsys
c_func
(paren
id|kobj
)paren
suffix:semicolon
r_struct
id|subsys_attribute
op_star
id|sattr
op_assign
id|to_sattr
c_func
(paren
id|attr
)paren
suffix:semicolon
id|ssize_t
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sattr-&gt;show
)paren
id|ret
op_assign
id|sattr
op_member_access_from_pointer
id|show
c_func
(paren
id|s
comma
id|page
comma
id|count
comma
id|off
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|subsys_attr_store
id|ssize_t
id|subsys_attr_store
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
comma
r_struct
id|attribute
op_star
id|attr
comma
r_const
r_char
op_star
id|page
comma
r_int
id|count
comma
id|loff_t
id|off
)paren
(brace
r_struct
id|subsystem
op_star
id|s
op_assign
id|to_subsys
c_func
(paren
id|kobj
)paren
suffix:semicolon
r_struct
id|subsys_attribute
op_star
id|sattr
op_assign
id|to_sattr
c_func
(paren
id|attr
)paren
suffix:semicolon
id|ssize_t
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sattr-&gt;store
)paren
id|ret
op_assign
id|sattr
op_member_access_from_pointer
id|store
c_func
(paren
id|s
comma
id|page
comma
id|count
comma
id|off
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|subsys_sysfs_ops
r_static
r_struct
id|sysfs_ops
id|subsys_sysfs_ops
op_assign
(brace
dot
id|show
op_assign
id|subsys_attr_show
comma
dot
id|store
op_assign
id|subsys_attr_store
comma
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;sysfs_read_file - read an attribute. &n; *&t;@file:&t;file pointer.&n; *&t;@buf:&t;buffer to fill.&n; *&t;@count:&t;number of bytes to read.&n; *&t;@ppos:&t;starting offset in file.&n; *&n; *&t;Userspace wants to read an attribute file. The attribute descriptor&n; *&t;is in the file&squot;s -&gt;d_fsdata. The target object is in the directory&squot;s&n; *&t;-&gt;d_fsdata. &n; *&n; *&t;We allocate a %PAGE_SIZE buffer, and pass it to the object&squot;s -&gt;show()&n; *&t;method (along with the object). We loop doing this until @count is &n; *&t;satisfied, or -&gt;show() returns %0. &n; */
r_static
id|ssize_t
DECL|function|sysfs_read_file
id|sysfs_read_file
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|attribute
op_star
id|attr
op_assign
id|file-&gt;f_dentry-&gt;d_fsdata
suffix:semicolon
r_struct
id|sysfs_ops
op_star
id|ops
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|kobject
op_star
id|kobj
op_assign
id|file-&gt;f_dentry-&gt;d_parent-&gt;d_fsdata
suffix:semicolon
r_int
r_char
op_star
id|page
suffix:semicolon
id|ssize_t
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
id|PAGE_SIZE
)paren
id|count
op_assign
id|PAGE_SIZE
suffix:semicolon
id|page
op_assign
(paren
r_int
r_char
op_star
)paren
id|__get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
id|ssize_t
id|len
suffix:semicolon
id|len
op_assign
id|ops
op_member_access_from_pointer
id|show
c_func
(paren
id|kobj
comma
id|attr
comma
id|page
comma
id|count
comma
op_star
id|ppos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|retval
op_assign
id|len
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buf
comma
id|page
comma
id|len
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
op_star
id|ppos
op_add_assign
id|len
suffix:semicolon
id|count
op_sub_assign
id|len
suffix:semicolon
id|buf
op_add_assign
id|len
suffix:semicolon
id|retval
op_add_assign
id|len
suffix:semicolon
)brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;sysfs_write_file - write an attribute.&n; *&t;@file:&t;file pointer&n; *&t;@buf:&t;data to write&n; *&t;@count:&t;number of bytes&n; *&t;@ppos:&t;starting offset&n; *&n; *&t;Identical to sysfs_read_file(), though going the opposite direction.&n; *&t;We allocate a %PAGE_SIZE buffer and copy in the userspace buffer. We&n; *&t;pass that to the object&squot;s -&gt;store() method until we reach @count or &n; *&t;-&gt;store() returns %0 or less.&n; */
r_static
id|ssize_t
DECL|function|sysfs_write_file
id|sysfs_write_file
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|attribute
op_star
id|attr
op_assign
id|file-&gt;f_dentry-&gt;d_fsdata
suffix:semicolon
r_struct
id|sysfs_ops
op_star
id|ops
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|kobject
op_star
id|kobj
op_assign
id|file-&gt;f_dentry-&gt;d_parent-&gt;d_fsdata
suffix:semicolon
id|ssize_t
id|retval
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|page
suffix:semicolon
id|page
op_assign
(paren
r_char
op_star
)paren
id|__get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|count
op_ge
id|PAGE_SIZE
)paren
id|count
op_assign
id|PAGE_SIZE
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|page
comma
id|buf
comma
id|count
)paren
)paren
r_goto
id|done
suffix:semicolon
op_star
(paren
id|page
op_plus
id|count
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
id|ssize_t
id|len
suffix:semicolon
id|len
op_assign
id|ops
op_member_access_from_pointer
id|store
c_func
(paren
id|kobj
comma
id|attr
comma
id|page
op_plus
id|retval
comma
id|count
comma
op_star
id|ppos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|retval
op_assign
id|len
suffix:semicolon
r_break
suffix:semicolon
)brace
id|retval
op_add_assign
id|len
suffix:semicolon
id|count
op_sub_assign
id|len
suffix:semicolon
op_star
id|ppos
op_add_assign
id|len
suffix:semicolon
id|buf
op_add_assign
id|len
suffix:semicolon
)brace
id|done
suffix:colon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|check_perm
r_static
r_int
id|check_perm
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|kobject
op_star
id|kobj
op_assign
id|kobject_get
c_func
(paren
id|file-&gt;f_dentry-&gt;d_parent-&gt;d_fsdata
)paren
suffix:semicolon
r_struct
id|attribute
op_star
id|attr
op_assign
id|file-&gt;f_dentry-&gt;d_fsdata
suffix:semicolon
r_struct
id|sysfs_ops
op_star
id|ops
op_assign
l_int|NULL
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|kobj
op_logical_or
op_logical_neg
id|attr
)paren
r_goto
id|Einval
suffix:semicolon
multiline_comment|/* if the kobject has no ktype, then we assume that it is a subsystem&n;&t; * itself, and use ops for it.&n;&t; */
r_if
c_cond
(paren
id|kobj-&gt;ktype
)paren
id|ops
op_assign
id|kobj-&gt;ktype-&gt;sysfs_ops
suffix:semicolon
r_else
id|ops
op_assign
op_amp
id|subsys_sysfs_ops
suffix:semicolon
multiline_comment|/* No sysfs operations, either from having no subsystem,&n;&t; * or the subsystem have no operations.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|ops
)paren
r_goto
id|Eaccess
suffix:semicolon
multiline_comment|/* File needs write support.&n;&t; * The inode&squot;s perms must say it&squot;s ok, &n;&t; * and we must have a store method.&n;&t; */
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|inode-&gt;i_mode
op_amp
id|S_IWUGO
)paren
)paren
r_goto
id|Eperm
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ops-&gt;store
)paren
r_goto
id|Eaccess
suffix:semicolon
)brace
multiline_comment|/* File needs read support.&n;&t; * The inode&squot;s perms must say it&squot;s ok, and we there&n;&t; * must be a show method for it.&n;&t; */
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|inode-&gt;i_mode
op_amp
id|S_IRUGO
)paren
)paren
r_goto
id|Eperm
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ops-&gt;show
)paren
r_goto
id|Eaccess
suffix:semicolon
)brace
multiline_comment|/* No error? Great, store the ops in file-&gt;private_data&n;&t; * for easy access in the read/write functions.&n;&t; */
id|file-&gt;private_data
op_assign
id|ops
suffix:semicolon
r_goto
id|Done
suffix:semicolon
id|Einval
suffix:colon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|Done
suffix:semicolon
id|Eaccess
suffix:colon
id|error
op_assign
op_minus
id|EACCES
suffix:semicolon
r_goto
id|Done
suffix:semicolon
id|Eperm
suffix:colon
id|error
op_assign
op_minus
id|EPERM
suffix:semicolon
id|Done
suffix:colon
r_return
id|error
suffix:semicolon
)brace
DECL|function|sysfs_open_file
r_static
r_int
id|sysfs_open_file
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_return
id|check_perm
c_func
(paren
id|inode
comma
id|filp
)paren
suffix:semicolon
)brace
DECL|function|sysfs_release
r_static
r_int
id|sysfs_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|kobject
op_star
id|kobj
op_assign
id|filp-&gt;f_dentry-&gt;d_parent-&gt;d_fsdata
suffix:semicolon
r_if
c_cond
(paren
id|kobj
)paren
id|kobject_put
c_func
(paren
id|kobj
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sysfs_file_operations
r_static
r_struct
id|file_operations
id|sysfs_file_operations
op_assign
(brace
dot
id|read
op_assign
id|sysfs_read_file
comma
dot
id|write
op_assign
id|sysfs_write_file
comma
dot
id|llseek
op_assign
id|generic_file_llseek
comma
dot
id|open
op_assign
id|sysfs_open_file
comma
dot
id|release
op_assign
id|sysfs_release
comma
)brace
suffix:semicolon
DECL|variable|sysfs_aops
r_static
r_struct
id|address_space_operations
id|sysfs_aops
op_assign
(brace
dot
id|readpage
op_assign
id|simple_readpage
comma
dot
id|prepare_write
op_assign
id|simple_prepare_write
comma
dot
id|commit_write
op_assign
id|simple_commit_write
)brace
suffix:semicolon
DECL|variable|sysfs_ops
r_static
r_struct
id|super_operations
id|sysfs_ops
op_assign
(brace
dot
id|statfs
op_assign
id|simple_statfs
comma
dot
id|drop_inode
op_assign
id|generic_delete_inode
comma
)brace
suffix:semicolon
DECL|function|sysfs_fill_super
r_static
r_int
id|sysfs_fill_super
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_void
op_star
id|data
comma
r_int
id|silent
)paren
(brace
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|dentry
op_star
id|root
suffix:semicolon
id|sb-&gt;s_blocksize
op_assign
id|PAGE_CACHE_SIZE
suffix:semicolon
id|sb-&gt;s_blocksize_bits
op_assign
id|PAGE_CACHE_SHIFT
suffix:semicolon
id|sb-&gt;s_magic
op_assign
id|SYSFS_MAGIC
suffix:semicolon
id|sb-&gt;s_op
op_assign
op_amp
id|sysfs_ops
suffix:semicolon
id|inode
op_assign
id|sysfs_get_inode
c_func
(paren
id|sb
comma
id|S_IFDIR
op_or
l_int|0755
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;%s: could not get inode!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|root
op_assign
id|d_alloc_root
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|root
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;%s: could not get root dentry!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|sb-&gt;s_root
op_assign
id|root
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sysfs_get_sb
r_static
r_struct
id|super_block
op_star
id|sysfs_get_sb
c_func
(paren
r_struct
id|file_system_type
op_star
id|fs_type
comma
r_int
id|flags
comma
r_char
op_star
id|dev_name
comma
r_void
op_star
id|data
)paren
(brace
r_return
id|get_sb_single
c_func
(paren
id|fs_type
comma
id|flags
comma
id|data
comma
id|sysfs_fill_super
)paren
suffix:semicolon
)brace
DECL|variable|sysfs_fs_type
r_static
r_struct
id|file_system_type
id|sysfs_fs_type
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;sysfs&quot;
comma
dot
id|get_sb
op_assign
id|sysfs_get_sb
comma
dot
id|kill_sb
op_assign
id|kill_litter_super
comma
)brace
suffix:semicolon
DECL|function|sysfs_init
r_static
r_int
id|__init
id|sysfs_init
c_func
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
id|err
op_assign
id|register_filesystem
c_func
(paren
op_amp
id|sysfs_fs_type
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|sysfs_mount
op_assign
id|kern_mount
c_func
(paren
op_amp
id|sysfs_fs_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|sysfs_mount
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sysfs: could not mount!&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
id|PTR_ERR
c_func
(paren
id|sysfs_mount
)paren
suffix:semicolon
id|sysfs_mount
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_return
id|err
suffix:semicolon
)brace
DECL|variable|sysfs_init
id|core_initcall
c_func
(paren
id|sysfs_init
)paren
suffix:semicolon
DECL|function|get_dentry
r_static
r_struct
id|dentry
op_star
id|get_dentry
c_func
(paren
r_struct
id|dentry
op_star
id|parent
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_struct
id|qstr
id|qstr
suffix:semicolon
id|qstr.name
op_assign
id|name
suffix:semicolon
id|qstr.len
op_assign
id|strlen
c_func
(paren
id|name
)paren
suffix:semicolon
id|qstr.hash
op_assign
id|full_name_hash
c_func
(paren
id|name
comma
id|qstr.len
)paren
suffix:semicolon
r_return
id|lookup_hash
c_func
(paren
op_amp
id|qstr
comma
id|parent
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;sysfs_create_dir - create a directory for an object.&n; *&t;@parent:&t;parent parent object.&n; *&t;@kobj:&t;&t;object we&squot;re creating directory for. &n; */
DECL|function|sysfs_create_dir
r_int
id|sysfs_create_dir
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
)paren
(brace
r_struct
id|dentry
op_star
id|dentry
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|dentry
op_star
id|parent
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|kobj
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|kobj-&gt;parent
)paren
id|parent
op_assign
id|kobj-&gt;parent-&gt;dentry
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sysfs_mount
op_logical_and
id|sysfs_mount-&gt;mnt_sb
)paren
id|parent
op_assign
id|sysfs_mount-&gt;mnt_sb-&gt;s_root
suffix:semicolon
r_else
r_return
op_minus
id|EFAULT
suffix:semicolon
id|down
c_func
(paren
op_amp
id|parent-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|dentry
op_assign
id|get_dentry
c_func
(paren
id|parent
comma
id|kobj-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_ERR
c_func
(paren
id|dentry
)paren
)paren
(brace
id|dentry-&gt;d_fsdata
op_assign
(paren
r_void
op_star
)paren
id|kobj
suffix:semicolon
id|kobj-&gt;dentry
op_assign
id|dentry
suffix:semicolon
id|error
op_assign
id|sysfs_mkdir
c_func
(paren
id|parent-&gt;d_inode
comma
id|dentry
comma
(paren
id|S_IFDIR
op_or
id|S_IRWXU
op_or
id|S_IRUGO
op_or
id|S_IXUGO
)paren
)paren
suffix:semicolon
)brace
r_else
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|parent-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;sysfs_create_file - create an attribute file for an object.&n; *&t;@kobj:&t;object we&squot;re creating for. &n; *&t;@attr:&t;atrribute descriptor.&n; */
DECL|function|sysfs_create_file
r_int
id|sysfs_create_file
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
comma
r_struct
id|attribute
op_star
id|attr
)paren
(brace
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
r_struct
id|dentry
op_star
id|parent
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|kobj
op_logical_or
op_logical_neg
id|attr
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|parent
op_assign
id|kobj-&gt;dentry
suffix:semicolon
id|down
c_func
(paren
op_amp
id|parent-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|dentry
op_assign
id|get_dentry
c_func
(paren
id|parent
comma
id|attr-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_ERR
c_func
(paren
id|dentry
)paren
)paren
(brace
id|dentry-&gt;d_fsdata
op_assign
(paren
r_void
op_star
)paren
id|attr
suffix:semicolon
id|error
op_assign
id|sysfs_create
c_func
(paren
id|parent-&gt;d_inode
comma
id|dentry
comma
id|attr-&gt;mode
)paren
suffix:semicolon
)brace
r_else
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|parent-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|object_depth
r_static
r_int
id|object_depth
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
)paren
(brace
r_struct
id|kobject
op_star
id|p
op_assign
id|kobj
suffix:semicolon
r_int
id|depth
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|depth
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|p
op_assign
id|p-&gt;parent
)paren
)paren
suffix:semicolon
r_return
id|depth
suffix:semicolon
)brace
DECL|function|object_path_length
r_static
r_int
id|object_path_length
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
)paren
(brace
r_struct
id|kobject
op_star
id|p
op_assign
id|kobj
suffix:semicolon
r_int
id|length
op_assign
l_int|1
suffix:semicolon
r_do
(brace
id|length
op_add_assign
id|strlen
c_func
(paren
id|p-&gt;name
)paren
op_plus
l_int|1
suffix:semicolon
id|p
op_assign
id|p-&gt;parent
suffix:semicolon
)brace
r_while
c_loop
(paren
id|p
)paren
suffix:semicolon
r_return
id|length
suffix:semicolon
)brace
DECL|function|fill_object_path
r_static
r_void
id|fill_object_path
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
comma
r_char
op_star
id|buffer
comma
r_int
id|length
)paren
(brace
r_struct
id|kobject
op_star
id|p
suffix:semicolon
op_decrement
id|length
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|kobj
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;parent
)paren
(brace
r_int
id|cur
op_assign
id|strlen
c_func
(paren
id|p-&gt;name
)paren
suffix:semicolon
multiline_comment|/* back up enough to print this bus id with &squot;/&squot; */
id|length
op_sub_assign
id|cur
suffix:semicolon
id|strncpy
c_func
(paren
id|buffer
op_plus
id|length
comma
id|p-&gt;name
comma
id|cur
)paren
suffix:semicolon
op_star
(paren
id|buffer
op_plus
op_decrement
id|length
)paren
op_assign
l_char|&squot;/&squot;
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; *&t;sysfs_create_link - create symlink between two objects.&n; *&t;@kobj:&t;object whose directory we&squot;re creating the link in.&n; *&t;@target:&t;object we&squot;re pointing to.&n; *&t;@name:&t;&t;name of the symlink.&n; */
DECL|function|sysfs_create_link
r_int
id|sysfs_create_link
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
comma
r_struct
id|kobject
op_star
id|target
comma
r_char
op_star
id|name
)paren
(brace
r_struct
id|dentry
op_star
id|dentry
op_assign
id|kobj-&gt;dentry
suffix:semicolon
r_struct
id|dentry
op_star
id|d
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_int
id|size
suffix:semicolon
r_int
id|depth
suffix:semicolon
r_char
op_star
id|path
suffix:semicolon
r_char
op_star
id|s
suffix:semicolon
id|depth
op_assign
id|object_depth
c_func
(paren
id|kobj
)paren
suffix:semicolon
id|size
op_assign
id|object_path_length
c_func
(paren
id|target
)paren
op_plus
id|depth
op_star
l_int|3
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|PATH_MAX
)paren
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: depth = %d, size = %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|depth
comma
id|size
)paren
suffix:semicolon
id|path
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|path
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|path
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
r_for
c_loop
(paren
id|s
op_assign
id|path
suffix:semicolon
id|depth
op_decrement
suffix:semicolon
id|s
op_add_assign
l_int|3
)paren
id|strcpy
c_func
(paren
id|s
comma
l_string|&quot;../&quot;
)paren
suffix:semicolon
id|fill_object_path
c_func
(paren
id|target
comma
id|path
comma
id|size
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: path = &squot;%s&squot;&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|path
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dentry-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|d
op_assign
id|get_dentry
c_func
(paren
id|dentry
comma
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_ERR
c_func
(paren
id|d
)paren
)paren
id|error
op_assign
id|sysfs_symlink
c_func
(paren
id|dentry-&gt;d_inode
comma
id|d
comma
id|path
)paren
suffix:semicolon
r_else
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|d
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dentry-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|path
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|hash_and_remove
r_static
r_void
id|hash_and_remove
c_func
(paren
r_struct
id|dentry
op_star
id|dir
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_struct
id|dentry
op_star
id|victim
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|victim
op_assign
id|get_dentry
c_func
(paren
id|dir
comma
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_ERR
c_func
(paren
id|victim
)paren
)paren
(brace
multiline_comment|/* make sure dentry is really there */
r_if
c_cond
(paren
id|victim-&gt;d_inode
op_logical_and
(paren
id|victim-&gt;d_parent-&gt;d_inode
op_eq
id|dir-&gt;d_inode
)paren
)paren
(brace
id|simple_unlink
c_func
(paren
id|dir-&gt;d_inode
comma
id|victim
)paren
suffix:semicolon
id|d_delete
c_func
(paren
id|victim
)paren
suffix:semicolon
)brace
)brace
id|up
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;sysfs_remove_file - remove an object attribute.&n; *&t;@kobj:&t;object we&squot;re acting for.&n; *&t;@attr:&t;attribute descriptor.&n; *&n; *&t;Hash the attribute name and kill the victim.&n; */
DECL|function|sysfs_remove_file
r_void
id|sysfs_remove_file
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
comma
r_struct
id|attribute
op_star
id|attr
)paren
(brace
id|hash_and_remove
c_func
(paren
id|kobj-&gt;dentry
comma
id|attr-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;sysfs_remove_link - remove symlink in object&squot;s directory.&n; *&t;@kobj:&t;object we&squot;re acting for.&n; *&t;@name:&t;name of the symlink to remove.&n; */
DECL|function|sysfs_remove_link
r_void
id|sysfs_remove_link
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
comma
r_char
op_star
id|name
)paren
(brace
id|hash_and_remove
c_func
(paren
id|kobj-&gt;dentry
comma
id|name
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;sysfs_remove_dir - remove an object&squot;s directory.&n; *&t;@kobj:&t;object. &n; *&n; *&t;The only thing special about this is that we remove any files in &n; *&t;the directory before we remove the directory, and we&squot;ve inlined&n; *&t;what used to be sysfs_rmdir() below, instead of calling separately.&n; */
DECL|function|sysfs_remove_dir
r_void
id|sysfs_remove_dir
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
)paren
(brace
r_struct
id|list_head
op_star
id|node
comma
op_star
id|next
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
op_assign
id|kobj-&gt;dentry
suffix:semicolon
r_struct
id|dentry
op_star
id|parent
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dentry
)paren
r_return
suffix:semicolon
id|parent
op_assign
id|dget
c_func
(paren
id|dentry-&gt;d_parent
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|parent-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dentry-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|node
comma
id|next
comma
op_amp
id|dentry-&gt;d_subdirs
)paren
(brace
r_struct
id|dentry
op_star
id|d
op_assign
id|list_entry
c_func
(paren
id|node
comma
r_struct
id|dentry
comma
id|d_child
)paren
suffix:semicolon
multiline_comment|/* make sure dentry is still there */
r_if
c_cond
(paren
id|d-&gt;d_inode
)paren
(brace
id|simple_unlink
c_func
(paren
id|dentry-&gt;d_inode
comma
id|d
)paren
suffix:semicolon
id|d_delete
c_func
(paren
id|dentry
)paren
suffix:semicolon
)brace
)brace
id|up
c_func
(paren
op_amp
id|dentry-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|d_invalidate
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|simple_rmdir
c_func
(paren
id|parent-&gt;d_inode
comma
id|dentry
)paren
suffix:semicolon
id|d_delete
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|parent-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|dput
c_func
(paren
id|parent
)paren
suffix:semicolon
)brace
DECL|variable|sysfs_create_file
id|EXPORT_SYMBOL
c_func
(paren
id|sysfs_create_file
)paren
suffix:semicolon
DECL|variable|sysfs_remove_file
id|EXPORT_SYMBOL
c_func
(paren
id|sysfs_remove_file
)paren
suffix:semicolon
DECL|variable|sysfs_create_link
id|EXPORT_SYMBOL
c_func
(paren
id|sysfs_create_link
)paren
suffix:semicolon
DECL|variable|sysfs_remove_link
id|EXPORT_SYMBOL
c_func
(paren
id|sysfs_remove_link
)paren
suffix:semicolon
DECL|variable|sysfs_create_dir
id|EXPORT_SYMBOL
c_func
(paren
id|sysfs_create_dir
)paren
suffix:semicolon
DECL|variable|sysfs_remove_dir
id|EXPORT_SYMBOL
c_func
(paren
id|sysfs_remove_dir
)paren
suffix:semicolon
eof
