multiline_comment|/*&n; * uncompress.c&n; *&n; * (C) Copyright 1999 Linus Torvalds&n; *&n; * cramfs interfaces to the uncompression library. There&squot;s really just&n; * three entrypoints:&n; *&n; *  - cramfs_uncompress_init() - called to initialize the thing.&n; *  - cramfs_uncompress_exit() - tell me when you&squot;re done&n; *  - cramfs_uncompress_block() - uncompress a block.&n; *&n; * NOTE NOTE NOTE! The uncompression is entirely single-threaded. We&n; * only have one stream, and we&squot;ll initialize it only once even if it&n; * then is used by multiple filesystems.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/zlib_fs.h&gt;
DECL|variable|stream
r_static
id|z_stream
id|stream
suffix:semicolon
DECL|variable|initialized
r_static
r_int
id|initialized
suffix:semicolon
multiline_comment|/* Returns length of decompressed data. */
DECL|function|cramfs_uncompress_block
r_int
id|cramfs_uncompress_block
c_func
(paren
r_void
op_star
id|dst
comma
r_int
id|dstlen
comma
r_void
op_star
id|src
comma
r_int
id|srclen
)paren
(brace
r_int
id|err
suffix:semicolon
id|stream.next_in
op_assign
id|src
suffix:semicolon
id|stream.avail_in
op_assign
id|srclen
suffix:semicolon
id|stream.next_out
op_assign
id|dst
suffix:semicolon
id|stream.avail_out
op_assign
id|dstlen
suffix:semicolon
id|err
op_assign
id|zlib_fs_inflateReset
c_func
(paren
op_amp
id|stream
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|Z_OK
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;zlib_fs_inflateReset error %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
id|zlib_fs_inflateEnd
c_func
(paren
op_amp
id|stream
)paren
suffix:semicolon
id|zlib_fs_inflateInit
c_func
(paren
op_amp
id|stream
)paren
suffix:semicolon
)brace
id|err
op_assign
id|zlib_fs_inflate
c_func
(paren
op_amp
id|stream
comma
id|Z_FINISH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|Z_STREAM_END
)paren
r_goto
id|err
suffix:semicolon
r_return
id|stream.total_out
suffix:semicolon
id|err
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Error %d while decompressing!&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%p(%d)-&gt;%p(%d)&bslash;n&quot;
comma
id|src
comma
id|srclen
comma
id|dst
comma
id|dstlen
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cramfs_uncompress_init
r_int
id|cramfs_uncompress_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|initialized
op_increment
)paren
(brace
id|stream.workspace
op_assign
id|vmalloc
c_func
(paren
id|zlib_fs_inflate_workspacesize
c_func
(paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stream.workspace
)paren
(brace
id|initialized
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|stream.next_in
op_assign
l_int|NULL
suffix:semicolon
id|stream.avail_in
op_assign
l_int|0
suffix:semicolon
id|zlib_fs_inflateInit
c_func
(paren
op_amp
id|stream
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cramfs_uncompress_exit
r_int
id|cramfs_uncompress_exit
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|initialized
)paren
(brace
id|zlib_fs_inflateEnd
c_func
(paren
op_amp
id|stream
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|stream.workspace
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
