multiline_comment|/*&n; * Copyright (C) 1997, 2001 Ralf Baechle (ralf@gnu.org),&n; * derived from r4xx0.c by David S. Miller (dm@engr.sgi.com).&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/mipsregs.h&gt;
macro_line|#include &lt;asm/bcache.h&gt;
macro_line|#include &lt;asm/cacheops.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/mmu_context.h&gt;
multiline_comment|/* Secondary cache size in bytes, if present.  */
DECL|variable|scache_size
r_static
r_int
r_int
id|scache_size
suffix:semicolon
DECL|macro|SC_LINE
mdefine_line|#define SC_LINE 32
DECL|macro|SC_PAGE
mdefine_line|#define SC_PAGE (128*SC_LINE)
DECL|macro|cache_op
mdefine_line|#define cache_op(base,op)                   &bslash;&n;__asm__ __volatile__(&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;.set noreorder;                 &bslash;&n;&t;&t;.set mips3;                     &bslash;&n;&t;&t;cache %1, (%0);                 &bslash;&n;&t;&t;.set mips0;                     &bslash;&n;&t;&t;.set reorder&quot;                   &bslash;&n;&t;&t;:                               &bslash;&n;&t;&t;: &quot;r&quot; (base),                   &bslash;&n;&t;&t;  &quot;i&quot; (op));
DECL|function|blast_r5000_scache
r_static
r_inline
r_void
id|blast_r5000_scache
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|start
op_assign
id|KSEG0
suffix:semicolon
r_int
r_int
id|end
op_assign
id|KSEG0
op_plus
id|scache_size
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
id|cache_op
c_func
(paren
id|start
comma
id|R5K_Page_Invalidate_S
)paren
suffix:semicolon
id|start
op_add_assign
id|SC_PAGE
suffix:semicolon
)brace
)brace
DECL|function|r5k_dma_cache_inv_sc
r_static
r_void
id|r5k_dma_cache_inv_sc
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|end
comma
id|a
suffix:semicolon
r_if
c_cond
(paren
id|size
op_ge
id|scache_size
)paren
(brace
id|blast_r5000_scache
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* On the R5000 secondary cache we cannot&n;&t; * invalidate less than a page at a time.&n;&t; * The secondary cache is physically indexed, write-through.&n;&t; */
id|a
op_assign
id|addr
op_amp
op_complement
(paren
id|SC_PAGE
op_minus
l_int|1
)paren
suffix:semicolon
id|end
op_assign
(paren
id|addr
op_plus
id|size
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|SC_PAGE
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|a
op_le
id|end
)paren
(brace
id|cache_op
c_func
(paren
id|a
comma
id|R5K_Page_Invalidate_S
)paren
suffix:semicolon
id|a
op_add_assign
id|SC_PAGE
suffix:semicolon
)brace
)brace
DECL|function|r5k_sc_enable
r_static
r_void
id|r5k_sc_enable
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|change_c0_config
c_func
(paren
id|R5K_CONF_SE
comma
id|R5K_CONF_SE
)paren
suffix:semicolon
id|blast_r5000_scache
c_func
(paren
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|r5k_sc_disable
r_static
r_void
id|r5k_sc_disable
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|blast_r5000_scache
c_func
(paren
)paren
suffix:semicolon
id|change_c0_config
c_func
(paren
id|R5K_CONF_SE
comma
l_int|0
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|r5k_sc_probe
r_static
r_inline
r_int
id|__init
id|r5k_sc_probe
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|config
op_assign
id|read_c0_config
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|config
op_amp
id|CONF_SC
)paren
r_return
l_int|0
suffix:semicolon
id|scache_size
op_assign
(paren
l_int|512
op_star
l_int|1024
)paren
op_lshift
(paren
(paren
id|config
op_amp
id|R5K_CONF_SS
)paren
op_rshift
l_int|20
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;R5000 SCACHE size %ldkB, linesize 32 bytes.&bslash;n&quot;
comma
id|scache_size
op_rshift
l_int|10
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|variable|r5k_sc_ops
r_static
r_struct
id|bcache_ops
id|r5k_sc_ops
op_assign
(brace
dot
id|bc_enable
op_assign
id|r5k_sc_enable
comma
dot
id|bc_disable
op_assign
id|r5k_sc_disable
comma
dot
id|bc_wback_inv
op_assign
id|r5k_dma_cache_inv_sc
comma
dot
id|bc_inv
op_assign
id|r5k_dma_cache_inv_sc
)brace
suffix:semicolon
DECL|function|r5k_sc_init
r_void
id|__init
id|r5k_sc_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|r5k_sc_probe
c_func
(paren
)paren
)paren
(brace
id|r5k_sc_enable
c_func
(paren
)paren
suffix:semicolon
id|bcops
op_assign
op_amp
id|r5k_sc_ops
suffix:semicolon
)brace
)brace
eof
