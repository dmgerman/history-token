multiline_comment|/*&n; * Code to handle IP32 IRQs&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Copyright (C) 2000 Harald Koerfgen&n; * Copyright (C) 2001 Keith M Wesolowski&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel_stat.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/mipsregs.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/ip32/ip32_ints.h&gt;
macro_line|#include &lt;asm/ip32/crime.h&gt;
macro_line|#include &lt;asm/ip32/mace.h&gt;
macro_line|#include &lt;asm/signal.h&gt;
DECL|macro|DEBUG_IRQ
macro_line|#undef DEBUG_IRQ
macro_line|#ifdef DEBUG_IRQ
DECL|macro|DBG
mdefine_line|#define DBG(x...) printk(x)
macro_line|#else
DECL|macro|DBG
mdefine_line|#define DBG(x...)
macro_line|#endif
multiline_comment|/* O2 irq map&n; *&n; * IP0 -&gt; software (ignored)&n; * IP1 -&gt; software (ignored)&n; * IP2 -&gt; (irq0) C crime 1.1 all interrupts; crime 1.5 ???&n; * IP3 -&gt; (irq1) X unknown&n; * IP4 -&gt; (irq2) X unknown&n; * IP5 -&gt; (irq3) X unknown&n; * IP6 -&gt; (irq4) X unknown&n; * IP7 -&gt; (irq5) 0 CPU count/compare timer (system timer)&n; *&n; * crime: (C)&n; *&n; * CRIME_INT_STAT 31:0:&n; *&n; * 0 -&gt; 1 Video in 1&n; * 1 -&gt; 2 Video in 2&n; * 2 -&gt; 3 Video out&n; * 3 -&gt; 4 Mace ethernet&n; * 4 -&gt; S  SuperIO sub-interrupt&n; * 5 -&gt; M  Miscellaneous sub-interrupt&n; * 6 -&gt; A  Audio sub-interrupt&n; * 7 -&gt; 8  PCI bridge errors&n; * 8 -&gt; 9  PCI SCSI aic7xxx 0&n; * 9 -&gt; 10  PCI SCSI aic7xxx 1&n; * 10 -&gt; 11 PCI slot 0&n; * 11 -&gt; 12 unused (PCI slot 1)&n; * 12 -&gt; 13 unused (PCI slot 2)&n; * 13 -&gt; 14 unused (PCI shared 0)&n; * 14 -&gt; 15 unused (PCI shared 1)&n; * 15 -&gt; 16 unused (PCI shared 2)&n; * 16 -&gt; 17 GBE0 (E)&n; * 17 -&gt; 18 GBE1 (E)&n; * 18 -&gt; 19 GBE2 (E)&n; * 19 -&gt; 20 GBE3 (E)&n; * 20 -&gt; 21 CPU errors&n; * 21 -&gt; 22 Memory errors&n; * 22 -&gt; 23 RE empty edge (E)&n; * 23 -&gt; 24 RE full edge (E)&n; * 24 -&gt; 25 RE idle edge (E)&n; * 25 -&gt; 26 RE empty level&n; * 26 -&gt; 27 RE full level&n; * 27 -&gt; 28 RE idle level&n; * 28 -&gt; 29  unused (software 0) (E)&n; * 29 -&gt; 30  unused (software 1) (E)&n; * 30 -&gt; 31  unused (software 2) - crime 1.5 CPU SysCorError (E)&n; * 31 -&gt; 32 VICE&n; *&n; * S, M, A: Use the MACE ISA interrupt register&n; * MACE_ISA_INT_STAT 31:0&n; *&n; * 0-7 -&gt; 33-40 Audio&n; * 8 -&gt; 41 RTC&n; * 9 -&gt; 42 Keyboard&n; * 10 -&gt; X Keyboard polled&n; * 11 -&gt; 44 Mouse&n; * 12 -&gt; X Mouse polled&n; * 13-15 -&gt; 46-48 Count/compare timers&n; * 16-19 -&gt; 49-52 Parallel (16 E)&n; * 20-25 -&gt; 53-58 Serial 1 (22 E)&n; * 26-31 -&gt; 59-64 Serial 2 (28 E)&n; *&n; * Note that this means IRQs 5-7, 43, and 45 do not exist.  This is a&n; * different IRQ map than IRIX uses, but that&squot;s OK as Linux irq handling&n; * is quite different anyway.&n; */
multiline_comment|/* Some initial interrupts to set up */
r_extern
r_void
id|crime_memerr_intr
(paren
r_int
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_extern
r_void
id|crime_cpuerr_intr
(paren
r_int
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
DECL|variable|memerr_irq
r_struct
id|irqaction
id|memerr_irq
op_assign
(brace
id|crime_memerr_intr
comma
id|SA_INTERRUPT
comma
l_int|0
comma
l_string|&quot;CRIME memory error&quot;
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|cpuerr_irq
r_struct
id|irqaction
id|cpuerr_irq
op_assign
(brace
id|crime_cpuerr_intr
comma
id|SA_INTERRUPT
comma
l_int|0
comma
l_string|&quot;CRIME CPU error&quot;
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|spurious_count
r_int
r_int
id|spurious_count
op_assign
l_int|0
suffix:semicolon
r_extern
r_void
id|ip32_handle_int
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|do_IRQ
(paren
r_int
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
multiline_comment|/* For interrupts wired from a single device to the CPU.  Only the clock&n; * uses this it seems, which is IRQ 0 and IP7.&n; */
DECL|function|enable_cpu_irq
r_static
r_void
id|enable_cpu_irq
(paren
r_int
r_int
id|irq
)paren
(brace
id|set_cp0_status
(paren
id|STATUSF_IP7
)paren
suffix:semicolon
)brace
DECL|function|startup_cpu_irq
r_static
r_int
r_int
id|startup_cpu_irq
(paren
r_int
r_int
id|irq
)paren
(brace
id|enable_cpu_irq
(paren
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|disable_cpu_irq
r_static
r_void
id|disable_cpu_irq
(paren
r_int
r_int
id|irq
)paren
(brace
id|clear_cp0_status
(paren
id|STATUSF_IP7
)paren
suffix:semicolon
)brace
DECL|function|end_cpu_irq
r_static
r_void
id|end_cpu_irq
(paren
r_int
r_int
id|irq
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|irq_desc
(braket
id|irq
)braket
dot
id|status
op_amp
(paren
id|IRQ_DISABLED
op_or
id|IRQ_INPROGRESS
)paren
)paren
)paren
id|enable_cpu_irq
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|macro|shutdown_cpu_irq
mdefine_line|#define shutdown_cpu_irq disable_cpu_irq
DECL|macro|mask_and_ack_cpu_irq
mdefine_line|#define mask_and_ack_cpu_irq disable_cpu_irq
DECL|variable|ip32_cpu_interrupt
r_static
r_struct
id|hw_interrupt_type
id|ip32_cpu_interrupt
op_assign
(brace
l_string|&quot;IP32 CPU&quot;
comma
id|startup_cpu_irq
comma
id|shutdown_cpu_irq
comma
id|enable_cpu_irq
comma
id|disable_cpu_irq
comma
id|mask_and_ack_cpu_irq
comma
id|end_cpu_irq
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/*&n; * This is for pure CRIME interrupts - ie not MACE.  The advantage?&n; * We get to split the register in half and do faster lookups.&n; */
DECL|function|enable_crime_irq
r_static
r_void
id|enable_crime_irq
(paren
r_int
r_int
id|irq
)paren
(brace
id|u64
id|crime_mask
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
(paren
id|flags
)paren
suffix:semicolon
id|crime_mask
op_assign
id|crime_read_64
(paren
id|CRIME_INT_MASK
)paren
suffix:semicolon
id|crime_mask
op_or_assign
l_int|1
op_lshift
(paren
id|irq
op_minus
l_int|1
)paren
suffix:semicolon
id|crime_write_64
(paren
id|CRIME_INT_MASK
comma
id|crime_mask
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|startup_crime_irq
r_static
r_int
r_int
id|startup_crime_irq
(paren
r_int
r_int
id|irq
)paren
(brace
id|enable_crime_irq
(paren
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* This is probably not right; we could have pending irqs */
)brace
DECL|function|disable_crime_irq
r_static
r_void
id|disable_crime_irq
(paren
r_int
r_int
id|irq
)paren
(brace
id|u64
id|crime_mask
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
(paren
id|flags
)paren
suffix:semicolon
id|crime_mask
op_assign
id|crime_read_64
(paren
id|CRIME_INT_MASK
)paren
suffix:semicolon
id|crime_mask
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|irq
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|crime_write_64
(paren
id|CRIME_INT_MASK
comma
id|crime_mask
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|mask_and_ack_crime_irq
r_static
r_void
id|mask_and_ack_crime_irq
(paren
r_int
r_int
id|irq
)paren
(brace
id|u64
id|crime_mask
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Edge triggered interrupts must be cleared. */
r_if
c_cond
(paren
(paren
id|irq
op_le
id|CRIME_GBE0_IRQ
op_logical_and
id|irq
op_ge
id|CRIME_GBE3_IRQ
)paren
op_logical_or
(paren
id|irq
op_le
id|CRIME_RE_EMPTY_E_IRQ
op_logical_and
id|irq
op_ge
id|CRIME_RE_IDLE_E_IRQ
)paren
op_logical_or
(paren
id|irq
op_le
id|CRIME_SOFT0_IRQ
op_logical_and
id|irq
op_ge
id|CRIME_SOFT2_IRQ
)paren
)paren
(brace
id|save_and_cli
(paren
id|flags
)paren
suffix:semicolon
id|crime_mask
op_assign
id|crime_read_64
(paren
id|CRIME_HARD_INT
)paren
suffix:semicolon
id|crime_mask
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|irq
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|crime_write_64
(paren
id|CRIME_HARD_INT
comma
id|crime_mask
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
id|disable_crime_irq
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|end_crime_irq
r_static
r_void
id|end_crime_irq
(paren
r_int
r_int
id|irq
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|irq_desc
(braket
id|irq
)braket
dot
id|status
op_amp
(paren
id|IRQ_DISABLED
op_or
id|IRQ_INPROGRESS
)paren
)paren
)paren
id|enable_crime_irq
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|macro|shutdown_crime_irq
mdefine_line|#define shutdown_crime_irq disable_crime_irq
DECL|variable|ip32_crime_interrupt
r_static
r_struct
id|hw_interrupt_type
id|ip32_crime_interrupt
op_assign
(brace
l_string|&quot;IP32 CRIME&quot;
comma
id|startup_crime_irq
comma
id|shutdown_crime_irq
comma
id|enable_crime_irq
comma
id|disable_crime_irq
comma
id|mask_and_ack_crime_irq
comma
id|end_crime_irq
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/* This is for MACE PCI interrupts.  We can decrease bus traffic by masking&n; * as close to the source as possible.  This also means we can take the&n; * next chunk of the CRIME register in one piece.&n; */
DECL|function|enable_macepci_irq
r_static
r_void
id|enable_macepci_irq
(paren
r_int
r_int
id|irq
)paren
(brace
id|u32
id|mace_mask
suffix:semicolon
id|u64
id|crime_mask
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
(paren
id|flags
)paren
suffix:semicolon
id|mace_mask
op_assign
id|mace_read_32
(paren
id|MACEPCI_CONTROL
)paren
suffix:semicolon
id|mace_mask
op_or_assign
id|MACEPCI_CONTROL_INT
(paren
id|irq
op_minus
l_int|9
)paren
suffix:semicolon
id|mace_write_32
(paren
id|MACEPCI_CONTROL
comma
id|mace_mask
)paren
suffix:semicolon
multiline_comment|/* In case the CRIME interrupt isn&squot;t enabled, we must enable it;&n;&t; * however, we never disable interrupts at that level.&n;&t; */
id|crime_mask
op_assign
id|crime_read_64
(paren
id|CRIME_INT_MASK
)paren
suffix:semicolon
id|crime_mask
op_or_assign
l_int|1
op_lshift
(paren
id|irq
op_minus
l_int|1
)paren
suffix:semicolon
id|crime_write_64
(paren
id|CRIME_INT_MASK
comma
id|crime_mask
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|startup_macepci_irq
r_static
r_int
r_int
id|startup_macepci_irq
(paren
r_int
r_int
id|irq
)paren
(brace
id|enable_macepci_irq
(paren
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* XXX */
)brace
DECL|function|disable_macepci_irq
r_static
r_void
id|disable_macepci_irq
(paren
r_int
r_int
id|irq
)paren
(brace
id|u32
id|mace_mask
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
(paren
id|flags
)paren
suffix:semicolon
id|mace_mask
op_assign
id|mace_read_32
(paren
id|MACEPCI_CONTROL
)paren
suffix:semicolon
id|mace_mask
op_and_assign
op_complement
id|MACEPCI_CONTROL_INT
(paren
id|irq
op_minus
l_int|9
)paren
suffix:semicolon
id|mace_write_32
(paren
id|MACEPCI_CONTROL
comma
id|mace_mask
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|end_macepci_irq
r_static
r_void
id|end_macepci_irq
(paren
r_int
r_int
id|irq
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|irq_desc
(braket
id|irq
)braket
dot
id|status
op_amp
(paren
id|IRQ_DISABLED
op_or
id|IRQ_INPROGRESS
)paren
)paren
)paren
id|enable_macepci_irq
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|macro|shutdown_macepci_irq
mdefine_line|#define shutdown_macepci_irq disable_macepci_irq
DECL|macro|mask_and_ack_macepci_irq
mdefine_line|#define mask_and_ack_macepci_irq disable_macepci_irq
DECL|variable|ip32_macepci_interrupt
r_static
r_struct
id|hw_interrupt_type
id|ip32_macepci_interrupt
op_assign
(brace
l_string|&quot;IP32 MACE PCI&quot;
comma
id|startup_macepci_irq
comma
id|shutdown_macepci_irq
comma
id|enable_macepci_irq
comma
id|disable_macepci_irq
comma
id|mask_and_ack_macepci_irq
comma
id|end_macepci_irq
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/* This is used for MACE ISA interrupts.  That means bits 4-6 in the&n; * CRIME register.&n; */
DECL|function|enable_maceisa_irq
r_static
r_void
id|enable_maceisa_irq
(paren
r_int
r_int
id|irq
)paren
(brace
id|u64
id|crime_mask
suffix:semicolon
id|u32
id|mace_mask
suffix:semicolon
r_int
r_int
id|crime_int
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DBG
(paren
l_string|&quot;maceisa enable: %u&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|irq
)paren
(brace
r_case
id|MACEISA_AUDIO_SW_IRQ
dot
dot
dot
id|MACEISA_AUDIO3_MERR_IRQ
suffix:colon
id|crime_int
op_assign
id|MACE_AUDIO_INT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MACEISA_RTC_IRQ
dot
dot
dot
id|MACEISA_TIMER2_IRQ
suffix:colon
id|crime_int
op_assign
id|MACE_MISC_INT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MACEISA_PARALLEL_IRQ
dot
dot
dot
id|MACEISA_SERIAL2_RDMAOR_IRQ
suffix:colon
id|crime_int
op_assign
id|MACE_SUPERIO_INT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DBG
(paren
l_string|&quot;crime_int %016lx enabled&bslash;n&quot;
comma
id|crime_int
)paren
suffix:semicolon
id|save_and_cli
(paren
id|flags
)paren
suffix:semicolon
id|crime_mask
op_assign
id|crime_read_64
(paren
id|CRIME_INT_MASK
)paren
suffix:semicolon
id|crime_mask
op_or_assign
id|crime_int
suffix:semicolon
id|crime_write_64
(paren
id|CRIME_INT_MASK
comma
id|crime_mask
)paren
suffix:semicolon
id|mace_mask
op_assign
id|mace_read_32
(paren
id|MACEISA_INT_MASK
)paren
suffix:semicolon
id|mace_mask
op_or_assign
l_int|1
op_lshift
(paren
id|irq
op_minus
l_int|33
)paren
suffix:semicolon
id|mace_write_32
(paren
id|MACEISA_INT_MASK
comma
id|mace_mask
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|startup_maceisa_irq
r_static
r_int
r_int
id|startup_maceisa_irq
(paren
r_int
r_int
id|irq
)paren
(brace
id|enable_maceisa_irq
(paren
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|disable_maceisa_irq
r_static
r_void
id|disable_maceisa_irq
(paren
r_int
r_int
id|irq
)paren
(brace
id|u32
id|mace_mask
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
(paren
id|flags
)paren
suffix:semicolon
id|mace_mask
op_assign
id|mace_read_32
(paren
id|MACEISA_INT_MASK
)paren
suffix:semicolon
id|mace_mask
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|irq
op_minus
l_int|33
)paren
)paren
suffix:semicolon
id|mace_write_32
(paren
id|MACEISA_INT_MASK
comma
id|mace_mask
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|mask_and_ack_maceisa_irq
r_static
r_void
id|mask_and_ack_maceisa_irq
(paren
r_int
r_int
id|irq
)paren
(brace
id|u32
id|mace_mask
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_switch
c_cond
(paren
id|irq
)paren
(brace
r_case
id|MACEISA_PARALLEL_IRQ
suffix:colon
r_case
id|MACEISA_SERIAL1_TDMAPR_IRQ
suffix:colon
r_case
id|MACEISA_SERIAL2_TDMAPR_IRQ
suffix:colon
id|save_and_cli
(paren
id|flags
)paren
suffix:semicolon
id|mace_mask
op_assign
id|mace_read_32
(paren
id|MACEISA_INT_STAT
)paren
suffix:semicolon
id|mace_mask
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|irq
op_minus
l_int|33
)paren
)paren
suffix:semicolon
id|mace_write_32
(paren
id|MACEISA_INT_STAT
comma
id|mace_mask
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|disable_maceisa_irq
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|end_maceisa_irq
r_static
r_void
id|end_maceisa_irq
(paren
r_int
id|irq
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|irq_desc
(braket
id|irq
)braket
dot
id|status
op_amp
(paren
id|IRQ_DISABLED
op_or
id|IRQ_INPROGRESS
)paren
)paren
)paren
id|enable_maceisa_irq
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|macro|shutdown_maceisa_irq
mdefine_line|#define shutdown_maceisa_irq disable_maceisa_irq
DECL|variable|ip32_maceisa_interrupt
r_static
r_struct
id|hw_interrupt_type
id|ip32_maceisa_interrupt
op_assign
(brace
l_string|&quot;IP32 MACE ISA&quot;
comma
id|startup_maceisa_irq
comma
id|shutdown_maceisa_irq
comma
id|enable_maceisa_irq
comma
id|disable_maceisa_irq
comma
id|mask_and_ack_maceisa_irq
comma
id|end_maceisa_irq
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/* This is used for regular non-ISA, non-PCI MACE interrupts.  That means&n; * bits 0-3 and 7 in the CRIME register.&n; */
DECL|function|enable_mace_irq
r_static
r_void
id|enable_mace_irq
(paren
r_int
r_int
id|irq
)paren
(brace
id|u64
id|crime_mask
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
(paren
id|flags
)paren
suffix:semicolon
id|crime_mask
op_assign
id|crime_read_64
(paren
id|CRIME_INT_MASK
)paren
suffix:semicolon
id|crime_mask
op_or_assign
l_int|1
op_lshift
(paren
id|irq
op_minus
l_int|1
)paren
suffix:semicolon
id|crime_write_64
(paren
id|CRIME_INT_MASK
comma
id|crime_mask
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|startup_mace_irq
r_static
r_int
r_int
id|startup_mace_irq
(paren
r_int
r_int
id|irq
)paren
(brace
id|enable_mace_irq
(paren
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|disable_mace_irq
r_static
r_void
id|disable_mace_irq
(paren
r_int
r_int
id|irq
)paren
(brace
id|u64
id|crime_mask
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
(paren
id|flags
)paren
suffix:semicolon
id|crime_mask
op_assign
id|crime_read_64
(paren
id|CRIME_INT_MASK
)paren
suffix:semicolon
id|crime_mask
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|irq
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|crime_write_64
(paren
id|CRIME_INT_MASK
comma
id|crime_mask
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|end_mace_irq
r_static
r_void
id|end_mace_irq
(paren
r_int
r_int
id|irq
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|irq_desc
(braket
id|irq
)braket
dot
id|status
op_amp
(paren
id|IRQ_DISABLED
op_or
id|IRQ_INPROGRESS
)paren
)paren
)paren
id|enable_mace_irq
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|macro|shutdown_mace_irq
mdefine_line|#define shutdown_mace_irq disable_mace_irq
DECL|macro|mask_and_ack_mace_irq
mdefine_line|#define mask_and_ack_mace_irq disable_mace_irq
DECL|variable|ip32_mace_interrupt
r_static
r_struct
id|hw_interrupt_type
id|ip32_mace_interrupt
op_assign
(brace
l_string|&quot;IP32 MACE&quot;
comma
id|startup_mace_irq
comma
id|shutdown_mace_irq
comma
id|enable_mace_irq
comma
id|disable_mace_irq
comma
id|mask_and_ack_mace_irq
comma
id|end_mace_irq
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|ip32_unknown_interrupt
r_static
r_void
id|ip32_unknown_interrupt
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|u64
id|crime
suffix:semicolon
id|u32
id|mace
suffix:semicolon
id|printk
(paren
l_string|&quot;Unknown interrupt occurred!&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;cp0_status: %08x&bslash;tcp0_cause: %08x&bslash;n&quot;
comma
id|read_32bit_cp0_register
(paren
id|CP0_STATUS
)paren
comma
id|read_32bit_cp0_register
(paren
id|CP0_CAUSE
)paren
)paren
suffix:semicolon
id|crime
op_assign
id|crime_read_64
(paren
id|CRIME_INT_MASK
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;CRIME interrupt mask: %016lx&bslash;n&quot;
comma
id|crime
)paren
suffix:semicolon
id|crime
op_assign
id|crime_read_64
(paren
id|CRIME_INT_STAT
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;CRIME interrupt status: %016lx&bslash;n&quot;
comma
id|crime
)paren
suffix:semicolon
id|crime
op_assign
id|crime_read_64
(paren
id|CRIME_HARD_INT
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;CRIME hardware interrupt register: %016lx&bslash;n&quot;
comma
id|crime
)paren
suffix:semicolon
id|mace
op_assign
id|mace_read_32
(paren
id|MACEISA_INT_MASK
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;MACE ISA interrupt mask: %08x&bslash;n&quot;
comma
id|mace
)paren
suffix:semicolon
id|mace
op_assign
id|mace_read_32
(paren
id|MACEISA_INT_STAT
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;MACE ISA interrupt status: %08x&bslash;n&quot;
comma
id|mace
)paren
suffix:semicolon
id|mace
op_assign
id|mace_read_32
(paren
id|MACEPCI_CONTROL
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;MACE PCI control register: %08x&bslash;n&quot;
comma
id|mace
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;Register dump:&bslash;n&quot;
)paren
suffix:semicolon
id|show_regs
(paren
id|regs
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;Please mail this report to linux-mips@oss.sgi.com&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;Spinning...&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|ip32_irq_init
r_void
id|__init
id|ip32_irq_init
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|irq
suffix:semicolon
r_extern
r_void
id|init_generic_irq
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* Install our interrupt handler, then clear and disable all&n;&t; * CRIME and MACE interrupts.&n;&t; */
id|crime_write_64
(paren
id|CRIME_INT_MASK
comma
l_int|0
)paren
suffix:semicolon
id|crime_write_64
(paren
id|CRIME_HARD_INT
comma
l_int|0
)paren
suffix:semicolon
id|crime_write_64
(paren
id|CRIME_SOFT_INT
comma
l_int|0
)paren
suffix:semicolon
id|mace_write_32
(paren
id|MACEISA_INT_STAT
comma
l_int|0
)paren
suffix:semicolon
id|mace_write_32
(paren
id|MACEISA_INT_MASK
comma
l_int|0
)paren
suffix:semicolon
id|set_except_vector
c_func
(paren
l_int|0
comma
id|ip32_handle_int
)paren
suffix:semicolon
id|init_generic_irq
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|irq
op_assign
l_int|0
suffix:semicolon
id|irq
op_le
id|IP32_IRQ_MAX
suffix:semicolon
id|irq
op_increment
)paren
(brace
id|hw_irq_controller
op_star
id|controller
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_eq
id|CLOCK_IRQ
)paren
id|controller
op_assign
op_amp
id|ip32_cpu_interrupt
suffix:semicolon
r_else
r_if
c_cond
(paren
id|irq
op_le
id|MACE_PCI_BRIDGE_IRQ
op_logical_and
id|irq
op_ge
id|MACE_VID_IN1_IRQ
)paren
id|controller
op_assign
op_amp
id|ip32_mace_interrupt
suffix:semicolon
r_else
r_if
c_cond
(paren
id|irq
op_le
id|MACEPCI_SHARED2_IRQ
op_logical_and
id|irq
op_ge
id|MACEPCI_SCSI0_IRQ
)paren
id|controller
op_assign
op_amp
id|ip32_macepci_interrupt
suffix:semicolon
r_else
r_if
c_cond
(paren
id|irq
op_le
id|CRIME_VICE_IRQ
op_logical_and
id|irq
op_ge
id|CRIME_GBE0_IRQ
)paren
id|controller
op_assign
op_amp
id|ip32_crime_interrupt
suffix:semicolon
r_else
id|controller
op_assign
op_amp
id|ip32_maceisa_interrupt
suffix:semicolon
id|irq_desc
(braket
id|irq
)braket
dot
id|status
op_assign
id|IRQ_DISABLED
suffix:semicolon
id|irq_desc
(braket
id|irq
)braket
dot
id|action
op_assign
l_int|0
suffix:semicolon
id|irq_desc
(braket
id|irq
)braket
dot
id|depth
op_assign
l_int|0
suffix:semicolon
id|irq_desc
(braket
id|irq
)braket
dot
id|handler
op_assign
id|controller
suffix:semicolon
)brace
id|setup_irq
(paren
id|CRIME_MEMERR_IRQ
comma
op_amp
id|memerr_irq
)paren
suffix:semicolon
id|setup_irq
(paren
id|CRIME_CPUERR_IRQ
comma
op_amp
id|cpuerr_irq
)paren
suffix:semicolon
)brace
multiline_comment|/* CRIME 1.1 appears to deliver all interrupts to this one pin. */
DECL|function|ip32_irq0
r_void
id|ip32_irq0
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|u64
id|crime_int
op_assign
id|crime_read_64
(paren
id|CRIME_INT_STAT
)paren
suffix:semicolon
r_int
id|irq
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|crime_int
op_amp
id|CRIME_MACE_INT_MASK
)paren
(brace
id|crime_int
op_and_assign
id|CRIME_MACE_INT_MASK
suffix:semicolon
id|irq
op_assign
id|ffs
(paren
id|crime_int
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|crime_int
op_amp
id|CRIME_MACEISA_INT_MASK
)paren
(brace
id|u32
id|mace_int
suffix:semicolon
id|mace_int
op_assign
id|mace_read_32
(paren
id|MACEISA_INT_STAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mace_int
op_eq
l_int|0
)paren
id|irq
op_assign
l_int|0
suffix:semicolon
r_else
id|irq
op_assign
id|ffs
(paren
id|mace_int
)paren
op_plus
l_int|32
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|crime_int
op_amp
id|CRIME_MACEPCI_INT_MASK
)paren
(brace
id|crime_int
op_and_assign
id|CRIME_MACEPCI_INT_MASK
suffix:semicolon
id|crime_int
op_rshift_assign
l_int|8
suffix:semicolon
id|irq
op_assign
id|ffs
(paren
id|crime_int
)paren
op_plus
l_int|8
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|crime_int
op_amp
l_int|0xffff0000
)paren
(brace
id|crime_int
op_rshift_assign
l_int|16
suffix:semicolon
id|irq
op_assign
id|ffs
(paren
id|crime_int
)paren
op_plus
l_int|16
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irq
op_eq
l_int|0
)paren
id|ip32_unknown_interrupt
(paren
id|regs
)paren
suffix:semicolon
id|DBG
(paren
l_string|&quot;*irq %u*&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
id|do_IRQ
(paren
id|irq
comma
id|regs
)paren
suffix:semicolon
)brace
DECL|function|ip32_irq1
r_void
id|ip32_irq1
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|ip32_unknown_interrupt
(paren
id|regs
)paren
suffix:semicolon
)brace
DECL|function|ip32_irq2
r_void
id|ip32_irq2
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|ip32_unknown_interrupt
(paren
id|regs
)paren
suffix:semicolon
)brace
DECL|function|ip32_irq3
r_void
id|ip32_irq3
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|ip32_unknown_interrupt
(paren
id|regs
)paren
suffix:semicolon
)brace
DECL|function|ip32_irq4
r_void
id|ip32_irq4
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|ip32_unknown_interrupt
(paren
id|regs
)paren
suffix:semicolon
)brace
DECL|function|ip32_irq5
r_void
id|ip32_irq5
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|do_IRQ
(paren
id|CLOCK_IRQ
comma
id|regs
)paren
suffix:semicolon
)brace
eof
