multiline_comment|/*&n; * BRIEF MODULE DESCRIPTION&n; *&t;Simple Au1000 clocks routines.&n; *&n; * Copyright 2001 MontaVista Software Inc.&n; * Author: MontaVista Software, Inc.&n; *&t;&t;ppopov@mvista.com or source@mvista.com&n; *&n; *  This program is free software; you can redistribute&t; it and/or modify it&n; *  under  the terms of&t; the GNU General  Public License as published by the&n; *  Free Software Foundation;  either version 2 of the&t;License, or (at your&n; *  option) any later version.&n; *&n; *  THIS  SOFTWARE  IS PROVIDED&t;  ``AS&t;IS&squot;&squot; AND   ANY&t;EXPRESS OR IMPLIED&n; *  WARRANTIES,&t;  INCLUDING, BUT NOT  LIMITED  TO, THE IMPLIED WARRANTIES OF&n; *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN&n; *  NO&t;EVENT  SHALL   THE AUTHOR  BE&t; LIABLE FOR ANY&t;  DIRECT, INDIRECT,&n; *  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT&n; *  NOT LIMITED&t;  TO, PROCUREMENT OF  SUBSTITUTE GOODS&t;OR SERVICES; LOSS OF&n; *  USE, DATA,&t;OR PROFITS; OR&t;BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON&n; *  ANY THEORY OF LIABILITY, WHETHER IN&t; CONTRACT, STRICT LIABILITY, OR TORT&n; *  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF&n; *  THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n; *&n; *  You should have received a copy of the  GNU General Public License along&n; *  with this program; if not, write  to the Free Software Foundation, Inc.,&n; *  675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/au1000.h&gt;
DECL|variable|au1x00_clock
r_static
r_int
r_int
id|au1x00_clock
suffix:semicolon
singleline_comment|// Hz
DECL|variable|lcd_clock
r_static
r_int
r_int
id|lcd_clock
suffix:semicolon
singleline_comment|// KHz
DECL|variable|uart_baud_base
r_static
r_int
r_int
id|uart_baud_base
suffix:semicolon
multiline_comment|/*&n; * Set the au1000_clock&n; */
DECL|function|set_au1x00_speed
r_void
id|set_au1x00_speed
c_func
(paren
r_int
r_int
id|new_freq
)paren
(brace
id|au1x00_clock
op_assign
id|new_freq
suffix:semicolon
)brace
DECL|function|get_au1x00_speed
r_int
r_int
id|get_au1x00_speed
c_func
(paren
r_void
)paren
(brace
r_return
id|au1x00_clock
suffix:semicolon
)brace
multiline_comment|/*&n; * The UART baud base is not known at compile time ... if&n; * we want to be able to use the same code on different&n; * speed CPUs.&n; */
DECL|function|get_au1x00_uart_baud_base
r_int
r_int
id|get_au1x00_uart_baud_base
c_func
(paren
r_void
)paren
(brace
r_return
id|uart_baud_base
suffix:semicolon
)brace
DECL|function|set_au1x00_uart_baud_base
r_void
id|set_au1x00_uart_baud_base
c_func
(paren
r_int
r_int
id|new_baud_base
)paren
(brace
id|uart_baud_base
op_assign
id|new_baud_base
suffix:semicolon
)brace
multiline_comment|/*&n; * Calculate the Au1x00&squot;s LCD clock based on the current&n; * cpu clock and the system bus clock, and try to keep it&n; * below 40 MHz (the Pb1000 board can lock-up if the LCD&n; * clock is over 40 MHz).&n; */
DECL|function|set_au1x00_lcd_clock
r_void
id|set_au1x00_lcd_clock
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|static_cfg0
suffix:semicolon
r_int
r_int
id|sys_busclk
op_assign
(paren
id|get_au1x00_speed
c_func
(paren
)paren
op_div
l_int|1000
)paren
op_div
(paren
(paren
r_int
)paren
(paren
id|au_readl
c_func
(paren
id|SYS_POWERCTRL
)paren
op_amp
l_int|0x03
)paren
op_plus
l_int|2
)paren
suffix:semicolon
id|static_cfg0
op_assign
id|au_readl
c_func
(paren
id|MEM_STCFG0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|static_cfg0
op_amp
(paren
l_int|1
op_lshift
l_int|11
)paren
)paren
id|lcd_clock
op_assign
id|sys_busclk
op_div
l_int|5
suffix:semicolon
multiline_comment|/* note: BCLK switching fails with D5 */
r_else
id|lcd_clock
op_assign
id|sys_busclk
op_div
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|lcd_clock
OG
l_int|50000
)paren
multiline_comment|/* Epson MAX */
id|printk
c_func
(paren
l_string|&quot;%s: warning: LCD clock too high (%d KHz)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|lcd_clock
)paren
suffix:semicolon
)brace
DECL|function|get_au1x00_lcd_clock
r_int
r_int
id|get_au1x00_lcd_clock
c_func
(paren
r_void
)paren
(brace
r_return
id|lcd_clock
suffix:semicolon
)brace
DECL|variable|get_au1x00_lcd_clock
id|EXPORT_SYMBOL
c_func
(paren
id|get_au1x00_lcd_clock
)paren
suffix:semicolon
eof
