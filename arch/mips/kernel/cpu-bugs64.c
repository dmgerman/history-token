multiline_comment|/*&n; * Copyright (C) 2003, 2004  Maciej W. Rozycki&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;asm/bugs.h&gt;
macro_line|#include &lt;asm/compiler.h&gt;
macro_line|#include &lt;asm/cpu.h&gt;
macro_line|#include &lt;asm/fpu.h&gt;
macro_line|#include &lt;asm/mipsregs.h&gt;
macro_line|#include &lt;asm/system.h&gt;
DECL|function|align_mod
r_static
r_inline
r_void
id|align_mod
c_func
(paren
r_const
r_int
id|align
comma
r_const
r_int
id|mod
)paren
(brace
id|asm
r_volatile
(paren
l_string|&quot;.set&t;push&bslash;n&bslash;t&quot;
l_string|&quot;.set&t;noreorder&bslash;n&bslash;t&quot;
l_string|&quot;.balign %0&bslash;n&bslash;t&quot;
l_string|&quot;.rept&t;%1&bslash;n&bslash;t&quot;
l_string|&quot;nop&bslash;n&bslash;t&quot;
l_string|&quot;.endr&bslash;n&bslash;t&quot;
l_string|&quot;.set&t;pop&quot;
suffix:colon
suffix:colon
l_string|&quot;n&quot;
(paren
id|align
)paren
comma
l_string|&quot;n&quot;
(paren
id|mod
)paren
)paren
suffix:semicolon
)brace
DECL|function|mult_sh_align_mod
r_static
r_inline
r_void
id|mult_sh_align_mod
c_func
(paren
r_int
op_star
id|v1
comma
r_int
op_star
id|v2
comma
r_int
op_star
id|w
comma
r_const
r_int
id|align
comma
r_const
r_int
id|mod
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|m1
comma
id|m2
suffix:semicolon
r_int
id|p
comma
id|s
comma
id|lv1
comma
id|lv2
comma
id|lw
suffix:semicolon
multiline_comment|/*&n;&t; * We want the multiply and the shift to be isolated from the&n;&t; * rest of the code to disable gcc optimizations.  Hence the&n;&t; * asm statements that execute nothing, but make gcc not know&n;&t; * what the values of m1, m2 and s are and what lv2 and p are&n;&t; * used for.&n;&t; */
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * The following code leads to a wrong result of the first&n;&t; * dsll32 when executed on R4000 rev. 2.2 or 3.0 (PRId&n;&t; * 00000422 or 00000430, respectively).&n;&t; *&n;&t; * See &quot;MIPS R4000PC/SC Errata, Processor Revision 2.2 and&n;&t; * 3.0&quot; by MIPS Technologies, Inc., errata #16 and #28 for&n;&t; * details.  I got no permission to duplicate them here,&n;&t; * sigh... --macro&n;&t; */
id|asm
r_volatile
(paren
l_string|&quot;&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|m1
)paren
comma
l_string|&quot;=r&quot;
(paren
id|m2
)paren
comma
l_string|&quot;=r&quot;
(paren
id|s
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
l_int|5
)paren
comma
l_string|&quot;1&quot;
(paren
l_int|8
)paren
comma
l_string|&quot;2&quot;
(paren
l_int|5
)paren
)paren
suffix:semicolon
id|align_mod
c_func
(paren
id|align
comma
id|mod
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * The trailing nop is needed to fullfill the two-instruction&n;&t; * requirement between reading hi/lo and staring a mult/div.&n;&t; * Leaving it out may cause gas insert a nop itself breaking&n;&t; * the desired alignment of the next chunk.&n;&t; */
id|asm
r_volatile
(paren
l_string|&quot;.set&t;push&bslash;n&bslash;t&quot;
l_string|&quot;.set&t;noat&bslash;n&bslash;t&quot;
l_string|&quot;.set&t;noreorder&bslash;n&bslash;t&quot;
l_string|&quot;.set&t;nomacro&bslash;n&bslash;t&quot;
l_string|&quot;mult&t;%2, %3&bslash;n&bslash;t&quot;
l_string|&quot;dsll32&t;%0, %4, %5&bslash;n&bslash;t&quot;
l_string|&quot;mflo&t;$0&bslash;n&bslash;t&quot;
l_string|&quot;dsll32&t;%1, %4, %5&bslash;n&bslash;t&quot;
l_string|&quot;nop&bslash;n&bslash;t&quot;
l_string|&quot;.set&t;pop&quot;
suffix:colon
l_string|&quot;=&amp;r&quot;
(paren
id|lv1
)paren
comma
l_string|&quot;=r&quot;
(paren
id|lw
)paren
suffix:colon
l_string|&quot;r&quot;
(paren
id|m1
)paren
comma
l_string|&quot;r&quot;
(paren
id|m2
)paren
comma
l_string|&quot;r&quot;
(paren
id|s
)paren
comma
l_string|&quot;I&quot;
(paren
l_int|0
)paren
suffix:colon
l_string|&quot;hi&quot;
comma
l_string|&quot;lo&quot;
comma
id|GCC_REG_ACCUM
)paren
suffix:semicolon
multiline_comment|/* We have to use single integers for m1 and m2 and a double&n;&t; * one for p to be sure the mulsidi3 gcc&squot;s RTL multiplication&n;&t; * instruction has the workaround applied.  Older versions of&n;&t; * gcc have correct umulsi3 and mulsi3, but other&n;&t; * multiplication variants lack the workaround.&n;&t; */
id|asm
r_volatile
(paren
l_string|&quot;&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|m1
)paren
comma
l_string|&quot;=r&quot;
(paren
id|m2
)paren
comma
l_string|&quot;=r&quot;
(paren
id|s
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|m1
)paren
comma
l_string|&quot;1&quot;
(paren
id|m2
)paren
comma
l_string|&quot;2&quot;
(paren
id|s
)paren
)paren
suffix:semicolon
id|align_mod
c_func
(paren
id|align
comma
id|mod
)paren
suffix:semicolon
id|p
op_assign
id|m1
op_star
id|m2
suffix:semicolon
id|lv2
op_assign
id|s
op_lshift
l_int|32
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|lv2
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|lv2
)paren
comma
l_string|&quot;r&quot;
(paren
id|p
)paren
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
op_star
id|v1
op_assign
id|lv1
suffix:semicolon
op_star
id|v2
op_assign
id|lv2
suffix:semicolon
op_star
id|w
op_assign
id|lw
suffix:semicolon
)brace
DECL|function|check_mult_sh
r_static
r_inline
r_void
id|check_mult_sh
c_func
(paren
r_void
)paren
(brace
r_int
id|v1
(braket
l_int|8
)braket
comma
id|v2
(braket
l_int|8
)braket
comma
id|w
(braket
l_int|8
)braket
suffix:semicolon
r_int
id|bug
comma
id|fix
comma
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Checking for the multiply/shift bug... &quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Testing discovered false negatives for certain code offsets&n;&t; * into cache lines.  Hence we test all possible offsets for&n;&t; * the worst assumption of an R4000 I-cache line width of 32&n;&t; * bytes.&n;&t; *&n;&t; * We can&squot;t use a loop as alignment directives need to be&n;&t; * immediates.&n;&t; */
id|mult_sh_align_mod
c_func
(paren
op_amp
id|v1
(braket
l_int|0
)braket
comma
op_amp
id|v2
(braket
l_int|0
)braket
comma
op_amp
id|w
(braket
l_int|0
)braket
comma
l_int|32
comma
l_int|0
)paren
suffix:semicolon
id|mult_sh_align_mod
c_func
(paren
op_amp
id|v1
(braket
l_int|1
)braket
comma
op_amp
id|v2
(braket
l_int|1
)braket
comma
op_amp
id|w
(braket
l_int|1
)braket
comma
l_int|32
comma
l_int|1
)paren
suffix:semicolon
id|mult_sh_align_mod
c_func
(paren
op_amp
id|v1
(braket
l_int|2
)braket
comma
op_amp
id|v2
(braket
l_int|2
)braket
comma
op_amp
id|w
(braket
l_int|2
)braket
comma
l_int|32
comma
l_int|2
)paren
suffix:semicolon
id|mult_sh_align_mod
c_func
(paren
op_amp
id|v1
(braket
l_int|3
)braket
comma
op_amp
id|v2
(braket
l_int|3
)braket
comma
op_amp
id|w
(braket
l_int|3
)braket
comma
l_int|32
comma
l_int|3
)paren
suffix:semicolon
id|mult_sh_align_mod
c_func
(paren
op_amp
id|v1
(braket
l_int|4
)braket
comma
op_amp
id|v2
(braket
l_int|4
)braket
comma
op_amp
id|w
(braket
l_int|4
)braket
comma
l_int|32
comma
l_int|4
)paren
suffix:semicolon
id|mult_sh_align_mod
c_func
(paren
op_amp
id|v1
(braket
l_int|5
)braket
comma
op_amp
id|v2
(braket
l_int|5
)braket
comma
op_amp
id|w
(braket
l_int|5
)braket
comma
l_int|32
comma
l_int|5
)paren
suffix:semicolon
id|mult_sh_align_mod
c_func
(paren
op_amp
id|v1
(braket
l_int|6
)braket
comma
op_amp
id|v2
(braket
l_int|6
)braket
comma
op_amp
id|w
(braket
l_int|6
)braket
comma
l_int|32
comma
l_int|6
)paren
suffix:semicolon
id|mult_sh_align_mod
c_func
(paren
op_amp
id|v1
(braket
l_int|7
)braket
comma
op_amp
id|v2
(braket
l_int|7
)braket
comma
op_amp
id|w
(braket
l_int|7
)braket
comma
l_int|32
comma
l_int|7
)paren
suffix:semicolon
id|bug
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|v1
(braket
id|i
)braket
op_ne
id|w
(braket
id|i
)braket
)paren
id|bug
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|bug
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;no.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;yes, workaround... &quot;
)paren
suffix:semicolon
id|fix
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|v2
(braket
id|i
)braket
op_ne
id|w
(braket
id|i
)braket
)paren
id|fix
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fix
op_eq
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;yes.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;no.&bslash;n&quot;
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;Reliable operation impossible!&bslash;n&quot;
macro_line|#ifndef CONFIG_CPU_R4000
l_string|&quot;Configure for R4000 to enable the workaround.&quot;
macro_line|#else
l_string|&quot;Please report to &lt;linux-mips@linux-mips.org&gt;.&quot;
macro_line|#endif
)paren
suffix:semicolon
)brace
DECL|variable|__initdata
r_static
r_volatile
r_int
id|daddi_ov
id|__initdata
op_assign
l_int|0
suffix:semicolon
DECL|function|do_daddi_ov
id|asmlinkage
r_void
id|__init
id|do_daddi_ov
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|daddi_ov
op_assign
l_int|1
suffix:semicolon
id|regs-&gt;cp0_epc
op_add_assign
l_int|4
suffix:semicolon
)brace
DECL|function|check_daddi
r_static
r_inline
r_void
id|check_daddi
c_func
(paren
r_void
)paren
(brace
r_extern
id|asmlinkage
r_void
id|handle_daddi_ov
c_func
(paren
r_void
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_void
op_star
id|handler
suffix:semicolon
r_int
id|v
comma
id|tmp
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Checking for the daddi bug... &quot;
)paren
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|handler
op_assign
id|set_except_vector
c_func
(paren
l_int|12
comma
id|handle_daddi_ov
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * The following code fails to trigger an overflow exception&n;&t; * when executed on R4000 rev. 2.2 or 3.0 (PRId 00000422 or&n;&t; * 00000430, respectively).&n;&t; *&n;&t; * See &quot;MIPS R4000PC/SC Errata, Processor Revision 2.2 and&n;&t; * 3.0&quot; by MIPS Technologies, Inc., erratum #23 for details.&n;&t; * I got no permission to duplicate it here, sigh... --macro&n;&t; */
id|asm
r_volatile
(paren
l_string|&quot;.set&t;push&bslash;n&bslash;t&quot;
l_string|&quot;.set&t;noat&bslash;n&bslash;t&quot;
l_string|&quot;.set&t;noreorder&bslash;n&bslash;t&quot;
l_string|&quot;.set&t;nomacro&bslash;n&bslash;t&quot;
l_string|&quot;addiu&t;%1, $0, %2&bslash;n&bslash;t&quot;
l_string|&quot;dsrl&t;%1, %1, 1&bslash;n&bslash;t&quot;
macro_line|#ifdef HAVE_AS_SET_DADDI
l_string|&quot;.set&t;daddi&bslash;n&bslash;t&quot;
macro_line|#endif
l_string|&quot;daddi&t;%0, %1, %3&bslash;n&bslash;t&quot;
l_string|&quot;.set&t;pop&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|v
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|tmp
)paren
suffix:colon
l_string|&quot;I&quot;
(paren
l_int|0xffffffffffffdb9a
)paren
comma
l_string|&quot;I&quot;
(paren
l_int|0x1234
)paren
)paren
suffix:semicolon
id|set_except_vector
c_func
(paren
l_int|12
comma
id|handler
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|daddi_ov
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;no.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;yes, workaround... &quot;
)paren
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|handler
op_assign
id|set_except_vector
c_func
(paren
l_int|12
comma
id|handle_daddi_ov
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;addiu&t;%1, $0, %2&bslash;n&bslash;t&quot;
l_string|&quot;dsrl&t;%1, %1, 1&bslash;n&bslash;t&quot;
l_string|&quot;daddi&t;%0, %1, %3&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|v
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|tmp
)paren
suffix:colon
l_string|&quot;I&quot;
(paren
l_int|0xffffffffffffdb9a
)paren
comma
l_string|&quot;I&quot;
(paren
l_int|0x1234
)paren
)paren
suffix:semicolon
id|set_except_vector
c_func
(paren
l_int|12
comma
id|handler
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|daddi_ov
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;yes.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;no.&bslash;n&quot;
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;Reliable operation impossible!&bslash;n&quot;
macro_line|#if !defined(CONFIG_CPU_R4000) &amp;&amp; !defined(CONFIG_CPU_R4400)
l_string|&quot;Configure for R4000 or R4400 to enable the workaround.&quot;
macro_line|#else
l_string|&quot;Please report to &lt;linux-mips@linux-mips.org&gt;.&quot;
macro_line|#endif
)paren
suffix:semicolon
)brace
DECL|function|check_daddiu
r_static
r_inline
r_void
id|check_daddiu
c_func
(paren
r_void
)paren
(brace
r_int
id|v
comma
id|w
comma
id|tmp
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Checking for the daddiu bug... &quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * The following code leads to a wrong result of daddiu when&n;&t; * executed on R4400 rev. 1.0 (PRId 00000440).&n;&t; *&n;&t; * See &quot;MIPS R4400PC/SC Errata, Processor Revision 1.0&quot; by&n;&t; * MIPS Technologies, Inc., erratum #7 for details.&n;&t; *&n;&t; * According to &quot;MIPS R4000PC/SC Errata, Processor Revision&n;&t; * 2.2 and 3.0&quot; by MIPS Technologies, Inc., erratum #41 this&n;&t; * problem affects R4000 rev. 2.2 and 3.0 (PRId 00000422 and&n;&t; * 00000430, respectively), too.  Testing failed to trigger it&n;&t; * so far.&n;&t; *&n;&t; * I got no permission to duplicate the errata here, sigh...&n;&t; * --macro&n;&t; */
id|asm
r_volatile
(paren
l_string|&quot;.set&t;push&bslash;n&bslash;t&quot;
l_string|&quot;.set&t;noat&bslash;n&bslash;t&quot;
l_string|&quot;.set&t;noreorder&bslash;n&bslash;t&quot;
l_string|&quot;.set&t;nomacro&bslash;n&bslash;t&quot;
l_string|&quot;addiu&t;%2, $0, %3&bslash;n&bslash;t&quot;
l_string|&quot;dsrl&t;%2, %2, 1&bslash;n&bslash;t&quot;
macro_line|#ifdef HAVE_AS_SET_DADDI
l_string|&quot;.set&t;daddi&bslash;n&bslash;t&quot;
macro_line|#endif
l_string|&quot;daddiu&t;%0, %2, %4&bslash;n&bslash;t&quot;
l_string|&quot;addiu&t;%1, $0, %4&bslash;n&bslash;t&quot;
l_string|&quot;daddu&t;%1, %2&bslash;n&bslash;t&quot;
l_string|&quot;.set&t;pop&quot;
suffix:colon
l_string|&quot;=&amp;r&quot;
(paren
id|v
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|w
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|tmp
)paren
suffix:colon
l_string|&quot;I&quot;
(paren
l_int|0xffffffffffffdb9a
)paren
comma
l_string|&quot;I&quot;
(paren
l_int|0x1234
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|v
op_eq
id|w
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;no.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;yes, workaround... &quot;
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;addiu&t;%2, $0, %3&bslash;n&bslash;t&quot;
l_string|&quot;dsrl&t;%2, %2, 1&bslash;n&bslash;t&quot;
l_string|&quot;daddiu&t;%0, %2, %4&bslash;n&bslash;t&quot;
l_string|&quot;addiu&t;%1, $0, %4&bslash;n&bslash;t&quot;
l_string|&quot;daddu&t;%1, %2&quot;
suffix:colon
l_string|&quot;=&amp;r&quot;
(paren
id|v
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|w
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|tmp
)paren
suffix:colon
l_string|&quot;I&quot;
(paren
l_int|0xffffffffffffdb9a
)paren
comma
l_string|&quot;I&quot;
(paren
l_int|0x1234
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|v
op_eq
id|w
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;yes.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;no.&bslash;n&quot;
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;Reliable operation impossible!&bslash;n&quot;
macro_line|#if !defined(CONFIG_CPU_R4000) &amp;&amp; !defined(CONFIG_CPU_R4400)
l_string|&quot;Configure for R4000 or R4400 to enable the workaround.&quot;
macro_line|#else
l_string|&quot;Please report to &lt;linux-mips@linux-mips.org&gt;.&quot;
macro_line|#endif
)paren
suffix:semicolon
)brace
DECL|function|check_bugs64
r_void
id|__init
id|check_bugs64
c_func
(paren
r_void
)paren
(brace
id|check_mult_sh
c_func
(paren
)paren
suffix:semicolon
id|check_daddi
c_func
(paren
)paren
suffix:semicolon
id|check_daddiu
c_func
(paren
)paren
suffix:semicolon
)brace
eof
