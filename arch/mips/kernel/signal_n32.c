multiline_comment|/*&n; * Copyright (C) 2003 Broadcom Corporation&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version 2&n; * of the License, or (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/compat.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;asm/asm.h&gt;
macro_line|#include &lt;asm/cacheflush.h&gt;
macro_line|#include &lt;asm/sim.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/ucontext.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/fpu.h&gt;
macro_line|#include &lt;asm/cpu-features.h&gt;
macro_line|#include &quot;signal-common.h&quot;
multiline_comment|/*&n; * Including &lt;asm/unistd.h&gt; would give use the 64-bit syscall numbers ...&n; */
DECL|macro|__NR_N32_rt_sigreturn
mdefine_line|#define __NR_N32_rt_sigreturn&t;&t;6211
DECL|macro|__NR_N32_restart_syscall
mdefine_line|#define __NR_N32_restart_syscall&t;6214
DECL|macro|_BLOCKABLE
mdefine_line|#define _BLOCKABLE (~(sigmask(SIGKILL) | sigmask(SIGSTOP)))
multiline_comment|/* IRIX compatible stack_t  */
DECL|struct|sigaltstack32
r_typedef
r_struct
id|sigaltstack32
(brace
DECL|member|ss_sp
id|s32
id|ss_sp
suffix:semicolon
DECL|member|ss_size
id|compat_size_t
id|ss_size
suffix:semicolon
DECL|member|ss_flags
r_int
id|ss_flags
suffix:semicolon
DECL|typedef|stack32_t
)brace
id|stack32_t
suffix:semicolon
DECL|struct|ucontextn32
r_struct
id|ucontextn32
(brace
DECL|member|uc_flags
id|u32
id|uc_flags
suffix:semicolon
DECL|member|uc_link
id|s32
id|uc_link
suffix:semicolon
DECL|member|uc_stack
id|stack32_t
id|uc_stack
suffix:semicolon
DECL|member|uc_mcontext
r_struct
id|sigcontext
id|uc_mcontext
suffix:semicolon
DECL|member|uc_sigmask
id|sigset_t
id|uc_sigmask
suffix:semicolon
multiline_comment|/* mask last for extensibility */
)brace
suffix:semicolon
macro_line|#if PLAT_TRAMPOLINE_STUFF_LINE
DECL|macro|__tramp
mdefine_line|#define __tramp __attribute__((aligned(PLAT_TRAMPOLINE_STUFF_LINE)))
macro_line|#else
DECL|macro|__tramp
mdefine_line|#define __tramp
macro_line|#endif
DECL|struct|rt_sigframe_n32
r_struct
id|rt_sigframe_n32
(brace
DECL|member|rs_ass
id|u32
id|rs_ass
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* argument save space for o32 */
DECL|member|__tramp
id|u32
id|rs_code
(braket
l_int|2
)braket
id|__tramp
suffix:semicolon
multiline_comment|/* signal trampoline */
DECL|member|__tramp
r_struct
id|siginfo
id|rs_info
id|__tramp
suffix:semicolon
DECL|member|rs_uc
r_struct
id|ucontextn32
id|rs_uc
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|sysn32_rt_sigreturn
id|save_static_function
c_func
(paren
id|sysn32_rt_sigreturn
)paren
suffix:semicolon
id|__attribute_used__
id|noinline
r_static
r_void
DECL|function|_sysn32_rt_sigreturn
id|_sysn32_rt_sigreturn
c_func
(paren
id|nabi_no_regargs
r_struct
id|pt_regs
id|regs
)paren
(brace
r_struct
id|rt_sigframe_n32
op_star
id|frame
suffix:semicolon
id|sigset_t
id|set
suffix:semicolon
id|stack_t
id|st
suffix:semicolon
id|s32
id|sp
suffix:semicolon
id|frame
op_assign
(paren
r_struct
id|rt_sigframe_n32
op_star
)paren
id|regs.regs
(braket
l_int|29
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_READ
comma
id|frame
comma
r_sizeof
(paren
op_star
id|frame
)paren
)paren
)paren
r_goto
id|badframe
suffix:semicolon
r_if
c_cond
(paren
id|__copy_from_user
c_func
(paren
op_amp
id|set
comma
op_amp
id|frame-&gt;rs_uc.uc_sigmask
comma
r_sizeof
(paren
id|set
)paren
)paren
)paren
r_goto
id|badframe
suffix:semicolon
id|sigdelsetmask
c_func
(paren
op_amp
id|set
comma
op_complement
id|_BLOCKABLE
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|current-&gt;sighand-&gt;siglock
)paren
suffix:semicolon
id|current-&gt;blocked
op_assign
id|set
suffix:semicolon
id|recalc_sigpending
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|current-&gt;sighand-&gt;siglock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|restore_sigcontext
c_func
(paren
op_amp
id|regs
comma
op_amp
id|frame-&gt;rs_uc.uc_mcontext
)paren
)paren
r_goto
id|badframe
suffix:semicolon
multiline_comment|/* The ucontext contains a stack32_t, so we must convert!  */
r_if
c_cond
(paren
id|__get_user
c_func
(paren
id|sp
comma
op_amp
id|frame-&gt;rs_uc.uc_stack.ss_sp
)paren
)paren
r_goto
id|badframe
suffix:semicolon
id|st.ss_size
op_assign
(paren
r_int
)paren
id|sp
suffix:semicolon
r_if
c_cond
(paren
id|__get_user
c_func
(paren
id|st.ss_size
comma
op_amp
id|frame-&gt;rs_uc.uc_stack.ss_size
)paren
)paren
r_goto
id|badframe
suffix:semicolon
r_if
c_cond
(paren
id|__get_user
c_func
(paren
id|st.ss_flags
comma
op_amp
id|frame-&gt;rs_uc.uc_stack.ss_flags
)paren
)paren
r_goto
id|badframe
suffix:semicolon
multiline_comment|/* It is more difficult to avoid calling this function than to&n;&t;   call it and ignore errors.  */
id|do_sigaltstack
c_func
(paren
op_amp
id|st
comma
l_int|NULL
comma
id|regs.regs
(braket
l_int|29
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Don&squot;t let your children do this ...&n;&t; */
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;move&bslash;t$29, %0&bslash;n&bslash;t&quot;
l_string|&quot;j&bslash;tsyscall_exit&quot;
suffix:colon
multiline_comment|/* no outputs */
suffix:colon
l_string|&quot;r&quot;
(paren
op_amp
id|regs
)paren
)paren
suffix:semicolon
multiline_comment|/* Unreached */
id|badframe
suffix:colon
id|force_sig
c_func
(paren
id|SIGSEGV
comma
id|current
)paren
suffix:semicolon
)brace
DECL|function|setup_rt_frame_n32
r_void
id|setup_rt_frame_n32
c_func
(paren
r_struct
id|k_sigaction
op_star
id|ka
comma
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|signr
comma
id|sigset_t
op_star
id|set
comma
id|siginfo_t
op_star
id|info
)paren
(brace
r_struct
id|rt_sigframe_n32
op_star
id|frame
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|s32
id|sp
suffix:semicolon
id|frame
op_assign
id|get_sigframe
c_func
(paren
id|ka
comma
id|regs
comma
r_sizeof
(paren
op_star
id|frame
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_WRITE
comma
id|frame
comma
r_sizeof
(paren
op_star
id|frame
)paren
)paren
)paren
r_goto
id|give_sigsegv
suffix:semicolon
multiline_comment|/*&n;&t; * Set up the return code ...&n;&t; *&n;&t; *         li      v0, __NR_rt_sigreturn&n;&t; *         syscall&n;&t; */
r_if
c_cond
(paren
id|PLAT_TRAMPOLINE_STUFF_LINE
)paren
id|__clear_user
c_func
(paren
id|frame-&gt;rs_code
comma
id|PLAT_TRAMPOLINE_STUFF_LINE
)paren
suffix:semicolon
id|err
op_or_assign
id|__put_user
c_func
(paren
l_int|0x24020000
op_plus
id|__NR_N32_rt_sigreturn
comma
id|frame-&gt;rs_code
op_plus
l_int|0
)paren
suffix:semicolon
id|err
op_or_assign
id|__put_user
c_func
(paren
l_int|0x0000000c
comma
id|frame-&gt;rs_code
op_plus
l_int|1
)paren
suffix:semicolon
id|flush_cache_sigtramp
c_func
(paren
(paren
r_int
r_int
)paren
id|frame-&gt;rs_code
)paren
suffix:semicolon
multiline_comment|/* Create siginfo.  */
id|err
op_or_assign
id|copy_siginfo_to_user
c_func
(paren
op_amp
id|frame-&gt;rs_info
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* Create the ucontext.  */
id|err
op_or_assign
id|__put_user
c_func
(paren
l_int|0
comma
op_amp
id|frame-&gt;rs_uc.uc_flags
)paren
suffix:semicolon
id|err
op_or_assign
id|__put_user
c_func
(paren
l_int|0
comma
op_amp
id|frame-&gt;rs_uc.uc_link
)paren
suffix:semicolon
id|sp
op_assign
(paren
r_int
)paren
(paren
r_int
)paren
id|current-&gt;sas_ss_sp
suffix:semicolon
id|err
op_or_assign
id|__put_user
c_func
(paren
id|sp
comma
op_amp
id|frame-&gt;rs_uc.uc_stack.ss_sp
)paren
suffix:semicolon
id|err
op_or_assign
id|__put_user
c_func
(paren
id|sas_ss_flags
c_func
(paren
id|regs-&gt;regs
(braket
l_int|29
)braket
)paren
comma
op_amp
id|frame-&gt;rs_uc.uc_stack.ss_flags
)paren
suffix:semicolon
id|err
op_or_assign
id|__put_user
c_func
(paren
id|current-&gt;sas_ss_size
comma
op_amp
id|frame-&gt;rs_uc.uc_stack.ss_size
)paren
suffix:semicolon
id|err
op_or_assign
id|setup_sigcontext
c_func
(paren
id|regs
comma
op_amp
id|frame-&gt;rs_uc.uc_mcontext
)paren
suffix:semicolon
id|err
op_or_assign
id|__copy_to_user
c_func
(paren
op_amp
id|frame-&gt;rs_uc.uc_sigmask
comma
id|set
comma
r_sizeof
(paren
op_star
id|set
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|give_sigsegv
suffix:semicolon
multiline_comment|/*&n;&t; * Arguments to signal handler:&n;&t; *&n;&t; *   a0 = signal number&n;&t; *   a1 = 0 (should be cause)&n;&t; *   a2 = pointer to ucontext&n;&t; *&n;&t; * $25 and c0_epc point to the signal handler, $29 points to&n;&t; * the struct rt_sigframe.&n;&t; */
id|regs-&gt;regs
(braket
l_int|4
)braket
op_assign
id|signr
suffix:semicolon
id|regs-&gt;regs
(braket
l_int|5
)braket
op_assign
(paren
r_int
r_int
)paren
op_amp
id|frame-&gt;rs_info
suffix:semicolon
id|regs-&gt;regs
(braket
l_int|6
)braket
op_assign
(paren
r_int
r_int
)paren
op_amp
id|frame-&gt;rs_uc
suffix:semicolon
id|regs-&gt;regs
(braket
l_int|29
)braket
op_assign
(paren
r_int
r_int
)paren
id|frame
suffix:semicolon
id|regs-&gt;regs
(braket
l_int|31
)braket
op_assign
(paren
r_int
r_int
)paren
id|frame-&gt;rs_code
suffix:semicolon
id|regs-&gt;cp0_epc
op_assign
id|regs-&gt;regs
(braket
l_int|25
)braket
op_assign
(paren
r_int
r_int
)paren
id|ka-&gt;sa.sa_handler
suffix:semicolon
macro_line|#if DEBUG_SIG
id|printk
c_func
(paren
l_string|&quot;SIG deliver (%s:%d): sp=0x%p pc=0x%lx ra=0x%p&bslash;n&quot;
comma
id|current-&gt;comm
comma
id|current-&gt;pid
comma
id|frame
comma
id|regs-&gt;cp0_epc
comma
id|regs-&gt;regs
(braket
l_int|31
)braket
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
id|give_sigsegv
suffix:colon
id|force_sigsegv
c_func
(paren
id|signr
comma
id|current
)paren
suffix:semicolon
)brace
eof
