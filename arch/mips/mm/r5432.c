multiline_comment|/*&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * r5432.c: NEC Vr5432 processor.  We cannot use r4xx0.c because of&n; *      its unique way-selection method for indexed operations.&n; *&n; * Copyright (C) 1996 David S. Miller (dm@engr.sgi.com)&n; * Copyright (C) 1997, 1998, 1999, 2000 Ralf Baechle (ralf@gnu.org)&n; * Copyright (C) 2000 Jun Sun (jsun@mvista.com)&n; *&n; */
multiline_comment|/*&n; * [jsun]&n; * In a sense, this is really silly.  We cannot re-use r4xx0.c because&n; * the lowest-level indexed cache operation does not take way-selection&n; * into account.  So all what I am doing here is to copy all the funcs&n; * and macros (in r4kcache.h) relavent to R5432 to this file, and then&n; * modify a few indexed cache operations.  *sigh*&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/bcache.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#include &lt;asm/mmu_context.h&gt;
multiline_comment|/* CP0 hazard avoidance. */
DECL|macro|BARRIER
mdefine_line|#define BARRIER __asm__ __volatile__(&quot;.set noreorder&bslash;n&bslash;t&quot; &bslash;&n;&t;&t;&t;&t;     &quot;nop; nop; nop; nop; nop; nop;&bslash;n&bslash;t&quot; &bslash;&n;&t;&t;&t;&t;     &quot;.set reorder&bslash;n&bslash;t&quot;)
macro_line|#include &lt;asm/asm.h&gt;
macro_line|#include &lt;asm/cacheops.h&gt;
DECL|macro|DEBUG_CACHE
macro_line|#undef DEBUG_CACHE
multiline_comment|/* Primary cache parameters. */
DECL|variable|icache_size
DECL|variable|dcache_size
r_static
r_int
id|icache_size
comma
id|dcache_size
suffix:semicolon
multiline_comment|/* Size in bytes */
DECL|variable|ic_lsize
DECL|variable|dc_lsize
r_static
r_int
id|ic_lsize
comma
id|dc_lsize
suffix:semicolon
multiline_comment|/* LineSize in bytes */
multiline_comment|/* -------------------------------------------------------------------- */
multiline_comment|/* #include &lt;asm/r4kcache.h&gt; */
DECL|function|flush_icache_line_indexed
r_extern
r_inline
r_void
id|flush_icache_line_indexed
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;.set noreorder&bslash;n&bslash;t&quot;
l_string|&quot;.set mips3&bslash;n&bslash;t&quot;
l_string|&quot;cache %1, (%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache %1, 1(%0)&bslash;n&bslash;t&quot;
l_string|&quot;.set mips0&bslash;n&bslash;t&quot;
l_string|&quot;.set reorder&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|addr
)paren
comma
l_string|&quot;i&quot;
(paren
id|Index_Invalidate_I
)paren
)paren
suffix:semicolon
)brace
DECL|function|flush_dcache_line_indexed
r_extern
r_inline
r_void
id|flush_dcache_line_indexed
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;.set noreorder&bslash;n&bslash;t&quot;
l_string|&quot;.set mips3&bslash;n&bslash;t&quot;
l_string|&quot;cache %1, (%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache %1, 1(%0)&bslash;n&bslash;t&quot;
l_string|&quot;.set mips0&bslash;n&bslash;t&quot;
l_string|&quot;.set reorder&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|addr
)paren
comma
l_string|&quot;i&quot;
(paren
id|Index_Writeback_Inv_D
)paren
)paren
suffix:semicolon
)brace
DECL|function|flush_icache_line
r_extern
r_inline
r_void
id|flush_icache_line
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;.set noreorder&bslash;n&bslash;t&quot;
l_string|&quot;.set mips3&bslash;n&bslash;t&quot;
l_string|&quot;cache %1, (%0)&bslash;n&bslash;t&quot;
l_string|&quot;.set mips0&bslash;n&bslash;t&quot;
l_string|&quot;.set reorder&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|addr
)paren
comma
l_string|&quot;i&quot;
(paren
id|Hit_Invalidate_I
)paren
)paren
suffix:semicolon
)brace
DECL|function|flush_dcache_line
r_extern
r_inline
r_void
id|flush_dcache_line
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;.set noreorder&bslash;n&bslash;t&quot;
l_string|&quot;.set mips3&bslash;n&bslash;t&quot;
l_string|&quot;cache %1, (%0)&bslash;n&bslash;t&quot;
l_string|&quot;.set mips0&bslash;n&bslash;t&quot;
l_string|&quot;.set reorder&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|addr
)paren
comma
l_string|&quot;i&quot;
(paren
id|Hit_Writeback_Inv_D
)paren
)paren
suffix:semicolon
)brace
DECL|function|invalidate_dcache_line
r_extern
r_inline
r_void
id|invalidate_dcache_line
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;.set noreorder&bslash;n&bslash;t&quot;
l_string|&quot;.set mips3&bslash;n&bslash;t&quot;
l_string|&quot;cache %1, (%0)&bslash;n&bslash;t&quot;
l_string|&quot;.set mips0&bslash;n&bslash;t&quot;
l_string|&quot;.set reorder&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|addr
)paren
comma
l_string|&quot;i&quot;
(paren
id|Hit_Invalidate_D
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * The next two are for badland addresses like signal trampolines.&n; */
DECL|function|protected_flush_icache_line
r_extern
r_inline
r_void
id|protected_flush_icache_line
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;.set noreorder&bslash;n&bslash;t&quot;
l_string|&quot;.set mips3&bslash;n&quot;
l_string|&quot;1:&bslash;tcache %1,(%0)&bslash;n&quot;
l_string|&quot;2:&bslash;t.set mips0&bslash;n&bslash;t&quot;
l_string|&quot;.set reorder&bslash;n&bslash;t&quot;
l_string|&quot;.section&bslash;t__ex_table,&bslash;&quot;a&bslash;&quot;&bslash;n&bslash;t&quot;
id|STR
c_func
(paren
id|PTR
)paren
l_string|&quot;&bslash;t1b,2b&bslash;n&bslash;t&quot;
l_string|&quot;.previous&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|addr
)paren
comma
l_string|&quot;i&quot;
(paren
id|Hit_Invalidate_I
)paren
)paren
suffix:semicolon
)brace
DECL|function|protected_writeback_dcache_line
r_extern
r_inline
r_void
id|protected_writeback_dcache_line
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;.set noreorder&bslash;n&bslash;t&quot;
l_string|&quot;.set mips3&bslash;n&quot;
l_string|&quot;1:&bslash;tcache %1,(%0)&bslash;n&quot;
l_string|&quot;2:&bslash;t.set mips0&bslash;n&bslash;t&quot;
l_string|&quot;.set reorder&bslash;n&bslash;t&quot;
l_string|&quot;.section&bslash;t__ex_table,&bslash;&quot;a&bslash;&quot;&bslash;n&bslash;t&quot;
id|STR
c_func
(paren
id|PTR
)paren
l_string|&quot;&bslash;t1b,2b&bslash;n&bslash;t&quot;
l_string|&quot;.previous&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|addr
)paren
comma
l_string|&quot;i&quot;
(paren
id|Hit_Writeback_D
)paren
)paren
suffix:semicolon
)brace
DECL|macro|cache32_unroll32
mdefine_line|#define cache32_unroll32(base,op)&t;&t;&t;&t;&bslash;&n;&t;__asm__ __volatile__(&quot;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;.set noreorder;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;.set mips3;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;cache %1, 0x000(%0); cache %1, 0x020(%0);&t;&bslash;&n;&t;&t;cache %1, 0x040(%0); cache %1, 0x060(%0);&t;&bslash;&n;&t;&t;cache %1, 0x080(%0); cache %1, 0x0a0(%0);&t;&bslash;&n;&t;&t;cache %1, 0x0c0(%0); cache %1, 0x0e0(%0);&t;&bslash;&n;&t;&t;cache %1, 0x100(%0); cache %1, 0x120(%0);&t;&bslash;&n;&t;&t;cache %1, 0x140(%0); cache %1, 0x160(%0);&t;&bslash;&n;&t;&t;cache %1, 0x180(%0); cache %1, 0x1a0(%0);&t;&bslash;&n;&t;&t;cache %1, 0x1c0(%0); cache %1, 0x1e0(%0);&t;&bslash;&n;&t;&t;cache %1, 0x200(%0); cache %1, 0x220(%0);&t;&bslash;&n;&t;&t;cache %1, 0x240(%0); cache %1, 0x260(%0);&t;&bslash;&n;&t;&t;cache %1, 0x280(%0); cache %1, 0x2a0(%0);&t;&bslash;&n;&t;&t;cache %1, 0x2c0(%0); cache %1, 0x2e0(%0);&t;&bslash;&n;&t;&t;cache %1, 0x300(%0); cache %1, 0x320(%0);&t;&bslash;&n;&t;&t;cache %1, 0x340(%0); cache %1, 0x360(%0);&t;&bslash;&n;&t;&t;cache %1, 0x380(%0); cache %1, 0x3a0(%0);&t;&bslash;&n;&t;&t;cache %1, 0x3c0(%0); cache %1, 0x3e0(%0);&t;&bslash;&n;&t;&t;.set mips0;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;.set reorder&quot;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;:&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;: &quot;r&quot; (base),&t;&t;&t;&t;&t;&bslash;&n;&t;&t;  &quot;i&quot; (op));
DECL|function|blast_dcache32
r_extern
r_inline
r_void
id|blast_dcache32
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|start
op_assign
id|KSEG0
suffix:semicolon
r_int
r_int
id|end
op_assign
(paren
id|start
op_plus
id|dcache_size
op_div
l_int|2
)paren
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
id|cache32_unroll32
c_func
(paren
id|start
comma
id|Index_Writeback_Inv_D
)paren
suffix:semicolon
id|cache32_unroll32
c_func
(paren
id|start
op_plus
l_int|1
comma
id|Index_Writeback_Inv_D
)paren
suffix:semicolon
id|start
op_add_assign
l_int|0x400
suffix:semicolon
)brace
)brace
DECL|function|blast_dcache32_page
r_extern
r_inline
r_void
id|blast_dcache32_page
c_func
(paren
r_int
r_int
id|page
)paren
(brace
r_int
r_int
id|start
op_assign
id|page
suffix:semicolon
r_int
r_int
id|end
op_assign
(paren
id|start
op_plus
id|PAGE_SIZE
)paren
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
id|cache32_unroll32
c_func
(paren
id|start
comma
id|Hit_Writeback_Inv_D
)paren
suffix:semicolon
id|start
op_add_assign
l_int|0x400
suffix:semicolon
)brace
)brace
DECL|function|blast_dcache32_page_indexed
r_extern
r_inline
r_void
id|blast_dcache32_page_indexed
c_func
(paren
r_int
r_int
id|page
)paren
(brace
r_int
r_int
id|start
op_assign
id|page
suffix:semicolon
r_int
r_int
id|end
op_assign
(paren
id|start
op_plus
id|PAGE_SIZE
)paren
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
id|cache32_unroll32
c_func
(paren
id|start
comma
id|Index_Writeback_Inv_D
)paren
suffix:semicolon
id|cache32_unroll32
c_func
(paren
id|start
op_plus
l_int|1
comma
id|Index_Writeback_Inv_D
)paren
suffix:semicolon
id|start
op_add_assign
l_int|0x400
suffix:semicolon
)brace
)brace
DECL|function|blast_icache32
r_extern
r_inline
r_void
id|blast_icache32
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|start
op_assign
id|KSEG0
suffix:semicolon
r_int
r_int
id|end
op_assign
(paren
id|start
op_plus
id|icache_size
op_div
l_int|2
)paren
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
id|cache32_unroll32
c_func
(paren
id|start
comma
id|Index_Invalidate_I
)paren
suffix:semicolon
id|cache32_unroll32
c_func
(paren
id|start
op_plus
l_int|1
comma
id|Index_Invalidate_I
)paren
suffix:semicolon
id|start
op_add_assign
l_int|0x400
suffix:semicolon
)brace
)brace
DECL|function|blast_icache32_page
r_extern
r_inline
r_void
id|blast_icache32_page
c_func
(paren
r_int
r_int
id|page
)paren
(brace
r_int
r_int
id|start
op_assign
id|page
suffix:semicolon
r_int
r_int
id|end
op_assign
(paren
id|start
op_plus
id|PAGE_SIZE
)paren
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
id|cache32_unroll32
c_func
(paren
id|start
comma
id|Hit_Invalidate_I
)paren
suffix:semicolon
id|start
op_add_assign
l_int|0x400
suffix:semicolon
)brace
)brace
DECL|function|blast_icache32_page_indexed
r_extern
r_inline
r_void
id|blast_icache32_page_indexed
c_func
(paren
r_int
r_int
id|page
)paren
(brace
r_int
r_int
id|start
op_assign
id|page
suffix:semicolon
r_int
r_int
id|end
op_assign
(paren
id|start
op_plus
id|PAGE_SIZE
)paren
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
id|cache32_unroll32
c_func
(paren
id|start
comma
id|Index_Invalidate_I
)paren
suffix:semicolon
id|cache32_unroll32
c_func
(paren
id|start
op_plus
l_int|1
comma
id|Index_Invalidate_I
)paren
suffix:semicolon
id|start
op_add_assign
l_int|0x400
suffix:semicolon
)brace
)brace
multiline_comment|/* -------------------------------------------------------------------- */
DECL|function|r5432_clear_page_d32
r_static
r_void
id|r5432_clear_page_d32
c_func
(paren
r_void
op_star
id|page
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;.set&bslash;tnoreorder&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tnoat&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tmips3&bslash;n&bslash;t&quot;
l_string|&quot;daddiu&bslash;t$1,%0,%2&bslash;n&quot;
l_string|&quot;1:&bslash;tcache&bslash;t%3,(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sd&bslash;t$0,(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sd&bslash;t$0,8(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sd&bslash;t$0,16(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sd&bslash;t$0,24(%0)&bslash;n&bslash;t&quot;
l_string|&quot;daddiu&bslash;t%0,64&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%3,-32(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sd&bslash;t$0,-32(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sd&bslash;t$0,-24(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sd&bslash;t$0,-16(%0)&bslash;n&bslash;t&quot;
l_string|&quot;bne&bslash;t$1,%0,1b&bslash;n&bslash;t&quot;
l_string|&quot;sd&bslash;t$0,-8(%0)&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tmips0&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tat&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;treorder&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|page
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|page
)paren
comma
l_string|&quot;I&quot;
(paren
id|PAGE_SIZE
)paren
comma
l_string|&quot;i&quot;
(paren
id|Create_Dirty_Excl_D
)paren
suffix:colon
l_string|&quot;$1&quot;
comma
l_string|&quot;memory&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This is still inefficient.  We only can do better if we know the&n; * virtual address where the copy will be accessed.&n; */
DECL|function|r5432_copy_page_d32
r_static
r_void
id|r5432_copy_page_d32
c_func
(paren
r_void
op_star
id|to
comma
r_void
op_star
id|from
)paren
(brace
r_int
r_int
id|dummy1
comma
id|dummy2
suffix:semicolon
r_int
r_int
id|reg1
comma
id|reg2
comma
id|reg3
comma
id|reg4
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;.set&bslash;tnoreorder&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tnoat&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tmips3&bslash;n&bslash;t&quot;
l_string|&quot;daddiu&bslash;t$1,%0,%8&bslash;n&quot;
l_string|&quot;1:&bslash;tcache&bslash;t%9,(%0)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%2,(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%3,4(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%4,8(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%5,12(%1)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%2,(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%3,4(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%4,8(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%5,12(%0)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%2,16(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%3,20(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%4,24(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%5,28(%1)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%2,16(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%3,20(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%4,24(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%5,28(%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%9,32(%0)&bslash;n&bslash;t&quot;
l_string|&quot;daddiu&bslash;t%0,64&bslash;n&bslash;t&quot;
l_string|&quot;daddiu&bslash;t%1,64&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%2,-32(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%3,-28(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%4,-24(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%5,-20(%1)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%2,-32(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%3,-28(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%4,-24(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%5,-20(%0)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%2,-16(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%3,-12(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%4,-8(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%5,-4(%1)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%2,-16(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%3,-12(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%4,-8(%0)&bslash;n&bslash;t&quot;
l_string|&quot;bne&bslash;t$1,%0,1b&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%5,-4(%0)&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tmips0&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tat&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;treorder&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|dummy1
)paren
comma
l_string|&quot;=r&quot;
(paren
id|dummy2
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|reg1
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|reg2
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|reg3
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|reg4
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|to
)paren
comma
l_string|&quot;1&quot;
(paren
id|from
)paren
comma
l_string|&quot;I&quot;
(paren
id|PAGE_SIZE
)paren
comma
l_string|&quot;i&quot;
(paren
id|Create_Dirty_Excl_D
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * If you think for one second that this stuff coming up is a lot&n; * of bulky code eating too many kernel cache lines.  Think _again_.&n; *&n; * Consider:&n; * 1) Taken branches have a 3 cycle penalty on R4k&n; * 2) The branch itself is a real dead cycle on even R4600/R5000.&n; * 3) Only one of the following variants of each type is even used by&n; *    the kernel based upon the cache parameters we detect at boot time.&n; *&n; * QED.&n; */
DECL|function|r5432_flush_cache_all_d32i32
r_static
r_inline
r_void
id|r5432_flush_cache_all_d32i32
c_func
(paren
r_void
)paren
(brace
id|blast_dcache32
c_func
(paren
)paren
suffix:semicolon
id|blast_icache32
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|r5432_flush_cache_range_d32i32
r_static
r_void
id|r5432_flush_cache_range_d32i32
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
r_if
c_cond
(paren
id|mm-&gt;context
op_ne
l_int|0
)paren
(brace
macro_line|#ifdef DEBUG_CACHE
id|printk
c_func
(paren
l_string|&quot;crange[%d,%08lx,%08lx]&quot;
comma
(paren
r_int
)paren
id|mm-&gt;context
comma
id|start
comma
id|end
)paren
suffix:semicolon
macro_line|#endif
id|blast_dcache32
c_func
(paren
)paren
suffix:semicolon
id|blast_icache32
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * On architectures like the Sparc, we could get rid of lines in&n; * the cache created only by a certain context, but on the MIPS&n; * (and actually certain Sparc&squot;s) we cannot.&n; */
DECL|function|r5432_flush_cache_mm_d32i32
r_static
r_void
id|r5432_flush_cache_mm_d32i32
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
r_if
c_cond
(paren
id|mm-&gt;context
op_ne
l_int|0
)paren
(brace
macro_line|#ifdef DEBUG_CACHE
id|printk
c_func
(paren
l_string|&quot;cmm[%d]&quot;
comma
(paren
r_int
)paren
id|mm-&gt;context
)paren
suffix:semicolon
macro_line|#endif
id|r5432_flush_cache_all_d32i32
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|r5432_flush_cache_page_d32i32
r_static
r_void
id|r5432_flush_cache_page_d32i32
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
(brace
r_struct
id|mm_struct
op_star
id|mm
op_assign
id|vma-&gt;vm_mm
suffix:semicolon
id|pgd_t
op_star
id|pgdp
suffix:semicolon
id|pmd_t
op_star
id|pmdp
suffix:semicolon
id|pte_t
op_star
id|ptep
suffix:semicolon
multiline_comment|/*&n;&t; * If ownes no valid ASID yet, cannot possibly have gotten&n;&t; * this page into the cache.&n;&t; */
r_if
c_cond
(paren
id|mm-&gt;context
op_eq
l_int|0
)paren
r_return
suffix:semicolon
macro_line|#ifdef DEBUG_CACHE
id|printk
c_func
(paren
l_string|&quot;cpage[%d,%08lx]&quot;
comma
(paren
r_int
)paren
id|mm-&gt;context
comma
id|page
)paren
suffix:semicolon
macro_line|#endif
id|page
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|pgdp
op_assign
id|pgd_offset
c_func
(paren
id|mm
comma
id|page
)paren
suffix:semicolon
id|pmdp
op_assign
id|pmd_offset
c_func
(paren
id|pgdp
comma
id|page
)paren
suffix:semicolon
id|ptep
op_assign
id|pte_offset
c_func
(paren
id|pmdp
comma
id|page
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If the page isn&squot;t marked valid, the page cannot possibly be&n;&t; * in the cache.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|pte_val
c_func
(paren
op_star
id|ptep
)paren
op_amp
id|_PAGE_PRESENT
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * Doing flushes for another ASID than the current one is&n;&t; * too difficult since stupid R4k caches do a TLB translation&n;&t; * for every cache flush operation.  So we do indexed flushes&n;&t; * in that case, which doesn&squot;t overly flush the cache too much.&n;&t; */
r_if
c_cond
(paren
(paren
id|mm
op_eq
id|current-&gt;active_mm
)paren
op_logical_and
(paren
id|pte_val
c_func
(paren
op_star
id|ptep
)paren
op_amp
id|_PAGE_VALID
)paren
)paren
(brace
id|blast_dcache32_page
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Do indexed flush, too much work to get the (possible)&n;&t;&t; * tlb refills to work correctly.&n;&t;&t; */
id|page
op_assign
(paren
id|KSEG0
op_plus
(paren
id|page
op_amp
(paren
id|dcache_size
op_minus
l_int|1
)paren
)paren
)paren
suffix:semicolon
id|blast_dcache32_page_indexed
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* If the addresses passed to these routines are valid, they are&n; * either:&n; *&n; * 1) In KSEG0, so we can do a direct flush of the page.&n; * 2) In KSEG2, and since every process can translate those&n; *    addresses all the time in kernel mode we can do a direct&n; *    flush.&n; * 3) In KSEG1, no flush necessary.&n; */
DECL|function|r5432_flush_page_to_ram_d32
r_static
r_void
id|r5432_flush_page_to_ram_d32
c_func
(paren
r_struct
id|page
op_star
id|page
)paren
(brace
id|blast_dcache32_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page_address
c_func
(paren
id|page
)paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|r5432_flush_icache_range
id|r5432_flush_icache_range
c_func
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
id|r5432_flush_cache_all_d32i32
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Ok, this seriously sucks.  We use them to flush a user page but don&squot;t&n; * know the virtual address, so we have to blast away the whole icache&n; * which is significantly more expensive than the real thing.&n; */
r_static
r_void
DECL|function|r5432_flush_icache_page_i32
id|r5432_flush_icache_page_i32
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_struct
id|page
op_star
id|page
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_EXEC
)paren
)paren
r_return
suffix:semicolon
id|r5432_flush_cache_all_d32i32
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Writeback and invalidate the primary cache dcache before DMA.&n; */
r_static
r_void
DECL|function|r5432_dma_cache_wback_inv_pc
id|r5432_dma_cache_wback_inv_pc
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|end
comma
id|a
suffix:semicolon
r_if
c_cond
(paren
id|size
op_ge
id|dcache_size
)paren
(brace
id|flush_cache_all
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|a
op_assign
id|addr
op_amp
op_complement
(paren
id|dc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
id|end
op_assign
(paren
id|addr
op_plus
id|size
)paren
op_amp
op_complement
(paren
id|dc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|flush_dcache_line
c_func
(paren
id|a
)paren
suffix:semicolon
multiline_comment|/* Hit_Writeback_Inv_D */
r_if
c_cond
(paren
id|a
op_eq
id|end
)paren
r_break
suffix:semicolon
id|a
op_add_assign
id|dc_lsize
suffix:semicolon
)brace
)brace
id|bc_wback_inv
c_func
(paren
id|addr
comma
id|size
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|r5432_dma_cache_inv_pc
id|r5432_dma_cache_inv_pc
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|end
comma
id|a
suffix:semicolon
r_if
c_cond
(paren
id|size
op_ge
id|dcache_size
)paren
(brace
id|flush_cache_all
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|a
op_assign
id|addr
op_amp
op_complement
(paren
id|dc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
id|end
op_assign
(paren
id|addr
op_plus
id|size
)paren
op_amp
op_complement
(paren
id|dc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|flush_dcache_line
c_func
(paren
id|a
)paren
suffix:semicolon
multiline_comment|/* Hit_Writeback_Inv_D */
r_if
c_cond
(paren
id|a
op_eq
id|end
)paren
r_break
suffix:semicolon
id|a
op_add_assign
id|dc_lsize
suffix:semicolon
)brace
)brace
id|bc_inv
c_func
(paren
id|addr
comma
id|size
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|r5432_dma_cache_wback
id|r5432_dma_cache_wback
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|size
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;r5432_dma_cache called - should not happen.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * While we&squot;re protected against bad userland addresses we don&squot;t care&n; * very much about what happens in that case.  Usually a segmentation&n; * fault will dump the process later on anyway ...&n; */
DECL|function|r5432_flush_cache_sigtramp
r_static
r_void
id|r5432_flush_cache_sigtramp
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
id|protected_writeback_dcache_line
c_func
(paren
id|addr
op_amp
op_complement
(paren
id|dc_lsize
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|protected_flush_icache_line
c_func
(paren
id|addr
op_amp
op_complement
(paren
id|ic_lsize
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
DECL|macro|DEBUG_TLB
macro_line|#undef DEBUG_TLB
DECL|macro|DEBUG_TLBUPDATE
macro_line|#undef DEBUG_TLBUPDATE
DECL|macro|NTLB_ENTRIES
mdefine_line|#define NTLB_ENTRIES       48  /* Fixed on all R4XX0 variants... */
DECL|macro|NTLB_ENTRIES_HALF
mdefine_line|#define NTLB_ENTRIES_HALF  24  /* Fixed on all R4XX0 variants... */
DECL|function|flush_tlb_all
r_void
id|flush_tlb_all
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|old_ctx
suffix:semicolon
r_int
id|entry
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef DEBUG_TLB
id|printk
c_func
(paren
l_string|&quot;[tlball]&quot;
)paren
suffix:semicolon
macro_line|#endif
id|__save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Save old context and create impossible VPN2 value */
id|old_ctx
op_assign
(paren
id|get_entryhi
c_func
(paren
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|set_entryhi
c_func
(paren
id|KSEG0
)paren
suffix:semicolon
id|set_entrylo0
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|set_entrylo1
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|entry
op_assign
id|get_wired
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Blast &squot;em all away. */
r_while
c_loop
(paren
id|entry
OL
id|NTLB_ENTRIES
)paren
(brace
id|set_index
c_func
(paren
id|entry
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|tlb_write_indexed
c_func
(paren
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|entry
op_increment
suffix:semicolon
)brace
id|BARRIER
suffix:semicolon
id|set_entryhi
c_func
(paren
id|old_ctx
)paren
suffix:semicolon
id|__restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|flush_tlb_mm
r_void
id|flush_tlb_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
r_if
c_cond
(paren
id|mm-&gt;context
op_ne
l_int|0
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef DEBUG_TLB
id|printk
c_func
(paren
l_string|&quot;[tlbmm&lt;%d&gt;]&quot;
comma
id|mm-&gt;context
)paren
suffix:semicolon
macro_line|#endif
id|__save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|get_new_mmu_context
c_func
(paren
id|mm
comma
id|asid_cache
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mm
op_eq
id|current-&gt;active_mm
)paren
id|set_entryhi
c_func
(paren
id|mm-&gt;context
op_amp
l_int|0xff
)paren
suffix:semicolon
id|__restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|flush_tlb_range
r_void
id|flush_tlb_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
r_if
c_cond
(paren
id|mm-&gt;context
op_ne
l_int|0
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|size
suffix:semicolon
macro_line|#ifdef DEBUG_TLB
id|printk
c_func
(paren
l_string|&quot;[tlbrange&lt;%02x,%08lx,%08lx&gt;]&quot;
comma
(paren
id|mm-&gt;context
op_amp
l_int|0xff
)paren
comma
id|start
comma
id|end
)paren
suffix:semicolon
macro_line|#endif
id|__save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|size
op_assign
(paren
id|end
op_minus
id|start
op_plus
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|size
op_assign
(paren
id|size
op_plus
l_int|1
)paren
op_rshift
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|size
op_le
id|NTLB_ENTRIES_HALF
)paren
(brace
r_int
id|oldpid
op_assign
(paren
id|get_entryhi
c_func
(paren
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
r_int
id|newpid
op_assign
(paren
id|mm-&gt;context
op_amp
l_int|0xff
)paren
suffix:semicolon
id|start
op_and_assign
(paren
id|PAGE_MASK
op_lshift
l_int|1
)paren
suffix:semicolon
id|end
op_add_assign
(paren
(paren
id|PAGE_SIZE
op_lshift
l_int|1
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|end
op_and_assign
(paren
id|PAGE_MASK
op_lshift
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
r_int
id|idx
suffix:semicolon
id|set_entryhi
c_func
(paren
id|start
op_or
id|newpid
)paren
suffix:semicolon
id|start
op_add_assign
(paren
id|PAGE_SIZE
op_lshift
l_int|1
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|tlb_probe
c_func
(paren
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|idx
op_assign
id|get_index
c_func
(paren
)paren
suffix:semicolon
id|set_entrylo0
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|set_entrylo1
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|set_entryhi
c_func
(paren
id|KSEG0
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
r_if
c_cond
(paren
id|idx
OL
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
id|tlb_write_indexed
c_func
(paren
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
)brace
id|set_entryhi
c_func
(paren
id|oldpid
)paren
suffix:semicolon
)brace
r_else
(brace
id|get_new_mmu_context
c_func
(paren
id|mm
comma
id|asid_cache
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mm
op_eq
id|current-&gt;active_mm
)paren
id|set_entryhi
c_func
(paren
id|mm-&gt;context
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
id|__restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|flush_tlb_page
r_void
id|flush_tlb_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
(brace
r_if
c_cond
(paren
id|vma-&gt;vm_mm-&gt;context
op_ne
l_int|0
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|oldpid
comma
id|newpid
comma
id|idx
suffix:semicolon
macro_line|#ifdef DEBUG_TLB
id|printk
c_func
(paren
l_string|&quot;[tlbpage&lt;%d,%08lx&gt;]&quot;
comma
id|vma-&gt;vm_mm-&gt;context
comma
id|page
)paren
suffix:semicolon
macro_line|#endif
id|newpid
op_assign
(paren
id|vma-&gt;vm_mm-&gt;context
op_amp
l_int|0xff
)paren
suffix:semicolon
id|page
op_and_assign
(paren
id|PAGE_MASK
op_lshift
l_int|1
)paren
suffix:semicolon
id|__save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|oldpid
op_assign
(paren
id|get_entryhi
c_func
(paren
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|set_entryhi
c_func
(paren
id|page
op_or
id|newpid
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|tlb_probe
c_func
(paren
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|idx
op_assign
id|get_index
c_func
(paren
)paren
suffix:semicolon
id|set_entrylo0
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|set_entrylo1
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|set_entryhi
c_func
(paren
id|KSEG0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idx
OL
l_int|0
)paren
(brace
r_goto
id|finish
suffix:semicolon
)brace
id|BARRIER
suffix:semicolon
id|tlb_write_indexed
c_func
(paren
)paren
suffix:semicolon
id|finish
suffix:colon
id|BARRIER
suffix:semicolon
id|set_entryhi
c_func
(paren
id|oldpid
)paren
suffix:semicolon
id|__restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|pgd_init
r_void
id|pgd_init
c_func
(paren
r_int
r_int
id|page
)paren
(brace
r_int
r_int
op_star
id|p
op_assign
(paren
r_int
r_int
op_star
)paren
id|page
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|USER_PTRS_PER_PGD
suffix:semicolon
id|i
op_add_assign
l_int|8
)paren
(brace
id|p
(braket
id|i
op_plus
l_int|0
)braket
op_assign
(paren
r_int
r_int
)paren
id|invalid_pte_table
suffix:semicolon
id|p
(braket
id|i
op_plus
l_int|1
)braket
op_assign
(paren
r_int
r_int
)paren
id|invalid_pte_table
suffix:semicolon
id|p
(braket
id|i
op_plus
l_int|2
)braket
op_assign
(paren
r_int
r_int
)paren
id|invalid_pte_table
suffix:semicolon
id|p
(braket
id|i
op_plus
l_int|3
)braket
op_assign
(paren
r_int
r_int
)paren
id|invalid_pte_table
suffix:semicolon
id|p
(braket
id|i
op_plus
l_int|4
)braket
op_assign
(paren
r_int
r_int
)paren
id|invalid_pte_table
suffix:semicolon
id|p
(braket
id|i
op_plus
l_int|5
)braket
op_assign
(paren
r_int
r_int
)paren
id|invalid_pte_table
suffix:semicolon
id|p
(braket
id|i
op_plus
l_int|6
)braket
op_assign
(paren
r_int
r_int
)paren
id|invalid_pte_table
suffix:semicolon
id|p
(braket
id|i
op_plus
l_int|7
)braket
op_assign
(paren
r_int
r_int
)paren
id|invalid_pte_table
suffix:semicolon
)brace
)brace
multiline_comment|/* We will need multiple versions of update_mmu_cache(), one that just&n; * updates the TLB with the new pte(s), and another which also checks&n; * for the R4k &quot;end of page&quot; hardware bug and does the needy.&n; */
DECL|function|update_mmu_cache
r_void
id|update_mmu_cache
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|address
comma
id|pte_t
id|pte
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|pgd_t
op_star
id|pgdp
suffix:semicolon
id|pmd_t
op_star
id|pmdp
suffix:semicolon
id|pte_t
op_star
id|ptep
suffix:semicolon
r_int
id|idx
comma
id|pid
suffix:semicolon
multiline_comment|/*&n;&t; * Handle debugger faulting in for debugee.&n;&t; */
r_if
c_cond
(paren
id|current-&gt;active_mm
op_ne
id|vma-&gt;vm_mm
)paren
r_return
suffix:semicolon
id|pid
op_assign
id|get_entryhi
c_func
(paren
)paren
op_amp
l_int|0xff
suffix:semicolon
macro_line|#ifdef DEBUG_TLB
r_if
c_cond
(paren
(paren
id|pid
op_ne
(paren
id|vma-&gt;vm_mm-&gt;context
op_amp
l_int|0xff
)paren
)paren
op_logical_or
(paren
id|vma-&gt;vm_mm-&gt;context
op_eq
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;update_mmu_cache: Wheee, bogus tlbpid mmpid=%d tlbpid=%d&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|vma-&gt;vm_mm-&gt;context
op_amp
l_int|0xff
)paren
comma
id|pid
)paren
suffix:semicolon
)brace
macro_line|#endif
id|__save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|address
op_and_assign
(paren
id|PAGE_MASK
op_lshift
l_int|1
)paren
suffix:semicolon
id|set_entryhi
c_func
(paren
id|address
op_or
(paren
id|pid
)paren
)paren
suffix:semicolon
id|pgdp
op_assign
id|pgd_offset
c_func
(paren
id|vma-&gt;vm_mm
comma
id|address
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|tlb_probe
c_func
(paren
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|pmdp
op_assign
id|pmd_offset
c_func
(paren
id|pgdp
comma
id|address
)paren
suffix:semicolon
id|idx
op_assign
id|get_index
c_func
(paren
)paren
suffix:semicolon
id|ptep
op_assign
id|pte_offset
c_func
(paren
id|pmdp
comma
id|address
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|set_entrylo0
c_func
(paren
id|pte_val
c_func
(paren
op_star
id|ptep
op_increment
)paren
op_rshift
l_int|6
)paren
suffix:semicolon
id|set_entrylo1
c_func
(paren
id|pte_val
c_func
(paren
op_star
id|ptep
)paren
op_rshift
l_int|6
)paren
suffix:semicolon
id|set_entryhi
c_func
(paren
id|address
op_or
(paren
id|pid
)paren
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
r_if
c_cond
(paren
id|idx
OL
l_int|0
)paren
(brace
id|tlb_write_random
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|tlb_write_indexed
c_func
(paren
)paren
suffix:semicolon
)brace
id|BARRIER
suffix:semicolon
id|set_entryhi
c_func
(paren
id|pid
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|__restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|show_regs
r_void
id|show_regs
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
multiline_comment|/* Saved main processor registers. */
id|printk
c_func
(paren
l_string|&quot;$0 : %08lx %08lx %08lx %08lx&bslash;n&quot;
comma
l_int|0UL
comma
id|regs-&gt;regs
(braket
l_int|1
)braket
comma
id|regs-&gt;regs
(braket
l_int|2
)braket
comma
id|regs-&gt;regs
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;$4 : %08lx %08lx %08lx %08lx&bslash;n&quot;
comma
id|regs-&gt;regs
(braket
l_int|4
)braket
comma
id|regs-&gt;regs
(braket
l_int|5
)braket
comma
id|regs-&gt;regs
(braket
l_int|6
)braket
comma
id|regs-&gt;regs
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;$8 : %08lx %08lx %08lx %08lx&bslash;n&quot;
comma
id|regs-&gt;regs
(braket
l_int|8
)braket
comma
id|regs-&gt;regs
(braket
l_int|9
)braket
comma
id|regs-&gt;regs
(braket
l_int|10
)braket
comma
id|regs-&gt;regs
(braket
l_int|11
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;$12: %08lx %08lx %08lx %08lx&bslash;n&quot;
comma
id|regs-&gt;regs
(braket
l_int|12
)braket
comma
id|regs-&gt;regs
(braket
l_int|13
)braket
comma
id|regs-&gt;regs
(braket
l_int|14
)braket
comma
id|regs-&gt;regs
(braket
l_int|15
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;$16: %08lx %08lx %08lx %08lx&bslash;n&quot;
comma
id|regs-&gt;regs
(braket
l_int|16
)braket
comma
id|regs-&gt;regs
(braket
l_int|17
)braket
comma
id|regs-&gt;regs
(braket
l_int|18
)braket
comma
id|regs-&gt;regs
(braket
l_int|19
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;$20: %08lx %08lx %08lx %08lx&bslash;n&quot;
comma
id|regs-&gt;regs
(braket
l_int|20
)braket
comma
id|regs-&gt;regs
(braket
l_int|21
)braket
comma
id|regs-&gt;regs
(braket
l_int|22
)braket
comma
id|regs-&gt;regs
(braket
l_int|23
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;$24: %08lx %08lx&bslash;n&quot;
comma
id|regs-&gt;regs
(braket
l_int|24
)braket
comma
id|regs-&gt;regs
(braket
l_int|25
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;$28: %08lx %08lx %08lx %08lx&bslash;n&quot;
comma
id|regs-&gt;regs
(braket
l_int|28
)braket
comma
id|regs-&gt;regs
(braket
l_int|29
)braket
comma
id|regs-&gt;regs
(braket
l_int|30
)braket
comma
id|regs-&gt;regs
(braket
l_int|31
)braket
)paren
suffix:semicolon
multiline_comment|/* Saved cp0 registers. */
id|printk
c_func
(paren
l_string|&quot;epc   : %08lx    %s&bslash;nStatus: %08lx&bslash;nCause : %08lx&bslash;n&quot;
comma
id|regs-&gt;cp0_epc
comma
id|print_tainted
c_func
(paren
)paren
comma
id|regs-&gt;cp0_status
comma
id|regs-&gt;cp0_cause
)paren
suffix:semicolon
)brace
DECL|function|add_wired_entry
r_void
id|add_wired_entry
c_func
(paren
r_int
r_int
id|entrylo0
comma
r_int
r_int
id|entrylo1
comma
r_int
r_int
id|entryhi
comma
r_int
r_int
id|pagemask
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|wired
suffix:semicolon
r_int
r_int
id|old_pagemask
suffix:semicolon
r_int
r_int
id|old_ctx
suffix:semicolon
id|__save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Save old context and create impossible VPN2 value */
id|old_ctx
op_assign
(paren
id|get_entryhi
c_func
(paren
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|old_pagemask
op_assign
id|get_pagemask
c_func
(paren
)paren
suffix:semicolon
id|wired
op_assign
id|get_wired
c_func
(paren
)paren
suffix:semicolon
id|set_wired
(paren
id|wired
op_plus
l_int|1
)paren
suffix:semicolon
id|set_index
(paren
id|wired
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|set_pagemask
(paren
id|pagemask
)paren
suffix:semicolon
id|set_entryhi
c_func
(paren
id|entryhi
)paren
suffix:semicolon
id|set_entrylo0
c_func
(paren
id|entrylo0
)paren
suffix:semicolon
id|set_entrylo1
c_func
(paren
id|entrylo1
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|tlb_write_indexed
c_func
(paren
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|set_entryhi
c_func
(paren
id|old_ctx
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|set_pagemask
(paren
id|old_pagemask
)paren
suffix:semicolon
id|flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
id|__restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Detect and size the various r4k caches. */
DECL|function|probe_icache
r_static
r_void
id|__init
id|probe_icache
c_func
(paren
r_int
r_int
id|config
)paren
(brace
id|icache_size
op_assign
l_int|1
op_lshift
(paren
l_int|12
op_plus
(paren
(paren
id|config
op_rshift
l_int|9
)paren
op_amp
l_int|7
)paren
)paren
suffix:semicolon
id|ic_lsize
op_assign
l_int|16
op_lshift
(paren
(paren
id|config
op_rshift
l_int|5
)paren
op_amp
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Primary instruction cache %dkb, linesize %d bytes.&bslash;n&quot;
comma
id|icache_size
op_rshift
l_int|10
comma
id|ic_lsize
)paren
suffix:semicolon
)brace
DECL|function|probe_dcache
r_static
r_void
id|__init
id|probe_dcache
c_func
(paren
r_int
r_int
id|config
)paren
(brace
id|dcache_size
op_assign
l_int|1
op_lshift
(paren
l_int|12
op_plus
(paren
(paren
id|config
op_rshift
l_int|6
)paren
op_amp
l_int|7
)paren
)paren
suffix:semicolon
id|dc_lsize
op_assign
l_int|16
op_lshift
(paren
(paren
id|config
op_rshift
l_int|4
)paren
op_amp
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Primary data cache %dkb, linesize %d bytes.&bslash;n&quot;
comma
id|dcache_size
op_rshift
l_int|10
comma
id|dc_lsize
)paren
suffix:semicolon
)brace
DECL|function|ld_mmu_r5432
r_void
id|__init
id|ld_mmu_r5432
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|config
op_assign
id|read_32bit_cp0_register
c_func
(paren
id|CP0_CONFIG
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;CPU revision is: %08x&bslash;n&quot;
comma
id|read_32bit_cp0_register
c_func
(paren
id|CP0_PRID
)paren
)paren
suffix:semicolon
id|change_cp0_config
c_func
(paren
id|CONF_CM_CMASK
comma
id|CONF_CM_CACHABLE_NONCOHERENT
)paren
suffix:semicolon
id|probe_icache
c_func
(paren
id|config
)paren
suffix:semicolon
id|probe_dcache
c_func
(paren
id|config
)paren
suffix:semicolon
id|_clear_page
op_assign
id|r5432_clear_page_d32
suffix:semicolon
id|_copy_page
op_assign
id|r5432_copy_page_d32
suffix:semicolon
id|_flush_cache_all
op_assign
id|r5432_flush_cache_all_d32i32
suffix:semicolon
id|___flush_cache_all
op_assign
id|r5432_flush_cache_all_d32i32
suffix:semicolon
id|_flush_page_to_ram
op_assign
id|r5432_flush_page_to_ram_d32
suffix:semicolon
id|_flush_cache_mm
op_assign
id|r5432_flush_cache_mm_d32i32
suffix:semicolon
id|_flush_cache_range
op_assign
id|r5432_flush_cache_range_d32i32
suffix:semicolon
id|_flush_cache_page
op_assign
id|r5432_flush_cache_page_d32i32
suffix:semicolon
id|_flush_icache_page
op_assign
id|r5432_flush_icache_page_i32
suffix:semicolon
id|_dma_cache_wback_inv
op_assign
id|r5432_dma_cache_wback_inv_pc
suffix:semicolon
id|_dma_cache_wback
op_assign
id|r5432_dma_cache_wback
suffix:semicolon
id|_dma_cache_inv
op_assign
id|r5432_dma_cache_inv_pc
suffix:semicolon
id|_flush_cache_sigtramp
op_assign
id|r5432_flush_cache_sigtramp
suffix:semicolon
id|_flush_icache_range
op_assign
id|r5432_flush_icache_range
suffix:semicolon
multiline_comment|/* Ouch */
id|__flush_cache_all
c_func
(paren
)paren
suffix:semicolon
id|write_32bit_cp0_register
c_func
(paren
id|CP0_WIRED
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * You should never change this register:&n;&t; *   - On R4600 1.7 the tlbp never hits for pages smaller than&n;&t; *     the value in the c0_pagemask register.&n;&t; *   - The entire mm handling assumes the c0_pagemask register to&n;&t; *     be set for 4kb pages.&n;&t; */
id|write_32bit_cp0_register
c_func
(paren
id|CP0_PAGEMASK
comma
id|PM_4K
)paren
suffix:semicolon
id|flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
)brace
eof
