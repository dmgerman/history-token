multiline_comment|/*&n; * r2300.c: R2000 and R3000 specific mmu/cache code.&n; *&n; * Copyright (C) 1996 David S. Miller (dm@engr.sgi.com)&n; *&n; * with a lot of changes to make this thing work for R3000s&n; * Tx39XX R4k style caches added. HK&n; * Copyright (C) 1998, 1999, 2000 Harald Koerfgen&n; * Copyright (C) 1998 Gleb Raiko &amp; Vladimir Roganov&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/cacheops.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/mmu_context.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/isadep.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#include &lt;asm/cpu.h&gt;
multiline_comment|/* For R3000 cores with R4000 style caches */
DECL|variable|icache_size
DECL|variable|dcache_size
r_static
r_int
r_int
id|icache_size
comma
id|dcache_size
suffix:semicolon
multiline_comment|/* Size in bytes */
macro_line|#include &lt;asm/r4kcache.h&gt;
r_extern
r_int
id|r3k_have_wired_reg
suffix:semicolon
multiline_comment|/* in r3k-tlb.c */
multiline_comment|/* This sequence is required to ensure icache is disabled immediately */
DECL|macro|TX39_STOP_STREAMING
mdefine_line|#define TX39_STOP_STREAMING() &bslash;&n;__asm__ __volatile__( &bslash;&n;&t;&quot;.set    push&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;.set    noreorder&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;b       1f&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;nop&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;1:&bslash;n&bslash;t&quot; &bslash;&n;&t;&quot;.set pop&quot; &bslash;&n;&t;)
multiline_comment|/* TX39H-style cache flush routines. */
DECL|function|tx39h_flush_icache_all
r_static
r_void
id|tx39h_flush_icache_all
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|start
op_assign
id|KSEG0
suffix:semicolon
r_int
r_int
id|end
op_assign
(paren
id|start
op_plus
id|icache_size
)paren
suffix:semicolon
r_int
r_int
id|flags
comma
id|config
suffix:semicolon
multiline_comment|/* disable icache (set ICE#) */
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|config
op_assign
id|read_c0_conf
c_func
(paren
)paren
suffix:semicolon
id|write_c0_conf
c_func
(paren
id|config
op_amp
op_complement
id|TX39_CONF_ICE
)paren
suffix:semicolon
id|TX39_STOP_STREAMING
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* invalidate icache */
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
id|cache16_unroll32
c_func
(paren
id|start
comma
id|Index_Invalidate_I
)paren
suffix:semicolon
id|start
op_add_assign
l_int|0x200
suffix:semicolon
)brace
id|write_c0_conf
c_func
(paren
id|config
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|tx39h_dma_cache_wback_inv
r_static
r_void
id|tx39h_dma_cache_wback_inv
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|end
comma
id|a
suffix:semicolon
r_int
r_int
id|dc_lsize
op_assign
id|current_cpu_data.dcache.linesz
suffix:semicolon
multiline_comment|/* Catch bad driver code */
id|BUG_ON
c_func
(paren
id|size
op_eq
l_int|0
)paren
suffix:semicolon
id|iob
c_func
(paren
)paren
suffix:semicolon
id|a
op_assign
id|addr
op_amp
op_complement
(paren
id|dc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
id|end
op_assign
(paren
id|addr
op_plus
id|size
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|dc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|invalidate_dcache_line
c_func
(paren
id|a
)paren
suffix:semicolon
multiline_comment|/* Hit_Invalidate_D */
r_if
c_cond
(paren
id|a
op_eq
id|end
)paren
r_break
suffix:semicolon
id|a
op_add_assign
id|dc_lsize
suffix:semicolon
)brace
)brace
multiline_comment|/* TX39H2,TX39H3 */
DECL|function|tx39_blast_dcache_page
r_static
r_inline
r_void
id|tx39_blast_dcache_page
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_if
c_cond
(paren
id|current_cpu_data.cputype
op_ne
id|CPU_TX3912
)paren
id|blast_dcache16_page
c_func
(paren
id|addr
)paren
suffix:semicolon
)brace
DECL|function|tx39_blast_dcache_page_indexed
r_static
r_inline
r_void
id|tx39_blast_dcache_page_indexed
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
id|blast_dcache16_page_indexed
c_func
(paren
id|addr
)paren
suffix:semicolon
)brace
DECL|function|tx39_blast_dcache
r_static
r_inline
r_void
id|tx39_blast_dcache
c_func
(paren
r_void
)paren
(brace
id|blast_dcache16
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|tx39_blast_icache_page
r_static
r_inline
r_void
id|tx39_blast_icache_page
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_int
r_int
id|flags
comma
id|config
suffix:semicolon
multiline_comment|/* disable icache (set ICE#) */
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|config
op_assign
id|read_c0_conf
c_func
(paren
)paren
suffix:semicolon
id|write_c0_conf
c_func
(paren
id|config
op_amp
op_complement
id|TX39_CONF_ICE
)paren
suffix:semicolon
id|TX39_STOP_STREAMING
c_func
(paren
)paren
suffix:semicolon
id|blast_icache16_page
c_func
(paren
id|addr
)paren
suffix:semicolon
id|write_c0_conf
c_func
(paren
id|config
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|tx39_blast_icache_page_indexed
r_static
r_inline
r_void
id|tx39_blast_icache_page_indexed
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_int
r_int
id|flags
comma
id|config
suffix:semicolon
multiline_comment|/* disable icache (set ICE#) */
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|config
op_assign
id|read_c0_conf
c_func
(paren
)paren
suffix:semicolon
id|write_c0_conf
c_func
(paren
id|config
op_amp
op_complement
id|TX39_CONF_ICE
)paren
suffix:semicolon
id|TX39_STOP_STREAMING
c_func
(paren
)paren
suffix:semicolon
id|blast_icache16_page_indexed
c_func
(paren
id|addr
)paren
suffix:semicolon
id|write_c0_conf
c_func
(paren
id|config
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|tx39_blast_icache
r_static
r_inline
r_void
id|tx39_blast_icache
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
comma
id|config
suffix:semicolon
multiline_comment|/* disable icache (set ICE#) */
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|config
op_assign
id|read_c0_conf
c_func
(paren
)paren
suffix:semicolon
id|write_c0_conf
c_func
(paren
id|config
op_amp
op_complement
id|TX39_CONF_ICE
)paren
suffix:semicolon
id|TX39_STOP_STREAMING
c_func
(paren
)paren
suffix:semicolon
id|blast_icache16
c_func
(paren
)paren
suffix:semicolon
id|write_c0_conf
c_func
(paren
id|config
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|tx39_flush_cache_all
r_static
r_inline
r_void
id|tx39_flush_cache_all
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|cpu_has_dc_aliases
)paren
r_return
suffix:semicolon
id|tx39_blast_dcache
c_func
(paren
)paren
suffix:semicolon
id|tx39_blast_icache
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|tx39___flush_cache_all
r_static
r_inline
r_void
id|tx39___flush_cache_all
c_func
(paren
r_void
)paren
(brace
id|tx39_blast_dcache
c_func
(paren
)paren
suffix:semicolon
id|tx39_blast_icache
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|tx39_flush_cache_mm
r_static
r_void
id|tx39_flush_cache_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|cpu_has_dc_aliases
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|cpu_context
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
id|mm
)paren
op_ne
l_int|0
)paren
(brace
id|tx39_flush_cache_all
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|tx39_flush_cache_range
r_static
r_void
id|tx39_flush_cache_range
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
r_struct
id|mm_struct
op_star
id|mm
op_assign
id|vma-&gt;vm_mm
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpu_has_dc_aliases
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|cpu_context
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
id|mm
)paren
op_ne
l_int|0
)paren
(brace
id|tx39_blast_dcache
c_func
(paren
)paren
suffix:semicolon
id|tx39_blast_icache
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|tx39_flush_cache_page
r_static
r_void
id|tx39_flush_cache_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
(brace
r_int
id|exec
op_assign
id|vma-&gt;vm_flags
op_amp
id|VM_EXEC
suffix:semicolon
r_struct
id|mm_struct
op_star
id|mm
op_assign
id|vma-&gt;vm_mm
suffix:semicolon
id|pgd_t
op_star
id|pgdp
suffix:semicolon
id|pmd_t
op_star
id|pmdp
suffix:semicolon
id|pte_t
op_star
id|ptep
suffix:semicolon
multiline_comment|/*&n;&t; * If ownes no valid ASID yet, cannot possibly have gotten&n;&t; * this page into the cache.&n;&t; */
r_if
c_cond
(paren
id|cpu_context
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
id|mm
)paren
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|page
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|pgdp
op_assign
id|pgd_offset
c_func
(paren
id|mm
comma
id|page
)paren
suffix:semicolon
id|pmdp
op_assign
id|pmd_offset
c_func
(paren
id|pgdp
comma
id|page
)paren
suffix:semicolon
id|ptep
op_assign
id|pte_offset
c_func
(paren
id|pmdp
comma
id|page
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If the page isn&squot;t marked valid, the page cannot possibly be&n;&t; * in the cache.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|pte_val
c_func
(paren
op_star
id|ptep
)paren
op_amp
id|_PAGE_PRESENT
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * Doing flushes for another ASID than the current one is&n;&t; * too difficult since stupid R4k caches do a TLB translation&n;&t; * for every cache flush operation.  So we do indexed flushes&n;&t; * in that case, which doesn&squot;t overly flush the cache too much.&n;&t; */
r_if
c_cond
(paren
(paren
id|mm
op_eq
id|current-&gt;active_mm
)paren
op_logical_and
(paren
id|pte_val
c_func
(paren
op_star
id|ptep
)paren
op_amp
id|_PAGE_VALID
)paren
)paren
(brace
r_if
c_cond
(paren
id|cpu_has_dc_aliases
op_logical_or
id|exec
)paren
id|tx39_blast_dcache_page
c_func
(paren
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|exec
)paren
id|tx39_blast_icache_page
c_func
(paren
id|page
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Do indexed flush, too much work to get the (possible) TLB refills&n;&t; * to work correctly.&n;&t; */
id|page
op_assign
(paren
id|KSEG0
op_plus
(paren
id|page
op_amp
(paren
id|dcache_size
op_minus
l_int|1
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpu_has_dc_aliases
op_logical_or
id|exec
)paren
id|tx39_blast_dcache_page_indexed
c_func
(paren
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|exec
)paren
id|tx39_blast_icache_page_indexed
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
DECL|function|tx39_flush_data_cache_page
r_static
r_void
id|tx39_flush_data_cache_page
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
id|tx39_blast_dcache_page
c_func
(paren
id|addr
)paren
suffix:semicolon
)brace
DECL|function|tx39_flush_icache_range
r_static
r_void
id|tx39_flush_icache_range
c_func
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
r_int
r_int
id|dc_lsize
op_assign
id|current_cpu_data.dcache.linesz
suffix:semicolon
r_int
r_int
id|addr
comma
id|aend
suffix:semicolon
r_if
c_cond
(paren
id|end
op_minus
id|start
OG
id|dcache_size
)paren
id|tx39_blast_dcache
c_func
(paren
)paren
suffix:semicolon
r_else
(brace
id|addr
op_assign
id|start
op_amp
op_complement
(paren
id|dc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
id|aend
op_assign
(paren
id|end
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|dc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
multiline_comment|/* Hit_Writeback_Inv_D */
id|protected_writeback_dcache_line
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_eq
id|aend
)paren
r_break
suffix:semicolon
id|addr
op_add_assign
id|dc_lsize
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|end
op_minus
id|start
OG
id|icache_size
)paren
id|tx39_blast_icache
c_func
(paren
)paren
suffix:semicolon
r_else
(brace
r_int
r_int
id|flags
comma
id|config
suffix:semicolon
id|addr
op_assign
id|start
op_amp
op_complement
(paren
id|dc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
id|aend
op_assign
(paren
id|end
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|dc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* disable icache (set ICE#) */
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|config
op_assign
id|read_c0_conf
c_func
(paren
)paren
suffix:semicolon
id|write_c0_conf
c_func
(paren
id|config
op_amp
op_complement
id|TX39_CONF_ICE
)paren
suffix:semicolon
id|TX39_STOP_STREAMING
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
multiline_comment|/* Hit_Invalidate_I */
id|protected_flush_icache_line
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_eq
id|aend
)paren
r_break
suffix:semicolon
id|addr
op_add_assign
id|dc_lsize
suffix:semicolon
)brace
id|write_c0_conf
c_func
(paren
id|config
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Ok, this seriously sucks.  We use them to flush a user page but don&squot;t&n; * know the virtual address, so we have to blast away the whole icache&n; * which is significantly more expensive than the real thing.  Otoh we at&n; * least know the kernel address of the page so we can flush it&n; * selectivly.&n; */
DECL|function|tx39_flush_icache_page
r_static
r_void
id|tx39_flush_icache_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_struct
id|page
op_star
id|page
)paren
(brace
r_int
r_int
id|addr
suffix:semicolon
multiline_comment|/*&n;&t; * If there&squot;s no context yet, or the page isn&squot;t executable, no icache&n;&t; * flush is needed.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_EXEC
)paren
)paren
r_return
suffix:semicolon
id|addr
op_assign
(paren
r_int
r_int
)paren
id|page_address
c_func
(paren
id|page
)paren
suffix:semicolon
id|tx39_blast_dcache_page
c_func
(paren
id|addr
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We&squot;re not sure of the virtual address(es) involved here, so&n;&t; * we have to flush the entire I-cache.&n;&t; */
id|tx39_blast_icache
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|tx39_dma_cache_wback_inv
r_static
r_void
id|tx39_dma_cache_wback_inv
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|end
comma
id|a
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|size
op_or
id|addr
)paren
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|end
op_assign
id|addr
op_plus
id|size
suffix:semicolon
r_do
(brace
id|tx39_blast_dcache_page
c_func
(paren
id|addr
)paren
suffix:semicolon
id|addr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
r_while
c_loop
(paren
id|addr
op_ne
id|end
)paren
(brace
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|size
OG
id|dcache_size
)paren
(brace
id|tx39_blast_dcache
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|dc_lsize
op_assign
id|current_cpu_data.dcache.linesz
suffix:semicolon
id|a
op_assign
id|addr
op_amp
op_complement
(paren
id|dc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
id|end
op_assign
(paren
id|addr
op_plus
id|size
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|dc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|flush_dcache_line
c_func
(paren
id|a
)paren
suffix:semicolon
multiline_comment|/* Hit_Writeback_Inv_D */
r_if
c_cond
(paren
id|a
op_eq
id|end
)paren
r_break
suffix:semicolon
id|a
op_add_assign
id|dc_lsize
suffix:semicolon
)brace
)brace
)brace
DECL|function|tx39_dma_cache_inv
r_static
r_void
id|tx39_dma_cache_inv
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|end
comma
id|a
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|size
op_or
id|addr
)paren
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|end
op_assign
id|addr
op_plus
id|size
suffix:semicolon
r_do
(brace
id|tx39_blast_dcache_page
c_func
(paren
id|addr
)paren
suffix:semicolon
id|addr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
r_while
c_loop
(paren
id|addr
op_ne
id|end
)paren
(brace
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|size
OG
id|dcache_size
)paren
(brace
id|tx39_blast_dcache
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|dc_lsize
op_assign
id|current_cpu_data.dcache.linesz
suffix:semicolon
id|a
op_assign
id|addr
op_amp
op_complement
(paren
id|dc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
id|end
op_assign
(paren
id|addr
op_plus
id|size
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|dc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|invalidate_dcache_line
c_func
(paren
id|a
)paren
suffix:semicolon
multiline_comment|/* Hit_Invalidate_D */
r_if
c_cond
(paren
id|a
op_eq
id|end
)paren
r_break
suffix:semicolon
id|a
op_add_assign
id|dc_lsize
suffix:semicolon
)brace
)brace
)brace
DECL|function|tx39_flush_cache_sigtramp
r_static
r_void
id|tx39_flush_cache_sigtramp
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_int
r_int
id|ic_lsize
op_assign
id|current_cpu_data.icache.linesz
suffix:semicolon
r_int
r_int
id|dc_lsize
op_assign
id|current_cpu_data.dcache.linesz
suffix:semicolon
r_int
r_int
id|config
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|protected_writeback_dcache_line
c_func
(paren
id|addr
op_amp
op_complement
(paren
id|dc_lsize
op_minus
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/* disable icache (set ICE#) */
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|config
op_assign
id|read_c0_conf
c_func
(paren
)paren
suffix:semicolon
id|write_c0_conf
c_func
(paren
id|config
op_amp
op_complement
id|TX39_CONF_ICE
)paren
suffix:semicolon
id|TX39_STOP_STREAMING
c_func
(paren
)paren
suffix:semicolon
id|protected_flush_icache_line
c_func
(paren
id|addr
op_amp
op_complement
(paren
id|ic_lsize
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|write_c0_conf
c_func
(paren
id|config
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|tx39_probe_cache
r_static
id|__init
r_void
id|tx39_probe_cache
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|config
suffix:semicolon
id|config
op_assign
id|read_c0_conf
c_func
(paren
)paren
suffix:semicolon
id|icache_size
op_assign
l_int|1
op_lshift
(paren
l_int|10
op_plus
(paren
(paren
id|config
op_amp
id|TX39_CONF_ICS_MASK
)paren
op_rshift
id|TX39_CONF_ICS_SHIFT
)paren
)paren
suffix:semicolon
id|dcache_size
op_assign
l_int|1
op_lshift
(paren
l_int|10
op_plus
(paren
(paren
id|config
op_amp
id|TX39_CONF_DCS_MASK
)paren
op_rshift
id|TX39_CONF_DCS_SHIFT
)paren
)paren
suffix:semicolon
id|current_cpu_data.icache.linesz
op_assign
l_int|16
suffix:semicolon
r_switch
c_cond
(paren
id|current_cpu_data.cputype
)paren
(brace
r_case
id|CPU_TX3912
suffix:colon
id|current_cpu_data.icache.ways
op_assign
l_int|1
suffix:semicolon
id|current_cpu_data.dcache.ways
op_assign
l_int|1
suffix:semicolon
id|current_cpu_data.dcache.linesz
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPU_TX3927
suffix:colon
id|current_cpu_data.icache.ways
op_assign
l_int|2
suffix:semicolon
id|current_cpu_data.dcache.ways
op_assign
l_int|2
suffix:semicolon
id|current_cpu_data.dcache.linesz
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPU_TX3922
suffix:colon
r_default
suffix:colon
id|current_cpu_data.icache.ways
op_assign
l_int|1
suffix:semicolon
id|current_cpu_data.dcache.ways
op_assign
l_int|1
suffix:semicolon
id|current_cpu_data.dcache.linesz
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|ld_mmu_tx39
r_void
id|__init
id|ld_mmu_tx39
c_func
(paren
r_void
)paren
(brace
r_extern
r_void
id|build_clear_page
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|build_copy_page
c_func
(paren
r_void
)paren
suffix:semicolon
r_int
r_int
id|config
suffix:semicolon
id|config
op_assign
id|read_c0_conf
c_func
(paren
)paren
suffix:semicolon
id|config
op_and_assign
op_complement
id|TX39_CONF_WBON
suffix:semicolon
id|write_c0_conf
c_func
(paren
id|config
)paren
suffix:semicolon
id|tx39_probe_cache
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|current_cpu_data.cputype
)paren
(brace
r_case
id|CPU_TX3912
suffix:colon
multiline_comment|/* TX39/H core (writethru direct-map cache) */
id|flush_cache_all
op_assign
id|tx39h_flush_icache_all
suffix:semicolon
id|__flush_cache_all
op_assign
id|tx39h_flush_icache_all
suffix:semicolon
id|flush_cache_mm
op_assign
(paren
r_void
op_star
)paren
id|tx39h_flush_icache_all
suffix:semicolon
id|flush_cache_range
op_assign
(paren
r_void
op_star
)paren
id|tx39h_flush_icache_all
suffix:semicolon
id|flush_cache_page
op_assign
(paren
r_void
op_star
)paren
id|tx39h_flush_icache_all
suffix:semicolon
id|flush_icache_page
op_assign
(paren
r_void
op_star
)paren
id|tx39h_flush_icache_all
suffix:semicolon
id|flush_icache_range
op_assign
(paren
r_void
op_star
)paren
id|tx39h_flush_icache_all
suffix:semicolon
id|flush_cache_sigtramp
op_assign
(paren
r_void
op_star
)paren
id|tx39h_flush_icache_all
suffix:semicolon
id|flush_data_cache_page
op_assign
(paren
r_void
op_star
)paren
id|tx39h_flush_icache_all
suffix:semicolon
id|_dma_cache_wback_inv
op_assign
id|tx39h_dma_cache_wback_inv
suffix:semicolon
id|shm_align_mask
op_assign
id|PAGE_SIZE
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPU_TX3922
suffix:colon
r_case
id|CPU_TX3927
suffix:colon
r_default
suffix:colon
multiline_comment|/* TX39/H2,H3 core (writeback 2way-set-associative cache) */
id|r3k_have_wired_reg
op_assign
l_int|1
suffix:semicolon
id|write_c0_wired
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* set 8 on reset... */
multiline_comment|/* board-dependent init code may set WBON */
id|flush_cache_all
op_assign
id|tx39_flush_cache_all
suffix:semicolon
id|__flush_cache_all
op_assign
id|tx39___flush_cache_all
suffix:semicolon
id|flush_cache_mm
op_assign
id|tx39_flush_cache_mm
suffix:semicolon
id|flush_cache_range
op_assign
id|tx39_flush_cache_range
suffix:semicolon
id|flush_cache_page
op_assign
id|tx39_flush_cache_page
suffix:semicolon
id|flush_icache_page
op_assign
id|tx39_flush_icache_page
suffix:semicolon
id|flush_icache_range
op_assign
id|tx39_flush_icache_range
suffix:semicolon
id|flush_cache_sigtramp
op_assign
id|tx39_flush_cache_sigtramp
suffix:semicolon
id|flush_data_cache_page
op_assign
id|tx39_flush_data_cache_page
suffix:semicolon
id|_dma_cache_wback_inv
op_assign
id|tx39_dma_cache_wback_inv
suffix:semicolon
id|_dma_cache_wback
op_assign
id|tx39_dma_cache_wback_inv
suffix:semicolon
id|_dma_cache_inv
op_assign
id|tx39_dma_cache_inv
suffix:semicolon
id|shm_align_mask
op_assign
id|max_t
c_func
(paren
r_int
r_int
comma
(paren
id|dcache_size
op_div
id|current_cpu_data.dcache.ways
)paren
op_minus
l_int|1
comma
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|current_cpu_data.icache.waysize
op_assign
id|icache_size
op_div
id|current_cpu_data.icache.ways
suffix:semicolon
id|current_cpu_data.dcache.waysize
op_assign
id|dcache_size
op_div
id|current_cpu_data.dcache.ways
suffix:semicolon
id|current_cpu_data.icache.sets
op_assign
id|current_cpu_data.icache.waysize
op_div
id|current_cpu_data.icache.linesz
suffix:semicolon
id|current_cpu_data.dcache.sets
op_assign
id|current_cpu_data.dcache.waysize
op_div
id|current_cpu_data.dcache.linesz
suffix:semicolon
r_if
c_cond
(paren
id|current_cpu_data.dcache.waysize
OG
id|PAGE_SIZE
)paren
id|current_cpu_data.dcache.flags
op_or_assign
id|MIPS_CACHE_ALIASES
suffix:semicolon
id|current_cpu_data.icache.waybit
op_assign
l_int|0
suffix:semicolon
id|current_cpu_data.dcache.waybit
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Primary instruction cache %ldkB, linesize %d bytes&bslash;n&quot;
comma
id|icache_size
op_rshift
l_int|10
comma
id|current_cpu_data.icache.linesz
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Primary data cache %ldkB, linesize %d bytes&bslash;n&quot;
comma
id|dcache_size
op_rshift
l_int|10
comma
id|current_cpu_data.dcache.linesz
)paren
suffix:semicolon
id|build_clear_page
c_func
(paren
)paren
suffix:semicolon
id|build_copy_page
c_func
(paren
)paren
suffix:semicolon
)brace
eof
