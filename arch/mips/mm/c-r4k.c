multiline_comment|/*&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Copyright (C) 1996 David S. Miller (dm@engr.sgi.com)&n; * Copyright (C) 1997, 1998, 1999, 2000, 2001, 2002 Ralf Baechle (ralf@gnu.org)&n; * Copyright (C) 1999, 2000 Silicon Graphics, Inc.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;asm/bcache.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#include &lt;asm/cacheops.h&gt;
macro_line|#include &lt;asm/cpu.h&gt;
macro_line|#include &lt;asm/cpu-features.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/r4kcache.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/mmu_context.h&gt;
macro_line|#include &lt;asm/war.h&gt;
DECL|variable|icache_size
DECL|variable|dcache_size
DECL|variable|scache_size
r_static
r_int
r_int
id|icache_size
comma
id|dcache_size
comma
id|scache_size
suffix:semicolon
multiline_comment|/*&n; * Dummy cache handling routines for machines without boardcaches&n; */
DECL|function|no_sc_noop
r_static
r_void
id|no_sc_noop
c_func
(paren
r_void
)paren
(brace
)brace
DECL|variable|no_sc_ops
r_static
r_struct
id|bcache_ops
id|no_sc_ops
op_assign
(brace
dot
id|bc_enable
op_assign
(paren
r_void
op_star
)paren
id|no_sc_noop
comma
dot
id|bc_disable
op_assign
(paren
r_void
op_star
)paren
id|no_sc_noop
comma
dot
id|bc_wback_inv
op_assign
(paren
r_void
op_star
)paren
id|no_sc_noop
comma
dot
id|bc_inv
op_assign
(paren
r_void
op_star
)paren
id|no_sc_noop
)brace
suffix:semicolon
DECL|variable|bcops
r_struct
id|bcache_ops
op_star
id|bcops
op_assign
op_amp
id|no_sc_ops
suffix:semicolon
DECL|macro|cpu_is_r4600_v1_x
mdefine_line|#define cpu_is_r4600_v1_x()&t;((read_c0_prid() &amp; 0xfffffff0) == 0x2010)
DECL|macro|cpu_is_r4600_v2_x
mdefine_line|#define cpu_is_r4600_v2_x()&t;((read_c0_prid() &amp; 0xfffffff0) == 0x2020)
DECL|macro|R4600_HIT_CACHEOP_WAR_IMPL
mdefine_line|#define R4600_HIT_CACHEOP_WAR_IMPL&t;&t;&t;&t;&t;&bslash;&n;do {&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;if (R4600_V2_HIT_CACHEOP_WAR &amp;&amp; cpu_is_r4600_v2_x())&t;&t;&bslash;&n;&t;&t;*(volatile unsigned long *)CKSEG1;&t;&t;&t;&bslash;&n;&t;if (R4600_V1_HIT_CACHEOP_WAR)&t;&t;&t;&t;&t;&bslash;&n;&t;&t;__asm__ __volatile__(&quot;nop;nop;nop;nop&quot;);&t;&t;&bslash;&n;} while (0)
DECL|variable|r4k_blast_dcache_page
r_static
r_void
(paren
op_star
id|r4k_blast_dcache_page
)paren
(paren
r_int
r_int
id|addr
)paren
suffix:semicolon
DECL|function|r4k_blast_dcache_page_dc32
r_static
r_inline
r_void
id|r4k_blast_dcache_page_dc32
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
id|R4600_HIT_CACHEOP_WAR_IMPL
suffix:semicolon
id|blast_dcache32_page
c_func
(paren
id|addr
)paren
suffix:semicolon
)brace
DECL|function|r4k_blast_dcache_page_setup
r_static
r_inline
r_void
id|r4k_blast_dcache_page_setup
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|dc_lsize
op_assign
id|cpu_dcache_line_size
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dc_lsize
op_eq
l_int|16
)paren
id|r4k_blast_dcache_page
op_assign
id|blast_dcache16_page
suffix:semicolon
r_else
r_if
c_cond
(paren
id|dc_lsize
op_eq
l_int|32
)paren
id|r4k_blast_dcache_page
op_assign
id|r4k_blast_dcache_page_dc32
suffix:semicolon
)brace
DECL|variable|r4k_blast_dcache_page_indexed
r_static
r_void
(paren
op_star
id|r4k_blast_dcache_page_indexed
)paren
(paren
r_int
r_int
id|addr
)paren
suffix:semicolon
DECL|function|r4k_blast_dcache_page_indexed_setup
r_static
r_inline
r_void
id|r4k_blast_dcache_page_indexed_setup
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|dc_lsize
op_assign
id|cpu_dcache_line_size
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dc_lsize
op_eq
l_int|16
)paren
id|r4k_blast_dcache_page_indexed
op_assign
id|blast_dcache16_page_indexed
suffix:semicolon
r_else
r_if
c_cond
(paren
id|dc_lsize
op_eq
l_int|32
)paren
id|r4k_blast_dcache_page_indexed
op_assign
id|blast_dcache32_page_indexed
suffix:semicolon
)brace
DECL|variable|r4k_blast_dcache
r_static
r_void
(paren
op_star
id|r4k_blast_dcache
)paren
(paren
r_void
)paren
suffix:semicolon
DECL|function|r4k_blast_dcache_setup
r_static
r_inline
r_void
id|r4k_blast_dcache_setup
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|dc_lsize
op_assign
id|cpu_dcache_line_size
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dc_lsize
op_eq
l_int|16
)paren
id|r4k_blast_dcache
op_assign
id|blast_dcache16
suffix:semicolon
r_else
r_if
c_cond
(paren
id|dc_lsize
op_eq
l_int|32
)paren
id|r4k_blast_dcache
op_assign
id|blast_dcache32
suffix:semicolon
)brace
multiline_comment|/* force code alignment (used for TX49XX_ICACHE_INDEX_INV_WAR) */
DECL|macro|JUMP_TO_ALIGN
mdefine_line|#define JUMP_TO_ALIGN(order) &bslash;&n;&t;__asm__ __volatile__( &bslash;&n;&t;&t;&quot;b&bslash;t1f&bslash;n&bslash;t&quot; &bslash;&n;&t;&t;&quot;.align&bslash;t&quot; #order &quot;&bslash;n&bslash;t&quot; &bslash;&n;&t;&t;&quot;1:&bslash;n&bslash;t&quot; &bslash;&n;&t;&t;)
DECL|macro|CACHE32_UNROLL32_ALIGN
mdefine_line|#define CACHE32_UNROLL32_ALIGN&t;JUMP_TO_ALIGN(10) /* 32 * 32 = 1024 */
DECL|macro|CACHE32_UNROLL32_ALIGN2
mdefine_line|#define CACHE32_UNROLL32_ALIGN2&t;JUMP_TO_ALIGN(11)
DECL|function|blast_r4600_v1_icache32
r_static
r_inline
r_void
id|blast_r4600_v1_icache32
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|blast_icache32
c_func
(paren
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|tx49_blast_icache32
r_static
r_inline
r_void
id|tx49_blast_icache32
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|start
op_assign
id|INDEX_BASE
suffix:semicolon
r_int
r_int
id|end
op_assign
id|start
op_plus
id|current_cpu_data.icache.waysize
suffix:semicolon
r_int
r_int
id|ws_inc
op_assign
l_int|1UL
op_lshift
id|current_cpu_data.icache.waybit
suffix:semicolon
r_int
r_int
id|ws_end
op_assign
id|current_cpu_data.icache.ways
op_lshift
id|current_cpu_data.icache.waybit
suffix:semicolon
r_int
r_int
id|ws
comma
id|addr
suffix:semicolon
id|CACHE32_UNROLL32_ALIGN2
suffix:semicolon
multiline_comment|/* I&squot;m in even chunk.  blast odd chunks */
r_for
c_loop
(paren
id|ws
op_assign
l_int|0
suffix:semicolon
id|ws
OL
id|ws_end
suffix:semicolon
id|ws
op_add_assign
id|ws_inc
)paren
r_for
c_loop
(paren
id|addr
op_assign
id|start
op_plus
l_int|0x400
suffix:semicolon
id|addr
OL
id|end
suffix:semicolon
id|addr
op_add_assign
l_int|0x400
op_star
l_int|2
)paren
id|cache32_unroll32
c_func
(paren
id|addr
op_or
id|ws
comma
id|Index_Invalidate_I
)paren
suffix:semicolon
id|CACHE32_UNROLL32_ALIGN
suffix:semicolon
multiline_comment|/* I&squot;m in odd chunk.  blast even chunks */
r_for
c_loop
(paren
id|ws
op_assign
l_int|0
suffix:semicolon
id|ws
OL
id|ws_end
suffix:semicolon
id|ws
op_add_assign
id|ws_inc
)paren
r_for
c_loop
(paren
id|addr
op_assign
id|start
suffix:semicolon
id|addr
OL
id|end
suffix:semicolon
id|addr
op_add_assign
l_int|0x400
op_star
l_int|2
)paren
id|cache32_unroll32
c_func
(paren
id|addr
op_or
id|ws
comma
id|Index_Invalidate_I
)paren
suffix:semicolon
)brace
DECL|function|blast_icache32_r4600_v1_page_indexed
r_static
r_inline
r_void
id|blast_icache32_r4600_v1_page_indexed
c_func
(paren
r_int
r_int
id|page
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|blast_icache32_page_indexed
c_func
(paren
id|page
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|tx49_blast_icache32_page_indexed
r_static
r_inline
r_void
id|tx49_blast_icache32_page_indexed
c_func
(paren
r_int
r_int
id|page
)paren
(brace
r_int
r_int
id|start
op_assign
id|page
suffix:semicolon
r_int
r_int
id|end
op_assign
id|start
op_plus
id|PAGE_SIZE
suffix:semicolon
r_int
r_int
id|ws_inc
op_assign
l_int|1UL
op_lshift
id|current_cpu_data.icache.waybit
suffix:semicolon
r_int
r_int
id|ws_end
op_assign
id|current_cpu_data.icache.ways
op_lshift
id|current_cpu_data.icache.waybit
suffix:semicolon
r_int
r_int
id|ws
comma
id|addr
suffix:semicolon
id|CACHE32_UNROLL32_ALIGN2
suffix:semicolon
multiline_comment|/* I&squot;m in even chunk.  blast odd chunks */
r_for
c_loop
(paren
id|ws
op_assign
l_int|0
suffix:semicolon
id|ws
OL
id|ws_end
suffix:semicolon
id|ws
op_add_assign
id|ws_inc
)paren
r_for
c_loop
(paren
id|addr
op_assign
id|start
op_plus
l_int|0x400
suffix:semicolon
id|addr
OL
id|end
suffix:semicolon
id|addr
op_add_assign
l_int|0x400
op_star
l_int|2
)paren
id|cache32_unroll32
c_func
(paren
id|addr
op_or
id|ws
comma
id|Index_Invalidate_I
)paren
suffix:semicolon
id|CACHE32_UNROLL32_ALIGN
suffix:semicolon
multiline_comment|/* I&squot;m in odd chunk.  blast even chunks */
r_for
c_loop
(paren
id|ws
op_assign
l_int|0
suffix:semicolon
id|ws
OL
id|ws_end
suffix:semicolon
id|ws
op_add_assign
id|ws_inc
)paren
r_for
c_loop
(paren
id|addr
op_assign
id|start
suffix:semicolon
id|addr
OL
id|end
suffix:semicolon
id|addr
op_add_assign
l_int|0x400
op_star
l_int|2
)paren
id|cache32_unroll32
c_func
(paren
id|addr
op_or
id|ws
comma
id|Index_Invalidate_I
)paren
suffix:semicolon
)brace
DECL|variable|r4k_blast_icache_page
r_static
r_void
(paren
op_star
id|r4k_blast_icache_page
)paren
(paren
r_int
r_int
id|addr
)paren
suffix:semicolon
DECL|function|r4k_blast_icache_page_setup
r_static
r_inline
r_void
id|r4k_blast_icache_page_setup
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|ic_lsize
op_assign
id|cpu_icache_line_size
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ic_lsize
op_eq
l_int|16
)paren
id|r4k_blast_icache_page
op_assign
id|blast_icache16_page
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ic_lsize
op_eq
l_int|32
)paren
id|r4k_blast_icache_page
op_assign
id|blast_icache32_page
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ic_lsize
op_eq
l_int|64
)paren
id|r4k_blast_icache_page
op_assign
id|blast_icache64_page
suffix:semicolon
)brace
DECL|variable|r4k_blast_icache_page_indexed
r_static
r_void
(paren
op_star
id|r4k_blast_icache_page_indexed
)paren
(paren
r_int
r_int
id|addr
)paren
suffix:semicolon
DECL|function|r4k_blast_icache_page_indexed_setup
r_static
r_inline
r_void
id|r4k_blast_icache_page_indexed_setup
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|ic_lsize
op_assign
id|cpu_icache_line_size
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ic_lsize
op_eq
l_int|16
)paren
id|r4k_blast_icache_page_indexed
op_assign
id|blast_icache16_page_indexed
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ic_lsize
op_eq
l_int|32
)paren
(brace
r_if
c_cond
(paren
id|TX49XX_ICACHE_INDEX_INV_WAR
)paren
id|r4k_blast_icache_page_indexed
op_assign
id|tx49_blast_icache32_page_indexed
suffix:semicolon
r_else
r_if
c_cond
(paren
id|R4600_V1_INDEX_ICACHEOP_WAR
op_logical_and
id|cpu_is_r4600_v1_x
c_func
(paren
)paren
)paren
id|r4k_blast_icache_page_indexed
op_assign
id|blast_icache32_r4600_v1_page_indexed
suffix:semicolon
r_else
id|r4k_blast_icache_page_indexed
op_assign
id|blast_icache32_page_indexed
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ic_lsize
op_eq
l_int|64
)paren
id|r4k_blast_icache_page_indexed
op_assign
id|blast_icache64_page_indexed
suffix:semicolon
)brace
DECL|variable|r4k_blast_icache
r_static
r_void
(paren
op_star
id|r4k_blast_icache
)paren
(paren
r_void
)paren
suffix:semicolon
DECL|function|r4k_blast_icache_setup
r_static
r_inline
r_void
id|r4k_blast_icache_setup
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|ic_lsize
op_assign
id|cpu_icache_line_size
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ic_lsize
op_eq
l_int|16
)paren
id|r4k_blast_icache
op_assign
id|blast_icache16
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ic_lsize
op_eq
l_int|32
)paren
(brace
r_if
c_cond
(paren
id|R4600_V1_INDEX_ICACHEOP_WAR
op_logical_and
id|cpu_is_r4600_v1_x
c_func
(paren
)paren
)paren
id|r4k_blast_icache
op_assign
id|blast_r4600_v1_icache32
suffix:semicolon
r_else
r_if
c_cond
(paren
id|TX49XX_ICACHE_INDEX_INV_WAR
)paren
id|r4k_blast_icache
op_assign
id|tx49_blast_icache32
suffix:semicolon
r_else
id|r4k_blast_icache
op_assign
id|blast_icache32
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ic_lsize
op_eq
l_int|64
)paren
id|r4k_blast_icache
op_assign
id|blast_icache64
suffix:semicolon
)brace
DECL|variable|r4k_blast_scache_page
r_static
r_void
(paren
op_star
id|r4k_blast_scache_page
)paren
(paren
r_int
r_int
id|addr
)paren
suffix:semicolon
DECL|function|r4k_blast_scache_page_setup
r_static
r_inline
r_void
id|r4k_blast_scache_page_setup
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|sc_lsize
op_assign
id|cpu_scache_line_size
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sc_lsize
op_eq
l_int|16
)paren
id|r4k_blast_scache_page
op_assign
id|blast_scache16_page
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sc_lsize
op_eq
l_int|32
)paren
id|r4k_blast_scache_page
op_assign
id|blast_scache32_page
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sc_lsize
op_eq
l_int|64
)paren
id|r4k_blast_scache_page
op_assign
id|blast_scache64_page
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sc_lsize
op_eq
l_int|128
)paren
id|r4k_blast_scache_page
op_assign
id|blast_scache128_page
suffix:semicolon
)brace
DECL|variable|r4k_blast_scache_page_indexed
r_static
r_void
(paren
op_star
id|r4k_blast_scache_page_indexed
)paren
(paren
r_int
r_int
id|addr
)paren
suffix:semicolon
DECL|function|r4k_blast_scache_page_indexed_setup
r_static
r_inline
r_void
id|r4k_blast_scache_page_indexed_setup
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|sc_lsize
op_assign
id|cpu_scache_line_size
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sc_lsize
op_eq
l_int|16
)paren
id|r4k_blast_scache_page_indexed
op_assign
id|blast_scache16_page_indexed
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sc_lsize
op_eq
l_int|32
)paren
id|r4k_blast_scache_page_indexed
op_assign
id|blast_scache32_page_indexed
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sc_lsize
op_eq
l_int|64
)paren
id|r4k_blast_scache_page_indexed
op_assign
id|blast_scache64_page_indexed
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sc_lsize
op_eq
l_int|128
)paren
id|r4k_blast_scache_page_indexed
op_assign
id|blast_scache128_page_indexed
suffix:semicolon
)brace
DECL|variable|r4k_blast_scache
r_static
r_void
(paren
op_star
id|r4k_blast_scache
)paren
(paren
r_void
)paren
suffix:semicolon
DECL|function|r4k_blast_scache_setup
r_static
r_inline
r_void
id|r4k_blast_scache_setup
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|sc_lsize
op_assign
id|cpu_scache_line_size
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sc_lsize
op_eq
l_int|16
)paren
id|r4k_blast_scache
op_assign
id|blast_scache16
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sc_lsize
op_eq
l_int|32
)paren
id|r4k_blast_scache
op_assign
id|blast_scache32
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sc_lsize
op_eq
l_int|64
)paren
id|r4k_blast_scache
op_assign
id|blast_scache64
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sc_lsize
op_eq
l_int|128
)paren
id|r4k_blast_scache
op_assign
id|blast_scache128
suffix:semicolon
)brace
multiline_comment|/*&n; * This is former mm&squot;s flush_cache_all() which really should be&n; * flush_cache_vunmap these days ...&n; */
DECL|function|local_r4k_flush_cache_all
r_static
r_inline
r_void
id|local_r4k_flush_cache_all
c_func
(paren
r_void
op_star
id|args
)paren
(brace
id|r4k_blast_dcache
c_func
(paren
)paren
suffix:semicolon
id|r4k_blast_icache
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|r4k_flush_cache_all
r_static
r_void
id|r4k_flush_cache_all
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|cpu_has_dc_aliases
)paren
r_return
suffix:semicolon
id|on_each_cpu
c_func
(paren
id|local_r4k_flush_cache_all
comma
l_int|NULL
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|local_r4k___flush_cache_all
r_static
r_inline
r_void
id|local_r4k___flush_cache_all
c_func
(paren
r_void
op_star
id|args
)paren
(brace
id|r4k_blast_dcache
c_func
(paren
)paren
suffix:semicolon
id|r4k_blast_icache
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|current_cpu_data.cputype
)paren
(brace
r_case
id|CPU_R4000SC
suffix:colon
r_case
id|CPU_R4000MC
suffix:colon
r_case
id|CPU_R4400SC
suffix:colon
r_case
id|CPU_R4400MC
suffix:colon
r_case
id|CPU_R10000
suffix:colon
r_case
id|CPU_R12000
suffix:colon
id|r4k_blast_scache
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|r4k___flush_cache_all
r_static
r_void
id|r4k___flush_cache_all
c_func
(paren
r_void
)paren
(brace
id|on_each_cpu
c_func
(paren
id|local_r4k___flush_cache_all
comma
l_int|NULL
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|local_r4k_flush_cache_range
r_static
r_inline
r_void
id|local_r4k_flush_cache_range
c_func
(paren
r_void
op_star
id|args
)paren
(brace
r_struct
id|vm_area_struct
op_star
id|vma
op_assign
id|args
suffix:semicolon
r_int
id|exec
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cpu_context
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
id|vma-&gt;vm_mm
)paren
)paren
)paren
r_return
suffix:semicolon
id|exec
op_assign
id|vma-&gt;vm_flags
op_amp
id|VM_EXEC
suffix:semicolon
r_if
c_cond
(paren
id|cpu_has_dc_aliases
op_logical_or
id|exec
)paren
id|r4k_blast_dcache
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|exec
)paren
id|r4k_blast_icache
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|r4k_flush_cache_range
r_static
r_void
id|r4k_flush_cache_range
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
id|on_each_cpu
c_func
(paren
id|local_r4k_flush_cache_range
comma
id|vma
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|local_r4k_flush_cache_mm
r_static
r_inline
r_void
id|local_r4k_flush_cache_mm
c_func
(paren
r_void
op_star
id|args
)paren
(brace
r_struct
id|mm_struct
op_star
id|mm
op_assign
id|args
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpu_context
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
id|mm
)paren
)paren
r_return
suffix:semicolon
id|r4k_blast_dcache
c_func
(paren
)paren
suffix:semicolon
id|r4k_blast_icache
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Kludge alert.  For obscure reasons R4000SC and R4400SC go nuts if we&n;&t; * only flush the primary caches but R10000 and R12000 behave sane ...&n;&t; */
r_if
c_cond
(paren
id|current_cpu_data.cputype
op_eq
id|CPU_R4000SC
op_logical_or
id|current_cpu_data.cputype
op_eq
id|CPU_R4000MC
op_logical_or
id|current_cpu_data.cputype
op_eq
id|CPU_R4400SC
op_logical_or
id|current_cpu_data.cputype
op_eq
id|CPU_R4400MC
)paren
id|r4k_blast_scache
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|r4k_flush_cache_mm
r_static
r_void
id|r4k_flush_cache_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|cpu_has_dc_aliases
)paren
r_return
suffix:semicolon
id|on_each_cpu
c_func
(paren
id|local_r4k_flush_cache_mm
comma
id|mm
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|struct|flush_cache_page_args
r_struct
id|flush_cache_page_args
(brace
DECL|member|vma
r_struct
id|vm_area_struct
op_star
id|vma
suffix:semicolon
DECL|member|page
r_int
r_int
id|page
suffix:semicolon
)brace
suffix:semicolon
DECL|function|local_r4k_flush_cache_page
r_static
r_inline
r_void
id|local_r4k_flush_cache_page
c_func
(paren
r_void
op_star
id|args
)paren
(brace
r_struct
id|flush_cache_page_args
op_star
id|fcp_args
op_assign
id|args
suffix:semicolon
r_struct
id|vm_area_struct
op_star
id|vma
op_assign
id|fcp_args-&gt;vma
suffix:semicolon
r_int
r_int
id|page
op_assign
id|fcp_args-&gt;page
suffix:semicolon
r_int
id|exec
op_assign
id|vma-&gt;vm_flags
op_amp
id|VM_EXEC
suffix:semicolon
r_struct
id|mm_struct
op_star
id|mm
op_assign
id|vma-&gt;vm_mm
suffix:semicolon
id|pgd_t
op_star
id|pgdp
suffix:semicolon
id|pmd_t
op_star
id|pmdp
suffix:semicolon
id|pte_t
op_star
id|ptep
suffix:semicolon
id|page
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|pgdp
op_assign
id|pgd_offset
c_func
(paren
id|mm
comma
id|page
)paren
suffix:semicolon
id|pmdp
op_assign
id|pmd_offset
c_func
(paren
id|pgdp
comma
id|page
)paren
suffix:semicolon
id|ptep
op_assign
id|pte_offset
c_func
(paren
id|pmdp
comma
id|page
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If the page isn&squot;t marked valid, the page cannot possibly be&n;&t; * in the cache.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|pte_val
c_func
(paren
op_star
id|ptep
)paren
op_amp
id|_PAGE_PRESENT
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * Doing flushes for another ASID than the current one is&n;&t; * too difficult since stupid R4k caches do a TLB translation&n;&t; * for every cache flush operation.  So we do indexed flushes&n;&t; * in that case, which doesn&squot;t overly flush the cache too much.&n;&t; */
r_if
c_cond
(paren
(paren
id|mm
op_eq
id|current-&gt;active_mm
)paren
op_logical_and
(paren
id|pte_val
c_func
(paren
op_star
id|ptep
)paren
op_amp
id|_PAGE_VALID
)paren
)paren
(brace
r_if
c_cond
(paren
id|cpu_has_dc_aliases
op_logical_or
(paren
id|exec
op_logical_and
op_logical_neg
id|cpu_has_ic_fills_f_dc
)paren
)paren
(brace
id|r4k_blast_dcache_page
c_func
(paren
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|exec
op_logical_and
op_logical_neg
id|cpu_icache_snoops_remote_store
)paren
id|r4k_blast_scache_page
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|exec
)paren
id|r4k_blast_icache_page
c_func
(paren
id|page
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Do indexed flush, too much work to get the (possible) TLB refills&n;&t; * to work correctly.&n;&t; */
id|page
op_assign
id|INDEX_BASE
op_plus
(paren
id|page
op_amp
(paren
id|dcache_size
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpu_has_dc_aliases
op_logical_or
(paren
id|exec
op_logical_and
op_logical_neg
id|cpu_has_ic_fills_f_dc
)paren
)paren
(brace
id|r4k_blast_dcache_page_indexed
c_func
(paren
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|exec
op_logical_and
op_logical_neg
id|cpu_icache_snoops_remote_store
)paren
id|r4k_blast_scache_page_indexed
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|exec
)paren
(brace
r_if
c_cond
(paren
id|cpu_has_vtag_icache
)paren
(brace
r_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpu_context
c_func
(paren
id|cpu
comma
id|vma-&gt;vm_mm
)paren
op_ne
l_int|0
)paren
id|drop_mmu_context
c_func
(paren
id|vma-&gt;vm_mm
comma
id|cpu
)paren
suffix:semicolon
)brace
r_else
id|r4k_blast_icache_page_indexed
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
)brace
DECL|function|r4k_flush_cache_page
r_static
r_void
id|r4k_flush_cache_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
(brace
r_struct
id|flush_cache_page_args
id|args
suffix:semicolon
multiline_comment|/*&n;&t; * If ownes no valid ASID yet, cannot possibly have gotten&n;&t; * this page into the cache.&n;&t; */
r_if
c_cond
(paren
id|cpu_context
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
id|vma-&gt;vm_mm
)paren
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|args.vma
op_assign
id|vma
suffix:semicolon
id|args.page
op_assign
id|page
suffix:semicolon
id|on_each_cpu
c_func
(paren
id|local_r4k_flush_cache_page
comma
op_amp
id|args
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|local_r4k_flush_data_cache_page
r_static
r_inline
r_void
id|local_r4k_flush_data_cache_page
c_func
(paren
r_void
op_star
id|addr
)paren
(brace
id|r4k_blast_dcache_page
c_func
(paren
(paren
r_int
r_int
)paren
id|addr
)paren
suffix:semicolon
)brace
DECL|function|r4k_flush_data_cache_page
r_static
r_void
id|r4k_flush_data_cache_page
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
id|on_each_cpu
c_func
(paren
id|local_r4k_flush_data_cache_page
comma
(paren
r_void
op_star
)paren
id|addr
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|struct|flush_icache_range_args
r_struct
id|flush_icache_range_args
(brace
DECL|member|start
r_int
r_int
id|start
suffix:semicolon
DECL|member|end
r_int
r_int
id|end
suffix:semicolon
)brace
suffix:semicolon
DECL|function|local_r4k_flush_icache_range
r_static
r_inline
r_void
id|local_r4k_flush_icache_range
c_func
(paren
r_void
op_star
id|args
)paren
(brace
r_struct
id|flush_icache_range_args
op_star
id|fir_args
op_assign
id|args
suffix:semicolon
r_int
r_int
id|dc_lsize
op_assign
id|current_cpu_data.dcache.linesz
suffix:semicolon
r_int
r_int
id|ic_lsize
op_assign
id|current_cpu_data.icache.linesz
suffix:semicolon
r_int
r_int
id|sc_lsize
op_assign
id|current_cpu_data.scache.linesz
suffix:semicolon
r_int
r_int
id|start
op_assign
id|fir_args-&gt;start
suffix:semicolon
r_int
r_int
id|end
op_assign
id|fir_args-&gt;end
suffix:semicolon
r_int
r_int
id|addr
comma
id|aend
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpu_has_ic_fills_f_dc
)paren
(brace
r_if
c_cond
(paren
id|end
op_minus
id|start
OG
id|dcache_size
)paren
(brace
id|r4k_blast_dcache
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|addr
op_assign
id|start
op_amp
op_complement
(paren
id|dc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
id|aend
op_assign
(paren
id|end
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|dc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
multiline_comment|/* Hit_Writeback_Inv_D */
id|protected_writeback_dcache_line
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_eq
id|aend
)paren
r_break
suffix:semicolon
id|addr
op_add_assign
id|dc_lsize
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|cpu_icache_snoops_remote_store
)paren
(brace
r_if
c_cond
(paren
id|end
op_minus
id|start
OG
id|scache_size
)paren
(brace
id|r4k_blast_scache
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|addr
op_assign
id|start
op_amp
op_complement
(paren
id|sc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
id|aend
op_assign
(paren
id|end
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|sc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
multiline_comment|/* Hit_Writeback_Inv_D */
id|protected_writeback_scache_line
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_eq
id|aend
)paren
r_break
suffix:semicolon
id|addr
op_add_assign
id|sc_lsize
suffix:semicolon
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
id|end
op_minus
id|start
OG
id|icache_size
)paren
id|r4k_blast_icache
c_func
(paren
)paren
suffix:semicolon
r_else
(brace
id|addr
op_assign
id|start
op_amp
op_complement
(paren
id|ic_lsize
op_minus
l_int|1
)paren
suffix:semicolon
id|aend
op_assign
(paren
id|end
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|ic_lsize
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
multiline_comment|/* Hit_Invalidate_I */
id|protected_flush_icache_line
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_eq
id|aend
)paren
r_break
suffix:semicolon
id|addr
op_add_assign
id|ic_lsize
suffix:semicolon
)brace
)brace
)brace
DECL|function|r4k_flush_icache_range
r_static
r_void
id|r4k_flush_icache_range
c_func
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
r_struct
id|flush_icache_range_args
id|args
suffix:semicolon
id|args.start
op_assign
id|start
suffix:semicolon
id|args.end
op_assign
id|end
suffix:semicolon
id|on_each_cpu
c_func
(paren
id|local_r4k_flush_icache_range
comma
op_amp
id|args
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Ok, this seriously sucks.  We use them to flush a user page but don&squot;t&n; * know the virtual address, so we have to blast away the whole icache&n; * which is significantly more expensive than the real thing.  Otoh we at&n; * least know the kernel address of the page so we can flush it&n; * selectivly.&n; */
DECL|struct|flush_icache_page_args
r_struct
id|flush_icache_page_args
(brace
DECL|member|vma
r_struct
id|vm_area_struct
op_star
id|vma
suffix:semicolon
DECL|member|page
r_struct
id|page
op_star
id|page
suffix:semicolon
)brace
suffix:semicolon
DECL|function|local_r4k_flush_icache_page
r_static
r_inline
r_void
id|local_r4k_flush_icache_page
c_func
(paren
r_void
op_star
id|args
)paren
(brace
r_struct
id|flush_icache_page_args
op_star
id|fip_args
op_assign
id|args
suffix:semicolon
r_struct
id|vm_area_struct
op_star
id|vma
op_assign
id|fip_args-&gt;vma
suffix:semicolon
r_struct
id|page
op_star
id|page
op_assign
id|fip_args-&gt;page
suffix:semicolon
multiline_comment|/*&n;&t; * Tricky ...  Because we don&squot;t know the virtual address we&squot;ve got the&n;&t; * choice of either invalidating the entire primary and secondary&n;&t; * caches or invalidating the secondary caches also.  With the subset&n;&t; * enforcment on R4000SC, R4400SC, R10000 and R12000 invalidating the&n;&t; * secondary cache will result in any entries in the primary caches&n;&t; * also getting invalidated which hopefully is a bit more economical.&n;&t; */
r_if
c_cond
(paren
id|cpu_has_subset_pcaches
)paren
(brace
r_int
r_int
id|addr
op_assign
(paren
r_int
r_int
)paren
id|page_address
c_func
(paren
id|page
)paren
suffix:semicolon
id|r4k_blast_scache_page
c_func
(paren
id|addr
)paren
suffix:semicolon
id|ClearPageDcacheDirty
c_func
(paren
id|page
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|cpu_has_ic_fills_f_dc
)paren
(brace
r_int
r_int
id|addr
op_assign
(paren
r_int
r_int
)paren
id|page_address
c_func
(paren
id|page
)paren
suffix:semicolon
id|r4k_blast_dcache_page
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpu_icache_snoops_remote_store
)paren
id|r4k_blast_scache_page
c_func
(paren
id|addr
)paren
suffix:semicolon
id|ClearPageDcacheDirty
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * We&squot;re not sure of the virtual address(es) involved here, so&n;&t; * we have to flush the entire I-cache.&n;&t; */
r_if
c_cond
(paren
id|cpu_has_vtag_icache
)paren
(brace
r_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpu_context
c_func
(paren
id|cpu
comma
id|vma-&gt;vm_mm
)paren
op_ne
l_int|0
)paren
id|drop_mmu_context
c_func
(paren
id|vma-&gt;vm_mm
comma
id|cpu
)paren
suffix:semicolon
)brace
r_else
id|r4k_blast_icache
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|r4k_flush_icache_page
r_static
r_void
id|r4k_flush_icache_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_struct
id|page
op_star
id|page
)paren
(brace
r_struct
id|flush_icache_page_args
id|args
suffix:semicolon
multiline_comment|/*&n;&t; * If there&squot;s no context yet, or the page isn&squot;t executable, no I-cache&n;&t; * flush is needed.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_EXEC
)paren
)paren
r_return
suffix:semicolon
id|args.vma
op_assign
id|vma
suffix:semicolon
id|args.page
op_assign
id|page
suffix:semicolon
id|on_each_cpu
c_func
(paren
id|local_r4k_flush_icache_page
comma
op_amp
id|args
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_DMA_NONCOHERENT
DECL|function|r4k_dma_cache_wback_inv
r_static
r_void
id|r4k_dma_cache_wback_inv
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|end
comma
id|a
suffix:semicolon
multiline_comment|/* Catch bad driver code */
id|BUG_ON
c_func
(paren
id|size
op_eq
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpu_has_subset_pcaches
)paren
(brace
r_int
r_int
id|sc_lsize
op_assign
id|current_cpu_data.scache.linesz
suffix:semicolon
r_if
c_cond
(paren
id|size
op_ge
id|scache_size
)paren
(brace
id|r4k_blast_scache
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|a
op_assign
id|addr
op_amp
op_complement
(paren
id|sc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
id|end
op_assign
(paren
id|addr
op_plus
id|size
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|sc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|flush_scache_line
c_func
(paren
id|a
)paren
suffix:semicolon
multiline_comment|/* Hit_Writeback_Inv_SD */
r_if
c_cond
(paren
id|a
op_eq
id|end
)paren
r_break
suffix:semicolon
id|a
op_add_assign
id|sc_lsize
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Either no secondary cache or the available caches don&squot;t have the&n;&t; * subset property so we have to flush the primary caches&n;&t; * explicitly&n;&t; */
r_if
c_cond
(paren
id|size
op_ge
id|dcache_size
)paren
(brace
id|r4k_blast_dcache
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|dc_lsize
op_assign
id|current_cpu_data.dcache.linesz
suffix:semicolon
id|R4600_HIT_CACHEOP_WAR_IMPL
suffix:semicolon
id|a
op_assign
id|addr
op_amp
op_complement
(paren
id|dc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
id|end
op_assign
(paren
id|addr
op_plus
id|size
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|dc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|flush_dcache_line
c_func
(paren
id|a
)paren
suffix:semicolon
multiline_comment|/* Hit_Writeback_Inv_D */
r_if
c_cond
(paren
id|a
op_eq
id|end
)paren
r_break
suffix:semicolon
id|a
op_add_assign
id|dc_lsize
suffix:semicolon
)brace
)brace
id|bc_wback_inv
c_func
(paren
id|addr
comma
id|size
)paren
suffix:semicolon
)brace
DECL|function|r4k_dma_cache_inv
r_static
r_void
id|r4k_dma_cache_inv
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|end
comma
id|a
suffix:semicolon
multiline_comment|/* Catch bad driver code */
id|BUG_ON
c_func
(paren
id|size
op_eq
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpu_has_subset_pcaches
)paren
(brace
r_int
r_int
id|sc_lsize
op_assign
id|current_cpu_data.scache.linesz
suffix:semicolon
r_if
c_cond
(paren
id|size
op_ge
id|scache_size
)paren
(brace
id|r4k_blast_scache
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|a
op_assign
id|addr
op_amp
op_complement
(paren
id|sc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
id|end
op_assign
(paren
id|addr
op_plus
id|size
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|sc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|flush_scache_line
c_func
(paren
id|a
)paren
suffix:semicolon
multiline_comment|/* Hit_Writeback_Inv_SD */
r_if
c_cond
(paren
id|a
op_eq
id|end
)paren
r_break
suffix:semicolon
id|a
op_add_assign
id|sc_lsize
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|size
op_ge
id|dcache_size
)paren
(brace
id|r4k_blast_dcache
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|dc_lsize
op_assign
id|current_cpu_data.dcache.linesz
suffix:semicolon
id|R4600_HIT_CACHEOP_WAR_IMPL
suffix:semicolon
id|a
op_assign
id|addr
op_amp
op_complement
(paren
id|dc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
id|end
op_assign
(paren
id|addr
op_plus
id|size
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|dc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|flush_dcache_line
c_func
(paren
id|a
)paren
suffix:semicolon
multiline_comment|/* Hit_Writeback_Inv_D */
r_if
c_cond
(paren
id|a
op_eq
id|end
)paren
r_break
suffix:semicolon
id|a
op_add_assign
id|dc_lsize
suffix:semicolon
)brace
)brace
id|bc_inv
c_func
(paren
id|addr
comma
id|size
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_DMA_NONCOHERENT */
multiline_comment|/*&n; * While we&squot;re protected against bad userland addresses we don&squot;t care&n; * very much about what happens in that case.  Usually a segmentation&n; * fault will dump the process later on anyway ...&n; */
DECL|function|local_r4k_flush_cache_sigtramp
r_static
r_void
id|local_r4k_flush_cache_sigtramp
c_func
(paren
r_void
op_star
id|arg
)paren
(brace
r_int
r_int
id|ic_lsize
op_assign
id|current_cpu_data.icache.linesz
suffix:semicolon
r_int
r_int
id|dc_lsize
op_assign
id|current_cpu_data.dcache.linesz
suffix:semicolon
r_int
r_int
id|sc_lsize
op_assign
id|current_cpu_data.scache.linesz
suffix:semicolon
r_int
r_int
id|addr
op_assign
(paren
r_int
r_int
)paren
id|arg
suffix:semicolon
id|R4600_HIT_CACHEOP_WAR_IMPL
suffix:semicolon
id|protected_writeback_dcache_line
c_func
(paren
id|addr
op_amp
op_complement
(paren
id|dc_lsize
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpu_icache_snoops_remote_store
)paren
id|protected_writeback_scache_line
c_func
(paren
id|addr
op_amp
op_complement
(paren
id|sc_lsize
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|protected_flush_icache_line
c_func
(paren
id|addr
op_amp
op_complement
(paren
id|ic_lsize
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|MIPS4K_ICACHE_REFILL_WAR
)paren
(brace
id|__asm__
id|__volatile__
(paren
l_string|&quot;.set push&bslash;n&bslash;t&quot;
l_string|&quot;.set noat&bslash;n&bslash;t&quot;
l_string|&quot;.set mips3&bslash;n&bslash;t&quot;
macro_line|#ifdef CONFIG_MIPS32
l_string|&quot;la&t;$at,1f&bslash;n&bslash;t&quot;
macro_line|#endif
macro_line|#ifdef CONFIG_MIPS64
l_string|&quot;dla&t;$at,1f&bslash;n&bslash;t&quot;
macro_line|#endif
l_string|&quot;cache&t;%0,($at)&bslash;n&bslash;t&quot;
l_string|&quot;nop; nop; nop&bslash;n&quot;
l_string|&quot;1:&bslash;n&bslash;t&quot;
l_string|&quot;.set pop&quot;
suffix:colon
suffix:colon
l_string|&quot;i&quot;
(paren
id|Hit_Invalidate_I
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MIPS_CACHE_SYNC_WAR
)paren
id|__asm__
id|__volatile__
(paren
l_string|&quot;sync&quot;
)paren
suffix:semicolon
)brace
DECL|function|r4k_flush_cache_sigtramp
r_static
r_void
id|r4k_flush_cache_sigtramp
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
id|on_each_cpu
c_func
(paren
id|local_r4k_flush_cache_sigtramp
comma
(paren
r_void
op_star
)paren
id|addr
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|r4k_flush_icache_all
r_static
r_void
id|r4k_flush_icache_all
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|cpu_has_vtag_icache
)paren
id|r4k_blast_icache
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|rm7k_erratum31
r_static
r_inline
r_void
id|rm7k_erratum31
c_func
(paren
r_void
)paren
(brace
r_const
r_int
r_int
id|ic_lsize
op_assign
l_int|32
suffix:semicolon
r_int
r_int
id|addr
suffix:semicolon
multiline_comment|/* RM7000 erratum #31. The icache is screwed at startup. */
id|write_c0_taglo
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|write_c0_taghi
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|addr
op_assign
id|INDEX_BASE
suffix:semicolon
id|addr
op_le
id|INDEX_BASE
op_plus
l_int|4096
suffix:semicolon
id|addr
op_add_assign
id|ic_lsize
)paren
(brace
id|__asm__
id|__volatile__
(paren
l_string|&quot;.set noreorder&bslash;n&bslash;t&quot;
l_string|&quot;.set mips3&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%1, 0(%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%1, 0x1000(%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%1, 0x2000(%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%1, 0x3000(%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%2, 0(%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%2, 0x1000(%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%2, 0x2000(%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%2, 0x3000(%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%1, 0(%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%1, 0x1000(%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%1, 0x2000(%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%1, 0x3000(%0)&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tmips0&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;treorder&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|addr
)paren
comma
l_string|&quot;i&quot;
(paren
id|Index_Store_Tag_I
)paren
comma
l_string|&quot;i&quot;
(paren
id|Fill
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|variable|__initdata
r_static
r_char
op_star
id|way_string
(braket
)braket
id|__initdata
op_assign
(brace
l_int|NULL
comma
l_string|&quot;direct mapped&quot;
comma
l_string|&quot;2-way&quot;
comma
l_string|&quot;3-way&quot;
comma
l_string|&quot;4-way&quot;
comma
l_string|&quot;5-way&quot;
comma
l_string|&quot;6-way&quot;
comma
l_string|&quot;7-way&quot;
comma
l_string|&quot;8-way&quot;
)brace
suffix:semicolon
DECL|function|probe_pcache
r_static
r_void
id|__init
id|probe_pcache
c_func
(paren
r_void
)paren
(brace
r_struct
id|cpuinfo_mips
op_star
id|c
op_assign
op_amp
id|current_cpu_data
suffix:semicolon
r_int
r_int
id|config
op_assign
id|read_c0_config
c_func
(paren
)paren
suffix:semicolon
r_int
r_int
id|prid
op_assign
id|read_c0_prid
c_func
(paren
)paren
suffix:semicolon
r_int
r_int
id|config1
suffix:semicolon
r_int
r_int
id|lsize
suffix:semicolon
r_switch
c_cond
(paren
id|c-&gt;cputype
)paren
(brace
r_case
id|CPU_R4600
suffix:colon
multiline_comment|/* QED style two way caches? */
r_case
id|CPU_R4700
suffix:colon
r_case
id|CPU_R5000
suffix:colon
r_case
id|CPU_NEVADA
suffix:colon
id|icache_size
op_assign
l_int|1
op_lshift
(paren
l_int|12
op_plus
(paren
(paren
id|config
op_amp
id|CONF_IC
)paren
op_rshift
l_int|9
)paren
)paren
suffix:semicolon
id|c-&gt;icache.linesz
op_assign
l_int|16
op_lshift
(paren
(paren
id|config
op_amp
id|CONF_IB
)paren
op_rshift
l_int|5
)paren
suffix:semicolon
id|c-&gt;icache.ways
op_assign
l_int|2
suffix:semicolon
id|c-&gt;icache.waybit
op_assign
id|ffs
c_func
(paren
id|icache_size
op_div
l_int|2
)paren
op_minus
l_int|1
suffix:semicolon
id|dcache_size
op_assign
l_int|1
op_lshift
(paren
l_int|12
op_plus
(paren
(paren
id|config
op_amp
id|CONF_DC
)paren
op_rshift
l_int|6
)paren
)paren
suffix:semicolon
id|c-&gt;dcache.linesz
op_assign
l_int|16
op_lshift
(paren
(paren
id|config
op_amp
id|CONF_DB
)paren
op_rshift
l_int|4
)paren
suffix:semicolon
id|c-&gt;dcache.ways
op_assign
l_int|2
suffix:semicolon
id|c-&gt;dcache.waybit
op_assign
id|ffs
c_func
(paren
id|dcache_size
op_div
l_int|2
)paren
op_minus
l_int|1
suffix:semicolon
id|c-&gt;options
op_or_assign
id|MIPS_CPU_CACHE_CDEX_P
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPU_R5432
suffix:colon
r_case
id|CPU_R5500
suffix:colon
id|icache_size
op_assign
l_int|1
op_lshift
(paren
l_int|12
op_plus
(paren
(paren
id|config
op_amp
id|CONF_IC
)paren
op_rshift
l_int|9
)paren
)paren
suffix:semicolon
id|c-&gt;icache.linesz
op_assign
l_int|16
op_lshift
(paren
(paren
id|config
op_amp
id|CONF_IB
)paren
op_rshift
l_int|5
)paren
suffix:semicolon
id|c-&gt;icache.ways
op_assign
l_int|2
suffix:semicolon
id|c-&gt;icache.waybit
op_assign
l_int|0
suffix:semicolon
id|dcache_size
op_assign
l_int|1
op_lshift
(paren
l_int|12
op_plus
(paren
(paren
id|config
op_amp
id|CONF_DC
)paren
op_rshift
l_int|6
)paren
)paren
suffix:semicolon
id|c-&gt;dcache.linesz
op_assign
l_int|16
op_lshift
(paren
(paren
id|config
op_amp
id|CONF_DB
)paren
op_rshift
l_int|4
)paren
suffix:semicolon
id|c-&gt;dcache.ways
op_assign
l_int|2
suffix:semicolon
id|c-&gt;dcache.waybit
op_assign
l_int|0
suffix:semicolon
id|c-&gt;options
op_or_assign
id|MIPS_CPU_CACHE_CDEX_P
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPU_TX49XX
suffix:colon
id|icache_size
op_assign
l_int|1
op_lshift
(paren
l_int|12
op_plus
(paren
(paren
id|config
op_amp
id|CONF_IC
)paren
op_rshift
l_int|9
)paren
)paren
suffix:semicolon
id|c-&gt;icache.linesz
op_assign
l_int|16
op_lshift
(paren
(paren
id|config
op_amp
id|CONF_IB
)paren
op_rshift
l_int|5
)paren
suffix:semicolon
id|c-&gt;icache.ways
op_assign
l_int|4
suffix:semicolon
id|c-&gt;icache.waybit
op_assign
l_int|0
suffix:semicolon
id|dcache_size
op_assign
l_int|1
op_lshift
(paren
l_int|12
op_plus
(paren
(paren
id|config
op_amp
id|CONF_DC
)paren
op_rshift
l_int|6
)paren
)paren
suffix:semicolon
id|c-&gt;dcache.linesz
op_assign
l_int|16
op_lshift
(paren
(paren
id|config
op_amp
id|CONF_DB
)paren
op_rshift
l_int|4
)paren
suffix:semicolon
id|c-&gt;dcache.ways
op_assign
l_int|4
suffix:semicolon
id|c-&gt;dcache.waybit
op_assign
l_int|0
suffix:semicolon
id|c-&gt;options
op_or_assign
id|MIPS_CPU_CACHE_CDEX_P
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPU_R4000PC
suffix:colon
r_case
id|CPU_R4000SC
suffix:colon
r_case
id|CPU_R4000MC
suffix:colon
r_case
id|CPU_R4400PC
suffix:colon
r_case
id|CPU_R4400SC
suffix:colon
r_case
id|CPU_R4400MC
suffix:colon
r_case
id|CPU_R4300
suffix:colon
id|icache_size
op_assign
l_int|1
op_lshift
(paren
l_int|12
op_plus
(paren
(paren
id|config
op_amp
id|CONF_IC
)paren
op_rshift
l_int|9
)paren
)paren
suffix:semicolon
id|c-&gt;icache.linesz
op_assign
l_int|16
op_lshift
(paren
(paren
id|config
op_amp
id|CONF_IB
)paren
op_rshift
l_int|5
)paren
suffix:semicolon
id|c-&gt;icache.ways
op_assign
l_int|1
suffix:semicolon
id|c-&gt;icache.waybit
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* doesn&squot;t matter */
id|dcache_size
op_assign
l_int|1
op_lshift
(paren
l_int|12
op_plus
(paren
(paren
id|config
op_amp
id|CONF_DC
)paren
op_rshift
l_int|6
)paren
)paren
suffix:semicolon
id|c-&gt;dcache.linesz
op_assign
l_int|16
op_lshift
(paren
(paren
id|config
op_amp
id|CONF_DB
)paren
op_rshift
l_int|4
)paren
suffix:semicolon
id|c-&gt;dcache.ways
op_assign
l_int|1
suffix:semicolon
id|c-&gt;dcache.waybit
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* does not matter */
id|c-&gt;options
op_or_assign
id|MIPS_CPU_CACHE_CDEX_P
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPU_R10000
suffix:colon
r_case
id|CPU_R12000
suffix:colon
id|icache_size
op_assign
l_int|1
op_lshift
(paren
l_int|12
op_plus
(paren
(paren
id|config
op_amp
id|R10K_CONF_IC
)paren
op_rshift
l_int|29
)paren
)paren
suffix:semicolon
id|c-&gt;icache.linesz
op_assign
l_int|64
suffix:semicolon
id|c-&gt;icache.ways
op_assign
l_int|2
suffix:semicolon
id|c-&gt;icache.waybit
op_assign
l_int|0
suffix:semicolon
id|dcache_size
op_assign
l_int|1
op_lshift
(paren
l_int|12
op_plus
(paren
(paren
id|config
op_amp
id|R10K_CONF_DC
)paren
op_rshift
l_int|26
)paren
)paren
suffix:semicolon
id|c-&gt;dcache.linesz
op_assign
l_int|32
suffix:semicolon
id|c-&gt;dcache.ways
op_assign
l_int|2
suffix:semicolon
id|c-&gt;dcache.waybit
op_assign
l_int|0
suffix:semicolon
id|c-&gt;options
op_or_assign
id|MIPS_CPU_PREFETCH
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPU_VR4133
suffix:colon
id|write_c0_config
c_func
(paren
id|config
op_amp
op_complement
id|CONF_EB
)paren
suffix:semicolon
r_case
id|CPU_VR4131
suffix:colon
multiline_comment|/* Workaround for cache instruction bug of VR4131 */
r_if
c_cond
(paren
id|c-&gt;processor_id
op_eq
l_int|0x0c80U
op_logical_or
id|c-&gt;processor_id
op_eq
l_int|0x0c81U
op_logical_or
id|c-&gt;processor_id
op_eq
l_int|0x0c82U
)paren
(brace
id|config
op_and_assign
op_complement
l_int|0x00000030U
suffix:semicolon
id|config
op_or_assign
l_int|0x00410000U
suffix:semicolon
id|write_c0_config
c_func
(paren
id|config
)paren
suffix:semicolon
)brace
id|icache_size
op_assign
l_int|1
op_lshift
(paren
l_int|10
op_plus
(paren
(paren
id|config
op_amp
id|CONF_IC
)paren
op_rshift
l_int|9
)paren
)paren
suffix:semicolon
id|c-&gt;icache.linesz
op_assign
l_int|16
op_lshift
(paren
(paren
id|config
op_amp
id|CONF_IB
)paren
op_rshift
l_int|5
)paren
suffix:semicolon
id|c-&gt;icache.ways
op_assign
l_int|2
suffix:semicolon
id|c-&gt;icache.waybit
op_assign
id|ffs
c_func
(paren
id|icache_size
op_div
l_int|2
)paren
op_minus
l_int|1
suffix:semicolon
id|dcache_size
op_assign
l_int|1
op_lshift
(paren
l_int|10
op_plus
(paren
(paren
id|config
op_amp
id|CONF_DC
)paren
op_rshift
l_int|6
)paren
)paren
suffix:semicolon
id|c-&gt;dcache.linesz
op_assign
l_int|16
op_lshift
(paren
(paren
id|config
op_amp
id|CONF_DB
)paren
op_rshift
l_int|4
)paren
suffix:semicolon
id|c-&gt;dcache.ways
op_assign
l_int|2
suffix:semicolon
id|c-&gt;dcache.waybit
op_assign
id|ffs
c_func
(paren
id|dcache_size
op_div
l_int|2
)paren
op_minus
l_int|1
suffix:semicolon
id|c-&gt;options
op_or_assign
id|MIPS_CPU_CACHE_CDEX_P
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPU_VR41XX
suffix:colon
r_case
id|CPU_VR4111
suffix:colon
r_case
id|CPU_VR4121
suffix:colon
r_case
id|CPU_VR4122
suffix:colon
r_case
id|CPU_VR4181
suffix:colon
r_case
id|CPU_VR4181A
suffix:colon
id|icache_size
op_assign
l_int|1
op_lshift
(paren
l_int|10
op_plus
(paren
(paren
id|config
op_amp
id|CONF_IC
)paren
op_rshift
l_int|9
)paren
)paren
suffix:semicolon
id|c-&gt;icache.linesz
op_assign
l_int|16
op_lshift
(paren
(paren
id|config
op_amp
id|CONF_IB
)paren
op_rshift
l_int|5
)paren
suffix:semicolon
id|c-&gt;icache.ways
op_assign
l_int|1
suffix:semicolon
id|c-&gt;icache.waybit
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* doesn&squot;t matter */
id|dcache_size
op_assign
l_int|1
op_lshift
(paren
l_int|10
op_plus
(paren
(paren
id|config
op_amp
id|CONF_DC
)paren
op_rshift
l_int|6
)paren
)paren
suffix:semicolon
id|c-&gt;dcache.linesz
op_assign
l_int|16
op_lshift
(paren
(paren
id|config
op_amp
id|CONF_DB
)paren
op_rshift
l_int|4
)paren
suffix:semicolon
id|c-&gt;dcache.ways
op_assign
l_int|1
suffix:semicolon
id|c-&gt;dcache.waybit
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* does not matter */
id|c-&gt;options
op_or_assign
id|MIPS_CPU_CACHE_CDEX_P
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPU_RM7000
suffix:colon
id|rm7k_erratum31
c_func
(paren
)paren
suffix:semicolon
r_case
id|CPU_RM9000
suffix:colon
id|icache_size
op_assign
l_int|1
op_lshift
(paren
l_int|12
op_plus
(paren
(paren
id|config
op_amp
id|CONF_IC
)paren
op_rshift
l_int|9
)paren
)paren
suffix:semicolon
id|c-&gt;icache.linesz
op_assign
l_int|16
op_lshift
(paren
(paren
id|config
op_amp
id|CONF_IB
)paren
op_rshift
l_int|5
)paren
suffix:semicolon
id|c-&gt;icache.ways
op_assign
l_int|4
suffix:semicolon
id|c-&gt;icache.waybit
op_assign
id|ffs
c_func
(paren
id|icache_size
op_div
id|c-&gt;icache.ways
)paren
op_minus
l_int|1
suffix:semicolon
id|dcache_size
op_assign
l_int|1
op_lshift
(paren
l_int|12
op_plus
(paren
(paren
id|config
op_amp
id|CONF_DC
)paren
op_rshift
l_int|6
)paren
)paren
suffix:semicolon
id|c-&gt;dcache.linesz
op_assign
l_int|16
op_lshift
(paren
(paren
id|config
op_amp
id|CONF_DB
)paren
op_rshift
l_int|4
)paren
suffix:semicolon
id|c-&gt;dcache.ways
op_assign
l_int|4
suffix:semicolon
id|c-&gt;dcache.waybit
op_assign
id|ffs
c_func
(paren
id|dcache_size
op_div
id|c-&gt;dcache.ways
)paren
op_minus
l_int|1
suffix:semicolon
macro_line|#if !defined(CONFIG_SMP) || !defined(RM9000_CDEX_SMP_WAR)
id|c-&gt;options
op_or_assign
id|MIPS_CPU_CACHE_CDEX_P
suffix:semicolon
macro_line|#endif
id|c-&gt;options
op_or_assign
id|MIPS_CPU_PREFETCH
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|config
op_amp
id|MIPS_CONF_M
)paren
)paren
id|panic
c_func
(paren
l_string|&quot;Don&squot;t know how to probe P-caches on this cpu.&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * So we seem to be a MIPS32 or MIPS64 CPU&n;&t;&t; * So let&squot;s probe the I-cache ...&n;&t;&t; */
id|config1
op_assign
id|read_c0_config1
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lsize
op_assign
(paren
(paren
id|config1
op_rshift
l_int|19
)paren
op_amp
l_int|7
)paren
)paren
)paren
id|c-&gt;icache.linesz
op_assign
l_int|2
op_lshift
id|lsize
suffix:semicolon
r_else
id|c-&gt;icache.linesz
op_assign
id|lsize
suffix:semicolon
id|c-&gt;icache.sets
op_assign
l_int|64
op_lshift
(paren
(paren
id|config1
op_rshift
l_int|22
)paren
op_amp
l_int|7
)paren
suffix:semicolon
id|c-&gt;icache.ways
op_assign
l_int|1
op_plus
(paren
(paren
id|config1
op_rshift
l_int|16
)paren
op_amp
l_int|7
)paren
suffix:semicolon
id|icache_size
op_assign
id|c-&gt;icache.sets
op_star
id|c-&gt;icache.ways
op_star
id|c-&gt;icache.linesz
suffix:semicolon
id|c-&gt;icache.waybit
op_assign
id|ffs
c_func
(paren
id|icache_size
op_div
id|c-&gt;icache.ways
)paren
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|config
op_amp
l_int|0x8
)paren
multiline_comment|/* VI bit */
id|c-&gt;icache.flags
op_or_assign
id|MIPS_CACHE_VTAG
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Now probe the MIPS32 / MIPS64 data cache.&n;&t;&t; */
id|c-&gt;dcache.flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lsize
op_assign
(paren
(paren
id|config1
op_rshift
l_int|10
)paren
op_amp
l_int|7
)paren
)paren
)paren
id|c-&gt;dcache.linesz
op_assign
l_int|2
op_lshift
id|lsize
suffix:semicolon
r_else
id|c-&gt;dcache.linesz
op_assign
id|lsize
suffix:semicolon
id|c-&gt;dcache.sets
op_assign
l_int|64
op_lshift
(paren
(paren
id|config1
op_rshift
l_int|13
)paren
op_amp
l_int|7
)paren
suffix:semicolon
id|c-&gt;dcache.ways
op_assign
l_int|1
op_plus
(paren
(paren
id|config1
op_rshift
l_int|7
)paren
op_amp
l_int|7
)paren
suffix:semicolon
id|dcache_size
op_assign
id|c-&gt;dcache.sets
op_star
id|c-&gt;dcache.ways
op_star
id|c-&gt;dcache.linesz
suffix:semicolon
id|c-&gt;dcache.waybit
op_assign
id|ffs
c_func
(paren
id|dcache_size
op_div
id|c-&gt;dcache.ways
)paren
op_minus
l_int|1
suffix:semicolon
id|c-&gt;options
op_or_assign
id|MIPS_CPU_PREFETCH
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Processor configuration sanity check for the R4000SC erratum&n;&t; * #5.  With page sizes larger than 32kB there is no possibility&n;&t; * to get a VCE exception anymore so we don&squot;t care about this&n;&t; * misconfiguration.  The case is rather theoretical anyway;&n;&t; * presumably no vendor is shipping his hardware in the &quot;bad&quot;&n;&t; * configuration.&n;&t; */
r_if
c_cond
(paren
(paren
id|prid
op_amp
l_int|0xff00
)paren
op_eq
id|PRID_IMP_R4000
op_logical_and
(paren
id|prid
op_amp
l_int|0xff
)paren
OL
l_int|0x40
op_logical_and
op_logical_neg
(paren
id|config
op_amp
id|CONF_SC
)paren
op_logical_and
id|c-&gt;icache.linesz
op_ne
l_int|16
op_logical_and
id|PAGE_SIZE
op_le
l_int|0x8000
)paren
id|panic
c_func
(paren
l_string|&quot;Improper R4000SC processor configuration detected&quot;
)paren
suffix:semicolon
multiline_comment|/* compute a couple of other cache variables */
id|c-&gt;icache.waysize
op_assign
id|icache_size
op_div
id|c-&gt;icache.ways
suffix:semicolon
id|c-&gt;dcache.waysize
op_assign
id|dcache_size
op_div
id|c-&gt;dcache.ways
suffix:semicolon
id|c-&gt;icache.sets
op_assign
id|icache_size
op_div
(paren
id|c-&gt;icache.linesz
op_star
id|c-&gt;icache.ways
)paren
suffix:semicolon
id|c-&gt;dcache.sets
op_assign
id|dcache_size
op_div
(paren
id|c-&gt;dcache.linesz
op_star
id|c-&gt;dcache.ways
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * R10000 and R12000 P-caches are odd in a positive way.  They&squot;re 32kB&n;&t; * 2-way virtually indexed so normally would suffer from aliases.  So&n;&t; * normally they&squot;d suffer from aliases but magic in the hardware deals&n;&t; * with that for us so we don&squot;t need to take care ourselves.&n;&t; */
r_if
c_cond
(paren
id|c-&gt;cputype
op_ne
id|CPU_R10000
op_logical_and
id|c-&gt;cputype
op_ne
id|CPU_R12000
)paren
r_if
c_cond
(paren
id|c-&gt;dcache.waysize
OG
id|PAGE_SIZE
)paren
id|c-&gt;dcache.flags
op_or_assign
id|MIPS_CACHE_ALIASES
suffix:semicolon
r_switch
c_cond
(paren
id|c-&gt;cputype
)paren
(brace
r_case
id|CPU_20KC
suffix:colon
multiline_comment|/*&n;&t;&t; * Some older 20Kc chips doesn&squot;t have the &squot;VI&squot; bit in&n;&t;&t; * the config register.&n;&t;&t; */
id|c-&gt;icache.flags
op_or_assign
id|MIPS_CACHE_VTAG
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPU_AU1500
suffix:colon
id|c-&gt;icache.flags
op_or_assign
id|MIPS_CACHE_IC_F_DC
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;Primary instruction cache %ldkB, %s, %s, linesize %d bytes.&bslash;n&quot;
comma
id|icache_size
op_rshift
l_int|10
comma
id|cpu_has_vtag_icache
ques
c_cond
l_string|&quot;virtually tagged&quot;
suffix:colon
l_string|&quot;physically tagged&quot;
comma
id|way_string
(braket
id|c-&gt;icache.ways
)braket
comma
id|c-&gt;icache.linesz
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Primary data cache %ldkB, %s, linesize %d bytes.&bslash;n&quot;
comma
id|dcache_size
op_rshift
l_int|10
comma
id|way_string
(braket
id|c-&gt;dcache.ways
)braket
comma
id|c-&gt;dcache.linesz
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * If you even _breathe_ on this function, look at the gcc output and make sure&n; * it does not pop things on and off the stack for the cache sizing loop that&n; * executes in KSEG1 space or else you will crash and burn badly.  You have&n; * been warned.&n; */
DECL|function|probe_scache
r_static
r_int
id|__init
id|probe_scache
c_func
(paren
r_void
)paren
(brace
r_extern
r_int
r_int
id|stext
suffix:semicolon
r_int
r_int
id|flags
comma
id|addr
comma
id|begin
comma
id|end
comma
id|pow2
suffix:semicolon
r_int
r_int
id|config
op_assign
id|read_c0_config
c_func
(paren
)paren
suffix:semicolon
r_struct
id|cpuinfo_mips
op_star
id|c
op_assign
op_amp
id|current_cpu_data
suffix:semicolon
r_int
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|config
op_amp
id|CONF_SC
)paren
r_return
l_int|0
suffix:semicolon
id|begin
op_assign
(paren
r_int
r_int
)paren
op_amp
id|stext
suffix:semicolon
id|begin
op_and_assign
op_complement
(paren
(paren
l_int|4
op_star
l_int|1024
op_star
l_int|1024
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|end
op_assign
id|begin
op_plus
(paren
l_int|4
op_star
l_int|1024
op_star
l_int|1024
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * This is such a bitch, you&squot;d think they would make it easy to do&n;&t; * this.  Away you daemons of stupidity!&n;&t; */
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Fill each size-multiple cache line with a valid tag. */
id|pow2
op_assign
(paren
l_int|64
op_star
l_int|1024
)paren
suffix:semicolon
r_for
c_loop
(paren
id|addr
op_assign
id|begin
suffix:semicolon
id|addr
OL
id|end
suffix:semicolon
id|addr
op_assign
(paren
id|begin
op_plus
id|pow2
)paren
)paren
(brace
r_int
r_int
op_star
id|p
op_assign
(paren
r_int
r_int
op_star
)paren
id|addr
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;nop&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
op_star
id|p
)paren
)paren
suffix:semicolon
multiline_comment|/* whee... */
id|pow2
op_lshift_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Load first line with zero (therefore invalid) tag. */
id|write_c0_taglo
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|write_c0_taghi
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;nop; nop; nop; nop;&quot;
)paren
suffix:semicolon
multiline_comment|/* avoid the hazard */
id|cache_op
c_func
(paren
id|Index_Store_Tag_I
comma
id|begin
)paren
suffix:semicolon
id|cache_op
c_func
(paren
id|Index_Store_Tag_D
comma
id|begin
)paren
suffix:semicolon
id|cache_op
c_func
(paren
id|Index_Store_Tag_SD
comma
id|begin
)paren
suffix:semicolon
multiline_comment|/* Now search for the wrap around point. */
id|pow2
op_assign
(paren
l_int|128
op_star
l_int|1024
)paren
suffix:semicolon
id|tmp
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|addr
op_assign
id|begin
op_plus
(paren
l_int|128
op_star
l_int|1024
)paren
suffix:semicolon
id|addr
OL
id|end
suffix:semicolon
id|addr
op_assign
id|begin
op_plus
id|pow2
)paren
(brace
id|cache_op
c_func
(paren
id|Index_Load_Tag_SD
comma
id|addr
)paren
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;nop; nop; nop; nop;&quot;
)paren
suffix:semicolon
multiline_comment|/* hazard... */
r_if
c_cond
(paren
op_logical_neg
id|read_c0_taglo
c_func
(paren
)paren
)paren
r_break
suffix:semicolon
id|pow2
op_lshift_assign
l_int|1
suffix:semicolon
)brace
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
id|addr
op_sub_assign
id|begin
suffix:semicolon
id|scache_size
op_assign
id|addr
suffix:semicolon
id|c-&gt;scache.linesz
op_assign
l_int|16
op_lshift
(paren
(paren
id|config
op_amp
id|R4K_CONF_SB
)paren
op_rshift
l_int|22
)paren
suffix:semicolon
id|c-&gt;scache.ways
op_assign
l_int|1
suffix:semicolon
id|c-&gt;dcache.waybit
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* does not matter */
r_return
l_int|1
suffix:semicolon
)brace
DECL|typedef|probe_func_t
r_typedef
r_int
(paren
op_star
id|probe_func_t
)paren
(paren
r_int
r_int
)paren
suffix:semicolon
r_extern
r_int
id|r5k_sc_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_int
id|rm7k_sc_init
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|function|setup_scache
r_static
r_void
id|__init
id|setup_scache
c_func
(paren
r_void
)paren
(brace
r_struct
id|cpuinfo_mips
op_star
id|c
op_assign
op_amp
id|current_cpu_data
suffix:semicolon
r_int
r_int
id|config
op_assign
id|read_c0_config
c_func
(paren
)paren
suffix:semicolon
id|probe_func_t
id|probe_scache_kseg1
suffix:semicolon
r_int
id|sc_present
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Do the probing thing on R4000SC and R4400SC processors.  Other&n;&t; * processors don&squot;t have a S-cache that would be relevant to the&n;&t; * Linux memory managment.&n;&t; */
r_switch
c_cond
(paren
id|c-&gt;cputype
)paren
(brace
r_case
id|CPU_R4000SC
suffix:colon
r_case
id|CPU_R4000MC
suffix:colon
r_case
id|CPU_R4400SC
suffix:colon
r_case
id|CPU_R4400MC
suffix:colon
id|probe_scache_kseg1
op_assign
(paren
id|probe_func_t
)paren
(paren
id|CKSEG1ADDR
c_func
(paren
op_amp
id|probe_scache
)paren
)paren
suffix:semicolon
id|sc_present
op_assign
id|probe_scache_kseg1
c_func
(paren
id|config
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sc_present
)paren
id|c-&gt;options
op_or_assign
id|MIPS_CPU_CACHE_CDEX_S
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPU_R10000
suffix:colon
r_case
id|CPU_R12000
suffix:colon
id|scache_size
op_assign
l_int|0x80000
op_lshift
(paren
(paren
id|config
op_amp
id|R10K_CONF_SS
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|c-&gt;scache.linesz
op_assign
l_int|64
op_lshift
(paren
(paren
id|config
op_rshift
l_int|13
)paren
op_amp
l_int|1
)paren
suffix:semicolon
id|c-&gt;scache.ways
op_assign
l_int|2
suffix:semicolon
id|c-&gt;scache.waybit
op_assign
l_int|0
suffix:semicolon
id|sc_present
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPU_R5000
suffix:colon
r_case
id|CPU_NEVADA
suffix:colon
macro_line|#ifdef CONFIG_R5000_CPU_SCACHE
id|r5k_sc_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
r_case
id|CPU_RM7000
suffix:colon
r_case
id|CPU_RM9000
suffix:colon
macro_line|#ifdef CONFIG_RM7000_CPU_SCACHE
id|rm7k_sc_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
r_default
suffix:colon
id|sc_present
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|sc_present
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c-&gt;isa_level
op_eq
id|MIPS_CPU_ISA_M32
op_logical_or
id|c-&gt;isa_level
op_eq
id|MIPS_CPU_ISA_M64
)paren
op_logical_and
op_logical_neg
(paren
id|c-&gt;scache.flags
op_amp
id|MIPS_CACHE_NOT_PRESENT
)paren
)paren
id|panic
c_func
(paren
l_string|&quot;Dunno how to handle MIPS32 / MIPS64 second level cache&quot;
)paren
suffix:semicolon
multiline_comment|/* compute a couple of other cache variables */
id|c-&gt;scache.waysize
op_assign
id|scache_size
op_div
id|c-&gt;scache.ways
suffix:semicolon
id|c-&gt;scache.sets
op_assign
id|scache_size
op_div
(paren
id|c-&gt;scache.linesz
op_star
id|c-&gt;scache.ways
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Unified secondary cache %ldkB %s, linesize %d bytes.&bslash;n&quot;
comma
id|scache_size
op_rshift
l_int|10
comma
id|way_string
(braket
id|c-&gt;scache.ways
)braket
comma
id|c-&gt;scache.linesz
)paren
suffix:semicolon
id|c-&gt;options
op_or_assign
id|MIPS_CPU_SUBSET_CACHES
suffix:semicolon
)brace
DECL|function|coherency_setup
r_static
r_inline
r_void
id|coherency_setup
c_func
(paren
r_void
)paren
(brace
id|change_c0_config
c_func
(paren
id|CONF_CM_CMASK
comma
id|CONF_CM_DEFAULT
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * c0_status.cu=0 specifies that updates by the sc instruction use&n;&t; * the coherency mode specified by the TLB; 1 means cachable&n;&t; * coherent update on write will be used.  Not all processors have&n;&t; * this bit and; some wire it to zero, others like Toshiba had the&n;&t; * silly idea of putting something else there ...&n;&t; */
r_switch
c_cond
(paren
id|current_cpu_data.cputype
)paren
(brace
r_case
id|CPU_R4000PC
suffix:colon
r_case
id|CPU_R4000SC
suffix:colon
r_case
id|CPU_R4000MC
suffix:colon
r_case
id|CPU_R4400PC
suffix:colon
r_case
id|CPU_R4400SC
suffix:colon
r_case
id|CPU_R4400MC
suffix:colon
id|clear_c0_config
c_func
(paren
id|CONF_CU
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|ld_mmu_r4xx0
r_void
id|__init
id|ld_mmu_r4xx0
c_func
(paren
r_void
)paren
(brace
r_extern
r_void
id|build_clear_page
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|build_copy_page
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_char
id|except_vec2_generic
suffix:semicolon
r_struct
id|cpuinfo_mips
op_star
id|c
op_assign
op_amp
id|current_cpu_data
suffix:semicolon
multiline_comment|/* Default cache error handler for R4000 and R5000 family */
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|CAC_BASE
op_plus
l_int|0x100
)paren
comma
op_amp
id|except_vec2_generic
comma
l_int|0x80
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|UNCAC_BASE
op_plus
l_int|0x100
)paren
comma
op_amp
id|except_vec2_generic
comma
l_int|0x80
)paren
suffix:semicolon
id|probe_pcache
c_func
(paren
)paren
suffix:semicolon
id|setup_scache
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;dcache.sets
op_star
id|c-&gt;dcache.ways
OG
id|PAGE_SIZE
)paren
id|c-&gt;dcache.flags
op_or_assign
id|MIPS_CACHE_ALIASES
suffix:semicolon
id|r4k_blast_dcache_page_setup
c_func
(paren
)paren
suffix:semicolon
id|r4k_blast_dcache_page_indexed_setup
c_func
(paren
)paren
suffix:semicolon
id|r4k_blast_dcache_setup
c_func
(paren
)paren
suffix:semicolon
id|r4k_blast_icache_page_setup
c_func
(paren
)paren
suffix:semicolon
id|r4k_blast_icache_page_indexed_setup
c_func
(paren
)paren
suffix:semicolon
id|r4k_blast_icache_setup
c_func
(paren
)paren
suffix:semicolon
id|r4k_blast_scache_page_setup
c_func
(paren
)paren
suffix:semicolon
id|r4k_blast_scache_page_indexed_setup
c_func
(paren
)paren
suffix:semicolon
id|r4k_blast_scache_setup
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Some MIPS32 and MIPS64 processors have physically indexed caches.&n;&t; * This code supports virtually indexed processors and will be&n;&t; * unnecessarily inefficient on physically indexed processors.&n;&t; */
id|shm_align_mask
op_assign
id|max_t
c_func
(paren
r_int
r_int
comma
id|c-&gt;dcache.sets
op_star
id|c-&gt;dcache.linesz
op_minus
l_int|1
comma
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|flush_cache_all
op_assign
id|r4k_flush_cache_all
suffix:semicolon
id|__flush_cache_all
op_assign
id|r4k___flush_cache_all
suffix:semicolon
id|flush_cache_mm
op_assign
id|r4k_flush_cache_mm
suffix:semicolon
id|flush_cache_page
op_assign
id|r4k_flush_cache_page
suffix:semicolon
id|flush_icache_page
op_assign
id|r4k_flush_icache_page
suffix:semicolon
id|flush_cache_range
op_assign
id|r4k_flush_cache_range
suffix:semicolon
id|flush_cache_sigtramp
op_assign
id|r4k_flush_cache_sigtramp
suffix:semicolon
id|flush_icache_all
op_assign
id|r4k_flush_icache_all
suffix:semicolon
id|flush_data_cache_page
op_assign
id|r4k_flush_data_cache_page
suffix:semicolon
id|flush_icache_range
op_assign
id|r4k_flush_icache_range
suffix:semicolon
macro_line|#ifdef CONFIG_DMA_NONCOHERENT
id|_dma_cache_wback_inv
op_assign
id|r4k_dma_cache_wback_inv
suffix:semicolon
id|_dma_cache_wback
op_assign
id|r4k_dma_cache_wback_inv
suffix:semicolon
id|_dma_cache_inv
op_assign
id|r4k_dma_cache_inv
suffix:semicolon
macro_line|#endif
id|__flush_cache_all
c_func
(paren
)paren
suffix:semicolon
id|coherency_setup
c_func
(paren
)paren
suffix:semicolon
id|build_clear_page
c_func
(paren
)paren
suffix:semicolon
id|build_copy_page
c_func
(paren
)paren
suffix:semicolon
)brace
eof
