multiline_comment|/*&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * r4xx0.c: R4000 processor variant specific MMU/Cache routines.&n; *&n; * Copyright (C) 1996 David S. Miller (dm@engr.sgi.com)&n; * Copyright (C) 1997, 1998 Ralf Baechle ralf@gnu.org&n; *&n; * To do:&n; *&n; *  - this code is a overbloated pig&n; *  - many of the bug workarounds are not efficient at all, but at&n; *    least they are functional ...&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#include &lt;asm/mmu_context.h&gt;
multiline_comment|/* CP0 hazard avoidance. */
DECL|macro|BARRIER
mdefine_line|#define BARRIER __asm__ __volatile__(&quot;.set noreorder&bslash;n&bslash;t&quot; &bslash;&n;&t;&t;&t;&t;     &quot;nop; nop; nop; nop; nop; nop;&bslash;n&bslash;t&quot; &bslash;&n;&t;&t;&t;&t;     &quot;.set reorder&bslash;n&bslash;t&quot;)
multiline_comment|/* Primary cache parameters. */
DECL|variable|icache_size
DECL|variable|dcache_size
r_static
r_int
id|icache_size
comma
id|dcache_size
suffix:semicolon
multiline_comment|/* Size in bytes */
DECL|macro|ic_lsize
mdefine_line|#define ic_lsize&t;32&t;&t;/* Fixed to 32 byte on RM7000  */
DECL|macro|dc_lsize
mdefine_line|#define dc_lsize&t;32&t;&t;/* Fixed to 32 byte on RM7000  */
DECL|macro|sc_lsize
mdefine_line|#define sc_lsize&t;32&t;&t;/* Fixed to 32 byte on RM7000  */
DECL|macro|tc_pagesize
mdefine_line|#define tc_pagesize&t;(32*128)
multiline_comment|/* Secondary cache parameters. */
DECL|macro|scache_size
mdefine_line|#define scache_size&t;(256*1024)&t;/* Fixed to 256KiB on RM7000 */
macro_line|#include &lt;asm/cacheops.h&gt;
macro_line|#include &lt;asm/r4kcache.h&gt;
DECL|variable|rm7k_tcache_enabled
r_int
id|rm7k_tcache_enabled
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * Not added to asm/r4kcache.h because it seems to be RM7000-specific.&n; */
DECL|macro|Page_Invalidate_T
mdefine_line|#define Page_Invalidate_T 0x16
DECL|function|invalidate_tcache_page
r_static
r_inline
r_void
id|invalidate_tcache_page
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;.set&bslash;tnoreorder&bslash;t&bslash;t&bslash;t# invalidate_tcache_page&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tmips3&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%1, (%0)&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tmips0&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;treorder&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|addr
)paren
comma
l_string|&quot;i&quot;
(paren
id|Page_Invalidate_T
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Zero an entire page.  Note that while the RM7000 has a second level cache&n; * it doesn&squot;t have a Create_Dirty_Excl_SD operation.&n; */
DECL|function|rm7k_clear_page
r_static
r_void
id|rm7k_clear_page
c_func
(paren
r_void
op_star
id|page
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;.set&bslash;tnoreorder&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tnoat&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tmips3&bslash;n&bslash;t&quot;
l_string|&quot;daddiu&bslash;t$1,%0,%2&bslash;n&quot;
l_string|&quot;1:&bslash;tcache&bslash;t%3,(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sd&bslash;t$0,(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sd&bslash;t$0,8(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sd&bslash;t$0,16(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sd&bslash;t$0,24(%0)&bslash;n&bslash;t&quot;
l_string|&quot;daddiu&bslash;t%0,64&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%3,-32(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sd&bslash;t$0,-32(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sd&bslash;t$0,-24(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sd&bslash;t$0,-16(%0)&bslash;n&bslash;t&quot;
l_string|&quot;bne&bslash;t$1,%0,1b&bslash;n&bslash;t&quot;
l_string|&quot;sd&bslash;t$0,-8(%0)&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tmips0&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tat&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;treorder&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|page
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|page
)paren
comma
l_string|&quot;I&quot;
(paren
id|PAGE_SIZE
)paren
comma
l_string|&quot;i&quot;
(paren
id|Create_Dirty_Excl_D
)paren
suffix:colon
l_string|&quot;$1&quot;
comma
l_string|&quot;memory&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Copy an entire page.  Note that while the RM7000 has a second level cache&n; * it doesn&squot;t have a Create_Dirty_Excl_SD operation.&n; */
DECL|function|rm7k_copy_page
r_static
r_void
id|rm7k_copy_page
c_func
(paren
r_void
op_star
id|to
comma
r_void
op_star
id|from
)paren
(brace
r_int
r_int
id|dummy1
comma
id|dummy2
suffix:semicolon
r_int
r_int
id|reg1
comma
id|reg2
comma
id|reg3
comma
id|reg4
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;.set&bslash;tnoreorder&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tnoat&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tmips3&bslash;n&bslash;t&quot;
l_string|&quot;daddiu&bslash;t$1,%0,%8&bslash;n&quot;
l_string|&quot;1:&bslash;tcache&bslash;t%9,(%0)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%2,(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%3,4(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%4,8(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%5,12(%1)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%2,(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%3,4(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%4,8(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%5,12(%0)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%2,16(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%3,20(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%4,24(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%5,28(%1)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%2,16(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%3,20(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%4,24(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%5,28(%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%9,32(%0)&bslash;n&bslash;t&quot;
l_string|&quot;daddiu&bslash;t%0,64&bslash;n&bslash;t&quot;
l_string|&quot;daddiu&bslash;t%1,64&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%2,-32(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%3,-28(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%4,-24(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%5,-20(%1)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%2,-32(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%3,-28(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%4,-24(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%5,-20(%0)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%2,-16(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%3,-12(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%4,-8(%1)&bslash;n&bslash;t&quot;
l_string|&quot;lw&bslash;t%5,-4(%1)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%2,-16(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%3,-12(%0)&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%4,-8(%0)&bslash;n&bslash;t&quot;
l_string|&quot;bne&bslash;t$1,%0,1b&bslash;n&bslash;t&quot;
l_string|&quot;sw&bslash;t%5,-4(%0)&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tmips0&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tat&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;treorder&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|dummy1
)paren
comma
l_string|&quot;=r&quot;
(paren
id|dummy2
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|reg1
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|reg2
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|reg3
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|reg4
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|to
)paren
comma
l_string|&quot;1&quot;
(paren
id|from
)paren
comma
l_string|&quot;I&quot;
(paren
id|PAGE_SIZE
)paren
comma
l_string|&quot;i&quot;
(paren
id|Create_Dirty_Excl_D
)paren
)paren
suffix:semicolon
)brace
DECL|function|__flush_cache_all_d32i32
r_static
r_void
id|__flush_cache_all_d32i32
c_func
(paren
r_void
)paren
(brace
id|blast_dcache32
c_func
(paren
)paren
suffix:semicolon
id|blast_icache32
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|rm7k_flush_cache_all_d32i32
r_static
r_inline
r_void
id|rm7k_flush_cache_all_d32i32
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Yes! Caches that don&squot;t suck ...  */
)brace
DECL|function|rm7k_flush_cache_range_d32i32
r_static
r_void
id|rm7k_flush_cache_range_d32i32
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
multiline_comment|/* RM7000 caches are sane ...  */
)brace
DECL|function|rm7k_flush_cache_mm_d32i32
r_static
r_void
id|rm7k_flush_cache_mm_d32i32
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
multiline_comment|/* RM7000 caches are sane ...  */
)brace
DECL|function|rm7k_flush_cache_page_d32i32
r_static
r_void
id|rm7k_flush_cache_page_d32i32
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
(brace
multiline_comment|/* RM7000 caches are sane ...  */
)brace
DECL|function|rm7k_flush_page_to_ram_d32i32
r_static
r_void
id|rm7k_flush_page_to_ram_d32i32
c_func
(paren
r_struct
id|page
op_star
id|page
)paren
(brace
multiline_comment|/* Yes!  Caches that don&squot;t suck!  */
)brace
DECL|function|rm7k_flush_icache_range
r_static
r_void
id|rm7k_flush_icache_range
c_func
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
multiline_comment|/*&n;&t; * FIXME: This is overdoing things and harms performance.&n;&t; */
id|__flush_cache_all_d32i32
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|rm7k_flush_icache_page
r_static
r_void
id|rm7k_flush_icache_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_struct
id|page
op_star
id|page
)paren
(brace
multiline_comment|/*&n;&t; * FIXME: We should not flush the entire cache but establish some&n;&t; * temporary mapping and use hit_invalidate operation to flush out&n;&t; * the line from the cache.&n;&t; */
id|__flush_cache_all_d32i32
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Writeback and invalidate the primary cache dcache before DMA.&n; * (XXX These need to be fixed ...)&n; */
r_static
r_void
DECL|function|rm7k_dma_cache_wback_inv
id|rm7k_dma_cache_wback_inv
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|end
comma
id|a
suffix:semicolon
id|a
op_assign
id|addr
op_amp
op_complement
(paren
id|sc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
id|end
op_assign
(paren
id|addr
op_plus
id|size
)paren
op_amp
op_complement
(paren
id|sc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|flush_dcache_line
c_func
(paren
id|a
)paren
suffix:semicolon
multiline_comment|/* Hit_Writeback_Inv_D */
id|flush_icache_line
c_func
(paren
id|a
)paren
suffix:semicolon
multiline_comment|/* Hit_Invalidate_I */
id|flush_scache_line
c_func
(paren
id|a
)paren
suffix:semicolon
multiline_comment|/* Hit_Writeback_Inv_SD */
r_if
c_cond
(paren
id|a
op_eq
id|end
)paren
r_break
suffix:semicolon
id|a
op_add_assign
id|sc_lsize
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|rm7k_tcache_enabled
)paren
r_return
suffix:semicolon
id|a
op_assign
id|addr
op_amp
op_complement
(paren
id|tc_pagesize
op_minus
l_int|1
)paren
suffix:semicolon
id|end
op_assign
(paren
id|addr
op_plus
id|size
)paren
op_amp
op_complement
(paren
id|tc_pagesize
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|invalidate_tcache_page
c_func
(paren
id|a
)paren
suffix:semicolon
multiline_comment|/* Page_Invalidate_T */
r_if
c_cond
(paren
id|a
op_eq
id|end
)paren
r_break
suffix:semicolon
id|a
op_add_assign
id|tc_pagesize
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|rm7k_dma_cache_inv
id|rm7k_dma_cache_inv
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|end
comma
id|a
suffix:semicolon
id|a
op_assign
id|addr
op_amp
op_complement
(paren
id|sc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
id|end
op_assign
(paren
id|addr
op_plus
id|size
)paren
op_amp
op_complement
(paren
id|sc_lsize
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|invalidate_dcache_line
c_func
(paren
id|a
)paren
suffix:semicolon
multiline_comment|/* Hit_Invalidate_D */
id|flush_icache_line
c_func
(paren
id|a
)paren
suffix:semicolon
multiline_comment|/* Hit_Invalidate_I */
id|invalidate_scache_line
c_func
(paren
id|a
)paren
suffix:semicolon
multiline_comment|/* Hit_Invalidate_SD */
r_if
c_cond
(paren
id|a
op_eq
id|end
)paren
r_break
suffix:semicolon
id|a
op_add_assign
id|sc_lsize
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|rm7k_tcache_enabled
)paren
r_return
suffix:semicolon
id|a
op_assign
id|addr
op_amp
op_complement
(paren
id|tc_pagesize
op_minus
l_int|1
)paren
suffix:semicolon
id|end
op_assign
(paren
id|addr
op_plus
id|size
)paren
op_amp
op_complement
(paren
id|tc_pagesize
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|invalidate_tcache_page
c_func
(paren
id|a
)paren
suffix:semicolon
multiline_comment|/* Page_Invalidate_T */
r_if
c_cond
(paren
id|a
op_eq
id|end
)paren
r_break
suffix:semicolon
id|a
op_add_assign
id|tc_pagesize
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|rm7k_dma_cache_wback
id|rm7k_dma_cache_wback
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|size
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;rm7k_dma_cache_wback called - should not happen.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * While we&squot;re protected against bad userland addresses we don&squot;t care&n; * very much about what happens in that case.  Usually a segmentation&n; * fault will dump the process later on anyway ...&n; */
DECL|function|rm7k_flush_cache_sigtramp
r_static
r_void
id|rm7k_flush_cache_sigtramp
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
id|protected_writeback_dcache_line
c_func
(paren
id|addr
op_amp
op_complement
(paren
id|dc_lsize
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|protected_flush_icache_line
c_func
(paren
id|addr
op_amp
op_complement
(paren
id|ic_lsize
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Undocumented RM7000:  Bit 29 in the info register of the RM7000 v2.0&n; * indicates if the TLB has 48 or 64 entries.&n; *&n; * 29      1 =&gt;    64 entry JTLB&n; *         0 =&gt;    48 entry JTLB&n; */
DECL|function|ntlb_entries
r_static
r_inline
r_int
id|__attribute__
c_func
(paren
(paren
r_const
)paren
)paren
id|ntlb_entries
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|get_info
c_func
(paren
)paren
op_amp
(paren
l_int|1
op_lshift
l_int|29
)paren
)paren
r_return
l_int|64
suffix:semicolon
r_return
l_int|48
suffix:semicolon
)brace
DECL|function|flush_tlb_all
r_void
id|flush_tlb_all
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|old_ctx
suffix:semicolon
r_int
id|entry
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Save old context and create impossible VPN2 value */
id|old_ctx
op_assign
id|get_entryhi
c_func
(paren
)paren
op_amp
l_int|0xff
suffix:semicolon
id|set_entryhi
c_func
(paren
id|KSEG0
)paren
suffix:semicolon
id|set_entrylo0
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|set_entrylo1
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|entry
op_assign
id|get_wired
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Blast &squot;em all away. */
r_while
c_loop
(paren
id|entry
OL
id|ntlb_entries
c_func
(paren
)paren
)paren
(brace
id|set_index
c_func
(paren
id|entry
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|tlb_write_indexed
c_func
(paren
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|entry
op_increment
suffix:semicolon
)brace
id|BARRIER
suffix:semicolon
id|set_entryhi
c_func
(paren
id|old_ctx
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|flush_tlb_mm
r_void
id|flush_tlb_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
r_if
c_cond
(paren
id|mm-&gt;context
op_ne
l_int|0
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|get_new_mmu_context
c_func
(paren
id|mm
comma
id|asid_cache
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mm
op_eq
id|current-&gt;mm
)paren
id|set_entryhi
c_func
(paren
id|mm-&gt;context
op_amp
l_int|0xff
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|flush_tlb_range
r_void
id|flush_tlb_range
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
r_if
c_cond
(paren
id|mm-&gt;context
op_ne
l_int|0
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|size
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|size
op_assign
(paren
id|end
op_minus
id|start
op_plus
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|size
op_assign
(paren
id|size
op_plus
l_int|1
)paren
op_rshift
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|size
op_le
(paren
id|ntlb_entries
c_func
(paren
)paren
op_div
l_int|2
)paren
)paren
(brace
r_int
id|oldpid
op_assign
(paren
id|get_entryhi
c_func
(paren
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
r_int
id|newpid
op_assign
(paren
id|mm-&gt;context
op_amp
l_int|0xff
)paren
suffix:semicolon
id|start
op_and_assign
(paren
id|PAGE_MASK
op_lshift
l_int|1
)paren
suffix:semicolon
id|end
op_add_assign
(paren
(paren
id|PAGE_SIZE
op_lshift
l_int|1
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|end
op_and_assign
(paren
id|PAGE_MASK
op_lshift
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
r_int
id|idx
suffix:semicolon
id|set_entryhi
c_func
(paren
id|start
op_or
id|newpid
)paren
suffix:semicolon
id|start
op_add_assign
(paren
id|PAGE_SIZE
op_lshift
l_int|1
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|tlb_probe
c_func
(paren
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|idx
op_assign
id|get_index
c_func
(paren
)paren
suffix:semicolon
id|set_entrylo0
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|set_entrylo1
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|set_entryhi
c_func
(paren
id|KSEG0
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
r_if
c_cond
(paren
id|idx
OL
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
id|tlb_write_indexed
c_func
(paren
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
)brace
id|set_entryhi
c_func
(paren
id|oldpid
)paren
suffix:semicolon
)brace
r_else
(brace
id|get_new_mmu_context
c_func
(paren
id|mm
comma
id|asid_cache
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mm
op_eq
id|current-&gt;mm
)paren
(brace
id|set_entryhi
c_func
(paren
id|mm-&gt;context
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
)brace
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|flush_tlb_page
r_void
id|flush_tlb_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|page
)paren
(brace
r_if
c_cond
(paren
id|vma-&gt;vm_mm-&gt;context
op_ne
l_int|0
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|oldpid
comma
id|newpid
comma
id|idx
suffix:semicolon
id|newpid
op_assign
(paren
id|vma-&gt;vm_mm-&gt;context
op_amp
l_int|0xff
)paren
suffix:semicolon
id|page
op_and_assign
(paren
id|PAGE_MASK
op_lshift
l_int|1
)paren
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|oldpid
op_assign
(paren
id|get_entryhi
c_func
(paren
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|set_entryhi
c_func
(paren
id|page
op_or
id|newpid
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|tlb_probe
c_func
(paren
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|idx
op_assign
id|get_index
c_func
(paren
)paren
suffix:semicolon
id|set_entrylo0
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|set_entrylo1
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|set_entryhi
c_func
(paren
id|KSEG0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idx
OL
l_int|0
)paren
(brace
r_goto
id|finish
suffix:semicolon
)brace
id|BARRIER
suffix:semicolon
id|tlb_write_indexed
c_func
(paren
)paren
suffix:semicolon
id|finish
suffix:colon
id|BARRIER
suffix:semicolon
id|set_entryhi
c_func
(paren
id|oldpid
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|pgd_init
r_void
id|pgd_init
c_func
(paren
r_int
r_int
id|page
)paren
(brace
r_int
r_int
op_star
id|p
op_assign
(paren
r_int
r_int
op_star
)paren
id|page
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|USER_PTRS_PER_PGD
suffix:semicolon
id|i
op_add_assign
l_int|8
)paren
(brace
id|p
(braket
id|i
op_plus
l_int|0
)braket
op_assign
(paren
r_int
r_int
)paren
id|invalid_pte_table
suffix:semicolon
id|p
(braket
id|i
op_plus
l_int|1
)braket
op_assign
(paren
r_int
r_int
)paren
id|invalid_pte_table
suffix:semicolon
id|p
(braket
id|i
op_plus
l_int|2
)braket
op_assign
(paren
r_int
r_int
)paren
id|invalid_pte_table
suffix:semicolon
id|p
(braket
id|i
op_plus
l_int|3
)braket
op_assign
(paren
r_int
r_int
)paren
id|invalid_pte_table
suffix:semicolon
id|p
(braket
id|i
op_plus
l_int|4
)braket
op_assign
(paren
r_int
r_int
)paren
id|invalid_pte_table
suffix:semicolon
id|p
(braket
id|i
op_plus
l_int|5
)braket
op_assign
(paren
r_int
r_int
)paren
id|invalid_pte_table
suffix:semicolon
id|p
(braket
id|i
op_plus
l_int|6
)braket
op_assign
(paren
r_int
r_int
)paren
id|invalid_pte_table
suffix:semicolon
id|p
(braket
id|i
op_plus
l_int|7
)braket
op_assign
(paren
r_int
r_int
)paren
id|invalid_pte_table
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * We will need multiple versions of update_mmu_cache(), one that just&n; * updates the TLB with the new pte(s), and another which also checks&n; * for the R4k &quot;end of page&quot; hardware bug and does the needy.&n; */
DECL|function|update_mmu_cache
r_void
id|update_mmu_cache
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|address
comma
id|pte_t
id|pte
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|pgd_t
op_star
id|pgdp
suffix:semicolon
id|pmd_t
op_star
id|pmdp
suffix:semicolon
id|pte_t
op_star
id|ptep
suffix:semicolon
r_int
id|idx
comma
id|pid
suffix:semicolon
multiline_comment|/*&n;&t; * Handle debugger faulting in for debugee.&n;&t; */
r_if
c_cond
(paren
id|current-&gt;active_mm
op_ne
id|vma-&gt;vm_mm
)paren
r_return
suffix:semicolon
id|pid
op_assign
id|get_entryhi
c_func
(paren
)paren
op_amp
l_int|0xff
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|address
op_and_assign
(paren
id|PAGE_MASK
op_lshift
l_int|1
)paren
suffix:semicolon
id|set_entryhi
c_func
(paren
id|address
op_or
(paren
id|pid
)paren
)paren
suffix:semicolon
id|pgdp
op_assign
id|pgd_offset
c_func
(paren
id|vma-&gt;vm_mm
comma
id|address
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|tlb_probe
c_func
(paren
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|pmdp
op_assign
id|pmd_offset
c_func
(paren
id|pgdp
comma
id|address
)paren
suffix:semicolon
id|idx
op_assign
id|get_index
c_func
(paren
)paren
suffix:semicolon
id|ptep
op_assign
id|pte_offset
c_func
(paren
id|pmdp
comma
id|address
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|set_entrylo0
c_func
(paren
id|pte_val
c_func
(paren
op_star
id|ptep
op_increment
)paren
op_rshift
l_int|6
)paren
suffix:semicolon
id|set_entrylo1
c_func
(paren
id|pte_val
c_func
(paren
op_star
id|ptep
)paren
op_rshift
l_int|6
)paren
suffix:semicolon
id|set_entryhi
c_func
(paren
id|address
op_or
(paren
id|pid
)paren
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
r_if
c_cond
(paren
id|idx
OL
l_int|0
)paren
(brace
id|tlb_write_random
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|tlb_write_indexed
c_func
(paren
)paren
suffix:semicolon
)brace
id|BARRIER
suffix:semicolon
id|set_entryhi
c_func
(paren
id|pid
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|show_regs
r_void
id|show_regs
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
multiline_comment|/* Saved main processor registers. */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;$0 : %08lx %08lx %08lx %08lx&bslash;n&quot;
comma
l_int|0UL
comma
id|regs-&gt;regs
(braket
l_int|1
)braket
comma
id|regs-&gt;regs
(braket
l_int|2
)braket
comma
id|regs-&gt;regs
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;$4 : %08lx %08lx %08lx %08lx&bslash;n&quot;
comma
id|regs-&gt;regs
(braket
l_int|4
)braket
comma
id|regs-&gt;regs
(braket
l_int|5
)braket
comma
id|regs-&gt;regs
(braket
l_int|6
)braket
comma
id|regs-&gt;regs
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;$8 : %08lx %08lx %08lx %08lx&bslash;n&quot;
comma
id|regs-&gt;regs
(braket
l_int|8
)braket
comma
id|regs-&gt;regs
(braket
l_int|9
)braket
comma
id|regs-&gt;regs
(braket
l_int|10
)braket
comma
id|regs-&gt;regs
(braket
l_int|11
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;$12: %08lx %08lx %08lx %08lx&bslash;n&quot;
comma
id|regs-&gt;regs
(braket
l_int|12
)braket
comma
id|regs-&gt;regs
(braket
l_int|13
)braket
comma
id|regs-&gt;regs
(braket
l_int|14
)braket
comma
id|regs-&gt;regs
(braket
l_int|15
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;$16: %08lx %08lx %08lx %08lx&bslash;n&quot;
comma
id|regs-&gt;regs
(braket
l_int|16
)braket
comma
id|regs-&gt;regs
(braket
l_int|17
)braket
comma
id|regs-&gt;regs
(braket
l_int|18
)braket
comma
id|regs-&gt;regs
(braket
l_int|19
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;$20: %08lx %08lx %08lx %08lx&bslash;n&quot;
comma
id|regs-&gt;regs
(braket
l_int|20
)braket
comma
id|regs-&gt;regs
(braket
l_int|21
)braket
comma
id|regs-&gt;regs
(braket
l_int|22
)braket
comma
id|regs-&gt;regs
(braket
l_int|23
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;$24: %08lx %08lx&bslash;n&quot;
comma
id|regs-&gt;regs
(braket
l_int|24
)braket
comma
id|regs-&gt;regs
(braket
l_int|25
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;$28: %08lx %08lx %08lx %08lx&bslash;n&quot;
comma
id|regs-&gt;regs
(braket
l_int|28
)braket
comma
id|regs-&gt;regs
(braket
l_int|29
)braket
comma
id|regs-&gt;regs
(braket
l_int|30
)braket
comma
id|regs-&gt;regs
(braket
l_int|31
)braket
)paren
suffix:semicolon
multiline_comment|/* Saved cp0 registers. */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;epc   : %08lx    %s&bslash;nStatus: %08lx&bslash;nCause : %08lx&bslash;n&quot;
comma
id|regs-&gt;cp0_epc
comma
id|print_tainted
c_func
(paren
)paren
comma
id|regs-&gt;cp0_status
comma
id|regs-&gt;cp0_cause
)paren
suffix:semicolon
)brace
DECL|function|add_wired_entry
r_void
id|add_wired_entry
c_func
(paren
r_int
r_int
id|entrylo0
comma
r_int
r_int
id|entrylo1
comma
r_int
r_int
id|entryhi
comma
r_int
r_int
id|pagemask
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|wired
suffix:semicolon
r_int
r_int
id|old_pagemask
suffix:semicolon
r_int
r_int
id|old_ctx
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Save old context and create impossible VPN2 value */
id|old_ctx
op_assign
(paren
id|get_entryhi
c_func
(paren
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|old_pagemask
op_assign
id|get_pagemask
c_func
(paren
)paren
suffix:semicolon
id|wired
op_assign
id|get_wired
c_func
(paren
)paren
suffix:semicolon
id|set_wired
(paren
id|wired
op_plus
l_int|1
)paren
suffix:semicolon
id|set_index
(paren
id|wired
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|set_pagemask
(paren
id|pagemask
)paren
suffix:semicolon
id|set_entryhi
c_func
(paren
id|entryhi
)paren
suffix:semicolon
id|set_entrylo0
c_func
(paren
id|entrylo0
)paren
suffix:semicolon
id|set_entrylo1
c_func
(paren
id|entrylo1
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|tlb_write_indexed
c_func
(paren
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|set_entryhi
c_func
(paren
id|old_ctx
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|set_pagemask
(paren
id|old_pagemask
)paren
suffix:semicolon
id|flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Used for loading TLB entries before trap_init() has started, when we&n;   don&squot;t actually want to add a wired entry which remains throughout the&n;   lifetime of the system */
DECL|variable|__initdata
r_static
r_int
id|temp_tlb_entry
id|__initdata
suffix:semicolon
DECL|function|add_temporary_entry
id|__init
r_int
id|add_temporary_entry
c_func
(paren
r_int
r_int
id|entrylo0
comma
r_int
r_int
id|entrylo1
comma
r_int
r_int
id|entryhi
comma
r_int
r_int
id|pagemask
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|wired
suffix:semicolon
r_int
r_int
id|old_pagemask
suffix:semicolon
r_int
r_int
id|old_ctx
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Save old context and create impossible VPN2 value */
id|old_ctx
op_assign
(paren
id|get_entryhi
c_func
(paren
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|old_pagemask
op_assign
id|get_pagemask
c_func
(paren
)paren
suffix:semicolon
id|wired
op_assign
id|get_wired
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|temp_tlb_entry
OL
id|wired
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;No TLB space left for add_temporary_entry&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOSPC
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|set_index
(paren
id|temp_tlb_entry
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|set_pagemask
(paren
id|pagemask
)paren
suffix:semicolon
id|set_entryhi
c_func
(paren
id|entryhi
)paren
suffix:semicolon
id|set_entrylo0
c_func
(paren
id|entrylo0
)paren
suffix:semicolon
id|set_entrylo1
c_func
(paren
id|entrylo1
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|tlb_write_indexed
c_func
(paren
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|set_entryhi
c_func
(paren
id|old_ctx
)paren
suffix:semicolon
id|BARRIER
suffix:semicolon
id|set_pagemask
(paren
id|old_pagemask
)paren
suffix:semicolon
id|out
suffix:colon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Detect and size the caches. */
DECL|function|probe_icache
r_static
r_inline
r_void
id|probe_icache
c_func
(paren
r_int
r_int
id|config
)paren
(brace
id|icache_size
op_assign
l_int|1
op_lshift
(paren
l_int|12
op_plus
(paren
(paren
id|config
op_rshift
l_int|9
)paren
op_amp
l_int|7
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Primary instruction cache %dKiB.&bslash;n&quot;
comma
id|icache_size
op_rshift
l_int|10
)paren
suffix:semicolon
)brace
DECL|function|probe_dcache
r_static
r_inline
r_void
id|probe_dcache
c_func
(paren
r_int
r_int
id|config
)paren
(brace
id|dcache_size
op_assign
l_int|1
op_lshift
(paren
l_int|12
op_plus
(paren
(paren
id|config
op_rshift
l_int|6
)paren
op_amp
l_int|7
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Primary data cache %dKiB.&bslash;n&quot;
comma
id|dcache_size
op_rshift
l_int|10
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * This function is executed in the uncached segment KSEG1.&n; * It must not touch the stack, because the stack pointer still points&n; * into KSEG0. &n; *&n; * Three options:&n; *&t;- Write it in assembly and guarantee that we don&squot;t use the stack.&n; *&t;- Disable caching for KSEG0 before calling it.&n; *&t;- Pray that GCC doesn&squot;t randomly start using the stack.&n; *&n; * This being Linux, we obviously take the least sane of those options -&n; * following DaveM&squot;s lead in r4xx0.c&n; *&n; * It seems we get our kicks from relying on unguaranteed behaviour in GCC&n; */
DECL|function|setup_scache
r_static
id|__init
r_void
id|setup_scache
c_func
(paren
r_void
)paren
(brace
r_int
r_register
id|i
suffix:semicolon
id|set_cp0_config
c_func
(paren
l_int|1
op_lshift
l_int|3
multiline_comment|/* CONF_SE */
)paren
suffix:semicolon
id|set_taglo
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|set_taghi
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|scache_size
suffix:semicolon
id|i
op_add_assign
id|sc_lsize
)paren
(brace
id|__asm__
id|__volatile__
(paren
l_string|&quot;.set noreorder&bslash;n&bslash;t&quot;
l_string|&quot;.set mips3&bslash;n&bslash;t&quot;
l_string|&quot;cache %1, (%0)&bslash;n&bslash;t&quot;
l_string|&quot;.set mips0&bslash;n&bslash;t&quot;
l_string|&quot;.set reorder&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|KSEG0ADDR
c_func
(paren
id|i
)paren
)paren
comma
l_string|&quot;i&quot;
(paren
id|Index_Store_Tag_SD
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|probe_scache
r_static
r_inline
r_void
id|probe_scache
c_func
(paren
r_int
r_int
id|config
)paren
(brace
r_void
(paren
op_star
id|func
)paren
(paren
r_void
)paren
op_assign
id|KSEG1ADDR
c_func
(paren
op_amp
id|setup_scache
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|config
op_rshift
l_int|31
)paren
op_amp
l_int|1
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Secondary cache %dKiB, linesize %d bytes.&bslash;n&quot;
comma
(paren
id|scache_size
op_rshift
l_int|10
)paren
comma
id|sc_lsize
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|config
op_rshift
l_int|3
)paren
op_amp
l_int|1
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Enabling secondary cache...&quot;
)paren
suffix:semicolon
id|func
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Done&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|probe_tcache
r_static
r_inline
r_void
id|probe_tcache
c_func
(paren
r_int
r_int
id|config
)paren
(brace
r_if
c_cond
(paren
(paren
id|config
op_rshift
l_int|17
)paren
op_amp
l_int|1
)paren
r_return
suffix:semicolon
multiline_comment|/* We can&squot;t enable the L3 cache yet. There may be board-specific&n;&t; * magic necessary to turn it on, and blindly asking the CPU to&n;&t; * start using it would may give cache errors.&n;&t; *&n;&t; * Also, board-specific knowledge may allow us to use the &n;&t; * CACHE Flash_Invalidate_T instruction if the tag RAM supports&n;&t; * it, and may specify the size of the L3 cache so we don&squot;t have&n;&t; * to probe it. &n;&t; */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Tertiary cache present, %s enabled&bslash;n&quot;
comma
id|config
op_amp
(paren
l_int|1
op_lshift
l_int|12
)paren
ques
c_cond
l_string|&quot;already&quot;
suffix:colon
l_string|&quot;not (yet)&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|config
op_rshift
l_int|12
)paren
op_amp
l_int|1
)paren
id|rm7k_tcache_enabled
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|ld_mmu_rm7k
r_void
id|__init
id|ld_mmu_rm7k
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|config
op_assign
id|read_32bit_cp0_register
c_func
(paren
id|CP0_CONFIG
)paren
suffix:semicolon
r_int
r_int
id|addr
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;CPU revision is: %08x&bslash;n&quot;
comma
id|read_32bit_cp0_register
c_func
(paren
id|CP0_PRID
)paren
)paren
suffix:semicolon
id|change_cp0_config
c_func
(paren
id|CONF_CM_CMASK
comma
id|CONF_CM_UNCACHED
)paren
suffix:semicolon
multiline_comment|/* RM7000 erratum #31. The icache is screwed at startup. */
id|set_taglo
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|set_taghi
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|addr
op_assign
id|KSEG0
suffix:semicolon
id|addr
op_le
id|KSEG0
op_plus
l_int|4096
suffix:semicolon
id|addr
op_add_assign
id|ic_lsize
)paren
(brace
id|__asm__
id|__volatile__
(paren
l_string|&quot;.set noreorder&bslash;n&bslash;t&quot;
l_string|&quot;.set mips3&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%1, 0(%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%1, 0x1000(%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%1, 0x2000(%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%1, 0x3000(%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%2, 0(%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%2, 0x1000(%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%2, 0x2000(%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%2, 0x3000(%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%1, 0(%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%1, 0x1000(%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%1, 0x2000(%0)&bslash;n&bslash;t&quot;
l_string|&quot;cache&bslash;t%1, 0x3000(%0)&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;tmips0&bslash;n&bslash;t&quot;
l_string|&quot;.set&bslash;treorder&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|addr
)paren
comma
l_string|&quot;i&quot;
(paren
id|Index_Store_Tag_I
)paren
comma
l_string|&quot;i&quot;
(paren
id|Fill
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifndef CONFIG_MIPS_UNCACHED
id|change_cp0_config
c_func
(paren
id|CONF_CM_CMASK
comma
id|CONF_CM_CACHABLE_NONCOHERENT
)paren
suffix:semicolon
macro_line|#endif
id|probe_icache
c_func
(paren
id|config
)paren
suffix:semicolon
id|probe_dcache
c_func
(paren
id|config
)paren
suffix:semicolon
id|probe_scache
c_func
(paren
id|config
)paren
suffix:semicolon
id|probe_tcache
c_func
(paren
id|config
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLB has %d entries.&bslash;n&quot;
comma
id|ntlb_entries
c_func
(paren
)paren
)paren
suffix:semicolon
id|_clear_page
op_assign
id|rm7k_clear_page
suffix:semicolon
id|_copy_page
op_assign
id|rm7k_copy_page
suffix:semicolon
id|_flush_cache_all
op_assign
id|rm7k_flush_cache_all_d32i32
suffix:semicolon
id|___flush_cache_all
op_assign
id|__flush_cache_all_d32i32
suffix:semicolon
id|_flush_cache_mm
op_assign
id|rm7k_flush_cache_mm_d32i32
suffix:semicolon
id|_flush_cache_range
op_assign
id|rm7k_flush_cache_range_d32i32
suffix:semicolon
id|_flush_cache_page
op_assign
id|rm7k_flush_cache_page_d32i32
suffix:semicolon
id|_flush_page_to_ram
op_assign
id|rm7k_flush_page_to_ram_d32i32
suffix:semicolon
id|_flush_cache_sigtramp
op_assign
id|rm7k_flush_cache_sigtramp
suffix:semicolon
id|_flush_icache_range
op_assign
id|rm7k_flush_icache_range
suffix:semicolon
id|_flush_icache_page
op_assign
id|rm7k_flush_icache_page
suffix:semicolon
id|_dma_cache_wback_inv
op_assign
id|rm7k_dma_cache_wback_inv
suffix:semicolon
id|_dma_cache_wback
op_assign
id|rm7k_dma_cache_wback
suffix:semicolon
id|_dma_cache_inv
op_assign
id|rm7k_dma_cache_inv
suffix:semicolon
id|__flush_cache_all_d32i32
c_func
(paren
)paren
suffix:semicolon
id|write_32bit_cp0_register
c_func
(paren
id|CP0_WIRED
comma
l_int|0
)paren
suffix:semicolon
id|temp_tlb_entry
op_assign
id|ntlb_entries
c_func
(paren
)paren
op_minus
l_int|1
suffix:semicolon
id|write_32bit_cp0_register
c_func
(paren
id|CP0_PAGEMASK
comma
id|PM_4K
)paren
suffix:semicolon
id|flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
)brace
eof
