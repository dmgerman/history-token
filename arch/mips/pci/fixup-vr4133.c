multiline_comment|/*&n; * arch/mips/vr41xx/nec-cmbvr4133/pci_fixup.c&n; *&n; * The NEC CMB-VR4133 Board specific PCI fixups.&n; *&n; * Author: Yoichi Yuasa &lt;yyuasa@mvista.com, or source@mvista.com&gt; and&n; *         Alex Sapkov &lt;asapkov@ru.mvista.com&gt;&n; *&n; * 2003-2004 (c) MontaVista, Software, Inc. This file is licensed under&n; * the terms of the GNU General Public License version 2. This program&n; * is licensed &quot;as is&quot; without any warranty of any kind, whether express&n; * or implied.&n; *&n; * Modified for support in 2.6&n; * Author: Manish Lachwani (mlachwani@mvista.com)&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/vr41xx/cmbvr4133.h&gt;
r_extern
r_int
id|vr4133_rockhopper
suffix:semicolon
r_extern
r_void
id|ali_m1535plus_init
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
suffix:semicolon
r_extern
r_void
id|ali_m5229_init
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* Do platform specific device initialization at pci_enable_device() time */
DECL|function|pcibios_plat_dev_init
r_int
id|pcibios_plat_dev_init
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
multiline_comment|/*&n;&t; * We have to reset AMD PCnet adapter on Rockhopper since&n;&t; * PMON leaves it enabled and generating interrupts. This leads&n;&t; * to a lock if some PCI device driver later enables the IRQ line&n;&t; * shared with PCnet and there is no AMD PCnet driver to catch its&n;&t; * interrupts.&n;&t; */
macro_line|#ifdef CONFIG_ROCKHOPPER
r_if
c_cond
(paren
id|dev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_AMD
op_logical_and
id|dev-&gt;device
op_eq
id|PCI_DEVICE_ID_AMD_LANCE
)paren
(brace
id|inl
c_func
(paren
id|pci_resource_start
c_func
(paren
id|dev
comma
l_int|0
)paren
op_plus
l_int|0x18
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t; * we have to open the bridges&squot; windows down to 0 because otherwise&n; &t; * we cannot access ISA south bridge I/O registers that get mapped from&n;&t; * 0. for example, 8259 PIC would be unaccessible without that&n;&t; */
r_if
c_cond
(paren
id|dev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_INTEL
op_logical_and
id|dev-&gt;device
op_eq
id|PCI_DEVICE_ID_INTEL_S21152BB
)paren
(brace
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|PCI_IO_BASE
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;bus-&gt;number
op_eq
l_int|0
)paren
(brace
id|pci_write_config_word
c_func
(paren
id|dev
comma
id|PCI_IO_BASE_UPPER16
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|pci_write_config_word
c_func
(paren
id|dev
comma
id|PCI_IO_BASE_UPPER16
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * M1535 IRQ mapping&n; * Feel free to change this, although it shouldn&squot;t be needed&n; */
DECL|macro|M1535_IRQ_INTA
mdefine_line|#define M1535_IRQ_INTA  7
DECL|macro|M1535_IRQ_INTB
mdefine_line|#define M1535_IRQ_INTB  9
DECL|macro|M1535_IRQ_INTC
mdefine_line|#define M1535_IRQ_INTC  10
DECL|macro|M1535_IRQ_INTD
mdefine_line|#define M1535_IRQ_INTD  11
DECL|macro|M1535_IRQ_USB
mdefine_line|#define M1535_IRQ_USB   9
DECL|macro|M1535_IRQ_IDE
mdefine_line|#define M1535_IRQ_IDE   14
DECL|macro|M1535_IRQ_IDE2
mdefine_line|#define M1535_IRQ_IDE2  15
DECL|macro|M1535_IRQ_PS2
mdefine_line|#define M1535_IRQ_PS2   12
DECL|macro|M1535_IRQ_RTC
mdefine_line|#define M1535_IRQ_RTC   8
DECL|macro|M1535_IRQ_FDC
mdefine_line|#define M1535_IRQ_FDC   6
DECL|macro|M1535_IRQ_AUDIO
mdefine_line|#define M1535_IRQ_AUDIO 5
DECL|macro|M1535_IRQ_COM1
mdefine_line|#define M1535_IRQ_COM1  4
DECL|macro|M1535_IRQ_COM2
mdefine_line|#define M1535_IRQ_COM2  4
DECL|macro|M1535_IRQ_IRDA
mdefine_line|#define M1535_IRQ_IRDA  3
DECL|macro|M1535_IRQ_KBD
mdefine_line|#define M1535_IRQ_KBD   1
DECL|macro|M1535_IRQ_TMR
mdefine_line|#define M1535_IRQ_TMR   0
multiline_comment|/* Rockhopper &quot;slots&quot; assignment; this is hard-coded ... */
DECL|macro|ROCKHOPPER_M5451_SLOT
mdefine_line|#define ROCKHOPPER_M5451_SLOT  1
DECL|macro|ROCKHOPPER_M1535_SLOT
mdefine_line|#define ROCKHOPPER_M1535_SLOT  2
DECL|macro|ROCKHOPPER_M5229_SLOT
mdefine_line|#define ROCKHOPPER_M5229_SLOT  11
DECL|macro|ROCKHOPPER_M5237_SLOT
mdefine_line|#define ROCKHOPPER_M5237_SLOT  15
DECL|macro|ROCKHOPPER_PMU_SLOT
mdefine_line|#define ROCKHOPPER_PMU_SLOT    12
multiline_comment|/* ... and hard-wired. */
DECL|macro|ROCKHOPPER_PCI1_SLOT
mdefine_line|#define ROCKHOPPER_PCI1_SLOT   3
DECL|macro|ROCKHOPPER_PCI2_SLOT
mdefine_line|#define ROCKHOPPER_PCI2_SLOT   4
DECL|macro|ROCKHOPPER_PCI3_SLOT
mdefine_line|#define ROCKHOPPER_PCI3_SLOT   5
DECL|macro|ROCKHOPPER_PCI4_SLOT
mdefine_line|#define ROCKHOPPER_PCI4_SLOT   6
DECL|macro|ROCKHOPPER_PCNET_SLOT
mdefine_line|#define ROCKHOPPER_PCNET_SLOT  1
DECL|macro|M1535_IRQ_MASK
mdefine_line|#define M1535_IRQ_MASK(n) (1 &lt;&lt; (n))
DECL|macro|M1535_IRQ_EDGE
mdefine_line|#define M1535_IRQ_EDGE  (M1535_IRQ_MASK(M1535_IRQ_TMR)  | &bslash;&n;                         M1535_IRQ_MASK(M1535_IRQ_KBD)  | &bslash;&n;                         M1535_IRQ_MASK(M1535_IRQ_COM1) | &bslash;&n;                         M1535_IRQ_MASK(M1535_IRQ_COM2) | &bslash;&n;                         M1535_IRQ_MASK(M1535_IRQ_IRDA) | &bslash;&n;                         M1535_IRQ_MASK(M1535_IRQ_RTC)  | &bslash;&n;                         M1535_IRQ_MASK(M1535_IRQ_FDC)  | &bslash;&n;                         M1535_IRQ_MASK(M1535_IRQ_PS2))
DECL|macro|M1535_IRQ_LEVEL
mdefine_line|#define M1535_IRQ_LEVEL (M1535_IRQ_MASK(M1535_IRQ_IDE)  | &bslash;&n;                         M1535_IRQ_MASK(M1535_IRQ_USB)  | &bslash;&n;                         M1535_IRQ_MASK(M1535_IRQ_INTA) | &bslash;&n;                         M1535_IRQ_MASK(M1535_IRQ_INTB) | &bslash;&n;                         M1535_IRQ_MASK(M1535_IRQ_INTC) | &bslash;&n;                         M1535_IRQ_MASK(M1535_IRQ_INTD))
DECL|struct|irq_map_entry
r_struct
id|irq_map_entry
(brace
DECL|member|bus
id|u16
id|bus
suffix:semicolon
DECL|member|slot
id|u8
id|slot
suffix:semicolon
DECL|member|irq
id|u8
id|irq
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|int_map
r_static
r_struct
id|irq_map_entry
id|int_map
(braket
)braket
op_assign
(brace
(brace
l_int|1
comma
id|ROCKHOPPER_M5451_SLOT
comma
id|M1535_IRQ_AUDIO
)brace
comma
multiline_comment|/* Audio controller */
(brace
l_int|1
comma
id|ROCKHOPPER_PCI1_SLOT
comma
id|M1535_IRQ_INTD
)brace
comma
multiline_comment|/* PCI slot #1 */
(brace
l_int|1
comma
id|ROCKHOPPER_PCI2_SLOT
comma
id|M1535_IRQ_INTC
)brace
comma
multiline_comment|/* PCI slot #2 */
(brace
l_int|1
comma
id|ROCKHOPPER_M5237_SLOT
comma
id|M1535_IRQ_USB
)brace
comma
multiline_comment|/* USB host controller */
(brace
l_int|1
comma
id|ROCKHOPPER_M5229_SLOT
comma
id|IDE_PRIMARY_IRQ
)brace
comma
multiline_comment|/* IDE controller */
(brace
l_int|2
comma
id|ROCKHOPPER_PCNET_SLOT
comma
id|M1535_IRQ_INTD
)brace
comma
multiline_comment|/* AMD Am79c973 on-board&n;&t;&t;&t;&t;&t;&t;&t;   ethernet */
(brace
l_int|2
comma
id|ROCKHOPPER_PCI3_SLOT
comma
id|M1535_IRQ_INTB
)brace
comma
multiline_comment|/* PCI slot #3 */
(brace
l_int|2
comma
id|ROCKHOPPER_PCI4_SLOT
comma
id|M1535_IRQ_INTC
)brace
multiline_comment|/* PCI slot #4 */
)brace
suffix:semicolon
DECL|variable|pci_intlines
r_static
r_int
id|pci_intlines
(braket
)braket
op_assign
(brace
id|M1535_IRQ_INTA
comma
id|M1535_IRQ_INTB
comma
id|M1535_IRQ_INTC
comma
id|M1535_IRQ_INTD
)brace
suffix:semicolon
multiline_comment|/* Determine the Rockhopper IRQ line number for the PCI device */
DECL|function|rockhopper_get_irq
r_int
id|rockhopper_get_irq
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
id|u8
id|pin
comma
id|u8
id|slot
)paren
(brace
r_struct
id|pci_bus
op_star
id|bus
suffix:semicolon
r_int
id|i
suffix:semicolon
id|bus
op_assign
id|dev-&gt;bus
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|int_map
)paren
op_div
r_sizeof
(paren
id|int_map
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|int_map
(braket
id|i
)braket
dot
id|bus
op_eq
id|bus-&gt;number
op_logical_and
id|int_map
(braket
id|i
)braket
dot
id|slot
op_eq
id|slot
)paren
(brace
r_int
id|line
suffix:semicolon
r_for
c_loop
(paren
id|line
op_assign
l_int|0
suffix:semicolon
id|line
OL
l_int|4
suffix:semicolon
id|line
op_increment
)paren
r_if
c_cond
(paren
id|pci_intlines
(braket
id|line
)braket
op_eq
id|int_map
(braket
id|i
)braket
dot
id|irq
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|line
OL
l_int|4
)paren
r_return
id|pci_intlines
(braket
(paren
id|line
op_plus
(paren
id|pin
op_minus
l_int|1
)paren
)paren
op_mod
l_int|4
)braket
suffix:semicolon
r_else
r_return
id|int_map
(braket
id|i
)braket
dot
id|irq
suffix:semicolon
)brace
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ROCKHOPPER
DECL|function|i8259_init
r_void
id|i8259_init
c_func
(paren
r_void
)paren
(brace
id|outb
c_func
(paren
l_int|0x11
comma
l_int|0x20
)paren
suffix:semicolon
multiline_comment|/* Master ICW1 */
id|outb
c_func
(paren
id|I8259_IRQ_BASE
comma
l_int|0x21
)paren
suffix:semicolon
multiline_comment|/* Master ICW2 */
id|outb
c_func
(paren
l_int|0x04
comma
l_int|0x21
)paren
suffix:semicolon
multiline_comment|/* Master ICW3 */
id|outb
c_func
(paren
l_int|0x01
comma
l_int|0x21
)paren
suffix:semicolon
multiline_comment|/* Master ICW4 */
id|outb
c_func
(paren
l_int|0xff
comma
l_int|0x21
)paren
suffix:semicolon
multiline_comment|/* Master IMW */
id|outb
c_func
(paren
l_int|0x11
comma
l_int|0xa0
)paren
suffix:semicolon
multiline_comment|/* Slave ICW1 */
id|outb
c_func
(paren
id|I8259_IRQ_BASE
op_plus
l_int|8
comma
l_int|0xa1
)paren
suffix:semicolon
multiline_comment|/* Slave ICW2 */
id|outb
c_func
(paren
l_int|0x02
comma
l_int|0xa1
)paren
suffix:semicolon
multiline_comment|/* Slave ICW3 */
id|outb
c_func
(paren
l_int|0x01
comma
l_int|0xa1
)paren
suffix:semicolon
multiline_comment|/* Slave ICW4 */
id|outb
c_func
(paren
l_int|0xff
comma
l_int|0xa1
)paren
suffix:semicolon
multiline_comment|/* Slave IMW */
id|outb
c_func
(paren
l_int|0x00
comma
l_int|0x4d0
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x02
comma
l_int|0x4d1
)paren
suffix:semicolon
multiline_comment|/* USB IRQ9 is level */
)brace
macro_line|#endif
DECL|function|pcibios_map_irq
r_int
id|__init
id|pcibios_map_irq
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
id|u8
id|slot
comma
id|u8
id|pin
)paren
(brace
r_extern
r_int
id|pci_probe_only
suffix:semicolon
id|pci_probe_only
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef CONFIG_ROCKHOPPER
r_if
c_cond
(paren
id|dev-&gt;bus-&gt;number
op_eq
l_int|1
op_logical_and
id|vr4133_rockhopper
)paren
(brace
r_if
c_cond
(paren
id|slot
op_eq
id|ROCKHOPPER_PCI1_SLOT
op_logical_or
id|slot
op_eq
id|ROCKHOPPER_PCI2_SLOT
)paren
(brace
id|dev-&gt;irq
op_assign
id|CMBVR41XX_INTA_IRQ
suffix:semicolon
)brace
r_else
id|dev-&gt;irq
op_assign
id|rockhopper_get_irq
c_func
(paren
id|dev
comma
id|pin
comma
id|slot
)paren
suffix:semicolon
)brace
r_else
id|dev-&gt;irq
op_assign
id|CMBVR41XX_INTA_IRQ
suffix:semicolon
macro_line|#else
id|dev-&gt;irq
op_assign
id|CMBVR41XX_INTA_IRQ
suffix:semicolon
macro_line|#endif
r_return
id|dev-&gt;irq
suffix:semicolon
)brace
id|DECLARE_PCI_FIXUP_HEADER
c_func
(paren
id|PCI_VENDOR_ID_AL
comma
id|PCI_DEVICE_ID_AL_M1533
comma
id|ali_m1535plus_init
)paren
suffix:semicolon
id|DECLARE_PCI_FIXUP_HEADER
c_func
(paren
id|PCI_VENDOR_ID_AL
comma
id|PCI_DEVICE_ID_AL_M5229
comma
id|ali_m5229_init
)paren
suffix:semicolon
eof
