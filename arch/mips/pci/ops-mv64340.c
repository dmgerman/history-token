multiline_comment|/*&n; * Copyright 2002 Momentum Computer&n; * Author: Matthew Dharm &lt;mdharm@momenco.com&gt;&n; *&n; * Copyright (C) 2003, 2004 Ralf Baechle (ralf@linux-mips.org)&n; *&n; *  This program is free software; you can redistribute  it and/or modify it&n; *  under  the terms of  the GNU General  Public License as published by the&n; *  Free Software Foundation;  either version 2 of the  License, or (at your&n; *  option) any later version.&n; *&n; *  THIS  SOFTWARE  IS PROVIDED   ``AS  IS&squot;&squot; AND   ANY  EXPRESS OR IMPLIED&n; *  WARRANTIES,   INCLUDING, BUT NOT  LIMITED  TO, THE IMPLIED WARRANTIES OF&n; *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN&n; *  NO  EVENT  SHALL   THE AUTHOR  BE    LIABLE FOR ANY   DIRECT, INDIRECT,&n; *  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT&n; *  NOT LIMITED   TO, PROCUREMENT OF  SUBSTITUTE GOODS  OR SERVICES; LOSS OF&n; *  USE, DATA,  OR PROFITS; OR  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON&n; *  ANY THEORY OF LIABILITY, WHETHER IN  CONTRACT, STRICT LIABILITY, OR TORT&n; *  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF&n; *  THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n; *&n; *  You should have received a copy of the  GNU General Public License along&n; *  with this program; if not, write  to the Free Software Foundation, Inc.,&n; *  675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/mv64340.h&gt;
multiline_comment|/*&n; * galileo_pcibios_(read/write)_config_(dword/word/byte) -&n; *&n; * reads/write a dword/word/byte register from the configuration space&n; * of a device.&n; *&n; * Note that bus 0 and bus 1 are local, and we assume all other busses are&n; * bridged from bus 1.  This is a safe assumption, since any other&n; * configuration will require major modifications to the CP7000G&n; *&n; * Inputs :&n; * bus - bus number&n; * dev - device number&n; * offset - register offset in the configuration space&n; * val - value to be written / read&n; *&n; * Outputs :&n; * PCIBIOS_SUCCESSFUL when operation was succesfull&n; * PCIBIOS_DEVICE_NOT_FOUND when the bus or dev is errorneous&n; * PCIBIOS_BAD_REGISTER_NUMBER when accessing non aligned&n; */
DECL|function|mv64340_read_config
r_static
r_int
id|mv64340_read_config
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|reg
comma
r_int
id|size
comma
id|u32
op_star
id|val
comma
id|u32
id|address_reg
comma
id|u32
id|data_reg
)paren
(brace
id|u32
id|address
suffix:semicolon
multiline_comment|/* Accessing device 31 crashes the MV-64340. */
r_if
c_cond
(paren
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
OG
l_int|5
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|address
op_assign
(paren
id|bus-&gt;number
op_lshift
l_int|16
)paren
op_or
(paren
id|devfn
op_lshift
l_int|8
)paren
op_or
(paren
id|reg
op_amp
l_int|0xfc
)paren
op_or
l_int|0x80000000
suffix:semicolon
multiline_comment|/* start the configuration cycle */
id|MV_WRITE
c_func
(paren
id|address_reg
comma
id|address
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
l_int|1
suffix:colon
op_star
id|val
op_assign
id|MV_READ_8
c_func
(paren
id|data_reg
op_plus
(paren
id|reg
op_amp
l_int|0x3
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
op_star
id|val
op_assign
id|MV_READ_16
c_func
(paren
id|data_reg
op_plus
(paren
id|reg
op_amp
l_int|0x3
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
op_star
id|val
op_assign
id|MV_READ
c_func
(paren
id|data_reg
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|mv64340_write_config
r_static
r_int
id|mv64340_write_config
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|reg
comma
r_int
id|size
comma
id|u32
id|val
comma
id|u32
id|address_reg
comma
id|u32
id|data_reg
)paren
(brace
id|u32
id|address
suffix:semicolon
multiline_comment|/* Accessing device 31 crashes the MV-64340. */
r_if
c_cond
(paren
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
OG
l_int|5
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|address
op_assign
(paren
id|bus-&gt;number
op_lshift
l_int|16
)paren
op_or
(paren
id|devfn
op_lshift
l_int|8
)paren
op_or
(paren
id|reg
op_amp
l_int|0xfc
)paren
op_or
l_int|0x80000000
suffix:semicolon
multiline_comment|/* start the configuration cycle */
id|MV_WRITE
c_func
(paren
id|address_reg
comma
id|address
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
l_int|1
suffix:colon
multiline_comment|/* write the data */
id|MV_WRITE_8
c_func
(paren
id|data_reg
op_plus
(paren
id|reg
op_amp
l_int|0x3
)paren
comma
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* write the data */
id|MV_WRITE_16
c_func
(paren
id|data_reg
op_plus
(paren
id|reg
op_amp
l_int|0x3
)paren
comma
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
multiline_comment|/* write the data */
id|MV_WRITE
c_func
(paren
id|data_reg
comma
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|macro|BUILD_PCI_OPS
mdefine_line|#define BUILD_PCI_OPS(host)&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static int mv64340_bus ## host ## _read_config(struct pci_bus *bus,&t;&bslash;&n;&t;unsigned int devfn, int reg, int size, u32 * val)&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return mv64340_read_config(bus, devfn, reg, size, val,&t;&t;&bslash;&n;&t;           MV64340_PCI_ ## host ## _CONFIG_ADDR,&t;&t;&bslash;&n;&t;           MV64340_PCI_ ## host ## _CONFIG_DATA_VIRTUAL_REG);&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static int mv64340_bus ## host ## _write_config(struct pci_bus *bus,&t;&bslash;&n;&t;unsigned int devfn, int reg, int size, u32 val)&t;&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return mv64340_write_config(bus, devfn, reg, size, val,&t;&t;&bslash;&n;&t;           MV64340_PCI_ ## host ## _CONFIG_ADDR,&t;&t;&bslash;&n;&t;           MV64340_PCI_ ## host ## _CONFIG_DATA_VIRTUAL_REG);&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;struct pci_ops mv64340_bus ## host ## _pci_ops = {&t;&t;&t;&bslash;&n;&t;.read&t;= mv64340_bus ## host ## _read_config,&t;&t;&t;&bslash;&n;&t;.write&t;= mv64340_bus ## host ## _write_config&t;&t;&t;&bslash;&n;};
id|BUILD_PCI_OPS
c_func
(paren
l_int|0
)paren
id|BUILD_PCI_OPS
c_func
(paren
l_int|1
)paren
eof
