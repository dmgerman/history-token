multiline_comment|/***********************************************************************&n; * Copyright 2001 MontaVista Software Inc.&n; * Author: Jun Sun, jsun@mvista.com or jsun@junsun.net&n; *&n; * arch/mips/ddb5xxx/ddb5477/pci_ops.c&n; *     Define the pci_ops for DB5477.&n; *&n; * Much of the code is derived from the original DDB5074 port by&n; * Geert Uytterhoeven &lt;geert@sonycom.com&gt;&n; *&n; * This program is free software; you can redistribute  it and/or modify it&n; * under  the terms of  the GNU General  Public License as published by the&n; * Free Software Foundation;  either version 2 of the  License, or (at your&n; * option) any later version.&n; ***********************************************************************&n; */
multiline_comment|/*&n; * DDB5477 has two PCI channels, external PCI and IOPIC (internal)&n; * Therefore we provide two sets of pci_ops.&n; */
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;asm/addrspace.h&gt;
macro_line|#include &lt;asm/debug.h&gt;
macro_line|#include &lt;asm/ddb5xxx/ddb5xxx.h&gt;
multiline_comment|/*&n; * config_swap structure records what set of pdar/pmr are used&n; * to access pci config space.  It also provides a place hold the&n; * original values for future restoring.&n; */
DECL|struct|pci_config_swap
r_struct
id|pci_config_swap
(brace
DECL|member|pdar
id|u32
id|pdar
suffix:semicolon
DECL|member|pmr
id|u32
id|pmr
suffix:semicolon
DECL|member|config_base
id|u32
id|config_base
suffix:semicolon
DECL|member|config_size
id|u32
id|config_size
suffix:semicolon
DECL|member|pdar_backup
id|u32
id|pdar_backup
suffix:semicolon
DECL|member|pmr_backup
id|u32
id|pmr_backup
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * On DDB5477, we have two sets of swap registers, for ext PCI and IOPCI.&n; */
DECL|variable|ext_pci_swap
r_struct
id|pci_config_swap
id|ext_pci_swap
op_assign
(brace
id|DDB_PCIW0
comma
id|DDB_PCIINIT00
comma
id|DDB_PCI0_CONFIG_BASE
comma
id|DDB_PCI0_CONFIG_SIZE
)brace
suffix:semicolon
DECL|variable|io_pci_swap
r_struct
id|pci_config_swap
id|io_pci_swap
op_assign
(brace
id|DDB_IOPCIW0
comma
id|DDB_PCIINIT01
comma
id|DDB_PCI1_CONFIG_BASE
comma
id|DDB_PCI1_CONFIG_SIZE
)brace
suffix:semicolon
multiline_comment|/*&n; * access config space&n; */
DECL|function|ddb_access_config_base
r_static
r_inline
id|u32
id|ddb_access_config_base
c_func
(paren
r_struct
id|pci_config_swap
op_star
id|swap
comma
id|u32
id|bus
comma
multiline_comment|/* 0 means top level bus */
id|u32
id|slot_num
)paren
(brace
id|u32
id|pci_addr
op_assign
l_int|0
suffix:semicolon
id|u32
id|pciinit_offset
op_assign
l_int|0
suffix:semicolon
id|u32
id|virt_addr
suffix:semicolon
id|u32
id|option
suffix:semicolon
multiline_comment|/* minimum pdar (window) size is 2MB */
id|db_assert
c_func
(paren
id|swap-&gt;config_size
op_ge
(paren
l_int|2
op_lshift
l_int|20
)paren
)paren
suffix:semicolon
id|db_assert
c_func
(paren
id|slot_num
OL
(paren
l_int|1
op_lshift
l_int|5
)paren
)paren
suffix:semicolon
id|db_assert
c_func
(paren
id|bus
OL
(paren
l_int|1
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* backup registers */
id|swap-&gt;pdar_backup
op_assign
id|ddb_in32
c_func
(paren
id|swap-&gt;pdar
)paren
suffix:semicolon
id|swap-&gt;pmr_backup
op_assign
id|ddb_in32
c_func
(paren
id|swap-&gt;pmr
)paren
suffix:semicolon
multiline_comment|/* set the pdar (pci window) register */
id|ddb_set_pdar
c_func
(paren
id|swap-&gt;pdar
comma
id|swap-&gt;config_base
comma
id|swap-&gt;config_size
comma
l_int|32
comma
multiline_comment|/* 32 bit wide */
l_int|0
comma
multiline_comment|/* not on local memory bus */
l_int|0
)paren
suffix:semicolon
multiline_comment|/* not visible from PCI bus (N/A) */
multiline_comment|/*&n;&t; * calcuate the absolute pci config addr;&n;&t; * according to the spec, we start scanning from adr:11 (0x800)&n;&t; */
r_if
c_cond
(paren
id|bus
op_eq
l_int|0
)paren
(brace
multiline_comment|/* type 0 config */
id|pci_addr
op_assign
l_int|0x800
op_lshift
id|slot_num
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* type 1 config */
id|pci_addr
op_assign
(paren
id|bus
op_lshift
l_int|16
)paren
op_or
(paren
id|slot_num
op_lshift
l_int|11
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * if pci_addr is less than pci config window size,  we set&n;&t; * pciinit_offset to 0 and adjust the virt_address.&n;&t; * Otherwise we will try to adjust pciinit_offset.&n;&t; */
r_if
c_cond
(paren
id|pci_addr
OL
id|swap-&gt;config_size
)paren
(brace
id|virt_addr
op_assign
id|KSEG1ADDR
c_func
(paren
id|swap-&gt;config_base
op_plus
id|pci_addr
)paren
suffix:semicolon
id|pciinit_offset
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|db_assert
c_func
(paren
(paren
id|pci_addr
op_amp
(paren
id|swap-&gt;config_size
op_minus
l_int|1
)paren
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|virt_addr
op_assign
id|KSEG1ADDR
c_func
(paren
id|swap-&gt;config_base
)paren
suffix:semicolon
id|pciinit_offset
op_assign
id|pci_addr
suffix:semicolon
)brace
multiline_comment|/* set the pmr register */
id|option
op_assign
id|DDB_PCI_ACCESS_32
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_ne
l_int|0
)paren
id|option
op_or_assign
id|DDB_PCI_CFGTYPE1
suffix:semicolon
id|ddb_set_pmr
c_func
(paren
id|swap-&gt;pmr
comma
id|DDB_PCICMD_CFG
comma
id|pciinit_offset
comma
id|option
)paren
suffix:semicolon
r_return
id|virt_addr
suffix:semicolon
)brace
DECL|function|ddb_close_config_base
r_static
r_inline
r_void
id|ddb_close_config_base
c_func
(paren
r_struct
id|pci_config_swap
op_star
id|swap
)paren
(brace
id|ddb_out32
c_func
(paren
id|swap-&gt;pdar
comma
id|swap-&gt;pdar_backup
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|swap-&gt;pmr
comma
id|swap-&gt;pmr_backup
)paren
suffix:semicolon
)brace
DECL|function|read_config_dword
r_static
r_int
id|read_config_dword
c_func
(paren
r_struct
id|pci_config_swap
op_star
id|swap
comma
r_struct
id|pci_bus
op_star
id|bus
comma
id|u32
id|devfn
comma
id|u32
id|where
comma
id|u32
op_star
id|val
)paren
(brace
id|u32
id|bus_num
comma
id|slot_num
comma
id|func_num
suffix:semicolon
id|u32
id|base
suffix:semicolon
id|db_assert
c_func
(paren
(paren
id|where
op_amp
l_int|3
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|db_assert
c_func
(paren
id|where
OL
(paren
l_int|1
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* check if the bus is top-level */
r_if
c_cond
(paren
id|bus-&gt;parent
op_ne
l_int|NULL
)paren
(brace
id|bus_num
op_assign
id|bus-&gt;number
suffix:semicolon
id|db_assert
c_func
(paren
id|bus_num
op_ne
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|bus_num
op_assign
l_int|0
suffix:semicolon
)brace
id|slot_num
op_assign
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
suffix:semicolon
id|func_num
op_assign
id|PCI_FUNC
c_func
(paren
id|devfn
)paren
suffix:semicolon
id|base
op_assign
id|ddb_access_config_base
c_func
(paren
id|swap
comma
id|bus_num
comma
id|slot_num
)paren
suffix:semicolon
op_star
id|val
op_assign
op_star
(paren
r_volatile
id|u32
op_star
)paren
(paren
id|base
op_plus
(paren
id|func_num
op_lshift
l_int|8
)paren
op_plus
id|where
)paren
suffix:semicolon
id|ddb_close_config_base
c_func
(paren
id|swap
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|read_config_word
r_static
r_int
id|read_config_word
c_func
(paren
r_struct
id|pci_config_swap
op_star
id|swap
comma
r_struct
id|pci_bus
op_star
id|bus
comma
id|u32
id|devfn
comma
id|u32
id|where
comma
id|u16
op_star
id|val
)paren
(brace
r_int
id|status
suffix:semicolon
id|u32
id|result
suffix:semicolon
id|db_assert
c_func
(paren
(paren
id|where
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|status
op_assign
id|read_config_dword
c_func
(paren
id|swap
comma
id|bus
comma
id|devfn
comma
id|where
op_amp
op_complement
l_int|3
comma
op_amp
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|where
op_amp
l_int|2
)paren
id|result
op_rshift_assign
l_int|16
suffix:semicolon
op_star
id|val
op_assign
id|result
op_amp
l_int|0xffff
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|read_config_byte
r_static
r_int
id|read_config_byte
c_func
(paren
r_struct
id|pci_config_swap
op_star
id|swap
comma
r_struct
id|pci_bus
op_star
id|bus
comma
id|u32
id|devfn
comma
id|u32
id|where
comma
id|u8
op_star
id|val
)paren
(brace
r_int
id|status
suffix:semicolon
id|u32
id|result
suffix:semicolon
id|status
op_assign
id|read_config_dword
c_func
(paren
id|swap
comma
id|bus
comma
id|devfn
comma
id|where
op_amp
op_complement
l_int|3
comma
op_amp
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|where
op_amp
l_int|1
)paren
id|result
op_rshift_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|where
op_amp
l_int|2
)paren
id|result
op_rshift_assign
l_int|16
suffix:semicolon
op_star
id|val
op_assign
id|result
op_amp
l_int|0xff
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|write_config_dword
r_static
r_int
id|write_config_dword
c_func
(paren
r_struct
id|pci_config_swap
op_star
id|swap
comma
r_struct
id|pci_bus
op_star
id|bus
comma
id|u32
id|devfn
comma
id|u32
id|where
comma
id|u32
id|val
)paren
(brace
id|u32
id|bus_num
comma
id|slot_num
comma
id|func_num
suffix:semicolon
id|u32
id|base
suffix:semicolon
id|db_assert
c_func
(paren
(paren
id|where
op_amp
l_int|3
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|db_assert
c_func
(paren
id|where
OL
(paren
l_int|1
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* check if the bus is top-level */
r_if
c_cond
(paren
id|bus-&gt;parent
op_ne
l_int|NULL
)paren
(brace
id|bus_num
op_assign
id|bus-&gt;number
suffix:semicolon
id|db_assert
c_func
(paren
id|bus_num
op_ne
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|bus_num
op_assign
l_int|0
suffix:semicolon
)brace
id|slot_num
op_assign
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
suffix:semicolon
id|func_num
op_assign
id|PCI_FUNC
c_func
(paren
id|devfn
)paren
suffix:semicolon
id|base
op_assign
id|ddb_access_config_base
c_func
(paren
id|swap
comma
id|bus_num
comma
id|slot_num
)paren
suffix:semicolon
op_star
(paren
r_volatile
id|u32
op_star
)paren
(paren
id|base
op_plus
(paren
id|func_num
op_lshift
l_int|8
)paren
op_plus
id|where
)paren
op_assign
id|val
suffix:semicolon
id|ddb_close_config_base
c_func
(paren
id|swap
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|write_config_word
r_static
r_int
id|write_config_word
c_func
(paren
r_struct
id|pci_config_swap
op_star
id|swap
comma
r_struct
id|pci_bus
op_star
id|bus
comma
id|u32
id|devfn
comma
id|u32
id|where
comma
id|u16
id|val
)paren
(brace
r_int
id|status
comma
id|shift
op_assign
l_int|0
suffix:semicolon
id|u32
id|result
suffix:semicolon
id|db_assert
c_func
(paren
(paren
id|where
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|status
op_assign
id|read_config_dword
c_func
(paren
id|swap
comma
id|bus
comma
id|devfn
comma
id|where
op_amp
op_complement
l_int|3
comma
op_amp
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
id|where
op_amp
l_int|2
)paren
id|shift
op_add_assign
l_int|16
suffix:semicolon
id|result
op_and_assign
op_complement
(paren
l_int|0xffff
op_lshift
id|shift
)paren
suffix:semicolon
id|result
op_or_assign
id|val
op_lshift
id|shift
suffix:semicolon
r_return
id|write_config_dword
c_func
(paren
id|swap
comma
id|bus
comma
id|devfn
comma
id|where
op_amp
op_complement
l_int|3
comma
id|result
)paren
suffix:semicolon
)brace
DECL|function|write_config_byte
r_static
r_int
id|write_config_byte
c_func
(paren
r_struct
id|pci_config_swap
op_star
id|swap
comma
r_struct
id|pci_bus
op_star
id|bus
comma
id|u32
id|devfn
comma
id|u32
id|where
comma
id|u8
id|val
)paren
(brace
r_int
id|status
comma
id|shift
op_assign
l_int|0
suffix:semicolon
id|u32
id|result
suffix:semicolon
id|status
op_assign
id|read_config_dword
c_func
(paren
id|swap
comma
id|bus
comma
id|devfn
comma
id|where
op_amp
op_complement
l_int|3
comma
op_amp
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
id|where
op_amp
l_int|2
)paren
id|shift
op_add_assign
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|where
op_amp
l_int|1
)paren
id|shift
op_add_assign
l_int|8
suffix:semicolon
id|result
op_and_assign
op_complement
(paren
l_int|0xff
op_lshift
id|shift
)paren
suffix:semicolon
id|result
op_or_assign
id|val
op_lshift
id|shift
suffix:semicolon
r_return
id|write_config_dword
c_func
(paren
id|swap
comma
id|bus
comma
id|devfn
comma
id|where
op_amp
op_complement
l_int|3
comma
id|result
)paren
suffix:semicolon
)brace
DECL|macro|MAKE_PCI_OPS
mdefine_line|#define        MAKE_PCI_OPS(prefix, rw, pciswap, star) &bslash;&n;static int prefix##_##rw##_config(struct pci_bus *bus, unsigned int devfn, int where, int size, u32 star val) &bslash;&n;{ &bslash;&n;&t;if (size == 1) &bslash;&n;     &t;&t;return rw##_config_byte(pciswap, bus, devfn, where, (u8 star)val); &bslash;&n;&t;else if (size == 2) &bslash;&n;     &t;&t;return rw##_config_word(pciswap, bus, devfn, where, (u16 star)val); &bslash;&n;&t;/* Size must be 4 */ &bslash;&n;     &t;return rw##_config_dword(pciswap, bus, devfn, where, val); &bslash;&n;}
id|MAKE_PCI_OPS
c_func
(paren
id|extpci
comma
id|read
comma
op_amp
id|ext_pci_swap
comma
op_star
)paren
id|MAKE_PCI_OPS
c_func
(paren
id|extpci
comma
id|write
comma
op_amp
id|ext_pci_swap
comma
)paren
id|MAKE_PCI_OPS
c_func
(paren
id|iopci
comma
id|read
comma
op_amp
id|io_pci_swap
comma
op_star
)paren
id|MAKE_PCI_OPS
c_func
(paren
id|iopci
comma
id|write
comma
op_amp
id|io_pci_swap
comma
)paren
DECL|variable|ddb5477_ext_pci_ops
r_struct
id|pci_ops
id|ddb5477_ext_pci_ops
op_assign
(brace
dot
id|read
op_assign
id|extpci_read_config
comma
dot
id|write
op_assign
id|extpci_write_config
)brace
suffix:semicolon
DECL|variable|ddb5477_io_pci_ops
r_struct
id|pci_ops
id|ddb5477_io_pci_ops
op_assign
(brace
dot
id|read
op_assign
id|iopci_read_config
comma
dot
id|write
op_assign
id|iopci_write_config
)brace
suffix:semicolon
eof
