multiline_comment|/*&n; *  ops-vr41xx.c, PCI configuration routines for the PCIU of NEC VR4100 series.&n; *&n; *  Copyright (C) 2001-2003 MontaVista Software Inc.&n; *    Author: Yoichi Yuasa &lt;yyuasa@mvista.com or source@mvista.com&gt;&n; *  Copyright (C) 2004  Yoichi Yuasa &lt;yuasa@hh.iij4u.or.jp&gt;&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
multiline_comment|/*&n; * Changes:&n; *  MontaVista Software Inc. &lt;yyuasa@mvista.com&gt; or &lt;source@mvista.com&gt;&n; *  - New creation, NEC VR4122 and VR4131 are supported.&n; */
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|macro|PCICONFDREG
mdefine_line|#define PCICONFDREG&t;KSEG1ADDR(0x0f000c14)
DECL|macro|PCICONFAREG
mdefine_line|#define PCICONFAREG&t;KSEG1ADDR(0x0f000c18)
DECL|function|set_pci_configuration_address
r_static
r_inline
r_int
id|set_pci_configuration_address
c_func
(paren
r_int
r_char
id|number
comma
r_int
r_int
id|devfn
comma
r_int
id|where
)paren
(brace
r_if
c_cond
(paren
id|number
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t; * Type 0 configuration&n;&t;&t; */
r_if
c_cond
(paren
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
template_param
l_int|0xff
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|writel
c_func
(paren
(paren
l_int|1U
op_lshift
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
)paren
op_or
(paren
id|PCI_FUNC
c_func
(paren
id|devfn
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|where
op_amp
l_int|0xfc
)paren
comma
id|PCICONFAREG
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Type 1 configuration&n;&t;&t; */
r_if
c_cond
(paren
id|where
OG
l_int|0xff
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|writel
c_func
(paren
(paren
(paren
r_uint32
)paren
id|number
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|devfn
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|where
op_amp
l_int|0xfc
)paren
op_or
l_int|1U
comma
id|PCICONFAREG
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pci_config_read
r_static
r_int
id|pci_config_read
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
r_uint32
op_star
id|val
)paren
(brace
r_uint32
id|data
suffix:semicolon
op_star
id|val
op_assign
l_int|0xffffffffU
suffix:semicolon
r_if
c_cond
(paren
id|set_pci_configuration_address
c_func
(paren
id|bus-&gt;number
comma
id|devfn
comma
id|where
)paren
OL
l_int|0
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|data
op_assign
id|readl
c_func
(paren
id|PCICONFDREG
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
l_int|1
suffix:colon
op_star
id|val
op_assign
(paren
id|data
op_rshift
(paren
(paren
id|where
op_amp
l_int|3
)paren
op_lshift
l_int|3
)paren
)paren
op_amp
l_int|0xffU
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
op_star
id|val
op_assign
(paren
id|data
op_rshift
(paren
(paren
id|where
op_amp
l_int|2
)paren
op_lshift
l_int|3
)paren
)paren
op_amp
l_int|0xffffU
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
op_star
id|val
op_assign
id|data
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|PCIBIOS_FUNC_NOT_SUPPORTED
suffix:semicolon
)brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|pci_config_write
r_static
r_int
id|pci_config_write
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
r_uint32
id|val
)paren
(brace
r_uint32
id|data
suffix:semicolon
r_int
id|shift
suffix:semicolon
r_if
c_cond
(paren
id|set_pci_configuration_address
c_func
(paren
id|bus-&gt;number
comma
id|devfn
comma
id|where
)paren
OL
l_int|0
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|data
op_assign
id|readl
c_func
(paren
id|PCICONFDREG
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
l_int|1
suffix:colon
id|shift
op_assign
(paren
id|where
op_amp
l_int|3
)paren
op_lshift
l_int|3
suffix:semicolon
id|data
op_and_assign
op_complement
(paren
l_int|0xffU
op_lshift
id|shift
)paren
suffix:semicolon
id|data
op_or_assign
(paren
(paren
id|val
op_amp
l_int|0xffU
)paren
op_lshift
id|shift
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|shift
op_assign
(paren
id|where
op_amp
l_int|2
)paren
op_lshift
l_int|3
suffix:semicolon
id|data
op_and_assign
op_complement
(paren
l_int|0xffffU
op_lshift
id|shift
)paren
suffix:semicolon
id|data
op_or_assign
(paren
(paren
id|val
op_amp
l_int|0xffffU
)paren
op_lshift
id|shift
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|data
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|PCIBIOS_FUNC_NOT_SUPPORTED
suffix:semicolon
)brace
id|writel
c_func
(paren
id|data
comma
id|PCICONFDREG
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|variable|vr41xx_pci_ops
r_struct
id|pci_ops
id|vr41xx_pci_ops
op_assign
(brace
dot
id|read
op_assign
id|pci_config_read
comma
dot
id|write
op_assign
id|pci_config_write
comma
)brace
suffix:semicolon
eof
