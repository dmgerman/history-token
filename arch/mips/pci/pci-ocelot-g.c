multiline_comment|/*&n; * Copyright 2002 Momentum Computer&n; * Author: Matthew Dharm &lt;mdharm@momenco.com&gt;&n; *&n; *  This program is free software; you can redistribute  it and/or modify it&n; *  under  the terms of  the GNU General  Public License as published by the&n; *  Free Software Foundation;  either version 2 of the  License, or (at your&n; *  option) any later version.&n; *&n; *  THIS  SOFTWARE  IS PROVIDED   ``AS  IS&squot;&squot; AND   ANY  EXPRESS OR IMPLIED&n; *  WARRANTIES,   INCLUDING, BUT NOT  LIMITED  TO, THE IMPLIED WARRANTIES OF&n; *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN&n; *  NO  EVENT  SHALL   THE AUTHOR  BE    LIABLE FOR ANY   DIRECT, INDIRECT,&n; *  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT&n; *  NOT LIMITED   TO, PROCUREMENT OF  SUBSTITUTE GOODS  OR SERVICES; LOSS OF&n; *  USE, DATA,  OR PROFITS; OR  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON&n; *  ANY THEORY OF LIABILITY, WHETHER IN  CONTRACT, STRICT LIABILITY, OR TORT&n; *  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF&n; *  THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n; *&n; *  You should have received a copy of the  GNU General Public License along&n; *  with this program; if not, write  to the Free Software Foundation, Inc.,&n; *  675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;asm/pci.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;gt64240.h&quot;
macro_line|#include &lt;linux/init.h&gt;
DECL|macro|SELF
mdefine_line|#define SELF 0
DECL|macro|MASTER_ABORT_BIT
mdefine_line|#define MASTER_ABORT_BIT 0x100
multiline_comment|/*&n; * These functions and structures provide the BIOS scan and mapping of the PCI&n; * devices.&n; */
DECL|macro|MAX_PCI_DEVS
mdefine_line|#define MAX_PCI_DEVS 10
r_void
id|gt64240_board_pcibios_fixup_bus
c_func
(paren
r_struct
id|pci_bus
op_star
id|c
)paren
suffix:semicolon
multiline_comment|/*  Functions to implement &quot;pci ops&quot;  */
r_static
r_int
id|galileo_pcibios_read_config_word
c_func
(paren
r_int
id|bus
comma
r_int
id|devfn
comma
r_int
id|offset
comma
id|u16
op_star
id|val
)paren
suffix:semicolon
r_static
r_int
id|galileo_pcibios_read_config_byte
c_func
(paren
r_int
id|bus
comma
r_int
id|devfn
comma
r_int
id|offset
comma
id|u8
op_star
id|val
)paren
suffix:semicolon
r_static
r_int
id|galileo_pcibios_read_config_dword
c_func
(paren
r_int
id|bus
comma
r_int
id|devfn
comma
r_int
id|offset
comma
id|u32
op_star
id|val
)paren
suffix:semicolon
r_static
r_int
id|galileo_pcibios_write_config_byte
c_func
(paren
r_int
id|bus
comma
r_int
id|devfn
comma
r_int
id|offset
comma
id|u8
id|val
)paren
suffix:semicolon
r_static
r_int
id|galileo_pcibios_write_config_word
c_func
(paren
r_int
id|bus
comma
r_int
id|devfn
comma
r_int
id|offset
comma
id|u16
id|val
)paren
suffix:semicolon
r_static
r_int
id|galileo_pcibios_write_config_dword
c_func
(paren
r_int
id|bus
comma
r_int
id|devfn
comma
r_int
id|offset
comma
id|u32
id|val
)paren
suffix:semicolon
macro_line|#if 0
r_static
r_void
id|galileo_pcibios_set_master
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_static
r_int
id|pci_read
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfs
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
op_star
id|val
)paren
suffix:semicolon
r_static
r_int
id|pci_write
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfs
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
id|val
)paren
suffix:semicolon
multiline_comment|/*&n; *  General-purpose PCI functions.&n; */
multiline_comment|/*&n; * pci_range_ck -&n; *&n; * Check if the pci device that are trying to access does really exists&n; * on the evaluation board.&n; *&n; * Inputs :&n; * bus - bus number (0 for PCI 0 ; 1 for PCI 1)&n; * dev - number of device on the specific pci bus&n; *&n; * Outpus :&n; * 0 - if OK , 1 - if failure&n; */
DECL|function|pci_range_ck
r_static
id|__inline__
r_int
id|pci_range_ck
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev
)paren
(brace
multiline_comment|/* Accessing device 31 crashes the GT-64240. */
r_if
c_cond
(paren
id|dev
OL
l_int|5
)paren
r_return
l_int|0
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * galileo_pcibios_(read/write)_config_(dword/word/byte) -&n; *&n; * reads/write a dword/word/byte register from the configuration space&n; * of a device.&n; *&n; * Note that bus 0 and bus 1 are local, and we assume all other busses are&n; * bridged from bus 1.  This is a safe assumption, since any other&n; * configuration will require major modifications to the CP7000G&n; *&n; * Inputs :&n; * bus - bus number&n; * dev - device number&n; * offset - register offset in the configuration space&n; * val - value to be written / read&n; *&n; * Outputs :&n; * PCIBIOS_SUCCESSFUL when operation was succesfull&n; * PCIBIOS_DEVICE_NOT_FOUND when the bus or dev is errorneous&n; * PCIBIOS_BAD_REGISTER_NUMBER when accessing non aligned&n; */
DECL|function|galileo_pcibios_read_config_dword
r_static
r_int
id|galileo_pcibios_read_config_dword
c_func
(paren
r_int
id|bus
comma
r_int
id|devfn
comma
r_int
id|offset
comma
id|u32
op_star
id|val
)paren
(brace
r_int
id|dev
comma
id|func
suffix:semicolon
r_uint32
id|address_reg
comma
id|data_reg
suffix:semicolon
r_uint32
id|address
suffix:semicolon
id|dev
op_assign
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
suffix:semicolon
id|func
op_assign
id|PCI_FUNC
c_func
(paren
id|devfn
)paren
suffix:semicolon
multiline_comment|/* verify the range */
r_if
c_cond
(paren
id|pci_range_ck
c_func
(paren
id|bus
comma
id|dev
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
multiline_comment|/* select the GT-64240 registers to communicate with the PCI bus */
r_if
c_cond
(paren
id|bus
op_eq
l_int|0
)paren
(brace
id|address_reg
op_assign
id|PCI_0CONFIGURATION_ADDRESS
suffix:semicolon
id|data_reg
op_assign
id|PCI_0CONFIGURATION_DATA_VIRTUAL_REGISTER
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|PCI_0ERROR_CAUSE
comma
op_complement
id|MASTER_ABORT_BIT
)paren
suffix:semicolon
)brace
r_else
(brace
id|address_reg
op_assign
id|PCI_1CONFIGURATION_ADDRESS
suffix:semicolon
id|data_reg
op_assign
id|PCI_1CONFIGURATION_DATA_VIRTUAL_REGISTER
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|PCI_1ERROR_CAUSE
comma
op_complement
id|MASTER_ABORT_BIT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_eq
l_int|1
)paren
id|bus
op_assign
l_int|0
suffix:semicolon
)brace
id|address
op_assign
(paren
id|bus
op_lshift
l_int|16
)paren
op_or
(paren
id|dev
op_lshift
l_int|11
)paren
op_or
(paren
id|func
op_lshift
l_int|8
)paren
op_or
(paren
id|offset
op_amp
l_int|0xfc
)paren
op_or
l_int|0x80000000
suffix:semicolon
multiline_comment|/* start the configuration cycle */
id|GT_WRITE
c_func
(paren
id|address_reg
comma
id|address
)paren
suffix:semicolon
multiline_comment|/* read the data */
id|GT_READ
c_func
(paren
id|data_reg
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|galileo_pcibios_read_config_word
r_static
r_int
id|galileo_pcibios_read_config_word
c_func
(paren
r_int
id|bus
comma
r_int
id|devfn
comma
r_int
id|offset
comma
id|u16
op_star
id|val
)paren
(brace
r_int
id|dev
comma
id|func
suffix:semicolon
r_uint32
id|address_reg
comma
id|data_reg
suffix:semicolon
r_uint32
id|address
suffix:semicolon
id|dev
op_assign
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
suffix:semicolon
id|func
op_assign
id|PCI_FUNC
c_func
(paren
id|devfn
)paren
suffix:semicolon
multiline_comment|/* verify the range */
r_if
c_cond
(paren
id|pci_range_ck
c_func
(paren
id|bus
comma
id|dev
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
multiline_comment|/* select the GT-64240 registers to communicate with the PCI bus */
r_if
c_cond
(paren
id|bus
op_eq
l_int|0
)paren
(brace
id|address_reg
op_assign
id|PCI_0CONFIGURATION_ADDRESS
suffix:semicolon
id|data_reg
op_assign
id|PCI_0CONFIGURATION_DATA_VIRTUAL_REGISTER
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|PCI_0ERROR_CAUSE
comma
op_complement
id|MASTER_ABORT_BIT
)paren
suffix:semicolon
)brace
r_else
(brace
id|address_reg
op_assign
id|PCI_1CONFIGURATION_ADDRESS
suffix:semicolon
id|data_reg
op_assign
id|PCI_1CONFIGURATION_DATA_VIRTUAL_REGISTER
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|PCI_1ERROR_CAUSE
comma
op_complement
id|MASTER_ABORT_BIT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_eq
l_int|1
)paren
id|bus
op_assign
l_int|0
suffix:semicolon
)brace
id|address
op_assign
(paren
id|bus
op_lshift
l_int|16
)paren
op_or
(paren
id|dev
op_lshift
l_int|11
)paren
op_or
(paren
id|func
op_lshift
l_int|8
)paren
op_or
(paren
id|offset
op_amp
l_int|0xfc
)paren
op_or
l_int|0x80000000
suffix:semicolon
multiline_comment|/* start the configuration cycle */
id|GT_WRITE
c_func
(paren
id|address_reg
comma
id|address
)paren
suffix:semicolon
multiline_comment|/* read the data */
id|GT_READ_16
c_func
(paren
id|data_reg
op_plus
(paren
id|offset
op_amp
l_int|0x3
)paren
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|galileo_pcibios_read_config_byte
r_static
r_int
id|galileo_pcibios_read_config_byte
c_func
(paren
r_int
id|bus
comma
r_int
id|devfn
comma
r_int
id|offset
comma
id|u8
op_star
id|val
)paren
(brace
r_int
id|dev
comma
id|func
suffix:semicolon
r_uint32
id|address_reg
comma
id|data_reg
suffix:semicolon
r_uint32
id|address
suffix:semicolon
id|dev
op_assign
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
suffix:semicolon
id|func
op_assign
id|PCI_FUNC
c_func
(paren
id|devfn
)paren
suffix:semicolon
multiline_comment|/* verify the range */
r_if
c_cond
(paren
id|pci_range_ck
c_func
(paren
id|bus
comma
id|dev
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
multiline_comment|/* select the GT-64240 registers to communicate with the PCI bus */
r_if
c_cond
(paren
id|bus
op_eq
l_int|0
)paren
(brace
id|address_reg
op_assign
id|PCI_0CONFIGURATION_ADDRESS
suffix:semicolon
id|data_reg
op_assign
id|PCI_0CONFIGURATION_DATA_VIRTUAL_REGISTER
suffix:semicolon
)brace
r_else
(brace
id|address_reg
op_assign
id|PCI_1CONFIGURATION_ADDRESS
suffix:semicolon
id|data_reg
op_assign
id|PCI_1CONFIGURATION_DATA_VIRTUAL_REGISTER
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_eq
l_int|1
)paren
id|bus
op_assign
l_int|0
suffix:semicolon
)brace
id|address
op_assign
(paren
id|bus
op_lshift
l_int|16
)paren
op_or
(paren
id|dev
op_lshift
l_int|11
)paren
op_or
(paren
id|func
op_lshift
l_int|8
)paren
op_or
(paren
id|offset
op_amp
l_int|0xfc
)paren
op_or
l_int|0x80000000
suffix:semicolon
multiline_comment|/* start the configuration cycle */
id|GT_WRITE
c_func
(paren
id|address_reg
comma
id|address
)paren
suffix:semicolon
multiline_comment|/* write the data */
id|GT_READ_8
c_func
(paren
id|data_reg
op_plus
(paren
id|offset
op_amp
l_int|0x3
)paren
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|galileo_pcibios_write_config_dword
r_static
r_int
id|galileo_pcibios_write_config_dword
c_func
(paren
r_int
id|bus
comma
r_int
id|devfn
comma
r_int
id|offset
comma
id|u32
id|val
)paren
(brace
r_int
id|dev
comma
id|func
suffix:semicolon
r_uint32
id|address_reg
comma
id|data_reg
suffix:semicolon
r_uint32
id|address
suffix:semicolon
id|dev
op_assign
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
suffix:semicolon
id|func
op_assign
id|PCI_FUNC
c_func
(paren
id|devfn
)paren
suffix:semicolon
multiline_comment|/* verify the range */
r_if
c_cond
(paren
id|pci_range_ck
c_func
(paren
id|bus
comma
id|dev
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
multiline_comment|/* select the GT-64240 registers to communicate with the PCI bus */
r_if
c_cond
(paren
id|bus
op_eq
l_int|0
)paren
(brace
id|address_reg
op_assign
id|PCI_0CONFIGURATION_ADDRESS
suffix:semicolon
id|data_reg
op_assign
id|PCI_0CONFIGURATION_DATA_VIRTUAL_REGISTER
suffix:semicolon
)brace
r_else
(brace
id|address_reg
op_assign
id|PCI_1CONFIGURATION_ADDRESS
suffix:semicolon
id|data_reg
op_assign
id|PCI_1CONFIGURATION_DATA_VIRTUAL_REGISTER
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_eq
l_int|1
)paren
id|bus
op_assign
l_int|0
suffix:semicolon
)brace
id|address
op_assign
(paren
id|bus
op_lshift
l_int|16
)paren
op_or
(paren
id|dev
op_lshift
l_int|11
)paren
op_or
(paren
id|func
op_lshift
l_int|8
)paren
op_or
(paren
id|offset
op_amp
l_int|0xfc
)paren
op_or
l_int|0x80000000
suffix:semicolon
multiline_comment|/* start the configuration cycle */
id|GT_WRITE
c_func
(paren
id|address_reg
comma
id|address
)paren
suffix:semicolon
multiline_comment|/* write the data */
id|GT_WRITE
c_func
(paren
id|data_reg
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|galileo_pcibios_write_config_word
r_static
r_int
id|galileo_pcibios_write_config_word
c_func
(paren
r_int
id|bus
comma
r_int
id|devfn
comma
r_int
id|offset
comma
id|u16
id|val
)paren
(brace
r_int
id|dev
comma
id|func
suffix:semicolon
r_uint32
id|address_reg
comma
id|data_reg
suffix:semicolon
r_uint32
id|address
suffix:semicolon
id|dev
op_assign
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
suffix:semicolon
id|func
op_assign
id|PCI_FUNC
c_func
(paren
id|devfn
)paren
suffix:semicolon
multiline_comment|/* verify the range */
r_if
c_cond
(paren
id|pci_range_ck
c_func
(paren
id|bus
comma
id|dev
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
multiline_comment|/* select the GT-64240 registers to communicate with the PCI bus */
r_if
c_cond
(paren
id|bus
op_eq
l_int|0
)paren
(brace
id|address_reg
op_assign
id|PCI_0CONFIGURATION_ADDRESS
suffix:semicolon
id|data_reg
op_assign
id|PCI_0CONFIGURATION_DATA_VIRTUAL_REGISTER
suffix:semicolon
)brace
r_else
(brace
id|address_reg
op_assign
id|PCI_1CONFIGURATION_ADDRESS
suffix:semicolon
id|data_reg
op_assign
id|PCI_1CONFIGURATION_DATA_VIRTUAL_REGISTER
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_eq
l_int|1
)paren
id|bus
op_assign
l_int|0
suffix:semicolon
)brace
id|address
op_assign
(paren
id|bus
op_lshift
l_int|16
)paren
op_or
(paren
id|dev
op_lshift
l_int|11
)paren
op_or
(paren
id|func
op_lshift
l_int|8
)paren
op_or
(paren
id|offset
op_amp
l_int|0xfc
)paren
op_or
l_int|0x80000000
suffix:semicolon
multiline_comment|/* start the configuration cycle */
id|GT_WRITE
c_func
(paren
id|address_reg
comma
id|address
)paren
suffix:semicolon
multiline_comment|/* write the data */
id|GT_WRITE_16
c_func
(paren
id|data_reg
op_plus
(paren
id|offset
op_amp
l_int|0x3
)paren
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|galileo_pcibios_write_config_byte
r_static
r_int
id|galileo_pcibios_write_config_byte
c_func
(paren
r_int
id|bus
comma
r_int
id|devfn
comma
r_int
id|offset
comma
id|u8
id|val
)paren
(brace
r_int
id|dev
comma
id|func
suffix:semicolon
r_uint32
id|address_reg
comma
id|data_reg
suffix:semicolon
r_uint32
id|address
suffix:semicolon
id|dev
op_assign
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
suffix:semicolon
id|func
op_assign
id|PCI_FUNC
c_func
(paren
id|devfn
)paren
suffix:semicolon
multiline_comment|/* verify the range */
r_if
c_cond
(paren
id|pci_range_ck
c_func
(paren
id|bus
comma
id|dev
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
multiline_comment|/* select the GT-64240 registers to communicate with the PCI bus */
r_if
c_cond
(paren
id|bus
op_eq
l_int|0
)paren
(brace
id|address_reg
op_assign
id|PCI_0CONFIGURATION_ADDRESS
suffix:semicolon
id|data_reg
op_assign
id|PCI_0CONFIGURATION_DATA_VIRTUAL_REGISTER
suffix:semicolon
)brace
r_else
(brace
id|address_reg
op_assign
id|PCI_1CONFIGURATION_ADDRESS
suffix:semicolon
id|data_reg
op_assign
id|PCI_1CONFIGURATION_DATA_VIRTUAL_REGISTER
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_eq
l_int|1
)paren
id|bus
op_assign
l_int|0
suffix:semicolon
)brace
id|address
op_assign
(paren
id|bus
op_lshift
l_int|16
)paren
op_or
(paren
id|dev
op_lshift
l_int|11
)paren
op_or
(paren
id|func
op_lshift
l_int|8
)paren
op_or
(paren
id|offset
op_amp
l_int|0xfc
)paren
op_or
l_int|0x80000000
suffix:semicolon
multiline_comment|/* start the configuration cycle */
id|GT_WRITE
c_func
(paren
id|address_reg
comma
id|address
)paren
suffix:semicolon
multiline_comment|/* write the data */
id|GT_WRITE_8
c_func
(paren
id|data_reg
op_plus
(paren
id|offset
op_amp
l_int|0x3
)paren
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
macro_line|#if 0
r_static
r_void
id|galileo_pcibios_set_master
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|u16
id|cmd
suffix:semicolon
id|galileo_pcibios_read_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd
op_or_assign
id|PCI_COMMAND_MASTER
suffix:semicolon
id|galileo_pcibios_write_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
id|cmd
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*  Externally-expected functions.  Do not change function names  */
DECL|function|pcibios_enable_resources
r_int
id|pcibios_enable_resources
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|u16
id|cmd
comma
id|old_cmd
suffix:semicolon
id|u8
id|tmp1
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_struct
id|resource
op_star
id|r
suffix:semicolon
id|pci_read
c_func
(paren
id|dev-&gt;bus
comma
id|dev-&gt;devfn
comma
id|PCI_COMMAND
comma
l_int|2
comma
(paren
id|u32
op_star
)paren
op_amp
id|cmd
)paren
suffix:semicolon
id|old_cmd
op_assign
id|cmd
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
l_int|6
suffix:semicolon
id|idx
op_increment
)paren
(brace
id|r
op_assign
op_amp
id|dev-&gt;resource
(braket
id|idx
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|r-&gt;start
op_logical_and
id|r-&gt;end
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PCI: Device %s not available because of &quot;
l_string|&quot;resource collisions&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|r-&gt;flags
op_amp
id|IORESOURCE_IO
)paren
id|cmd
op_or_assign
id|PCI_COMMAND_IO
suffix:semicolon
r_if
c_cond
(paren
id|r-&gt;flags
op_amp
id|IORESOURCE_MEM
)paren
id|cmd
op_or_assign
id|PCI_COMMAND_MEMORY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_ne
id|old_cmd
)paren
(brace
id|pci_write
c_func
(paren
id|dev-&gt;bus
comma
id|dev-&gt;devfn
comma
id|PCI_COMMAND
comma
l_int|2
comma
id|cmd
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Let&squot;s fix up the latency timer and cache line size here.  Cache&n;&t; * line size = 32 bytes / sizeof dword (4) = 8.&n;&t; * Latency timer must be &gt; 8.  32 is random but appears to work.&n;&t; */
id|pci_read
c_func
(paren
id|dev-&gt;bus
comma
id|dev-&gt;devfn
comma
id|PCI_CACHE_LINE_SIZE
comma
l_int|1
comma
(paren
id|u32
op_star
)paren
op_amp
id|tmp1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp1
op_ne
l_int|8
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PCI setting cache line size to 8 from &quot;
l_string|&quot;%d&bslash;n&quot;
comma
id|tmp1
)paren
suffix:semicolon
id|pci_write
c_func
(paren
id|dev-&gt;bus
comma
id|dev-&gt;devfn
comma
id|PCI_CACHE_LINE_SIZE
comma
l_int|1
comma
l_int|8
)paren
suffix:semicolon
)brace
id|pci_read
c_func
(paren
id|dev-&gt;bus
comma
id|dev-&gt;devfn
comma
id|PCI_LATENCY_TIMER
comma
l_int|1
comma
(paren
id|u32
op_star
)paren
op_amp
id|tmp1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp1
OL
l_int|32
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PCI setting latency timer to 32 from %d&bslash;n&quot;
comma
id|tmp1
)paren
suffix:semicolon
id|pci_write
c_func
(paren
id|dev-&gt;bus
comma
id|dev-&gt;devfn
comma
id|PCI_LATENCY_TIMER
comma
l_int|1
comma
l_int|32
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcibios_enable_device
r_int
id|pcibios_enable_device
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|mask
)paren
(brace
r_return
id|pcibios_enable_resources
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|pcibios_align_resource
r_void
id|pcibios_align_resource
c_func
(paren
r_void
op_star
id|data
comma
r_struct
id|resource
op_star
id|res
comma
r_int
r_int
id|size
comma
r_int
r_int
id|align
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
op_assign
id|data
suffix:semicolon
r_if
c_cond
(paren
id|res-&gt;flags
op_amp
id|IORESOURCE_IO
)paren
(brace
r_int
r_int
id|start
op_assign
id|res-&gt;start
suffix:semicolon
multiline_comment|/* We need to avoid collisions with `mirrored&squot; VGA ports&n;&t;&t;   and other strange ISA hardware, so we always want the&n;&t;&t;   addresses kilobyte aligned.  */
r_if
c_cond
(paren
id|size
OG
l_int|0x100
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PCI: I/O Region %s/%d too large&quot;
l_string|&quot; (%ld bytes)&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|dev
)paren
comma
id|dev-&gt;resource
op_minus
id|res
comma
id|size
)paren
suffix:semicolon
)brace
id|start
op_assign
(paren
id|start
op_plus
l_int|1024
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
l_int|1024
op_minus
l_int|1
)paren
suffix:semicolon
id|res-&gt;start
op_assign
id|start
suffix:semicolon
)brace
)brace
DECL|variable|galileo_pci_ops
r_struct
id|pci_ops
id|galileo_pci_ops
op_assign
(brace
dot
id|read
op_assign
id|pci_read
comma
dot
id|write
op_assign
id|pci_write
)brace
suffix:semicolon
DECL|function|pci_read
r_static
r_int
id|pci_read
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
op_star
id|val
)paren
(brace
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
l_int|1
suffix:colon
r_return
id|galileo_pcibios_read_config_byte
c_func
(paren
id|bus-&gt;number
comma
id|devfn
comma
id|where
comma
(paren
id|u8
op_star
)paren
id|val
)paren
suffix:semicolon
r_case
l_int|2
suffix:colon
r_return
id|galileo_pcibios_read_config_word
c_func
(paren
id|bus-&gt;number
comma
id|devfn
comma
id|where
comma
(paren
id|u16
op_star
)paren
id|val
)paren
suffix:semicolon
r_case
l_int|4
suffix:colon
r_return
id|galileo_pcibios_read_config_dword
c_func
(paren
id|bus-&gt;number
comma
id|devfn
comma
id|where
comma
(paren
id|u32
op_star
)paren
id|val
)paren
suffix:semicolon
)brace
r_return
id|PCIBIOS_FUNC_NOT_SUPPORTED
suffix:semicolon
)brace
DECL|function|pci_write
r_static
r_int
id|pci_write
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
id|val
)paren
(brace
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
l_int|1
suffix:colon
r_return
id|galileo_pcibios_write_config_byte
c_func
(paren
id|bus-&gt;number
comma
id|devfn
comma
id|where
comma
id|val
)paren
suffix:semicolon
r_case
l_int|2
suffix:colon
r_return
id|galileo_pcibios_write_config_word
c_func
(paren
id|bus-&gt;number
comma
id|devfn
comma
id|where
comma
id|val
)paren
suffix:semicolon
r_case
l_int|4
suffix:colon
r_return
id|galileo_pcibios_write_config_dword
c_func
(paren
id|bus-&gt;number
comma
id|devfn
comma
id|where
comma
id|val
)paren
suffix:semicolon
)brace
r_return
id|PCIBIOS_FUNC_NOT_SUPPORTED
suffix:semicolon
)brace
DECL|variable|pcibios_fixups
r_struct
id|pci_fixup
id|pcibios_fixups
(braket
)braket
op_assign
(brace
(brace
l_int|0
)brace
)brace
suffix:semicolon
DECL|function|pcibios_fixup_bus
r_void
id|__devinit
id|pcibios_fixup_bus
c_func
(paren
r_struct
id|pci_bus
op_star
id|c
)paren
(brace
id|gt64240_board_pcibios_fixup_bus
c_func
(paren
id|c
)paren
suffix:semicolon
)brace
multiline_comment|/********************************************************************&n;* pci0P2PConfig - This function set the PCI_0 P2P configurate.&n;*                 For more information on the P2P read PCI spec.&n;*&n;* Inputs:  unsigned int SecondBusLow - Secondery PCI interface Bus Range Lower&n;*                                      Boundry.&n;*          unsigned int SecondBusHigh - Secondry PCI interface Bus Range upper&n;*                                      Boundry.&n;*          unsigned int busNum - The CPI bus number to which the PCI interface&n;*                                      is connected.&n;*          unsigned int devNum - The PCI interface&squot;s device number.&n;*&n;* Returns:  true.&n;*/
DECL|function|pci0P2PConfig
r_void
id|pci0P2PConfig
c_func
(paren
r_int
r_int
id|SecondBusLow
comma
r_int
r_int
id|SecondBusHigh
comma
r_int
r_int
id|busNum
comma
r_int
r_int
id|devNum
)paren
(brace
r_uint32
id|regData
suffix:semicolon
id|regData
op_assign
(paren
id|SecondBusLow
op_amp
l_int|0xff
)paren
op_or
(paren
(paren
id|SecondBusHigh
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|busNum
op_amp
l_int|0xff
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|devNum
op_amp
l_int|0x1f
)paren
op_lshift
l_int|24
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|PCI_0P2P_CONFIGURATION
comma
id|regData
)paren
suffix:semicolon
)brace
multiline_comment|/********************************************************************&n;* pci1P2PConfig - This function set the PCI_1 P2P configurate.&n;*                 For more information on the P2P read PCI spec.&n;*&n;* Inputs:  unsigned int SecondBusLow - Secondery PCI interface Bus Range Lower&n;*               Boundry.&n;*          unsigned int SecondBusHigh - Secondry PCI interface Bus Range upper&n;*               Boundry.&n;*          unsigned int busNum - The CPI bus number to which the PCI interface&n;*               is connected.&n;*          unsigned int devNum - The PCI interface&squot;s device number.&n;*&n;* Returns:  true.&n;*/
DECL|function|pci1P2PConfig
r_void
id|pci1P2PConfig
c_func
(paren
r_int
r_int
id|SecondBusLow
comma
r_int
r_int
id|SecondBusHigh
comma
r_int
r_int
id|busNum
comma
r_int
r_int
id|devNum
)paren
(brace
r_uint32
id|regData
suffix:semicolon
id|regData
op_assign
(paren
id|SecondBusLow
op_amp
l_int|0xff
)paren
op_or
(paren
(paren
id|SecondBusHigh
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|busNum
op_amp
l_int|0xff
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|devNum
op_amp
l_int|0x1f
)paren
op_lshift
l_int|24
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|PCI_1P2P_CONFIGURATION
comma
id|regData
)paren
suffix:semicolon
)brace
DECL|macro|PCI0_STATUS_COMMAND_REG
mdefine_line|#define PCI0_STATUS_COMMAND_REG                 0x4
DECL|macro|PCI1_STATUS_COMMAND_REG
mdefine_line|#define PCI1_STATUS_COMMAND_REG                 0x84
DECL|function|pcibios_init
r_static
r_int
id|__init
id|pcibios_init
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Reset PCI I/O and PCI MEM values */
id|ioport_resource.start
op_assign
l_int|0xe0000000
suffix:semicolon
id|ioport_resource.end
op_assign
l_int|0xe0000000
op_plus
l_int|0x20000000
op_minus
l_int|1
suffix:semicolon
id|iomem_resource.start
op_assign
l_int|0xc0000000
suffix:semicolon
id|iomem_resource.end
op_assign
l_int|0xc0000000
op_plus
l_int|0x20000000
op_minus
l_int|1
suffix:semicolon
id|pci_scan_bus
c_func
(paren
l_int|0
comma
op_amp
id|galileo_pci_ops
comma
l_int|NULL
)paren
suffix:semicolon
id|pci_scan_bus
c_func
(paren
l_int|1
comma
op_amp
id|galileo_pci_ops
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|pcibios_init
id|subsys_initcall
c_func
(paren
id|pcibios_init
)paren
suffix:semicolon
multiline_comment|/*&n; * for parsing &quot;pci=&quot; kernel boot arguments.&n; */
DECL|function|pcibios_setup
r_char
op_star
id|pcibios_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;rr: pcibios_setup&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Nothing to do for now.  */
r_return
id|str
suffix:semicolon
)brace
DECL|function|pcibios_assign_all_busses
r_int
id|__init
r_int
id|pcibios_assign_all_busses
c_func
(paren
r_void
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
eof
