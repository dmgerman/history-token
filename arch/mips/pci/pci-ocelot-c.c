multiline_comment|/*&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Copyright (C) 2004 by Ralf Baechle&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/mv64340.h&gt;
macro_line|#include &lt;asm/pci_channel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
multiline_comment|/*&n; * We assume the address ranges have already been setup appropriately by&n; * the firmware.  PMON in case of the Ocelot C does that.&n; */
DECL|variable|mv_pci_io_mem0_resource
r_static
r_struct
id|resource
id|mv_pci_io_mem0_resource
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;MV64340 PCI0 IO MEM&quot;
comma
dot
id|flags
op_assign
id|IORESOURCE_IO
)brace
suffix:semicolon
DECL|variable|mv_pci_mem0_resource
r_static
r_struct
id|resource
id|mv_pci_mem0_resource
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;MV64340 PCI0 MEM&quot;
comma
dot
id|flags
op_assign
id|IORESOURCE_MEM
)brace
suffix:semicolon
DECL|variable|mv_bus0_controller
r_static
r_struct
id|mv_pci_controller
id|mv_bus0_controller
op_assign
(brace
dot
id|pcic
op_assign
(brace
dot
id|pci_ops
op_assign
op_amp
id|mv_pci_ops
comma
dot
id|mem_resource
op_assign
op_amp
id|mv_pci_mem0_resource
comma
dot
id|io_resource
op_assign
op_amp
id|mv_pci_io_mem0_resource
comma
)brace
comma
dot
id|config_addr
op_assign
id|MV64340_PCI_0_CONFIG_ADDR
comma
dot
id|config_vreg
op_assign
id|MV64340_PCI_0_CONFIG_DATA_VIRTUAL_REG
comma
)brace
suffix:semicolon
DECL|variable|mv_io_base
DECL|variable|mv_io_size
r_static
r_uint32
id|mv_io_base
comma
id|mv_io_size
suffix:semicolon
DECL|function|mv64340_pci0_init
r_static
r_void
id|mv64340_pci0_init
c_func
(paren
r_void
)paren
(brace
r_uint32
id|mem0_base
comma
id|mem0_size
suffix:semicolon
r_uint32
id|io_base
comma
id|io_size
suffix:semicolon
id|io_base
op_assign
id|MV_READ
c_func
(paren
id|MV64340_PCI_0_IO_BASE_ADDR
)paren
op_lshift
l_int|16
suffix:semicolon
id|io_size
op_assign
(paren
id|MV_READ
c_func
(paren
id|MV64340_PCI_0_IO_SIZE
)paren
op_plus
l_int|1
)paren
op_lshift
l_int|16
suffix:semicolon
id|mem0_base
op_assign
id|MV_READ
c_func
(paren
id|MV64340_PCI_0_MEMORY0_BASE_ADDR
)paren
op_lshift
l_int|16
suffix:semicolon
id|mem0_size
op_assign
(paren
id|MV_READ
c_func
(paren
id|MV64340_PCI_0_MEMORY0_SIZE
)paren
op_plus
l_int|1
)paren
op_lshift
l_int|16
suffix:semicolon
id|mv_pci_io_mem0_resource.start
op_assign
l_int|0
suffix:semicolon
id|mv_pci_io_mem0_resource.end
op_assign
id|io_size
op_minus
l_int|1
suffix:semicolon
id|mv_pci_mem0_resource.start
op_assign
id|mem0_base
suffix:semicolon
id|mv_pci_mem0_resource.end
op_assign
id|mem0_base
op_plus
id|mem0_size
op_minus
l_int|1
suffix:semicolon
id|mv_bus0_controller.pcic.mem_offset
op_assign
id|mem0_base
suffix:semicolon
id|mv_bus0_controller.pcic.io_offset
op_assign
l_int|0
suffix:semicolon
id|ioport_resource.end
op_assign
id|io_size
op_minus
l_int|1
suffix:semicolon
id|register_pci_controller
c_func
(paren
op_amp
id|mv_bus0_controller.pcic
)paren
suffix:semicolon
id|mv_io_base
op_assign
id|io_base
suffix:semicolon
id|mv_io_size
op_assign
id|io_size
suffix:semicolon
)brace
DECL|variable|mv_pci_io_mem1_resource
r_static
r_struct
id|resource
id|mv_pci_io_mem1_resource
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;MV64340 PCI1 IO MEM&quot;
comma
dot
id|flags
op_assign
id|IORESOURCE_IO
)brace
suffix:semicolon
DECL|variable|mv_pci_mem1_resource
r_static
r_struct
id|resource
id|mv_pci_mem1_resource
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;MV64340 PCI1 MEM&quot;
comma
dot
id|flags
op_assign
id|IORESOURCE_MEM
)brace
suffix:semicolon
DECL|variable|mv_bus1_controller
r_static
r_struct
id|mv_pci_controller
id|mv_bus1_controller
op_assign
(brace
dot
id|pcic
op_assign
(brace
dot
id|pci_ops
op_assign
op_amp
id|mv_pci_ops
comma
dot
id|mem_resource
op_assign
op_amp
id|mv_pci_mem1_resource
comma
dot
id|io_resource
op_assign
op_amp
id|mv_pci_io_mem1_resource
comma
)brace
comma
dot
id|config_addr
op_assign
id|MV64340_PCI_1_CONFIG_ADDR
comma
dot
id|config_vreg
op_assign
id|MV64340_PCI_1_CONFIG_DATA_VIRTUAL_REG
comma
)brace
suffix:semicolon
DECL|function|mv64340_pci1_init
r_static
id|__init
r_void
id|mv64340_pci1_init
c_func
(paren
r_void
)paren
(brace
r_uint32
id|mem0_base
comma
id|mem0_size
suffix:semicolon
r_uint32
id|io_base
comma
id|io_size
suffix:semicolon
id|io_base
op_assign
id|MV_READ
c_func
(paren
id|MV64340_PCI_1_IO_BASE_ADDR
)paren
op_lshift
l_int|16
suffix:semicolon
id|io_size
op_assign
(paren
id|MV_READ
c_func
(paren
id|MV64340_PCI_1_IO_SIZE
)paren
op_plus
l_int|1
)paren
op_lshift
l_int|16
suffix:semicolon
id|mem0_base
op_assign
id|MV_READ
c_func
(paren
id|MV64340_PCI_1_MEMORY0_BASE_ADDR
)paren
op_lshift
l_int|16
suffix:semicolon
id|mem0_size
op_assign
(paren
id|MV_READ
c_func
(paren
id|MV64340_PCI_1_MEMORY0_SIZE
)paren
op_plus
l_int|1
)paren
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/*&n;&t; * Here we assume the I/O window of second bus to be contiguous with&n;&t; * the first.  A gap is no problem but would waste address space for&n;&t; * remapping the port space.&n;&t; */
id|mv_pci_io_mem1_resource.start
op_assign
id|mv_io_size
suffix:semicolon
id|mv_pci_io_mem1_resource.end
op_assign
id|mv_io_size
op_plus
id|io_size
op_minus
l_int|1
suffix:semicolon
id|mv_pci_mem1_resource.start
op_assign
id|mem0_base
suffix:semicolon
id|mv_pci_mem1_resource.end
op_assign
id|mem0_base
op_plus
id|mem0_size
op_minus
l_int|1
suffix:semicolon
id|mv_bus1_controller.pcic.mem_offset
op_assign
id|mem0_base
suffix:semicolon
id|mv_bus1_controller.pcic.io_offset
op_assign
l_int|0
suffix:semicolon
id|ioport_resource.end
op_assign
id|io_base
op_plus
id|io_size
op_minus
id|mv_io_base
op_minus
l_int|1
suffix:semicolon
id|register_pci_controller
c_func
(paren
op_amp
id|mv_bus1_controller.pcic
)paren
suffix:semicolon
id|mv_io_size
op_assign
id|io_base
op_plus
id|io_size
op_minus
id|mv_io_base
suffix:semicolon
)brace
DECL|function|ocelot_c_pci_init
r_static
id|__init
r_int
id|__init
id|ocelot_c_pci_init
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|io_v_base
suffix:semicolon
r_uint32
id|enable
suffix:semicolon
id|enable
op_assign
op_complement
id|MV_READ
c_func
(paren
id|MV64340_BASE_ADDR_ENABLE
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We require at least one enabled I/O or PCI memory window or we&n;&t; * will ignore this PCI bus.  We ignore PCI windows 1, 2 and 3.&n;&t; */
r_if
c_cond
(paren
id|enable
op_amp
(paren
l_int|0x01
op_lshift
l_int|9
)paren
op_logical_or
id|enable
op_amp
(paren
l_int|0x01
op_lshift
l_int|10
)paren
)paren
id|mv64340_pci0_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|enable
op_amp
(paren
l_int|0x01
op_lshift
l_int|14
)paren
op_logical_or
id|enable
op_amp
(paren
l_int|0x01
op_lshift
l_int|15
)paren
)paren
id|mv64340_pci1_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mv_io_size
)paren
(brace
id|io_v_base
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|mv_io_base
comma
id|mv_io_size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|io_v_base
)paren
id|panic
c_func
(paren
l_string|&quot;Could not ioremap I/O port range&quot;
)paren
suffix:semicolon
id|set_io_port_base
c_func
(paren
id|io_v_base
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ocelot_c_pci_init
id|arch_initcall
c_func
(paren
id|ocelot_c_pci_init
)paren
suffix:semicolon
eof
