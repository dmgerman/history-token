multiline_comment|/*&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Copyright (C) 2000, 2001 Keith M Wesolowski&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;asm/pci.h&gt;
macro_line|#include &lt;asm/ip32/mace.h&gt;
macro_line|#if 0
macro_line|# define DPRINTK(args...) printk(args);
macro_line|#else
DECL|macro|DPRINTK
macro_line|# define DPRINTK(args...)
macro_line|#endif
multiline_comment|/*&n; * O2 has up to 5 PCI devices connected into the MACE bridge.  The device&n; * map looks like this:&n; *&n; * 0  aic7xxx 0&n; * 1  aic7xxx 1&n; * 2  expansion slot&n; * 3  N/C&n; * 4  N/C&n; */
DECL|macro|chkslot
mdefine_line|#define chkslot(_bus,_devfn)&t;&t;&t;&t;&t;&bslash;&n;do {&t;&t;&t;&t;&t;&t;&t;        &bslash;&n;&t;if ((_bus)-&gt;number &gt; 0 || PCI_SLOT (_devfn) &lt; 1&t;&bslash;&n;&t;    || PCI_SLOT (_devfn) &gt; 3)&t;&t;&t;        &bslash;&n;&t;&t;return PCIBIOS_DEVICE_NOT_FOUND;&t;&t;&bslash;&n;} while (0)
DECL|macro|mkaddr
mdefine_line|#define mkaddr(_devfn, _reg) &bslash;&n;((((_devfn) &amp; 0xffUL) &lt;&lt; 8) | ((_reg) &amp; 0xfcUL))
r_static
r_int
DECL|function|mace_pci_read_config
id|mace_pci_read_config
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|reg
comma
r_int
id|size
comma
id|u32
op_star
id|val
)paren
(brace
id|chkslot
c_func
(paren
id|bus
comma
id|devfn
)paren
suffix:semicolon
id|mace-&gt;pci.config_addr
op_assign
id|mkaddr
c_func
(paren
id|devfn
comma
id|reg
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
l_int|1
suffix:colon
op_star
id|val
op_assign
id|mace-&gt;pci.config_data.b
(braket
(paren
id|reg
op_amp
l_int|3
)paren
op_xor
l_int|3
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
op_star
id|val
op_assign
id|mace-&gt;pci.config_data.w
(braket
(paren
(paren
id|reg
op_rshift
l_int|1
)paren
op_amp
l_int|1
)paren
op_xor
l_int|1
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
op_star
id|val
op_assign
id|mace-&gt;pci.config_data.l
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;read%d: reg=%08x,val=%02x&bslash;n&quot;
comma
id|size
op_star
l_int|8
comma
id|reg
comma
op_star
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
r_static
r_int
DECL|function|mace_pci_write_config
id|mace_pci_write_config
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|reg
comma
r_int
id|size
comma
id|u32
id|val
)paren
(brace
id|chkslot
c_func
(paren
id|bus
comma
id|devfn
)paren
suffix:semicolon
id|mace-&gt;pci.config_addr
op_assign
id|mkaddr
c_func
(paren
id|devfn
comma
id|reg
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
l_int|1
suffix:colon
id|mace-&gt;pci.config_data.b
(braket
(paren
id|reg
op_amp
l_int|3
)paren
op_xor
l_int|3
)braket
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|mace-&gt;pci.config_data.w
(braket
(paren
(paren
id|reg
op_rshift
l_int|1
)paren
op_amp
l_int|1
)paren
op_xor
l_int|1
)braket
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|mace-&gt;pci.config_data.l
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;write%d: reg=%08x,val=%02x&bslash;n&quot;
comma
id|size
op_star
l_int|8
comma
id|reg
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|variable|mace_pci_ops
r_struct
id|pci_ops
id|mace_pci_ops
op_assign
(brace
dot
id|read
op_assign
id|mace_pci_read_config
comma
dot
id|write
op_assign
id|mace_pci_write_config
comma
)brace
suffix:semicolon
eof
