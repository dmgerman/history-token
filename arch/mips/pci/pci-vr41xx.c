multiline_comment|/*&n; * FILE NAME&n; *&t;arch/mips/vr41xx/common/pciu.c&n; *&n; * BRIEF MODULE DESCRIPTION&n; *&t;PCI Control Unit routines for the NEC VR4100 series.&n; *&n; * Author: Yoichi Yuasa&n; *         yyuasa@mvista.com or source@mvista.com&n; *&n; * Copyright 2001,2002 MontaVista Software Inc.&n; *&n; *  This program is free software; you can redistribute it and/or modify it&n; *  under the terms of the GNU General Public License as published by the&n; *  Free Software Foundation; either version 2 of the License, or (at your&n; *  option) any later version.&n; *&n; *  THIS SOFTWARE IS PROVIDED ``AS IS&squot;&squot; AND ANY EXPRESS OR IMPLIED&n; *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF&n; *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.&n; *  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,&n; *  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,&n; *  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS&n; *  OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND&n; *  ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR&n; *  TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE&n; *  USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n; *&n; *  You should have received a copy of the GNU General Public License along&n; *  with this program; if not, write to the Free Software Foundation, Inc.,&n; *  675 Mass Ave, Cambridge, MA 02139, USA.&n; */
multiline_comment|/*&n; * Changes:&n; *  Paul Mundt &lt;lethal@chaoticdreams.org&gt;&n; *  - Fix deadlock-causing PCIU access race for VR4131.&n; *&n; *  MontaVista Software Inc. &lt;yyuasa@mvista.com&gt; or &lt;source@mvista.com&gt;&n; *  - New creation, NEC VR4122 and VR4131 are supported.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/cpu.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pci_channel.h&gt;
macro_line|#include &lt;asm/vr41xx/vr41xx.h&gt;
macro_line|#include &quot;pciu.h&quot;
r_extern
r_int
r_int
id|vr41xx_vtclock
suffix:semicolon
DECL|function|vr41xx_pci_config_access
r_static
r_inline
r_int
id|vr41xx_pci_config_access
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
)paren
(brace
r_if
c_cond
(paren
id|bus
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t; * Type 0 configuration&n;&t;&t; */
r_if
c_cond
(paren
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
template_param
l_int|255
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|writel
c_func
(paren
(paren
l_int|1UL
op_lshift
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
)paren
op_or
(paren
id|PCI_FUNC
c_func
(paren
id|devfn
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|where
op_amp
l_int|0xfc
)paren
comma
id|PCICONFAREG
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Type 1 configuration&n;&t;&t; */
r_if
c_cond
(paren
id|where
OG
l_int|255
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|writel
c_func
(paren
(paren
id|bus
op_lshift
l_int|16
)paren
op_or
(paren
id|devfn
op_lshift
l_int|8
)paren
op_or
(paren
id|where
op_amp
l_int|0xfc
)paren
op_or
l_int|1UL
comma
id|PCICONFAREG
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vr41xx_pci_config_read
r_static
r_int
id|vr41xx_pci_config_read
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
op_star
id|val
)paren
(brace
id|u32
id|data
suffix:semicolon
op_star
id|val
op_assign
l_int|0xffffffffUL
suffix:semicolon
r_if
c_cond
(paren
id|vr41xx_pci_config_access
c_func
(paren
id|bus-&gt;number
comma
id|devfn
comma
id|where
)paren
OL
l_int|0
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|data
op_assign
id|readl
c_func
(paren
id|PCICONFDREG
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
l_int|1
suffix:colon
op_star
id|val
op_assign
(paren
id|data
op_rshift
(paren
(paren
id|where
op_amp
l_int|3
)paren
op_lshift
l_int|3
)paren
)paren
op_amp
l_int|0xffUL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
op_star
id|val
op_assign
(paren
id|data
op_rshift
(paren
(paren
id|where
op_amp
l_int|2
)paren
op_lshift
l_int|3
)paren
)paren
op_amp
l_int|0xffffUL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
op_star
id|val
op_assign
id|data
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|PCIBIOS_FUNC_NOT_SUPPORTED
suffix:semicolon
)brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|vr41xx_pci_config_write
r_static
r_int
id|vr41xx_pci_config_write
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
id|val
)paren
(brace
id|u32
id|data
suffix:semicolon
r_int
id|shift
suffix:semicolon
r_if
c_cond
(paren
id|vr41xx_pci_config_access
c_func
(paren
id|bus-&gt;number
comma
id|devfn
comma
id|where
)paren
OL
l_int|0
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|data
op_assign
id|readl
c_func
(paren
id|PCICONFDREG
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
l_int|1
suffix:colon
id|shift
op_assign
(paren
id|where
op_amp
l_int|3
)paren
op_lshift
l_int|3
suffix:semicolon
id|data
op_and_assign
op_complement
(paren
l_int|0xff
op_lshift
id|shift
)paren
suffix:semicolon
id|data
op_or_assign
(paren
(paren
id|val
op_amp
l_int|0xff
)paren
op_lshift
id|shift
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|shift
op_assign
(paren
id|where
op_amp
l_int|2
)paren
op_lshift
l_int|3
suffix:semicolon
id|data
op_and_assign
op_complement
(paren
l_int|0xffff
op_lshift
id|shift
)paren
suffix:semicolon
id|data
op_or_assign
(paren
(paren
id|val
op_amp
l_int|0xffff
)paren
op_lshift
id|shift
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|data
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|PCIBIOS_FUNC_NOT_SUPPORTED
suffix:semicolon
)brace
id|writel
c_func
(paren
id|data
comma
id|PCICONFDREG
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|variable|vr41xx_pci_ops
r_struct
id|pci_ops
id|vr41xx_pci_ops
op_assign
(brace
dot
id|read
op_assign
id|vr41xx_pci_config_read
comma
dot
id|write
op_assign
id|vr41xx_pci_config_write
comma
)brace
suffix:semicolon
DECL|function|vr41xx_pciu_init
r_void
id|__init
id|vr41xx_pciu_init
c_func
(paren
r_struct
id|vr41xx_pci_address_map
op_star
id|map
)paren
(brace
r_struct
id|vr41xx_pci_address_space
op_star
id|s
suffix:semicolon
id|u32
id|config
suffix:semicolon
r_int
id|n
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|map
)paren
r_return
suffix:semicolon
multiline_comment|/* Disable PCI interrupt */
id|writew
c_func
(paren
l_int|0
comma
id|MPCIINTREG
)paren
suffix:semicolon
multiline_comment|/* Supply VTClock to PCIU */
id|vr41xx_clock_supply
c_func
(paren
id|PCIU_CLOCK
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Sleep for 1us after setting MSKPPCIU bit in CMUCLKMSK&n;&t; * before doing any PCIU access to avoid deadlock on VR4131.&n;&t; */
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Select PCI clock */
r_if
c_cond
(paren
id|vr41xx_vtclock
OL
id|MAX_PCI_CLOCK
)paren
id|writel
c_func
(paren
id|EQUAL_VTCLOCK
comma
id|PCICLKSELREG
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|vr41xx_vtclock
op_div
l_int|2
)paren
OL
id|MAX_PCI_CLOCK
)paren
id|writel
c_func
(paren
id|HALF_VTCLOCK
comma
id|PCICLKSELREG
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|vr41xx_vtclock
op_div
l_int|4
)paren
OL
id|MAX_PCI_CLOCK
)paren
id|writel
c_func
(paren
id|QUARTER_VTCLOCK
comma
id|PCICLKSELREG
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Warning: PCI Clock is over 33MHz.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Supply PCI clock by PCI bus */
id|vr41xx_clock_supply
c_func
(paren
id|PCI_CLOCK
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set PCI memory &amp; I/O space address conversion registers&n;&t; * for master transaction.&n;&t; */
r_if
c_cond
(paren
id|map-&gt;mem1
op_ne
l_int|NULL
)paren
(brace
id|s
op_assign
id|map-&gt;mem1
suffix:semicolon
id|config
op_assign
(paren
id|s-&gt;internal_base
op_amp
l_int|0xff000000
)paren
op_or
(paren
(paren
id|s-&gt;address_mask
op_amp
l_int|0x7f000000
)paren
op_rshift
l_int|11
)paren
op_or
(paren
l_int|1UL
op_lshift
l_int|12
)paren
op_or
(paren
(paren
id|s-&gt;pci_base
op_amp
l_int|0xff000000
)paren
op_rshift
l_int|24
)paren
suffix:semicolon
id|writel
c_func
(paren
id|config
comma
id|PCIMMAW1REG
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|map-&gt;mem2
op_ne
l_int|NULL
)paren
(brace
id|s
op_assign
id|map-&gt;mem2
suffix:semicolon
id|config
op_assign
(paren
id|s-&gt;internal_base
op_amp
l_int|0xff000000
)paren
op_or
(paren
(paren
id|s-&gt;address_mask
op_amp
l_int|0x7f000000
)paren
op_rshift
l_int|11
)paren
op_or
(paren
l_int|1UL
op_lshift
l_int|12
)paren
op_or
(paren
(paren
id|s-&gt;pci_base
op_amp
l_int|0xff000000
)paren
op_rshift
l_int|24
)paren
suffix:semicolon
id|writel
c_func
(paren
id|config
comma
id|PCIMMAW2REG
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|map-&gt;io
op_ne
l_int|NULL
)paren
(brace
id|s
op_assign
id|map-&gt;io
suffix:semicolon
id|config
op_assign
(paren
id|s-&gt;internal_base
op_amp
l_int|0xff000000
)paren
op_or
(paren
(paren
id|s-&gt;address_mask
op_amp
l_int|0x7f000000
)paren
op_rshift
l_int|11
)paren
op_or
(paren
l_int|1UL
op_lshift
l_int|12
)paren
op_or
(paren
(paren
id|s-&gt;pci_base
op_amp
l_int|0xff000000
)paren
op_rshift
l_int|24
)paren
suffix:semicolon
id|writel
c_func
(paren
id|config
comma
id|PCIMIOAWREG
)paren
suffix:semicolon
)brace
multiline_comment|/* Set target memory windows */
id|writel
c_func
(paren
l_int|0x00081000
comma
id|PCITAW1REG
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0UL
comma
id|PCITAW2REG
)paren
suffix:semicolon
id|pciu_write_config_dword
c_func
(paren
id|PCI_BASE_ADDRESS_0
comma
l_int|0UL
)paren
suffix:semicolon
id|pciu_write_config_dword
c_func
(paren
id|PCI_BASE_ADDRESS_1
comma
l_int|0UL
)paren
suffix:semicolon
multiline_comment|/* Clear bus error */
id|n
op_assign
id|readl
c_func
(paren
id|BUSERRADREG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current_cpu_data.cputype
op_eq
id|CPU_VR4122
)paren
(brace
id|writel
c_func
(paren
l_int|0UL
comma
id|PCITRDYVREG
)paren
suffix:semicolon
id|pciu_write_config_dword
c_func
(paren
id|PCI_CACHE_LINE_SIZE
comma
l_int|0x0000f804
)paren
suffix:semicolon
)brace
r_else
(brace
id|writel
c_func
(paren
l_int|100UL
comma
id|PCITRDYVREG
)paren
suffix:semicolon
id|pciu_write_config_dword
c_func
(paren
id|PCI_CACHE_LINE_SIZE
comma
l_int|0x00008004
)paren
suffix:semicolon
)brace
id|writel
c_func
(paren
id|CONFIG_DONE
comma
id|PCIENREG
)paren
suffix:semicolon
id|pciu_write_config_dword
c_func
(paren
id|PCI_COMMAND
comma
id|PCI_COMMAND_IO
op_or
id|PCI_COMMAND_MEMORY
op_or
id|PCI_COMMAND_MASTER
op_or
id|PCI_COMMAND_PARITY
op_or
id|PCI_COMMAND_SERR
)paren
suffix:semicolon
)brace
eof
