multiline_comment|/*&n; *  pci-vr41xx.c, PCI Control Unit routines for the NEC VR4100 series.&n; *&n; *  Copyright (C) 2001-2003 MontaVista Software Inc.&n; *    Author: Yoichi Yuasa &lt;yyuasa@mvista.com or source@mvista.com&gt;&n; *  Copyright (C) 2004  Yoichi Yuasa &lt;yuasa@hh.iij4u.or.jp&gt;&n; * Copyright (C) 2004 by Ralf Baechle (ralf@linux-mips.org)&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
multiline_comment|/*&n; * Changes:&n; *  MontaVista Software Inc. &lt;yyuasa@mvista.com&gt; or &lt;source@mvista.com&gt;&n; *  - New creation, NEC VR4122 and VR4131 are supported.&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;asm/cpu.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/vr41xx/vr41xx.h&gt;
macro_line|#include &quot;pci-vr41xx.h&quot;
r_extern
r_struct
id|pci_ops
id|vr41xx_pci_ops
suffix:semicolon
DECL|variable|pci_master_memory1
r_static
r_struct
id|pci_master_address_conversion
id|pci_master_memory1
op_assign
(brace
dot
id|bus_base_address
op_assign
id|PCI_MASTER_MEM1_BUS_BASE_ADDRESS
comma
dot
id|address_mask
op_assign
id|PCI_MASTER_MEM1_ADDRESS_MASK
comma
dot
id|pci_base_address
op_assign
id|PCI_MASTER_MEM1_PCI_BASE_ADDRESS
comma
)brace
suffix:semicolon
DECL|variable|pci_target_memory1
r_static
r_struct
id|pci_target_address_conversion
id|pci_target_memory1
op_assign
(brace
dot
id|address_mask
op_assign
id|PCI_TARGET_MEM1_ADDRESS_MASK
comma
dot
id|bus_base_address
op_assign
id|PCI_TARGET_MEM1_BUS_BASE_ADDRESS
comma
)brace
suffix:semicolon
DECL|variable|pci_master_io
r_static
r_struct
id|pci_master_address_conversion
id|pci_master_io
op_assign
(brace
dot
id|bus_base_address
op_assign
id|PCI_MASTER_IO_BUS_BASE_ADDRESS
comma
dot
id|address_mask
op_assign
id|PCI_MASTER_IO_ADDRESS_MASK
comma
dot
id|pci_base_address
op_assign
id|PCI_MASTER_IO_PCI_BASE_ADDRESS
comma
)brace
suffix:semicolon
DECL|variable|pci_mailbox
r_static
r_struct
id|pci_mailbox_address
id|pci_mailbox
op_assign
(brace
dot
id|base_address
op_assign
id|PCI_MAILBOX_BASE_ADDRESS
comma
)brace
suffix:semicolon
DECL|variable|pci_target_window1
r_static
r_struct
id|pci_target_address_window
id|pci_target_window1
op_assign
(brace
dot
id|base_address
op_assign
id|PCI_TARGET_WINDOW1_BASE_ADDRESS
comma
)brace
suffix:semicolon
DECL|variable|pci_mem_resource
r_static
r_struct
id|resource
id|pci_mem_resource
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;PCI Memory resources&quot;
comma
dot
id|start
op_assign
id|PCI_MEM_RESOURCE_START
comma
dot
id|end
op_assign
id|PCI_MEM_RESOURCE_END
comma
dot
id|flags
op_assign
id|IORESOURCE_MEM
comma
)brace
suffix:semicolon
DECL|variable|pci_io_resource
r_static
r_struct
id|resource
id|pci_io_resource
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;PCI I/O resources&quot;
comma
dot
id|start
op_assign
id|PCI_IO_RESOURCE_START
comma
dot
id|end
op_assign
id|PCI_IO_RESOURCE_END
comma
dot
id|flags
op_assign
id|IORESOURCE_IO
comma
)brace
suffix:semicolon
DECL|variable|vr41xx_pci_controller_unit_setup
r_static
r_struct
id|pci_controller_unit_setup
id|vr41xx_pci_controller_unit_setup
op_assign
(brace
dot
id|master_memory1
op_assign
op_amp
id|pci_master_memory1
comma
dot
id|target_memory1
op_assign
op_amp
id|pci_target_memory1
comma
dot
id|master_io
op_assign
op_amp
id|pci_master_io
comma
dot
id|exclusive_access
op_assign
id|CANNOT_LOCK_FROM_DEVICE
comma
dot
id|wait_time_limit_from_irdy_to_trdy
op_assign
l_int|0
comma
dot
id|mailbox
op_assign
op_amp
id|pci_mailbox
comma
dot
id|target_window1
op_assign
op_amp
id|pci_target_window1
comma
dot
id|master_latency_timer
op_assign
l_int|0x80
comma
dot
id|retry_limit
op_assign
l_int|0
comma
dot
id|arbiter_priority_control
op_assign
id|PCI_ARBITRATION_MODE_FAIR
comma
dot
id|take_away_gnt_mode
op_assign
id|PCI_TAKE_AWAY_GNT_DISABLE
comma
)brace
suffix:semicolon
DECL|variable|vr41xx_pci_controller
r_static
r_struct
id|pci_controller
id|vr41xx_pci_controller
op_assign
(brace
dot
id|pci_ops
op_assign
op_amp
id|vr41xx_pci_ops
comma
dot
id|mem_resource
op_assign
op_amp
id|pci_mem_resource
comma
dot
id|io_resource
op_assign
op_amp
id|pci_io_resource
comma
)brace
suffix:semicolon
DECL|function|vr41xx_pciu_setup
r_void
id|__init
id|vr41xx_pciu_setup
c_func
(paren
r_struct
id|pci_controller_unit_setup
op_star
id|setup
)paren
(brace
id|vr41xx_pci_controller_unit_setup
op_assign
op_star
id|setup
suffix:semicolon
)brace
DECL|function|vr41xx_pciu_init
r_static
r_int
id|__init
id|vr41xx_pciu_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_controller_unit_setup
op_star
id|setup
suffix:semicolon
r_struct
id|pci_master_address_conversion
op_star
id|master
suffix:semicolon
r_struct
id|pci_target_address_conversion
op_star
id|target
suffix:semicolon
r_struct
id|pci_mailbox_address
op_star
id|mailbox
suffix:semicolon
r_struct
id|pci_target_address_window
op_star
id|window
suffix:semicolon
r_int
r_int
id|vtclock
comma
id|pci_clock_max
suffix:semicolon
r_uint32
id|val
suffix:semicolon
id|setup
op_assign
op_amp
id|vr41xx_pci_controller_unit_setup
suffix:semicolon
multiline_comment|/* Disable PCI interrupt */
id|vr41xx_disable_pciint
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Supply VTClock to PCIU */
id|vr41xx_supply_clock
c_func
(paren
id|PCIU_CLOCK
)paren
suffix:semicolon
multiline_comment|/* Dummy write, waiting for supply of VTClock. */
id|vr41xx_disable_pciint
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Select PCI clock */
r_if
c_cond
(paren
id|setup-&gt;pci_clock_max
op_ne
l_int|0
)paren
id|pci_clock_max
op_assign
id|setup-&gt;pci_clock_max
suffix:semicolon
r_else
id|pci_clock_max
op_assign
id|PCI_CLOCK_MAX
suffix:semicolon
id|vtclock
op_assign
id|vr41xx_get_vtclock_frequency
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vtclock
OL
id|pci_clock_max
)paren
id|writel
c_func
(paren
id|EQUAL_VTCLOCK
comma
id|PCICLKSELREG
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|vtclock
op_div
l_int|2
)paren
OL
id|pci_clock_max
)paren
id|writel
c_func
(paren
id|HALF_VTCLOCK
comma
id|PCICLKSELREG
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|current_cpu_data.processor_id
op_ge
id|PRID_VR4131_REV2_1
op_logical_and
(paren
id|vtclock
op_div
l_int|3
)paren
OL
id|pci_clock_max
)paren
id|writel
c_func
(paren
id|ONE_THIRD_VTCLOCK
comma
id|PCICLKSELREG
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|vtclock
op_div
l_int|4
)paren
OL
id|pci_clock_max
)paren
id|writel
c_func
(paren
id|QUARTER_VTCLOCK
comma
id|PCICLKSELREG
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PCI Clock is over 33MHz.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Supply PCI clock by PCI bus */
id|vr41xx_supply_clock
c_func
(paren
id|PCI_CLOCK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|setup-&gt;master_memory1
op_ne
l_int|NULL
)paren
(brace
id|master
op_assign
id|setup-&gt;master_memory1
suffix:semicolon
id|val
op_assign
id|IBA
c_func
(paren
id|master-&gt;bus_base_address
)paren
op_or
id|MASTER_MSK
c_func
(paren
id|master-&gt;address_mask
)paren
op_or
id|WINEN
op_or
id|PCIA
c_func
(paren
id|master-&gt;pci_base_address
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|PCIMMAW1REG
)paren
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
id|readl
c_func
(paren
id|PCIMMAW1REG
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
id|WINEN
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|PCIMMAW1REG
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|setup-&gt;master_memory2
op_ne
l_int|NULL
)paren
(brace
id|master
op_assign
id|setup-&gt;master_memory2
suffix:semicolon
id|val
op_assign
id|IBA
c_func
(paren
id|master-&gt;bus_base_address
)paren
op_or
id|MASTER_MSK
c_func
(paren
id|master-&gt;address_mask
)paren
op_or
id|WINEN
op_or
id|PCIA
c_func
(paren
id|master-&gt;pci_base_address
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|PCIMMAW2REG
)paren
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
id|readl
c_func
(paren
id|PCIMMAW2REG
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
id|WINEN
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|PCIMMAW2REG
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|setup-&gt;target_memory1
op_ne
l_int|NULL
)paren
(brace
id|target
op_assign
id|setup-&gt;target_memory1
suffix:semicolon
id|val
op_assign
id|TARGET_MSK
c_func
(paren
id|target-&gt;address_mask
)paren
op_or
id|WINEN
op_or
id|ITA
c_func
(paren
id|target-&gt;bus_base_address
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|PCITAW1REG
)paren
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
id|readl
c_func
(paren
id|PCITAW1REG
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
id|WINEN
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|PCITAW1REG
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|setup-&gt;target_memory2
op_ne
l_int|NULL
)paren
(brace
id|target
op_assign
id|setup-&gt;target_memory2
suffix:semicolon
id|val
op_assign
id|TARGET_MSK
c_func
(paren
id|target-&gt;address_mask
)paren
op_or
id|WINEN
op_or
id|ITA
c_func
(paren
id|target-&gt;bus_base_address
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|PCITAW2REG
)paren
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
id|readl
c_func
(paren
id|PCITAW2REG
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
id|WINEN
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|PCITAW2REG
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|setup-&gt;master_io
op_ne
l_int|NULL
)paren
(brace
id|master
op_assign
id|setup-&gt;master_io
suffix:semicolon
id|val
op_assign
id|IBA
c_func
(paren
id|master-&gt;bus_base_address
)paren
op_or
id|MASTER_MSK
c_func
(paren
id|master-&gt;address_mask
)paren
op_or
id|WINEN
op_or
id|PCIIA
c_func
(paren
id|master-&gt;pci_base_address
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|PCIMIOAWREG
)paren
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
id|readl
c_func
(paren
id|PCIMIOAWREG
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
id|WINEN
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|PCIMIOAWREG
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|setup-&gt;exclusive_access
op_eq
id|CANNOT_LOCK_FROM_DEVICE
)paren
id|writel
c_func
(paren
id|UNLOCK
comma
id|PCIEXACCREG
)paren
suffix:semicolon
r_else
id|writel
c_func
(paren
l_int|0
comma
id|PCIEXACCREG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current_cpu_data.cputype
op_eq
id|CPU_VR4122
)paren
id|writel
c_func
(paren
id|TRDYV
c_func
(paren
id|setup-&gt;wait_time_limit_from_irdy_to_trdy
)paren
comma
id|PCITRDYVREG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MLTIM
c_func
(paren
id|setup-&gt;master_latency_timer
)paren
comma
id|LATTIMEREG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|setup-&gt;mailbox
op_ne
l_int|NULL
)paren
(brace
id|mailbox
op_assign
id|setup-&gt;mailbox
suffix:semicolon
id|val
op_assign
id|MBADD
c_func
(paren
id|mailbox-&gt;base_address
)paren
op_or
id|TYPE_32BITSPACE
op_or
id|MSI_MEMORY
op_or
id|PREF_APPROVAL
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|MAILBAREG
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|setup-&gt;target_window1
)paren
(brace
id|window
op_assign
id|setup-&gt;target_window1
suffix:semicolon
id|val
op_assign
id|PMBA
c_func
(paren
id|window-&gt;base_address
)paren
op_or
id|TYPE_32BITSPACE
op_or
id|MSI_MEMORY
op_or
id|PREF_APPROVAL
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|PCIMBA1REG
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|setup-&gt;target_window2
)paren
(brace
id|window
op_assign
id|setup-&gt;target_window2
suffix:semicolon
id|val
op_assign
id|PMBA
c_func
(paren
id|window-&gt;base_address
)paren
op_or
id|TYPE_32BITSPACE
op_or
id|MSI_MEMORY
op_or
id|PREF_APPROVAL
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|PCIMBA2REG
)paren
suffix:semicolon
)brace
id|val
op_assign
id|readl
c_func
(paren
id|RETVALREG
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
id|RTYVAL_MASK
suffix:semicolon
id|val
op_or_assign
id|RTYVAL
c_func
(paren
id|setup-&gt;retry_limit
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|RETVALREG
)paren
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|PCIAPCNTREG
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
(paren
id|TKYGNT
op_or
id|PAPC
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|setup-&gt;arbiter_priority_control
)paren
(brace
r_case
id|PCI_ARBITRATION_MODE_ALTERNATE_0
suffix:colon
id|val
op_or_assign
id|PAPC_ALTERNATE_0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_ARBITRATION_MODE_ALTERNATE_B
suffix:colon
id|val
op_or_assign
id|PAPC_ALTERNATE_B
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|val
op_or_assign
id|PAPC_FAIR
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|setup-&gt;take_away_gnt_mode
op_eq
id|PCI_TAKE_AWAY_GNT_ENABLE
)paren
id|val
op_or_assign
id|TKYGNT_ENABLE
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|PCIAPCNTREG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|PCI_COMMAND_IO
op_or
id|PCI_COMMAND_MEMORY
op_or
id|PCI_COMMAND_MASTER
op_or
id|PCI_COMMAND_PARITY
op_or
id|PCI_COMMAND_SERR
comma
id|COMMANDREG
)paren
suffix:semicolon
multiline_comment|/* Clear bus error */
id|readl
c_func
(paren
id|BUSERRADREG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|CONFIG_DONE
comma
id|PCIENREG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|setup-&gt;mem_resource
op_ne
l_int|NULL
)paren
id|vr41xx_pci_controller.mem_resource
op_assign
id|setup-&gt;mem_resource
suffix:semicolon
r_if
c_cond
(paren
id|setup-&gt;io_resource
op_ne
l_int|NULL
)paren
(brace
id|vr41xx_pci_controller.io_resource
op_assign
id|setup-&gt;io_resource
suffix:semicolon
)brace
r_else
(brace
id|set_io_port_base
c_func
(paren
id|IO_PORT_BASE
)paren
suffix:semicolon
id|ioport_resource.start
op_assign
id|IO_PORT_RESOURCE_START
suffix:semicolon
id|ioport_resource.end
op_assign
id|IO_PORT_RESOURCE_END
suffix:semicolon
)brace
id|register_pci_controller
c_func
(paren
op_amp
id|vr41xx_pci_controller
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|vr41xx_pciu_init
id|early_initcall
c_func
(paren
id|vr41xx_pciu_init
)paren
suffix:semicolon
eof
