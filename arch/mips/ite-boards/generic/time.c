multiline_comment|/*&n; * Carsten Langgaard, carstenl@mips.com&n; * Copyright (C) 1999,2000 MIPS Technologies, Inc.  All rights reserved.&n; *&n; * Copyright (C) 2003 MontaVista Software Inc.&n; * Author: Jun Sun, jsun@mvista.com or jsun@junsun.net&n; *&n; * ########################################################################&n; *&n; *  This program is free software; you can distribute it and/or modify it&n; *  under the terms of the GNU General Public License (Version 2) as&n; *  published by the Free Software Foundation.&n; *&n; *  This program is distributed in the hope it will be useful, but WITHOUT&n; *  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or&n; *  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License&n; *  for more details.&n; *&n; *  You should have received a copy of the GNU General Public License along&n; *  with this program; if not, write to the Free Software Foundation, Inc.,&n; *  59 Temple Place - Suite 330, Boston MA 02111-1307, USA.&n; *&n; * ########################################################################&n; *&n; * Setting up the clock on the MIPS boards.&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel_stat.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/mc146818rtc.h&gt;
macro_line|#include &lt;asm/time.h&gt;
macro_line|#include &lt;asm/mipsregs.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/it8172/it8172.h&gt;
macro_line|#include &lt;asm/it8172/it8172_int.h&gt;
macro_line|#include &lt;asm/debug.h&gt;
DECL|macro|IT8172_RTC_ADR_REG
mdefine_line|#define IT8172_RTC_ADR_REG  (IT8172_PCI_IO_BASE + IT_RTC_BASE)
DECL|macro|IT8172_RTC_DAT_REG
mdefine_line|#define IT8172_RTC_DAT_REG  (IT8172_RTC_ADR_REG + 1)
DECL|macro|IT8172_RTC_CENTURY_REG
mdefine_line|#define IT8172_RTC_CENTURY_REG  (IT8172_PCI_IO_BASE + IT_RTC_CENTURY)
DECL|variable|rtc_adr_reg
r_static
r_volatile
r_char
op_star
id|rtc_adr_reg
op_assign
(paren
r_char
op_star
)paren
id|KSEG1ADDR
c_func
(paren
id|IT8172_RTC_ADR_REG
)paren
suffix:semicolon
DECL|variable|rtc_dat_reg
r_static
r_volatile
r_char
op_star
id|rtc_dat_reg
op_assign
(paren
r_char
op_star
)paren
id|KSEG1ADDR
c_func
(paren
id|IT8172_RTC_DAT_REG
)paren
suffix:semicolon
DECL|variable|rtc_century_reg
r_static
r_volatile
r_char
op_star
id|rtc_century_reg
op_assign
(paren
r_char
op_star
)paren
id|KSEG1ADDR
c_func
(paren
id|IT8172_RTC_CENTURY_REG
)paren
suffix:semicolon
DECL|function|it8172_rtc_read_data
r_int
r_char
id|it8172_rtc_read_data
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_int
r_char
id|retval
suffix:semicolon
op_star
id|rtc_adr_reg
op_assign
id|addr
suffix:semicolon
id|retval
op_assign
op_star
id|rtc_dat_reg
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|it8172_rtc_write_data
r_void
id|it8172_rtc_write_data
c_func
(paren
r_int
r_char
id|data
comma
r_int
r_int
id|addr
)paren
(brace
op_star
id|rtc_adr_reg
op_assign
id|addr
suffix:semicolon
op_star
id|rtc_dat_reg
op_assign
id|data
suffix:semicolon
)brace
DECL|macro|CMOS_READ
macro_line|#undef &t;CMOS_READ
DECL|macro|CMOS_WRITE
macro_line|#undef &t;CMOS_WRITE
DECL|macro|CMOS_READ
mdefine_line|#define&t;CMOS_READ(addr)&t;&t;&t;it8172_rtc_read_data(addr)
DECL|macro|CMOS_WRITE
mdefine_line|#define CMOS_WRITE(data, addr) &t;&t;it8172_rtc_write_data(data, addr)
DECL|variable|saved_control
r_static
r_int
r_char
id|saved_control
suffix:semicolon
multiline_comment|/* remember rtc control reg */
DECL|function|rtc_24h
r_static
r_inline
r_int
id|rtc_24h
c_func
(paren
r_void
)paren
(brace
r_return
id|saved_control
op_amp
id|RTC_24H
suffix:semicolon
)brace
DECL|function|rtc_dm_binary
r_static
r_inline
r_int
id|rtc_dm_binary
c_func
(paren
r_void
)paren
(brace
r_return
id|saved_control
op_amp
id|RTC_DM_BINARY
suffix:semicolon
)brace
r_static
r_inline
r_int
r_char
DECL|function|bin_to_hw
id|bin_to_hw
c_func
(paren
r_int
r_char
id|c
)paren
(brace
r_if
c_cond
(paren
id|rtc_dm_binary
c_func
(paren
)paren
)paren
r_return
id|c
suffix:semicolon
r_else
r_return
(paren
(paren
id|c
op_div
l_int|10
)paren
op_lshift
l_int|4
)paren
op_plus
(paren
id|c
op_mod
l_int|10
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
r_char
DECL|function|hw_to_bin
id|hw_to_bin
c_func
(paren
r_int
r_char
id|c
)paren
(brace
r_if
c_cond
(paren
id|rtc_dm_binary
c_func
(paren
)paren
)paren
r_return
id|c
suffix:semicolon
r_else
r_return
(paren
id|c
op_rshift
l_int|4
)paren
op_star
l_int|10
op_plus
(paren
id|c
op_amp
l_int|0xf
)paren
suffix:semicolon
)brace
multiline_comment|/* 0x80 bit indicates pm in 12-hour format */
r_static
r_inline
r_int
r_char
DECL|function|hour_bin_to_hw
id|hour_bin_to_hw
c_func
(paren
r_int
r_char
id|c
)paren
(brace
r_if
c_cond
(paren
id|rtc_24h
c_func
(paren
)paren
)paren
r_return
id|bin_to_hw
c_func
(paren
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_ge
l_int|12
)paren
r_return
l_int|0x80
op_or
id|bin_to_hw
c_func
(paren
(paren
id|c
op_eq
l_int|12
)paren
ques
c_cond
l_int|12
suffix:colon
id|c
op_minus
l_int|12
)paren
suffix:semicolon
multiline_comment|/* 12 is 12pm */
r_else
r_return
id|bin_to_hw
c_func
(paren
(paren
id|c
op_eq
l_int|0
)paren
ques
c_cond
l_int|12
suffix:colon
id|c
)paren
suffix:semicolon
multiline_comment|/* 0 is 12 AM, not 0 am */
)brace
r_static
r_inline
r_int
r_char
DECL|function|hour_hw_to_bin
id|hour_hw_to_bin
c_func
(paren
r_int
r_char
id|c
)paren
(brace
r_int
r_char
id|tmp
op_assign
id|hw_to_bin
c_func
(paren
id|c
op_amp
l_int|0x3f
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rtc_24h
c_func
(paren
)paren
)paren
r_return
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|c
op_amp
l_int|0x80
)paren
r_return
(paren
id|tmp
op_eq
l_int|12
)paren
ques
c_cond
l_int|12
suffix:colon
id|tmp
op_plus
l_int|12
suffix:semicolon
multiline_comment|/* 12pm is 12, not 24 */
r_else
r_return
(paren
id|tmp
op_eq
l_int|12
)paren
ques
c_cond
l_int|0
suffix:colon
id|tmp
suffix:semicolon
multiline_comment|/* 12am is 0 */
)brace
DECL|variable|r4k_offset
r_static
r_int
r_int
id|r4k_offset
suffix:semicolon
multiline_comment|/* Amount to increment compare reg each time */
DECL|variable|r4k_cur
r_static
r_int
r_int
id|r4k_cur
suffix:semicolon
multiline_comment|/* What counter should be at next timer irq */
r_extern
r_int
r_int
id|mips_counter_frequency
suffix:semicolon
multiline_comment|/*&n; * Figure out the r4k offset, the amount to increment the compare&n; * register for each time tick.&n; * Use the RTC to calculate offset.&n; */
DECL|function|cal_r4koff
r_static
r_int
r_int
id|__init
id|cal_r4koff
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Start counter exactly on falling edge of update flag */
r_while
c_loop
(paren
id|CMOS_READ
c_func
(paren
id|RTC_REG_A
)paren
op_amp
id|RTC_UIP
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|CMOS_READ
c_func
(paren
id|RTC_REG_A
)paren
op_amp
id|RTC_UIP
)paren
)paren
suffix:semicolon
multiline_comment|/* Start r4k counter. */
id|write_c0_count
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Read counter exactly on falling edge of update flag */
r_while
c_loop
(paren
id|CMOS_READ
c_func
(paren
id|RTC_REG_A
)paren
op_amp
id|RTC_UIP
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|CMOS_READ
c_func
(paren
id|RTC_REG_A
)paren
op_amp
id|RTC_UIP
)paren
)paren
suffix:semicolon
id|mips_counter_frequency
op_assign
id|read_c0_count
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* restore interrupts */
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
(paren
id|mips_counter_frequency
op_div
id|HZ
)paren
suffix:semicolon
)brace
r_static
r_int
r_int
DECL|function|it8172_rtc_get_time
id|it8172_rtc_get_time
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|year
comma
id|mon
comma
id|day
comma
id|hour
comma
id|min
comma
id|sec
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* avoid update-in-progress. */
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|CMOS_READ
c_func
(paren
id|RTC_REG_A
)paren
op_amp
id|RTC_UIP
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* don&squot;t hold intr closed all the time */
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Read regs. */
id|sec
op_assign
id|hw_to_bin
c_func
(paren
id|CMOS_READ
c_func
(paren
id|RTC_SECONDS
)paren
)paren
suffix:semicolon
id|min
op_assign
id|hw_to_bin
c_func
(paren
id|CMOS_READ
c_func
(paren
id|RTC_MINUTES
)paren
)paren
suffix:semicolon
id|hour
op_assign
id|hour_hw_to_bin
c_func
(paren
id|CMOS_READ
c_func
(paren
id|RTC_HOURS
)paren
)paren
suffix:semicolon
id|day
op_assign
id|hw_to_bin
c_func
(paren
id|CMOS_READ
c_func
(paren
id|RTC_DAY_OF_MONTH
)paren
)paren
suffix:semicolon
id|mon
op_assign
id|hw_to_bin
c_func
(paren
id|CMOS_READ
c_func
(paren
id|RTC_MONTH
)paren
)paren
suffix:semicolon
id|year
op_assign
id|hw_to_bin
c_func
(paren
id|CMOS_READ
c_func
(paren
id|RTC_YEAR
)paren
)paren
op_plus
id|hw_to_bin
c_func
(paren
op_star
id|rtc_century_reg
)paren
op_star
l_int|100
suffix:semicolon
multiline_comment|/* restore interrupts */
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|mktime
c_func
(paren
id|year
comma
id|mon
comma
id|day
comma
id|hour
comma
id|min
comma
id|sec
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|it8172_rtc_set_time
id|it8172_rtc_set_time
c_func
(paren
r_int
r_int
id|t
)paren
(brace
r_struct
id|rtc_time
id|tm
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* convert */
id|to_tm
c_func
(paren
id|t
comma
op_amp
id|tm
)paren
suffix:semicolon
multiline_comment|/* avoid update-in-progress. */
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|CMOS_READ
c_func
(paren
id|RTC_REG_A
)paren
op_amp
id|RTC_UIP
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* don&squot;t hold intr closed all the time */
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
op_star
id|rtc_century_reg
op_assign
id|bin_to_hw
c_func
(paren
id|tm.tm_year
op_div
l_int|100
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|bin_to_hw
c_func
(paren
id|tm.tm_sec
)paren
comma
id|RTC_SECONDS
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|bin_to_hw
c_func
(paren
id|tm.tm_min
)paren
comma
id|RTC_MINUTES
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|hour_bin_to_hw
c_func
(paren
id|tm.tm_hour
)paren
comma
id|RTC_HOURS
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|bin_to_hw
c_func
(paren
id|tm.tm_mday
)paren
comma
id|RTC_DAY_OF_MONTH
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|bin_to_hw
c_func
(paren
id|tm.tm_mon
op_plus
l_int|1
)paren
comma
id|RTC_MONTH
)paren
suffix:semicolon
multiline_comment|/* tm_mon starts from 0 */
id|CMOS_WRITE
c_func
(paren
id|bin_to_hw
c_func
(paren
id|tm.tm_year
op_mod
l_int|100
)paren
comma
id|RTC_YEAR
)paren
suffix:semicolon
multiline_comment|/* restore interrupts */
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|it8172_time_init
r_void
id|__init
id|it8172_time_init
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|est_freq
comma
id|flags
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|saved_control
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_CONTROL
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;calculating r4koff... &quot;
)paren
suffix:semicolon
id|r4k_offset
op_assign
id|cal_r4koff
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%08lx(%d)&bslash;n&quot;
comma
id|r4k_offset
comma
(paren
r_int
)paren
id|r4k_offset
)paren
suffix:semicolon
id|est_freq
op_assign
l_int|2
op_star
id|r4k_offset
op_star
id|HZ
suffix:semicolon
id|est_freq
op_add_assign
l_int|5000
suffix:semicolon
multiline_comment|/* round */
id|est_freq
op_sub_assign
id|est_freq
op_mod
l_int|10000
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;CPU frequency %d.%02d MHz&bslash;n&quot;
comma
id|est_freq
op_div
l_int|1000000
comma
(paren
id|est_freq
op_mod
l_int|1000000
)paren
op_star
l_int|100
op_div
l_int|1000000
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
id|rtc_get_time
op_assign
id|it8172_rtc_get_time
suffix:semicolon
id|rtc_set_time
op_assign
id|it8172_rtc_set_time
suffix:semicolon
)brace
DECL|macro|ALLINTS
mdefine_line|#define ALLINTS (IE_IRQ0 | IE_IRQ1 | IE_IRQ2 | IE_IRQ3 | IE_IRQ4 | IE_IRQ5)
DECL|function|it8172_timer_setup
r_void
id|__init
id|it8172_timer_setup
c_func
(paren
r_struct
id|irqaction
op_star
id|irq
)paren
(brace
id|puts
c_func
(paren
l_string|&quot;timer_setup&bslash;n&quot;
)paren
suffix:semicolon
id|put32
c_func
(paren
id|NR_IRQS
)paren
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
multiline_comment|/* we are using the cpu counter for timer interrupts */
id|setup_irq
c_func
(paren
id|MIPS_CPU_TIMER_IRQ
comma
id|irq
)paren
suffix:semicolon
multiline_comment|/* to generate the first timer interrupt */
id|r4k_cur
op_assign
(paren
id|read_c0_count
c_func
(paren
)paren
op_plus
id|r4k_offset
)paren
suffix:semicolon
id|write_c0_compare
c_func
(paren
id|r4k_cur
)paren
suffix:semicolon
id|set_c0_status
c_func
(paren
id|ALLINTS
)paren
suffix:semicolon
)brace
eof
