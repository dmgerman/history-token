multiline_comment|/*&n; * Carsten Langgaard, carstenl@mips.com&n; * Copyright (C) 2000, 2001 MIPS Technologies, Inc.&n; * Copyright (C) 2001 Ralf Baechle&n; *&n; *  This program is free software; you can distribute it and/or modify it&n; *  under the terms of the GNU General Public License (Version 2) as&n; *  published by the Free Software Foundation.&n; *&n; *  This program is distributed in the hope it will be useful, but WITHOUT&n; *  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or&n; *  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License&n; *  for more details.&n; *&n; *  You should have received a copy of the GNU General Public License along&n; *  with this program; if not, write to the Free Software Foundation, Inc.,&n; *  59 Temple Place - Suite 330, Boston MA 02111-1307, USA.&n; *&n; * Routines for generic manipulation of the interrupts found on the MIPS&n; * Malta board.&n; * The interrupt controller is located in the South Bridge a PIIX4 device&n; * with two internal 82C95 interrupt controllers.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/kernel_stat.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;asm/i8259.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/mips-boards/malta.h&gt;
macro_line|#include &lt;asm/mips-boards/maltaint.h&gt;
macro_line|#include &lt;asm/mips-boards/piix4.h&gt;
macro_line|#include &lt;asm/gt64120.h&gt;
macro_line|#include &lt;asm/mips-boards/generic.h&gt;
macro_line|#include &lt;asm/mips-boards/msc01_pci.h&gt;
r_extern
id|asmlinkage
r_void
id|mipsIRQ
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|variable|mips_irq_lock
r_static
id|spinlock_t
id|mips_irq_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|function|mips_pcibios_iack
r_static
r_inline
r_int
id|mips_pcibios_iack
c_func
(paren
r_void
)paren
(brace
r_int
id|irq
suffix:semicolon
id|u32
id|dummy
suffix:semicolon
multiline_comment|/*&n;&t; * Determine highest priority pending interrupt by performing&n;&t; * a PCI Interrupt Acknowledge cycle.&n;&t; */
r_switch
c_cond
(paren
id|mips_revision_corid
)paren
(brace
r_case
id|MIPS_REVISION_CORID_CORE_MSC
suffix:colon
r_case
id|MIPS_REVISION_CORID_CORE_FPGA2
suffix:colon
r_case
id|MIPS_REVISION_CORID_CORE_EMUL_MSC
suffix:colon
id|MSC_READ
c_func
(paren
id|MSC01_PCI_IACK
comma
id|irq
)paren
suffix:semicolon
id|irq
op_and_assign
l_int|0xff
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIPS_REVISION_CORID_QED_RM5261
suffix:colon
r_case
id|MIPS_REVISION_CORID_CORE_LV
suffix:colon
r_case
id|MIPS_REVISION_CORID_CORE_FPGA
suffix:colon
r_case
id|MIPS_REVISION_CORID_CORE_FPGAR2
suffix:colon
id|irq
op_assign
id|GT_READ
c_func
(paren
id|GT_PCI0_IACK_OFS
)paren
suffix:semicolon
id|irq
op_and_assign
l_int|0xff
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIPS_REVISION_CORID_BONITO64
suffix:colon
r_case
id|MIPS_REVISION_CORID_CORE_20K
suffix:colon
r_case
id|MIPS_REVISION_CORID_CORE_EMUL_BON
suffix:colon
multiline_comment|/* The following will generate a PCI IACK cycle on the&n;&t;&t; * Bonito controller. It&squot;s a little bit kludgy, but it&n;&t;&t; * was the easiest way to implement it in hardware at&n;&t;&t; * the given time.&n;&t;&t; */
id|BONITO_PCIMAP_CFG
op_assign
l_int|0x20000
suffix:semicolon
multiline_comment|/* Flush Bonito register block */
id|dummy
op_assign
id|BONITO_PCIMAP_CFG
suffix:semicolon
id|iob
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* sync */
id|irq
op_assign
op_star
(paren
r_volatile
id|u32
op_star
)paren
(paren
id|_pcictrl_bonito_pcicfg
)paren
suffix:semicolon
id|iob
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* sync */
id|irq
op_and_assign
l_int|0xff
suffix:semicolon
id|BONITO_PCIMAP_CFG
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Unknown Core card, don&squot;t know the system controller.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
id|irq
suffix:semicolon
)brace
DECL|function|get_int
r_static
r_inline
r_int
id|get_int
c_func
(paren
r_int
op_star
id|irq
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mips_irq_lock
comma
id|flags
)paren
suffix:semicolon
op_star
id|irq
op_assign
id|mips_pcibios_iack
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * IRQ7 is used to detect spurious interrupts.&n;&t; * The interrupt acknowledge cycle returns IRQ7, if no&n;&t; * interrupts is requested.&n;&t; * We can differentiate between this situation and a&n;&t; * &quot;Normal&quot; IRQ7 by reading the ISR.&n;&t; */
r_if
c_cond
(paren
op_star
id|irq
op_eq
l_int|7
)paren
(brace
id|outb
c_func
(paren
id|PIIX4_OCW3_SEL
op_or
id|PIIX4_OCW3_ISR
comma
id|PIIX4_ICTLR1_OCW3
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|PIIX4_ICTLR1_OCW3
)paren
op_amp
(paren
l_int|1
op_lshift
l_int|7
)paren
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mips_irq_lock
comma
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;We got a spurious interrupt from PIIX4.&bslash;n&quot;
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|irq_err_count
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Spurious interrupt. */
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mips_irq_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|malta_hw0_irqdispatch
r_void
id|malta_hw0_irqdispatch
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|irq
suffix:semicolon
r_if
c_cond
(paren
id|get_int
c_func
(paren
op_amp
id|irq
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* interrupt has already been cleared */
id|do_IRQ
c_func
(paren
id|irq
comma
id|regs
)paren
suffix:semicolon
)brace
DECL|function|corehi_irqdispatch
r_void
id|corehi_irqdispatch
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|data
comma
id|datahi
suffix:semicolon
multiline_comment|/* Mask out corehi interrupt. */
id|clear_c0_status
c_func
(paren
id|IE_IRQ3
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;CoreHI interrupt, shouldn&squot;t happen, so we die here!!!&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;epc   : %08lx&bslash;nStatus: %08lx&bslash;nCause : %08lx&bslash;nbadVaddr : %08lx&bslash;n&quot;
comma
id|regs-&gt;cp0_epc
comma
id|regs-&gt;cp0_status
comma
id|regs-&gt;cp0_cause
comma
id|regs-&gt;cp0_badvaddr
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|mips_revision_corid
)paren
(brace
r_case
id|MIPS_REVISION_CORID_CORE_MSC
suffix:colon
r_case
id|MIPS_REVISION_CORID_CORE_FPGA2
suffix:colon
r_case
id|MIPS_REVISION_CORID_CORE_EMUL_MSC
suffix:colon
r_break
suffix:semicolon
r_case
id|MIPS_REVISION_CORID_QED_RM5261
suffix:colon
r_case
id|MIPS_REVISION_CORID_CORE_LV
suffix:colon
r_case
id|MIPS_REVISION_CORID_CORE_FPGA
suffix:colon
r_case
id|MIPS_REVISION_CORID_CORE_FPGAR2
suffix:colon
id|data
op_assign
id|GT_READ
c_func
(paren
id|GT_INTRCAUSE_OFS
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;GT_INTRCAUSE = %08x&bslash;n&quot;
comma
id|data
)paren
suffix:semicolon
id|data
op_assign
id|GT_READ
c_func
(paren
l_int|0x70
)paren
suffix:semicolon
id|datahi
op_assign
id|GT_READ
c_func
(paren
l_int|0x78
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;GT_CPU_ERR_ADDR = %02x%08x&bslash;n&quot;
comma
id|datahi
comma
id|data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIPS_REVISION_CORID_BONITO64
suffix:colon
r_case
id|MIPS_REVISION_CORID_CORE_20K
suffix:colon
r_case
id|MIPS_REVISION_CORID_CORE_EMUL_BON
suffix:colon
id|data
op_assign
id|BONITO_INTISR
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;BONITO_INTISR = %08x&bslash;n&quot;
comma
id|data
)paren
suffix:semicolon
id|data
op_assign
id|BONITO_INTEN
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;BONITO_INTEN = %08x&bslash;n&quot;
comma
id|data
)paren
suffix:semicolon
id|data
op_assign
id|BONITO_INTPOL
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;BONITO_INTPOL = %08x&bslash;n&quot;
comma
id|data
)paren
suffix:semicolon
id|data
op_assign
id|BONITO_INTEDGE
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;BONITO_INTEDGE = %08x&bslash;n&quot;
comma
id|data
)paren
suffix:semicolon
id|data
op_assign
id|BONITO_INTSTEER
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;BONITO_INTSTEER = %08x&bslash;n&quot;
comma
id|data
)paren
suffix:semicolon
id|data
op_assign
id|BONITO_PCICMD
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;BONITO_PCICMD = %08x&bslash;n&quot;
comma
id|data
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* We die here*/
id|die
c_func
(paren
l_string|&quot;CoreHi interrupt&quot;
comma
id|regs
)paren
suffix:semicolon
)brace
DECL|function|arch_init_irq
r_void
id|__init
id|arch_init_irq
c_func
(paren
r_void
)paren
(brace
id|set_except_vector
c_func
(paren
l_int|0
comma
id|mipsIRQ
)paren
suffix:semicolon
id|init_i8259_irqs
c_func
(paren
)paren
suffix:semicolon
)brace
eof
