multiline_comment|/*&n; * setup.c&n; *&n; * BRIEF MODULE DESCRIPTION&n; * Galileo Evaluation Boards - board dependent boot routines&n; *&n; * Copyright (C) 1996, 1997, 2001  Ralf Baechle&n; * Copyright (C) 2000 RidgeRun, Inc.&n; * Copyright (C) 2001 Red Hat, Inc.&n; *&n; * Author: RidgeRun, Inc.&n; *   glonnon@ridgerun.com, skranz@ridgerun.com, stevej@ridgerun.com&n; *&n; * Copyright 2001 MontaVista Software Inc.&n; * Author: jsun@mvista.com or jsun@junsun.net&n; *&n; *  This program is free software; you can redistribute  it and/or modify it&n; *  under  the terms of  the GNU General  Public License as published by the&n; *  Free Software Foundation;  either version 2 of the  License, or (at your&n; *  option) any later version.&n; *&n; *  THIS  SOFTWARE  IS PROVIDED   ``AS  IS&squot;&squot; AND   ANY  EXPRESS OR IMPLIED&n; *  WARRANTIES,   INCLUDING, BUT NOT  LIMITED  TO, THE IMPLIED WARRANTIES OF&n; *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN&n; *  NO  EVENT  SHALL   THE AUTHOR  BE    LIABLE FOR ANY   DIRECT, INDIRECT,&n; *  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT&n; *  NOT LIMITED   TO, PROCUREMENT OF  SUBSTITUTE GOODS  OR SERVICES; LOSS OF&n; *  USE, DATA,  OR PROFITS; OR  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON&n; *  ANY THEORY OF LIABILITY, WHETHER IN  CONTRACT, STRICT LIABILITY, OR TORT&n; *  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF&n; *  THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n; *&n; *  You should have received a copy of the  GNU General Public License along&n; *  with this program; if not, write  to the Free Software Foundation, Inc.,&n; *  675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/mc146818rtc.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/swap.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/timex.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;asm/time.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/pci.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/reboot.h&gt;
macro_line|#include &lt;asm/mc146818rtc.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;asm/gt64120/gt64120.h&gt;
macro_line|#include &quot;ocelot_pld.h&quot;
r_extern
r_struct
id|rtc_ops
id|no_rtc_ops
suffix:semicolon
DECL|variable|gt64120_base
r_int
r_int
id|gt64120_base
op_assign
id|KSEG1ADDR
c_func
(paren
id|GT_DEF_BASE
)paren
suffix:semicolon
multiline_comment|/* These functions are used for rebooting or halting the machine*/
r_extern
r_void
id|momenco_ocelot_restart
c_func
(paren
r_char
op_star
id|command
)paren
suffix:semicolon
r_extern
r_void
id|momenco_ocelot_halt
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|momenco_ocelot_power_off
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|gt64120_time_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|momenco_ocelot_irq_setup
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|variable|reset_reason
r_static
r_char
id|reset_reason
suffix:semicolon
DECL|macro|ENTRYLO
mdefine_line|#define ENTRYLO(x) ((pte_val(pfn_pte((x) &gt;&gt; PAGE_SHIFT, PAGE_KERNEL_UNCACHED)) &gt;&gt; 6)|1)
r_static
r_void
id|__init
id|setup_l3cache
c_func
(paren
r_int
r_int
id|size
)paren
suffix:semicolon
DECL|function|momenco_ocelot_setup
r_void
id|__init
id|momenco_ocelot_setup
c_func
(paren
r_void
)paren
(brace
r_void
(paren
op_star
id|l3func
)paren
(paren
r_int
r_int
)paren
op_assign
id|KSEG1ADDR
c_func
(paren
op_amp
id|setup_l3cache
)paren
suffix:semicolon
r_int
r_int
id|tmpword
suffix:semicolon
id|board_time_init
op_assign
id|gt64120_time_init
suffix:semicolon
id|_machine_restart
op_assign
id|momenco_ocelot_restart
suffix:semicolon
id|_machine_halt
op_assign
id|momenco_ocelot_halt
suffix:semicolon
id|_machine_power_off
op_assign
id|momenco_ocelot_power_off
suffix:semicolon
multiline_comment|/*&n;&t; * initrd_start = (ulong)ocelot_initrd_start;&n;&t; * initrd_end = (ulong)ocelot_initrd_start + (ulong)ocelot_initrd_size;&n;&t; * initrd_below_start_ok = 1;&n;&t; */
id|rtc_ops
op_assign
op_amp
id|no_rtc_ops
suffix:semicolon
multiline_comment|/* A wired TLB entry for the GT64120A and the serial port. The&n;&t;   GT64120A is going to be hit on every IRQ anyway - there&squot;s&n;&t;   absolutely no point in letting it be a random TLB entry, as&n;&t;   it&squot;ll just cause needless churning of the TLB. And we use&n;&t;   the other half for the serial port, which is just a PITA&n;&t;   otherwise :)&n;&n;&t;&t;Device&t;&t;&t;Physical&t;Virtual&n;&t;&t;GT64120 Internal Regs&t;0x24000000&t;0xe0000000&n;&t;&t;UARTs (CS2)&t;&t;0x2d000000&t;0xe0001000&n;&t;*/
id|add_wired_entry
c_func
(paren
id|ENTRYLO
c_func
(paren
l_int|0x24000000
)paren
comma
id|ENTRYLO
c_func
(paren
l_int|0x2D000000
)paren
comma
l_int|0xe0000000
comma
id|PM_4K
)paren
suffix:semicolon
multiline_comment|/* Also a temporary entry to let us talk to the Ocelot PLD and NVRAM&n;&t;   in the CS[012] region. We can&squot;t use ioremap() yet. The NVRAM&n;&t;   appears to be one of the variants of ST M48T35 - see &n;&t;   http://www.st.com/stonline/bin/sftab.exe?table=172&amp;filter0=M48T35&n;&n;&t;&t;Ocelot PLD (CS0)&t;0x2c000000&t;0xe0020000&n;&t;&t;NVRAM&t;&t;&t;0x2c800000&t;0xe0030000&n;&t;*/
id|add_temporary_entry
c_func
(paren
id|ENTRYLO
c_func
(paren
l_int|0x2C000000
)paren
comma
id|ENTRYLO
c_func
(paren
l_int|0x2d000000
)paren
comma
l_int|0xe0020000
comma
id|PM_64K
)paren
suffix:semicolon
multiline_comment|/* Relocate the CS3/BootCS region */
id|GT_WRITE
c_func
(paren
id|GT_CS3BOOTLD_OFS
comma
l_int|0x2f000000
op_rshift
l_int|21
)paren
suffix:semicolon
multiline_comment|/* Relocate CS[012] */
id|GT_WRITE
c_func
(paren
id|GT_CS20LD_OFS
comma
l_int|0x2c000000
op_rshift
l_int|21
)paren
suffix:semicolon
multiline_comment|/* Relocate the GT64120A itself... */
id|GT_WRITE
c_func
(paren
id|GT_ISD_OFS
comma
l_int|0x24000000
op_rshift
l_int|21
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|gt64120_base
op_assign
l_int|0xe0000000
suffix:semicolon
multiline_comment|/* ...and the PCI0 view of it. */
id|GT_WRITE
c_func
(paren
id|GT_PCI0_CFGADDR_OFS
comma
l_int|0x80000020
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|GT_PCI0_CFGDATA_OFS
comma
l_int|0x24000000
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|GT_PCI0_CFGADDR_OFS
comma
l_int|0x80000024
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|GT_PCI0_CFGDATA_OFS
comma
l_int|0x24000001
)paren
suffix:semicolon
multiline_comment|/* Relocate PCI0 I/O and Mem0 */
id|GT_WRITE
c_func
(paren
id|GT_PCI0IOLD_OFS
comma
l_int|0x20000000
op_rshift
l_int|21
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|GT_PCI0M0LD_OFS
comma
l_int|0x22000000
op_rshift
l_int|21
)paren
suffix:semicolon
multiline_comment|/* Relocate PCI0 Mem1 */
id|GT_WRITE
c_func
(paren
id|GT_PCI0M1LD_OFS
comma
l_int|0x36000000
op_rshift
l_int|21
)paren
suffix:semicolon
multiline_comment|/* Relocate all the PCI1 stuff, not that we use it */
id|GT_WRITE
c_func
(paren
id|GT_PCI1IOLD_OFS
comma
l_int|0x30000000
op_rshift
l_int|21
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|GT_PCI1M0LD_OFS
comma
l_int|0x32000000
op_rshift
l_int|21
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|GT_PCI1M1LD_OFS
comma
l_int|0x34000000
op_rshift
l_int|21
)paren
suffix:semicolon
multiline_comment|/* Relocate the CPU&squot;s view of the RAM... */
id|GT_WRITE
c_func
(paren
id|GT_SCS10LD_OFS
comma
l_int|0
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|GT_SCS10HD_OFS
comma
l_int|0x0fe00000
op_rshift
l_int|21
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|GT_SCS32LD_OFS
comma
l_int|0x10000000
op_rshift
l_int|21
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|GT_SCS32HD_OFS
comma
l_int|0x0fe00000
op_rshift
l_int|21
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|GT_SCS1LD_OFS
comma
l_int|0xff
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|GT_SCS1HD_OFS
comma
l_int|0x00
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|GT_SCS0LD_OFS
comma
l_int|0
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|GT_SCS0HD_OFS
comma
l_int|0xff
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|GT_SCS3LD_OFS
comma
l_int|0xff
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|GT_SCS3HD_OFS
comma
l_int|0x00
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|GT_SCS2LD_OFS
comma
l_int|0
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|GT_SCS2HD_OFS
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* ...and the PCI0 view of it. */
id|GT_WRITE
c_func
(paren
id|GT_PCI0_CFGADDR_OFS
comma
l_int|0x80000010
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|GT_PCI0_CFGDATA_OFS
comma
l_int|0x00000000
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|GT_PCI0_CFGADDR_OFS
comma
l_int|0x80000014
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|GT_PCI0_CFGDATA_OFS
comma
l_int|0x10000000
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|GT_PCI0_BS_SCS10_OFS
comma
l_int|0x0ffff000
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|GT_PCI0_BS_SCS32_OFS
comma
l_int|0x0ffff000
)paren
suffix:semicolon
id|tmpword
op_assign
id|OCELOT_PLD_READ
c_func
(paren
id|BOARDREV
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmpword
OL
l_int|26
)paren
id|printk
c_func
(paren
l_string|&quot;Momenco Ocelot: Board Assembly Rev. %c&bslash;n&quot;
comma
l_char|&squot;A&squot;
op_plus
id|tmpword
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;Momenco Ocelot: Board Assembly Revision #0x%x&bslash;n&quot;
comma
id|tmpword
)paren
suffix:semicolon
id|tmpword
op_assign
id|OCELOT_PLD_READ
c_func
(paren
id|PLD1_ID
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PLD 1 ID: %d.%d&bslash;n&quot;
comma
id|tmpword
op_rshift
l_int|4
comma
id|tmpword
op_amp
l_int|15
)paren
suffix:semicolon
id|tmpword
op_assign
id|OCELOT_PLD_READ
c_func
(paren
id|PLD2_ID
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PLD 2 ID: %d.%d&bslash;n&quot;
comma
id|tmpword
op_rshift
l_int|4
comma
id|tmpword
op_amp
l_int|15
)paren
suffix:semicolon
id|tmpword
op_assign
id|OCELOT_PLD_READ
c_func
(paren
id|RESET_STATUS
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Reset reason: 0x%x&bslash;n&quot;
comma
id|tmpword
)paren
suffix:semicolon
id|reset_reason
op_assign
id|tmpword
suffix:semicolon
id|OCELOT_PLD_WRITE
c_func
(paren
l_int|0xff
comma
id|RESET_STATUS
)paren
suffix:semicolon
id|tmpword
op_assign
id|OCELOT_PLD_READ
c_func
(paren
id|BOARD_STATUS
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Board Status register: 0x%02x&bslash;n&quot;
comma
id|tmpword
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  - User jumper: %s&bslash;n&quot;
comma
(paren
id|tmpword
op_amp
l_int|0x80
)paren
ques
c_cond
l_string|&quot;installed&quot;
suffix:colon
l_string|&quot;absent&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  - Boot flash write jumper: %s&bslash;n&quot;
comma
(paren
id|tmpword
op_amp
l_int|0x40
)paren
ques
c_cond
l_string|&quot;installed&quot;
suffix:colon
l_string|&quot;absent&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  - Tulip PHY %s connected&bslash;n&quot;
comma
(paren
id|tmpword
op_amp
l_int|0x10
)paren
ques
c_cond
l_string|&quot;is&quot;
suffix:colon
l_string|&quot;not&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  - L3 Cache size: %d MiB&bslash;n&quot;
comma
(paren
l_int|1
op_lshift
(paren
(paren
id|tmpword
op_amp
l_int|12
)paren
op_rshift
l_int|2
)paren
)paren
op_amp
op_complement
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  - SDRAM size: %d MiB&bslash;n&quot;
comma
l_int|1
op_lshift
(paren
l_int|6
op_plus
(paren
id|tmpword
op_amp
l_int|3
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmpword
op_amp
l_int|12
)paren
id|l3func
c_func
(paren
(paren
l_int|1
op_lshift
(paren
(paren
(paren
id|tmpword
op_amp
l_int|12
)paren
op_rshift
l_int|2
)paren
op_plus
l_int|20
)paren
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|tmpword
op_amp
l_int|3
)paren
(brace
r_case
l_int|3
suffix:colon
multiline_comment|/* 512MiB */
id|add_memory_region
c_func
(paren
l_int|256
op_lshift
l_int|20
comma
l_int|256
op_lshift
l_int|20
comma
id|BOOT_MEM_RAM
)paren
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* 256MiB */
multiline_comment|/* FIXME: Is it actually here, or at 0x10000000? */
id|add_memory_region
c_func
(paren
l_int|128
op_lshift
l_int|20
comma
l_int|128
op_lshift
l_int|20
comma
id|BOOT_MEM_RAM
)paren
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* 128MiB */
id|add_memory_region
c_func
(paren
l_int|64
op_lshift
l_int|20
comma
l_int|64
op_lshift
l_int|20
comma
id|BOOT_MEM_RAM
)paren
suffix:semicolon
r_case
l_int|0
suffix:colon
multiline_comment|/* 64MiB */
suffix:semicolon
)brace
multiline_comment|/* Fix up the DiskOnChip mapping */
id|GT_WRITE
c_func
(paren
l_int|0x468
comma
l_int|0xfef73
)paren
suffix:semicolon
)brace
r_extern
r_int
id|rm7k_tcache_enabled
suffix:semicolon
multiline_comment|/*&n; * This runs in KSEG1. See the verbiage in rm7k.c::probe_scache()&n; */
DECL|macro|Page_Invalidate_T
mdefine_line|#define Page_Invalidate_T 0x16
DECL|function|setup_l3cache
r_static
r_void
id|__init
id|setup_l3cache
c_func
(paren
r_int
r_int
id|size
)paren
(brace
r_int
r_register
id|i
suffix:semicolon
r_int
r_int
id|tmp
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Enabling L3 cache...&quot;
)paren
suffix:semicolon
multiline_comment|/* Enable the L3 cache in the GT64120A&squot;s CPU Configuration register */
id|GT_READ
c_func
(paren
l_int|0
comma
op_amp
id|tmp
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
l_int|0
comma
id|tmp
op_or
(paren
l_int|1
op_lshift
l_int|14
)paren
)paren
suffix:semicolon
multiline_comment|/* Enable the L3 cache in the CPU */
id|set_cp0_config
c_func
(paren
l_int|1
op_lshift
l_int|12
multiline_comment|/* CONF_TE */
)paren
suffix:semicolon
multiline_comment|/* Clear the cache */
id|set_taglo
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|set_taghi
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_add_assign
l_int|4096
)paren
(brace
id|__asm__
id|__volatile__
(paren
l_string|&quot;.set noreorder&bslash;n&bslash;t&quot;
l_string|&quot;.set mips3&bslash;n&bslash;t&quot;
l_string|&quot;cache %1, (%0)&bslash;n&bslash;t&quot;
l_string|&quot;.set mips0&bslash;n&bslash;t&quot;
l_string|&quot;.set reorder&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|KSEG0ADDR
c_func
(paren
id|i
)paren
)paren
comma
l_string|&quot;i&quot;
(paren
id|Page_Invalidate_T
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Let the RM7000 MM code know that the tertiary cache is enabled */
id|rm7k_tcache_enabled
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Done&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* This needs to be one of the first initcalls, because no I/O port access&n;   can work before this */
DECL|function|io_base_ioremap
r_static
r_int
id|io_base_ioremap
c_func
(paren
r_void
)paren
(brace
r_void
op_star
id|io_remap_range
op_assign
id|ioremap
c_func
(paren
id|GT_PCI_IO_BASE
comma
id|GT_PCI_IO_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|io_remap_range
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Could not ioremap I/O port range&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|mips_io_port_base
op_assign
id|io_remap_range
op_minus
id|GT_PCI_IO_BASE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|io_base_ioremap
id|module_init
c_func
(paren
id|io_base_ioremap
)paren
suffix:semicolon
eof
