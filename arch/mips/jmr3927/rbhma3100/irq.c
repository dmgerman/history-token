multiline_comment|/*&n; * Copyright 2001 MontaVista Software Inc.&n; * Author: MontaVista Software, Inc.&n; *              ahennessy@mvista.com&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Copyright (C) 2000-2001 Toshiba Corporation&n; *&n; *  This program is free software; you can redistribute  it and/or modify it&n; *  under  the terms of  the GNU General  Public License as published by the&n; *  Free Software Foundation;  either version 2 of the  License, or (at your&n; *  option) any later version.&n; *&n; *  THIS  SOFTWARE  IS PROVIDED   ``AS  IS&squot;&squot; AND   ANY  EXPRESS OR IMPLIED&n; *  WARRANTIES,   INCLUDING, BUT NOT  LIMITED  TO, THE IMPLIED WARRANTIES OF&n; *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN&n; *  NO  EVENT  SHALL   THE AUTHOR  BE    LIABLE FOR ANY   DIRECT, INDIRECT,&n; *  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT&n; *  NOT LIMITED   TO, PROCUREMENT OF  SUBSTITUTE GOODS  OR SERVICES; LOSS OF&n; *  USE, DATA,  OR PROFITS; OR  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON&n; *  ANY THEORY OF LIABILITY, WHETHER IN  CONTRACT, STRICT LIABILITY, OR TORT&n; *  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF&n; *  THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n; *&n; *  You should have received a copy of the  GNU General Public License along&n; *  with this program; if not, write  to the Free Software Foundation, Inc.,&n; *  675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/kernel_stat.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/timex.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/mipsregs.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/jmr3927/irq.h&gt;
macro_line|#include &lt;asm/debug.h&gt;
macro_line|#include &lt;asm/jmr3927/jmr3927.h&gt;
macro_line|#if JMR3927_IRQ_END &gt; NR_IRQS
macro_line|#error JMR3927_IRQ_END &gt; NR_IRQS
macro_line|#endif
DECL|variable|tb_irq_spaces
r_struct
id|tb_irq_space
op_star
id|tb_irq_spaces
suffix:semicolon
DECL|variable|jmr3927_irq_base
r_static
r_int
id|jmr3927_irq_base
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#ifdef CONFIG_PCI
DECL|function|jmr3927_gen_iack
r_static
r_int
id|jmr3927_gen_iack
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* generate ACK cycle */
macro_line|#ifdef __BIG_ENDIAN
r_return
(paren
id|tx3927_pcicptr-&gt;iiadp
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
suffix:semicolon
macro_line|#else
r_return
id|tx3927_pcicptr-&gt;iiadp
op_amp
l_int|0xff
suffix:semicolon
macro_line|#endif
)brace
macro_line|#endif
r_extern
id|asmlinkage
r_void
id|jmr3927_IRQ
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|macro|irc_dlevel
mdefine_line|#define irc_dlevel&t;0
DECL|macro|irc_elevel
mdefine_line|#define irc_elevel&t;1
DECL|variable|irc_level
r_static
r_int
r_char
id|irc_level
(braket
id|TX3927_NUM_IR
)braket
op_assign
(brace
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
multiline_comment|/* INT[5:0] */
l_int|7
comma
l_int|7
comma
multiline_comment|/* SIO */
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* DMA, PIO, PCI */
l_int|6
comma
l_int|6
comma
l_int|6
multiline_comment|/* TMR */
)brace
suffix:semicolon
DECL|function|mask_irq
r_static
r_inline
r_void
id|mask_irq
c_func
(paren
r_int
r_int
id|irq_nr
)paren
(brace
r_struct
id|tb_irq_space
op_star
id|sp
suffix:semicolon
r_for
c_loop
(paren
id|sp
op_assign
id|tb_irq_spaces
suffix:semicolon
id|sp
suffix:semicolon
id|sp
op_assign
id|sp-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|sp-&gt;start_irqno
op_le
id|irq_nr
op_logical_and
id|irq_nr
OL
id|sp-&gt;start_irqno
op_plus
id|sp-&gt;nr_irqs
)paren
(brace
r_if
c_cond
(paren
id|sp-&gt;mask_func
)paren
id|sp
op_member_access_from_pointer
id|mask_func
c_func
(paren
id|irq_nr
op_minus
id|sp-&gt;start_irqno
comma
id|sp-&gt;space_id
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
DECL|function|unmask_irq
r_static
r_inline
r_void
id|unmask_irq
c_func
(paren
r_int
r_int
id|irq_nr
)paren
(brace
r_struct
id|tb_irq_space
op_star
id|sp
suffix:semicolon
r_for
c_loop
(paren
id|sp
op_assign
id|tb_irq_spaces
suffix:semicolon
id|sp
suffix:semicolon
id|sp
op_assign
id|sp-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|sp-&gt;start_irqno
op_le
id|irq_nr
op_logical_and
id|irq_nr
OL
id|sp-&gt;start_irqno
op_plus
id|sp-&gt;nr_irqs
)paren
(brace
r_if
c_cond
(paren
id|sp-&gt;unmask_func
)paren
id|sp
op_member_access_from_pointer
id|unmask_func
c_func
(paren
id|irq_nr
op_minus
id|sp-&gt;start_irqno
comma
id|sp-&gt;space_id
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_static
r_void
id|jmr3927_irq_disable
c_func
(paren
r_int
r_int
id|irq_nr
)paren
suffix:semicolon
r_static
r_void
id|jmr3927_irq_enable
c_func
(paren
r_int
r_int
id|irq_nr
)paren
suffix:semicolon
DECL|variable|jmr3927_irq_lock
r_static
id|spinlock_t
id|jmr3927_irq_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|function|jmr3927_irq_startup
r_static
r_int
r_int
id|jmr3927_irq_startup
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|jmr3927_irq_enable
c_func
(paren
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|jmr3927_irq_shutdown
mdefine_line|#define&t;jmr3927_irq_shutdown&t;jmr3927_irq_disable
DECL|function|jmr3927_irq_ack
r_static
r_void
id|jmr3927_irq_ack
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_if
c_cond
(paren
id|irq
op_eq
id|JMR3927_IRQ_IRC_TMR0
)paren
(brace
id|jmr3927_tmrptr-&gt;tisr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* ack interrupt */
)brace
id|jmr3927_irq_disable
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|jmr3927_irq_end
r_static
r_void
id|jmr3927_irq_end
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|jmr3927_irq_enable
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|jmr3927_irq_disable
r_static
r_void
id|jmr3927_irq_disable
c_func
(paren
r_int
r_int
id|irq_nr
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spinlock_irqsave
c_func
(paren
op_amp
id|jmr3927_irq_lock
comma
id|flags
)paren
suffix:semicolon
id|mask_irq
c_func
(paren
id|irq_nr
)paren
suffix:semicolon
id|spinlock_irqrestore
c_func
(paren
op_amp
id|jmr3927_irq_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|jmr3927_irq_enable
r_static
r_void
id|jmr3927_irq_enable
c_func
(paren
r_int
r_int
id|irq_nr
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spinlock_irqsave
c_func
(paren
op_amp
id|jmr3927_irq_lock
comma
id|flags
)paren
suffix:semicolon
id|unmask_irq
c_func
(paren
id|irq_nr
)paren
suffix:semicolon
id|spinlock_irqrestore
c_func
(paren
op_amp
id|jmr3927_irq_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * CP0_STATUS is a thread&squot;s resource (saved/restored on context switch).&n; * So disable_irq/enable_irq MUST handle IOC/ISAC/IRC registers.&n; */
DECL|function|mask_irq_isac
r_static
r_void
id|mask_irq_isac
c_func
(paren
r_int
id|irq_nr
comma
r_int
id|space_id
)paren
(brace
multiline_comment|/* 0: mask */
r_int
r_char
id|imask
op_assign
id|jmr3927_isac_reg_in
c_func
(paren
id|JMR3927_ISAC_INTM_ADDR
)paren
suffix:semicolon
r_int
r_int
id|bit
op_assign
l_int|1
op_lshift
id|irq_nr
suffix:semicolon
id|jmr3927_isac_reg_out
c_func
(paren
id|imask
op_amp
op_complement
id|bit
comma
id|JMR3927_ISAC_INTM_ADDR
)paren
suffix:semicolon
multiline_comment|/* flush write buffer */
(paren
r_void
)paren
id|jmr3927_ioc_reg_in
c_func
(paren
id|JMR3927_IOC_REV_ADDR
)paren
suffix:semicolon
)brace
DECL|function|unmask_irq_isac
r_static
r_void
id|unmask_irq_isac
c_func
(paren
r_int
id|irq_nr
comma
r_int
id|space_id
)paren
(brace
multiline_comment|/* 0: mask */
r_int
r_char
id|imask
op_assign
id|jmr3927_isac_reg_in
c_func
(paren
id|JMR3927_ISAC_INTM_ADDR
)paren
suffix:semicolon
r_int
r_int
id|bit
op_assign
l_int|1
op_lshift
id|irq_nr
suffix:semicolon
id|jmr3927_isac_reg_out
c_func
(paren
id|imask
op_or
id|bit
comma
id|JMR3927_ISAC_INTM_ADDR
)paren
suffix:semicolon
multiline_comment|/* flush write buffer */
(paren
r_void
)paren
id|jmr3927_ioc_reg_in
c_func
(paren
id|JMR3927_IOC_REV_ADDR
)paren
suffix:semicolon
)brace
DECL|function|mask_irq_ioc
r_static
r_void
id|mask_irq_ioc
c_func
(paren
r_int
id|irq_nr
comma
r_int
id|space_id
)paren
(brace
multiline_comment|/* 0: mask */
r_int
r_char
id|imask
op_assign
id|jmr3927_ioc_reg_in
c_func
(paren
id|JMR3927_IOC_INTM_ADDR
)paren
suffix:semicolon
r_int
r_int
id|bit
op_assign
l_int|1
op_lshift
id|irq_nr
suffix:semicolon
id|jmr3927_ioc_reg_out
c_func
(paren
id|imask
op_amp
op_complement
id|bit
comma
id|JMR3927_IOC_INTM_ADDR
)paren
suffix:semicolon
multiline_comment|/* flush write buffer */
(paren
r_void
)paren
id|jmr3927_ioc_reg_in
c_func
(paren
id|JMR3927_IOC_REV_ADDR
)paren
suffix:semicolon
)brace
DECL|function|unmask_irq_ioc
r_static
r_void
id|unmask_irq_ioc
c_func
(paren
r_int
id|irq_nr
comma
r_int
id|space_id
)paren
(brace
multiline_comment|/* 0: mask */
r_int
r_char
id|imask
op_assign
id|jmr3927_ioc_reg_in
c_func
(paren
id|JMR3927_IOC_INTM_ADDR
)paren
suffix:semicolon
r_int
r_int
id|bit
op_assign
l_int|1
op_lshift
id|irq_nr
suffix:semicolon
id|jmr3927_ioc_reg_out
c_func
(paren
id|imask
op_or
id|bit
comma
id|JMR3927_IOC_INTM_ADDR
)paren
suffix:semicolon
multiline_comment|/* flush write buffer */
(paren
r_void
)paren
id|jmr3927_ioc_reg_in
c_func
(paren
id|JMR3927_IOC_REV_ADDR
)paren
suffix:semicolon
)brace
DECL|function|mask_irq_irc
r_static
r_void
id|mask_irq_irc
c_func
(paren
r_int
id|irq_nr
comma
r_int
id|space_id
)paren
(brace
r_volatile
r_int
r_int
op_star
id|ilrp
op_assign
op_amp
id|tx3927_ircptr-&gt;ilr
(braket
id|irq_nr
op_div
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|irq_nr
op_amp
l_int|1
)paren
op_star
id|ilrp
op_assign
(paren
op_star
id|ilrp
op_amp
l_int|0x00ff
)paren
op_or
(paren
id|irc_dlevel
op_lshift
l_int|8
)paren
suffix:semicolon
r_else
op_star
id|ilrp
op_assign
(paren
op_star
id|ilrp
op_amp
l_int|0xff00
)paren
op_or
id|irc_dlevel
suffix:semicolon
multiline_comment|/* update IRCSR */
id|tx3927_ircptr-&gt;imr
op_assign
l_int|0
suffix:semicolon
id|tx3927_ircptr-&gt;imr
op_assign
id|irc_elevel
suffix:semicolon
)brace
DECL|function|unmask_irq_irc
r_static
r_void
id|unmask_irq_irc
c_func
(paren
r_int
id|irq_nr
comma
r_int
id|space_id
)paren
(brace
r_volatile
r_int
r_int
op_star
id|ilrp
op_assign
op_amp
id|tx3927_ircptr-&gt;ilr
(braket
id|irq_nr
op_div
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|irq_nr
op_amp
l_int|1
)paren
op_star
id|ilrp
op_assign
(paren
op_star
id|ilrp
op_amp
l_int|0x00ff
)paren
op_or
(paren
id|irc_level
(braket
id|irq_nr
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
r_else
op_star
id|ilrp
op_assign
(paren
op_star
id|ilrp
op_amp
l_int|0xff00
)paren
op_or
id|irc_level
(braket
id|irq_nr
)braket
suffix:semicolon
multiline_comment|/* update IRCSR */
id|tx3927_ircptr-&gt;imr
op_assign
l_int|0
suffix:semicolon
id|tx3927_ircptr-&gt;imr
op_assign
id|irc_elevel
suffix:semicolon
)brace
DECL|variable|jmr3927_isac_irqspace
r_struct
id|tb_irq_space
id|jmr3927_isac_irqspace
op_assign
(brace
dot
id|next
op_assign
l_int|NULL
comma
dot
id|start_irqno
op_assign
id|JMR3927_IRQ_ISAC
comma
id|nr_irqs
suffix:colon
id|JMR3927_NR_IRQ_ISAC
comma
dot
id|mask_func
op_assign
id|mask_irq_isac
comma
dot
id|unmask_func
op_assign
id|unmask_irq_isac
comma
dot
id|name
op_assign
l_string|&quot;ISAC&quot;
comma
dot
id|space_id
op_assign
l_int|0
comma
id|can_share
suffix:colon
l_int|0
)brace
suffix:semicolon
DECL|variable|jmr3927_ioc_irqspace
r_struct
id|tb_irq_space
id|jmr3927_ioc_irqspace
op_assign
(brace
dot
id|next
op_assign
l_int|NULL
comma
dot
id|start_irqno
op_assign
id|JMR3927_IRQ_IOC
comma
id|nr_irqs
suffix:colon
id|JMR3927_NR_IRQ_IOC
comma
dot
id|mask_func
op_assign
id|mask_irq_ioc
comma
dot
id|unmask_func
op_assign
id|unmask_irq_ioc
comma
dot
id|name
op_assign
l_string|&quot;IOC&quot;
comma
dot
id|space_id
op_assign
l_int|0
comma
id|can_share
suffix:colon
l_int|1
)brace
suffix:semicolon
DECL|variable|jmr3927_irc_irqspace
r_struct
id|tb_irq_space
id|jmr3927_irc_irqspace
op_assign
(brace
dot
id|next
op_assign
l_int|NULL
comma
dot
id|start_irqno
op_assign
id|JMR3927_IRQ_IRC
comma
id|nr_irqs
suffix:colon
id|JMR3927_NR_IRQ_IRC
comma
dot
id|mask_func
op_assign
id|mask_irq_irc
comma
dot
id|unmask_func
op_assign
id|unmask_irq_irc
comma
dot
id|name
op_assign
l_string|&quot;on-chip&quot;
comma
dot
id|space_id
op_assign
l_int|0
comma
id|can_share
suffix:colon
l_int|0
)brace
suffix:semicolon
DECL|function|jmr3927_spurious
r_void
id|jmr3927_spurious
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
macro_line|#ifdef CONFIG_TX_BRANCH_LIKELY_BUG_WORKAROUND
id|tx_branch_likely_bug_fixup
c_func
(paren
id|regs
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;spurious interrupt (cause 0x%lx, pc 0x%lx, ra 0x%lx).&bslash;n&quot;
comma
id|regs-&gt;cp0_cause
comma
id|regs-&gt;cp0_epc
comma
id|regs-&gt;regs
(braket
l_int|31
)braket
)paren
suffix:semicolon
)brace
DECL|function|jmr3927_irc_irqdispatch
r_void
id|jmr3927_irc_irqdispatch
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|irq
suffix:semicolon
macro_line|#ifdef CONFIG_TX_BRANCH_LIKELY_BUG_WORKAROUND
id|tx_branch_likely_bug_fixup
c_func
(paren
id|regs
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|regs-&gt;cp0_cause
op_amp
id|CAUSEF_IP7
)paren
op_eq
l_int|0
)paren
(brace
macro_line|#if 0
id|jmr3927_spurious
c_func
(paren
id|regs
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
id|irq
op_assign
(paren
id|regs-&gt;cp0_cause
op_rshift
id|CAUSEB_IP2
)paren
op_amp
l_int|0x0f
suffix:semicolon
id|do_IRQ
c_func
(paren
id|irq
op_plus
id|JMR3927_IRQ_IRC
comma
id|regs
)paren
suffix:semicolon
)brace
DECL|function|jmr3927_ioc_interrupt
r_static
r_void
id|jmr3927_ioc_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_char
id|istat
op_assign
id|jmr3927_ioc_reg_in
c_func
(paren
id|JMR3927_IOC_INTS2_ADDR
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|JMR3927_NR_IRQ_IOC
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|istat
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
id|irq
op_assign
id|JMR3927_IRQ_IOC
op_plus
id|i
suffix:semicolon
id|do_IRQ
c_func
(paren
id|irq
comma
id|regs
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|variable|ioc_action
r_static
r_struct
id|irqaction
id|ioc_action
op_assign
(brace
id|jmr3927_ioc_interrupt
comma
l_int|0
comma
id|CPU_MASK_NONE
comma
l_string|&quot;IOC&quot;
comma
l_int|NULL
comma
l_int|NULL
comma
)brace
suffix:semicolon
DECL|function|jmr3927_isac_interrupt
r_static
r_void
id|jmr3927_isac_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_char
id|istat
op_assign
id|jmr3927_isac_reg_in
c_func
(paren
id|JMR3927_ISAC_INTS2_ADDR
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|JMR3927_NR_IRQ_ISAC
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|istat
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
id|irq
op_assign
id|JMR3927_IRQ_ISAC
op_plus
id|i
suffix:semicolon
id|do_IRQ
c_func
(paren
id|irq
comma
id|regs
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|variable|isac_action
r_static
r_struct
id|irqaction
id|isac_action
op_assign
(brace
id|jmr3927_isac_interrupt
comma
l_int|0
comma
id|CPU_MASK_NONE
comma
l_string|&quot;ISAC&quot;
comma
l_int|NULL
comma
l_int|NULL
comma
)brace
suffix:semicolon
DECL|function|jmr3927_isaerr_interrupt
r_static
r_void
id|jmr3927_isaerr_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ISA error interrupt (irq 0x%x).&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
)brace
DECL|variable|isaerr_action
r_static
r_struct
id|irqaction
id|isaerr_action
op_assign
(brace
id|jmr3927_isaerr_interrupt
comma
l_int|0
comma
id|CPU_MASK_NONE
comma
l_string|&quot;ISA error&quot;
comma
l_int|NULL
comma
l_int|NULL
comma
)brace
suffix:semicolon
DECL|function|jmr3927_pcierr_interrupt
r_static
r_void
id|jmr3927_pcierr_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PCI error interrupt (irq 0x%x).&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;pcistat:%02x, lbstat:%04lx&bslash;n&quot;
comma
id|tx3927_pcicptr-&gt;pcistat
comma
id|tx3927_pcicptr-&gt;lbstat
)paren
suffix:semicolon
)brace
DECL|variable|pcierr_action
r_static
r_struct
id|irqaction
id|pcierr_action
op_assign
(brace
id|jmr3927_pcierr_interrupt
comma
l_int|0
comma
id|CPU_MASK_NONE
comma
l_string|&quot;PCI error&quot;
comma
l_int|NULL
comma
l_int|NULL
comma
)brace
suffix:semicolon
DECL|variable|jmr3927_ether1_irq
r_int
id|jmr3927_ether1_irq
op_assign
l_int|0
suffix:semicolon
r_void
id|jmr3927_irq_init
c_func
(paren
id|u32
id|irq_base
)paren
suffix:semicolon
DECL|function|arch_init_irq
r_void
id|__init
id|arch_init_irq
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* look for io board&squot;s presence */
r_int
id|have_isac
op_assign
id|jmr3927_have_isac
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Now, interrupt control disabled, */
multiline_comment|/* all IRC interrupts are masked, */
multiline_comment|/* all IRC interrupt mode are Low Active. */
r_if
c_cond
(paren
id|have_isac
)paren
(brace
multiline_comment|/* ETHER1 (NE2000 compatible 10M-Ether) parameter setup */
multiline_comment|/* temporary enable interrupt control */
id|tx3927_ircptr-&gt;cer
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* ETHER1 Int. Is High-Active. */
r_if
c_cond
(paren
id|tx3927_ircptr-&gt;ssr
op_amp
(paren
l_int|1
op_lshift
l_int|0
)paren
)paren
id|jmr3927_ether1_irq
op_assign
id|JMR3927_IRQ_IRC_INT0
suffix:semicolon
macro_line|#if 0&t;/* INT3 may be asserted by ether0 (even after reboot...) */
r_else
r_if
c_cond
(paren
id|tx3927_ircptr-&gt;ssr
op_amp
(paren
l_int|1
op_lshift
l_int|3
)paren
)paren
id|jmr3927_ether1_irq
op_assign
id|JMR3927_IRQ_IRC_INT3
suffix:semicolon
macro_line|#endif
multiline_comment|/* disable interrupt control */
id|tx3927_ircptr-&gt;cer
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Ether1: High Active */
r_if
c_cond
(paren
id|jmr3927_ether1_irq
)paren
(brace
r_int
id|ether1_irc
op_assign
id|jmr3927_ether1_irq
op_minus
id|JMR3927_IRQ_IRC
suffix:semicolon
id|tx3927_ircptr-&gt;cr
(braket
id|ether1_irc
op_div
l_int|8
)braket
op_or_assign
id|TX3927_IRCR_HIGH
op_lshift
(paren
(paren
id|ether1_irc
op_mod
l_int|8
)paren
op_star
l_int|2
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* mask all IOC interrupts */
id|jmr3927_ioc_reg_out
c_func
(paren
l_int|0
comma
id|JMR3927_IOC_INTM_ADDR
)paren
suffix:semicolon
multiline_comment|/* setup IOC interrupt mode (SOFT:High Active, Others:Low Active) */
id|jmr3927_ioc_reg_out
c_func
(paren
id|JMR3927_IOC_INTF_SOFT
comma
id|JMR3927_IOC_INTP_ADDR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|have_isac
)paren
(brace
multiline_comment|/* mask all ISAC interrupts */
id|jmr3927_isac_reg_out
c_func
(paren
l_int|0
comma
id|JMR3927_ISAC_INTM_ADDR
)paren
suffix:semicolon
multiline_comment|/* setup ISAC interrupt mode (ISAIRQ3,ISAIRQ5:Low Active ???) */
id|jmr3927_isac_reg_out
c_func
(paren
id|JMR3927_ISAC_INTF_IRQ3
op_or
id|JMR3927_ISAC_INTF_IRQ5
comma
id|JMR3927_ISAC_INTP_ADDR
)paren
suffix:semicolon
)brace
multiline_comment|/* clear PCI Soft interrupts */
id|jmr3927_ioc_reg_out
c_func
(paren
l_int|0
comma
id|JMR3927_IOC_INTS1_ADDR
)paren
suffix:semicolon
multiline_comment|/* clear PCI Reset interrupts */
id|jmr3927_ioc_reg_out
c_func
(paren
l_int|0
comma
id|JMR3927_IOC_RESET_ADDR
)paren
suffix:semicolon
multiline_comment|/* enable interrupt control */
id|tx3927_ircptr-&gt;cer
op_assign
id|TX3927_IRCER_ICE
suffix:semicolon
id|tx3927_ircptr-&gt;imr
op_assign
id|irc_elevel
suffix:semicolon
id|jmr3927_irq_init
c_func
(paren
id|NR_ISA_IRQS
)paren
suffix:semicolon
id|set_except_vector
c_func
(paren
l_int|0
comma
id|jmr3927_IRQ
)paren
suffix:semicolon
multiline_comment|/* setup irq space */
id|add_tb_irq_space
c_func
(paren
op_amp
id|jmr3927_isac_irqspace
)paren
suffix:semicolon
id|add_tb_irq_space
c_func
(paren
op_amp
id|jmr3927_ioc_irqspace
)paren
suffix:semicolon
id|add_tb_irq_space
c_func
(paren
op_amp
id|jmr3927_irc_irqspace
)paren
suffix:semicolon
multiline_comment|/* setup IOC interrupt 1 (PCI, MODEM) */
id|setup_irq
c_func
(paren
id|JMR3927_IRQ_IOCINT
comma
op_amp
id|ioc_action
)paren
suffix:semicolon
r_if
c_cond
(paren
id|have_isac
)paren
(brace
id|setup_irq
c_func
(paren
id|JMR3927_IRQ_ISACINT
comma
op_amp
id|isac_action
)paren
suffix:semicolon
id|setup_irq
c_func
(paren
id|JMR3927_IRQ_ISAC_ISAER
comma
op_amp
id|isaerr_action
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PCI
id|setup_irq
c_func
(paren
id|JMR3927_IRQ_IRC_PCI
comma
op_amp
id|pcierr_action
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* enable all CPU interrupt bits. */
id|set_c0_status
c_func
(paren
id|ST0_IM
)paren
suffix:semicolon
multiline_comment|/* IE bit is still 0. */
)brace
DECL|variable|jmr3927_irq_controller
r_static
id|hw_irq_controller
id|jmr3927_irq_controller
op_assign
(brace
l_string|&quot;jmr3927_irq&quot;
comma
id|jmr3927_irq_startup
comma
id|jmr3927_irq_shutdown
comma
id|jmr3927_irq_enable
comma
id|jmr3927_irq_disable
comma
id|jmr3927_irq_ack
comma
id|jmr3927_irq_end
comma
)brace
suffix:semicolon
DECL|function|jmr3927_irq_init
r_void
id|jmr3927_irq_init
c_func
(paren
id|u32
id|irq_base
)paren
(brace
id|u32
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|irq_base
suffix:semicolon
id|i
OL
id|irq_base
op_plus
id|JMR3927_NR_IRQ_IRC
op_plus
id|JMR3927_NR_IRQ_IOC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|irq_desc
(braket
id|i
)braket
dot
id|status
op_assign
id|IRQ_DISABLED
suffix:semicolon
id|irq_desc
(braket
id|i
)braket
dot
id|action
op_assign
l_int|NULL
suffix:semicolon
id|irq_desc
(braket
id|i
)braket
dot
id|depth
op_assign
l_int|1
suffix:semicolon
id|irq_desc
(braket
id|i
)braket
dot
id|handler
op_assign
op_amp
id|jmr3927_irq_controller
suffix:semicolon
)brace
id|jmr3927_irq_base
op_assign
id|irq_base
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_TX_BRANCH_LIKELY_BUG_WORKAROUND
DECL|variable|tx_branch_likely_bug_count
r_static
r_int
id|tx_branch_likely_bug_count
op_assign
l_int|0
suffix:semicolon
DECL|variable|have_tx_branch_likely_bug
r_static
r_int
id|have_tx_branch_likely_bug
op_assign
l_int|0
suffix:semicolon
DECL|function|tx_branch_likely_bug_fixup
r_void
id|tx_branch_likely_bug_fixup
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
multiline_comment|/* TX39/49-BUG: Under this condition, the insn in delay slot&n;           of the branch likely insn is executed (not nullified) even&n;           the branch condition is false. */
r_if
c_cond
(paren
op_logical_neg
id|have_tx_branch_likely_bug
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
(paren
id|regs-&gt;cp0_epc
op_amp
l_int|0xfff
)paren
op_eq
l_int|0xffc
op_logical_and
id|KSEGX
c_func
(paren
id|regs-&gt;cp0_epc
)paren
op_ne
id|KSEG0
op_logical_and
id|KSEGX
c_func
(paren
id|regs-&gt;cp0_epc
)paren
op_ne
id|KSEG1
)paren
(brace
r_int
r_int
id|insn
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|regs-&gt;cp0_epc
op_minus
l_int|4
)paren
suffix:semicolon
multiline_comment|/* beql,bnel,blezl,bgtzl */
multiline_comment|/* bltzl,bgezl,blezall,bgezall */
multiline_comment|/* bczfl, bcztl */
r_if
c_cond
(paren
(paren
id|insn
op_amp
l_int|0xf0000000
)paren
op_eq
l_int|0x50000000
op_logical_or
(paren
id|insn
op_amp
l_int|0xfc0e0000
)paren
op_eq
l_int|0x04020000
op_logical_or
(paren
id|insn
op_amp
l_int|0xf3fe0000
)paren
op_eq
l_int|0x41020000
)paren
(brace
id|regs-&gt;cp0_epc
op_sub_assign
l_int|4
suffix:semicolon
id|tx_branch_likely_bug_count
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;fix branch-likery bug in %s (insn %08x)&bslash;n&quot;
comma
id|current-&gt;comm
comma
id|insn
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
eof
