multiline_comment|/***********************************************************************&n; *&n; * Copyright 2001 MontaVista Software Inc.&n; * Author: MontaVista Software, Inc.&n; *              ahennessy@mvista.com&n; *&n; * Based on arch/mips/ddb5xxx/ddb5477/setup.c&n; *&n; *     Setup file for JMR3927.&n; *&n; * Copyright (C) 2000-2001 Toshiba Corporation&n; *&n; *  This program is free software; you can redistribute  it and/or modify it&n; *  under  the terms of  the GNU General  Public License as published by the&n; *  Free Software Foundation;  either version 2 of the  License, or (at your&n; *  option) any later version.&n; *&n; *  THIS  SOFTWARE  IS PROVIDED   ``AS  IS&squot;&squot; AND   ANY  EXPRESS OR IMPLIED&n; *  WARRANTIES,   INCLUDING, BUT NOT  LIMITED  TO, THE IMPLIED WARRANTIES OF&n; *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN&n; *  NO  EVENT  SHALL   THE AUTHOR  BE    LIABLE FOR ANY   DIRECT, INDIRECT,&n; *  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT&n; *  NOT LIMITED   TO, PROCUREMENT OF  SUBSTITUTE GOODS  OR SERVICES; LOSS OF&n; *  USE, DATA,  OR PROFITS; OR  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON&n; *  ANY THEORY OF LIABILITY, WHETHER IN  CONTRACT, STRICT LIABILITY, OR TORT&n; *  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF&n; *  THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n; *&n; *  You should have received a copy of the  GNU General Public License along&n; *  with this program; if not, write  to the Free Software Foundation, Inc.,&n; *  675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; ***********************************************************************&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/kdev_t.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/ide.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/param.h&gt;&t;/* for HZ */
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/addrspace.h&gt;
macro_line|#include &lt;asm/time.h&gt;
macro_line|#include &lt;asm/bcache.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/reboot.h&gt;
macro_line|#include &lt;asm/gdb-stub.h&gt;
macro_line|#include &lt;asm/jmr3927/jmr3927.h&gt;
macro_line|#include &lt;asm/mipsregs.h&gt;
macro_line|#include &lt;asm/traps.h&gt;
multiline_comment|/* Tick Timer divider */
DECL|macro|JMR3927_TIMER_CCD
mdefine_line|#define JMR3927_TIMER_CCD&t;0&t;/* 1/2 */
DECL|macro|JMR3927_TIMER_CLK
mdefine_line|#define JMR3927_TIMER_CLK&t;(JMR3927_IMCLK / (2 &lt;&lt; JMR3927_TIMER_CCD))
DECL|variable|led_state
r_int
r_char
id|led_state
op_assign
l_int|0xf
suffix:semicolon
r_struct
(brace
DECL|member|ram0
r_struct
id|resource
id|ram0
suffix:semicolon
DECL|member|ram1
r_struct
id|resource
id|ram1
suffix:semicolon
DECL|member|pcimem
r_struct
id|resource
id|pcimem
suffix:semicolon
DECL|member|iob
r_struct
id|resource
id|iob
suffix:semicolon
DECL|member|ioc
r_struct
id|resource
id|ioc
suffix:semicolon
DECL|member|pciio
r_struct
id|resource
id|pciio
suffix:semicolon
DECL|member|jmy1394
r_struct
id|resource
id|jmy1394
suffix:semicolon
DECL|member|rom1
r_struct
id|resource
id|rom1
suffix:semicolon
DECL|member|rom0
r_struct
id|resource
id|rom0
suffix:semicolon
DECL|member|sio0
r_struct
id|resource
id|sio0
suffix:semicolon
DECL|member|sio1
r_struct
id|resource
id|sio1
suffix:semicolon
DECL|variable|jmr3927_resources
)brace
id|jmr3927_resources
op_assign
(brace
(brace
l_string|&quot;RAM0&quot;
comma
l_int|0
comma
l_int|0x01FFFFFF
comma
id|IORESOURCE_MEM
)brace
comma
(brace
l_string|&quot;RAM1&quot;
comma
l_int|0x02000000
comma
l_int|0x03FFFFFF
comma
id|IORESOURCE_MEM
)brace
comma
(brace
l_string|&quot;PCIMEM&quot;
comma
l_int|0x08000000
comma
l_int|0x07FFFFFF
comma
id|IORESOURCE_MEM
)brace
comma
(brace
l_string|&quot;IOB&quot;
comma
l_int|0x10000000
comma
l_int|0x13FFFFFF
)brace
comma
(brace
l_string|&quot;IOC&quot;
comma
l_int|0x14000000
comma
l_int|0x14FFFFFF
)brace
comma
(brace
l_string|&quot;PCIIO&quot;
comma
l_int|0x15000000
comma
l_int|0x15FFFFFF
)brace
comma
(brace
l_string|&quot;JMY1394&quot;
comma
l_int|0x1D000000
comma
l_int|0x1D3FFFFF
)brace
comma
(brace
l_string|&quot;ROM1&quot;
comma
l_int|0x1E000000
comma
l_int|0x1E3FFFFF
)brace
comma
(brace
l_string|&quot;ROM0&quot;
comma
l_int|0x1FC00000
comma
l_int|0x1FFFFFFF
)brace
comma
(brace
l_string|&quot;SIO0&quot;
comma
l_int|0xFFFEF300
comma
l_int|0xFFFEF3FF
)brace
comma
(brace
l_string|&quot;SIO1&quot;
comma
l_int|0xFFFEF400
comma
l_int|0xFFFEF4FF
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* don&squot;t enable - see errata */
DECL|variable|jmr3927_ccfg_toeon
r_int
id|jmr3927_ccfg_toeon
op_assign
l_int|0
suffix:semicolon
DECL|function|do_reset
r_static
r_inline
r_void
id|do_reset
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_TC35815
r_extern
r_void
id|tc35815_killall
c_func
(paren
r_void
)paren
suffix:semicolon
id|tc35815_killall
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if 1&t;/* Resetting PCI bus */
id|jmr3927_ioc_reg_out
c_func
(paren
l_int|0
comma
id|JMR3927_IOC_RESET_ADDR
)paren
suffix:semicolon
id|jmr3927_ioc_reg_out
c_func
(paren
id|JMR3927_IOC_RESET_PCI
comma
id|JMR3927_IOC_RESET_ADDR
)paren
suffix:semicolon
(paren
r_void
)paren
id|jmr3927_ioc_reg_in
c_func
(paren
id|JMR3927_IOC_RESET_ADDR
)paren
suffix:semicolon
multiline_comment|/* flush WB */
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|jmr3927_ioc_reg_out
c_func
(paren
l_int|0
comma
id|JMR3927_IOC_RESET_ADDR
)paren
suffix:semicolon
macro_line|#endif
id|jmr3927_ioc_reg_out
c_func
(paren
id|JMR3927_IOC_RESET_CPU
comma
id|JMR3927_IOC_RESET_ADDR
)paren
suffix:semicolon
)brace
DECL|function|jmr3927_machine_restart
r_static
r_void
id|jmr3927_machine_restart
c_func
(paren
r_char
op_star
id|command
)paren
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot;Rebooting...&quot;
)paren
suffix:semicolon
id|do_reset
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|jmr3927_machine_halt
r_static
r_void
id|jmr3927_machine_halt
c_func
(paren
r_void
)paren
(brace
id|puts
c_func
(paren
l_string|&quot;JMR-TX3927 halted.&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|jmr3927_machine_power_off
r_static
r_void
id|jmr3927_machine_power_off
c_func
(paren
r_void
)paren
(brace
id|puts
c_func
(paren
l_string|&quot;JMR-TX3927 halted. Please turn off the power.&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|macro|USE_RTC_DS1742
mdefine_line|#define USE_RTC_DS1742
macro_line|#ifdef USE_RTC_DS1742
r_extern
r_void
id|rtc_ds1742_init
c_func
(paren
r_int
r_int
id|base
)paren
suffix:semicolon
macro_line|#endif
DECL|function|jmr3927_time_init
r_static
r_void
id|__init
id|jmr3927_time_init
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef USE_RTC_DS1742
r_if
c_cond
(paren
id|jmr3927_have_nvram
c_func
(paren
)paren
)paren
(brace
id|rtc_ds1742_init
c_func
(paren
id|JMR3927_IOC_NVRAMB_ADDR
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
r_int
r_int
id|jmr3927_do_gettimeoffset
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_int
id|setup_irq
c_func
(paren
r_int
r_int
id|irq
comma
r_struct
id|irqaction
op_star
id|irqaction
)paren
suffix:semicolon
DECL|function|jmr3927_timer_setup
r_static
r_void
id|__init
id|jmr3927_timer_setup
c_func
(paren
r_struct
id|irqaction
op_star
id|irq
)paren
(brace
id|do_gettimeoffset
op_assign
id|jmr3927_do_gettimeoffset
suffix:semicolon
id|jmr3927_tmrptr-&gt;cpra
op_assign
id|JMR3927_TIMER_CLK
op_div
id|HZ
suffix:semicolon
id|jmr3927_tmrptr-&gt;itmr
op_assign
id|TXx927_TMTITMR_TIIE
op_or
id|TXx927_TMTITMR_TZCE
suffix:semicolon
id|jmr3927_tmrptr-&gt;ccdr
op_assign
id|JMR3927_TIMER_CCD
suffix:semicolon
id|jmr3927_tmrptr-&gt;tcr
op_assign
id|TXx927_TMTCR_TCE
op_or
id|TXx927_TMTCR_CCDE
op_or
id|TXx927_TMTCR_TMODE_ITVL
suffix:semicolon
id|setup_irq
c_func
(paren
id|JMR3927_IRQ_TICK
comma
id|irq
)paren
suffix:semicolon
)brace
DECL|macro|USECS_PER_JIFFY
mdefine_line|#define USECS_PER_JIFFY (1000000/HZ)
DECL|function|jmr3927_do_gettimeoffset
r_int
r_int
id|jmr3927_do_gettimeoffset
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|count
suffix:semicolon
r_int
r_int
id|res
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* MUST read TRR before TISR. */
id|count
op_assign
id|jmr3927_tmrptr-&gt;trr
suffix:semicolon
r_if
c_cond
(paren
id|jmr3927_tmrptr-&gt;tisr
op_amp
id|TXx927_TMTISR_TIIS
)paren
(brace
multiline_comment|/* timer interrupt is pending.  use Max value. */
id|res
op_assign
id|USECS_PER_JIFFY
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* convert to usec */
multiline_comment|/* res = count / (JMR3927_TIMER_CLK / 1000000); */
id|res
op_assign
(paren
id|count
op_lshift
l_int|7
)paren
op_div
(paren
(paren
id|JMR3927_TIMER_CLK
op_lshift
l_int|7
)paren
op_div
l_int|1000000
)paren
suffix:semicolon
multiline_comment|/*&n;                * Due to possible jiffies inconsistencies, we need to check&n;                * the result so that we&squot;ll get a timer that is monotonic.&n;                */
r_if
c_cond
(paren
id|res
op_ge
id|USECS_PER_JIFFY
)paren
id|res
op_assign
id|USECS_PER_JIFFY
op_minus
l_int|1
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
macro_line|#if defined(CONFIG_BLK_DEV_INITRD)
r_extern
r_int
r_int
id|__rd_start
comma
id|__rd_end
comma
id|initrd_start
comma
id|initrd_end
suffix:semicolon
macro_line|#endif
singleline_comment|//#undef DO_WRITE_THROUGH
DECL|macro|DO_WRITE_THROUGH
mdefine_line|#define DO_WRITE_THROUGH
DECL|macro|DO_ENABLE_CACHE
mdefine_line|#define DO_ENABLE_CACHE
r_extern
r_char
op_star
id|__init
id|prom_getcmdline
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|jmr3927_board_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|jmr3927_irq_setup
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_struct
id|resource
id|pci_io_resource
suffix:semicolon
r_extern
r_struct
id|resource
id|pci_mem_resource
suffix:semicolon
DECL|function|jmr3927_setup
r_static
r_void
id|__init
id|jmr3927_setup
c_func
(paren
r_void
)paren
(brace
r_extern
r_int
id|panic_timeout
suffix:semicolon
r_char
op_star
id|argptr
suffix:semicolon
id|irq_setup
op_assign
id|jmr3927_irq_setup
suffix:semicolon
id|set_io_port_base
c_func
(paren
id|JMR3927_PORT_BASE
op_plus
id|JMR3927_PCIIO
)paren
suffix:semicolon
id|board_time_init
op_assign
id|jmr3927_time_init
suffix:semicolon
id|board_timer_setup
op_assign
id|jmr3927_timer_setup
suffix:semicolon
id|_machine_restart
op_assign
id|jmr3927_machine_restart
suffix:semicolon
id|_machine_halt
op_assign
id|jmr3927_machine_halt
suffix:semicolon
id|_machine_power_off
op_assign
id|jmr3927_machine_power_off
suffix:semicolon
multiline_comment|/*&n;&t; * IO/MEM resources.&n;&t; */
id|ioport_resource.start
op_assign
id|pci_io_resource.start
suffix:semicolon
id|ioport_resource.end
op_assign
id|pci_io_resource.end
suffix:semicolon
id|iomem_resource.start
op_assign
id|pci_mem_resource.start
suffix:semicolon
id|iomem_resource.end
op_assign
id|pci_mem_resource.end
suffix:semicolon
multiline_comment|/* Reboot on panic */
id|panic_timeout
op_assign
l_int|180
suffix:semicolon
(brace
r_int
r_int
id|conf
suffix:semicolon
id|conf
op_assign
id|read_c0_conf
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#if 1
multiline_comment|/* cache setup */
(brace
r_int
r_int
id|conf
suffix:semicolon
macro_line|#ifdef DO_ENABLE_CACHE
r_int
id|mips_ic_disable
op_assign
l_int|0
comma
id|mips_dc_disable
op_assign
l_int|0
suffix:semicolon
macro_line|#else
r_int
id|mips_ic_disable
op_assign
l_int|1
comma
id|mips_dc_disable
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
macro_line|#ifdef DO_WRITE_THROUGH
r_int
id|mips_config_cwfon
op_assign
l_int|0
suffix:semicolon
r_int
id|mips_config_wbon
op_assign
l_int|0
suffix:semicolon
macro_line|#else
r_int
id|mips_config_cwfon
op_assign
l_int|1
suffix:semicolon
r_int
id|mips_config_wbon
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|conf
op_assign
id|read_c0_conf
c_func
(paren
)paren
suffix:semicolon
id|conf
op_and_assign
op_complement
(paren
id|TX39_CONF_ICE
op_or
id|TX39_CONF_DCE
op_or
id|TX39_CONF_WBON
op_or
id|TX39_CONF_CWFON
)paren
suffix:semicolon
id|conf
op_or_assign
id|mips_ic_disable
ques
c_cond
l_int|0
suffix:colon
id|TX39_CONF_ICE
suffix:semicolon
id|conf
op_or_assign
id|mips_dc_disable
ques
c_cond
l_int|0
suffix:colon
id|TX39_CONF_DCE
suffix:semicolon
id|conf
op_or_assign
id|mips_config_wbon
ques
c_cond
id|TX39_CONF_WBON
suffix:colon
l_int|0
suffix:semicolon
id|conf
op_or_assign
id|mips_config_cwfon
ques
c_cond
id|TX39_CONF_CWFON
suffix:colon
l_int|0
suffix:semicolon
id|write_c0_conf
c_func
(paren
id|conf
)paren
suffix:semicolon
id|write_c0_cache
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* initialize board */
id|jmr3927_board_init
c_func
(paren
)paren
suffix:semicolon
id|argptr
op_assign
id|prom_getcmdline
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|argptr
op_assign
id|strstr
c_func
(paren
id|argptr
comma
l_string|&quot;toeon&quot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|jmr3927_ccfg_toeon
op_assign
l_int|1
suffix:semicolon
)brace
id|argptr
op_assign
id|prom_getcmdline
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|argptr
op_assign
id|strstr
c_func
(paren
id|argptr
comma
l_string|&quot;ip=&quot;
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|argptr
op_assign
id|prom_getcmdline
c_func
(paren
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|argptr
comma
l_string|&quot; ip=bootp&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_TXX927_SERIAL_CONSOLE
id|argptr
op_assign
id|prom_getcmdline
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|argptr
op_assign
id|strstr
c_func
(paren
id|argptr
comma
l_string|&quot;console=&quot;
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|argptr
op_assign
id|prom_getcmdline
c_func
(paren
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|argptr
comma
l_string|&quot; console=ttyS1,115200&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
DECL|variable|jmr3927_setup
id|early_initcall
c_func
(paren
id|jmr3927_setup
)paren
suffix:semicolon
r_static
r_void
id|tx3927_setup
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PCI
DECL|variable|mips_pci_io_base
r_int
r_int
id|mips_pci_io_base
suffix:semicolon
DECL|variable|mips_pci_io_size
r_int
r_int
id|mips_pci_io_size
suffix:semicolon
DECL|variable|mips_pci_mem_base
r_int
r_int
id|mips_pci_mem_base
suffix:semicolon
DECL|variable|mips_pci_mem_size
r_int
r_int
id|mips_pci_mem_size
suffix:semicolon
multiline_comment|/* for legacy I/O, PCI I/O PCI Bus address must be 0 */
DECL|variable|mips_pci_io_pciaddr
r_int
r_int
id|mips_pci_io_pciaddr
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
DECL|function|jmr3927_board_init
r_static
r_void
id|__init
id|jmr3927_board_init
c_func
(paren
r_void
)paren
(brace
r_char
op_star
id|argptr
suffix:semicolon
macro_line|#ifdef CONFIG_PCI
id|mips_pci_io_base
op_assign
id|JMR3927_PCIIO
suffix:semicolon
id|mips_pci_io_size
op_assign
id|JMR3927_PCIIO_SIZE
suffix:semicolon
id|mips_pci_mem_base
op_assign
id|JMR3927_PCIMEM
suffix:semicolon
id|mips_pci_mem_size
op_assign
id|JMR3927_PCIMEM_SIZE
suffix:semicolon
macro_line|#endif
id|tx3927_setup
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jmr3927_have_isac
c_func
(paren
)paren
)paren
(brace
macro_line|#ifdef CONFIG_FB_E1355
id|argptr
op_assign
id|prom_getcmdline
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|argptr
op_assign
id|strstr
c_func
(paren
id|argptr
comma
l_string|&quot;video=&quot;
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|argptr
op_assign
id|prom_getcmdline
c_func
(paren
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|argptr
comma
l_string|&quot; video=e1355fb:crt16h&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_BLK_DEV_IDE
multiline_comment|/* overrides PCI-IDE */
macro_line|#endif
)brace
multiline_comment|/* SIO0 DTR on */
id|jmr3927_ioc_reg_out
c_func
(paren
l_int|0
comma
id|JMR3927_IOC_DTR_ADDR
)paren
suffix:semicolon
id|jmr3927_led_set
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jmr3927_have_isac
c_func
(paren
)paren
)paren
id|jmr3927_io_led_set
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;JMR-TX3927 (Rev %d) --- IOC(Rev %d) DIPSW:%d,%d,%d,%d&bslash;n&quot;
comma
id|jmr3927_ioc_reg_in
c_func
(paren
id|JMR3927_IOC_BREV_ADDR
)paren
op_amp
id|JMR3927_REV_MASK
comma
id|jmr3927_ioc_reg_in
c_func
(paren
id|JMR3927_IOC_REV_ADDR
)paren
op_amp
id|JMR3927_REV_MASK
comma
id|jmr3927_dipsw1
c_func
(paren
)paren
comma
id|jmr3927_dipsw2
c_func
(paren
)paren
comma
id|jmr3927_dipsw3
c_func
(paren
)paren
comma
id|jmr3927_dipsw4
c_func
(paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jmr3927_have_isac
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;JMI-3927IO2 --- ISAC(Rev %d) DIPSW:%01x&bslash;n&quot;
comma
id|jmr3927_isac_reg_in
c_func
(paren
id|JMR3927_ISAC_REV_ADDR
)paren
op_amp
id|JMR3927_REV_MASK
comma
id|jmr3927_io_dipsw
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|tx3927_setup
r_static
r_void
id|__init
id|tx3927_setup
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* SDRAMC are configured by PROM */
multiline_comment|/* ROMC */
id|tx3927_romcptr-&gt;cr
(braket
l_int|1
)braket
op_assign
id|JMR3927_ROMCE1
op_or
l_int|0x00030048
suffix:semicolon
id|tx3927_romcptr-&gt;cr
(braket
l_int|2
)braket
op_assign
id|JMR3927_ROMCE2
op_or
l_int|0x000064c8
suffix:semicolon
id|tx3927_romcptr-&gt;cr
(braket
l_int|3
)braket
op_assign
id|JMR3927_ROMCE3
op_or
l_int|0x0003f698
suffix:semicolon
id|tx3927_romcptr-&gt;cr
(braket
l_int|5
)braket
op_assign
id|JMR3927_ROMCE5
op_or
l_int|0x0000f218
suffix:semicolon
multiline_comment|/* CCFG */
multiline_comment|/* enable Timeout BusError */
r_if
c_cond
(paren
id|jmr3927_ccfg_toeon
)paren
id|tx3927_ccfgptr-&gt;ccfg
op_or_assign
id|TX3927_CCFG_TOE
suffix:semicolon
multiline_comment|/* clear BusErrorOnWrite flag */
id|tx3927_ccfgptr-&gt;ccfg
op_and_assign
op_complement
id|TX3927_CCFG_BEOW
suffix:semicolon
multiline_comment|/* Disable PCI snoop */
id|tx3927_ccfgptr-&gt;ccfg
op_and_assign
op_complement
id|TX3927_CCFG_PSNP
suffix:semicolon
macro_line|#ifdef DO_WRITE_THROUGH
multiline_comment|/* Enable PCI SNOOP - with write through only */
id|tx3927_ccfgptr-&gt;ccfg
op_or_assign
id|TX3927_CCFG_PSNP
suffix:semicolon
macro_line|#endif
multiline_comment|/* Pin selection */
id|tx3927_ccfgptr-&gt;pcfg
op_and_assign
op_complement
id|TX3927_PCFG_SELALL
suffix:semicolon
id|tx3927_ccfgptr-&gt;pcfg
op_or_assign
id|TX3927_PCFG_SELSIOC
c_func
(paren
l_int|0
)paren
op_or
id|TX3927_PCFG_SELSIO_ALL
op_or
(paren
id|TX3927_PCFG_SELDMA_ALL
op_amp
op_complement
id|TX3927_PCFG_SELDMA
c_func
(paren
l_int|1
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TX3927 -- CRIR:%08lx CCFG:%08lx PCFG:%08lx&bslash;n&quot;
comma
id|tx3927_ccfgptr-&gt;crir
comma
id|tx3927_ccfgptr-&gt;ccfg
comma
id|tx3927_ccfgptr-&gt;pcfg
)paren
suffix:semicolon
multiline_comment|/* IRC */
multiline_comment|/* disable interrupt control */
id|tx3927_ircptr-&gt;cer
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* mask all IRC interrupts */
id|tx3927_ircptr-&gt;imr
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX3927_NUM_IR
op_div
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tx3927_ircptr-&gt;ilr
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* setup IRC interrupt mode (Low Active) */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX3927_NUM_IR
op_div
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tx3927_ircptr-&gt;cr
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* TMR */
multiline_comment|/* disable all timers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX3927_NR_TMR
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tx3927_tmrptr
c_func
(paren
id|i
)paren
op_member_access_from_pointer
id|tcr
op_assign
id|TXx927_TMTCR_CRE
suffix:semicolon
id|tx3927_tmrptr
c_func
(paren
id|i
)paren
op_member_access_from_pointer
id|tisr
op_assign
l_int|0
suffix:semicolon
id|tx3927_tmrptr
c_func
(paren
id|i
)paren
op_member_access_from_pointer
id|cpra
op_assign
l_int|0xffffffff
suffix:semicolon
id|tx3927_tmrptr
c_func
(paren
id|i
)paren
op_member_access_from_pointer
id|itmr
op_assign
l_int|0
suffix:semicolon
id|tx3927_tmrptr
c_func
(paren
id|i
)paren
op_member_access_from_pointer
id|ccdr
op_assign
l_int|0
suffix:semicolon
id|tx3927_tmrptr
c_func
(paren
id|i
)paren
op_member_access_from_pointer
id|pgmr
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* DMA */
id|tx3927_dmaptr-&gt;mcr
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|tx3927_dmaptr-&gt;ch
)paren
op_div
r_sizeof
(paren
id|tx3927_dmaptr-&gt;ch
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* reset channel */
id|tx3927_dmaptr-&gt;ch
(braket
id|i
)braket
dot
id|ccr
op_assign
id|TX3927_DMA_CCR_CHRST
suffix:semicolon
id|tx3927_dmaptr-&gt;ch
(braket
id|i
)braket
dot
id|ccr
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* enable DMA */
macro_line|#ifdef __BIG_ENDIAN
id|tx3927_dmaptr-&gt;mcr
op_assign
id|TX3927_DMA_MCR_MSTEN
suffix:semicolon
macro_line|#else
id|tx3927_dmaptr-&gt;mcr
op_assign
id|TX3927_DMA_MCR_MSTEN
op_or
id|TX3927_DMA_MCR_LE
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_PCI
multiline_comment|/* PCIC */
id|printk
c_func
(paren
l_string|&quot;TX3927 PCIC -- DID:%04x VID:%04x RID:%02x Arbiter:&quot;
comma
id|tx3927_pcicptr-&gt;did
comma
id|tx3927_pcicptr-&gt;vid
comma
id|tx3927_pcicptr-&gt;rid
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tx3927_ccfgptr-&gt;ccfg
op_amp
id|TX3927_CCFG_PCIXARB
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;External&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* XXX */
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;Internal&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Reset PCI Bus */
id|jmr3927_ioc_reg_out
c_func
(paren
l_int|0
comma
id|JMR3927_IOC_RESET_ADDR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|jmr3927_ioc_reg_out
c_func
(paren
id|JMR3927_IOC_RESET_PCI
comma
id|JMR3927_IOC_RESET_ADDR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|jmr3927_ioc_reg_out
c_func
(paren
l_int|0
comma
id|JMR3927_IOC_RESET_ADDR
)paren
suffix:semicolon
multiline_comment|/* Disable External PCI Config. Access */
id|tx3927_pcicptr-&gt;lbc
op_assign
id|TX3927_PCIC_LBC_EPCAD
suffix:semicolon
macro_line|#ifdef __BIG_ENDIAN
id|tx3927_pcicptr-&gt;lbc
op_or_assign
id|TX3927_PCIC_LBC_IBSE
op_or
id|TX3927_PCIC_LBC_TIBSE
op_or
id|TX3927_PCIC_LBC_TMFBSE
op_or
id|TX3927_PCIC_LBC_MSDSE
suffix:semicolon
macro_line|#endif
multiline_comment|/* LB-&gt;PCI mappings */
id|tx3927_pcicptr-&gt;iomas
op_assign
op_complement
(paren
id|mips_pci_io_size
op_minus
l_int|1
)paren
suffix:semicolon
id|tx3927_pcicptr-&gt;ilbioma
op_assign
id|mips_pci_io_base
suffix:semicolon
id|tx3927_pcicptr-&gt;ipbioma
op_assign
id|mips_pci_io_pciaddr
suffix:semicolon
id|tx3927_pcicptr-&gt;mmas
op_assign
op_complement
(paren
id|mips_pci_mem_size
op_minus
l_int|1
)paren
suffix:semicolon
id|tx3927_pcicptr-&gt;ilbmma
op_assign
id|mips_pci_mem_base
suffix:semicolon
id|tx3927_pcicptr-&gt;ipbmma
op_assign
id|mips_pci_mem_base
suffix:semicolon
multiline_comment|/* PCI-&gt;LB mappings */
id|tx3927_pcicptr-&gt;iobas
op_assign
l_int|0xffffffff
suffix:semicolon
id|tx3927_pcicptr-&gt;ioba
op_assign
l_int|0
suffix:semicolon
id|tx3927_pcicptr-&gt;tlbioma
op_assign
l_int|0
suffix:semicolon
id|tx3927_pcicptr-&gt;mbas
op_assign
op_complement
(paren
id|mips_pci_mem_size
op_minus
l_int|1
)paren
suffix:semicolon
id|tx3927_pcicptr-&gt;mba
op_assign
l_int|0
suffix:semicolon
id|tx3927_pcicptr-&gt;tlbmma
op_assign
l_int|0
suffix:semicolon
macro_line|#ifndef JMR3927_INIT_INDIRECT_PCI
multiline_comment|/* Enable Direct mapping Address Space Decoder */
id|tx3927_pcicptr-&gt;lbc
op_or_assign
id|TX3927_PCIC_LBC_ILMDE
op_or
id|TX3927_PCIC_LBC_ILIDE
suffix:semicolon
macro_line|#endif
multiline_comment|/* Clear All Local Bus Status */
id|tx3927_pcicptr-&gt;lbstat
op_assign
id|TX3927_PCIC_LBIM_ALL
suffix:semicolon
multiline_comment|/* Enable All Local Bus Interrupts */
id|tx3927_pcicptr-&gt;lbim
op_assign
id|TX3927_PCIC_LBIM_ALL
suffix:semicolon
multiline_comment|/* Clear All PCI Status Error */
id|tx3927_pcicptr-&gt;pcistat
op_assign
id|TX3927_PCIC_PCISTATIM_ALL
suffix:semicolon
multiline_comment|/* Enable All PCI Status Error Interrupts */
id|tx3927_pcicptr-&gt;pcistatim
op_assign
id|TX3927_PCIC_PCISTATIM_ALL
suffix:semicolon
multiline_comment|/* PCIC Int =&gt; IRC IRQ10 */
id|tx3927_pcicptr-&gt;il
op_assign
id|TX3927_IR_PCI
suffix:semicolon
macro_line|#if 1
multiline_comment|/* Target Control (per errata) */
id|tx3927_pcicptr-&gt;tc
op_assign
id|TX3927_PCIC_TC_OF8E
op_or
id|TX3927_PCIC_TC_IF8E
suffix:semicolon
macro_line|#endif
multiline_comment|/* Enable Bus Arbiter */
macro_line|#if 0
id|tx3927_pcicptr-&gt;req_trace
op_assign
l_int|0x73737373
suffix:semicolon
macro_line|#endif
id|tx3927_pcicptr-&gt;pbapmc
op_assign
id|TX3927_PCIC_PBAPMC_PBAEN
suffix:semicolon
id|tx3927_pcicptr-&gt;pcicmd
op_assign
id|PCI_COMMAND_MASTER
op_or
id|PCI_COMMAND_MEMORY
op_or
macro_line|#if 1
id|PCI_COMMAND_IO
op_or
macro_line|#endif
id|PCI_COMMAND_PARITY
op_or
id|PCI_COMMAND_SERR
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PCI */
multiline_comment|/* PIO */
multiline_comment|/* PIO[15:12] connected to LEDs */
id|tx3927_pioptr-&gt;dir
op_assign
l_int|0x0000f000
suffix:semicolon
id|tx3927_pioptr-&gt;maskcpu
op_assign
l_int|0
suffix:semicolon
id|tx3927_pioptr-&gt;maskext
op_assign
l_int|0
suffix:semicolon
(brace
r_int
r_int
id|conf
suffix:semicolon
id|conf
op_assign
id|read_c0_conf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|conf
op_amp
id|TX39_CONF_ICE
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;TX3927 I-Cache disabled.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|conf
op_amp
id|TX39_CONF_DCE
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;TX3927 D-Cache disabled.&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|conf
op_amp
id|TX39_CONF_WBON
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;TX3927 D-Cache WriteThrough.&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|conf
op_amp
id|TX39_CONF_CWFON
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;TX3927 D-Cache WriteBack.&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;TX3927 D-Cache WriteBack (CWF) .&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
eof
