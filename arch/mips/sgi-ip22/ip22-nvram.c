multiline_comment|/*&n; * ip22-nvram.c: NVRAM and serial EEPROM handling.&n; *&n; * Copyright (C) 2003 Ladislav Michl (ladis@linux-mips.org)&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/sgi/hpc3.h&gt;
macro_line|#include &lt;asm/sgi/ip22.h&gt;
multiline_comment|/* Control opcode for serial eeprom  */
DECL|macro|EEPROM_READ
mdefine_line|#define EEPROM_READ&t;0xc000&t;/* serial memory read */
DECL|macro|EEPROM_WEN
mdefine_line|#define EEPROM_WEN&t;0x9800&t;/* write enable before prog modes */
DECL|macro|EEPROM_WRITE
mdefine_line|#define EEPROM_WRITE&t;0xa000&t;/* serial memory write */
DECL|macro|EEPROM_WRALL
mdefine_line|#define EEPROM_WRALL&t;0x8800&t;/* write all registers */
DECL|macro|EEPROM_WDS
mdefine_line|#define EEPROM_WDS&t;0x8000&t;/* disable all programming */
DECL|macro|EEPROM_PRREAD
mdefine_line|#define&t;EEPROM_PRREAD&t;0xc000&t;/* read protect register */
DECL|macro|EEPROM_PREN
mdefine_line|#define&t;EEPROM_PREN&t;0x9800&t;/* enable protect register mode */
DECL|macro|EEPROM_PRCLEAR
mdefine_line|#define&t;EEPROM_PRCLEAR&t;0xffff&t;/* clear protect register */
DECL|macro|EEPROM_PRWRITE
mdefine_line|#define&t;EEPROM_PRWRITE&t;0xa000&t;/* write protect register */
DECL|macro|EEPROM_PRDS
mdefine_line|#define&t;EEPROM_PRDS&t;0x8000&t;/* disable protect register, forever */
DECL|macro|EEPROM_EPROT
mdefine_line|#define EEPROM_EPROT&t;0x01&t;/* Protect register enable */
DECL|macro|EEPROM_CSEL
mdefine_line|#define EEPROM_CSEL&t;0x02&t;/* Chip select */
DECL|macro|EEPROM_ECLK
mdefine_line|#define EEPROM_ECLK&t;0x04&t;/* EEPROM clock */
DECL|macro|EEPROM_DATO
mdefine_line|#define EEPROM_DATO&t;0x08&t;/* Data out */
DECL|macro|EEPROM_DATI
mdefine_line|#define EEPROM_DATI&t;0x10&t;/* Data in */
multiline_comment|/* We need to use this functions early... */
DECL|macro|delay
mdefine_line|#define delay()&t;({&t;&t;&t;&t;&t;&t;&bslash;&n;&t;int x;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;for (x=0; x&lt;100000; x++) __asm__ __volatile__(&quot;&quot;); })
DECL|macro|eeprom_cs_on
mdefine_line|#define eeprom_cs_on(ptr) ({&t;&bslash;&n;&t;*ptr &amp;= ~EEPROM_DATO;&t;&bslash;&n;&t;*ptr &amp;= ~EEPROM_ECLK;&t;&bslash;&n;&t;*ptr &amp;= ~EEPROM_EPROT;&t;&bslash;&n;&t;delay();&t;&t;&bslash;&n;&t;*ptr |= EEPROM_CSEL;&t;&bslash;&n;&t;*ptr |= EEPROM_ECLK; })
DECL|macro|eeprom_cs_off
mdefine_line|#define eeprom_cs_off(ptr) ({&t;&bslash;&n;&t;*ptr &amp;= ~EEPROM_ECLK;&t;&bslash;&n;&t;*ptr &amp;= ~EEPROM_CSEL;&t;&bslash;&n;&t;*ptr |= EEPROM_EPROT;&t;&bslash;&n;&t;*ptr |= EEPROM_ECLK; })
DECL|macro|BITS_IN_COMMAND
mdefine_line|#define&t;BITS_IN_COMMAND&t;11
multiline_comment|/*&n; * clock in the nvram command and the register number. For the&n; * national semiconductor nv ram chip the op code is 3 bits and&n; * the address is 6/8 bits. &n; */
DECL|function|eeprom_cmd
r_static
r_inline
r_void
id|eeprom_cmd
c_func
(paren
r_volatile
r_int
r_int
op_star
id|ctrl
comma
r_int
id|cmd
comma
r_int
id|reg
)paren
(brace
r_int
r_int
id|ser_cmd
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ser_cmd
op_assign
id|cmd
op_or
(paren
id|reg
op_lshift
(paren
l_int|16
op_minus
id|BITS_IN_COMMAND
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|BITS_IN_COMMAND
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ser_cmd
op_amp
(paren
l_int|1
op_lshift
l_int|15
)paren
)paren
multiline_comment|/* if high order bit set */
op_star
id|ctrl
op_or_assign
id|EEPROM_DATO
suffix:semicolon
r_else
op_star
id|ctrl
op_and_assign
op_complement
id|EEPROM_DATO
suffix:semicolon
op_star
id|ctrl
op_and_assign
op_complement
id|EEPROM_ECLK
suffix:semicolon
op_star
id|ctrl
op_or_assign
id|EEPROM_ECLK
suffix:semicolon
id|ser_cmd
op_lshift_assign
l_int|1
suffix:semicolon
)brace
op_star
id|ctrl
op_and_assign
op_complement
id|EEPROM_DATO
suffix:semicolon
multiline_comment|/* see data sheet timing diagram */
)brace
DECL|function|ip22_eeprom_read
r_int
r_int
id|ip22_eeprom_read
c_func
(paren
r_volatile
r_int
r_int
op_star
id|ctrl
comma
r_int
id|reg
)paren
(brace
r_int
r_int
id|res
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
op_star
id|ctrl
op_and_assign
op_complement
id|EEPROM_EPROT
suffix:semicolon
id|eeprom_cs_on
c_func
(paren
id|ctrl
)paren
suffix:semicolon
id|eeprom_cmd
c_func
(paren
id|ctrl
comma
id|EEPROM_READ
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* clock the data ouf of serial mem */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|ctrl
op_and_assign
op_complement
id|EEPROM_ECLK
suffix:semicolon
id|delay
c_func
(paren
)paren
suffix:semicolon
op_star
id|ctrl
op_or_assign
id|EEPROM_ECLK
suffix:semicolon
id|delay
c_func
(paren
)paren
suffix:semicolon
id|res
op_lshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_star
id|ctrl
op_amp
id|EEPROM_DATI
)paren
id|res
op_or_assign
l_int|1
suffix:semicolon
)brace
id|eeprom_cs_off
c_func
(paren
id|ctrl
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|variable|ip22_eeprom_read
id|EXPORT_SYMBOL
c_func
(paren
id|ip22_eeprom_read
)paren
suffix:semicolon
multiline_comment|/*&n; * Read specified register from main NVRAM&n; */
DECL|function|ip22_nvram_read
r_int
r_int
id|ip22_nvram_read
c_func
(paren
r_int
id|reg
)paren
(brace
r_if
c_cond
(paren
id|ip22_is_fullhouse
c_func
(paren
)paren
)paren
multiline_comment|/* IP22 (Indigo2 aka FullHouse) stores env variables into&n;&t;&t; * 93CS56 Microwire Bus EEPROM 2048 Bit (128x16) */
r_return
id|ip22_eeprom_read
c_func
(paren
op_amp
id|hpc3c0-&gt;eeprom
comma
id|reg
)paren
suffix:semicolon
r_else
(brace
r_int
r_int
id|tmp
suffix:semicolon
multiline_comment|/* IP24 (Indy aka Guiness) uses DS1386 8K version */
id|reg
op_lshift_assign
l_int|1
suffix:semicolon
id|tmp
op_assign
id|hpc3c0-&gt;bbram
(braket
id|reg
op_increment
)braket
op_amp
l_int|0xff
suffix:semicolon
r_return
(paren
id|tmp
op_lshift
l_int|8
)paren
op_or
(paren
id|hpc3c0-&gt;bbram
(braket
id|reg
)braket
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
)brace
DECL|variable|ip22_nvram_read
id|EXPORT_SYMBOL
c_func
(paren
id|ip22_nvram_read
)paren
suffix:semicolon
eof
