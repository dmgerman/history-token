multiline_comment|/*&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Copyright (C) 1997, 1998, 2001, 2003 by Ralf Baechle&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/notifier.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/reboot.h&gt;
macro_line|#include &lt;asm/ds1286.h&gt;
macro_line|#include &lt;asm/sgialib.h&gt;
macro_line|#include &lt;asm/sgi/ioc.h&gt;
macro_line|#include &lt;asm/sgi/hpc3.h&gt;
macro_line|#include &lt;asm/sgi/ip22.h&gt;
multiline_comment|/*&n; * Just powerdown if init hasn&squot;t done after POWERDOWN_TIMEOUT seconds.&n; * I&squot;m not sure if this feature is a good idea, for now it&squot;s here just to&n; * make the power button make behave just like under IRIX.&n; */
DECL|macro|POWERDOWN_TIMEOUT
mdefine_line|#define POWERDOWN_TIMEOUT&t;120
multiline_comment|/*&n; * Blink frequency during reboot grace period and when paniced.&n; */
DECL|macro|POWERDOWN_FREQ
mdefine_line|#define POWERDOWN_FREQ&t;&t;(HZ / 4)
DECL|macro|PANIC_FREQ
mdefine_line|#define PANIC_FREQ&t;&t;(HZ / 8)
DECL|variable|power_timer
DECL|variable|blink_timer
DECL|variable|debounce_timer
DECL|variable|volume_timer
r_static
r_struct
id|timer_list
id|power_timer
comma
id|blink_timer
comma
id|debounce_timer
comma
id|volume_timer
suffix:semicolon
DECL|macro|MACHINE_PANICED
mdefine_line|#define MACHINE_PANICED&t;&t;1
DECL|macro|MACHINE_SHUTTING_DOWN
mdefine_line|#define MACHINE_SHUTTING_DOWN&t;2
DECL|variable|machine_state
r_static
r_int
id|machine_state
op_assign
l_int|0
suffix:semicolon
r_static
r_void
id|sgi_machine_restart
c_func
(paren
r_char
op_star
id|command
)paren
id|__attribute__
c_func
(paren
(paren
id|noreturn
)paren
)paren
suffix:semicolon
r_static
r_void
id|sgi_machine_halt
c_func
(paren
r_void
)paren
id|__attribute__
c_func
(paren
(paren
id|noreturn
)paren
)paren
suffix:semicolon
r_static
r_void
id|sgi_machine_power_off
c_func
(paren
r_void
)paren
id|__attribute__
c_func
(paren
(paren
id|noreturn
)paren
)paren
suffix:semicolon
multiline_comment|/* XXX How to pass the reboot command to the firmware??? */
DECL|function|sgi_machine_restart
r_static
r_void
id|sgi_machine_restart
c_func
(paren
r_char
op_star
id|command
)paren
(brace
r_if
c_cond
(paren
id|machine_state
op_amp
id|MACHINE_SHUTTING_DOWN
)paren
id|sgi_machine_power_off
c_func
(paren
)paren
suffix:semicolon
id|ArcReboot
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|sgi_machine_halt
r_static
r_void
id|sgi_machine_halt
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|machine_state
op_amp
id|MACHINE_SHUTTING_DOWN
)paren
id|sgi_machine_power_off
c_func
(paren
)paren
suffix:semicolon
id|ArcEnterInteractiveMode
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|sgi_machine_power_off
r_static
r_void
id|sgi_machine_power_off
c_func
(paren
r_void
)paren
(brace
r_int
r_char
id|val
suffix:semicolon
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Disable watchdog */
id|val
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_CMD
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|val
op_or
id|RTC_WAM
comma
id|RTC_CMD
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
l_int|0
comma
id|RTC_WSEC
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
l_int|0
comma
id|RTC_WHSEC
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|sgioc-&gt;panel
op_assign
op_complement
id|SGIOC_PANEL_POWERON
suffix:semicolon
multiline_comment|/* Good bye cruel world ...  */
multiline_comment|/* If we&squot;re still running, we probably got sent an alarm&n;&t;&t;   interrupt.  Read the flag to clear it.  */
id|val
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_HOURS_ALARM
)paren
suffix:semicolon
)brace
)brace
DECL|function|power_timeout
r_static
r_void
id|power_timeout
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|sgi_machine_power_off
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|blink_timeout
r_static
r_void
id|blink_timeout
c_func
(paren
r_int
r_int
id|data
)paren
(brace
multiline_comment|/* XXX fix this for fullhouse  */
id|sgi_ioc_reset
op_xor_assign
(paren
id|SGIOC_RESET_LC0OFF
op_or
id|SGIOC_RESET_LC1OFF
)paren
suffix:semicolon
id|sgioc-&gt;reset
op_assign
id|sgi_ioc_reset
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|blink_timer
comma
id|jiffies
op_plus
id|data
)paren
suffix:semicolon
)brace
DECL|function|debounce
r_static
r_void
id|debounce
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|debounce_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sgint-&gt;istat1
op_amp
id|SGINT_ISTAT1_PWR
)paren
(brace
multiline_comment|/* Interrupt still being sent. */
id|debounce_timer.expires
op_assign
id|jiffies
op_plus
l_int|5
suffix:semicolon
multiline_comment|/* 0.05s  */
id|add_timer
c_func
(paren
op_amp
id|debounce_timer
)paren
suffix:semicolon
id|sgioc-&gt;panel
op_assign
id|SGIOC_PANEL_POWERON
op_or
id|SGIOC_PANEL_POWERINTR
op_or
id|SGIOC_PANEL_VOLDNINTR
op_or
id|SGIOC_PANEL_VOLDNHOLD
op_or
id|SGIOC_PANEL_VOLUPINTR
op_or
id|SGIOC_PANEL_VOLUPHOLD
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|machine_state
op_amp
id|MACHINE_PANICED
)paren
id|ArcReboot
c_func
(paren
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|SGI_PANEL_IRQ
)paren
suffix:semicolon
)brace
DECL|function|power_button
r_static
r_inline
r_void
id|power_button
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|machine_state
op_amp
id|MACHINE_PANICED
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
(paren
id|machine_state
op_amp
id|MACHINE_SHUTTING_DOWN
)paren
op_logical_or
id|kill_proc
c_func
(paren
l_int|1
comma
id|SIGINT
comma
l_int|1
)paren
)paren
(brace
multiline_comment|/* No init process or button pressed twice.  */
id|sgi_machine_power_off
c_func
(paren
)paren
suffix:semicolon
)brace
id|machine_state
op_or_assign
id|MACHINE_SHUTTING_DOWN
suffix:semicolon
id|blink_timer.data
op_assign
id|POWERDOWN_FREQ
suffix:semicolon
id|blink_timeout
c_func
(paren
id|POWERDOWN_FREQ
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|power_timer
)paren
suffix:semicolon
id|power_timer.function
op_assign
id|power_timeout
suffix:semicolon
id|power_timer.expires
op_assign
id|jiffies
op_plus
id|POWERDOWN_TIMEOUT
op_star
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|power_timer
)paren
suffix:semicolon
)brace
DECL|variable|indy_volume_button
r_void
(paren
op_star
id|indy_volume_button
)paren
(paren
r_int
)paren
op_assign
l_int|NULL
suffix:semicolon
DECL|function|volume_up_button
r_static
r_inline
r_void
id|volume_up_button
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|volume_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|indy_volume_button
)paren
id|indy_volume_button
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sgint-&gt;istat1
op_amp
id|SGINT_ISTAT1_PWR
)paren
(brace
id|volume_timer.expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|volume_timer
)paren
suffix:semicolon
)brace
)brace
DECL|function|volume_down_button
r_static
r_inline
r_void
id|volume_down_button
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|volume_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|indy_volume_button
)paren
id|indy_volume_button
c_func
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sgint-&gt;istat1
op_amp
id|SGINT_ISTAT1_PWR
)paren
(brace
id|volume_timer.expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|volume_timer
)paren
suffix:semicolon
)brace
)brace
DECL|function|panel_int
r_static
id|irqreturn_t
id|panel_int
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|buttons
suffix:semicolon
id|buttons
op_assign
id|sgioc-&gt;panel
suffix:semicolon
id|sgioc-&gt;panel
op_assign
id|SGIOC_PANEL_POWERON
op_or
id|SGIOC_PANEL_POWERINTR
suffix:semicolon
r_if
c_cond
(paren
id|sgint-&gt;istat1
op_amp
id|SGINT_ISTAT1_PWR
)paren
(brace
multiline_comment|/* Wait until interrupt goes away */
id|disable_irq
c_func
(paren
id|SGI_PANEL_IRQ
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|debounce_timer
)paren
suffix:semicolon
id|debounce_timer.function
op_assign
id|debounce
suffix:semicolon
id|debounce_timer.expires
op_assign
id|jiffies
op_plus
l_int|5
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|debounce_timer
)paren
suffix:semicolon
)brace
multiline_comment|/* Power button was pressed &n;&t; *&n;&t; * ioc.ps page 22: &quot;The Panel Register is called Power Control by Full&n;&t; * House. Only lowest 2 bits are used. Guiness uses upper four bits&n;&t; * for volume control&quot;. This is not true, all bits are pulled high&n;&t; * on fullhouse&n;&t; */
r_if
c_cond
(paren
id|ip22_is_fullhouse
c_func
(paren
)paren
op_logical_or
op_logical_neg
(paren
id|buttons
op_amp
id|SGIOC_PANEL_POWERINTR
)paren
)paren
(brace
id|power_button
c_func
(paren
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* TODO: mute/unmute */
multiline_comment|/* Volume up button was pressed */
r_if
c_cond
(paren
op_logical_neg
(paren
id|buttons
op_amp
id|SGIOC_PANEL_VOLUPINTR
)paren
)paren
(brace
id|init_timer
c_func
(paren
op_amp
id|volume_timer
)paren
suffix:semicolon
id|volume_timer.function
op_assign
id|volume_up_button
suffix:semicolon
id|volume_timer.expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|volume_timer
)paren
suffix:semicolon
)brace
multiline_comment|/* Volume down button was pressed */
r_if
c_cond
(paren
op_logical_neg
(paren
id|buttons
op_amp
id|SGIOC_PANEL_VOLDNINTR
)paren
)paren
(brace
id|init_timer
c_func
(paren
op_amp
id|volume_timer
)paren
suffix:semicolon
id|volume_timer.function
op_assign
id|volume_down_button
suffix:semicolon
id|volume_timer.expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|volume_timer
)paren
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|panic_event
r_static
r_int
id|panic_event
c_func
(paren
r_struct
id|notifier_block
op_star
id|this
comma
r_int
r_int
id|event
comma
r_void
op_star
id|ptr
)paren
(brace
r_if
c_cond
(paren
id|machine_state
op_amp
id|MACHINE_PANICED
)paren
r_return
id|NOTIFY_DONE
suffix:semicolon
id|machine_state
op_or_assign
id|MACHINE_PANICED
suffix:semicolon
id|blink_timer.data
op_assign
id|PANIC_FREQ
suffix:semicolon
id|blink_timeout
c_func
(paren
id|PANIC_FREQ
)paren
suffix:semicolon
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
DECL|variable|panic_block
r_static
r_struct
id|notifier_block
id|panic_block
op_assign
(brace
dot
id|notifier_call
op_assign
id|panic_event
comma
)brace
suffix:semicolon
DECL|function|reboot_setup
r_static
r_int
id|__init
id|reboot_setup
c_func
(paren
r_void
)paren
(brace
id|_machine_restart
op_assign
id|sgi_machine_restart
suffix:semicolon
id|_machine_halt
op_assign
id|sgi_machine_halt
suffix:semicolon
id|_machine_power_off
op_assign
id|sgi_machine_power_off
suffix:semicolon
id|request_irq
c_func
(paren
id|SGI_PANEL_IRQ
comma
id|panel_int
comma
l_int|0
comma
l_string|&quot;Front Panel&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|blink_timer
)paren
suffix:semicolon
id|blink_timer.function
op_assign
id|blink_timeout
suffix:semicolon
id|notifier_chain_register
c_func
(paren
op_amp
id|panic_notifier_list
comma
op_amp
id|panic_block
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|reboot_setup
id|subsys_initcall
c_func
(paren
id|reboot_setup
)paren
suffix:semicolon
eof
