multiline_comment|/* DMA.C - DMA functions and definitions */
multiline_comment|/* Copyright Galileo Technology. */
multiline_comment|/*&n;DESCRIPTION&n;This file gives the user a complete interface to the powerful DMA engines,&n;including functions for controling the priority mechanism.&n;To fully understand the capabilities of the DMA engines please spare some&n;time to go trough the spec.&n;*/
multiline_comment|/* includes */
macro_line|#ifdef __linux__
macro_line|#include &lt;asm/galileo/evb64120A/core.h&gt;
macro_line|#include &lt;asm/galileo/evb64120A/dma.h&gt;
macro_line|#else
macro_line|#include &quot;Core.h&quot;
macro_line|#include &quot;DMA.h&quot;
macro_line|#endif
multiline_comment|/********************************************************************&n;* dmaCommand - Write a command to a DMA channel&n;*&n;* Inputs: DMA_ENGINE channel - choosing one of the four engine.&n;*         unsigned int command - The command to be written to the control register.&n;* Returns: false if one of the parameters is erroneous else returns true.&n;*********************************************************************/
DECL|function|dmaCommand
r_bool
id|dmaCommand
c_func
(paren
id|DMA_ENGINE
id|channel
comma
r_int
r_int
id|command
)paren
(brace
r_if
c_cond
(paren
id|channel
OG
id|LAST_DMA_ENGINE
)paren
r_return
l_bool|false
suffix:semicolon
id|GT_REG_WRITE
c_func
(paren
id|CHANNEL0CONTROL
op_plus
id|channel
op_star
l_int|4
comma
id|command
)paren
suffix:semicolon
r_return
l_bool|true
suffix:semicolon
)brace
multiline_comment|/********************************************************************&n;* dmaTransfer - transfer data from sourceAddr to destAddr on DMA channel&n;* Inputs:&n;*   DMA_RECORED *nextRecoredPointer: If we are using chain mode DMA transfer,&n;*   then this pointer should point to the next recored,otherwise it should be&n;*   NULL.&n;*   VERY IMPORTANT !!! When using chain mode, the records must be 16 Bytes&n;*   aligned, the function will take care of that for you, but you need to&n;*   allocate one more record for that, meaning: if you are having 3 records ,&n;*   declare 4 (see the example bellow) and start using the second one.&n;*   Example:&n;*   Performing a chain mode DMA transfer(Copy a 1/4 mega of data using&n;*   chain mode DMA):&n;*    DMA_RECORED dmaRecoredArray[4];&n;*    dmaRecoredArray[1].ByteCnt = _64KB;&n;*    dmaRecoredArray[1].DestAdd = destAddress + _64KB;&n;*    dmaRecoredArray[1].SrcAdd  = sourceAddress + _64KB;&n;*    dmaRecoredArray[1].NextRecPtr = &amp;dmaRecoredArray[2];&n;*    dmaRecoredArray[2].ByteCnt = _64KB;&n;*    dmaRecoredArray[2].DestAdd = destAddress + 2*_64KB;&n;*    dmaRecoredArray[2].SrcAdd  = sourceAddress + 2*_64KB;&n;*    dmaRecoredArray[2].NextRecPtr = &amp;dmaRecoredArray[3];&n;*    dmaRecoredArray[3].ByteCnt = _64KB;&n;*    dmaRecoredArray[3].DestAdd = destAddress + 3*_64KB;&n;*    dmaRecoredArray[3].SrcAdd  = sourceAddress + 3*_64KB;&n;*    dmaRecoredArray[3].NextRecPtr = NULL;&n;*    performCmDma(0,sourceAddress,destAddress,_64KB,PLAIN,WAIT_TO_END,&n;*                            &amp;dmaRecoredArray[1]);&n;* Returns: NO_SUCH_CHANNEL if channel does not exist, CHANNEL_BUSY if channel&n;*          is active and true if the transfer ended successfully&n;*********************************************************************/
DECL|function|dmaTransfer
id|DMA_STATUS
id|dmaTransfer
c_func
(paren
id|DMA_ENGINE
id|channel
comma
r_int
r_int
id|sourceAddr
comma
r_int
r_int
id|destAddr
comma
r_int
r_int
id|numOfBytes
comma
r_int
r_int
id|command
comma
id|DMA_RECORED
op_star
id|nextRecoredPointer
)paren
(brace
r_int
r_int
id|tempData
comma
id|checkBits
comma
id|alignmentOffset
op_assign
l_int|0
suffix:semicolon
id|DMA_RECORED
op_star
id|next
op_assign
id|nextRecoredPointer
suffix:semicolon
r_if
c_cond
(paren
id|channel
OG
id|LAST_DMA_ENGINE
)paren
r_return
id|NO_SUCH_CHANNEL
suffix:semicolon
r_if
c_cond
(paren
id|numOfBytes
OG
l_int|0xffff
)paren
r_return
id|GENERAL_ERROR
suffix:semicolon
r_if
c_cond
(paren
id|isDmaChannelActive
c_func
(paren
id|channel
)paren
)paren
r_return
id|CHANNEL_BUSY
suffix:semicolon
r_if
c_cond
(paren
id|next
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* case of chain Mode */
id|alignmentOffset
op_assign
(paren
(paren
r_int
r_int
)paren
id|next
op_mod
l_int|16
)paren
suffix:semicolon
)brace
id|checkBits
op_assign
id|command
op_amp
l_int|0x6000000
suffix:semicolon
r_if
c_cond
(paren
id|checkBits
op_eq
l_int|0
)paren
(brace
r_while
c_loop
(paren
id|next
op_ne
l_int|NULL
)paren
(brace
id|WRITE_WORD
c_func
(paren
(paren
r_int
r_int
)paren
id|next
op_minus
id|alignmentOffset
comma
id|next-&gt;ByteCnt
)paren
suffix:semicolon
id|tempData
op_assign
(paren
r_int
r_int
)paren
id|next-&gt;SrcAdd
suffix:semicolon
id|WRITE_WORD
c_func
(paren
(paren
r_int
r_int
)paren
id|next
op_plus
l_int|4
op_minus
id|alignmentOffset
comma
id|tempData
op_amp
l_int|0x5fffffff
)paren
suffix:semicolon
id|tempData
op_assign
(paren
r_int
r_int
)paren
id|next-&gt;DestAdd
suffix:semicolon
id|WRITE_WORD
c_func
(paren
(paren
r_int
r_int
)paren
id|next
op_plus
l_int|8
op_minus
id|alignmentOffset
comma
id|tempData
op_amp
l_int|0x5fffffff
)paren
suffix:semicolon
id|tempData
op_assign
(paren
r_int
r_int
)paren
id|next-&gt;NextRecPtr
suffix:semicolon
id|WRITE_WORD
c_func
(paren
(paren
r_int
r_int
)paren
id|next
op_plus
l_int|12
op_minus
id|alignmentOffset
comma
id|tempData
op_amp
l_int|0x5fffffff
op_minus
id|alignmentOffset
)paren
suffix:semicolon
id|next
op_assign
(paren
id|DMA_RECORED
op_star
)paren
id|tempData
suffix:semicolon
r_if
c_cond
(paren
id|next
op_eq
id|nextRecoredPointer
)paren
id|next
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|GT_REG_WRITE
c_func
(paren
id|CHANNEL0_DMA_BYTE_COUNT
op_plus
id|channel
op_star
l_int|4
comma
id|numOfBytes
)paren
suffix:semicolon
id|tempData
op_assign
id|sourceAddr
suffix:semicolon
id|GT_REG_WRITE
c_func
(paren
id|CHANNEL0_DMA_SOURCE_ADDRESS
op_plus
id|channel
op_star
l_int|4
comma
id|tempData
op_amp
l_int|0x5fffffff
)paren
suffix:semicolon
id|tempData
op_assign
id|destAddr
suffix:semicolon
id|GT_REG_WRITE
c_func
(paren
id|CHANNEL0_DMA_DESTINATION_ADDRESS
op_plus
id|channel
op_star
l_int|4
comma
id|tempData
op_amp
l_int|0x5fffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nextRecoredPointer
op_ne
l_int|NULL
)paren
(brace
id|tempData
op_assign
(paren
r_int
r_int
)paren
id|nextRecoredPointer
op_minus
id|alignmentOffset
suffix:semicolon
id|GT_REG_WRITE
c_func
(paren
id|CHANNEL0NEXT_RECORD_POINTER
op_plus
l_int|4
op_star
id|channel
comma
id|tempData
op_amp
l_int|0x5fffffff
)paren
suffix:semicolon
id|command
op_assign
id|command
op_or
id|CHANNEL_ENABLE
suffix:semicolon
)brace
r_else
(brace
id|command
op_assign
id|command
op_or
id|CHANNEL_ENABLE
op_or
id|NON_CHAIN_MOD
suffix:semicolon
)brace
multiline_comment|/* Activate DMA engine By writting to dmaControlRegister */
id|GT_REG_WRITE
c_func
(paren
id|CHANNEL0CONTROL
op_plus
id|channel
op_star
l_int|4
comma
id|command
)paren
suffix:semicolon
r_return
id|DMA_OK
suffix:semicolon
)brace
multiline_comment|/********************************************************************&n;* isDmaChannelActive - check if channel is busy&n;*&n;* Inputs: channel number&n;* RETURNS: True if the channel is busy, false otherwise.&n;*********************************************************************/
DECL|function|isDmaChannelActive
r_bool
id|isDmaChannelActive
c_func
(paren
id|DMA_ENGINE
id|channel
)paren
(brace
r_int
r_int
id|data
suffix:semicolon
r_if
c_cond
(paren
id|channel
OG
id|LAST_DMA_ENGINE
)paren
r_return
l_bool|false
suffix:semicolon
id|GT_REG_READ
c_func
(paren
id|CHANNEL0CONTROL
op_plus
l_int|4
op_star
id|channel
comma
op_amp
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_amp
id|DMA_ACTIVITY_STATUS
)paren
r_return
l_bool|true
suffix:semicolon
r_else
r_return
l_bool|false
suffix:semicolon
)brace
multiline_comment|/********************************************************************&n;* changeDmaPriority - update the arbiter`s priority for channels 0-3&n;*&n;* Inputs: priority  for channels 0-1, priority  for channels 2-3,&n;          priority for groups and other priority options&n;* RETURNS: false if one of the parameters is erroneous and true else&n;*********************************************************************/
DECL|function|changeDmaPriority
r_bool
id|changeDmaPriority
c_func
(paren
id|PRIO_CHAN_0_1
id|prio_01
comma
id|PRIO_CHAN_2_3
id|prio_23
comma
id|PRIO_GROUP
id|prioGrp
comma
id|PRIO_OPT
id|prioOpt
)paren
(brace
r_int
r_int
id|prioReg
op_assign
l_int|0
suffix:semicolon
id|prioReg
op_assign
(paren
id|prio_01
op_amp
l_int|0x3
)paren
op_plus
(paren
(paren
id|prio_23
op_amp
l_int|0x3
)paren
op_lshift
l_int|2
)paren
op_plus
(paren
(paren
id|prioGrp
op_amp
l_int|0x3
)paren
op_lshift
l_int|4
)paren
op_plus
(paren
id|prioOpt
op_lshift
l_int|6
)paren
suffix:semicolon
id|GT_REG_WRITE
c_func
(paren
id|ARBITER_CONTROL
comma
id|prioReg
)paren
suffix:semicolon
r_return
l_bool|true
suffix:semicolon
)brace
eof
