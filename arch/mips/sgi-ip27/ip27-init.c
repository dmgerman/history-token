multiline_comment|/*&n; * This file is subject to the terms and conditions of the GNU General&n; * Public License.  See the file &quot;COPYING&quot; in the main directory of this&n; * archive for more details.&n; *&n; * Copyright (C) 2000 - 2001 by Kanoj Sarcar (kanoj@sgi.com)&n; * Copyright (C) 2000 - 2001 by Silicon Graphics, Inc.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/cpumask.h&gt;
macro_line|#include &lt;asm/cpu.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/time.h&gt;
macro_line|#include &lt;asm/sn/types.h&gt;
macro_line|#include &lt;asm/sn/sn0/addrs.h&gt;
macro_line|#include &lt;asm/sn/sn0/hubni.h&gt;
macro_line|#include &lt;asm/sn/sn0/hubio.h&gt;
macro_line|#include &lt;asm/sn/klconfig.h&gt;
macro_line|#include &lt;asm/sn/ioc3.h&gt;
macro_line|#include &lt;asm/mipsregs.h&gt;
macro_line|#include &lt;asm/sn/gda.h&gt;
macro_line|#include &lt;asm/sn/hub.h&gt;
macro_line|#include &lt;asm/sn/intr.h&gt;
macro_line|#include &lt;asm/current.h&gt;
macro_line|#include &lt;asm/smp.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/mmu_context.h&gt;
macro_line|#include &lt;asm/thread_info.h&gt;
macro_line|#include &lt;asm/sn/launch.h&gt;
macro_line|#include &lt;asm/sn/sn_private.h&gt;
macro_line|#include &lt;asm/sn/sn0/ip27.h&gt;
macro_line|#include &lt;asm/sn/mapped_kernel.h&gt;
DECL|macro|CPU_NONE
mdefine_line|#define CPU_NONE&t;&t;(cpuid_t)-1
r_static
id|DECLARE_BITMAP
c_func
(paren
id|hub_init_mask
comma
id|MAX_COMPACT_NODES
)paren
suffix:semicolon
DECL|variable|master_nasid
id|nasid_t
id|master_nasid
op_assign
id|INVALID_NASID
suffix:semicolon
DECL|variable|nasid_to_compact_node
id|cnodeid_t
id|nasid_to_compact_node
(braket
id|MAX_NASIDS
)braket
suffix:semicolon
DECL|variable|compact_to_nasid_node
id|nasid_t
id|compact_to_nasid_node
(braket
id|MAX_COMPACT_NODES
)braket
suffix:semicolon
DECL|variable|cpuid_to_compact_node
id|cnodeid_t
id|cpuid_to_compact_node
(braket
id|MAXCPUS
)braket
suffix:semicolon
DECL|variable|nasid_to_compact_node
id|EXPORT_SYMBOL
c_func
(paren
id|nasid_to_compact_node
)paren
suffix:semicolon
r_extern
r_void
id|pcibr_setup
c_func
(paren
id|cnodeid_t
)paren
suffix:semicolon
r_extern
r_void
id|xtalk_probe_node
c_func
(paren
id|cnodeid_t
id|nid
)paren
suffix:semicolon
DECL|function|per_hub_init
r_static
r_void
id|__init
id|per_hub_init
c_func
(paren
id|cnodeid_t
id|cnode
)paren
(brace
r_struct
id|hub_data
op_star
id|hub
op_assign
id|hub_data
c_func
(paren
id|cnode
)paren
suffix:semicolon
id|nasid_t
id|nasid
op_assign
id|COMPACT_TO_NASID_NODEID
c_func
(paren
id|cnode
)paren
suffix:semicolon
id|cpu_set
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
id|hub-&gt;h_cpus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|cnode
comma
id|hub_init_mask
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * Set CRB timeout at 5ms, (&lt; PI timeout of 10ms)&n;&t; */
id|REMOTE_HUB_S
c_func
(paren
id|nasid
comma
id|IIO_ICTP
comma
l_int|0x800
)paren
suffix:semicolon
id|REMOTE_HUB_S
c_func
(paren
id|nasid
comma
id|IIO_ICTO
comma
l_int|0xff
)paren
suffix:semicolon
id|hub_rtc_init
c_func
(paren
id|cnode
)paren
suffix:semicolon
id|xtalk_probe_node
c_func
(paren
id|cnode
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_REPLICATE_EXHANDLERS
multiline_comment|/*&n;&t; * If this is not a headless node initialization,&n;&t; * copy over the caliased exception handlers.&n;&t; */
r_if
c_cond
(paren
id|get_compact_nodeid
c_func
(paren
)paren
op_eq
id|cnode
)paren
(brace
r_extern
r_char
id|except_vec0
comma
id|except_vec1_r4k
suffix:semicolon
r_extern
r_char
id|except_vec2_generic
comma
id|except_vec3_generic
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|KSEG0
op_plus
l_int|0x100
)paren
comma
op_amp
id|except_vec2_generic
comma
l_int|0x80
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|KSEG0
op_plus
l_int|0x180
)paren
comma
op_amp
id|except_vec3_generic
comma
l_int|0x80
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|KSEG0
comma
op_amp
id|except_vec0
comma
l_int|0x80
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|KSEG0
op_plus
l_int|0x080
comma
op_amp
id|except_vec1_r4k
comma
l_int|0x80
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|KSEG0
op_plus
l_int|0x100
)paren
comma
(paren
r_void
op_star
)paren
id|KSEG0
comma
l_int|0x80
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|KSEG0
op_plus
l_int|0x180
)paren
comma
op_amp
id|except_vec3_generic
comma
l_int|0x100
)paren
suffix:semicolon
id|__flush_cache_all
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
DECL|function|per_cpu_init
r_void
id|__init
id|per_cpu_init
c_func
(paren
r_void
)paren
(brace
r_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_int
id|slice
op_assign
id|LOCAL_HUB_L
c_func
(paren
id|PI_CPU_NUM
)paren
suffix:semicolon
id|cnodeid_t
id|cnode
op_assign
id|get_compact_nodeid
c_func
(paren
)paren
suffix:semicolon
r_struct
id|hub_data
op_star
id|hub
op_assign
id|hub_data
c_func
(paren
id|cnode
)paren
suffix:semicolon
r_struct
id|slice_data
op_star
id|si
op_assign
id|hub-&gt;slice
op_plus
id|slice
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|slice
comma
op_amp
id|hub-&gt;slice_map
)paren
)paren
r_return
suffix:semicolon
id|clear_c0_status
c_func
(paren
id|ST0_IM
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|LEVELS_PER_SLICE
suffix:semicolon
id|i
op_increment
)paren
id|si-&gt;level_to_irq
(braket
id|i
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Some interrupts are reserved by hardware or by software convention.&n;&t; * Mark these as reserved right away so they won&squot;t be used accidently&n;&t; * later.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|BASE_PCI_IRQ
suffix:semicolon
id|i
op_increment
)paren
(brace
id|__set_bit
c_func
(paren
id|i
comma
id|si-&gt;irq_alloc_mask
)paren
suffix:semicolon
id|LOCAL_HUB_S
c_func
(paren
id|PI_INT_PEND_MOD
comma
id|i
)paren
suffix:semicolon
)brace
id|__set_bit
c_func
(paren
id|IP_PEND0_6_63
comma
id|si-&gt;irq_alloc_mask
)paren
suffix:semicolon
id|LOCAL_HUB_S
c_func
(paren
id|PI_INT_PEND_MOD
comma
id|IP_PEND0_6_63
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|NI_BRDCAST_ERR_A
suffix:semicolon
id|i
op_le
id|MSC_PANIC_INTR
suffix:semicolon
id|i
op_increment
)paren
(brace
id|__set_bit
c_func
(paren
id|i
comma
id|si-&gt;irq_alloc_mask
op_plus
l_int|1
)paren
suffix:semicolon
id|LOCAL_HUB_S
c_func
(paren
id|PI_INT_PEND_MOD
comma
id|i
)paren
suffix:semicolon
)brace
id|LOCAL_HUB_L
c_func
(paren
id|PI_INT_PEND0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We use this so we can find the local hub&squot;s data as fast as only&n;&t; * possible.&n;&t; */
id|cpu_data
(braket
id|cpu
)braket
dot
id|data
op_assign
id|si
suffix:semicolon
id|cpu_time_init
c_func
(paren
)paren
suffix:semicolon
id|install_ipi
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Install our NMI handler if symmon hasn&squot;t installed one. */
id|install_cpu_nmi_handler
c_func
(paren
id|cputoslice
c_func
(paren
id|cpu
)paren
)paren
suffix:semicolon
id|set_c0_status
c_func
(paren
id|SRB_DEV0
op_or
id|SRB_DEV1
)paren
suffix:semicolon
id|per_hub_init
c_func
(paren
id|cnode
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * get_nasid() returns the physical node id number of the caller.&n; */
id|nasid_t
DECL|function|get_nasid
id|get_nasid
c_func
(paren
r_void
)paren
(brace
r_return
(paren
id|nasid_t
)paren
(paren
(paren
id|LOCAL_HUB_L
c_func
(paren
id|NI_STATUS_REV_ID
)paren
op_amp
id|NSRI_NODEID_MASK
)paren
op_rshift
id|NSRI_NODEID_SHFT
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Map the physical node id to a virtual node id (virtual node ids are contiguous).&n; */
DECL|function|get_compact_nodeid
id|cnodeid_t
id|get_compact_nodeid
c_func
(paren
r_void
)paren
(brace
r_return
id|NASID_TO_COMPACT_NODEID
c_func
(paren
id|get_nasid
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Extracted from the IOC3 meta driver.  FIXME.  */
DECL|function|ioc3_sio_init
r_static
r_inline
r_void
id|ioc3_sio_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|ioc3
op_star
id|ioc3
suffix:semicolon
id|nasid_t
id|nid
suffix:semicolon
r_int
id|loops
suffix:semicolon
id|nid
op_assign
id|get_nasid
c_func
(paren
)paren
suffix:semicolon
id|ioc3
op_assign
(paren
r_struct
id|ioc3
op_star
)paren
id|KL_CONFIG_CH_CONS_INFO
c_func
(paren
id|nid
)paren
op_member_access_from_pointer
id|memory_base
suffix:semicolon
id|ioc3-&gt;sscr_a
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* PIO mode for uarta.  */
id|ioc3-&gt;sscr_b
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* PIO mode for uartb.  */
id|ioc3-&gt;sio_iec
op_assign
op_complement
l_int|0
suffix:semicolon
id|ioc3-&gt;sio_ies
op_assign
(paren
id|SIO_IR_SA_INT
op_or
id|SIO_IR_SB_INT
)paren
suffix:semicolon
id|loops
op_assign
l_int|1000000
suffix:semicolon
r_while
c_loop
(paren
id|loops
op_decrement
)paren
(brace
suffix:semicolon
)brace
id|ioc3-&gt;sregs.uarta.iu_fcr
op_assign
l_int|0
suffix:semicolon
id|ioc3-&gt;sregs.uartb.iu_fcr
op_assign
l_int|0
suffix:semicolon
id|loops
op_assign
l_int|1000000
suffix:semicolon
r_while
c_loop
(paren
id|loops
op_decrement
)paren
(brace
suffix:semicolon
)brace
)brace
DECL|function|ioc3_eth_init
r_static
r_inline
r_void
id|ioc3_eth_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|ioc3
op_star
id|ioc3
suffix:semicolon
id|nasid_t
id|nid
suffix:semicolon
id|nid
op_assign
id|get_nasid
c_func
(paren
)paren
suffix:semicolon
id|ioc3
op_assign
(paren
r_struct
id|ioc3
op_star
)paren
id|KL_CONFIG_CH_CONS_INFO
c_func
(paren
id|nid
)paren
op_member_access_from_pointer
id|memory_base
suffix:semicolon
id|ioc3-&gt;eier
op_assign
l_int|0
suffix:semicolon
)brace
r_extern
r_void
id|ip27_setup_console
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|ip27_time_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|ip27_reboot_setup
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|function|ip27_setup
r_static
r_int
id|__init
id|ip27_setup
c_func
(paren
r_void
)paren
(brace
id|hubreg_t
id|p
comma
id|e
comma
id|n_mode
suffix:semicolon
id|nasid_t
id|nid
suffix:semicolon
id|ip27_setup_console
c_func
(paren
)paren
suffix:semicolon
id|ip27_reboot_setup
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * hub_rtc init and cpu clock intr enabled for later calibrate_delay.&n;&t; */
id|nid
op_assign
id|get_nasid
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;IP27: Running on node %d.&bslash;n&quot;
comma
id|nid
)paren
suffix:semicolon
id|p
op_assign
id|LOCAL_HUB_L
c_func
(paren
id|PI_CPU_PRESENT_A
)paren
op_amp
l_int|1
suffix:semicolon
id|e
op_assign
id|LOCAL_HUB_L
c_func
(paren
id|PI_CPU_ENABLE_A
)paren
op_amp
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Node %d has %s primary CPU%s.&bslash;n&quot;
comma
id|nid
comma
id|p
ques
c_cond
l_string|&quot;a&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|e
ques
c_cond
l_string|&quot;, CPU is running&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|p
op_assign
id|LOCAL_HUB_L
c_func
(paren
id|PI_CPU_PRESENT_B
)paren
op_amp
l_int|1
suffix:semicolon
id|e
op_assign
id|LOCAL_HUB_L
c_func
(paren
id|PI_CPU_ENABLE_B
)paren
op_amp
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Node %d has %s secondary CPU%s.&bslash;n&quot;
comma
id|nid
comma
id|p
ques
c_cond
l_string|&quot;a&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|e
ques
c_cond
l_string|&quot;, CPU is running&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Try to catch kernel missconfigurations and give user an&n;&t; * indication what option to select.&n;&t; */
id|n_mode
op_assign
id|LOCAL_HUB_L
c_func
(paren
id|NI_STATUS_REV_ID
)paren
op_amp
id|NSRI_MORENODES_MASK
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Machine is in %c mode.&bslash;n&quot;
comma
id|n_mode
ques
c_cond
l_char|&squot;N&squot;
suffix:colon
l_char|&squot;M&squot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SGI_SN0_N_MODE
r_if
c_cond
(paren
op_logical_neg
id|n_mode
)paren
id|panic
c_func
(paren
l_string|&quot;Kernel compiled for M mode.&quot;
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|n_mode
)paren
id|panic
c_func
(paren
l_string|&quot;Kernel compiled for N mode.&quot;
)paren
suffix:semicolon
macro_line|#endif
id|ioc3_sio_init
c_func
(paren
)paren
suffix:semicolon
id|ioc3_eth_init
c_func
(paren
)paren
suffix:semicolon
id|per_cpu_init
c_func
(paren
)paren
suffix:semicolon
id|set_io_port_base
c_func
(paren
id|IO_BASE
)paren
suffix:semicolon
id|board_time_init
op_assign
id|ip27_time_init
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ip27_setup
id|early_initcall
c_func
(paren
id|ip27_setup
)paren
suffix:semicolon
eof
