multiline_comment|/*&n; * This file is subject to the terms and conditions of the GNU General&n; * Public License.  See the file &quot;COPYING&quot; in the main directory of this&n; * archive for more details.&n; *&n; * Copyright (C) 2000 - 2001 by Kanoj Sarcar (kanoj@sgi.com)&n; * Copyright (C) 2000 - 2001 by Silicon Graphics, Inc.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mmzone.h&gt;&t;/* for numnodes */
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/cpumask.h&gt;
macro_line|#include &lt;asm/cpu.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/time.h&gt;
macro_line|#include &lt;asm/sn/types.h&gt;
macro_line|#include &lt;asm/sn/sn0/addrs.h&gt;
macro_line|#include &lt;asm/sn/sn0/hubni.h&gt;
macro_line|#include &lt;asm/sn/sn0/hubio.h&gt;
macro_line|#include &lt;asm/sn/klconfig.h&gt;
macro_line|#include &lt;asm/sn/ioc3.h&gt;
macro_line|#include &lt;asm/mipsregs.h&gt;
macro_line|#include &lt;asm/sn/gda.h&gt;
macro_line|#include &lt;asm/sn/hub.h&gt;
macro_line|#include &lt;asm/sn/intr.h&gt;
macro_line|#include &lt;asm/current.h&gt;
macro_line|#include &lt;asm/smp.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/mmu_context.h&gt;
macro_line|#include &lt;asm/thread_info.h&gt;
macro_line|#include &lt;asm/sn/launch.h&gt;
macro_line|#include &lt;asm/sn/sn_private.h&gt;
macro_line|#include &lt;asm/sn/sn0/ip27.h&gt;
macro_line|#include &lt;asm/sn/mapped_kernel.h&gt;
DECL|macro|CPU_NONE
mdefine_line|#define CPU_NONE&t;&t;(cpuid_t)-1
r_static
id|DECLARE_BITMAP
c_func
(paren
id|hub_init_mask
comma
id|MAX_COMPACT_NODES
)paren
suffix:semicolon
DECL|variable|region_mask
r_static
id|hubreg_t
id|region_mask
suffix:semicolon
DECL|variable|fine_mode
r_static
r_int
id|fine_mode
suffix:semicolon
DECL|variable|router_distance
r_static
r_int
id|router_distance
suffix:semicolon
DECL|variable|master_nasid
id|nasid_t
id|master_nasid
op_assign
id|INVALID_NASID
suffix:semicolon
DECL|variable|nasid_to_compact_node
id|cnodeid_t
id|nasid_to_compact_node
(braket
id|MAX_NASIDS
)braket
suffix:semicolon
DECL|variable|compact_to_nasid_node
id|nasid_t
id|compact_to_nasid_node
(braket
id|MAX_COMPACT_NODES
)braket
suffix:semicolon
DECL|variable|cpuid_to_compact_node
id|cnodeid_t
id|cpuid_to_compact_node
(braket
id|MAXCPUS
)braket
suffix:semicolon
DECL|variable|node_distances
r_char
id|node_distances
(braket
id|MAX_COMPACT_NODES
)braket
(braket
id|MAX_COMPACT_NODES
)braket
suffix:semicolon
DECL|function|get_region
r_static
id|hubreg_t
id|get_region
c_func
(paren
id|cnodeid_t
id|cnode
)paren
(brace
r_if
c_cond
(paren
id|fine_mode
)paren
r_return
id|COMPACT_TO_NASID_NODEID
c_func
(paren
id|cnode
)paren
op_rshift
id|NASID_TO_FINEREG_SHFT
suffix:semicolon
r_else
r_return
id|COMPACT_TO_NASID_NODEID
c_func
(paren
id|cnode
)paren
op_rshift
id|NASID_TO_COARSEREG_SHFT
suffix:semicolon
)brace
DECL|function|gen_region_mask
r_static
r_void
id|gen_region_mask
c_func
(paren
id|hubreg_t
op_star
id|region_mask
comma
r_int
id|maxnodes
)paren
(brace
id|cnodeid_t
id|cnode
suffix:semicolon
(paren
op_star
id|region_mask
)paren
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|cnode
op_assign
l_int|0
suffix:semicolon
id|cnode
OL
id|maxnodes
suffix:semicolon
id|cnode
op_increment
)paren
(brace
(paren
op_star
id|region_mask
)paren
op_or_assign
l_int|1ULL
op_lshift
id|get_region
c_func
(paren
id|cnode
)paren
suffix:semicolon
)brace
)brace
DECL|function|is_fine_dirmode
r_static
r_int
id|is_fine_dirmode
c_func
(paren
r_void
)paren
(brace
r_return
(paren
(paren
(paren
id|LOCAL_HUB_L
c_func
(paren
id|NI_STATUS_REV_ID
)paren
op_amp
id|NSRI_REGIONSIZE_MASK
)paren
op_rshift
id|NSRI_REGIONSIZE_SHFT
)paren
op_amp
id|REGIONSIZE_FINE
)paren
suffix:semicolon
)brace
r_extern
r_void
id|pcibr_setup
c_func
(paren
id|cnodeid_t
)paren
suffix:semicolon
DECL|function|per_slice_init
r_static
id|__init
r_void
id|per_slice_init
c_func
(paren
id|cnodeid_t
id|cnode
comma
r_int
id|slice
)paren
(brace
r_struct
id|slice_data
op_star
id|si
op_assign
id|hub_data
(braket
id|cnode
)braket
op_member_access_from_pointer
id|slice
op_plus
id|slice
suffix:semicolon
r_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|LEVELS_PER_SLICE
suffix:semicolon
id|i
op_increment
)paren
id|si-&gt;level_to_irq
(braket
id|i
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Some interrupts are reserved by hardware or by software convention.&n;&t; * Mark these as reserved right away so they won&squot;t be used accidently&n;&t; * later.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|BASE_PCI_IRQ
suffix:semicolon
id|i
op_increment
)paren
(brace
id|__set_bit
c_func
(paren
id|i
comma
id|si-&gt;irq_alloc_mask
)paren
suffix:semicolon
id|LOCAL_HUB_S
c_func
(paren
id|PI_INT_PEND_MOD
comma
id|i
)paren
suffix:semicolon
)brace
id|__set_bit
c_func
(paren
id|IP_PEND0_6_63
comma
id|si-&gt;irq_alloc_mask
)paren
suffix:semicolon
id|LOCAL_HUB_S
c_func
(paren
id|PI_INT_PEND_MOD
comma
id|IP_PEND0_6_63
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|NI_BRDCAST_ERR_A
suffix:semicolon
id|i
op_le
id|MSC_PANIC_INTR
suffix:semicolon
id|i
op_increment
)paren
(brace
id|__set_bit
c_func
(paren
id|i
comma
id|si-&gt;irq_alloc_mask
op_plus
l_int|1
)paren
suffix:semicolon
id|LOCAL_HUB_S
c_func
(paren
id|PI_INT_PEND_MOD
comma
id|i
)paren
suffix:semicolon
)brace
id|LOCAL_HUB_L
c_func
(paren
id|PI_INT_PEND0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We use this so we can find the local hub&squot;s data as fast as only&n;&t; * possible.&n;&t; */
id|cpu_data
(braket
id|cpu
)braket
dot
id|data
op_assign
id|si
suffix:semicolon
)brace
r_extern
r_void
id|xtalk_probe_node
c_func
(paren
id|cnodeid_t
id|nid
)paren
suffix:semicolon
DECL|function|per_hub_init
r_void
id|__init
id|per_hub_init
c_func
(paren
id|cnodeid_t
id|cnode
)paren
(brace
r_struct
id|hub_data
op_star
id|hub
op_assign
id|HUB_DATA
c_func
(paren
id|cnode
)paren
suffix:semicolon
id|nasid_t
id|nasid
op_assign
id|COMPACT_TO_NASID_NODEID
c_func
(paren
id|cnode
)paren
suffix:semicolon
r_int
id|slice
op_assign
id|LOCAL_HUB_L
c_func
(paren
id|PI_CPU_NUM
)paren
suffix:semicolon
id|cpu_set
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
id|hub-&gt;h_cpus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_and_set_bit
c_func
(paren
id|slice
comma
op_amp
id|hub-&gt;slice_map
)paren
)paren
id|per_slice_init
c_func
(paren
id|cnode
comma
id|slice
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|cnode
comma
id|hub_init_mask
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * Set CRB timeout at 5ms, (&lt; PI timeout of 10ms)&n;&t; */
id|REMOTE_HUB_S
c_func
(paren
id|nasid
comma
id|IIO_ICTP
comma
l_int|0x800
)paren
suffix:semicolon
id|REMOTE_HUB_S
c_func
(paren
id|nasid
comma
id|IIO_ICTO
comma
l_int|0xff
)paren
suffix:semicolon
id|hub_rtc_init
c_func
(paren
id|cnode
)paren
suffix:semicolon
id|xtalk_probe_node
c_func
(paren
id|cnode
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_REPLICATE_EXHANDLERS
multiline_comment|/*&n;&t; * If this is not a headless node initialization,&n;&t; * copy over the caliased exception handlers.&n;&t; */
r_if
c_cond
(paren
id|get_compact_nodeid
c_func
(paren
)paren
op_eq
id|cnode
)paren
(brace
r_extern
r_char
id|except_vec0
comma
id|except_vec1_r10k
suffix:semicolon
r_extern
r_char
id|except_vec2_generic
comma
id|except_vec3_generic
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|KSEG0
op_plus
l_int|0x100
)paren
comma
op_amp
id|except_vec2_generic
comma
l_int|0x80
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|KSEG0
op_plus
l_int|0x180
)paren
comma
op_amp
id|except_vec3_generic
comma
l_int|0x80
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|KSEG0
comma
op_amp
id|except_vec0
comma
l_int|0x80
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|KSEG0
op_plus
l_int|0x080
comma
op_amp
id|except_vec1_r10k
comma
l_int|0x80
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|KSEG0
op_plus
l_int|0x100
)paren
comma
(paren
r_void
op_star
)paren
id|KSEG0
comma
l_int|0x80
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|KSEG0
op_plus
l_int|0x180
)paren
comma
op_amp
id|except_vec3_generic
comma
l_int|0x100
)paren
suffix:semicolon
id|__flush_cache_all
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/*&n; * get_nasid() returns the physical node id number of the caller.&n; */
id|nasid_t
DECL|function|get_nasid
id|get_nasid
c_func
(paren
r_void
)paren
(brace
r_return
(paren
id|nasid_t
)paren
(paren
(paren
id|LOCAL_HUB_L
c_func
(paren
id|NI_STATUS_REV_ID
)paren
op_amp
id|NSRI_NODEID_MASK
)paren
op_rshift
id|NSRI_NODEID_SHFT
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Map the physical node id to a virtual node id (virtual node ids are contiguous).&n; */
DECL|function|get_compact_nodeid
id|cnodeid_t
id|get_compact_nodeid
c_func
(paren
r_void
)paren
(brace
r_return
id|NASID_TO_COMPACT_NODEID
c_func
(paren
id|get_nasid
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
DECL|macro|rou_rflag
mdefine_line|#define&t;rou_rflag&t;rou_flags
DECL|function|router_recurse
r_static
r_void
id|router_recurse
c_func
(paren
id|klrou_t
op_star
id|router_a
comma
id|klrou_t
op_star
id|router_b
comma
r_int
id|depth
)paren
(brace
id|klrou_t
op_star
id|router
suffix:semicolon
id|lboard_t
op_star
id|brd
suffix:semicolon
r_int
id|port
suffix:semicolon
r_if
c_cond
(paren
id|router_a-&gt;rou_rflag
op_eq
l_int|1
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|depth
op_ge
id|router_distance
)paren
r_return
suffix:semicolon
id|router_a-&gt;rou_rflag
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
l_int|1
suffix:semicolon
id|port
op_le
id|MAX_ROUTER_PORTS
suffix:semicolon
id|port
op_increment
)paren
(brace
r_if
c_cond
(paren
id|router_a-&gt;rou_port
(braket
id|port
)braket
dot
id|port_nasid
op_eq
id|INVALID_NASID
)paren
r_continue
suffix:semicolon
id|brd
op_assign
(paren
id|lboard_t
op_star
)paren
id|NODE_OFFSET_TO_K0
c_func
(paren
id|router_a-&gt;rou_port
(braket
id|port
)braket
dot
id|port_nasid
comma
id|router_a-&gt;rou_port
(braket
id|port
)braket
dot
id|port_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|brd-&gt;brd_type
op_eq
id|KLTYPE_ROUTER
)paren
(brace
id|router
op_assign
(paren
id|klrou_t
op_star
)paren
id|NODE_OFFSET_TO_K0
c_func
(paren
id|NASID_GET
c_func
(paren
id|brd
)paren
comma
id|brd-&gt;brd_compts
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|router
op_eq
id|router_b
)paren
(brace
r_if
c_cond
(paren
id|depth
OL
id|router_distance
)paren
id|router_distance
op_assign
id|depth
suffix:semicolon
)brace
r_else
id|router_recurse
c_func
(paren
id|router
comma
id|router_b
comma
id|depth
op_plus
l_int|1
)paren
suffix:semicolon
)brace
)brace
id|router_a-&gt;rou_rflag
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|node_distance
r_int
id|node_distance
c_func
(paren
id|nasid_t
id|nasid_a
comma
id|nasid_t
id|nasid_b
)paren
(brace
id|klrou_t
op_star
id|router
comma
op_star
id|router_a
op_assign
l_int|NULL
comma
op_star
id|router_b
op_assign
l_int|NULL
suffix:semicolon
id|lboard_t
op_star
id|brd
comma
op_star
id|dest_brd
suffix:semicolon
id|cnodeid_t
id|cnode
suffix:semicolon
id|nasid_t
id|nasid
suffix:semicolon
r_int
id|port
suffix:semicolon
multiline_comment|/* Figure out which routers nodes in question are connected to */
r_for
c_loop
(paren
id|cnode
op_assign
l_int|0
suffix:semicolon
id|cnode
OL
id|numnodes
suffix:semicolon
id|cnode
op_increment
)paren
(brace
id|nasid
op_assign
id|COMPACT_TO_NASID_NODEID
c_func
(paren
id|cnode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nasid
op_eq
op_minus
l_int|1
)paren
r_continue
suffix:semicolon
id|brd
op_assign
id|find_lboard_class
c_func
(paren
(paren
id|lboard_t
op_star
)paren
id|KL_CONFIG_INFO
c_func
(paren
id|nasid
)paren
comma
id|KLTYPE_ROUTER
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|brd
)paren
r_continue
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|brd-&gt;brd_flags
op_amp
id|DUPLICATE_BOARD
)paren
r_continue
suffix:semicolon
id|router
op_assign
(paren
id|klrou_t
op_star
)paren
id|NODE_OFFSET_TO_K0
c_func
(paren
id|NASID_GET
c_func
(paren
id|brd
)paren
comma
id|brd-&gt;brd_compts
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|router-&gt;rou_rflag
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
l_int|1
suffix:semicolon
id|port
op_le
id|MAX_ROUTER_PORTS
suffix:semicolon
id|port
op_increment
)paren
(brace
r_if
c_cond
(paren
id|router-&gt;rou_port
(braket
id|port
)braket
dot
id|port_nasid
op_eq
id|INVALID_NASID
)paren
r_continue
suffix:semicolon
id|dest_brd
op_assign
(paren
id|lboard_t
op_star
)paren
id|NODE_OFFSET_TO_K0
c_func
(paren
id|router-&gt;rou_port
(braket
id|port
)braket
dot
id|port_nasid
comma
id|router-&gt;rou_port
(braket
id|port
)braket
dot
id|port_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dest_brd-&gt;brd_type
op_eq
id|KLTYPE_IP27
)paren
(brace
r_if
c_cond
(paren
id|dest_brd-&gt;brd_nasid
op_eq
id|nasid_a
)paren
id|router_a
op_assign
id|router
suffix:semicolon
r_if
c_cond
(paren
id|dest_brd-&gt;brd_nasid
op_eq
id|nasid_b
)paren
id|router_b
op_assign
id|router
suffix:semicolon
)brace
)brace
)brace
r_while
c_loop
(paren
(paren
id|brd
op_assign
id|find_lboard_class
c_func
(paren
id|KLCF_NEXT
c_func
(paren
id|brd
)paren
comma
id|KLTYPE_ROUTER
)paren
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|router_a
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;node_distance: router_a NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|router_b
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;node_distance: router_b NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nasid_a
op_eq
id|nasid_b
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|router_a
op_eq
id|router_b
)paren
r_return
l_int|1
suffix:semicolon
id|router_distance
op_assign
l_int|100
suffix:semicolon
id|router_recurse
c_func
(paren
id|router_a
comma
id|router_b
comma
l_int|2
)paren
suffix:semicolon
r_return
id|router_distance
suffix:semicolon
)brace
DECL|function|init_topology_matrix
r_static
r_void
id|init_topology_matrix
c_func
(paren
r_void
)paren
(brace
id|nasid_t
id|nasid
comma
id|nasid2
suffix:semicolon
id|cnodeid_t
id|row
comma
id|col
suffix:semicolon
r_for
c_loop
(paren
id|row
op_assign
l_int|0
suffix:semicolon
id|row
OL
id|MAX_COMPACT_NODES
suffix:semicolon
id|row
op_increment
)paren
r_for
c_loop
(paren
id|col
op_assign
l_int|0
suffix:semicolon
id|col
OL
id|MAX_COMPACT_NODES
suffix:semicolon
id|col
op_increment
)paren
id|node_distances
(braket
id|row
)braket
(braket
id|col
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|row
op_assign
l_int|0
suffix:semicolon
id|row
OL
id|numnodes
suffix:semicolon
id|row
op_increment
)paren
(brace
id|nasid
op_assign
id|COMPACT_TO_NASID_NODEID
c_func
(paren
id|row
)paren
suffix:semicolon
r_for
c_loop
(paren
id|col
op_assign
l_int|0
suffix:semicolon
id|col
OL
id|numnodes
suffix:semicolon
id|col
op_increment
)paren
(brace
id|nasid2
op_assign
id|COMPACT_TO_NASID_NODEID
c_func
(paren
id|col
)paren
suffix:semicolon
id|node_distances
(braket
id|row
)braket
(braket
id|col
)braket
op_assign
id|node_distance
c_func
(paren
id|nasid
comma
id|nasid2
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|dump_topology
r_static
r_void
id|dump_topology
c_func
(paren
r_void
)paren
(brace
id|nasid_t
id|nasid
suffix:semicolon
id|cnodeid_t
id|cnode
suffix:semicolon
id|lboard_t
op_star
id|brd
comma
op_star
id|dest_brd
suffix:semicolon
r_int
id|port
suffix:semicolon
r_int
id|router_num
op_assign
l_int|0
suffix:semicolon
id|klrou_t
op_star
id|router
suffix:semicolon
id|cnodeid_t
id|row
comma
id|col
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;************** Topology ********************&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;    &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|col
op_assign
l_int|0
suffix:semicolon
id|col
OL
id|numnodes
suffix:semicolon
id|col
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02d &quot;
comma
id|col
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|row
op_assign
l_int|0
suffix:semicolon
id|row
OL
id|numnodes
suffix:semicolon
id|row
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02d  &quot;
comma
id|row
)paren
suffix:semicolon
r_for
c_loop
(paren
id|col
op_assign
l_int|0
suffix:semicolon
id|col
OL
id|numnodes
suffix:semicolon
id|col
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%2d &quot;
comma
id|node_distances
(braket
id|row
)braket
(braket
id|col
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|cnode
op_assign
l_int|0
suffix:semicolon
id|cnode
OL
id|numnodes
suffix:semicolon
id|cnode
op_increment
)paren
(brace
id|nasid
op_assign
id|COMPACT_TO_NASID_NODEID
c_func
(paren
id|cnode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nasid
op_eq
op_minus
l_int|1
)paren
r_continue
suffix:semicolon
id|brd
op_assign
id|find_lboard_class
c_func
(paren
(paren
id|lboard_t
op_star
)paren
id|KL_CONFIG_INFO
c_func
(paren
id|nasid
)paren
comma
id|KLTYPE_ROUTER
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|brd
)paren
r_continue
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|brd-&gt;brd_flags
op_amp
id|DUPLICATE_BOARD
)paren
r_continue
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Router %d:&quot;
comma
id|router_num
)paren
suffix:semicolon
id|router_num
op_increment
suffix:semicolon
id|router
op_assign
(paren
id|klrou_t
op_star
)paren
id|NODE_OFFSET_TO_K0
c_func
(paren
id|NASID_GET
c_func
(paren
id|brd
)paren
comma
id|brd-&gt;brd_compts
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
l_int|1
suffix:semicolon
id|port
op_le
id|MAX_ROUTER_PORTS
suffix:semicolon
id|port
op_increment
)paren
(brace
r_if
c_cond
(paren
id|router-&gt;rou_port
(braket
id|port
)braket
dot
id|port_nasid
op_eq
id|INVALID_NASID
)paren
r_continue
suffix:semicolon
id|dest_brd
op_assign
(paren
id|lboard_t
op_star
)paren
id|NODE_OFFSET_TO_K0
c_func
(paren
id|router-&gt;rou_port
(braket
id|port
)braket
dot
id|port_nasid
comma
id|router-&gt;rou_port
(braket
id|port
)braket
dot
id|port_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dest_brd-&gt;brd_type
op_eq
id|KLTYPE_IP27
)paren
id|printk
c_func
(paren
l_string|&quot; %d&quot;
comma
id|dest_brd-&gt;brd_nasid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dest_brd-&gt;brd_type
op_eq
id|KLTYPE_ROUTER
)paren
id|printk
c_func
(paren
l_string|&quot; r&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|brd
op_assign
id|find_lboard_class
c_func
(paren
id|KLCF_NEXT
c_func
(paren
id|brd
)paren
comma
id|KLTYPE_ROUTER
)paren
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|mlreset
r_void
id|mlreset
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|master_nasid
op_assign
id|get_nasid
c_func
(paren
)paren
suffix:semicolon
id|fine_mode
op_assign
id|is_fine_dirmode
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Probe for all CPUs - this creates the cpumask and sets up the&n;&t; * mapping tables.  We need to do this as early as possible.&n;&t; */
macro_line|#ifdef CONFIG_SMP
id|cpu_node_probe
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|init_topology_matrix
c_func
(paren
)paren
suffix:semicolon
id|dump_topology
c_func
(paren
)paren
suffix:semicolon
id|gen_region_mask
c_func
(paren
op_amp
id|region_mask
comma
id|numnodes
)paren
suffix:semicolon
id|setup_replication_mask
c_func
(paren
id|numnodes
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set all nodes&squot; calias sizes to 8k&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|numnodes
suffix:semicolon
id|i
op_increment
)paren
(brace
id|nasid_t
id|nasid
suffix:semicolon
id|nasid
op_assign
id|COMPACT_TO_NASID_NODEID
c_func
(paren
id|i
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Always have node 0 in the region mask, otherwise&n;&t;&t; * CALIAS accesses get exceptions since the hub&n;&t;&t; * thinks it is a node 0 address.&n;&t;&t; */
id|REMOTE_HUB_S
c_func
(paren
id|nasid
comma
id|PI_REGION_PRESENT
comma
(paren
id|region_mask
op_or
l_int|1
)paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_REPLICATE_EXHANDLERS
id|REMOTE_HUB_S
c_func
(paren
id|nasid
comma
id|PI_CALIAS_SIZE
comma
id|PI_CALIAS_SIZE_8K
)paren
suffix:semicolon
macro_line|#else
id|REMOTE_HUB_S
c_func
(paren
id|nasid
comma
id|PI_CALIAS_SIZE
comma
id|PI_CALIAS_SIZE_0
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef LATER
multiline_comment|/*&n;&t;&t; * Set up all hubs to have a big window pointing at&n;&t;&t; * widget 0. Memory mode, widget 0, offset 0&n;&t;&t; */
id|REMOTE_HUB_S
c_func
(paren
id|nasid
comma
id|IIO_ITTE
c_func
(paren
id|SWIN0_BIGWIN
)paren
comma
(paren
(paren
id|HUB_PIO_MAP_TO_MEM
op_lshift
id|IIO_ITTE_IOSP_SHIFT
)paren
op_or
(paren
l_int|0
op_lshift
id|IIO_ITTE_WIDGET_SHIFT
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
multiline_comment|/* Extracted from the IOC3 meta driver.  FIXME.  */
DECL|function|ioc3_sio_init
r_static
r_inline
r_void
id|ioc3_sio_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|ioc3
op_star
id|ioc3
suffix:semicolon
id|nasid_t
id|nid
suffix:semicolon
r_int
id|loops
suffix:semicolon
id|nid
op_assign
id|get_nasid
c_func
(paren
)paren
suffix:semicolon
id|ioc3
op_assign
(paren
r_struct
id|ioc3
op_star
)paren
id|KL_CONFIG_CH_CONS_INFO
c_func
(paren
id|nid
)paren
op_member_access_from_pointer
id|memory_base
suffix:semicolon
id|ioc3-&gt;sscr_a
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* PIO mode for uarta.  */
id|ioc3-&gt;sscr_b
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* PIO mode for uartb.  */
id|ioc3-&gt;sio_iec
op_assign
op_complement
l_int|0
suffix:semicolon
id|ioc3-&gt;sio_ies
op_assign
(paren
id|SIO_IR_SA_INT
op_or
id|SIO_IR_SB_INT
)paren
suffix:semicolon
id|loops
op_assign
l_int|1000000
suffix:semicolon
r_while
c_loop
(paren
id|loops
op_decrement
)paren
(brace
suffix:semicolon
)brace
id|ioc3-&gt;sregs.uarta.iu_fcr
op_assign
l_int|0
suffix:semicolon
id|ioc3-&gt;sregs.uartb.iu_fcr
op_assign
l_int|0
suffix:semicolon
id|loops
op_assign
l_int|1000000
suffix:semicolon
r_while
c_loop
(paren
id|loops
op_decrement
)paren
(brace
suffix:semicolon
)brace
)brace
DECL|function|ioc3_eth_init
r_static
r_inline
r_void
id|ioc3_eth_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|ioc3
op_star
id|ioc3
suffix:semicolon
id|nasid_t
id|nid
suffix:semicolon
id|nid
op_assign
id|get_nasid
c_func
(paren
)paren
suffix:semicolon
id|ioc3
op_assign
(paren
r_struct
id|ioc3
op_star
)paren
id|KL_CONFIG_CH_CONS_INFO
c_func
(paren
id|nid
)paren
op_member_access_from_pointer
id|memory_base
suffix:semicolon
id|ioc3-&gt;eier
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|per_cpu_init
r_void
id|__init
id|per_cpu_init
c_func
(paren
r_void
)paren
(brace
id|cnodeid_t
id|cnode
op_assign
id|get_compact_nodeid
c_func
(paren
)paren
suffix:semicolon
r_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
id|clear_c0_status
c_func
(paren
id|ST0_IM
)paren
suffix:semicolon
id|per_hub_init
c_func
(paren
id|cnode
)paren
suffix:semicolon
id|cpu_time_init
c_func
(paren
)paren
suffix:semicolon
id|install_ipi
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Install our NMI handler if symmon hasn&squot;t installed one. */
id|install_cpu_nmi_handler
c_func
(paren
id|cputoslice
c_func
(paren
id|cpu
)paren
)paren
suffix:semicolon
id|set_c0_status
c_func
(paren
id|SRB_DEV0
op_or
id|SRB_DEV1
)paren
suffix:semicolon
)brace
r_extern
r_void
id|ip27_setup_console
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|ip27_time_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|ip27_reboot_setup
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|function|ip27_setup
r_static
r_int
id|__init
id|ip27_setup
c_func
(paren
r_void
)paren
(brace
id|hubreg_t
id|p
comma
id|e
comma
id|n_mode
suffix:semicolon
id|nasid_t
id|nid
suffix:semicolon
id|ip27_setup_console
c_func
(paren
)paren
suffix:semicolon
id|ip27_reboot_setup
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * hub_rtc init and cpu clock intr enabled for later calibrate_delay.&n;&t; */
id|nid
op_assign
id|get_nasid
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;IP27: Running on node %d.&bslash;n&quot;
comma
id|nid
)paren
suffix:semicolon
id|p
op_assign
id|LOCAL_HUB_L
c_func
(paren
id|PI_CPU_PRESENT_A
)paren
op_amp
l_int|1
suffix:semicolon
id|e
op_assign
id|LOCAL_HUB_L
c_func
(paren
id|PI_CPU_ENABLE_A
)paren
op_amp
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Node %d has %s primary CPU%s.&bslash;n&quot;
comma
id|nid
comma
id|p
ques
c_cond
l_string|&quot;a&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|e
ques
c_cond
l_string|&quot;, CPU is running&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|p
op_assign
id|LOCAL_HUB_L
c_func
(paren
id|PI_CPU_PRESENT_B
)paren
op_amp
l_int|1
suffix:semicolon
id|e
op_assign
id|LOCAL_HUB_L
c_func
(paren
id|PI_CPU_ENABLE_B
)paren
op_amp
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Node %d has %s secondary CPU%s.&bslash;n&quot;
comma
id|nid
comma
id|p
ques
c_cond
l_string|&quot;a&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|e
ques
c_cond
l_string|&quot;, CPU is running&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Try to catch kernel missconfigurations and give user an&n;&t; * indication what option to select.&n;&t; */
id|n_mode
op_assign
id|LOCAL_HUB_L
c_func
(paren
id|NI_STATUS_REV_ID
)paren
op_amp
id|NSRI_MORENODES_MASK
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Machine is in %c mode.&bslash;n&quot;
comma
id|n_mode
ques
c_cond
l_char|&squot;N&squot;
suffix:colon
l_char|&squot;M&squot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SGI_SN0_N_MODE
r_if
c_cond
(paren
op_logical_neg
id|n_mode
)paren
id|panic
c_func
(paren
l_string|&quot;Kernel compiled for M mode.&quot;
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|n_mode
)paren
id|panic
c_func
(paren
l_string|&quot;Kernel compiled for N mode.&quot;
)paren
suffix:semicolon
macro_line|#endif
id|ioc3_sio_init
c_func
(paren
)paren
suffix:semicolon
id|ioc3_eth_init
c_func
(paren
)paren
suffix:semicolon
id|per_cpu_init
c_func
(paren
)paren
suffix:semicolon
id|set_io_port_base
c_func
(paren
id|IO_BASE
)paren
suffix:semicolon
id|board_time_init
op_assign
id|ip27_time_init
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ip27_setup
id|early_initcall
c_func
(paren
id|ip27_setup
)paren
suffix:semicolon
eof
