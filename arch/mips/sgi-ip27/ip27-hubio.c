multiline_comment|/*&n; * Copyright (C) 1992-1997, 2000-2003 Silicon Graphics, Inc.&n; * Copyright (C) 2004 Christoph Hellwig.&n; *&t;Released under GPL v2.&n; *&n; * Support functions for the HUB ASIC - mostly PIO mapping related.&n; */
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/sn/addrs.h&gt;
macro_line|#include &lt;asm/sn/arch.h&gt;
macro_line|#include &lt;asm/sn/hub.h&gt;
DECL|variable|force_fire_and_forget
r_static
r_int
id|force_fire_and_forget
op_assign
l_int|1
suffix:semicolon
multiline_comment|/**&n; * hub_pio_map  -  establish a HUB PIO mapping&n; *&n; * @hub:&t;hub to perform PIO mapping on&n; * @widget:&t;widget ID to perform PIO mapping for&n; * @xtalk_addr:&t;xtalk_address that needs to be mapped&n; * @size:&t;size of the PIO mapping&n; *&n; **/
DECL|function|hub_pio_map
r_int
r_int
id|hub_pio_map
c_func
(paren
id|cnodeid_t
id|cnode
comma
id|xwidgetnum_t
id|widget
comma
r_int
r_int
id|xtalk_addr
comma
r_int
id|size
)paren
(brace
id|nasid_t
id|nasid
op_assign
id|COMPACT_TO_NASID_NODEID
c_func
(paren
id|cnode
)paren
suffix:semicolon
r_volatile
id|hubreg_t
id|junk
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* use small-window mapping if possible */
r_if
c_cond
(paren
(paren
id|xtalk_addr
op_mod
id|SWIN_SIZE
)paren
op_plus
id|size
op_le
id|SWIN_SIZE
)paren
r_return
id|NODE_SWIN_BASE
c_func
(paren
id|nasid
comma
id|widget
)paren
op_plus
(paren
id|xtalk_addr
op_mod
id|SWIN_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|xtalk_addr
op_mod
id|BWIN_SIZE
)paren
op_plus
id|size
OG
id|BWIN_SIZE
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PIO mapping at hub %d widget %d addr 0x%lx&quot;
l_string|&quot; too big (%ld)&bslash;n&quot;
comma
id|nasid
comma
id|widget
comma
id|xtalk_addr
comma
id|size
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|xtalk_addr
op_and_assign
op_complement
(paren
id|BWIN_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HUB_NUM_BIG_WINDOW
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|i
comma
id|HUB_DATA
c_func
(paren
id|cnode
)paren
op_member_access_from_pointer
id|h_bigwin_used
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/*&n;&t;&t; * The code below does a PIO write to setup an ITTE entry.&n;&t;&t; *&n;&t;&t; * We need to prevent other CPUs from seeing our updated&n;&t;&t; * memory shadow of the ITTE (in the piomap) until the ITTE&n;&t;&t; * entry is actually set up; otherwise, another CPU might&n;&t;&t; * attempt a PIO prematurely.&n;&t;&t; *&n;&t;&t; * Also, the only way we can know that an entry has been&n;&t;&t; * received  by the hub and can be used by future PIO reads/&n;&t;&t; * writes is by reading back the ITTE entry after writing it.&n;&t;&t; *&n;&t;&t; * For these two reasons, we PIO read back the ITTE entry&n;&t;&t; * after we write it.&n;&t;&t; */
id|IIO_ITTE_PUT
c_func
(paren
id|nasid
comma
id|i
comma
id|HUB_PIO_MAP_TO_MEM
comma
id|widget
comma
id|xtalk_addr
)paren
suffix:semicolon
id|junk
op_assign
id|HUB_L
c_func
(paren
id|IIO_ITTE_GET
c_func
(paren
id|nasid
comma
id|i
)paren
)paren
suffix:semicolon
r_return
id|NODE_BWIN_BASE
c_func
(paren
id|nasid
comma
id|widget
)paren
op_plus
(paren
id|xtalk_addr
op_mod
id|BWIN_SIZE
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;unable to establish PIO mapping for at&quot;
l_string|&quot; hub %d widget %d addr 0x%lx&bslash;n&quot;
comma
id|nasid
comma
id|widget
comma
id|xtalk_addr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * hub_setup_prb(nasid, prbnum, credits, conveyor)&n; *&n; * &t;Put a PRB into fire-and-forget mode if conveyor isn&squot;t set.  Otherwise,&n; * &t;put it into conveyor belt mode with the specified number of credits.&n; */
DECL|function|hub_setup_prb
r_static
r_void
id|hub_setup_prb
c_func
(paren
id|nasid_t
id|nasid
comma
r_int
id|prbnum
comma
r_int
id|credits
)paren
(brace
id|iprb_t
id|prb
suffix:semicolon
r_int
id|prb_offset
suffix:semicolon
multiline_comment|/*&n;&t; * Get the current register value.&n;&t; */
id|prb_offset
op_assign
id|IIO_IOPRB
c_func
(paren
id|prbnum
)paren
suffix:semicolon
id|prb.iprb_regval
op_assign
id|REMOTE_HUB_L
c_func
(paren
id|nasid
comma
id|prb_offset
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Clear out some fields.&n;&t; */
id|prb.iprb_ovflow
op_assign
l_int|1
suffix:semicolon
id|prb.iprb_bnakctr
op_assign
l_int|0
suffix:semicolon
id|prb.iprb_anakctr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Enable or disable fire-and-forget mode.&n;&t; */
id|prb.iprb_ff
op_assign
id|force_fire_and_forget
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Set the appropriate number of PIO cresits for the widget.&n;&t; */
id|prb.iprb_xtalkctr
op_assign
id|credits
suffix:semicolon
multiline_comment|/*&n;&t; * Store the new value to the register.&n;&t; */
id|REMOTE_HUB_S
c_func
(paren
id|nasid
comma
id|prb_offset
comma
id|prb.iprb_regval
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * hub_set_piomode  -  set pio mode for a given hub&n; *&n; * @nasid:&t;physical node ID for the hub in question&n; *&n; * Put the hub into either &quot;PIO conveyor belt&quot; mode or &quot;fire-and-forget&quot; mode.&n; * To do this, we have to make absolutely sure that no PIOs are in progress&n; * so we turn off access to all widgets for the duration of the function.&n; *&n; * XXX - This code should really check what kind of widget we&squot;re talking&n; * to.  Bridges can only handle three requests, but XG will do more.&n; * How many can crossbow handle to widget 0?  We&squot;re assuming 1.&n; *&n; * XXX - There is a bug in the crossbow that link reset PIOs do not&n; * return write responses.  The easiest solution to this problem is to&n; * leave widget 0 (xbow) in fire-and-forget mode at all times.  This&n; * only affects pio&squot;s to xbow registers, which should be rare.&n; **/
DECL|function|hub_set_piomode
r_static
r_void
id|hub_set_piomode
c_func
(paren
id|nasid_t
id|nasid
)paren
(brace
id|hubreg_t
id|ii_iowa
suffix:semicolon
id|hubii_wcr_t
id|ii_wcr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ii_iowa
op_assign
id|REMOTE_HUB_L
c_func
(paren
id|nasid
comma
id|IIO_OUTWIDGET_ACCESS
)paren
suffix:semicolon
id|REMOTE_HUB_S
c_func
(paren
id|nasid
comma
id|IIO_OUTWIDGET_ACCESS
comma
l_int|0
)paren
suffix:semicolon
id|ii_wcr.wcr_reg_value
op_assign
id|REMOTE_HUB_L
c_func
(paren
id|nasid
comma
id|IIO_WCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ii_wcr.iwcr_dir_con
)paren
(brace
multiline_comment|/*&n;&t;&t; * Assume a bridge here.&n;&t;&t; */
id|hub_setup_prb
c_func
(paren
id|nasid
comma
l_int|0
comma
l_int|3
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Assume a crossbow here.&n;&t;&t; */
id|hub_setup_prb
c_func
(paren
id|nasid
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * XXX - Here&squot;s where we should take the widget type into&n;&t; * when account assigning credits.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
id|HUB_WIDGET_ID_MIN
suffix:semicolon
id|i
op_le
id|HUB_WIDGET_ID_MAX
suffix:semicolon
id|i
op_increment
)paren
id|hub_setup_prb
c_func
(paren
id|nasid
comma
id|i
comma
l_int|3
)paren
suffix:semicolon
id|REMOTE_HUB_S
c_func
(paren
id|nasid
comma
id|IIO_OUTWIDGET_ACCESS
comma
id|ii_iowa
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * hub_pio_init  -  PIO-related hub initalization&n; *&n; * @hub:&t;hubinfo structure for our hub&n; */
DECL|function|hub_pio_init
r_void
id|hub_pio_init
c_func
(paren
id|cnodeid_t
id|cnode
)paren
(brace
id|nasid_t
id|nasid
op_assign
id|COMPACT_TO_NASID_NODEID
c_func
(paren
id|cnode
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* initialize big window piomaps for this hub */
id|bitmap_zero
c_func
(paren
id|HUB_DATA
c_func
(paren
id|cnode
)paren
op_member_access_from_pointer
id|h_bigwin_used
comma
id|HUB_NUM_BIG_WINDOW
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HUB_NUM_BIG_WINDOW
suffix:semicolon
id|i
op_increment
)paren
id|IIO_ITTE_DISABLE
c_func
(paren
id|nasid
comma
id|i
)paren
suffix:semicolon
id|hub_set_piomode
c_func
(paren
id|nasid
)paren
suffix:semicolon
)brace
eof
