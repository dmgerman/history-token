multiline_comment|/* IEEE754 floating point arithmetic&n; * double precision square root&n; */
multiline_comment|/*&n; * MIPS floating point support&n; * Copyright (C) 1994-2000 Algorithmics Ltd.  All rights reserved.&n; * http://www.algor.co.uk&n; *&n; * ########################################################################&n; *&n; *  This program is free software; you can distribute it and/or modify it&n; *  under the terms of the GNU General Public License (Version 2) as&n; *  published by the Free Software Foundation.&n; *&n; *  This program is distributed in the hope it will be useful, but WITHOUT&n; *  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or&n; *  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License&n; *  for more details.&n; *&n; *  You should have received a copy of the GNU General Public License along&n; *  with this program; if not, write to the Free Software Foundation, Inc.,&n; *  59 Temple Place - Suite 330, Boston MA 02111-1307, USA.&n; *&n; * ########################################################################&n; */
macro_line|#include &quot;ieee754dp.h&quot;
DECL|variable|table
r_static
r_const
r_int
id|table
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|1204
comma
l_int|3062
comma
l_int|5746
comma
l_int|9193
comma
l_int|13348
comma
l_int|18162
comma
l_int|23592
comma
l_int|29598
comma
l_int|36145
comma
l_int|43202
comma
l_int|50740
comma
l_int|58733
comma
l_int|67158
comma
l_int|75992
comma
l_int|85215
comma
l_int|83599
comma
l_int|71378
comma
l_int|60428
comma
l_int|50647
comma
l_int|41945
comma
l_int|34246
comma
l_int|27478
comma
l_int|21581
comma
l_int|16499
comma
l_int|12183
comma
l_int|8588
comma
l_int|5674
comma
l_int|3403
comma
l_int|1742
comma
l_int|661
comma
l_int|130
)brace
suffix:semicolon
DECL|function|ieee754dp_sqrt
id|ieee754dp
id|ieee754dp_sqrt
c_func
(paren
id|ieee754dp
id|x
)paren
(brace
r_struct
id|ieee754_csr
id|oldcsr
suffix:semicolon
id|ieee754dp
id|y
comma
id|z
comma
id|t
suffix:semicolon
r_int
id|scalx
comma
id|yh
suffix:semicolon
id|COMPXDP
suffix:semicolon
id|EXPLODEXDP
suffix:semicolon
id|CLEARCX
suffix:semicolon
id|FLUSHXDP
suffix:semicolon
multiline_comment|/* x == INF or NAN? */
r_switch
c_cond
(paren
id|xc
)paren
(brace
r_case
id|IEEE754_CLASS_QNAN
suffix:colon
multiline_comment|/* sqrt(Nan) = Nan */
r_return
id|ieee754dp_nanxcpt
c_func
(paren
id|x
comma
l_string|&quot;sqrt&quot;
)paren
suffix:semicolon
r_case
id|IEEE754_CLASS_SNAN
suffix:colon
id|SETCX
c_func
(paren
id|IEEE754_INVALID_OPERATION
)paren
suffix:semicolon
r_return
id|ieee754dp_nanxcpt
c_func
(paren
id|ieee754dp_indef
c_func
(paren
)paren
comma
l_string|&quot;sqrt&quot;
)paren
suffix:semicolon
r_case
id|IEEE754_CLASS_ZERO
suffix:colon
multiline_comment|/* sqrt(0) = 0 */
r_return
id|x
suffix:semicolon
r_case
id|IEEE754_CLASS_INF
suffix:colon
r_if
c_cond
(paren
id|xs
)paren
(brace
multiline_comment|/* sqrt(-Inf) = Nan */
id|SETCX
c_func
(paren
id|IEEE754_INVALID_OPERATION
)paren
suffix:semicolon
r_return
id|ieee754dp_nanxcpt
c_func
(paren
id|ieee754dp_indef
c_func
(paren
)paren
comma
l_string|&quot;sqrt&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* sqrt(+Inf) = Inf */
r_return
id|x
suffix:semicolon
r_case
id|IEEE754_CLASS_DNORM
suffix:colon
id|DPDNORMX
suffix:semicolon
multiline_comment|/* fall through */
r_case
id|IEEE754_CLASS_NORM
suffix:colon
r_if
c_cond
(paren
id|xs
)paren
(brace
multiline_comment|/* sqrt(-x) = Nan */
id|SETCX
c_func
(paren
id|IEEE754_INVALID_OPERATION
)paren
suffix:semicolon
r_return
id|ieee754dp_nanxcpt
c_func
(paren
id|ieee754dp_indef
c_func
(paren
)paren
comma
l_string|&quot;sqrt&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/* save old csr; switch off INX enable &amp; flag; set RN rounding */
id|oldcsr
op_assign
id|ieee754_csr
suffix:semicolon
id|ieee754_csr.mx
op_and_assign
op_complement
id|IEEE754_INEXACT
suffix:semicolon
id|ieee754_csr.sx
op_and_assign
op_complement
id|IEEE754_INEXACT
suffix:semicolon
id|ieee754_csr.rm
op_assign
id|IEEE754_RN
suffix:semicolon
multiline_comment|/* adjust exponent to prevent overflow */
id|scalx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|xe
OG
l_int|512
)paren
(brace
multiline_comment|/* x &gt; 2**-512? */
id|xe
op_sub_assign
l_int|512
suffix:semicolon
multiline_comment|/* x = x / 2**512 */
id|scalx
op_add_assign
l_int|256
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|xe
OL
op_minus
l_int|512
)paren
(brace
multiline_comment|/* x &lt; 2**-512? */
id|xe
op_add_assign
l_int|512
suffix:semicolon
multiline_comment|/* x = x * 2**512 */
id|scalx
op_sub_assign
l_int|256
suffix:semicolon
)brace
id|y
op_assign
id|x
op_assign
id|builddp
c_func
(paren
l_int|0
comma
id|xe
op_plus
id|DP_EBIAS
comma
id|xm
op_amp
op_complement
id|DP_HIDDEN_BIT
)paren
suffix:semicolon
multiline_comment|/* magic initial approximation to almost 8 sig. bits */
id|yh
op_assign
id|y.bits
op_rshift
l_int|32
suffix:semicolon
id|yh
op_assign
(paren
id|yh
op_rshift
l_int|1
)paren
op_plus
l_int|0x1ff80000
suffix:semicolon
id|yh
op_assign
id|yh
op_minus
id|table
(braket
(paren
id|yh
op_rshift
l_int|15
)paren
op_amp
l_int|31
)braket
suffix:semicolon
id|y.bits
op_assign
(paren
(paren
id|u64
)paren
id|yh
op_lshift
l_int|32
)paren
op_or
(paren
id|y.bits
op_amp
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* Heron&squot;s rule once with correction to improve to ~18 sig. bits */
multiline_comment|/* t=x/y; y=y+t; py[n0]=py[n0]-0x00100006; py[n1]=0; */
id|t
op_assign
id|ieee754dp_div
c_func
(paren
id|x
comma
id|y
)paren
suffix:semicolon
id|y
op_assign
id|ieee754dp_add
c_func
(paren
id|y
comma
id|t
)paren
suffix:semicolon
id|y.bits
op_sub_assign
l_int|0x0010000600000000LL
suffix:semicolon
id|y.bits
op_and_assign
l_int|0xffffffff00000000LL
suffix:semicolon
multiline_comment|/* triple to almost 56 sig. bits: y ~= sqrt(x) to within 1 ulp */
multiline_comment|/* t=y*y; z=t;  pt[n0]+=0x00100000; t+=z; z=(x-z)*y; */
id|z
op_assign
id|t
op_assign
id|ieee754dp_mul
c_func
(paren
id|y
comma
id|y
)paren
suffix:semicolon
id|t.parts.bexp
op_add_assign
l_int|0x001
suffix:semicolon
id|t
op_assign
id|ieee754dp_add
c_func
(paren
id|t
comma
id|z
)paren
suffix:semicolon
id|z
op_assign
id|ieee754dp_mul
c_func
(paren
id|ieee754dp_sub
c_func
(paren
id|x
comma
id|z
)paren
comma
id|y
)paren
suffix:semicolon
multiline_comment|/* t=z/(t+x) ;  pt[n0]+=0x00100000; y+=t; */
id|t
op_assign
id|ieee754dp_div
c_func
(paren
id|z
comma
id|ieee754dp_add
c_func
(paren
id|t
comma
id|x
)paren
)paren
suffix:semicolon
id|t.parts.bexp
op_add_assign
l_int|0x001
suffix:semicolon
id|y
op_assign
id|ieee754dp_add
c_func
(paren
id|y
comma
id|t
)paren
suffix:semicolon
multiline_comment|/* twiddle last bit to force y correctly rounded */
multiline_comment|/* set RZ, clear INEX flag */
id|ieee754_csr.rm
op_assign
id|IEEE754_RZ
suffix:semicolon
id|ieee754_csr.sx
op_and_assign
op_complement
id|IEEE754_INEXACT
suffix:semicolon
multiline_comment|/* t=x/y; ...chopped quotient, possibly inexact */
id|t
op_assign
id|ieee754dp_div
c_func
(paren
id|x
comma
id|y
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ieee754_csr.sx
op_amp
id|IEEE754_INEXACT
op_logical_or
id|t.bits
op_ne
id|y.bits
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ieee754_csr.sx
op_amp
id|IEEE754_INEXACT
)paren
)paren
multiline_comment|/* t = t-ulp */
id|t.bits
op_sub_assign
l_int|1
suffix:semicolon
multiline_comment|/* add inexact to result status */
id|oldcsr.cx
op_or_assign
id|IEEE754_INEXACT
suffix:semicolon
id|oldcsr.sx
op_or_assign
id|IEEE754_INEXACT
suffix:semicolon
r_switch
c_cond
(paren
id|oldcsr.rm
)paren
(brace
r_case
id|IEEE754_RP
suffix:colon
id|y.bits
op_add_assign
l_int|1
suffix:semicolon
multiline_comment|/* drop through */
r_case
id|IEEE754_RN
suffix:colon
id|t.bits
op_add_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* y=y+t; ...chopped sum */
id|y
op_assign
id|ieee754dp_add
c_func
(paren
id|y
comma
id|t
)paren
suffix:semicolon
multiline_comment|/* adjust scalx for correctly rounded sqrt(x) */
id|scalx
op_sub_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* py[n0]=py[n0]+scalx; ...scale back y */
id|y.parts.bexp
op_add_assign
id|scalx
suffix:semicolon
multiline_comment|/* restore rounding mode, possibly set inexact */
id|ieee754_csr
op_assign
id|oldcsr
suffix:semicolon
r_return
id|y
suffix:semicolon
)brace
eof
