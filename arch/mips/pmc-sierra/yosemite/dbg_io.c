multiline_comment|/*&n; * Copyright 2003 PMC-Sierra&n; * Author: Manish Lachwani (lachwani@pmc-sierra.com)&n; *&n; *  This program is free software; you can redistribute  it and/or modify it&n; *  under  the terms of  the GNU General  Public License as published by the&n; *  Free Software Foundation;  either version 2 of the  License, or (at your&n; *  option) any later version.&n; *&n; *  THIS  SOFTWARE  IS PROVIDED   ``AS  IS&squot;&squot; AND   ANY  EXPRESS OR IMPLIED&n; *  WARRANTIES,   INCLUDING, BUT NOT  LIMITED  TO, THE IMPLIED WARRANTIES OF&n; *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN&n; *  NO  EVENT  SHALL   THE AUTHOR  BE    LIABLE FOR ANY   DIRECT, INDIRECT,&n; *  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT&n; *  NOT LIMITED   TO, PROCUREMENT OF  SUBSTITUTE GOODS  OR SERVICES; LOSS OF&n; *  USE, DATA,  OR PROFITS; OR  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON&n; *  ANY THEORY OF LIABILITY, WHETHER IN  CONTRACT, STRICT LIABILITY, OR TORT&n; *  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF&n; *  THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n; *&n; *  You should have received a copy of the  GNU General Public License along&n; *  with this program; if not, write  to the Free Software Foundation, Inc.,&n; *  675 Mass Ave, Cambridge, MA 02139, USA.&n; */
multiline_comment|/*&n; * Support for KGDB for the Yosemite board. We make use of single serial&n; * port to be used for KGDB as well as console. The second serial port&n; * seems to be having a problem. Single IRQ is allocated for both the&n; * ports. Hence, the interrupt routing code needs to figure out whether&n; * the interrupt came from channel A or B.&n; */
macro_line|#include &lt;asm/serial.h&gt;
multiline_comment|/*&n; * Baud rate, Parity, Data and Stop bit settings for the&n; * serial port on the Yosemite. Note that the Early printk&n; * patch has been added. So, we should be all set to go&n; */
DECL|macro|YOSEMITE_BAUD_2400
mdefine_line|#define&t;YOSEMITE_BAUD_2400&t;2400
DECL|macro|YOSEMITE_BAUD_4800
mdefine_line|#define&t;YOSEMITE_BAUD_4800&t;4800
DECL|macro|YOSEMITE_BAUD_9600
mdefine_line|#define&t;YOSEMITE_BAUD_9600&t;9600
DECL|macro|YOSEMITE_BAUD_19200
mdefine_line|#define&t;YOSEMITE_BAUD_19200&t;19200
DECL|macro|YOSEMITE_BAUD_38400
mdefine_line|#define&t;YOSEMITE_BAUD_38400&t;38400
DECL|macro|YOSEMITE_BAUD_57600
mdefine_line|#define&t;YOSEMITE_BAUD_57600&t;57600
DECL|macro|YOSEMITE_BAUD_115200
mdefine_line|#define&t;YOSEMITE_BAUD_115200&t;115200
DECL|macro|YOSEMITE_PARITY_NONE
mdefine_line|#define&t;YOSEMITE_PARITY_NONE&t;0
DECL|macro|YOSEMITE_PARITY_ODD
mdefine_line|#define&t;YOSEMITE_PARITY_ODD&t;0x08
DECL|macro|YOSEMITE_PARITY_EVEN
mdefine_line|#define&t;YOSEMITE_PARITY_EVEN&t;0x18
DECL|macro|YOSEMITE_PARITY_MARK
mdefine_line|#define&t;YOSEMITE_PARITY_MARK&t;0x28
DECL|macro|YOSEMITE_PARITY_SPACE
mdefine_line|#define&t;YOSEMITE_PARITY_SPACE&t;0x38
DECL|macro|YOSEMITE_DATA_5BIT
mdefine_line|#define&t;YOSEMITE_DATA_5BIT&t;0x0
DECL|macro|YOSEMITE_DATA_6BIT
mdefine_line|#define&t;YOSEMITE_DATA_6BIT&t;0x1
DECL|macro|YOSEMITE_DATA_7BIT
mdefine_line|#define&t;YOSEMITE_DATA_7BIT&t;0x2
DECL|macro|YOSEMITE_DATA_8BIT
mdefine_line|#define&t;YOSEMITE_DATA_8BIT&t;0x3
DECL|macro|YOSEMITE_STOP_1BIT
mdefine_line|#define&t;YOSEMITE_STOP_1BIT&t;0x0
DECL|macro|YOSEMITE_STOP_2BIT
mdefine_line|#define&t;YOSEMITE_STOP_2BIT&t;0x4
multiline_comment|/* This is crucial */
DECL|macro|SERIAL_REG_OFS
mdefine_line|#define&t;SERIAL_REG_OFS&t;&t;0x1
DECL|macro|SERIAL_RCV_BUFFER
mdefine_line|#define&t;SERIAL_RCV_BUFFER&t;0x0
DECL|macro|SERIAL_TRANS_HOLD
mdefine_line|#define&t;SERIAL_TRANS_HOLD&t;0x0
DECL|macro|SERIAL_SEND_BUFFER
mdefine_line|#define&t;SERIAL_SEND_BUFFER&t;0x0
DECL|macro|SERIAL_INTR_ENABLE
mdefine_line|#define&t;SERIAL_INTR_ENABLE&t;(1 * SERIAL_REG_OFS)
DECL|macro|SERIAL_INTR_ID
mdefine_line|#define&t;SERIAL_INTR_ID&t;&t;(2 * SERIAL_REG_OFS)
DECL|macro|SERIAL_DATA_FORMAT
mdefine_line|#define&t;SERIAL_DATA_FORMAT&t;(3 * SERIAL_REG_OFS)
DECL|macro|SERIAL_LINE_CONTROL
mdefine_line|#define&t;SERIAL_LINE_CONTROL&t;(3 * SERIAL_REG_OFS)
DECL|macro|SERIAL_MODEM_CONTROL
mdefine_line|#define&t;SERIAL_MODEM_CONTROL&t;(4 * SERIAL_REG_OFS)
DECL|macro|SERIAL_RS232_OUTPUT
mdefine_line|#define&t;SERIAL_RS232_OUTPUT&t;(4 * SERIAL_REG_OFS)
DECL|macro|SERIAL_LINE_STATUS
mdefine_line|#define&t;SERIAL_LINE_STATUS&t;(5 * SERIAL_REG_OFS)
DECL|macro|SERIAL_MODEM_STATUS
mdefine_line|#define&t;SERIAL_MODEM_STATUS&t;(6 * SERIAL_REG_OFS)
DECL|macro|SERIAL_RS232_INPUT
mdefine_line|#define&t;SERIAL_RS232_INPUT&t;(6 * SERIAL_REG_OFS)
DECL|macro|SERIAL_SCRATCH_PAD
mdefine_line|#define&t;SERIAL_SCRATCH_PAD&t;(7 * SERIAL_REG_OFS)
DECL|macro|SERIAL_DIVISOR_LSB
mdefine_line|#define&t;SERIAL_DIVISOR_LSB&t;(0 * SERIAL_REG_OFS)
DECL|macro|SERIAL_DIVISOR_MSB
mdefine_line|#define&t;SERIAL_DIVISOR_MSB&t;(1 * SERIAL_REG_OFS)
multiline_comment|/*&n; * Functions to READ and WRITE to serial port 0&n; */
DECL|macro|SERIAL_READ
mdefine_line|#define&t;SERIAL_READ(ofs)&t;&t;(*((volatile unsigned char*)&t;&bslash;&n;&t;&t;&t;&t;&t;(TITAN_SERIAL_BASE + ofs)))
DECL|macro|SERIAL_WRITE
mdefine_line|#define&t;SERIAL_WRITE(ofs, val)&t;&t;((*((volatile unsigned char*)&t;&bslash;&n;&t;&t;&t;&t;&t;(TITAN_SERIAL_BASE + ofs))) = val)
multiline_comment|/*&n; * Functions to READ and WRITE to serial port 1&n; */
DECL|macro|SERIAL_READ_1
mdefine_line|#define&t;SERIAL_READ_1(ofs)&t;&t;(*((volatile unsigned char*)&t;&bslash;&n;&t;&t;&t;&t;&t;(TITAN_SERIAL_BASE_1 + ofs)
DECL|macro|SERIAL_WRITE_1
mdefine_line|#define&t;SERIAL_WRITE_1(ofs, val)&t;((*((volatile unsigned char*)&t;&bslash;&n;&t;&t;&t;&t;&t;(TITAN_SERIAL_BASE_1 + ofs))) = val)
multiline_comment|/*&n; * Second serial port initialization&n; */
DECL|function|init_second_port
r_void
id|init_second_port
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Disable Interrupts */
id|SERIAL_WRITE_1
c_func
(paren
id|SERIAL_LINE_CONTROL
comma
l_int|0x0
)paren
suffix:semicolon
id|SERIAL_WRITE_1
c_func
(paren
id|SERIAL_INTR_ENABLE
comma
l_int|0x0
)paren
suffix:semicolon
(brace
r_int
r_int
id|divisor
suffix:semicolon
id|SERIAL_WRITE_1
c_func
(paren
id|SERIAL_LINE_CONTROL
comma
l_int|0x80
)paren
suffix:semicolon
id|divisor
op_assign
id|TITAN_SERIAL_BASE_BAUD
op_div
id|YOSEMITE_BAUD_115200
suffix:semicolon
id|SERIAL_WRITE_1
c_func
(paren
id|SERIAL_DIVISOR_LSB
comma
id|divisor
op_amp
l_int|0xff
)paren
suffix:semicolon
id|SERIAL_WRITE_1
c_func
(paren
id|SERIAL_DIVISOR_MSB
comma
(paren
id|divisor
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|SERIAL_WRITE_1
c_func
(paren
id|SERIAL_LINE_CONTROL
comma
l_int|0x0
)paren
suffix:semicolon
)brace
id|SERIAL_WRITE_1
c_func
(paren
id|SERIAL_DATA_FORMAT
comma
id|YOSEMITE_DATA_8BIT
op_or
id|YOSEMITE_PARITY_NONE
op_or
id|YOSEMITE_STOP_1BIT
)paren
suffix:semicolon
multiline_comment|/* Enable Interrupts */
id|SERIAL_WRITE_1
c_func
(paren
id|SERIAL_INTR_ENABLE
comma
l_int|0xf
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize the serial port for KGDB debugging */
DECL|function|debugInit
r_void
id|debugInit
c_func
(paren
r_int
r_int
id|baud
comma
r_int
r_char
id|data
comma
r_int
r_char
id|parity
comma
r_int
r_char
id|stop
)paren
(brace
multiline_comment|/* Disable Interrupts */
id|SERIAL_WRITE
c_func
(paren
id|SERIAL_LINE_CONTROL
comma
l_int|0x0
)paren
suffix:semicolon
id|SERIAL_WRITE
c_func
(paren
id|SERIAL_INTR_ENABLE
comma
l_int|0x0
)paren
suffix:semicolon
(brace
r_int
r_int
id|divisor
suffix:semicolon
id|SERIAL_WRITE
c_func
(paren
id|SERIAL_LINE_CONTROL
comma
l_int|0x80
)paren
suffix:semicolon
id|divisor
op_assign
id|TITAN_SERIAL_BASE_BAUD
op_div
id|baud
suffix:semicolon
id|SERIAL_WRITE
c_func
(paren
id|SERIAL_DIVISOR_LSB
comma
id|divisor
op_amp
l_int|0xff
)paren
suffix:semicolon
id|SERIAL_WRITE
c_func
(paren
id|SERIAL_DIVISOR_MSB
comma
(paren
id|divisor
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|SERIAL_WRITE
c_func
(paren
id|SERIAL_LINE_CONTROL
comma
l_int|0x0
)paren
suffix:semicolon
)brace
id|SERIAL_WRITE
c_func
(paren
id|SERIAL_DATA_FORMAT
comma
id|data
op_or
id|parity
op_or
id|stop
)paren
suffix:semicolon
)brace
DECL|variable|remoteDebugInitialized
r_static
r_int
id|remoteDebugInitialized
op_assign
l_int|0
suffix:semicolon
DECL|function|getDebugChar
r_int
r_char
id|getDebugChar
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|remoteDebugInitialized
)paren
(brace
id|remoteDebugInitialized
op_assign
l_int|1
suffix:semicolon
id|debugInit
c_func
(paren
id|YOSEMITE_BAUD_115200
comma
id|YOSEMITE_DATA_8BIT
comma
id|YOSEMITE_PARITY_NONE
comma
id|YOSEMITE_STOP_1BIT
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|SERIAL_READ
c_func
(paren
id|SERIAL_LINE_STATUS
)paren
op_amp
l_int|0x1
)paren
op_eq
l_int|0
)paren
suffix:semicolon
r_return
id|SERIAL_READ
c_func
(paren
id|SERIAL_RCV_BUFFER
)paren
suffix:semicolon
)brace
DECL|function|putDebugChar
r_int
id|putDebugChar
c_func
(paren
r_int
r_char
id|byte
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|remoteDebugInitialized
)paren
(brace
id|remoteDebugInitialized
op_assign
l_int|1
suffix:semicolon
id|debugInit
c_func
(paren
id|YOSEMITE_BAUD_115200
comma
id|YOSEMITE_DATA_8BIT
comma
id|YOSEMITE_PARITY_NONE
comma
id|YOSEMITE_STOP_1BIT
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|SERIAL_READ
c_func
(paren
id|SERIAL_LINE_STATUS
)paren
op_amp
l_int|0x20
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|SERIAL_WRITE
c_func
(paren
id|SERIAL_SEND_BUFFER
comma
id|byte
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
eof
