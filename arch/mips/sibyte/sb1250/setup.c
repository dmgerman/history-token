multiline_comment|/*&n; * Copyright (C) 2000, 2001, 2002, 2003 Broadcom Corporation&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version 2&n; * of the License, or (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/reboot.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#include &lt;asm/mipsregs.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/sibyte/sb1250.h&gt;
macro_line|#include &lt;asm/sibyte/sb1250_regs.h&gt;
macro_line|#include &lt;asm/sibyte/sb1250_scd.h&gt;
DECL|variable|sb1_pass
r_int
r_int
id|sb1_pass
suffix:semicolon
DECL|variable|soc_pass
r_int
r_int
id|soc_pass
suffix:semicolon
DECL|variable|soc_type
r_int
r_int
id|soc_type
suffix:semicolon
DECL|variable|periph_rev
r_int
r_int
id|periph_rev
suffix:semicolon
DECL|variable|zbbus_mhz
r_int
r_int
id|zbbus_mhz
suffix:semicolon
DECL|variable|soc_str
r_static
r_char
op_star
id|soc_str
suffix:semicolon
DECL|variable|pass_str
r_static
r_char
op_star
id|pass_str
suffix:semicolon
DECL|variable|war_pass
r_static
r_int
r_int
id|war_pass
suffix:semicolon
multiline_comment|/* XXXKW don&squot;t overload PASS defines? */
r_static
r_inline
r_int
id|setup_bcm1250
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_inline
r_int
id|setup_bcm112x
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* Setup code likely to be common to all SiByte platforms */
DECL|function|sys_rev_decode
r_static
r_inline
r_int
id|sys_rev_decode
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|war_pass
op_assign
id|soc_pass
suffix:semicolon
r_switch
c_cond
(paren
id|soc_type
)paren
(brace
r_case
id|K_SYS_SOC_TYPE_BCM1250
suffix:colon
r_case
id|K_SYS_SOC_TYPE_BCM1250_ALT
suffix:colon
r_case
id|K_SYS_SOC_TYPE_BCM1250_ALT2
suffix:colon
id|soc_str
op_assign
l_string|&quot;BCM1250&quot;
suffix:semicolon
id|ret
op_assign
id|setup_bcm1250
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|K_SYS_SOC_TYPE_BCM1120
suffix:colon
id|soc_str
op_assign
l_string|&quot;BCM1120&quot;
suffix:semicolon
id|ret
op_assign
id|setup_bcm112x
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|K_SYS_SOC_TYPE_BCM1125
suffix:colon
id|soc_str
op_assign
l_string|&quot;BCM1125&quot;
suffix:semicolon
id|ret
op_assign
id|setup_bcm112x
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|K_SYS_SOC_TYPE_BCM1125H
suffix:colon
id|soc_str
op_assign
l_string|&quot;BCM1125H&quot;
suffix:semicolon
id|ret
op_assign
id|setup_bcm112x
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|prom_printf
c_func
(paren
l_string|&quot;Unknown SOC type %x&bslash;n&quot;
comma
id|soc_type
)paren
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|setup_bcm1250
r_static
r_inline
r_int
id|setup_bcm1250
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|soc_pass
)paren
(brace
r_case
id|K_SYS_REVISION_BCM1250_PASS1
suffix:colon
id|periph_rev
op_assign
l_int|1
suffix:semicolon
id|pass_str
op_assign
l_string|&quot;Pass 1&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|K_SYS_REVISION_BCM1250_A10
suffix:colon
id|periph_rev
op_assign
l_int|2
suffix:semicolon
id|pass_str
op_assign
l_string|&quot;A8/A10&quot;
suffix:semicolon
multiline_comment|/* XXXKW different war_pass? */
id|war_pass
op_assign
id|K_SYS_REVISION_BCM1250_PASS2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|K_SYS_REVISION_BCM1250_PASS2_2
suffix:colon
id|periph_rev
op_assign
l_int|2
suffix:semicolon
id|pass_str
op_assign
l_string|&quot;B1&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|K_SYS_REVISION_BCM1250_B2
suffix:colon
id|periph_rev
op_assign
l_int|2
suffix:semicolon
id|pass_str
op_assign
l_string|&quot;B2&quot;
suffix:semicolon
id|war_pass
op_assign
id|K_SYS_REVISION_BCM1250_PASS2_2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|K_SYS_REVISION_BCM1250_PASS3
suffix:colon
id|periph_rev
op_assign
l_int|3
suffix:semicolon
id|pass_str
op_assign
l_string|&quot;C0&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|K_SYS_REVISION_BCM1250_C1
suffix:colon
id|periph_rev
op_assign
l_int|3
suffix:semicolon
id|pass_str
op_assign
l_string|&quot;C1&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|soc_pass
OL
id|K_SYS_REVISION_BCM1250_PASS2_2
)paren
(brace
id|periph_rev
op_assign
l_int|2
suffix:semicolon
id|pass_str
op_assign
l_string|&quot;A0-A6&quot;
suffix:semicolon
id|war_pass
op_assign
id|K_SYS_REVISION_BCM1250_PASS2
suffix:semicolon
)brace
r_else
(brace
id|prom_printf
c_func
(paren
l_string|&quot;Unknown BCM1250 rev %x&bslash;n&quot;
comma
id|soc_pass
)paren
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|setup_bcm112x
r_static
r_inline
r_int
id|setup_bcm112x
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|soc_pass
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* Early build didn&squot;t have revid set */
id|periph_rev
op_assign
l_int|3
suffix:semicolon
id|pass_str
op_assign
l_string|&quot;A1&quot;
suffix:semicolon
id|war_pass
op_assign
id|K_SYS_REVISION_BCM112x_A1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|K_SYS_REVISION_BCM112x_A1
suffix:colon
id|periph_rev
op_assign
l_int|3
suffix:semicolon
id|pass_str
op_assign
l_string|&quot;A1&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|K_SYS_REVISION_BCM112x_A2
suffix:colon
id|periph_rev
op_assign
l_int|3
suffix:semicolon
id|pass_str
op_assign
l_string|&quot;A2&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|prom_printf
c_func
(paren
l_string|&quot;Unknown %s rev %x&bslash;n&quot;
comma
id|soc_str
comma
id|soc_pass
)paren
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sb1250_setup
r_void
id|sb1250_setup
c_func
(paren
r_void
)paren
(brace
r_uint64
id|sys_rev
suffix:semicolon
r_int
id|plldiv
suffix:semicolon
r_int
id|bad_config
op_assign
l_int|0
suffix:semicolon
id|sb1_pass
op_assign
id|read_c0_prid
c_func
(paren
)paren
op_amp
l_int|0xff
suffix:semicolon
id|sys_rev
op_assign
id|bus_readq
c_func
(paren
id|IOADDR
c_func
(paren
id|A_SCD_SYSTEM_REVISION
)paren
)paren
suffix:semicolon
id|soc_type
op_assign
id|SYS_SOC_TYPE
c_func
(paren
id|sys_rev
)paren
suffix:semicolon
id|soc_pass
op_assign
id|G_SYS_REVISION
c_func
(paren
id|sys_rev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sys_rev_decode
c_func
(paren
)paren
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;Restart after failure to identify SiByte chip&bslash;n&quot;
)paren
suffix:semicolon
id|machine_restart
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
id|plldiv
op_assign
id|G_SYS_PLL_DIV
c_func
(paren
id|bus_readq
c_func
(paren
id|IOADDR
c_func
(paren
id|A_SCD_SYSTEM_CFG
)paren
)paren
)paren
suffix:semicolon
id|zbbus_mhz
op_assign
(paren
(paren
id|plldiv
op_rshift
l_int|1
)paren
op_star
l_int|50
)paren
op_plus
(paren
(paren
id|plldiv
op_amp
l_int|1
)paren
op_star
l_int|25
)paren
suffix:semicolon
id|prom_printf
c_func
(paren
l_string|&quot;Broadcom SiByte %s %s @ %d MHz (SB1 rev %d)&bslash;n&quot;
comma
id|soc_str
comma
id|pass_str
comma
id|zbbus_mhz
op_star
l_int|2
comma
id|sb1_pass
)paren
suffix:semicolon
id|prom_printf
c_func
(paren
l_string|&quot;Board type: %s&bslash;n&quot;
comma
id|get_system_type
c_func
(paren
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|war_pass
)paren
(brace
r_case
id|K_SYS_REVISION_BCM1250_PASS1
suffix:colon
macro_line|#ifndef CONFIG_SB1_PASS_1_WORKAROUNDS
id|prom_printf
c_func
(paren
l_string|&quot;@@@@ This is a BCM1250 A0-A2 (Pass 1) board, and the kernel doesn&squot;t have the proper workarounds compiled in. @@@@&bslash;n&quot;
)paren
suffix:semicolon
id|bad_config
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|K_SYS_REVISION_BCM1250_PASS2
suffix:colon
multiline_comment|/* Pass 2 - easiest as default for now - so many numbers */
macro_line|#if !defined(CONFIG_SB1_PASS_2_WORKAROUNDS) || !defined(CONFIG_SB1_PASS_2_1_WORKAROUNDS)
id|prom_printf
c_func
(paren
l_string|&quot;@@@@ This is a BCM1250 A3-A10 board, and the kernel doesn&squot;t have the proper workarounds compiled in. @@@@&bslash;n&quot;
)paren
suffix:semicolon
id|bad_config
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_CPU_HAS_PREFETCH
id|prom_printf
c_func
(paren
l_string|&quot;@@@@ Prefetches may be enabled in this kernel, but are buggy on this board.  @@@@&bslash;n&quot;
)paren
suffix:semicolon
id|bad_config
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|K_SYS_REVISION_BCM1250_PASS2_2
suffix:colon
macro_line|#ifndef CONFIG_SB1_PASS_2_WORKAROUNDS
id|prom_printf
c_func
(paren
l_string|&quot;@@@@ This is a BCM1250 B1/B2. board, and the kernel doesn&squot;t have the proper workarounds compiled in. @@@@&bslash;n&quot;
)paren
suffix:semicolon
id|bad_config
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
macro_line|#if defined(CONFIG_SB1_PASS_2_1_WORKAROUNDS) || !defined(CONFIG_CPU_HAS_PREFETCH)
id|prom_printf
c_func
(paren
l_string|&quot;@@@@ This is a BCM1250 B1/B2, but the kernel is conservatively configured for an &squot;A&squot; stepping. @@@@&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bad_config
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;Invalid configuration for this chip.&bslash;n&quot;
)paren
suffix:semicolon
id|machine_restart
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
eof
