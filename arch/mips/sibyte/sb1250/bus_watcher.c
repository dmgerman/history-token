multiline_comment|/*&n; * Copyright (C) 2002,2003 Broadcom Corporation&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version 2&n; * of the License, or (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; * &n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.&n; */
multiline_comment|/* &n; * The Bus Watcher monitors internal bus transactions and maintains&n; * counts of transactions with error status, logging details and&n; * causing one of several interrupts.  This driver provides a handler&n; * for those interrupts which aggregates the counts (to avoid&n; * saturating the 8-bit counters) and provides a presence in&n; * /proc/bus_watcher if PROC_FS is on.&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/sibyte/sb1250.h&gt;
macro_line|#include &lt;asm/sibyte/sb1250_regs.h&gt;
macro_line|#include &lt;asm/sibyte/sb1250_int.h&gt;
macro_line|#include &lt;asm/sibyte/sb1250_scd.h&gt;
macro_line|#include &lt;asm/sibyte/64bit.h&gt;
DECL|struct|bw_stats_struct
r_struct
id|bw_stats_struct
(brace
DECL|member|status
r_uint64
id|status
suffix:semicolon
DECL|member|l2_err
r_uint32
id|l2_err
suffix:semicolon
DECL|member|memio_err
r_uint32
id|memio_err
suffix:semicolon
DECL|member|status_printed
r_int
id|status_printed
suffix:semicolon
DECL|member|l2_cor_d
r_int
r_int
id|l2_cor_d
suffix:semicolon
DECL|member|l2_bad_d
r_int
r_int
id|l2_bad_d
suffix:semicolon
DECL|member|l2_cor_t
r_int
r_int
id|l2_cor_t
suffix:semicolon
DECL|member|l2_bad_t
r_int
r_int
id|l2_bad_t
suffix:semicolon
DECL|member|mem_cor_d
r_int
r_int
id|mem_cor_d
suffix:semicolon
DECL|member|mem_bad_d
r_int
r_int
id|mem_bad_d
suffix:semicolon
DECL|member|bus_error
r_int
r_int
id|bus_error
suffix:semicolon
DECL|variable|bw_stats
)brace
id|bw_stats
suffix:semicolon
DECL|function|print_summary
r_static
r_void
id|print_summary
c_func
(paren
r_uint32
id|status
comma
r_uint32
id|l2_err
comma
r_uint32
id|memio_err
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Bus watcher error counters: %08x %08x&bslash;n&quot;
comma
id|l2_err
comma
id|memio_err
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;nLast recorded signature:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Request %02x from %d, answered by %d with Dcode %d&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
(paren
id|G_SCD_BERR_TID
c_func
(paren
id|status
)paren
op_amp
l_int|0x3f
)paren
comma
(paren
r_int
)paren
(paren
id|G_SCD_BERR_TID
c_func
(paren
id|status
)paren
op_rshift
l_int|6
)paren
comma
(paren
r_int
)paren
id|G_SCD_BERR_RID
c_func
(paren
id|status
)paren
comma
(paren
r_int
)paren
id|G_SCD_BERR_DCODE
c_func
(paren
id|status
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * check_bus_watcher is exported for use in situations where we want&n; * to see the most recent status of the bus watcher, which might have&n; * already been destructively read out of the registers.&n; *&n; * notes: this is currently used by the cache error handler&n; *        should provide locking against the interrupt handler&n; */
DECL|function|check_bus_watcher
r_void
id|check_bus_watcher
c_func
(paren
r_void
)paren
(brace
id|u32
id|status
comma
id|l2_err
comma
id|memio_err
suffix:semicolon
macro_line|#ifdef CONFIG_SB1_PASS_1_WORKAROUNDS
multiline_comment|/* Destructive read, clears register and interrupt */
id|status
op_assign
id|csr_in32
c_func
(paren
id|IO_SPACE_BASE
op_or
id|A_SCD_BUS_ERR_STATUS
)paren
suffix:semicolon
macro_line|#else
multiline_comment|/* Use non-destructive register */
id|status
op_assign
id|csr_in32
c_func
(paren
id|IO_SPACE_BASE
op_or
id|A_SCD_BUS_ERR_STATUS_DEBUG
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
l_int|0x7fffffff
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Using last values reaped by bus watcher driver&bslash;n&quot;
)paren
suffix:semicolon
id|status
op_assign
id|bw_stats.status
suffix:semicolon
id|l2_err
op_assign
id|bw_stats.l2_err
suffix:semicolon
id|memio_err
op_assign
id|bw_stats.memio_err
suffix:semicolon
)brace
r_else
(brace
id|l2_err
op_assign
id|csr_in32
c_func
(paren
id|IO_SPACE_BASE
op_or
id|A_BUS_L2_ERRORS
)paren
suffix:semicolon
id|memio_err
op_assign
id|csr_in32
c_func
(paren
id|IO_SPACE_BASE
op_or
id|A_BUS_MEM_IO_ERRORS
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
op_complement
(paren
l_int|1UL
op_lshift
l_int|31
)paren
)paren
id|print_summary
c_func
(paren
id|status
comma
id|l2_err
comma
id|memio_err
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;Bus watcher indicates no error&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|bw_print_buffer
r_static
r_int
id|bw_print_buffer
c_func
(paren
r_char
op_star
id|page
comma
r_struct
id|bw_stats_struct
op_star
id|stats
)paren
(brace
r_int
id|len
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;SiByte Bus Watcher statistics&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;-----------------------------&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;L2-d-cor %8ld&bslash;nL2-d-bad %8ld&bslash;n&quot;
comma
id|stats-&gt;l2_cor_d
comma
id|stats-&gt;l2_bad_d
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;L2-t-cor %8ld&bslash;nL2-t-bad %8ld&bslash;n&quot;
comma
id|stats-&gt;l2_cor_t
comma
id|stats-&gt;l2_bad_t
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;MC-d-cor %8ld&bslash;nMC-d-bad %8ld&bslash;n&quot;
comma
id|stats-&gt;mem_cor_d
comma
id|stats-&gt;mem_bad_d
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;IO-err   %8ld&bslash;n&quot;
comma
id|stats-&gt;bus_error
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;&bslash;nLast recorded signature:&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;Request %02x from %d, answered by %d with Dcode %d&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
(paren
id|G_SCD_BERR_TID
c_func
(paren
id|stats-&gt;status
)paren
op_amp
l_int|0x3f
)paren
comma
(paren
r_int
)paren
(paren
id|G_SCD_BERR_TID
c_func
(paren
id|stats-&gt;status
)paren
op_rshift
l_int|6
)paren
comma
(paren
r_int
)paren
id|G_SCD_BERR_RID
c_func
(paren
id|stats-&gt;status
)paren
comma
(paren
r_int
)paren
id|G_SCD_BERR_DCODE
c_func
(paren
id|stats-&gt;status
)paren
)paren
suffix:semicolon
multiline_comment|/* XXXKW indicate multiple errors between printings, or stats&n;           collection (or both)? */
r_if
c_cond
(paren
id|stats-&gt;status
op_amp
id|M_SCD_BERR_MULTERRS
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;Multiple errors observed since last check.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stats-&gt;status_printed
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;(no change since last printing)&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|stats-&gt;status_printed
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
multiline_comment|/* For simplicity, I want to assume a single read is required each&n;   time */
DECL|function|bw_read_proc
r_static
r_int
id|bw_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
id|off
op_eq
l_int|0
)paren
(brace
id|len
op_assign
id|bw_print_buffer
c_func
(paren
id|page
comma
id|data
)paren
suffix:semicolon
op_star
id|start
op_assign
id|page
suffix:semicolon
)brace
r_else
(brace
id|len
op_assign
l_int|0
suffix:semicolon
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
DECL|function|create_proc_decoder
r_static
r_void
id|create_proc_decoder
c_func
(paren
r_struct
id|bw_stats_struct
op_star
id|stats
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|ent
suffix:semicolon
id|ent
op_assign
id|create_proc_read_entry
c_func
(paren
l_string|&quot;bus_watcher&quot;
comma
id|S_IWUSR
op_or
id|S_IRUGO
comma
l_int|NULL
comma
id|bw_read_proc
comma
id|stats
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ent
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Unable to initialize bus_watcher /proc entry&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_PROC_FS */
multiline_comment|/*&n; * sibyte_bw_int - handle bus watcher interrupts and accumulate counts&n; *&n; * notes: possible re-entry due to multiple sources&n; *        should check/indicate saturation&n; */
DECL|function|sibyte_bw_int
r_static
r_void
id|sibyte_bw_int
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|data
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|bw_stats_struct
op_star
id|stats
op_assign
id|data
suffix:semicolon
r_int
r_int
id|cntr
suffix:semicolon
macro_line|#ifndef CONFIG_PROC_FS
r_char
id|bw_buf
(braket
l_int|1024
)braket
suffix:semicolon
macro_line|#endif
multiline_comment|/* Destructive read, clears register and interrupt */
id|stats-&gt;status
op_assign
id|csr_in32
c_func
(paren
id|IO_SPACE_BASE
op_or
id|A_SCD_BUS_ERR_STATUS
)paren
suffix:semicolon
id|stats-&gt;status_printed
op_assign
l_int|0
suffix:semicolon
id|stats-&gt;l2_err
op_assign
id|cntr
op_assign
id|csr_in32
c_func
(paren
id|IO_SPACE_BASE
op_or
id|A_BUS_L2_ERRORS
)paren
suffix:semicolon
id|stats-&gt;l2_cor_d
op_add_assign
id|G_SCD_L2ECC_CORR_D
c_func
(paren
id|cntr
)paren
suffix:semicolon
id|stats-&gt;l2_bad_d
op_add_assign
id|G_SCD_L2ECC_BAD_D
c_func
(paren
id|cntr
)paren
suffix:semicolon
id|stats-&gt;l2_cor_t
op_add_assign
id|G_SCD_L2ECC_CORR_T
c_func
(paren
id|cntr
)paren
suffix:semicolon
id|stats-&gt;l2_bad_t
op_add_assign
id|G_SCD_L2ECC_BAD_T
c_func
(paren
id|cntr
)paren
suffix:semicolon
id|csr_out32
c_func
(paren
l_int|0
comma
id|IO_SPACE_BASE
op_or
id|A_BUS_L2_ERRORS
)paren
suffix:semicolon
id|stats-&gt;memio_err
op_assign
id|cntr
op_assign
id|csr_in32
c_func
(paren
id|IO_SPACE_BASE
op_or
id|A_BUS_MEM_IO_ERRORS
)paren
suffix:semicolon
id|stats-&gt;mem_cor_d
op_add_assign
id|G_SCD_MEM_ECC_CORR
c_func
(paren
id|cntr
)paren
suffix:semicolon
id|stats-&gt;mem_bad_d
op_add_assign
id|G_SCD_MEM_ECC_BAD
c_func
(paren
id|cntr
)paren
suffix:semicolon
id|stats-&gt;bus_error
op_add_assign
id|G_SCD_MEM_BUSERR
c_func
(paren
id|cntr
)paren
suffix:semicolon
id|csr_out32
c_func
(paren
l_int|0
comma
id|IO_SPACE_BASE
op_or
id|A_BUS_MEM_IO_ERRORS
)paren
suffix:semicolon
macro_line|#ifndef CONFIG_PROC_FS
id|bw_print_buffer
c_func
(paren
id|bw_buf
comma
id|stats
)paren
suffix:semicolon
id|printk
c_func
(paren
id|bw_buf
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|sibyte_bus_watcher
r_int
id|__init
id|sibyte_bus_watcher
c_func
(paren
r_void
)paren
(brace
id|memset
c_func
(paren
op_amp
id|bw_stats
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|bw_stats_struct
)paren
)paren
suffix:semicolon
id|bw_stats.status_printed
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|K_INT_BAD_ECC
comma
id|sibyte_bw_int
comma
l_int|0
comma
l_string|&quot;Bus watcher&quot;
comma
op_amp
id|bw_stats
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to register bus watcher BAD_ECC irq&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|K_INT_COR_ECC
comma
id|sibyte_bw_int
comma
l_int|0
comma
l_string|&quot;Bus watcher&quot;
comma
op_amp
id|bw_stats
)paren
)paren
(brace
id|free_irq
c_func
(paren
id|K_INT_BAD_ECC
comma
op_amp
id|bw_stats
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Failed to register bus watcher COR_ECC irq&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|K_INT_IO_BUS
comma
id|sibyte_bw_int
comma
l_int|0
comma
l_string|&quot;Bus watcher&quot;
comma
op_amp
id|bw_stats
)paren
)paren
(brace
id|free_irq
c_func
(paren
id|K_INT_BAD_ECC
comma
op_amp
id|bw_stats
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|K_INT_COR_ECC
comma
op_amp
id|bw_stats
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Failed to register bus watcher IO_BUS irq&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
id|create_proc_decoder
c_func
(paren
op_amp
id|bw_stats
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sibyte_bus_watcher
id|__initcall
c_func
(paren
id|sibyte_bus_watcher
)paren
suffix:semicolon
eof
