multiline_comment|/*&n; * Copyright 2002 Momentum Computer&n; * Author: mdharm@momenco.com&n; *&n; * arch/mips/momentum/ocelot_c/uart-irq.c&n; *     Interrupt routines for UARTs.  Interrupt numbers are assigned from&n; *     80 to 81 (2 interrupt sources).&n; *&n; * This program is free software; you can redistribute  it and/or modify it&n; * under  the terms of  the GNU General  Public License as published by the&n; * Free Software Foundation;  either version 2 of the  License, or (at your&n; * option) any later version.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel_stat.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &quot;ocelot_c_fpga.h&quot;
DECL|function|ls1bit8
r_static
r_inline
r_int
id|ls1bit8
c_func
(paren
r_int
r_int
id|x
)paren
(brace
r_int
id|b
op_assign
l_int|7
comma
id|s
suffix:semicolon
id|s
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
r_char
)paren
(paren
id|x
op_lshift
l_int|4
)paren
)paren
op_eq
l_int|0
)paren
id|s
op_assign
l_int|0
suffix:semicolon
id|b
op_sub_assign
id|s
suffix:semicolon
id|x
op_lshift_assign
id|s
suffix:semicolon
id|s
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
r_char
)paren
(paren
id|x
op_lshift
l_int|2
)paren
)paren
op_eq
l_int|0
)paren
id|s
op_assign
l_int|0
suffix:semicolon
id|b
op_sub_assign
id|s
suffix:semicolon
id|x
op_lshift_assign
id|s
suffix:semicolon
id|s
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
r_char
)paren
(paren
id|x
op_lshift
l_int|1
)paren
)paren
op_eq
l_int|0
)paren
id|s
op_assign
l_int|0
suffix:semicolon
id|b
op_sub_assign
id|s
suffix:semicolon
r_return
id|b
suffix:semicolon
)brace
multiline_comment|/* mask off an interrupt -- 0 is enable, 1 is disable */
DECL|function|mask_uart_irq
r_static
r_inline
r_void
id|mask_uart_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_uint8
id|value
suffix:semicolon
id|value
op_assign
id|OCELOT_FPGA_READ
c_func
(paren
id|UART_INTMASK
)paren
suffix:semicolon
id|value
op_or_assign
l_int|1
op_lshift
(paren
id|irq
op_minus
l_int|74
)paren
suffix:semicolon
id|OCELOT_FPGA_WRITE
c_func
(paren
id|value
comma
id|UART_INTMASK
)paren
suffix:semicolon
multiline_comment|/* read the value back to assure that it&squot;s really been written */
id|value
op_assign
id|OCELOT_FPGA_READ
c_func
(paren
id|UART_INTMASK
)paren
suffix:semicolon
)brace
multiline_comment|/* unmask an interrupt -- 0 is enable, 1 is disable */
DECL|function|unmask_uart_irq
r_static
r_inline
r_void
id|unmask_uart_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_uint8
id|value
suffix:semicolon
id|value
op_assign
id|OCELOT_FPGA_READ
c_func
(paren
id|UART_INTMASK
)paren
suffix:semicolon
id|value
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|irq
op_minus
l_int|74
)paren
)paren
suffix:semicolon
id|OCELOT_FPGA_WRITE
c_func
(paren
id|value
comma
id|UART_INTMASK
)paren
suffix:semicolon
multiline_comment|/* read the value back to assure that it&squot;s really been written */
id|value
op_assign
id|OCELOT_FPGA_READ
c_func
(paren
id|UART_INTMASK
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Enables the IRQ in the FPGA&n; */
DECL|function|enable_uart_irq
r_static
r_void
id|enable_uart_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|unmask_uart_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialize the IRQ in the FPGA&n; */
DECL|function|startup_uart_irq
r_static
r_int
r_int
id|startup_uart_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|unmask_uart_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Disables the IRQ in the FPGA&n; */
DECL|function|disable_uart_irq
r_static
r_void
id|disable_uart_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|mask_uart_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Masks and ACKs an IRQ&n; */
DECL|function|mask_and_ack_uart_irq
r_static
r_void
id|mask_and_ack_uart_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|mask_uart_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * End IRQ processing&n; */
DECL|function|end_uart_irq
r_static
r_void
id|end_uart_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|irq_desc
(braket
id|irq
)braket
dot
id|status
op_amp
(paren
id|IRQ_DISABLED
op_or
id|IRQ_INPROGRESS
)paren
)paren
)paren
id|unmask_uart_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Interrupt handler for interrupts coming from the FPGA chip.&n; */
DECL|function|ll_uart_irq
r_void
id|ll_uart_irq
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|irq_src
comma
id|irq_mask
suffix:semicolon
multiline_comment|/* read the interrupt status registers */
id|irq_src
op_assign
id|OCELOT_FPGA_READ
c_func
(paren
id|UART_INTSTAT
)paren
suffix:semicolon
id|irq_mask
op_assign
id|OCELOT_FPGA_READ
c_func
(paren
id|UART_INTMASK
)paren
suffix:semicolon
multiline_comment|/* mask for just the interrupts we want */
id|irq_src
op_and_assign
op_complement
id|irq_mask
suffix:semicolon
id|do_IRQ
c_func
(paren
id|ls1bit8
c_func
(paren
id|irq_src
)paren
op_plus
l_int|74
comma
id|regs
)paren
suffix:semicolon
)brace
DECL|macro|shutdown_uart_irq
mdefine_line|#define shutdown_uart_irq&t;disable_uart_irq
DECL|variable|uart_irq_type
r_struct
id|hw_interrupt_type
id|uart_irq_type
op_assign
(brace
l_string|&quot;UART/FPGA&quot;
comma
id|startup_uart_irq
comma
id|shutdown_uart_irq
comma
id|enable_uart_irq
comma
id|disable_uart_irq
comma
id|mask_and_ack_uart_irq
comma
id|end_uart_irq
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|uart_irq_init
r_void
id|uart_irq_init
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Reset irq handlers pointers to NULL */
id|irq_desc
(braket
l_int|80
)braket
dot
id|status
op_assign
id|IRQ_DISABLED
suffix:semicolon
id|irq_desc
(braket
l_int|80
)braket
dot
id|action
op_assign
l_int|0
suffix:semicolon
id|irq_desc
(braket
l_int|80
)braket
dot
id|depth
op_assign
l_int|2
suffix:semicolon
id|irq_desc
(braket
l_int|80
)braket
dot
id|handler
op_assign
op_amp
id|uart_irq_type
suffix:semicolon
id|irq_desc
(braket
l_int|81
)braket
dot
id|status
op_assign
id|IRQ_DISABLED
suffix:semicolon
id|irq_desc
(braket
l_int|81
)braket
dot
id|action
op_assign
l_int|0
suffix:semicolon
id|irq_desc
(braket
l_int|81
)braket
dot
id|depth
op_assign
l_int|2
suffix:semicolon
id|irq_desc
(braket
l_int|81
)braket
dot
id|handler
op_assign
op_amp
id|uart_irq_type
suffix:semicolon
)brace
eof
