multiline_comment|/*&n; * Copyright 2002 Momentum Computer Inc.&n; * Author: Matthew Dharm &lt;mdharm@momenco.com&gt; &n; *&n; * Based on work for the Linux port to the Ocelot board, which is&n; * Copyright 2001 MontaVista Software Inc.&n; * Author: Jun Sun, jsun@mvista.com or jsun@junsun.net&n; *&n; * arch/mips/momentum/ocelot_g/pci.c&n; *     Board-specific PCI routines for mv64340 controller.&n; *&n; * This program is free software; you can redistribute  it and/or modify it&n; * under  the terms of  the GNU General  Public License as published by the&n; * Free Software Foundation;  either version 2 of the  License, or (at your&n; * option) any later version.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/pci.h&gt;
DECL|function|mv64340_board_pcibios_fixup_bus
r_void
id|__init
id|mv64340_board_pcibios_fixup_bus
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
)paren
(brace
r_struct
id|pci_bus
op_star
id|current_bus
op_assign
id|bus
suffix:semicolon
r_struct
id|pci_dev
op_star
id|devices
suffix:semicolon
r_struct
id|list_head
op_star
id|devices_link
suffix:semicolon
id|u16
id|cmd
suffix:semicolon
multiline_comment|/* loop over all known devices on this bus */
id|list_for_each
c_func
(paren
id|devices_link
comma
op_amp
(paren
id|current_bus-&gt;devices
)paren
)paren
(brace
id|devices
op_assign
id|pci_dev_b
c_func
(paren
id|devices_link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devices
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|current_bus-&gt;number
op_eq
l_int|0
)paren
op_logical_and
(paren
id|PCI_SLOT
c_func
(paren
id|devices-&gt;devfn
)paren
op_eq
l_int|1
)paren
op_logical_and
(paren
id|PCI_FUNC
c_func
(paren
id|devices-&gt;devfn
)paren
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/* LSI 53C10101R SCSI (A) */
id|devices-&gt;irq
op_assign
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|current_bus-&gt;number
op_eq
l_int|0
)paren
op_logical_and
(paren
id|PCI_SLOT
c_func
(paren
id|devices-&gt;devfn
)paren
op_eq
l_int|1
)paren
op_logical_and
(paren
id|PCI_FUNC
c_func
(paren
id|devices-&gt;devfn
)paren
op_eq
l_int|1
)paren
)paren
(brace
multiline_comment|/* LSI 53C10101R SCSI (B) */
id|devices-&gt;irq
op_assign
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|current_bus-&gt;number
op_eq
l_int|1
)paren
op_logical_and
(paren
id|PCI_SLOT
c_func
(paren
id|devices-&gt;devfn
)paren
op_eq
l_int|1
)paren
)paren
(brace
multiline_comment|/* Intel 21555 bridge */
id|devices-&gt;irq
op_assign
l_int|12
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|current_bus-&gt;number
op_eq
l_int|1
)paren
op_logical_and
(paren
id|PCI_SLOT
c_func
(paren
id|devices-&gt;devfn
)paren
op_eq
l_int|2
)paren
)paren
(brace
multiline_comment|/* PMC Slot */
id|devices-&gt;irq
op_assign
l_int|4
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* We don&squot;t have assign interrupts for other devices. */
id|devices-&gt;irq
op_assign
l_int|0xff
suffix:semicolon
)brace
multiline_comment|/* Assign an interrupt number for the device */
id|bus-&gt;ops
op_member_access_from_pointer
id|write_byte
c_func
(paren
id|devices
comma
id|PCI_INTERRUPT_LINE
comma
id|devices-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* enable master for everything but the MV-64340 */
r_if
c_cond
(paren
(paren
(paren
id|current_bus-&gt;number
op_ne
l_int|0
)paren
op_logical_and
(paren
id|current_bus-&gt;number
op_ne
l_int|1
)paren
)paren
op_logical_or
(paren
id|PCI_SLOT
c_func
(paren
id|devices-&gt;devfn
)paren
op_ne
l_int|0
)paren
)paren
(brace
id|bus-&gt;ops
op_member_access_from_pointer
id|read_word
c_func
(paren
id|devices
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd
op_or_assign
id|PCI_COMMAND_MASTER
suffix:semicolon
id|bus-&gt;ops
op_member_access_from_pointer
id|write_word
c_func
(paren
id|devices
comma
id|PCI_COMMAND
comma
id|cmd
)paren
suffix:semicolon
)brace
)brace
)brace
eof
