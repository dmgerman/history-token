multiline_comment|/*&n; * Copyright 2002 Momentum Computer&n; * Author: mdharm@momenco.com&n; *&n; * arch/mips/momentum/ocelot_c/cpci-irq.c&n; *     Interrupt routines for cpci.  Interrupt numbers are assigned from&n; *     CPCI_IRQ_BASE to CPCI_IRQ_BASE+8 (8 interrupt sources).&n; *&n; * Note that the high-level software will need to be careful about using&n; * these interrupts.  If this board is asserting a cPCI interrupt, it will&n; * also see the asserted interrupt.  Care must be taken to avoid an&n; * interrupt flood.&n; *&n; * This program is free software; you can redistribute  it and/or modify it&n; * under  the terms of  the GNU General  Public License as published by the&n; * Free Software Foundation;  either version 2 of the  License, or (at your&n; * option) any later version.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel_stat.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;ocelot_c_fpga.h&quot;
DECL|macro|CPCI_IRQ_BASE
mdefine_line|#define CPCI_IRQ_BASE&t;8
DECL|function|ls1bit8
r_static
r_inline
r_int
id|ls1bit8
c_func
(paren
r_int
r_int
id|x
)paren
(brace
r_int
id|b
op_assign
l_int|7
comma
id|s
suffix:semicolon
id|s
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
r_char
)paren
(paren
id|x
op_lshift
l_int|4
)paren
)paren
op_eq
l_int|0
)paren
id|s
op_assign
l_int|0
suffix:semicolon
id|b
op_sub_assign
id|s
suffix:semicolon
id|x
op_lshift_assign
id|s
suffix:semicolon
id|s
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
r_char
)paren
(paren
id|x
op_lshift
l_int|2
)paren
)paren
op_eq
l_int|0
)paren
id|s
op_assign
l_int|0
suffix:semicolon
id|b
op_sub_assign
id|s
suffix:semicolon
id|x
op_lshift_assign
id|s
suffix:semicolon
id|s
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
r_char
)paren
(paren
id|x
op_lshift
l_int|1
)paren
)paren
op_eq
l_int|0
)paren
id|s
op_assign
l_int|0
suffix:semicolon
id|b
op_sub_assign
id|s
suffix:semicolon
r_return
id|b
suffix:semicolon
)brace
multiline_comment|/* mask off an interrupt -- 0 is enable, 1 is disable */
DECL|function|mask_cpci_irq
r_static
r_inline
r_void
id|mask_cpci_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_uint32
id|value
suffix:semicolon
id|value
op_assign
id|OCELOT_FPGA_READ
c_func
(paren
id|INTMASK
)paren
suffix:semicolon
id|value
op_or_assign
l_int|1
op_lshift
(paren
id|irq
op_minus
id|CPCI_IRQ_BASE
)paren
suffix:semicolon
id|OCELOT_FPGA_WRITE
c_func
(paren
id|value
comma
id|INTMASK
)paren
suffix:semicolon
multiline_comment|/* read the value back to assure that it&squot;s really been written */
id|value
op_assign
id|OCELOT_FPGA_READ
c_func
(paren
id|INTMASK
)paren
suffix:semicolon
)brace
multiline_comment|/* unmask an interrupt -- 0 is enable, 1 is disable */
DECL|function|unmask_cpci_irq
r_static
r_inline
r_void
id|unmask_cpci_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_uint32
id|value
suffix:semicolon
id|value
op_assign
id|OCELOT_FPGA_READ
c_func
(paren
id|INTMASK
)paren
suffix:semicolon
id|value
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|irq
op_minus
id|CPCI_IRQ_BASE
)paren
)paren
suffix:semicolon
id|OCELOT_FPGA_WRITE
c_func
(paren
id|value
comma
id|INTMASK
)paren
suffix:semicolon
multiline_comment|/* read the value back to assure that it&squot;s really been written */
id|value
op_assign
id|OCELOT_FPGA_READ
c_func
(paren
id|INTMASK
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Enables the IRQ in the FPGA&n; */
DECL|function|enable_cpci_irq
r_static
r_void
id|enable_cpci_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|unmask_cpci_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialize the IRQ in the FPGA&n; */
DECL|function|startup_cpci_irq
r_static
r_int
r_int
id|startup_cpci_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|unmask_cpci_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Disables the IRQ in the FPGA&n; */
DECL|function|disable_cpci_irq
r_static
r_void
id|disable_cpci_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|mask_cpci_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Masks and ACKs an IRQ&n; */
DECL|function|mask_and_ack_cpci_irq
r_static
r_void
id|mask_and_ack_cpci_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|mask_cpci_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * End IRQ processing&n; */
DECL|function|end_cpci_irq
r_static
r_void
id|end_cpci_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|irq_desc
(braket
id|irq
)braket
dot
id|status
op_amp
(paren
id|IRQ_DISABLED
op_or
id|IRQ_INPROGRESS
)paren
)paren
)paren
id|unmask_cpci_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Interrupt handler for interrupts coming from the FPGA chip.&n; * It could be built in ethernet ports etc...&n; */
DECL|function|ll_cpci_irq
r_void
id|ll_cpci_irq
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|irq_src
comma
id|irq_mask
suffix:semicolon
multiline_comment|/* read the interrupt status registers */
id|irq_src
op_assign
id|OCELOT_FPGA_READ
c_func
(paren
id|INTSTAT
)paren
suffix:semicolon
id|irq_mask
op_assign
id|OCELOT_FPGA_READ
c_func
(paren
id|INTMASK
)paren
suffix:semicolon
multiline_comment|/* mask for just the interrupts we want */
id|irq_src
op_and_assign
op_complement
id|irq_mask
suffix:semicolon
id|do_IRQ
c_func
(paren
id|ls1bit8
c_func
(paren
id|irq_src
)paren
op_plus
id|CPCI_IRQ_BASE
comma
id|regs
)paren
suffix:semicolon
)brace
DECL|macro|shutdown_cpci_irq
mdefine_line|#define shutdown_cpci_irq&t;disable_cpci_irq
DECL|variable|cpci_irq_type
r_struct
id|hw_interrupt_type
id|cpci_irq_type
op_assign
(brace
l_string|&quot;CPCI/FPGA&quot;
comma
id|startup_cpci_irq
comma
id|shutdown_cpci_irq
comma
id|enable_cpci_irq
comma
id|disable_cpci_irq
comma
id|mask_and_ack_cpci_irq
comma
id|end_cpci_irq
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|cpci_irq_init
r_void
id|cpci_irq_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Reset irq handlers pointers to NULL */
r_for
c_loop
(paren
id|i
op_assign
id|CPCI_IRQ_BASE
suffix:semicolon
id|i
OL
(paren
id|CPCI_IRQ_BASE
op_plus
l_int|8
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|irq_desc
(braket
id|i
)braket
dot
id|status
op_assign
id|IRQ_DISABLED
suffix:semicolon
id|irq_desc
(braket
id|i
)braket
dot
id|action
op_assign
l_int|0
suffix:semicolon
id|irq_desc
(braket
id|i
)braket
dot
id|depth
op_assign
l_int|2
suffix:semicolon
id|irq_desc
(braket
id|i
)braket
dot
id|handler
op_assign
op_amp
id|cpci_irq_type
suffix:semicolon
)brace
)brace
eof
