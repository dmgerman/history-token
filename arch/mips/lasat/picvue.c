multiline_comment|/* &n; * Picvue PVC160206 display driver&n; *&n; * Brian Murphy &lt;brian@murphy.dk&gt; &n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#include &lt;asm/lasat/lasat.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &quot;picvue.h&quot;
DECL|macro|PVC_BUSY
mdefine_line|#define PVC_BUSY&t;&t;0x80
DECL|macro|PVC_NLINES
mdefine_line|#define PVC_NLINES&t;&t;2
DECL|macro|PVC_DISPMEM
mdefine_line|#define PVC_DISPMEM&t;&t;80
DECL|macro|PVC_LINELEN
mdefine_line|#define PVC_LINELEN&t;&t;PVC_DISPMEM / PVC_NLINES
DECL|variable|picvue
r_struct
id|pvc_defs
op_star
id|picvue
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|pvc_sem
id|DECLARE_MUTEX
c_func
(paren
id|pvc_sem
)paren
suffix:semicolon
DECL|function|pvc_reg_write
r_static
r_void
id|pvc_reg_write
c_func
(paren
id|u32
id|val
)paren
(brace
op_star
id|picvue-&gt;reg
op_assign
id|val
suffix:semicolon
)brace
DECL|function|pvc_reg_read
r_static
id|u32
id|pvc_reg_read
c_func
(paren
r_void
)paren
(brace
id|u32
id|tmp
op_assign
op_star
id|picvue-&gt;reg
suffix:semicolon
r_return
id|tmp
suffix:semicolon
)brace
DECL|function|pvc_write_byte
r_static
r_void
id|pvc_write_byte
c_func
(paren
id|u32
id|data
comma
id|u8
id|byte
)paren
(brace
id|data
op_or_assign
id|picvue-&gt;e
suffix:semicolon
id|pvc_reg_write
c_func
(paren
id|data
)paren
suffix:semicolon
id|data
op_and_assign
op_complement
id|picvue-&gt;data_mask
suffix:semicolon
id|data
op_or_assign
id|byte
op_lshift
id|picvue-&gt;data_shift
suffix:semicolon
id|pvc_reg_write
c_func
(paren
id|data
)paren
suffix:semicolon
id|ndelay
c_func
(paren
l_int|220
)paren
suffix:semicolon
id|pvc_reg_write
c_func
(paren
id|data
op_amp
op_complement
id|picvue-&gt;e
)paren
suffix:semicolon
id|ndelay
c_func
(paren
l_int|220
)paren
suffix:semicolon
)brace
DECL|function|pvc_read_byte
r_static
id|u8
id|pvc_read_byte
c_func
(paren
id|u32
id|data
)paren
(brace
id|u8
id|byte
suffix:semicolon
id|data
op_or_assign
id|picvue-&gt;e
suffix:semicolon
id|pvc_reg_write
c_func
(paren
id|data
)paren
suffix:semicolon
id|ndelay
c_func
(paren
l_int|220
)paren
suffix:semicolon
id|byte
op_assign
(paren
id|pvc_reg_read
c_func
(paren
)paren
op_amp
id|picvue-&gt;data_mask
)paren
op_rshift
id|picvue-&gt;data_shift
suffix:semicolon
id|data
op_and_assign
op_complement
id|picvue-&gt;e
suffix:semicolon
id|pvc_reg_write
c_func
(paren
id|data
)paren
suffix:semicolon
id|ndelay
c_func
(paren
l_int|220
)paren
suffix:semicolon
r_return
id|byte
suffix:semicolon
)brace
DECL|function|pvc_read_data
r_static
id|u8
id|pvc_read_data
c_func
(paren
r_void
)paren
(brace
id|u32
id|data
op_assign
id|pvc_reg_read
c_func
(paren
)paren
suffix:semicolon
id|u8
id|byte
suffix:semicolon
id|data
op_or_assign
id|picvue-&gt;rw
suffix:semicolon
id|data
op_and_assign
op_complement
id|picvue-&gt;rs
suffix:semicolon
id|pvc_reg_write
c_func
(paren
id|data
)paren
suffix:semicolon
id|ndelay
c_func
(paren
l_int|40
)paren
suffix:semicolon
id|byte
op_assign
id|pvc_read_byte
c_func
(paren
id|data
)paren
suffix:semicolon
id|data
op_or_assign
id|picvue-&gt;rs
suffix:semicolon
id|pvc_reg_write
c_func
(paren
id|data
)paren
suffix:semicolon
r_return
id|byte
suffix:semicolon
)brace
DECL|macro|TIMEOUT
mdefine_line|#define TIMEOUT 1000
DECL|function|pvc_wait
r_static
r_int
id|pvc_wait
c_func
(paren
r_void
)paren
(brace
r_int
id|i
op_assign
id|TIMEOUT
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pvc_read_data
c_func
(paren
)paren
op_amp
id|PVC_BUSY
)paren
op_logical_and
id|i
)paren
id|i
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
id|err
op_assign
op_minus
id|ETIME
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|macro|MODE_INST
mdefine_line|#define MODE_INST 0
DECL|macro|MODE_DATA
mdefine_line|#define MODE_DATA 1
DECL|function|pvc_write
r_static
r_void
id|pvc_write
c_func
(paren
id|u8
id|byte
comma
r_int
id|mode
)paren
(brace
id|u32
id|data
op_assign
id|pvc_reg_read
c_func
(paren
)paren
suffix:semicolon
id|data
op_and_assign
op_complement
id|picvue-&gt;rw
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|MODE_DATA
)paren
id|data
op_or_assign
id|picvue-&gt;rs
suffix:semicolon
r_else
id|data
op_and_assign
op_complement
id|picvue-&gt;rs
suffix:semicolon
id|pvc_reg_write
c_func
(paren
id|data
)paren
suffix:semicolon
id|ndelay
c_func
(paren
l_int|40
)paren
suffix:semicolon
id|pvc_write_byte
c_func
(paren
id|data
comma
id|byte
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|MODE_DATA
)paren
id|data
op_and_assign
op_complement
id|picvue-&gt;rs
suffix:semicolon
r_else
id|data
op_or_assign
id|picvue-&gt;rs
suffix:semicolon
id|pvc_reg_write
c_func
(paren
id|data
)paren
suffix:semicolon
id|pvc_wait
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|pvc_write_string
r_void
id|pvc_write_string
c_func
(paren
r_const
r_int
r_char
op_star
id|str
comma
id|u8
id|addr
comma
r_int
id|line
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|line
OG
l_int|0
op_logical_and
(paren
id|PVC_NLINES
OG
l_int|1
)paren
)paren
id|addr
op_add_assign
l_int|0x40
op_star
id|line
suffix:semicolon
id|pvc_write
c_func
(paren
l_int|0x80
op_or
id|addr
comma
id|MODE_INST
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|str
op_ne
l_int|0
op_logical_and
id|i
OL
id|PVC_LINELEN
)paren
(brace
id|pvc_write
c_func
(paren
op_star
id|str
op_increment
comma
id|MODE_DATA
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
)brace
DECL|function|pvc_write_string_centered
r_void
id|pvc_write_string_centered
c_func
(paren
r_const
r_int
r_char
op_star
id|str
comma
r_int
id|line
)paren
(brace
r_int
id|len
op_assign
id|strlen
c_func
(paren
id|str
)paren
suffix:semicolon
id|u8
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|PVC_VISIBLE_CHARS
)paren
id|addr
op_assign
l_int|0
suffix:semicolon
r_else
id|addr
op_assign
(paren
id|PVC_VISIBLE_CHARS
op_minus
id|strlen
c_func
(paren
id|str
)paren
)paren
op_div
l_int|2
suffix:semicolon
id|pvc_write_string
c_func
(paren
id|str
comma
id|addr
comma
id|line
)paren
suffix:semicolon
)brace
DECL|function|pvc_dump_string
r_void
id|pvc_dump_string
c_func
(paren
r_const
r_int
r_char
op_star
id|str
)paren
(brace
r_int
id|len
op_assign
id|strlen
c_func
(paren
id|str
)paren
suffix:semicolon
id|pvc_write_string
c_func
(paren
id|str
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|PVC_VISIBLE_CHARS
)paren
id|pvc_write_string
c_func
(paren
op_amp
id|str
(braket
id|PVC_VISIBLE_CHARS
)braket
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|macro|BM_SIZE
mdefine_line|#define BM_SIZE&t;&t;&t;8
DECL|macro|MAX_PROGRAMMABLE_CHARS
mdefine_line|#define MAX_PROGRAMMABLE_CHARS&t;8
DECL|function|pvc_program_cg
r_int
id|pvc_program_cg
c_func
(paren
r_int
id|charnum
comma
id|u8
id|bitmap
(braket
id|BM_SIZE
)braket
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|charnum
OG
id|MAX_PROGRAMMABLE_CHARS
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
id|addr
op_assign
id|charnum
op_star
l_int|8
suffix:semicolon
id|pvc_write
c_func
(paren
l_int|0x40
op_or
id|addr
comma
id|MODE_INST
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|BM_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|pvc_write
c_func
(paren
id|bitmap
(braket
id|i
)braket
comma
id|MODE_DATA
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|FUNC_SET_CMD
mdefine_line|#define FUNC_SET_CMD&t;0x20
DECL|macro|EIGHT_BYTE
mdefine_line|#define  EIGHT_BYTE&t;(1 &lt;&lt; 4)
DECL|macro|FOUR_BYTE
mdefine_line|#define  FOUR_BYTE&t;0
DECL|macro|TWO_LINES
mdefine_line|#define  TWO_LINES&t;(1 &lt;&lt; 3)
DECL|macro|ONE_LINE
mdefine_line|#define  ONE_LINE&t;0
DECL|macro|LARGE_FONT
mdefine_line|#define  LARGE_FONT&t;(1 &lt;&lt; 2)
DECL|macro|SMALL_FONT
mdefine_line|#define  SMALL_FONT&t;0
DECL|function|pvc_funcset
r_static
r_void
id|pvc_funcset
c_func
(paren
id|u8
id|cmd
)paren
(brace
id|pvc_write
c_func
(paren
id|FUNC_SET_CMD
op_or
(paren
id|cmd
op_amp
(paren
id|EIGHT_BYTE
op_or
id|TWO_LINES
op_or
id|LARGE_FONT
)paren
)paren
comma
id|MODE_INST
)paren
suffix:semicolon
)brace
DECL|macro|ENTRYMODE_CMD
mdefine_line|#define ENTRYMODE_CMD&t;&t;0x4
DECL|macro|AUTO_INC
mdefine_line|#define  AUTO_INC&t;&t;(1 &lt;&lt; 1)
DECL|macro|AUTO_DEC
mdefine_line|#define  AUTO_DEC&t;&t;0
DECL|macro|CURSOR_FOLLOWS_DISP
mdefine_line|#define  CURSOR_FOLLOWS_DISP&t;(1 &lt;&lt; 0)
DECL|function|pvc_entrymode
r_static
r_void
id|pvc_entrymode
c_func
(paren
id|u8
id|cmd
)paren
(brace
id|pvc_write
c_func
(paren
id|ENTRYMODE_CMD
op_or
(paren
id|cmd
op_amp
(paren
id|AUTO_INC
op_or
id|CURSOR_FOLLOWS_DISP
)paren
)paren
comma
id|MODE_INST
)paren
suffix:semicolon
)brace
DECL|macro|DISP_CNT_CMD
mdefine_line|#define DISP_CNT_CMD&t;0x08
DECL|macro|DISP_OFF
mdefine_line|#define  DISP_OFF&t;0
DECL|macro|DISP_ON
mdefine_line|#define  DISP_ON&t;(1 &lt;&lt; 2)
DECL|macro|CUR_ON
mdefine_line|#define  CUR_ON&t;&t;(1 &lt;&lt; 1)
DECL|macro|CUR_BLINK
mdefine_line|#define  CUR_BLINK&t;(1 &lt;&lt; 0)
DECL|function|pvc_dispcnt
r_void
id|pvc_dispcnt
c_func
(paren
id|u8
id|cmd
)paren
(brace
id|pvc_write
c_func
(paren
id|DISP_CNT_CMD
op_or
(paren
id|cmd
op_amp
(paren
id|DISP_ON
op_or
id|CUR_ON
op_or
id|CUR_BLINK
)paren
)paren
comma
id|MODE_INST
)paren
suffix:semicolon
)brace
DECL|macro|MOVE_CMD
mdefine_line|#define MOVE_CMD&t;0x10
DECL|macro|DISPLAY
mdefine_line|#define  DISPLAY&t;(1 &lt;&lt; 3)
DECL|macro|CURSOR
mdefine_line|#define  CURSOR&t;&t;0
DECL|macro|RIGHT
mdefine_line|#define  RIGHT&t;&t;(1 &lt;&lt; 2)
DECL|macro|LEFT
mdefine_line|#define  LEFT&t;&t;0
DECL|function|pvc_move
r_void
id|pvc_move
c_func
(paren
id|u8
id|cmd
)paren
(brace
id|pvc_write
c_func
(paren
id|MOVE_CMD
op_or
(paren
id|cmd
op_amp
(paren
id|DISPLAY
op_or
id|RIGHT
)paren
)paren
comma
id|MODE_INST
)paren
suffix:semicolon
)brace
DECL|macro|CLEAR_CMD
mdefine_line|#define CLEAR_CMD&t;0x1
DECL|function|pvc_clear
r_void
id|pvc_clear
c_func
(paren
r_void
)paren
(brace
id|pvc_write
c_func
(paren
id|CLEAR_CMD
comma
id|MODE_INST
)paren
suffix:semicolon
)brace
DECL|macro|HOME_CMD
mdefine_line|#define HOME_CMD&t;0x2
DECL|function|pvc_home
r_void
id|pvc_home
c_func
(paren
r_void
)paren
(brace
id|pvc_write
c_func
(paren
id|HOME_CMD
comma
id|MODE_INST
)paren
suffix:semicolon
)brace
DECL|function|pvc_init
r_int
id|pvc_init
c_func
(paren
r_void
)paren
(brace
id|u8
id|cmd
op_assign
id|EIGHT_BYTE
suffix:semicolon
r_if
c_cond
(paren
id|PVC_NLINES
op_eq
l_int|2
)paren
id|cmd
op_or_assign
(paren
id|SMALL_FONT
op_or
id|TWO_LINES
)paren
suffix:semicolon
r_else
id|cmd
op_or_assign
(paren
id|LARGE_FONT
op_or
id|ONE_LINE
)paren
suffix:semicolon
id|pvc_funcset
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|pvc_dispcnt
c_func
(paren
id|DISP_ON
)paren
suffix:semicolon
id|pvc_entrymode
c_func
(paren
id|AUTO_INC
)paren
suffix:semicolon
id|pvc_clear
c_func
(paren
)paren
suffix:semicolon
id|pvc_write_string_centered
c_func
(paren
l_string|&quot;Display&quot;
comma
l_int|0
)paren
suffix:semicolon
id|pvc_write_string_centered
c_func
(paren
l_string|&quot;Initialized&quot;
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|pvc_init
id|module_init
c_func
(paren
id|pvc_init
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
