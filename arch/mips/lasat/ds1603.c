multiline_comment|/* &n; * Dallas Semiconductors 1603 RTC driver &n; *&n; * Brian Murphy &lt;brian@murphy.dk&gt; &n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/lasat/lasat.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/lasat/ds1603.h&gt;
macro_line|#include &quot;ds1603.h&quot;
DECL|macro|READ_TIME_CMD
mdefine_line|#define READ_TIME_CMD 0x81
DECL|macro|SET_TIME_CMD
mdefine_line|#define SET_TIME_CMD 0x80
DECL|macro|TRIMMER_SET_CMD
mdefine_line|#define TRIMMER_SET_CMD 0xC0
DECL|macro|TRIMMER_VALUE_MASK
mdefine_line|#define TRIMMER_VALUE_MASK 0x38
DECL|macro|TRIMMER_SHIFT
mdefine_line|#define TRIMMER_SHIFT 3
DECL|variable|ds1603
r_struct
id|ds_defs
op_star
id|ds1603
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* HW specific register functions */
DECL|function|rtc_reg_write
r_static
r_void
id|rtc_reg_write
c_func
(paren
r_int
r_int
id|val
)paren
(brace
op_star
id|ds1603-&gt;reg
op_assign
id|val
suffix:semicolon
)brace
DECL|function|rtc_reg_read
r_static
r_int
r_int
id|rtc_reg_read
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|tmp
op_assign
op_star
id|ds1603-&gt;reg
suffix:semicolon
r_return
id|tmp
suffix:semicolon
)brace
DECL|function|rtc_datareg_read
r_static
r_int
r_int
id|rtc_datareg_read
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|tmp
op_assign
op_star
id|ds1603-&gt;data_reg
suffix:semicolon
r_return
id|tmp
suffix:semicolon
)brace
DECL|function|rtc_nrst_high
r_static
r_void
id|rtc_nrst_high
c_func
(paren
r_void
)paren
(brace
id|rtc_reg_write
c_func
(paren
id|rtc_reg_read
c_func
(paren
)paren
op_or
id|ds1603-&gt;rst
)paren
suffix:semicolon
)brace
DECL|function|rtc_nrst_low
r_static
r_void
id|rtc_nrst_low
c_func
(paren
r_void
)paren
(brace
id|rtc_reg_write
c_func
(paren
id|rtc_reg_read
c_func
(paren
)paren
op_amp
op_complement
id|ds1603-&gt;rst
)paren
suffix:semicolon
)brace
DECL|function|rtc_cycle_clock
r_static
r_void
id|rtc_cycle_clock
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|data
op_or_assign
id|ds1603-&gt;clk
suffix:semicolon
id|rtc_reg_write
c_func
(paren
id|data
)paren
suffix:semicolon
id|ndelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ds1603-&gt;data_reversed
)paren
id|data
op_and_assign
op_complement
id|ds1603-&gt;data
suffix:semicolon
r_else
id|data
op_or_assign
id|ds1603-&gt;data
suffix:semicolon
id|data
op_and_assign
op_complement
id|ds1603-&gt;clk
suffix:semicolon
id|rtc_reg_write
c_func
(paren
id|data
)paren
suffix:semicolon
id|ndelay
c_func
(paren
l_int|250
op_plus
id|ds1603-&gt;huge_delay
)paren
suffix:semicolon
)brace
DECL|function|rtc_write_databit
r_static
r_void
id|rtc_write_databit
c_func
(paren
r_int
r_int
id|bit
)paren
(brace
r_int
r_int
id|data
op_assign
id|rtc_reg_read
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ds1603-&gt;data_reversed
)paren
id|bit
op_assign
op_logical_neg
id|bit
suffix:semicolon
r_if
c_cond
(paren
id|bit
)paren
id|data
op_or_assign
id|ds1603-&gt;data
suffix:semicolon
r_else
id|data
op_and_assign
op_complement
id|ds1603-&gt;data
suffix:semicolon
id|rtc_reg_write
c_func
(paren
id|data
)paren
suffix:semicolon
id|ndelay
c_func
(paren
l_int|50
op_plus
id|ds1603-&gt;huge_delay
)paren
suffix:semicolon
id|rtc_cycle_clock
c_func
(paren
id|data
)paren
suffix:semicolon
)brace
DECL|function|rtc_read_databit
r_static
r_int
r_int
id|rtc_read_databit
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|data
suffix:semicolon
id|data
op_assign
(paren
id|rtc_datareg_read
c_func
(paren
)paren
op_amp
(paren
l_int|1
op_lshift
id|ds1603-&gt;data_read_shift
)paren
)paren
op_rshift
id|ds1603-&gt;data_read_shift
suffix:semicolon
id|rtc_cycle_clock
c_func
(paren
id|rtc_reg_read
c_func
(paren
)paren
)paren
suffix:semicolon
r_return
id|data
suffix:semicolon
)brace
DECL|function|rtc_write_byte
r_static
r_void
id|rtc_write_byte
c_func
(paren
r_int
r_int
id|byte
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|7
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rtc_write_databit
c_func
(paren
id|byte
op_amp
l_int|1L
)paren
suffix:semicolon
id|byte
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|rtc_write_word
r_static
r_void
id|rtc_write_word
c_func
(paren
r_int
r_int
id|word
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|31
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rtc_write_databit
c_func
(paren
id|word
op_amp
l_int|1L
)paren
suffix:semicolon
id|word
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|rtc_read_word
r_static
r_int
r_int
id|rtc_read_word
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|word
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|shift
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|31
suffix:semicolon
id|i
op_increment
)paren
(brace
id|word
op_or_assign
id|rtc_read_databit
c_func
(paren
)paren
op_lshift
id|shift
suffix:semicolon
id|shift
op_increment
suffix:semicolon
)brace
r_return
id|word
suffix:semicolon
)brace
DECL|function|rtc_init_op
r_static
r_void
id|rtc_init_op
c_func
(paren
r_void
)paren
(brace
id|rtc_nrst_high
c_func
(paren
)paren
suffix:semicolon
id|rtc_reg_write
c_func
(paren
id|rtc_reg_read
c_func
(paren
)paren
op_amp
op_complement
id|ds1603-&gt;clk
)paren
suffix:semicolon
id|ndelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
)brace
DECL|function|rtc_end_op
r_static
r_void
id|rtc_end_op
c_func
(paren
r_void
)paren
(brace
id|rtc_nrst_low
c_func
(paren
)paren
suffix:semicolon
id|ndelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
)brace
multiline_comment|/* interface */
DECL|function|ds1603_read
r_int
r_int
id|ds1603_read
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|word
suffix:semicolon
id|rtc_init_op
c_func
(paren
)paren
suffix:semicolon
id|rtc_write_byte
c_func
(paren
id|READ_TIME_CMD
)paren
suffix:semicolon
id|word
op_assign
id|rtc_read_word
c_func
(paren
)paren
suffix:semicolon
id|rtc_end_op
c_func
(paren
)paren
suffix:semicolon
r_return
id|word
suffix:semicolon
)brace
DECL|function|ds1603_set
r_int
id|ds1603_set
c_func
(paren
r_int
r_int
id|time
)paren
(brace
id|rtc_init_op
c_func
(paren
)paren
suffix:semicolon
id|rtc_write_byte
c_func
(paren
id|SET_TIME_CMD
)paren
suffix:semicolon
id|rtc_write_word
c_func
(paren
id|time
)paren
suffix:semicolon
id|rtc_end_op
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ds1603_set_trimmer
r_void
id|ds1603_set_trimmer
c_func
(paren
r_int
r_int
id|trimval
)paren
(brace
id|rtc_init_op
c_func
(paren
)paren
suffix:semicolon
id|rtc_write_byte
c_func
(paren
(paren
(paren
id|trimval
op_lshift
id|TRIMMER_SHIFT
)paren
op_amp
id|TRIMMER_VALUE_MASK
)paren
op_or
(paren
id|TRIMMER_SET_CMD
)paren
)paren
suffix:semicolon
id|rtc_end_op
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|ds1603_disable
r_void
id|ds1603_disable
c_func
(paren
r_void
)paren
(brace
id|ds1603_set_trimmer
c_func
(paren
id|TRIMMER_DISABLE_RTC
)paren
suffix:semicolon
)brace
DECL|function|ds1603_enable
r_void
id|ds1603_enable
c_func
(paren
r_void
)paren
(brace
id|ds1603_set_trimmer
c_func
(paren
id|TRIMMER_DEFAULT
)paren
suffix:semicolon
)brace
eof
