multiline_comment|/*&n; * arch/ppc/kernel/pci_auto.c&n; * &n; * PCI autoconfiguration library&n; *&n; * Author: Matt Porter &lt;mporter@mvista.com&gt;&n; *&n; * Copyright 2000, 2001 MontaVista Software Inc.&n; *&n; * This program is free software; you can redistribute  it and/or modify it&n; * under  the terms of  the GNU General  Public License as published by the&n; * Free Software Foundation;  either version 2 of the  License, or (at your&n; * option) any later version.&n; */
multiline_comment|/*&n; * Modified for MIPS by Jun Sun, jsun@mvista.com&n; *&n; * . Simplify the interface between pci_auto and the rest: a single function.&n; * . Assign resources from low address to upper address.&n; * . change most int to u32.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/ddb5xxx/pci.h&gt;
macro_line|#include &lt;asm/ddb5xxx/debug.h&gt;
DECL|macro|DEBUG
mdefine_line|#define&t;DEBUG
macro_line|#ifdef &t;DEBUG
DECL|macro|DBG
mdefine_line|#define&t;DBG(x...)&t;printk(x)
macro_line|#else
DECL|macro|DBG
mdefine_line|#define&t;DBG(x...)&t;
macro_line|#endif
multiline_comment|/* These are used for config access before all the PCI probing&n;   has been done. */
r_int
id|early_read_config_byte
c_func
(paren
r_struct
id|pci_channel
op_star
id|hose
comma
r_int
id|bus
comma
r_int
id|dev_fn
comma
r_int
id|where
comma
id|u8
op_star
id|val
)paren
suffix:semicolon
r_int
id|early_read_config_word
c_func
(paren
r_struct
id|pci_channel
op_star
id|hose
comma
r_int
id|bus
comma
r_int
id|dev_fn
comma
r_int
id|where
comma
id|u16
op_star
id|val
)paren
suffix:semicolon
r_int
id|early_read_config_dword
c_func
(paren
r_struct
id|pci_channel
op_star
id|hose
comma
r_int
id|bus
comma
r_int
id|dev_fn
comma
r_int
id|where
comma
id|u32
op_star
id|val
)paren
suffix:semicolon
r_int
id|early_write_config_byte
c_func
(paren
r_struct
id|pci_channel
op_star
id|hose
comma
r_int
id|bus
comma
r_int
id|dev_fn
comma
r_int
id|where
comma
id|u8
id|val
)paren
suffix:semicolon
r_int
id|early_write_config_word
c_func
(paren
r_struct
id|pci_channel
op_star
id|hose
comma
r_int
id|bus
comma
r_int
id|dev_fn
comma
r_int
id|where
comma
id|u16
id|val
)paren
suffix:semicolon
r_int
id|early_write_config_dword
c_func
(paren
r_struct
id|pci_channel
op_star
id|hose
comma
r_int
id|bus
comma
r_int
id|dev_fn
comma
r_int
id|where
comma
id|u32
id|val
)paren
suffix:semicolon
DECL|variable|pciauto_lower_iospc
r_static
id|u32
id|pciauto_lower_iospc
suffix:semicolon
DECL|variable|pciauto_upper_iospc
r_static
id|u32
id|pciauto_upper_iospc
suffix:semicolon
DECL|variable|pciauto_lower_memspc
r_static
id|u32
id|pciauto_lower_memspc
suffix:semicolon
DECL|variable|pciauto_upper_memspc
r_static
id|u32
id|pciauto_upper_memspc
suffix:semicolon
r_void
id|__init
DECL|function|pciauto_setup_bars
id|pciauto_setup_bars
c_func
(paren
r_struct
id|pci_channel
op_star
id|hose
comma
r_int
id|current_bus
comma
r_int
id|pci_devfn
)paren
(brace
id|u32
id|bar_response
comma
id|bar_size
comma
id|bar_value
suffix:semicolon
id|u32
id|bar
comma
id|addr_mask
comma
id|bar_nr
op_assign
l_int|0
suffix:semicolon
id|u32
op_star
id|upper_limit
suffix:semicolon
id|u32
op_star
id|lower_limit
suffix:semicolon
r_int
id|found_mem64
op_assign
l_int|0
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;PCI Autoconfig: Found Bus %d, Device %d, Function %d&bslash;n&quot;
comma
id|current_bus
comma
id|PCI_SLOT
c_func
(paren
id|pci_devfn
)paren
comma
id|PCI_FUNC
c_func
(paren
id|pci_devfn
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|bar
op_assign
id|PCI_BASE_ADDRESS_0
suffix:semicolon
id|bar
op_le
id|PCI_BASE_ADDRESS_5
suffix:semicolon
id|bar
op_add_assign
l_int|4
)paren
(brace
multiline_comment|/* Tickle the BAR and get the response */
id|early_write_config_dword
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|bar
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|early_read_config_dword
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|bar
comma
op_amp
id|bar_response
)paren
suffix:semicolon
multiline_comment|/* If BAR is not implemented go to the next BAR */
r_if
c_cond
(paren
op_logical_neg
id|bar_response
)paren
r_continue
suffix:semicolon
multiline_comment|/* Check the BAR type and set our address mask */
r_if
c_cond
(paren
id|bar_response
op_amp
id|PCI_BASE_ADDRESS_SPACE
)paren
(brace
id|addr_mask
op_assign
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
id|upper_limit
op_assign
op_amp
id|pciauto_upper_iospc
suffix:semicolon
id|lower_limit
op_assign
op_amp
id|pciauto_lower_iospc
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;PCI Autoconfig: BAR %d, I/O, &quot;
comma
id|bar_nr
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|bar_response
op_amp
id|PCI_BASE_ADDRESS_MEM_TYPE_MASK
)paren
op_eq
id|PCI_BASE_ADDRESS_MEM_TYPE_64
)paren
id|found_mem64
op_assign
l_int|1
suffix:semicolon
id|addr_mask
op_assign
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
id|upper_limit
op_assign
op_amp
id|pciauto_upper_memspc
suffix:semicolon
id|lower_limit
op_assign
op_amp
id|pciauto_lower_memspc
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;PCI Autoconfig: BAR %d, Mem, &quot;
comma
id|bar_nr
)paren
suffix:semicolon
)brace
multiline_comment|/* Calculate requested size */
id|bar_size
op_assign
op_complement
(paren
id|bar_response
op_amp
id|addr_mask
)paren
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* Allocate a base address */
id|bar_value
op_assign
(paren
(paren
op_star
id|lower_limit
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|bar_size
op_minus
l_int|1
)paren
)paren
op_plus
id|bar_size
suffix:semicolon
id|MIPS_ASSERT
c_func
(paren
id|bar_value
op_plus
id|bar_size
op_le
op_star
id|upper_limit
)paren
suffix:semicolon
multiline_comment|/* Write it out and update our limit */
id|early_write_config_dword
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|bar
comma
id|bar_value
)paren
suffix:semicolon
op_star
id|lower_limit
op_assign
id|bar_value
op_plus
id|bar_size
suffix:semicolon
multiline_comment|/*&n;&t;&t; * If we are a 64-bit decoder then increment to the&n;&t;&t; * upper 32 bits of the bar and force it to locate&n;&t;&t; * in the lower 4GB of memory.&n;&t;&t; */
r_if
c_cond
(paren
id|found_mem64
)paren
(brace
id|bar
op_add_assign
l_int|4
suffix:semicolon
id|early_write_config_dword
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|bar
comma
l_int|0x00000000
)paren
suffix:semicolon
)brace
id|bar_nr
op_increment
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;size=0x%x, address=0x%x&bslash;n&quot;
comma
id|bar_size
comma
id|bar_value
)paren
suffix:semicolon
)brace
)brace
r_void
id|__init
DECL|function|pciauto_prescan_setup_bridge
id|pciauto_prescan_setup_bridge
c_func
(paren
r_struct
id|pci_channel
op_star
id|hose
comma
r_int
id|current_bus
comma
r_int
id|pci_devfn
comma
r_int
id|sub_bus
)paren
(brace
r_int
id|cmdstat
suffix:semicolon
multiline_comment|/* Configure bus number registers */
id|early_write_config_byte
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|PCI_PRIMARY_BUS
comma
id|current_bus
)paren
suffix:semicolon
id|early_write_config_byte
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|PCI_SECONDARY_BUS
comma
id|sub_bus
op_plus
l_int|1
)paren
suffix:semicolon
id|early_write_config_byte
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|PCI_SUBORDINATE_BUS
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Round memory allocator to 1MB boundary */
id|pciauto_upper_memspc
op_and_assign
op_complement
(paren
l_int|0x100000
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Round I/O allocator to 4KB boundary */
id|pciauto_upper_iospc
op_and_assign
op_complement
(paren
l_int|0x1000
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Set up memory and I/O filter limits, assume 32-bit I/O space */
id|early_write_config_word
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|PCI_MEMORY_LIMIT
comma
(paren
(paren
id|pciauto_upper_memspc
op_minus
l_int|1
)paren
op_amp
l_int|0xfff00000
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|early_write_config_byte
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|PCI_IO_LIMIT
comma
(paren
(paren
id|pciauto_upper_iospc
op_minus
l_int|1
)paren
op_amp
l_int|0x0000f000
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|early_write_config_word
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|PCI_IO_LIMIT_UPPER16
comma
(paren
(paren
id|pciauto_upper_iospc
op_minus
l_int|1
)paren
op_amp
l_int|0xffff0000
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t support prefetchable memory for now, so disable */
id|early_write_config_word
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|PCI_PREF_MEMORY_BASE
comma
l_int|0x1000
)paren
suffix:semicolon
id|early_write_config_word
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|PCI_PREF_MEMORY_LIMIT
comma
l_int|0x1000
)paren
suffix:semicolon
multiline_comment|/* Enable memory and I/O accesses, enable bus master */
id|early_read_config_dword
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|PCI_COMMAND
comma
op_amp
id|cmdstat
)paren
suffix:semicolon
id|early_write_config_dword
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|PCI_COMMAND
comma
id|cmdstat
op_or
id|PCI_COMMAND_IO
op_or
id|PCI_COMMAND_MEMORY
op_or
id|PCI_COMMAND_MASTER
)paren
suffix:semicolon
)brace
r_void
id|__init
DECL|function|pciauto_postscan_setup_bridge
id|pciauto_postscan_setup_bridge
c_func
(paren
r_struct
id|pci_channel
op_star
id|hose
comma
r_int
id|current_bus
comma
r_int
id|pci_devfn
comma
r_int
id|sub_bus
)paren
(brace
multiline_comment|/* Configure bus number registers */
id|early_write_config_byte
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|PCI_SUBORDINATE_BUS
comma
id|sub_bus
)paren
suffix:semicolon
multiline_comment|/* Round memory allocator to 1MB boundary */
id|pciauto_upper_memspc
op_and_assign
op_complement
(paren
l_int|0x100000
op_minus
l_int|1
)paren
suffix:semicolon
id|early_write_config_word
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|PCI_MEMORY_BASE
comma
id|pciauto_upper_memspc
op_rshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* Round I/O allocator to 4KB boundary */
id|pciauto_upper_iospc
op_and_assign
op_complement
(paren
l_int|0x1000
op_minus
l_int|1
)paren
suffix:semicolon
id|early_write_config_byte
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|PCI_IO_BASE
comma
(paren
id|pciauto_upper_iospc
op_amp
l_int|0x0000f000
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|early_write_config_word
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|PCI_IO_BASE_UPPER16
comma
id|pciauto_upper_iospc
op_rshift
l_int|16
)paren
suffix:semicolon
)brace
DECL|macro|PCIAUTO_IDE_MODE_MASK
mdefine_line|#define      PCIAUTO_IDE_MODE_MASK           0x05
r_int
id|__init
DECL|function|pciauto_bus_scan
id|pciauto_bus_scan
c_func
(paren
r_struct
id|pci_channel
op_star
id|hose
comma
r_int
id|current_bus
)paren
(brace
r_int
id|sub_bus
suffix:semicolon
id|u32
id|pci_devfn
comma
id|pci_class
comma
id|cmdstat
comma
id|found_multi
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|vid
suffix:semicolon
r_int
r_char
id|header_type
suffix:semicolon
id|sub_bus
op_assign
id|current_bus
suffix:semicolon
r_for
c_loop
(paren
id|pci_devfn
op_assign
l_int|0
suffix:semicolon
id|pci_devfn
OL
l_int|0xff
suffix:semicolon
id|pci_devfn
op_increment
)paren
(brace
r_if
c_cond
(paren
id|PCI_FUNC
c_func
(paren
id|pci_devfn
)paren
op_logical_and
op_logical_neg
id|found_multi
)paren
r_continue
suffix:semicolon
id|early_read_config_byte
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|PCI_HEADER_TYPE
comma
op_amp
id|header_type
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|PCI_FUNC
c_func
(paren
id|pci_devfn
)paren
)paren
id|found_multi
op_assign
id|header_type
op_amp
l_int|0x80
suffix:semicolon
id|early_read_config_word
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|PCI_VENDOR_ID
comma
op_amp
id|vid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vid
op_eq
l_int|0xffff
)paren
r_continue
suffix:semicolon
id|early_read_config_dword
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|PCI_CLASS_REVISION
comma
op_amp
id|pci_class
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pci_class
op_rshift
l_int|16
)paren
op_eq
id|PCI_CLASS_BRIDGE_PCI
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;PCI Autoconfig: Found P2P bridge, device %d&bslash;n&quot;
comma
id|PCI_SLOT
c_func
(paren
id|pci_devfn
)paren
)paren
suffix:semicolon
id|pciauto_prescan_setup_bridge
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|sub_bus
)paren
suffix:semicolon
id|sub_bus
op_assign
id|pciauto_bus_scan
c_func
(paren
id|hose
comma
id|sub_bus
op_plus
l_int|1
)paren
suffix:semicolon
id|pciauto_postscan_setup_bridge
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|sub_bus
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|pci_class
op_rshift
l_int|16
)paren
op_eq
id|PCI_CLASS_STORAGE_IDE
)paren
(brace
r_int
r_char
id|prg_iface
suffix:semicolon
id|early_read_config_byte
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|PCI_CLASS_PROG
comma
op_amp
id|prg_iface
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|prg_iface
op_amp
id|PCIAUTO_IDE_MODE_MASK
)paren
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;PCI Autoconfig: Skipping legacy mode IDE controller&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t; * Found a peripheral, enable some standard&n;&t;&t; * settings&n;&t;&t; */
id|early_read_config_dword
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|PCI_COMMAND
comma
op_amp
id|cmdstat
)paren
suffix:semicolon
id|early_write_config_dword
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|PCI_COMMAND
comma
id|cmdstat
op_or
id|PCI_COMMAND_IO
op_or
id|PCI_COMMAND_MEMORY
op_or
id|PCI_COMMAND_MASTER
)paren
suffix:semicolon
id|early_write_config_byte
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
comma
id|PCI_LATENCY_TIMER
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* Allocate PCI I/O and/or memory space */
id|pciauto_setup_bars
c_func
(paren
id|hose
comma
id|current_bus
comma
id|pci_devfn
)paren
suffix:semicolon
)brace
r_return
id|sub_bus
suffix:semicolon
)brace
r_int
id|__init
DECL|function|pciauto_assign_resources
id|pciauto_assign_resources
c_func
(paren
r_int
id|busno
comma
r_struct
id|pci_channel
op_star
id|hose
)paren
(brace
multiline_comment|/* setup resource limits */
id|pciauto_lower_iospc
op_assign
id|hose-&gt;io_resource-&gt;start
suffix:semicolon
id|pciauto_upper_iospc
op_assign
id|hose-&gt;io_resource-&gt;end
op_plus
l_int|1
suffix:semicolon
id|pciauto_lower_memspc
op_assign
id|hose-&gt;mem_resource-&gt;start
suffix:semicolon
id|pciauto_upper_memspc
op_assign
id|hose-&gt;mem_resource-&gt;end
op_plus
l_int|1
suffix:semicolon
r_return
id|pciauto_bus_scan
c_func
(paren
id|hose
comma
id|busno
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * These functions are used early on before PCI scanning is done&n; * and all of the pci_dev and pci_bus structures have been created.&n; */
r_static
r_struct
id|pci_dev
op_star
DECL|function|fake_pci_dev
id|fake_pci_dev
c_func
(paren
r_struct
id|pci_channel
op_star
id|hose
comma
r_int
id|busnr
comma
r_int
id|devfn
)paren
(brace
r_static
r_struct
id|pci_dev
id|dev
suffix:semicolon
r_static
r_struct
id|pci_bus
id|bus
suffix:semicolon
id|dev.bus
op_assign
op_amp
id|bus
suffix:semicolon
id|dev.sysdata
op_assign
id|hose
suffix:semicolon
id|dev.devfn
op_assign
id|devfn
suffix:semicolon
id|bus.number
op_assign
id|busnr
suffix:semicolon
id|bus.ops
op_assign
id|hose-&gt;pci_ops
suffix:semicolon
r_return
op_amp
id|dev
suffix:semicolon
)brace
DECL|macro|EARLY_PCI_OP
mdefine_line|#define EARLY_PCI_OP(rw, size, type)                                    &bslash;&n;int early_##rw##_config_##size(struct pci_channel *hose, int bus,    &bslash;&n;                               int devfn, int offset, type value)       &bslash;&n;{                                                                       &bslash;&n;        return pci_##rw##_config_##size(fake_pci_dev(hose, bus, devfn), &bslash;&n;                                        offset, value);                 &bslash;&n;}
id|EARLY_PCI_OP
c_func
(paren
id|read
comma
id|byte
comma
id|u8
op_star
)paren
id|EARLY_PCI_OP
c_func
(paren
id|read
comma
id|word
comma
id|u16
op_star
)paren
id|EARLY_PCI_OP
c_func
(paren
id|read
comma
id|dword
comma
id|u32
op_star
)paren
id|EARLY_PCI_OP
c_func
(paren
id|write
comma
id|byte
comma
id|u8
)paren
id|EARLY_PCI_OP
c_func
(paren
id|write
comma
id|word
comma
id|u16
)paren
id|EARLY_PCI_OP
c_func
(paren
id|write
comma
id|dword
comma
id|u32
)paren
eof
