multiline_comment|/*&n; * Copyright 2001 MontaVista Software Inc.&n; * Author: jsun@mvista.com or jsun@junsun.net&n; *&n; * arch/mips/ddb5xxx/common/rtc_ds1386.c&n; *     low-level RTC hookups for s for Dallas 1396 chip.&n; *&n; * This program is free software; you can redistribute  it and/or modify it&n; * under  the terms of  the GNU General  Public License as published by the&n; * Free Software Foundation;  either version 2 of the  License, or (at your&n; * option) any later version.&n; */
multiline_comment|/*&n; * This file exports a function, rtc_ds1386_init(), which expects an&n; * uncached base address as the argument.  It will set the two function&n; * pointers expected by the MIPS generic timer code.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;asm/time.h&gt;
macro_line|#include &lt;asm/addrspace.h&gt;
macro_line|#include &lt;asm/ddb5xxx/debug.h&gt;
DECL|macro|EPOCH
mdefine_line|#define&t;EPOCH&t;&t;2000
DECL|macro|BCD_TO_BIN
macro_line|#undef BCD_TO_BIN
DECL|macro|BCD_TO_BIN
mdefine_line|#define BCD_TO_BIN(val) (((val)&amp;15) + ((val)&gt;&gt;4)*10)
DECL|macro|BIN_TO_BCD
macro_line|#undef BIN_TO_BCD
DECL|macro|BIN_TO_BCD
mdefine_line|#define BIN_TO_BCD(val) ((((val)/10)&lt;&lt;4) + (val)%10)
DECL|macro|READ_RTC
mdefine_line|#define&t;READ_RTC(x)&t;*(volatile unsigned char*)(rtc_base+x)
DECL|macro|WRITE_RTC
mdefine_line|#define&t;WRITE_RTC(x, y)&t;*(volatile unsigned char*)(rtc_base+x) = y
DECL|variable|rtc_base
r_static
r_int
r_int
id|rtc_base
suffix:semicolon
r_static
r_int
r_int
DECL|function|rtc_ds1386_get_time
id|rtc_ds1386_get_time
c_func
(paren
r_void
)paren
(brace
id|u8
id|byte
suffix:semicolon
id|u8
id|temp
suffix:semicolon
r_int
r_int
id|year
comma
id|month
comma
id|day
comma
id|hour
comma
id|minute
comma
id|second
suffix:semicolon
multiline_comment|/* let us freeze external registers */
id|byte
op_assign
id|READ_RTC
c_func
(paren
l_int|0xB
)paren
suffix:semicolon
id|byte
op_and_assign
l_int|0x3f
suffix:semicolon
id|WRITE_RTC
c_func
(paren
l_int|0xB
comma
id|byte
)paren
suffix:semicolon
multiline_comment|/* read time data */
id|year
op_assign
id|BCD_TO_BIN
c_func
(paren
id|READ_RTC
c_func
(paren
l_int|0xA
)paren
)paren
op_plus
id|EPOCH
suffix:semicolon
id|month
op_assign
id|BCD_TO_BIN
c_func
(paren
id|READ_RTC
c_func
(paren
l_int|0x9
)paren
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|day
op_assign
id|BCD_TO_BIN
c_func
(paren
id|READ_RTC
c_func
(paren
l_int|0x8
)paren
)paren
suffix:semicolon
id|minute
op_assign
id|BCD_TO_BIN
c_func
(paren
id|READ_RTC
c_func
(paren
l_int|0x2
)paren
)paren
suffix:semicolon
id|second
op_assign
id|BCD_TO_BIN
c_func
(paren
id|READ_RTC
c_func
(paren
l_int|0x1
)paren
)paren
suffix:semicolon
multiline_comment|/* hour is special - deal with it later */
id|temp
op_assign
id|READ_RTC
c_func
(paren
l_int|0x4
)paren
suffix:semicolon
multiline_comment|/* enable time transfer */
id|byte
op_or_assign
l_int|0x80
suffix:semicolon
id|WRITE_RTC
c_func
(paren
l_int|0xB
comma
id|byte
)paren
suffix:semicolon
multiline_comment|/* calc hour */
r_if
c_cond
(paren
id|temp
op_amp
l_int|0x40
)paren
(brace
multiline_comment|/* 12 hour format */
id|hour
op_assign
id|BCD_TO_BIN
c_func
(paren
id|temp
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
l_int|0x20
)paren
id|hour
op_add_assign
l_int|12
suffix:semicolon
multiline_comment|/* PM */
)brace
r_else
(brace
multiline_comment|/* 24 hour format */
id|hour
op_assign
id|BCD_TO_BIN
c_func
(paren
id|temp
op_amp
l_int|0x3f
)paren
suffix:semicolon
)brace
r_return
id|mktime
c_func
(paren
id|year
comma
id|month
comma
id|day
comma
id|hour
comma
id|minute
comma
id|second
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|rtc_ds1386_set_time
id|rtc_ds1386_set_time
c_func
(paren
r_int
r_int
id|t
)paren
(brace
r_struct
id|rtc_time
id|tm
suffix:semicolon
id|u8
id|byte
suffix:semicolon
id|u8
id|temp
suffix:semicolon
id|u8
id|year
comma
id|month
comma
id|day
comma
id|hour
comma
id|minute
comma
id|second
suffix:semicolon
multiline_comment|/* let us freeze external registers */
id|byte
op_assign
id|READ_RTC
c_func
(paren
l_int|0xB
)paren
suffix:semicolon
id|byte
op_and_assign
l_int|0x3f
suffix:semicolon
id|WRITE_RTC
c_func
(paren
l_int|0xB
comma
id|byte
)paren
suffix:semicolon
multiline_comment|/* convert */
id|to_tm
c_func
(paren
id|t
comma
op_amp
id|tm
)paren
suffix:semicolon
multiline_comment|/* check each field one by one */
id|year
op_assign
id|BIN_TO_BCD
c_func
(paren
id|tm.tm_year
op_minus
id|EPOCH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|year
op_ne
id|READ_RTC
c_func
(paren
l_int|0xA
)paren
)paren
(brace
id|WRITE_RTC
c_func
(paren
l_int|0xA
comma
id|year
)paren
suffix:semicolon
)brace
id|temp
op_assign
id|READ_RTC
c_func
(paren
l_int|0x9
)paren
suffix:semicolon
id|month
op_assign
id|BIN_TO_BCD
c_func
(paren
id|tm.tm_mon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|month
op_ne
(paren
id|temp
op_amp
l_int|0x1f
)paren
)paren
(brace
id|WRITE_RTC
c_func
(paren
l_int|0x9
comma
(paren
id|month
op_amp
l_int|0x1f
)paren
op_or
(paren
id|temp
op_amp
op_complement
l_int|0x1f
)paren
)paren
suffix:semicolon
)brace
id|day
op_assign
id|BIN_TO_BCD
c_func
(paren
id|tm.tm_mday
)paren
suffix:semicolon
r_if
c_cond
(paren
id|day
op_ne
id|READ_RTC
c_func
(paren
l_int|0x8
)paren
)paren
(brace
id|WRITE_RTC
c_func
(paren
l_int|0x8
comma
id|day
)paren
suffix:semicolon
)brace
id|temp
op_assign
id|READ_RTC
c_func
(paren
l_int|0x4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
l_int|0x40
)paren
(brace
multiline_comment|/* 12 hour format */
id|hour
op_assign
l_int|0x40
suffix:semicolon
r_if
c_cond
(paren
id|tm.tm_hour
OG
l_int|12
)paren
(brace
id|hour
op_or_assign
l_int|0x20
op_or
(paren
id|BIN_TO_BCD
c_func
(paren
id|hour
op_minus
l_int|12
)paren
op_amp
l_int|0x1f
)paren
suffix:semicolon
)brace
r_else
(brace
id|hour
op_or_assign
id|BIN_TO_BCD
c_func
(paren
id|tm.tm_hour
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* 24 hour format */
id|hour
op_assign
id|BIN_TO_BCD
c_func
(paren
id|tm.tm_hour
)paren
op_amp
l_int|0x3f
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hour
op_ne
id|temp
)paren
id|WRITE_RTC
c_func
(paren
l_int|0x4
comma
id|hour
)paren
suffix:semicolon
id|minute
op_assign
id|BIN_TO_BCD
c_func
(paren
id|tm.tm_min
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minute
op_ne
id|READ_RTC
c_func
(paren
l_int|0x2
)paren
)paren
(brace
id|WRITE_RTC
c_func
(paren
l_int|0x2
comma
id|minute
)paren
suffix:semicolon
)brace
id|second
op_assign
id|BIN_TO_BCD
c_func
(paren
id|tm.tm_sec
)paren
suffix:semicolon
r_if
c_cond
(paren
id|second
op_ne
id|READ_RTC
c_func
(paren
l_int|0x1
)paren
)paren
(brace
id|WRITE_RTC
c_func
(paren
l_int|0x1
comma
id|second
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|rtc_ds1386_init
id|rtc_ds1386_init
c_func
(paren
r_int
r_int
id|base
)paren
(brace
r_int
r_char
id|byte
suffix:semicolon
multiline_comment|/* remember the base */
id|rtc_base
op_assign
id|base
suffix:semicolon
id|MIPS_ASSERT
c_func
(paren
(paren
id|rtc_base
op_amp
l_int|0xe0000000
)paren
op_eq
id|KSEG1
)paren
suffix:semicolon
multiline_comment|/* turn on RTC if it is not on */
id|byte
op_assign
id|READ_RTC
c_func
(paren
l_int|0x9
)paren
suffix:semicolon
r_if
c_cond
(paren
id|byte
op_amp
l_int|0x80
)paren
(brace
id|byte
op_and_assign
l_int|0x7f
suffix:semicolon
id|WRITE_RTC
c_func
(paren
l_int|0x9
comma
id|byte
)paren
suffix:semicolon
)brace
multiline_comment|/* enable time transfer */
id|byte
op_assign
id|READ_RTC
c_func
(paren
l_int|0xB
)paren
suffix:semicolon
id|byte
op_or_assign
l_int|0x80
suffix:semicolon
id|WRITE_RTC
c_func
(paren
l_int|0xB
comma
id|byte
)paren
suffix:semicolon
multiline_comment|/* set the function pointers */
id|rtc_get_time
op_assign
id|rtc_ds1386_get_time
suffix:semicolon
id|rtc_set_time
op_assign
id|rtc_ds1386_set_time
suffix:semicolon
)brace
eof
