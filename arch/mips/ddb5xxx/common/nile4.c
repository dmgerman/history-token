multiline_comment|/***********************************************************************&n; *&n; * Copyright 2001 MontaVista Software Inc.&n; * Author: jsun@mvista.com or jsun@junsun.net&n; *&n; * arch/mips/ddb5xxx/common/nile4.c&n; *     misc low-level routines for vrc-5xxx controllers.&n; *&n; * derived from original code by Geert Uytterhoeven &lt;geert@sonycom.com&gt;&n; *&n; * This program is free software; you can redistribute  it and/or modify it&n; * under  the terms of  the GNU General  Public License as published by the&n; * Free Software Foundation;  either version 2 of the  License, or (at your&n; * option) any later version.&n; *&n; ***********************************************************************&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/ddb5xxx/ddb5xxx.h&gt;
macro_line|#include &lt;asm/ddb5xxx/debug.h&gt;
id|u32
DECL|function|ddb_calc_pdar
id|ddb_calc_pdar
c_func
(paren
id|u32
id|phys
comma
id|u32
id|size
comma
r_int
id|width
comma
r_int
id|on_memory_bus
comma
r_int
id|pci_visible
)paren
(brace
id|u32
id|maskbits
suffix:semicolon
id|u32
id|widthbits
suffix:semicolon
r_switch
c_cond
(paren
id|size
)paren
(brace
macro_line|#if 0                           /* We don&squot;t support 4 GB yet */
r_case
l_int|0x100000000
suffix:colon
multiline_comment|/* 4 GB */
id|maskbits
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
l_int|0x80000000
suffix:colon
multiline_comment|/* 2 GB */
id|maskbits
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x40000000
suffix:colon
multiline_comment|/* 1 GB */
id|maskbits
op_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x20000000
suffix:colon
multiline_comment|/* 512 MB */
id|maskbits
op_assign
l_int|7
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x10000000
suffix:colon
multiline_comment|/* 256 MB */
id|maskbits
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x08000000
suffix:colon
multiline_comment|/* 128 MB */
id|maskbits
op_assign
l_int|9
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04000000
suffix:colon
multiline_comment|/* 64 MB */
id|maskbits
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02000000
suffix:colon
multiline_comment|/* 32 MB */
id|maskbits
op_assign
l_int|11
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01000000
suffix:colon
multiline_comment|/* 16 MB */
id|maskbits
op_assign
l_int|12
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x00800000
suffix:colon
multiline_comment|/* 8 MB */
id|maskbits
op_assign
l_int|13
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x00400000
suffix:colon
multiline_comment|/* 4 MB */
id|maskbits
op_assign
l_int|14
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x00200000
suffix:colon
multiline_comment|/* 2 MB */
id|maskbits
op_assign
l_int|15
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
multiline_comment|/* OFF */
id|maskbits
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|panic
c_func
(paren
l_string|&quot;nile4_set_pdar: unsupported size %p&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|size
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|width
)paren
(brace
r_case
l_int|8
suffix:colon
id|widthbits
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|widthbits
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|widthbits
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|64
suffix:colon
id|widthbits
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|panic
c_func
(paren
l_string|&quot;nile4_set_pdar: unsupported width %d&bslash;n&quot;
comma
id|width
)paren
suffix:semicolon
)brace
r_return
id|maskbits
op_or
(paren
id|on_memory_bus
ques
c_cond
l_int|0x10
suffix:colon
l_int|0
)paren
op_or
(paren
id|pci_visible
ques
c_cond
l_int|0x20
suffix:colon
l_int|0
)paren
op_or
(paren
id|widthbits
op_lshift
l_int|6
)paren
op_or
(paren
id|phys
op_amp
l_int|0xffe00000
)paren
suffix:semicolon
)brace
r_void
DECL|function|ddb_set_pdar
id|ddb_set_pdar
c_func
(paren
id|u32
id|pdar
comma
id|u32
id|phys
comma
id|u32
id|size
comma
r_int
id|width
comma
r_int
id|on_memory_bus
comma
r_int
id|pci_visible
)paren
(brace
id|u32
id|temp
op_assign
id|ddb_calc_pdar
c_func
(paren
id|phys
comma
id|size
comma
id|width
comma
id|on_memory_bus
comma
id|pci_visible
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|pdar
comma
id|temp
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|pdar
op_plus
l_int|4
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;         * When programming a PDAR, the register should be read immediately&n;         * after writing it. This ensures that address decoders are properly&n;         * configured.&n;&t; * [jsun] is this really necessary?&n;         */
id|ddb_in32
c_func
(paren
id|pdar
)paren
suffix:semicolon
id|ddb_in32
c_func
(paren
id|pdar
op_plus
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * routines that mess with PCIINITx registers&n; */
DECL|function|ddb_set_pmr
r_void
id|ddb_set_pmr
c_func
(paren
id|u32
id|pmr
comma
id|u32
id|type
comma
id|u32
id|addr
comma
id|u32
id|options
)paren
(brace
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|DDB_PCICMD_IACK
suffix:colon
multiline_comment|/* PCI Interrupt Acknowledge */
r_case
id|DDB_PCICMD_IO
suffix:colon
multiline_comment|/* PCI I/O Space */
r_case
id|DDB_PCICMD_MEM
suffix:colon
multiline_comment|/* PCI Memory Space */
r_case
id|DDB_PCICMD_CFG
suffix:colon
multiline_comment|/* PCI Configuration Space */
r_break
suffix:semicolon
r_default
suffix:colon
id|panic
c_func
(paren
l_string|&quot;nile4_set_pmr: invalid type %d&bslash;n&quot;
comma
id|type
)paren
suffix:semicolon
)brace
id|ddb_out32
c_func
(paren
id|pmr
comma
(paren
id|type
op_lshift
l_int|1
)paren
op_or
(paren
id|addr
op_amp
l_int|0xffe00000
)paren
op_or
id|options
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|pmr
op_plus
l_int|4
comma
l_int|0
)paren
suffix:semicolon
)brace
eof
