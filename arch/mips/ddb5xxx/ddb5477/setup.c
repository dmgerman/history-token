multiline_comment|/***********************************************************************&n; *&n; * Copyright 2001 MontaVista Software Inc.&n; * Author: jsun@mvista.com or jsun@junsun.net&n; *&n; * arch/mips/ddb5xxx/ddb5477/setup.c&n; *     Setup file for DDB5477.&n; *&n; * This program is free software; you can redistribute  it and/or modify it&n; * under  the terms of  the GNU General  Public License as published by the&n; * Free Software Foundation;  either version 2 of the  License, or (at your&n; * option) any later version.&n; *&n; ***********************************************************************&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/kdev_t.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/ide.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/param.h&gt;&t;/* for HZ */
macro_line|#include &lt;linux/root_dev.h&gt;
macro_line|#include &lt;asm/addrspace.h&gt;
macro_line|#include &lt;asm/time.h&gt;
macro_line|#include &lt;asm/bcache.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/reboot.h&gt;
macro_line|#include &lt;asm/gdb-stub.h&gt;
macro_line|#include &lt;asm/ddb5xxx/ddb5xxx.h&gt;
DECL|macro|USE_CPU_COUNTER_TIMER
mdefine_line|#define&t;USE_CPU_COUNTER_TIMER&t;/* whether we use cpu counter */
macro_line|#ifdef USE_CPU_COUNTER_TIMER
DECL|macro|CPU_COUNTER_FREQUENCY
mdefine_line|#define&t;CPU_COUNTER_FREQUENCY&t;&t;83000000
macro_line|#else
multiline_comment|/* otherwise we use special timer 1 */
DECL|macro|SP_TIMER_FREQUENCY
mdefine_line|#define&t;SP_TIMER_FREQUENCY&t;&t;83000000
DECL|macro|SP_TIMER_BASE
mdefine_line|#define&t;SP_TIMER_BASE&t;&t;&t;DDB_SPT1CTRL_L
DECL|macro|SP_TIMER_IRQ
mdefine_line|#define&t;SP_TIMER_IRQ&t;&t;&t;(8 + 6)
macro_line|#endif
DECL|function|ddb_machine_restart
r_static
r_void
id|ddb_machine_restart
c_func
(paren
r_char
op_star
id|command
)paren
(brace
r_static
r_void
(paren
op_star
id|back_to_prom
)paren
(paren
r_void
)paren
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_void
)paren
)paren
l_int|0xbfc00000
suffix:semicolon
id|u32
id|t
suffix:semicolon
multiline_comment|/* PCI cold reset */
id|ddb_pci_reset_bus
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* CPU cold reset */
id|t
op_assign
id|ddb_in32
c_func
(paren
id|DDB_CPUSTAT
)paren
suffix:semicolon
id|MIPS_ASSERT
c_func
(paren
(paren
id|t
op_amp
l_int|1
)paren
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_CPUSTAT
comma
id|t
)paren
suffix:semicolon
multiline_comment|/* Call the PROM */
id|back_to_prom
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|ddb_machine_halt
r_static
r_void
id|ddb_machine_halt
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DDB Vrc-5477 halted.&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|ddb_machine_power_off
r_static
r_void
id|ddb_machine_power_off
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DDB Vrc-5477 halted. Please turn off the power.&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_extern
r_void
id|rtc_ds1386_init
c_func
(paren
r_int
r_int
id|base
)paren
suffix:semicolon
DECL|function|ddb_time_init
r_static
r_void
id|__init
id|ddb_time_init
c_func
(paren
r_void
)paren
(brace
macro_line|#if defined(USE_CPU_COUNTER_TIMER)
id|mips_counter_frequency
op_assign
id|CPU_COUNTER_FREQUENCY
suffix:semicolon
macro_line|#endif
multiline_comment|/* we have ds1396 RTC chip */
id|rtc_ds1386_init
c_func
(paren
id|KSEG1ADDR
c_func
(paren
id|DDB_LCS1_BASE
)paren
)paren
suffix:semicolon
)brace
macro_line|#if defined(CONFIG_LL_DEBUG)
DECL|variable|board_init_done_flag
r_int
id|board_init_done_flag
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_extern
r_int
id|setup_irq
c_func
(paren
r_int
r_int
id|irq
comma
r_struct
id|irqaction
op_star
id|irqaction
)paren
suffix:semicolon
DECL|function|ddb_timer_setup
r_static
r_void
id|__init
id|ddb_timer_setup
c_func
(paren
r_struct
id|irqaction
op_star
id|irq
)paren
(brace
macro_line|#if defined(USE_CPU_COUNTER_TIMER)
r_int
r_int
id|count
suffix:semicolon
multiline_comment|/* we are using the cpu counter for timer interrupts */
id|setup_irq
c_func
(paren
l_int|7
comma
id|irq
)paren
suffix:semicolon
multiline_comment|/* to generate the first timer interrupt */
id|count
op_assign
id|read_32bit_cp0_register
c_func
(paren
id|CP0_COUNT
)paren
suffix:semicolon
id|write_32bit_cp0_register
c_func
(paren
id|CP0_COMPARE
comma
id|count
op_plus
l_int|1000
)paren
suffix:semicolon
macro_line|#else
multiline_comment|/* if we don&squot;t use Special purpose timer 1 */
id|ddb_out32
c_func
(paren
id|SP_TIMER_BASE
comma
id|SP_TIMER_FREQUENCY
op_div
id|HZ
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|SP_TIMER_BASE
op_plus
l_int|4
comma
l_int|0x1
)paren
suffix:semicolon
id|setup_irq
c_func
(paren
id|SP_TIMER_IRQ
comma
id|irq
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* this is the last board dependent code */
id|MIPS_DEBUG
c_func
(paren
id|board_init_done_flag
op_assign
l_int|1
)paren
suffix:semicolon
)brace
r_static
r_void
id|ddb5477_board_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|ddb5477_irq_setup
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_BLK_DEV_INITRD)
r_extern
r_int
r_int
id|__rd_start
comma
id|__rd_end
comma
id|initrd_start
comma
id|initrd_end
suffix:semicolon
macro_line|#endif 
DECL|function|ddb_setup
r_void
id|__init
id|ddb_setup
c_func
(paren
r_void
)paren
(brace
r_extern
r_int
id|panic_timeout
suffix:semicolon
id|irq_setup
op_assign
id|ddb5477_irq_setup
suffix:semicolon
id|mips_io_port_base
op_assign
id|KSEG1ADDR
c_func
(paren
id|DDB_PCI_IO_BASE
)paren
suffix:semicolon
id|board_time_init
op_assign
id|ddb_time_init
suffix:semicolon
id|board_timer_setup
op_assign
id|ddb_timer_setup
suffix:semicolon
id|_machine_restart
op_assign
id|ddb_machine_restart
suffix:semicolon
id|_machine_halt
op_assign
id|ddb_machine_halt
suffix:semicolon
id|_machine_power_off
op_assign
id|ddb_machine_power_off
suffix:semicolon
multiline_comment|/* setup resource limits */
id|ioport_resource.end
op_assign
id|DDB_PCI0_IO_SIZE
op_plus
id|DDB_PCI1_IO_SIZE
op_minus
l_int|1
suffix:semicolon
id|iomem_resource.end
op_assign
l_int|0xffffffff
suffix:semicolon
multiline_comment|/* Reboot on panic */
id|panic_timeout
op_assign
l_int|180
suffix:semicolon
multiline_comment|/* initialize board - we don&squot;t trust the loader */
id|ddb5477_board_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_BLK_DEV_INITRD)
id|ROOT_DEV
op_assign
id|Root_RAM0
suffix:semicolon
id|initrd_start
op_assign
(paren
r_int
r_int
)paren
op_amp
id|__rd_start
suffix:semicolon
id|initrd_end
op_assign
(paren
r_int
r_int
)paren
op_amp
id|__rd_end
suffix:semicolon
macro_line|#endif
)brace
DECL|function|ddb5477_board_init
r_static
r_void
id|__init
id|ddb5477_board_init
c_func
(paren
)paren
(brace
multiline_comment|/* ----------- setup PDARs ------------ */
multiline_comment|/* SDRAM should have been set */
id|MIPS_ASSERT
c_func
(paren
id|ddb_in32
c_func
(paren
id|DDB_SDRAM0
)paren
op_eq
id|ddb_calc_pdar
c_func
(paren
id|DDB_SDRAM_BASE
comma
id|DDB_SDRAM_SIZE
comma
l_int|32
comma
l_int|0
comma
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/* SDRAM1 should be turned off.  What is this for anyway ? */
id|MIPS_ASSERT
c_func
(paren
(paren
id|ddb_in32
c_func
(paren
id|DDB_SDRAM1
)paren
op_amp
l_int|0xf
)paren
op_eq
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set LDCSs */
multiline_comment|/* flash */
id|ddb_set_pdar
c_func
(paren
id|DDB_LCS0
comma
id|DDB_LCS0_BASE
comma
id|DDB_LCS0_SIZE
comma
l_int|16
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* misc */
id|ddb_set_pdar
c_func
(paren
id|DDB_LCS1
comma
id|DDB_LCS1_BASE
comma
id|DDB_LCS1_SIZE
comma
l_int|8
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* mezzanie (?) */
id|ddb_set_pdar
c_func
(paren
id|DDB_LCS2
comma
id|DDB_LCS2_BASE
comma
id|DDB_LCS2_SIZE
comma
l_int|16
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* verify VRC5477 base addr */
id|MIPS_ASSERT
c_func
(paren
id|ddb_in32
c_func
(paren
id|DDB_VRC5477
)paren
op_eq
id|ddb_calc_pdar
c_func
(paren
id|DDB_VRC5477_BASE
comma
id|DDB_VRC5477_SIZE
comma
l_int|32
comma
l_int|0
comma
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/* verify BOOT ROM addr */
id|MIPS_ASSERT
c_func
(paren
id|ddb_in32
c_func
(paren
id|DDB_BOOTCS
)paren
op_eq
id|ddb_calc_pdar
c_func
(paren
id|DDB_BOOTCS_BASE
comma
id|DDB_BOOTCS_SIZE
comma
l_int|8
comma
l_int|0
comma
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* setup PCI windows - window0 for MEM/config, window1 for IO */
id|ddb_set_pdar
c_func
(paren
id|DDB_PCIW0
comma
id|DDB_PCI0_MEM_BASE
comma
id|DDB_PCI0_MEM_SIZE
comma
l_int|32
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|ddb_set_pdar
c_func
(paren
id|DDB_PCIW1
comma
id|DDB_PCI0_IO_BASE
comma
id|DDB_PCI0_IO_SIZE
comma
l_int|32
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|ddb_set_pdar
c_func
(paren
id|DDB_IOPCIW0
comma
id|DDB_PCI1_MEM_BASE
comma
id|DDB_PCI1_MEM_SIZE
comma
l_int|32
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|ddb_set_pdar
c_func
(paren
id|DDB_IOPCIW1
comma
id|DDB_PCI1_IO_BASE
comma
id|DDB_PCI1_IO_SIZE
comma
l_int|32
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* ------------ reset PCI bus and BARs ----------------- */
id|ddb_pci_reset_bus
c_func
(paren
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BARM010
comma
l_int|0x00000008
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BARM011
comma
l_int|0x00000008
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BARC0
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BARM230
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BAR00
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BAR10
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BAR20
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BAR30
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BAR40
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BAR50
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BARB0
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BARC1
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BARM231
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BAR01
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BAR11
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BAR21
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BAR31
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BAR41
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BAR51
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BARB1
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * We use pci master register 0  for memory space / config space&n;&t; * And we use register 1 for IO space.&n;&t; * Note that for memory space, we bump up the pci base address&n;&t; * so that we have 1:1 mapping between PCI memory and cpu physical.&n;&t; * For PCI IO space, it starts from 0 in PCI IO space but with&n;&t; * DDB_xx_IO_BASE in CPU physical address space.&n;&t; */
id|ddb_set_pmr
c_func
(paren
id|DDB_PCIINIT00
comma
id|DDB_PCICMD_MEM
comma
id|DDB_PCI0_MEM_BASE
comma
id|DDB_PCI_ACCESS_32
)paren
suffix:semicolon
id|ddb_set_pmr
c_func
(paren
id|DDB_PCIINIT10
comma
id|DDB_PCICMD_IO
comma
l_int|0
comma
id|DDB_PCI_ACCESS_32
)paren
suffix:semicolon
id|ddb_set_pmr
c_func
(paren
id|DDB_PCIINIT01
comma
id|DDB_PCICMD_MEM
comma
id|DDB_PCI1_MEM_BASE
comma
id|DDB_PCI_ACCESS_32
)paren
suffix:semicolon
id|ddb_set_pmr
c_func
(paren
id|DDB_PCIINIT11
comma
id|DDB_PCICMD_IO
comma
id|DDB_PCI0_IO_SIZE
comma
id|DDB_PCI_ACCESS_32
)paren
suffix:semicolon
multiline_comment|/* PCI cross window should be set properly */
id|ddb_set_pdar
c_func
(paren
id|DDB_BARP00
comma
id|DDB_PCI1_MEM_BASE
comma
id|DDB_PCI1_MEM_SIZE
comma
l_int|32
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|ddb_set_pdar
c_func
(paren
id|DDB_BARP10
comma
id|DDB_PCI1_IO_BASE
comma
id|DDB_PCI1_IO_SIZE
comma
l_int|32
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|ddb_set_pdar
c_func
(paren
id|DDB_BARP01
comma
id|DDB_PCI0_MEM_BASE
comma
id|DDB_PCI0_MEM_SIZE
comma
l_int|32
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|ddb_set_pdar
c_func
(paren
id|DDB_BARP11
comma
id|DDB_PCI0_IO_BASE
comma
id|DDB_PCI0_IO_SIZE
comma
l_int|32
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* enable USB input buffers */
id|ddb_out32
c_func
(paren
id|DDB_PIBMISC
comma
l_int|0x00000007
)paren
suffix:semicolon
multiline_comment|/* For dual-function pins, make them all non-GPIO */
id|ddb_out32
c_func
(paren
id|DDB_GIUFUNSEL
comma
l_int|0x0
)paren
suffix:semicolon
singleline_comment|// ddb_out32(DDB_GIUFUNSEL, 0xfe0fcfff);  /* NEC recommanded value */
)brace
eof
