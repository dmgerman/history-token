macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/ddb5xxx/ddb5xxx.h&gt;
macro_line|#include &lt;asm/ddb5xxx/debug.h&gt;
macro_line|#include &lt;asm/ddb5xxx/pci.h&gt;
DECL|variable|extpci_io_resource
r_static
r_struct
id|resource
id|extpci_io_resource
op_assign
(brace
l_string|&quot;ext pci IO space&quot;
comma
id|DDB_PCI0_IO_BASE
op_minus
id|DDB_PCI_IO_BASE
comma
id|DDB_PCI0_IO_BASE
op_minus
id|DDB_PCI_IO_BASE
op_plus
id|DDB_PCI0_IO_SIZE
op_minus
l_int|1
comma
id|IORESOURCE_IO
)brace
suffix:semicolon
DECL|variable|extpci_mem_resource
r_static
r_struct
id|resource
id|extpci_mem_resource
op_assign
(brace
l_string|&quot;ext pci memory space&quot;
comma
id|DDB_PCI0_MEM_BASE
comma
id|DDB_PCI0_MEM_BASE
op_plus
id|DDB_PCI0_MEM_SIZE
op_minus
l_int|1
comma
id|IORESOURCE_MEM
)brace
suffix:semicolon
DECL|variable|iopci_io_resource
r_static
r_struct
id|resource
id|iopci_io_resource
op_assign
(brace
l_string|&quot;io pci IO space&quot;
comma
id|DDB_PCI1_IO_BASE
op_minus
id|DDB_PCI_IO_BASE
comma
id|DDB_PCI1_IO_BASE
op_minus
id|DDB_PCI_IO_BASE
op_plus
id|DDB_PCI1_IO_SIZE
op_minus
l_int|1
comma
id|IORESOURCE_IO
)brace
suffix:semicolon
DECL|variable|iopci_mem_resource
r_static
r_struct
id|resource
id|iopci_mem_resource
op_assign
(brace
l_string|&quot;ext pci memory space&quot;
comma
id|DDB_PCI1_MEM_BASE
comma
id|DDB_PCI1_MEM_BASE
op_plus
id|DDB_PCI1_MEM_SIZE
op_minus
l_int|1
comma
id|IORESOURCE_MEM
)brace
suffix:semicolon
r_extern
r_struct
id|pci_ops
id|ddb5477_ext_pci_ops
suffix:semicolon
r_extern
r_struct
id|pci_ops
id|ddb5477_io_pci_ops
suffix:semicolon
DECL|variable|mips_pci_channels
r_struct
id|pci_channel
id|mips_pci_channels
(braket
)braket
op_assign
(brace
(brace
op_amp
id|ddb5477_ext_pci_ops
comma
op_amp
id|extpci_io_resource
comma
op_amp
id|extpci_mem_resource
)brace
comma
(brace
op_amp
id|ddb5477_io_pci_ops
comma
op_amp
id|iopci_io_resource
comma
op_amp
id|iopci_mem_resource
)brace
comma
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; * we fix up irqs based on the slot number.&n; * The first entry is at AD:11.&n; * Fortunately this works because, although we have two pci buses,&n; * they all have different slot numbers.&n; * &n; * This does not work for devices on sub-buses.&n; *&n; * Note that the irq number in the array is relative number in vrc5477.&n; * We need to translate it to global irq number.&n; */
multiline_comment|/*&n; * irq mapping : PCI int # -&gt; vrc5477 irq #&n; * based on vrc5477 manual page 46&n; */
DECL|macro|PCI_EXT_INTA
mdefine_line|#define&t;&t;PCI_EXT_INTA&t;&t;8
DECL|macro|PCI_EXT_INTB
mdefine_line|#define&t;&t;PCI_EXT_INTB&t;&t;9
DECL|macro|PCI_EXT_INTC
mdefine_line|#define&t;&t;PCI_EXT_INTC&t;&t;10
DECL|macro|PCI_EXT_INTD
mdefine_line|#define&t;&t;PCI_EXT_INTD&t;&t;11
DECL|macro|PCI_EXT_INTE
mdefine_line|#define&t;&t;PCI_EXT_INTE&t;&t;12
DECL|macro|PCI_IO_INTA
mdefine_line|#define&t;&t;PCI_IO_INTA&t;&t;16
DECL|macro|PCI_IO_INTB
mdefine_line|#define&t;&t;PCI_IO_INTB&t;&t;17
DECL|macro|PCI_IO_INTC
mdefine_line|#define&t;&t;PCI_IO_INTC&t;&t;18
DECL|macro|PCI_IO_INTD
mdefine_line|#define&t;&t;PCI_IO_INTD&t;&t;19
multiline_comment|/* &n; * irq mapping : device -&gt; pci int #, &n; * ddb5477 board manual page 4  and vrc5477 manual page 46&n; */
DECL|macro|INT_ONBOARD_TULIP
mdefine_line|#define&t;&t;INT_ONBOARD_TULIP&t;PCI_EXT_INTA
DECL|macro|INT_SLOT1
mdefine_line|#define&t;&t;INT_SLOT1&t;&t;PCI_EXT_INTB
DECL|macro|INT_SLOT2
mdefine_line|#define&t;&t;INT_SLOT2&t;&t;PCI_EXT_INTC
DECL|macro|INT_SLOT3
mdefine_line|#define&t;&t;INT_SLOT3&t;&t;PCI_EXT_INTD
DECL|macro|INT_SLOT4
mdefine_line|#define&t;&t;INT_SLOT4&t;&t;PCI_EXT_INTE
DECL|macro|INT_USB_HOST
mdefine_line|#define&t;&t;INT_USB_HOST&t;&t;PCI_IO_INTA
DECL|macro|INT_USB_PERI
mdefine_line|#define&t;&t;INT_USB_PERI&t;&t;PCI_IO_INTB
DECL|macro|INT_AC97
mdefine_line|#define&t;&t;INT_AC97&t;&t;PCI_IO_INTC
multiline_comment|/*&n; * based on ddb5477 manual page 11&n; */
DECL|macro|MAX_SLOT_NUM
mdefine_line|#define&t;&t;MAX_SLOT_NUM&t;&t;21
DECL|variable|irq_map
r_static
r_int
r_char
id|irq_map
(braket
id|MAX_SLOT_NUM
)braket
op_assign
(brace
multiline_comment|/* AD:11 */
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
multiline_comment|/* AD:15 */
id|INT_ONBOARD_TULIP
comma
id|INT_SLOT1
comma
id|INT_SLOT2
comma
id|INT_SLOT3
comma
multiline_comment|/* AD:19 */
id|INT_SLOT4
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
multiline_comment|/* AD:23 */
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
multiline_comment|/* AD:27 */
l_int|0xff
comma
l_int|0xff
comma
id|INT_AC97
comma
id|INT_USB_PERI
comma
multiline_comment|/* AD:31 */
id|INT_USB_HOST
)brace
suffix:semicolon
r_extern
r_int
id|vrc5477_irq_to_irq
c_func
(paren
r_int
id|irq
)paren
suffix:semicolon
DECL|function|pcibios_fixup_irqs
r_void
id|__init
id|pcibios_fixup_irqs
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|slot_num
suffix:semicolon
r_while
c_loop
(paren
(paren
id|dev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|dev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|slot_num
op_assign
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
suffix:semicolon
id|MIPS_ASSERT
c_func
(paren
id|slot_num
OL
id|MAX_SLOT_NUM
)paren
suffix:semicolon
id|MIPS_ASSERT
c_func
(paren
id|irq_map
(braket
id|slot_num
)braket
op_ne
l_int|0xff
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|PCI_INTERRUPT_LINE
comma
id|irq_map
(braket
id|slot_num
)braket
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|vrc5477_irq_to_irq
c_func
(paren
id|irq_map
(braket
id|slot_num
)braket
)paren
suffix:semicolon
)brace
)brace
macro_line|#if defined(CONFIG_LL_DEBUG)
r_extern
r_void
id|jsun_scan_pci_bus
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|jsun_assign_pci_resource
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
DECL|function|ddb_pci_reset_bus
r_void
id|__init
id|ddb_pci_reset_bus
c_func
(paren
r_void
)paren
(brace
id|u32
id|temp
suffix:semicolon
multiline_comment|/*&n;&t; * I am not sure about the &quot;official&quot; procedure, the following&n;&t; * steps work as far as I know:&n;&t; * We first set PCI cold reset bit (bit 31) in PCICTRL-H.&n;&t; * Then we clear the PCI warm reset bit (bit 30) to 0 in PCICTRL-H.&n;&t; * The same is true for both PCI channels.&n;&t; */
id|temp
op_assign
id|ddb_in32
c_func
(paren
id|DDB_PCICTL0_H
)paren
suffix:semicolon
id|temp
op_or_assign
l_int|0x80000000
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_PCICTL0_H
comma
id|temp
)paren
suffix:semicolon
id|temp
op_and_assign
op_complement
l_int|0xc0000000
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_PCICTL0_H
comma
id|temp
)paren
suffix:semicolon
id|temp
op_assign
id|ddb_in32
c_func
(paren
id|DDB_PCICTL1_H
)paren
suffix:semicolon
id|temp
op_or_assign
l_int|0x80000000
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_PCICTL1_H
comma
id|temp
)paren
suffix:semicolon
id|temp
op_and_assign
op_complement
l_int|0xc0000000
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_PCICTL1_H
comma
id|temp
)paren
suffix:semicolon
)brace
DECL|function|pcibios_assign_all_busses
r_int
id|__init
r_int
id|pcibios_assign_all_busses
c_func
(paren
r_void
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
eof
