multiline_comment|/*&n; * Copyright 2001 MontaVista Software Inc.&n; * Author: Jun Sun, jsun@mvista.com or jsun@junsun.net&n; *&n; *  arch/mips/ddb5xxx/ddb5477/irq.c&n; *     The irq setup and misc routines for DDB5476.&n; *&n; * This program is free software; you can redistribute  it and/or modify it&n; * under  the terms of  the GNU General  Public License as published by the&n; * Free Software Foundation;  either version 2 of the  License, or (at your&n; * option) any later version.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;asm/i8259.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/mipsregs.h&gt;
macro_line|#include &lt;asm/debug.h&gt;
macro_line|#include &lt;asm/addrspace.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#include &lt;asm/ddb5xxx/ddb5xxx.h&gt;
multiline_comment|/*&n; * IRQ mapping&n; *&n; *  0-7: 8 CPU interrupts&n; *&t;0 -&t;software interrupt 0&n; *&t;1 - &t;software interrupt 1&n; *&t;2 - &t;most Vrc5477 interrupts are routed to this pin&n; *&t;3 - &t;(optional) some other interrupts routed to this pin for debugg&n; *&t;4 - &t;not used&n; *&t;5 - &t;not used&n; *&t;6 - &t;not used&n; *&t;7 - &t;cpu timer (used by default)&n; *&n; *  8-39: 32 Vrc5477 interrupt sources&n; *&t;(refer to the Vrc5477 manual)&n; */
DECL|macro|PCI0
mdefine_line|#define&t;PCI0&t;&t;&t;DDB_INTPPES0
DECL|macro|PCI1
mdefine_line|#define&t;PCI1&t;&t;&t;DDB_INTPPES1
DECL|macro|ACTIVE_LOW
mdefine_line|#define&t;ACTIVE_LOW&t;&t;1
DECL|macro|ACTIVE_HIGH
mdefine_line|#define&t;ACTIVE_HIGH&t;&t;0
DECL|macro|LEVEL_SENSE
mdefine_line|#define&t;LEVEL_SENSE&t;&t;2
DECL|macro|EDGE_TRIGGER
mdefine_line|#define&t;EDGE_TRIGGER&t;&t;0
DECL|macro|INTA
mdefine_line|#define&t;INTA&t;&t;&t;0
DECL|macro|INTB
mdefine_line|#define&t;INTB&t;&t;&t;1
DECL|macro|INTC
mdefine_line|#define&t;INTC&t;&t;&t;2
DECL|macro|INTD
mdefine_line|#define&t;INTD&t;&t;&t;3
DECL|macro|INTE
mdefine_line|#define&t;INTE&t;&t;&t;4
r_static
r_inline
r_void
DECL|function|set_pci_int_attr
id|set_pci_int_attr
c_func
(paren
id|u32
id|pci
comma
id|u32
id|intn
comma
id|u32
id|active
comma
id|u32
id|trigger
)paren
(brace
id|u32
id|reg_value
suffix:semicolon
id|u32
id|reg_bitmask
suffix:semicolon
id|reg_value
op_assign
id|ddb_in32
c_func
(paren
id|pci
)paren
suffix:semicolon
id|reg_bitmask
op_assign
l_int|0x3
op_lshift
(paren
id|intn
op_star
l_int|2
)paren
suffix:semicolon
id|reg_value
op_and_assign
op_complement
id|reg_bitmask
suffix:semicolon
id|reg_value
op_or_assign
(paren
id|active
op_or
id|trigger
)paren
op_lshift
(paren
id|intn
op_star
l_int|2
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|pci
comma
id|reg_value
)paren
suffix:semicolon
)brace
r_extern
r_void
id|vrc5477_irq_init
c_func
(paren
id|u32
id|base
)paren
suffix:semicolon
r_extern
r_void
id|mips_cpu_irq_init
c_func
(paren
id|u32
id|base
)paren
suffix:semicolon
r_extern
id|asmlinkage
r_void
id|ddb5477_handle_int
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_int
id|setup_irq
c_func
(paren
r_int
r_int
id|irq
comma
r_struct
id|irqaction
op_star
id|irqaction
)paren
suffix:semicolon
DECL|variable|irq_cascade
r_static
r_struct
id|irqaction
id|irq_cascade
op_assign
(brace
id|no_action
comma
l_int|0
comma
id|CPU_MASK_NONE
comma
l_string|&quot;cascade&quot;
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|arch_init_irq
r_void
id|__init
id|arch_init_irq
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* by default, we disable all interrupts and route all vrc5477&n;&t; * interrupts to pin 0 (irq 2) */
id|ddb_out32
c_func
(paren
id|DDB_INTCTRL0
comma
l_int|0
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_INTCTRL1
comma
l_int|0
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_INTCTRL2
comma
l_int|0
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_INTCTRL3
comma
l_int|0
)paren
suffix:semicolon
id|clear_c0_status
c_func
(paren
l_int|0xff00
)paren
suffix:semicolon
id|set_c0_status
c_func
(paren
l_int|0x0400
)paren
suffix:semicolon
multiline_comment|/* setup PCI interrupt attributes */
id|set_pci_int_attr
c_func
(paren
id|PCI0
comma
id|INTA
comma
id|ACTIVE_LOW
comma
id|LEVEL_SENSE
)paren
suffix:semicolon
id|set_pci_int_attr
c_func
(paren
id|PCI0
comma
id|INTB
comma
id|ACTIVE_LOW
comma
id|LEVEL_SENSE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mips_machtype
op_eq
id|MACH_NEC_ROCKHOPPERII
)paren
id|set_pci_int_attr
c_func
(paren
id|PCI0
comma
id|INTC
comma
id|ACTIVE_HIGH
comma
id|LEVEL_SENSE
)paren
suffix:semicolon
r_else
id|set_pci_int_attr
c_func
(paren
id|PCI0
comma
id|INTC
comma
id|ACTIVE_LOW
comma
id|LEVEL_SENSE
)paren
suffix:semicolon
id|set_pci_int_attr
c_func
(paren
id|PCI0
comma
id|INTD
comma
id|ACTIVE_LOW
comma
id|LEVEL_SENSE
)paren
suffix:semicolon
id|set_pci_int_attr
c_func
(paren
id|PCI0
comma
id|INTE
comma
id|ACTIVE_LOW
comma
id|LEVEL_SENSE
)paren
suffix:semicolon
id|set_pci_int_attr
c_func
(paren
id|PCI1
comma
id|INTA
comma
id|ACTIVE_LOW
comma
id|LEVEL_SENSE
)paren
suffix:semicolon
id|set_pci_int_attr
c_func
(paren
id|PCI1
comma
id|INTB
comma
id|ACTIVE_LOW
comma
id|LEVEL_SENSE
)paren
suffix:semicolon
id|set_pci_int_attr
c_func
(paren
id|PCI1
comma
id|INTC
comma
id|ACTIVE_LOW
comma
id|LEVEL_SENSE
)paren
suffix:semicolon
id|set_pci_int_attr
c_func
(paren
id|PCI1
comma
id|INTD
comma
id|ACTIVE_LOW
comma
id|LEVEL_SENSE
)paren
suffix:semicolon
id|set_pci_int_attr
c_func
(paren
id|PCI1
comma
id|INTE
comma
id|ACTIVE_LOW
comma
id|LEVEL_SENSE
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * for debugging purpose, we enable several error interrupts&n;&t; * and route them to pin 1. (IP3)&n;&t; */
multiline_comment|/* cpu parity check - 0 */
id|ll_vrc5477_irq_route
c_func
(paren
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|ll_vrc5477_irq_enable
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* cpu no-target decode - 1 */
id|ll_vrc5477_irq_route
c_func
(paren
l_int|1
comma
l_int|1
)paren
suffix:semicolon
id|ll_vrc5477_irq_enable
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* local bus read time-out - 7 */
id|ll_vrc5477_irq_route
c_func
(paren
l_int|7
comma
l_int|1
)paren
suffix:semicolon
id|ll_vrc5477_irq_enable
c_func
(paren
l_int|7
)paren
suffix:semicolon
multiline_comment|/* PCI SERR# - 14 */
id|ll_vrc5477_irq_route
c_func
(paren
l_int|14
comma
l_int|1
)paren
suffix:semicolon
id|ll_vrc5477_irq_enable
c_func
(paren
l_int|14
)paren
suffix:semicolon
multiline_comment|/* PCI internal error - 15 */
id|ll_vrc5477_irq_route
c_func
(paren
l_int|15
comma
l_int|1
)paren
suffix:semicolon
id|ll_vrc5477_irq_enable
c_func
(paren
l_int|15
)paren
suffix:semicolon
multiline_comment|/* IOPCI SERR# - 30 */
id|ll_vrc5477_irq_route
c_func
(paren
l_int|30
comma
l_int|1
)paren
suffix:semicolon
id|ll_vrc5477_irq_enable
c_func
(paren
l_int|30
)paren
suffix:semicolon
multiline_comment|/* IOPCI internal error - 31 */
id|ll_vrc5477_irq_route
c_func
(paren
l_int|31
comma
l_int|1
)paren
suffix:semicolon
id|ll_vrc5477_irq_enable
c_func
(paren
l_int|31
)paren
suffix:semicolon
multiline_comment|/* init all controllers */
id|init_i8259_irqs
c_func
(paren
)paren
suffix:semicolon
id|mips_cpu_irq_init
c_func
(paren
id|CPU_IRQ_BASE
)paren
suffix:semicolon
id|vrc5477_irq_init
c_func
(paren
id|VRC5477_IRQ_BASE
)paren
suffix:semicolon
multiline_comment|/* setup cascade interrupts */
id|setup_irq
c_func
(paren
id|VRC5477_IRQ_BASE
op_plus
id|VRC5477_I8259_CASCADE
comma
op_amp
id|irq_cascade
)paren
suffix:semicolon
id|setup_irq
c_func
(paren
id|CPU_IRQ_BASE
op_plus
id|CPU_VRC5477_CASCADE
comma
op_amp
id|irq_cascade
)paren
suffix:semicolon
multiline_comment|/* hook up the first-level interrupt handler */
id|set_except_vector
c_func
(paren
l_int|0
comma
id|ddb5477_handle_int
)paren
suffix:semicolon
)brace
DECL|function|i8259_interrupt_ack
id|u8
id|i8259_interrupt_ack
c_func
(paren
r_void
)paren
(brace
id|u8
id|irq
suffix:semicolon
id|u32
id|reg
suffix:semicolon
multiline_comment|/* Set window 0 for interrupt acknowledge */
id|reg
op_assign
id|ddb_in32
c_func
(paren
id|DDB_PCIINIT10
)paren
suffix:semicolon
id|ddb_set_pmr
c_func
(paren
id|DDB_PCIINIT10
comma
id|DDB_PCICMD_IACK
comma
l_int|0
comma
id|DDB_PCI_ACCESS_32
)paren
suffix:semicolon
id|irq
op_assign
op_star
(paren
r_volatile
id|u8
op_star
)paren
id|KSEG1ADDR
c_func
(paren
id|DDB_PCI_IACK_BASE
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_PCIINIT10
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* i8259.c set the base vector to be 0x0 */
r_return
id|irq
op_plus
id|I8259_IRQ_BASE
suffix:semicolon
)brace
multiline_comment|/*&n; * the first level int-handler will jump here if it is a vrc5477 irq&n; */
DECL|macro|NUM_5477_IRQS
mdefine_line|#define&t;NUM_5477_IRQS&t;32
id|asmlinkage
r_void
DECL|function|vrc5477_irq_dispatch
id|vrc5477_irq_dispatch
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|u32
id|intStatus
suffix:semicolon
id|u32
id|bitmask
suffix:semicolon
id|u32
id|i
suffix:semicolon
id|db_assert
c_func
(paren
id|ddb_in32
c_func
(paren
id|DDB_INT2STAT
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|db_assert
c_func
(paren
id|ddb_in32
c_func
(paren
id|DDB_INT3STAT
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|db_assert
c_func
(paren
id|ddb_in32
c_func
(paren
id|DDB_INT4STAT
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|db_assert
c_func
(paren
id|ddb_in32
c_func
(paren
id|DDB_NMISTAT
)paren
op_eq
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ddb_in32
c_func
(paren
id|DDB_INT1STAT
)paren
op_ne
l_int|0
)paren
(brace
macro_line|#if defined(CONFIG_RUNTIME_DEBUG)
id|vrc5477_show_int_regs
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|panic
c_func
(paren
l_string|&quot;error interrupt has happened.&quot;
)paren
suffix:semicolon
)brace
id|intStatus
op_assign
id|ddb_in32
c_func
(paren
id|DDB_INT0STAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mips_machtype
op_eq
id|MACH_NEC_ROCKHOPPERII
)paren
(brace
multiline_comment|/* check for i8259 interrupts */
r_if
c_cond
(paren
id|intStatus
op_amp
(paren
l_int|1
op_lshift
id|VRC5477_I8259_CASCADE
)paren
)paren
(brace
r_int
id|i8259_irq
op_assign
id|i8259_interrupt_ack
c_func
(paren
)paren
suffix:semicolon
id|do_IRQ
c_func
(paren
id|I8259_IRQ_BASE
op_plus
id|i8259_irq
comma
id|regs
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|bitmask
op_assign
l_int|1
suffix:semicolon
id|i
op_le
id|NUM_5477_IRQS
suffix:semicolon
id|bitmask
op_lshift_assign
l_int|1
comma
id|i
op_increment
)paren
(brace
multiline_comment|/* do we need to &quot;and&quot; with the int mask? */
r_if
c_cond
(paren
id|intStatus
op_amp
id|bitmask
)paren
(brace
id|do_IRQ
c_func
(paren
id|VRC5477_IRQ_BASE
op_plus
id|i
comma
id|regs
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
)brace
eof
