multiline_comment|/*&n; *  arch/mips/ddb5476/setup.c -- NEC DDB Vrc-5476 setup routines&n; *&n; *  Copyright (C) 2000 Geert Uytterhoeven &lt;geert@sonycom.com&gt;&n; *                     Sony Software Development Center Europe (SDCE), Brussels&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kbd_ll.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/kdev_t.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/addrspace.h&gt;
macro_line|#include &lt;asm/bcache.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/reboot.h&gt;
macro_line|#include &lt;asm/gdb-stub.h&gt;
macro_line|#include &lt;asm/time.h&gt;
macro_line|#include &lt;asm/debug.h&gt;
macro_line|#include &lt;asm/traps.h&gt;
macro_line|#include &lt;asm/ddb5xxx/ddb5xxx.h&gt;
singleline_comment|// #define USE_CPU_COUNTER_TIMER&t;/* whether we use cpu counter */
macro_line|#ifdef USE_CPU_COUNTER_TIMER
DECL|macro|CPU_COUNTER_FREQUENCY
mdefine_line|#define CPU_COUNTER_FREQUENCY           83000000
macro_line|#else
multiline_comment|/* otherwise we use general purpose timer */
DECL|macro|TIMER_FREQUENCY
mdefine_line|#define TIMER_FREQUENCY&t;&t;&t;83000000
DECL|macro|TIMER_BASE
mdefine_line|#define TIMER_BASE&t;&t;&t;DDB_T2CTRL
DECL|macro|TIMER_IRQ
mdefine_line|#define TIMER_IRQ&t;&t;&t;(VRC5476_IRQ_BASE + VRC5476_IRQ_GPT)
macro_line|#endif
DECL|variable|back_to_prom
r_static
r_void
(paren
op_star
id|back_to_prom
)paren
(paren
r_void
)paren
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_void
)paren
)paren
l_int|0xbfc00000
suffix:semicolon
DECL|function|ddb_machine_restart
r_static
r_void
id|ddb_machine_restart
c_func
(paren
r_char
op_star
id|command
)paren
(brace
id|u32
id|t
suffix:semicolon
multiline_comment|/* PCI cold reset */
id|t
op_assign
id|ddb_in32
c_func
(paren
id|DDB_PCICTRL
op_plus
l_int|4
)paren
suffix:semicolon
id|t
op_or_assign
l_int|0x40000000
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_PCICTRL
op_plus
l_int|4
comma
id|t
)paren
suffix:semicolon
multiline_comment|/* CPU cold reset */
id|t
op_assign
id|ddb_in32
c_func
(paren
id|DDB_CPUSTAT
)paren
suffix:semicolon
id|t
op_or_assign
l_int|1
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_CPUSTAT
comma
id|t
)paren
suffix:semicolon
multiline_comment|/* Call the PROM */
id|back_to_prom
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|ddb_machine_halt
r_static
r_void
id|ddb_machine_halt
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;DDB Vrc-5476 halted.&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|ddb_machine_power_off
r_static
r_void
id|ddb_machine_power_off
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;DDB Vrc-5476 halted. Please turn off the power.&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_extern
r_void
id|rtc_ds1386_init
c_func
(paren
r_int
r_int
id|base
)paren
suffix:semicolon
DECL|function|ddb_time_init
r_static
r_void
id|__init
id|ddb_time_init
c_func
(paren
r_void
)paren
(brace
macro_line|#if defined(USE_CPU_COUNTER_TIMER)
id|mips_hpt_frequency
op_assign
id|CPU_COUNTER_FREQUENCY
suffix:semicolon
macro_line|#endif
multiline_comment|/* we have ds1396 RTC chip */
id|rtc_ds1386_init
c_func
(paren
id|KSEG1ADDR
c_func
(paren
id|DDB_PCI_MEM_BASE
)paren
)paren
suffix:semicolon
)brace
r_extern
r_int
id|setup_irq
c_func
(paren
r_int
r_int
id|irq
comma
r_struct
id|irqaction
op_star
id|irqaction
)paren
suffix:semicolon
DECL|function|ddb_timer_setup
r_static
r_void
id|__init
id|ddb_timer_setup
c_func
(paren
r_struct
id|irqaction
op_star
id|irq
)paren
(brace
macro_line|#if defined(USE_CPU_COUNTER_TIMER)
r_int
r_int
id|count
suffix:semicolon
multiline_comment|/* we are using the cpu counter for timer interrupts */
id|setup_irq
c_func
(paren
id|CPU_IRQ_BASE
op_plus
l_int|7
comma
id|irq
)paren
suffix:semicolon
multiline_comment|/* to generate the first timer interrupt */
id|count
op_assign
id|read_c0_count
c_func
(paren
)paren
suffix:semicolon
id|write_c0_compare
c_func
(paren
id|count
op_plus
l_int|1000
)paren
suffix:semicolon
macro_line|#else
id|ddb_out32
c_func
(paren
id|TIMER_BASE
comma
id|TIMER_FREQUENCY
op_div
id|HZ
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|TIMER_BASE
op_plus
l_int|4
comma
l_int|0x1
)paren
suffix:semicolon
multiline_comment|/* enable timer */
id|setup_irq
c_func
(paren
id|TIMER_IRQ
comma
id|irq
)paren
suffix:semicolon
macro_line|#endif
)brace
r_static
r_struct
(brace
DECL|member|dma1
r_struct
id|resource
id|dma1
suffix:semicolon
DECL|member|timer
r_struct
id|resource
id|timer
suffix:semicolon
DECL|member|rtc
r_struct
id|resource
id|rtc
suffix:semicolon
DECL|member|dma_page_reg
r_struct
id|resource
id|dma_page_reg
suffix:semicolon
DECL|member|dma2
r_struct
id|resource
id|dma2
suffix:semicolon
DECL|variable|ddb5476_ioport
)brace
id|ddb5476_ioport
op_assign
(brace
(brace
l_string|&quot;dma1&quot;
comma
l_int|0x00
comma
l_int|0x1f
comma
id|IORESOURCE_BUSY
)brace
comma
(brace
l_string|&quot;timer&quot;
comma
l_int|0x40
comma
l_int|0x5f
comma
id|IORESOURCE_BUSY
)brace
comma
(brace
l_string|&quot;rtc&quot;
comma
l_int|0x70
comma
l_int|0x7f
comma
id|IORESOURCE_BUSY
)brace
comma
(brace
l_string|&quot;dma page reg&quot;
comma
l_int|0x80
comma
l_int|0x8f
comma
id|IORESOURCE_BUSY
)brace
comma
(brace
l_string|&quot;dma2&quot;
comma
l_int|0xc0
comma
l_int|0xdf
comma
id|IORESOURCE_BUSY
)brace
)brace
suffix:semicolon
r_static
r_struct
(brace
DECL|member|nile4
r_struct
id|resource
id|nile4
suffix:semicolon
DECL|variable|ddb5476_iomem
)brace
id|ddb5476_iomem
op_assign
(brace
(brace
l_string|&quot;Nile 4&quot;
comma
id|DDB_BASE
comma
id|DDB_BASE
op_plus
id|DDB_SIZE
op_minus
l_int|1
comma
id|IORESOURCE_BUSY
)brace
)brace
suffix:semicolon
r_static
r_void
id|ddb5476_board_init
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|function|ddb5476_setup
r_static
r_void
id|__init
id|ddb5476_setup
c_func
(paren
r_void
)paren
(brace
id|set_io_port_base
c_func
(paren
id|KSEG1ADDR
c_func
(paren
id|DDB_PCI_IO_BASE
)paren
)paren
suffix:semicolon
id|board_time_init
op_assign
id|ddb_time_init
suffix:semicolon
id|board_timer_setup
op_assign
id|ddb_timer_setup
suffix:semicolon
id|_machine_restart
op_assign
id|ddb_machine_restart
suffix:semicolon
id|_machine_halt
op_assign
id|ddb_machine_halt
suffix:semicolon
id|_machine_power_off
op_assign
id|ddb_machine_power_off
suffix:semicolon
multiline_comment|/* request io port/mem resources  */
r_if
c_cond
(paren
id|request_resource
c_func
(paren
op_amp
id|ioport_resource
comma
op_amp
id|ddb5476_ioport.dma1
)paren
op_logical_or
id|request_resource
c_func
(paren
op_amp
id|ioport_resource
comma
op_amp
id|ddb5476_ioport.timer
)paren
op_logical_or
id|request_resource
c_func
(paren
op_amp
id|ioport_resource
comma
op_amp
id|ddb5476_ioport.rtc
)paren
op_logical_or
id|request_resource
c_func
(paren
op_amp
id|ioport_resource
comma
op_amp
id|ddb5476_ioport.dma_page_reg
)paren
op_logical_or
id|request_resource
c_func
(paren
op_amp
id|ioport_resource
comma
op_amp
id|ddb5476_ioport.dma2
)paren
op_logical_or
id|request_resource
c_func
(paren
op_amp
id|iomem_resource
comma
op_amp
id|ddb5476_iomem.nile4
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;ddb_setup - requesting oo port resources failed.&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
suffix:semicolon
)brace
multiline_comment|/* Reboot on panic */
id|panic_timeout
op_assign
l_int|180
suffix:semicolon
multiline_comment|/* [jsun] we need to set BAR0 so that SDRAM 0 appears at 0x0 in PCI */
multiline_comment|/* *(long*)0xbfa00218 = 0x8; */
multiline_comment|/* board initialization stuff */
id|ddb5476_board_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|variable|ddb5476_setup
id|early_initcall
c_func
(paren
id|ddb5476_setup
)paren
suffix:semicolon
multiline_comment|/*&n; * We don&squot;t trust bios.  We essentially does hardware re-initialization&n; * as complete as possible, as far as we know we can safely do.&n; */
DECL|function|ddb5476_board_init
r_static
r_void
id|ddb5476_board_init
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* ----------- setup PDARs ------------ */
multiline_comment|/* check SDRAM0, whether we are on MEM bus does not matter */
id|db_assert
c_func
(paren
(paren
id|ddb_in32
c_func
(paren
id|DDB_SDRAM0
)paren
op_amp
l_int|0xffffffef
)paren
op_eq
id|ddb_calc_pdar
c_func
(paren
id|DDB_SDRAM_BASE
comma
id|DDB_SDRAM_SIZE
comma
l_int|32
comma
l_int|0
comma
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/* SDRAM1 should be turned off.  What is this for anyway ? */
id|db_assert
c_func
(paren
(paren
id|ddb_in32
c_func
(paren
id|DDB_SDRAM1
)paren
op_amp
l_int|0xf
)paren
op_eq
l_int|0
)paren
suffix:semicolon
multiline_comment|/* flash 1&amp;2, DDB status, DDB control */
id|ddb_set_pdar
c_func
(paren
id|DDB_DCS2
comma
id|DDB_DCS2_BASE
comma
id|DDB_DCS2_SIZE
comma
l_int|16
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|ddb_set_pdar
c_func
(paren
id|DDB_DCS3
comma
id|DDB_DCS3_BASE
comma
id|DDB_DCS3_SIZE
comma
l_int|16
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|ddb_set_pdar
c_func
(paren
id|DDB_DCS4
comma
id|DDB_DCS4_BASE
comma
id|DDB_DCS4_SIZE
comma
l_int|8
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|ddb_set_pdar
c_func
(paren
id|DDB_DCS5
comma
id|DDB_DCS5_BASE
comma
id|DDB_DCS5_SIZE
comma
l_int|8
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* shut off other pdar so they don&squot;t accidentally get into the way */
id|ddb_set_pdar
c_func
(paren
id|DDB_DCS6
comma
l_int|0xffffffff
comma
l_int|0
comma
l_int|32
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|ddb_set_pdar
c_func
(paren
id|DDB_DCS7
comma
l_int|0xffffffff
comma
l_int|0
comma
l_int|32
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|ddb_set_pdar
c_func
(paren
id|DDB_DCS8
comma
l_int|0xffffffff
comma
l_int|0
comma
l_int|32
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* verify VRC5477 base addr */
multiline_comment|/* don&squot;t care about some details */
id|db_assert
c_func
(paren
(paren
id|ddb_in32
c_func
(paren
id|DDB_INTCS
)paren
op_amp
l_int|0xffffff0f
)paren
op_eq
id|ddb_calc_pdar
c_func
(paren
id|DDB_INTCS_BASE
comma
id|DDB_INTCS_SIZE
comma
l_int|8
comma
l_int|0
comma
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* verify BOOT ROM addr */
multiline_comment|/* don&squot;t care about some details */
id|db_assert
c_func
(paren
(paren
id|ddb_in32
c_func
(paren
id|DDB_BOOTCS
)paren
op_amp
l_int|0xffffff0f
)paren
op_eq
id|ddb_calc_pdar
c_func
(paren
id|DDB_BOOTCS_BASE
comma
id|DDB_BOOTCS_SIZE
comma
l_int|8
comma
l_int|0
comma
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* setup PCI windows - window1 for MEM/config, window0 for IO */
id|ddb_set_pdar
c_func
(paren
id|DDB_PCIW0
comma
id|DDB_PCI_IO_BASE
comma
id|DDB_PCI_IO_SIZE
comma
l_int|32
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|ddb_set_pmr
c_func
(paren
id|DDB_PCIINIT0
comma
id|DDB_PCICMD_IO
comma
l_int|0
comma
id|DDB_PCI_ACCESS_32
)paren
suffix:semicolon
id|ddb_set_pdar
c_func
(paren
id|DDB_PCIW1
comma
id|DDB_PCI_MEM_BASE
comma
id|DDB_PCI_MEM_SIZE
comma
l_int|32
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|ddb_set_pmr
c_func
(paren
id|DDB_PCIINIT1
comma
id|DDB_PCICMD_MEM
comma
id|DDB_PCI_MEM_BASE
comma
id|DDB_PCI_ACCESS_32
)paren
suffix:semicolon
multiline_comment|/* ----------- setup PDARs ------------ */
multiline_comment|/* this is problematic - it will reset Aladin which cause we loose&n;&t; * serial port, and we don&squot;t know how to set up Aladin chip again.&n;&t; */
singleline_comment|// ddb_pci_reset_bus();
id|ddb_out32
c_func
(paren
id|DDB_BAR0
comma
l_int|0x00000008
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BARC
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BARB
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BAR1
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BAR2
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BAR3
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BAR4
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BAR5
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BAR6
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BAR7
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|ddb_out32
c_func
(paren
id|DDB_BAR8
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* ----------- switch PCI1 to PCI CONFIG space  ------------ */
id|ddb_set_pdar
c_func
(paren
id|DDB_PCIW1
comma
id|DDB_PCI_CONFIG_BASE
comma
id|DDB_PCI_CONFIG_SIZE
comma
l_int|32
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|ddb_set_pmr
c_func
(paren
id|DDB_PCIINIT1
comma
id|DDB_PCICMD_CFG
comma
l_int|0x0
comma
id|DDB_PCI_ACCESS_32
)paren
suffix:semicolon
multiline_comment|/* ----- M1543 PCI setup ------ */
multiline_comment|/* we know M1543 PCI-ISA controller is at addr:18 */
multiline_comment|/* xxxx1010 makes USB at addr:13 and PMU at addr:14 */
op_star
(paren
r_volatile
r_int
r_char
op_star
)paren
l_int|0xa8040072
op_and_assign
l_int|0xf0
suffix:semicolon
op_star
(paren
r_volatile
r_int
r_char
op_star
)paren
l_int|0xa8040072
op_or_assign
l_int|0xa
suffix:semicolon
multiline_comment|/* setup USB interrupt to IRQ 9, (bit 0:3 - 0001)&n;&t; * no IOCHRDY signal, (bit 7 - 1)&n;&t; * M1543C &amp; M7101 VID and Subsys Device ID are read-only (bit 6 - 1)&n;&t; * Make USB Master INTAJ level to edge conversion (bit 4 - 1)&n;&t; */
op_star
(paren
r_int
r_char
op_star
)paren
l_int|0xa8040074
op_assign
l_int|0xd1
suffix:semicolon
multiline_comment|/* setup PMU(SCI to IRQ 10 (bit 0:3 - 0011)&n;&t; * SCI routing to IRQ 13 disabled (bit 7 - 1)&n;&t; * SCI interrupt level to edge conversion bypassed (bit 4 - 0)&n;&t; */
op_star
(paren
r_int
r_char
op_star
)paren
l_int|0xa8040076
op_assign
l_int|0x83
suffix:semicolon
multiline_comment|/* setup IDE controller&n;&t; * enable IDE controller (bit 6 - 1)&n;&t; * IDE IDSEL to be addr:24 (bit 4:5 - 11)&n;&t; * no IDE ATA Secondary Bus Signal Pad Control (bit 3 - 0)&n;&t; * no IDE ATA Primary Bus Signal Pad Control (bit 2 - 0)&n;&t; * primary IRQ is 14, secondary is 15 (bit 1:0 - 01&n;&t; */
singleline_comment|// *(unsigned char*)0xa8040058 = 0x71;
singleline_comment|// *(unsigned char*)0xa8040058 = 0x79;
singleline_comment|// *(unsigned char*)0xa8040058 = 0x74;              // use SIRQ, primary tri-state
op_star
(paren
r_int
r_char
op_star
)paren
l_int|0xa8040058
op_assign
l_int|0x75
suffix:semicolon
singleline_comment|// primary tri-state
macro_line|#if 0
multiline_comment|/* this is not necessary if M5229 does not use SIRQ */
op_star
(paren
r_int
r_char
op_star
)paren
l_int|0xa8040044
op_assign
l_int|0x0d
suffix:semicolon
singleline_comment|// primary to IRQ 14
op_star
(paren
r_int
r_char
op_star
)paren
l_int|0xa8040075
op_assign
l_int|0x0d
suffix:semicolon
singleline_comment|// secondary to IRQ 14
macro_line|#endif
multiline_comment|/* enable IDE in the M5229 config register 0x50 (bit 0 - 1) */
multiline_comment|/* M5229 IDSEL is addr:24; see above setting */
op_star
(paren
r_int
r_char
op_star
)paren
l_int|0xa9000050
op_or_assign
l_int|0x1
suffix:semicolon
multiline_comment|/* enable bus master (bit 2)  and IO decoding  (bit 0) */
op_star
(paren
r_int
r_char
op_star
)paren
l_int|0xa9000004
op_or_assign
l_int|0x5
suffix:semicolon
multiline_comment|/* enable native, copied from arch/ppc/k2boot/head.S */
multiline_comment|/* TODO - need volatile, need to be portable */
op_star
(paren
r_int
r_char
op_star
)paren
l_int|0xa9000009
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* ----- end of M1543 PCI setup ------ */
multiline_comment|/* ----- reset on-board ether chip  ------ */
op_star
(paren
(paren
r_volatile
id|u32
op_star
)paren
l_int|0xa8020004
)paren
op_or_assign
l_int|1
suffix:semicolon
multiline_comment|/* decode I/O */
op_star
(paren
(paren
r_volatile
id|u32
op_star
)paren
l_int|0xa8020010
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set BAR address */
multiline_comment|/* send reset command */
op_star
(paren
(paren
r_volatile
id|u32
op_star
)paren
l_int|0xa6000000
)paren
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* do a soft reset */
multiline_comment|/* disable ether chip */
op_star
(paren
(paren
r_volatile
id|u32
op_star
)paren
l_int|0xa8020004
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* disable any decoding */
multiline_comment|/* put it into sleep */
op_star
(paren
(paren
r_volatile
id|u32
op_star
)paren
l_int|0xa8020040
)paren
op_assign
l_int|0x80000000
suffix:semicolon
multiline_comment|/* ----- end of reset on-board ether chip  ------ */
multiline_comment|/* ----------- switch PCI1 back to PCI MEM space  ------------ */
id|ddb_set_pdar
c_func
(paren
id|DDB_PCIW1
comma
id|DDB_PCI_MEM_BASE
comma
id|DDB_PCI_MEM_SIZE
comma
l_int|32
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|ddb_set_pmr
c_func
(paren
id|DDB_PCIINIT1
comma
id|DDB_PCICMD_MEM
comma
id|DDB_PCI_MEM_BASE
comma
id|DDB_PCI_ACCESS_32
)paren
suffix:semicolon
)brace
eof
