multiline_comment|/*&n; *  arch/mips/ddb5476/irq.c -- NEC DDB Vrc-5476 interrupt routines&n; *&n; *  Copyright (C) 2000 Geert Uytterhoeven &lt;geert@sonycom.com&gt;&n; *                     Sony Software Development Center Europe (SDCE), Brussels&n; *&n; * Re-write the whole thing to use new irq.c file.&n; * Copyright (C) 2001 MontaVista Software Inc.&n; * Author: Jun Sun, jsun@mvista.com or jsun@junsun.net&n; *&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/i8259.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/ddb5xxx/ddb5xxx.h&gt;
DECL|macro|M1543_PNP_CONFIG
mdefine_line|#define M1543_PNP_CONFIG&t;0x03f0&t;/* PnP Config Port */
DECL|macro|M1543_PNP_INDEX
mdefine_line|#define M1543_PNP_INDEX&t;&t;0x03f0&t;/* PnP Index Port */
DECL|macro|M1543_PNP_DATA
mdefine_line|#define M1543_PNP_DATA&t;&t;0x03f1&t;/* PnP Data Port */
DECL|macro|M1543_PNP_ALT_CONFIG
mdefine_line|#define M1543_PNP_ALT_CONFIG&t;0x0370&t;/* Alternative PnP Config Port */
DECL|macro|M1543_PNP_ALT_INDEX
mdefine_line|#define M1543_PNP_ALT_INDEX&t;0x0370&t;/* Alternative PnP Index Port */
DECL|macro|M1543_PNP_ALT_DATA
mdefine_line|#define M1543_PNP_ALT_DATA&t;0x0371&t;/* Alternative PnP Data Port */
DECL|macro|M1543_INT1_MASTER_CTRL
mdefine_line|#define M1543_INT1_MASTER_CTRL&t;0x0020&t;/* INT_1 (master) Control Register */
DECL|macro|M1543_INT1_MASTER_MASK
mdefine_line|#define M1543_INT1_MASTER_MASK&t;0x0021&t;/* INT_1 (master) Mask Register */
DECL|macro|M1543_INT1_SLAVE_CTRL
mdefine_line|#define M1543_INT1_SLAVE_CTRL&t;0x00a0&t;/* INT_1 (slave) Control Register */
DECL|macro|M1543_INT1_SLAVE_MASK
mdefine_line|#define M1543_INT1_SLAVE_MASK&t;0x00a1&t;/* INT_1 (slave) Mask Register */
DECL|macro|M1543_INT1_MASTER_ELCR
mdefine_line|#define M1543_INT1_MASTER_ELCR&t;0x04d0&t;/* INT_1 (master) Edge/Level Control */
DECL|macro|M1543_INT1_SLAVE_ELCR
mdefine_line|#define M1543_INT1_SLAVE_ELCR&t;0x04d1&t;/* INT_1 (slave) Edge/Level Control */
DECL|function|m1543_irq_setup
r_static
r_void
id|m1543_irq_setup
c_func
(paren
r_void
)paren
(brace
multiline_comment|/*&n;&t; *  The ALI M1543 has 13 interrupt inputs, IRQ1..IRQ13.  Not all&n;&t; *  the possible IO sources in the M1543 are in use by us.  We will&n;&t; *  use the following mapping:&n;&t; *&n;&t; *      IRQ1  - keyboard (default set by M1543)&n;&t; *      IRQ3  - reserved for UART B (default set by M1543) (note that&n;&t; *              the schematics for the DDB Vrc-5476 board seem to&n;&t; *              indicate that IRQ3 is connected to the DS1386&n;&t; *              watchdog timer interrupt output so we might have&n;&t; *              a conflict)&n;&t; *      IRQ4  - reserved for UART A (default set by M1543)&n;&t; *      IRQ5  - parallel (default set by M1543)&n;&t; *      IRQ8  - DS1386 time of day (RTC) interrupt&n;&t; *      IRQ9  - USB (hardwired in ddb_setup)&n;&t; *      IRQ10 - PMU (hardwired in ddb_setup)&n;&t; *      IRQ12 - mouse&n;&t; *      IRQ14,15 - IDE controller (need to be confirmed, jsun)&n;&t; */
multiline_comment|/*&n;&t; *  Assing mouse interrupt to IRQ12&n;&t; */
multiline_comment|/* Enter configuration mode */
id|outb
c_func
(paren
l_int|0x51
comma
id|M1543_PNP_CONFIG
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x23
comma
id|M1543_PNP_CONFIG
)paren
suffix:semicolon
multiline_comment|/* Select logical device 7 (Keyboard) */
id|outb
c_func
(paren
l_int|0x07
comma
id|M1543_PNP_INDEX
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x07
comma
id|M1543_PNP_DATA
)paren
suffix:semicolon
multiline_comment|/* Select IRQ12 */
id|outb
c_func
(paren
l_int|0x72
comma
id|M1543_PNP_INDEX
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x0c
comma
id|M1543_PNP_DATA
)paren
suffix:semicolon
multiline_comment|/* Leave configration mode */
id|outb
c_func
(paren
l_int|0xbb
comma
id|M1543_PNP_CONFIG
)paren
suffix:semicolon
)brace
DECL|function|nile4_irq_setup
r_static
r_void
id|nile4_irq_setup
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Map all interrupts to CPU int #0 (IP2) */
id|nile4_map_irq_all
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* PCI INTA#-E# must be level triggered */
id|nile4_set_pci_irq_level_or_edge
c_func
(paren
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|nile4_set_pci_irq_level_or_edge
c_func
(paren
l_int|1
comma
l_int|1
)paren
suffix:semicolon
id|nile4_set_pci_irq_level_or_edge
c_func
(paren
l_int|2
comma
l_int|1
)paren
suffix:semicolon
id|nile4_set_pci_irq_level_or_edge
c_func
(paren
l_int|3
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* PCI INTA#, B#, D# must be active low, INTC# must be active high */
id|nile4_set_pci_irq_polarity
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|nile4_set_pci_irq_polarity
c_func
(paren
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|nile4_set_pci_irq_polarity
c_func
(paren
l_int|2
comma
l_int|1
)paren
suffix:semicolon
id|nile4_set_pci_irq_polarity
c_func
(paren
l_int|3
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|nile4_clear_irq
c_func
(paren
id|i
)paren
suffix:semicolon
multiline_comment|/* Enable CPU int #0 */
id|nile4_enable_irq_output
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* memory resource acquire in ddb_setup */
)brace
DECL|variable|irq_cascade
r_static
r_struct
id|irqaction
id|irq_cascade
op_assign
(brace
id|no_action
comma
l_int|0
comma
id|CPU_MASK_NONE
comma
l_string|&quot;cascade&quot;
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|irq_error
r_static
r_struct
id|irqaction
id|irq_error
op_assign
(brace
id|no_action
comma
l_int|0
comma
id|CPU_MASK_NONE
comma
l_string|&quot;error&quot;
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
r_extern
id|asmlinkage
r_void
id|ddb5476_handle_int
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_int
id|setup_irq
c_func
(paren
r_int
r_int
id|irq
comma
r_struct
id|irqaction
op_star
id|irqaction
)paren
suffix:semicolon
r_extern
r_void
id|mips_cpu_irq_init
c_func
(paren
id|u32
id|irq_base
)paren
suffix:semicolon
r_extern
r_void
id|vrc5476_irq_init
c_func
(paren
id|u32
id|irq_base
)paren
suffix:semicolon
DECL|function|ddb5476_irq_setup
r_void
id|__init
id|ddb5476_irq_setup
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* hardware initialization */
id|nile4_irq_setup
c_func
(paren
)paren
suffix:semicolon
id|m1543_irq_setup
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* controller setup */
id|init_i8259_irqs
c_func
(paren
)paren
suffix:semicolon
id|vrc5476_irq_init
c_func
(paren
id|VRC5476_IRQ_BASE
)paren
suffix:semicolon
id|mips_cpu_irq_init
c_func
(paren
id|CPU_IRQ_BASE
)paren
suffix:semicolon
multiline_comment|/* setup cascade interrupts */
id|setup_irq
c_func
(paren
id|VRC5476_IRQ_BASE
op_plus
id|VRC5476_I8259_CASCADE
comma
op_amp
id|irq_cascade
)paren
suffix:semicolon
id|setup_irq
c_func
(paren
id|CPU_IRQ_BASE
op_plus
id|CPU_VRC5476_CASCADE
comma
op_amp
id|irq_cascade
)paren
suffix:semicolon
multiline_comment|/* setup error interrupts for debugging */
id|setup_irq
c_func
(paren
id|VRC5476_IRQ_BASE
op_plus
id|VRC5476_IRQ_CPCE
comma
op_amp
id|irq_error
)paren
suffix:semicolon
id|setup_irq
c_func
(paren
id|VRC5476_IRQ_BASE
op_plus
id|VRC5476_IRQ_CNTD
comma
op_amp
id|irq_error
)paren
suffix:semicolon
id|setup_irq
c_func
(paren
id|VRC5476_IRQ_BASE
op_plus
id|VRC5476_IRQ_MCE
comma
op_amp
id|irq_error
)paren
suffix:semicolon
id|setup_irq
c_func
(paren
id|VRC5476_IRQ_BASE
op_plus
id|VRC5476_IRQ_LBRT
comma
op_amp
id|irq_error
)paren
suffix:semicolon
id|setup_irq
c_func
(paren
id|VRC5476_IRQ_BASE
op_plus
id|VRC5476_IRQ_PCIS
comma
op_amp
id|irq_error
)paren
suffix:semicolon
id|setup_irq
c_func
(paren
id|VRC5476_IRQ_BASE
op_plus
id|VRC5476_IRQ_PCI
comma
op_amp
id|irq_error
)paren
suffix:semicolon
multiline_comment|/* setup the grandpa intr vector */
id|set_except_vector
c_func
(paren
l_int|0
comma
id|ddb5476_handle_int
)paren
suffix:semicolon
)brace
eof
