multiline_comment|/*&n; * FILE NAME: ocp-probe.c&n; *&n; * BRIEF MODULE DESCRIPTION: &n; * Device scanning &amp; bus set routines&n; * Based on drivers/pci/probe, Copyright (c) 1997--1999 Martin Mares&n; *&n; * Maintained by: Armin &lt;akuster@mvista.com&gt;&n; *&n; *&n; *  This program is free software; you can redistribute  it and/or modify it&n; *  under  the terms of  the GNU General  Public License as published by the&n; *  Free Software Foundation;  either version 2 of the  License, or (at your&n; *  option) any later version.&n; *&n; *  THIS  SOFTWARE  IS PROVIDED   ``AS  IS&squot;&squot; AND   ANY  EXPRESS OR IMPLIED&n; *  WARRANTIES,   INCLUDING, BUT NOT  LIMITED  TO, THE IMPLIED WARRANTIES OF&n; *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN&n; *  NO  EVENT  SHALL   THE AUTHOR  BE    LIABLE FOR ANY   DIRECT, INDIRECT,&n; *  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT&n; *  NOT LIMITED   TO, PROCUREMENT OF  SUBSTITUTE GOODS  OR SERVICES; LOSS OF&n; *  USE, DATA,  OR PROFITS; OR  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON&n; *  ANY THEORY OF LIABILITY, WHETHER IN  CONTRACT, STRICT LIABILITY, OR TORT&n; *  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF&n; *  THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n; *&n; *  You should have received a copy of the  GNU General Public License along&n; *  with this program; if not, write  to the Free Software Foundation, Inc.,&n; *  675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;asm/ocp.h&gt;
DECL|variable|ocp_devices
id|LIST_HEAD
c_func
(paren
id|ocp_devices
)paren
suffix:semicolon
DECL|variable|ocp_bus
r_struct
id|device
op_star
id|ocp_bus
suffix:semicolon
r_static
r_struct
id|ocp_device
op_star
id|__devinit
DECL|function|ocp_setup_dev
id|ocp_setup_dev
c_func
(paren
r_struct
id|ocp_def
op_star
id|odef
comma
r_int
r_int
id|index
)paren
(brace
r_struct
id|ocp_device
op_star
id|dev
suffix:semicolon
id|dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|dev
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|dev
)paren
)paren
suffix:semicolon
id|dev-&gt;vendor
op_assign
id|odef-&gt;vendor
suffix:semicolon
id|dev-&gt;device
op_assign
id|odef-&gt;device
suffix:semicolon
id|dev-&gt;num
op_assign
id|ocp_get_num
c_func
(paren
id|dev-&gt;device
)paren
suffix:semicolon
id|dev-&gt;paddr
op_assign
id|odef-&gt;paddr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|odef-&gt;irq
suffix:semicolon
id|dev-&gt;pm
op_assign
id|odef-&gt;pm
suffix:semicolon
id|dev-&gt;current_state
op_assign
l_int|4
suffix:semicolon
id|sprintf
c_func
(paren
id|dev-&gt;name
comma
l_string|&quot;OCP device %04x:%04x&quot;
comma
id|dev-&gt;vendor
comma
id|dev-&gt;device
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s %s 0x%lx irq:%d pm:0x%lx &bslash;n&quot;
comma
id|dev-&gt;slot_name
comma
id|dev-&gt;name
comma
(paren
r_int
r_int
)paren
id|dev-&gt;paddr
comma
id|dev-&gt;irq
comma
id|dev-&gt;pm
)paren
suffix:semicolon
multiline_comment|/* now put in global tree */
id|sprintf
c_func
(paren
id|dev-&gt;dev.bus_id
comma
l_string|&quot;%d&quot;
comma
id|index
)paren
suffix:semicolon
id|dev-&gt;dev.parent
op_assign
id|ocp_bus
suffix:semicolon
id|dev-&gt;dev.bus
op_assign
op_amp
id|ocp_bus_type
suffix:semicolon
id|device_register
c_func
(paren
op_amp
id|dev-&gt;dev
)paren
suffix:semicolon
r_return
id|dev
suffix:semicolon
)brace
DECL|function|ocp_alloc_primary_bus
r_static
r_struct
id|device
op_star
id|__devinit
id|ocp_alloc_primary_bus
c_func
(paren
r_void
)paren
(brace
r_struct
id|device
op_star
id|b
suffix:semicolon
id|b
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|b
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|b
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|device
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|b-&gt;bus_id
comma
l_string|&quot;ocp&quot;
)paren
suffix:semicolon
id|device_register
c_func
(paren
id|b
)paren
suffix:semicolon
r_return
id|b
suffix:semicolon
)brace
DECL|function|ocp_setup_devices
r_void
id|__devinit
id|ocp_setup_devices
c_func
(paren
r_struct
id|ocp_def
op_star
id|odef
)paren
(brace
r_int
id|index
suffix:semicolon
r_struct
id|ocp_device
op_star
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|ocp_bus
op_eq
l_int|NULL
)paren
id|ocp_bus
op_assign
id|ocp_alloc_primary_bus
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
id|odef-&gt;vendor
op_ne
id|OCP_VENDOR_INVALID
suffix:semicolon
op_increment
id|index
comma
op_increment
id|odef
)paren
(brace
id|dev
op_assign
id|ocp_setup_dev
c_func
(paren
id|odef
comma
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ne
l_int|NULL
)paren
id|list_add_tail
c_func
(paren
op_amp
id|dev-&gt;global_list
comma
op_amp
id|ocp_devices
)paren
suffix:semicolon
)brace
)brace
r_extern
r_struct
id|ocp_def
id|core_ocp
(braket
)braket
suffix:semicolon
r_static
r_int
id|__init
DECL|function|ocparch_init
id|ocparch_init
c_func
(paren
r_void
)paren
(brace
id|ocp_setup_devices
c_func
(paren
id|core_ocp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ocparch_init
id|subsys_initcall
c_func
(paren
id|ocparch_init
)paren
suffix:semicolon
DECL|variable|ocp_devices
id|EXPORT_SYMBOL
c_func
(paren
id|ocp_devices
)paren
suffix:semicolon
eof
