multiline_comment|/*&n; * arch/ppc/platforms/4xx/xilinx_ml300.c&n; *&n; * Xilinx ML300 evaluation board initialization&n; *&n; * Author: MontaVista Software, Inc.&n; *         source@mvista.com&n; *&n; * 2002-2004 (c) MontaVista Software, Inc.  This file is licensed under the&n; * terms of the GNU General Public License version 2.  This program is licensed&n; * &quot;as is&quot; without any warranty of any kind, whether express or implied.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/serial_core.h&gt;
macro_line|#include &lt;linux/serialP.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/ocp.h&gt;
macro_line|#include &lt;platforms/4xx/virtex-ii_pro.h&gt;&t;/* for NR_SER_PORTS */
multiline_comment|/*&n; * As an overview of how the following functions (platform_init,&n; * ml300_map_io, ml300_setup_arch and ml300_init_IRQ) fit into the&n; * kernel startup procedure, here&squot;s a call tree:&n; *&n; * start_here&t;&t;&t;&t;&t;arch/ppc/kernel/head_4xx.S&n; *  early_init&t;&t;&t;&t;&t;arch/ppc/kernel/setup.c&n; *  machine_init&t;&t;&t;&t;arch/ppc/kernel/setup.c&n; *    platform_init&t;&t;&t;&t;this file&n; *      ppc4xx_init&t;&t;&t;&t;arch/ppc/syslib/ppc4xx_setup.c&n; *        parse_bootinfo&n; *          find_bootinfo&n; *        &quot;setup some default ppc_md pointers&quot;&n; *  MMU_init&t;&t;&t;&t;&t;arch/ppc/mm/init.c&n; *    *ppc_md.setup_io_mappings == ml300_map_io&t;this file&n; *      ppc4xx_map_io&t;&t;&t;&t;arch/ppc/syslib/ppc4xx_setup.c&n; *  start_kernel&t;&t;&t;&t;init/main.c&n; *    setup_arch&t;&t;&t;&t;arch/ppc/kernel/setup.c&n; * #if defined(CONFIG_KGDB)&n; *      *ppc_md.kgdb_map_scc() == gen550_kgdb_map_scc&n; * #endif&n; *      *ppc_md.setup_arch == ml300_setup_arch&t;this file&n; *        ppc4xx_setup_arch&t;&t;&t;arch/ppc/syslib/ppc4xx_setup.c&n; *          ppc4xx_find_bridges&t;&t;&t;arch/ppc/syslib/ppc405_pci.c&n; *    init_IRQ&t;&t;&t;&t;&t;arch/ppc/kernel/irq.c&n; *      *ppc_md.init_IRQ == ml300_init_IRQ&t;this file&n; *        ppc4xx_init_IRQ&t;&t;&t;arch/ppc/syslib/ppc4xx_setup.c&n; *          ppc4xx_pic_init&t;&t;&t;arch/ppc/syslib/xilinx_pic.c&n; */
macro_line|#if defined(XPAR_POWER_0_POWERDOWN_BASEADDR)
DECL|variable|powerdown_base
r_static
r_volatile
r_int
op_star
id|powerdown_base
op_assign
(paren
r_volatile
r_int
op_star
)paren
id|XPAR_POWER_0_POWERDOWN_BASEADDR
suffix:semicolon
r_static
r_void
DECL|function|xilinx_power_off
id|xilinx_power_off
c_func
(paren
r_void
)paren
(brace
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
id|out_be32
c_func
(paren
id|powerdown_base
comma
id|XPAR_POWER_0_POWERDOWN_VALUE
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#endif
r_void
id|__init
DECL|function|ml300_map_io
id|ml300_map_io
c_func
(paren
r_void
)paren
(brace
id|ppc4xx_map_io
c_func
(paren
)paren
suffix:semicolon
macro_line|#if defined(XPAR_POWER_0_POWERDOWN_BASEADDR)
id|powerdown_base
op_assign
id|ioremap
c_func
(paren
(paren
r_int
r_int
)paren
id|powerdown_base
comma
id|XPAR_POWER_0_POWERDOWN_HIGHADDR
op_minus
id|XPAR_POWER_0_POWERDOWN_BASEADDR
op_plus
l_int|1
)paren
suffix:semicolon
macro_line|#endif
)brace
r_static
r_void
id|__init
DECL|function|ml300_early_serial_map
id|ml300_early_serial_map
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_SERIAL_8250
r_struct
id|serial_state
id|old_ports
(braket
)braket
op_assign
(brace
id|SERIAL_PORT_DFNS
)brace
suffix:semicolon
r_struct
id|uart_port
id|port
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Setup ioremapped serial port access */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|old_ports
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memset
c_func
(paren
op_amp
id|port
comma
l_int|0
comma
r_sizeof
(paren
id|port
)paren
)paren
suffix:semicolon
id|port.membase
op_assign
id|ioremap
c_func
(paren
(paren
id|phys_addr_t
)paren
(paren
id|old_ports
(braket
id|i
)braket
dot
id|iomem_base
)paren
comma
l_int|16
)paren
suffix:semicolon
id|port.irq
op_assign
id|old_ports
(braket
id|i
)braket
dot
id|irq
suffix:semicolon
id|port.uartclk
op_assign
id|old_ports
(braket
id|i
)braket
dot
id|baud_base
op_star
l_int|16
suffix:semicolon
id|port.regshift
op_assign
id|old_ports
(braket
id|i
)braket
dot
id|iomem_reg_shift
suffix:semicolon
id|port.iotype
op_assign
id|SERIAL_IO_MEM
suffix:semicolon
id|port.flags
op_assign
id|ASYNC_BOOT_AUTOCONF
op_or
id|ASYNC_SKIP_TEST
suffix:semicolon
id|port.line
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|early_serial_setup
c_func
(paren
op_amp
id|port
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Early serial init of port %d failed&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_SERIAL_8250 */
)brace
r_void
id|__init
DECL|function|ml300_setup_arch
id|ml300_setup_arch
c_func
(paren
r_void
)paren
(brace
id|ppc4xx_setup_arch
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* calls ppc4xx_find_bridges() */
id|ml300_early_serial_map
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Identify the system */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Xilinx Virtex-II Pro port&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Port by MontaVista Software, Inc. (source@mvista.com)&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Called after board_setup_irq from ppc4xx_init_IRQ(). */
r_void
id|__init
DECL|function|ml300_init_irq
id|ml300_init_irq
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
id|ppc4xx_init_IRQ
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * For PowerPC 405 cores the default value for NR_IRQS is 32.&n;&t; * See include/asm-ppc/irq.h for details.&n;&t; * This is just fine for ML300.&n;&t; */
macro_line|#if (NR_IRQS != 32)
macro_line|#error NR_IRQS must be 32 for ML300
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_IRQS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|XPAR_INTC_0_KIND_OF_INTR
op_amp
(paren
l_int|0x80000000
op_rshift
id|i
)paren
)paren
id|irq_desc
(braket
id|i
)braket
dot
id|status
op_and_assign
op_complement
id|IRQ_LEVEL
suffix:semicolon
r_else
id|irq_desc
(braket
id|i
)braket
dot
id|status
op_or_assign
id|IRQ_LEVEL
suffix:semicolon
)brace
)brace
r_void
id|__init
DECL|function|platform_init
id|platform_init
c_func
(paren
r_int
r_int
id|r3
comma
r_int
r_int
id|r4
comma
r_int
r_int
id|r5
comma
r_int
r_int
id|r6
comma
r_int
r_int
id|r7
)paren
(brace
id|ppc4xx_init
c_func
(paren
id|r3
comma
id|r4
comma
id|r5
comma
id|r6
comma
id|r7
)paren
suffix:semicolon
id|ppc_md.setup_arch
op_assign
id|ml300_setup_arch
suffix:semicolon
id|ppc_md.setup_io_mappings
op_assign
id|ml300_map_io
suffix:semicolon
id|ppc_md.init_IRQ
op_assign
id|ml300_init_irq
suffix:semicolon
macro_line|#if defined(XPAR_POWER_0_POWERDOWN_BASEADDR)
id|ppc_md.power_off
op_assign
id|xilinx_power_off
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_KGDB
id|ppc_md.early_serial_map
op_assign
id|ml300_early_serial_map
suffix:semicolon
macro_line|#endif
)brace
eof
