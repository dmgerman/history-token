multiline_comment|/*&n; * BK Id: %F% %I% %G% %U% %#%&n; */
multiline_comment|/*&n; *  arch/ppc/platforms/pmac_feature.c&n; *&n; *  Copyright (C) 1996-2001 Paul Mackerras (paulus@cs.anu.edu.au)&n; *                          Ben. Herrenschmidt (benh@kernel.crashing.org)&n; *&n; *  This program is free software; you can redistribute it and/or&n; *  modify it under the terms of the GNU General Public License&n; *  as published by the Free Software Foundation; either version&n; *  2 of the License, or (at your option) any later version.&n; *  &n; *  TODO: &n; *  &n; *   - Replace mdelay with some schedule loop if possible&n; *   - Shorten some obfuscated delays on some routines (like modem&n; *     power)&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/adb.h&gt;
macro_line|#include &lt;linux/pmu.h&gt;
macro_line|#include &lt;asm/sections.h&gt;
macro_line|#include &lt;asm/errno.h&gt;
macro_line|#include &lt;asm/ohare.h&gt;
macro_line|#include &lt;asm/heathrow.h&gt;
macro_line|#include &lt;asm/keylargo.h&gt;
macro_line|#include &lt;asm/uninorth.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/pmac_feature.h&gt;
macro_line|#include &lt;asm/dbdma.h&gt;
DECL|macro|DEBUG_FEATURE
macro_line|#undef DEBUG_FEATURE
macro_line|#ifdef DEBUG_FEATURE
DECL|macro|DBG
mdefine_line|#define DBG(fmt,...) printk(KERN_DEBUG fmt)
macro_line|#else
DECL|macro|DBG
mdefine_line|#define DBG(fmt,...)
macro_line|#endif
multiline_comment|/* Exported from arch/ppc/kernel/idle.c */
r_extern
r_int
r_int
id|powersave_nap
suffix:semicolon
multiline_comment|/*&n; * We use a single global lock to protect accesses. Each driver has&n; * to take care of it&squot;s own locking&n; */
DECL|variable|__pmacdata
r_static
id|spinlock_t
id|feature_lock
id|__pmacdata
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|macro|LOCK
mdefine_line|#define LOCK(flags)&t;spin_lock_irqsave(&amp;feature_lock, flags);
DECL|macro|UNLOCK
mdefine_line|#define UNLOCK(flags)&t;spin_unlock_irqrestore(&amp;feature_lock, flags);
multiline_comment|/*&n; * Helper functions regarding the various flavors of mac-io&n; */
DECL|macro|MAX_MACIO_CHIPS
mdefine_line|#define MAX_MACIO_CHIPS&t;&t;2
r_enum
(brace
DECL|enumerator|macio_unknown
id|macio_unknown
op_assign
l_int|0
comma
DECL|enumerator|macio_grand_central
id|macio_grand_central
comma
DECL|enumerator|macio_ohare
id|macio_ohare
comma
DECL|enumerator|macio_ohareII
id|macio_ohareII
comma
DECL|enumerator|macio_heathrow
id|macio_heathrow
comma
DECL|enumerator|macio_gatwick
id|macio_gatwick
comma
DECL|enumerator|macio_paddington
id|macio_paddington
comma
DECL|enumerator|macio_keylargo
id|macio_keylargo
comma
DECL|enumerator|macio_pangea
id|macio_pangea
)brace
suffix:semicolon
DECL|variable|__pmacdata
r_static
r_const
r_char
op_star
id|macio_names
(braket
)braket
id|__pmacdata
op_assign
(brace
l_string|&quot;Unknown&quot;
comma
l_string|&quot;Grand Central&quot;
comma
l_string|&quot;OHare&quot;
comma
l_string|&quot;OHareII&quot;
comma
l_string|&quot;Heathrow&quot;
comma
l_string|&quot;Gatwick&quot;
comma
l_string|&quot;Paddington&quot;
comma
l_string|&quot;Keylargo&quot;
comma
l_string|&quot;Pangea&quot;
)brace
suffix:semicolon
DECL|struct|macio_chip
r_static
r_struct
id|macio_chip
(brace
DECL|member|of_node
r_struct
id|device_node
op_star
id|of_node
suffix:semicolon
DECL|member|type
r_int
id|type
suffix:semicolon
DECL|member|rev
r_int
id|rev
suffix:semicolon
DECL|member|base
r_volatile
id|u32
op_star
id|base
suffix:semicolon
DECL|member|flags
r_int
r_int
id|flags
suffix:semicolon
DECL|variable|__pmacdata
)brace
id|macio_chips
(braket
id|MAX_MACIO_CHIPS
)braket
id|__pmacdata
suffix:semicolon
DECL|macro|MACIO_FLAG_SCCA_ON
mdefine_line|#define MACIO_FLAG_SCCA_ON&t;0x00000001
DECL|macro|MACIO_FLAG_SCCB_ON
mdefine_line|#define MACIO_FLAG_SCCB_ON&t;0x00000002
DECL|macro|MACIO_FLAG_SCC_LOCKED
mdefine_line|#define MACIO_FLAG_SCC_LOCKED&t;0x00000004
DECL|macro|MACIO_FLAG_AIRPORT_ON
mdefine_line|#define MACIO_FLAG_AIRPORT_ON&t;0x00000010
DECL|macro|MACIO_FLAG_FW_SUPPORTED
mdefine_line|#define MACIO_FLAG_FW_SUPPORTED&t;0x00000020
r_static
r_struct
id|macio_chip
op_star
id|__pmac
DECL|function|macio_find
id|macio_find
c_func
(paren
r_struct
id|device_node
op_star
id|child
comma
r_int
id|type
)paren
(brace
r_while
c_loop
(paren
id|child
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_MACIO_CHIPS
op_logical_and
id|macio_chips
(braket
id|i
)braket
dot
id|of_node
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|child
op_eq
id|macio_chips
(braket
id|i
)braket
dot
id|of_node
op_logical_and
(paren
op_logical_neg
id|type
op_logical_or
id|macio_chips
(braket
id|i
)braket
dot
id|type
op_eq
id|type
)paren
)paren
r_return
op_amp
id|macio_chips
(braket
id|i
)braket
suffix:semicolon
id|child
op_assign
id|child-&gt;parent
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|macro|MACIO_FCR32
mdefine_line|#define MACIO_FCR32(macio, r)&t;((macio)-&gt;base + ((r) &gt;&gt; 2))
DECL|macro|MACIO_FCR8
mdefine_line|#define MACIO_FCR8(macio, r)&t;(((volatile u8*)((macio)-&gt;base)) + (r))
DECL|macro|MACIO_IN32
mdefine_line|#define MACIO_IN32(r)&t;&t;(in_le32(MACIO_FCR32(macio,r)))
DECL|macro|MACIO_OUT32
mdefine_line|#define MACIO_OUT32(r,v)&t;(out_le32(MACIO_FCR32(macio,r), (v)))
DECL|macro|MACIO_BIS
mdefine_line|#define MACIO_BIS(r,v)&t;&t;(MACIO_OUT32((r), MACIO_IN32(r) | (v)))
DECL|macro|MACIO_BIC
mdefine_line|#define MACIO_BIC(r,v)&t;&t;(MACIO_OUT32((r), MACIO_IN32(r) &amp; ~(v)))
DECL|macro|MACIO_IN8
mdefine_line|#define MACIO_IN8(r)&t;&t;(in_8(MACIO_FCR8(macio,r)))
DECL|macro|MACIO_OUT8
mdefine_line|#define MACIO_OUT8(r,v)&t;&t;(out_8(MACIO_FCR8(macio,r), (v)))
multiline_comment|/*&n; * Uninorth reg. access. Note that Uni-N regs are big endian&n; */
DECL|macro|UN_REG
mdefine_line|#define UN_REG(r)&t;(uninorth_base + ((r) &gt;&gt; 2))
DECL|macro|UN_IN
mdefine_line|#define UN_IN(r)&t;(in_be32(UN_REG(r)))
DECL|macro|UN_OUT
mdefine_line|#define UN_OUT(r,v)&t;(out_be32(UN_REG(r), (v)))
DECL|macro|UN_BIS
mdefine_line|#define UN_BIS(r,v)&t;(UN_OUT((r), UN_IN(r) | (v)))
DECL|macro|UN_BIC
mdefine_line|#define UN_BIC(r,v)&t;(UN_OUT((r), UN_IN(r) &amp; ~(v)))
DECL|variable|__pmacdata
r_static
r_struct
id|device_node
op_star
id|uninorth_node
id|__pmacdata
suffix:semicolon
DECL|variable|__pmacdata
r_static
id|u32
op_star
id|uninorth_base
id|__pmacdata
suffix:semicolon
DECL|variable|__pmacdata
r_static
id|u32
id|uninorth_rev
id|__pmacdata
suffix:semicolon
multiline_comment|/*&n; * For each motherboard family, we have a table of functions pointers&n; * that handle the various features.&n; */
DECL|typedef|feature_call
r_typedef
r_int
(paren
op_star
id|feature_call
)paren
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
suffix:semicolon
DECL|struct|feature_table_entry
r_struct
id|feature_table_entry
(brace
DECL|member|selector
r_int
r_int
id|selector
suffix:semicolon
DECL|member|function
id|feature_call
id|function
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|pmac_mb_def
r_struct
id|pmac_mb_def
(brace
DECL|member|model_string
r_const
r_char
op_star
id|model_string
suffix:semicolon
DECL|member|model_name
r_const
r_char
op_star
id|model_name
suffix:semicolon
DECL|member|model_id
r_int
id|model_id
suffix:semicolon
DECL|member|features
r_struct
id|feature_table_entry
op_star
id|features
suffix:semicolon
DECL|member|board_flags
r_int
r_int
id|board_flags
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|__pmacdata
r_static
r_struct
id|pmac_mb_def
id|pmac_mb
id|__pmacdata
suffix:semicolon
multiline_comment|/*&n; * Here are the chip specific feature functions&n; */
r_static
r_inline
r_int
id|__pmac
DECL|function|simple_feature_tweak
id|simple_feature_tweak
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|type
comma
r_int
id|reg
comma
id|u32
id|mask
comma
r_int
id|value
)paren
(brace
r_struct
id|macio_chip
op_star
id|macio
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|macio
op_assign
id|macio_find
c_func
(paren
id|node
comma
id|type
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|macio
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
id|MACIO_BIS
c_func
(paren
id|reg
comma
id|mask
)paren
suffix:semicolon
r_else
id|MACIO_BIC
c_func
(paren
id|reg
comma
id|mask
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|reg
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|ohare_htw_scc_enable
id|ohare_htw_scc_enable
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_struct
id|macio_chip
op_star
id|macio
suffix:semicolon
r_int
r_int
id|chan_mask
suffix:semicolon
r_int
r_int
id|fcr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|htw
suffix:semicolon
r_int
r_int
id|rmask
suffix:semicolon
id|macio
op_assign
id|macio_find
c_func
(paren
id|node
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|macio
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|node-&gt;name
comma
l_string|&quot;ch-a&quot;
)paren
)paren
id|chan_mask
op_assign
id|MACIO_FLAG_SCCA_ON
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|node-&gt;name
comma
l_string|&quot;ch-b&quot;
)paren
)paren
id|chan_mask
op_assign
id|MACIO_FLAG_SCCB_ON
suffix:semicolon
r_else
r_return
op_minus
id|ENODEV
suffix:semicolon
id|htw
op_assign
(paren
id|macio-&gt;type
op_eq
id|macio_heathrow
op_logical_or
id|macio-&gt;type
op_eq
id|macio_paddington
op_logical_or
id|macio-&gt;type
op_eq
id|macio_gatwick
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
(brace
macro_line|#ifdef CONFIG_ADB_PMU
r_if
c_cond
(paren
(paren
id|param
op_amp
l_int|0xfff
)paren
op_eq
id|PMAC_SCC_IRDA
)paren
id|pmu_enable_irled
c_func
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_ADB_PMU */&t;&t;
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|fcr
op_assign
id|MACIO_IN32
c_func
(paren
id|OHARE_FCR
)paren
suffix:semicolon
multiline_comment|/* Check if scc cell need enabling */
r_if
c_cond
(paren
op_logical_neg
(paren
id|fcr
op_amp
id|OH_SCC_ENABLE
)paren
)paren
(brace
id|fcr
op_or_assign
id|OH_SCC_ENABLE
suffix:semicolon
r_if
c_cond
(paren
id|htw
)paren
(brace
id|fcr
op_and_assign
op_complement
id|HRW_SCC_TRANS_EN_N
suffix:semicolon
id|MACIO_OUT32
c_func
(paren
id|OHARE_FCR
comma
id|fcr
)paren
suffix:semicolon
id|fcr
op_or_assign
(paren
id|rmask
op_assign
id|HRW_RESET_SCC
)paren
suffix:semicolon
id|MACIO_OUT32
c_func
(paren
id|OHARE_FCR
comma
id|fcr
)paren
suffix:semicolon
)brace
r_else
(brace
id|fcr
op_or_assign
(paren
id|rmask
op_assign
id|OH_SCC_RESET
)paren
suffix:semicolon
id|MACIO_OUT32
c_func
(paren
id|OHARE_FCR
comma
id|fcr
)paren
suffix:semicolon
)brace
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|OHARE_FCR
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|15
)paren
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|fcr
op_and_assign
op_complement
id|rmask
suffix:semicolon
id|MACIO_OUT32
c_func
(paren
id|OHARE_FCR
comma
id|fcr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chan_mask
op_amp
id|MACIO_FLAG_SCCA_ON
)paren
id|fcr
op_or_assign
id|OH_SCCA_IO
suffix:semicolon
r_if
c_cond
(paren
id|chan_mask
op_amp
id|MACIO_FLAG_SCCB_ON
)paren
id|fcr
op_or_assign
id|OH_SCCB_IO
suffix:semicolon
id|MACIO_OUT32
c_func
(paren
id|OHARE_FCR
comma
id|fcr
)paren
suffix:semicolon
id|macio-&gt;flags
op_or_assign
id|chan_mask
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
op_amp
id|PMAC_SCC_FLAG_XMON
)paren
id|macio-&gt;flags
op_or_assign
id|MACIO_FLAG_SCC_LOCKED
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|macio-&gt;flags
op_amp
id|MACIO_FLAG_SCC_LOCKED
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|fcr
op_assign
id|MACIO_IN32
c_func
(paren
id|OHARE_FCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan_mask
op_amp
id|MACIO_FLAG_SCCA_ON
)paren
id|fcr
op_and_assign
op_complement
id|OH_SCCA_IO
suffix:semicolon
r_if
c_cond
(paren
id|chan_mask
op_amp
id|MACIO_FLAG_SCCB_ON
)paren
id|fcr
op_and_assign
op_complement
id|OH_SCCB_IO
suffix:semicolon
id|MACIO_OUT32
c_func
(paren
id|OHARE_FCR
comma
id|fcr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fcr
op_amp
(paren
id|OH_SCCA_IO
op_or
id|OH_SCCB_IO
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|fcr
op_and_assign
op_complement
id|OH_SCC_ENABLE
suffix:semicolon
r_if
c_cond
(paren
id|htw
)paren
id|fcr
op_or_assign
id|HRW_SCC_TRANS_EN_N
suffix:semicolon
id|MACIO_OUT32
c_func
(paren
id|OHARE_FCR
comma
id|fcr
)paren
suffix:semicolon
)brace
id|macio-&gt;flags
op_and_assign
op_complement
(paren
id|chan_mask
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ADB_PMU
r_if
c_cond
(paren
(paren
id|param
op_amp
l_int|0xfff
)paren
op_eq
id|PMAC_SCC_IRDA
)paren
id|pmu_enable_irled
c_func
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_ADB_PMU */&t;&t;
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|ohare_floppy_enable
id|ohare_floppy_enable
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_return
id|simple_feature_tweak
c_func
(paren
id|node
comma
id|macio_ohare
comma
id|OHARE_FCR
comma
id|OH_FLOPPY_ENABLE
comma
id|value
)paren
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|ohare_mesh_enable
id|ohare_mesh_enable
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_return
id|simple_feature_tweak
c_func
(paren
id|node
comma
id|macio_ohare
comma
id|OHARE_FCR
comma
id|OH_MESH_ENABLE
comma
id|value
)paren
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|ohare_ide_enable
id|ohare_ide_enable
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_switch
c_cond
(paren
id|param
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* For some reason, setting the bit in set_initial_features()&n;&t;    &t; * doesn&squot;t stick. I&squot;m still investigating... --BenH.&n;&t;    &t; */
r_if
c_cond
(paren
id|value
)paren
id|simple_feature_tweak
c_func
(paren
id|node
comma
id|macio_ohare
comma
id|OHARE_FCR
comma
id|OH_IOBUS_ENABLE
comma
l_int|1
)paren
suffix:semicolon
r_return
id|simple_feature_tweak
c_func
(paren
id|node
comma
id|macio_ohare
comma
id|OHARE_FCR
comma
id|OH_IDE0_ENABLE
comma
id|value
)paren
suffix:semicolon
r_case
l_int|1
suffix:colon
r_return
id|simple_feature_tweak
c_func
(paren
id|node
comma
id|macio_ohare
comma
id|OHARE_FCR
comma
id|OH_BAY_IDE_ENABLE
comma
id|value
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_static
r_int
id|__pmac
DECL|function|ohare_ide_reset
id|ohare_ide_reset
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_switch
c_cond
(paren
id|param
)paren
(brace
r_case
l_int|0
suffix:colon
r_return
id|simple_feature_tweak
c_func
(paren
id|node
comma
id|macio_ohare
comma
id|OHARE_FCR
comma
id|OH_IDE0_RESET_N
comma
op_logical_neg
id|value
)paren
suffix:semicolon
r_case
l_int|1
suffix:colon
r_return
id|simple_feature_tweak
c_func
(paren
id|node
comma
id|macio_ohare
comma
id|OHARE_FCR
comma
id|OH_IDE1_RESET_N
comma
op_logical_neg
id|value
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_static
r_int
id|__pmac
DECL|function|ohare_sleep_state
id|ohare_sleep_state
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_struct
id|macio_chip
op_star
id|macio
op_assign
op_amp
id|macio_chips
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pmac_mb.board_flags
op_amp
id|PMAC_MB_CAN_SLEEP
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
(brace
id|MACIO_BIC
c_func
(paren
id|OHARE_FCR
comma
id|OH_IOBUS_ENABLE
)paren
suffix:semicolon
)brace
r_else
(brace
id|MACIO_BIS
c_func
(paren
id|OHARE_FCR
comma
id|OH_IOBUS_ENABLE
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|heathrow_modem_enable
id|heathrow_modem_enable
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_struct
id|macio_chip
op_star
id|macio
suffix:semicolon
id|u8
id|gpio
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|macio
op_assign
id|macio_find
c_func
(paren
id|node
comma
id|macio_unknown
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|macio
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|gpio
op_assign
id|MACIO_IN8
c_func
(paren
id|HRW_GPIO_MODEM_RESET
)paren
op_amp
op_complement
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|value
)paren
(brace
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|HRW_GPIO_MODEM_RESET
comma
id|gpio
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
id|HRW_GPIO_MODEM_RESET
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pmac_mb.model_id
op_ne
id|PMAC_TYPE_YOSEMITE
op_logical_and
id|pmac_mb.model_id
op_ne
id|PMAC_TYPE_YIKES
)paren
(brace
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
id|MACIO_BIC
c_func
(paren
id|HEATHROW_FCR
comma
id|HRW_SCC_TRANS_EN_N
)paren
suffix:semicolon
r_else
id|MACIO_BIS
c_func
(paren
id|HEATHROW_FCR
comma
id|HRW_SCC_TRANS_EN_N
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|HEATHROW_FCR
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|value
)paren
(brace
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|HRW_GPIO_MODEM_RESET
comma
id|gpio
op_or
l_int|1
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
id|HRW_GPIO_MODEM_RESET
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|HRW_GPIO_MODEM_RESET
comma
id|gpio
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
id|HRW_GPIO_MODEM_RESET
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|HRW_GPIO_MODEM_RESET
comma
id|gpio
op_or
l_int|1
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
id|HRW_GPIO_MODEM_RESET
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|heathrow_floppy_enable
id|heathrow_floppy_enable
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_return
id|simple_feature_tweak
c_func
(paren
id|node
comma
id|macio_unknown
comma
id|HEATHROW_FCR
comma
id|HRW_SWIM_ENABLE
op_or
id|HRW_BAY_FLOPPY_ENABLE
comma
id|value
)paren
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|heathrow_mesh_enable
id|heathrow_mesh_enable
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_struct
id|macio_chip
op_star
id|macio
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|macio
op_assign
id|macio_find
c_func
(paren
id|node
comma
id|macio_unknown
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|macio
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Set clear mesh cell enable */
r_if
c_cond
(paren
id|value
)paren
id|MACIO_BIS
c_func
(paren
id|HEATHROW_FCR
comma
id|HRW_MESH_ENABLE
)paren
suffix:semicolon
r_else
id|MACIO_BIC
c_func
(paren
id|HEATHROW_FCR
comma
id|HRW_MESH_ENABLE
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|HEATHROW_FCR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Set/Clear termination power (todo: test ! the bit value&n;&t; * used by Darwin doesn&squot;t seem to match what we used so&n;&t; * far. If you experience problems, turn #if 1 into #if 0&n;&t; * and tell me about it --BenH.&n;&t; */
macro_line|#if 1
r_if
c_cond
(paren
id|value
)paren
id|MACIO_BIC
c_func
(paren
id|HEATHROW_MBCR
comma
l_int|0x00000004
)paren
suffix:semicolon
r_else
id|MACIO_BIS
c_func
(paren
id|HEATHROW_MBCR
comma
l_int|0x00000004
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|value
)paren
id|MACIO_BIC
c_func
(paren
id|HEATHROW_MBCR
comma
l_int|0x00040000
)paren
suffix:semicolon
r_else
id|MACIO_BIS
c_func
(paren
id|HEATHROW_MBCR
comma
l_int|0x00040000
)paren
suffix:semicolon
macro_line|#endif&t;&t;
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|HEATHROW_MBCR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|heathrow_ide_enable
id|heathrow_ide_enable
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_switch
c_cond
(paren
id|param
)paren
(brace
r_case
l_int|0
suffix:colon
r_return
id|simple_feature_tweak
c_func
(paren
id|node
comma
id|macio_unknown
comma
id|HEATHROW_FCR
comma
id|HRW_IDE0_ENABLE
comma
id|value
)paren
suffix:semicolon
r_case
l_int|1
suffix:colon
r_return
id|simple_feature_tweak
c_func
(paren
id|node
comma
id|macio_unknown
comma
id|HEATHROW_FCR
comma
id|HRW_BAY_IDE_ENABLE
comma
id|value
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_static
r_int
id|__pmac
DECL|function|heathrow_ide_reset
id|heathrow_ide_reset
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_switch
c_cond
(paren
id|param
)paren
(brace
r_case
l_int|0
suffix:colon
r_return
id|simple_feature_tweak
c_func
(paren
id|node
comma
id|macio_unknown
comma
id|HEATHROW_FCR
comma
id|HRW_IDE0_RESET_N
comma
op_logical_neg
id|value
)paren
suffix:semicolon
r_case
l_int|1
suffix:colon
r_return
id|simple_feature_tweak
c_func
(paren
id|node
comma
id|macio_unknown
comma
id|HEATHROW_FCR
comma
id|HRW_IDE1_RESET_N
comma
op_logical_neg
id|value
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_static
r_int
id|__pmac
DECL|function|heathrow_bmac_enable
id|heathrow_bmac_enable
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_struct
id|macio_chip
op_star
id|macio
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|macio
op_assign
id|macio_find
c_func
(paren
id|node
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|macio
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
(brace
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_BIS
c_func
(paren
id|HEATHROW_FCR
comma
id|HRW_BMAC_IO_ENABLE
)paren
suffix:semicolon
id|MACIO_BIS
c_func
(paren
id|HEATHROW_FCR
comma
id|HRW_BMAC_RESET
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|HEATHROW_FCR
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_BIC
c_func
(paren
id|HEATHROW_FCR
comma
id|HRW_BMAC_RESET
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|HEATHROW_FCR
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_else
(brace
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_BIC
c_func
(paren
id|HEATHROW_FCR
comma
id|HRW_BMAC_IO_ENABLE
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|heathrow_sound_enable
id|heathrow_sound_enable
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_struct
id|macio_chip
op_star
id|macio
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* B&amp;W G3 and Yikes don&squot;t support that properly (the&n;&t; * sound appear to never come back after beeing shut down).&n;&t; */
r_if
c_cond
(paren
id|pmac_mb.model_id
op_eq
id|PMAC_TYPE_YOSEMITE
op_logical_or
id|pmac_mb.model_id
op_eq
id|PMAC_TYPE_YIKES
)paren
r_return
l_int|0
suffix:semicolon
id|macio
op_assign
id|macio_find
c_func
(paren
id|node
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|macio
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
(brace
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_BIS
c_func
(paren
id|HEATHROW_FCR
comma
id|HRW_SOUND_CLK_ENABLE
)paren
suffix:semicolon
id|MACIO_BIC
c_func
(paren
id|HEATHROW_FCR
comma
id|HRW_SOUND_POWER_N
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|HEATHROW_FCR
)paren
suffix:semicolon
)brace
r_else
(brace
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_BIS
c_func
(paren
id|HEATHROW_FCR
comma
id|HRW_SOUND_POWER_N
)paren
suffix:semicolon
id|MACIO_BIC
c_func
(paren
id|HEATHROW_FCR
comma
id|HRW_SOUND_CLK_ENABLE
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|__pmacdata
r_static
id|u32
id|save_fcr
(braket
l_int|5
)braket
id|__pmacdata
suffix:semicolon
DECL|variable|__pmacdata
r_static
id|u32
id|save_mbcr
id|__pmacdata
suffix:semicolon
DECL|variable|__pmacdata
r_static
id|u32
id|save_gpio_levels
(braket
l_int|2
)braket
id|__pmacdata
suffix:semicolon
DECL|variable|__pmacdata
r_static
id|u8
id|save_gpio_extint
(braket
id|KEYLARGO_GPIO_EXTINT_CNT
)braket
id|__pmacdata
suffix:semicolon
DECL|variable|__pmacdata
r_static
id|u8
id|save_gpio_normal
(braket
id|KEYLARGO_GPIO_CNT
)braket
id|__pmacdata
suffix:semicolon
DECL|variable|__pmacdata
r_static
id|u32
id|save_unin_clock_ctl
id|__pmacdata
suffix:semicolon
DECL|variable|__pmacdata
r_static
r_struct
id|dbdma_regs
id|save_dbdma
(braket
l_int|13
)braket
id|__pmacdata
suffix:semicolon
DECL|variable|__pmacdata
r_static
r_struct
id|dbdma_regs
id|save_alt_dbdma
(braket
l_int|13
)braket
id|__pmacdata
suffix:semicolon
r_static
r_void
id|__pmac
DECL|function|dbdma_save
id|dbdma_save
c_func
(paren
r_struct
id|macio_chip
op_star
id|macio
comma
r_struct
id|dbdma_regs
op_star
id|save
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Save state &amp; config of DBDMA channels */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|13
suffix:semicolon
id|i
op_increment
)paren
(brace
r_volatile
r_struct
id|dbdma_regs
op_star
id|chan
op_assign
(paren
r_volatile
r_struct
id|dbdma_regs
op_star
)paren
(paren
id|macio-&gt;base
op_plus
(paren
(paren
l_int|0x8000
op_plus
id|i
op_star
l_int|0x100
)paren
op_rshift
l_int|2
)paren
)paren
suffix:semicolon
id|save
(braket
id|i
)braket
dot
id|cmdptr_hi
op_assign
id|in_le32
c_func
(paren
op_amp
id|chan-&gt;cmdptr_hi
)paren
suffix:semicolon
id|save
(braket
id|i
)braket
dot
id|cmdptr
op_assign
id|in_le32
c_func
(paren
op_amp
id|chan-&gt;cmdptr
)paren
suffix:semicolon
id|save
(braket
id|i
)braket
dot
id|intr_sel
op_assign
id|in_le32
c_func
(paren
op_amp
id|chan-&gt;intr_sel
)paren
suffix:semicolon
id|save
(braket
id|i
)braket
dot
id|br_sel
op_assign
id|in_le32
c_func
(paren
op_amp
id|chan-&gt;br_sel
)paren
suffix:semicolon
id|save
(braket
id|i
)braket
dot
id|wait_sel
op_assign
id|in_le32
c_func
(paren
op_amp
id|chan-&gt;wait_sel
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
id|__pmac
DECL|function|dbdma_restore
id|dbdma_restore
c_func
(paren
r_struct
id|macio_chip
op_star
id|macio
comma
r_struct
id|dbdma_regs
op_star
id|save
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Save state &amp; config of DBDMA channels */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|13
suffix:semicolon
id|i
op_increment
)paren
(brace
r_volatile
r_struct
id|dbdma_regs
op_star
id|chan
op_assign
(paren
r_volatile
r_struct
id|dbdma_regs
op_star
)paren
(paren
id|macio-&gt;base
op_plus
(paren
(paren
l_int|0x8000
op_plus
id|i
op_star
l_int|0x100
)paren
op_rshift
l_int|2
)paren
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|chan-&gt;control
comma
(paren
id|ACTIVE
op_or
id|DEAD
op_or
id|WAKE
op_or
id|FLUSH
op_or
id|PAUSE
op_or
id|RUN
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
r_while
c_loop
(paren
id|in_le32
c_func
(paren
op_amp
id|chan-&gt;status
)paren
op_amp
id|ACTIVE
)paren
id|mb
c_func
(paren
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|chan-&gt;cmdptr_hi
comma
id|save
(braket
id|i
)braket
dot
id|cmdptr_hi
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|chan-&gt;cmdptr
comma
id|save
(braket
id|i
)braket
dot
id|cmdptr
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|chan-&gt;intr_sel
comma
id|save
(braket
id|i
)braket
dot
id|intr_sel
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|chan-&gt;br_sel
comma
id|save
(braket
id|i
)braket
dot
id|br_sel
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|chan-&gt;wait_sel
comma
id|save
(braket
id|i
)braket
dot
id|wait_sel
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
id|__pmac
DECL|function|heathrow_sleep
id|heathrow_sleep
c_func
(paren
r_struct
id|macio_chip
op_star
id|macio
comma
r_int
id|secondary
)paren
(brace
r_if
c_cond
(paren
id|secondary
)paren
(brace
id|dbdma_save
c_func
(paren
id|macio
comma
id|save_alt_dbdma
)paren
suffix:semicolon
id|save_fcr
(braket
l_int|2
)braket
op_assign
id|MACIO_IN32
c_func
(paren
l_int|0x38
)paren
suffix:semicolon
id|save_fcr
(braket
l_int|3
)braket
op_assign
id|MACIO_IN32
c_func
(paren
l_int|0x3c
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbdma_save
c_func
(paren
id|macio
comma
id|save_dbdma
)paren
suffix:semicolon
id|save_fcr
(braket
l_int|0
)braket
op_assign
id|MACIO_IN32
c_func
(paren
l_int|0x38
)paren
suffix:semicolon
id|save_fcr
(braket
l_int|1
)braket
op_assign
id|MACIO_IN32
c_func
(paren
l_int|0x3c
)paren
suffix:semicolon
id|save_mbcr
op_assign
id|MACIO_IN32
c_func
(paren
l_int|0x34
)paren
suffix:semicolon
multiline_comment|/* Make sure sound is shut down */
id|MACIO_BIS
c_func
(paren
id|HEATHROW_FCR
comma
id|HRW_SOUND_POWER_N
)paren
suffix:semicolon
id|MACIO_BIC
c_func
(paren
id|HEATHROW_FCR
comma
id|HRW_SOUND_CLK_ENABLE
)paren
suffix:semicolon
multiline_comment|/* This seems to be necessary as well or the fan&n;&t;&t; * keeps coming up and battery drains fast */
id|MACIO_BIC
c_func
(paren
id|HEATHROW_FCR
comma
id|HRW_IOBUS_ENABLE
)paren
suffix:semicolon
multiline_comment|/* Make sure eth is down even if module or sleep&n;&t;&t; * won&squot;t work properly */
id|MACIO_BIC
c_func
(paren
id|HEATHROW_FCR
comma
id|HRW_BMAC_IO_ENABLE
op_or
id|HRW_BMAC_RESET
)paren
suffix:semicolon
)brace
multiline_comment|/* Make sure modem is shut down */
id|MACIO_OUT8
c_func
(paren
id|HRW_GPIO_MODEM_RESET
comma
id|MACIO_IN8
c_func
(paren
id|HRW_GPIO_MODEM_RESET
)paren
op_amp
op_complement
l_int|1
)paren
suffix:semicolon
id|MACIO_BIS
c_func
(paren
id|HEATHROW_FCR
comma
id|HRW_SCC_TRANS_EN_N
)paren
suffix:semicolon
id|MACIO_BIC
c_func
(paren
id|HEATHROW_FCR
comma
id|OH_SCCA_IO
op_or
id|OH_SCCB_IO
op_or
id|HRW_SCC_ENABLE
)paren
suffix:semicolon
multiline_comment|/* Let things settle */
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|HEATHROW_FCR
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_static
r_void
id|__pmac
DECL|function|heathrow_wakeup
id|heathrow_wakeup
c_func
(paren
r_struct
id|macio_chip
op_star
id|macio
comma
r_int
id|secondary
)paren
(brace
r_if
c_cond
(paren
id|secondary
)paren
(brace
id|MACIO_OUT32
c_func
(paren
l_int|0x38
comma
id|save_fcr
(braket
l_int|2
)braket
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
l_int|0x38
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|MACIO_OUT32
c_func
(paren
l_int|0x3c
comma
id|save_fcr
(braket
l_int|3
)braket
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
l_int|0x38
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|dbdma_restore
c_func
(paren
id|macio
comma
id|save_alt_dbdma
)paren
suffix:semicolon
)brace
r_else
(brace
id|MACIO_OUT32
c_func
(paren
l_int|0x38
comma
id|save_fcr
(braket
l_int|0
)braket
op_or
id|HRW_IOBUS_ENABLE
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
l_int|0x38
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|MACIO_OUT32
c_func
(paren
l_int|0x3c
comma
id|save_fcr
(braket
l_int|1
)braket
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
l_int|0x38
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|MACIO_OUT32
c_func
(paren
l_int|0x34
comma
id|save_mbcr
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
l_int|0x38
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|dbdma_restore
c_func
(paren
id|macio
comma
id|save_dbdma
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
id|__pmac
DECL|function|heathrow_sleep_state
id|heathrow_sleep_state
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_if
c_cond
(paren
(paren
id|pmac_mb.board_flags
op_amp
id|PMAC_MB_CAN_SLEEP
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|value
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|macio_chips
(braket
l_int|1
)braket
dot
id|type
op_eq
id|macio_gatwick
)paren
id|heathrow_sleep
c_func
(paren
op_amp
id|macio_chips
(braket
l_int|0
)braket
comma
l_int|1
)paren
suffix:semicolon
id|heathrow_sleep
c_func
(paren
op_amp
id|macio_chips
(braket
l_int|0
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|value
op_eq
l_int|0
)paren
(brace
id|heathrow_wakeup
c_func
(paren
op_amp
id|macio_chips
(braket
l_int|0
)braket
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|macio_chips
(braket
l_int|1
)braket
dot
id|type
op_eq
id|macio_gatwick
)paren
id|heathrow_wakeup
c_func
(paren
op_amp
id|macio_chips
(braket
l_int|0
)braket
comma
l_int|1
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|core99_scc_enable
id|core99_scc_enable
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_struct
id|macio_chip
op_star
id|macio
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|chan_mask
suffix:semicolon
id|u32
id|fcr
suffix:semicolon
id|macio
op_assign
id|macio_find
c_func
(paren
id|node
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|macio
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|node-&gt;name
comma
l_string|&quot;ch-a&quot;
)paren
)paren
id|chan_mask
op_assign
id|MACIO_FLAG_SCCA_ON
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|node-&gt;name
comma
l_string|&quot;ch-b&quot;
)paren
)paren
id|chan_mask
op_assign
id|MACIO_FLAG_SCCB_ON
suffix:semicolon
r_else
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
(brace
r_int
id|need_reset_scc
op_assign
l_int|0
suffix:semicolon
r_int
id|need_reset_irda
op_assign
l_int|0
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|fcr
op_assign
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR0
)paren
suffix:semicolon
multiline_comment|/* Check if scc cell need enabling */
r_if
c_cond
(paren
op_logical_neg
(paren
id|fcr
op_amp
id|KL0_SCC_CELL_ENABLE
)paren
)paren
(brace
id|fcr
op_or_assign
id|KL0_SCC_CELL_ENABLE
suffix:semicolon
id|need_reset_scc
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chan_mask
op_amp
id|MACIO_FLAG_SCCA_ON
)paren
(brace
id|fcr
op_or_assign
id|KL0_SCCA_ENABLE
suffix:semicolon
multiline_comment|/* Don&squot;t enable line drivers for I2S modem */
r_if
c_cond
(paren
(paren
id|param
op_amp
l_int|0xfff
)paren
op_eq
id|PMAC_SCC_I2S1
)paren
id|fcr
op_and_assign
op_complement
id|KL0_SCC_A_INTF_ENABLE
suffix:semicolon
r_else
id|fcr
op_or_assign
id|KL0_SCC_A_INTF_ENABLE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chan_mask
op_amp
id|MACIO_FLAG_SCCB_ON
)paren
(brace
id|fcr
op_or_assign
id|KL0_SCCB_ENABLE
suffix:semicolon
multiline_comment|/* Perform irda specific inits */
r_if
c_cond
(paren
(paren
id|param
op_amp
l_int|0xfff
)paren
op_eq
id|PMAC_SCC_IRDA
)paren
(brace
id|fcr
op_and_assign
op_complement
id|KL0_SCC_B_INTF_ENABLE
suffix:semicolon
id|fcr
op_or_assign
id|KL0_IRDA_ENABLE
suffix:semicolon
id|fcr
op_or_assign
id|KL0_IRDA_CLK32_ENABLE
op_or
id|KL0_IRDA_CLK19_ENABLE
suffix:semicolon
id|fcr
op_or_assign
id|KL0_IRDA_SOURCE1_SEL
suffix:semicolon
id|fcr
op_and_assign
op_complement
(paren
id|KL0_IRDA_FAST_CONNECT
op_or
id|KL0_IRDA_DEFAULT1
op_or
id|KL0_IRDA_DEFAULT0
)paren
suffix:semicolon
id|fcr
op_and_assign
op_complement
(paren
id|KL0_IRDA_SOURCE2_SEL
op_or
id|KL0_IRDA_HIGH_BAND
)paren
suffix:semicolon
id|need_reset_irda
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|fcr
op_or_assign
id|KL0_SCC_B_INTF_ENABLE
suffix:semicolon
)brace
id|MACIO_OUT32
c_func
(paren
id|KEYLARGO_FCR0
comma
id|fcr
)paren
suffix:semicolon
id|macio-&gt;flags
op_or_assign
id|chan_mask
suffix:semicolon
r_if
c_cond
(paren
id|need_reset_scc
)paren
(brace
id|MACIO_BIS
c_func
(paren
id|KEYLARGO_FCR0
comma
id|KL0_SCC_RESET
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR0
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|15
)paren
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_BIC
c_func
(paren
id|KEYLARGO_FCR0
comma
id|KL0_SCC_RESET
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|need_reset_irda
)paren
(brace
id|MACIO_BIS
c_func
(paren
id|KEYLARGO_FCR0
comma
id|KL0_IRDA_RESET
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR0
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|15
)paren
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_BIC
c_func
(paren
id|KEYLARGO_FCR0
comma
id|KL0_IRDA_RESET
)paren
suffix:semicolon
)brace
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
op_amp
id|PMAC_SCC_FLAG_XMON
)paren
id|macio-&gt;flags
op_or_assign
id|MACIO_FLAG_SCC_LOCKED
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|macio-&gt;flags
op_amp
id|MACIO_FLAG_SCC_LOCKED
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|fcr
op_assign
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan_mask
op_amp
id|MACIO_FLAG_SCCA_ON
)paren
id|fcr
op_and_assign
op_complement
id|KL0_SCCA_ENABLE
suffix:semicolon
r_if
c_cond
(paren
id|chan_mask
op_amp
id|MACIO_FLAG_SCCB_ON
)paren
(brace
id|fcr
op_and_assign
op_complement
id|KL0_SCCB_ENABLE
suffix:semicolon
multiline_comment|/* Perform irda specific clears */
r_if
c_cond
(paren
(paren
id|param
op_amp
l_int|0xfff
)paren
op_eq
id|PMAC_SCC_IRDA
)paren
(brace
id|fcr
op_and_assign
op_complement
id|KL0_IRDA_ENABLE
suffix:semicolon
id|fcr
op_and_assign
op_complement
(paren
id|KL0_IRDA_CLK32_ENABLE
op_or
id|KL0_IRDA_CLK19_ENABLE
)paren
suffix:semicolon
id|fcr
op_and_assign
op_complement
(paren
id|KL0_IRDA_FAST_CONNECT
op_or
id|KL0_IRDA_DEFAULT1
op_or
id|KL0_IRDA_DEFAULT0
)paren
suffix:semicolon
id|fcr
op_and_assign
op_complement
(paren
id|KL0_IRDA_SOURCE1_SEL
op_or
id|KL0_IRDA_SOURCE2_SEL
op_or
id|KL0_IRDA_HIGH_BAND
)paren
suffix:semicolon
)brace
)brace
id|MACIO_OUT32
c_func
(paren
id|KEYLARGO_FCR0
comma
id|fcr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fcr
op_amp
(paren
id|KL0_SCCA_ENABLE
op_or
id|KL0_SCCB_ENABLE
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|fcr
op_and_assign
op_complement
id|KL0_SCC_CELL_ENABLE
suffix:semicolon
id|MACIO_OUT32
c_func
(paren
id|KEYLARGO_FCR0
comma
id|fcr
)paren
suffix:semicolon
)brace
id|macio-&gt;flags
op_and_assign
op_complement
(paren
id|chan_mask
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|core99_modem_enable
id|core99_modem_enable
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_struct
id|macio_chip
op_star
id|macio
suffix:semicolon
id|u8
id|gpio
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|macio
op_assign
id|macio_find
c_func
(paren
id|node
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|macio
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|gpio
op_assign
id|MACIO_IN8
c_func
(paren
id|KL_GPIO_MODEM_RESET
)paren
suffix:semicolon
id|gpio
op_or_assign
id|KEYLARGO_GPIO_OUTPUT_ENABLE
suffix:semicolon
id|gpio
op_and_assign
op_complement
id|KEYLARGO_GPIO_OUTOUT_DATA
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|value
)paren
(brace
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|KL_GPIO_MODEM_RESET
comma
id|gpio
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
id|KL_GPIO_MODEM_RESET
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
)brace
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
(brace
id|MACIO_BIC
c_func
(paren
id|KEYLARGO_FCR2
comma
id|KL2_ALT_DATA_OUT
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR2
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
)brace
r_else
(brace
id|MACIO_BIS
c_func
(paren
id|KEYLARGO_FCR2
comma
id|KL2_ALT_DATA_OUT
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|value
)paren
(brace
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|KL_GPIO_MODEM_RESET
comma
id|gpio
op_or
id|KEYLARGO_GPIO_OUTOUT_DATA
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
id|KL_GPIO_MODEM_RESET
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|KL_GPIO_MODEM_RESET
comma
id|gpio
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
id|KL_GPIO_MODEM_RESET
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|KL_GPIO_MODEM_RESET
comma
id|gpio
op_or
id|KEYLARGO_GPIO_OUTOUT_DATA
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
id|KL_GPIO_MODEM_RESET
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|core99_ide_enable
id|core99_ide_enable
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_switch
c_cond
(paren
id|param
)paren
(brace
r_case
l_int|0
suffix:colon
r_return
id|simple_feature_tweak
c_func
(paren
id|node
comma
id|macio_unknown
comma
id|KEYLARGO_FCR1
comma
id|KL1_EIDE0_ENABLE
comma
id|value
)paren
suffix:semicolon
r_case
l_int|1
suffix:colon
r_return
id|simple_feature_tweak
c_func
(paren
id|node
comma
id|macio_unknown
comma
id|KEYLARGO_FCR1
comma
id|KL1_EIDE1_ENABLE
comma
id|value
)paren
suffix:semicolon
r_case
l_int|2
suffix:colon
r_return
id|simple_feature_tweak
c_func
(paren
id|node
comma
id|macio_unknown
comma
id|KEYLARGO_FCR1
comma
id|KL1_UIDE_ENABLE
comma
id|value
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_static
r_int
id|__pmac
DECL|function|core99_ide_reset
id|core99_ide_reset
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_switch
c_cond
(paren
id|param
)paren
(brace
r_case
l_int|0
suffix:colon
r_return
id|simple_feature_tweak
c_func
(paren
id|node
comma
id|macio_unknown
comma
id|KEYLARGO_FCR1
comma
id|KL1_EIDE0_RESET_N
comma
op_logical_neg
id|value
)paren
suffix:semicolon
r_case
l_int|1
suffix:colon
r_return
id|simple_feature_tweak
c_func
(paren
id|node
comma
id|macio_unknown
comma
id|KEYLARGO_FCR1
comma
id|KL1_EIDE1_RESET_N
comma
op_logical_neg
id|value
)paren
suffix:semicolon
r_case
l_int|2
suffix:colon
r_return
id|simple_feature_tweak
c_func
(paren
id|node
comma
id|macio_unknown
comma
id|KEYLARGO_FCR1
comma
id|KL1_UIDE_RESET_N
comma
op_logical_neg
id|value
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_static
r_int
id|__pmac
DECL|function|core99_gmac_enable
id|core99_gmac_enable
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
id|UN_BIS
c_func
(paren
id|UNI_N_CLOCK_CNTL
comma
id|UNI_N_CLOCK_CNTL_GMAC
)paren
suffix:semicolon
r_else
id|UN_BIC
c_func
(paren
id|UNI_N_CLOCK_CNTL
comma
id|UNI_N_CLOCK_CNTL_GMAC
)paren
suffix:semicolon
(paren
r_void
)paren
id|UN_IN
c_func
(paren
id|UNI_N_CLOCK_CNTL
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|core99_gmac_phy_reset
id|core99_gmac_phy_reset
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|macio_chip
op_star
id|macio
suffix:semicolon
id|macio
op_assign
op_amp
id|macio_chips
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|macio-&gt;type
op_ne
id|macio_keylargo
op_logical_and
id|macio-&gt;type
op_ne
id|macio_pangea
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|KL_GPIO_ETH_PHY_RESET
comma
id|KEYLARGO_GPIO_OUTPUT_ENABLE
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
id|KL_GPIO_ETH_PHY_RESET
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|KL_GPIO_ETH_PHY_RESET
comma
id|KEYLARGO_GPIO_OUTPUT_ENABLE
op_or
id|KEYLARGO_GPIO_OUTOUT_DATA
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|core99_sound_chip_enable
id|core99_sound_chip_enable
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_struct
id|macio_chip
op_star
id|macio
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|macio
op_assign
id|macio_find
c_func
(paren
id|node
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|macio
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Do a better probe code, screamer G4 desktops &amp;&n;&t; * iMacs can do that too, add a recalibrate  in&n;&t; * the driver as well&n;&t; */
r_if
c_cond
(paren
id|pmac_mb.model_id
op_eq
id|PMAC_TYPE_PISMO
op_logical_or
id|pmac_mb.model_id
op_eq
id|PMAC_TYPE_TITANIUM
)paren
(brace
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
id|MACIO_OUT8
c_func
(paren
id|KL_GPIO_SOUND_POWER
comma
id|KEYLARGO_GPIO_OUTPUT_ENABLE
op_or
id|KEYLARGO_GPIO_OUTOUT_DATA
)paren
suffix:semicolon
r_else
id|MACIO_OUT8
c_func
(paren
id|KL_GPIO_SOUND_POWER
comma
id|KEYLARGO_GPIO_OUTPUT_ENABLE
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
id|KL_GPIO_SOUND_POWER
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|core99_airport_enable
id|core99_airport_enable
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_struct
id|macio_chip
op_star
id|macio
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|state
suffix:semicolon
id|macio
op_assign
id|macio_find
c_func
(paren
id|node
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|macio
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Hint: we allow passing of macio itself for the sake of the&n;&t; * sleep code&n;&t; */
r_if
c_cond
(paren
id|node
op_ne
id|macio-&gt;of_node
op_logical_and
(paren
op_logical_neg
id|node-&gt;parent
op_logical_or
id|node-&gt;parent
op_ne
id|macio-&gt;of_node
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|state
op_assign
(paren
id|macio-&gt;flags
op_amp
id|MACIO_FLAG_AIRPORT_ON
)paren
op_ne
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|value
op_eq
id|state
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
(brace
multiline_comment|/* This code is a reproduction of OF enable-cardslot&n;&t;&t; * and init-wireless methods, slightly hacked until&n;&t;&t; * I got it working.&n;&t;&t; */
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|KEYLARGO_GPIO_0
op_plus
l_int|0xf
comma
l_int|5
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
id|KEYLARGO_GPIO_0
op_plus
l_int|0xf
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|KEYLARGO_GPIO_0
op_plus
l_int|0xf
comma
l_int|4
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
id|KEYLARGO_GPIO_0
op_plus
l_int|0xf
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_BIC
c_func
(paren
id|KEYLARGO_FCR2
comma
id|KL2_CARDSEL_16
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR2
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|KEYLARGO_GPIO_EXTINT_0
op_plus
l_int|0xb
comma
l_int|0
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
id|KEYLARGO_GPIO_EXTINT_0
op_plus
l_int|0xb
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|KEYLARGO_GPIO_EXTINT_0
op_plus
l_int|0xa
comma
l_int|0x28
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
id|KEYLARGO_GPIO_EXTINT_0
op_plus
l_int|0xa
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|KEYLARGO_GPIO_EXTINT_0
op_plus
l_int|0xd
comma
l_int|0x28
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
id|KEYLARGO_GPIO_EXTINT_0
op_plus
l_int|0xd
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|KEYLARGO_GPIO_0
op_plus
l_int|0xd
comma
l_int|0x28
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
id|KEYLARGO_GPIO_0
op_plus
l_int|0xd
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|KEYLARGO_GPIO_0
op_plus
l_int|0xe
comma
l_int|0x28
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
id|KEYLARGO_GPIO_0
op_plus
l_int|0xe
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|MACIO_OUT32
c_func
(paren
l_int|0x1c000
comma
l_int|0
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
l_int|0x1a3e0
comma
l_int|0x41
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
l_int|0x1a3e0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_BIS
c_func
(paren
id|KEYLARGO_FCR2
comma
id|KL2_CARDSEL_16
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR2
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|macio-&gt;flags
op_or_assign
id|MACIO_FLAG_AIRPORT_ON
suffix:semicolon
)brace
r_else
(brace
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_BIC
c_func
(paren
id|KEYLARGO_FCR2
comma
id|KL2_CARDSEL_16
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR2
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|KL_GPIO_AIRPORT_0
comma
l_int|0
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|KL_GPIO_AIRPORT_1
comma
l_int|0
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|KL_GPIO_AIRPORT_2
comma
l_int|0
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|KL_GPIO_AIRPORT_3
comma
l_int|0
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|KL_GPIO_AIRPORT_4
comma
l_int|0
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
id|KL_GPIO_AIRPORT_4
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|macio-&gt;flags
op_and_assign
op_complement
id|MACIO_FLAG_AIRPORT_ON
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SMP
r_static
r_int
id|__pmac
DECL|function|core99_reset_cpu
id|core99_reset_cpu
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_const
r_int
id|reset_lines
(braket
)braket
op_assign
(brace
id|KL_GPIO_RESET_CPU0
comma
id|KL_GPIO_RESET_CPU1
comma
id|KL_GPIO_RESET_CPU2
comma
id|KL_GPIO_RESET_CPU3
)brace
suffix:semicolon
r_int
id|reset_io
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|macio_chip
op_star
id|macio
suffix:semicolon
id|macio
op_assign
op_amp
id|macio_chips
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|macio-&gt;type
op_ne
id|macio_keylargo
op_logical_and
id|macio-&gt;type
op_ne
id|macio_pangea
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|param
OG
l_int|3
op_logical_or
id|param
OL
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|reset_io
op_assign
id|reset_lines
(braket
id|param
)braket
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|reset_io
comma
id|KEYLARGO_GPIO_OUTPUT_ENABLE
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
id|reset_io
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|reset_io
comma
id|KEYLARGO_GPIO_OUTPUT_ENABLE
op_or
id|KEYLARGO_GPIO_OUTOUT_DATA
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
id|reset_io
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_SMP */
r_static
r_int
id|__pmac
DECL|function|core99_usb_enable
id|core99_usb_enable
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_struct
id|macio_chip
op_star
id|macio
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_char
op_star
id|prop
suffix:semicolon
r_int
id|number
suffix:semicolon
id|u32
id|reg
suffix:semicolon
id|macio
op_assign
op_amp
id|macio_chips
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|macio-&gt;type
op_ne
id|macio_keylargo
op_logical_and
id|macio-&gt;type
op_ne
id|macio_pangea
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|prop
op_assign
(paren
r_char
op_star
)paren
id|get_property
c_func
(paren
id|node
comma
l_string|&quot;AAPL,clock-id&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|prop
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|prop
comma
l_string|&quot;usb0u048&quot;
comma
id|strlen
c_func
(paren
l_string|&quot;usb0u048&quot;
)paren
)paren
op_eq
l_int|0
)paren
id|number
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|prop
comma
l_string|&quot;usb1u148&quot;
comma
id|strlen
c_func
(paren
l_string|&quot;usb1u148&quot;
)paren
)paren
op_eq
l_int|0
)paren
id|number
op_assign
l_int|2
suffix:semicolon
r_else
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Sorry for the brute-force locking, but this is only used during&n;&t; * sleep and the timing seem to be critical&n;&t; */
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
(brace
multiline_comment|/* Turn ON */
r_if
c_cond
(paren
id|number
op_eq
l_int|0
)paren
(brace
id|MACIO_BIC
c_func
(paren
id|KEYLARGO_FCR0
comma
(paren
id|KL0_USB0_PAD_SUSPEND0
op_or
id|KL0_USB0_PAD_SUSPEND1
)paren
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR0
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_BIS
c_func
(paren
id|KEYLARGO_FCR0
comma
id|KL0_USB0_CELL_ENABLE
)paren
suffix:semicolon
)brace
r_else
(brace
id|MACIO_BIC
c_func
(paren
id|KEYLARGO_FCR0
comma
(paren
id|KL0_USB1_PAD_SUSPEND0
op_or
id|KL0_USB1_PAD_SUSPEND1
)paren
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR0
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_BIS
c_func
(paren
id|KEYLARGO_FCR0
comma
id|KL0_USB1_CELL_ENABLE
)paren
suffix:semicolon
)brace
id|reg
op_assign
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR4
)paren
suffix:semicolon
id|reg
op_and_assign
op_complement
(paren
id|KL4_PORT_WAKEUP_ENABLE
c_func
(paren
id|number
)paren
op_or
id|KL4_PORT_RESUME_WAKE_EN
c_func
(paren
id|number
)paren
op_or
id|KL4_PORT_CONNECT_WAKE_EN
c_func
(paren
id|number
)paren
op_or
id|KL4_PORT_DISCONNECT_WAKE_EN
c_func
(paren
id|number
)paren
)paren
suffix:semicolon
id|reg
op_and_assign
op_complement
(paren
id|KL4_PORT_WAKEUP_ENABLE
c_func
(paren
id|number
op_plus
l_int|1
)paren
op_or
id|KL4_PORT_RESUME_WAKE_EN
c_func
(paren
id|number
op_plus
l_int|1
)paren
op_or
id|KL4_PORT_CONNECT_WAKE_EN
c_func
(paren
id|number
op_plus
l_int|1
)paren
op_or
id|KL4_PORT_DISCONNECT_WAKE_EN
c_func
(paren
id|number
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|MACIO_OUT32
c_func
(paren
id|KEYLARGO_FCR4
comma
id|reg
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR4
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Turn OFF */
id|reg
op_assign
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR4
)paren
suffix:semicolon
id|reg
op_or_assign
id|KL4_PORT_WAKEUP_ENABLE
c_func
(paren
id|number
)paren
op_or
id|KL4_PORT_RESUME_WAKE_EN
c_func
(paren
id|number
)paren
op_or
id|KL4_PORT_CONNECT_WAKE_EN
c_func
(paren
id|number
)paren
op_or
id|KL4_PORT_DISCONNECT_WAKE_EN
c_func
(paren
id|number
)paren
suffix:semicolon
id|reg
op_or_assign
id|KL4_PORT_WAKEUP_ENABLE
c_func
(paren
id|number
op_plus
l_int|1
)paren
op_or
id|KL4_PORT_RESUME_WAKE_EN
c_func
(paren
id|number
op_plus
l_int|1
)paren
op_or
id|KL4_PORT_CONNECT_WAKE_EN
c_func
(paren
id|number
op_plus
l_int|1
)paren
op_or
id|KL4_PORT_DISCONNECT_WAKE_EN
c_func
(paren
id|number
op_plus
l_int|1
)paren
suffix:semicolon
id|MACIO_OUT32
c_func
(paren
id|KEYLARGO_FCR4
comma
id|reg
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR4
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|number
op_eq
l_int|0
)paren
(brace
id|MACIO_BIC
c_func
(paren
id|KEYLARGO_FCR0
comma
id|KL0_USB0_CELL_ENABLE
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|MACIO_BIS
c_func
(paren
id|KEYLARGO_FCR0
comma
(paren
id|KL0_USB0_PAD_SUSPEND0
op_or
id|KL0_USB0_PAD_SUSPEND1
)paren
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR0
)paren
suffix:semicolon
)brace
r_else
(brace
id|MACIO_BIC
c_func
(paren
id|KEYLARGO_FCR0
comma
id|KL0_USB1_CELL_ENABLE
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|MACIO_BIS
c_func
(paren
id|KEYLARGO_FCR0
comma
(paren
id|KL0_USB1_PAD_SUSPEND0
op_or
id|KL0_USB1_PAD_SUSPEND1
)paren
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR0
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|core99_firewire_enable
id|core99_firewire_enable
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|macio_chip
op_star
id|macio
suffix:semicolon
id|macio
op_assign
op_amp
id|macio_chips
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|macio-&gt;type
op_ne
id|macio_keylargo
op_logical_and
id|macio-&gt;type
op_ne
id|macio_pangea
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|macio-&gt;flags
op_amp
id|MACIO_FLAG_FW_SUPPORTED
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
(brace
id|UN_BIS
c_func
(paren
id|UNI_N_CLOCK_CNTL
comma
id|UNI_N_CLOCK_CNTL_FW
)paren
suffix:semicolon
(paren
r_void
)paren
id|UN_IN
c_func
(paren
id|UNI_N_CLOCK_CNTL
)paren
suffix:semicolon
)brace
r_else
(brace
id|UN_BIC
c_func
(paren
id|UNI_N_CLOCK_CNTL
comma
id|UNI_N_CLOCK_CNTL_FW
)paren
suffix:semicolon
(paren
r_void
)paren
id|UN_IN
c_func
(paren
id|UNI_N_CLOCK_CNTL
)paren
suffix:semicolon
)brace
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|core99_firewire_cable_power
id|core99_firewire_cable_power
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|macio_chip
op_star
id|macio
suffix:semicolon
multiline_comment|/* Trick: we allow NULL node */
r_if
c_cond
(paren
(paren
id|pmac_mb.board_flags
op_amp
id|PMAC_MB_HAS_FW_POWER
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|macio
op_assign
op_amp
id|macio_chips
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|macio-&gt;type
op_ne
id|macio_keylargo
op_logical_and
id|macio-&gt;type
op_ne
id|macio_pangea
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|macio-&gt;flags
op_amp
id|MACIO_FLAG_FW_SUPPORTED
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
(brace
id|MACIO_OUT8
c_func
(paren
id|KL_GPIO_FW_CABLE_POWER
comma
l_int|0
)paren
suffix:semicolon
id|MACIO_IN8
c_func
(paren
id|KL_GPIO_FW_CABLE_POWER
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_else
(brace
id|MACIO_OUT8
c_func
(paren
id|KL_GPIO_FW_CABLE_POWER
comma
l_int|4
)paren
suffix:semicolon
id|MACIO_IN8
c_func
(paren
id|KL_GPIO_FW_CABLE_POWER
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|core99_read_gpio
id|core99_read_gpio
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_struct
id|macio_chip
op_star
id|macio
op_assign
op_amp
id|macio_chips
(braket
l_int|0
)braket
suffix:semicolon
r_return
id|MACIO_IN8
c_func
(paren
id|param
)paren
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|core99_write_gpio
id|core99_write_gpio
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_struct
id|macio_chip
op_star
id|macio
op_assign
op_amp
id|macio_chips
(braket
l_int|0
)braket
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|param
comma
(paren
id|u8
)paren
(paren
id|value
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|__pmac
DECL|function|keylargo_shutdown
id|keylargo_shutdown
c_func
(paren
r_struct
id|macio_chip
op_star
id|macio
comma
r_int
id|restart
)paren
(brace
id|u32
id|temp
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|MACIO_BIS
c_func
(paren
id|KEYLARGO_FCR0
comma
id|KL0_USB_REF_SUSPEND
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR0
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|MACIO_BIC
c_func
(paren
id|KEYLARGO_FCR0
comma
id|KL0_SCCA_ENABLE
op_or
id|KL0_SCCB_ENABLE
op_or
id|KL0_SCC_CELL_ENABLE
op_or
id|KL0_IRDA_ENABLE
op_or
id|KL0_IRDA_CLK32_ENABLE
op_or
id|KL0_IRDA_CLK19_ENABLE
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|MACIO_BIC
c_func
(paren
id|KEYLARGO_MBCR
comma
id|KL_MBCR_MB0_DEV_MASK
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_MBCR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|MACIO_BIC
c_func
(paren
id|KEYLARGO_FCR1
comma
id|KL1_AUDIO_SEL_22MCLK
op_or
id|KL1_AUDIO_CLK_ENABLE_BIT
op_or
id|KL1_AUDIO_CLK_OUT_ENABLE
op_or
id|KL1_AUDIO_CELL_ENABLE
op_or
id|KL1_I2S0_CELL_ENABLE
op_or
id|KL1_I2S0_CLK_ENABLE_BIT
op_or
id|KL1_I2S0_ENABLE
op_or
id|KL1_I2S1_CELL_ENABLE
op_or
id|KL1_I2S1_CLK_ENABLE_BIT
op_or
id|KL1_I2S1_ENABLE
op_or
id|KL1_EIDE0_ENABLE
op_or
id|KL1_EIDE0_RESET_N
op_or
id|KL1_EIDE1_ENABLE
op_or
id|KL1_EIDE1_RESET_N
op_or
id|KL1_UIDE_ENABLE
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR1
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|MACIO_BIS
c_func
(paren
id|KEYLARGO_FCR2
comma
id|KL2_ALT_DATA_OUT
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|MACIO_BIC
c_func
(paren
id|KEYLARGO_FCR2
comma
id|KL2_IOBUS_ENABLE
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|temp
op_assign
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|macio-&gt;rev
op_ge
l_int|2
)paren
id|temp
op_or_assign
(paren
id|KL3_SHUTDOWN_PLL2X
op_or
id|KL3_SHUTDOWN_PLL_TOTAL
)paren
suffix:semicolon
id|temp
op_or_assign
id|KL3_SHUTDOWN_PLLKW6
op_or
id|KL3_SHUTDOWN_PLLKW4
op_or
id|KL3_SHUTDOWN_PLLKW35
op_or
id|KL3_SHUTDOWN_PLLKW12
suffix:semicolon
id|temp
op_and_assign
op_complement
(paren
id|KL3_CLK66_ENABLE
op_or
id|KL3_CLK49_ENABLE
op_or
id|KL3_CLK45_ENABLE
op_or
id|KL3_CLK31_ENABLE
op_or
id|KL3_TIMER_CLK18_ENABLE
op_or
id|KL3_I2S1_CLK18_ENABLE
op_or
id|KL3_I2S0_CLK18_ENABLE
op_or
id|KL3_VIA_CLK16_ENABLE
)paren
suffix:semicolon
id|MACIO_OUT32
c_func
(paren
id|KEYLARGO_FCR3
comma
id|temp
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR3
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_static
r_void
id|__pmac
DECL|function|pangea_shutdown
id|pangea_shutdown
c_func
(paren
r_struct
id|macio_chip
op_star
id|macio
comma
r_int
id|restart
)paren
(brace
id|u32
id|temp
suffix:semicolon
id|MACIO_BIC
c_func
(paren
id|KEYLARGO_FCR0
comma
id|KL0_SCCA_ENABLE
op_or
id|KL0_SCCB_ENABLE
op_or
id|KL0_SCC_CELL_ENABLE
op_or
id|KL0_USB0_CELL_ENABLE
op_or
id|KL0_USB1_CELL_ENABLE
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|MACIO_BIC
c_func
(paren
id|KEYLARGO_MBCR
comma
id|KL_MBCR_MB0_DEV_MASK
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_MBCR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|MACIO_BIC
c_func
(paren
id|KEYLARGO_FCR1
comma
id|KL1_AUDIO_SEL_22MCLK
op_or
id|KL1_AUDIO_CLK_ENABLE_BIT
op_or
id|KL1_AUDIO_CLK_OUT_ENABLE
op_or
id|KL1_AUDIO_CELL_ENABLE
op_or
id|KL1_I2S0_CELL_ENABLE
op_or
id|KL1_I2S0_CLK_ENABLE_BIT
op_or
id|KL1_I2S0_ENABLE
op_or
id|KL1_I2S1_CELL_ENABLE
op_or
id|KL1_I2S1_CLK_ENABLE_BIT
op_or
id|KL1_I2S1_ENABLE
op_or
id|KL1_UIDE_ENABLE
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR1
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|MACIO_BIS
c_func
(paren
id|KEYLARGO_FCR2
comma
id|KL2_ALT_DATA_OUT
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|temp
op_assign
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR3
)paren
suffix:semicolon
id|temp
op_or_assign
id|KL3_SHUTDOWN_PLLKW6
op_or
id|KL3_SHUTDOWN_PLLKW4
op_or
id|KL3_SHUTDOWN_PLLKW35
suffix:semicolon
id|temp
op_and_assign
op_complement
(paren
id|KL3_CLK49_ENABLE
op_or
id|KL3_CLK45_ENABLE
op_or
id|KL3_CLK31_ENABLE
op_or
id|KL3_TIMER_CLK18_ENABLE
op_or
id|KL3_I2S1_CLK18_ENABLE
op_or
id|KL3_I2S0_CLK18_ENABLE
op_or
id|KL3_VIA_CLK16_ENABLE
)paren
suffix:semicolon
id|MACIO_OUT32
c_func
(paren
id|KEYLARGO_FCR3
comma
id|temp
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR3
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|core99_sleep
id|core99_sleep
c_func
(paren
r_void
)paren
(brace
r_struct
id|macio_chip
op_star
id|macio
suffix:semicolon
r_int
id|i
suffix:semicolon
id|macio
op_assign
op_amp
id|macio_chips
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|macio-&gt;type
op_ne
id|macio_keylargo
op_logical_and
id|macio-&gt;type
op_ne
id|macio_pangea
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* We power off the wireless slot in case it was not done&n;&t; * by the driver. We don&squot;t power it on automatically however&n;&t; */
r_if
c_cond
(paren
id|macio-&gt;flags
op_amp
id|MACIO_FLAG_AIRPORT_ON
)paren
id|core99_airport_enable
c_func
(paren
id|macio-&gt;of_node
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* We power off the FW cable. Should be done by the driver... */
r_if
c_cond
(paren
id|macio-&gt;flags
op_amp
id|MACIO_FLAG_FW_SUPPORTED
)paren
(brace
id|core99_firewire_enable
c_func
(paren
l_int|NULL
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|core99_firewire_cable_power
c_func
(paren
l_int|NULL
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* We make sure int. modem is off (in case driver lost it) */
id|core99_modem_enable
c_func
(paren
id|macio-&gt;of_node
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* We make sure the sound is off as well */
id|core99_sound_chip_enable
c_func
(paren
id|macio-&gt;of_node
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Save various bits of KeyLargo&n;&t; */
multiline_comment|/* Save the state of the various GPIOs */
id|save_gpio_levels
(braket
l_int|0
)braket
op_assign
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_GPIO_LEVELS0
)paren
suffix:semicolon
id|save_gpio_levels
(braket
l_int|1
)braket
op_assign
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_GPIO_LEVELS1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|KEYLARGO_GPIO_EXTINT_CNT
suffix:semicolon
id|i
op_increment
)paren
id|save_gpio_extint
(braket
id|i
)braket
op_assign
id|MACIO_IN8
c_func
(paren
id|KEYLARGO_GPIO_EXTINT_0
op_plus
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|KEYLARGO_GPIO_CNT
suffix:semicolon
id|i
op_increment
)paren
id|save_gpio_normal
(braket
id|i
)braket
op_assign
id|MACIO_IN8
c_func
(paren
id|KEYLARGO_GPIO_0
op_plus
id|i
)paren
suffix:semicolon
multiline_comment|/* Save the FCRs */
id|save_mbcr
op_assign
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_MBCR
)paren
suffix:semicolon
id|save_fcr
(braket
l_int|0
)braket
op_assign
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR0
)paren
suffix:semicolon
id|save_fcr
(braket
l_int|1
)braket
op_assign
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR1
)paren
suffix:semicolon
id|save_fcr
(braket
l_int|2
)braket
op_assign
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR2
)paren
suffix:semicolon
id|save_fcr
(braket
l_int|3
)braket
op_assign
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR3
)paren
suffix:semicolon
id|save_fcr
(braket
l_int|4
)braket
op_assign
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR4
)paren
suffix:semicolon
multiline_comment|/* Save state &amp; config of DBDMA channels */
id|dbdma_save
c_func
(paren
id|macio
comma
id|save_dbdma
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Turn off as much as we can&n;&t; */
r_if
c_cond
(paren
id|macio-&gt;type
op_eq
id|macio_pangea
)paren
id|pangea_shutdown
c_func
(paren
id|macio
comma
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|macio-&gt;type
op_eq
id|macio_keylargo
)paren
id|keylargo_shutdown
c_func
(paren
id|macio
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Put the host bridge to sleep&n;&t; */
id|save_unin_clock_ctl
op_assign
id|UN_IN
c_func
(paren
id|UNI_N_CLOCK_CNTL
)paren
suffix:semicolon
id|UN_OUT
c_func
(paren
id|UNI_N_CLOCK_CNTL
comma
id|save_unin_clock_ctl
op_amp
op_complement
(paren
id|UNI_N_CLOCK_CNTL_GMAC
op_or
id|UNI_N_CLOCK_CNTL_FW
multiline_comment|/*|UNI_N_CLOCK_CNTL_PCI*/
)paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|UN_OUT
c_func
(paren
id|UNI_N_HWINIT_STATE
comma
id|UNI_N_HWINIT_STATE_SLEEPING
)paren
suffix:semicolon
id|UN_OUT
c_func
(paren
id|UNI_N_POWER_MGT
comma
id|UNI_N_POWER_MGT_SLEEP
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * FIXME: A bit of black magic with OpenPIC (don&squot;t ask me why)&n;&t; */
r_if
c_cond
(paren
id|pmac_mb.model_id
op_eq
id|PMAC_TYPE_SAWTOOTH
)paren
(brace
id|MACIO_BIS
c_func
(paren
l_int|0x506e0
comma
l_int|0x00400000
)paren
suffix:semicolon
id|MACIO_BIS
c_func
(paren
l_int|0x506e0
comma
l_int|0x80000000
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|core99_wake_up
id|core99_wake_up
c_func
(paren
r_void
)paren
(brace
r_struct
id|macio_chip
op_star
id|macio
suffix:semicolon
r_int
id|i
suffix:semicolon
id|macio
op_assign
op_amp
id|macio_chips
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|macio-&gt;type
op_ne
id|macio_keylargo
op_logical_and
id|macio-&gt;type
op_ne
id|macio_pangea
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/*&n;&t; * Wakeup the host bridge&n;&t; */
id|UN_OUT
c_func
(paren
id|UNI_N_POWER_MGT
comma
id|UNI_N_POWER_MGT_NORMAL
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|UN_OUT
c_func
(paren
id|UNI_N_HWINIT_STATE
comma
id|UNI_N_HWINIT_STATE_RUNNING
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Restore KeyLargo&n;&t; */
id|MACIO_OUT32
c_func
(paren
id|KEYLARGO_MBCR
comma
id|save_mbcr
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_MBCR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|MACIO_OUT32
c_func
(paren
id|KEYLARGO_FCR0
comma
id|save_fcr
(braket
l_int|0
)braket
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|MACIO_OUT32
c_func
(paren
id|KEYLARGO_FCR1
comma
id|save_fcr
(braket
l_int|1
)braket
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR1
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|MACIO_OUT32
c_func
(paren
id|KEYLARGO_FCR2
comma
id|save_fcr
(braket
l_int|2
)braket
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR2
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|MACIO_OUT32
c_func
(paren
id|KEYLARGO_FCR3
comma
id|save_fcr
(braket
l_int|3
)braket
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR3
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|MACIO_OUT32
c_func
(paren
id|KEYLARGO_FCR4
comma
id|save_fcr
(braket
l_int|4
)braket
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR4
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|dbdma_restore
c_func
(paren
id|macio
comma
id|save_dbdma
)paren
suffix:semicolon
id|MACIO_OUT32
c_func
(paren
id|KEYLARGO_GPIO_LEVELS0
comma
id|save_gpio_levels
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|MACIO_OUT32
c_func
(paren
id|KEYLARGO_GPIO_LEVELS1
comma
id|save_gpio_levels
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|KEYLARGO_GPIO_EXTINT_CNT
suffix:semicolon
id|i
op_increment
)paren
id|MACIO_OUT8
c_func
(paren
id|KEYLARGO_GPIO_EXTINT_0
op_plus
id|i
comma
id|save_gpio_extint
(braket
id|i
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|KEYLARGO_GPIO_CNT
suffix:semicolon
id|i
op_increment
)paren
id|MACIO_OUT8
c_func
(paren
id|KEYLARGO_GPIO_0
op_plus
id|i
comma
id|save_gpio_normal
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* FIXME more black magic with OpenPIC ... */
r_if
c_cond
(paren
id|pmac_mb.model_id
op_eq
id|PMAC_TYPE_SAWTOOTH
)paren
(brace
id|MACIO_BIC
c_func
(paren
l_int|0x506e0
comma
l_int|0x00400000
)paren
suffix:semicolon
id|MACIO_BIC
c_func
(paren
l_int|0x506e0
comma
l_int|0x80000000
)paren
suffix:semicolon
)brace
id|UN_OUT
c_func
(paren
id|UNI_N_CLOCK_CNTL
comma
id|save_unin_clock_ctl
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|core99_sleep_state
id|core99_sleep_state
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_if
c_cond
(paren
(paren
id|pmac_mb.board_flags
op_amp
id|PMAC_MB_CAN_SLEEP
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|value
op_eq
l_int|1
)paren
r_return
id|core99_sleep
c_func
(paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|value
op_eq
l_int|0
)paren
r_return
id|core99_wake_up
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|pangea_modem_enable
id|pangea_modem_enable
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_struct
id|macio_chip
op_star
id|macio
suffix:semicolon
id|u8
id|gpio
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|macio
op_assign
id|macio_find
c_func
(paren
id|node
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|macio
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|gpio
op_assign
id|MACIO_IN8
c_func
(paren
id|KL_GPIO_MODEM_RESET
)paren
suffix:semicolon
id|gpio
op_or_assign
id|KEYLARGO_GPIO_OUTPUT_ENABLE
suffix:semicolon
id|gpio
op_and_assign
op_complement
id|KEYLARGO_GPIO_OUTOUT_DATA
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|value
)paren
(brace
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|KL_GPIO_MODEM_RESET
comma
id|gpio
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
id|KL_GPIO_MODEM_RESET
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
)brace
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
(brace
id|MACIO_OUT8
c_func
(paren
id|KL_GPIO_MODEM_POWER
comma
id|KEYLARGO_GPIO_OUTPUT_ENABLE
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN32
c_func
(paren
id|KEYLARGO_FCR2
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
)brace
r_else
(brace
id|MACIO_OUT8
c_func
(paren
id|KL_GPIO_MODEM_POWER
comma
id|KEYLARGO_GPIO_OUTPUT_ENABLE
op_or
id|KEYLARGO_GPIO_OUTOUT_DATA
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|value
)paren
(brace
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|KL_GPIO_MODEM_RESET
comma
id|gpio
op_or
id|KEYLARGO_GPIO_OUTOUT_DATA
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
id|KL_GPIO_MODEM_RESET
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|KL_GPIO_MODEM_RESET
comma
id|gpio
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
id|KL_GPIO_MODEM_RESET
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
id|LOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|MACIO_OUT8
c_func
(paren
id|KL_GPIO_MODEM_RESET
comma
id|gpio
op_or
id|KEYLARGO_GPIO_OUTOUT_DATA
)paren
suffix:semicolon
(paren
r_void
)paren
id|MACIO_IN8
c_func
(paren
id|KL_GPIO_MODEM_RESET
)paren
suffix:semicolon
id|UNLOCK
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|generic_get_mb_info
id|generic_get_mb_info
c_func
(paren
r_struct
id|device_node
op_star
id|node
comma
r_int
id|param
comma
r_int
id|value
)paren
(brace
r_switch
c_cond
(paren
id|param
)paren
(brace
r_case
id|PMAC_MB_INFO_MODEL
suffix:colon
r_return
id|pmac_mb.model_id
suffix:semicolon
r_case
id|PMAC_MB_INFO_FLAGS
suffix:colon
r_return
id|pmac_mb.board_flags
suffix:semicolon
r_case
id|PMAC_MB_INFO_NAME
suffix:colon
multiline_comment|/* hack hack hack... but should work */
op_star
(paren
(paren
r_const
r_char
op_star
op_star
)paren
id|value
)paren
op_assign
id|pmac_mb.model_name
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n; * Table definitions&n; */
multiline_comment|/* Used on any machine&n; */
DECL|variable|__pmacdata
r_static
r_struct
id|feature_table_entry
id|any_features
(braket
)braket
id|__pmacdata
op_assign
(brace
(brace
id|PMAC_FTR_GET_MB_INFO
comma
id|generic_get_mb_info
)brace
comma
(brace
l_int|0
comma
l_int|NULL
)brace
)brace
suffix:semicolon
multiline_comment|/* OHare based motherboards. Currently, we only use these on the&n; * 2400,3400 and 3500 series powerbooks. Some older desktops seem&n; * to have issues with turning on/off those asic cells&n; */
DECL|variable|__pmacdata
r_static
r_struct
id|feature_table_entry
id|ohare_features
(braket
)braket
id|__pmacdata
op_assign
(brace
(brace
id|PMAC_FTR_SCC_ENABLE
comma
id|ohare_htw_scc_enable
)brace
comma
(brace
id|PMAC_FTR_SWIM3_ENABLE
comma
id|ohare_floppy_enable
)brace
comma
(brace
id|PMAC_FTR_MESH_ENABLE
comma
id|ohare_mesh_enable
)brace
comma
(brace
id|PMAC_FTR_IDE_ENABLE
comma
id|ohare_ide_enable
)brace
comma
(brace
id|PMAC_FTR_IDE_RESET
comma
id|ohare_ide_reset
)brace
comma
(brace
id|PMAC_FTR_SLEEP_STATE
comma
id|ohare_sleep_state
)brace
comma
(brace
l_int|0
comma
l_int|NULL
)brace
)brace
suffix:semicolon
multiline_comment|/* Heathrow desktop machines (Beige G3).&n; * Separated as some features couldn&squot;t be properly tested&n; * and the serial port control bits appear to confuse it.&n; */
DECL|variable|__pmacdata
r_static
r_struct
id|feature_table_entry
id|heathrow_desktop_features
(braket
)braket
id|__pmacdata
op_assign
(brace
(brace
id|PMAC_FTR_SWIM3_ENABLE
comma
id|heathrow_floppy_enable
)brace
comma
(brace
id|PMAC_FTR_MESH_ENABLE
comma
id|heathrow_mesh_enable
)brace
comma
(brace
id|PMAC_FTR_IDE_ENABLE
comma
id|heathrow_ide_enable
)brace
comma
(brace
id|PMAC_FTR_IDE_RESET
comma
id|heathrow_ide_reset
)brace
comma
(brace
id|PMAC_FTR_BMAC_ENABLE
comma
id|heathrow_bmac_enable
)brace
comma
(brace
l_int|0
comma
l_int|NULL
)brace
)brace
suffix:semicolon
multiline_comment|/* Heathrow based laptop, that is the Wallstreet and mainstreet&n; * powerbooks.&n; */
DECL|variable|__pmacdata
r_static
r_struct
id|feature_table_entry
id|heathrow_laptop_features
(braket
)braket
id|__pmacdata
op_assign
(brace
(brace
id|PMAC_FTR_SCC_ENABLE
comma
id|ohare_htw_scc_enable
)brace
comma
(brace
id|PMAC_FTR_MODEM_ENABLE
comma
id|heathrow_modem_enable
)brace
comma
(brace
id|PMAC_FTR_SWIM3_ENABLE
comma
id|heathrow_floppy_enable
)brace
comma
(brace
id|PMAC_FTR_MESH_ENABLE
comma
id|heathrow_mesh_enable
)brace
comma
(brace
id|PMAC_FTR_IDE_ENABLE
comma
id|heathrow_ide_enable
)brace
comma
(brace
id|PMAC_FTR_IDE_RESET
comma
id|heathrow_ide_reset
)brace
comma
(brace
id|PMAC_FTR_BMAC_ENABLE
comma
id|heathrow_bmac_enable
)brace
comma
(brace
id|PMAC_FTR_SOUND_CHIP_ENABLE
comma
id|heathrow_sound_enable
)brace
comma
(brace
id|PMAC_FTR_SLEEP_STATE
comma
id|heathrow_sleep_state
)brace
comma
(brace
l_int|0
comma
l_int|NULL
)brace
)brace
suffix:semicolon
multiline_comment|/* Paddington based machines&n; * The lombard (101) powerbook, first iMac models, B&amp;W G3 and Yikes G4.&n; */
DECL|variable|__pmacdata
r_static
r_struct
id|feature_table_entry
id|paddington_features
(braket
)braket
id|__pmacdata
op_assign
(brace
(brace
id|PMAC_FTR_SCC_ENABLE
comma
id|ohare_htw_scc_enable
)brace
comma
(brace
id|PMAC_FTR_MODEM_ENABLE
comma
id|heathrow_modem_enable
)brace
comma
(brace
id|PMAC_FTR_SWIM3_ENABLE
comma
id|heathrow_floppy_enable
)brace
comma
(brace
id|PMAC_FTR_MESH_ENABLE
comma
id|heathrow_mesh_enable
)brace
comma
(brace
id|PMAC_FTR_IDE_ENABLE
comma
id|heathrow_ide_enable
)brace
comma
(brace
id|PMAC_FTR_IDE_RESET
comma
id|heathrow_ide_reset
)brace
comma
(brace
id|PMAC_FTR_BMAC_ENABLE
comma
id|heathrow_bmac_enable
)brace
comma
(brace
id|PMAC_FTR_SOUND_CHIP_ENABLE
comma
id|heathrow_sound_enable
)brace
comma
(brace
id|PMAC_FTR_SLEEP_STATE
comma
id|heathrow_sleep_state
)brace
comma
(brace
l_int|0
comma
l_int|NULL
)brace
)brace
suffix:semicolon
multiline_comment|/* Core99 &amp; MacRISC 2 machines (all machines released since the&n; * iBook (included), that is all AGP machines, except pangea&n; * chipset. The pangea chipset is the &quot;combo&quot; UniNorth/KeyLargo&n; * used on iBook2 &amp; iMac &quot;flow power&quot;.&n; */
DECL|variable|__pmacdata
r_static
r_struct
id|feature_table_entry
id|core99_features
(braket
)braket
id|__pmacdata
op_assign
(brace
(brace
id|PMAC_FTR_SCC_ENABLE
comma
id|core99_scc_enable
)brace
comma
(brace
id|PMAC_FTR_MODEM_ENABLE
comma
id|core99_modem_enable
)brace
comma
(brace
id|PMAC_FTR_IDE_ENABLE
comma
id|core99_ide_enable
)brace
comma
(brace
id|PMAC_FTR_IDE_RESET
comma
id|core99_ide_reset
)brace
comma
(brace
id|PMAC_FTR_GMAC_ENABLE
comma
id|core99_gmac_enable
)brace
comma
(brace
id|PMAC_FTR_GMAC_PHY_RESET
comma
id|core99_gmac_phy_reset
)brace
comma
(brace
id|PMAC_FTR_SOUND_CHIP_ENABLE
comma
id|core99_sound_chip_enable
)brace
comma
(brace
id|PMAC_FTR_AIRPORT_ENABLE
comma
id|core99_airport_enable
)brace
comma
(brace
id|PMAC_FTR_USB_ENABLE
comma
id|core99_usb_enable
)brace
comma
(brace
id|PMAC_FTR_1394_ENABLE
comma
id|core99_firewire_enable
)brace
comma
(brace
id|PMAC_FTR_1394_CABLE_POWER
comma
id|core99_firewire_cable_power
)brace
comma
(brace
id|PMAC_FTR_SLEEP_STATE
comma
id|core99_sleep_state
)brace
comma
macro_line|#ifdef CONFIG_SMP
(brace
id|PMAC_FTR_RESET_CPU
comma
id|core99_reset_cpu
)brace
comma
macro_line|#endif /* CONFIG_SMP */
(brace
id|PMAC_FTR_READ_GPIO
comma
id|core99_read_gpio
)brace
comma
(brace
id|PMAC_FTR_WRITE_GPIO
comma
id|core99_write_gpio
)brace
comma
(brace
l_int|0
comma
l_int|NULL
)brace
)brace
suffix:semicolon
multiline_comment|/* Pangea features&n; */
DECL|variable|__pmacdata
r_static
r_struct
id|feature_table_entry
id|pangea_features
(braket
)braket
id|__pmacdata
op_assign
(brace
(brace
id|PMAC_FTR_SCC_ENABLE
comma
id|core99_scc_enable
)brace
comma
(brace
id|PMAC_FTR_MODEM_ENABLE
comma
id|pangea_modem_enable
)brace
comma
(brace
id|PMAC_FTR_IDE_ENABLE
comma
id|core99_ide_enable
)brace
comma
(brace
id|PMAC_FTR_IDE_RESET
comma
id|core99_ide_reset
)brace
comma
(brace
id|PMAC_FTR_GMAC_ENABLE
comma
id|core99_gmac_enable
)brace
comma
(brace
id|PMAC_FTR_GMAC_PHY_RESET
comma
id|core99_gmac_phy_reset
)brace
comma
(brace
id|PMAC_FTR_SOUND_CHIP_ENABLE
comma
id|core99_sound_chip_enable
)brace
comma
(brace
id|PMAC_FTR_AIRPORT_ENABLE
comma
id|core99_airport_enable
)brace
comma
(brace
id|PMAC_FTR_USB_ENABLE
comma
id|core99_usb_enable
)brace
comma
(brace
id|PMAC_FTR_1394_ENABLE
comma
id|core99_firewire_enable
)brace
comma
(brace
id|PMAC_FTR_1394_CABLE_POWER
comma
id|core99_firewire_cable_power
)brace
comma
(brace
id|PMAC_FTR_SLEEP_STATE
comma
id|core99_sleep_state
)brace
comma
(brace
id|PMAC_FTR_READ_GPIO
comma
id|core99_read_gpio
)brace
comma
(brace
id|PMAC_FTR_WRITE_GPIO
comma
id|core99_write_gpio
)brace
comma
(brace
l_int|0
comma
l_int|NULL
)brace
)brace
suffix:semicolon
DECL|variable|__pmacdata
r_static
r_struct
id|pmac_mb_def
id|pmac_mb_defs
(braket
)braket
id|__pmacdata
op_assign
(brace
multiline_comment|/* Warning: ordering is important as some models may claim&n;&t; * beeing compatible with several types&n;&t; */
(brace
l_string|&quot;AAPL,8500&quot;
comma
l_string|&quot;PowerMac 8500/8600&quot;
comma
id|PMAC_TYPE_PSURGE
comma
l_int|NULL
comma
l_int|0
)brace
comma
(brace
l_string|&quot;AAPL,9500&quot;
comma
l_string|&quot;PowerMac 9500/9600&quot;
comma
id|PMAC_TYPE_PSURGE
comma
l_int|NULL
comma
l_int|0
)brace
comma
(brace
l_string|&quot;AAPL,7500&quot;
comma
l_string|&quot;PowerMac 7500&quot;
comma
id|PMAC_TYPE_PSURGE
comma
l_int|NULL
comma
l_int|0
)brace
comma
(brace
l_string|&quot;AAPL,ShinerESB&quot;
comma
l_string|&quot;Apple Network Server&quot;
comma
id|PMAC_TYPE_ANS
comma
l_int|NULL
comma
l_int|0
)brace
comma
(brace
l_string|&quot;AAPL,e407&quot;
comma
l_string|&quot;Alchemy&quot;
comma
id|PMAC_TYPE_ALCHEMY
comma
l_int|NULL
comma
l_int|0
)brace
comma
(brace
l_string|&quot;AAPL,e411&quot;
comma
l_string|&quot;Gazelle&quot;
comma
id|PMAC_TYPE_GAZELLE
comma
l_int|NULL
comma
l_int|0
)brace
comma
(brace
l_string|&quot;AAPL,3400/2400&quot;
comma
l_string|&quot;PowerBook 3400&quot;
comma
id|PMAC_TYPE_HOOPER
comma
id|ohare_features
comma
id|PMAC_MB_CAN_SLEEP
)brace
comma
(brace
l_string|&quot;AAPL,3500&quot;
comma
l_string|&quot;PowerBook 3500&quot;
comma
id|PMAC_TYPE_KANGA
comma
id|ohare_features
comma
id|PMAC_MB_CAN_SLEEP
)brace
comma
(brace
l_string|&quot;AAPL,Gossamer&quot;
comma
l_string|&quot;PowerMac G3 (Gossamer)&quot;
comma
id|PMAC_TYPE_GOSSAMER
comma
id|heathrow_desktop_features
comma
l_int|0
)brace
comma
(brace
l_string|&quot;AAPL,PowerMac G3&quot;
comma
l_string|&quot;PowerMac G3 (Silk)&quot;
comma
id|PMAC_TYPE_SILK
comma
id|heathrow_desktop_features
comma
l_int|0
)brace
comma
(brace
l_string|&quot;AAPL,PowerBook1998&quot;
comma
l_string|&quot;PowerBook Wallstreet&quot;
comma
id|PMAC_TYPE_WALLSTREET
comma
id|heathrow_laptop_features
comma
id|PMAC_MB_CAN_SLEEP
)brace
comma
(brace
l_string|&quot;AAPL,PowerBook1,1&quot;
comma
l_string|&quot;PowerBook 101 (Lombard)&quot;
comma
id|PMAC_TYPE_101_PBOOK
comma
id|paddington_features
comma
id|PMAC_MB_CAN_SLEEP
)brace
comma
(brace
l_string|&quot;iMac,1&quot;
comma
l_string|&quot;iMac (first generation)&quot;
comma
id|PMAC_TYPE_ORIG_IMAC
comma
id|paddington_features
comma
l_int|0
)brace
comma
(brace
l_string|&quot;PowerMac4,1&quot;
comma
l_string|&quot;iMac &bslash;&quot;Flower Power&bslash;&quot;&quot;
comma
id|PMAC_TYPE_PANGEA_IMAC
comma
id|pangea_features
comma
id|PMAC_MB_CAN_SLEEP
)brace
comma
(brace
l_string|&quot;PowerBook4,2&quot;
comma
l_string|&quot;iBook 2 with 14&bslash;&quot; LCD&quot;
comma
id|PMAC_TYPE_IBOOK2
comma
id|pangea_features
comma
id|PMAC_MB_CAN_SLEEP
op_or
id|PMAC_MB_HAS_FW_POWER
)brace
comma
(brace
l_string|&quot;PowerBook4,1&quot;
comma
l_string|&quot;iBook 2&quot;
comma
id|PMAC_TYPE_IBOOK2
comma
id|pangea_features
comma
id|PMAC_MB_CAN_SLEEP
op_or
id|PMAC_MB_HAS_FW_POWER
)brace
comma
(brace
l_string|&quot;PowerMac4,2&quot;
comma
l_string|&quot;Flat panel iMac&quot;
comma
id|PMAC_TYPE_FLAT_PANEL_IMAC
comma
id|pangea_features
comma
id|PMAC_MB_CAN_SLEEP
)brace
comma
(brace
l_string|&quot;PowerMac1,1&quot;
comma
l_string|&quot;Blue&amp;White G3&quot;
comma
id|PMAC_TYPE_YOSEMITE
comma
id|paddington_features
comma
l_int|0
)brace
comma
(brace
l_string|&quot;PowerMac1,2&quot;
comma
l_string|&quot;PowerMac G4 PCI Graphics&quot;
comma
id|PMAC_TYPE_YIKES
comma
id|paddington_features
comma
l_int|0
)brace
comma
(brace
l_string|&quot;PowerBook2,1&quot;
comma
l_string|&quot;iBook (first generation)&quot;
comma
id|PMAC_TYPE_ORIG_IBOOK
comma
id|core99_features
comma
id|PMAC_MB_CAN_SLEEP
)brace
comma
(brace
l_string|&quot;PowerMac3,1&quot;
comma
l_string|&quot;PowerMac G4 AGP Graphics&quot;
comma
id|PMAC_TYPE_SAWTOOTH
comma
id|core99_features
comma
l_int|0
)brace
comma
(brace
l_string|&quot;PowerMac3,2&quot;
comma
l_string|&quot;PowerMac G4 AGP Graphics&quot;
comma
id|PMAC_TYPE_SAWTOOTH
comma
id|core99_features
comma
l_int|0
)brace
comma
(brace
l_string|&quot;PowerMac3,3&quot;
comma
l_string|&quot;PowerMac G4 AGP Graphics&quot;
comma
id|PMAC_TYPE_SAWTOOTH
comma
id|core99_features
comma
l_int|0
)brace
comma
(brace
l_string|&quot;PowerMac2,1&quot;
comma
l_string|&quot;iMac FireWire&quot;
comma
id|PMAC_TYPE_FW_IMAC
comma
id|core99_features
comma
id|PMAC_MB_CAN_SLEEP
)brace
comma
(brace
l_string|&quot;PowerMac2,2&quot;
comma
l_string|&quot;iMac FireWire&quot;
comma
id|PMAC_TYPE_FW_IMAC
comma
id|core99_features
comma
id|PMAC_MB_CAN_SLEEP
)brace
comma
(brace
l_string|&quot;PowerBook2,2&quot;
comma
l_string|&quot;iBook FireWire&quot;
comma
id|PMAC_TYPE_FW_IBOOK
comma
id|core99_features
comma
id|PMAC_MB_CAN_SLEEP
op_or
id|PMAC_MB_HAS_FW_POWER
)brace
comma
(brace
l_string|&quot;PowerMac5,1&quot;
comma
l_string|&quot;PowerMac G4 Cube&quot;
comma
id|PMAC_TYPE_CUBE
comma
id|core99_features
comma
)brace
comma
(brace
l_string|&quot;PowerMac3,4&quot;
comma
l_string|&quot;PowerMac G4 Silver&quot;
comma
id|PMAC_TYPE_QUICKSILVER
comma
id|core99_features
comma
l_int|0
)brace
comma
(brace
l_string|&quot;PowerMac3,5&quot;
comma
l_string|&quot;PowerMac G4 Silver&quot;
comma
id|PMAC_TYPE_QUICKSILVER
comma
id|core99_features
comma
l_int|0
)brace
comma
(brace
l_string|&quot;PowerBook3,1&quot;
comma
l_string|&quot;PowerBook Pismo&quot;
comma
id|PMAC_TYPE_PISMO
comma
id|core99_features
comma
id|PMAC_MB_CAN_SLEEP
op_or
id|PMAC_MB_HAS_FW_POWER
)brace
comma
(brace
l_string|&quot;PowerBook3,2&quot;
comma
l_string|&quot;PowerBook Titanium&quot;
comma
id|PMAC_TYPE_TITANIUM
comma
id|core99_features
comma
id|PMAC_MB_CAN_SLEEP
op_or
id|PMAC_MB_HAS_FW_POWER
)brace
comma
(brace
l_string|&quot;PowerBook3,3&quot;
comma
l_string|&quot;PowerBook Titanium II&quot;
comma
id|PMAC_TYPE_TITANIUM2
comma
id|core99_features
comma
id|PMAC_MB_CAN_SLEEP
op_or
id|PMAC_MB_HAS_FW_POWER
)brace
comma
(brace
l_string|&quot;PowerBook3,4&quot;
comma
l_string|&quot;PowerBook Titanium III&quot;
comma
id|PMAC_TYPE_TITANIUM3
comma
id|core99_features
comma
id|PMAC_MB_CAN_SLEEP
op_or
id|PMAC_MB_HAS_FW_POWER
)brace
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * The toplevel feature_call callback&n; */
r_int
id|__pmac
DECL|function|pmac_do_feature_call
id|pmac_do_feature_call
c_func
(paren
r_int
r_int
id|selector
comma
dot
dot
dot
)paren
(brace
r_struct
id|device_node
op_star
id|node
suffix:semicolon
r_int
id|param
comma
id|value
comma
id|i
suffix:semicolon
id|feature_call
id|func
op_assign
l_int|NULL
suffix:semicolon
id|va_list
id|args
suffix:semicolon
r_if
c_cond
(paren
id|pmac_mb.features
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|pmac_mb.features
(braket
id|i
)braket
dot
id|function
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|pmac_mb.features
(braket
id|i
)braket
dot
id|selector
op_eq
id|selector
)paren
(brace
id|func
op_assign
id|pmac_mb.features
(braket
id|i
)braket
dot
id|function
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|func
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|any_features
(braket
id|i
)braket
dot
id|function
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|any_features
(braket
id|i
)braket
dot
id|selector
op_eq
id|selector
)paren
(brace
id|func
op_assign
id|any_features
(braket
id|i
)braket
dot
id|function
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|func
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|va_start
c_func
(paren
id|args
comma
id|selector
)paren
suffix:semicolon
id|node
op_assign
(paren
r_struct
id|device_node
op_star
)paren
id|va_arg
c_func
(paren
id|args
comma
r_void
op_star
)paren
suffix:semicolon
id|param
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
)paren
suffix:semicolon
id|value
op_assign
id|va_arg
c_func
(paren
id|args
comma
r_int
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|args
)paren
suffix:semicolon
r_return
id|func
c_func
(paren
id|node
comma
id|param
comma
id|value
)paren
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|probe_motherboard
id|probe_motherboard
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|macio_chip
op_star
id|macio
op_assign
op_amp
id|macio_chips
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Lookup known motherboard type in device-tree */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_sizeof
(paren
id|pmac_mb_defs
)paren
op_div
r_sizeof
(paren
r_struct
id|pmac_mb_def
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|machine_is_compatible
c_func
(paren
id|pmac_mb_defs
(braket
id|i
)braket
dot
id|model_string
)paren
)paren
(brace
id|pmac_mb
op_assign
id|pmac_mb_defs
(braket
id|i
)braket
suffix:semicolon
r_goto
id|found
suffix:semicolon
)brace
)brace
multiline_comment|/* Fallback to selection depending on mac-io chip type */
r_switch
c_cond
(paren
id|macio-&gt;type
)paren
(brace
r_case
id|macio_grand_central
suffix:colon
id|pmac_mb.model_id
op_assign
id|PMAC_TYPE_PSURGE
suffix:semicolon
id|pmac_mb.model_name
op_assign
l_string|&quot;Unknown PowerSurge&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|macio_ohare
suffix:colon
id|pmac_mb.model_id
op_assign
id|PMAC_TYPE_UNKNOWN_OHARE
suffix:semicolon
id|pmac_mb.model_name
op_assign
l_string|&quot;Unknown OHare-based&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|macio_heathrow
suffix:colon
id|pmac_mb.model_id
op_assign
id|PMAC_TYPE_UNKNOWN_HEATHROW
suffix:semicolon
id|pmac_mb.model_name
op_assign
l_string|&quot;Unknown Heathrow-based&quot;
suffix:semicolon
id|pmac_mb.features
op_assign
id|heathrow_desktop_features
suffix:semicolon
r_break
suffix:semicolon
r_case
id|macio_paddington
suffix:colon
id|pmac_mb.model_id
op_assign
id|PMAC_TYPE_UNKNOWN_PADDINGTON
suffix:semicolon
id|pmac_mb.model_name
op_assign
l_string|&quot;Unknown Paddington-based&quot;
suffix:semicolon
id|pmac_mb.features
op_assign
id|paddington_features
suffix:semicolon
r_break
suffix:semicolon
r_case
id|macio_keylargo
suffix:colon
id|pmac_mb.model_id
op_assign
id|PMAC_TYPE_UNKNOWN_CORE99
suffix:semicolon
id|pmac_mb.model_name
op_assign
l_string|&quot;Unknown Keylargo-based&quot;
suffix:semicolon
id|pmac_mb.features
op_assign
id|core99_features
suffix:semicolon
r_break
suffix:semicolon
r_case
id|macio_pangea
suffix:colon
id|pmac_mb.model_id
op_assign
id|PMAC_TYPE_UNKNOWN_PANGEA
suffix:semicolon
id|pmac_mb.model_name
op_assign
l_string|&quot;Unknown Pangea-based&quot;
suffix:semicolon
id|pmac_mb.features
op_assign
id|pangea_features
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|found
suffix:colon
multiline_comment|/* Fixup Hooper vs. Comet */
r_if
c_cond
(paren
id|pmac_mb.model_id
op_eq
id|PMAC_TYPE_HOOPER
)paren
(brace
id|u32
op_star
id|mach_id_ptr
op_assign
(paren
id|u32
op_star
)paren
id|ioremap
c_func
(paren
l_int|0xf3000034
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mach_id_ptr
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Here, I used to disable the media-bay on comet. It&n;&t;&t; * appears this is wrong, the floppy connector is actually&n;&t;&t; * a kind of media-bay and works with the current driver.&n;&t;&t; */
r_if
c_cond
(paren
(paren
op_star
id|mach_id_ptr
)paren
op_amp
l_int|0x20000000UL
)paren
id|pmac_mb.model_id
op_assign
id|PMAC_TYPE_COMET
suffix:semicolon
id|iounmap
c_func
(paren
id|mach_id_ptr
)paren
suffix:semicolon
)brace
multiline_comment|/* Set default value of powersave_nap on machines that support it.&n;&t; * It appears that uninorth rev 3 has a problem with it, we don&squot;t&n;&t; * enable it on those. In theory, the flush-on-lock property is&n;&t; * supposed to be set when not supported, but I&squot;m not very confident&n;&t; * that all Apple OF revs did it properly, I do it the paranoid way.&n;&t; */
r_while
c_loop
(paren
id|uninorth_base
op_logical_and
id|uninorth_rev
OG
l_int|3
)paren
(brace
r_struct
id|device_node
op_star
id|np
op_assign
id|find_path_device
c_func
(paren
l_string|&quot;/cpus&quot;
)paren
suffix:semicolon
id|u32
id|pvr
op_assign
id|mfspr
c_func
(paren
id|PVR
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|np
op_logical_or
op_logical_neg
id|np-&gt;child
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Can&squot;t find CPU(s) in device tree !&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|np
op_assign
id|np-&gt;child
suffix:semicolon
multiline_comment|/* Nap mode not supported on SMP */
r_if
c_cond
(paren
id|np-&gt;sibling
)paren
r_break
suffix:semicolon
multiline_comment|/* Nap mode not supported if flush-on-lock property is present */
r_if
c_cond
(paren
id|get_property
c_func
(paren
id|np
comma
l_string|&quot;flush-on-lock&quot;
comma
l_int|NULL
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* Some 7450 may have problem with NAP mode too ... */
r_if
c_cond
(paren
(paren
(paren
id|pvr
op_rshift
l_int|16
)paren
op_eq
l_int|0x8000
)paren
op_logical_and
(paren
(paren
id|pvr
op_amp
l_int|0xffff
)paren
OL
l_int|0x0201
)paren
)paren
r_break
suffix:semicolon
id|powersave_nap
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Processor NAP mode on idle enabled.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PowerMac motherboard: %s&bslash;n&quot;
comma
id|pmac_mb.model_name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Initialize the Core99 UniNorth host bridge and memory controller&n; */
r_static
r_void
id|__init
DECL|function|probe_uninorth
id|probe_uninorth
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|actrl
suffix:semicolon
multiline_comment|/* Locate core99 Uni-N */
id|uninorth_node
op_assign
id|find_devices
c_func
(paren
l_string|&quot;uni-n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uninorth_node
op_logical_and
id|uninorth_node-&gt;n_addrs
OG
l_int|0
)paren
(brace
id|uninorth_base
op_assign
id|ioremap
c_func
(paren
id|uninorth_node-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
comma
l_int|0x1000
)paren
suffix:semicolon
id|uninorth_rev
op_assign
id|in_be32
c_func
(paren
id|UN_REG
c_func
(paren
id|UNI_N_VERSION
)paren
)paren
suffix:semicolon
)brace
r_else
id|uninorth_node
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uninorth_node
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Found Uninorth memory controller &amp; host bridge, revision: %d&bslash;n&quot;
comma
id|uninorth_rev
)paren
suffix:semicolon
multiline_comment|/* Set the arbitrer QAck delay according to what Apple does&n;&t; */
r_if
c_cond
(paren
id|uninorth_rev
OL
l_int|0x10
)paren
(brace
id|actrl
op_assign
id|UN_IN
c_func
(paren
id|UNI_N_ARB_CTRL
)paren
op_amp
op_complement
id|UNI_N_ARB_CTRL_QACK_DELAY_MASK
suffix:semicolon
id|actrl
op_or_assign
(paren
(paren
id|uninorth_rev
OL
l_int|3
)paren
ques
c_cond
id|UNI_N_ARB_CTRL_QACK_DELAY105
suffix:colon
id|UNI_N_ARB_CTRL_QACK_DELAY
)paren
op_lshift
id|UNI_N_ARB_CTRL_QACK_DELAY_SHIFT
suffix:semicolon
id|UN_OUT
c_func
(paren
id|UNI_N_ARB_CTRL
comma
id|actrl
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
id|__init
DECL|function|probe_one_macio
id|probe_one_macio
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_const
r_char
op_star
id|compat
comma
r_int
id|type
)paren
(brace
r_struct
id|device_node
op_star
id|node
suffix:semicolon
r_int
id|i
suffix:semicolon
r_volatile
id|u32
op_star
id|base
suffix:semicolon
id|u32
op_star
id|revp
suffix:semicolon
id|node
op_assign
id|find_devices
c_func
(paren
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
op_logical_or
op_logical_neg
id|node-&gt;n_addrs
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|compat
)paren
r_do
(brace
r_if
c_cond
(paren
id|device_is_compatible
c_func
(paren
id|node
comma
id|compat
)paren
)paren
r_break
suffix:semicolon
id|node
op_assign
id|node-&gt;next
suffix:semicolon
)brace
r_while
c_loop
(paren
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_MACIO_CHIPS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|macio_chips
(braket
id|i
)braket
dot
id|of_node
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|macio_chips
(braket
id|i
)braket
dot
id|of_node
op_eq
id|node
)paren
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ge
id|MAX_MACIO_CHIPS
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pmac_feature: Please increase MAX_MACIO_CHIPS !&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pmac_feature: %s skipped&bslash;n&quot;
comma
id|node-&gt;full_name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|base
op_assign
(paren
r_volatile
id|u32
op_star
)paren
id|ioremap
c_func
(paren
id|node-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
comma
id|node-&gt;addrs
(braket
l_int|0
)braket
dot
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|base
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pmac_feature: Can&squot;t map mac-io chip !&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|type
op_eq
id|macio_keylargo
)paren
(brace
id|u32
op_star
id|did
op_assign
(paren
id|u32
op_star
)paren
id|get_property
c_func
(paren
id|node
comma
l_string|&quot;device-id&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|did
op_eq
l_int|0x00000025
)paren
id|type
op_assign
id|macio_pangea
suffix:semicolon
)brace
id|macio_chips
(braket
id|i
)braket
dot
id|of_node
op_assign
id|node
suffix:semicolon
id|macio_chips
(braket
id|i
)braket
dot
id|type
op_assign
id|type
suffix:semicolon
id|macio_chips
(braket
id|i
)braket
dot
id|base
op_assign
id|base
suffix:semicolon
id|macio_chips
(braket
id|i
)braket
dot
id|flags
op_assign
id|MACIO_FLAG_SCCB_ON
op_or
id|MACIO_FLAG_SCCB_ON
suffix:semicolon
id|revp
op_assign
(paren
id|u32
op_star
)paren
id|get_property
c_func
(paren
id|node
comma
l_string|&quot;revision-id&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|revp
)paren
id|macio_chips
(braket
id|i
)braket
dot
id|rev
op_assign
op_star
id|revp
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Found a %s mac-io controller, rev: %d, mapped at 0x%p&bslash;n&quot;
comma
id|macio_names
(braket
id|type
)braket
comma
id|macio_chips
(braket
id|i
)braket
dot
id|rev
comma
id|macio_chips
(braket
id|i
)braket
dot
id|base
)paren
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|probe_macios
id|probe_macios
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Warning, ordering is important */
id|probe_one_macio
c_func
(paren
l_string|&quot;gc&quot;
comma
l_int|NULL
comma
id|macio_grand_central
)paren
suffix:semicolon
id|probe_one_macio
c_func
(paren
l_string|&quot;ohare&quot;
comma
l_int|NULL
comma
id|macio_ohare
)paren
suffix:semicolon
id|probe_one_macio
c_func
(paren
l_string|&quot;pci106b,7&quot;
comma
l_int|NULL
comma
id|macio_ohareII
)paren
suffix:semicolon
id|probe_one_macio
c_func
(paren
l_string|&quot;mac-io&quot;
comma
l_string|&quot;keylargo&quot;
comma
id|macio_keylargo
)paren
suffix:semicolon
id|probe_one_macio
c_func
(paren
l_string|&quot;mac-io&quot;
comma
l_string|&quot;paddington&quot;
comma
id|macio_paddington
)paren
suffix:semicolon
id|probe_one_macio
c_func
(paren
l_string|&quot;mac-io&quot;
comma
l_string|&quot;gatwick&quot;
comma
id|macio_gatwick
)paren
suffix:semicolon
id|probe_one_macio
c_func
(paren
l_string|&quot;mac-io&quot;
comma
l_string|&quot;heathrow&quot;
comma
id|macio_heathrow
)paren
suffix:semicolon
multiline_comment|/* Make sure the &quot;main&quot; macio chip appear first */
r_if
c_cond
(paren
id|macio_chips
(braket
l_int|0
)braket
dot
id|type
op_eq
id|macio_gatwick
op_logical_and
id|macio_chips
(braket
l_int|1
)braket
dot
id|type
op_eq
id|macio_heathrow
)paren
(brace
r_struct
id|macio_chip
id|temp
op_assign
id|macio_chips
(braket
l_int|0
)braket
suffix:semicolon
id|macio_chips
(braket
l_int|0
)braket
op_assign
id|macio_chips
(braket
l_int|1
)braket
suffix:semicolon
id|macio_chips
(braket
l_int|1
)braket
op_assign
id|temp
suffix:semicolon
)brace
r_if
c_cond
(paren
id|macio_chips
(braket
l_int|0
)braket
dot
id|type
op_eq
id|macio_ohareII
op_logical_and
id|macio_chips
(braket
l_int|1
)braket
dot
id|type
op_eq
id|macio_ohare
)paren
(brace
r_struct
id|macio_chip
id|temp
op_assign
id|macio_chips
(braket
l_int|0
)braket
suffix:semicolon
id|macio_chips
(braket
l_int|0
)braket
op_assign
id|macio_chips
(braket
l_int|1
)braket
suffix:semicolon
id|macio_chips
(braket
l_int|1
)braket
op_assign
id|temp
suffix:semicolon
)brace
r_return
(paren
id|macio_chips
(braket
l_int|0
)braket
dot
id|of_node
op_eq
l_int|NULL
)paren
ques
c_cond
op_minus
id|ENODEV
suffix:colon
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|__init
DECL|function|initial_serial_shutdown
id|initial_serial_shutdown
c_func
(paren
r_struct
id|device_node
op_star
id|np
)paren
(brace
r_int
id|len
suffix:semicolon
r_struct
id|slot_names_prop
(brace
r_int
id|count
suffix:semicolon
r_char
id|name
(braket
l_int|1
)braket
suffix:semicolon
)brace
op_star
id|slots
suffix:semicolon
r_char
op_star
id|conn
suffix:semicolon
r_int
id|port_type
op_assign
id|PMAC_SCC_ASYNC
suffix:semicolon
r_int
id|modem
op_assign
l_int|0
suffix:semicolon
id|slots
op_assign
(paren
r_struct
id|slot_names_prop
op_star
)paren
id|get_property
c_func
(paren
id|np
comma
l_string|&quot;slot-names&quot;
comma
op_amp
id|len
)paren
suffix:semicolon
id|conn
op_assign
id|get_property
c_func
(paren
id|np
comma
l_string|&quot;AAPL,connector&quot;
comma
op_amp
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conn
op_logical_and
(paren
id|strcmp
c_func
(paren
id|conn
comma
l_string|&quot;infrared&quot;
)paren
op_eq
l_int|0
)paren
)paren
id|port_type
op_assign
id|PMAC_SCC_IRDA
suffix:semicolon
r_else
r_if
c_cond
(paren
id|device_is_compatible
c_func
(paren
id|np
comma
l_string|&quot;cobalt&quot;
)paren
)paren
id|modem
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|slots
op_logical_and
id|slots-&gt;count
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|slots-&gt;name
comma
l_string|&quot;IrDA&quot;
)paren
op_eq
l_int|0
)paren
id|port_type
op_assign
id|PMAC_SCC_IRDA
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|slots-&gt;name
comma
l_string|&quot;Modem&quot;
)paren
op_eq
l_int|0
)paren
id|modem
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|modem
)paren
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_MODEM_ENABLE
comma
id|np
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_SCC_ENABLE
comma
id|np
comma
id|port_type
comma
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
id|__init
DECL|function|set_initial_features
id|set_initial_features
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|np
suffix:semicolon
multiline_comment|/* That hack appears to be necessary for some StarMax motherboards&n;&t; * but I&squot;m not too sure it was audited for side-effects on other&n;&t; * ohare based machines...&n;&t; * Since I still have difficulties figuring the right way to&n;&t; * differenciate them all and since that hack was there for a long&n;&t; * time, I&squot;ll keep it around&n;&t; */
r_if
c_cond
(paren
id|macio_chips
(braket
l_int|0
)braket
dot
id|type
op_eq
id|macio_ohare
op_logical_and
op_logical_neg
id|find_devices
c_func
(paren
l_string|&quot;via-pmu&quot;
)paren
)paren
(brace
r_struct
id|macio_chip
op_star
id|macio
op_assign
op_amp
id|macio_chips
(braket
l_int|0
)braket
suffix:semicolon
id|MACIO_OUT32
c_func
(paren
id|OHARE_FCR
comma
id|STARMAX_FEATURES
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|macio_chips
(braket
l_int|0
)braket
dot
id|type
op_eq
id|macio_ohare
)paren
(brace
r_struct
id|macio_chip
op_star
id|macio
op_assign
op_amp
id|macio_chips
(braket
l_int|0
)braket
suffix:semicolon
id|MACIO_BIS
c_func
(paren
id|OHARE_FCR
comma
id|OH_IOBUS_ENABLE
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|macio_chips
(braket
l_int|1
)braket
dot
id|type
op_eq
id|macio_ohare
)paren
(brace
r_struct
id|macio_chip
op_star
id|macio
op_assign
op_amp
id|macio_chips
(braket
l_int|1
)braket
suffix:semicolon
id|MACIO_BIS
c_func
(paren
id|OHARE_FCR
comma
id|OH_IOBUS_ENABLE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|macio_chips
(braket
l_int|0
)braket
dot
id|type
op_eq
id|macio_keylargo
op_logical_or
id|macio_chips
(braket
l_int|0
)braket
dot
id|type
op_eq
id|macio_pangea
)paren
(brace
multiline_comment|/* Enable GMAC for now for PCI probing. It will be disabled&n;&t;&t; * later on after PCI probe&n;&t;&t; */
id|np
op_assign
id|find_devices
c_func
(paren
l_string|&quot;ethernet&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|np
)paren
(brace
r_if
c_cond
(paren
id|np-&gt;parent
op_logical_and
id|device_is_compatible
c_func
(paren
id|np-&gt;parent
comma
l_string|&quot;uni-north&quot;
)paren
op_logical_and
id|device_is_compatible
c_func
(paren
id|np
comma
l_string|&quot;gmac&quot;
)paren
)paren
id|core99_gmac_enable
c_func
(paren
id|np
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|np
op_assign
id|np-&gt;next
suffix:semicolon
)brace
multiline_comment|/* Enable FW before PCI probe. Will be disabled later on&n;&t;&t; * Note: We should have a batter way to check that we are&n;&t;&t; * dealing with uninorth internal cell and not a PCI cell&n;&t;&t; * on the external PCI. The code below works though.&n;&t;&t; */
id|np
op_assign
id|find_devices
c_func
(paren
l_string|&quot;firewire&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|np
)paren
(brace
r_if
c_cond
(paren
id|np-&gt;parent
op_logical_and
id|device_is_compatible
c_func
(paren
id|np-&gt;parent
comma
l_string|&quot;uni-north&quot;
)paren
op_logical_and
(paren
id|device_is_compatible
c_func
(paren
id|np
comma
l_string|&quot;pci106b,18&quot;
)paren
op_logical_or
id|device_is_compatible
c_func
(paren
id|np
comma
l_string|&quot;pci106b,30&quot;
)paren
op_logical_or
id|device_is_compatible
c_func
(paren
id|np
comma
l_string|&quot;pci11c1,5811&quot;
)paren
)paren
)paren
(brace
id|macio_chips
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|MACIO_FLAG_FW_SUPPORTED
suffix:semicolon
id|core99_firewire_enable
c_func
(paren
id|np
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
)brace
id|np
op_assign
id|np-&gt;next
suffix:semicolon
)brace
multiline_comment|/* Switch airport off */
id|np
op_assign
id|find_devices
c_func
(paren
l_string|&quot;radio&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|np
)paren
(brace
r_if
c_cond
(paren
id|np
op_logical_and
id|np-&gt;parent
op_eq
id|macio_chips
(braket
l_int|0
)braket
dot
id|of_node
)paren
(brace
id|macio_chips
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|MACIO_FLAG_AIRPORT_ON
suffix:semicolon
id|core99_airport_enable
c_func
(paren
id|np
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
id|np
op_assign
id|np-&gt;next
suffix:semicolon
)brace
)brace
multiline_comment|/* On all machines that support sound PM, switch sound off */
r_if
c_cond
(paren
id|macio_chips
(braket
l_int|0
)braket
dot
id|of_node
)paren
id|pmac_do_feature_call
c_func
(paren
id|PMAC_FTR_SOUND_CHIP_ENABLE
comma
id|macio_chips
(braket
l_int|0
)braket
dot
id|of_node
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* While on some desktop G3s, we turn it back on */
r_if
c_cond
(paren
id|macio_chips
(braket
l_int|0
)braket
dot
id|of_node
op_logical_and
id|macio_chips
(braket
l_int|0
)braket
dot
id|type
op_eq
id|macio_heathrow
op_logical_and
(paren
id|pmac_mb.model_id
op_eq
id|PMAC_TYPE_GOSSAMER
op_logical_or
id|pmac_mb.model_id
op_eq
id|PMAC_TYPE_SILK
)paren
)paren
(brace
r_struct
id|macio_chip
op_star
id|macio
op_assign
op_amp
id|macio_chips
(braket
l_int|0
)braket
suffix:semicolon
id|MACIO_BIS
c_func
(paren
id|HEATHROW_FCR
comma
id|HRW_SOUND_CLK_ENABLE
)paren
suffix:semicolon
id|MACIO_BIC
c_func
(paren
id|HEATHROW_FCR
comma
id|HRW_SOUND_POWER_N
)paren
suffix:semicolon
)brace
multiline_comment|/* On all machines, switch modem &amp; serial ports off */
id|np
op_assign
id|find_devices
c_func
(paren
l_string|&quot;ch-a&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|np
)paren
(brace
id|initial_serial_shutdown
c_func
(paren
id|np
)paren
suffix:semicolon
id|np
op_assign
id|np-&gt;next
suffix:semicolon
)brace
id|np
op_assign
id|find_devices
c_func
(paren
l_string|&quot;ch-b&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|np
)paren
(brace
id|initial_serial_shutdown
c_func
(paren
id|np
)paren
suffix:semicolon
id|np
op_assign
id|np-&gt;next
suffix:semicolon
)brace
multiline_comment|/* Let hardware settle down */
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_void
id|__init
DECL|function|pmac_feature_init
id|pmac_feature_init
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Detect the UniNorth memory controller */
id|probe_uninorth
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Probe mac-io controllers */
r_if
c_cond
(paren
id|probe_macios
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;No mac-io chip found&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Probe machine type */
r_if
c_cond
(paren
id|probe_motherboard
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Unknown PowerMac !&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Set some initial features (turn off some chips that will&n;&t; * be later turned on)&n;&t; */
id|set_initial_features
c_func
(paren
)paren
suffix:semicolon
)brace
r_int
id|__init
DECL|function|pmac_feature_late_init
id|pmac_feature_late_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|np
suffix:semicolon
multiline_comment|/* Request some resources late */
r_if
c_cond
(paren
id|uninorth_node
)paren
id|request_OF_resource
c_func
(paren
id|uninorth_node
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
id|np
op_assign
id|find_devices
c_func
(paren
l_string|&quot;hammerhead&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np
)paren
id|request_OF_resource
c_func
(paren
id|np
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
id|np
op_assign
id|find_devices
c_func
(paren
l_string|&quot;interrupt-controller&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np
)paren
id|request_OF_resource
c_func
(paren
id|np
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|pmac_feature_late_init
id|device_initcall
c_func
(paren
id|pmac_feature_late_init
)paren
suffix:semicolon
eof
