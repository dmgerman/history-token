multiline_comment|/*&n; * BK Id: %F% %I% %G% %U% %#%&n; */
multiline_comment|/*&n; *  arch/ppc/platforms/apus_setup.c&n; *&n; *  Copyright (C) 1998, 1999  Jesper Skov&n; *&n; *  Basically what is needed to replace functionality found in&n; *  arch/m68k allowing Amiga drivers to work under APUS.&n; *  Bits of code and/or ideas from arch/m68k and arch/ppc files.&n; *&n; * TODO:&n; *  This file needs a *really* good cleanup. Restructure and optimize.&n; *  Make sure it can be compiled for non-APUS configs. Begin to move&n; *  Amiga specific stuff into mach/amiga.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/seq_file.h&gt;
multiline_comment|/* Needs INITSERIAL call in head.S! */
DECL|macro|APUS_DEBUG
macro_line|#undef APUS_DEBUG
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#include &lt;asm/setup.h&gt;
macro_line|#include &lt;asm/amigahw.h&gt;
macro_line|#include &lt;asm/amigaints.h&gt;
macro_line|#include &lt;asm/amigappc.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/time.h&gt;
DECL|variable|m68k_machtype
r_int
r_int
id|m68k_machtype
suffix:semicolon
DECL|variable|debug_device
r_char
id|debug_device
(braket
l_int|6
)braket
op_assign
l_string|&quot;&quot;
suffix:semicolon
r_extern
r_void
id|amiga_init_IRQ
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|apus_setup_pci_ptrs
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
(paren
op_star
id|mach_sched_init
)paren
(paren
r_void
(paren
op_star
id|handler
)paren
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
)paren
id|__initdata
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* machine dependent irq functions */
r_void
(paren
op_star
id|mach_init_IRQ
)paren
(paren
r_void
)paren
id|__initdata
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|mach_default_handler
r_void
(paren
op_star
(paren
op_star
id|mach_default_handler
)paren
(braket
)braket
)paren
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|mach_get_model
r_void
(paren
op_star
id|mach_get_model
)paren
(paren
r_char
op_star
id|model
)paren
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|mach_get_hardware_list
r_int
(paren
op_star
id|mach_get_hardware_list
)paren
(paren
r_char
op_star
id|buffer
)paren
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|mach_get_irq_list
r_int
(paren
op_star
id|mach_get_irq_list
)paren
(paren
r_struct
id|seq_file
op_star
comma
r_void
op_star
)paren
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|mach_process_int
r_void
(paren
op_star
id|mach_process_int
)paren
(paren
r_int
comma
r_struct
id|pt_regs
op_star
)paren
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* machine dependent timer functions */
DECL|variable|mach_gettimeoffset
r_int
r_int
(paren
op_star
id|mach_gettimeoffset
)paren
(paren
r_void
)paren
suffix:semicolon
DECL|variable|mach_gettod
r_void
(paren
op_star
id|mach_gettod
)paren
(paren
r_int
op_star
comma
r_int
op_star
comma
r_int
op_star
comma
r_int
op_star
comma
r_int
op_star
comma
r_int
op_star
)paren
suffix:semicolon
DECL|variable|mach_hwclk
r_int
(paren
op_star
id|mach_hwclk
)paren
(paren
r_int
comma
r_struct
id|hwclk_time
op_star
)paren
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|mach_set_clock_mmss
r_int
(paren
op_star
id|mach_set_clock_mmss
)paren
(paren
r_int
r_int
)paren
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|mach_reset
r_void
(paren
op_star
id|mach_reset
)paren
(paren
r_void
)paren
suffix:semicolon
DECL|variable|mach_max_dma_address
r_int
id|mach_max_dma_address
op_assign
l_int|0x00ffffff
suffix:semicolon
multiline_comment|/* default set to the lower 16MB */
macro_line|#if defined(CONFIG_AMIGA_FLOPPY)
r_void
(paren
op_star
id|mach_floppy_setup
)paren
(paren
r_char
op_star
comma
r_int
op_star
)paren
id|__initdata
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_HEARTBEAT
DECL|variable|mach_heartbeat
r_void
(paren
op_star
id|mach_heartbeat
)paren
(paren
r_int
)paren
op_assign
l_int|NULL
suffix:semicolon
r_extern
r_void
id|apus_heartbeat
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
r_extern
r_int
r_int
id|amiga_model
suffix:semicolon
r_extern
r_int
id|decrementer_count
suffix:semicolon
multiline_comment|/* count value for 1e6/HZ microseconds */
r_extern
r_int
id|count_period_num
suffix:semicolon
multiline_comment|/* 1 decrementer count equals */
r_extern
r_int
id|count_period_den
suffix:semicolon
multiline_comment|/* count_period_num / count_period_den us */
DECL|variable|num_memory
r_int
id|num_memory
op_assign
l_int|0
suffix:semicolon
DECL|variable|memory
r_struct
id|mem_info
id|memory
(braket
id|NUM_MEMINFO
)braket
suffix:semicolon
multiline_comment|/* memory description */
multiline_comment|/* FIXME: Duplicate memory data to avoid conflicts with m68k shared code. */
DECL|variable|m68k_realnum_memory
r_int
id|m68k_realnum_memory
op_assign
l_int|0
suffix:semicolon
DECL|variable|m68k_memory
r_struct
id|mem_info
id|m68k_memory
(braket
id|NUM_MEMINFO
)braket
suffix:semicolon
multiline_comment|/* memory description */
DECL|variable|ramdisk
r_struct
id|mem_info
id|ramdisk
suffix:semicolon
r_extern
r_void
id|amiga_floppy_setup
c_func
(paren
r_char
op_star
comma
r_int
op_star
)paren
suffix:semicolon
r_extern
r_void
id|config_amiga
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|variable|__60nsram
r_static
r_int
id|__60nsram
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* for cpuinfo */
DECL|variable|__bus_speed
r_static
r_int
id|__bus_speed
op_assign
l_int|0
suffix:semicolon
DECL|variable|__speed_test_failed
r_static
r_int
id|__speed_test_failed
op_assign
l_int|0
suffix:semicolon
multiline_comment|/********************************************** COMPILE PROTECTION */
multiline_comment|/* Provide some stubs that links to Amiga specific functions.&n; * This allows CONFIG_APUS to be removed from generic PPC files while&n; * preventing link errors for other PPC targets.&n; */
DECL|function|apus_get_rtc_time
r_int
r_int
id|apus_get_rtc_time
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_APUS
r_extern
r_int
r_int
id|m68k_get_rtc_time
c_func
(paren
r_void
)paren
suffix:semicolon
r_return
id|m68k_get_rtc_time
(paren
)paren
suffix:semicolon
macro_line|#else
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
DECL|function|apus_set_rtc_time
r_int
id|apus_set_rtc_time
c_func
(paren
r_int
r_int
id|nowtime
)paren
(brace
macro_line|#ifdef CONFIG_APUS
r_extern
r_int
id|m68k_set_rtc_time
c_func
(paren
r_int
r_int
id|nowtime
)paren
suffix:semicolon
r_return
id|m68k_set_rtc_time
(paren
id|nowtime
)paren
suffix:semicolon
macro_line|#else
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*********************************************************** SETUP */
multiline_comment|/* From arch/m68k/kernel/setup.c. */
DECL|function|apus_setup_arch
r_void
id|__init
id|apus_setup_arch
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_APUS
r_extern
r_char
id|cmd_line
(braket
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
op_star
id|p
comma
op_star
id|q
suffix:semicolon
multiline_comment|/* Let m68k-shared code know it should do the Amiga thing. */
id|m68k_machtype
op_assign
id|MACH_AMIGA
suffix:semicolon
multiline_comment|/* Parse the command line for arch-specific options.&n;&t; * For the m68k, this is currently only &quot;debug=xxx&quot; to enable printing&n;&t; * certain kernel messages to some machine-specific device.  */
r_for
c_loop
(paren
id|p
op_assign
id|cmd_line
suffix:semicolon
id|p
op_logical_and
op_star
id|p
suffix:semicolon
)paren
(brace
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|p
comma
l_string|&quot;debug=&quot;
comma
l_int|6
)paren
)paren
(brace
id|strncpy
c_func
(paren
id|debug_device
comma
id|p
op_plus
l_int|6
comma
r_sizeof
(paren
id|debug_device
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|debug_device
(braket
r_sizeof
(paren
id|debug_device
)paren
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|q
op_assign
id|strchr
c_func
(paren
id|debug_device
comma
l_char|&squot; &squot;
)paren
)paren
)paren
op_star
id|q
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|p
comma
l_string|&quot;60nsram&quot;
comma
l_int|7
)paren
)paren
(brace
id|APUS_WRITE
(paren
id|APUS_REG_WAITSTATE
comma
id|REGWAITSTATE_SETRESET
op_or
id|REGWAITSTATE_PPCR
op_or
id|REGWAITSTATE_PPCW
)paren
suffix:semicolon
id|__60nsram
op_assign
l_int|1
suffix:semicolon
id|i
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
)paren
(brace
multiline_comment|/* option processed, delete it */
r_if
c_cond
(paren
(paren
id|q
op_assign
id|strchr
c_func
(paren
id|p
comma
l_char|&squot; &squot;
)paren
)paren
)paren
id|strcpy
c_func
(paren
id|p
comma
id|q
op_plus
l_int|1
)paren
suffix:semicolon
r_else
op_star
id|p
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strchr
c_func
(paren
id|p
comma
l_char|&squot; &squot;
)paren
)paren
)paren
op_increment
id|p
suffix:semicolon
)brace
)brace
id|config_amiga
c_func
(paren
)paren
suffix:semicolon
macro_line|#if 0 /* Enable for logging - also include logging.o in Makefile rule */
(brace
mdefine_line|#define LOG_SIZE 4096
r_void
op_star
id|base
suffix:semicolon
multiline_comment|/* Throw away some memory - the P5 firmare stomps on top&n;&t;&t; * of CHIP memory during bootup.&n;&t;&t; */
id|amiga_chip_alloc
c_func
(paren
l_int|0x1000
)paren
suffix:semicolon
id|base
op_assign
id|amiga_chip_alloc
c_func
(paren
id|LOG_SIZE
op_plus
r_sizeof
(paren
id|klog_data_t
)paren
)paren
suffix:semicolon
id|LOG_INIT
c_func
(paren
id|base
comma
id|base
op_plus
r_sizeof
(paren
id|klog_data_t
)paren
comma
id|LOG_SIZE
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif
)brace
r_int
DECL|function|apus_show_cpuinfo
id|apus_show_cpuinfo
c_func
(paren
r_struct
id|seq_file
op_star
id|m
)paren
(brace
r_extern
r_int
id|__map_without_bats
suffix:semicolon
r_extern
r_int
r_int
id|powerup_PCI_present
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;machine&bslash;t&bslash;t: Amiga&bslash;n&quot;
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;bus speed&bslash;t: %d%s&quot;
comma
id|__bus_speed
comma
(paren
id|__speed_test_failed
)paren
ques
c_cond
l_string|&quot; [failed]&bslash;n&quot;
suffix:colon
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;using BATs&bslash;t: %s&bslash;n&quot;
comma
(paren
id|__map_without_bats
)paren
ques
c_cond
l_string|&quot;No&quot;
suffix:colon
l_string|&quot;Yes&quot;
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;ram speed&bslash;t: %dns&bslash;n&quot;
comma
(paren
id|__60nsram
)paren
ques
c_cond
l_int|60
suffix:colon
l_int|70
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;PCI bridge&bslash;t: %s&bslash;n&quot;
comma
(paren
id|powerup_PCI_present
)paren
ques
c_cond
l_string|&quot;Yes&quot;
suffix:colon
l_string|&quot;No&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_current_tb
r_static
r_void
id|get_current_tb
c_func
(paren
r_int
r_int
r_int
op_star
id|time
)paren
(brace
id|__asm
id|__volatile
(paren
l_string|&quot;1:mftbu 4      &bslash;n&bslash;t&quot;
l_string|&quot;  mftb  5      &bslash;n&bslash;t&quot;
l_string|&quot;  mftbu 6      &bslash;n&bslash;t&quot;
l_string|&quot;  cmpw  4,6    &bslash;n&bslash;t&quot;
l_string|&quot;  bne   1b     &bslash;n&bslash;t&quot;
l_string|&quot;  stw   4,0(%0)&bslash;n&bslash;t&quot;
l_string|&quot;  stw   5,4(%0)&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|time
)paren
suffix:colon
l_string|&quot;r4&quot;
comma
l_string|&quot;r5&quot;
comma
l_string|&quot;r6&quot;
)paren
suffix:semicolon
)brace
DECL|function|apus_calibrate_decr
r_void
id|apus_calibrate_decr
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_APUS
r_int
r_int
id|freq
suffix:semicolon
multiline_comment|/* This algorithm for determining the bus speed was&n;           contributed by Ralph Schmidt. */
r_int
r_int
r_int
id|start
comma
id|stop
suffix:semicolon
r_int
id|bus_speed
suffix:semicolon
r_int
id|speed_test_failed
op_assign
l_int|0
suffix:semicolon
(brace
r_int
r_int
id|loop
op_assign
id|amiga_eclock
op_div
l_int|10
suffix:semicolon
id|get_current_tb
(paren
op_amp
id|start
)paren
suffix:semicolon
r_while
c_loop
(paren
id|loop
op_decrement
)paren
(brace
r_int
r_char
id|tmp
suffix:semicolon
id|tmp
op_assign
id|ciaa.pra
suffix:semicolon
)brace
id|get_current_tb
(paren
op_amp
id|stop
)paren
suffix:semicolon
)brace
id|bus_speed
op_assign
(paren
(paren
(paren
r_int
r_int
)paren
(paren
id|stop
op_minus
id|start
)paren
)paren
op_star
l_int|10
op_star
l_int|4
)paren
op_div
l_int|1000000
suffix:semicolon
r_if
c_cond
(paren
id|AMI_1200
op_eq
id|amiga_model
)paren
id|bus_speed
op_div_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bus_speed
op_ge
l_int|47
)paren
op_logical_and
(paren
id|bus_speed
OL
l_int|53
)paren
)paren
(brace
id|bus_speed
op_assign
l_int|50
suffix:semicolon
id|freq
op_assign
l_int|12500000
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|bus_speed
op_ge
l_int|57
)paren
op_logical_and
(paren
id|bus_speed
OL
l_int|63
)paren
)paren
(brace
id|bus_speed
op_assign
l_int|60
suffix:semicolon
id|freq
op_assign
l_int|15000000
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|bus_speed
op_ge
l_int|63
)paren
op_logical_and
(paren
id|bus_speed
OL
l_int|69
)paren
)paren
(brace
id|bus_speed
op_assign
l_int|67
suffix:semicolon
id|freq
op_assign
l_int|16666667
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
l_string|&quot;APUS: Unable to determine bus speed (%d). &quot;
l_string|&quot;Defaulting to 50MHz&quot;
comma
id|bus_speed
)paren
suffix:semicolon
id|bus_speed
op_assign
l_int|50
suffix:semicolon
id|freq
op_assign
l_int|12500000
suffix:semicolon
id|speed_test_failed
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Ease diagnostics... */
(brace
r_extern
r_int
id|__map_without_bats
suffix:semicolon
r_extern
r_int
r_int
id|powerup_PCI_present
suffix:semicolon
id|printk
(paren
l_string|&quot;APUS: BATs=%d, BUS=%dMHz&quot;
comma
(paren
id|__map_without_bats
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
comma
id|bus_speed
)paren
suffix:semicolon
r_if
c_cond
(paren
id|speed_test_failed
)paren
id|printk
(paren
l_string|&quot;[FAILED - please report]&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;, RAM=%dns, PCI bridge=%d&bslash;n&quot;
comma
(paren
id|__60nsram
)paren
ques
c_cond
l_int|60
suffix:colon
l_int|70
comma
(paren
id|powerup_PCI_present
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/* print a bit more if asked politely... */
r_if
c_cond
(paren
op_logical_neg
(paren
id|ciaa.pra
op_amp
l_int|0x40
)paren
)paren
(brace
r_extern
r_int
r_int
id|bat_addrs
(braket
l_int|4
)braket
(braket
l_int|3
)braket
suffix:semicolon
r_int
id|b
suffix:semicolon
r_for
c_loop
(paren
id|b
op_assign
l_int|0
suffix:semicolon
id|b
OL
l_int|4
suffix:semicolon
op_increment
id|b
)paren
(brace
id|printk
(paren
l_string|&quot;APUS: BAT%d &quot;
comma
id|b
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;%08x-%08x -&gt; %08x&bslash;n&quot;
comma
id|bat_addrs
(braket
id|b
)braket
(braket
l_int|0
)braket
comma
id|bat_addrs
(braket
id|b
)braket
(braket
l_int|1
)braket
comma
id|bat_addrs
(braket
id|b
)braket
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;time_init: decrementer frequency = %lu.%.6lu MHz&bslash;n&quot;
comma
id|freq
op_div
l_int|1000000
comma
id|freq
op_mod
l_int|1000000
)paren
suffix:semicolon
id|tb_ticks_per_jiffy
op_assign
id|freq
op_div
id|HZ
suffix:semicolon
id|tb_to_us
op_assign
id|mulhwu_scale_factor
c_func
(paren
id|freq
comma
l_int|1000000
)paren
suffix:semicolon
id|__bus_speed
op_assign
id|bus_speed
suffix:semicolon
id|__speed_test_failed
op_assign
id|speed_test_failed
suffix:semicolon
macro_line|#endif
)brace
DECL|function|arch_gettod
r_void
id|arch_gettod
c_func
(paren
r_int
op_star
id|year
comma
r_int
op_star
id|mon
comma
r_int
op_star
id|day
comma
r_int
op_star
id|hour
comma
r_int
op_star
id|min
comma
r_int
op_star
id|sec
)paren
(brace
macro_line|#ifdef CONFIG_APUS
r_if
c_cond
(paren
id|mach_gettod
)paren
id|mach_gettod
c_func
(paren
id|year
comma
id|mon
comma
id|day
comma
id|hour
comma
id|min
comma
id|sec
)paren
suffix:semicolon
r_else
op_star
id|year
op_assign
op_star
id|mon
op_assign
op_star
id|day
op_assign
op_star
id|hour
op_assign
op_star
id|min
op_assign
op_star
id|sec
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* for &quot;kbd-reset&quot; cmdline param */
id|__init
DECL|function|kbd_reset_setup
r_void
id|kbd_reset_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
)brace
multiline_comment|/*********************************************************** FLOPPY */
macro_line|#if defined(CONFIG_AMIGA_FLOPPY)
id|__init
DECL|function|floppy_setup
r_void
id|floppy_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
r_if
c_cond
(paren
id|mach_floppy_setup
)paren
id|mach_floppy_setup
(paren
id|str
comma
id|ints
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*********************************************************** MEMORY */
DECL|macro|KMAP_MAX
mdefine_line|#define KMAP_MAX 32
DECL|variable|kmap_chunks
r_int
r_int
id|kmap_chunks
(braket
id|KMAP_MAX
op_star
l_int|3
)braket
suffix:semicolon
DECL|variable|kmap_chunk_count
r_int
id|kmap_chunk_count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* From pgtable.h */
DECL|function|my_find_pte
r_static
id|__inline__
id|pte_t
op_star
id|my_find_pte
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|va
)paren
(brace
id|pgd_t
op_star
id|dir
op_assign
l_int|0
suffix:semicolon
id|pmd_t
op_star
id|pmd
op_assign
l_int|0
suffix:semicolon
id|pte_t
op_star
id|pte
op_assign
l_int|0
suffix:semicolon
id|va
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|dir
op_assign
id|pgd_offset
c_func
(paren
id|mm
comma
id|va
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dir
)paren
(brace
id|pmd
op_assign
id|pmd_offset
c_func
(paren
id|dir
comma
id|va
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmd
op_logical_and
id|pmd_present
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
id|pte
op_assign
id|pte_offset
c_func
(paren
id|pmd
comma
id|va
)paren
suffix:semicolon
)brace
)brace
r_return
id|pte
suffix:semicolon
)brace
multiline_comment|/* Again simulating an m68k/mm/kmap.c function. */
DECL|function|kernel_set_cachemode
r_void
id|kernel_set_cachemode
c_func
(paren
r_int
r_int
id|address
comma
r_int
r_int
id|size
comma
r_int
r_int
id|cmode
)paren
(brace
r_int
r_int
id|mask
comma
id|flags
suffix:semicolon
r_switch
c_cond
(paren
id|cmode
)paren
(brace
r_case
id|IOMAP_FULL_CACHING
suffix:colon
id|mask
op_assign
op_complement
(paren
id|_PAGE_NO_CACHE
op_or
id|_PAGE_GUARDED
)paren
suffix:semicolon
id|flags
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IOMAP_NOCACHE_SER
suffix:colon
id|mask
op_assign
op_complement
l_int|0
suffix:semicolon
id|flags
op_assign
(paren
id|_PAGE_NO_CACHE
op_or
id|_PAGE_GUARDED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|panic
(paren
l_string|&quot;kernel_set_cachemode() doesn&squot;t support mode %d&bslash;n&quot;
comma
id|cmode
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|size
op_div_assign
id|PAGE_SIZE
suffix:semicolon
id|address
op_and_assign
id|PAGE_MASK
suffix:semicolon
r_while
c_loop
(paren
id|size
op_decrement
)paren
(brace
id|pte_t
op_star
id|pte
suffix:semicolon
id|pte
op_assign
id|my_find_pte
c_func
(paren
op_amp
id|init_mm
comma
id|address
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pte
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;pte NULL in kernel_set_cachemode()&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pte_val
(paren
op_star
id|pte
)paren
op_and_assign
id|mask
suffix:semicolon
id|pte_val
(paren
op_star
id|pte
)paren
op_or_assign
id|flags
suffix:semicolon
id|flush_tlb_page
c_func
(paren
id|find_vma
c_func
(paren
op_amp
id|init_mm
comma
id|address
)paren
comma
id|address
)paren
suffix:semicolon
id|address
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
DECL|function|mm_ptov
r_int
r_int
id|mm_ptov
(paren
r_int
r_int
id|paddr
)paren
(brace
r_int
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|paddr
OL
l_int|16
op_star
l_int|1024
op_star
l_int|1024
)paren
id|ret
op_assign
id|ZTWO_VADDR
c_func
(paren
id|paddr
)paren
suffix:semicolon
r_else
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|kmap_chunk_count
suffix:semicolon
)paren
(brace
r_int
r_int
id|phys
op_assign
id|kmap_chunks
(braket
id|i
op_increment
)braket
suffix:semicolon
r_int
r_int
id|size
op_assign
id|kmap_chunks
(braket
id|i
op_increment
)braket
suffix:semicolon
r_int
r_int
id|virt
op_assign
id|kmap_chunks
(braket
id|i
op_increment
)braket
suffix:semicolon
r_if
c_cond
(paren
id|paddr
op_ge
id|phys
op_logical_and
id|paddr
OL
(paren
id|phys
op_plus
id|size
)paren
)paren
(brace
id|ret
op_assign
id|virt
op_plus
id|paddr
op_minus
id|phys
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
)brace
id|ret
op_assign
(paren
r_int
r_int
)paren
id|__va
c_func
(paren
id|paddr
)paren
suffix:semicolon
)brace
m_exit
suffix:colon
macro_line|#ifdef DEBUGPV
id|printk
(paren
l_string|&quot;PTOV(%lx)=%lx&bslash;n&quot;
comma
id|paddr
comma
id|ret
)paren
suffix:semicolon
macro_line|#endif
r_return
id|ret
suffix:semicolon
)brace
DECL|function|mm_end_of_chunk
r_int
id|mm_end_of_chunk
(paren
r_int
r_int
id|addr
comma
r_int
id|len
)paren
(brace
r_if
c_cond
(paren
id|memory
(braket
l_int|0
)braket
dot
id|addr
op_plus
id|memory
(braket
l_int|0
)braket
dot
id|size
op_eq
id|addr
op_plus
id|len
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*********************************************************** CACHE */
DECL|macro|L1_CACHE_BYTES
mdefine_line|#define L1_CACHE_BYTES 32
DECL|macro|MAX_CACHE_SIZE
mdefine_line|#define MAX_CACHE_SIZE 8192
DECL|function|cache_push
r_void
id|cache_push
c_func
(paren
id|__u32
id|addr
comma
r_int
id|length
)paren
(brace
id|addr
op_assign
id|mm_ptov
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|MAX_CACHE_SIZE
OL
id|length
)paren
id|length
op_assign
id|MAX_CACHE_SIZE
suffix:semicolon
r_while
c_loop
(paren
id|length
OG
l_int|0
)paren
(brace
id|__asm
(paren
l_string|&quot;dcbf 0,%0&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|addr
)paren
)paren
suffix:semicolon
id|addr
op_add_assign
id|L1_CACHE_BYTES
suffix:semicolon
id|length
op_sub_assign
id|L1_CACHE_BYTES
suffix:semicolon
)brace
multiline_comment|/* Also flush trailing block */
id|__asm
(paren
l_string|&quot;dcbf 0,%0&bslash;n&bslash;t&quot;
l_string|&quot;sync &bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|addr
)paren
)paren
suffix:semicolon
)brace
DECL|function|cache_clear
r_void
id|cache_clear
c_func
(paren
id|__u32
id|addr
comma
r_int
id|length
)paren
(brace
r_if
c_cond
(paren
id|MAX_CACHE_SIZE
OL
id|length
)paren
id|length
op_assign
id|MAX_CACHE_SIZE
suffix:semicolon
id|addr
op_assign
id|mm_ptov
c_func
(paren
id|addr
)paren
suffix:semicolon
id|__asm
(paren
l_string|&quot;dcbf 0,%0&bslash;n&bslash;t&quot;
l_string|&quot;sync &bslash;n&bslash;t&quot;
l_string|&quot;icbi 0,%0 &bslash;n&bslash;t&quot;
l_string|&quot;isync &bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|addr
)paren
)paren
suffix:semicolon
id|addr
op_add_assign
id|L1_CACHE_BYTES
suffix:semicolon
id|length
op_sub_assign
id|L1_CACHE_BYTES
suffix:semicolon
r_while
c_loop
(paren
id|length
OG
l_int|0
)paren
(brace
id|__asm
(paren
l_string|&quot;dcbf 0,%0&bslash;n&bslash;t&quot;
l_string|&quot;sync &bslash;n&bslash;t&quot;
l_string|&quot;icbi 0,%0 &bslash;n&bslash;t&quot;
l_string|&quot;isync &bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|addr
)paren
)paren
suffix:semicolon
id|addr
op_add_assign
id|L1_CACHE_BYTES
suffix:semicolon
id|length
op_sub_assign
id|L1_CACHE_BYTES
suffix:semicolon
)brace
id|__asm
(paren
l_string|&quot;dcbf 0,%0&bslash;n&bslash;t&quot;
l_string|&quot;sync &bslash;n&bslash;t&quot;
l_string|&quot;icbi 0,%0 &bslash;n&bslash;t&quot;
l_string|&quot;isync &bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|addr
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************** from setup.c */
r_void
DECL|function|apus_restart
id|apus_restart
c_func
(paren
r_char
op_star
id|cmd
)paren
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
id|APUS_WRITE
c_func
(paren
id|APUS_REG_LOCK
comma
id|REGLOCK_BLACKMAGICK1
op_or
id|REGLOCK_BLACKMAGICK2
)paren
suffix:semicolon
id|APUS_WRITE
c_func
(paren
id|APUS_REG_LOCK
comma
id|REGLOCK_BLACKMAGICK1
op_or
id|REGLOCK_BLACKMAGICK3
)paren
suffix:semicolon
id|APUS_WRITE
c_func
(paren
id|APUS_REG_LOCK
comma
id|REGLOCK_BLACKMAGICK2
op_or
id|REGLOCK_BLACKMAGICK3
)paren
suffix:semicolon
id|APUS_WRITE
c_func
(paren
id|APUS_REG_SHADOW
comma
id|REGSHADOW_SELFRESET
)paren
suffix:semicolon
id|APUS_WRITE
c_func
(paren
id|APUS_REG_RESET
comma
id|REGRESET_AMIGARESET
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
suffix:semicolon
)brace
)brace
r_void
DECL|function|apus_power_off
id|apus_power_off
c_func
(paren
r_void
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
suffix:semicolon
)brace
r_void
DECL|function|apus_halt
id|apus_halt
c_func
(paren
r_void
)paren
(brace
id|apus_restart
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************** IRQ stuff */
DECL|variable|last_ipl
r_static
r_int
r_char
id|last_ipl
(braket
l_int|8
)braket
suffix:semicolon
DECL|function|apus_get_irq
r_int
id|apus_get_irq
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_char
id|ipl_emu
comma
id|mask
suffix:semicolon
r_int
r_int
id|level
suffix:semicolon
id|APUS_READ
c_func
(paren
id|APUS_IPL_EMU
comma
id|ipl_emu
)paren
suffix:semicolon
id|level
op_assign
(paren
id|ipl_emu
op_rshift
l_int|3
)paren
op_amp
id|IPLEMU_IPLMASK
suffix:semicolon
id|mask
op_assign
id|IPLEMU_SETRESET
op_or
id|IPLEMU_DISABLEINT
op_or
id|level
suffix:semicolon
id|level
op_xor_assign
l_int|7
suffix:semicolon
multiline_comment|/* Save previous IPL value */
r_if
c_cond
(paren
id|last_ipl
(braket
id|level
)braket
)paren
r_return
op_minus
l_int|2
suffix:semicolon
id|last_ipl
(braket
id|level
)braket
op_assign
id|ipl_emu
suffix:semicolon
multiline_comment|/* Set to current IPL value */
id|APUS_WRITE
c_func
(paren
id|APUS_IPL_EMU
comma
id|mask
)paren
suffix:semicolon
id|APUS_WRITE
c_func
(paren
id|APUS_IPL_EMU
comma
id|IPLEMU_DISABLEINT
op_or
id|level
)paren
suffix:semicolon
macro_line|#ifdef __INTERRUPT_DEBUG
id|printk
c_func
(paren
l_string|&quot;&lt;%d:%d&gt;&quot;
comma
id|level
comma
op_complement
id|ipl_emu
op_amp
id|IPLEMU_IPLMASK
)paren
suffix:semicolon
macro_line|#endif
r_return
id|level
op_plus
id|IRQ_AMIGA_AUTO
suffix:semicolon
)brace
DECL|function|apus_end_irq
r_void
id|apus_end_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_char
id|ipl_emu
suffix:semicolon
r_int
r_int
id|level
op_assign
id|irq
op_minus
id|IRQ_AMIGA_AUTO
suffix:semicolon
macro_line|#ifdef __INTERRUPT_DEBUG
id|printk
c_func
(paren
l_string|&quot;{%d}&quot;
comma
op_complement
id|last_ipl
(braket
id|level
)braket
op_amp
id|IPLEMU_IPLMASK
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Restore IPL to the previous value */
id|ipl_emu
op_assign
id|last_ipl
(braket
id|level
)braket
op_amp
id|IPLEMU_IPLMASK
suffix:semicolon
id|APUS_WRITE
c_func
(paren
id|APUS_IPL_EMU
comma
id|IPLEMU_SETRESET
op_or
id|IPLEMU_DISABLEINT
op_or
id|ipl_emu
)paren
suffix:semicolon
id|last_ipl
(braket
id|level
)braket
op_assign
l_int|0
suffix:semicolon
id|ipl_emu
op_xor_assign
l_int|7
suffix:semicolon
id|APUS_WRITE
c_func
(paren
id|APUS_IPL_EMU
comma
id|IPLEMU_DISABLEINT
op_or
id|ipl_emu
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************** debugging */
multiline_comment|/* some serial hardware definitions */
DECL|macro|SDR_OVRUN
mdefine_line|#define SDR_OVRUN   (1&lt;&lt;15)
DECL|macro|SDR_RBF
mdefine_line|#define SDR_RBF     (1&lt;&lt;14)
DECL|macro|SDR_TBE
mdefine_line|#define SDR_TBE     (1&lt;&lt;13)
DECL|macro|SDR_TSRE
mdefine_line|#define SDR_TSRE    (1&lt;&lt;12)
DECL|macro|AC_SETCLR
mdefine_line|#define AC_SETCLR   (1&lt;&lt;15)
DECL|macro|AC_UARTBRK
mdefine_line|#define AC_UARTBRK  (1&lt;&lt;11)
DECL|macro|SER_DTR
mdefine_line|#define SER_DTR     (1&lt;&lt;7)
DECL|macro|SER_RTS
mdefine_line|#define SER_RTS     (1&lt;&lt;6)
DECL|macro|SER_DCD
mdefine_line|#define SER_DCD     (1&lt;&lt;5)
DECL|macro|SER_CTS
mdefine_line|#define SER_CTS     (1&lt;&lt;4)
DECL|macro|SER_DSR
mdefine_line|#define SER_DSR     (1&lt;&lt;3)
DECL|function|ser_RTSon
r_static
id|__inline__
r_void
id|ser_RTSon
c_func
(paren
r_void
)paren
(brace
id|ciab.pra
op_and_assign
op_complement
id|SER_RTS
suffix:semicolon
multiline_comment|/* active low */
)brace
DECL|function|__debug_ser_out
r_int
id|__debug_ser_out
c_func
(paren
r_int
r_char
id|c
)paren
(brace
id|custom.serdat
op_assign
id|c
op_or
l_int|0x100
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|custom.serdatr
op_amp
l_int|0x2000
)paren
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|__debug_ser_in
r_int
r_char
id|__debug_ser_in
c_func
(paren
r_void
)paren
(brace
r_int
r_char
id|c
suffix:semicolon
multiline_comment|/* XXX: is that ok?? derived from amiga_ser.c... */
r_while
c_loop
(paren
op_logical_neg
(paren
id|custom.intreqr
op_amp
id|IF_RBF
)paren
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
id|c
op_assign
id|custom.serdatr
suffix:semicolon
multiline_comment|/* clear the interrupt, so that another character can be read */
id|custom.intreq
op_assign
id|IF_RBF
suffix:semicolon
r_return
id|c
suffix:semicolon
)brace
DECL|function|__debug_serinit
r_int
id|__debug_serinit
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* turn off Rx and Tx interrupts */
id|custom.intena
op_assign
id|IF_RBF
op_or
id|IF_TBE
suffix:semicolon
multiline_comment|/* clear any pending interrupt */
id|custom.intreq
op_assign
id|IF_RBF
op_or
id|IF_TBE
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * set the appropriate directions for the modem control flags,&n;&t; * and clear RTS and DTR&n;&t; */
id|ciab.ddra
op_or_assign
(paren
id|SER_DTR
op_or
id|SER_RTS
)paren
suffix:semicolon
multiline_comment|/* outputs */
id|ciab.ddra
op_and_assign
op_complement
(paren
id|SER_DCD
op_or
id|SER_CTS
op_or
id|SER_DSR
)paren
suffix:semicolon
multiline_comment|/* inputs */
macro_line|#ifdef CONFIG_KGDB
multiline_comment|/* turn Rx interrupts on for GDB */
id|custom.intena
op_assign
id|IF_SETCLR
op_or
id|IF_RBF
suffix:semicolon
id|ser_RTSon
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|__debug_print_hex
r_void
id|__debug_print_hex
c_func
(paren
r_int
r_int
id|x
)paren
(brace
r_int
id|i
suffix:semicolon
r_char
id|hexchars
(braket
)braket
op_assign
l_string|&quot;0123456789ABCDEF&quot;
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|__debug_ser_out
c_func
(paren
id|hexchars
(braket
(paren
id|x
op_rshift
l_int|28
)paren
op_amp
l_int|15
)braket
)paren
suffix:semicolon
id|x
op_lshift_assign
l_int|4
suffix:semicolon
)brace
id|__debug_ser_out
c_func
(paren
l_char|&squot;&bslash;n&squot;
)paren
suffix:semicolon
id|__debug_ser_out
c_func
(paren
l_char|&squot;&bslash;r&squot;
)paren
suffix:semicolon
)brace
DECL|function|__debug_print_string
r_void
id|__debug_print_string
c_func
(paren
r_char
op_star
id|s
)paren
(brace
r_int
r_char
id|c
suffix:semicolon
r_while
c_loop
(paren
(paren
id|c
op_assign
op_star
id|s
op_increment
)paren
)paren
(brace
id|__debug_ser_out
c_func
(paren
id|c
)paren
suffix:semicolon
)brace
id|__debug_ser_out
c_func
(paren
l_char|&squot;&bslash;n&squot;
)paren
suffix:semicolon
id|__debug_ser_out
c_func
(paren
l_char|&squot;&bslash;r&squot;
)paren
suffix:semicolon
)brace
DECL|function|apus_progress
r_static
r_void
id|apus_progress
c_func
(paren
r_char
op_star
id|s
comma
r_int
r_int
id|value
)paren
(brace
id|__debug_print_string
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************** init */
multiline_comment|/* The number of spurious interrupts */
DECL|variable|num_spurious
r_volatile
r_int
r_int
id|num_spurious
suffix:semicolon
r_extern
r_struct
id|irqaction
id|amiga_sys_irqaction
(braket
id|AUTO_IRQS
)braket
suffix:semicolon
r_extern
r_void
id|amiga_enable_irq
c_func
(paren
r_int
r_int
id|irq
)paren
suffix:semicolon
r_extern
r_void
id|amiga_disable_irq
c_func
(paren
r_int
r_int
id|irq
)paren
suffix:semicolon
DECL|variable|amiga_sys_irqctrl
r_struct
id|hw_interrupt_type
id|amiga_sys_irqctrl
op_assign
(brace
r_typename
suffix:colon
l_string|&quot;Amiga IPL&quot;
comma
id|end
suffix:colon
id|apus_end_irq
comma
)brace
suffix:semicolon
DECL|variable|amiga_irqctrl
r_struct
id|hw_interrupt_type
id|amiga_irqctrl
op_assign
(brace
r_typename
suffix:colon
l_string|&quot;Amiga    &quot;
comma
id|enable
suffix:colon
id|amiga_enable_irq
comma
id|disable
suffix:colon
id|amiga_disable_irq
comma
)brace
suffix:semicolon
DECL|macro|HARDWARE_MAPPED_SIZE
mdefine_line|#define HARDWARE_MAPPED_SIZE (512*1024)
DECL|function|apus_find_end_of_memory
r_int
r_int
id|__init
id|apus_find_end_of_memory
c_func
(paren
r_void
)paren
(brace
r_int
id|shadow
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|total
suffix:semicolon
multiline_comment|/* The memory size reported by ADOS excludes the 512KB&n;&t;   reserved for PPC exception registers and possibly 512KB&n;&t;   containing a shadow of the ADOS ROM. */
(brace
r_int
r_int
id|size
op_assign
id|memory
(braket
l_int|0
)braket
dot
id|size
suffix:semicolon
multiline_comment|/* If 2MB aligned, size was probably user&n;                   specified. We can&squot;t tell anything about shadowing&n;                   in this case so skip shadow assignment. */
r_if
c_cond
(paren
l_int|0
op_ne
(paren
id|size
op_amp
l_int|0x1fffff
)paren
)paren
(brace
multiline_comment|/* Align to 512KB to ensure correct handling&n;&t;&t;&t;   of both memfile and system specified&n;&t;&t;&t;   sizes. */
id|size
op_assign
(paren
(paren
id|size
op_plus
l_int|0x0007ffff
)paren
op_amp
l_int|0xfff80000
)paren
suffix:semicolon
multiline_comment|/* If memory is 1MB aligned, assume&n;                           shadowing. */
id|shadow
op_assign
op_logical_neg
(paren
id|size
op_amp
l_int|0x80000
)paren
suffix:semicolon
)brace
multiline_comment|/* Add the chunk that ADOS does not see. by aligning&n;                   the size to the nearest 2MB limit upwards.  */
id|memory
(braket
l_int|0
)braket
dot
id|size
op_assign
(paren
(paren
id|size
op_plus
l_int|0x001fffff
)paren
op_amp
l_int|0xffe00000
)paren
suffix:semicolon
)brace
id|ppc_memstart
op_assign
id|memory
(braket
l_int|0
)braket
dot
id|addr
suffix:semicolon
id|ppc_memoffset
op_assign
id|PAGE_OFFSET
op_minus
id|PPC_MEMSTART
suffix:semicolon
id|total
op_assign
id|memory
(braket
l_int|0
)braket
dot
id|size
suffix:semicolon
multiline_comment|/* Remove the memory chunks that are controlled by special&n;           Phase5 hardware. */
multiline_comment|/* Remove the upper 512KB if it contains a shadow of&n;&t;   the ADOS ROM. FIXME: It might be possible to&n;&t;   disable this shadow HW. Check the booter&n;&t;   (ppc_boot.c) */
r_if
c_cond
(paren
id|shadow
)paren
id|total
op_sub_assign
id|HARDWARE_MAPPED_SIZE
suffix:semicolon
multiline_comment|/* Remove the upper 512KB where the PPC exception&n;&t;   vectors are mapped. */
id|total
op_sub_assign
id|HARDWARE_MAPPED_SIZE
suffix:semicolon
multiline_comment|/* Linux/APUS only handles one block of memory -- the one on&n;&t;   the PowerUP board. Other system memory is horrible slow in&n;&t;   comparison. The user can use other memory for swapping&n;&t;   using the z2ram device. */
r_return
id|total
suffix:semicolon
)brace
r_static
r_void
id|__init
DECL|function|apus_map_io
id|apus_map_io
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Map PPC exception vectors. */
id|io_block_mapping
c_func
(paren
l_int|0xfff00000
comma
l_int|0xfff00000
comma
l_int|0x00020000
comma
id|_PAGE_KERNEL
)paren
suffix:semicolon
multiline_comment|/* Map chip and ZorroII memory */
id|io_block_mapping
c_func
(paren
id|zTwoBase
comma
l_int|0x00000000
comma
l_int|0x01000000
comma
id|_PAGE_IO
)paren
suffix:semicolon
)brace
id|__init
DECL|function|apus_init_IRQ
r_void
id|apus_init_IRQ
c_func
(paren
r_void
)paren
(brace
r_struct
id|irqaction
op_star
id|action
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#ifdef CONFIG_PCI
id|apus_setup_pci_ptrs
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|AMI_IRQS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|irq_desc
(braket
id|i
)braket
dot
id|status
op_assign
id|IRQ_LEVEL
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|IRQ_AMIGA_AUTO
)paren
(brace
id|irq_desc
(braket
id|i
)braket
dot
id|handler
op_assign
op_amp
id|amiga_irqctrl
suffix:semicolon
)brace
r_else
(brace
id|irq_desc
(braket
id|i
)braket
dot
id|handler
op_assign
op_amp
id|amiga_sys_irqctrl
suffix:semicolon
id|action
op_assign
op_amp
id|amiga_sys_irqaction
(braket
id|i
op_minus
id|IRQ_AMIGA_AUTO
)braket
suffix:semicolon
r_if
c_cond
(paren
id|action-&gt;name
)paren
id|setup_irq
c_func
(paren
id|i
comma
id|action
)paren
suffix:semicolon
)brace
)brace
id|amiga_init_IRQ
c_func
(paren
)paren
suffix:semicolon
)brace
id|__init
DECL|function|platform_init
r_void
id|platform_init
c_func
(paren
r_int
r_int
id|r3
comma
r_int
r_int
id|r4
comma
r_int
r_int
id|r5
comma
r_int
r_int
id|r6
comma
r_int
r_int
id|r7
)paren
(brace
r_extern
r_int
id|parse_bootinfo
c_func
(paren
r_const
r_struct
id|bi_record
op_star
)paren
suffix:semicolon
r_extern
r_char
id|_end
(braket
)braket
suffix:semicolon
multiline_comment|/* Parse bootinfo. The bootinfo is located right after&n;           the kernel bss */
id|parse_bootinfo
c_func
(paren
(paren
r_const
r_struct
id|bi_record
op_star
)paren
op_amp
id|_end
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_BLK_DEV_INITRD
multiline_comment|/* Take care of initrd if we have one. Use data from&n;&t;   bootinfo to avoid the need to initialize PPC&n;&t;   registers when kernel is booted via a PPC reset. */
r_if
c_cond
(paren
id|ramdisk.addr
)paren
(brace
id|initrd_start
op_assign
(paren
r_int
r_int
)paren
id|__va
c_func
(paren
id|ramdisk.addr
)paren
suffix:semicolon
id|initrd_end
op_assign
(paren
r_int
r_int
)paren
id|__va
c_func
(paren
id|ramdisk.size
op_plus
id|ramdisk.addr
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_BLK_DEV_INITRD */
id|ISA_DMA_THRESHOLD
op_assign
l_int|0x00ffffff
suffix:semicolon
id|ppc_md.setup_arch
op_assign
id|apus_setup_arch
suffix:semicolon
id|ppc_md.show_cpuinfo
op_assign
id|apus_show_cpuinfo
suffix:semicolon
id|ppc_md.init_IRQ
op_assign
id|apus_init_IRQ
suffix:semicolon
id|ppc_md.get_irq
op_assign
id|apus_get_irq
suffix:semicolon
macro_line|#ifdef CONFIG_HEARTBEAT
id|ppc_md.heartbeat
op_assign
id|apus_heartbeat
suffix:semicolon
id|ppc_md.heartbeat_count
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
macro_line|#ifdef APUS_DEBUG
id|__debug_serinit
c_func
(paren
)paren
suffix:semicolon
id|ppc_md.progress
op_assign
id|apus_progress
suffix:semicolon
macro_line|#endif
id|ppc_md.init
op_assign
l_int|NULL
suffix:semicolon
id|ppc_md.restart
op_assign
id|apus_restart
suffix:semicolon
id|ppc_md.power_off
op_assign
id|apus_power_off
suffix:semicolon
id|ppc_md.halt
op_assign
id|apus_halt
suffix:semicolon
id|ppc_md.time_init
op_assign
l_int|NULL
suffix:semicolon
id|ppc_md.set_rtc_time
op_assign
id|apus_set_rtc_time
suffix:semicolon
id|ppc_md.get_rtc_time
op_assign
id|apus_get_rtc_time
suffix:semicolon
id|ppc_md.calibrate_decr
op_assign
id|apus_calibrate_decr
suffix:semicolon
id|ppc_md.find_end_of_memory
op_assign
id|apus_find_end_of_memory
suffix:semicolon
id|ppc_md.setup_io_mappings
op_assign
id|apus_map_io
suffix:semicolon
)brace
eof
