multiline_comment|/*&n; *  arch/ppc/platforms/pmac_nvram.c&n; *&n; *  Copyright (C) 2002 Benjamin Herrenschmidt (benh@kernel.crashing.org)&n; *&n; *  This program is free software; you can redistribute it and/or&n; *  modify it under the terms of the GNU General Public License&n; *  as published by the Free Software Foundation; either version&n; *  2 of the License, or (at your option) any later version.&n; *&n; *  Todo: - add support for the OF persistent properties&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/nvram.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/adb.h&gt;
macro_line|#include &lt;linux/pmu.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;linux/completion.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/sections.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/nvram.h&gt;
DECL|macro|DEBUG
mdefine_line|#define DEBUG
macro_line|#ifdef DEBUG
DECL|macro|DBG
mdefine_line|#define DBG(x...) printk(x)
macro_line|#else
DECL|macro|DBG
mdefine_line|#define DBG(x...)
macro_line|#endif
DECL|macro|NVRAM_SIZE
mdefine_line|#define NVRAM_SIZE&t;&t;0x2000&t;/* 8kB of non-volatile RAM */
DECL|macro|CORE99_SIGNATURE
mdefine_line|#define CORE99_SIGNATURE&t;0x5a
DECL|macro|CORE99_ADLER_START
mdefine_line|#define CORE99_ADLER_START&t;0x14
multiline_comment|/* On Core99, nvram is either a sharp, a micron or an AMD flash */
DECL|macro|SM_FLASH_STATUS_DONE
mdefine_line|#define SM_FLASH_STATUS_DONE&t;0x80
DECL|macro|SM_FLASH_STATUS_ERR
mdefine_line|#define SM_FLASH_STATUS_ERR&t;&t;0x38
DECL|macro|SM_FLASH_CMD_ERASE_CONFIRM
mdefine_line|#define SM_FLASH_CMD_ERASE_CONFIRM&t;0xd0
DECL|macro|SM_FLASH_CMD_ERASE_SETUP
mdefine_line|#define SM_FLASH_CMD_ERASE_SETUP&t;0x20
DECL|macro|SM_FLASH_CMD_RESET
mdefine_line|#define SM_FLASH_CMD_RESET&t;&t;0xff
DECL|macro|SM_FLASH_CMD_WRITE_SETUP
mdefine_line|#define SM_FLASH_CMD_WRITE_SETUP&t;0x40
DECL|macro|SM_FLASH_CMD_CLEAR_STATUS
mdefine_line|#define SM_FLASH_CMD_CLEAR_STATUS&t;0x50
DECL|macro|SM_FLASH_CMD_READ_STATUS
mdefine_line|#define SM_FLASH_CMD_READ_STATUS&t;0x70
multiline_comment|/* CHRP NVRAM header */
DECL|struct|chrp_header
r_struct
id|chrp_header
(brace
DECL|member|signature
id|u8
id|signature
suffix:semicolon
DECL|member|cksum
id|u8
id|cksum
suffix:semicolon
DECL|member|len
id|u16
id|len
suffix:semicolon
DECL|member|name
r_char
id|name
(braket
l_int|12
)braket
suffix:semicolon
DECL|member|data
id|u8
id|data
(braket
l_int|0
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|core99_header
r_struct
id|core99_header
(brace
DECL|member|hdr
r_struct
id|chrp_header
id|hdr
suffix:semicolon
DECL|member|adler
id|u32
id|adler
suffix:semicolon
DECL|member|generation
id|u32
id|generation
suffix:semicolon
DECL|member|reserved
id|u32
id|reserved
(braket
l_int|2
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * Read and write the non-volatile RAM on PowerMacs and CHRP machines.&n; */
DECL|variable|nvram_naddrs
r_static
r_int
id|nvram_naddrs
suffix:semicolon
DECL|variable|nvram_addr
r_static
r_volatile
r_int
r_char
op_star
id|nvram_addr
suffix:semicolon
DECL|variable|nvram_data
r_static
r_volatile
r_int
r_char
op_star
id|nvram_data
suffix:semicolon
DECL|variable|nvram_mult
DECL|variable|is_core_99
r_static
r_int
id|nvram_mult
comma
id|is_core_99
suffix:semicolon
DECL|variable|core99_bank
r_static
r_int
id|core99_bank
op_assign
l_int|0
suffix:semicolon
DECL|variable|nvram_partitions
r_static
r_int
id|nvram_partitions
(braket
l_int|3
)braket
suffix:semicolon
r_static
id|DEFINE_SPINLOCK
c_func
(paren
id|nv_lock
)paren
suffix:semicolon
r_extern
r_int
id|pmac_newworld
suffix:semicolon
r_extern
r_int
id|system_running
suffix:semicolon
DECL|variable|core99_write_bank
r_static
r_int
(paren
op_star
id|core99_write_bank
)paren
(paren
r_int
id|bank
comma
id|u8
op_star
id|datas
)paren
suffix:semicolon
DECL|variable|core99_erase_bank
r_static
r_int
(paren
op_star
id|core99_erase_bank
)paren
(paren
r_int
id|bank
)paren
suffix:semicolon
DECL|variable|__pmacdata
r_static
r_char
op_star
id|nvram_image
id|__pmacdata
suffix:semicolon
DECL|function|core99_nvram_read_byte
r_static
r_int
r_char
id|__pmac
id|core99_nvram_read_byte
c_func
(paren
r_int
id|addr
)paren
(brace
r_if
c_cond
(paren
id|nvram_image
op_eq
l_int|NULL
)paren
r_return
l_int|0xff
suffix:semicolon
r_return
id|nvram_image
(braket
id|addr
)braket
suffix:semicolon
)brace
DECL|function|core99_nvram_write_byte
r_static
r_void
id|__pmac
id|core99_nvram_write_byte
c_func
(paren
r_int
id|addr
comma
r_int
r_char
id|val
)paren
(brace
r_if
c_cond
(paren
id|nvram_image
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|nvram_image
(braket
id|addr
)braket
op_assign
id|val
suffix:semicolon
)brace
DECL|function|direct_nvram_read_byte
r_static
r_int
r_char
id|__openfirmware
id|direct_nvram_read_byte
c_func
(paren
r_int
id|addr
)paren
(brace
r_return
id|in_8
c_func
(paren
op_amp
id|nvram_data
(braket
(paren
id|addr
op_amp
(paren
id|NVRAM_SIZE
op_minus
l_int|1
)paren
)paren
op_star
id|nvram_mult
)braket
)paren
suffix:semicolon
)brace
DECL|function|direct_nvram_write_byte
r_static
r_void
id|__openfirmware
id|direct_nvram_write_byte
c_func
(paren
r_int
id|addr
comma
r_int
r_char
id|val
)paren
(brace
id|out_8
c_func
(paren
op_amp
id|nvram_data
(braket
(paren
id|addr
op_amp
(paren
id|NVRAM_SIZE
op_minus
l_int|1
)paren
)paren
op_star
id|nvram_mult
)braket
comma
id|val
)paren
suffix:semicolon
)brace
DECL|function|indirect_nvram_read_byte
r_static
r_int
r_char
id|__pmac
id|indirect_nvram_read_byte
c_func
(paren
r_int
id|addr
)paren
(brace
r_int
r_char
id|val
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|nv_lock
comma
id|flags
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|nvram_addr
comma
id|addr
op_rshift
l_int|5
)paren
suffix:semicolon
id|val
op_assign
id|in_8
c_func
(paren
op_amp
id|nvram_data
(braket
(paren
id|addr
op_amp
l_int|0x1f
)paren
op_lshift
l_int|4
)braket
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|nv_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
DECL|function|indirect_nvram_write_byte
r_static
r_void
id|__pmac
id|indirect_nvram_write_byte
c_func
(paren
r_int
id|addr
comma
r_int
r_char
id|val
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|nv_lock
comma
id|flags
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|nvram_addr
comma
id|addr
op_rshift
l_int|5
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|nvram_data
(braket
(paren
id|addr
op_amp
l_int|0x1f
)paren
op_lshift
l_int|4
)braket
comma
id|val
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|nv_lock
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ADB_PMU
DECL|function|pmu_nvram_complete
r_static
r_void
id|__pmac
id|pmu_nvram_complete
c_func
(paren
r_struct
id|adb_request
op_star
id|req
)paren
(brace
r_if
c_cond
(paren
id|req-&gt;arg
)paren
id|complete
c_func
(paren
(paren
r_struct
id|completion
op_star
)paren
id|req-&gt;arg
)paren
suffix:semicolon
)brace
DECL|function|pmu_nvram_read_byte
r_static
r_int
r_char
id|__pmac
id|pmu_nvram_read_byte
c_func
(paren
r_int
id|addr
)paren
(brace
r_struct
id|adb_request
id|req
suffix:semicolon
id|DECLARE_COMPLETION
c_func
(paren
id|req_complete
)paren
suffix:semicolon
id|req.arg
op_assign
id|system_state
op_eq
id|SYSTEM_RUNNING
ques
c_cond
op_amp
id|req_complete
suffix:colon
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|pmu_request
c_func
(paren
op_amp
id|req
comma
id|pmu_nvram_complete
comma
l_int|3
comma
id|PMU_READ_NVRAM
comma
(paren
id|addr
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|addr
op_amp
l_int|0xff
)paren
)paren
r_return
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|system_state
op_eq
id|SYSTEM_RUNNING
)paren
id|wait_for_completion
c_func
(paren
op_amp
id|req_complete
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
r_return
id|req.reply
(braket
l_int|0
)braket
suffix:semicolon
)brace
DECL|function|pmu_nvram_write_byte
r_static
r_void
id|__pmac
id|pmu_nvram_write_byte
c_func
(paren
r_int
id|addr
comma
r_int
r_char
id|val
)paren
(brace
r_struct
id|adb_request
id|req
suffix:semicolon
id|DECLARE_COMPLETION
c_func
(paren
id|req_complete
)paren
suffix:semicolon
id|req.arg
op_assign
id|system_state
op_eq
id|SYSTEM_RUNNING
ques
c_cond
op_amp
id|req_complete
suffix:colon
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|pmu_request
c_func
(paren
op_amp
id|req
comma
id|pmu_nvram_complete
comma
l_int|4
comma
id|PMU_WRITE_NVRAM
comma
(paren
id|addr
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|addr
op_amp
l_int|0xff
comma
id|val
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|system_state
op_eq
id|SYSTEM_RUNNING
)paren
id|wait_for_completion
c_func
(paren
op_amp
id|req_complete
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ADB_PMU */
DECL|function|chrp_checksum
r_static
id|u8
id|__pmac
id|chrp_checksum
c_func
(paren
r_struct
id|chrp_header
op_star
id|hdr
)paren
(brace
id|u8
op_star
id|ptr
suffix:semicolon
id|u16
id|sum
op_assign
id|hdr-&gt;signature
suffix:semicolon
r_for
c_loop
(paren
id|ptr
op_assign
(paren
id|u8
op_star
)paren
op_amp
id|hdr-&gt;len
suffix:semicolon
id|ptr
OL
id|hdr-&gt;data
suffix:semicolon
id|ptr
op_increment
)paren
id|sum
op_add_assign
op_star
id|ptr
suffix:semicolon
r_while
c_loop
(paren
id|sum
OG
l_int|0xFF
)paren
id|sum
op_assign
(paren
id|sum
op_amp
l_int|0xFF
)paren
op_plus
(paren
id|sum
op_rshift
l_int|8
)paren
suffix:semicolon
r_return
id|sum
suffix:semicolon
)brace
DECL|function|core99_calc_adler
r_static
id|u32
id|__pmac
id|core99_calc_adler
c_func
(paren
id|u8
op_star
id|buffer
)paren
(brace
r_int
id|cnt
suffix:semicolon
id|u32
id|low
comma
id|high
suffix:semicolon
id|buffer
op_add_assign
id|CORE99_ADLER_START
suffix:semicolon
id|low
op_assign
l_int|1
suffix:semicolon
id|high
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
(paren
id|NVRAM_SIZE
op_minus
id|CORE99_ADLER_START
)paren
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|cnt
op_mod
l_int|5000
)paren
op_eq
l_int|0
)paren
(brace
id|high
op_mod_assign
l_int|65521UL
suffix:semicolon
id|high
op_mod_assign
l_int|65521UL
suffix:semicolon
)brace
id|low
op_add_assign
id|buffer
(braket
id|cnt
)braket
suffix:semicolon
id|high
op_add_assign
id|low
suffix:semicolon
)brace
id|low
op_mod_assign
l_int|65521UL
suffix:semicolon
id|high
op_mod_assign
l_int|65521UL
suffix:semicolon
r_return
(paren
id|high
op_lshift
l_int|16
)paren
op_or
id|low
suffix:semicolon
)brace
DECL|function|core99_check
r_static
id|u32
id|__pmac
id|core99_check
c_func
(paren
id|u8
op_star
id|datas
)paren
(brace
r_struct
id|core99_header
op_star
id|hdr99
op_assign
(paren
r_struct
id|core99_header
op_star
)paren
id|datas
suffix:semicolon
r_if
c_cond
(paren
id|hdr99-&gt;hdr.signature
op_ne
id|CORE99_SIGNATURE
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Invalid signature&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hdr99-&gt;hdr.cksum
op_ne
id|chrp_checksum
c_func
(paren
op_amp
id|hdr99-&gt;hdr
)paren
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Invalid checksum&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hdr99-&gt;adler
op_ne
id|core99_calc_adler
c_func
(paren
id|datas
)paren
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Invalid adler&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|hdr99-&gt;generation
suffix:semicolon
)brace
DECL|function|sm_erase_bank
r_static
r_int
id|__pmac
id|sm_erase_bank
c_func
(paren
r_int
id|bank
)paren
(brace
r_int
id|stat
comma
id|i
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
id|u8
op_star
id|base
op_assign
(paren
id|u8
op_star
)paren
id|nvram_data
op_plus
id|core99_bank
op_star
id|NVRAM_SIZE
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;nvram: Sharp/Micron Erasing bank %d...&bslash;n&quot;
comma
id|bank
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|base
comma
id|SM_FLASH_CMD_ERASE_SETUP
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|base
comma
id|SM_FLASH_CMD_ERASE_CONFIRM
)paren
suffix:semicolon
id|timeout
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
op_increment
id|timeout
OG
l_int|1000000
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;nvram: Sharp/Miron flash erase timeout !&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|out_8
c_func
(paren
id|base
comma
id|SM_FLASH_CMD_READ_STATUS
)paren
suffix:semicolon
id|stat
op_assign
id|in_8
c_func
(paren
id|base
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|stat
op_amp
id|SM_FLASH_STATUS_DONE
)paren
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|base
comma
id|SM_FLASH_CMD_CLEAR_STATUS
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|base
comma
id|SM_FLASH_CMD_RESET
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NVRAM_SIZE
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|base
(braket
id|i
)braket
op_ne
l_int|0xff
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;nvram: Sharp/Micron flash erase failed !&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sm_write_bank
r_static
r_int
id|__pmac
id|sm_write_bank
c_func
(paren
r_int
id|bank
comma
id|u8
op_star
id|datas
)paren
(brace
r_int
id|i
comma
id|stat
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
id|u8
op_star
id|base
op_assign
(paren
id|u8
op_star
)paren
id|nvram_data
op_plus
id|core99_bank
op_star
id|NVRAM_SIZE
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;nvram: Sharp/Micron Writing bank %d...&bslash;n&quot;
comma
id|bank
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NVRAM_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|out_8
c_func
(paren
id|base
op_plus
id|i
comma
id|SM_FLASH_CMD_WRITE_SETUP
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|base
op_plus
id|i
comma
id|datas
(braket
id|i
)braket
)paren
suffix:semicolon
id|timeout
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
op_increment
id|timeout
OG
l_int|1000000
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;nvram: Sharp/Micron flash write timeout !&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|out_8
c_func
(paren
id|base
comma
id|SM_FLASH_CMD_READ_STATUS
)paren
suffix:semicolon
id|stat
op_assign
id|in_8
c_func
(paren
id|base
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|stat
op_amp
id|SM_FLASH_STATUS_DONE
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|stat
op_amp
id|SM_FLASH_STATUS_DONE
)paren
)paren
r_break
suffix:semicolon
)brace
id|out_8
c_func
(paren
id|base
comma
id|SM_FLASH_CMD_CLEAR_STATUS
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|base
comma
id|SM_FLASH_CMD_RESET
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NVRAM_SIZE
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|base
(braket
id|i
)braket
op_ne
id|datas
(braket
id|i
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;nvram: Sharp/Micron flash write failed !&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|amd_erase_bank
r_static
r_int
id|__pmac
id|amd_erase_bank
c_func
(paren
r_int
id|bank
)paren
(brace
r_int
id|i
comma
id|stat
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
id|u8
op_star
id|base
op_assign
(paren
id|u8
op_star
)paren
id|nvram_data
op_plus
id|core99_bank
op_star
id|NVRAM_SIZE
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;nvram: AMD Erasing bank %d...&bslash;n&quot;
comma
id|bank
)paren
suffix:semicolon
multiline_comment|/* Unlock 1 */
id|out_8
c_func
(paren
id|base
op_plus
l_int|0x555
comma
l_int|0xaa
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Unlock 2 */
id|out_8
c_func
(paren
id|base
op_plus
l_int|0x2aa
comma
l_int|0x55
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Sector-Erase */
id|out_8
c_func
(paren
id|base
op_plus
l_int|0x555
comma
l_int|0x80
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|base
op_plus
l_int|0x555
comma
l_int|0xaa
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|base
op_plus
l_int|0x2aa
comma
l_int|0x55
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|base
comma
l_int|0x30
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|timeout
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
op_increment
id|timeout
OG
l_int|1000000
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;nvram: AMD flash erase timeout !&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|stat
op_assign
id|in_8
c_func
(paren
id|base
)paren
op_xor
id|in_8
c_func
(paren
id|base
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|stat
op_ne
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Reset */
id|out_8
c_func
(paren
id|base
comma
l_int|0xf0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NVRAM_SIZE
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|base
(braket
id|i
)braket
op_ne
l_int|0xff
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;nvram: AMD flash erase failed !&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|amd_write_bank
r_static
r_int
id|__pmac
id|amd_write_bank
c_func
(paren
r_int
id|bank
comma
id|u8
op_star
id|datas
)paren
(brace
r_int
id|i
comma
id|stat
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
id|u8
op_star
id|base
op_assign
(paren
id|u8
op_star
)paren
id|nvram_data
op_plus
id|core99_bank
op_star
id|NVRAM_SIZE
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;nvram: AMD Writing bank %d...&bslash;n&quot;
comma
id|bank
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NVRAM_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Unlock 1 */
id|out_8
c_func
(paren
id|base
op_plus
l_int|0x555
comma
l_int|0xaa
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Unlock 2 */
id|out_8
c_func
(paren
id|base
op_plus
l_int|0x2aa
comma
l_int|0x55
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Write single word */
id|out_8
c_func
(paren
id|base
op_plus
l_int|0x555
comma
l_int|0xa0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|base
op_plus
id|i
comma
id|datas
(braket
id|i
)braket
)paren
suffix:semicolon
id|timeout
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
op_increment
id|timeout
OG
l_int|1000000
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;nvram: AMD flash write timeout !&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|stat
op_assign
id|in_8
c_func
(paren
id|base
)paren
op_xor
id|in_8
c_func
(paren
id|base
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|stat
op_ne
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_ne
l_int|0
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/* Reset */
id|out_8
c_func
(paren
id|base
comma
l_int|0xf0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NVRAM_SIZE
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|base
(braket
id|i
)braket
op_ne
id|datas
(braket
id|i
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;nvram: AMD flash write failed !&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lookup_partitions
r_static
r_void
id|__init
id|lookup_partitions
c_func
(paren
r_void
)paren
(brace
id|u8
id|buffer
(braket
l_int|17
)braket
suffix:semicolon
r_int
id|i
comma
id|offset
suffix:semicolon
r_struct
id|chrp_header
op_star
id|hdr
suffix:semicolon
r_if
c_cond
(paren
id|pmac_newworld
)paren
(brace
id|nvram_partitions
(braket
id|pmac_nvram_OF
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
id|nvram_partitions
(braket
id|pmac_nvram_XPRAM
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
id|nvram_partitions
(braket
id|pmac_nvram_NR
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
id|hdr
op_assign
(paren
r_struct
id|chrp_header
op_star
)paren
id|buffer
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
id|buffer
(braket
l_int|16
)braket
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|buffer
(braket
id|i
)braket
op_assign
id|nvram_read_byte
c_func
(paren
id|offset
op_plus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|hdr-&gt;name
comma
l_string|&quot;common&quot;
)paren
)paren
id|nvram_partitions
(braket
id|pmac_nvram_OF
)braket
op_assign
id|offset
op_plus
l_int|0x10
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|hdr-&gt;name
comma
l_string|&quot;APL,MacOS75&quot;
)paren
)paren
(brace
id|nvram_partitions
(braket
id|pmac_nvram_XPRAM
)braket
op_assign
id|offset
op_plus
l_int|0x10
suffix:semicolon
id|nvram_partitions
(braket
id|pmac_nvram_NR
)braket
op_assign
id|offset
op_plus
l_int|0x110
suffix:semicolon
)brace
id|offset
op_add_assign
(paren
id|hdr-&gt;len
op_star
l_int|0x10
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|offset
OL
id|NVRAM_SIZE
)paren
(brace
suffix:semicolon
)brace
)brace
r_else
(brace
id|nvram_partitions
(braket
id|pmac_nvram_OF
)braket
op_assign
l_int|0x1800
suffix:semicolon
id|nvram_partitions
(braket
id|pmac_nvram_XPRAM
)braket
op_assign
l_int|0x1300
suffix:semicolon
id|nvram_partitions
(braket
id|pmac_nvram_NR
)braket
op_assign
l_int|0x1400
suffix:semicolon
)brace
id|DBG
c_func
(paren
l_string|&quot;nvram: OF partition at 0x%x&bslash;n&quot;
comma
id|nvram_partitions
(braket
id|pmac_nvram_OF
)braket
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;nvram: XP partition at 0x%x&bslash;n&quot;
comma
id|nvram_partitions
(braket
id|pmac_nvram_XPRAM
)braket
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;nvram: NR partition at 0x%x&bslash;n&quot;
comma
id|nvram_partitions
(braket
id|pmac_nvram_NR
)braket
)paren
suffix:semicolon
)brace
DECL|function|core99_nvram_sync
r_static
r_void
id|__pmac
id|core99_nvram_sync
c_func
(paren
r_void
)paren
(brace
r_struct
id|core99_header
op_star
id|hdr99
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_core_99
op_logical_or
op_logical_neg
id|nvram_data
op_logical_or
op_logical_neg
id|nvram_image
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|nv_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|nvram_image
comma
(paren
id|u8
op_star
)paren
id|nvram_data
op_plus
id|core99_bank
op_star
id|NVRAM_SIZE
comma
id|NVRAM_SIZE
)paren
)paren
r_goto
id|bail
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;Updating nvram...&bslash;n&quot;
)paren
suffix:semicolon
id|hdr99
op_assign
(paren
r_struct
id|core99_header
op_star
)paren
id|nvram_image
suffix:semicolon
id|hdr99-&gt;generation
op_increment
suffix:semicolon
id|hdr99-&gt;hdr.signature
op_assign
id|CORE99_SIGNATURE
suffix:semicolon
id|hdr99-&gt;hdr.cksum
op_assign
id|chrp_checksum
c_func
(paren
op_amp
id|hdr99-&gt;hdr
)paren
suffix:semicolon
id|hdr99-&gt;adler
op_assign
id|core99_calc_adler
c_func
(paren
id|nvram_image
)paren
suffix:semicolon
id|core99_bank
op_assign
id|core99_bank
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|core99_erase_bank
)paren
r_if
c_cond
(paren
id|core99_erase_bank
c_func
(paren
id|core99_bank
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nvram: Error erasing bank %d&bslash;n&quot;
comma
id|core99_bank
)paren
suffix:semicolon
r_goto
id|bail
suffix:semicolon
)brace
r_if
c_cond
(paren
id|core99_write_bank
)paren
r_if
c_cond
(paren
id|core99_write_bank
c_func
(paren
id|core99_bank
comma
id|nvram_image
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;nvram: Error writing bank %d&bslash;n&quot;
comma
id|core99_bank
)paren
suffix:semicolon
id|bail
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|nv_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|mdelay
c_func
(paren
l_int|2000
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|pmac_nvram_init
r_void
id|__init
id|pmac_nvram_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|dp
suffix:semicolon
id|nvram_naddrs
op_assign
l_int|0
suffix:semicolon
id|dp
op_assign
id|find_devices
c_func
(paren
l_string|&quot;nvram&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dp
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Can&squot;t find NVRAM device&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|nvram_naddrs
op_assign
id|dp-&gt;n_addrs
suffix:semicolon
id|is_core_99
op_assign
id|device_is_compatible
c_func
(paren
id|dp
comma
l_string|&quot;nvram,flash&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_core_99
)paren
(brace
r_int
id|i
suffix:semicolon
id|u32
id|gen_bank0
comma
id|gen_bank1
suffix:semicolon
r_if
c_cond
(paren
id|nvram_naddrs
OL
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;nvram: no address&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|nvram_image
op_assign
id|alloc_bootmem
c_func
(paren
id|NVRAM_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nvram_image
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;nvram: can&squot;t allocate ram image&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|nvram_data
op_assign
id|ioremap
c_func
(paren
id|dp-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
comma
id|NVRAM_SIZE
op_star
l_int|2
)paren
suffix:semicolon
id|nvram_naddrs
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Make sure we get the correct case */
id|DBG
c_func
(paren
l_string|&quot;nvram: Checking bank 0...&bslash;n&quot;
)paren
suffix:semicolon
id|gen_bank0
op_assign
id|core99_check
c_func
(paren
(paren
id|u8
op_star
)paren
id|nvram_data
)paren
suffix:semicolon
id|gen_bank1
op_assign
id|core99_check
c_func
(paren
(paren
id|u8
op_star
)paren
id|nvram_data
op_plus
id|NVRAM_SIZE
)paren
suffix:semicolon
id|core99_bank
op_assign
(paren
id|gen_bank0
OL
id|gen_bank1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;nvram: gen0=%d, gen1=%d&bslash;n&quot;
comma
id|gen_bank0
comma
id|gen_bank1
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;nvram: Active bank is: %d&bslash;n&quot;
comma
id|core99_bank
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NVRAM_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|nvram_image
(braket
id|i
)braket
op_assign
id|nvram_data
(braket
id|i
op_plus
id|core99_bank
op_star
id|NVRAM_SIZE
)braket
suffix:semicolon
id|ppc_md.nvram_read_val
op_assign
id|core99_nvram_read_byte
suffix:semicolon
id|ppc_md.nvram_write_val
op_assign
id|core99_nvram_write_byte
suffix:semicolon
id|ppc_md.nvram_sync
op_assign
id|core99_nvram_sync
suffix:semicolon
multiline_comment|/* &n;&t;&t; * Maybe we could be smarter here though making an exclusive list&n;&t;&t; * of known flash chips is a bit nasty as older OF didn&squot;t provide us&n;&t;&t; * with a useful &quot;compatible&quot; entry. A solution would be to really&n;&t;&t; * identify the chip using flash id commands and base ourselves on&n;&t;&t; * a list of known chips IDs&n;&t;&t; */
r_if
c_cond
(paren
id|device_is_compatible
c_func
(paren
id|dp
comma
l_string|&quot;amd-0137&quot;
)paren
)paren
(brace
id|core99_erase_bank
op_assign
id|amd_erase_bank
suffix:semicolon
id|core99_write_bank
op_assign
id|amd_write_bank
suffix:semicolon
)brace
r_else
(brace
id|core99_erase_bank
op_assign
id|sm_erase_bank
suffix:semicolon
id|core99_write_bank
op_assign
id|sm_write_bank
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|_machine
op_eq
id|_MACH_chrp
op_logical_and
id|nvram_naddrs
op_eq
l_int|1
)paren
(brace
id|nvram_data
op_assign
id|ioremap
c_func
(paren
id|dp-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
op_plus
id|isa_mem_base
comma
id|dp-&gt;addrs
(braket
l_int|0
)braket
dot
id|size
)paren
suffix:semicolon
id|nvram_mult
op_assign
l_int|1
suffix:semicolon
id|ppc_md.nvram_read_val
op_assign
id|direct_nvram_read_byte
suffix:semicolon
id|ppc_md.nvram_write_val
op_assign
id|direct_nvram_write_byte
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|nvram_naddrs
op_eq
l_int|1
)paren
(brace
id|nvram_data
op_assign
id|ioremap
c_func
(paren
id|dp-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
comma
id|dp-&gt;addrs
(braket
l_int|0
)braket
dot
id|size
)paren
suffix:semicolon
id|nvram_mult
op_assign
(paren
id|dp-&gt;addrs
(braket
l_int|0
)braket
dot
id|size
op_plus
id|NVRAM_SIZE
op_minus
l_int|1
)paren
op_div
id|NVRAM_SIZE
suffix:semicolon
id|ppc_md.nvram_read_val
op_assign
id|direct_nvram_read_byte
suffix:semicolon
id|ppc_md.nvram_write_val
op_assign
id|direct_nvram_write_byte
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|nvram_naddrs
op_eq
l_int|2
)paren
(brace
id|nvram_addr
op_assign
id|ioremap
c_func
(paren
id|dp-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
comma
id|dp-&gt;addrs
(braket
l_int|0
)braket
dot
id|size
)paren
suffix:semicolon
id|nvram_data
op_assign
id|ioremap
c_func
(paren
id|dp-&gt;addrs
(braket
l_int|1
)braket
dot
id|address
comma
id|dp-&gt;addrs
(braket
l_int|1
)braket
dot
id|size
)paren
suffix:semicolon
id|ppc_md.nvram_read_val
op_assign
id|indirect_nvram_read_byte
suffix:semicolon
id|ppc_md.nvram_write_val
op_assign
id|indirect_nvram_write_byte
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|nvram_naddrs
op_eq
l_int|0
op_logical_and
id|sys_ctrler
op_eq
id|SYS_CTRLER_PMU
)paren
(brace
macro_line|#ifdef CONFIG_ADB_PMU
id|nvram_naddrs
op_assign
op_minus
l_int|1
suffix:semicolon
id|ppc_md.nvram_read_val
op_assign
id|pmu_nvram_read_byte
suffix:semicolon
id|ppc_md.nvram_write_val
op_assign
id|pmu_nvram_write_byte
suffix:semicolon
macro_line|#endif /* CONFIG_ADB_PMU */
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Don&squot;t know how to access NVRAM with %d addresses&bslash;n&quot;
comma
id|nvram_naddrs
)paren
suffix:semicolon
)brace
id|lookup_partitions
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|pmac_get_partition
r_int
id|__pmac
id|pmac_get_partition
c_func
(paren
r_int
id|partition
)paren
(brace
r_return
id|nvram_partitions
(braket
id|partition
)braket
suffix:semicolon
)brace
DECL|function|pmac_xpram_read
id|u8
id|__pmac
id|pmac_xpram_read
c_func
(paren
r_int
id|xpaddr
)paren
(brace
r_int
id|offset
op_assign
id|nvram_partitions
(braket
id|pmac_nvram_XPRAM
)braket
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
l_int|0
)paren
r_return
l_int|0xff
suffix:semicolon
r_return
id|ppc_md
dot
id|nvram_read_val
c_func
(paren
id|xpaddr
op_plus
id|offset
)paren
suffix:semicolon
)brace
DECL|function|pmac_xpram_write
r_void
id|__pmac
id|pmac_xpram_write
c_func
(paren
r_int
id|xpaddr
comma
id|u8
id|data
)paren
(brace
r_int
id|offset
op_assign
id|nvram_partitions
(braket
id|pmac_nvram_XPRAM
)braket
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
l_int|0
)paren
r_return
suffix:semicolon
id|ppc_md
dot
id|nvram_write_val
c_func
(paren
id|xpaddr
op_plus
id|offset
comma
id|data
)paren
suffix:semicolon
)brace
DECL|variable|pmac_get_partition
id|EXPORT_SYMBOL
c_func
(paren
id|pmac_get_partition
)paren
suffix:semicolon
DECL|variable|pmac_xpram_read
id|EXPORT_SYMBOL
c_func
(paren
id|pmac_xpram_read
)paren
suffix:semicolon
DECL|variable|pmac_xpram_write
id|EXPORT_SYMBOL
c_func
(paren
id|pmac_xpram_write
)paren
suffix:semicolon
eof
