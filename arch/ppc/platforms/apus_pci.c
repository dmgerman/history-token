multiline_comment|/*&n; * Copyright (C) Michel D&#xfffd;nzer &lt;michdaen@iiic.ethz.ch&gt;&n; *&n; * APUS PCI routines.&n; *&n; * Currently, only B/CVisionPPC cards (Permedia2) are supported.&n; *&n; * Thanks to Geert Uytterhoeven for the idea:&n; * Read values from given config space(s) for the first devices, -1 otherwise&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#ifdef CONFIG_AMIGA
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &quot;apus_pci.h&quot;
multiline_comment|/* These definitions are mostly adapted from pm2fb.c */
DECL|macro|APUS_PCI_MASTER_DEBUG
macro_line|#undef APUS_PCI_MASTER_DEBUG
macro_line|#ifdef APUS_PCI_MASTER_DEBUG
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(a,b...)&t;printk(KERN_DEBUG &quot;apus_pci: %s: &quot; a, __FUNCTION__ , ## b)
macro_line|#else
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(a,b...)
macro_line|#endif 
multiline_comment|/*&n; * The _DEFINITIVE_ memory mapping/unmapping functions.&n; * This is due to the fact that they&squot;re changing soooo often...&n; */
DECL|macro|DEFW
mdefine_line|#define DEFW()&t;&t;wmb()
DECL|macro|DEFR
mdefine_line|#define DEFR()&t;&t;rmb()
DECL|macro|DEFRW
mdefine_line|#define DEFRW()&t;&t;mb()
DECL|macro|DEVNO
mdefine_line|#define DEVNO(d)&t;((d)&gt;&gt;3)
DECL|macro|FNNO
mdefine_line|#define FNNO(d)&t;&t;((d)&amp;7)
r_extern
r_int
r_int
id|powerup_PCI_present
suffix:semicolon
DECL|variable|apus_hose
r_static
r_struct
id|pci_controller
op_star
id|apus_hose
suffix:semicolon
DECL|function|pci_io_base
r_void
op_star
id|pci_io_base
c_func
(paren
r_int
r_int
id|bus
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|apus_pcibios_read_config
id|apus_pcibios_read_config
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
id|devfn
comma
r_int
id|offset
comma
r_int
id|len
comma
id|u32
op_star
id|val
)paren
(brace
r_int
id|fnno
op_assign
id|FNNO
c_func
(paren
id|devfn
)paren
suffix:semicolon
r_int
id|devno
op_assign
id|DEVNO
c_func
(paren
id|devfn
)paren
suffix:semicolon
r_volatile
r_int
r_char
op_star
id|cfg_data
suffix:semicolon
r_if
c_cond
(paren
id|bus-&gt;number
OG
l_int|0
op_logical_or
id|devno
op_ne
l_int|1
)paren
(brace
op_star
id|val
op_assign
op_complement
l_int|0
suffix:semicolon
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
)brace
multiline_comment|/* base address + function offset + offset ^ endianness conversion */
multiline_comment|/* XXX the fnno&lt;&lt;5 bit seems wacky  -- paulus */
id|cfg_data
op_assign
id|apus_hose-&gt;cfg_data
op_plus
(paren
id|fnno
op_lshift
l_int|5
)paren
op_plus
(paren
id|offset
op_xor
(paren
id|len
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|len
)paren
(brace
r_case
l_int|1
suffix:colon
op_star
id|val
op_assign
id|readb
c_func
(paren
id|cfg_data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
op_star
id|val
op_assign
id|readw
c_func
(paren
id|cfg_data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
op_star
id|val
op_assign
id|readl
c_func
(paren
id|cfg_data
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;read b: 0x%x, d: 0x%x, f: 0x%x, o: 0x%x, l: %d, v: 0x%x&bslash;n&quot;
comma
id|bus-&gt;number
comma
id|devfn
op_rshift
l_int|3
comma
id|devfn
op_amp
l_int|7
comma
id|offset
comma
id|len
comma
op_star
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
r_int
DECL|function|apus_pcibios_write_config
id|apus_pcibios_write_config
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
id|devfn
comma
r_int
id|offset
comma
r_int
id|len
comma
id|u32
op_star
id|val
)paren
(brace
r_int
id|fnno
op_assign
id|FNNO
c_func
(paren
id|devfn
)paren
suffix:semicolon
r_int
id|devno
op_assign
id|DEVNO
c_func
(paren
id|devfn
)paren
suffix:semicolon
r_volatile
r_int
r_char
op_star
id|cfg_data
suffix:semicolon
r_if
c_cond
(paren
id|bus-&gt;number
OG
l_int|0
op_logical_or
id|devno
op_ne
l_int|1
)paren
(brace
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
)brace
multiline_comment|/* base address + function offset + offset ^ endianness conversion */
multiline_comment|/* XXX the fnno&lt;&lt;5 bit seems wacky  -- paulus */
id|cfg_data
op_assign
id|apus_hose-&gt;cfg_data
op_plus
(paren
id|fnno
op_lshift
l_int|5
)paren
op_plus
(paren
id|offset
op_xor
(paren
id|len
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|len
)paren
(brace
r_case
l_int|1
suffix:colon
id|writeb
c_func
(paren
id|val
comma
id|cfg_data
)paren
suffix:semicolon
id|DEFW
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|writew
c_func
(paren
id|val
comma
id|cfg_data
)paren
suffix:semicolon
id|DEFW
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|writel
c_func
(paren
id|val
comma
id|cfg_data
)paren
suffix:semicolon
id|DEFW
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;write b: 0x%x, d: 0x%x, f: 0x%x, o: 0x%x, l: %d, v: 0x%x&bslash;n&quot;
comma
id|bus-&gt;number
comma
id|devfn
op_rshift
l_int|3
comma
id|devfn
op_amp
l_int|7
comma
id|offset
comma
id|len
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|variable|apus_pci_ops
r_static
r_struct
id|pci_ops
id|apus_pci_ops
op_assign
(brace
id|apus_pcibios_read_config
comma
id|apus_pcibios_write_config
)brace
suffix:semicolon
DECL|variable|pci_mem
r_static
r_struct
id|resource
id|pci_mem
op_assign
(brace
l_string|&quot;B/CVisionPPC PCI mem&quot;
comma
id|CVPPC_FB_APERTURE_ONE
comma
id|CVPPC_PCI_CONFIG
comma
id|IORESOURCE_MEM
)brace
suffix:semicolon
r_void
id|__init
DECL|function|apus_pcibios_fixup
id|apus_pcibios_fixup
c_func
(paren
r_void
)paren
(brace
multiline_comment|/*&t;struct pci_dev *dev = pci_find_slot(0, 1&lt;&lt;3);&n;&t;unsigned int reg, val, offset;*/
multiline_comment|/* FIXME: interrupt? */
multiline_comment|/*dev-&gt;interrupt = xxx;*/
id|request_resource
c_func
(paren
op_amp
id|iomem_resource
comma
op_amp
id|pci_mem
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: PCI mem resource requested&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
DECL|function|apus_pcibios_fixup_bus
r_static
r_void
id|__init
id|apus_pcibios_fixup_bus
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
)paren
(brace
id|bus-&gt;resource
(braket
l_int|1
)braket
op_assign
op_amp
id|pci_mem
suffix:semicolon
)brace
multiline_comment|/* &n; * This is from pm2fb.c again&n; * &n; * Check if PCI (B/CVisionPPC) is available, initialize it and set up&n; * the pcibios_* pointers&n; */
r_void
id|__init
DECL|function|apus_setup_pci_ptrs
id|apus_setup_pci_ptrs
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|powerup_PCI_present
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;no PCI bridge detected&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;Phase5 B/CVisionPPC PCI bridge detected.&bslash;n&quot;
)paren
suffix:semicolon
id|apus_hose
op_assign
id|pcibios_alloc_controller
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|apus_hose
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;apus_pci: Can&squot;t allocate PCI controller structure&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|apus_hose-&gt;cfg_data
op_assign
id|ioremap
c_func
(paren
id|CVPPC_PCI_CONFIG
comma
l_int|256
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;apus_pci: unable to map PCI config region&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|apus_hose-&gt;cfg_addr
op_assign
id|ioremap
c_func
(paren
id|CSPPC_PCI_BRIDGE
comma
l_int|256
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;apus_pci: unable to map PCI bridge&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|writel
c_func
(paren
id|CSPPCF_BRIDGE_BIG_ENDIAN
comma
id|apus_hose-&gt;cfg_addr
op_plus
id|CSPPC_BRIDGE_ENDIAN
)paren
suffix:semicolon
id|DEFW
c_func
(paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|CVPPC_REGS_REGION
comma
id|apus_hose-&gt;cfg_data
op_plus
id|PCI_BASE_ADDRESS_0
)paren
suffix:semicolon
id|DEFW
c_func
(paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|CVPPC_FB_APERTURE_ONE
comma
id|apus_hose-&gt;cfg_data
op_plus
id|PCI_BASE_ADDRESS_1
)paren
suffix:semicolon
id|DEFW
c_func
(paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|CVPPC_FB_APERTURE_TWO
comma
id|apus_hose-&gt;cfg_data
op_plus
id|PCI_BASE_ADDRESS_2
)paren
suffix:semicolon
id|DEFW
c_func
(paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|CVPPC_ROM_ADDRESS
comma
id|apus_hose-&gt;cfg_data
op_plus
id|PCI_ROM_ADDRESS
)paren
suffix:semicolon
id|DEFW
c_func
(paren
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xef000000
op_or
id|PCI_COMMAND_IO
op_or
id|PCI_COMMAND_MEMORY
op_or
id|PCI_COMMAND_MASTER
comma
id|apus_hose-&gt;cfg_data
op_plus
id|PCI_COMMAND
)paren
suffix:semicolon
id|DEFW
c_func
(paren
)paren
suffix:semicolon
id|apus_hose-&gt;first_busno
op_assign
l_int|0
suffix:semicolon
id|apus_hose-&gt;last_busno
op_assign
l_int|0
suffix:semicolon
id|apus_hose-&gt;ops
op_assign
op_amp
id|apus_pci_ops
suffix:semicolon
id|ppc_md.pcibios_fixup
op_assign
id|apus_pcibios_fixup
suffix:semicolon
id|ppc_md.pcibios_fixup_bus
op_assign
id|apus_pcibios_fixup_bus
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_AMIGA */
eof
