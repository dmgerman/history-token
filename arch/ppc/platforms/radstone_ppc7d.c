multiline_comment|/*&n; * arch/ppc/platforms/radstone_ppc7d.c&n; *&n; * Board setup routines for the Radstone PPC7D boards.&n; *&n; * Author: James Chapman &lt;jchapman@katalix.com&gt;&n; *&n; * Based on code done by Rabeeh Khoury - rabeeh@galileo.co.il&n; * Based on code done by - Mark A. Greer &lt;mgreer@mvista.com&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the&n; * Free Software Foundation; either version 2 of the License, or (at your&n; * option) any later version.&n; */
multiline_comment|/* Radstone PPC7D boards are rugged VME boards with PPC 7447A CPUs,&n; * Discovery-II, dual gigabit ethernet, dual PMC, USB, keyboard/mouse,&n; * 4 serial ports, 2 high speed serial ports (MPSCs) and optional&n; * SCSI / VGA.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/reboot.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/kdev_t.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/initrd.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/ide.h&gt;
macro_line|#include &lt;linux/seq_file.h&gt;
macro_line|#include &lt;linux/root_dev.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/tty.h&gt;&t;&t;/* for linux/serial_core.h */
macro_line|#include &lt;linux/serial_core.h&gt;
macro_line|#include &lt;linux/mv643xx.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/time.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/smp.h&gt;
macro_line|#include &lt;asm/vga.h&gt;
macro_line|#include &lt;asm/open_pic.h&gt;
macro_line|#include &lt;asm/i8259.h&gt;
macro_line|#include &lt;asm/todc.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#include &lt;asm/mpc10x.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#include &lt;asm/mv64x60.h&gt;
macro_line|#include &lt;asm/i8259.h&gt;
macro_line|#include &quot;radstone_ppc7d.h&quot;
DECL|macro|DEBUG
macro_line|#undef DEBUG
DECL|macro|PPC7D_RST_PIN
mdefine_line|#define PPC7D_RST_PIN&t;&t;&t;17 &t;/* GPP17 */
r_extern
id|u32
id|mv64360_irq_base
suffix:semicolon
DECL|variable|bh
r_static
r_struct
id|mv64x60_handle
id|bh
suffix:semicolon
DECL|variable|ppc7d_has_alma
r_static
r_int
id|ppc7d_has_alma
suffix:semicolon
r_extern
r_void
id|gen550_progress
c_func
(paren
r_char
op_star
comma
r_int
r_int
)paren
suffix:semicolon
r_extern
r_void
id|gen550_init
c_func
(paren
r_int
comma
r_struct
id|uart_port
op_star
)paren
suffix:semicolon
multiline_comment|/* residual data */
DECL|variable|__res
r_int
r_char
id|__res
(braket
r_sizeof
(paren
id|bd_t
)paren
)braket
suffix:semicolon
multiline_comment|/*****************************************************************************&n; * Serial port code&n; *****************************************************************************/
macro_line|#if defined(CONFIG_KGDB) || defined(CONFIG_SERIAL_TEXT_DEBUG)
DECL|function|ppc7d_early_serial_map
r_static
r_void
id|__init
id|ppc7d_early_serial_map
c_func
(paren
r_void
)paren
(brace
macro_line|#if defined(CONFIG_SERIAL_MPSC_CONSOLE)
id|mv64x60_progress_init
c_func
(paren
id|CONFIG_MV64X60_NEW_BASE
)paren
suffix:semicolon
macro_line|#elif defined(CONFIG_SERIAL_8250)
r_struct
id|uart_port
id|serial_req
suffix:semicolon
multiline_comment|/* Setup serial port access */
id|memset
c_func
(paren
op_amp
id|serial_req
comma
l_int|0
comma
r_sizeof
(paren
id|serial_req
)paren
)paren
suffix:semicolon
id|serial_req.uartclk
op_assign
id|UART_CLK
suffix:semicolon
id|serial_req.irq
op_assign
l_int|4
suffix:semicolon
id|serial_req.flags
op_assign
id|STD_COM_FLAGS
suffix:semicolon
id|serial_req.iotype
op_assign
id|SERIAL_IO_MEM
suffix:semicolon
id|serial_req.membase
op_assign
(paren
id|u_char
op_star
)paren
id|PPC7D_SERIAL_0
suffix:semicolon
id|gen550_init
c_func
(paren
l_int|0
comma
op_amp
id|serial_req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|early_serial_setup
c_func
(paren
op_amp
id|serial_req
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Early serial init of port 0 failed&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Assume early_serial_setup() doesn&squot;t modify serial_req */
id|serial_req.line
op_assign
l_int|1
suffix:semicolon
id|serial_req.irq
op_assign
l_int|3
suffix:semicolon
id|serial_req.membase
op_assign
(paren
id|u_char
op_star
)paren
id|PPC7D_SERIAL_1
suffix:semicolon
id|gen550_init
c_func
(paren
l_int|1
comma
op_amp
id|serial_req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|early_serial_setup
c_func
(paren
op_amp
id|serial_req
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Early serial init of port 1 failed&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#else
macro_line|#error CONFIG_KGDB || CONFIG_SERIAL_TEXT_DEBUG has no supported CONFIG_SERIAL_XXX
macro_line|#endif
)brace
macro_line|#endif /* CONFIG_KGDB || CONFIG_SERIAL_TEXT_DEBUG */
multiline_comment|/*****************************************************************************&n; * Low-level board support code&n; *****************************************************************************/
DECL|function|ppc7d_find_end_of_memory
r_static
r_int
r_int
id|__init
id|ppc7d_find_end_of_memory
c_func
(paren
r_void
)paren
(brace
id|bd_t
op_star
id|bp
op_assign
(paren
id|bd_t
op_star
)paren
id|__res
suffix:semicolon
r_if
c_cond
(paren
id|bp-&gt;bi_memsize
)paren
r_return
id|bp-&gt;bi_memsize
suffix:semicolon
r_return
(paren
l_int|256
op_star
l_int|1024
op_star
l_int|1024
)paren
suffix:semicolon
)brace
DECL|function|ppc7d_map_io
r_static
r_void
id|__init
id|ppc7d_map_io
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* remove temporary mapping */
id|mtspr
c_func
(paren
id|SPRN_DBAT3U
comma
l_int|0x00000000
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|SPRN_DBAT3L
comma
l_int|0x00000000
)paren
suffix:semicolon
id|io_block_mapping
c_func
(paren
l_int|0xe8000000
comma
l_int|0xe8000000
comma
l_int|0x08000000
comma
id|_PAGE_IO
)paren
suffix:semicolon
id|io_block_mapping
c_func
(paren
l_int|0xfe000000
comma
l_int|0xfe000000
comma
l_int|0x02000000
comma
id|_PAGE_IO
)paren
suffix:semicolon
)brace
DECL|function|ppc7d_restart
r_static
r_void
id|ppc7d_restart
c_func
(paren
r_char
op_star
id|cmd
)paren
(brace
id|u32
id|data
suffix:semicolon
multiline_comment|/* Disable GPP17 interrupt */
id|data
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_GPP_INTR_MASK
)paren
suffix:semicolon
id|data
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|PPC7D_RST_PIN
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_GPP_INTR_MASK
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* Configure MPP17 as GPP */
id|data
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_MPP_CNTL_2
)paren
suffix:semicolon
id|data
op_and_assign
op_complement
(paren
l_int|0x0000000f
op_lshift
l_int|4
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_MPP_CNTL_2
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* Enable pin GPP17 for output */
id|data
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_GPP_IO_CNTL
)paren
suffix:semicolon
id|data
op_or_assign
(paren
l_int|1
op_lshift
id|PPC7D_RST_PIN
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_GPP_IO_CNTL
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* Toggle GPP9 pin to reset the board */
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_GPP_VALUE_CLR
comma
l_int|1
op_lshift
id|PPC7D_RST_PIN
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_GPP_VALUE_SET
comma
l_int|1
op_lshift
id|PPC7D_RST_PIN
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* Spin until reset happens */
multiline_comment|/* NOTREACHED */
)brace
DECL|function|ppc7d_power_off
r_static
r_void
id|ppc7d_power_off
c_func
(paren
r_void
)paren
(brace
id|u32
id|data
suffix:semicolon
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Ensure that internal MV643XX watchdog is disabled.&n;&t; * The Disco watchdog uses MPP17 on this hardware.&n;&t; */
id|data
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_MPP_CNTL_2
)paren
suffix:semicolon
id|data
op_and_assign
op_complement
(paren
l_int|0x0000000f
op_lshift
l_int|4
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_MPP_CNTL_2
comma
id|data
)paren
suffix:semicolon
id|data
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_WDT_WDC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_amp
l_int|0x80000000
)paren
(brace
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_WDT_WDC
comma
l_int|1
op_lshift
l_int|24
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_WDT_WDC
comma
l_int|2
op_lshift
l_int|24
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* No way to shut power off with software */
multiline_comment|/* NOTREACHED */
)brace
DECL|function|ppc7d_halt
r_static
r_void
id|ppc7d_halt
c_func
(paren
r_void
)paren
(brace
id|ppc7d_power_off
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* NOTREACHED */
)brace
DECL|variable|ppc7d_led_no_pulse
r_static
r_int
r_int
id|ppc7d_led_no_pulse
suffix:semicolon
DECL|function|ppc7d_led_pulse_disable
r_static
r_int
id|__init
id|ppc7d_led_pulse_disable
c_func
(paren
r_char
op_star
id|str
)paren
(brace
id|ppc7d_led_no_pulse
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* This kernel option disables the heartbeat pulsing of a board LED */
id|__setup
c_func
(paren
l_string|&quot;ledoff&quot;
comma
id|ppc7d_led_pulse_disable
)paren
suffix:semicolon
DECL|function|ppc7d_heartbeat
r_static
r_void
id|ppc7d_heartbeat
c_func
(paren
r_void
)paren
(brace
id|u32
id|data32
suffix:semicolon
id|u8
id|data8
suffix:semicolon
r_static
r_int
id|max706_wdog
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Unfortunately we can&squot;t access the LED control registers&n;&t; * during early init because they&squot;re on the CPLD which is the&n;&t; * other side of a PCI bridge which goes unreachable during&n;&t; * PCI scan. So write the LEDs only if the MV64360 watchdog is&n;&t; * enabled (i.e. userspace apps are running so kernel is up)..&n;&t; */
id|data32
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_WDT_WDC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data32
op_amp
l_int|0x80000000
)paren
(brace
multiline_comment|/* Enable MAX706 watchdog if not done already */
r_if
c_cond
(paren
op_logical_neg
id|max706_wdog
)paren
(brace
id|outb
c_func
(paren
l_int|3
comma
id|PPC7D_CPLD_RESET
)paren
suffix:semicolon
id|max706_wdog
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Hit the MAX706 watchdog */
id|outb
c_func
(paren
l_int|0
comma
id|PPC7D_CPLD_WATCHDOG_TRIG
)paren
suffix:semicolon
multiline_comment|/* Pulse LED DS219 if not disabled */
r_if
c_cond
(paren
op_logical_neg
id|ppc7d_led_no_pulse
)paren
(brace
r_static
r_int
id|led_on
op_assign
l_int|0
suffix:semicolon
id|data8
op_assign
id|inb
c_func
(paren
id|PPC7D_CPLD_LEDS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|led_on
)paren
id|data8
op_and_assign
op_complement
id|PPC7D_CPLD_LEDS_DS219_MASK
suffix:semicolon
r_else
id|data8
op_or_assign
id|PPC7D_CPLD_LEDS_DS219_MASK
suffix:semicolon
id|outb
c_func
(paren
id|data8
comma
id|PPC7D_CPLD_LEDS
)paren
suffix:semicolon
id|led_on
op_assign
op_logical_neg
id|led_on
suffix:semicolon
)brace
)brace
id|ppc_md.heartbeat_count
op_assign
id|ppc_md.heartbeat_reset
suffix:semicolon
)brace
DECL|function|ppc7d_show_cpuinfo
r_static
r_int
id|ppc7d_show_cpuinfo
c_func
(paren
r_struct
id|seq_file
op_star
id|m
)paren
(brace
id|u8
id|val
suffix:semicolon
id|u8
id|val1
comma
id|val2
suffix:semicolon
r_static
r_int
id|flash_sizes
(braket
l_int|4
)braket
op_assign
(brace
l_int|64
comma
l_int|32
comma
l_int|0
comma
l_int|16
)brace
suffix:semicolon
r_static
r_int
id|flash_banks
(braket
l_int|4
)braket
op_assign
(brace
l_int|4
comma
l_int|3
comma
l_int|2
comma
l_int|1
)brace
suffix:semicolon
r_static
r_char
op_star
id|pci_modes
(braket
)braket
op_assign
(brace
l_string|&quot;PCI33&quot;
comma
l_string|&quot;PCI66&quot;
comma
l_string|&quot;Unknown&quot;
comma
l_string|&quot;Unknown&quot;
comma
l_string|&quot;PCIX33&quot;
comma
l_string|&quot;PCIX66&quot;
comma
l_string|&quot;PCIX100&quot;
comma
l_string|&quot;PCIX133&quot;
)brace
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;vendor&bslash;t&bslash;t: Radstone Technology&bslash;n&quot;
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;machine&bslash;t&bslash;t: PPC7D&bslash;n&quot;
)paren
suffix:semicolon
id|val
op_assign
id|inb
c_func
(paren
id|PPC7D_CPLD_BOARD_REVISION
)paren
suffix:semicolon
id|val1
op_assign
(paren
id|val
op_amp
id|PPC7D_CPLD_BOARD_REVISION_NUMBER_MASK
)paren
op_rshift
l_int|5
suffix:semicolon
id|val2
op_assign
(paren
id|val
op_amp
id|PPC7D_CPLD_BOARD_REVISION_LETTER_MASK
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;revision&bslash;t: %hd%c%c&bslash;n&quot;
comma
id|val1
comma
(paren
id|val2
op_le
l_int|0x18
)paren
ques
c_cond
l_char|&squot;A&squot;
op_plus
id|val2
suffix:colon
l_char|&squot;Y&squot;
comma
(paren
id|val2
OG
l_int|0x18
)paren
ques
c_cond
l_char|&squot;A&squot;
op_plus
(paren
id|val2
op_minus
l_int|0x19
)paren
suffix:colon
l_char|&squot; &squot;
)paren
suffix:semicolon
id|val
op_assign
id|inb
c_func
(paren
id|PPC7D_CPLD_MOTHERBOARD_TYPE
)paren
suffix:semicolon
id|val1
op_assign
id|val
op_amp
id|PPC7D_CPLD_MB_TYPE_PLL_MASK
suffix:semicolon
id|val2
op_assign
id|val
op_amp
(paren
id|PPC7D_CPLD_MB_TYPE_ECC_FITTED_MASK
op_or
id|PPC7D_CPLD_MB_TYPE_ECC_ENABLE_MASK
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;bus speed&bslash;t: %dMHz&bslash;n&quot;
comma
(paren
id|val1
op_eq
id|PPC7D_CPLD_MB_TYPE_PLL_133
)paren
ques
c_cond
l_int|133
suffix:colon
(paren
id|val1
op_eq
id|PPC7D_CPLD_MB_TYPE_PLL_100
)paren
ques
c_cond
l_int|100
suffix:colon
(paren
id|val1
op_eq
id|PPC7D_CPLD_MB_TYPE_PLL_64
)paren
ques
c_cond
l_int|64
suffix:colon
l_int|0
)paren
suffix:semicolon
id|val
op_assign
id|inb
c_func
(paren
id|PPC7D_CPLD_MEM_CONFIG_EXTEND
)paren
suffix:semicolon
id|val1
op_assign
id|val
op_amp
id|PPC7D_CPLD_SDRAM_BANK_SIZE_MASK
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;SDRAM&bslash;t&bslash;t: %d%c&quot;
comma
(paren
id|val1
op_eq
id|PPC7D_CPLD_SDRAM_BANK_SIZE_128M
)paren
ques
c_cond
l_int|128
suffix:colon
(paren
id|val1
op_eq
id|PPC7D_CPLD_SDRAM_BANK_SIZE_256M
)paren
ques
c_cond
l_int|256
suffix:colon
(paren
id|val1
op_eq
id|PPC7D_CPLD_SDRAM_BANK_SIZE_512M
)paren
ques
c_cond
l_int|512
suffix:colon
l_int|1
comma
(paren
id|val1
op_eq
id|PPC7D_CPLD_SDRAM_BANK_SIZE_1G
)paren
ques
c_cond
l_char|&squot;G&squot;
suffix:colon
l_char|&squot;M&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val2
op_amp
id|PPC7D_CPLD_MB_TYPE_ECC_FITTED_MASK
)paren
(brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot; [ECC %sabled]&quot;
comma
(paren
id|val2
op_amp
id|PPC7D_CPLD_MB_TYPE_ECC_ENABLE_MASK
)paren
ques
c_cond
l_string|&quot;en&quot;
suffix:colon
l_string|&quot;dis&quot;
)paren
suffix:semicolon
)brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|val1
op_assign
(paren
id|val
op_amp
id|PPC7D_CPLD_FLASH_DEV_SIZE_MASK
)paren
suffix:semicolon
id|val2
op_assign
(paren
id|val
op_amp
id|PPC7D_CPLD_FLASH_BANK_NUM_MASK
)paren
op_rshift
l_int|2
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;FLASH&bslash;t&bslash;t: %d banks of %dM, total %dM&bslash;n&quot;
comma
id|flash_banks
(braket
id|val2
)braket
comma
id|flash_sizes
(braket
id|val1
)braket
comma
id|flash_banks
(braket
id|val2
)braket
op_star
id|flash_sizes
(braket
id|val1
)braket
)paren
suffix:semicolon
id|val
op_assign
id|inb
c_func
(paren
id|PPC7D_CPLD_FLASH_WRITE_CNTL
)paren
suffix:semicolon
id|val1
op_assign
id|inb
c_func
(paren
id|PPC7D_CPLD_SW_FLASH_WRITE_PROTECT
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;  write links&bslash;t: %s%s%s%s&bslash;n&quot;
comma
(paren
id|val
op_amp
id|PPD7D_CPLD_FLASH_CNTL_WR_LINK_MASK
)paren
ques
c_cond
l_string|&quot;WRITE &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|val
op_amp
id|PPD7D_CPLD_FLASH_CNTL_BOOT_LINK_MASK
)paren
ques
c_cond
l_string|&quot;BOOT &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|val
op_amp
id|PPD7D_CPLD_FLASH_CNTL_USER_LINK_MASK
)paren
ques
c_cond
l_string|&quot;USER &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|val
op_amp
(paren
id|PPD7D_CPLD_FLASH_CNTL_WR_LINK_MASK
op_or
id|PPD7D_CPLD_FLASH_CNTL_BOOT_LINK_MASK
op_or
id|PPD7D_CPLD_FLASH_CNTL_USER_LINK_MASK
)paren
)paren
op_eq
l_int|0
ques
c_cond
l_string|&quot;NONE&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;  write sector h/w enables: %s%s%s%s%s&bslash;n&quot;
comma
(paren
id|val
op_amp
id|PPD7D_CPLD_FLASH_CNTL_RECO_WR_MASK
)paren
ques
c_cond
l_string|&quot;RECOVERY &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|val
op_amp
id|PPD7D_CPLD_FLASH_CNTL_BOOT_WR_MASK
)paren
ques
c_cond
l_string|&quot;BOOT &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|val
op_amp
id|PPD7D_CPLD_FLASH_CNTL_USER_WR_MASK
)paren
ques
c_cond
l_string|&quot;USER &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|val1
op_amp
id|PPC7D_CPLD_FLASH_CNTL_NVRAM_PROT_MASK
)paren
ques
c_cond
l_string|&quot;NVRAM &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
(paren
(paren
id|val
op_amp
(paren
id|PPD7D_CPLD_FLASH_CNTL_RECO_WR_MASK
op_or
id|PPD7D_CPLD_FLASH_CNTL_BOOT_WR_MASK
op_or
id|PPD7D_CPLD_FLASH_CNTL_BOOT_WR_MASK
)paren
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
(paren
id|val1
op_amp
id|PPC7D_CPLD_FLASH_CNTL_NVRAM_PROT_MASK
)paren
op_eq
l_int|0
)paren
)paren
ques
c_cond
l_string|&quot;NONE&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|val1
op_assign
id|inb
c_func
(paren
id|PPC7D_CPLD_SW_FLASH_WRITE_PROTECT
)paren
op_amp
(paren
id|PPC7D_CPLD_SW_FLASH_WRPROT_SYSBOOT_MASK
op_or
id|PPC7D_CPLD_SW_FLASH_WRPROT_USER_MASK
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;  software sector enables: %s%s%s&bslash;n&quot;
comma
(paren
id|val1
op_amp
id|PPC7D_CPLD_SW_FLASH_WRPROT_SYSBOOT_MASK
)paren
ques
c_cond
l_string|&quot;SYSBOOT &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|val1
op_amp
id|PPC7D_CPLD_SW_FLASH_WRPROT_USER_MASK
)paren
ques
c_cond
l_string|&quot;USER &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|val1
op_eq
l_int|0
)paren
ques
c_cond
l_string|&quot;NONE &quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Boot options&bslash;t: %s%s%s%s&bslash;n&quot;
comma
(paren
id|val
op_amp
id|PPC7D_CPLD_FLASH_CNTL_ALTBOOT_LINK_MASK
)paren
ques
c_cond
l_string|&quot;ALTERNATE &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|val
op_amp
id|PPC7D_CPLD_FLASH_CNTL_VMEBOOT_LINK_MASK
)paren
ques
c_cond
l_string|&quot;VME &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|val
op_amp
id|PPC7D_CPLD_FLASH_CNTL_RECBOOT_LINK_MASK
)paren
ques
c_cond
l_string|&quot;RECOVERY &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
(paren
id|val
op_amp
(paren
id|PPC7D_CPLD_FLASH_CNTL_ALTBOOT_LINK_MASK
op_or
id|PPC7D_CPLD_FLASH_CNTL_VMEBOOT_LINK_MASK
op_or
id|PPC7D_CPLD_FLASH_CNTL_RECBOOT_LINK_MASK
)paren
)paren
op_eq
l_int|0
)paren
ques
c_cond
l_string|&quot;NONE&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|val
op_assign
id|inb
c_func
(paren
id|PPC7D_CPLD_EQUIPMENT_PRESENT_1
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Fitted modules&bslash;t: %s%s%s%s&bslash;n&quot;
comma
(paren
id|val
op_amp
id|PPC7D_CPLD_EQPT_PRES_1_PMC1_MASK
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;PMC1 &quot;
comma
(paren
id|val
op_amp
id|PPC7D_CPLD_EQPT_PRES_1_PMC2_MASK
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;PMC2 &quot;
comma
(paren
id|val
op_amp
id|PPC7D_CPLD_EQPT_PRES_1_AFIX_MASK
)paren
ques
c_cond
l_string|&quot;AFIX &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
(paren
id|val
op_amp
(paren
id|PPC7D_CPLD_EQPT_PRES_1_PMC1_MASK
op_or
id|PPC7D_CPLD_EQPT_PRES_1_PMC2_MASK
op_or
id|PPC7D_CPLD_EQPT_PRES_1_AFIX_MASK
)paren
)paren
op_eq
(paren
id|PPC7D_CPLD_EQPT_PRES_1_PMC1_MASK
op_or
id|PPC7D_CPLD_EQPT_PRES_1_PMC2_MASK
)paren
)paren
ques
c_cond
l_string|&quot;NONE&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|PPC7D_CPLD_EQPT_PRES_1_AFIX_MASK
)paren
(brace
r_static
r_const
r_char
op_star
id|ids
(braket
)braket
op_assign
(brace
l_string|&quot;unknown&quot;
comma
l_string|&quot;1553 (Dual Channel)&quot;
comma
l_string|&quot;1553 (Single Channel)&quot;
comma
l_string|&quot;8-bit SCSI + VGA&quot;
comma
l_string|&quot;16-bit SCSI + VGA&quot;
comma
l_string|&quot;1553 (Single Channel with sideband)&quot;
comma
l_string|&quot;1553 (Dual Channel with sideband)&quot;
comma
l_int|NULL
)brace
suffix:semicolon
id|u8
id|id
op_assign
id|__raw_readb
c_func
(paren
(paren
r_void
op_star
)paren
id|PPC7D_AFIX_REG_BASE
op_plus
l_int|0x03
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;AFIX module&bslash;t: 0x%hx [%s]&bslash;n&quot;
comma
id|id
comma
id|id
OL
l_int|7
ques
c_cond
id|ids
(braket
id|id
)braket
suffix:colon
l_string|&quot;unknown&quot;
)paren
suffix:semicolon
)brace
id|val
op_assign
id|inb
c_func
(paren
id|PPC7D_CPLD_PCI_CONFIG
)paren
suffix:semicolon
id|val1
op_assign
(paren
id|val
op_amp
id|PPC7D_CPLD_PCI_CONFIG_PCI0_MASK
)paren
op_rshift
l_int|4
suffix:semicolon
id|val2
op_assign
(paren
id|val
op_amp
id|PPC7D_CPLD_PCI_CONFIG_PCI1_MASK
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;PCI#0&bslash;t&bslash;t: %s&bslash;nPCI#1&bslash;t&bslash;t: %s&bslash;n&quot;
comma
id|pci_modes
(braket
id|val1
)braket
comma
id|pci_modes
(braket
id|val2
)braket
)paren
suffix:semicolon
id|val
op_assign
id|inb
c_func
(paren
id|PPC7D_CPLD_EQUIPMENT_PRESENT_2
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;PMC1&bslash;t&bslash;t: %s&bslash;nPMC2&bslash;t&bslash;t: %s&bslash;n&quot;
comma
(paren
id|val
op_amp
id|PPC7D_CPLD_EQPT_PRES_3_PMC1_V_MASK
)paren
ques
c_cond
l_string|&quot;3.3v&quot;
suffix:colon
l_string|&quot;5v&quot;
comma
(paren
id|val
op_amp
id|PPC7D_CPLD_EQPT_PRES_3_PMC2_V_MASK
)paren
ques
c_cond
l_string|&quot;3.3v&quot;
suffix:colon
l_string|&quot;5v&quot;
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;PMC power source: %s&bslash;n&quot;
comma
(paren
id|val
op_amp
id|PPC7D_CPLD_EQPT_PRES_3_PMC_POWER_MASK
)paren
ques
c_cond
l_string|&quot;VME&quot;
suffix:colon
l_string|&quot;internal&quot;
)paren
suffix:semicolon
id|val
op_assign
id|inb
c_func
(paren
id|PPC7D_CPLD_EQUIPMENT_PRESENT_4
)paren
suffix:semicolon
id|val2
op_assign
id|inb
c_func
(paren
id|PPC7D_CPLD_EQUIPMENT_PRESENT_2
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Fit options&bslash;t: %s%s%s%s%s%s%s&bslash;n&quot;
comma
(paren
id|val
op_amp
id|PPC7D_CPLD_EQPT_PRES_4_LPT_MASK
)paren
ques
c_cond
l_string|&quot;LPT &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|val
op_amp
id|PPC7D_CPLD_EQPT_PRES_4_PS2_FITTED
)paren
ques
c_cond
l_string|&quot;PS2 &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|val
op_amp
id|PPC7D_CPLD_EQPT_PRES_4_USB2_FITTED
)paren
ques
c_cond
l_string|&quot;USB2 &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|val2
op_amp
id|PPC7D_CPLD_EQPT_PRES_2_UNIVERSE_MASK
)paren
ques
c_cond
l_string|&quot;VME &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|val2
op_amp
id|PPC7D_CPLD_EQPT_PRES_2_COM36_MASK
)paren
ques
c_cond
l_string|&quot;COM3-6 &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|val2
op_amp
id|PPC7D_CPLD_EQPT_PRES_2_GIGE_MASK
)paren
ques
c_cond
l_string|&quot;eth0 &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|val2
op_amp
id|PPC7D_CPLD_EQPT_PRES_2_DUALGIGE_MASK
)paren
ques
c_cond
l_string|&quot;eth1 &quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|val
op_assign
id|inb
c_func
(paren
id|PPC7D_CPLD_ID_LINK
)paren
suffix:semicolon
id|val1
op_assign
id|val
op_amp
(paren
id|PPC7D_CPLD_ID_LINK_E6_MASK
op_or
id|PPC7D_CPLD_ID_LINK_E7_MASK
op_or
id|PPC7D_CPLD_ID_LINK_E12_MASK
op_or
id|PPC7D_CPLD_ID_LINK_E13_MASK
)paren
suffix:semicolon
id|val
op_assign
id|inb
c_func
(paren
id|PPC7D_CPLD_FLASH_WRITE_CNTL
)paren
op_amp
(paren
id|PPD7D_CPLD_FLASH_CNTL_WR_LINK_MASK
op_or
id|PPD7D_CPLD_FLASH_CNTL_BOOT_LINK_MASK
op_or
id|PPD7D_CPLD_FLASH_CNTL_USER_LINK_MASK
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Board links present: %s%s%s%s%s%s%s%s&bslash;n&quot;
comma
(paren
id|val1
op_amp
id|PPC7D_CPLD_ID_LINK_E6_MASK
)paren
ques
c_cond
l_string|&quot;E6 &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|val1
op_amp
id|PPC7D_CPLD_ID_LINK_E7_MASK
)paren
ques
c_cond
l_string|&quot;E7 &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|val
op_amp
id|PPD7D_CPLD_FLASH_CNTL_WR_LINK_MASK
)paren
ques
c_cond
l_string|&quot;E9 &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|val
op_amp
id|PPD7D_CPLD_FLASH_CNTL_BOOT_LINK_MASK
)paren
ques
c_cond
l_string|&quot;E10 &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|val
op_amp
id|PPD7D_CPLD_FLASH_CNTL_USER_LINK_MASK
)paren
ques
c_cond
l_string|&quot;E11 &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|val1
op_amp
id|PPC7D_CPLD_ID_LINK_E12_MASK
)paren
ques
c_cond
l_string|&quot;E12 &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|val1
op_amp
id|PPC7D_CPLD_ID_LINK_E13_MASK
)paren
ques
c_cond
l_string|&quot;E13 &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
(paren
id|val
op_eq
l_int|0
)paren
op_logical_and
(paren
id|val1
op_eq
l_int|0
)paren
)paren
ques
c_cond
l_string|&quot;NONE&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|val
op_assign
id|inb
c_func
(paren
id|PPC7D_CPLD_WDOG_RESETSW_MASK
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Front panel reset switch: %sabled&bslash;n&quot;
comma
(paren
id|val
op_amp
id|PPC7D_CPLD_WDOG_RESETSW_MASK
)paren
ques
c_cond
l_string|&quot;dis&quot;
suffix:colon
l_string|&quot;en&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ppc7d_calibrate_decr
r_static
r_void
id|__init
id|ppc7d_calibrate_decr
c_func
(paren
r_void
)paren
(brace
id|ulong
id|freq
suffix:semicolon
id|freq
op_assign
l_int|100000000
op_div
l_int|4
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;time_init: decrementer frequency = %lu.%.6lu MHz&bslash;n&quot;
comma
id|freq
op_div
l_int|1000000
comma
id|freq
op_mod
l_int|1000000
)paren
suffix:semicolon
id|tb_ticks_per_jiffy
op_assign
id|freq
op_div
id|HZ
suffix:semicolon
id|tb_to_us
op_assign
id|mulhwu_scale_factor
c_func
(paren
id|freq
comma
l_int|1000000
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * Interrupt stuff&n; *****************************************************************************/
DECL|function|ppc7d_i8259_intr
r_static
id|irqreturn_t
id|ppc7d_i8259_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|u32
id|temp
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_GPP_INTR_CAUSE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
(paren
l_int|1
op_lshift
l_int|28
)paren
)paren
(brace
id|i8259_irq
c_func
(paren
id|regs
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_GPP_INTR_CAUSE
comma
id|temp
op_amp
(paren
op_complement
(paren
l_int|1
op_lshift
l_int|28
)paren
)paren
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_return
id|IRQ_NONE
suffix:semicolon
)brace
multiline_comment|/*&n; * Each interrupt cause is assigned an IRQ number.&n; * Southbridge has 16*2 (two 8259&squot;s) interrupts.&n; * Discovery-II has 96 interrupts (cause-hi, cause-lo, gpp x 32).&n; * If multiple interrupts are pending, get_irq() returns the&n; * lowest pending irq number first.&n; *&n; *&n; * IRQ #   Source                              Trig   Active&n; * =============================================================&n; *&n; * Southbridge&n; * -----------&n; * IRQ #   Source                              Trig&n; * =============================================================&n; * 0       ISA High Resolution Counter         Edge&n; * 1       Keyboard                            Edge&n; * 2       Cascade From (IRQ 8-15)             Edge&n; * 3       Com 2 (Uart 2)                      Edge&n; * 4       Com 1 (Uart 1)                      Edge&n; * 5       PCI Int D/AFIX IRQZ ID4 (2,7)       Level&n; * 6       GPIO                                Level&n; * 7       LPT                                 Edge&n; * 8       RTC Alarm                           Edge&n; * 9       PCI Int A/PMC 2/AFIX IRQW ID1 (2,0) Level&n; * 10      PCI Int B/PMC 1/AFIX IRQX ID2 (2,1) Level&n; * 11      USB2                                Level&n; * 12      Mouse                               Edge&n; * 13      Reserved internally by Ali M1535+&n; * 14      PCI Int C/VME/AFIX IRQY ID3 (2,6)   Level&n; * 15      COM 5/6                             Level&n; *&n; * 16..112 Discovery-II...&n; *&n; * MPP28   Southbridge                         Edge   High&n; *&n; *&n; * Interrupts are cascaded through to the Discovery-II.&n; *&n; *  PCI ---&n; *         &bslash;&n; * CPLD --&gt; ALI1535 -------&gt; DISCOVERY-II&n; *        INTF           MPP28&n; */
DECL|function|ppc7d_init_irq
r_static
r_void
id|__init
id|ppc7d_init_irq
c_func
(paren
r_void
)paren
(brace
r_int
id|irq
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|i8259_init
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|mv64360_init_irq
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* IRQ 0..15 are handled by the cascaded 8259&squot;s of the Ali1535 */
r_for
c_loop
(paren
id|irq
op_assign
l_int|0
suffix:semicolon
id|irq
OL
l_int|16
suffix:semicolon
id|irq
op_increment
)paren
(brace
id|irq_desc
(braket
id|irq
)braket
dot
id|handler
op_assign
op_amp
id|i8259_pic
suffix:semicolon
)brace
multiline_comment|/* IRQs 5,6,9,10,11,14,15 are level sensitive */
id|irq_desc
(braket
l_int|5
)braket
dot
id|status
op_or_assign
id|IRQ_LEVEL
suffix:semicolon
id|irq_desc
(braket
l_int|6
)braket
dot
id|status
op_or_assign
id|IRQ_LEVEL
suffix:semicolon
id|irq_desc
(braket
l_int|9
)braket
dot
id|status
op_or_assign
id|IRQ_LEVEL
suffix:semicolon
id|irq_desc
(braket
l_int|10
)braket
dot
id|status
op_or_assign
id|IRQ_LEVEL
suffix:semicolon
id|irq_desc
(braket
l_int|11
)braket
dot
id|status
op_or_assign
id|IRQ_LEVEL
suffix:semicolon
id|irq_desc
(braket
l_int|14
)braket
dot
id|status
op_or_assign
id|IRQ_LEVEL
suffix:semicolon
id|irq_desc
(braket
l_int|15
)braket
dot
id|status
op_or_assign
id|IRQ_LEVEL
suffix:semicolon
multiline_comment|/* GPP28 is edge triggered */
id|irq_desc
(braket
id|mv64360_irq_base
op_plus
id|MV64x60_IRQ_GPP28
)braket
dot
id|status
op_and_assign
op_complement
id|IRQ_LEVEL
suffix:semicolon
)brace
DECL|function|ppc7d_irq_canonicalize
r_static
id|u32
id|ppc7d_irq_canonicalize
c_func
(paren
id|u32
id|irq
)paren
(brace
r_if
c_cond
(paren
(paren
id|irq
op_ge
l_int|16
)paren
op_logical_and
(paren
id|irq
OL
(paren
l_int|16
op_plus
l_int|96
)paren
)paren
)paren
id|irq
op_sub_assign
l_int|16
suffix:semicolon
r_return
id|irq
suffix:semicolon
)brace
DECL|function|ppc7d_get_irq
r_static
r_int
id|ppc7d_get_irq
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|irq
suffix:semicolon
id|irq
op_assign
id|mv64360_get_irq
c_func
(paren
id|regs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_eq
(paren
id|mv64360_irq_base
op_plus
id|MV64x60_IRQ_GPP28
)paren
)paren
id|irq
op_assign
id|i8259_irq
c_func
(paren
id|regs
)paren
suffix:semicolon
r_return
id|irq
suffix:semicolon
)brace
multiline_comment|/*&n; * 9       PCI Int A/PMC 2/AFIX IRQW ID1 (2,0) Level&n; * 10      PCI Int B/PMC 1/AFIX IRQX ID2 (2,1) Level&n; * 14      PCI Int C/VME/AFIX IRQY ID3 (2,6)   Level&n; * 5       PCI Int D/AFIX IRQZ ID4 (2,7)       Level&n; */
DECL|function|ppc7d_map_irq
r_static
r_int
id|__init
id|ppc7d_map_irq
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
r_char
id|idsel
comma
r_int
r_char
id|pin
)paren
(brace
r_static
r_const
r_char
id|pci_irq_table
(braket
)braket
(braket
l_int|4
)braket
op_assign
multiline_comment|/*&n;&t;     *      PCI IDSEL/INTPIN-&gt;INTLINE&n;&t;     *         A   B   C   D&n;&t;     */
(brace
(brace
l_int|10
comma
l_int|14
comma
l_int|5
comma
l_int|9
)brace
comma
multiline_comment|/* IDSEL 10 - PMC2 / AFIX IRQW */
(brace
l_int|9
comma
l_int|10
comma
l_int|14
comma
l_int|5
)brace
comma
multiline_comment|/* IDSEL 11 - PMC1 / AFIX IRQX */
(brace
l_int|5
comma
l_int|9
comma
l_int|10
comma
l_int|14
)brace
comma
multiline_comment|/* IDSEL 12 - AFIX IRQY */
(brace
l_int|14
comma
l_int|5
comma
l_int|9
comma
l_int|10
)brace
comma
multiline_comment|/* IDSEL 13 - AFIX IRQZ */
)brace
suffix:semicolon
r_const
r_int
id|min_idsel
op_assign
l_int|10
comma
id|max_idsel
op_assign
l_int|14
comma
id|irqs_per_slot
op_assign
l_int|4
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: %04x/%04x/%x: idsel=%hx pin=%hu&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dev-&gt;vendor
comma
id|dev-&gt;device
comma
id|PCI_FUNC
c_func
(paren
id|dev-&gt;devfn
)paren
comma
id|idsel
comma
id|pin
)paren
suffix:semicolon
r_return
id|PCI_IRQ_TABLE_LOOKUP
suffix:semicolon
)brace
DECL|function|ppc7d_intr_setup
r_void
id|__init
id|ppc7d_intr_setup
c_func
(paren
r_void
)paren
(brace
id|u32
id|data
suffix:semicolon
multiline_comment|/*&n;&t; * Define GPP 28 interrupt polarity as active high&n;&t; * input signal and level triggered&n;&t; */
id|data
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_GPP_LEVEL_CNTL
)paren
suffix:semicolon
id|data
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|28
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_GPP_LEVEL_CNTL
comma
id|data
)paren
suffix:semicolon
id|data
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_GPP_IO_CNTL
)paren
suffix:semicolon
id|data
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|28
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_GPP_IO_CNTL
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* Config GPP intr ctlr to respond to level trigger */
id|data
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_COMM_ARBITER_CNTL
)paren
suffix:semicolon
id|data
op_or_assign
(paren
l_int|1
op_lshift
l_int|10
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_COMM_ARBITER_CNTL
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* XXXX Erranum FEr PCI-#8 */
id|data
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_PCI0_CMD
)paren
suffix:semicolon
id|data
op_and_assign
op_complement
(paren
(paren
l_int|1
op_lshift
l_int|5
)paren
op_or
(paren
l_int|1
op_lshift
l_int|9
)paren
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_PCI0_CMD
comma
id|data
)paren
suffix:semicolon
id|data
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_PCI1_CMD
)paren
suffix:semicolon
id|data
op_and_assign
op_complement
(paren
(paren
l_int|1
op_lshift
l_int|5
)paren
op_or
(paren
l_int|1
op_lshift
l_int|9
)paren
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_PCI1_CMD
comma
id|data
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Dismiss and then enable interrupt on GPP interrupt cause&n;&t; * for CPU #0&n;&t; */
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_GPP_INTR_CAUSE
comma
op_complement
(paren
l_int|1
op_lshift
l_int|28
)paren
)paren
suffix:semicolon
id|data
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_GPP_INTR_MASK
)paren
suffix:semicolon
id|data
op_or_assign
(paren
l_int|1
op_lshift
l_int|28
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_GPP_INTR_MASK
comma
id|data
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Dismiss and then enable interrupt on CPU #0 high cause reg&n;&t; * BIT27 summarizes GPP interrupts 23-31&n;&t; */
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64360_IC_MAIN_CAUSE_HI
comma
op_complement
(paren
l_int|1
op_lshift
l_int|27
)paren
)paren
suffix:semicolon
id|data
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64360_IC_CPU0_INTR_MASK_HI
)paren
suffix:semicolon
id|data
op_or_assign
(paren
l_int|1
op_lshift
l_int|27
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64360_IC_CPU0_INTR_MASK_HI
comma
id|data
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * Platform device data fixup routines.&n; *****************************************************************************/
macro_line|#if defined(CONFIG_SERIAL_MPSC)
DECL|function|ppc7d_fixup_mpsc_pdata
r_static
r_void
id|__init
id|ppc7d_fixup_mpsc_pdata
c_func
(paren
r_struct
id|platform_device
op_star
id|pdev
)paren
(brace
r_struct
id|mpsc_pdata
op_star
id|pdata
suffix:semicolon
id|pdata
op_assign
(paren
r_struct
id|mpsc_pdata
op_star
)paren
id|pdev-&gt;dev.platform_data
suffix:semicolon
id|pdata-&gt;max_idle
op_assign
l_int|40
suffix:semicolon
id|pdata-&gt;default_baud
op_assign
id|PPC7D_DEFAULT_BAUD
suffix:semicolon
id|pdata-&gt;brg_clk_src
op_assign
id|PPC7D_MPSC_CLK_SRC
suffix:semicolon
id|pdata-&gt;brg_clk_freq
op_assign
id|PPC7D_MPSC_CLK_FREQ
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if defined(CONFIG_MV643XX_ETH)
DECL|function|ppc7d_fixup_eth_pdata
r_static
r_void
id|__init
id|ppc7d_fixup_eth_pdata
c_func
(paren
r_struct
id|platform_device
op_star
id|pdev
)paren
(brace
r_struct
id|mv643xx_eth_platform_data
op_star
id|eth_pd
suffix:semicolon
r_static
id|u16
id|phy_addr
(braket
)braket
op_assign
(brace
id|PPC7D_ETH0_PHY_ADDR
comma
id|PPC7D_ETH1_PHY_ADDR
comma
id|PPC7D_ETH2_PHY_ADDR
comma
)brace
suffix:semicolon
r_int
id|i
suffix:semicolon
id|eth_pd
op_assign
id|pdev-&gt;dev.platform_data
suffix:semicolon
id|eth_pd-&gt;force_phy_addr
op_assign
l_int|1
suffix:semicolon
id|eth_pd-&gt;phy_addr
op_assign
id|phy_addr
(braket
id|pdev-&gt;id
)braket
suffix:semicolon
id|eth_pd-&gt;tx_queue_size
op_assign
id|PPC7D_ETH_TX_QUEUE_SIZE
suffix:semicolon
id|eth_pd-&gt;rx_queue_size
op_assign
id|PPC7D_ETH_RX_QUEUE_SIZE
suffix:semicolon
multiline_comment|/* Adjust IRQ by mv64360_irq_base */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pdev-&gt;num_resources
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|resource
op_star
id|r
op_assign
op_amp
id|pdev-&gt;resource
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|r-&gt;flags
op_amp
id|IORESOURCE_IRQ
)paren
(brace
id|r-&gt;start
op_add_assign
id|mv64360_irq_base
suffix:semicolon
id|r-&gt;end
op_add_assign
id|mv64360_irq_base
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s, uses IRQ %d&bslash;n&quot;
comma
id|pdev-&gt;name
comma
(paren
r_int
)paren
id|r-&gt;start
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
macro_line|#if defined(CONFIG_I2C_MV64XXX)
r_static
r_void
id|__init
DECL|function|ppc7d_fixup_i2c_pdata
id|ppc7d_fixup_i2c_pdata
c_func
(paren
r_struct
id|platform_device
op_star
id|pdev
)paren
(brace
r_struct
id|mv64xxx_i2c_pdata
op_star
id|pdata
suffix:semicolon
r_int
id|i
suffix:semicolon
id|pdata
op_assign
id|pdev-&gt;dev.platform_data
suffix:semicolon
r_if
c_cond
(paren
id|pdata
op_eq
l_int|NULL
)paren
(brace
id|pdata
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|pdata
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdata
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|memset
c_func
(paren
id|pdata
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|pdata
)paren
)paren
suffix:semicolon
id|pdev-&gt;dev.platform_data
op_assign
id|pdata
suffix:semicolon
)brace
multiline_comment|/* divisors M=8, N=3 for 100kHz I2C from 133MHz system clock */
id|pdata-&gt;freq_m
op_assign
l_int|8
suffix:semicolon
id|pdata-&gt;freq_n
op_assign
l_int|3
suffix:semicolon
id|pdata-&gt;timeout
op_assign
l_int|500
suffix:semicolon
id|pdata-&gt;retries
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* Adjust IRQ by mv64360_irq_base */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pdev-&gt;num_resources
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|resource
op_star
id|r
op_assign
op_amp
id|pdev-&gt;resource
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|r-&gt;flags
op_amp
id|IORESOURCE_IRQ
)paren
(brace
id|r-&gt;start
op_add_assign
id|mv64360_irq_base
suffix:semicolon
id|r-&gt;end
op_add_assign
id|mv64360_irq_base
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s, uses IRQ %d&bslash;n&quot;
comma
id|pdev-&gt;name
comma
(paren
r_int
)paren
id|r-&gt;start
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
DECL|function|ppc7d_platform_notify
r_static
r_int
id|__init
id|ppc7d_platform_notify
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_static
r_struct
(brace
r_char
op_star
id|bus_id
suffix:semicolon
r_void
(paren
(paren
op_star
id|rtn
)paren
(paren
r_struct
id|platform_device
op_star
id|pdev
)paren
)paren
suffix:semicolon
)brace
id|dev_map
(braket
)braket
op_assign
(brace
macro_line|#if defined(CONFIG_SERIAL_MPSC)
(brace
id|MPSC_CTLR_NAME
l_string|&quot;.0&quot;
comma
id|ppc7d_fixup_mpsc_pdata
)brace
comma
(brace
id|MPSC_CTLR_NAME
l_string|&quot;.1&quot;
comma
id|ppc7d_fixup_mpsc_pdata
)brace
comma
macro_line|#endif
macro_line|#if defined(CONFIG_MV643XX_ETH)
(brace
id|MV643XX_ETH_NAME
l_string|&quot;.0&quot;
comma
id|ppc7d_fixup_eth_pdata
)brace
comma
(brace
id|MV643XX_ETH_NAME
l_string|&quot;.1&quot;
comma
id|ppc7d_fixup_eth_pdata
)brace
comma
(brace
id|MV643XX_ETH_NAME
l_string|&quot;.2&quot;
comma
id|ppc7d_fixup_eth_pdata
)brace
comma
macro_line|#endif
macro_line|#if defined(CONFIG_I2C_MV64XXX)
(brace
id|MV64XXX_I2C_CTLR_NAME
l_string|&quot;.0&quot;
comma
id|ppc7d_fixup_i2c_pdata
)brace
comma
macro_line|#endif
)brace
suffix:semicolon
r_struct
id|platform_device
op_star
id|pdev
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_logical_and
id|dev-&gt;bus_id
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|dev_map
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|dev-&gt;bus_id
comma
id|dev_map
(braket
id|i
)braket
dot
id|bus_id
comma
id|BUS_ID_SIZE
)paren
)paren
(brace
id|pdev
op_assign
id|container_of
c_func
(paren
id|dev
comma
r_struct
id|platform_device
comma
id|dev
)paren
suffix:semicolon
id|dev_map
(braket
id|i
)braket
dot
id|rtn
c_func
(paren
id|pdev
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * PCI device fixups.&n; * These aren&squot;t really fixups per se. They are used to init devices as they&n; * are found during PCI scan.&n; *&n; * The PPC7D has an HB8 PCI-X bridge which must be set up during a PCI&n; * scan in order to find other devices on its secondary side.&n; *****************************************************************************/
DECL|function|ppc7d_fixup_hb8
r_static
r_void
id|__init
id|ppc7d_fixup_hb8
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|u16
id|val16
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;bus-&gt;number
op_eq
l_int|0
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;PCI: HB8 init&bslash;n&quot;
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0x1c
comma
(paren
(paren
id|PPC7D_PCI0_IO_START_PCI_ADDR
op_amp
l_int|0xf000
)paren
op_rshift
l_int|8
)paren
op_or
l_int|0x01
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0x1d
comma
(paren
(paren
(paren
id|PPC7D_PCI0_IO_START_PCI_ADDR
op_plus
id|PPC7D_PCI0_IO_SIZE
op_minus
l_int|1
)paren
op_amp
l_int|0xf000
)paren
op_rshift
l_int|8
)paren
op_or
l_int|0x01
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|dev
comma
l_int|0x30
comma
id|PPC7D_PCI0_IO_START_PCI_ADDR
op_rshift
l_int|16
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|dev
comma
l_int|0x32
comma
(paren
(paren
id|PPC7D_PCI0_IO_START_PCI_ADDR
op_plus
id|PPC7D_PCI0_IO_SIZE
op_minus
l_int|1
)paren
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|dev
comma
l_int|0x20
comma
id|PPC7D_PCI0_MEM0_START_PCI_LO_ADDR
op_rshift
l_int|16
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|dev
comma
l_int|0x22
comma
(paren
(paren
id|PPC7D_PCI0_MEM0_START_PCI_LO_ADDR
op_plus
id|PPC7D_PCI0_MEM0_SIZE
op_minus
l_int|1
)paren
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|dev
comma
l_int|0x24
comma
l_int|0
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|dev
comma
l_int|0x26
comma
l_int|0
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|dev
comma
l_int|0x28
comma
l_int|0
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|dev
comma
l_int|0x2c
comma
l_int|0
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|dev
comma
l_int|0x3e
comma
op_amp
id|val16
)paren
suffix:semicolon
id|val16
op_or_assign
(paren
(paren
l_int|1
op_lshift
l_int|5
)paren
op_or
(paren
l_int|1
op_lshift
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/* signal master aborts and&n;&t;&t;&t;&t;&t;&t; * SERR to primary&n;&t;&t;&t;&t;&t;&t; */
id|val16
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|2
)paren
suffix:semicolon
multiline_comment|/* ISA disable, so all ISA&n;&t;&t;&t;&t;&t;&t; * ports forwarded to secondary&n;&t;&t;&t;&t;&t;&t; */
id|pci_write_config_word
c_func
(paren
id|dev
comma
l_int|0x3e
comma
id|val16
)paren
suffix:semicolon
)brace
)brace
id|DECLARE_PCI_FIXUP_HEADER
c_func
(paren
id|PCI_VENDOR_ID_HINT
comma
l_int|0x0028
comma
id|ppc7d_fixup_hb8
)paren
suffix:semicolon
multiline_comment|/* This should perhaps be a separate driver as we&squot;re actually initializing&n; * the chip for this board here. It&squot;s hardly a fixup...&n; */
DECL|function|ppc7d_fixup_ali1535
r_static
r_void
id|__init
id|ppc7d_fixup_ali1535
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;PCI: ALI1535 init&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;bus-&gt;number
op_eq
l_int|1
)paren
(brace
multiline_comment|/* Configure the ISA Port Settings */
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0x43
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Disable PCI Interrupt polling mode */
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0x45
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Multifunction pin select INTFJ -&gt; INTF */
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0x78
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Set PCI INT -&gt; IRQ Routing control in for external&n;&t;&t; * pins south bridge.&n;&t;&t; */
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0x48
comma
l_int|0x31
)paren
suffix:semicolon
multiline_comment|/* [7-4] INT B -&gt; IRQ10&n;&t;&t;&t;&t;&t;&t;&t; * [3-0] INT A -&gt; IRQ9&n;&t;&t;&t;&t;&t;&t;&t; */
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0x49
comma
l_int|0x5D
)paren
suffix:semicolon
multiline_comment|/* [7-4] INT D -&gt; IRQ5&n;&t;&t;&t;&t;&t;&t;&t; * [3-0] INT C -&gt; IRQ14&n;&t;&t;&t;&t;&t;&t;&t; */
multiline_comment|/* PPC7D setup */
multiline_comment|/* NEC USB device on IRQ 11 (INTE) - INTF disabled */
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0x4A
comma
l_int|0x09
)paren
suffix:semicolon
multiline_comment|/* GPIO on IRQ 6 */
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0x76
comma
l_int|0x07
)paren
suffix:semicolon
multiline_comment|/* SIRQ I (COMS 5/6) use IRQ line 15.&n;&t;&t; * Positive (not subtractive) address decode.&n;&t;&t; */
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0x44
comma
l_int|0x0f
)paren
suffix:semicolon
multiline_comment|/* SIRQ II disabled */
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0x75
comma
l_int|0x0
)paren
suffix:semicolon
multiline_comment|/* On board USB and RTC disabled */
id|pci_write_config_word
c_func
(paren
id|dev
comma
l_int|0x52
comma
(paren
l_int|1
op_lshift
l_int|14
)paren
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0x74
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* On board IDE disabled */
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0x58
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Decode 32-bit addresses */
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0x5b
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Disable docking IO */
id|pci_write_config_word
c_func
(paren
id|dev
comma
l_int|0x5c
comma
l_int|0x0000
)paren
suffix:semicolon
multiline_comment|/* Disable modem, enable sound */
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0x77
comma
(paren
l_int|1
op_lshift
l_int|6
)paren
)paren
suffix:semicolon
multiline_comment|/* Disable hot-docking mode */
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0x7d
comma
l_int|0x00
)paren
suffix:semicolon
)brace
)brace
id|DECLARE_PCI_FIXUP_HEADER
c_func
(paren
id|PCI_VENDOR_ID_AL
comma
l_int|0x1533
comma
id|ppc7d_fixup_ali1535
)paren
suffix:semicolon
DECL|function|ppc7d_pci_exclude_device
r_static
r_int
id|ppc7d_pci_exclude_device
c_func
(paren
id|u8
id|bus
comma
id|u8
id|devfn
)paren
(brace
multiline_comment|/* Early versions of this board were fitted with IBM ALMA&n;&t; * PCI-VME bridge chips. The PCI config space of these devices&n;&t; * was not set up correctly and causes PCI scan problems.&n;&t; */
r_if
c_cond
(paren
(paren
id|bus
op_eq
l_int|1
)paren
op_logical_and
(paren
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
op_eq
l_int|4
)paren
op_logical_and
id|ppc7d_has_alma
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_return
id|mv64x60_pci_exclude_device
c_func
(paren
id|bus
comma
id|devfn
)paren
suffix:semicolon
)brace
multiline_comment|/* This hook is called when each PCI bus is probed.&n; */
DECL|function|ppc7d_pci_fixup_bus
r_static
r_void
id|ppc7d_pci_fixup_bus
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;PCI BUS %hu: %lx/%lx %lx/%lx %lx/%lx %lx/%lx&bslash;n&quot;
comma
id|bus-&gt;number
comma
id|bus-&gt;resource
(braket
l_int|0
)braket
ques
c_cond
id|bus-&gt;resource
(braket
l_int|0
)braket
op_member_access_from_pointer
id|start
suffix:colon
l_int|0
comma
id|bus-&gt;resource
(braket
l_int|0
)braket
ques
c_cond
id|bus-&gt;resource
(braket
l_int|0
)braket
op_member_access_from_pointer
id|end
suffix:colon
l_int|0
comma
id|bus-&gt;resource
(braket
l_int|1
)braket
ques
c_cond
id|bus-&gt;resource
(braket
l_int|1
)braket
op_member_access_from_pointer
id|start
suffix:colon
l_int|0
comma
id|bus-&gt;resource
(braket
l_int|1
)braket
ques
c_cond
id|bus-&gt;resource
(braket
l_int|1
)braket
op_member_access_from_pointer
id|end
suffix:colon
l_int|0
comma
id|bus-&gt;resource
(braket
l_int|2
)braket
ques
c_cond
id|bus-&gt;resource
(braket
l_int|2
)braket
op_member_access_from_pointer
id|start
suffix:colon
l_int|0
comma
id|bus-&gt;resource
(braket
l_int|2
)braket
ques
c_cond
id|bus-&gt;resource
(braket
l_int|2
)braket
op_member_access_from_pointer
id|end
suffix:colon
l_int|0
comma
id|bus-&gt;resource
(braket
l_int|3
)braket
ques
c_cond
id|bus-&gt;resource
(braket
l_int|3
)braket
op_member_access_from_pointer
id|start
suffix:colon
l_int|0
comma
id|bus-&gt;resource
(braket
l_int|3
)braket
ques
c_cond
id|bus-&gt;resource
(braket
l_int|3
)braket
op_member_access_from_pointer
id|end
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bus-&gt;number
op_eq
l_int|1
)paren
op_logical_and
(paren
id|bus-&gt;resource
(braket
l_int|2
)braket
op_ne
l_int|NULL
)paren
)paren
(brace
multiline_comment|/* Hide PCI window 2 of Bus 1 which is used only to&n;&t;&t; * map legacy ISA memory space.&n;&t;&t; */
id|bus-&gt;resource
(braket
l_int|2
)braket
op_member_access_from_pointer
id|start
op_assign
l_int|0
suffix:semicolon
id|bus-&gt;resource
(braket
l_int|2
)braket
op_member_access_from_pointer
id|end
op_assign
l_int|0
suffix:semicolon
id|bus-&gt;resource
(braket
l_int|2
)braket
op_member_access_from_pointer
id|flags
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*****************************************************************************&n; * Board device setup code&n; *****************************************************************************/
DECL|function|ppc7d_setup_peripherals
r_void
id|__init
id|ppc7d_setup_peripherals
c_func
(paren
r_void
)paren
(brace
id|u32
id|val32
suffix:semicolon
multiline_comment|/* Set up windows for boot CS */
id|mv64x60_set_32bit_window
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU2BOOT_WIN
comma
id|PPC7D_BOOT_WINDOW_BASE
comma
id|PPC7D_BOOT_WINDOW_SIZE
comma
l_int|0
)paren
suffix:semicolon
id|bh.ci
op_member_access_from_pointer
id|enable_window_32bit
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU2BOOT_WIN
)paren
suffix:semicolon
multiline_comment|/* Boot firmware configures the following DevCS addresses.&n;&t; * DevCS0 - board control/status&n;&t; * DevCS1 - test registers&n;&t; * DevCS2 - AFIX port/address registers (for identifying)&n;&t; * DevCS3 - FLASH&n;&t; *&n;&t; * We don&squot;t use DevCS0, DevCS1.&n;&t; */
id|val32
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64360_CPU_BAR_ENABLE
)paren
suffix:semicolon
id|val32
op_or_assign
(paren
(paren
l_int|1
op_lshift
l_int|4
)paren
op_or
(paren
l_int|1
op_lshift
l_int|5
)paren
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64360_CPU_BAR_ENABLE
comma
id|val32
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU2DEV_0_BASE
comma
l_int|0
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU2DEV_0_SIZE
comma
l_int|0
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU2DEV_1_BASE
comma
l_int|0
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU2DEV_1_SIZE
comma
l_int|0
)paren
suffix:semicolon
id|mv64x60_set_32bit_window
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU2DEV_2_WIN
comma
id|PPC7D_AFIX_REG_BASE
comma
id|PPC7D_AFIX_REG_SIZE
comma
l_int|0
)paren
suffix:semicolon
id|bh.ci
op_member_access_from_pointer
id|enable_window_32bit
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU2DEV_2_WIN
)paren
suffix:semicolon
id|mv64x60_set_32bit_window
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU2DEV_3_WIN
comma
id|PPC7D_FLASH_BASE
comma
id|PPC7D_FLASH_SIZE_ACTUAL
comma
l_int|0
)paren
suffix:semicolon
id|bh.ci
op_member_access_from_pointer
id|enable_window_32bit
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU2DEV_3_WIN
)paren
suffix:semicolon
id|mv64x60_set_32bit_window
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU2SRAM_WIN
comma
id|PPC7D_INTERNAL_SRAM_BASE
comma
id|MV64360_SRAM_SIZE
comma
l_int|0
)paren
suffix:semicolon
id|bh.ci
op_member_access_from_pointer
id|enable_window_32bit
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU2SRAM_WIN
)paren
suffix:semicolon
multiline_comment|/* Set up Enet-&gt;SRAM window */
id|mv64x60_set_32bit_window
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_ENET2MEM_4_WIN
comma
id|PPC7D_INTERNAL_SRAM_BASE
comma
id|MV64360_SRAM_SIZE
comma
l_int|0x2
)paren
suffix:semicolon
id|bh.ci
op_member_access_from_pointer
id|enable_window_32bit
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_ENET2MEM_4_WIN
)paren
suffix:semicolon
multiline_comment|/* Give enet r/w access to memory region */
id|val32
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64360_ENET2MEM_ACC_PROT_0
)paren
suffix:semicolon
id|val32
op_or_assign
(paren
l_int|0x3
op_lshift
(paren
l_int|4
op_lshift
l_int|1
)paren
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64360_ENET2MEM_ACC_PROT_0
comma
id|val32
)paren
suffix:semicolon
id|val32
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64360_ENET2MEM_ACC_PROT_1
)paren
suffix:semicolon
id|val32
op_or_assign
(paren
l_int|0x3
op_lshift
(paren
l_int|4
op_lshift
l_int|1
)paren
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64360_ENET2MEM_ACC_PROT_1
comma
id|val32
)paren
suffix:semicolon
id|val32
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64360_ENET2MEM_ACC_PROT_2
)paren
suffix:semicolon
id|val32
op_or_assign
(paren
l_int|0x3
op_lshift
(paren
l_int|4
op_lshift
l_int|1
)paren
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64360_ENET2MEM_ACC_PROT_2
comma
id|val32
)paren
suffix:semicolon
id|val32
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_TIMR_CNTR_0_3_CNTL
)paren
suffix:semicolon
id|val32
op_and_assign
op_complement
(paren
(paren
l_int|1
op_lshift
l_int|0
)paren
op_or
(paren
l_int|1
op_lshift
l_int|8
)paren
op_or
(paren
l_int|1
op_lshift
l_int|16
)paren
op_or
(paren
l_int|1
op_lshift
l_int|24
)paren
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_TIMR_CNTR_0_3_CNTL
comma
id|val32
)paren
suffix:semicolon
multiline_comment|/* Enumerate pci bus.&n;&t; *&n;&t; * We scan PCI#0 first (the bus with the HB8 and other&n;&t; * on-board peripherals). We must configure the 64360 before&n;&t; * each scan, according to the bus number assignments.  Busses&n;&t; * are assigned incrementally, starting at 0.  PCI#0 is&n;&t; * usually assigned bus#0, the secondary side of the HB8 gets&n;&t; * bus#1 and PCI#1 (second PMC site) gets bus#2.  However, if&n;&t; * any PMC card has a PCI bridge, these bus assignments will&n;&t; * change.&n;&t; */
multiline_comment|/* Turn off PCI retries */
id|val32
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU_CONFIG
)paren
suffix:semicolon
id|val32
op_or_assign
(paren
l_int|1
op_lshift
l_int|17
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU_CONFIG
comma
id|val32
)paren
suffix:semicolon
multiline_comment|/* Scan PCI#0 */
id|mv64x60_set_bus
c_func
(paren
op_amp
id|bh
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|bh.hose_a-&gt;first_busno
op_assign
l_int|0
suffix:semicolon
id|bh.hose_a-&gt;last_busno
op_assign
l_int|0xff
suffix:semicolon
id|bh.hose_a-&gt;last_busno
op_assign
id|pciauto_bus_scan
c_func
(paren
id|bh.hose_a
comma
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PCI#0: first=%d last=%d&bslash;n&quot;
comma
id|bh.hose_a-&gt;first_busno
comma
id|bh.hose_a-&gt;last_busno
)paren
suffix:semicolon
multiline_comment|/* Scan PCI#1 */
id|bh.hose_b-&gt;first_busno
op_assign
id|bh.hose_a-&gt;last_busno
op_plus
l_int|1
suffix:semicolon
id|mv64x60_set_bus
c_func
(paren
op_amp
id|bh
comma
l_int|1
comma
id|bh.hose_b-&gt;first_busno
)paren
suffix:semicolon
id|bh.hose_b-&gt;last_busno
op_assign
l_int|0xff
suffix:semicolon
id|bh.hose_b-&gt;last_busno
op_assign
id|pciauto_bus_scan
c_func
(paren
id|bh.hose_b
comma
id|bh.hose_b-&gt;first_busno
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PCI#1: first=%d last=%d&bslash;n&quot;
comma
id|bh.hose_b-&gt;first_busno
comma
id|bh.hose_b-&gt;last_busno
)paren
suffix:semicolon
multiline_comment|/* Turn on PCI retries */
id|val32
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU_CONFIG
)paren
suffix:semicolon
id|val32
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|17
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU_CONFIG
comma
id|val32
)paren
suffix:semicolon
multiline_comment|/* Setup interrupts */
id|ppc7d_intr_setup
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|ppc7d_setup_bridge
r_static
r_void
id|__init
id|ppc7d_setup_bridge
c_func
(paren
r_void
)paren
(brace
r_struct
id|mv64x60_setup_info
id|si
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
id|temp
suffix:semicolon
id|mv64360_irq_base
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* first 16 intrs are 2 x 8259&squot;s */
id|memset
c_func
(paren
op_amp
id|si
comma
l_int|0
comma
r_sizeof
(paren
id|si
)paren
)paren
suffix:semicolon
id|si.phys_reg_base
op_assign
id|CONFIG_MV64X60_NEW_BASE
suffix:semicolon
id|si.pci_0.enable_bus
op_assign
l_int|1
suffix:semicolon
id|si.pci_0.pci_io.cpu_base
op_assign
id|PPC7D_PCI0_IO_START_PROC_ADDR
suffix:semicolon
id|si.pci_0.pci_io.pci_base_hi
op_assign
l_int|0
suffix:semicolon
id|si.pci_0.pci_io.pci_base_lo
op_assign
id|PPC7D_PCI0_IO_START_PCI_ADDR
suffix:semicolon
id|si.pci_0.pci_io.size
op_assign
id|PPC7D_PCI0_IO_SIZE
suffix:semicolon
id|si.pci_0.pci_io.swap
op_assign
id|MV64x60_CPU2PCI_SWAP_NONE
suffix:semicolon
id|si.pci_0.pci_mem
(braket
l_int|0
)braket
dot
id|cpu_base
op_assign
id|PPC7D_PCI0_MEM0_START_PROC_ADDR
suffix:semicolon
id|si.pci_0.pci_mem
(braket
l_int|0
)braket
dot
id|pci_base_hi
op_assign
id|PPC7D_PCI0_MEM0_START_PCI_HI_ADDR
suffix:semicolon
id|si.pci_0.pci_mem
(braket
l_int|0
)braket
dot
id|pci_base_lo
op_assign
id|PPC7D_PCI0_MEM0_START_PCI_LO_ADDR
suffix:semicolon
id|si.pci_0.pci_mem
(braket
l_int|0
)braket
dot
id|size
op_assign
id|PPC7D_PCI0_MEM0_SIZE
suffix:semicolon
id|si.pci_0.pci_mem
(braket
l_int|0
)braket
dot
id|swap
op_assign
id|MV64x60_CPU2PCI_SWAP_NONE
suffix:semicolon
id|si.pci_0.pci_mem
(braket
l_int|1
)braket
dot
id|cpu_base
op_assign
id|PPC7D_PCI0_MEM1_START_PROC_ADDR
suffix:semicolon
id|si.pci_0.pci_mem
(braket
l_int|1
)braket
dot
id|pci_base_hi
op_assign
id|PPC7D_PCI0_MEM1_START_PCI_HI_ADDR
suffix:semicolon
id|si.pci_0.pci_mem
(braket
l_int|1
)braket
dot
id|pci_base_lo
op_assign
id|PPC7D_PCI0_MEM1_START_PCI_LO_ADDR
suffix:semicolon
id|si.pci_0.pci_mem
(braket
l_int|1
)braket
dot
id|size
op_assign
id|PPC7D_PCI0_MEM1_SIZE
suffix:semicolon
id|si.pci_0.pci_mem
(braket
l_int|1
)braket
dot
id|swap
op_assign
id|MV64x60_CPU2PCI_SWAP_NONE
suffix:semicolon
id|si.pci_0.pci_cmd_bits
op_assign
l_int|0
suffix:semicolon
id|si.pci_0.latency_timer
op_assign
l_int|0x80
suffix:semicolon
id|si.pci_1.enable_bus
op_assign
l_int|1
suffix:semicolon
id|si.pci_1.pci_io.cpu_base
op_assign
id|PPC7D_PCI1_IO_START_PROC_ADDR
suffix:semicolon
id|si.pci_1.pci_io.pci_base_hi
op_assign
l_int|0
suffix:semicolon
id|si.pci_1.pci_io.pci_base_lo
op_assign
id|PPC7D_PCI1_IO_START_PCI_ADDR
suffix:semicolon
id|si.pci_1.pci_io.size
op_assign
id|PPC7D_PCI1_IO_SIZE
suffix:semicolon
id|si.pci_1.pci_io.swap
op_assign
id|MV64x60_CPU2PCI_SWAP_NONE
suffix:semicolon
id|si.pci_1.pci_mem
(braket
l_int|0
)braket
dot
id|cpu_base
op_assign
id|PPC7D_PCI1_MEM0_START_PROC_ADDR
suffix:semicolon
id|si.pci_1.pci_mem
(braket
l_int|0
)braket
dot
id|pci_base_hi
op_assign
id|PPC7D_PCI1_MEM0_START_PCI_HI_ADDR
suffix:semicolon
id|si.pci_1.pci_mem
(braket
l_int|0
)braket
dot
id|pci_base_lo
op_assign
id|PPC7D_PCI1_MEM0_START_PCI_LO_ADDR
suffix:semicolon
id|si.pci_1.pci_mem
(braket
l_int|0
)braket
dot
id|size
op_assign
id|PPC7D_PCI1_MEM0_SIZE
suffix:semicolon
id|si.pci_1.pci_mem
(braket
l_int|0
)braket
dot
id|swap
op_assign
id|MV64x60_CPU2PCI_SWAP_NONE
suffix:semicolon
id|si.pci_1.pci_mem
(braket
l_int|1
)braket
dot
id|cpu_base
op_assign
id|PPC7D_PCI1_MEM1_START_PROC_ADDR
suffix:semicolon
id|si.pci_1.pci_mem
(braket
l_int|1
)braket
dot
id|pci_base_hi
op_assign
id|PPC7D_PCI1_MEM1_START_PCI_HI_ADDR
suffix:semicolon
id|si.pci_1.pci_mem
(braket
l_int|1
)braket
dot
id|pci_base_lo
op_assign
id|PPC7D_PCI1_MEM1_START_PCI_LO_ADDR
suffix:semicolon
id|si.pci_1.pci_mem
(braket
l_int|1
)braket
dot
id|size
op_assign
id|PPC7D_PCI1_MEM1_SIZE
suffix:semicolon
id|si.pci_1.pci_mem
(braket
l_int|1
)braket
dot
id|swap
op_assign
id|MV64x60_CPU2PCI_SWAP_NONE
suffix:semicolon
id|si.pci_1.pci_cmd_bits
op_assign
l_int|0
suffix:semicolon
id|si.pci_1.latency_timer
op_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* Don&squot;t clear the SRAM window since we use it for debug */
id|si.window_preserve_mask_32_lo
op_assign
(paren
l_int|1
op_lshift
id|MV64x60_CPU2SRAM_WIN
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PCI: MV64360 PCI#0 IO at %x, size %x&bslash;n&quot;
comma
id|si.pci_0.pci_io.cpu_base
comma
id|si.pci_0.pci_io.size
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PCI: MV64360 PCI#1 IO at %x, size %x&bslash;n&quot;
comma
id|si.pci_1.pci_io.cpu_base
comma
id|si.pci_1.pci_io.size
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MV64x60_CPU2MEM_WINDOWS
suffix:semicolon
id|i
op_increment
)paren
(brace
macro_line|#if defined(CONFIG_NOT_COHERENT_CACHE)
id|si.cpu_prot_options
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|si.enet_options
(braket
id|i
)braket
op_assign
id|MV64360_ENET2MEM_SNOOP_NONE
suffix:semicolon
id|si.mpsc_options
(braket
id|i
)braket
op_assign
id|MV64360_MPSC2MEM_SNOOP_NONE
suffix:semicolon
id|si.idma_options
(braket
id|i
)braket
op_assign
id|MV64360_IDMA2MEM_SNOOP_NONE
suffix:semicolon
id|si.pci_0.acc_cntl_options
(braket
id|i
)braket
op_assign
id|MV64360_PCI_ACC_CNTL_SNOOP_NONE
op_or
id|MV64360_PCI_ACC_CNTL_SWAP_NONE
op_or
id|MV64360_PCI_ACC_CNTL_MBURST_128_BYTES
op_or
id|MV64360_PCI_ACC_CNTL_RDSIZE_256_BYTES
suffix:semicolon
id|si.pci_1.acc_cntl_options
(braket
id|i
)braket
op_assign
id|MV64360_PCI_ACC_CNTL_SNOOP_NONE
op_or
id|MV64360_PCI_ACC_CNTL_SWAP_NONE
op_or
id|MV64360_PCI_ACC_CNTL_MBURST_128_BYTES
op_or
id|MV64360_PCI_ACC_CNTL_RDSIZE_256_BYTES
suffix:semicolon
macro_line|#else
id|si.cpu_prot_options
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* All PPC7D hardware uses B0 or newer MV64360 silicon which&n;&t;&t; * does not have snoop bugs.&n;&t;&t; */
id|si.enet_options
(braket
id|i
)braket
op_assign
id|MV64360_ENET2MEM_SNOOP_WB
suffix:semicolon
id|si.mpsc_options
(braket
id|i
)braket
op_assign
id|MV64360_MPSC2MEM_SNOOP_WB
suffix:semicolon
id|si.idma_options
(braket
id|i
)braket
op_assign
id|MV64360_IDMA2MEM_SNOOP_WB
suffix:semicolon
id|si.pci_0.acc_cntl_options
(braket
id|i
)braket
op_assign
id|MV64360_PCI_ACC_CNTL_SNOOP_WB
op_or
id|MV64360_PCI_ACC_CNTL_SWAP_NONE
op_or
id|MV64360_PCI_ACC_CNTL_MBURST_32_BYTES
op_or
id|MV64360_PCI_ACC_CNTL_RDSIZE_32_BYTES
suffix:semicolon
id|si.pci_1.acc_cntl_options
(braket
id|i
)braket
op_assign
id|MV64360_PCI_ACC_CNTL_SNOOP_WB
op_or
id|MV64360_PCI_ACC_CNTL_SWAP_NONE
op_or
id|MV64360_PCI_ACC_CNTL_MBURST_32_BYTES
op_or
id|MV64360_PCI_ACC_CNTL_RDSIZE_32_BYTES
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Lookup PCI host bridges */
r_if
c_cond
(paren
id|mv64x60_init
c_func
(paren
op_amp
id|bh
comma
op_amp
id|si
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MV64360 initialization failed.&bslash;n&quot;
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;MV64360 regs @ %lx/%p&bslash;n&quot;
comma
id|bh.p_base
comma
id|bh.v_base
)paren
suffix:semicolon
multiline_comment|/* Enable WB Cache coherency on SRAM */
id|temp
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64360_SRAM_CONFIG
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;SRAM_CONFIG: %x&bslash;n&quot;
comma
id|temp
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_NOT_COHERENT_CACHE)
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64360_SRAM_CONFIG
comma
id|temp
op_amp
op_complement
l_int|0x2
)paren
suffix:semicolon
macro_line|#else
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64360_SRAM_CONFIG
comma
id|temp
op_or
l_int|0x2
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* If system operates with internal bus arbiter (CPU master&n;&t; * control bit8) clear AACK Delay bit [25] in CPU&n;&t; * configuration register.&n;&t; */
id|temp
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU_MASTER_CNTL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
(paren
l_int|1
op_lshift
l_int|8
)paren
)paren
(brace
id|temp
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU_CONFIG
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU_CONFIG
comma
(paren
id|temp
op_amp
op_complement
(paren
l_int|1
op_lshift
l_int|25
)paren
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Data and address parity is enabled */
id|temp
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU_CONFIG
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU_CONFIG
comma
(paren
id|temp
op_or
(paren
l_int|1
op_lshift
l_int|26
)paren
op_or
(paren
l_int|1
op_lshift
l_int|19
)paren
)paren
)paren
suffix:semicolon
id|pci_dram_offset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* sys mem at same addr on PCI &amp; cpu bus */
id|ppc_md.pci_swizzle
op_assign
id|common_swizzle
suffix:semicolon
id|ppc_md.pci_map_irq
op_assign
id|ppc7d_map_irq
suffix:semicolon
id|ppc_md.pci_exclude_device
op_assign
id|ppc7d_pci_exclude_device
suffix:semicolon
id|mv64x60_set_bus
c_func
(paren
op_amp
id|bh
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|bh.hose_a-&gt;first_busno
op_assign
l_int|0
suffix:semicolon
id|bh.hose_a-&gt;last_busno
op_assign
l_int|0xff
suffix:semicolon
id|bh.hose_a-&gt;mem_space.start
op_assign
id|PPC7D_PCI0_MEM0_START_PCI_LO_ADDR
suffix:semicolon
id|bh.hose_a-&gt;mem_space.end
op_assign
id|PPC7D_PCI0_MEM0_START_PCI_LO_ADDR
op_plus
id|PPC7D_PCI0_MEM0_SIZE
suffix:semicolon
multiline_comment|/* These will be set later, as a result of PCI0 scan */
id|bh.hose_b-&gt;first_busno
op_assign
l_int|0
suffix:semicolon
id|bh.hose_b-&gt;last_busno
op_assign
l_int|0xff
suffix:semicolon
id|bh.hose_b-&gt;mem_space.start
op_assign
id|PPC7D_PCI1_MEM0_START_PCI_LO_ADDR
suffix:semicolon
id|bh.hose_b-&gt;mem_space.end
op_assign
id|PPC7D_PCI1_MEM0_START_PCI_LO_ADDR
op_plus
id|PPC7D_PCI1_MEM0_SIZE
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;MV64360: PCI#0 IO decode %08x/%08x IO remap %08x&bslash;n&quot;
comma
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
l_int|0x48
)paren
comma
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
l_int|0x50
)paren
comma
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
l_int|0xf0
)paren
)paren
suffix:semicolon
)brace
DECL|function|ppc7d_setup_arch
r_static
r_void
id|__init
id|ppc7d_setup_arch
c_func
(paren
r_void
)paren
(brace
r_int
id|port
suffix:semicolon
id|loops_per_jiffy
op_assign
l_int|100000000
op_div
id|HZ
suffix:semicolon
macro_line|#ifdef CONFIG_BLK_DEV_INITRD
r_if
c_cond
(paren
id|initrd_start
)paren
id|ROOT_DEV
op_assign
id|Root_RAM0
suffix:semicolon
r_else
macro_line|#endif
macro_line|#ifdef&t;CONFIG_ROOT_NFS
id|ROOT_DEV
op_assign
id|Root_NFS
suffix:semicolon
macro_line|#else
id|ROOT_DEV
op_assign
id|Root_HDA1
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|cur_cpu_spec
(braket
l_int|0
)braket
op_member_access_from_pointer
id|cpu_features
op_amp
id|CPU_FTR_SPEC7450
)paren
op_logical_or
(paren
id|cur_cpu_spec
(braket
l_int|0
)braket
op_member_access_from_pointer
id|cpu_features
op_amp
id|CPU_FTR_L3CR
)paren
)paren
multiline_comment|/* 745x is different.  We only want to pass along enable. */
id|_set_L2CR
c_func
(paren
id|L2CR_L2E
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cur_cpu_spec
(braket
l_int|0
)braket
op_member_access_from_pointer
id|cpu_features
op_amp
id|CPU_FTR_L2CR
)paren
multiline_comment|/* All modules have 1MB of L2.  We also assume that an&n;&t;&t; * L2 divisor of 3 will work.&n;&t;&t; */
id|_set_L2CR
c_func
(paren
id|L2CR_L2E
op_or
id|L2CR_L2SIZ_1MB
op_or
id|L2CR_L2CLK_DIV3
op_or
id|L2CR_L2RAM_PIPE
op_or
id|L2CR_L2OH_1_0
op_or
id|L2CR_L2DF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cur_cpu_spec
(braket
l_int|0
)braket
op_member_access_from_pointer
id|cpu_features
op_amp
id|CPU_FTR_L3CR
)paren
multiline_comment|/* No L3 cache */
id|_set_L3CR
c_func
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_DUMMY_CONSOLE
id|conswitchp
op_assign
op_amp
id|dummy_con
suffix:semicolon
macro_line|#endif
multiline_comment|/* Lookup PCI host bridges */
r_if
c_cond
(paren
id|ppc_md.progress
)paren
id|ppc_md
dot
id|progress
c_func
(paren
l_string|&quot;ppc7d_setup_arch: calling setup_bridge&quot;
comma
l_int|0
)paren
suffix:semicolon
id|ppc7d_setup_bridge
c_func
(paren
)paren
suffix:semicolon
id|ppc7d_setup_peripherals
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Disable ethernet. It might have been setup by the bootrom */
r_for
c_loop
(paren
id|port
op_assign
l_int|0
suffix:semicolon
id|port
OL
l_int|3
suffix:semicolon
id|port
op_increment
)paren
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV643XX_ETH_RECEIVE_QUEUE_COMMAND_REG
c_func
(paren
id|port
)paren
comma
l_int|0x0000ff00
)paren
suffix:semicolon
multiline_comment|/* Clear queue pointers to ensure they are all initialized,&n;&t; * otherwise since queues 1-7 are unused, they have random&n;&t; * pointers which look strange in register dumps. Don&squot;t bother&n;&t; * with queue 0 since it will be initialized later.&n;&t; */
r_for
c_loop
(paren
id|port
op_assign
l_int|0
suffix:semicolon
id|port
OL
l_int|3
suffix:semicolon
id|port
op_increment
)paren
(brace
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV643XX_ETH_RX_CURRENT_QUEUE_DESC_PTR_1
c_func
(paren
id|port
)paren
comma
l_int|0x00000000
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV643XX_ETH_RX_CURRENT_QUEUE_DESC_PTR_2
c_func
(paren
id|port
)paren
comma
l_int|0x00000000
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV643XX_ETH_RX_CURRENT_QUEUE_DESC_PTR_3
c_func
(paren
id|port
)paren
comma
l_int|0x00000000
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV643XX_ETH_RX_CURRENT_QUEUE_DESC_PTR_4
c_func
(paren
id|port
)paren
comma
l_int|0x00000000
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV643XX_ETH_RX_CURRENT_QUEUE_DESC_PTR_5
c_func
(paren
id|port
)paren
comma
l_int|0x00000000
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV643XX_ETH_RX_CURRENT_QUEUE_DESC_PTR_6
c_func
(paren
id|port
)paren
comma
l_int|0x00000000
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV643XX_ETH_RX_CURRENT_QUEUE_DESC_PTR_7
c_func
(paren
id|port
)paren
comma
l_int|0x00000000
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Radstone Technology PPC7D&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppc_md.progress
)paren
id|ppc_md
dot
id|progress
c_func
(paren
l_string|&quot;ppc7d_setup_arch: exit&quot;
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* This kernel command line parameter can be used to have the target&n; * wait for a JTAG debugger to attach. Of course, a JTAG debugger&n; * with hardware breakpoint support can have the target stop at any&n; * location during init, but this is a convenience feature that makes&n; * it easier in the common case of loading the code using the ppcboot&n; * bootloader..&n; */
DECL|variable|ppc7d_wait_debugger
r_static
r_int
r_int
id|ppc7d_wait_debugger
suffix:semicolon
DECL|function|ppc7d_waitdbg
r_static
r_int
id|__init
id|ppc7d_waitdbg
c_func
(paren
r_char
op_star
id|str
)paren
(brace
id|ppc7d_wait_debugger
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;waitdbg&quot;
comma
id|ppc7d_waitdbg
)paren
suffix:semicolon
multiline_comment|/* Second phase board init, called after other (architecture common)&n; * low-level services have been initialized.&n; */
DECL|function|ppc7d_init2
r_static
r_void
id|ppc7d_init2
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|data
suffix:semicolon
id|u8
id|data8
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: enter&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* Wait for debugger? */
r_if
c_cond
(paren
id|ppc7d_wait_debugger
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Waiting for debugger...&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|readl
c_func
(paren
op_amp
id|ppc7d_wait_debugger
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Hook up i8259 interrupt which is connected to GPP28 */
id|request_irq
c_func
(paren
id|mv64360_irq_base
op_plus
id|MV64x60_IRQ_GPP28
comma
id|ppc7d_i8259_intr
comma
id|SA_INTERRUPT
comma
l_string|&quot;I8259 (GPP28) interrupt&quot;
comma
(paren
r_void
op_star
)paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Configure MPP16 as watchdog NMI, MPP17 as watchdog WDE */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mv64x60_lock
comma
id|flags
)paren
suffix:semicolon
id|data
op_assign
id|mv64x60_read
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_MPP_CNTL_2
)paren
suffix:semicolon
id|data
op_and_assign
op_complement
(paren
l_int|0x0000000f
op_lshift
l_int|0
)paren
suffix:semicolon
id|data
op_or_assign
(paren
l_int|0x00000004
op_lshift
l_int|0
)paren
suffix:semicolon
id|data
op_and_assign
op_complement
(paren
l_int|0x0000000f
op_lshift
l_int|4
)paren
suffix:semicolon
id|data
op_or_assign
(paren
l_int|0x00000004
op_lshift
l_int|4
)paren
suffix:semicolon
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_MPP_CNTL_2
comma
id|data
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mv64x60_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* All LEDs off */
id|data8
op_assign
id|inb
c_func
(paren
id|PPC7D_CPLD_LEDS
)paren
suffix:semicolon
id|data8
op_and_assign
op_complement
l_int|0x08
suffix:semicolon
id|data8
op_or_assign
l_int|0x07
suffix:semicolon
id|outb
c_func
(paren
id|data8
comma
id|PPC7D_CPLD_LEDS
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: exit&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
multiline_comment|/* Called from machine_init(), early, before any of the __init functions&n; * have run. We must init software-configurable pins before other functions&n; * such as interrupt controllers are initialised.&n; */
DECL|function|platform_init
r_void
id|__init
id|platform_init
c_func
(paren
r_int
r_int
id|r3
comma
r_int
r_int
id|r4
comma
r_int
r_int
id|r5
comma
r_int
r_int
id|r6
comma
r_int
r_int
id|r7
)paren
(brace
id|u8
id|val8
suffix:semicolon
id|u8
id|rev_num
suffix:semicolon
multiline_comment|/* Map 0xe0000000-0xffffffff early because we need access to SRAM&n;&t; * and the ISA memory space (for serial port) here. This mapping&n;&t; * is redone properly in ppc7d_map_io() later.&n;&t; */
id|mtspr
c_func
(paren
id|SPRN_DBAT3U
comma
l_int|0xe0003fff
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|SPRN_DBAT3L
comma
l_int|0xe000002a
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Zero SRAM. Note that this generates parity errors on&n;&t; * internal data path in SRAM if it&squot;s first time accessing it&n;&t; * after reset.&n;&t; *&n;&t; * We do this ASAP to avoid parity errors when reading&n;&t; * uninitialized SRAM.&n;&t; */
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|PPC7D_INTERNAL_SRAM_BASE
comma
l_int|0
comma
id|MV64360_SRAM_SIZE
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;platform_init: r3-r7: %lx %lx %lx %lx %lx&bslash;n&quot;
comma
id|r3
comma
id|r4
comma
id|r5
comma
id|r6
comma
id|r7
)paren
suffix:semicolon
id|parse_bootinfo
c_func
(paren
id|find_bootinfo
c_func
(paren
)paren
)paren
suffix:semicolon
multiline_comment|/* ASSUMPTION:  If both r3 (bd_t pointer) and r6 (cmdline pointer)&n;&t; * are non-zero, then we should use the board info from the bd_t&n;&t; * structure and the cmdline pointed to by r6 instead of the&n;&t; * information from birecs, if any.  Otherwise, use the information&n;&t; * from birecs as discovered by the preceeding call to&n;&t; * parse_bootinfo().  This rule should work with both PPCBoot, which&n;&t; * uses a bd_t board info structure, and the kernel boot wrapper,&n;&t; * which uses birecs.&n;&t; */
r_if
c_cond
(paren
id|r3
op_logical_and
id|r6
)paren
(brace
id|bd_t
op_star
id|bp
op_assign
(paren
id|bd_t
op_star
)paren
id|__res
suffix:semicolon
multiline_comment|/* copy board info structure */
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|__res
comma
(paren
r_void
op_star
)paren
(paren
id|r3
op_plus
id|KERNELBASE
)paren
comma
r_sizeof
(paren
id|bd_t
)paren
)paren
suffix:semicolon
multiline_comment|/* copy command line */
op_star
(paren
r_char
op_star
)paren
(paren
id|r7
op_plus
id|KERNELBASE
)paren
op_assign
l_int|0
suffix:semicolon
id|strcpy
c_func
(paren
id|cmd_line
comma
(paren
r_char
op_star
)paren
(paren
id|r6
op_plus
id|KERNELBASE
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Board info data:-&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  Internal freq: %lu MHz, bus freq: %lu MHz&bslash;n&quot;
comma
id|bp-&gt;bi_intfreq
comma
id|bp-&gt;bi_busfreq
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  Memory: %lx, size %lx&bslash;n&quot;
comma
id|bp-&gt;bi_memstart
comma
id|bp-&gt;bi_memsize
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  Console baudrate: %lu&bslash;n&quot;
comma
id|bp-&gt;bi_baudrate
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  Ethernet address: &quot;
l_string|&quot;%02x:%02x:%02x:%02x:%02x:%02x&bslash;n&quot;
comma
id|bp-&gt;bi_enetaddr
(braket
l_int|0
)braket
comma
id|bp-&gt;bi_enetaddr
(braket
l_int|1
)braket
comma
id|bp-&gt;bi_enetaddr
(braket
l_int|2
)braket
comma
id|bp-&gt;bi_enetaddr
(braket
l_int|3
)braket
comma
id|bp-&gt;bi_enetaddr
(braket
l_int|4
)braket
comma
id|bp-&gt;bi_enetaddr
(braket
l_int|5
)braket
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_BLK_DEV_INITRD
multiline_comment|/* take care of initrd if we have one */
r_if
c_cond
(paren
id|r4
)paren
(brace
id|initrd_start
op_assign
id|r4
op_plus
id|KERNELBASE
suffix:semicolon
id|initrd_end
op_assign
id|r5
op_plus
id|KERNELBASE
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;INITRD @ %lx/%lx&bslash;n&quot;
comma
id|initrd_start
comma
id|initrd_end
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_BLK_DEV_INITRD */
multiline_comment|/* Map in board regs, etc. */
id|isa_io_base
op_assign
l_int|0xe8000000
suffix:semicolon
id|isa_mem_base
op_assign
l_int|0xe8000000
suffix:semicolon
id|pci_dram_offset
op_assign
l_int|0x00000000
suffix:semicolon
id|ISA_DMA_THRESHOLD
op_assign
l_int|0x00ffffff
suffix:semicolon
id|DMA_MODE_READ
op_assign
l_int|0x44
suffix:semicolon
id|DMA_MODE_WRITE
op_assign
l_int|0x48
suffix:semicolon
id|ppc_md.setup_arch
op_assign
id|ppc7d_setup_arch
suffix:semicolon
id|ppc_md.init
op_assign
id|ppc7d_init2
suffix:semicolon
id|ppc_md.show_cpuinfo
op_assign
id|ppc7d_show_cpuinfo
suffix:semicolon
id|ppc_md.irq_canonicalize
op_assign
id|ppc7d_irq_canonicalize
suffix:semicolon
id|ppc_md.init_IRQ
op_assign
id|ppc7d_init_irq
suffix:semicolon
id|ppc_md.get_irq
op_assign
id|ppc7d_get_irq
suffix:semicolon
id|ppc_md.restart
op_assign
id|ppc7d_restart
suffix:semicolon
id|ppc_md.power_off
op_assign
id|ppc7d_power_off
suffix:semicolon
id|ppc_md.halt
op_assign
id|ppc7d_halt
suffix:semicolon
id|ppc_md.find_end_of_memory
op_assign
id|ppc7d_find_end_of_memory
suffix:semicolon
id|ppc_md.setup_io_mappings
op_assign
id|ppc7d_map_io
suffix:semicolon
id|ppc_md.time_init
op_assign
l_int|NULL
suffix:semicolon
id|ppc_md.set_rtc_time
op_assign
l_int|NULL
suffix:semicolon
id|ppc_md.get_rtc_time
op_assign
l_int|NULL
suffix:semicolon
id|ppc_md.calibrate_decr
op_assign
id|ppc7d_calibrate_decr
suffix:semicolon
id|ppc_md.nvram_read_val
op_assign
l_int|NULL
suffix:semicolon
id|ppc_md.nvram_write_val
op_assign
l_int|NULL
suffix:semicolon
id|ppc_md.heartbeat
op_assign
id|ppc7d_heartbeat
suffix:semicolon
id|ppc_md.heartbeat_reset
op_assign
id|HZ
suffix:semicolon
id|ppc_md.heartbeat_count
op_assign
id|ppc_md.heartbeat_reset
suffix:semicolon
id|ppc_md.pcibios_fixup_bus
op_assign
id|ppc7d_pci_fixup_bus
suffix:semicolon
macro_line|#if defined(CONFIG_SERIAL_MPSC) || defined(CONFIG_MV643XX_ETH) || &bslash;&n;    defined(CONFIG_I2C_MV64XXX)
id|platform_notify
op_assign
id|ppc7d_platform_notify
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_SERIAL_MPSC
multiline_comment|/* On PPC7D, we must configure MPSC support via CPLD control&n;&t; * registers.&n;&t; */
id|outb
c_func
(paren
id|PPC7D_CPLD_RTS_COM4_SCLK
op_or
id|PPC7D_CPLD_RTS_COM56_ENABLED
comma
id|PPC7D_CPLD_RTS
)paren
suffix:semicolon
id|outb
c_func
(paren
id|PPC7D_CPLD_COMS_COM3_TCLKEN
op_or
id|PPC7D_CPLD_COMS_COM3_TXEN
op_or
id|PPC7D_CPLD_COMS_COM4_TCLKEN
op_or
id|PPC7D_CPLD_COMS_COM4_TXEN
comma
id|PPC7D_CPLD_COMS
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_SERIAL_MPSC */
macro_line|#if defined(CONFIG_KGDB) || defined(CONFIG_SERIAL_TEXT_DEBUG)
id|ppc7d_early_serial_map
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef  CONFIG_SERIAL_TEXT_DEBUG
macro_line|#if defined(CONFIG_SERIAL_MPSC_CONSOLE)
id|ppc_md.progress
op_assign
id|mv64x60_mpsc_progress
suffix:semicolon
macro_line|#elif defined(CONFIG_SERIAL_8250)
id|ppc_md.progress
op_assign
id|gen550_progress
suffix:semicolon
macro_line|#else
macro_line|#error CONFIG_KGDB || CONFIG_SERIAL_TEXT_DEBUG has no supported CONFIG_SERIAL_XXX
macro_line|#endif /* CONFIG_SERIAL_8250 */
macro_line|#endif /* CONFIG_SERIAL_TEXT_DEBUG */
macro_line|#endif /* CONFIG_KGDB || CONFIG_SERIAL_TEXT_DEBUG */
multiline_comment|/* Enable write access to user flash.  This is necessary for&n;&t; * flash probe.&n;&t; */
id|val8
op_assign
id|readb
c_func
(paren
(paren
r_void
op_star
)paren
id|isa_io_base
op_plus
id|PPC7D_CPLD_SW_FLASH_WRITE_PROTECT
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|val8
op_or
(paren
id|PPC7D_CPLD_SW_FLASH_WRPROT_ENABLED
op_amp
id|PPC7D_CPLD_SW_FLASH_WRPROT_USER_MASK
)paren
comma
(paren
r_void
op_star
)paren
id|isa_io_base
op_plus
id|PPC7D_CPLD_SW_FLASH_WRITE_PROTECT
)paren
suffix:semicolon
multiline_comment|/* Determine if this board has IBM ALMA VME devices */
id|val8
op_assign
id|readb
c_func
(paren
(paren
r_void
op_star
)paren
id|isa_io_base
op_plus
id|PPC7D_CPLD_BOARD_REVISION
)paren
suffix:semicolon
id|rev_num
op_assign
(paren
id|val8
op_amp
id|PPC7D_CPLD_BOARD_REVISION_NUMBER_MASK
)paren
op_rshift
l_int|5
suffix:semicolon
r_if
c_cond
(paren
id|rev_num
op_le
l_int|1
)paren
id|ppc7d_has_alma
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef DEBUG
id|console_printk
(braket
l_int|0
)braket
op_assign
l_int|8
suffix:semicolon
macro_line|#endif
)brace
eof
