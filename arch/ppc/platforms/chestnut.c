multiline_comment|/*&n; * arch/ppc/platforms/chestnut.c&n; *&n; * Board setup routines for IBM Chestnut&n; *&n; * Author: &lt;source@mvista.com&gt;&n; *&n; * &lt;2004&gt; (c) MontaVista Software, Inc. This file is licensed under&n; * the terms of the GNU General Public License version 2. This program&n; * is licensed &quot;as is&quot; without any warranty of any kind, whether express&n; * or implied.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/reboot.h&gt;
macro_line|#include &lt;linux/kdev_t.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/root_dev.h&gt;
macro_line|#include &lt;linux/initrd.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/seq_file.h&gt;
macro_line|#include &lt;linux/ide.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/serial_core.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/time.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;asm/hw_irq.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/kgdb.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#include &lt;asm/mv64x60.h&gt;
macro_line|#include &lt;platforms/chestnut.h&gt;
DECL|variable|boot_base
r_static
id|u32
id|boot_base
suffix:semicolon
multiline_comment|/* Virtual addr of 8bit boot */
DECL|variable|cpld_base
r_static
id|u32
id|cpld_base
suffix:semicolon
multiline_comment|/* Virtual addr of CPLD Regs */
DECL|variable|bh
r_static
id|mv64x60_handle_t
id|bh
suffix:semicolon
r_extern
r_void
id|gen550_progress
c_func
(paren
r_char
op_star
comma
r_int
r_int
)paren
suffix:semicolon
r_extern
r_void
id|gen550_init
c_func
(paren
r_int
comma
r_struct
id|uart_port
op_star
)paren
suffix:semicolon
r_extern
r_void
id|mv64360_pcibios_fixup
c_func
(paren
id|mv64x60_handle_t
op_star
id|bh
)paren
suffix:semicolon
DECL|macro|BIT
mdefine_line|#define BIT(x) (1&lt;&lt;x)
DECL|macro|CHESTNUT_PRESERVE_MASK
mdefine_line|#define CHESTNUT_PRESERVE_MASK (BIT(MV64x60_CPU2DEV_0_WIN) | &bslash;&n;&t;&t;&t;&t;BIT(MV64x60_CPU2DEV_1_WIN) | &bslash;&n;&t;&t;&t;&t;BIT(MV64x60_CPU2DEV_2_WIN) | &bslash;&n;&t;&t;&t;&t;BIT(MV64x60_CPU2DEV_3_WIN) | &bslash;&n;&t;&t;&t;&t;BIT(MV64x60_CPU2BOOT_WIN))
multiline_comment|/**************************************************************************&n; * FUNCTION: chestnut_calibrate_decr&n; *&n; * DESCRIPTION: initialize decrementer interrupt frequency (used as system&n; *              timer)&n; *&n; ****/
r_static
r_void
id|__init
DECL|function|chestnut_calibrate_decr
(def_block
id|chestnut_calibrate_decr
c_func
(paren
r_void
)paren
(brace
id|ulong
id|freq
suffix:semicolon
id|freq
op_assign
id|CHESTNUT_BUS_SPEED
op_div
l_int|4
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;time_init: decrementer frequency = %lu.%.6lu MHz&bslash;n&quot;
comma
id|freq
op_div
l_int|1000000
comma
id|freq
op_mod
l_int|1000000
)paren
suffix:semicolon
id|tb_ticks_per_jiffy
op_assign
id|freq
op_div
id|HZ
suffix:semicolon
id|tb_to_us
op_assign
id|mulhwu_scale_factor
c_func
(paren
id|freq
comma
l_int|1000000
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)def_block
r_static
r_int
DECL|function|chestnut_show_cpuinfo
id|chestnut_show_cpuinfo
c_func
(paren
r_struct
id|seq_file
op_star
id|m
)paren
(brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;vendor&bslash;t&bslash;t: IBM&bslash;n&quot;
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;machine&bslash;t&bslash;t: 750FX/GX Eval Board (Chestnut/Buckeye)&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; * FUNCTION: chestnut_find_end_of_memory&n; *&n; * DESCRIPTION: ppc_md memory size callback&n; *&n; ****/
r_int
r_int
id|__init
DECL|function|chestnut_find_end_of_memory
id|chestnut_find_end_of_memory
c_func
(paren
r_void
)paren
(brace
r_static
r_int
id|mem_size
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mem_size
op_eq
l_int|0
)paren
(brace
id|mem_size
op_assign
id|mv64x60_get_mem_size
c_func
(paren
id|CONFIG_MV64X60_NEW_BASE
comma
id|MV64x60_TYPE_MV64460
)paren
suffix:semicolon
)brace
r_return
id|mem_size
suffix:semicolon
)brace
macro_line|#if defined(CONFIG_SERIAL_8250)
r_static
r_void
id|__init
DECL|function|chestnut_early_serial_map
id|chestnut_early_serial_map
c_func
(paren
r_void
)paren
(brace
r_struct
id|uart_port
id|port
suffix:semicolon
multiline_comment|/* Setup serial port access */
id|memset
c_func
(paren
op_amp
id|port
comma
l_int|0
comma
r_sizeof
(paren
id|port
)paren
)paren
suffix:semicolon
id|port.uartclk
op_assign
id|BASE_BAUD
op_star
l_int|16
suffix:semicolon
id|port.irq
op_assign
id|UART0_INT
suffix:semicolon
id|port.flags
op_assign
id|STD_COM_FLAGS
op_or
id|UPF_IOREMAP
suffix:semicolon
id|port.iotype
op_assign
id|SERIAL_IO_MEM
suffix:semicolon
id|port.mapbase
op_assign
id|CHESTNUT_UART0_IO_BASE
suffix:semicolon
id|port.regshift
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|early_serial_setup
c_func
(paren
op_amp
id|port
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;Early serial init of port 0 failed&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Assume early_serial_setup() doesn&squot;t modify serial_req */
id|port.line
op_assign
l_int|1
suffix:semicolon
id|port.irq
op_assign
id|UART1_INT
suffix:semicolon
id|port.mapbase
op_assign
id|CHESTNUT_UART1_IO_BASE
suffix:semicolon
r_if
c_cond
(paren
id|early_serial_setup
c_func
(paren
op_amp
id|port
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;Early serial init of port 1 failed&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/**************************************************************************&n; * FUNCTION: chestnut_map_irq&n; *&n; * DESCRIPTION: 0 return since PCI IRQs not needed&n; *&n; ****/
r_static
r_int
id|__init
DECL|function|chestnut_map_irq
id|chestnut_map_irq
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
r_char
id|idsel
comma
r_int
r_char
id|pin
)paren
(brace
r_static
r_char
id|pci_irq_table
(braket
)braket
(braket
l_int|4
)braket
op_assign
(brace
(brace
id|CHESTNUT_PCI_SLOT0_IRQ
comma
id|CHESTNUT_PCI_SLOT0_IRQ
comma
id|CHESTNUT_PCI_SLOT0_IRQ
comma
id|CHESTNUT_PCI_SLOT0_IRQ
)brace
comma
(brace
id|CHESTNUT_PCI_SLOT1_IRQ
comma
id|CHESTNUT_PCI_SLOT1_IRQ
comma
id|CHESTNUT_PCI_SLOT1_IRQ
comma
id|CHESTNUT_PCI_SLOT1_IRQ
)brace
comma
(brace
id|CHESTNUT_PCI_SLOT2_IRQ
comma
id|CHESTNUT_PCI_SLOT2_IRQ
comma
id|CHESTNUT_PCI_SLOT2_IRQ
comma
id|CHESTNUT_PCI_SLOT2_IRQ
)brace
comma
(brace
id|CHESTNUT_PCI_SLOT3_IRQ
comma
id|CHESTNUT_PCI_SLOT3_IRQ
comma
id|CHESTNUT_PCI_SLOT3_IRQ
comma
id|CHESTNUT_PCI_SLOT3_IRQ
)brace
comma
)brace
suffix:semicolon
r_const
r_int
id|min_idsel
op_assign
l_int|1
comma
id|max_idsel
op_assign
l_int|4
comma
id|irqs_per_slot
op_assign
l_int|4
suffix:semicolon
r_return
(paren
id|PCI_IRQ_TABLE_LOOKUP
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; * FUNCTION: chestnut_setup_bridge&n; *&n; * DESCRIPTION: initalize board-specific settings on the MV64360&n; *&n; ****/
r_static
r_void
id|__init
DECL|function|chestnut_setup_bridge
id|chestnut_setup_bridge
c_func
(paren
r_void
)paren
(brace
r_struct
id|mv64x60_setup_info
id|si
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|ppc_md.progress
)paren
id|ppc_md
dot
id|progress
c_func
(paren
l_string|&quot;chestnut_setup_bridge: enter&quot;
comma
l_int|0
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|si
comma
l_int|0
comma
r_sizeof
(paren
id|si
)paren
)paren
suffix:semicolon
id|si.phys_reg_base
op_assign
id|CONFIG_MV64X60_NEW_BASE
suffix:semicolon
multiline_comment|/* setup only PCI bus 0 (bus 1 not used) */
id|si.pci_0.enable_bus
op_assign
l_int|1
suffix:semicolon
id|si.pci_0.pci_io.cpu_base
op_assign
id|CHESTNUT_PCI0_IO_PROC_ADDR
suffix:semicolon
id|si.pci_0.pci_io.pci_base_hi
op_assign
l_int|0
suffix:semicolon
id|si.pci_0.pci_io.pci_base_lo
op_assign
id|CHESTNUT_PCI0_IO_PCI_ADDR
suffix:semicolon
id|si.pci_0.pci_io.size
op_assign
id|CHESTNUT_PCI0_IO_SIZE
suffix:semicolon
id|si.pci_0.pci_io.swap
op_assign
id|MV64x60_CPU2PCI_SWAP_NONE
suffix:semicolon
multiline_comment|/* no swapping */
id|si.pci_0.pci_mem
(braket
l_int|0
)braket
dot
id|cpu_base
op_assign
id|CHESTNUT_PCI0_MEM_PROC_ADDR
suffix:semicolon
id|si.pci_0.pci_mem
(braket
l_int|0
)braket
dot
id|pci_base_hi
op_assign
id|CHESTNUT_PCI0_MEM_PCI_HI_ADDR
suffix:semicolon
id|si.pci_0.pci_mem
(braket
l_int|0
)braket
dot
id|pci_base_lo
op_assign
id|CHESTNUT_PCI0_MEM_PCI_LO_ADDR
suffix:semicolon
id|si.pci_0.pci_mem
(braket
l_int|0
)braket
dot
id|size
op_assign
id|CHESTNUT_PCI0_MEM_SIZE
suffix:semicolon
id|si.pci_0.pci_mem
(braket
l_int|0
)braket
dot
id|swap
op_assign
id|MV64x60_CPU2PCI_SWAP_NONE
suffix:semicolon
multiline_comment|/* no swapping */
id|si.pci_0.pci_cmd_bits
op_assign
l_int|0
suffix:semicolon
id|si.pci_0.latency_timer
op_assign
l_int|0x80
suffix:semicolon
id|si.window_preserve_mask_32_lo
op_assign
id|CHESTNUT_PRESERVE_MASK
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MV64x60_CPU2MEM_WINDOWS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|si.cpu_prot_options
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_NOT_CACHE_COHERENT
id|si.cpu_snoop_options
(braket
id|i
)braket
op_assign
id|MV64360_CPU_SNOOP_NONE
suffix:semicolon
macro_line|#else
id|si.cpu_snoop_options
(braket
id|i
)braket
op_assign
id|MV64360_CPU_SNOOP_WB
suffix:semicolon
multiline_comment|/* risky */
macro_line|#endif
id|si.pci_0.acc_cntl_options
(braket
id|i
)braket
op_assign
macro_line|#ifdef CONFIG_NOT_CACHE_COHERENT
id|MV64360_PCI_ACC_CNTL_SNOOP_NONE
op_or
macro_line|#else
id|MV64360_PCI_ACC_CNTL_SNOOP_WB
op_or
multiline_comment|/* risky */
macro_line|#endif
id|MV64360_PCI_ACC_CNTL_SWAP_NONE
op_or
id|MV64360_PCI_ACC_CNTL_MBURST_32_BYTES
op_or
id|MV64360_PCI_ACC_CNTL_RDSIZE_32_BYTES
suffix:semicolon
)brace
multiline_comment|/* Lookup host bridge - on CPU 0 - no SMP support */
r_if
c_cond
(paren
id|mv64x60_init
c_func
(paren
op_amp
id|bh
comma
op_amp
id|si
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&bslash;nPCI Bridge initialization failed!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|pci_dram_offset
op_assign
l_int|0
suffix:semicolon
id|ppc_md.pci_swizzle
op_assign
id|common_swizzle
suffix:semicolon
id|ppc_md.pci_map_irq
op_assign
id|chestnut_map_irq
suffix:semicolon
id|ppc_md.pci_exclude_device
op_assign
id|mv64x60_pci_exclude_device
suffix:semicolon
id|mv64x60_set_bus
c_func
(paren
op_amp
id|bh
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|bh.hose_a-&gt;first_busno
op_assign
l_int|0
suffix:semicolon
id|bh.hose_a-&gt;last_busno
op_assign
l_int|0xff
suffix:semicolon
id|bh.hose_a-&gt;last_busno
op_assign
id|pciauto_bus_scan
c_func
(paren
id|bh.hose_a
comma
l_int|0
)paren
suffix:semicolon
)brace
r_void
id|__init
DECL|function|chestnut_setup_peripherals
id|chestnut_setup_peripherals
c_func
(paren
r_void
)paren
(brace
id|mv64x60_set_32bit_window
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU2BOOT_WIN
comma
id|CHESTNUT_BOOT_8BIT_BASE
comma
id|CHESTNUT_BOOT_8BIT_SIZE
comma
l_int|0
)paren
suffix:semicolon
id|mv64x60_set_32bit_window
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU2DEV_0_WIN
comma
id|CHESTNUT_32BIT_BASE
comma
id|CHESTNUT_32BIT_SIZE
comma
l_int|0
)paren
suffix:semicolon
id|mv64x60_set_32bit_window
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU2DEV_1_WIN
comma
id|CHESTNUT_CPLD_BASE
comma
id|CHESTNUT_CPLD_SIZE
comma
l_int|0
)paren
suffix:semicolon
id|mv64x60_set_32bit_window
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU2DEV_2_WIN
comma
id|CHESTNUT_UART_BASE
comma
id|CHESTNUT_UART_SIZE
comma
l_int|0
)paren
suffix:semicolon
id|mv64x60_set_32bit_window
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU2DEV_3_WIN
comma
id|CHESTNUT_FRAM_BASE
comma
id|CHESTNUT_FRAM_SIZE
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set up window for internal sram (256KByte insize) */
id|mv64x60_set_32bit_window
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_CPU2SRAM_WIN
comma
id|CHESTNUT_INTERNAL_SRAM_BASE
comma
id|CHESTNUT_INTERNAL_SRAM_SIZE
comma
l_int|0
)paren
suffix:semicolon
id|boot_base
op_assign
(paren
id|u32
)paren
id|ioremap
c_func
(paren
id|CHESTNUT_BOOT_8BIT_BASE
comma
id|CHESTNUT_BOOT_8BIT_SIZE
)paren
suffix:semicolon
id|cpld_base
op_assign
(paren
id|u32
)paren
id|ioremap
c_func
(paren
id|CHESTNUT_CPLD_BASE
comma
id|CHESTNUT_CPLD_SIZE
)paren
suffix:semicolon
multiline_comment|/*&n;    &t; * Configure internal SRAM -&n;    &t; * Cache coherent write back, incase&n;&t; *      CONFIG_MV64360_SRAM_CACHE_COHERENT set&n;    &t; * Parity enabled.&n;    &t; * Parity error propagation&n;    &t; * Arbitration not parked for CPU only&n;    &t; * Other bits are reserved.&n;    &t; */
macro_line|#ifdef CONFIG_MV64360_SRAM_CACHE_COHERENT
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64360_SRAM_CONFIG
comma
l_int|0x001600b2
)paren
suffix:semicolon
macro_line|#else
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64360_SRAM_CONFIG
comma
l_int|0x001600b0
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;    &t; * Setting the SRAM to 0. Note that this generates parity errors on&n;&t; * internal data path in SRAM since it&squot;s first time accessing it&n;&t; * while after reset it&squot;s not configured&n;    &t;*/
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|CHESTNUT_INTERNAL_SRAM_BASE
comma
l_int|0
comma
id|CHESTNUT_INTERNAL_SRAM_SIZE
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Configure MPP pins for PCI DMA&n;&t; *&n;&t; * PCI Slot&t;GNT pin&t;&t;REQ pin&n;&t; *&t;0&t;MPP16&t;&t;MPP17&n;&t; *&t;1&t;MPP18&t;&t;MPP19&n;&t; *&t;2&t;MPP20&t;&t;MPP21&n;&t; *&t;3&t;MPP22&t;&t;MPP23&n;&t; */
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_MPP_CNTL_2
comma
(paren
l_int|0x1
op_lshift
l_int|0
)paren
op_or
multiline_comment|/* MPPSel16 PCI0_GNT[0] */
(paren
l_int|0x1
op_lshift
l_int|4
)paren
op_or
multiline_comment|/* MPPSel17 PCI0_REQ[0] */
(paren
l_int|0x1
op_lshift
l_int|8
)paren
op_or
multiline_comment|/* MPPSel18 PCI0_GNT[1] */
(paren
l_int|0x1
op_lshift
l_int|12
)paren
op_or
multiline_comment|/* MPPSel19 PCI0_REQ[1] */
(paren
l_int|0x1
op_lshift
l_int|16
)paren
op_or
multiline_comment|/* MPPSel20 PCI0_GNT[2] */
(paren
l_int|0x1
op_lshift
l_int|20
)paren
op_or
multiline_comment|/* MPPSel21 PCI0_REQ[2] */
(paren
l_int|0x1
op_lshift
l_int|24
)paren
op_or
multiline_comment|/* MPPSel22 PCI0_GNT[3] */
(paren
l_int|0x1
op_lshift
l_int|28
)paren
)paren
suffix:semicolon
multiline_comment|/* MPPSel23 PCI0_REQ[3] */
multiline_comment|/*&n;&t; * Set unused MPP pins for output, as per schematic note&n;&t; *&n;&t; * Unused Pins: MPP01, MPP02, MPP04, MPP05, MPP06&n;&t; *&t;&t;MPP09, MPP10, MPP13, MPP14, MPP15&n;&t; */
id|mv64x60_clr_bits
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_MPP_CNTL_0
comma
(paren
l_int|0xf
op_lshift
l_int|4
)paren
op_or
multiline_comment|/* MPPSel01 GPIO[1] */
(paren
l_int|0xf
op_lshift
l_int|8
)paren
op_or
multiline_comment|/* MPPSel02 GPIO[2] */
(paren
l_int|0xf
op_lshift
l_int|16
)paren
op_or
multiline_comment|/* MPPSel04 GPIO[4] */
(paren
l_int|0xf
op_lshift
l_int|20
)paren
op_or
multiline_comment|/* MPPSel05 GPIO[5] */
(paren
l_int|0xf
op_lshift
l_int|24
)paren
)paren
suffix:semicolon
multiline_comment|/* MPPSel06 GPIO[6] */
id|mv64x60_clr_bits
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_MPP_CNTL_1
comma
(paren
l_int|0xf
op_lshift
l_int|4
)paren
op_or
multiline_comment|/* MPPSel09 GPIO[9] */
(paren
l_int|0xf
op_lshift
l_int|8
)paren
op_or
multiline_comment|/* MPPSel10 GPIO[10] */
(paren
l_int|0xf
op_lshift
l_int|20
)paren
op_or
multiline_comment|/* MPPSel13 GPIO[13] */
(paren
l_int|0xf
op_lshift
l_int|24
)paren
op_or
multiline_comment|/* MPPSel14 GPIO[14] */
(paren
l_int|0xf
op_lshift
l_int|28
)paren
)paren
suffix:semicolon
multiline_comment|/* MPPSel15 GPIO[15] */
id|mv64x60_set_bits
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_GPP_IO_CNTL
comma
id|BIT
c_func
(paren
l_int|1
)paren
op_or
id|BIT
c_func
(paren
l_int|2
)paren
op_or
id|BIT
c_func
(paren
l_int|4
)paren
op_or
id|BIT
c_func
(paren
l_int|5
)paren
op_or
id|BIT
c_func
(paren
l_int|6
)paren
op_or
id|BIT
c_func
(paren
l_int|9
)paren
op_or
id|BIT
c_func
(paren
l_int|10
)paren
op_or
id|BIT
c_func
(paren
l_int|13
)paren
op_or
id|BIT
c_func
(paren
l_int|14
)paren
op_or
id|BIT
c_func
(paren
l_int|15
)paren
)paren
suffix:semicolon
multiline_comment|/* Output */
multiline_comment|/*&n;    &t; * Configure the following MPP pins to indicate a level&n;    &t; * triggered interrupt&n;    &t; *&n;       &t; * MPP24 - Board Reset (just map the MPP &amp; GPP for chestnut_reset)&n;       &t; * MPP25 - UART A  (high)&n;       &t; * MPP26 - UART B  (high)&n;&t; * MPP28 - PCI Slot 3 (low)&n;&t; * MPP29 - PCI Slot 2 (low)&n;&t; * MPP30 - PCI Slot 1 (low)&n;&t; * MPP31 - PCI Slot 0 (low)&n;    &t; */
id|mv64x60_clr_bits
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_MPP_CNTL_3
comma
id|BIT
c_func
(paren
l_int|3
)paren
op_or
id|BIT
c_func
(paren
l_int|2
)paren
op_or
id|BIT
c_func
(paren
l_int|1
)paren
op_or
id|BIT
c_func
(paren
l_int|0
)paren
op_or
multiline_comment|/* MPP 24 */
id|BIT
c_func
(paren
l_int|7
)paren
op_or
id|BIT
c_func
(paren
l_int|6
)paren
op_or
id|BIT
c_func
(paren
l_int|5
)paren
op_or
id|BIT
c_func
(paren
l_int|4
)paren
op_or
multiline_comment|/* MPP 25 */
id|BIT
c_func
(paren
l_int|11
)paren
op_or
id|BIT
c_func
(paren
l_int|10
)paren
op_or
id|BIT
c_func
(paren
l_int|9
)paren
op_or
id|BIT
c_func
(paren
l_int|8
)paren
op_or
multiline_comment|/* MPP 26 */
id|BIT
c_func
(paren
l_int|19
)paren
op_or
id|BIT
c_func
(paren
l_int|18
)paren
op_or
id|BIT
c_func
(paren
l_int|17
)paren
op_or
id|BIT
c_func
(paren
l_int|16
)paren
op_or
multiline_comment|/* MPP 28 */
id|BIT
c_func
(paren
l_int|23
)paren
op_or
id|BIT
c_func
(paren
l_int|22
)paren
op_or
id|BIT
c_func
(paren
l_int|21
)paren
op_or
id|BIT
c_func
(paren
l_int|20
)paren
op_or
multiline_comment|/* MPP 29 */
id|BIT
c_func
(paren
l_int|27
)paren
op_or
id|BIT
c_func
(paren
l_int|26
)paren
op_or
id|BIT
c_func
(paren
l_int|25
)paren
op_or
id|BIT
c_func
(paren
l_int|24
)paren
op_or
multiline_comment|/* MPP 30 */
id|BIT
c_func
(paren
l_int|31
)paren
op_or
id|BIT
c_func
(paren
l_int|30
)paren
op_or
id|BIT
c_func
(paren
l_int|29
)paren
op_or
id|BIT
c_func
(paren
l_int|28
)paren
)paren
suffix:semicolon
multiline_comment|/* MPP 31 */
multiline_comment|/*&n;&t; * Define GPP 25 (high), 26 (high), 28 (low), 29 (low), 30 (low),&n;&t; * 31 (low) interrupt polarity input signal and level triggered&n;    &t; */
id|mv64x60_clr_bits
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_GPP_LEVEL_CNTL
comma
id|BIT
c_func
(paren
l_int|25
)paren
op_or
id|BIT
c_func
(paren
l_int|26
)paren
)paren
suffix:semicolon
id|mv64x60_set_bits
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_GPP_LEVEL_CNTL
comma
id|BIT
c_func
(paren
l_int|28
)paren
op_or
id|BIT
c_func
(paren
l_int|29
)paren
op_or
id|BIT
c_func
(paren
l_int|30
)paren
op_or
id|BIT
c_func
(paren
l_int|31
)paren
)paren
suffix:semicolon
id|mv64x60_clr_bits
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_GPP_IO_CNTL
comma
id|BIT
c_func
(paren
l_int|25
)paren
op_or
id|BIT
c_func
(paren
l_int|26
)paren
op_or
id|BIT
c_func
(paren
l_int|28
)paren
op_or
id|BIT
c_func
(paren
l_int|29
)paren
op_or
id|BIT
c_func
(paren
l_int|30
)paren
op_or
id|BIT
c_func
(paren
l_int|31
)paren
)paren
suffix:semicolon
multiline_comment|/* Config GPP interrupt controller to respond to level trigger */
id|mv64x60_set_bits
c_func
(paren
op_amp
id|bh
comma
id|MV64360_COMM_ARBITER_CNTL
comma
id|BIT
c_func
(paren
l_int|10
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;    &t; * Dismiss and then enable interrupt on GPP interrupt cause for CPU #0&n;    &t; */
id|mv64x60_write
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_GPP_INTR_CAUSE
comma
op_complement
(paren
id|BIT
c_func
(paren
l_int|25
)paren
op_or
id|BIT
c_func
(paren
l_int|26
)paren
op_or
id|BIT
c_func
(paren
l_int|28
)paren
op_or
id|BIT
c_func
(paren
l_int|29
)paren
op_or
id|BIT
c_func
(paren
l_int|30
)paren
op_or
id|BIT
c_func
(paren
l_int|31
)paren
)paren
)paren
suffix:semicolon
id|mv64x60_set_bits
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_GPP_INTR_MASK
comma
id|BIT
c_func
(paren
l_int|25
)paren
op_or
id|BIT
c_func
(paren
l_int|26
)paren
op_or
id|BIT
c_func
(paren
l_int|28
)paren
op_or
id|BIT
c_func
(paren
l_int|29
)paren
op_or
id|BIT
c_func
(paren
l_int|30
)paren
op_or
id|BIT
c_func
(paren
l_int|31
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;    &t; * Dismiss and then enable interrupt on CPU #0 high cause register&n;    &t; * BIT27 summarizes GPP interrupts 24-31&n;    &t;*/
id|mv64x60_set_bits
c_func
(paren
op_amp
id|bh
comma
id|MV64360_IC_CPU0_INTR_MASK_HI
comma
id|BIT
c_func
(paren
l_int|27
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppc_md.progress
)paren
id|ppc_md
dot
id|progress
c_func
(paren
l_string|&quot;chestnut_setup_bridge: exit&quot;
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; * FUNCTION: chestnut_setup_arch&n; *&n; * DESCRIPTION: ppc_md machine configuration callback&n; *&n; ****/
r_static
r_void
id|__init
DECL|function|chestnut_setup_arch
id|chestnut_setup_arch
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ppc_md.progress
)paren
id|ppc_md
dot
id|progress
c_func
(paren
l_string|&quot;chestnut_setup_arch: enter&quot;
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* init to some ~sane value until calibrate_delay() runs */
id|loops_per_jiffy
op_assign
l_int|50000000
op_div
id|HZ
suffix:semicolon
multiline_comment|/* if the time base value is greater than bus freq/4 (the TB and&n;    &t;* decrementer tick rate) + signed integer rollover value, we&n;    &t;* can spend a fair amount of time waiting for the rollover to&n;    &t;* happen.  To get around this, initialize the time base register&n;    &t;* to a &quot;safe&quot; value.&n;    &t;*/
id|set_tb
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_BLK_DEV_INITRD
r_if
c_cond
(paren
id|initrd_start
)paren
id|ROOT_DEV
op_assign
id|Root_RAM0
suffix:semicolon
r_else
macro_line|#endif
macro_line|#ifdef CONFIG_ROOT_NFS
id|ROOT_DEV
op_assign
id|Root_NFS
suffix:semicolon
macro_line|#else
id|ROOT_DEV
op_assign
id|Root_SDA2
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;    &t;* Set up the L2CR register.&n;    &t;*/
id|_set_L2CR
c_func
(paren
id|_get_L2CR
c_func
(paren
)paren
op_or
id|L2CR_L2E
)paren
suffix:semicolon
id|chestnut_setup_bridge
c_func
(paren
)paren
suffix:semicolon
id|chestnut_setup_peripherals
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_DUMMY_CONSOLE
id|conswitchp
op_assign
op_amp
id|dummy_con
suffix:semicolon
macro_line|#endif
macro_line|#if defined(CONFIG_SERIAL_8250)
id|chestnut_early_serial_map
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Identify the system */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;System Identification: IBM 750FX/GX Eval Board&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;IBM 750FX/GX port (C) 2004 MontaVista Software, Inc. (source@mvista.com)&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppc_md.progress
)paren
id|ppc_md
dot
id|progress
c_func
(paren
l_string|&quot;chestnut_setup_arch: exit&quot;
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; * FUNCTION: chestnut_restart&n; *&n; * DESCRIPTION: ppc_md machine reset callback&n; *              reset the board via the CPLD command register&n; *&n; ****/
r_static
r_void
DECL|function|chestnut_restart
id|chestnut_restart
c_func
(paren
r_char
op_star
id|cmd
)paren
(brace
r_volatile
id|ulong
id|i
op_assign
l_int|10000000
suffix:semicolon
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;         * Set CPLD Reg 3 bit 0 to 1 to allow MPP signals on reset to work&n;         *&n;         * MPP24 - board reset&n;         */
id|writeb
c_func
(paren
l_int|0x1
comma
(paren
r_void
id|__iomem
op_star
)paren
(paren
id|cpld_base
op_plus
l_int|3
)paren
)paren
suffix:semicolon
multiline_comment|/* GPP pin tied to MPP earlier */
id|mv64x60_set_bits
c_func
(paren
op_amp
id|bh
comma
id|MV64x60_GPP_VALUE_SET
comma
id|BIT
c_func
(paren
l_int|24
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|i
op_decrement
OG
l_int|0
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;restart failed&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|chestnut_halt
id|chestnut_halt
c_func
(paren
r_void
)paren
(brace
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* NOTREACHED */
)brace
r_static
r_void
DECL|function|chestnut_power_off
id|chestnut_power_off
c_func
(paren
r_void
)paren
(brace
id|chestnut_halt
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* NOTREACHED */
)brace
DECL|macro|SET_PCI_COMMAND_INVALIDATE
mdefine_line|#define SET_PCI_COMMAND_INVALIDATE
macro_line|#ifdef SET_PCI_COMMAND_INVALIDATE
multiline_comment|/*&n; * Dave Wilhardt found that PCI_COMMAND_INVALIDATE must&n; * be set for each device if you are using cache coherency.&n; */
r_static
r_void
id|__init
DECL|function|set_pci_command_invalidate
id|set_pci_command_invalidate
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
id|u16
id|val
suffix:semicolon
r_while
c_loop
(paren
(paren
id|dev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|dev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|pci_read_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
op_amp
id|val
)paren
suffix:semicolon
id|val
op_or_assign
id|PCI_COMMAND_INVALIDATE
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
id|val
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|PCI_CACHE_LINE_SIZE
comma
id|L1_CACHE_LINE_SIZE
op_rshift
l_int|2
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
r_static
r_void
id|__init
DECL|function|chestnut_pci_fixups
id|chestnut_pci_fixups
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef SET_PCI_COMMAND_INVALIDATE
id|set_pci_command_invalidate
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/**************************************************************************&n; * FUNCTION: chestnut_map_io&n; *&n; * DESCRIPTION: configure fixed memory-mapped IO&n; *&n; ****/
r_static
r_void
id|__init
DECL|function|chestnut_map_io
id|chestnut_map_io
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_MV64360_SRAM_CACHEABLE
id|io_block_mapping
c_func
(paren
id|CHESTNUT_INTERNAL_SRAM_BASE
comma
id|CHESTNUT_INTERNAL_SRAM_BASE
comma
id|CHESTNUT_INTERNAL_SRAM_SIZE
comma
id|_PAGE_KERNEL
op_or
id|_PAGE_GUARDED
)paren
suffix:semicolon
macro_line|#else
macro_line|#ifdef CONFIG_MV64360_SRAM_CACHE_COHERENT
id|io_block_mapping
c_func
(paren
id|CHESTNUT_INTERNAL_SRAM_BASE
comma
id|CHESTNUT_INTERNAL_SRAM_BASE
comma
id|CHESTNUT_INTERNAL_SRAM_SIZE
comma
id|_PAGE_KERNEL
op_or
id|_PAGE_GUARDED
op_or
id|_PAGE_COHERENT
)paren
suffix:semicolon
macro_line|#else
id|io_block_mapping
c_func
(paren
id|CHESTNUT_INTERNAL_SRAM_BASE
comma
id|CHESTNUT_INTERNAL_SRAM_BASE
comma
id|CHESTNUT_INTERNAL_SRAM_SIZE
comma
id|_PAGE_IO
)paren
suffix:semicolon
macro_line|#endif /* !CONFIG_MV64360_SRAM_CACHE_COHERENT */
macro_line|#endif /* !CONFIG_MV64360_SRAM_CACHEABLE */
macro_line|#if defined(CONFIG_SERIAL_TEXT_DEBUG) || defined(CONFIG_KGDB)
id|io_block_mapping
c_func
(paren
id|CHESTNUT_UART_BASE
comma
id|CHESTNUT_UART_BASE
comma
l_int|0x100000
comma
id|_PAGE_IO
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/**************************************************************************&n; * FUNCTION: chestnut_set_bat&n; *&n; * DESCRIPTION: configures a (temporary) bat mapping for early access to&n; *              device I/O&n; *&n; ****/
r_static
id|__inline__
r_void
DECL|function|chestnut_set_bat
id|chestnut_set_bat
c_func
(paren
r_void
)paren
(brace
id|mb
c_func
(paren
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|DBAT3U
comma
l_int|0xf0001ffe
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|DBAT3L
comma
l_int|0xf000002a
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; * FUNCTION: platform_init&n; *&n; * DESCRIPTION: main entry point for configuring board-specific machine&n; *              callbacks&n; *&n; ****/
r_void
id|__init
DECL|function|platform_init
id|platform_init
c_func
(paren
r_int
r_int
id|r3
comma
r_int
r_int
id|r4
comma
r_int
r_int
id|r5
comma
r_int
r_int
id|r6
comma
r_int
r_int
id|r7
)paren
(brace
id|parse_bootinfo
c_func
(paren
id|find_bootinfo
c_func
(paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Copy the kernel command line arguments to a safe place. */
r_if
c_cond
(paren
id|r6
)paren
(brace
op_star
(paren
r_char
op_star
)paren
(paren
id|r7
op_plus
id|KERNELBASE
)paren
op_assign
l_int|0
suffix:semicolon
id|strcpy
c_func
(paren
id|cmd_line
comma
(paren
r_char
op_star
)paren
(paren
id|r6
op_plus
id|KERNELBASE
)paren
)paren
suffix:semicolon
)brace
id|isa_mem_base
op_assign
l_int|0
suffix:semicolon
id|ppc_md.setup_arch
op_assign
id|chestnut_setup_arch
suffix:semicolon
id|ppc_md.show_cpuinfo
op_assign
id|chestnut_show_cpuinfo
suffix:semicolon
id|ppc_md.irq_canonicalize
op_assign
l_int|NULL
suffix:semicolon
id|ppc_md.init_IRQ
op_assign
id|mv64360_init_irq
suffix:semicolon
id|ppc_md.get_irq
op_assign
id|mv64360_get_irq
suffix:semicolon
id|ppc_md.init
op_assign
l_int|NULL
suffix:semicolon
id|ppc_md.find_end_of_memory
op_assign
id|chestnut_find_end_of_memory
suffix:semicolon
id|ppc_md.setup_io_mappings
op_assign
id|chestnut_map_io
suffix:semicolon
id|ppc_md.pcibios_fixup
op_assign
id|chestnut_pci_fixups
suffix:semicolon
id|ppc_md.restart
op_assign
id|chestnut_restart
suffix:semicolon
id|ppc_md.power_off
op_assign
id|chestnut_power_off
suffix:semicolon
id|ppc_md.halt
op_assign
id|chestnut_halt
suffix:semicolon
id|ppc_md.time_init
op_assign
l_int|NULL
suffix:semicolon
id|ppc_md.set_rtc_time
op_assign
l_int|NULL
suffix:semicolon
id|ppc_md.get_rtc_time
op_assign
l_int|NULL
suffix:semicolon
id|ppc_md.calibrate_decr
op_assign
id|chestnut_calibrate_decr
suffix:semicolon
id|ppc_md.nvram_read_val
op_assign
l_int|NULL
suffix:semicolon
id|ppc_md.nvram_write_val
op_assign
l_int|NULL
suffix:semicolon
id|ppc_md.heartbeat
op_assign
l_int|NULL
suffix:semicolon
id|ppc_md.pcibios_fixup
op_assign
id|chestnut_pci_fixups
suffix:semicolon
id|bh.p_base
op_assign
id|CONFIG_MV64X60_NEW_BASE
suffix:semicolon
id|chestnut_set_bat
c_func
(paren
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_SERIAL_TEXT_DEBUG)
id|ppc_md.progress
op_assign
id|gen550_progress
suffix:semicolon
macro_line|#endif
macro_line|#if defined(CONFIG_KGDB)
id|ppc_md.kgdb_map_scc
op_assign
id|gen550_kgdb_map_scc
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ppc_md.progress
)paren
id|ppc_md
dot
id|progress
c_func
(paren
l_string|&quot;chestnut_init(): exit&quot;
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
eof
