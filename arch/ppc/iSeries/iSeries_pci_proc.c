multiline_comment|/************************************************************************/
multiline_comment|/* File iSeries pci_proc.c created by Allan Trautman on Feb 27 2001.    */
multiline_comment|/************************************************************************/
multiline_comment|/* Create /proc/iSeries/pci file that contains iSeries card location.   */
multiline_comment|/* Copyright (C) 20yy  &lt;Allan H Trautman&gt; &lt;IBM Corp&gt;                    */
multiline_comment|/*                                                                      */
multiline_comment|/* This program is free software; you can redistribute it and/or modify */
multiline_comment|/* it under the terms of the GNU General Public License as published by */
multiline_comment|/* the Free Software Foundation; either version 2 of the License, or    */
multiline_comment|/* (at your option) any later version.                                  */
multiline_comment|/*                                                                      */
multiline_comment|/* This program is distributed in the hope that it will be useful,      */
multiline_comment|/* but WITHOUT ANY WARRANTY; without even the implied warranty of       */
multiline_comment|/* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the        */
multiline_comment|/* GNU General Public License for more details.                         */
multiline_comment|/*                                                                      */
multiline_comment|/* You should have received a copy of the GNU General Public License    */
multiline_comment|/* along with this program; if not, write to the:                       */
multiline_comment|/* Free Software Foundation, Inc.,                                      */
multiline_comment|/* 59 Temple Place, Suite 330,                                          */
multiline_comment|/* Boston, MA  02111-1307  USA                                          */
multiline_comment|/************************************************************************/
multiline_comment|/* Change Activity:                                                     */
multiline_comment|/*   Created, Feb 27, 2001                                              */
multiline_comment|/* End Change Activity                                                  */
multiline_comment|/************************************************************************/
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/iSeries/iSeries_VpdInfo.h&gt;
macro_line|#include &lt;asm/iSeries/iSeries_proc.h&gt;
macro_line|#include &lt;asm/iSeries/iSeries_pci.h&gt;
macro_line|#include &lt;asm/iSeries/iSeries_FlightRecorder.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
DECL|variable|pci_proc_root
r_static
r_struct
id|proc_dir_entry
op_star
id|pci_proc_root
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|pciFr_proc_root
r_static
r_struct
id|proc_dir_entry
op_star
id|pciFr_proc_root
op_assign
l_int|NULL
suffix:semicolon
r_int
id|iSeries_proc_pci_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_int
id|iSeries_proc_pci_write_proc
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_int
id|iSeries_proc_pciFr_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_int
id|iSeries_proc_pciFr_write_proc
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
suffix:semicolon
DECL|function|iSeries_pci_proc_init
r_void
id|iSeries_pci_proc_init
c_func
(paren
r_struct
id|proc_dir_entry
op_star
id|iSeries_proc
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: Creating /proc/iSeries/pci&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Read = User,Group,Other, Write User */
id|pci_proc_root
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;pci&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|iSeries_proc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_proc_root
)paren
r_return
suffix:semicolon
id|pci_proc_root-&gt;nlink
op_assign
l_int|1
suffix:semicolon
id|pci_proc_root-&gt;data
op_assign
(paren
r_void
op_star
)paren
l_int|0
suffix:semicolon
id|pci_proc_root-&gt;read_proc
op_assign
id|iSeries_proc_pci_read_proc
suffix:semicolon
id|pci_proc_root-&gt;write_proc
op_assign
id|iSeries_proc_pci_write_proc
suffix:semicolon
multiline_comment|/* Read = User,Group,Other, Write User */
id|printk
c_func
(paren
l_string|&quot;PCI: Creating /proc/iSeries/pciFr&bslash;n&quot;
)paren
suffix:semicolon
id|pciFr_proc_root
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;pciFr&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|iSeries_proc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pciFr_proc_root
)paren
r_return
suffix:semicolon
id|pciFr_proc_root-&gt;nlink
op_assign
l_int|1
suffix:semicolon
id|pciFr_proc_root-&gt;data
op_assign
(paren
r_void
op_star
)paren
l_int|0
suffix:semicolon
id|pciFr_proc_root-&gt;read_proc
op_assign
id|iSeries_proc_pciFr_read_proc
suffix:semicolon
id|pciFr_proc_root-&gt;write_proc
op_assign
id|iSeries_proc_pciFr_write_proc
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************/
multiline_comment|/* Get called when client reads the /proc/iSeries/pci file.  The data returned */
multiline_comment|/* is the iSeries card locations for service.                                  */
multiline_comment|/*******************************************************************************/
DECL|function|iSeries_proc_pci_read_proc
r_int
id|iSeries_proc_pci_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|LineLen
suffix:semicolon
multiline_comment|/* Size of new Data            */
r_struct
id|pci_dev
op_star
id|PciDev
suffix:semicolon
multiline_comment|/* Device pointer              */
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
multiline_comment|/* net_device pointer          */
r_int
id|DeviceCount
suffix:semicolon
multiline_comment|/* Device Number               */
multiline_comment|/***************************************************************************/
multiline_comment|/* ###        Bus  Device      Bus  Dev Frm Card                           */
multiline_comment|/*   1. Linux:  0/ 28  iSeries: 24/ 36/  1/C14                             */
multiline_comment|/*   2. Linux:  0/ 30  iSeries: 24/ 38/  2/C14                             */
multiline_comment|/***************************************************************************/
id|DeviceCount
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Count the devices listed.           */
id|LineLen
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Reset Length                        */
multiline_comment|/***************************************************************************/
multiline_comment|/* List the devices                                                        */
multiline_comment|/***************************************************************************/
id|pci_for_each_dev
c_func
(paren
id|PciDev
)paren
(brace
id|LineLen
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|LineLen
comma
l_string|&quot;%3d. &quot;
comma
id|DeviceCount
)paren
suffix:semicolon
id|LineLen
op_add_assign
id|iSeries_Device_Information
c_func
(paren
id|PciDev
comma
id|page
op_plus
id|LineLen
comma
id|count
op_minus
id|LineLen
)paren
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
id|dev_base
suffix:semicolon
id|dev
op_ne
l_int|NULL
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;base_addr
op_eq
id|PciDev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
)paren
(brace
multiline_comment|/* Yep, a net_device */
id|LineLen
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|LineLen
comma
l_string|&quot;, Net device: %s&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* if */
)brace
multiline_comment|/* for */
id|LineLen
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|LineLen
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
op_increment
id|DeviceCount
suffix:semicolon
multiline_comment|/* Add for the list.                    */
multiline_comment|/************************************************************************/
multiline_comment|/* Run out of room in system buffer.                                    */
multiline_comment|/************************************************************************/
r_if
c_cond
(paren
id|LineLen
op_plus
l_int|80
op_ge
id|count
)paren
(brace
multiline_comment|/* Room for another line?  No. bail out */
id|LineLen
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|LineLen
comma
l_string|&quot;/proc/pci file full!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/***************************************************************************/
multiline_comment|/* If no devices, tell user that instead                                   */
multiline_comment|/***************************************************************************/
r_if
c_cond
(paren
id|DeviceCount
op_eq
l_int|1
)paren
(brace
id|LineLen
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|LineLen
comma
l_string|&quot;No PCI devices found&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
multiline_comment|/* Update counts and return                                                */
multiline_comment|/***************************************************************************/
op_star
id|eof
op_assign
id|LineLen
suffix:semicolon
r_return
id|LineLen
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************/
multiline_comment|/* Do nothing, Nothing to support for the write                                */
multiline_comment|/*******************************************************************************/
DECL|function|iSeries_proc_pci_write_proc
r_int
id|iSeries_proc_pci_write_proc
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************/
multiline_comment|/* Get called when client reads the /proc/iSeries/pci file.  The data returned */
multiline_comment|/* is the iSeries card locations for service.                                  */
multiline_comment|/*******************************************************************************/
DECL|function|iSeries_proc_pciFr_read_proc
r_int
id|iSeries_proc_pciFr_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|pci_dev
op_star
id|PciDev
suffix:semicolon
multiline_comment|/* Device pointer              */
r_int
id|DeviceCount
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Device Number               */
r_int
id|LineLen
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Size of new Data            */
id|printk
c_func
(paren
l_string|&quot;PCI: Dump Flight Recorder!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/***************************************************************************/
multiline_comment|/* List the devices                                                        */
multiline_comment|/***************************************************************************/
id|pci_for_each_dev
c_func
(paren
id|PciDev
)paren
(brace
id|LineLen
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|LineLen
comma
l_string|&quot;%3d. 0x%08X  &quot;
comma
id|DeviceCount
comma
(paren
r_int
)paren
id|PciDev
)paren
suffix:semicolon
id|LineLen
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|LineLen
comma
l_string|&quot;Bus: %02X, Device: %02X &quot;
comma
id|PciDev-&gt;bus-&gt;number
comma
id|PciDev-&gt;devfn
)paren
suffix:semicolon
id|LineLen
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|LineLen
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
op_increment
id|DeviceCount
suffix:semicolon
multiline_comment|/* Add for the list.                    */
)brace
id|LineLen
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|LineLen
comma
l_string|&quot;--&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/***************************************************************************/
multiline_comment|/* The Flight Recorder                                                     */
multiline_comment|/* Someday handle wrap                                                     */
multiline_comment|/***************************************************************************/
r_if
c_cond
(paren
id|PciFr-&gt;StartingPointer
op_ne
l_int|NULL
)paren
(brace
r_char
op_star
id|StartEntry
op_assign
(paren
r_char
op_star
)paren
id|PciFr-&gt;StartingPointer
suffix:semicolon
r_char
op_star
id|EndEntry
op_assign
(paren
r_char
op_star
)paren
id|PciFr-&gt;CurrentPointer
suffix:semicolon
r_while
c_loop
(paren
id|EndEntry
OG
id|StartEntry
op_logical_and
id|LineLen
op_plus
l_int|40
OL
id|count
)paren
(brace
id|LineLen
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|LineLen
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|StartEntry
)paren
suffix:semicolon
id|StartEntry
op_add_assign
id|strlen
c_func
(paren
id|StartEntry
)paren
op_plus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|LineLen
op_plus
l_int|40
op_ge
id|count
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: Max Count Hit %d and %d&bslash;n&quot;
comma
id|LineLen
comma
id|count
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/***************************************************************************/
multiline_comment|/* Update counts and return                                                */
multiline_comment|/***************************************************************************/
id|printk
c_func
(paren
l_string|&quot;PCI: End of File at %d&bslash;n&quot;
comma
id|LineLen
)paren
suffix:semicolon
op_star
id|eof
op_assign
id|LineLen
suffix:semicolon
r_return
id|LineLen
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************/
multiline_comment|/* Flight Recorder Controls                                                    */
multiline_comment|/*******************************************************************************/
DECL|function|iSeries_proc_pciFr_write_proc
r_int
id|iSeries_proc_pciFr_write_proc
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_if
c_cond
(paren
id|buffer
op_ne
l_int|0
op_logical_and
id|strlen
c_func
(paren
id|buffer
)paren
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|strstr
c_func
(paren
id|buffer
comma
l_string|&quot;trace on&quot;
)paren
op_ne
l_int|NULL
)paren
(brace
id|iSeries_Set_PciTraceFlag
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|ISERIES_PCI_FR_DATE
c_func
(paren
l_string|&quot;PCI Trace turned on!&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strstr
c_func
(paren
id|buffer
comma
l_string|&quot;trace off&quot;
)paren
op_ne
l_int|NULL
)paren
(brace
id|iSeries_Set_PciTraceFlag
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|ISERIES_PCI_FR_DATE
c_func
(paren
l_string|&quot;PCI Trace turned off!&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|ISERIES_PCI_FR_TIME
c_func
(paren
l_string|&quot;PCI Trace Option Invalid!&quot;
)paren
suffix:semicolon
id|readl
c_func
(paren
l_int|0x00000000
)paren
suffix:semicolon
)brace
)brace
r_return
id|count
suffix:semicolon
)brace
eof
