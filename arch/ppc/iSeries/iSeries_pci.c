multiline_comment|/************************************************************************/
multiline_comment|/* File iSeries_pci.c created by Allan Trautman on Tue Jan  9 2001.     */
multiline_comment|/************************************************************************/
multiline_comment|/* This code supports the pci interface on the IBM iSeries systems.     */
multiline_comment|/* Copyright (C) 20yy  &lt;Allan H Trautman&gt; &lt;IBM Corp&gt;                    */
multiline_comment|/*                                                                      */
multiline_comment|/* This program is free software; you can redistribute it and/or modify */
multiline_comment|/* it under the terms of the GNU General Public License as published by */
multiline_comment|/* the Free Software Foundation; either version 2 of the License, or    */
multiline_comment|/* (at your option) any later version.                                  */
multiline_comment|/*                                                                      */
multiline_comment|/* This program is distributed in the hope that it will be useful,      */
multiline_comment|/* but WITHOUT ANY WARRANTY; without even the implied warranty of       */
multiline_comment|/* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the        */
multiline_comment|/* GNU General Public License for more details.                         */
multiline_comment|/*                                                                      */
multiline_comment|/* You should have received a copy of the GNU General Public License    */
multiline_comment|/* along with this program; if not, write to the:                       */
multiline_comment|/* Free Software Foundation, Inc.,                                      */
multiline_comment|/* 59 Temple Place, Suite 330,                                          */
multiline_comment|/* Boston, MA  02111-1307  USA                                          */
multiline_comment|/************************************************************************/
multiline_comment|/* Change Activity:                                                     */
multiline_comment|/*   Created, Jan 9, 2001                                               */
multiline_comment|/*   August, 10, 2001  Added PCI Retry code.                            */
multiline_comment|/* End Change Activity                                                  */
multiline_comment|/************************************************************************/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
multiline_comment|/************************************************************************/
multiline_comment|/* Arch specific&squot;s                                                      */
multiline_comment|/************************************************************************/
macro_line|#include &lt;asm/io.h&gt;                /* Has Io Instructions.              */
macro_line|#include &lt;asm/iSeries/iSeries_io.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#include &lt;asm/iSeries/HvCallPci.h&gt;
macro_line|#include &lt;asm/iSeries/HvTypes.h&gt;
macro_line|#include &lt;asm/iSeries/mf.h&gt;
macro_line|#include &lt;asm/iSeries/iSeries_proc.h&gt;
macro_line|#include &lt;asm/iSeries/iSeries_FlightRecorder.h&gt;
macro_line|#include &lt;asm/iSeries/iSeries_VpdInfo.h&gt;
macro_line|#include &quot;iSeries_IoMmTable.h&quot;
macro_line|#include &quot;iSeries_pci.h&quot;
r_extern
r_int
id|panic_timeout
suffix:semicolon
multiline_comment|/* Panic Timeout reference      */
multiline_comment|/************************************************************************/
multiline_comment|/* /proc/iSeries/pci initialization.                                    */
multiline_comment|/************************************************************************/
r_extern
r_void
id|iSeries_pci_proc_init
c_func
(paren
r_struct
id|proc_dir_entry
op_star
id|iSeries_proc
)paren
suffix:semicolon
r_void
id|iSeries_pci_IoError
c_func
(paren
r_char
op_star
id|OpCode
comma
id|iSeries_Device
op_star
id|Device
)paren
suffix:semicolon
multiline_comment|/************************************************************************/
multiline_comment|/* PCI Config Space Access functions for IBM iSeries Systems            */
multiline_comment|/*                                                                      */
multiline_comment|/* Modeled after the IBM Python                                         */
multiline_comment|/* int pci_read_config_word(struct pci_dev*, int Offset, u16* ValuePtr) */
multiline_comment|/************************************************************************/
multiline_comment|/* Note: Normal these routines are defined by a macro and branch        */
multiline_comment|/* table is created and stuffed in the pci_bus structure.               */
multiline_comment|/* The following is for reference, if it was done this way.  However for*/
multiline_comment|/* the first time out, the routines are individual coded.               */
multiline_comment|/************************************************************************/
multiline_comment|/* This is the low level architecture depend interface routines.        */
multiline_comment|/* 1. They must be in specific order, see &lt;linux/pci.h&gt; for base        */
multiline_comment|/*    structure.                                                        */
multiline_comment|/* 2. The code in not inline here, it calls specific routines in        */
multiline_comment|/*    this module and HvCalls                                           */
multiline_comment|/* 3. The common convention is to put a pointer to the structure in     */
multiline_comment|/*    pci_bus-&gt;sysdata.                                                 */
multiline_comment|/* 4. Direct call is the same as in &lt;linux/pci.h                        */
multiline_comment|/************************************************************************/
DECL|function|iSeries_pci_read_config_byte
r_int
id|iSeries_pci_read_config_byte
c_func
(paren
r_struct
id|pci_dev
op_star
id|PciDev
comma
r_int
id|Offset
comma
id|u8
op_star
id|ValuePtr
)paren
(brace
id|iSeries_Device
id|Device
suffix:semicolon
id|build_iSeries_Device
c_func
(paren
op_amp
id|Device
comma
id|PciDev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device.BusNumber
op_eq
l_int|0xFF
)paren
(brace
id|Device.RCode
op_assign
l_int|0x301
suffix:semicolon
)brace
multiline_comment|/* Trap out invalid bus. */
r_else
(brace
id|Device.RCode
op_assign
id|HvCallPci_configLoad8
c_func
(paren
id|Device.BusNumber
comma
id|Device.SubBus
comma
id|Device.DevFn
comma
id|Offset
comma
id|ValuePtr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device.RCode
op_ne
l_int|0
op_logical_or
id|PciTraceFlag
OG
l_int|0
)paren
(brace
id|sprintf
c_func
(paren
id|PciFrBuffer
comma
l_string|&quot;RCB: %02X,%02X,%02X,%04X Rtn: %04X,%02X&quot;
comma
id|Device.BusNumber
comma
id|Device.SubBus
comma
id|Device.DevFn
comma
id|Offset
comma
id|Device.RCode
comma
op_star
id|ValuePtr
)paren
suffix:semicolon
id|ISERIES_PCI_FR
c_func
(paren
id|PciFrBuffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device.RCode
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: I/O Error %s&quot;
comma
id|PciFrBuffer
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
id|Device.RCode
suffix:semicolon
)brace
DECL|function|iSeries_pci_read_config_word
r_int
id|iSeries_pci_read_config_word
c_func
(paren
r_struct
id|pci_dev
op_star
id|PciDev
comma
r_int
id|Offset
comma
id|u16
op_star
id|ValuePtr
)paren
(brace
id|iSeries_Device
id|Device
suffix:semicolon
id|build_iSeries_Device
c_func
(paren
op_amp
id|Device
comma
id|PciDev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device.BusNumber
op_eq
l_int|0xFF
)paren
(brace
id|Device.RCode
op_assign
l_int|0x301
suffix:semicolon
)brace
multiline_comment|/* Trap out invalid bus. */
r_else
(brace
id|Device.RCode
op_assign
id|HvCallPci_configLoad16
c_func
(paren
id|Device.BusNumber
comma
id|Device.SubBus
comma
id|Device.DevFn
comma
id|Offset
comma
id|ValuePtr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device.RCode
op_ne
l_int|0
op_logical_or
id|PciTraceFlag
OG
l_int|0
)paren
(brace
id|sprintf
c_func
(paren
id|PciFrBuffer
comma
l_string|&quot;RCW: %02X,%02X,%02X,%04X Rtn: %04X,%04X&quot;
comma
id|Device.BusNumber
comma
id|Device.SubBus
comma
id|Device.DevFn
comma
id|Offset
comma
id|Device.RCode
comma
op_star
id|ValuePtr
)paren
suffix:semicolon
id|ISERIES_PCI_FR
c_func
(paren
id|PciFrBuffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device.RCode
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: I/O Error %s&quot;
comma
id|PciFrBuffer
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
id|Device.RCode
suffix:semicolon
)brace
DECL|function|iSeries_pci_read_config_dword
r_int
id|iSeries_pci_read_config_dword
c_func
(paren
r_struct
id|pci_dev
op_star
id|PciDev
comma
r_int
id|Offset
comma
id|u32
op_star
id|ValuePtr
)paren
(brace
id|iSeries_Device
id|Device
suffix:semicolon
id|build_iSeries_Device
c_func
(paren
op_amp
id|Device
comma
id|PciDev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device.BusNumber
op_eq
l_int|0xFF
)paren
(brace
id|Device.RCode
op_assign
l_int|0x301
suffix:semicolon
)brace
multiline_comment|/* Trap out invalid bus. */
r_else
(brace
id|Device.RCode
op_assign
id|HvCallPci_configLoad32
c_func
(paren
id|Device.BusNumber
comma
id|Device.SubBus
comma
id|Device.DevFn
comma
id|Offset
comma
id|ValuePtr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device.RCode
op_ne
l_int|0
op_logical_or
id|PciTraceFlag
OG
l_int|0
)paren
(brace
id|sprintf
c_func
(paren
id|PciFrBuffer
comma
l_string|&quot;RCL: %02X,%02X,%02X,%04X Rtn: %04X,%08X&quot;
comma
id|Device.BusNumber
comma
id|Device.SubBus
comma
id|Device.DevFn
comma
id|Offset
comma
id|Device.RCode
comma
op_star
id|ValuePtr
)paren
suffix:semicolon
id|ISERIES_PCI_FR
c_func
(paren
id|PciFrBuffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device.RCode
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: I/O Error %s&quot;
comma
id|PciFrBuffer
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
id|Device.RCode
suffix:semicolon
)brace
DECL|function|iSeries_pci_write_config_byte
r_int
id|iSeries_pci_write_config_byte
c_func
(paren
r_struct
id|pci_dev
op_star
id|PciDev
comma
r_int
id|Offset
comma
id|u8
id|Value
)paren
(brace
id|iSeries_Device
id|Device
suffix:semicolon
id|build_iSeries_Device
c_func
(paren
op_amp
id|Device
comma
id|PciDev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device.BusNumber
op_eq
l_int|0xFF
)paren
(brace
id|Device.RCode
op_assign
l_int|0x301
suffix:semicolon
)brace
multiline_comment|/* Trap out invalid bus. */
r_else
(brace
id|Device.RCode
op_assign
id|HvCallPci_configStore8
c_func
(paren
id|Device.BusNumber
comma
id|Device.SubBus
comma
id|Device.DevFn
comma
id|Offset
comma
id|Value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device.RCode
op_ne
l_int|0
op_logical_or
id|PciTraceFlag
OG
l_int|0
)paren
(brace
id|sprintf
c_func
(paren
id|PciFrBuffer
comma
l_string|&quot;WCB: %02X,%02X,%02X,%04X Rtn: %04X,%02X&quot;
comma
id|Device.BusNumber
comma
id|Device.SubBus
comma
id|Device.DevFn
comma
id|Offset
comma
id|Device.RCode
comma
id|Value
)paren
suffix:semicolon
id|ISERIES_PCI_FR
c_func
(paren
id|PciFrBuffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device.RCode
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: I/O Error %s&quot;
comma
id|PciFrBuffer
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
id|Device.RCode
suffix:semicolon
)brace
DECL|function|iSeries_pci_write_config_word
r_int
id|iSeries_pci_write_config_word
c_func
(paren
r_struct
id|pci_dev
op_star
id|PciDev
comma
r_int
id|Offset
comma
id|u16
id|Value
)paren
(brace
id|iSeries_Device
id|Device
suffix:semicolon
id|build_iSeries_Device
c_func
(paren
op_amp
id|Device
comma
id|PciDev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device.BusNumber
op_eq
l_int|0xFF
)paren
(brace
id|Device.RCode
op_assign
l_int|0x301
suffix:semicolon
)brace
multiline_comment|/* Trap out invalid bus. */
r_else
(brace
id|Device.RCode
op_assign
id|HvCallPci_configStore16
c_func
(paren
id|Device.BusNumber
comma
id|Device.SubBus
comma
id|Device.DevFn
comma
id|Offset
comma
id|Value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device.RCode
op_ne
l_int|0
op_logical_or
id|PciTraceFlag
OG
l_int|0
)paren
(brace
id|sprintf
c_func
(paren
id|PciFrBuffer
comma
l_string|&quot;WCW: %02X,%02X,%02X,%04X Rtn: %04X,%04X&quot;
comma
id|Device.BusNumber
comma
id|Device.SubBus
comma
id|Device.DevFn
comma
id|Offset
comma
id|Device.RCode
comma
id|Value
)paren
suffix:semicolon
id|ISERIES_PCI_FR
c_func
(paren
id|PciFrBuffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device.RCode
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: I/O Error %s&quot;
comma
id|PciFrBuffer
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
id|Device.RCode
suffix:semicolon
)brace
DECL|function|iSeries_pci_write_config_dword
r_int
id|iSeries_pci_write_config_dword
c_func
(paren
r_struct
id|pci_dev
op_star
id|PciDev
comma
r_int
id|Offset
comma
id|u32
id|Value
)paren
(brace
id|iSeries_Device
id|Device
suffix:semicolon
id|build_iSeries_Device
c_func
(paren
op_amp
id|Device
comma
id|PciDev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device.BusNumber
op_eq
l_int|0xFF
)paren
(brace
id|Device.RCode
op_assign
l_int|0x301
suffix:semicolon
)brace
multiline_comment|/* Trap out invalid bus. */
r_else
(brace
id|Device.RCode
op_assign
id|HvCallPci_configStore32
c_func
(paren
id|Device.BusNumber
comma
id|Device.SubBus
comma
id|Device.DevFn
comma
id|Offset
comma
id|Value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device.RCode
op_ne
l_int|0
op_logical_or
id|PciTraceFlag
OG
l_int|0
)paren
(brace
id|sprintf
c_func
(paren
id|PciFrBuffer
comma
l_string|&quot;WCL: %02X,%02X,%02X,%04X Rtn: %04X,%08X&quot;
comma
id|Device.BusNumber
comma
id|Device.SubBus
comma
id|Device.DevFn
comma
id|Offset
comma
id|Device.RCode
comma
id|Value
)paren
suffix:semicolon
id|ISERIES_PCI_FR
c_func
(paren
id|PciFrBuffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device.RCode
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: I/O Error %s&quot;
comma
id|PciFrBuffer
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
id|Device.RCode
suffix:semicolon
)brace
multiline_comment|/************************************************************************/
multiline_comment|/* Branch Table                                                         */
multiline_comment|/************************************************************************/
DECL|variable|iSeries_pci_ops
r_struct
id|pci_ops
id|iSeries_pci_ops
op_assign
(brace
id|iSeries_pci_read_config_byte
comma
id|iSeries_pci_read_config_word
comma
id|iSeries_pci_read_config_dword
comma
id|iSeries_pci_write_config_byte
comma
id|iSeries_pci_write_config_word
comma
id|iSeries_pci_write_config_dword
)brace
suffix:semicolon
multiline_comment|/************************************************************************/
multiline_comment|/* Dump the device info into the Flight Recorder                        */
multiline_comment|/* Call should have 3 char text to prefix FR Entry                      */
multiline_comment|/************************************************************************/
DECL|function|iSeries_DumpDevice
r_void
id|iSeries_DumpDevice
c_func
(paren
r_char
op_star
id|Text
comma
id|iSeries_Device
op_star
id|Device
)paren
(brace
id|sprintf
c_func
(paren
id|PciFrBuffer
comma
l_string|&quot;%s:%02X%02X%02X %04X&quot;
comma
id|Text
comma
id|Device-&gt;BusNumber
comma
id|Device-&gt;SubBus
comma
id|Device-&gt;DevFn
comma
id|Device-&gt;RCode
)paren
suffix:semicolon
id|ISERIES_PCI_FR
c_func
(paren
id|PciFrBuffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device-&gt;BarNumber
op_ne
l_int|0xFF
)paren
(brace
id|sprintf
c_func
(paren
id|PciFrBuffer
comma
l_string|&quot;BAR:%02X %04X    &quot;
comma
id|Device-&gt;BarNumber
comma
id|Device-&gt;BarOffset
)paren
suffix:semicolon
id|ISERIES_PCI_FR
c_func
(paren
id|PciFrBuffer
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|Device-&gt;RCode
op_ne
l_int|0
)paren
(brace
multiline_comment|/*****************************************************************/
multiline_comment|/* PCI I/O ERROR RDL: Bus: 0x01 Device: 0x06 ReturnCode: 0x000B  */
multiline_comment|/*****************************************************************/
id|printk
c_func
(paren
l_string|&quot;PCI: I/O ERROR %s: Bus: 0x%02X Device: 0x%02X ReturnCode: 0x%04X&bslash;n&quot;
comma
id|Text
comma
id|Device-&gt;PciDevPtr-&gt;bus-&gt;number
comma
id|Device-&gt;PciDevPtr-&gt;devfn
comma
id|Device-&gt;RCode
)paren
suffix:semicolon
)brace
)brace
DECL|variable|IoCounts
r_int
id|IoCounts
op_assign
l_int|0
suffix:semicolon
DECL|variable|RetryCounts
r_int
id|RetryCounts
op_assign
l_int|0
suffix:semicolon
DECL|variable|IoRetry
r_int
id|IoRetry
op_assign
l_int|0
suffix:semicolon
multiline_comment|/************************************************************************&n; * Check Return Code&n; * -&gt; On Failure, print and log information.&n; *    Increment Retry Count, if exceeds max, panic partition.&n; * -&gt; If in retry, print and log success &n; ************************************************************************&n; * PCI: ReadL: I/O Error( 0): 0x1234&n; * PCI: Device..: 17:38.10  Bar: 0x00  Offset 0018&n; * PCI: Device..: 17:38.10  Retry( 1) Operation ReadL:&n; * PCI: Retry Successful on Device: 17:38.10&n; ************************************************************************/
DECL|function|CheckReturnCode
r_int
id|CheckReturnCode
c_func
(paren
r_char
op_star
id|TextHdr
comma
id|iSeries_Device
op_star
id|Device
)paren
(brace
op_increment
id|IoCounts
suffix:semicolon
r_if
c_cond
(paren
id|Device-&gt;RCode
op_ne
l_int|0
)paren
(brace
id|sprintf
c_func
(paren
id|PciFrBuffer
comma
l_string|&quot;%s: I/O Error(%2d): 0x%04X&bslash;n&quot;
comma
id|TextHdr
comma
id|IoRetry
comma
id|Device-&gt;RCode
)paren
suffix:semicolon
id|ISERIES_PCI_FR
c_func
(paren
id|PciFrBuffer
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI: %s&quot;
comma
id|PciFrBuffer
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|PciFrBuffer
comma
l_string|&quot;Device..: %02X:%02X.%02X  Bar: 0x%02X  Offset %04X&bslash;n&quot;
comma
id|Device-&gt;BusNumber
comma
id|Device-&gt;SubBus
comma
id|Device-&gt;DevFn
comma
id|Device-&gt;BarNumber
comma
id|Device-&gt;BarOffset
)paren
suffix:semicolon
id|ISERIES_PCI_FR
c_func
(paren
id|PciFrBuffer
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI: %s&quot;
comma
id|PciFrBuffer
)paren
suffix:semicolon
multiline_comment|/* Bump the retry and check for max. */
op_increment
id|RetryCounts
suffix:semicolon
op_increment
id|IoRetry
suffix:semicolon
multiline_comment|/* Retry Count exceeded or RIO Bus went down. */
r_if
c_cond
(paren
id|IoRetry
OG
l_int|7
op_logical_or
id|Device-&gt;RCode
op_eq
l_int|0x206
)paren
(brace
id|mf_displaySrc
c_func
(paren
l_int|0xB6000103
)paren
suffix:semicolon
id|panic_timeout
op_assign
l_int|0
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;PCI: Hardware I/O Error, SRC B6000103, Automatic Reboot Disabled.&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|sprintf
c_func
(paren
id|PciFrBuffer
comma
l_string|&quot;Device..: %02X:%02X.%02X  Retry(%2d) Operation: %s&bslash;n&quot;
comma
id|Device-&gt;BusNumber
comma
id|Device-&gt;SubBus
comma
id|Device-&gt;DevFn
comma
id|IoRetry
comma
id|TextHdr
)paren
suffix:semicolon
id|ISERIES_PCI_FR
c_func
(paren
id|PciFrBuffer
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI: %s&bslash;n&quot;
comma
id|PciFrBuffer
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|IoRetry
OG
l_int|0
)paren
(brace
id|sprintf
c_func
(paren
id|PciFrBuffer
comma
l_string|&quot;Retry Successful on Device: %02X:%02X.%02X&bslash;n&quot;
comma
id|Device-&gt;BusNumber
comma
id|Device-&gt;SubBus
comma
id|Device-&gt;DevFn
)paren
suffix:semicolon
id|ISERIES_PCI_FR
c_func
(paren
id|PciFrBuffer
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI: %s&bslash;n&quot;
comma
id|PciFrBuffer
)paren
suffix:semicolon
)brace
)brace
r_return
id|Device-&gt;RCode
suffix:semicolon
)brace
multiline_comment|/************************************************************************/
multiline_comment|/* Read MM I/O Instructions for the iSeries                             */
multiline_comment|/* On MM I/O error, all ones are returned and iSeries_pci_IoError is cal*/
multiline_comment|/* else, data is returned in big Endian format.                         */
multiline_comment|/************************************************************************/
multiline_comment|/* iSeries_Readb = Read Byte  ( 8 bit)                                  */
multiline_comment|/* iSeries_Readw = Read Word  (16 bit)                                  */
multiline_comment|/* iSeries_Readl = Read Long  (32 bit)                                  */
multiline_comment|/************************************************************************/
DECL|function|iSeries_Readb
id|u8
id|iSeries_Readb
c_func
(paren
id|u32
op_star
id|IoAddress
)paren
(brace
id|iSeries_Device
id|Device
suffix:semicolon
id|u8
id|IoData
suffix:semicolon
id|u8
id|Data
op_assign
op_minus
l_int|1
suffix:semicolon
id|IoRetry
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|build_iSeries_Device_From_IoAddress
c_func
(paren
op_amp
id|Device
comma
id|IoAddress
)paren
op_eq
l_int|0
)paren
(brace
r_do
(brace
id|Device.RCode
op_assign
id|HvCallPci_barLoad8
(paren
id|Device.BusNumber
comma
id|Device.SubBus
comma
id|Device.DevFn
comma
id|Device.BarNumber
comma
id|Device.BarOffset
comma
op_amp
id|IoData
)paren
suffix:semicolon
id|Data
op_assign
id|IoData
suffix:semicolon
r_if
c_cond
(paren
id|Device.RCode
op_ne
l_int|0
)paren
(brace
id|CheckReturnCode
c_func
(paren
l_string|&quot;ReadB&quot;
comma
op_amp
id|Device
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|Device.RCode
op_ne
l_int|0
)paren
(brace
suffix:semicolon
)brace
)brace
r_return
id|Data
suffix:semicolon
)brace
DECL|function|iSeries_Readw
id|u16
id|iSeries_Readw
c_func
(paren
id|u32
op_star
id|IoAddress
)paren
(brace
id|iSeries_Device
id|Device
suffix:semicolon
id|u16
id|IoData
suffix:semicolon
id|u16
id|Data
op_assign
op_minus
l_int|1
suffix:semicolon
id|IoRetry
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|build_iSeries_Device_From_IoAddress
c_func
(paren
op_amp
id|Device
comma
id|IoAddress
)paren
op_eq
l_int|0
)paren
(brace
r_do
(brace
id|Device.RCode
op_assign
id|HvCallPci_barLoad16
c_func
(paren
id|Device.BusNumber
comma
id|Device.SubBus
comma
id|Device.DevFn
comma
id|Device.BarNumber
comma
id|Device.BarOffset
comma
op_amp
id|IoData
)paren
suffix:semicolon
id|Data
op_assign
id|swab16
c_func
(paren
id|IoData
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device.RCode
op_ne
l_int|0
)paren
(brace
id|CheckReturnCode
c_func
(paren
l_string|&quot;ReadW&quot;
comma
op_amp
id|Device
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|Device.RCode
op_ne
l_int|0
)paren
(brace
suffix:semicolon
)brace
)brace
r_return
id|Data
suffix:semicolon
)brace
DECL|function|iSeries_Readl
id|u32
id|iSeries_Readl
c_func
(paren
id|u32
op_star
id|IoAddress
)paren
(brace
id|iSeries_Device
id|Device
suffix:semicolon
id|u32
id|Data
op_assign
op_minus
l_int|1
suffix:semicolon
id|u32
id|IoData
suffix:semicolon
id|IoRetry
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|build_iSeries_Device_From_IoAddress
c_func
(paren
op_amp
id|Device
comma
id|IoAddress
)paren
op_eq
l_int|0
)paren
(brace
id|IoRetry
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|Device.RCode
op_assign
id|HvCallPci_barLoad32
c_func
(paren
id|Device.BusNumber
comma
id|Device.SubBus
comma
id|Device.DevFn
comma
id|Device.BarNumber
comma
id|Device.BarOffset
comma
op_amp
id|IoData
)paren
suffix:semicolon
id|Data
op_assign
id|swab32
c_func
(paren
id|IoData
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device.RCode
op_ne
l_int|0
)paren
(brace
id|CheckReturnCode
c_func
(paren
l_string|&quot;ReadL&quot;
comma
op_amp
id|Device
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|Device.RCode
op_ne
l_int|0
)paren
(brace
suffix:semicolon
)brace
)brace
r_return
id|Data
suffix:semicolon
)brace
multiline_comment|/************************************************************************/
multiline_comment|/* Write MM I/O Instructions for the iSeries                            */
multiline_comment|/* On MM I/O error, iSeries_pci_IoError is called                       */
multiline_comment|/* Data is in big Endian format.                                        */
multiline_comment|/************************************************************************/
multiline_comment|/* iSeries_Writeb = Write Byte (8 bit)                                  */
multiline_comment|/* iSeries_Writew = Write Word(16 bit)                                  */
multiline_comment|/* iSeries_Writel = Write Long(32 bit)                                  */
multiline_comment|/************************************************************************/
DECL|function|iSeries_Writeb
r_void
id|iSeries_Writeb
c_func
(paren
id|u8
id|Data
comma
id|u32
op_star
id|IoAddress
)paren
(brace
id|iSeries_Device
id|Device
suffix:semicolon
id|u8
id|IoData
op_assign
id|Data
suffix:semicolon
id|IoRetry
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|build_iSeries_Device_From_IoAddress
c_func
(paren
op_amp
id|Device
comma
id|IoAddress
)paren
op_eq
l_int|0
)paren
(brace
r_do
(brace
id|Device.RCode
op_assign
id|HvCallPci_barStore8
(paren
id|Device.BusNumber
comma
id|Device.SubBus
comma
id|Device.DevFn
comma
id|Device.BarNumber
comma
id|Device.BarOffset
comma
id|IoData
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device.RCode
op_ne
l_int|0
)paren
(brace
id|CheckReturnCode
c_func
(paren
l_string|&quot;WrteB&quot;
comma
op_amp
id|Device
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|Device.RCode
op_ne
l_int|0
)paren
(brace
suffix:semicolon
)brace
)brace
)brace
DECL|function|iSeries_Writew
r_void
id|iSeries_Writew
c_func
(paren
id|u16
id|Data
comma
id|u32
op_star
id|IoAddress
)paren
(brace
id|iSeries_Device
id|Device
suffix:semicolon
id|u16
id|IoData
op_assign
id|swab16
c_func
(paren
id|Data
)paren
suffix:semicolon
id|IoRetry
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|build_iSeries_Device_From_IoAddress
c_func
(paren
op_amp
id|Device
comma
id|IoAddress
)paren
op_eq
l_int|0
)paren
(brace
r_do
(brace
id|Device.RCode
op_assign
id|HvCallPci_barStore16
c_func
(paren
id|Device.BusNumber
comma
id|Device.SubBus
comma
id|Device.DevFn
comma
id|Device.BarNumber
comma
id|Device.BarOffset
comma
id|IoData
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device.RCode
op_ne
l_int|0
)paren
(brace
id|CheckReturnCode
c_func
(paren
l_string|&quot;WrteW&quot;
comma
op_amp
id|Device
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|Device.RCode
op_ne
l_int|0
)paren
(brace
suffix:semicolon
)brace
)brace
)brace
DECL|function|iSeries_Writel
r_void
id|iSeries_Writel
c_func
(paren
id|u32
id|Data
comma
id|u32
op_star
id|IoAddress
)paren
(brace
id|iSeries_Device
id|Device
suffix:semicolon
id|u32
id|IoData
op_assign
id|swab32
c_func
(paren
id|Data
)paren
suffix:semicolon
id|IoRetry
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|build_iSeries_Device_From_IoAddress
c_func
(paren
op_amp
id|Device
comma
id|IoAddress
)paren
op_eq
l_int|0
)paren
(brace
r_do
(brace
id|Device.RCode
op_assign
id|HvCallPci_barStore32
c_func
(paren
id|Device.BusNumber
comma
id|Device.SubBus
comma
id|Device.DevFn
comma
id|Device.BarNumber
comma
id|Device.BarOffset
comma
id|IoData
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device.RCode
op_ne
l_int|0
)paren
(brace
id|CheckReturnCode
c_func
(paren
l_string|&quot;WrteL&quot;
comma
op_amp
id|Device
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|Device.RCode
op_ne
l_int|0
)paren
(brace
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/************************************************************************/
multiline_comment|/* iSeries I/O Remap                                                    */
multiline_comment|/* -&gt; Check to see if one of ours                                       */
multiline_comment|/* -&gt; If not, return null to help find the bug.                         */
multiline_comment|/************************************************************************/
DECL|function|iSeries_ioremap
r_void
op_star
id|iSeries_ioremap
(paren
r_int
r_int
id|offset
comma
r_int
r_int
id|size
)paren
(brace
r_if
c_cond
(paren
id|iSeries_xlateIoMmAddress
c_func
(paren
(paren
id|u32
op_star
)paren
id|offset
)paren
op_ne
l_int|0
)paren
(brace
r_return
(paren
r_void
op_star
)paren
id|offset
suffix:semicolon
)brace
r_else
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/************************************************************************/
multiline_comment|/* Routine to build the iSeries_Device for the pci device.              */
multiline_comment|/************************************************************************/
DECL|function|build_iSeries_Device
r_void
id|build_iSeries_Device
c_func
(paren
id|iSeries_Device
op_star
id|Device
comma
r_struct
id|pci_dev
op_star
id|DevPtr
)paren
(brace
id|Device-&gt;PciDevPtr
op_assign
id|DevPtr
suffix:semicolon
id|Device-&gt;BusNumber
op_assign
id|ISERIES_GET_LPAR_BUS
c_func
(paren
id|DevPtr-&gt;bus-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ISERIES_GET_LPAR_SUBBUS
c_func
(paren
id|DevPtr-&gt;bus-&gt;number
)paren
op_eq
l_int|0
)paren
(brace
id|Device-&gt;SubBus
op_assign
id|ISERIES_DEVFN_DECODE_SUBBUS
c_func
(paren
id|DevPtr-&gt;devfn
)paren
suffix:semicolon
id|Device-&gt;DevFn
op_assign
l_int|0x10
op_or
id|ISERIES_DECODE_FUNCTION
c_func
(paren
id|DevPtr-&gt;devfn
)paren
suffix:semicolon
)brace
r_else
(brace
id|Device-&gt;SubBus
op_assign
id|ISERIES_GET_LPAR_SUBBUS
c_func
(paren
id|DevPtr-&gt;bus-&gt;number
)paren
suffix:semicolon
id|Device-&gt;DevFn
op_assign
id|ISERIES_44_FORMAT
c_func
(paren
id|DevPtr-&gt;devfn
)paren
suffix:semicolon
)brace
id|Device-&gt;BarNumber
op_assign
l_int|0xFF
suffix:semicolon
id|Device-&gt;BarOffset
op_assign
l_int|0
suffix:semicolon
id|Device-&gt;RCode
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/************************************************************************/
multiline_comment|/* Routine to build the iSeries_Device for the IoAddress.               */
multiline_comment|/************************************************************************/
DECL|function|build_iSeries_Device_From_IoAddress
r_int
id|build_iSeries_Device_From_IoAddress
c_func
(paren
id|iSeries_Device
op_star
id|Device
comma
id|u32
op_star
id|IoAddress
)paren
(brace
id|Device-&gt;PciDevPtr
op_assign
id|iSeries_xlateIoMmAddress
c_func
(paren
id|IoAddress
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device-&gt;PciDevPtr
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Valid pci_dev?              */
id|build_iSeries_Device
c_func
(paren
id|Device
comma
id|Device-&gt;PciDevPtr
)paren
suffix:semicolon
id|Device-&gt;BarNumber
op_assign
id|iSeries_IoMmTable_Bar
c_func
(paren
id|IoAddress
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Device-&gt;BarNumber
op_ne
l_int|0xFF
)paren
(brace
id|Device-&gt;BarOffset
op_assign
id|iSeries_IoMmTable_BarOffset
c_func
(paren
id|IoAddress
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|sprintf
c_func
(paren
id|PciFrBuffer
comma
l_string|&quot;I/O BAR Address: 0x%08X&quot;
comma
(paren
r_int
)paren
id|IoAddress
)paren
suffix:semicolon
id|ISERIES_PCI_FR
c_func
(paren
id|PciFrBuffer
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI: Invalid I/O Address 0x%08X&bslash;n&quot;
comma
(paren
r_int
)paren
id|IoAddress
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;PCI: Invalid I/O Address 0x%08X&bslash;n&quot;
comma
(paren
r_int
)paren
id|IoAddress
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/************************************************************************/
multiline_comment|/* Returns the iSeries bus value                                        */
multiline_comment|/************************************************************************/
DECL|function|iSeries_Get_Bus
id|u8
id|iSeries_Get_Bus
c_func
(paren
r_struct
id|pci_dev
op_star
id|DevPtr
)paren
(brace
r_return
id|iSeries_GlobalBusMap
(braket
id|DevPtr-&gt;bus-&gt;number
)braket
(braket
id|_HVBUSNUMBER_
)braket
suffix:semicolon
)brace
multiline_comment|/************************************************************************/
multiline_comment|/* Returns the iSeries subbus value                                     */
multiline_comment|/************************************************************************/
DECL|function|iSeries_Get_SubBus
id|u8
id|iSeries_Get_SubBus
c_func
(paren
r_struct
id|pci_dev
op_star
id|DevPtr
)paren
(brace
id|u8
id|SubBus
op_assign
id|iSeries_GlobalBusMap
(braket
id|DevPtr-&gt;bus-&gt;number
)braket
(braket
id|_HVSUBBUSNUMBER_
)braket
suffix:semicolon
r_if
c_cond
(paren
id|SubBus
op_eq
l_int|0xFF
)paren
id|SubBus
op_assign
l_int|0xFF
suffix:semicolon
r_else
r_if
c_cond
(paren
id|SubBus
op_eq
l_int|0
)paren
(brace
id|SubBus
op_assign
id|ISERIES_DEVFN_DECODE_SUBBUS
c_func
(paren
id|DevPtr-&gt;devfn
)paren
suffix:semicolon
)brace
r_else
id|SubBus
op_assign
id|ISERIES_GET_LPAR_SUBBUS
c_func
(paren
id|DevPtr-&gt;bus-&gt;number
)paren
suffix:semicolon
r_return
id|SubBus
suffix:semicolon
)brace
multiline_comment|/************************************************************************/
multiline_comment|/* Returns the iSeries Device and Function Number                       */
multiline_comment|/************************************************************************/
DECL|function|iSeries_Get_DevFn
id|u8
id|iSeries_Get_DevFn
c_func
(paren
r_struct
id|pci_dev
op_star
id|DevPtr
)paren
(brace
id|u8
id|SubBus
op_assign
id|iSeries_GlobalBusMap
(braket
id|DevPtr-&gt;bus-&gt;number
)braket
(braket
id|_HVSUBBUSNUMBER_
)braket
suffix:semicolon
id|u8
id|DevFn
suffix:semicolon
r_if
c_cond
(paren
id|SubBus
op_eq
l_int|0xFF
)paren
id|DevFn
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|SubBus
op_eq
l_int|0
)paren
(brace
id|DevFn
op_assign
l_int|0x10
op_or
id|ISERIES_DECODE_FUNCTION
c_func
(paren
id|DevPtr-&gt;devfn
)paren
suffix:semicolon
)brace
r_else
id|DevFn
op_assign
id|ISERIES_44_FORMAT
c_func
(paren
id|DevPtr-&gt;devfn
)paren
suffix:semicolon
r_return
id|DevFn
suffix:semicolon
)brace
multiline_comment|/************************************************************************/
multiline_comment|/* This is provides the mapping from the Linux bus and devfn to ISeries */
multiline_comment|/* Bus and Subbus.                                                      */
multiline_comment|/* Initialize to all FFs, translations will fail if FF entry found.     */
multiline_comment|/************************************************************************/
DECL|variable|iSeries_GlobalBusMap
id|u8
id|iSeries_GlobalBusMap
(braket
l_int|256
)braket
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Global Bus Mapping           */
DECL|function|iSeries_Initialize_GlobalBusMap
r_void
id|__init
id|iSeries_Initialize_GlobalBusMap
c_func
(paren
r_void
)paren
(brace
r_int
id|Index
suffix:semicolon
r_for
c_loop
(paren
id|Index
op_assign
l_int|0
suffix:semicolon
id|Index
OL
l_int|256
suffix:semicolon
op_increment
id|Index
)paren
(brace
id|iSeries_GlobalBusMap
(braket
id|Index
)braket
(braket
id|_HVBUSNUMBER_
)braket
op_assign
l_int|0xFF
suffix:semicolon
id|iSeries_GlobalBusMap
(braket
id|Index
)braket
(braket
id|_HVSUBBUSNUMBER_
)braket
op_assign
l_int|0xFF
suffix:semicolon
)brace
id|ISERIES_PCI_FR
c_func
(paren
l_string|&quot;IntGlobalBusMap&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/************************************************************************/
multiline_comment|/* Create the Flight Recorder                                           */
multiline_comment|/************************************************************************/
DECL|variable|PciFlightRecorder
id|FlightRecorder
id|PciFlightRecorder
suffix:semicolon
multiline_comment|/* Pci Flight Recorder  */
DECL|variable|PciFr
id|FlightRecorder
op_star
id|PciFr
suffix:semicolon
multiline_comment|/* Pointer to Fr        */
DECL|variable|PciFrBufferData
r_char
id|PciFrBufferData
(braket
l_int|128
)braket
suffix:semicolon
multiline_comment|/* Working buffer       */
DECL|variable|PciFrBuffer
r_char
op_star
id|PciFrBuffer
suffix:semicolon
multiline_comment|/* Pointer to buffer    */
DECL|variable|PciTraceFlag
r_int
id|PciTraceFlag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Trace Level Flag     */
DECL|variable|PciDeviceTrace
r_struct
id|pci_dev
op_star
id|PciDeviceTrace
suffix:semicolon
multiline_comment|/* Device Tracing       */
DECL|function|iSeries_Initialize_FlightRecorder
r_void
id|__init
id|iSeries_Initialize_FlightRecorder
c_func
(paren
r_void
)paren
(brace
id|PciFr
op_assign
op_amp
id|PciFlightRecorder
suffix:semicolon
id|PciFrBuffer
op_assign
op_amp
id|PciFrBufferData
(braket
l_int|0
)braket
suffix:semicolon
id|iSeries_Fr_Initialize
c_func
(paren
id|PciFr
comma
l_string|&quot;PciFlightRecord&quot;
)paren
suffix:semicolon
id|ISERIES_PCI_FR
c_func
(paren
l_string|&quot;August 10,2001.&quot;
)paren
suffix:semicolon
id|PciTraceFlag
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/************************************************************************/
multiline_comment|/* Function to turn on and off the Flight Recorder Trace Flag           */
multiline_comment|/************************************************************************/
DECL|function|iSeries_Set_PciTraceFlag
r_int
id|iSeries_Set_PciTraceFlag
c_func
(paren
r_int
id|TraceFlag
)paren
(brace
r_int
id|TempFlag
op_assign
id|PciTraceFlag
suffix:semicolon
id|PciTraceFlag
op_assign
id|TraceFlag
suffix:semicolon
r_return
id|TempFlag
suffix:semicolon
)brace
DECL|function|iSeries_Get_PciTraceFlag
r_int
id|iSeries_Get_PciTraceFlag
c_func
(paren
r_void
)paren
(brace
r_return
id|PciTraceFlag
suffix:semicolon
)brace
DECL|function|iSeries_Set_PciFilter
r_void
id|iSeries_Set_PciFilter
c_func
(paren
r_struct
id|pci_dev
op_star
id|PciDevice
)paren
(brace
id|PciDeviceTrace
op_assign
id|PciDevice
suffix:semicolon
)brace
multiline_comment|/************************************************************************/
multiline_comment|/* Initialize the I/O Tables and maps                                   */
multiline_comment|/************************************************************************/
DECL|function|iSeries_pci_Initialize
r_void
id|__init
id|iSeries_pci_Initialize
c_func
(paren
r_void
)paren
(brace
id|iSeries_Initialize_FlightRecorder
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Flight Recorder 1st. */
id|iSeries_Initialize_GlobalBusMap
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Global Bus Map       */
id|iSeries_IoMmTable_Initialize
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Io Translate table.  */
id|iSeries_proc_callback
c_func
(paren
op_amp
id|iSeries_pci_proc_init
)paren
suffix:semicolon
id|iSeries_Set_PciErpFlag
c_func
(paren
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Erp Level set to 4   */
)brace
multiline_comment|/************************************************************************/
multiline_comment|/* Erp level when PCI I/O Errors are detected.                          */
multiline_comment|/*  0 =  Be quiet about the errors.                                     */
multiline_comment|/*  1 &gt;= Log error information and continue on.                         */
multiline_comment|/*  2 =  Printk the error information and continue on.                  */
multiline_comment|/*  3 =  Printk the error information and put task to sleep.            */
multiline_comment|/*  4 =  Printk the error information and panic the kernel with no reboo*/
multiline_comment|/************************************************************************/
DECL|variable|iSeries_pci_ErpLevel
r_int
id|iSeries_pci_ErpLevel
op_assign
l_int|0
suffix:semicolon
multiline_comment|/************************************************************************/
multiline_comment|/* Allows clients to set the Erp State                                  */
multiline_comment|/************************************************************************/
DECL|function|iSeries_Set_PciErpFlag
r_int
id|iSeries_Set_PciErpFlag
c_func
(paren
r_int
id|ErpFlag
)paren
(brace
r_int
id|SavedState
op_assign
id|iSeries_pci_ErpLevel
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI: PciERPFlag set to %d.&bslash;n&quot;
comma
id|ErpFlag
)paren
suffix:semicolon
id|iSeries_pci_ErpLevel
op_assign
id|ErpFlag
suffix:semicolon
r_return
id|SavedState
suffix:semicolon
)brace
r_extern
r_int
id|panic_timeout
suffix:semicolon
multiline_comment|/* Panic Timeout reference      */
multiline_comment|/************************************************************************/
multiline_comment|/* Fatal I/O Error, crash the system.                                   */
multiline_comment|/* PCI: Fatal I/O Error, Device 00/00, Error 0x0000, Status Reg 0x0000  */
multiline_comment|/* PCI: Kernel Panic called with reboot disabled.                       */
multiline_comment|/************************************************************************/
DECL|function|iSeries_pci_IoError
r_void
id|iSeries_pci_IoError
c_func
(paren
r_char
op_star
id|OpCode
comma
id|iSeries_Device
op_star
id|Device
)paren
(brace
r_char
id|DeviceInfo
(braket
l_int|128
)braket
suffix:semicolon
r_char
id|ErrorInfo
(braket
l_int|128
)braket
suffix:semicolon
r_struct
id|pci_dev
op_star
id|PciDev
op_assign
id|Device-&gt;PciDevPtr
suffix:semicolon
id|sprintf
c_func
(paren
id|ErrorInfo
comma
l_string|&quot;I/O Error Detected.  Op: %s, Bus%3d, Device%3d  Error: 0x%04X&bslash;n&quot;
comma
id|OpCode
comma
id|PciDev-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|PciDev-&gt;devfn
)paren
comma
id|Device-&gt;RCode
)paren
suffix:semicolon
id|iSeries_Device_Information
c_func
(paren
id|PciDev
comma
id|DeviceInfo
comma
l_int|128
)paren
suffix:semicolon
multiline_comment|/* Log the error in the flight recorder                            */
r_if
c_cond
(paren
id|iSeries_pci_ErpLevel
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|Device-&gt;RCode
op_ne
l_int|0x0102
)paren
(brace
multiline_comment|/* Previous error      */
id|ISERIES_PCI_FR
c_func
(paren
id|ErrorInfo
)paren
suffix:semicolon
id|ISERIES_PCI_FR
c_func
(paren
id|DeviceInfo
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|iSeries_pci_ErpLevel
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: %s&quot;
comma
id|ErrorInfo
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI: %s&bslash;n&quot;
comma
id|DeviceInfo
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|iSeries_pci_ErpLevel
op_eq
l_int|3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: Current process 0x%08X put to sleep for debug.&bslash;n&quot;
comma
id|current-&gt;pid
)paren
suffix:semicolon
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|WaitQueue
comma
id|current
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|current-&gt;wait_chldexit
comma
op_amp
id|WaitQueue
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|current-&gt;wait_chldexit
comma
op_amp
id|WaitQueue
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|iSeries_pci_ErpLevel
op_eq
l_int|4
)paren
(brace
id|mf_displaySrc
c_func
(paren
l_int|0xB6000103
)paren
suffix:semicolon
id|panic_timeout
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Don&squot;t reboot. */
multiline_comment|/* printk(&quot;PCI: Hardware I/O Error, SRC B6000103, Kernel Panic called.&bslash;n&quot;);*/
multiline_comment|/* panic(&quot;Automatic Reboot Disabled.&quot;) */
id|panic
c_func
(paren
l_string|&quot;PCI: Hardware I/O Error, SRC B6000103, Automatic Reboot Disabled.&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/************************************************************************/
multiline_comment|/* I/0 Memory copy MUST use mmio commands on iSeries                    */
multiline_comment|/************************************************************************/
DECL|function|iSeries_memcpy_toio
r_void
op_star
id|iSeries_memcpy_toio
c_func
(paren
r_void
op_star
id|dest
comma
r_void
op_star
id|source
comma
r_int
id|n
)paren
(brace
r_char
op_star
id|dst
op_assign
id|dest
suffix:semicolon
r_char
op_star
id|src
op_assign
id|source
suffix:semicolon
r_while
c_loop
(paren
id|n
op_decrement
)paren
(brace
id|writeb
(paren
op_star
id|src
op_increment
comma
id|dst
op_increment
)paren
suffix:semicolon
)brace
r_return
id|dest
suffix:semicolon
)brace
DECL|function|iSeries_memcpy_fromio
r_void
op_star
id|iSeries_memcpy_fromio
c_func
(paren
r_void
op_star
id|dest
comma
r_void
op_star
id|source
comma
r_int
id|n
)paren
(brace
r_char
op_star
id|dst
op_assign
id|dest
suffix:semicolon
r_char
op_star
id|src
op_assign
id|source
suffix:semicolon
r_while
c_loop
(paren
id|n
op_decrement
)paren
op_star
id|dst
op_increment
op_assign
id|readb
(paren
id|src
op_increment
)paren
suffix:semicolon
r_return
id|dest
suffix:semicolon
)brace
eof
