multiline_comment|/*&n; * arch/ppc/boot/simple/gt64260_tty.c&n; *&n; * Bootloader version of the embedded MPSC/UART driver for the GT64260[A].&n; * Note: Due to 64260A errata, DMA will be used for UART input (via SDMA).&n; *&n; * Author: Mark A. Greer &lt;mgreer@mvista.com&gt;&n; *&n; * 2001 (c) MontaVista, Software, Inc.  This file is licensed under&n; * the terms of the GNU General Public License version 2.  This program&n; * is licensed &quot;as is&quot; without any warranty of any kind, whether express&n; * or implied.&n; */
multiline_comment|/* This code assumes that the data cache has been disabled (L1, L2, L3). */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/serialP.h&gt;
macro_line|#include &lt;linux/serial_reg.h&gt;
macro_line|#include &lt;asm/serial.h&gt;
macro_line|#include &lt;asm/gt64260_defs.h&gt;
r_extern
r_void
id|udelay
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_void
id|stop_dma
c_func
(paren
r_int
id|chan
)paren
suffix:semicolon
DECL|variable|gt64260_base
r_static
id|u32
id|gt64260_base
op_assign
id|EV64260_BRIDGE_REG_BASE
suffix:semicolon
multiline_comment|/* base addr of 64260 */
r_inline
r_int
DECL|function|gt64260_in_le32
id|gt64260_in_le32
c_func
(paren
r_volatile
r_int
op_star
id|addr
)paren
(brace
r_int
id|ret
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;lwbrx %0,0,%1; eieio&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|ret
)paren
suffix:colon
l_string|&quot;r&quot;
(paren
id|addr
)paren
comma
l_string|&quot;m&quot;
(paren
op_star
id|addr
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_inline
r_void
DECL|function|gt64260_out_le32
id|gt64260_out_le32
c_func
(paren
r_volatile
r_int
op_star
id|addr
comma
r_int
id|val
)paren
(brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;stwbrx %1,0,%2; eieio&quot;
suffix:colon
l_string|&quot;=m&quot;
(paren
op_star
id|addr
)paren
suffix:colon
l_string|&quot;r&quot;
(paren
id|val
)paren
comma
l_string|&quot;r&quot;
(paren
id|addr
)paren
)paren
suffix:semicolon
)brace
DECL|macro|GT64260_REG_READ
mdefine_line|#define GT64260_REG_READ(offs)&t;&t;&t;&t;&t;&t;&bslash;&n;&t;(gt64260_in_le32((volatile uint *)(gt64260_base + (offs))))
DECL|macro|GT64260_REG_WRITE
mdefine_line|#define GT64260_REG_WRITE(offs, d)&t;&t;&t;&t;&t;&bslash;&n;        (gt64260_out_le32((volatile uint *)(gt64260_base + (offs)), (int)(d)))
r_static
r_struct
(brace
DECL|member|sdc
id|u32
id|sdc
suffix:semicolon
DECL|member|sdcm
id|u32
id|sdcm
suffix:semicolon
DECL|member|rx_desc
id|u32
id|rx_desc
suffix:semicolon
DECL|member|rx_buf_ptr
id|u32
id|rx_buf_ptr
suffix:semicolon
DECL|member|scrdp
id|u32
id|scrdp
suffix:semicolon
DECL|member|tx_desc
id|u32
id|tx_desc
suffix:semicolon
DECL|member|sctdp
id|u32
id|sctdp
suffix:semicolon
DECL|member|sftdp
id|u32
id|sftdp
suffix:semicolon
DECL|variable|sdma_regs
)brace
id|sdma_regs
suffix:semicolon
DECL|macro|SDMA_REGS_INIT
mdefine_line|#define&t;SDMA_REGS_INIT(chan) {&t;&t;&t;&t;&t;&t;&bslash;&n;&t;sdma_regs.sdc        = GT64260_SDMA_##chan##_SDC;&t;&t;&bslash;&n;&t;sdma_regs.sdcm       = GT64260_SDMA_##chan##_SDCM;&t;&t;&bslash;&n;&t;sdma_regs.rx_desc    = GT64260_SDMA_##chan##_RX_DESC;&t;&t;&bslash;&n;&t;sdma_regs.rx_buf_ptr = GT64260_SDMA_##chan##_RX_BUF_PTR;&t;&bslash;&n;&t;sdma_regs.scrdp      = GT64260_SDMA_##chan##_SCRDP;&t;&t;&bslash;&n;&t;sdma_regs.tx_desc    = GT64260_SDMA_##chan##_TX_DESC;&t;&t;&bslash;&n;&t;sdma_regs.sctdp      = GT64260_SDMA_##chan##_SCTDP;&t;&t;&bslash;&n;&t;sdma_regs.sftdp      = GT64260_SDMA_##chan##_SFTDP;&t;&t;&bslash;&n;}
r_typedef
r_struct
(brace
DECL|member|bufsize
r_volatile
id|u16
id|bufsize
suffix:semicolon
DECL|member|bytecnt
r_volatile
id|u16
id|bytecnt
suffix:semicolon
DECL|member|cmd_stat
r_volatile
id|u32
id|cmd_stat
suffix:semicolon
DECL|member|next_desc_ptr
r_volatile
id|u32
id|next_desc_ptr
suffix:semicolon
DECL|member|buffer
r_volatile
id|u32
id|buffer
suffix:semicolon
DECL|typedef|gt64260_rx_desc_t
)brace
id|gt64260_rx_desc_t
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|bytecnt
r_volatile
id|u16
id|bytecnt
suffix:semicolon
DECL|member|shadow
r_volatile
id|u16
id|shadow
suffix:semicolon
DECL|member|cmd_stat
r_volatile
id|u32
id|cmd_stat
suffix:semicolon
DECL|member|next_desc_ptr
r_volatile
id|u32
id|next_desc_ptr
suffix:semicolon
DECL|member|buffer
r_volatile
id|u32
id|buffer
suffix:semicolon
DECL|typedef|gt64260_tx_desc_t
)brace
id|gt64260_tx_desc_t
suffix:semicolon
DECL|macro|MAX_RESET_WAIT
mdefine_line|#define&t;MAX_RESET_WAIT&t;10000
DECL|macro|MAX_TX_WAIT
mdefine_line|#define&t;MAX_TX_WAIT&t;10000
DECL|macro|RX_NUM_DESC
mdefine_line|#define&t;RX_NUM_DESC&t;2
DECL|macro|TX_NUM_DESC
mdefine_line|#define&t;TX_NUM_DESC&t;2
DECL|macro|RX_BUF_SIZE
mdefine_line|#define&t;RX_BUF_SIZE&t;16
DECL|macro|TX_BUF_SIZE
mdefine_line|#define&t;TX_BUF_SIZE&t;16
DECL|variable|rd
r_static
id|gt64260_rx_desc_t
id|rd
(braket
id|RX_NUM_DESC
)braket
id|__attribute__
(paren
(paren
id|aligned
c_func
(paren
l_int|32
)paren
)paren
)paren
suffix:semicolon
DECL|variable|td
r_static
id|gt64260_tx_desc_t
id|td
(braket
id|TX_NUM_DESC
)braket
id|__attribute__
(paren
(paren
id|aligned
c_func
(paren
l_int|32
)paren
)paren
)paren
suffix:semicolon
DECL|variable|rx_buf
r_static
r_char
id|rx_buf
(braket
id|RX_NUM_DESC
op_star
id|RX_BUF_SIZE
)braket
id|__attribute__
(paren
(paren
id|aligned
c_func
(paren
l_int|32
)paren
)paren
)paren
suffix:semicolon
DECL|variable|tx_buf
r_static
r_char
id|tx_buf
(braket
id|TX_NUM_DESC
op_star
id|TX_BUF_SIZE
)braket
id|__attribute__
(paren
(paren
id|aligned
c_func
(paren
l_int|32
)paren
)paren
)paren
suffix:semicolon
DECL|variable|cur_rd
r_static
r_int
id|cur_rd
op_assign
l_int|0
suffix:semicolon
DECL|variable|cur_td
r_static
r_int
id|cur_td
op_assign
l_int|0
suffix:semicolon
DECL|macro|RX_INIT_RDP
mdefine_line|#define&t;RX_INIT_RDP(rdp) {&t;&t;&t;&t;&t;&t;&bslash;&n;&t;(rdp)-&gt;bufsize = 2;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;(rdp)-&gt;bytecnt = 0;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;(rdp)-&gt;cmd_stat = GT64260_SDMA_DESC_CMDSTAT_L |&t;&t;&t;&bslash;&n;&t;&t;&t;  GT64260_SDMA_DESC_CMDSTAT_F |&t;&t;&t;&bslash;&n;&t;&t;&t;  GT64260_SDMA_DESC_CMDSTAT_O;&t;&t;&t;&bslash;&n;}
r_int
r_int
DECL|function|serial_init
id|serial_init
c_func
(paren
r_int
id|chan
comma
r_void
op_star
id|ignored
)paren
(brace
id|u32
id|mpsc_adjust
comma
id|sdma_adjust
comma
id|brg_bcr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|stop_dma
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|stop_dma
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan
op_ne
l_int|1
)paren
(brace
id|chan
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* default to chan 0 if anything but 1 */
id|mpsc_adjust
op_assign
l_int|0
suffix:semicolon
id|sdma_adjust
op_assign
l_int|0
suffix:semicolon
id|brg_bcr
op_assign
id|GT64260_BRG_0_BCR
suffix:semicolon
id|SDMA_REGS_INIT
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|mpsc_adjust
op_assign
l_int|0x1000
suffix:semicolon
id|sdma_adjust
op_assign
l_int|0x2000
suffix:semicolon
id|brg_bcr
op_assign
id|GT64260_BRG_1_BCR
suffix:semicolon
id|SDMA_REGS_INIT
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Set up ring buffers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_NUM_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|RX_INIT_RDP
c_func
(paren
op_amp
id|rd
(braket
id|i
)braket
)paren
suffix:semicolon
id|rd
(braket
id|i
)braket
dot
id|buffer
op_assign
(paren
id|u32
)paren
op_amp
id|rx_buf
(braket
id|i
op_star
id|RX_BUF_SIZE
)braket
suffix:semicolon
id|rd
(braket
id|i
)braket
dot
id|next_desc_ptr
op_assign
(paren
id|u32
)paren
op_amp
id|rd
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
)brace
id|rd
(braket
id|RX_NUM_DESC
op_minus
l_int|1
)braket
dot
id|next_desc_ptr
op_assign
(paren
id|u32
)paren
op_amp
id|rd
(braket
l_int|0
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_NUM_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|td
(braket
id|i
)braket
dot
id|bytecnt
op_assign
l_int|0
suffix:semicolon
id|td
(braket
id|i
)braket
dot
id|shadow
op_assign
l_int|0
suffix:semicolon
id|td
(braket
id|i
)braket
dot
id|buffer
op_assign
(paren
id|u32
)paren
op_amp
id|tx_buf
(braket
id|i
op_star
id|TX_BUF_SIZE
)braket
suffix:semicolon
id|td
(braket
id|i
)braket
dot
id|cmd_stat
op_assign
id|GT64260_SDMA_DESC_CMDSTAT_F
op_or
id|GT64260_SDMA_DESC_CMDSTAT_L
suffix:semicolon
id|td
(braket
id|i
)braket
dot
id|next_desc_ptr
op_assign
(paren
id|u32
)paren
op_amp
id|td
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
)brace
id|td
(braket
id|TX_NUM_DESC
op_minus
l_int|1
)braket
dot
id|next_desc_ptr
op_assign
(paren
id|u32
)paren
op_amp
id|td
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Set MPSC Routing */
id|GT64260_REG_WRITE
c_func
(paren
id|GT64260_MPSC_MRR
comma
l_int|0x3ffffe38
)paren
suffix:semicolon
id|GT64260_REG_WRITE
c_func
(paren
id|GT64260_MPP_SERIAL_PORTS_MULTIPLEX
comma
l_int|0x00001102
)paren
suffix:semicolon
multiline_comment|/* MPSC 0/1 Rx &amp; Tx get clocks BRG0/1 */
id|GT64260_REG_WRITE
c_func
(paren
id|GT64260_MPSC_RCRR
comma
l_int|0x00000100
)paren
suffix:semicolon
id|GT64260_REG_WRITE
c_func
(paren
id|GT64260_MPSC_TCRR
comma
l_int|0x00000100
)paren
suffix:semicolon
multiline_comment|/* clear pending interrupts */
id|GT64260_REG_WRITE
c_func
(paren
id|GT64260_SDMA_INTR_MASK
comma
l_int|0
)paren
suffix:semicolon
id|GT64260_REG_WRITE
c_func
(paren
id|GT64260_SDMA_0_SCRDP
op_plus
id|sdma_adjust
comma
op_amp
id|rd
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|GT64260_REG_WRITE
c_func
(paren
id|GT64260_SDMA_0_SCTDP
op_plus
id|sdma_adjust
comma
op_amp
id|td
(braket
id|TX_NUM_DESC
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|GT64260_REG_WRITE
c_func
(paren
id|GT64260_SDMA_0_SFTDP
op_plus
id|sdma_adjust
comma
op_amp
id|td
(braket
id|TX_NUM_DESC
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|GT64260_REG_WRITE
c_func
(paren
id|GT64260_SDMA_0_SDC
op_plus
id|sdma_adjust
comma
id|GT64260_SDMA_SDC_RFT
op_or
id|GT64260_SDMA_SDC_SFM
op_or
id|GT64260_SDMA_SDC_BLMR
op_or
id|GT64260_SDMA_SDC_BLMT
op_or
(paren
l_int|3
op_lshift
l_int|12
)paren
)paren
suffix:semicolon
multiline_comment|/* Set BRG to generate proper baud rate */
id|GT64260_REG_WRITE
c_func
(paren
id|brg_bcr
comma
(paren
(paren
l_int|8
op_lshift
l_int|18
)paren
op_or
(paren
l_int|1
op_lshift
l_int|16
)paren
op_or
l_int|36
)paren
)paren
suffix:semicolon
multiline_comment|/* Put MPSC into UART mode, no null modem, 16x clock mode */
id|GT64260_REG_WRITE
c_func
(paren
id|GT64260_MPSC_0_MMCRL
op_plus
id|mpsc_adjust
comma
l_int|0x000004c4
)paren
suffix:semicolon
id|GT64260_REG_WRITE
c_func
(paren
id|GT64260_MPSC_0_MMCRH
op_plus
id|mpsc_adjust
comma
l_int|0x04400400
)paren
suffix:semicolon
id|GT64260_REG_WRITE
c_func
(paren
id|GT64260_MPSC_0_CHR_1
op_plus
id|mpsc_adjust
comma
l_int|0
)paren
suffix:semicolon
id|GT64260_REG_WRITE
c_func
(paren
id|GT64260_MPSC_0_CHR_9
op_plus
id|mpsc_adjust
comma
l_int|0
)paren
suffix:semicolon
id|GT64260_REG_WRITE
c_func
(paren
id|GT64260_MPSC_0_CHR_10
op_plus
id|mpsc_adjust
comma
l_int|0
)paren
suffix:semicolon
id|GT64260_REG_WRITE
c_func
(paren
id|GT64260_MPSC_0_CHR_3
op_plus
id|mpsc_adjust
comma
l_int|4
)paren
suffix:semicolon
id|GT64260_REG_WRITE
c_func
(paren
id|GT64260_MPSC_0_CHR_4
op_plus
id|mpsc_adjust
comma
l_int|0
)paren
suffix:semicolon
id|GT64260_REG_WRITE
c_func
(paren
id|GT64260_MPSC_0_CHR_5
op_plus
id|mpsc_adjust
comma
l_int|0
)paren
suffix:semicolon
id|GT64260_REG_WRITE
c_func
(paren
id|GT64260_MPSC_0_CHR_6
op_plus
id|mpsc_adjust
comma
l_int|0
)paren
suffix:semicolon
id|GT64260_REG_WRITE
c_func
(paren
id|GT64260_MPSC_0_CHR_7
op_plus
id|mpsc_adjust
comma
l_int|0
)paren
suffix:semicolon
id|GT64260_REG_WRITE
c_func
(paren
id|GT64260_MPSC_0_CHR_8
op_plus
id|mpsc_adjust
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* 8 data bits, 1 stop bit */
id|GT64260_REG_WRITE
c_func
(paren
id|GT64260_MPSC_0_MPCR
op_plus
id|mpsc_adjust
comma
(paren
l_int|3
op_lshift
l_int|12
)paren
)paren
suffix:semicolon
id|GT64260_REG_WRITE
c_func
(paren
id|GT64260_SDMA_0_SDCM
op_plus
id|sdma_adjust
comma
id|GT64260_SDMA_SDCM_ERD
)paren
suffix:semicolon
id|GT64260_REG_WRITE
c_func
(paren
id|GT64260_MPSC_0_CHR_2
op_plus
id|sdma_adjust
comma
id|GT64260_MPSC_UART_CR_EH
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_return
(paren
id|ulong
)paren
id|chan
suffix:semicolon
)brace
r_static
r_void
DECL|function|stop_dma
id|stop_dma
c_func
(paren
r_int
id|chan
)paren
(brace
id|u32
id|sdma_sdcm
op_assign
id|GT64260_SDMA_0_SDCM
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|chan
op_eq
l_int|1
)paren
(brace
id|sdma_sdcm
op_assign
id|GT64260_SDMA_1_SDCM
suffix:semicolon
)brace
multiline_comment|/* Abort SDMA Rx, Tx */
id|GT64260_REG_WRITE
c_func
(paren
id|sdma_sdcm
comma
id|GT64260_SDMA_SDCM_AR
op_or
id|GT64260_SDMA_SDCM_STD
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_RESET_WAIT
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|GT64260_REG_READ
c_func
(paren
id|sdma_sdcm
)paren
op_amp
(paren
id|GT64260_SDMA_SDCM_AR
op_or
id|GT64260_SDMA_SDCM_AT
)paren
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_static
r_int
DECL|function|wait_for_ownership
id|wait_for_ownership
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_TX_WAIT
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|GT64260_REG_READ
c_func
(paren
id|sdma_regs.sdcm
)paren
op_amp
id|GT64260_SDMA_SDCM_TXD
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
)brace
r_return
(paren
id|i
OL
id|MAX_TX_WAIT
)paren
suffix:semicolon
)brace
r_void
DECL|function|serial_putc
id|serial_putc
c_func
(paren
r_int
r_int
id|com_port
comma
r_int
r_char
id|c
)paren
(brace
id|gt64260_tx_desc_t
op_star
id|tdp
suffix:semicolon
r_if
c_cond
(paren
id|wait_for_ownership
c_func
(paren
)paren
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|tdp
op_assign
op_amp
id|td
(braket
id|cur_td
)braket
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|cur_td
op_ge
id|TX_NUM_DESC
)paren
id|cur_td
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|unchar
op_star
)paren
(paren
id|tdp-&gt;buffer
op_xor
l_int|7
)paren
op_assign
id|c
suffix:semicolon
id|tdp-&gt;bytecnt
op_assign
l_int|1
suffix:semicolon
id|tdp-&gt;shadow
op_assign
l_int|1
suffix:semicolon
id|tdp-&gt;cmd_stat
op_assign
id|GT64260_SDMA_DESC_CMDSTAT_L
op_or
id|GT64260_SDMA_DESC_CMDSTAT_F
op_or
id|GT64260_SDMA_DESC_CMDSTAT_O
suffix:semicolon
id|GT64260_REG_WRITE
c_func
(paren
id|sdma_regs.sctdp
comma
id|tdp
)paren
suffix:semicolon
id|GT64260_REG_WRITE
c_func
(paren
id|sdma_regs.sftdp
comma
id|tdp
)paren
suffix:semicolon
id|GT64260_REG_WRITE
c_func
(paren
id|sdma_regs.sdcm
comma
id|GT64260_REG_READ
c_func
(paren
id|sdma_regs.sdcm
)paren
op_or
id|GT64260_SDMA_SDCM_TXD
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_int
r_char
DECL|function|serial_getc
id|serial_getc
c_func
(paren
r_int
r_int
id|com_port
)paren
(brace
id|gt64260_rx_desc_t
op_star
id|rdp
suffix:semicolon
id|unchar
id|c
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|rdp
op_assign
op_amp
id|rd
(braket
id|cur_rd
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rdp-&gt;cmd_stat
op_amp
(paren
id|GT64260_SDMA_DESC_CMDSTAT_O
op_or
id|GT64260_SDMA_DESC_CMDSTAT_ES
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|c
op_assign
op_star
(paren
id|unchar
op_star
)paren
(paren
id|rdp-&gt;buffer
op_xor
l_int|7
)paren
suffix:semicolon
id|RX_INIT_RDP
c_func
(paren
id|rdp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|cur_rd
op_ge
id|RX_NUM_DESC
)paren
id|cur_rd
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|c
suffix:semicolon
)brace
r_int
DECL|function|serial_tstc
id|serial_tstc
c_func
(paren
r_int
r_int
id|com_port
)paren
(brace
id|gt64260_rx_desc_t
op_star
id|rdp
suffix:semicolon
r_int
id|loop_count
op_assign
l_int|0
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|rdp
op_assign
op_amp
id|rd
(braket
id|cur_rd
)braket
suffix:semicolon
multiline_comment|/* Go thru rcv desc&squot;s until empty looking for one with data (no error)*/
r_while
c_loop
(paren
(paren
(paren
id|rdp-&gt;cmd_stat
op_amp
id|GT64260_SDMA_DESC_CMDSTAT_O
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|loop_count
op_increment
OL
id|RX_NUM_DESC
)paren
)paren
(brace
multiline_comment|/* If there was an error, reinit the desc &amp; continue */
r_if
c_cond
(paren
(paren
id|rdp-&gt;cmd_stat
op_amp
id|GT64260_SDMA_DESC_CMDSTAT_ES
)paren
op_ne
l_int|0
)paren
(brace
id|RX_INIT_RDP
c_func
(paren
id|rdp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|cur_rd
op_ge
id|RX_NUM_DESC
)paren
id|cur_rd
op_assign
l_int|0
suffix:semicolon
id|rdp
op_assign
(paren
id|gt64260_rx_desc_t
op_star
)paren
id|rdp-&gt;next_desc_ptr
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|rc
suffix:semicolon
)brace
r_void
DECL|function|serial_close
id|serial_close
c_func
(paren
r_int
r_int
id|com_port
)paren
(brace
id|stop_dma
c_func
(paren
id|com_port
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
eof
