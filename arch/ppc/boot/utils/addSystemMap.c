macro_line|#include &lt;stdio.h&gt;
macro_line|#include &lt;stdlib.h&gt;
macro_line|#include &lt;byteswap.h&gt;
macro_line|#include &lt;sys/types.h&gt;
macro_line|#include &lt;sys/stat.h&gt;
DECL|function|xlate
r_void
id|xlate
c_func
(paren
r_char
op_star
id|inb
comma
r_char
op_star
id|trb
comma
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
op_increment
id|i
)paren
(brace
r_char
id|c
op_assign
op_star
id|inb
op_increment
suffix:semicolon
r_char
id|c1
op_assign
id|c
op_rshift
l_int|4
suffix:semicolon
r_char
id|c2
op_assign
id|c
op_amp
l_int|0xf
suffix:semicolon
r_if
c_cond
(paren
id|c1
OG
l_int|9
)paren
id|c1
op_assign
id|c1
op_plus
l_char|&squot;A&squot;
op_minus
l_int|10
suffix:semicolon
r_else
id|c1
op_assign
id|c1
op_plus
l_char|&squot;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|c2
OG
l_int|9
)paren
id|c2
op_assign
id|c2
op_plus
l_char|&squot;A&squot;
op_minus
l_int|10
suffix:semicolon
r_else
id|c2
op_assign
id|c2
op_plus
l_char|&squot;0&squot;
suffix:semicolon
op_star
id|trb
op_increment
op_assign
id|c1
suffix:semicolon
op_star
id|trb
op_increment
op_assign
id|c2
suffix:semicolon
)brace
op_star
id|trb
op_assign
l_int|0
suffix:semicolon
)brace
DECL|macro|ElfHeaderSize
mdefine_line|#define ElfHeaderSize  (64 * 1024)
DECL|macro|ElfPages
mdefine_line|#define ElfPages  (ElfHeaderSize / 4096)
DECL|macro|KERNELBASE
mdefine_line|#define KERNELBASE (0xc0000000)
DECL|function|get4k
r_void
id|get4k
c_func
(paren
multiline_comment|/*istream *inf*/
id|FILE
op_star
id|file
comma
r_char
op_star
id|buf
)paren
(brace
r_int
id|j
suffix:semicolon
r_int
id|num
op_assign
id|fread
c_func
(paren
id|buf
comma
l_int|1
comma
l_int|4096
comma
id|file
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
id|num
suffix:semicolon
id|j
OL
l_int|4096
suffix:semicolon
op_increment
id|j
)paren
id|buf
(braket
id|j
)braket
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|put4k
r_void
id|put4k
c_func
(paren
multiline_comment|/*ostream *outf*/
id|FILE
op_star
id|file
comma
r_char
op_star
id|buf
)paren
(brace
id|fwrite
c_func
(paren
id|buf
comma
l_int|1
comma
l_int|4096
comma
id|file
)paren
suffix:semicolon
)brace
DECL|function|main
r_int
id|main
c_func
(paren
r_int
id|argc
comma
r_char
op_star
op_star
id|argv
)paren
(brace
r_char
id|inbuf
(braket
l_int|4096
)braket
suffix:semicolon
id|FILE
op_star
id|ramDisk
op_assign
l_int|NULL
suffix:semicolon
id|FILE
op_star
id|inputVmlinux
op_assign
l_int|NULL
suffix:semicolon
id|FILE
op_star
id|outputVmlinux
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|ramFileLen
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|ramLen
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|roundR
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|kernelLen
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|actualKernelLen
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|round
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|roundedKernelLen
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|ramStartOffs
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|ramPages
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|roundedKernelPages
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|argc
OL
l_int|2
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;Name of System Map file missing.&bslash;n&quot;
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|argc
OL
l_int|3
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;Name of vmlinux file missing.&bslash;n&quot;
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|argc
OL
l_int|4
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;Name of vmlinux output file missing.&bslash;n&quot;
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|ramDisk
op_assign
id|fopen
c_func
(paren
id|argv
(braket
l_int|1
)braket
comma
l_string|&quot;r&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ramDisk
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;System Map file &bslash;&quot;%s&bslash;&quot; failed to open.&bslash;n&quot;
comma
id|argv
(braket
l_int|1
)braket
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|inputVmlinux
op_assign
id|fopen
c_func
(paren
id|argv
(braket
l_int|2
)braket
comma
l_string|&quot;r&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inputVmlinux
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;vmlinux file &bslash;&quot;%s&bslash;&quot; failed to open.&bslash;n&quot;
comma
id|argv
(braket
l_int|2
)braket
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|outputVmlinux
op_assign
id|fopen
c_func
(paren
id|argv
(braket
l_int|3
)braket
comma
l_string|&quot;w&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|outputVmlinux
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;output vmlinux file &bslash;&quot;%s&bslash;&quot; failed to open.&bslash;n&quot;
comma
id|argv
(braket
l_int|3
)braket
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|fseek
c_func
(paren
id|ramDisk
comma
l_int|0
comma
id|SEEK_END
)paren
suffix:semicolon
id|ramFileLen
op_assign
id|ftell
c_func
(paren
id|ramDisk
)paren
suffix:semicolon
id|fseek
c_func
(paren
id|ramDisk
comma
l_int|0
comma
id|SEEK_SET
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;%s file size = %ld&bslash;n&quot;
comma
id|argv
(braket
l_int|1
)braket
comma
id|ramFileLen
)paren
suffix:semicolon
id|ramLen
op_assign
id|ramFileLen
suffix:semicolon
id|roundR
op_assign
l_int|4096
op_minus
(paren
id|ramLen
op_mod
l_int|4096
)paren
suffix:semicolon
r_if
c_cond
(paren
id|roundR
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;Rounding System Map file up to a multiple of 4096, adding %ld&bslash;n&quot;
comma
id|roundR
)paren
suffix:semicolon
id|ramLen
op_add_assign
id|roundR
suffix:semicolon
)brace
id|printf
c_func
(paren
l_string|&quot;Rounded System Map size is %ld&bslash;n&quot;
comma
id|ramLen
)paren
suffix:semicolon
id|fseek
c_func
(paren
id|inputVmlinux
comma
l_int|0
comma
id|SEEK_END
)paren
suffix:semicolon
id|kernelLen
op_assign
id|ftell
c_func
(paren
id|inputVmlinux
)paren
suffix:semicolon
id|fseek
c_func
(paren
id|inputVmlinux
comma
l_int|0
comma
id|SEEK_SET
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;kernel file size = %ld&bslash;n&quot;
comma
id|kernelLen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kernelLen
op_eq
l_int|0
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;You must have a linux kernel specified as argv[2]&bslash;n&quot;
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|actualKernelLen
op_assign
id|kernelLen
op_minus
id|ElfHeaderSize
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;actual kernel length (minus ELF header) = %ld&bslash;n&quot;
comma
id|actualKernelLen
)paren
suffix:semicolon
id|round
op_assign
id|actualKernelLen
op_mod
l_int|4096
suffix:semicolon
id|roundedKernelLen
op_assign
id|actualKernelLen
suffix:semicolon
r_if
c_cond
(paren
id|round
)paren
id|roundedKernelLen
op_add_assign
(paren
l_int|4096
op_minus
id|round
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;actual kernel length rounded up to a 4k multiple = %ld&bslash;n&quot;
comma
id|roundedKernelLen
)paren
suffix:semicolon
id|ramStartOffs
op_assign
id|roundedKernelLen
suffix:semicolon
id|ramPages
op_assign
id|ramLen
op_div
l_int|4096
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;System map pages to copy = %ld&bslash;n&quot;
comma
id|ramPages
)paren
suffix:semicolon
singleline_comment|// Copy 64K ELF header
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|ElfPages
)paren
suffix:semicolon
op_increment
id|i
)paren
(brace
id|get4k
c_func
(paren
id|inputVmlinux
comma
id|inbuf
)paren
suffix:semicolon
id|put4k
c_func
(paren
id|outputVmlinux
comma
id|inbuf
)paren
suffix:semicolon
)brace
id|roundedKernelPages
op_assign
id|roundedKernelLen
op_div
l_int|4096
suffix:semicolon
id|fseek
c_func
(paren
id|inputVmlinux
comma
id|ElfHeaderSize
comma
id|SEEK_SET
)paren
suffix:semicolon
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|roundedKernelPages
suffix:semicolon
op_increment
id|i
)paren
(brace
id|get4k
c_func
(paren
id|inputVmlinux
comma
id|inbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
r_int
r_int
op_star
id|p
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;Storing embedded_sysmap_start at 0x3c&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
id|inbuf
op_plus
l_int|0x3c
)paren
suffix:semicolon
macro_line|#if (BYTE_ORDER == __BIG_ENDIAN)
op_star
id|p
op_assign
id|ramStartOffs
suffix:semicolon
macro_line|#else
op_star
id|p
op_assign
id|bswap_32
c_func
(paren
id|ramStartOffs
)paren
suffix:semicolon
macro_line|#endif
id|printf
c_func
(paren
l_string|&quot;Storing embedded_sysmap_end at 0x44&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
id|inbuf
op_plus
l_int|0x44
)paren
suffix:semicolon
macro_line|#if (BYTE_ORDER == __BIG_ENDIAN)
op_star
id|p
op_assign
id|ramStartOffs
op_plus
id|ramFileLen
suffix:semicolon
macro_line|#else
op_star
id|p
op_assign
id|bswap_32
c_func
(paren
id|ramStartOffs
op_plus
id|ramFileLen
)paren
suffix:semicolon
macro_line|#endif
)brace
id|put4k
c_func
(paren
id|outputVmlinux
comma
id|inbuf
)paren
suffix:semicolon
)brace
)brace
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ramPages
suffix:semicolon
op_increment
id|i
)paren
(brace
id|get4k
c_func
(paren
id|ramDisk
comma
id|inbuf
)paren
suffix:semicolon
id|put4k
c_func
(paren
id|outputVmlinux
comma
id|inbuf
)paren
suffix:semicolon
)brace
)brace
id|fclose
c_func
(paren
id|ramDisk
)paren
suffix:semicolon
id|fclose
c_func
(paren
id|inputVmlinux
)paren
suffix:semicolon
id|fclose
c_func
(paren
id|outputVmlinux
)paren
suffix:semicolon
multiline_comment|/* Set permission to executable */
id|chmod
c_func
(paren
id|argv
(braket
l_int|3
)braket
comma
id|S_IRUSR
op_or
id|S_IWUSR
op_or
id|S_IXUSR
op_or
id|S_IRGRP
op_or
id|S_IXGRP
op_or
id|S_IROTH
op_or
id|S_IXOTH
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
