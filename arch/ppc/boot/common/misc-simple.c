multiline_comment|/*&n; * arch/ppc/common/misc-simple.c&n; *&n; * Misc. bootloader code for many machines.  This assumes you have are using&n; * a 6xx/7xx/74xx CPU in your machine.  This assumes the chunk of memory&n; * below 8MB is free.  Finally, it assumes you have a NS16550-style uart for &n; * your serial console.  If a machine meets these requirements, it can quite&n; * likely use this code during boot.&n; * &n; * Author: Matt Porter &lt;mporter@mvista.com&gt;&n; * Derived from arch/ppc/boot/prep/misc.c&n; *&n; * Copyright 2001 MontaVista Software Inc.&n; *&n; * This program is free software; you can redistribute  it and/or modify it&n; * under  the terms of  the GNU General  Public License as published by the&n; * Free Software Foundation;  either version 2 of the  License, or (at your&n; * option) any later version.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/elf.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/mmu.h&gt;
macro_line|#include &quot;zlib.h&quot;
DECL|variable|com_port
r_int
r_int
id|com_port
suffix:semicolon
DECL|variable|avail_ram
r_char
op_star
id|avail_ram
suffix:semicolon
DECL|variable|end_avail
r_char
op_star
id|end_avail
suffix:semicolon
r_extern
r_char
id|_end
(braket
)braket
suffix:semicolon
macro_line|#ifdef CONFIG_CMDLINE
DECL|macro|CMDLINE
mdefine_line|#define CMDLINE CONFIG_CMDLINE
macro_line|#else
DECL|macro|CMDLINE
mdefine_line|#define CMDLINE &quot;&quot;
macro_line|#endif
DECL|variable|cmd_preset
r_char
id|cmd_preset
(braket
)braket
op_assign
id|CMDLINE
suffix:semicolon
DECL|variable|cmd_buf
r_char
id|cmd_buf
(braket
l_int|256
)braket
suffix:semicolon
DECL|variable|cmd_line
r_char
op_star
id|cmd_line
op_assign
id|cmd_buf
suffix:semicolon
DECL|variable|initrd_start
DECL|variable|initrd_end
r_int
r_int
id|initrd_start
op_assign
l_int|0
comma
id|initrd_end
op_assign
l_int|0
suffix:semicolon
DECL|variable|zimage_start
r_char
op_star
id|zimage_start
suffix:semicolon
DECL|variable|zimage_size
r_int
id|zimage_size
suffix:semicolon
r_extern
r_void
id|puts
c_func
(paren
r_const
r_char
op_star
)paren
suffix:semicolon
r_extern
r_void
id|putc
c_func
(paren
r_const
r_char
id|c
)paren
suffix:semicolon
r_extern
r_void
id|puthex
c_func
(paren
r_int
r_int
id|val
)paren
suffix:semicolon
r_extern
r_void
op_star
id|memcpy
c_func
(paren
r_void
op_star
id|__dest
comma
id|__const
r_void
op_star
id|__src
comma
id|__kernel_size_t
id|__n
)paren
suffix:semicolon
r_extern
r_void
id|gunzip
c_func
(paren
r_void
op_star
comma
r_int
comma
r_int
r_char
op_star
comma
r_int
op_star
)paren
suffix:semicolon
r_extern
r_void
id|udelay
c_func
(paren
r_int
id|delay
)paren
suffix:semicolon
r_extern
r_int
id|tstc
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_int
id|getc
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_volatile
r_int
r_int
id|serial_init
c_func
(paren
r_int
id|chan
)paren
suffix:semicolon
r_void
DECL|function|decompress_kernel
id|decompress_kernel
c_func
(paren
r_int
r_int
id|load_addr
comma
r_int
id|num_words
comma
r_int
r_int
id|cksum
)paren
(brace
r_int
id|timer
op_assign
l_int|0
suffix:semicolon
r_extern
r_int
r_int
id|start
suffix:semicolon
r_char
op_star
id|cp
comma
id|ch
suffix:semicolon
id|com_port
op_assign
id|serial_init
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* assume the chunk below 8M is free */
id|end_avail
op_assign
(paren
r_char
op_star
)paren
l_int|0x00800000
suffix:semicolon
multiline_comment|/*&n;&t; * Reveal where we were loaded at and where we&n;&t; * were relocated to.&n;&t; */
id|puts
c_func
(paren
l_string|&quot;loaded at:     &quot;
)paren
suffix:semicolon
id|puthex
c_func
(paren
id|load_addr
)paren
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
id|puthex
c_func
(paren
(paren
r_int
r_int
)paren
(paren
id|load_addr
op_plus
(paren
l_int|4
op_star
id|num_words
)paren
)paren
)paren
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|load_addr
op_ne
(paren
r_int
r_int
)paren
op_amp
id|start
)paren
(brace
id|puts
c_func
(paren
l_string|&quot;relocated to:  &quot;
)paren
suffix:semicolon
id|puthex
c_func
(paren
(paren
r_int
r_int
)paren
op_amp
id|start
)paren
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
id|puthex
c_func
(paren
(paren
r_int
r_int
)paren
(paren
(paren
r_int
r_int
)paren
op_amp
id|start
op_plus
(paren
l_int|4
op_star
id|num_words
)paren
)paren
)paren
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* we have to subtract 0x10000 here to correct for objdump including&n;&t;   the size of the elf header which we strip -- Cort */
id|zimage_start
op_assign
(paren
r_char
op_star
)paren
(paren
id|load_addr
op_minus
l_int|0x10000
op_plus
id|ZIMAGE_OFFSET
)paren
suffix:semicolon
id|zimage_size
op_assign
id|ZIMAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|INITRD_OFFSET
)paren
id|initrd_start
op_assign
id|load_addr
op_minus
l_int|0x10000
op_plus
id|INITRD_OFFSET
suffix:semicolon
r_else
id|initrd_start
op_assign
l_int|0
suffix:semicolon
id|initrd_end
op_assign
id|INITRD_SIZE
op_plus
id|initrd_start
suffix:semicolon
multiline_comment|/*&n;&t; * Find a place to stick the zimage and initrd and &n;&t; * relocate them if we have to. -- Cort&n;&t; */
id|avail_ram
op_assign
(paren
r_char
op_star
)paren
id|PAGE_ALIGN
c_func
(paren
(paren
r_int
r_int
)paren
id|_end
)paren
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot;zimage at:     &quot;
)paren
suffix:semicolon
id|puthex
c_func
(paren
(paren
r_int
r_int
)paren
id|zimage_start
)paren
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
id|puthex
c_func
(paren
(paren
r_int
r_int
)paren
(paren
id|zimage_size
op_plus
id|zimage_start
)paren
)paren
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|zimage_start
op_le
l_int|0x00800000
)paren
(brace
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|avail_ram
comma
(paren
r_void
op_star
)paren
id|zimage_start
comma
id|zimage_size
)paren
suffix:semicolon
id|zimage_start
op_assign
(paren
r_char
op_star
)paren
id|avail_ram
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot;relocated to:  &quot;
)paren
suffix:semicolon
id|puthex
c_func
(paren
(paren
r_int
r_int
)paren
id|zimage_start
)paren
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
id|puthex
c_func
(paren
(paren
r_int
r_int
)paren
id|zimage_size
op_plus
(paren
r_int
r_int
)paren
id|zimage_start
)paren
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* relocate initrd */
r_if
c_cond
(paren
id|initrd_start
)paren
(brace
id|puts
c_func
(paren
l_string|&quot;initrd at:     &quot;
)paren
suffix:semicolon
id|puthex
c_func
(paren
id|initrd_start
)paren
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
id|puthex
c_func
(paren
id|initrd_end
)paren
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|avail_ram
op_assign
(paren
r_char
op_star
)paren
id|PAGE_ALIGN
c_func
(paren
(paren
r_int
r_int
)paren
id|zimage_size
op_plus
(paren
r_int
r_int
)paren
id|zimage_start
)paren
suffix:semicolon
id|memcpy
(paren
(paren
r_void
op_star
)paren
id|avail_ram
comma
(paren
r_void
op_star
)paren
id|initrd_start
comma
id|INITRD_SIZE
)paren
suffix:semicolon
id|initrd_start
op_assign
(paren
r_int
r_int
)paren
id|avail_ram
suffix:semicolon
id|initrd_end
op_assign
id|initrd_start
op_plus
id|INITRD_SIZE
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot;relocated to:  &quot;
)paren
suffix:semicolon
id|puthex
c_func
(paren
id|initrd_start
)paren
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
id|puthex
c_func
(paren
id|initrd_end
)paren
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|initrd_start
)paren
(brace
id|puts
c_func
(paren
l_string|&quot;initrd at:     &quot;
)paren
suffix:semicolon
id|puthex
c_func
(paren
id|initrd_start
)paren
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
id|puthex
c_func
(paren
id|initrd_end
)paren
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|avail_ram
op_assign
(paren
r_char
op_star
)paren
l_int|0x00400000
suffix:semicolon
id|end_avail
op_assign
(paren
r_char
op_star
)paren
l_int|0x00800000
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot;avail ram:     &quot;
)paren
suffix:semicolon
id|puthex
c_func
(paren
(paren
r_int
r_int
)paren
id|avail_ram
)paren
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
id|puthex
c_func
(paren
(paren
r_int
r_int
)paren
id|end_avail
)paren
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Display standard Linux/PPC boot prompt for kernel args */
id|puts
c_func
(paren
l_string|&quot;&bslash;nLinux/PPC load: &quot;
)paren
suffix:semicolon
id|cp
op_assign
id|cmd_line
suffix:semicolon
id|memcpy
(paren
id|cmd_line
comma
id|cmd_preset
comma
r_sizeof
(paren
id|cmd_preset
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|cp
)paren
id|putc
c_func
(paren
op_star
id|cp
op_increment
)paren
suffix:semicolon
r_while
c_loop
(paren
id|timer
op_increment
OL
l_int|5
op_star
l_int|1000
)paren
(brace
r_if
c_cond
(paren
id|tstc
c_func
(paren
)paren
)paren
(brace
r_while
c_loop
(paren
(paren
id|ch
op_assign
id|getc
c_func
(paren
)paren
)paren
op_ne
l_char|&squot;&bslash;n&squot;
op_logical_and
id|ch
op_ne
l_char|&squot;&bslash;r&squot;
)paren
(brace
multiline_comment|/* Test for backspace/delete */
r_if
c_cond
(paren
id|ch
op_eq
l_char|&squot;&bslash;b&squot;
op_logical_or
id|ch
op_eq
l_char|&squot;&bslash;177&squot;
)paren
(brace
r_if
c_cond
(paren
id|cp
op_ne
id|cmd_line
)paren
(brace
id|cp
op_decrement
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot;&bslash;b &bslash;b&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Test for ^x/^u (and wipe the line) */
)brace
r_else
r_if
c_cond
(paren
id|ch
op_eq
l_char|&squot;&bslash;030&squot;
op_logical_or
id|ch
op_eq
l_char|&squot;&bslash;025&squot;
)paren
(brace
r_while
c_loop
(paren
id|cp
op_ne
id|cmd_line
)paren
(brace
id|cp
op_decrement
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot;&bslash;b &bslash;b&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
op_star
id|cp
op_increment
op_assign
id|ch
suffix:semicolon
id|putc
c_func
(paren
id|ch
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
multiline_comment|/* Exit &squot;timer&squot; loop */
)brace
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* 1 msec */
)brace
op_star
id|cp
op_assign
l_int|0
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* mappings on early boot can only handle 16M */
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|cmd_line
(braket
l_int|0
)braket
)paren
OG
(paren
l_int|16
op_lshift
l_int|20
)paren
)paren
id|puts
c_func
(paren
l_string|&quot;cmd_line located &gt; 16M&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|initrd_start
OG
(paren
l_int|16
op_lshift
l_int|20
)paren
)paren
id|puts
c_func
(paren
l_string|&quot;initrd_start located &gt; 16M&bslash;n&quot;
)paren
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot;Uncompressing Linux...&quot;
)paren
suffix:semicolon
id|gunzip
c_func
(paren
l_int|0
comma
l_int|0x400000
comma
id|zimage_start
comma
op_amp
id|zimage_size
)paren
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot;done.&bslash;n&quot;
)paren
suffix:semicolon
id|puts
c_func
(paren
l_string|&quot;Now booting the kernel&bslash;n&quot;
)paren
suffix:semicolon
)brace
eof
