multiline_comment|/*&n; * BK Id: SCCS/s.ns16550.c 1.7 05/18/01 06:20:29 patch&n; */
multiline_comment|/*&n; * COM1 NS16550 support&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/serialP.h&gt;
macro_line|#include &lt;linux/serial_reg.h&gt;
macro_line|#include &lt;asm/serial.h&gt;
multiline_comment|/* Some machines, such as ones with a PReP memory map, initally have&n; * their serial port at an offset of 0x80000000 from where they are&n; * in &lt;asm/serial.h&gt;.  This tries to take that into account. */
macro_line|#ifndef IOOFFSET
DECL|macro|IOOFFSET
mdefine_line|#define IOOFFSET 0
macro_line|#endif
DECL|variable|rs_table
r_static
r_struct
id|serial_state
id|rs_table
(braket
id|RS_TABLE_SIZE
)braket
op_assign
(brace
id|SERIAL_PORT_DFNS
multiline_comment|/* Defined in &lt;asm/serial.h&gt; */
)brace
suffix:semicolon
DECL|variable|shift
r_static
r_int
id|shift
suffix:semicolon
DECL|function|serial_init
r_volatile
r_int
r_int
id|serial_init
c_func
(paren
r_int
id|chan
)paren
(brace
r_int
r_int
id|com_port
suffix:semicolon
multiline_comment|/* Get the base, and add any offset we need to deal with. */
id|com_port
op_assign
id|rs_table
(braket
id|chan
)braket
dot
id|port
op_plus
id|IOOFFSET
suffix:semicolon
multiline_comment|/* How far apart the registers are. */
id|shift
op_assign
id|rs_table
(braket
id|chan
)braket
dot
id|iomem_reg_shift
suffix:semicolon
multiline_comment|/* See if port is present */
op_star
(paren
(paren
r_int
r_char
op_star
)paren
id|com_port
op_plus
(paren
id|UART_LCR
op_lshift
id|shift
)paren
)paren
op_assign
l_int|0x00
suffix:semicolon
op_star
(paren
(paren
r_int
r_char
op_star
)paren
id|com_port
op_plus
(paren
id|UART_IER
op_lshift
id|shift
)paren
)paren
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Access baud rate */
op_star
(paren
(paren
r_int
r_char
op_star
)paren
id|com_port
op_plus
(paren
id|UART_LCR
op_lshift
id|shift
)paren
)paren
op_assign
l_int|0x00
suffix:semicolon
macro_line|#ifdef CONFIG_SERIAL_CONSOLE_NONSTD
multiline_comment|/* Input clock. */
op_star
(paren
(paren
r_int
r_char
op_star
)paren
id|com_port
op_plus
(paren
id|UART_DLL
op_lshift
id|shift
)paren
)paren
op_assign
(paren
id|BASE_BAUD
op_div
id|CONFIG_SERIAL_CONSOLE_BAUD
)paren
suffix:semicolon
op_star
(paren
(paren
r_int
r_char
op_star
)paren
id|com_port
op_plus
(paren
id|UART_DLM
op_lshift
id|shift
)paren
)paren
op_assign
(paren
id|BASE_BAUD
op_div
id|CONFIG_SERIAL_CONSOLE_BAUD
)paren
op_rshift
l_int|8
suffix:semicolon
macro_line|#endif
multiline_comment|/* 8 data, 1 stop, no parity */
op_star
(paren
(paren
r_int
r_char
op_star
)paren
id|com_port
op_plus
(paren
id|UART_LCR
op_lshift
id|shift
)paren
)paren
op_assign
l_int|0x03
suffix:semicolon
multiline_comment|/* RTS/DTR */
op_star
(paren
(paren
r_int
r_char
op_star
)paren
id|com_port
op_plus
(paren
id|UART_MCR
op_lshift
id|shift
)paren
)paren
op_assign
l_int|0x03
suffix:semicolon
multiline_comment|/* Clear &amp; enable FIFOs */
op_star
(paren
(paren
r_int
r_char
op_star
)paren
id|com_port
op_plus
(paren
id|UART_FCR
op_lshift
id|shift
)paren
)paren
op_assign
l_int|0x07
suffix:semicolon
r_return
(paren
id|com_port
)paren
suffix:semicolon
)brace
r_void
DECL|function|serial_putc
id|serial_putc
c_func
(paren
r_volatile
r_int
r_int
id|com_port
comma
r_int
r_char
id|c
)paren
(brace
r_while
c_loop
(paren
(paren
op_star
(paren
(paren
r_volatile
r_int
r_char
op_star
)paren
id|com_port
op_plus
(paren
id|UART_LSR
op_lshift
id|shift
)paren
)paren
op_amp
id|UART_LSR_THRE
)paren
op_eq
l_int|0
)paren
suffix:semicolon
op_star
(paren
r_volatile
r_int
r_char
op_star
)paren
id|com_port
op_assign
id|c
suffix:semicolon
)brace
r_int
r_char
DECL|function|serial_getc
id|serial_getc
c_func
(paren
r_volatile
r_int
r_int
id|com_port
)paren
(brace
r_while
c_loop
(paren
(paren
op_star
(paren
(paren
r_volatile
r_int
r_char
op_star
)paren
id|com_port
op_plus
(paren
id|UART_LSR
op_lshift
id|shift
)paren
)paren
op_amp
id|UART_LSR_DR
)paren
op_eq
l_int|0
)paren
suffix:semicolon
r_return
(paren
op_star
(paren
r_volatile
r_int
r_char
op_star
)paren
id|com_port
)paren
suffix:semicolon
)brace
r_int
DECL|function|serial_tstc
id|serial_tstc
c_func
(paren
r_volatile
r_int
r_int
id|com_port
)paren
(brace
r_return
(paren
(paren
op_star
(paren
(paren
r_volatile
r_int
r_char
op_star
)paren
id|com_port
op_plus
(paren
id|UART_LSR
op_lshift
id|shift
)paren
)paren
op_amp
id|UART_LSR_DR
)paren
op_ne
l_int|0
)paren
suffix:semicolon
)brace
eof
