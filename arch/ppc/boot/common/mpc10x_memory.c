multiline_comment|/*&n; * arch/ppc/boot/common/mpc10x_common.c&n; *&n; * A routine to find out how much memory the machine has.&n; *&n; * Based on:&n; * arch/ppc/kernel/mpc10x_common.c&n; *&n; * Author: Mark A. Greer&n; *         mgreer@mvista.com&n; *&n; * 2001-2002 (c) MontaVista, Software, Inc.  This file is licensed under&n; * the terms of the GNU General Public License version 2.  This program&n; * is licensed &quot;as is&quot; without any warranty of any kind, whether express&n; * or implied.&n; */
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/types.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;mpc10x.h&quot;
multiline_comment|/*&n; * *** WARNING - A BAT MUST be set to access the PCI config addr/data regs ***&n; */
multiline_comment|/*&n; * PCI config space macros, similar to indirect_xxx and early_xxx macros.&n; * We assume bus 0.&n; */
DECL|macro|MPC10X_CFG_read
mdefine_line|#define MPC10X_CFG_read(val, addr, type, op)&t;*val = op((type)(addr))
DECL|macro|MPC10X_CFG_write
mdefine_line|#define MPC10X_CFG_write(val, addr, type, op)&t;op((type *)(addr), (val))
DECL|macro|MPC10X_PCI_OP
mdefine_line|#define MPC10X_PCI_OP(rw, size, type, op, mask)&t;&t;&t; &t;&bslash;&n;static void&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;mpc10x_##rw##_config_##size(unsigned int *cfg_addr, &t;&t;&t;&bslash;&n;&t;&t;unsigned int *cfg_data, int devfn, int offset,&t;&t;&bslash;&n;&t;&t;type val)&t;&t;&t;&t;&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;out_be32(cfg_addr, &t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t; ((offset &amp; 0xfc) &lt;&lt; 24) | (devfn &lt;&lt; 16)&t;&t;&bslash;&n;&t;&t; | (0 &lt;&lt; 8) | 0x80);&t;&t;&t;&t;&t;&bslash;&n;&t;MPC10X_CFG_##rw(val, cfg_data + (offset &amp; mask), type, op);&t;&bslash;&n;&t;return;    &t;&t;&t;&t;&t; &t;&t;&bslash;&n;}
id|MPC10X_PCI_OP
c_func
(paren
id|read
comma
id|byte
comma
id|u8
op_star
comma
id|in_8
comma
l_int|3
)paren
id|MPC10X_PCI_OP
c_func
(paren
id|read
comma
id|dword
comma
id|u32
op_star
comma
id|in_le32
comma
l_int|0
)paren
multiline_comment|/*&n; * Read the memory controller registers to determine the amount of memory in&n; * the system.  This assumes that the firmware has correctly set up the memory&n; * controller registers.  On CONFIG_PPC_PREP, we know we are being called&n; * under a PReP memory map. On all other machines, we assume we are under&n; * a CHRP memory map.&n; */
r_int
r_int
DECL|function|get_mem_size
id|get_mem_size
c_func
(paren
r_void
)paren
(brace
r_int
r_int
op_star
id|config_addr
comma
op_star
id|config_data
comma
id|val
suffix:semicolon
r_int
r_int
id|start
comma
id|end
comma
id|total
comma
id|offset
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_char
id|bank_enables
suffix:semicolon
macro_line|#ifdef CONFIG_PPC_PREP
id|config_addr
op_assign
(paren
r_int
r_int
op_star
)paren
id|MPC10X_MAPA_CNFG_ADDR
suffix:semicolon
id|config_data
op_assign
(paren
r_int
r_int
op_star
)paren
id|MPC10X_MAPA_CNFG_DATA
suffix:semicolon
macro_line|#else
id|config_addr
op_assign
(paren
r_int
r_int
op_star
)paren
id|MPC10X_MAPB_CNFG_ADDR
suffix:semicolon
id|config_data
op_assign
(paren
r_int
r_int
op_star
)paren
id|MPC10X_MAPB_CNFG_DATA
suffix:semicolon
macro_line|#endif
id|mpc10x_read_config_byte
c_func
(paren
id|config_addr
comma
id|config_data
comma
id|PCI_DEVFN
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
id|MPC10X_MCTLR_MEM_BANK_ENABLES
comma
op_amp
id|bank_enables
)paren
suffix:semicolon
id|total
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|bank_enables
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
id|offset
op_assign
id|MPC10X_MCTLR_MEM_START_1
op_plus
(paren
(paren
id|i
OG
l_int|3
)paren
ques
c_cond
l_int|4
suffix:colon
l_int|0
)paren
suffix:semicolon
id|mpc10x_read_config_dword
c_func
(paren
id|config_addr
comma
id|config_data
comma
id|PCI_DEVFN
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
id|offset
comma
op_amp
id|val
)paren
suffix:semicolon
id|start
op_assign
(paren
id|val
op_rshift
(paren
(paren
id|i
op_amp
l_int|3
)paren
op_lshift
l_int|3
)paren
)paren
op_amp
l_int|0xff
suffix:semicolon
id|offset
op_assign
id|MPC10X_MCTLR_EXT_MEM_START_1
op_plus
(paren
(paren
id|i
OG
l_int|3
)paren
ques
c_cond
l_int|4
suffix:colon
l_int|0
)paren
suffix:semicolon
id|mpc10x_read_config_dword
c_func
(paren
id|config_addr
comma
id|config_data
comma
id|PCI_DEVFN
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
id|offset
comma
op_amp
id|val
)paren
suffix:semicolon
id|val
op_assign
(paren
id|val
op_rshift
(paren
(paren
id|i
op_amp
l_int|3
)paren
op_lshift
l_int|3
)paren
)paren
op_amp
l_int|0x03
suffix:semicolon
id|start
op_assign
(paren
id|val
op_lshift
l_int|28
)paren
op_or
(paren
id|start
op_lshift
l_int|20
)paren
suffix:semicolon
id|offset
op_assign
id|MPC10X_MCTLR_MEM_END_1
op_plus
(paren
(paren
id|i
OG
l_int|3
)paren
ques
c_cond
l_int|4
suffix:colon
l_int|0
)paren
suffix:semicolon
id|mpc10x_read_config_dword
c_func
(paren
id|config_addr
comma
id|config_data
comma
id|PCI_DEVFN
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
id|offset
comma
op_amp
id|val
)paren
suffix:semicolon
id|end
op_assign
(paren
id|val
op_rshift
(paren
(paren
id|i
op_amp
l_int|3
)paren
op_lshift
l_int|3
)paren
)paren
op_amp
l_int|0xff
suffix:semicolon
id|offset
op_assign
id|MPC10X_MCTLR_EXT_MEM_END_1
op_plus
(paren
(paren
id|i
OG
l_int|3
)paren
ques
c_cond
l_int|4
suffix:colon
l_int|0
)paren
suffix:semicolon
id|mpc10x_read_config_dword
c_func
(paren
id|config_addr
comma
id|config_data
comma
id|PCI_DEVFN
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
id|offset
comma
op_amp
id|val
)paren
suffix:semicolon
id|val
op_assign
(paren
id|val
op_rshift
(paren
(paren
id|i
op_amp
l_int|3
)paren
op_lshift
l_int|3
)paren
)paren
op_amp
l_int|0x03
suffix:semicolon
id|end
op_assign
(paren
id|val
op_lshift
l_int|28
)paren
op_or
(paren
id|end
op_lshift
l_int|20
)paren
op_or
l_int|0xfffff
suffix:semicolon
id|total
op_add_assign
(paren
id|end
op_minus
id|start
op_plus
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_return
id|total
suffix:semicolon
)brace
eof
