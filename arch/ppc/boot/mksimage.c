multiline_comment|/*&n; *&n; *&n; *&n; *&n; */
macro_line|#include &lt;stdio.h&gt;
macro_line|#include &lt;string.h&gt;
macro_line|#include &lt;stdlib.h&gt;
macro_line|#include &lt;stdarg.h&gt;
macro_line|#include &lt;sys/types.h&gt;
macro_line|#include &lt;fcntl.h&gt;
macro_line|#include &lt;unistd.h&gt;
macro_line|#include &lt;errno.h&gt;
DECL|macro|SIZE
mdefine_line|#define SIZE 1024
DECL|macro|BLOCK_ALIGN
mdefine_line|#define BLOCK_ALIGN(x)  (((x)+SIZE-1)&amp;(~(SIZE-1)))
r_static
r_void
DECL|function|die
id|die
c_func
(paren
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
id|va_list
id|args
suffix:semicolon
id|va_start
c_func
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|vfprintf
c_func
(paren
id|stderr
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|fputc
c_func
(paren
l_char|&squot;&bslash;n&squot;
comma
id|stderr
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|usage
id|usage
c_func
(paren
r_void
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;Usage: mkbinimg &lt;bootstrap&gt; &lt;kernel&gt; &lt;ramdisk&gt; -o &lt;binary&gt;&bslash;n&quot;
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|copy_blocks
id|copy_blocks
c_func
(paren
r_int
id|ifd
comma
r_int
id|ofd
comma
r_int
r_int
op_star
id|offset
comma
r_int
r_int
op_star
id|size
)paren
(brace
id|off_t
id|cur
suffix:semicolon
r_int
id|amt
suffix:semicolon
r_int
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_char
id|buffer
(braket
id|SIZE
)braket
suffix:semicolon
id|cur
op_assign
id|lseek
c_func
(paren
id|ofd
comma
l_int|0
comma
id|SEEK_CUR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cur
op_mod
id|SIZE
)paren
(brace
id|cur
op_assign
id|BLOCK_ALIGN
c_func
(paren
id|cur
)paren
suffix:semicolon
id|cur
op_assign
id|lseek
c_func
(paren
id|ofd
comma
id|cur
comma
id|SEEK_SET
)paren
suffix:semicolon
)brace
op_star
id|offset
op_assign
(paren
r_int
r_int
)paren
id|cur
suffix:semicolon
r_while
c_loop
(paren
(paren
id|amt
op_assign
id|read
c_func
(paren
id|ifd
comma
id|buffer
comma
id|SIZE
)paren
)paren
OG
l_int|0
)paren
(brace
id|write
c_func
(paren
id|ofd
comma
id|buffer
comma
id|amt
)paren
suffix:semicolon
id|len
op_add_assign
id|amt
suffix:semicolon
)brace
op_star
id|size
op_assign
id|len
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|main
id|main
c_func
(paren
r_int
id|argc
comma
r_char
op_star
id|argv
(braket
)braket
)paren
(brace
r_char
op_star
id|kernel
comma
op_star
id|loader
comma
op_star
id|rdimage
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|ld_off
comma
id|kern_off
comma
id|rd_off
suffix:semicolon
r_int
r_int
id|ld_size
comma
id|kern_size
comma
id|rd_size
suffix:semicolon
r_int
id|fd
comma
id|ofd
comma
id|len
suffix:semicolon
r_char
id|buffer
(braket
l_int|500
)braket
suffix:semicolon
r_if
c_cond
(paren
id|argc
OL
l_int|5
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
id|argv
(braket
id|argc
op_minus
l_int|2
)braket
comma
l_string|&quot;-o&quot;
)paren
)paren
id|usage
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|argc
OG
l_int|5
)paren
id|rdimage
op_assign
id|argv
(braket
l_int|3
)braket
suffix:semicolon
id|kernel
op_assign
id|argv
(braket
l_int|2
)braket
suffix:semicolon
id|loader
op_assign
id|argv
(braket
l_int|1
)braket
suffix:semicolon
id|ofd
op_assign
id|open
c_func
(paren
id|argv
(braket
id|argc
op_minus
l_int|1
)braket
comma
(paren
id|O_RDWR
op_or
id|O_CREAT
)paren
comma
l_int|0755
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ofd
OL
l_int|0
)paren
(brace
id|die
c_func
(paren
l_string|&quot;can&squot;t open %s: %s&quot;
comma
id|argv
(braket
l_int|5
)braket
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
)brace
id|ld_off
op_assign
id|kern_off
op_assign
id|rd_off
op_assign
l_int|0
suffix:semicolon
id|ld_size
op_assign
id|kern_size
op_assign
id|rd_size
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|buffer
comma
l_int|0
comma
l_int|500
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|fd
op_assign
id|open
c_func
(paren
id|loader
comma
id|O_RDONLY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
OL
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;can&squot;t open loader: %s&quot;
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
id|copy_blocks
c_func
(paren
id|fd
comma
id|ofd
comma
op_amp
id|ld_off
comma
op_amp
id|ld_size
)paren
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;bootloader: %x %x&bslash;n&quot;
comma
id|ld_off
comma
id|ld_size
)paren
suffix:semicolon
id|close
c_func
(paren
id|fd
)paren
suffix:semicolon
id|fd
op_assign
id|open
c_func
(paren
id|kernel
comma
id|O_RDONLY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
OL
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;can&squot;t open kernel: %s&quot;
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
id|copy_blocks
c_func
(paren
id|fd
comma
id|ofd
comma
op_amp
id|kern_off
comma
op_amp
id|kern_size
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;zimage: %x %x&bslash;n&quot;
comma
id|kern_off
comma
id|kern_size
)paren
suffix:semicolon
id|close
c_func
(paren
id|fd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rdimage
)paren
(brace
id|fd
op_assign
id|open
c_func
(paren
id|rdimage
comma
id|O_RDONLY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
OL
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;can&squot;t get ramdisk: %s&quot;
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
id|copy_blocks
c_func
(paren
id|fd
comma
id|ofd
comma
op_amp
id|rd_off
comma
op_amp
id|rd_size
)paren
suffix:semicolon
id|close
c_func
(paren
id|fd
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;initrd: %x %x&quot;
comma
id|rd_off
comma
id|rd_size
)paren
suffix:semicolon
id|close
c_func
(paren
id|ofd
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|buffer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
