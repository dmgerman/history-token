macro_line|#ifndef __HEAD_BOOKE_H__
DECL|macro|__HEAD_BOOKE_H__
mdefine_line|#define __HEAD_BOOKE_H__
multiline_comment|/*&n; * Macros used for common Book-e exception handling&n; */
DECL|macro|SET_IVOR
mdefine_line|#define SET_IVOR(vector_number, vector_label)&t;&t;&bslash;&n;&t;&t;li&t;r26,vector_label@l; &t;&t;&bslash;&n;&t;&t;mtspr&t;SPRN_IVOR##vector_number,r26;&t;&bslash;&n;&t;&t;sync
DECL|macro|NORMAL_EXCEPTION_PROLOG
mdefine_line|#define NORMAL_EXCEPTION_PROLOG&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;mtspr&t;SPRN_SPRG0,r10;&t;&t;/* save two registers to work with */&bslash;&n;&t;mtspr&t;SPRN_SPRG1,r11;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;mtspr&t;SPRN_SPRG4W,r1;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;mfcr&t;r10;&t;&t;&t;/* save CR in r10 for now&t;   */&bslash;&n;&t;mfspr&t;r11,SPRN_SRR1;&t;&t;/* check whether user or kernel    */&bslash;&n;&t;andi.&t;r11,r11,MSR_PR;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;beq&t;1f;&t;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r1,SPRG3;&t;&t;/* if from user, start at top of   */&bslash;&n;&t;lwz&t;r1,THREAD_INFO-THREAD(r1); /* this thread&squot;s kernel stack   */&bslash;&n;&t;addi&t;r1,r1,THREAD_SIZE;&t;&t;&t;&t;&t;     &bslash;&n;1:&t;subi&t;r1,r1,INT_FRAME_SIZE;&t;/* Allocate an exception frame     */&bslash;&n;&t;tophys(r11,r1);&t;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,_CCR(r11);          /* save various registers&t;   */&bslash;&n;&t;stw&t;r12,GPR12(r11);&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r9,GPR9(r11);&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r10,SPRG0;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,GPR10(r11);&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r12,SPRG1;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r12,GPR11(r11);&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;mflr&t;r10;&t;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,_LINK(r11);&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r10,SPRG4R;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r12,SRR0;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,GPR1(r11);&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r9,SRR1;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,0(r11);&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;rlwinm&t;r9,r9,0,14,12;&t;&t;/* clear MSR_WE (necessary?)&t;   */&bslash;&n;&t;stw&t;r0,GPR0(r11);&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;SAVE_4GPRS(3, r11);&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;SAVE_2GPRS(7, r11)
multiline_comment|/*&n; * Exception prolog for critical exceptions.  This is a little different&n; * from the normal exception prolog above since a critical exception&n; * can potentially occur at any point during normal exception processing.&n; * Thus we cannot use the same SPRG registers as the normal prolog above.&n; * Instead we use a couple of words of memory at low physical addresses.&n; * This is OK since we don&squot;t support SMP on these processors. For Book E&n; * processors, we also have a reserved register (SPRG2) that is only used&n; * in critical exceptions so we can free up a GPR to use as the base for&n; * indirect access to the critical exception save area.  This is necessary&n; * since the MMU is always on and the save area is offset from KERNELBASE.&n; */
DECL|macro|CRITICAL_EXCEPTION_PROLOG
mdefine_line|#define CRITICAL_EXCEPTION_PROLOG&t;&t;&t;&t;&t;     &bslash;&n;&t;mtspr&t;SPRG2,r8;&t;&t;/* SPRG2 only used in criticals */   &bslash;&n;&t;lis&t;r8,crit_save@ha;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,crit_r10@l(r8);&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r11,crit_r11@l(r8);&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r10,SPRG0;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,crit_sprg0@l(r8);&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r10,SPRG1;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,crit_sprg1@l(r8);&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r10,SPRG4R;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,crit_sprg4@l(r8);&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r10,SPRG5R;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,crit_sprg5@l(r8);&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r10,SPRG7R;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,crit_sprg7@l(r8);&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r10,SPRN_PID;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,crit_pid@l(r8);&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r10,SRR0;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,crit_srr0@l(r8);&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r10,SRR1;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,crit_srr1@l(r8);&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r8,SPRG2;&t;&t;/* SPRG2 only used in criticals */   &bslash;&n;&t;mfcr&t;r10;&t;&t;&t;/* save CR in r10 for now&t;   */&bslash;&n;&t;mfspr&t;r11,SPRN_CSRR1;&t;&t;/* check whether user or kernel    */&bslash;&n;&t;andi.&t;r11,r11,MSR_PR;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;lis&t;r11,critical_stack_top@h;&t;&t;&t;&t;     &bslash;&n;&t;ori&t;r11,r11,critical_stack_top@l;&t;&t;&t;&t;     &bslash;&n;&t;beq&t;1f;&t;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;/* COMING FROM USER MODE */&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r11,SPRG3;&t;&t;/* if from user, start at top of   */&bslash;&n;&t;lwz&t;r11,THREAD_INFO-THREAD(r11); /* this thread&squot;s kernel stack */&bslash;&n;&t;addi&t;r11,r11,THREAD_SIZE;&t;&t;&t;&t;&t;     &bslash;&n;1:&t;subi&t;r11,r11,INT_FRAME_SIZE;&t;/* Allocate an exception frame     */&bslash;&n;&t;stw&t;r10,_CCR(r11);          /* save various registers&t;   */&bslash;&n;&t;stw&t;r12,GPR12(r11);&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r9,GPR9(r11);&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;mflr&t;r10;&t;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,_LINK(r11);&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r12,SPRN_DEAR;&t;&t;/* save DEAR and ESR in the frame  */&bslash;&n;&t;stw&t;r12,_DEAR(r11);&t;&t;/* since they may have had stuff   */&bslash;&n;&t;mfspr&t;r9,SPRN_ESR;&t;&t;/* in them at the point where the  */&bslash;&n;&t;stw&t;r9,_ESR(r11);&t;&t;/* exception was taken&t;&t;   */&bslash;&n;&t;mfspr&t;r12,CSRR0;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r1,GPR1(r11);&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r9,CSRR1;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r1,0(r11);&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;tovirt(r1,r11);&t;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;rlwinm&t;r9,r9,0,14,12;&t;&t;/* clear MSR_WE (necessary?)&t;   */&bslash;&n;&t;stw&t;r0,GPR0(r11);&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;SAVE_4GPRS(3, r11);&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;SAVE_2GPRS(7, r11)
multiline_comment|/*&n; * Exception prolog for machine check exceptions.  This is similar to&n; * the critical exception prolog, except that machine check exceptions&n; * have their own save area.  For Book E processors, we also have a&n; * reserved register (SPRG6) that is only used in machine check exceptions&n; * so we can free up a GPR to use as the base for indirect access to the&n; * machine check exception save area.  This is necessary since the MMU&n; * is always on and the save area is offset from KERNELBASE.&n; */
DECL|macro|MCHECK_EXCEPTION_PROLOG
mdefine_line|#define MCHECK_EXCEPTION_PROLOG&t;&t;&t;&t;&t;     &bslash;&n;&t;mtspr&t;SPRG6W,r8;&t;&t;/* SPRG6 used in machine checks */   &bslash;&n;&t;lis&t;r8,mcheck_save@ha;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,mcheck_r10@l(r8);&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r11,mcheck_r11@l(r8);&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r10,SPRG0;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,mcheck_sprg0@l(r8);&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r10,SPRG1;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,mcheck_sprg1@l(r8);&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r10,SPRG4R;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,mcheck_sprg4@l(r8);&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r10,SPRG5R;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,mcheck_sprg5@l(r8);&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r10,SPRG7R;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,mcheck_sprg7@l(r8);&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r10,SPRN_PID;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,mcheck_pid@l(r8);&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r10,SRR0;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,mcheck_srr0@l(r8);&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r10,SRR1;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,mcheck_srr1@l(r8);&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r10,CSRR0;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,mcheck_csrr0@l(r8);&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r10,CSRR1;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,mcheck_csrr1@l(r8);&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r8,SPRG6R;&t;&t;/* SPRG6 used in machine checks */   &bslash;&n;&t;mfcr&t;r10;&t;&t;&t;/* save CR in r10 for now&t;   */&bslash;&n;&t;mfspr&t;r11,SPRN_MCSRR1;&t;/* check whether user or kernel    */&bslash;&n;&t;andi.&t;r11,r11,MSR_PR;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;lis&t;r11,mcheck_stack_top@h;&t;&t;&t;&t;&t;     &bslash;&n;&t;ori&t;r11,r11,mcheck_stack_top@l;&t;&t;&t;&t;     &bslash;&n;&t;beq&t;1f;&t;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;/* COMING FROM USER MODE */&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r11,SPRG3;&t;&t;/* if from user, start at top of   */&bslash;&n;&t;lwz&t;r11,THREAD_INFO-THREAD(r11); /* this thread&squot;s kernel stack */&bslash;&n;&t;addi&t;r11,r11,THREAD_SIZE;&t;&t;&t;&t;&t;     &bslash;&n;1:&t;subi&t;r11,r11,INT_FRAME_SIZE;&t;/* Allocate an exception frame     */&bslash;&n;&t;stw&t;r10,_CCR(r11);          /* save various registers&t;   */&bslash;&n;&t;stw&t;r12,GPR12(r11);&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r9,GPR9(r11);&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;mflr&t;r10;&t;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r10,_LINK(r11);&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r12,SPRN_DEAR;&t;&t;/* save DEAR and ESR in the frame  */&bslash;&n;&t;stw&t;r12,_DEAR(r11);&t;&t;/* since they may have had stuff   */&bslash;&n;&t;mfspr&t;r9,SPRN_ESR;&t;&t;/* in them at the point where the  */&bslash;&n;&t;stw&t;r9,_ESR(r11);&t;&t;/* exception was taken&t;&t;   */&bslash;&n;&t;mfspr&t;r12,MCSRR0;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r1,GPR1(r11);&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;mfspr&t;r9,MCSRR1;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;stw&t;r1,0(r11);&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;tovirt(r1,r11);&t;&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;rlwinm&t;r9,r9,0,14,12;&t;&t;/* clear MSR_WE (necessary?)&t;   */&bslash;&n;&t;stw&t;r0,GPR0(r11);&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;SAVE_4GPRS(3, r11);&t;&t;&t;&t;&t;&t;     &bslash;&n;&t;SAVE_2GPRS(7, r11)
multiline_comment|/*&n; * Exception vectors.&n; */
DECL|macro|START_EXCEPTION
mdefine_line|#define&t;START_EXCEPTION(label)&t;&t;&t;&t;&t;&t;     &bslash;&n;        .align 5;              &t;&t;&t;&t;&t;&t;     &bslash;&n;label:
DECL|macro|FINISH_EXCEPTION
mdefine_line|#define FINISH_EXCEPTION(func)&t;&t;&t;&t;&t;&bslash;&n;&t;bl&t;transfer_to_handler_full;&t;&t;&t;&bslash;&n;&t;.long&t;func;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;.long&t;ret_from_except_full
DECL|macro|EXCEPTION
mdefine_line|#define EXCEPTION(n, label, hdlr, xfer)&t;&t;&t;&t;&bslash;&n;&t;START_EXCEPTION(label);&t;&t;&t;&t;&t;&bslash;&n;&t;NORMAL_EXCEPTION_PROLOG;&t;&t;&t;&t;&bslash;&n;&t;addi&t;r3,r1,STACK_FRAME_OVERHEAD;&t;&t;&t;&bslash;&n;&t;xfer(n, hdlr)
DECL|macro|CRITICAL_EXCEPTION
mdefine_line|#define CRITICAL_EXCEPTION(n, label, hdlr)&t;&t;&t;&bslash;&n;&t;START_EXCEPTION(label);&t;&t;&t;&t;&t;&bslash;&n;&t;CRITICAL_EXCEPTION_PROLOG;&t;&t;&t;&t;&bslash;&n;&t;addi&t;r3,r1,STACK_FRAME_OVERHEAD;&t;&t;&t;&bslash;&n;&t;EXC_XFER_TEMPLATE(hdlr, n+2, (MSR_KERNEL &amp; ~(MSR_ME|MSR_DE|MSR_CE)), &bslash;&n;&t;&t;&t;  NOCOPY, transfer_to_handler_full, &bslash;&n;&t;&t;&t;  ret_from_except_full)
DECL|macro|MCHECK_EXCEPTION
mdefine_line|#define MCHECK_EXCEPTION(n, label, hdlr)&t;&t;&t;&bslash;&n;&t;START_EXCEPTION(label);&t;&t;&t;&t;&t;&bslash;&n;&t;MCHECK_EXCEPTION_PROLOG;&t;&t;&t;&t;&bslash;&n;&t;mfspr&t;r5,SPRN_ESR;&t;&t;&t;&t;&t;&bslash;&n;&t;stw&t;r5,_ESR(r11);&t;&t;&t;&t;&t;&bslash;&n;&t;addi&t;r3,r1,STACK_FRAME_OVERHEAD;&t;&t;&t;&bslash;&n;&t;EXC_XFER_TEMPLATE(hdlr, n+2, (MSR_KERNEL &amp; ~(MSR_ME|MSR_DE|MSR_CE)), &bslash;&n;&t;&t;&t;  NOCOPY, mcheck_transfer_to_handler,   &bslash;&n;&t;&t;&t;  ret_from_mcheck_exc)
DECL|macro|EXC_XFER_TEMPLATE
mdefine_line|#define EXC_XFER_TEMPLATE(hdlr, trap, msr, copyee, tfer, ret)&t;&bslash;&n;&t;li&t;r10,trap;&t;&t;&t;&t;&t;&bslash;&n;&t;stw&t;r10,TRAP(r11);&t;&t;&t;&t;&t;&bslash;&n;&t;lis&t;r10,msr@h;&t;&t;&t;&t;&t;&bslash;&n;&t;ori&t;r10,r10,msr@l;&t;&t;&t;&t;&t;&bslash;&n;&t;copyee(r10, r9);&t;&t;&t;&t;&t;&bslash;&n;&t;bl&t;tfer;&t;&t; &t;&t;&t;&t;&bslash;&n;&t;.long&t;hdlr;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;.long&t;ret
DECL|macro|COPY_EE
mdefine_line|#define COPY_EE(d, s)&t;&t;rlwimi d,s,0,16,16
DECL|macro|NOCOPY
mdefine_line|#define NOCOPY(d, s)
DECL|macro|EXC_XFER_STD
mdefine_line|#define EXC_XFER_STD(n, hdlr)&t;&t;&bslash;&n;&t;EXC_XFER_TEMPLATE(hdlr, n, MSR_KERNEL, NOCOPY, transfer_to_handler_full, &bslash;&n;&t;&t;&t;  ret_from_except_full)
DECL|macro|EXC_XFER_LITE
mdefine_line|#define EXC_XFER_LITE(n, hdlr)&t;&t;&bslash;&n;&t;EXC_XFER_TEMPLATE(hdlr, n+1, MSR_KERNEL, NOCOPY, transfer_to_handler, &bslash;&n;&t;&t;&t;  ret_from_except)
DECL|macro|EXC_XFER_EE
mdefine_line|#define EXC_XFER_EE(n, hdlr)&t;&t;&bslash;&n;&t;EXC_XFER_TEMPLATE(hdlr, n, MSR_KERNEL, COPY_EE, transfer_to_handler_full, &bslash;&n;&t;&t;&t;  ret_from_except_full)
DECL|macro|EXC_XFER_EE_LITE
mdefine_line|#define EXC_XFER_EE_LITE(n, hdlr)&t;&bslash;&n;&t;EXC_XFER_TEMPLATE(hdlr, n+1, MSR_KERNEL, COPY_EE, transfer_to_handler, &bslash;&n;&t;&t;&t;  ret_from_except)
macro_line|#endif /* __HEAD_BOOKE_H__ */
eof
