multiline_comment|/*&n; * BK Id: SCCS/s.proc_rtas.c 1.5 05/17/01 18:14:22 cort&n; */
multiline_comment|/*&n; *   arch/ppc/kernel/proc_rtas.c&n; *   Copyright (C) 2000 Tilmann Bitterberg&n; *   (tilmann@bitterberg.de)&n; *&n; *   RTAS (Runtime Abstraction Services) stuff&n; *   Intention is to provide a clean user interface&n; *   to use the RTAS.&n; *&n; *   TODO:&n; *   Split off a header file and maybe move it to a different&n; *   location. Write Documentation on what the /proc/rtas/ entries&n; *   actually do.&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/machdep.h&gt; /* for ppc_md */
macro_line|#include &lt;asm/time.h&gt;
multiline_comment|/* Token for Sensors */
DECL|macro|KEY_SWITCH
mdefine_line|#define KEY_SWITCH&t;&t;0x0001
DECL|macro|ENCLOSURE_SWITCH
mdefine_line|#define ENCLOSURE_SWITCH&t;0x0002
DECL|macro|THERMAL_SENSOR
mdefine_line|#define THERMAL_SENSOR&t;&t;0x0003
DECL|macro|LID_STATUS
mdefine_line|#define LID_STATUS&t;&t;0x0004
DECL|macro|POWER_SOURCE
mdefine_line|#define POWER_SOURCE&t;&t;0x0005
DECL|macro|BATTERY_VOLTAGE
mdefine_line|#define BATTERY_VOLTAGE&t;&t;0x0006
DECL|macro|BATTERY_REMAINING
mdefine_line|#define BATTERY_REMAINING&t;0x0007
DECL|macro|BATTERY_PERCENTAGE
mdefine_line|#define BATTERY_PERCENTAGE&t;0x0008
DECL|macro|EPOW_SENSOR
mdefine_line|#define EPOW_SENSOR&t;&t;0x0009
DECL|macro|BATTERY_CYCLESTATE
mdefine_line|#define BATTERY_CYCLESTATE&t;0x000a
DECL|macro|BATTERY_CHARGING
mdefine_line|#define BATTERY_CHARGING&t;0x000b
multiline_comment|/* IBM specific sensors */
DECL|macro|IBM_SURVEILLANCE
mdefine_line|#define IBM_SURVEILLANCE&t;0x2328 /* 9000 */
DECL|macro|IBM_FANRPM
mdefine_line|#define IBM_FANRPM&t;&t;0x2329 /* 9001 */
DECL|macro|IBM_VOLTAGE
mdefine_line|#define IBM_VOLTAGE&t;&t;0x232a /* 9002 */
DECL|macro|IBM_DRCONNECTOR
mdefine_line|#define IBM_DRCONNECTOR&t;&t;0x232b /* 9003 */
DECL|macro|IBM_POWERSUPPLY
mdefine_line|#define IBM_POWERSUPPLY&t;&t;0x232c /* 9004 */
DECL|macro|IBM_INTQUEUE
mdefine_line|#define IBM_INTQUEUE&t;&t;0x232d /* 9005 */
multiline_comment|/* Status return values */
DECL|macro|SENSOR_CRITICAL_HIGH
mdefine_line|#define SENSOR_CRITICAL_HIGH&t;13
DECL|macro|SENSOR_WARNING_HIGH
mdefine_line|#define SENSOR_WARNING_HIGH&t;12
DECL|macro|SENSOR_NORMAL
mdefine_line|#define SENSOR_NORMAL&t;&t;11
DECL|macro|SENSOR_WARNING_LOW
mdefine_line|#define SENSOR_WARNING_LOW&t;10
DECL|macro|SENSOR_CRITICAL_LOW
mdefine_line|#define SENSOR_CRITICAL_LOW&t; 9
DECL|macro|SENSOR_SUCCESS
mdefine_line|#define SENSOR_SUCCESS&t;&t; 0
DECL|macro|SENSOR_HW_ERROR
mdefine_line|#define SENSOR_HW_ERROR&t;&t;-1
DECL|macro|SENSOR_BUSY
mdefine_line|#define SENSOR_BUSY&t;&t;-2
DECL|macro|SENSOR_NOT_EXIST
mdefine_line|#define SENSOR_NOT_EXIST&t;-3
DECL|macro|SENSOR_DR_ENTITY
mdefine_line|#define SENSOR_DR_ENTITY&t;-9000
multiline_comment|/* Location Codes */
DECL|macro|LOC_SCSI_DEV_ADDR
mdefine_line|#define LOC_SCSI_DEV_ADDR&t;&squot;A&squot;
DECL|macro|LOC_SCSI_DEV_LOC
mdefine_line|#define LOC_SCSI_DEV_LOC&t;&squot;B&squot;
DECL|macro|LOC_CPU
mdefine_line|#define LOC_CPU&t;&t;&t;&squot;C&squot;
DECL|macro|LOC_DISKETTE
mdefine_line|#define LOC_DISKETTE&t;&t;&squot;D&squot;
DECL|macro|LOC_ETHERNET
mdefine_line|#define LOC_ETHERNET&t;&t;&squot;E&squot;
DECL|macro|LOC_FAN
mdefine_line|#define LOC_FAN&t;&t;&t;&squot;F&squot;
DECL|macro|LOC_GRAPHICS
mdefine_line|#define LOC_GRAPHICS&t;&t;&squot;G&squot;
multiline_comment|/* reserved / not used&t;&t;&squot;H&squot; */
DECL|macro|LOC_IO_ADAPTER
mdefine_line|#define LOC_IO_ADAPTER&t;&t;&squot;I&squot;
multiline_comment|/* reserved / not used&t;&t;&squot;J&squot; */
DECL|macro|LOC_KEYBOARD
mdefine_line|#define LOC_KEYBOARD&t;&t;&squot;K&squot;
DECL|macro|LOC_LCD
mdefine_line|#define LOC_LCD&t;&t;&t;&squot;L&squot;
DECL|macro|LOC_MEMORY
mdefine_line|#define LOC_MEMORY&t;&t;&squot;M&squot;
DECL|macro|LOC_NV_MEMORY
mdefine_line|#define LOC_NV_MEMORY&t;&t;&squot;N&squot;
DECL|macro|LOC_MOUSE
mdefine_line|#define LOC_MOUSE&t;&t;&squot;O&squot;
DECL|macro|LOC_PLANAR
mdefine_line|#define LOC_PLANAR&t;&t;&squot;P&squot;
DECL|macro|LOC_OTHER_IO
mdefine_line|#define LOC_OTHER_IO&t;&t;&squot;Q&squot;
DECL|macro|LOC_PARALLEL
mdefine_line|#define LOC_PARALLEL&t;&t;&squot;R&squot;
DECL|macro|LOC_SERIAL
mdefine_line|#define LOC_SERIAL&t;&t;&squot;S&squot;
DECL|macro|LOC_DEAD_RING
mdefine_line|#define LOC_DEAD_RING&t;&t;&squot;T&squot;
DECL|macro|LOC_RACKMOUNTED
mdefine_line|#define LOC_RACKMOUNTED&t;&t;&squot;U&squot; /* for _u_nit is rack mounted */
DECL|macro|LOC_VOLTAGE
mdefine_line|#define LOC_VOLTAGE&t;&t;&squot;V&squot;
DECL|macro|LOC_SWITCH_ADAPTER
mdefine_line|#define LOC_SWITCH_ADAPTER&t;&squot;W&squot;
DECL|macro|LOC_OTHER
mdefine_line|#define LOC_OTHER&t;&t;&squot;X&squot;
DECL|macro|LOC_FIRMWARE
mdefine_line|#define LOC_FIRMWARE&t;&t;&squot;Y&squot;
DECL|macro|LOC_SCSI
mdefine_line|#define LOC_SCSI&t;&t;&squot;Z&squot;
multiline_comment|/* Tokens for indicators */
DECL|macro|TONE_FREQUENCY
mdefine_line|#define TONE_FREQUENCY&t;&t;0x0001 /* 0 - 1000 (HZ)*/
DECL|macro|TONE_VOLUME
mdefine_line|#define TONE_VOLUME&t;&t;0x0002 /* 0 - 100 (%) */
DECL|macro|SYSTEM_POWER_STATE
mdefine_line|#define SYSTEM_POWER_STATE&t;0x0003 
DECL|macro|WARNING_LIGHT
mdefine_line|#define WARNING_LIGHT&t;&t;0x0004
DECL|macro|DISK_ACTIVITY_LIGHT
mdefine_line|#define DISK_ACTIVITY_LIGHT&t;0x0005
DECL|macro|HEX_DISPLAY_UNIT
mdefine_line|#define HEX_DISPLAY_UNIT&t;0x0006
DECL|macro|BATTERY_WARNING_TIME
mdefine_line|#define BATTERY_WARNING_TIME&t;0x0007
DECL|macro|CONDITION_CYCLE_REQUEST
mdefine_line|#define CONDITION_CYCLE_REQUEST&t;0x0008
DECL|macro|SURVEILLANCE_INDICATOR
mdefine_line|#define SURVEILLANCE_INDICATOR&t;0x2328 /* 9000 */
DECL|macro|DR_ACTION
mdefine_line|#define DR_ACTION&t;&t;0x2329 /* 9001 */
DECL|macro|DR_INDICATOR
mdefine_line|#define DR_INDICATOR&t;&t;0x232a /* 9002 */
multiline_comment|/* 9003 - 9004: Vendor specific */
DECL|macro|GLOBAL_INTERRUPT_QUEUE
mdefine_line|#define GLOBAL_INTERRUPT_QUEUE&t;0x232d /* 9005 */
multiline_comment|/* 9006 - 9999: Vendor specific */
multiline_comment|/* other */
DECL|macro|MAX_SENSORS
mdefine_line|#define MAX_SENSORS&t;&t; 17  /* I only know of 17 sensors */    
DECL|macro|MAX_LINELENGTH
mdefine_line|#define MAX_LINELENGTH          256
DECL|macro|SENSOR_PREFIX
mdefine_line|#define SENSOR_PREFIX&t;&t;&quot;ibm,sensor-&quot;
DECL|macro|cel_to_fahr
mdefine_line|#define cel_to_fahr(x)&t;&t;((x*9/5)+32)
multiline_comment|/* Globals */
DECL|variable|proc_rtas
r_static
r_struct
id|proc_dir_entry
op_star
id|proc_rtas
suffix:semicolon
DECL|variable|sensors
r_static
r_struct
id|rtas_sensors
id|sensors
suffix:semicolon
DECL|variable|rtas
r_static
r_struct
id|device_node
op_star
id|rtas
suffix:semicolon
DECL|variable|power_on_time
r_static
r_int
r_int
id|power_on_time
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Save the time the user set */
DECL|variable|progress_led
r_static
r_char
id|progress_led
(braket
id|MAX_LINELENGTH
)braket
suffix:semicolon
DECL|variable|rtas_tone_frequency
r_static
r_int
r_int
id|rtas_tone_frequency
op_assign
l_int|1000
suffix:semicolon
DECL|variable|rtas_tone_volume
r_static
r_int
r_int
id|rtas_tone_volume
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* ****************STRUCTS******************************************* */
DECL|struct|individual_sensor
r_struct
id|individual_sensor
(brace
DECL|member|token
r_int
r_int
id|token
suffix:semicolon
DECL|member|quant
r_int
r_int
id|quant
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|rtas_sensors
r_struct
id|rtas_sensors
(brace
DECL|member|sensor
r_struct
id|individual_sensor
id|sensor
(braket
id|MAX_SENSORS
)braket
suffix:semicolon
DECL|member|quant
r_int
r_int
id|quant
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* ****************************************************************** */
multiline_comment|/* Declarations */
r_static
r_int
id|ppc_rtas_sensor_read
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
id|ssize_t
id|ppc_rtas_clock_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
r_static
id|ssize_t
id|ppc_rtas_clock_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
r_static
id|ssize_t
id|ppc_rtas_progress_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
r_static
id|ssize_t
id|ppc_rtas_progress_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
r_static
id|ssize_t
id|ppc_rtas_poweron_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
r_static
id|ssize_t
id|ppc_rtas_poweron_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
r_static
id|ssize_t
id|ppc_rtas_tone_freq_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
r_static
id|ssize_t
id|ppc_rtas_tone_freq_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
r_static
id|ssize_t
id|ppc_rtas_tone_volume_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
r_static
id|ssize_t
id|ppc_rtas_tone_volume_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
DECL|variable|ppc_rtas_poweron_operations
r_struct
id|file_operations
id|ppc_rtas_poweron_operations
op_assign
(brace
id|read
suffix:colon
id|ppc_rtas_poweron_read
comma
id|write
suffix:colon
id|ppc_rtas_poweron_write
)brace
suffix:semicolon
DECL|variable|ppc_rtas_progress_operations
r_struct
id|file_operations
id|ppc_rtas_progress_operations
op_assign
(brace
id|read
suffix:colon
id|ppc_rtas_progress_read
comma
id|write
suffix:colon
id|ppc_rtas_progress_write
)brace
suffix:semicolon
DECL|variable|ppc_rtas_clock_operations
r_struct
id|file_operations
id|ppc_rtas_clock_operations
op_assign
(brace
id|read
suffix:colon
id|ppc_rtas_clock_read
comma
id|write
suffix:colon
id|ppc_rtas_clock_write
)brace
suffix:semicolon
DECL|variable|ppc_rtas_tone_freq_operations
r_struct
id|file_operations
id|ppc_rtas_tone_freq_operations
op_assign
(brace
id|read
suffix:colon
id|ppc_rtas_tone_freq_read
comma
id|write
suffix:colon
id|ppc_rtas_tone_freq_write
)brace
suffix:semicolon
DECL|variable|ppc_rtas_tone_volume_operations
r_struct
id|file_operations
id|ppc_rtas_tone_volume_operations
op_assign
(brace
id|read
suffix:colon
id|ppc_rtas_tone_volume_read
comma
id|write
suffix:colon
id|ppc_rtas_tone_volume_write
)brace
suffix:semicolon
r_int
id|ppc_rtas_find_all_sensors
(paren
r_void
)paren
suffix:semicolon
r_int
id|ppc_rtas_process_sensor
c_func
(paren
r_struct
id|individual_sensor
id|s
comma
r_int
id|state
comma
r_int
id|error
comma
r_char
op_star
id|buf
)paren
suffix:semicolon
r_char
op_star
id|ppc_rtas_process_error
c_func
(paren
r_int
id|error
)paren
suffix:semicolon
r_int
id|get_location_code
c_func
(paren
r_struct
id|individual_sensor
id|s
comma
r_char
op_star
id|buf
)paren
suffix:semicolon
r_int
id|check_location_string
(paren
r_char
op_star
id|c
comma
r_char
op_star
id|buf
)paren
suffix:semicolon
r_int
id|check_location
(paren
r_char
op_star
id|c
comma
r_int
id|idx
comma
r_char
op_star
id|buf
)paren
suffix:semicolon
multiline_comment|/* ****************************************************************** */
multiline_comment|/* MAIN                                                               */
multiline_comment|/* ****************************************************************** */
DECL|function|proc_rtas_init
r_void
id|proc_rtas_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|entry
suffix:semicolon
id|rtas
op_assign
id|find_devices
c_func
(paren
l_string|&quot;rtas&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rtas
op_eq
l_int|0
)paren
op_logical_or
(paren
id|_machine
op_ne
id|_MACH_chrp
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|proc_rtas
op_assign
id|proc_mkdir
c_func
(paren
l_string|&quot;rtas&quot;
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|proc_rtas
op_eq
l_int|0
)paren
r_return
suffix:semicolon
multiline_comment|/* /proc/rtas entries */
id|entry
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;progress&quot;
comma
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|proc_rtas
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
)paren
id|entry-&gt;proc_fops
op_assign
op_amp
id|ppc_rtas_progress_operations
suffix:semicolon
id|entry
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;clock&quot;
comma
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|proc_rtas
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
)paren
id|entry-&gt;proc_fops
op_assign
op_amp
id|ppc_rtas_clock_operations
suffix:semicolon
id|entry
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;poweron&quot;
comma
id|S_IWUSR
op_or
id|S_IRUGO
comma
id|proc_rtas
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
)paren
id|entry-&gt;proc_fops
op_assign
op_amp
id|ppc_rtas_poweron_operations
suffix:semicolon
id|create_proc_read_entry
c_func
(paren
l_string|&quot;sensors&quot;
comma
id|S_IRUGO
comma
id|proc_rtas
comma
id|ppc_rtas_sensor_read
comma
l_int|NULL
)paren
suffix:semicolon
id|entry
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;frequency&quot;
comma
id|S_IWUSR
op_or
id|S_IRUGO
comma
id|proc_rtas
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
)paren
id|entry-&gt;proc_fops
op_assign
op_amp
id|ppc_rtas_tone_freq_operations
suffix:semicolon
id|entry
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;volume&quot;
comma
id|S_IWUSR
op_or
id|S_IRUGO
comma
id|proc_rtas
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
)paren
id|entry-&gt;proc_fops
op_assign
op_amp
id|ppc_rtas_tone_volume_operations
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
multiline_comment|/* POWER-ON-TIME                                                      */
multiline_comment|/* ****************************************************************** */
DECL|function|ppc_rtas_poweron_write
r_static
id|ssize_t
id|ppc_rtas_poweron_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|rtc_time
id|tm
suffix:semicolon
r_int
r_int
id|nowtime
suffix:semicolon
r_char
op_star
id|dest
suffix:semicolon
r_int
id|error
suffix:semicolon
id|nowtime
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
op_amp
id|dest
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|dest
op_ne
l_char|&squot;&bslash;0&squot;
op_logical_and
op_star
id|dest
op_ne
l_char|&squot;&bslash;n&squot;
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ppc_rtas_poweron_write: Invalid time&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
id|power_on_time
op_assign
id|nowtime
suffix:semicolon
multiline_comment|/* save the time */
id|to_tm
c_func
(paren
id|nowtime
comma
op_amp
id|tm
)paren
suffix:semicolon
id|error
op_assign
id|call_rtas
c_func
(paren
l_string|&quot;set-time-for-power-on&quot;
comma
l_int|7
comma
l_int|1
comma
l_int|NULL
comma
id|tm.tm_year
comma
id|tm.tm_mon
comma
id|tm.tm_mday
comma
id|tm.tm_hour
comma
id|tm.tm_min
comma
id|tm.tm_sec
comma
l_int|0
multiline_comment|/* nano */
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;error: setting poweron time returned: %s&bslash;n&quot;
comma
id|ppc_rtas_process_error
c_func
(paren
id|error
)paren
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
DECL|function|ppc_rtas_poweron_read
r_static
id|ssize_t
id|ppc_rtas_poweron_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
id|n
suffix:semicolon
r_if
c_cond
(paren
id|power_on_time
op_eq
l_int|0
)paren
id|n
op_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;Power on time not set&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|n
op_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%lu&bslash;n&quot;
comma
id|power_on_time
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|ppos
op_ge
id|strlen
c_func
(paren
id|buf
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
id|strlen
c_func
(paren
id|buf
)paren
op_minus
op_star
id|ppos
)paren
id|n
op_assign
id|strlen
c_func
(paren
id|buf
)paren
op_minus
op_star
id|ppos
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
id|count
)paren
id|n
op_assign
id|count
suffix:semicolon
op_star
id|ppos
op_add_assign
id|n
suffix:semicolon
r_return
id|n
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
multiline_comment|/* PROGRESS                                                           */
multiline_comment|/* ****************************************************************** */
DECL|function|ppc_rtas_progress_write
r_static
id|ssize_t
id|ppc_rtas_progress_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
r_int
id|hex
suffix:semicolon
id|strcpy
c_func
(paren
id|progress_led
comma
id|buf
)paren
suffix:semicolon
multiline_comment|/* save the string */
multiline_comment|/* Lets see if the user passed hexdigits */
id|hex
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|ppc_md.progress
(paren
(paren
r_char
op_star
)paren
id|buf
comma
id|hex
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
multiline_comment|/* clear the line */
multiline_comment|/* ppc_md.progress(&quot;                   &quot;, 0xffff);*/
)brace
multiline_comment|/* ****************************************************************** */
DECL|function|ppc_rtas_progress_read
r_static
id|ssize_t
id|ppc_rtas_progress_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
id|n
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|progress_led
op_ne
l_int|NULL
)paren
id|n
op_assign
id|sprintf
(paren
id|buf
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|progress_led
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|ppos
op_ge
id|strlen
c_func
(paren
id|buf
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
id|strlen
c_func
(paren
id|buf
)paren
op_minus
op_star
id|ppos
)paren
id|n
op_assign
id|strlen
c_func
(paren
id|buf
)paren
op_minus
op_star
id|ppos
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
id|count
)paren
id|n
op_assign
id|count
suffix:semicolon
op_star
id|ppos
op_add_assign
id|n
suffix:semicolon
r_return
id|n
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
multiline_comment|/* CLOCK                                                              */
multiline_comment|/* ****************************************************************** */
DECL|function|ppc_rtas_clock_write
r_static
id|ssize_t
id|ppc_rtas_clock_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|rtc_time
id|tm
suffix:semicolon
r_int
r_int
id|nowtime
suffix:semicolon
r_char
op_star
id|dest
suffix:semicolon
r_int
id|error
suffix:semicolon
id|nowtime
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
op_amp
id|dest
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|dest
op_ne
l_char|&squot;&bslash;0&squot;
op_logical_and
op_star
id|dest
op_ne
l_char|&squot;&bslash;n&squot;
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ppc_rtas_clock_write: Invalid time&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
id|to_tm
c_func
(paren
id|nowtime
comma
op_amp
id|tm
)paren
suffix:semicolon
id|error
op_assign
id|call_rtas
c_func
(paren
l_string|&quot;set-time-of-day&quot;
comma
l_int|7
comma
l_int|1
comma
l_int|NULL
comma
id|tm.tm_year
comma
id|tm.tm_mon
comma
id|tm.tm_mday
comma
id|tm.tm_hour
comma
id|tm.tm_min
comma
id|tm.tm_sec
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;error: setting the clock returned: %s&bslash;n&quot;
comma
id|ppc_rtas_process_error
c_func
(paren
id|error
)paren
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
DECL|function|ppc_rtas_clock_read
r_static
id|ssize_t
id|ppc_rtas_clock_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
r_int
id|year
comma
id|mon
comma
id|day
comma
id|hour
comma
id|min
comma
id|sec
suffix:semicolon
r_int
r_int
op_star
id|ret
op_assign
id|kmalloc
c_func
(paren
l_int|4
op_star
l_int|8
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_int
id|n
comma
id|error
suffix:semicolon
id|error
op_assign
id|call_rtas
c_func
(paren
l_string|&quot;get-time-of-day&quot;
comma
l_int|0
comma
l_int|8
comma
id|ret
)paren
suffix:semicolon
id|year
op_assign
id|ret
(braket
l_int|0
)braket
suffix:semicolon
id|mon
op_assign
id|ret
(braket
l_int|1
)braket
suffix:semicolon
id|day
op_assign
id|ret
(braket
l_int|2
)braket
suffix:semicolon
id|hour
op_assign
id|ret
(braket
l_int|3
)braket
suffix:semicolon
id|min
op_assign
id|ret
(braket
l_int|4
)braket
suffix:semicolon
id|sec
op_assign
id|ret
(braket
l_int|5
)braket
suffix:semicolon
r_if
c_cond
(paren
id|error
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;error: reading the clock returned: %s&bslash;n&quot;
comma
id|ppc_rtas_process_error
c_func
(paren
id|error
)paren
)paren
suffix:semicolon
id|n
op_assign
id|sprintf
(paren
id|buf
comma
l_string|&quot;0&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|n
op_assign
id|sprintf
(paren
id|buf
comma
l_string|&quot;%lu&bslash;n&quot;
comma
id|mktime
c_func
(paren
id|year
comma
id|mon
comma
id|day
comma
id|hour
comma
id|min
comma
id|sec
)paren
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|ret
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|ppos
op_ge
id|strlen
c_func
(paren
id|buf
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
id|strlen
c_func
(paren
id|buf
)paren
op_minus
op_star
id|ppos
)paren
id|n
op_assign
id|strlen
c_func
(paren
id|buf
)paren
op_minus
op_star
id|ppos
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
id|count
)paren
id|n
op_assign
id|count
suffix:semicolon
op_star
id|ppos
op_add_assign
id|n
suffix:semicolon
r_return
id|n
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
multiline_comment|/* SENSOR STUFF                                                       */
multiline_comment|/* ****************************************************************** */
DECL|function|ppc_rtas_sensor_read
r_static
r_int
id|ppc_rtas_sensor_read
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|i
comma
id|j
comma
id|n
suffix:semicolon
r_int
r_int
id|ret
suffix:semicolon
r_int
id|state
comma
id|error
suffix:semicolon
r_char
id|buffer
(braket
id|MAX_LINELENGTH
op_star
id|MAX_SENSORS
)braket
suffix:semicolon
multiline_comment|/* May not be enough */
r_if
c_cond
(paren
id|count
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|n
op_assign
id|sprintf
(paren
id|buffer
comma
l_string|&quot;RTAS (RunTime Abstraction Services) Sensor Information&bslash;n&quot;
)paren
suffix:semicolon
id|n
op_add_assign
id|sprintf
(paren
id|buffer
op_plus
id|n
comma
l_string|&quot;Sensor&bslash;t&bslash;tValue&bslash;t&bslash;tCondition&bslash;tLocation&bslash;n&quot;
)paren
suffix:semicolon
id|n
op_add_assign
id|sprintf
(paren
id|buffer
op_plus
id|n
comma
l_string|&quot;********************************************************&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppc_rtas_find_all_sensors
c_func
(paren
)paren
op_ne
l_int|0
)paren
(brace
id|n
op_add_assign
id|sprintf
(paren
id|buffer
op_plus
id|n
comma
l_string|&quot;&bslash;nNo sensors are available&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|return_string
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sensors.quant
suffix:semicolon
id|i
op_increment
)paren
(brace
id|j
op_assign
id|sensors.sensor
(braket
id|i
)braket
dot
id|quant
suffix:semicolon
multiline_comment|/* A sensor may have multiple instances */
r_while
c_loop
(paren
id|j
op_ge
l_int|0
)paren
(brace
id|error
op_assign
id|call_rtas
c_func
(paren
l_string|&quot;get-sensor-state&quot;
comma
l_int|2
comma
l_int|2
comma
op_amp
id|ret
comma
id|sensors.sensor
(braket
id|i
)braket
dot
id|token
comma
id|sensors.sensor
(braket
id|i
)braket
dot
id|quant
op_minus
id|j
)paren
suffix:semicolon
id|state
op_assign
(paren
r_int
)paren
id|ret
suffix:semicolon
id|n
op_add_assign
id|ppc_rtas_process_sensor
c_func
(paren
id|sensors.sensor
(braket
id|i
)braket
comma
id|state
comma
id|error
comma
id|buffer
op_plus
id|n
)paren
suffix:semicolon
id|n
op_add_assign
id|sprintf
(paren
id|buffer
op_plus
id|n
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|j
op_decrement
suffix:semicolon
)brace
multiline_comment|/* while */
)brace
multiline_comment|/* for */
id|return_string
suffix:colon
r_if
c_cond
(paren
id|off
op_ge
id|strlen
c_func
(paren
id|buffer
)paren
)paren
(brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n
OG
id|strlen
c_func
(paren
id|buffer
)paren
op_minus
id|off
)paren
id|n
op_assign
id|strlen
c_func
(paren
id|buffer
)paren
op_minus
id|off
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
id|count
)paren
id|n
op_assign
id|count
suffix:semicolon
r_else
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
id|buf
comma
id|buffer
op_plus
id|off
comma
id|n
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buf
suffix:semicolon
r_return
id|n
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
DECL|function|ppc_rtas_find_all_sensors
r_int
id|ppc_rtas_find_all_sensors
(paren
r_void
)paren
(brace
r_int
r_int
op_star
id|utmp
suffix:semicolon
r_int
id|len
comma
id|i
comma
id|j
suffix:semicolon
id|utmp
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_property
c_func
(paren
id|rtas
comma
l_string|&quot;rtas-sensors&quot;
comma
op_amp
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|utmp
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;error: could not get rtas-sensors&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|sensors.quant
op_assign
id|len
op_div
l_int|8
suffix:semicolon
multiline_comment|/* int + int */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|sensors.quant
suffix:semicolon
id|i
op_add_assign
l_int|2
comma
id|j
op_increment
)paren
(brace
id|sensors.sensor
(braket
id|j
)braket
dot
id|token
op_assign
id|utmp
(braket
id|i
)braket
suffix:semicolon
id|sensors.sensor
(braket
id|j
)braket
dot
id|quant
op_assign
id|utmp
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
multiline_comment|/*&n; * Builds a string of what rtas returned&n; */
DECL|function|ppc_rtas_process_error
r_char
op_star
id|ppc_rtas_process_error
c_func
(paren
r_int
id|error
)paren
(brace
r_switch
c_cond
(paren
id|error
)paren
(brace
r_case
id|SENSOR_CRITICAL_HIGH
suffix:colon
r_return
l_string|&quot;(critical high)&quot;
suffix:semicolon
r_case
id|SENSOR_WARNING_HIGH
suffix:colon
r_return
l_string|&quot;(warning high)&quot;
suffix:semicolon
r_case
id|SENSOR_NORMAL
suffix:colon
r_return
l_string|&quot;(normal)&quot;
suffix:semicolon
r_case
id|SENSOR_WARNING_LOW
suffix:colon
r_return
l_string|&quot;(warning low)&quot;
suffix:semicolon
r_case
id|SENSOR_CRITICAL_LOW
suffix:colon
r_return
l_string|&quot;(critical low)&quot;
suffix:semicolon
r_case
id|SENSOR_SUCCESS
suffix:colon
r_return
l_string|&quot;(read ok)&quot;
suffix:semicolon
r_case
id|SENSOR_HW_ERROR
suffix:colon
r_return
l_string|&quot;(hardware error)&quot;
suffix:semicolon
r_case
id|SENSOR_BUSY
suffix:colon
r_return
l_string|&quot;(busy)&quot;
suffix:semicolon
r_case
id|SENSOR_NOT_EXIST
suffix:colon
r_return
l_string|&quot;(non existant)&quot;
suffix:semicolon
r_case
id|SENSOR_DR_ENTITY
suffix:colon
r_return
l_string|&quot;(dr entity removed)&quot;
suffix:semicolon
r_default
suffix:colon
r_return
l_string|&quot;(UNKNOWN)&quot;
suffix:semicolon
)brace
)brace
multiline_comment|/* ****************************************************************** */
multiline_comment|/*&n; * Builds a string out of what the sensor said&n; */
DECL|function|ppc_rtas_process_sensor
r_int
id|ppc_rtas_process_sensor
c_func
(paren
r_struct
id|individual_sensor
id|s
comma
r_int
id|state
comma
r_int
id|error
comma
r_char
op_star
id|buf
)paren
(brace
multiline_comment|/* Defined return vales */
r_const
r_char
op_star
id|key_switch
(braket
)braket
op_assign
(brace
l_string|&quot;Off&bslash;t&quot;
comma
l_string|&quot;Normal&bslash;t&quot;
comma
l_string|&quot;Secure&bslash;t&quot;
comma
l_string|&quot;Mainenance&quot;
)brace
suffix:semicolon
r_const
r_char
op_star
id|enclosure_switch
(braket
)braket
op_assign
(brace
l_string|&quot;Closed&quot;
comma
l_string|&quot;Open&quot;
)brace
suffix:semicolon
r_const
r_char
op_star
id|lid_status
(braket
)braket
op_assign
(brace
l_string|&quot; &quot;
comma
l_string|&quot;Open&quot;
comma
l_string|&quot;Closed&quot;
)brace
suffix:semicolon
r_const
r_char
op_star
id|power_source
(braket
)braket
op_assign
(brace
l_string|&quot;AC&bslash;t&quot;
comma
l_string|&quot;Battery&quot;
comma
l_string|&quot;AC &amp; Battery&quot;
)brace
suffix:semicolon
r_const
r_char
op_star
id|battery_remaining
(braket
)braket
op_assign
(brace
l_string|&quot;Very Low&quot;
comma
l_string|&quot;Low&quot;
comma
l_string|&quot;Mid&quot;
comma
l_string|&quot;High&quot;
)brace
suffix:semicolon
r_const
r_char
op_star
id|epow_sensor
(braket
)braket
op_assign
(brace
l_string|&quot;EPOW Reset&quot;
comma
l_string|&quot;Cooling warning&quot;
comma
l_string|&quot;Power warning&quot;
comma
l_string|&quot;System shutdown&quot;
comma
l_string|&quot;System halt&quot;
comma
l_string|&quot;EPOW main enclosure&quot;
comma
l_string|&quot;EPOW power off&quot;
)brace
suffix:semicolon
r_const
r_char
op_star
id|battery_cyclestate
(braket
)braket
op_assign
(brace
l_string|&quot;None&quot;
comma
l_string|&quot;In progress&quot;
comma
l_string|&quot;Requested&quot;
)brace
suffix:semicolon
r_const
r_char
op_star
id|battery_charging
(braket
)braket
op_assign
(brace
l_string|&quot;Charging&quot;
comma
l_string|&quot;Discharching&quot;
comma
l_string|&quot;No current flow&quot;
)brace
suffix:semicolon
r_const
r_char
op_star
id|ibm_drconnector
(braket
)braket
op_assign
(brace
l_string|&quot;Empty&quot;
comma
l_string|&quot;Present&quot;
)brace
suffix:semicolon
r_const
r_char
op_star
id|ibm_intqueue
(braket
)braket
op_assign
(brace
l_string|&quot;Disabled&quot;
comma
l_string|&quot;Enabled&quot;
)brace
suffix:semicolon
r_int
id|have_strings
op_assign
l_int|0
suffix:semicolon
r_int
id|temperature
op_assign
l_int|0
suffix:semicolon
r_int
id|unknown
op_assign
l_int|0
suffix:semicolon
r_int
id|n
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* What kind of sensor do we have here? */
r_switch
c_cond
(paren
id|s.token
)paren
(brace
r_case
id|KEY_SWITCH
suffix:colon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;Key switch:&bslash;t&quot;
)paren
suffix:semicolon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;%s&bslash;t&quot;
comma
id|key_switch
(braket
id|state
)braket
)paren
suffix:semicolon
id|have_strings
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENCLOSURE_SWITCH
suffix:colon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;Enclosure switch:&bslash;t&quot;
)paren
suffix:semicolon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;%s&bslash;t&quot;
comma
id|enclosure_switch
(braket
id|state
)braket
)paren
suffix:semicolon
id|have_strings
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|THERMAL_SENSOR
suffix:colon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;Temp. (&#xfffd;C/&#xfffd;F):&bslash;t&quot;
)paren
suffix:semicolon
id|temperature
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LID_STATUS
suffix:colon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;Lid status:&bslash;t&quot;
)paren
suffix:semicolon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;%s&bslash;t&quot;
comma
id|lid_status
(braket
id|state
)braket
)paren
suffix:semicolon
id|have_strings
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|POWER_SOURCE
suffix:colon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;Power source:&bslash;t&quot;
)paren
suffix:semicolon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;%s&bslash;t&quot;
comma
id|power_source
(braket
id|state
)braket
)paren
suffix:semicolon
id|have_strings
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BATTERY_VOLTAGE
suffix:colon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;Battery voltage:&bslash;t&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BATTERY_REMAINING
suffix:colon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;Battery remaining:&bslash;t&quot;
)paren
suffix:semicolon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;%s&bslash;t&quot;
comma
id|battery_remaining
(braket
id|state
)braket
)paren
suffix:semicolon
id|have_strings
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BATTERY_PERCENTAGE
suffix:colon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;Battery percentage:&bslash;t&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EPOW_SENSOR
suffix:colon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;EPOW Sensor:&bslash;t&quot;
)paren
suffix:semicolon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;%s&bslash;t&quot;
comma
id|epow_sensor
(braket
id|state
)braket
)paren
suffix:semicolon
id|have_strings
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BATTERY_CYCLESTATE
suffix:colon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;Battery cyclestate:&bslash;t&quot;
)paren
suffix:semicolon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;%s&bslash;t&quot;
comma
id|battery_cyclestate
(braket
id|state
)braket
)paren
suffix:semicolon
id|have_strings
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BATTERY_CHARGING
suffix:colon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;Battery Charging:&bslash;t&quot;
)paren
suffix:semicolon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;%s&bslash;t&quot;
comma
id|battery_charging
(braket
id|state
)braket
)paren
suffix:semicolon
id|have_strings
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IBM_SURVEILLANCE
suffix:colon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;Surveillance:&bslash;t&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IBM_FANRPM
suffix:colon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;Fan (rpm):&bslash;t&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IBM_VOLTAGE
suffix:colon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;Voltage (mv):&bslash;t&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IBM_DRCONNECTOR
suffix:colon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;DR connector:&bslash;t&quot;
)paren
suffix:semicolon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;%s&bslash;t&quot;
comma
id|ibm_drconnector
(braket
id|state
)braket
)paren
suffix:semicolon
id|have_strings
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IBM_POWERSUPPLY
suffix:colon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;Powersupply:&bslash;t&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IBM_INTQUEUE
suffix:colon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;Interrupt queue:&bslash;t&quot;
)paren
suffix:semicolon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;%s&bslash;t&quot;
comma
id|ibm_intqueue
(braket
id|state
)braket
)paren
suffix:semicolon
id|have_strings
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;Unkown sensor (type %d), ignoring it&bslash;n&quot;
comma
id|s.token
)paren
suffix:semicolon
id|unknown
op_assign
l_int|1
suffix:semicolon
id|have_strings
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|have_strings
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|temperature
)paren
(brace
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;%4d /%4d&bslash;t&quot;
comma
id|state
comma
id|cel_to_fahr
c_func
(paren
id|state
)paren
)paren
suffix:semicolon
)brace
r_else
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;%10d&bslash;t&quot;
comma
id|state
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|unknown
op_eq
l_int|0
)paren
(brace
id|n
op_add_assign
id|sprintf
(paren
id|buf
op_plus
id|n
comma
l_string|&quot;%s&bslash;t&quot;
comma
id|ppc_rtas_process_error
c_func
(paren
id|error
)paren
)paren
suffix:semicolon
id|n
op_add_assign
id|get_location_code
c_func
(paren
id|s
comma
id|buf
op_plus
id|n
)paren
suffix:semicolon
)brace
r_return
id|n
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
DECL|function|check_location
r_int
id|check_location
(paren
r_char
op_star
id|c
comma
r_int
id|idx
comma
r_char
op_star
id|buf
)paren
(brace
r_int
id|n
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
op_star
(paren
id|c
op_plus
id|idx
)paren
)paren
(brace
r_case
id|LOC_PLANAR
suffix:colon
id|n
op_add_assign
id|sprintf
(paren
id|buf
comma
l_string|&quot;Planar #%c&quot;
comma
op_star
(paren
id|c
op_plus
id|idx
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LOC_CPU
suffix:colon
id|n
op_add_assign
id|sprintf
(paren
id|buf
comma
l_string|&quot;CPU #%c&quot;
comma
op_star
(paren
id|c
op_plus
id|idx
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LOC_FAN
suffix:colon
id|n
op_add_assign
id|sprintf
(paren
id|buf
comma
l_string|&quot;Fan #%c&quot;
comma
op_star
(paren
id|c
op_plus
id|idx
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LOC_RACKMOUNTED
suffix:colon
id|n
op_add_assign
id|sprintf
(paren
id|buf
comma
l_string|&quot;Rack #%c&quot;
comma
op_star
(paren
id|c
op_plus
id|idx
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LOC_VOLTAGE
suffix:colon
id|n
op_add_assign
id|sprintf
(paren
id|buf
comma
l_string|&quot;Voltage #%c&quot;
comma
op_star
(paren
id|c
op_plus
id|idx
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LOC_LCD
suffix:colon
id|n
op_add_assign
id|sprintf
(paren
id|buf
comma
l_string|&quot;LCD #%c&quot;
comma
op_star
(paren
id|c
op_plus
id|idx
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;.&squot;
suffix:colon
id|n
op_add_assign
id|sprintf
(paren
id|buf
comma
l_string|&quot;- %c&quot;
comma
op_star
(paren
id|c
op_plus
id|idx
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_default
suffix:colon
id|n
op_add_assign
id|sprintf
(paren
id|buf
comma
l_string|&quot;Unknown location&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|n
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
multiline_comment|/* &n; * Format: &n; * ${LETTER}${NUMBER}[[-/]${LETTER}${NUMBER} [ ... ] ]&n; * the &squot;.&squot; may be an abbrevation&n; */
DECL|function|check_location_string
r_int
id|check_location_string
(paren
r_char
op_star
id|c
comma
r_char
op_star
id|buf
)paren
(brace
r_int
id|n
op_assign
l_int|0
comma
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|c
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
id|isalpha
c_func
(paren
id|c
(braket
id|i
)braket
)paren
op_logical_or
id|c
(braket
id|i
)braket
op_eq
l_char|&squot;.&squot;
)paren
(brace
id|n
op_add_assign
id|check_location
c_func
(paren
id|c
comma
id|i
comma
id|buf
op_plus
id|n
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|c
(braket
id|i
)braket
op_eq
l_char|&squot;/&squot;
op_logical_or
id|c
(braket
id|i
)braket
op_eq
l_char|&squot;-&squot;
)paren
id|n
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|n
comma
l_string|&quot; at &quot;
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_return
id|n
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
DECL|function|get_location_code
r_int
id|get_location_code
c_func
(paren
r_struct
id|individual_sensor
id|s
comma
r_char
op_star
id|buffer
)paren
(brace
r_char
id|rstr
(braket
l_int|512
)braket
comma
id|tmp
(braket
l_int|10
)braket
comma
id|tmp2
(braket
l_int|10
)braket
suffix:semicolon
r_int
id|n
op_assign
l_int|0
comma
id|i
op_assign
l_int|0
comma
id|llen
comma
id|len
suffix:semicolon
multiline_comment|/* char *buf = kmalloc(MAX_LINELENGTH, GFP_KERNEL); */
r_char
op_star
id|ret
suffix:semicolon
r_static
r_int
id|pos
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* remember position where buffer was */
multiline_comment|/* construct the sensor number like 0003 */
multiline_comment|/* fill with zeros */
id|n
op_assign
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;%d&quot;
comma
id|s.token
)paren
suffix:semicolon
id|len
op_assign
id|strlen
c_func
(paren
id|tmp
)paren
suffix:semicolon
r_while
c_loop
(paren
id|strlen
c_func
(paren
id|tmp
)paren
OL
l_int|4
)paren
id|n
op_add_assign
id|sprintf
(paren
id|tmp
op_plus
id|n
comma
l_string|&quot;0&quot;
)paren
suffix:semicolon
multiline_comment|/* invert the string */
r_while
c_loop
(paren
id|tmp
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
id|i
OL
id|len
)paren
id|tmp2
(braket
l_int|4
op_minus
id|len
op_plus
id|i
)braket
op_assign
id|tmp
(braket
id|i
)braket
suffix:semicolon
r_else
id|tmp2
(braket
l_int|3
op_minus
id|i
)braket
op_assign
id|tmp
(braket
id|i
)braket
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
id|tmp2
(braket
l_int|4
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|sprintf
(paren
id|rstr
comma
id|SENSOR_PREFIX
l_string|&quot;%s&quot;
comma
id|tmp2
)paren
suffix:semicolon
id|ret
op_assign
(paren
r_char
op_star
)paren
id|get_property
c_func
(paren
id|rtas
comma
id|rstr
comma
op_amp
id|llen
)paren
suffix:semicolon
id|n
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ret
(braket
l_int|0
)braket
op_eq
l_char|&squot;&bslash;0&squot;
)paren
id|n
op_add_assign
id|sprintf
(paren
id|buffer
op_plus
id|n
comma
l_string|&quot;--- &quot;
)paren
suffix:semicolon
multiline_comment|/* does not have a location */
r_else
(brace
r_char
id|t
(braket
l_int|50
)braket
suffix:semicolon
id|ret
op_add_assign
id|pos
suffix:semicolon
id|n
op_add_assign
id|check_location_string
c_func
(paren
id|ret
comma
id|buffer
op_plus
id|n
)paren
suffix:semicolon
id|n
op_add_assign
id|sprintf
(paren
id|buffer
op_plus
id|n
comma
l_string|&quot; &quot;
)paren
suffix:semicolon
multiline_comment|/* see how many characters we have printed */
id|sprintf
(paren
id|t
comma
l_string|&quot;%s &quot;
comma
id|ret
)paren
suffix:semicolon
id|pos
op_add_assign
id|strlen
c_func
(paren
id|t
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_ge
id|llen
)paren
id|pos
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|n
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
multiline_comment|/* INDICATORS - Tone Frequency                                        */
multiline_comment|/* ****************************************************************** */
DECL|function|ppc_rtas_tone_freq_write
r_static
id|ssize_t
id|ppc_rtas_tone_freq_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
r_int
id|freq
suffix:semicolon
r_char
op_star
id|dest
suffix:semicolon
r_int
id|error
suffix:semicolon
id|freq
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
op_amp
id|dest
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|dest
op_ne
l_char|&squot;&bslash;0&squot;
op_logical_and
op_star
id|dest
op_ne
l_char|&squot;&bslash;n&squot;
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ppc_rtas_tone_freq_write: Invalid tone freqency&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_if
c_cond
(paren
id|freq
OL
l_int|0
)paren
id|freq
op_assign
l_int|0
suffix:semicolon
id|rtas_tone_frequency
op_assign
id|freq
suffix:semicolon
multiline_comment|/* save it for later */
id|error
op_assign
id|call_rtas
c_func
(paren
l_string|&quot;set-indicator&quot;
comma
l_int|3
comma
l_int|1
comma
l_int|NULL
comma
id|TONE_FREQUENCY
comma
l_int|0
comma
id|freq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;error: setting tone frequency returned: %s&bslash;n&quot;
comma
id|ppc_rtas_process_error
c_func
(paren
id|error
)paren
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
DECL|function|ppc_rtas_tone_freq_read
r_static
id|ssize_t
id|ppc_rtas_tone_freq_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
id|n
suffix:semicolon
id|n
op_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%lu&bslash;n&quot;
comma
id|rtas_tone_frequency
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|ppos
op_ge
id|strlen
c_func
(paren
id|buf
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
id|strlen
c_func
(paren
id|buf
)paren
op_minus
op_star
id|ppos
)paren
id|n
op_assign
id|strlen
c_func
(paren
id|buf
)paren
op_minus
op_star
id|ppos
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
id|count
)paren
id|n
op_assign
id|count
suffix:semicolon
op_star
id|ppos
op_add_assign
id|n
suffix:semicolon
r_return
id|n
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
multiline_comment|/* INDICATORS - Tone Volume                                           */
multiline_comment|/* ****************************************************************** */
DECL|function|ppc_rtas_tone_volume_write
r_static
id|ssize_t
id|ppc_rtas_tone_volume_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
r_int
id|volume
suffix:semicolon
r_char
op_star
id|dest
suffix:semicolon
r_int
id|error
suffix:semicolon
id|volume
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
op_amp
id|dest
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|dest
op_ne
l_char|&squot;&bslash;0&squot;
op_logical_and
op_star
id|dest
op_ne
l_char|&squot;&bslash;n&squot;
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ppc_rtas_tone_volume_write: Invalid tone volume&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_if
c_cond
(paren
id|volume
OL
l_int|0
)paren
id|volume
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|volume
OG
l_int|100
)paren
id|volume
op_assign
l_int|100
suffix:semicolon
id|rtas_tone_volume
op_assign
id|volume
suffix:semicolon
multiline_comment|/* save it for later */
id|error
op_assign
id|call_rtas
c_func
(paren
l_string|&quot;set-indicator&quot;
comma
l_int|3
comma
l_int|1
comma
l_int|NULL
comma
id|TONE_VOLUME
comma
l_int|0
comma
id|volume
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;error: setting tone volume returned: %s&bslash;n&quot;
comma
id|ppc_rtas_process_error
c_func
(paren
id|error
)paren
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
DECL|function|ppc_rtas_tone_volume_read
r_static
id|ssize_t
id|ppc_rtas_tone_volume_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
id|n
suffix:semicolon
id|n
op_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%lu&bslash;n&quot;
comma
id|rtas_tone_volume
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|ppos
op_ge
id|strlen
c_func
(paren
id|buf
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
id|strlen
c_func
(paren
id|buf
)paren
op_minus
op_star
id|ppos
)paren
id|n
op_assign
id|strlen
c_func
(paren
id|buf
)paren
op_minus
op_star
id|ppos
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
id|count
)paren
id|n
op_assign
id|count
suffix:semicolon
op_star
id|ppos
op_add_assign
id|n
suffix:semicolon
r_return
id|n
suffix:semicolon
)brace
eof
