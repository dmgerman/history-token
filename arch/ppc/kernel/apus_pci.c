multiline_comment|/*&n; * BK Id: SCCS/s.apus_pci.c 1.3 05/17/01 18:14:21 cort&n; */
multiline_comment|/*&n; * Copyright (C) Michel D&#xfffd;nzer &lt;michdaen@iiic.ethz.ch&gt;&n; *&n; * APUS PCI routines.&n; *&n; * Currently, only B/CVisionPPC cards (Permedia2) are supported.&n; *&n; * Thanks to Geert Uytterhoeven for the idea:&n; * Read values from given config space(s) for the first devices, -1 otherwise&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#ifdef CONFIG_AMIGA
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &quot;apus_pci.h&quot;
multiline_comment|/* These definitions are mostly adapted from pm2fb.c */
DECL|macro|APUS_PCI_MASTER_DEBUG
macro_line|#undef APUS_PCI_MASTER_DEBUG
macro_line|#ifdef APUS_PCI_MASTER_DEBUG
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(a,b...)&t;printk(KERN_DEBUG &quot;apus_pci: %s: &quot; a, __FUNCTION__ , ## b)
macro_line|#else
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(a,b...)
macro_line|#endif 
multiline_comment|/*&n; * The _DEFINITIVE_ memory mapping/unmapping functions.&n; * This is due to the fact that they&squot;re changing soooo often...&n; */
DECL|macro|DEFW
mdefine_line|#define DEFW()&t;&t;wmb()
DECL|macro|DEFR
mdefine_line|#define DEFR()&t;&t;rmb()
DECL|macro|DEFRW
mdefine_line|#define DEFRW()&t;&t;mb()
DECL|macro|DEVNO
mdefine_line|#define DEVNO(d)&t;((d)&gt;&gt;3)
DECL|macro|FNNO
mdefine_line|#define FNNO(d)&t;&t;((d)&amp;7)
r_extern
r_int
r_int
id|powerup_PCI_present
suffix:semicolon
DECL|variable|apus_hose
r_static
r_struct
id|pci_controller
op_star
id|apus_hose
suffix:semicolon
id|__apus
DECL|function|pci_io_base
r_void
op_star
id|pci_io_base
c_func
(paren
r_int
r_int
id|bus
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|cfg_read
mdefine_line|#define cfg_read(val, addr, type, op)&t;*val = op((type)(addr))
DECL|macro|cfg_write
mdefine_line|#define cfg_write(val, addr, type, op)&t;op((val), (type *)(addr)); DEFW()
DECL|macro|cfg_read_bad
mdefine_line|#define cfg_read_bad&t;*val = ~0;
DECL|macro|cfg_write_bad
mdefine_line|#define cfg_write_bad&t;;
DECL|macro|cfg_read_val
mdefine_line|#define cfg_read_val(val)&t;*val
DECL|macro|cfg_write_val
mdefine_line|#define cfg_write_val(val)&t;val
DECL|macro|APUS_PCI_OP
mdefine_line|#define APUS_PCI_OP(rw, size, type, op, mask)&t;&t;&t;&t;&t;&bslash;&n;__apus int&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;apus_pcibios_##rw##_config_##size(struct pci_dev *dev, int offset, type val)&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;int fnno = FNNO(dev-&gt;devfn);&t;&t;&t;&t;&t;&t;&bslash;&n;&t;int devno = DEVNO(dev-&gt;devfn);&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;if (dev-&gt;bus-&gt;number &gt; 0 || devno != 1) {&t;&t;&t;&t;&bslash;&n;&t;&t;cfg_##rw##_bad;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;return PCIBIOS_DEVICE_NOT_FOUND;&t;&t;&t;&t;&bslash;&n;&t;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;/* base address + function offset + offset ^ endianness conversion */&t;&bslash;&n;&t;cfg_##rw(val, apus_hose-&gt;cfg_data + (fnno&lt;&lt;5) + (offset ^ mask),&t;&bslash;&n;&t;&t; type, op);&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;DPRINTK(#op &quot; b: 0x%x, d: 0x%x, f: 0x%x, o: 0x%x, v: 0x%x&bslash;n&quot;,&t;&t;&bslash;&n;&t;&t;dev-&gt;bus-&gt;number, dev-&gt;devfn&gt;&gt;3, dev-&gt;devfn&amp;7,&t;&t;&t;&bslash;&n;&t;&t;offset, cfg_##rw##_val(val));&t;&t;&t;&t;&t;&bslash;&n;&t;return PCIBIOS_SUCCESSFUL;&t;&t;&t;&t;&t;&t;&bslash;&n;}
id|APUS_PCI_OP
c_func
(paren
id|read
comma
id|byte
comma
id|u8
op_star
comma
id|readb
comma
l_int|3
)paren
id|APUS_PCI_OP
c_func
(paren
id|read
comma
id|word
comma
id|u16
op_star
comma
id|readw
comma
l_int|2
)paren
id|APUS_PCI_OP
c_func
(paren
id|read
comma
id|dword
comma
id|u32
op_star
comma
id|readl
comma
l_int|0
)paren
id|APUS_PCI_OP
c_func
(paren
id|write
comma
id|byte
comma
id|u8
comma
id|writeb
comma
l_int|3
)paren
id|APUS_PCI_OP
c_func
(paren
id|write
comma
id|word
comma
id|u16
comma
id|writew
comma
l_int|2
)paren
id|APUS_PCI_OP
c_func
(paren
id|write
comma
id|dword
comma
id|u32
comma
id|writel
comma
l_int|0
)paren
DECL|variable|apus_pci_ops
r_static
r_struct
id|pci_ops
id|apus_pci_ops
op_assign
(brace
id|apus_pcibios_read_config_byte
comma
id|apus_pcibios_read_config_word
comma
id|apus_pcibios_read_config_dword
comma
id|apus_pcibios_write_config_byte
comma
id|apus_pcibios_write_config_word
comma
id|apus_pcibios_write_config_dword
)brace
suffix:semicolon
DECL|variable|pci_mem
r_static
r_struct
id|resource
id|pci_mem
op_assign
(brace
l_string|&quot;B/CVisionPPC PCI mem&quot;
comma
id|CVPPC_FB_APERTURE_ONE
comma
id|CVPPC_PCI_CONFIG
comma
id|IORESOURCE_MEM
)brace
suffix:semicolon
r_void
id|__init
DECL|function|apus_pcibios_fixup
id|apus_pcibios_fixup
c_func
(paren
r_void
)paren
(brace
multiline_comment|/*&t;struct pci_dev *dev = pci_find_slot(0, 1&lt;&lt;3);&n;&t;unsigned int reg, val, offset;*/
multiline_comment|/* FIXME: interrupt? */
multiline_comment|/*dev-&gt;interrupt = xxx;*/
id|request_resource
c_func
(paren
op_amp
id|iomem_resource
comma
op_amp
id|pci_mem
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: PCI mem resource requested&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
DECL|function|apus_pcibios_fixup_bus
r_static
r_void
id|__init
id|apus_pcibios_fixup_bus
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
)paren
(brace
id|bus-&gt;resource
(braket
l_int|1
)braket
op_assign
op_amp
id|pci_mem
suffix:semicolon
)brace
multiline_comment|/* &n; * This is from pm2fb.c again&n; * &n; * Check if PCI (B/CVisionPPC) is available, initialize it and set up&n; * the pcibios_* pointers&n; */
r_void
id|__init
DECL|function|apus_setup_pci_ptrs
id|apus_setup_pci_ptrs
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|powerup_PCI_present
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;no PCI bridge detected&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;Phase5 B/CVisionPPC PCI bridge detected.&bslash;n&quot;
)paren
suffix:semicolon
id|apus_hose
op_assign
id|pcibios_alloc_controller
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|apus_hose
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;apus_pci: Can&squot;t allocate PCI controller structure&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|apus_hose-&gt;cfg_data
op_assign
id|ioremap
c_func
(paren
id|CVPPC_PCI_CONFIG
comma
l_int|256
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;apus_pci: unable to map PCI config region&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|apus_hose-&gt;cfg_addr
op_assign
id|ioremap
c_func
(paren
id|CSPPC_PCI_BRIDGE
comma
l_int|256
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;apus_pci: unable to map PCI bridge&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|writel
c_func
(paren
id|CSPPCF_BRIDGE_BIG_ENDIAN
comma
id|apus_hose-&gt;cfg_addr
op_plus
id|CSPPC_BRIDGE_ENDIAN
)paren
suffix:semicolon
id|DEFW
c_func
(paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|CVPPC_REGS_REGION
comma
id|apus_hose-&gt;cfg_data
op_plus
id|PCI_BASE_ADDRESS_0
)paren
suffix:semicolon
id|DEFW
c_func
(paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|CVPPC_FB_APERTURE_ONE
comma
id|apus_hose-&gt;cfg_data
op_plus
id|PCI_BASE_ADDRESS_1
)paren
suffix:semicolon
id|DEFW
c_func
(paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|CVPPC_FB_APERTURE_TWO
comma
id|apus_hose-&gt;cfg_data
op_plus
id|PCI_BASE_ADDRESS_2
)paren
suffix:semicolon
id|DEFW
c_func
(paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|CVPPC_ROM_ADDRESS
comma
id|apus_hose-&gt;cfg_data
op_plus
id|PCI_ROM_ADDRESS
)paren
suffix:semicolon
id|DEFW
c_func
(paren
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xef000000
op_or
id|PCI_COMMAND_IO
op_or
id|PCI_COMMAND_MEMORY
op_or
id|PCI_COMMAND_MASTER
comma
id|apus_hose-&gt;cfg_data
op_plus
id|PCI_COMMAND
)paren
suffix:semicolon
id|DEFW
c_func
(paren
)paren
suffix:semicolon
id|apus_hose-&gt;first_busno
op_assign
l_int|0
suffix:semicolon
id|apus_hose-&gt;last_busno
op_assign
l_int|0
suffix:semicolon
id|apus_hose-&gt;ops
op_assign
op_amp
id|apus_pci_ops
suffix:semicolon
id|ppc_md.pcibios_fixup
op_assign
id|apus_pcibios_fixup
suffix:semicolon
id|ppc_md.pcibios_fixup_bus
op_assign
id|apus_pcibios_fixup_bus
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_AMIGA */
eof
