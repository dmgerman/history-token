multiline_comment|/*&n; * BK Id: SCCS/s.feature.c 1.14 06/17/01 09:33:37 trini&n; */
multiline_comment|/*&n; *  arch/ppc/kernel/feature.c&n; *&n; *  Copyright (C) 1996 Paul Mackerras (paulus@cs.anu.edu.au)&n; *                     Ben. Herrenschmidt (benh@kernel.crashing.org)&n; *&n; *  This program is free software; you can redistribute it and/or&n; *  modify it under the terms of the GNU General Public License&n; *  as published by the Free Software Foundation; either version&n; *  2 of the License, or (at your option) any later version.&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/errno.h&gt;
macro_line|#include &lt;asm/ohare.h&gt;
macro_line|#include &lt;asm/heathrow.h&gt;
macro_line|#include &lt;asm/keylargo.h&gt;
macro_line|#include &lt;asm/uninorth.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/feature.h&gt;
macro_line|#include &lt;asm/dbdma.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
DECL|macro|DEBUG_FEATURE
macro_line|#undef DEBUG_FEATURE
DECL|macro|MAX_FEATURE_CONTROLLERS
mdefine_line|#define MAX_FEATURE_CONTROLLERS&t;&t;2
DECL|macro|FREG
mdefine_line|#define FREG(c,r)&t;&t;&t;(&amp;(((c)-&gt;reg)[(r)&gt;&gt;2]))
multiline_comment|/* Keylargo reg. access. */
DECL|macro|KL_FCR
mdefine_line|#define KL_FCR(r)&t;(keylargo_base + ((r) &gt;&gt; 2))
DECL|macro|KL_IN
mdefine_line|#define KL_IN(r)&t;(in_le32(KL_FCR(r)))
DECL|macro|KL_OUT
mdefine_line|#define KL_OUT(r,v)&t;(out_le32(KL_FCR(r), (v)))
DECL|macro|KL_BIS
mdefine_line|#define KL_BIS(r,v)&t;(KL_OUT((r), KL_IN(r) | (v)))
DECL|macro|KL_BIC
mdefine_line|#define KL_BIC(r,v)&t;(KL_OUT((r), KL_IN(r) &amp; ~(v)))
multiline_comment|/* Uni-N reg. access. Note that Uni-N regs are big endian */
DECL|macro|UN_REG
mdefine_line|#define UN_REG(r)&t;(uninorth_base + ((r) &gt;&gt; 2))
DECL|macro|UN_IN
mdefine_line|#define UN_IN(r)&t;(in_be32(UN_REG(r)))
DECL|macro|UN_OUT
mdefine_line|#define UN_OUT(r,v)&t;(out_be32(UN_REG(r), (v)))
DECL|macro|UN_BIS
mdefine_line|#define UN_BIS(r,v)&t;(UN_OUT((r), UN_IN(r) | (v)))
DECL|macro|UN_BIC
mdefine_line|#define UN_BIC(r,v)&t;(UN_OUT((r), UN_IN(r) &amp; ~(v)))
DECL|struct|feature_bit
r_typedef
r_struct
id|feature_bit
(brace
DECL|member|reg
r_int
id|reg
suffix:semicolon
multiline_comment|/* reg. offset from mac-io base */
DECL|member|polarity
r_int
r_int
id|polarity
suffix:semicolon
multiline_comment|/* 0 = normal, 1 = inverse */
DECL|member|mask
r_int
r_int
id|mask
suffix:semicolon
multiline_comment|/* bit mask */
DECL|typedef|fbit
)brace
id|fbit
suffix:semicolon
multiline_comment|/* Those features concern for OHare-based PowerBooks (2400, 3400, 3500)&n; */
DECL|variable|feature_bits_ohare_pbook
r_static
id|fbit
id|feature_bits_ohare_pbook
(braket
)braket
op_assign
(brace
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_null */
(brace
l_int|0x38
comma
l_int|0
comma
id|OH_SCC_RESET
)brace
comma
multiline_comment|/* FEATURE_Serial_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|OH_SCC_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Serial_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|OH_SCCA_IO
)brace
comma
multiline_comment|/* FEATURE_Serial_IO_A */
(brace
l_int|0x38
comma
l_int|0
comma
id|OH_SCCB_IO
)brace
comma
multiline_comment|/* FEATURE_Serial_IO_B */
(brace
l_int|0x38
comma
l_int|0
comma
id|OH_FLOPPY_ENABLE
)brace
comma
multiline_comment|/* FEATURE_SWIM3_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|OH_MESH_ENABLE
)brace
comma
multiline_comment|/* FEATURE_MESH_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|OH_IDE0_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IDE0_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|OH_IDE0_RESET_N
)brace
comma
multiline_comment|/* FEATURE_IDE0_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|OH_IOBUS_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IOBUS_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|OH_BAY_RESET_N
)brace
comma
multiline_comment|/* FEATURE_Mediabay_reset */
(brace
l_int|0x38
comma
l_int|1
comma
id|OH_BAY_POWER_N
)brace
comma
multiline_comment|/* FEATURE_Mediabay_power */
(brace
l_int|0x38
comma
l_int|0
comma
id|OH_BAY_PCI_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Mediabay_PCI_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|OH_BAY_IDE_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IDE1_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|OH_IDE1_RESET_N
)brace
comma
multiline_comment|/* FEATURE_IDE1_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|OH_BAY_FLOPPY_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Mediabay_floppy_enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_BMac_reset */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_BMac_IO_enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Modem_power */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Slow_SCC_PCLK */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Sound_Power */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Sound_CLK_Enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_IDE2_enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_IDE2_reset */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_IDE_switch */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_content */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Airport_reset */
)brace
suffix:semicolon
multiline_comment|/* Those bits concern heathrow-based desktop machines (Beige G3s). We have removed&n; * the SCC related bits and init them once. They have proven to occasionally cause&n; * problems with the desktop units.&n; */
DECL|variable|feature_bits_heathrow
r_static
id|fbit
id|feature_bits_heathrow
(braket
)braket
op_assign
(brace
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_null */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Serial_reset */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Serial_enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Serial_IO_A */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Serial_IO_B */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SWIM_ENABLE
)brace
comma
multiline_comment|/* FEATURE_SWIM3_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_MESH_ENABLE
)brace
comma
multiline_comment|/* FEATURE_MESH_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_IDE0_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IDE0_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_IDE0_RESET_N
)brace
comma
multiline_comment|/* FEATURE_IDE0_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_IOBUS_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IOBUS_enable */
(brace
l_int|0x38
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_reset */
(brace
l_int|0x38
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_power */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_PCI_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BAY_IDE_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IDE1_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_IDE1_RESET_N
)brace
comma
multiline_comment|/* FEATURE_IDE1_reset */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_floppy_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BMAC_RESET
)brace
comma
multiline_comment|/* FEATURE_BMac_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BMAC_IO_ENABLE
)brace
comma
multiline_comment|/* FEATURE_BMac_IO_enable */
(brace
l_int|0x38
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Modem_power */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SLOW_SCC_PCLK
)brace
comma
multiline_comment|/* FEATURE_Slow_SCC_PCLK */
(brace
l_int|0x38
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Sound_Power */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Sound_CLK_Enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_IDE2_enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_IDE2_reset */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_IDE_switch */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_content */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Airport_reset */
)brace
suffix:semicolon
multiline_comment|/* Those bits concern heathrow-based PowerBooks (wallstreet/mainstreet).&n; * Heathrow-based desktop macs (Beige G3s) are _not_ handled here&n; */
DECL|variable|feature_bits_wallstreet
r_static
id|fbit
id|feature_bits_wallstreet
(braket
)braket
op_assign
(brace
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_null */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_RESET_SCC
)brace
comma
multiline_comment|/* FEATURE_Serial_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SCC_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Serial_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SCCA_IO
)brace
comma
multiline_comment|/* FEATURE_Serial_IO_A */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SCCB_IO
)brace
comma
multiline_comment|/* FEATURE_Serial_IO_B */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SWIM_ENABLE
)brace
comma
multiline_comment|/* FEATURE_SWIM3_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_MESH_ENABLE
)brace
comma
multiline_comment|/* FEATURE_MESH_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_IDE0_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IDE0_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_IDE0_RESET_N
)brace
comma
multiline_comment|/* FEATURE_IDE0_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_IOBUS_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IOBUS_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_BAY_RESET_N
)brace
comma
multiline_comment|/* FEATURE_Mediabay_reset */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_BAY_POWER_N
)brace
comma
multiline_comment|/* FEATURE_Mediabay_power */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BAY_PCI_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Mediabay_PCI_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BAY_IDE_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IDE1_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_IDE1_RESET_N
)brace
comma
multiline_comment|/* FEATURE_IDE1_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BAY_FLOPPY_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Mediabay_floppy_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BMAC_RESET
)brace
comma
multiline_comment|/* FEATURE_BMac_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BMAC_IO_ENABLE
)brace
comma
multiline_comment|/* FEATURE_BMac_IO_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_MODEM_POWER_N
)brace
comma
multiline_comment|/* FEATURE_Modem_power */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SLOW_SCC_PCLK
)brace
comma
multiline_comment|/* FEATURE_Slow_SCC_PCLK */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_SOUND_POWER_N
)brace
comma
multiline_comment|/* FEATURE_Sound_Power */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SOUND_CLK_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Sound_CLK_Enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_IDE2_enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_IDE2_reset */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_IDE_switch */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_content */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Airport_reset */
)brace
suffix:semicolon
multiline_comment|/*&n; * Those bits are from a 1999 G3 PowerBook, with a paddington chip.&n; * Mostly the same as the heathrow. They are used on both PowerBooks&n; * and desktop machines using the paddington chip&n; */
DECL|variable|feature_bits_paddington
r_static
id|fbit
id|feature_bits_paddington
(braket
)braket
op_assign
(brace
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_null */
(brace
l_int|0x38
comma
l_int|0
comma
id|PADD_RESET_SCC
)brace
comma
multiline_comment|/* FEATURE_Serial_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SCC_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Serial_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SCCA_IO
)brace
comma
multiline_comment|/* FEATURE_Serial_IO_A */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SCCB_IO
)brace
comma
multiline_comment|/* FEATURE_Serial_IO_B */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SWIM_ENABLE
)brace
comma
multiline_comment|/* FEATURE_SWIM3_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_MESH_ENABLE
)brace
comma
multiline_comment|/* FEATURE_MESH_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_IDE0_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IDE0_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_IDE0_RESET_N
)brace
comma
multiline_comment|/* FEATURE_IDE0_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_IOBUS_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IOBUS_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_BAY_RESET_N
)brace
comma
multiline_comment|/* FEATURE_Mediabay_reset */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_BAY_POWER_N
)brace
comma
multiline_comment|/* FEATURE_Mediabay_power */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BAY_PCI_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Mediabay_PCI_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BAY_IDE_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IDE1_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_IDE1_RESET_N
)brace
comma
multiline_comment|/* FEATURE_IDE1_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BAY_FLOPPY_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Mediabay_floppy_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BMAC_RESET
)brace
comma
multiline_comment|/* FEATURE_BMac_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_BMAC_IO_ENABLE
)brace
comma
multiline_comment|/* FEATURE_BMac_IO_enable */
(brace
l_int|0x38
comma
l_int|1
comma
id|PADD_MODEM_POWER_N
)brace
comma
multiline_comment|/* FEATURE_Modem_power */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SLOW_SCC_PCLK
)brace
comma
multiline_comment|/* FEATURE_Slow_SCC_PCLK */
(brace
l_int|0x38
comma
l_int|1
comma
id|HRW_SOUND_POWER_N
)brace
comma
multiline_comment|/* FEATURE_Sound_Power */
(brace
l_int|0x38
comma
l_int|0
comma
id|HRW_SOUND_CLK_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Sound_CLK_Enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_IDE2_enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_IDE2_reset */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_IDE_switch */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_content */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Airport_reset */
)brace
suffix:semicolon
multiline_comment|/* Those bits are for Core99 machines (iBook,G4,iMacSL/DV,Pismo,...).&n; * Note: Different sets may be needed for iBook, especially for sound&n; */
DECL|variable|feature_bits_keylargo
r_static
id|fbit
id|feature_bits_keylargo
(braket
)braket
op_assign
(brace
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_null */
(brace
l_int|0x38
comma
l_int|0
comma
id|KL0_SCC_RESET
)brace
comma
multiline_comment|/* FEATURE_Serial_reset */
(brace
l_int|0x38
comma
l_int|0
comma
id|KL0_SERIAL_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Serial_enable */
(brace
l_int|0x38
comma
l_int|0
comma
id|KL0_SCC_A_INTF_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Serial_IO_A */
(brace
l_int|0x38
comma
l_int|0
comma
id|KL0_SCC_B_INTF_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Serial_IO_B */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_SWIM3_enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_MESH_enable */
(brace
l_int|0x3c
comma
l_int|0
comma
id|KL1_EIDE0_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IDE0_enable */
(brace
l_int|0x3c
comma
l_int|1
comma
id|KL1_EIDE0_RESET_N
)brace
comma
multiline_comment|/* FEATURE_IDE0_reset */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_IOBUS_enable */
(brace
l_int|0x34
comma
l_int|1
comma
id|KL_MBCR_MB0_DEV_RESET
)brace
comma
multiline_comment|/* FEATURE_Mediabay_reset */
(brace
l_int|0x34
comma
l_int|1
comma
id|KL_MBCR_MB0_DEV_POWER
)brace
comma
multiline_comment|/* FEATURE_Mediabay_power */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_PCI_enable */
(brace
l_int|0x3c
comma
l_int|0
comma
id|KL1_EIDE1_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IDE1_enable */
(brace
l_int|0x3c
comma
l_int|1
comma
id|KL1_EIDE1_RESET_N
)brace
comma
multiline_comment|/* FEATURE_IDE1_reset */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Mediabay_floppy_enable */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_BMac_reset */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_BMac_IO_enable */
(brace
l_int|0x40
comma
l_int|1
comma
id|KL2_MODEM_POWER_N
)brace
comma
multiline_comment|/* FEATURE_Modem_power */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Slow_SCC_PCLK */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Sound_Power */
(brace
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* FEATURE_Sound_CLK_Enable */
(brace
l_int|0x3c
comma
l_int|0
comma
id|KL1_UIDE_ENABLE
)brace
comma
multiline_comment|/* FEATURE_IDE2_enable */
(brace
l_int|0x3c
comma
l_int|1
comma
id|KL1_UIDE_RESET_N
)brace
comma
multiline_comment|/* FEATURE_IDE2_reset */
(brace
l_int|0x34
comma
l_int|0
comma
id|KL_MBCR_MB0_DEV_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Mediabay_IDE_switch */
(brace
l_int|0x34
comma
l_int|0
comma
id|KL_MBCR_MB0_ENABLE
)brace
comma
multiline_comment|/* FEATURE_Mediabay_content */
(brace
l_int|0x40
comma
l_int|1
comma
id|KL2_AIRPORT_RESET_N
)brace
comma
multiline_comment|/* FEATURE_Airport_reset */
)brace
suffix:semicolon
multiline_comment|/* definition of a feature controller object */
DECL|struct|feature_controller
r_struct
id|feature_controller
(brace
DECL|member|bits
id|fbit
op_star
id|bits
suffix:semicolon
DECL|member|reg
r_volatile
id|u32
op_star
id|reg
suffix:semicolon
DECL|member|device
r_struct
id|device_node
op_star
id|device
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* static functions */
r_static
r_struct
id|feature_controller
op_star
id|feature_add_controller
c_func
(paren
r_struct
id|device_node
op_star
id|controller_device
comma
id|fbit
op_star
id|bits
)paren
suffix:semicolon
r_static
r_struct
id|feature_controller
op_star
id|feature_lookup_controller
c_func
(paren
r_struct
id|device_node
op_star
id|device
)paren
suffix:semicolon
r_static
r_void
id|uninorth_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|keylargo_init
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
r_static
r_void
id|heathrow_prepare_for_sleep
c_func
(paren
r_struct
id|feature_controller
op_star
id|ctrler
)paren
suffix:semicolon
r_static
r_void
id|heathrow_wakeup
c_func
(paren
r_struct
id|feature_controller
op_star
id|ctrler
)paren
suffix:semicolon
r_static
r_void
id|core99_prepare_for_sleep
c_func
(paren
r_struct
id|feature_controller
op_star
id|ctrler
)paren
suffix:semicolon
r_static
r_void
id|core99_wake_up
c_func
(paren
r_struct
id|feature_controller
op_star
id|ctrler
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PMAC_PBOOK */
multiline_comment|/* static variables */
DECL|variable|controllers
r_static
r_struct
id|feature_controller
id|controllers
(braket
id|MAX_FEATURE_CONTROLLERS
)braket
suffix:semicolon
DECL|variable|controller_count
r_static
r_int
id|controller_count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Core99 stuffs */
DECL|variable|uninorth_base
multiline_comment|/*static*/
r_volatile
id|u32
op_star
id|uninorth_base
suffix:semicolon
DECL|variable|keylargo_base
r_static
r_volatile
id|u32
op_star
id|keylargo_base
suffix:semicolon
DECL|variable|keylargo
r_static
r_struct
id|feature_controller
op_star
id|keylargo
suffix:semicolon
DECL|variable|uninorth_rev
r_static
r_int
id|uninorth_rev
suffix:semicolon
DECL|variable|keylargo_rev
r_static
r_int
id|keylargo_rev
suffix:semicolon
DECL|variable|board_features
r_static
id|u32
id|board_features
suffix:semicolon
DECL|variable|airport_pwr_regs
r_static
id|u8
id|airport_pwr_regs
(braket
l_int|5
)braket
suffix:semicolon
DECL|variable|airport_pwr_state
r_static
r_int
id|airport_pwr_state
suffix:semicolon
DECL|variable|airport_dev
r_static
r_struct
id|device_node
op_star
id|airport_dev
suffix:semicolon
DECL|macro|FTR_NEED_OPENPIC_TWEAK
mdefine_line|#define FTR_NEED_OPENPIC_TWEAK&t;&t;0x00000001
DECL|macro|FTR_CAN_NAP
mdefine_line|#define FTR_CAN_NAP&t;&t;&t;0x00000002
DECL|macro|FTR_HAS_FW_POWER
mdefine_line|#define FTR_HAS_FW_POWER&t;&t;0x00000004
DECL|macro|FTR_CAN_SLEEP
mdefine_line|#define FTR_CAN_SLEEP&t;&t;&t;0x00000008
DECL|struct|board_features_t
r_static
r_struct
id|board_features_t
(brace
DECL|member|compatible
r_char
op_star
id|compatible
suffix:semicolon
DECL|member|features
id|u32
id|features
suffix:semicolon
DECL|variable|__initdata
)brace
id|board_features_datas
(braket
)braket
id|__initdata
op_assign
(brace
(brace
l_string|&quot;AAPL,PowerMac G3&quot;
comma
l_int|0
)brace
comma
multiline_comment|/* Beige G3 */
(brace
l_string|&quot;iMac,1&quot;
comma
l_int|0
)brace
comma
multiline_comment|/* First iMac (gossamer) */
(brace
l_string|&quot;PowerMac1,1&quot;
comma
l_int|0
)brace
comma
multiline_comment|/* B&amp;W G3 / Yikes */
(brace
l_string|&quot;PowerMac1,2&quot;
comma
l_int|0
)brace
comma
multiline_comment|/* B&amp;W G3 / Yikes */
(brace
l_string|&quot;PowerMac2,1&quot;
comma
id|FTR_CAN_SLEEP
)brace
comma
multiline_comment|/* r128 based iMac */
(brace
l_string|&quot;PowerMac2,2&quot;
comma
id|FTR_HAS_FW_POWER
op_or
id|FTR_CAN_SLEEP
)brace
comma
multiline_comment|/* Summer 2000 iMac */
(brace
l_string|&quot;PowerMac4,1&quot;
comma
id|FTR_CAN_SLEEP
)brace
comma
multiline_comment|/* iMac &quot;Flower Power&quot; */
(brace
l_string|&quot;PowerMac3,1&quot;
comma
id|FTR_NEED_OPENPIC_TWEAK
)brace
comma
multiline_comment|/* Sawtooth (G4) */
(brace
l_string|&quot;PowerMac3,2&quot;
comma
l_int|0
)brace
comma
multiline_comment|/* G4/Dual G4 */
(brace
l_string|&quot;PowerMac3,3&quot;
comma
id|FTR_NEED_OPENPIC_TWEAK
)brace
comma
multiline_comment|/* G4/Dual G4 */
(brace
l_string|&quot;PowerMac5,1&quot;
comma
l_int|0
)brace
comma
multiline_comment|/* Cube */
(brace
l_string|&quot;AAPL,3400/2400&quot;
comma
id|FTR_CAN_SLEEP
)brace
comma
multiline_comment|/* 2400/3400 PowerBook */
(brace
l_string|&quot;AAPL,3500&quot;
comma
id|FTR_CAN_SLEEP
)brace
comma
multiline_comment|/* 3500 PowerBook (G3) */
(brace
l_string|&quot;AAPL,PowerBook1998&quot;
comma
id|FTR_CAN_SLEEP
)brace
comma
multiline_comment|/* Wallstreet PowerBook */
(brace
l_string|&quot;PowerBook1,1&quot;
comma
id|FTR_CAN_SLEEP
)brace
comma
multiline_comment|/* 101 (Lombard) PowerBook */
(brace
l_string|&quot;PowerBook2,1&quot;
comma
id|FTR_CAN_SLEEP
)brace
comma
multiline_comment|/* iBook */
(brace
l_string|&quot;PowerBook4,1&quot;
comma
id|FTR_CAN_NAP
op_or
id|FTR_CAN_SLEEP
)brace
comma
multiline_comment|/* iBook Dual USB */
(brace
l_string|&quot;PowerBook2,2&quot;
comma
id|FTR_CAN_SLEEP
multiline_comment|/*| FTR_CAN_NAP*/
)brace
comma
multiline_comment|/* iBook FireWire */
(brace
l_string|&quot;PowerBook3,1&quot;
comma
id|FTR_CAN_SLEEP
op_or
id|FTR_CAN_NAP
op_or
multiline_comment|/* PowerBook 2000 (Pismo) */
id|FTR_HAS_FW_POWER
)brace
comma
(brace
l_string|&quot;PowerBook3,2&quot;
comma
id|FTR_CAN_NAP
op_or
id|FTR_CAN_SLEEP
)brace
comma
multiline_comment|/* PowerBook Titanium */
(brace
l_int|NULL
comma
l_int|0
)brace
)brace
suffix:semicolon
r_extern
r_int
r_int
id|powersave_nap
suffix:semicolon
r_void
DECL|function|feature_init
id|feature_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|np
suffix:semicolon
id|u32
op_star
id|rev
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|_machine
op_ne
id|_MACH_Pmac
)paren
r_return
suffix:semicolon
multiline_comment|/* Figure out motherboard type &amp; options */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|board_features_datas
(braket
id|i
)braket
dot
id|compatible
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|machine_is_compatible
c_func
(paren
id|board_features_datas
(braket
id|i
)braket
dot
id|compatible
)paren
)paren
(brace
id|board_features
op_assign
id|board_features_datas
(braket
id|i
)braket
dot
id|features
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Set default value of powersave_nap on machines that support it */
r_if
c_cond
(paren
id|board_features
op_amp
id|FTR_CAN_NAP
)paren
id|powersave_nap
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Track those poor mac-io&squot;s */
id|np
op_assign
id|find_devices
c_func
(paren
l_string|&quot;mac-io&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|np
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* KeyLargo contains several (5 ?) FCR registers in mac-io,&n;&t;&t; * plus some gpio&squot;s which could eventually be handled here.&n;&t;&t; */
r_if
c_cond
(paren
id|device_is_compatible
c_func
(paren
id|np
comma
l_string|&quot;Keylargo&quot;
)paren
)paren
(brace
r_struct
id|feature_controller
op_star
id|ctrler
op_assign
id|feature_add_controller
c_func
(paren
id|np
comma
id|feature_bits_keylargo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ctrler
)paren
(brace
id|keylargo
op_assign
id|ctrler
suffix:semicolon
id|keylargo_base
op_assign
id|ctrler-&gt;reg
suffix:semicolon
id|rev
op_assign
(paren
id|u32
op_star
)paren
id|get_property
c_func
(paren
id|ctrler-&gt;device
comma
l_string|&quot;revision-id&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rev
)paren
id|keylargo_rev
op_assign
op_star
id|rev
suffix:semicolon
id|rev
op_assign
(paren
id|u32
op_star
)paren
id|get_property
c_func
(paren
id|ctrler-&gt;device
comma
l_string|&quot;device-id&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rev
op_logical_and
(paren
op_star
id|rev
)paren
op_eq
l_int|0x0025
)paren
id|keylargo_rev
op_or_assign
id|KL_PANGEA_REV
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|device_is_compatible
c_func
(paren
id|np
comma
l_string|&quot;paddington&quot;
)paren
)paren
(brace
id|feature_add_controller
c_func
(paren
id|np
comma
id|feature_bits_paddington
)paren
suffix:semicolon
multiline_comment|/* We disable the modem power bit on Yikes as it can&n;&t;&t;&t; * do bad things (it&squot;s the nvram power)&n;&t;&t;&t; */
r_if
c_cond
(paren
id|machine_is_compatible
c_func
(paren
l_string|&quot;PowerMac1,1&quot;
)paren
op_logical_or
id|machine_is_compatible
c_func
(paren
l_string|&quot;PowerMac1,2&quot;
)paren
)paren
(brace
id|feature_bits_paddington
(braket
id|FEATURE_Modem_power
)braket
dot
id|mask
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|machine_is_compatible
c_func
(paren
l_string|&quot;AAPL,PowerBook1998&quot;
)paren
)paren
(brace
id|feature_add_controller
c_func
(paren
id|np
comma
id|feature_bits_wallstreet
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|feature_controller
op_star
id|ctrler
op_assign
id|feature_add_controller
c_func
(paren
id|np
comma
id|feature_bits_heathrow
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ctrler
)paren
id|out_le32
c_func
(paren
id|FREG
c_func
(paren
id|ctrler
comma
id|HEATHROW_FEATURE_REG
)paren
comma
id|in_le32
c_func
(paren
id|FREG
c_func
(paren
id|ctrler
comma
id|HEATHROW_FEATURE_REG
)paren
)paren
op_or
id|HRW_DEFAULTS
)paren
suffix:semicolon
)brace
id|np
op_assign
id|np-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|controller_count
op_eq
l_int|0
)paren
(brace
id|np
op_assign
id|find_devices
c_func
(paren
l_string|&quot;ohare&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np
)paren
(brace
r_if
c_cond
(paren
id|find_devices
c_func
(paren
l_string|&quot;via-pmu&quot;
)paren
op_ne
l_int|NULL
)paren
id|feature_add_controller
c_func
(paren
id|np
comma
id|feature_bits_ohare_pbook
)paren
suffix:semicolon
r_else
multiline_comment|/* else not sure; maybe this is a Starmax? */
id|feature_add_controller
c_func
(paren
id|np
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Locate core99 Uni-N */
id|np
op_assign
id|find_devices
c_func
(paren
l_string|&quot;uni-n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np
op_logical_and
id|np-&gt;n_addrs
OG
l_int|0
)paren
(brace
id|uninorth_base
op_assign
id|ioremap
c_func
(paren
id|np-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
comma
l_int|0x1000
)paren
suffix:semicolon
id|uninorth_rev
op_assign
id|in_be32
c_func
(paren
id|UN_REG
c_func
(paren
id|UNI_N_VERSION
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Uninorth at 0x%08x&bslash;n&quot;
comma
id|np-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uninorth_base
op_logical_and
id|keylargo_base
)paren
id|printk
c_func
(paren
l_string|&quot;Uni-N revision: %d, KeyLargo revision: %d&bslash;n&quot;
comma
id|uninorth_rev
comma
id|keylargo_rev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uninorth_base
)paren
id|uninorth_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|keylargo_base
)paren
id|keylargo_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|controller_count
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Registered %d feature controller(s)&bslash;n&quot;
comma
id|controller_count
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_PMAC_PBOOK) &amp;&amp; !defined(CONFIG_DMASOUND_AWACS)
multiline_comment|/* On PowerBooks, we disable the sound chip when dmasound is a module&n;&t; * or not used at all&n;&t; */
r_if
c_cond
(paren
id|controller_count
op_logical_and
id|find_devices
c_func
(paren
l_string|&quot;via-pmu&quot;
)paren
op_ne
l_int|NULL
)paren
(brace
id|feature_clear
c_func
(paren
id|controllers
(braket
l_int|0
)braket
dot
id|device
comma
id|FEATURE_Sound_power
)paren
suffix:semicolon
id|feature_clear
c_func
(paren
id|controllers
(braket
l_int|0
)braket
dot
id|device
comma
id|FEATURE_Sound_CLK_enable
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
r_static
r_struct
id|feature_controller
op_star
DECL|function|feature_add_controller
id|feature_add_controller
c_func
(paren
r_struct
id|device_node
op_star
id|controller_device
comma
id|fbit
op_star
id|bits
)paren
(brace
r_struct
id|feature_controller
op_star
id|controller
suffix:semicolon
r_if
c_cond
(paren
id|controller_count
op_ge
id|MAX_FEATURE_CONTROLLERS
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Feature controller %s skipped(MAX:%d)&bslash;n&quot;
comma
id|controller_device-&gt;full_name
comma
id|MAX_FEATURE_CONTROLLERS
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|controller
op_assign
op_amp
id|controllers
(braket
id|controller_count
)braket
suffix:semicolon
id|controller-&gt;bits
op_assign
id|bits
suffix:semicolon
id|controller-&gt;device
op_assign
id|controller_device
suffix:semicolon
r_if
c_cond
(paren
id|controller_device-&gt;n_addrs
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;No addresses for %s&bslash;n&quot;
comma
id|controller_device-&gt;full_name
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* We remap the entire mac-io here. Normally, this will just&n;&t; * give us back our already existing BAT mapping&n;&t; */
id|controller-&gt;reg
op_assign
(paren
r_volatile
id|u32
op_star
)paren
id|ioremap
c_func
(paren
id|controller_device-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
comma
id|controller_device-&gt;addrs
(braket
l_int|0
)braket
dot
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Twiddling the magic ohare bits&bslash;n&quot;
)paren
suffix:semicolon
id|out_le32
c_func
(paren
id|FREG
c_func
(paren
id|controller
comma
id|OHARE_FEATURE_REG
)paren
comma
id|STARMAX_FEATURES
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|controller-&gt;lock
)paren
suffix:semicolon
id|controller_count
op_increment
suffix:semicolon
r_return
id|controller
suffix:semicolon
)brace
r_static
r_struct
id|feature_controller
op_star
DECL|function|feature_lookup_controller
id|feature_lookup_controller
c_func
(paren
r_struct
id|device_node
op_star
id|device
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|device
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|device
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|controller_count
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|device
op_eq
id|controllers
(braket
id|i
)braket
dot
id|device
)paren
r_return
op_amp
id|controllers
(braket
id|i
)braket
suffix:semicolon
id|device
op_assign
id|device-&gt;parent
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_FEATURE
id|printk
c_func
(paren
l_string|&quot;feature: &lt;%s&gt; not found on any controller&bslash;n&quot;
comma
id|device-&gt;name
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
r_int
DECL|function|feature_set
id|feature_set
c_func
(paren
r_struct
id|device_node
op_star
id|device
comma
r_enum
id|system_feature
id|f
)paren
(brace
r_struct
id|feature_controller
op_star
id|controller
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|value
suffix:semicolon
id|fbit
op_star
id|bit
suffix:semicolon
r_if
c_cond
(paren
id|f
op_ge
id|FEATURE_last
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|controller
op_assign
id|feature_lookup_controller
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|controller
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|bit
op_assign
op_amp
id|controller-&gt;bits
(braket
id|f
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bit-&gt;mask
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#ifdef DEBUG_FEATURE
id|printk
c_func
(paren
l_string|&quot;feature: &lt;%s&gt; setting feature %d in controller @0x%x&bslash;n&quot;
comma
id|device-&gt;name
comma
(paren
r_int
)paren
id|f
comma
(paren
r_int
r_int
)paren
id|controller-&gt;reg
)paren
suffix:semicolon
macro_line|#endif
id|spin_lock_irqsave
c_func
(paren
op_amp
id|controller-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|value
op_assign
id|in_le32
c_func
(paren
id|FREG
c_func
(paren
id|controller
comma
id|bit-&gt;reg
)paren
)paren
suffix:semicolon
id|value
op_assign
id|bit-&gt;polarity
ques
c_cond
(paren
id|value
op_amp
op_complement
id|bit-&gt;mask
)paren
suffix:colon
(paren
id|value
op_or
id|bit-&gt;mask
)paren
suffix:semicolon
id|out_le32
c_func
(paren
id|FREG
c_func
(paren
id|controller
comma
id|bit-&gt;reg
)paren
comma
id|value
)paren
suffix:semicolon
(paren
r_void
)paren
id|in_le32
c_func
(paren
id|FREG
c_func
(paren
id|controller
comma
id|bit-&gt;reg
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|controller-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|feature_clear
id|feature_clear
c_func
(paren
r_struct
id|device_node
op_star
id|device
comma
r_enum
id|system_feature
id|f
)paren
(brace
r_struct
id|feature_controller
op_star
id|controller
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|value
suffix:semicolon
id|fbit
op_star
id|bit
suffix:semicolon
r_if
c_cond
(paren
id|f
op_ge
id|FEATURE_last
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|controller
op_assign
id|feature_lookup_controller
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|controller
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|bit
op_assign
op_amp
id|controller-&gt;bits
(braket
id|f
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bit-&gt;mask
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#ifdef DEBUG_FEATURE
id|printk
c_func
(paren
l_string|&quot;feature: &lt;%s&gt; clearing feature %d in controller @0x%x&bslash;n&quot;
comma
id|device-&gt;name
comma
(paren
r_int
)paren
id|f
comma
(paren
r_int
r_int
)paren
id|controller-&gt;reg
)paren
suffix:semicolon
macro_line|#endif
id|spin_lock_irqsave
c_func
(paren
op_amp
id|controller-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|value
op_assign
id|in_le32
c_func
(paren
id|FREG
c_func
(paren
id|controller
comma
id|bit-&gt;reg
)paren
)paren
suffix:semicolon
id|value
op_assign
id|bit-&gt;polarity
ques
c_cond
(paren
id|value
op_or
id|bit-&gt;mask
)paren
suffix:colon
(paren
id|value
op_amp
op_complement
id|bit-&gt;mask
)paren
suffix:semicolon
id|out_le32
c_func
(paren
id|FREG
c_func
(paren
id|controller
comma
id|bit-&gt;reg
)paren
comma
id|value
)paren
suffix:semicolon
(paren
r_void
)paren
id|in_le32
c_func
(paren
id|FREG
c_func
(paren
id|controller
comma
id|bit-&gt;reg
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|controller-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|feature_test
id|feature_test
c_func
(paren
r_struct
id|device_node
op_star
id|device
comma
r_enum
id|system_feature
id|f
)paren
(brace
r_struct
id|feature_controller
op_star
id|controller
suffix:semicolon
r_int
r_int
id|value
suffix:semicolon
id|fbit
op_star
id|bit
suffix:semicolon
r_if
c_cond
(paren
id|f
op_ge
id|FEATURE_last
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|controller
op_assign
id|feature_lookup_controller
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|controller
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|bit
op_assign
op_amp
id|controller-&gt;bits
(braket
id|f
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bit-&gt;mask
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#ifdef DEBUG_FEATURE
id|printk
c_func
(paren
l_string|&quot;feature: &lt;%s&gt; clearing feature %d in controller @0x%x&bslash;n&quot;
comma
id|device-&gt;name
comma
(paren
r_int
)paren
id|f
comma
(paren
r_int
r_int
)paren
id|controller-&gt;reg
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* If one feature contains several bits, all of them must be set&n;&t; * for value to be true, or all of them must be 0 if polarity is&n;&t; * inverse&n;&t; */
id|value
op_assign
(paren
id|in_le32
c_func
(paren
id|FREG
c_func
(paren
id|controller
comma
id|bit-&gt;reg
)paren
)paren
op_amp
id|bit-&gt;mask
)paren
suffix:semicolon
r_return
id|bit-&gt;polarity
ques
c_cond
(paren
id|value
op_eq
l_int|0
)paren
suffix:colon
(paren
id|value
op_eq
id|bit-&gt;mask
)paren
suffix:semicolon
)brace
r_int
DECL|function|feature_can_sleep
id|feature_can_sleep
c_func
(paren
r_void
)paren
(brace
r_return
(paren
(paren
id|board_features
op_amp
id|FTR_CAN_SLEEP
)paren
op_ne
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Core99 functions&n; * &n; * Note: We currently assume there is _one_ UniN chip and _one_ KeyLargo&n; *       chip, which is the case on all Core99 machines so far&n; */
multiline_comment|/* Only one GMAC is assumed */
r_void
DECL|function|feature_set_gmac_power
id|feature_set_gmac_power
c_func
(paren
r_struct
id|device_node
op_star
id|device
comma
r_int
id|power
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uninorth_base
op_logical_or
op_logical_neg
id|keylargo
)paren
r_return
suffix:semicolon
multiline_comment|/* TODO: Handle save/restore of PCI config space here&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|keylargo-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|power
)paren
id|UN_BIS
c_func
(paren
id|UNI_N_CLOCK_CNTL
comma
id|UNI_N_CLOCK_CNTL_GMAC
)paren
suffix:semicolon
r_else
id|UN_BIC
c_func
(paren
id|UNI_N_CLOCK_CNTL
comma
id|UNI_N_CLOCK_CNTL_GMAC
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|keylargo-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
)brace
r_void
DECL|function|feature_gmac_phy_reset
id|feature_gmac_phy_reset
c_func
(paren
r_struct
id|device_node
op_star
id|device
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|keylargo_base
op_logical_or
op_logical_neg
id|keylargo
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|keylargo-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|out_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_ETH_PHY_RESET
)paren
comma
id|KEYLARGO_GPIO_OUTPUT_ENABLE
)paren
suffix:semicolon
(paren
r_void
)paren
id|in_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_ETH_PHY_RESET
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|keylargo-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|keylargo-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|out_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_ETH_PHY_RESET
)paren
comma
id|KEYLARGO_GPIO_OUTPUT_ENABLE
op_or
id|KEYLARGO_GPIO_OUTOUT_DATA
)paren
suffix:semicolon
(paren
r_void
)paren
id|in_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_ETH_PHY_RESET
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|keylargo-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
multiline_comment|/* Pass the node of the correct controller, please */
r_void
DECL|function|feature_set_usb_power
id|feature_set_usb_power
c_func
(paren
r_struct
id|device_node
op_star
id|device
comma
r_int
id|power
)paren
(brace
r_char
op_star
id|prop
suffix:semicolon
r_int
id|number
suffix:semicolon
id|u32
id|reg
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|keylargo_base
op_logical_or
op_logical_neg
id|keylargo
)paren
r_return
suffix:semicolon
id|prop
op_assign
(paren
r_char
op_star
)paren
id|get_property
c_func
(paren
id|device
comma
l_string|&quot;AAPL,clock-id&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|prop
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|prop
comma
l_string|&quot;usb0u048&quot;
comma
id|strlen
c_func
(paren
l_string|&quot;usb0u048&quot;
)paren
)paren
op_eq
l_int|0
)paren
id|number
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|prop
comma
l_string|&quot;usb1u148&quot;
comma
id|strlen
c_func
(paren
l_string|&quot;usb1u148&quot;
)paren
)paren
op_eq
l_int|0
)paren
id|number
op_assign
l_int|2
suffix:semicolon
r_else
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|keylargo-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|power
)paren
(brace
multiline_comment|/* Turn ON */
r_if
c_cond
(paren
id|number
op_eq
l_int|0
)paren
(brace
id|KL_BIC
c_func
(paren
id|KEYLARGO_FCR0
comma
(paren
id|KL0_USB0_PAD_SUSPEND0
op_or
id|KL0_USB0_PAD_SUSPEND1
)paren
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|KL_BIS
c_func
(paren
id|KEYLARGO_FCR0
comma
id|KL0_USB0_CELL_ENABLE
)paren
suffix:semicolon
)brace
r_else
(brace
id|KL_BIC
c_func
(paren
id|KEYLARGO_FCR0
comma
(paren
id|KL0_USB1_PAD_SUSPEND0
op_or
id|KL0_USB1_PAD_SUSPEND1
)paren
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|KL_BIS
c_func
(paren
id|KEYLARGO_FCR0
comma
id|KL0_USB1_CELL_ENABLE
)paren
suffix:semicolon
)brace
id|reg
op_assign
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR4
)paren
suffix:semicolon
id|reg
op_and_assign
op_complement
(paren
id|KL4_SET_PORT_ENABLE
c_func
(paren
id|number
)paren
op_or
id|KL4_SET_PORT_RESUME
c_func
(paren
id|number
)paren
op_or
id|KL4_SET_PORT_CONNECT
c_func
(paren
id|number
)paren
op_or
id|KL4_SET_PORT_DISCONNECT
c_func
(paren
id|number
)paren
)paren
suffix:semicolon
id|reg
op_and_assign
op_complement
(paren
id|KL4_SET_PORT_ENABLE
c_func
(paren
id|number
op_plus
l_int|1
)paren
op_or
id|KL4_SET_PORT_RESUME
c_func
(paren
id|number
op_plus
l_int|1
)paren
op_or
id|KL4_SET_PORT_CONNECT
c_func
(paren
id|number
op_plus
l_int|1
)paren
op_or
id|KL4_SET_PORT_DISCONNECT
c_func
(paren
id|number
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|KL_OUT
c_func
(paren
id|KEYLARGO_FCR4
comma
id|reg
)paren
suffix:semicolon
(paren
r_void
)paren
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR4
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Turn OFF */
id|reg
op_assign
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR4
)paren
suffix:semicolon
id|reg
op_or_assign
id|KL4_SET_PORT_ENABLE
c_func
(paren
id|number
)paren
op_or
id|KL4_SET_PORT_RESUME
c_func
(paren
id|number
)paren
op_or
id|KL4_SET_PORT_CONNECT
c_func
(paren
id|number
)paren
op_or
id|KL4_SET_PORT_DISCONNECT
c_func
(paren
id|number
)paren
suffix:semicolon
id|reg
op_or_assign
id|KL4_SET_PORT_ENABLE
c_func
(paren
id|number
op_plus
l_int|1
)paren
op_or
id|KL4_SET_PORT_RESUME
c_func
(paren
id|number
op_plus
l_int|1
)paren
op_or
id|KL4_SET_PORT_CONNECT
c_func
(paren
id|number
op_plus
l_int|1
)paren
op_or
id|KL4_SET_PORT_DISCONNECT
c_func
(paren
id|number
op_plus
l_int|1
)paren
suffix:semicolon
id|KL_OUT
c_func
(paren
id|KEYLARGO_FCR4
comma
id|reg
)paren
suffix:semicolon
(paren
r_void
)paren
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR4
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|number
op_eq
l_int|0
)paren
(brace
id|KL_BIC
c_func
(paren
id|KEYLARGO_FCR0
comma
id|KL0_USB0_CELL_ENABLE
)paren
suffix:semicolon
(paren
r_void
)paren
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|KL_BIS
c_func
(paren
id|KEYLARGO_FCR0
comma
(paren
id|KL0_USB0_PAD_SUSPEND0
op_or
id|KL0_USB0_PAD_SUSPEND1
)paren
)paren
suffix:semicolon
(paren
r_void
)paren
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR0
)paren
suffix:semicolon
)brace
r_else
(brace
id|KL_BIC
c_func
(paren
id|KEYLARGO_FCR0
comma
id|KL0_USB1_CELL_ENABLE
)paren
suffix:semicolon
(paren
r_void
)paren
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|KL_BIS
c_func
(paren
id|KEYLARGO_FCR0
comma
(paren
id|KL0_USB1_PAD_SUSPEND0
op_or
id|KL0_USB1_PAD_SUSPEND1
)paren
)paren
suffix:semicolon
(paren
r_void
)paren
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR0
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|keylargo-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_void
DECL|function|feature_set_firewire_power
id|feature_set_firewire_power
c_func
(paren
r_struct
id|device_node
op_star
id|device
comma
r_int
id|power
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* TODO: Handle save/restore of PCI config space here&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|uninorth_base
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|keylargo-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|power
)paren
id|UN_BIS
c_func
(paren
id|UNI_N_CLOCK_CNTL
comma
id|UNI_N_CLOCK_CNTL_FW
)paren
suffix:semicolon
r_else
id|UN_BIC
c_func
(paren
id|UNI_N_CLOCK_CNTL
comma
id|UNI_N_CLOCK_CNTL_FW
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|keylargo-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Warning: will kill the PHY.. */
r_void
DECL|function|feature_set_firewire_cable_power
id|feature_set_firewire_cable_power
c_func
(paren
r_struct
id|device_node
op_star
id|device
comma
r_int
id|power
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|u8
id|gpioValue
op_assign
id|power
ques
c_cond
l_int|0
suffix:colon
l_int|4
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|keylargo_base
op_logical_or
op_logical_neg
(paren
id|board_features
op_amp
id|FTR_HAS_FW_POWER
)paren
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|keylargo-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|out_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_FW_CABLE_POWER
)paren
comma
id|gpioValue
)paren
suffix:semicolon
(paren
r_void
)paren
id|in_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_FW_CABLE_POWER
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|keylargo-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SMP
r_void
DECL|function|feature_core99_kick_cpu
id|feature_core99_kick_cpu
c_func
(paren
r_int
id|cpu_nr
)paren
(brace
macro_line|#if 1 /* New way */
r_const
r_int
id|reset_lines
(braket
)braket
op_assign
(brace
id|KL_GPIO_RESET_CPU0
comma
id|KL_GPIO_RESET_CPU1
comma
id|KL_GPIO_RESET_CPU2
comma
id|KL_GPIO_RESET_CPU3
)brace
suffix:semicolon
r_volatile
id|u8
op_star
id|reset_io
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|keylargo_base
op_logical_or
id|cpu_nr
OG
l_int|3
)paren
r_return
suffix:semicolon
id|reset_io
op_assign
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|reset_lines
(braket
id|cpu_nr
)braket
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|reset_io
comma
id|KEYLARGO_GPIO_OUTPUT_ENABLE
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|reset_io
comma
id|KEYLARGO_GPIO_OUTPUT_ENABLE
op_or
id|KEYLARGO_GPIO_OUTOUT_DATA
)paren
suffix:semicolon
macro_line|#else
id|out_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_EXTINT_CPU1
)paren
comma
id|KL_GPIO_EXTINT_CPU1_ASSERT
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_EXTINT_CPU1
)paren
comma
id|KL_GPIO_EXTINT_CPU1_RELEASE
)paren
suffix:semicolon
macro_line|#endif&t;
)brace
macro_line|#endif /* CONFIG_SMP */
r_void
DECL|function|feature_set_airport_power
id|feature_set_airport_power
c_func
(paren
r_struct
id|device_node
op_star
id|device
comma
r_int
id|power
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|keylargo_base
op_logical_or
op_logical_neg
id|airport_dev
op_logical_or
id|airport_dev
op_ne
id|device
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|airport_pwr_state
op_eq
id|power
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|power
)paren
(brace
multiline_comment|/* Some if this is from Darwin code, some is from tracing of&n;&t;&t; * MacOS driver with Macsbug. Some real bit definitions would&n;&t;&t; * really help here...&n;&t;&t; */
id|out_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_AIRPORT_0
)paren
comma
id|airport_pwr_regs
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|out_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_AIRPORT_1
)paren
comma
id|airport_pwr_regs
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|out_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_AIRPORT_2
)paren
comma
id|airport_pwr_regs
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|out_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_AIRPORT_3
)paren
comma
id|airport_pwr_regs
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|out_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_AIRPORT_4
)paren
comma
id|airport_pwr_regs
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|out_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_AIRPORT_4
)paren
comma
l_int|5
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|out_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_AIRPORT_4
)paren
comma
l_int|4
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|KL_BIC
c_func
(paren
id|KEYLARGO_FCR2
comma
id|KL2_AIRPORT_RESET_N
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|out_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
l_int|0x1a3e0
)paren
comma
l_int|0x41
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|KL_BIS
c_func
(paren
id|KEYLARGO_FCR2
comma
id|KL2_AIRPORT_RESET_N
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_else
(brace
id|airport_pwr_regs
(braket
l_int|0
)braket
op_assign
id|in_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_AIRPORT_0
)paren
)paren
suffix:semicolon
id|airport_pwr_regs
(braket
l_int|1
)braket
op_assign
id|in_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_AIRPORT_1
)paren
)paren
suffix:semicolon
id|airport_pwr_regs
(braket
l_int|2
)braket
op_assign
id|in_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_AIRPORT_2
)paren
)paren
suffix:semicolon
id|airport_pwr_regs
(braket
l_int|3
)braket
op_assign
id|in_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_AIRPORT_3
)paren
)paren
suffix:semicolon
id|airport_pwr_regs
(braket
l_int|4
)braket
op_assign
id|in_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_AIRPORT_4
)paren
)paren
suffix:semicolon
id|out_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_AIRPORT_0
)paren
comma
l_int|0
)paren
suffix:semicolon
id|out_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_AIRPORT_1
)paren
comma
l_int|0
)paren
suffix:semicolon
id|out_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_AIRPORT_2
)paren
comma
l_int|0
)paren
suffix:semicolon
id|out_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_AIRPORT_3
)paren
comma
l_int|0
)paren
suffix:semicolon
id|out_8
c_func
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KL_GPIO_AIRPORT_4
)paren
comma
l_int|0
)paren
suffix:semicolon
)brace
id|airport_pwr_state
op_assign
id|power
suffix:semicolon
)brace
multiline_comment|/* Initialize the Core99 UniNorth host bridge and memory controller&n; */
r_static
r_void
DECL|function|uninorth_init
id|uninorth_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|gmac
comma
op_star
id|fw
suffix:semicolon
r_int
r_int
id|actrl
suffix:semicolon
multiline_comment|/* Set the arbitrer QAck delay according to what Apple does&n;&t; */
r_if
c_cond
(paren
id|uninorth_rev
OL
l_int|0x10
)paren
(brace
id|actrl
op_assign
id|UN_IN
c_func
(paren
id|UNI_N_ARB_CTRL
)paren
op_amp
op_complement
id|UNI_N_ARB_CTRL_QACK_DELAY_MASK
suffix:semicolon
id|actrl
op_or_assign
(paren
(paren
id|uninorth_rev
OL
l_int|3
)paren
ques
c_cond
id|UNI_N_ARB_CTRL_QACK_DELAY105
suffix:colon
id|UNI_N_ARB_CTRL_QACK_DELAY
)paren
op_lshift
id|UNI_N_ARB_CTRL_QACK_DELAY_SHIFT
suffix:semicolon
id|UN_OUT
c_func
(paren
id|UNI_N_ARB_CTRL
comma
id|actrl
)paren
suffix:semicolon
)brace
multiline_comment|/* Enable GMAC for now for PCI probing. It will be disabled&n;&t; * later on after PCI probe&n;&t; */
id|gmac
op_assign
id|find_devices
c_func
(paren
l_string|&quot;ethernet&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|gmac
)paren
(brace
r_if
c_cond
(paren
id|device_is_compatible
c_func
(paren
id|gmac
comma
l_string|&quot;gmac&quot;
)paren
)paren
r_break
suffix:semicolon
id|gmac
op_assign
id|gmac-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gmac
)paren
id|feature_set_gmac_power
c_func
(paren
id|gmac
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Enable FW before PCI probe. Will be disabled later on&n;&t; */
id|fw
op_assign
id|find_devices
c_func
(paren
l_string|&quot;firewire&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fw
op_logical_and
id|device_is_compatible
c_func
(paren
id|fw
comma
l_string|&quot;pci106b,18&quot;
)paren
)paren
id|feature_set_firewire_power
c_func
(paren
id|fw
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize the Core99 KeyLargo ASIC. &n; */
r_static
r_void
DECL|function|keylargo_init
id|keylargo_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|np
suffix:semicolon
id|KL_BIS
c_func
(paren
id|KEYLARGO_FCR2
comma
id|KL2_MPIC_ENABLE
)paren
suffix:semicolon
multiline_comment|/* Lookup for an airport card, and disable it if found&n;&t; * to save power (will be re-enabled by driver if used)&n;&t; */
id|np
op_assign
id|find_devices
c_func
(paren
l_string|&quot;radio&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np
op_logical_and
id|np-&gt;parent
op_eq
id|keylargo-&gt;device
)paren
id|airport_dev
op_assign
id|np
suffix:semicolon
r_if
c_cond
(paren
id|airport_dev
)paren
(brace
id|airport_pwr_state
op_assign
l_int|1
suffix:semicolon
id|feature_set_airport_power
c_func
(paren
id|airport_dev
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_PMAC_PBOOK
r_void
DECL|function|feature_prepare_for_sleep
id|feature_prepare_for_sleep
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* We assume gatwick is second */
r_struct
id|feature_controller
op_star
id|ctrler
op_assign
op_amp
id|controllers
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|controller_count
OG
l_int|1
op_logical_and
id|device_is_compatible
c_func
(paren
id|ctrler-&gt;device
comma
l_string|&quot;gatwick&quot;
)paren
)paren
id|ctrler
op_assign
op_amp
id|controllers
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ctrler-&gt;bits
op_eq
id|feature_bits_heathrow
op_logical_or
id|ctrler-&gt;bits
op_eq
id|feature_bits_paddington
)paren
(brace
id|heathrow_prepare_for_sleep
c_func
(paren
id|ctrler
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ctrler-&gt;bits
op_eq
id|feature_bits_keylargo
)paren
(brace
id|core99_prepare_for_sleep
c_func
(paren
id|ctrler
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_void
DECL|function|feature_wake_up
id|feature_wake_up
c_func
(paren
r_void
)paren
(brace
r_struct
id|feature_controller
op_star
id|ctrler
op_assign
op_amp
id|controllers
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|controller_count
OG
l_int|1
op_logical_and
id|device_is_compatible
c_func
(paren
id|ctrler-&gt;device
comma
l_string|&quot;gatwick&quot;
)paren
)paren
id|ctrler
op_assign
op_amp
id|controllers
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ctrler-&gt;bits
op_eq
id|feature_bits_heathrow
op_logical_or
id|ctrler-&gt;bits
op_eq
id|feature_bits_paddington
)paren
(brace
id|heathrow_wakeup
c_func
(paren
id|ctrler
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ctrler-&gt;bits
op_eq
id|feature_bits_keylargo
)paren
(brace
id|core99_wake_up
c_func
(paren
id|ctrler
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
DECL|variable|save_fcr
r_static
id|u32
id|save_fcr
(braket
l_int|5
)braket
suffix:semicolon
DECL|variable|save_mbcr
r_static
id|u32
id|save_mbcr
suffix:semicolon
DECL|variable|save_gpio_levels
r_static
id|u32
id|save_gpio_levels
(braket
l_int|2
)braket
suffix:semicolon
DECL|variable|save_gpio_extint
r_static
id|u8
id|save_gpio_extint
(braket
id|KEYLARGO_GPIO_EXTINT_CNT
)braket
suffix:semicolon
DECL|variable|save_gpio_normal
r_static
id|u8
id|save_gpio_normal
(braket
id|KEYLARGO_GPIO_CNT
)braket
suffix:semicolon
DECL|variable|save_unin_clock_ctl
r_static
id|u32
id|save_unin_clock_ctl
suffix:semicolon
DECL|variable|save_dbdma
r_static
r_struct
id|dbdma_regs
id|save_dbdma
(braket
l_int|13
)braket
suffix:semicolon
r_static
r_void
DECL|function|heathrow_prepare_for_sleep
id|heathrow_prepare_for_sleep
c_func
(paren
r_struct
id|feature_controller
op_star
id|ctrler
)paren
(brace
id|save_mbcr
op_assign
id|in_le32
c_func
(paren
id|FREG
c_func
(paren
id|ctrler
comma
l_int|0x34
)paren
)paren
suffix:semicolon
id|save_fcr
(braket
l_int|0
)braket
op_assign
id|in_le32
c_func
(paren
id|FREG
c_func
(paren
id|ctrler
comma
l_int|0x38
)paren
)paren
suffix:semicolon
id|save_fcr
(braket
l_int|1
)braket
op_assign
id|in_le32
c_func
(paren
id|FREG
c_func
(paren
id|ctrler
comma
l_int|0x3c
)paren
)paren
suffix:semicolon
id|out_le32
c_func
(paren
id|FREG
c_func
(paren
id|ctrler
comma
l_int|0x38
)paren
comma
id|save_fcr
(braket
l_int|0
)braket
op_amp
op_complement
id|HRW_IOBUS_ENABLE
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|heathrow_wakeup
id|heathrow_wakeup
c_func
(paren
r_struct
id|feature_controller
op_star
id|ctrler
)paren
(brace
id|out_le32
c_func
(paren
id|FREG
c_func
(paren
id|ctrler
comma
l_int|0x38
)paren
comma
id|save_fcr
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|out_le32
c_func
(paren
id|FREG
c_func
(paren
id|ctrler
comma
l_int|0x3c
)paren
comma
id|save_fcr
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|out_le32
c_func
(paren
id|FREG
c_func
(paren
id|ctrler
comma
l_int|0x34
)paren
comma
id|save_mbcr
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_le32
c_func
(paren
id|FREG
c_func
(paren
id|ctrler
comma
l_int|0x38
)paren
comma
id|save_fcr
(braket
l_int|0
)braket
op_or
id|HRW_IOBUS_ENABLE
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|turn_off_keylargo
id|turn_off_keylargo
c_func
(paren
r_void
)paren
(brace
id|u32
id|temp
suffix:semicolon
multiline_comment|/* For now, suspending the USB ref cause the machine to die on&n;&t; * wakeup -- BenH&n;&t; */
macro_line|#if 0
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|KL_BIS
c_func
(paren
id|KEYLARGO_FCR0
comma
id|KL0_USB_REF_SUSPEND
)paren
suffix:semicolon
(paren
r_void
)paren
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR0
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1500
)paren
suffix:semicolon
macro_line|#endif
id|KL_BIC
c_func
(paren
id|KEYLARGO_FCR0
comma
id|KL0_SCCA_ENABLE
op_or
id|KL0_SCCB_ENABLE
op_or
id|KL0_SCC_CELL_ENABLE
op_or
id|KL0_IRDA_ENABLE
op_or
id|KL0_IRDA_CLK32_ENABLE
op_or
id|KL0_IRDA_CLK19_ENABLE
)paren
suffix:semicolon
(paren
r_void
)paren
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|KL_BIS
c_func
(paren
id|KEYLARGO_MBCR
comma
id|KL_MBCR_MB0_DEV_ENABLE
)paren
suffix:semicolon
(paren
r_void
)paren
id|KL_IN
c_func
(paren
id|KEYLARGO_MBCR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|KL_BIC
c_func
(paren
id|KEYLARGO_FCR1
comma
id|KL1_AUDIO_SEL_22MCLK
op_or
id|KL1_AUDIO_CLK_ENABLE_BIT
op_or
id|KL1_AUDIO_CLK_OUT_ENABLE
op_or
id|KL1_AUDIO_CELL_ENABLE
op_or
id|KL1_I2S0_CELL_ENABLE
op_or
id|KL1_I2S0_CLK_ENABLE_BIT
op_or
id|KL1_I2S0_ENABLE
op_or
id|KL1_I2S1_CELL_ENABLE
op_or
id|KL1_I2S1_CLK_ENABLE_BIT
op_or
id|KL1_I2S1_ENABLE
op_or
id|KL1_EIDE0_ENABLE
op_or
id|KL1_EIDE0_RESET_N
op_or
id|KL1_EIDE1_ENABLE
op_or
id|KL1_EIDE1_RESET_N
op_or
id|KL1_UIDE_ENABLE
)paren
suffix:semicolon
(paren
r_void
)paren
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR1
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|KL_BIS
c_func
(paren
id|KEYLARGO_FCR2
comma
id|KL2_MODEM_POWER_N
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|KL_BIC
c_func
(paren
id|KEYLARGO_FCR2
comma
id|KL2_IOBUS_ENABLE
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|temp
op_assign
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|keylargo_rev
op_ge
l_int|2
)paren
id|temp
op_or_assign
(paren
id|KL3_SHUTDOWN_PLL2X
op_or
id|KL3_SHUTDOWN_PLL_TOTAL
)paren
suffix:semicolon
id|temp
op_or_assign
id|KL3_SHUTDOWN_PLLKW6
op_or
id|KL3_SHUTDOWN_PLLKW4
op_or
id|KL3_SHUTDOWN_PLLKW35
op_or
id|KL3_SHUTDOWN_PLLKW12
suffix:semicolon
id|temp
op_and_assign
op_complement
(paren
id|KL3_CLK66_ENABLE
op_or
id|KL3_CLK49_ENABLE
op_or
id|KL3_CLK45_ENABLE
op_or
id|KL3_CLK31_ENABLE
op_or
id|KL3_TIMER_CLK18_ENABLE
op_or
id|KL3_I2S1_CLK18_ENABLE
op_or
id|KL3_I2S0_CLK18_ENABLE
op_or
id|KL3_VIA_CLK16_ENABLE
)paren
suffix:semicolon
id|KL_OUT
c_func
(paren
id|KEYLARGO_FCR3
comma
id|temp
)paren
suffix:semicolon
(paren
r_void
)paren
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR3
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|turn_off_pangea
id|turn_off_pangea
c_func
(paren
r_void
)paren
(brace
id|u32
id|temp
suffix:semicolon
id|KL_BIC
c_func
(paren
id|KEYLARGO_FCR0
comma
id|KL0_SCCA_ENABLE
op_or
id|KL0_SCCB_ENABLE
op_or
id|KL0_SCC_CELL_ENABLE
op_or
id|KL0_USB0_CELL_ENABLE
op_or
id|KL0_USB1_CELL_ENABLE
)paren
suffix:semicolon
(paren
r_void
)paren
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|KL_BIS
c_func
(paren
id|KEYLARGO_MBCR
comma
id|KL_MBCR_MB0_DEV_ENABLE
)paren
suffix:semicolon
(paren
r_void
)paren
id|KL_IN
c_func
(paren
id|KEYLARGO_MBCR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|KL_BIC
c_func
(paren
id|KEYLARGO_FCR1
comma
id|KL1_AUDIO_SEL_22MCLK
op_or
id|KL1_AUDIO_CLK_ENABLE_BIT
op_or
id|KL1_AUDIO_CLK_OUT_ENABLE
op_or
id|KL1_AUDIO_CELL_ENABLE
op_or
id|KL1_I2S0_CELL_ENABLE
op_or
id|KL1_I2S0_CLK_ENABLE_BIT
op_or
id|KL1_I2S0_ENABLE
op_or
id|KL1_I2S1_CELL_ENABLE
op_or
id|KL1_I2S1_CLK_ENABLE_BIT
op_or
id|KL1_I2S1_ENABLE
op_or
id|KL1_UIDE_ENABLE
)paren
suffix:semicolon
(paren
r_void
)paren
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR1
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|KL_BIS
c_func
(paren
id|KEYLARGO_FCR2
comma
id|KL2_MODEM_POWER_N
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|temp
op_assign
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR3
)paren
suffix:semicolon
id|temp
op_or_assign
id|KL3_SHUTDOWN_PLLKW6
op_or
id|KL3_SHUTDOWN_PLLKW4
op_or
id|KL3_SHUTDOWN_PLLKW35
suffix:semicolon
id|temp
op_and_assign
op_complement
(paren
id|KL3_CLK49_ENABLE
op_or
id|KL3_CLK45_ENABLE
op_or
id|KL3_CLK31_ENABLE
op_or
id|KL3_TIMER_CLK18_ENABLE
op_or
id|KL3_I2S1_CLK18_ENABLE
op_or
id|KL3_I2S0_CLK18_ENABLE
op_or
id|KL3_VIA_CLK16_ENABLE
)paren
suffix:semicolon
id|KL_OUT
c_func
(paren
id|KEYLARGO_FCR3
comma
id|temp
)paren
suffix:semicolon
(paren
r_void
)paren
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR3
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|core99_prepare_for_sleep
id|core99_prepare_for_sleep
c_func
(paren
r_struct
id|feature_controller
op_star
id|ctrler
)paren
(brace
r_int
id|i
suffix:semicolon
id|u8
op_star
id|base8
suffix:semicolon
multiline_comment|/*&n;&t; * Save various bits of KeyLargo&n;&t; */
multiline_comment|/* We power off the wireless slot in case it was not done&n;&t; * by the driver. We don&squot;t power it on automatically however&n;&t; */
id|feature_set_airport_power
c_func
(paren
id|airport_dev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* We power off the FW cable. Should be done by the driver... */
id|feature_set_firewire_cable_power
c_func
(paren
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Save the state of the various GPIOs */
id|save_gpio_levels
(braket
l_int|0
)braket
op_assign
id|KL_IN
c_func
(paren
id|KEYLARGO_GPIO_LEVELS0
)paren
suffix:semicolon
id|save_gpio_levels
(braket
l_int|1
)braket
op_assign
id|KL_IN
c_func
(paren
id|KEYLARGO_GPIO_LEVELS1
)paren
suffix:semicolon
id|base8
op_assign
(paren
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KEYLARGO_GPIO_EXTINT_0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|KEYLARGO_GPIO_EXTINT_CNT
suffix:semicolon
id|i
op_increment
)paren
id|save_gpio_extint
(braket
id|i
)braket
op_assign
id|in_8
c_func
(paren
id|base8
op_plus
id|i
)paren
suffix:semicolon
id|base8
op_assign
(paren
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KEYLARGO_GPIO_0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|KEYLARGO_GPIO_CNT
suffix:semicolon
id|i
op_increment
)paren
id|save_gpio_normal
(braket
id|i
)braket
op_assign
id|in_8
c_func
(paren
id|base8
op_plus
id|i
)paren
suffix:semicolon
multiline_comment|/* Save the FCRs */
id|save_mbcr
op_assign
id|KL_IN
c_func
(paren
id|KEYLARGO_MBCR
)paren
suffix:semicolon
id|save_fcr
(braket
l_int|0
)braket
op_assign
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR0
)paren
suffix:semicolon
id|save_fcr
(braket
l_int|1
)braket
op_assign
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR1
)paren
suffix:semicolon
id|save_fcr
(braket
l_int|2
)braket
op_assign
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR2
)paren
suffix:semicolon
id|save_fcr
(braket
l_int|3
)braket
op_assign
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR3
)paren
suffix:semicolon
id|save_fcr
(braket
l_int|4
)braket
op_assign
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR4
)paren
suffix:semicolon
multiline_comment|/* Save state &amp; config of DBDMA channels */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|13
suffix:semicolon
id|i
op_increment
)paren
(brace
r_volatile
r_struct
id|dbdma_regs
op_star
id|chan
op_assign
(paren
r_volatile
r_struct
id|dbdma_regs
op_star
)paren
(paren
id|keylargo_base
op_plus
(paren
(paren
l_int|0x8000
op_plus
id|i
op_star
l_int|0x100
)paren
op_rshift
l_int|2
)paren
)paren
suffix:semicolon
id|save_dbdma
(braket
id|i
)braket
dot
id|cmdptr_hi
op_assign
id|in_le32
c_func
(paren
op_amp
id|chan-&gt;cmdptr_hi
)paren
suffix:semicolon
id|save_dbdma
(braket
id|i
)braket
dot
id|cmdptr
op_assign
id|in_le32
c_func
(paren
op_amp
id|chan-&gt;cmdptr
)paren
suffix:semicolon
id|save_dbdma
(braket
id|i
)braket
dot
id|intr_sel
op_assign
id|in_le32
c_func
(paren
op_amp
id|chan-&gt;intr_sel
)paren
suffix:semicolon
id|save_dbdma
(braket
id|i
)braket
dot
id|br_sel
op_assign
id|in_le32
c_func
(paren
op_amp
id|chan-&gt;br_sel
)paren
suffix:semicolon
id|save_dbdma
(braket
id|i
)braket
dot
id|wait_sel
op_assign
id|in_le32
c_func
(paren
op_amp
id|chan-&gt;wait_sel
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Turn off as much as we can&n;&t; */
r_if
c_cond
(paren
id|keylargo_rev
op_amp
id|KL_PANGEA_REV
)paren
id|turn_off_pangea
c_func
(paren
)paren
suffix:semicolon
r_else
id|turn_off_keylargo
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Put the host bridge to sleep&n;&t; */
id|save_unin_clock_ctl
op_assign
id|UN_IN
c_func
(paren
id|UNI_N_CLOCK_CNTL
)paren
suffix:semicolon
id|UN_OUT
c_func
(paren
id|UNI_N_CLOCK_CNTL
comma
id|save_unin_clock_ctl
op_amp
op_complement
(paren
id|UNI_N_CLOCK_CNTL_GMAC
op_or
id|UNI_N_CLOCK_CNTL_FW
multiline_comment|/*|UNI_N_CLOCK_CNTL_PCI*/
)paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|UN_OUT
c_func
(paren
id|UNI_N_HWINIT_STATE
comma
id|UNI_N_HWINIT_STATE_SLEEPING
)paren
suffix:semicolon
id|UN_OUT
c_func
(paren
id|UNI_N_POWER_MGT
comma
id|UNI_N_POWER_MGT_SLEEP
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * FIXME: A bit of black magic with OpenPIC (don&squot;t ask me why)&n;&t; */
r_if
c_cond
(paren
id|board_features
op_amp
id|FTR_NEED_OPENPIC_TWEAK
)paren
(brace
id|KL_BIS
c_func
(paren
l_int|0x506e0
comma
l_int|0x00400000
)paren
suffix:semicolon
id|KL_BIS
c_func
(paren
l_int|0x506e0
comma
l_int|0x80000000
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|core99_wake_up
id|core99_wake_up
c_func
(paren
r_struct
id|feature_controller
op_star
id|ctrler
)paren
(brace
r_int
id|i
suffix:semicolon
id|u8
op_star
id|base8
suffix:semicolon
multiline_comment|/*&n;&t; * Wakeup the host bridge&n;&t; */
id|UN_OUT
c_func
(paren
id|UNI_N_POWER_MGT
comma
id|UNI_N_POWER_MGT_NORMAL
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|UN_OUT
c_func
(paren
id|UNI_N_HWINIT_STATE
comma
id|UNI_N_HWINIT_STATE_RUNNING
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Restore KeyLargo&n;&t; */
id|KL_OUT
c_func
(paren
id|KEYLARGO_MBCR
comma
id|save_mbcr
)paren
suffix:semicolon
(paren
r_void
)paren
id|KL_IN
c_func
(paren
id|KEYLARGO_MBCR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|KL_OUT
c_func
(paren
id|KEYLARGO_FCR0
comma
id|save_fcr
(braket
l_int|0
)braket
)paren
suffix:semicolon
(paren
r_void
)paren
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|KL_OUT
c_func
(paren
id|KEYLARGO_FCR1
comma
id|save_fcr
(braket
l_int|1
)braket
)paren
suffix:semicolon
(paren
r_void
)paren
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR1
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|KL_OUT
c_func
(paren
id|KEYLARGO_FCR2
comma
id|save_fcr
(braket
l_int|2
)braket
)paren
suffix:semicolon
(paren
r_void
)paren
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR2
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|KL_OUT
c_func
(paren
id|KEYLARGO_FCR3
comma
id|save_fcr
(braket
l_int|3
)braket
)paren
suffix:semicolon
(paren
r_void
)paren
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR3
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|KL_OUT
c_func
(paren
id|KEYLARGO_FCR4
comma
id|save_fcr
(braket
l_int|4
)braket
)paren
suffix:semicolon
(paren
r_void
)paren
id|KL_IN
c_func
(paren
id|KEYLARGO_FCR4
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|13
suffix:semicolon
id|i
op_increment
)paren
(brace
r_volatile
r_struct
id|dbdma_regs
op_star
id|chan
op_assign
(paren
r_volatile
r_struct
id|dbdma_regs
op_star
)paren
(paren
id|keylargo_base
op_plus
(paren
(paren
l_int|0x8000
op_plus
id|i
op_star
l_int|0x100
)paren
op_rshift
l_int|2
)paren
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|chan-&gt;control
comma
(paren
id|ACTIVE
op_or
id|DEAD
op_or
id|WAKE
op_or
id|FLUSH
op_or
id|PAUSE
op_or
id|RUN
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
r_while
c_loop
(paren
id|in_le32
c_func
(paren
op_amp
id|chan-&gt;status
)paren
op_amp
id|ACTIVE
)paren
id|mb
c_func
(paren
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|chan-&gt;cmdptr_hi
comma
id|save_dbdma
(braket
id|i
)braket
dot
id|cmdptr_hi
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|chan-&gt;cmdptr
comma
id|save_dbdma
(braket
id|i
)braket
dot
id|cmdptr
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|chan-&gt;intr_sel
comma
id|save_dbdma
(braket
id|i
)braket
dot
id|intr_sel
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|chan-&gt;br_sel
comma
id|save_dbdma
(braket
id|i
)braket
dot
id|br_sel
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|chan-&gt;wait_sel
comma
id|save_dbdma
(braket
id|i
)braket
dot
id|wait_sel
)paren
suffix:semicolon
)brace
id|KL_OUT
c_func
(paren
id|KEYLARGO_GPIO_LEVELS0
comma
id|save_gpio_levels
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|KL_OUT
c_func
(paren
id|KEYLARGO_GPIO_LEVELS1
comma
id|save_gpio_levels
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|base8
op_assign
(paren
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KEYLARGO_GPIO_EXTINT_0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|KEYLARGO_GPIO_EXTINT_CNT
suffix:semicolon
id|i
op_increment
)paren
id|out_8
c_func
(paren
id|base8
op_plus
id|i
comma
id|save_gpio_extint
(braket
id|i
)braket
)paren
suffix:semicolon
id|base8
op_assign
(paren
id|u8
op_star
)paren
id|KL_FCR
c_func
(paren
id|KEYLARGO_GPIO_0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|KEYLARGO_GPIO_CNT
suffix:semicolon
id|i
op_increment
)paren
id|out_8
c_func
(paren
id|base8
op_plus
id|i
comma
id|save_gpio_normal
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* FIXME more black magic with OpenPIC ... */
r_if
c_cond
(paren
id|board_features
op_amp
id|FTR_NEED_OPENPIC_TWEAK
)paren
(brace
id|KL_BIC
c_func
(paren
l_int|0x506e0
comma
l_int|0x00400000
)paren
suffix:semicolon
id|KL_BIC
c_func
(paren
l_int|0x506e0
comma
l_int|0x80000000
)paren
suffix:semicolon
)brace
id|UN_OUT
c_func
(paren
id|UNI_N_CLOCK_CNTL
comma
id|save_unin_clock_ctl
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PMAC_PBOOK */
eof
