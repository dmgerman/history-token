multiline_comment|/*&n; * Support for indirect PCI bridges.&n; *&n; * Copyright (C) 1998 Gabriel Paubert.&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;asm/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &quot;pci.h&quot;
DECL|macro|cfg_read
mdefine_line|#define cfg_read(val, addr, type, op)&t;*val = op((type)(addr))
DECL|macro|cfg_write
mdefine_line|#define cfg_write(val, addr, type, op)&t;op((type *)(addr), (val))
DECL|macro|INDIRECT_PCI_OP
mdefine_line|#define INDIRECT_PCI_OP(rw, size, type, op, mask)&t;&t;&t; &bslash;&n;static int&t;&t;&t;&t;&t;&t;&t;&t; &bslash;&n;indirect_##rw##_config_##size(struct pci_dev *dev, int offset, type val) &bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t; &bslash;&n;&t;struct pci_controller *hose = dev-&gt;sysdata;&t;&t;&t; &bslash;&n;&t;&t;&t;&t;&t;&t;&t;&t;&t; &bslash;&n;&t;out_be32(hose-&gt;cfg_addr, &t;&t;&t;&t;&t; &bslash;&n;&t;&t; ((offset &amp; 0xfc) &lt;&lt; 24) | (dev-&gt;devfn &lt;&lt; 16)&t;&t; &bslash;&n;&t;&t; | (dev-&gt;bus-&gt;number &lt;&lt; 8) | 0x80);&t;&t;&t; &bslash;&n;&t;cfg_##rw(val, hose-&gt;cfg_data + (offset &amp; mask), type, op);&t; &bslash;&n;&t;return PCIBIOS_SUCCESSFUL;    &t;&t;&t;&t;&t; &bslash;&n;}
id|INDIRECT_PCI_OP
c_func
(paren
id|read
comma
id|byte
comma
id|u8
op_star
comma
id|in_8
comma
l_int|3
)paren
id|INDIRECT_PCI_OP
c_func
(paren
id|read
comma
id|word
comma
id|u16
op_star
comma
id|in_le16
comma
l_int|2
)paren
id|INDIRECT_PCI_OP
c_func
(paren
id|read
comma
id|dword
comma
id|u32
op_star
comma
id|in_le32
comma
l_int|0
)paren
id|INDIRECT_PCI_OP
c_func
(paren
id|write
comma
id|byte
comma
id|u8
comma
id|out_8
comma
l_int|3
)paren
id|INDIRECT_PCI_OP
c_func
(paren
id|write
comma
id|word
comma
id|u16
comma
id|out_le16
comma
l_int|2
)paren
id|INDIRECT_PCI_OP
c_func
(paren
id|write
comma
id|dword
comma
id|u32
comma
id|out_le32
comma
l_int|0
)paren
DECL|variable|indirect_pci_ops
r_static
r_struct
id|pci_ops
id|indirect_pci_ops
op_assign
(brace
id|indirect_read_config_byte
comma
id|indirect_read_config_word
comma
id|indirect_read_config_dword
comma
id|indirect_write_config_byte
comma
id|indirect_write_config_word
comma
id|indirect_write_config_dword
)brace
suffix:semicolon
r_void
id|__init
DECL|function|setup_indirect_pci
id|setup_indirect_pci
c_func
(paren
r_struct
id|pci_controller
op_star
id|hose
comma
id|u32
id|cfg_addr
comma
id|u32
id|cfg_data
)paren
(brace
id|hose-&gt;ops
op_assign
op_amp
id|indirect_pci_ops
suffix:semicolon
id|hose-&gt;cfg_addr
op_assign
(paren
r_int
r_int
op_star
)paren
id|ioremap
c_func
(paren
id|cfg_addr
comma
l_int|4
)paren
suffix:semicolon
id|hose-&gt;cfg_data
op_assign
(paren
r_int
r_char
op_star
)paren
id|ioremap
c_func
(paren
id|cfg_data
comma
l_int|4
)paren
suffix:semicolon
)brace
eof
