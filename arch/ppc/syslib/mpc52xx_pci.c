multiline_comment|/*&n; * arch/ppc/syslib/mpc52xx_pci.c&n; *&n; * PCI code for the Freescale MPC52xx embedded CPU.&n; *&n; *&n; * Maintainer : Sylvain Munaut &lt;tnt@246tNt.com&gt;&n; *&n; * Copyright (C) 2004 Sylvain Munaut &lt;tnt@246tNt.com&gt;&n; *&n; * This file is licensed under the terms of the GNU General Public License&n; * version 2. This program is licensed &quot;as is&quot; without any warranty of any&n; * kind, whether express or implied.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;asm/pci.h&gt;
macro_line|#include &lt;asm/mpc52xx.h&gt;
macro_line|#include &quot;mpc52xx_pci.h&quot;
macro_line|#include &lt;asm/delay.h&gt;
r_static
r_int
DECL|function|mpc52xx_pci_read_config
id|mpc52xx_pci_read_config
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|offset
comma
r_int
id|len
comma
id|u32
op_star
id|val
)paren
(brace
r_struct
id|pci_controller
op_star
id|hose
op_assign
id|bus-&gt;sysdata
suffix:semicolon
id|u32
id|value
suffix:semicolon
r_if
c_cond
(paren
id|ppc_md.pci_exclude_device
)paren
r_if
c_cond
(paren
id|ppc_md
dot
id|pci_exclude_device
c_func
(paren
id|bus-&gt;number
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|out_be32
c_func
(paren
id|hose-&gt;cfg_addr
comma
(paren
l_int|1
op_lshift
l_int|31
)paren
op_or
(paren
(paren
id|bus-&gt;number
op_minus
id|hose-&gt;bus_offset
)paren
op_lshift
l_int|16
)paren
op_or
(paren
id|devfn
op_lshift
l_int|8
)paren
op_or
(paren
id|offset
op_amp
l_int|0xfc
)paren
)paren
suffix:semicolon
id|value
op_assign
id|in_le32
c_func
(paren
id|hose-&gt;cfg_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
l_int|4
)paren
(brace
id|value
op_rshift_assign
(paren
(paren
id|offset
op_amp
l_int|0x3
)paren
op_lshift
l_int|3
)paren
suffix:semicolon
id|value
op_and_assign
l_int|0xffffffff
op_rshift
(paren
l_int|32
op_minus
(paren
id|len
op_lshift
l_int|3
)paren
)paren
suffix:semicolon
)brace
op_star
id|val
op_assign
id|value
suffix:semicolon
id|out_be32
c_func
(paren
id|hose-&gt;cfg_addr
comma
l_int|0
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
r_static
r_int
DECL|function|mpc52xx_pci_write_config
id|mpc52xx_pci_write_config
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|offset
comma
r_int
id|len
comma
id|u32
id|val
)paren
(brace
r_struct
id|pci_controller
op_star
id|hose
op_assign
id|bus-&gt;sysdata
suffix:semicolon
id|u32
id|value
comma
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|ppc_md.pci_exclude_device
)paren
r_if
c_cond
(paren
id|ppc_md
dot
id|pci_exclude_device
c_func
(paren
id|bus-&gt;number
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|out_be32
c_func
(paren
id|hose-&gt;cfg_addr
comma
(paren
l_int|1
op_lshift
l_int|31
)paren
op_or
(paren
(paren
id|bus-&gt;number
op_minus
id|hose-&gt;bus_offset
)paren
op_lshift
l_int|16
)paren
op_or
(paren
id|devfn
op_lshift
l_int|8
)paren
op_or
(paren
id|offset
op_amp
l_int|0xfc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
l_int|4
)paren
(brace
id|value
op_assign
id|in_le32
c_func
(paren
id|hose-&gt;cfg_data
)paren
suffix:semicolon
id|offset
op_assign
(paren
id|offset
op_amp
l_int|0x3
)paren
op_lshift
l_int|3
suffix:semicolon
id|mask
op_assign
(paren
l_int|0xffffffff
op_rshift
(paren
l_int|32
op_minus
(paren
id|len
op_lshift
l_int|3
)paren
)paren
)paren
suffix:semicolon
id|mask
op_lshift_assign
id|offset
suffix:semicolon
id|value
op_and_assign
op_complement
id|mask
suffix:semicolon
id|val
op_assign
id|value
op_or
(paren
(paren
id|val
op_lshift
id|offset
)paren
op_amp
id|mask
)paren
suffix:semicolon
)brace
id|out_le32
c_func
(paren
id|hose-&gt;cfg_data
comma
id|val
)paren
suffix:semicolon
id|out_be32
c_func
(paren
id|hose-&gt;cfg_addr
comma
l_int|0
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|variable|mpc52xx_pci_ops
r_static
r_struct
id|pci_ops
id|mpc52xx_pci_ops
op_assign
(brace
dot
id|read
op_assign
id|mpc52xx_pci_read_config
comma
dot
id|write
op_assign
id|mpc52xx_pci_write_config
)brace
suffix:semicolon
r_static
r_void
id|__init
DECL|function|mpc52xx_pci_setup
id|mpc52xx_pci_setup
c_func
(paren
r_struct
id|mpc52xx_pci
id|__iomem
op_star
id|pci_regs
)paren
(brace
multiline_comment|/* Setup control regs */
multiline_comment|/* Nothing to do afaik */
multiline_comment|/* Setup windows */
id|out_be32
c_func
(paren
op_amp
id|pci_regs-&gt;iw0btar
comma
id|MPC52xx_PCI_IWBTAR_TRANSLATION
c_func
(paren
id|MPC52xx_PCI_MEM_START
op_plus
id|MPC52xx_PCI_MEM_OFFSET
comma
id|MPC52xx_PCI_MEM_START
comma
id|MPC52xx_PCI_MEM_SIZE
)paren
)paren
suffix:semicolon
id|out_be32
c_func
(paren
op_amp
id|pci_regs-&gt;iw1btar
comma
id|MPC52xx_PCI_IWBTAR_TRANSLATION
c_func
(paren
id|MPC52xx_PCI_MMIO_START
op_plus
id|MPC52xx_PCI_MEM_OFFSET
comma
id|MPC52xx_PCI_MMIO_START
comma
id|MPC52xx_PCI_MMIO_SIZE
)paren
)paren
suffix:semicolon
id|out_be32
c_func
(paren
op_amp
id|pci_regs-&gt;iw2btar
comma
id|MPC52xx_PCI_IWBTAR_TRANSLATION
c_func
(paren
id|MPC52xx_PCI_IO_BASE
comma
id|MPC52xx_PCI_IO_START
comma
id|MPC52xx_PCI_IO_SIZE
)paren
)paren
suffix:semicolon
id|out_be32
c_func
(paren
op_amp
id|pci_regs-&gt;iwcr
comma
id|MPC52xx_PCI_IWCR_PACK
c_func
(paren
(paren
id|MPC52xx_PCI_IWCR_ENABLE
op_or
multiline_comment|/* iw0btar */
id|MPC52xx_PCI_IWCR_READ_MULTI
op_or
id|MPC52xx_PCI_IWCR_MEM
)paren
comma
(paren
id|MPC52xx_PCI_IWCR_ENABLE
op_or
multiline_comment|/* iw1btar */
id|MPC52xx_PCI_IWCR_READ
op_or
id|MPC52xx_PCI_IWCR_MEM
)paren
comma
(paren
id|MPC52xx_PCI_IWCR_ENABLE
op_or
multiline_comment|/* iw2btar */
id|MPC52xx_PCI_IWCR_IO
)paren
)paren
)paren
suffix:semicolon
id|out_be32
c_func
(paren
op_amp
id|pci_regs-&gt;tbatr0
comma
id|MPC52xx_PCI_TBATR_ENABLE
op_or
id|MPC52xx_PCI_TARGET_IO
)paren
suffix:semicolon
id|out_be32
c_func
(paren
op_amp
id|pci_regs-&gt;tbatr1
comma
id|MPC52xx_PCI_TBATR_ENABLE
op_or
id|MPC52xx_PCI_TARGET_MEM
)paren
suffix:semicolon
id|out_be32
c_func
(paren
op_amp
id|pci_regs-&gt;tcr
comma
id|MPC52xx_PCI_TCR_LD
)paren
suffix:semicolon
multiline_comment|/* Reset the exteral bus ( internal PCI controller is NOT resetted ) */
multiline_comment|/* Not necessary and can be a bad thing if for example the bootloader&n;&t;   is displaying a splash screen or ... Just left here for&n;&t;   documentation purpose if anyone need it */
macro_line|#if 0
id|u32
id|tmp
suffix:semicolon
id|tmp
op_assign
id|in_be32
c_func
(paren
op_amp
id|pci_regs-&gt;gscr
)paren
suffix:semicolon
id|out_be32
c_func
(paren
op_amp
id|pci_regs-&gt;gscr
comma
id|tmp
op_or
id|MPC52xx_PCI_GSCR_PR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|out_be32
c_func
(paren
op_amp
id|pci_regs-&gt;gscr
comma
id|tmp
)paren
suffix:semicolon
macro_line|#endif
)brace
r_static
r_void
id|__init
DECL|function|mpc52xx_pci_fixup_resources
id|mpc52xx_pci_fixup_resources
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* We don&squot;t rely on boot loader for PCI and resets all&n;&t;   devices */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEVICE_COUNT_RESOURCE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|resource
op_star
id|res
op_assign
op_amp
id|dev-&gt;resource
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|res-&gt;end
OG
id|res-&gt;start
)paren
(brace
multiline_comment|/* Only valid resources */
id|res-&gt;end
op_sub_assign
id|res-&gt;start
suffix:semicolon
id|res-&gt;start
op_assign
l_int|0
suffix:semicolon
id|res-&gt;flags
op_or_assign
id|IORESOURCE_UNSET
suffix:semicolon
)brace
)brace
multiline_comment|/* The PCI Host bridge of MPC52xx has a prefetch memory resource&n;&t;   fixed to 1Gb. Doesn&squot;t fit in the resource system so we remove it */
r_if
c_cond
(paren
(paren
id|dev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_MOTOROLA
)paren
op_logical_and
(paren
id|dev-&gt;device
op_eq
id|PCI_DEVICE_ID_MOTOROLA_MPC5200
)paren
)paren
(brace
r_struct
id|resource
op_star
id|res
op_assign
op_amp
id|dev-&gt;resource
(braket
l_int|1
)braket
suffix:semicolon
id|res-&gt;start
op_assign
id|res-&gt;end
op_assign
id|res-&gt;flags
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_void
id|__init
DECL|function|mpc52xx_find_bridges
id|mpc52xx_find_bridges
c_func
(paren
r_void
)paren
(brace
r_struct
id|mpc52xx_pci
id|__iomem
op_star
id|pci_regs
suffix:semicolon
r_struct
id|pci_controller
op_star
id|hose
suffix:semicolon
id|pci_assign_all_busses
op_assign
l_int|1
suffix:semicolon
id|pci_regs
op_assign
id|ioremap
c_func
(paren
id|MPC52xx_PCI
comma
r_sizeof
(paren
r_struct
id|mpc52xx_pci
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_regs
)paren
r_return
suffix:semicolon
id|hose
op_assign
id|pcibios_alloc_controller
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hose
)paren
(brace
id|iounmap
c_func
(paren
id|pci_regs
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ppc_md.pci_swizzle
op_assign
id|common_swizzle
suffix:semicolon
id|ppc_md.pcibios_fixup_resources
op_assign
id|mpc52xx_pci_fixup_resources
suffix:semicolon
id|hose-&gt;first_busno
op_assign
l_int|0
suffix:semicolon
id|hose-&gt;last_busno
op_assign
l_int|0xff
suffix:semicolon
id|hose-&gt;bus_offset
op_assign
l_int|0
suffix:semicolon
id|hose-&gt;ops
op_assign
op_amp
id|mpc52xx_pci_ops
suffix:semicolon
id|mpc52xx_pci_setup
c_func
(paren
id|pci_regs
)paren
suffix:semicolon
id|hose-&gt;pci_mem_offset
op_assign
id|MPC52xx_PCI_MEM_OFFSET
suffix:semicolon
id|isa_io_base
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|MPC52xx_PCI_IO_BASE
comma
id|MPC52xx_PCI_IO_SIZE
)paren
suffix:semicolon
id|hose-&gt;io_base_virt
op_assign
(paren
r_void
op_star
)paren
id|isa_io_base
suffix:semicolon
id|hose-&gt;cfg_addr
op_assign
op_amp
id|pci_regs-&gt;car
suffix:semicolon
id|hose-&gt;cfg_data
op_assign
(paren
r_void
id|__iomem
op_star
)paren
id|isa_io_base
suffix:semicolon
multiline_comment|/* Setup resources */
id|pci_init_resource
c_func
(paren
op_amp
id|hose-&gt;mem_resources
(braket
l_int|0
)braket
comma
id|MPC52xx_PCI_MEM_START
comma
id|MPC52xx_PCI_MEM_STOP
comma
id|IORESOURCE_MEM
op_or
id|IORESOURCE_PREFETCH
comma
l_string|&quot;PCI prefetchable memory&quot;
)paren
suffix:semicolon
id|pci_init_resource
c_func
(paren
op_amp
id|hose-&gt;mem_resources
(braket
l_int|1
)braket
comma
id|MPC52xx_PCI_MMIO_START
comma
id|MPC52xx_PCI_MMIO_STOP
comma
id|IORESOURCE_MEM
comma
l_string|&quot;PCI memory&quot;
)paren
suffix:semicolon
id|pci_init_resource
c_func
(paren
op_amp
id|hose-&gt;io_resource
comma
id|MPC52xx_PCI_IO_START
comma
id|MPC52xx_PCI_IO_STOP
comma
id|IORESOURCE_IO
comma
l_string|&quot;PCI I/O&quot;
)paren
suffix:semicolon
)brace
eof
