multiline_comment|/*&n; * arch/ppc/platforms/mpc8260_pci9.c&n; *&n; * Workaround for device erratum PCI 9.&n; * See Motorola&squot;s &quot;XPC826xA Family Device Errata Reference.&quot;&n; * The erratum applies to all 8260 family Hip4 processors.  It is scheduled &n; * to be fixed in HiP4 Rev C.  Erratum PCI 9 states that a simultaneous PCI &n; * inbound write transaction and PCI outbound read transaction can result in a &n; * bus deadlock.  The suggested workaround is to use the IDMA controller to &n; * perform all reads from PCI configuration, memory, and I/O space.&n; *&n; * Author:  andy_lowe@mvista.com&n; *&n; * 2003 (c) MontaVista Software, Inc. This file is licensed under&n; * the terms of the GNU General Public License version 2. This program&n; * is licensed &quot;as is&quot; without any warranty of any kind, whether express&n; * or implied.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/mpc8260.h&gt;
macro_line|#include &lt;asm/immap_cpm2.h&gt;
macro_line|#include &lt;asm/cpm2.h&gt;
macro_line|#include &quot;m8260_pci.h&quot;
macro_line|#ifdef CONFIG_8260_PCI9
multiline_comment|/*#include &lt;asm/mpc8260_pci9.h&gt;*/
multiline_comment|/* included in asm/io.h */
DECL|macro|IDMA_XFER_BUF_SIZE
mdefine_line|#define IDMA_XFER_BUF_SIZE 64&t;/* size of the IDMA transfer buffer */
multiline_comment|/* define a structure for the IDMA dpram usage */
DECL|struct|idma_dpram_s
r_typedef
r_struct
id|idma_dpram_s
(brace
DECL|member|pram
id|idma_t
id|pram
suffix:semicolon
multiline_comment|/* IDMA parameter RAM */
DECL|member|xfer_buf
id|u_char
id|xfer_buf
(braket
id|IDMA_XFER_BUF_SIZE
)braket
suffix:semicolon
multiline_comment|/* IDMA transfer buffer */
DECL|member|bd
id|idma_bd_t
id|bd
suffix:semicolon
multiline_comment|/* buffer descriptor */
DECL|typedef|idma_dpram_t
)brace
id|idma_dpram_t
suffix:semicolon
multiline_comment|/* define offsets relative to start of IDMA dpram */
DECL|macro|IDMA_XFER_BUF_OFFSET
mdefine_line|#define IDMA_XFER_BUF_OFFSET (sizeof(idma_t))
DECL|macro|IDMA_BD_OFFSET
mdefine_line|#define IDMA_BD_OFFSET (sizeof(idma_t) + IDMA_XFER_BUF_SIZE)
multiline_comment|/* define globals */
DECL|variable|idma_dpram
r_static
r_volatile
id|idma_dpram_t
op_star
id|idma_dpram
suffix:semicolon
multiline_comment|/* Exactly one of CONFIG_8260_PCI9_IDMAn must be defined, &n; * where n is 1, 2, 3, or 4.  This selects the IDMA channel used for &n; * the PCI9 workaround.&n; */
macro_line|#ifdef CONFIG_8260_PCI9_IDMA1
DECL|macro|IDMA_CHAN
mdefine_line|#define IDMA_CHAN 0
DECL|macro|PROFF_IDMA
mdefine_line|#define PROFF_IDMA PROFF_IDMA1_BASE
DECL|macro|IDMA_PAGE
mdefine_line|#define IDMA_PAGE CPM_CR_IDMA1_PAGE
DECL|macro|IDMA_SBLOCK
mdefine_line|#define IDMA_SBLOCK CPM_CR_IDMA1_SBLOCK
macro_line|#endif
macro_line|#ifdef CONFIG_8260_PCI9_IDMA2
DECL|macro|IDMA_CHAN
mdefine_line|#define IDMA_CHAN 1
DECL|macro|PROFF_IDMA
mdefine_line|#define PROFF_IDMA PROFF_IDMA2_BASE
DECL|macro|IDMA_PAGE
mdefine_line|#define IDMA_PAGE CPM_CR_IDMA2_PAGE
DECL|macro|IDMA_SBLOCK
mdefine_line|#define IDMA_SBLOCK CPM_CR_IDMA2_SBLOCK
macro_line|#endif
macro_line|#ifdef CONFIG_8260_PCI9_IDMA3
DECL|macro|IDMA_CHAN
mdefine_line|#define IDMA_CHAN 2
DECL|macro|PROFF_IDMA
mdefine_line|#define PROFF_IDMA PROFF_IDMA3_BASE
DECL|macro|IDMA_PAGE
mdefine_line|#define IDMA_PAGE CPM_CR_IDMA3_PAGE
DECL|macro|IDMA_SBLOCK
mdefine_line|#define IDMA_SBLOCK CPM_CR_IDMA3_SBLOCK
macro_line|#endif
macro_line|#ifdef CONFIG_8260_PCI9_IDMA4
DECL|macro|IDMA_CHAN
mdefine_line|#define IDMA_CHAN 3
DECL|macro|PROFF_IDMA
mdefine_line|#define PROFF_IDMA PROFF_IDMA4_BASE
DECL|macro|IDMA_PAGE
mdefine_line|#define IDMA_PAGE CPM_CR_IDMA4_PAGE
DECL|macro|IDMA_SBLOCK
mdefine_line|#define IDMA_SBLOCK CPM_CR_IDMA4_SBLOCK
macro_line|#endif
DECL|function|idma_pci9_init
r_void
id|idma_pci9_init
c_func
(paren
r_void
)paren
(brace
id|uint
id|dpram_offset
suffix:semicolon
r_volatile
id|idma_t
op_star
id|pram
suffix:semicolon
r_volatile
id|im_idma_t
op_star
id|idma_reg
suffix:semicolon
r_volatile
id|cpm2_map_t
op_star
id|immap
op_assign
id|cpm2_immr
suffix:semicolon
multiline_comment|/* allocate IDMA dpram */
id|dpram_offset
op_assign
id|cpm2_dpalloc
c_func
(paren
r_sizeof
(paren
id|idma_dpram_t
)paren
comma
l_int|64
)paren
suffix:semicolon
id|idma_dpram
op_assign
(paren
r_volatile
id|idma_dpram_t
op_star
)paren
op_amp
id|immap-&gt;im_dprambase
(braket
id|dpram_offset
)braket
suffix:semicolon
multiline_comment|/* initialize the IDMA parameter RAM */
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|idma_dpram
comma
l_int|0
comma
r_sizeof
(paren
id|idma_dpram_t
)paren
)paren
suffix:semicolon
id|pram
op_assign
op_amp
id|idma_dpram-&gt;pram
suffix:semicolon
id|pram-&gt;ibase
op_assign
id|dpram_offset
op_plus
id|IDMA_BD_OFFSET
suffix:semicolon
id|pram-&gt;dpr_buf
op_assign
id|dpram_offset
op_plus
id|IDMA_XFER_BUF_OFFSET
suffix:semicolon
id|pram-&gt;ss_max
op_assign
l_int|32
suffix:semicolon
id|pram-&gt;dts
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* initialize the IDMA_BASE pointer to the IDMA parameter RAM */
op_star
(paren
(paren
id|ushort
op_star
)paren
op_amp
id|immap-&gt;im_dprambase
(braket
id|PROFF_IDMA
)braket
)paren
op_assign
id|dpram_offset
suffix:semicolon
multiline_comment|/* initialize the IDMA registers */
id|idma_reg
op_assign
(paren
r_volatile
id|im_idma_t
op_star
)paren
op_amp
id|immap-&gt;im_sdma.sdma_idsr1
suffix:semicolon
id|idma_reg
(braket
id|IDMA_CHAN
)braket
dot
id|idmr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* mask all IDMA interrupts */
id|idma_reg
(braket
id|IDMA_CHAN
)braket
dot
id|idsr
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* clear all event flags */
id|printk
c_func
(paren
l_string|&quot;&lt;4&gt;Using IDMA%d for MPC8260 device erratum PCI 9 workaround&bslash;n&quot;
comma
id|IDMA_CHAN
op_plus
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Use the IDMA controller to transfer data from I/O memory to local RAM.&n; * The src address must be a physical address suitable for use by the DMA &n; * controller with no translation.  The dst address must be a kernel virtual &n; * address.  The dst address is translated to a physical address via &n; * virt_to_phys().&n; * The sinc argument specifies whether or not the source address is incremented&n; * by the DMA controller.  The source address is incremented if and only if sinc&n; * is non-zero.  The destination address is always incremented since the &n; * destination is always host RAM.&n; */
r_static
r_void
DECL|function|idma_pci9_read
id|idma_pci9_read
c_func
(paren
id|u8
op_star
id|dst
comma
id|u8
op_star
id|src
comma
r_int
id|bytes
comma
r_int
id|unit_size
comma
r_int
id|sinc
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_volatile
id|idma_t
op_star
id|pram
op_assign
op_amp
id|idma_dpram-&gt;pram
suffix:semicolon
r_volatile
id|idma_bd_t
op_star
id|bd
op_assign
op_amp
id|idma_dpram-&gt;bd
suffix:semicolon
r_volatile
id|cpm2_map_t
op_star
id|immap
op_assign
id|cpm2_immr
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* initialize IDMA parameter RAM for this transfer */
r_if
c_cond
(paren
id|sinc
)paren
id|pram-&gt;dcm
op_assign
id|IDMA_DCM_DMA_WRAP_64
op_or
id|IDMA_DCM_SINC
op_or
id|IDMA_DCM_DINC
op_or
id|IDMA_DCM_SD_MEM2MEM
suffix:semicolon
r_else
id|pram-&gt;dcm
op_assign
id|IDMA_DCM_DMA_WRAP_64
op_or
id|IDMA_DCM_DINC
op_or
id|IDMA_DCM_SD_MEM2MEM
suffix:semicolon
id|pram-&gt;ibdptr
op_assign
id|pram-&gt;ibase
suffix:semicolon
id|pram-&gt;sts
op_assign
id|unit_size
suffix:semicolon
id|pram-&gt;istate
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* initialize the buffer descriptor */
id|bd-&gt;dst
op_assign
id|virt_to_phys
c_func
(paren
id|dst
)paren
suffix:semicolon
id|bd-&gt;src
op_assign
(paren
id|uint
)paren
id|src
suffix:semicolon
id|bd-&gt;len
op_assign
id|bytes
suffix:semicolon
id|bd-&gt;flags
op_assign
id|IDMA_BD_V
op_or
id|IDMA_BD_W
op_or
id|IDMA_BD_I
op_or
id|IDMA_BD_L
op_or
id|IDMA_BD_DGBL
op_or
id|IDMA_BD_DBO_BE
op_or
id|IDMA_BD_SBO_BE
op_or
id|IDMA_BD_SDTB
suffix:semicolon
multiline_comment|/* issue the START_IDMA command to the CP */
r_while
c_loop
(paren
id|immap-&gt;im_cpm.cp_cpcr
op_amp
id|CPM_CR_FLG
)paren
suffix:semicolon
id|immap-&gt;im_cpm.cp_cpcr
op_assign
id|mk_cr_cmd
c_func
(paren
id|IDMA_PAGE
comma
id|IDMA_SBLOCK
comma
l_int|0
comma
id|CPM_CR_START_IDMA
)paren
op_or
id|CPM_CR_FLG
suffix:semicolon
r_while
c_loop
(paren
id|immap-&gt;im_cpm.cp_cpcr
op_amp
id|CPM_CR_FLG
)paren
suffix:semicolon
multiline_comment|/* wait for transfer to complete */
r_while
c_loop
(paren
id|bd-&gt;flags
op_amp
id|IDMA_BD_V
)paren
(brace
suffix:semicolon
)brace
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Use the IDMA controller to transfer data from I/O memory to local RAM.&n; * The dst address must be a physical address suitable for use by the DMA &n; * controller with no translation.  The src address must be a kernel virtual &n; * address.  The src address is translated to a physical address via &n; * virt_to_phys().&n; * The dinc argument specifies whether or not the dest address is incremented&n; * by the DMA controller.  The source address is incremented if and only if sinc&n; * is non-zero.  The source address is always incremented since the &n; * source is always host RAM.&n; */
r_static
r_void
DECL|function|idma_pci9_write
id|idma_pci9_write
c_func
(paren
id|u8
op_star
id|dst
comma
id|u8
op_star
id|src
comma
r_int
id|bytes
comma
r_int
id|unit_size
comma
r_int
id|dinc
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_volatile
id|idma_t
op_star
id|pram
op_assign
op_amp
id|idma_dpram-&gt;pram
suffix:semicolon
r_volatile
id|idma_bd_t
op_star
id|bd
op_assign
op_amp
id|idma_dpram-&gt;bd
suffix:semicolon
r_volatile
id|cpm2_map_t
op_star
id|immap
op_assign
id|cpm2_immr
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* initialize IDMA parameter RAM for this transfer */
r_if
c_cond
(paren
id|dinc
)paren
id|pram-&gt;dcm
op_assign
id|IDMA_DCM_DMA_WRAP_64
op_or
id|IDMA_DCM_SINC
op_or
id|IDMA_DCM_DINC
op_or
id|IDMA_DCM_SD_MEM2MEM
suffix:semicolon
r_else
id|pram-&gt;dcm
op_assign
id|IDMA_DCM_DMA_WRAP_64
op_or
id|IDMA_DCM_SINC
op_or
id|IDMA_DCM_SD_MEM2MEM
suffix:semicolon
id|pram-&gt;ibdptr
op_assign
id|pram-&gt;ibase
suffix:semicolon
id|pram-&gt;sts
op_assign
id|unit_size
suffix:semicolon
id|pram-&gt;istate
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* initialize the buffer descriptor */
id|bd-&gt;dst
op_assign
(paren
id|uint
)paren
id|dst
suffix:semicolon
id|bd-&gt;src
op_assign
id|virt_to_phys
c_func
(paren
id|src
)paren
suffix:semicolon
id|bd-&gt;len
op_assign
id|bytes
suffix:semicolon
id|bd-&gt;flags
op_assign
id|IDMA_BD_V
op_or
id|IDMA_BD_W
op_or
id|IDMA_BD_I
op_or
id|IDMA_BD_L
op_or
id|IDMA_BD_DGBL
op_or
id|IDMA_BD_DBO_BE
op_or
id|IDMA_BD_SBO_BE
op_or
id|IDMA_BD_SDTB
suffix:semicolon
multiline_comment|/* issue the START_IDMA command to the CP */
r_while
c_loop
(paren
id|immap-&gt;im_cpm.cp_cpcr
op_amp
id|CPM_CR_FLG
)paren
suffix:semicolon
id|immap-&gt;im_cpm.cp_cpcr
op_assign
id|mk_cr_cmd
c_func
(paren
id|IDMA_PAGE
comma
id|IDMA_SBLOCK
comma
l_int|0
comma
id|CPM_CR_START_IDMA
)paren
op_or
id|CPM_CR_FLG
suffix:semicolon
r_while
c_loop
(paren
id|immap-&gt;im_cpm.cp_cpcr
op_amp
id|CPM_CR_FLG
)paren
suffix:semicolon
multiline_comment|/* wait for transfer to complete */
r_while
c_loop
(paren
id|bd-&gt;flags
op_amp
id|IDMA_BD_V
)paren
(brace
suffix:semicolon
)brace
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Same as idma_pci9_read, but 16-bit little-endian byte swapping is performed&n; * if the unit_size is 2, and 32-bit little-endian byte swapping is performed if&n; * the unit_size is 4.&n; */
r_static
r_void
DECL|function|idma_pci9_read_le
id|idma_pci9_read_le
c_func
(paren
id|u8
op_star
id|dst
comma
id|u8
op_star
id|src
comma
r_int
id|bytes
comma
r_int
id|unit_size
comma
r_int
id|sinc
)paren
(brace
r_int
id|i
suffix:semicolon
id|u8
op_star
id|p
suffix:semicolon
id|idma_pci9_read
c_func
(paren
id|dst
comma
id|src
comma
id|bytes
comma
id|unit_size
comma
id|sinc
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|unit_size
)paren
(brace
r_case
l_int|2
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|p
op_assign
id|dst
suffix:semicolon
id|i
OL
id|bytes
suffix:semicolon
id|i
op_add_assign
l_int|2
comma
id|p
op_add_assign
l_int|2
)paren
id|swab16s
c_func
(paren
(paren
id|u16
op_star
)paren
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|p
op_assign
id|dst
suffix:semicolon
id|i
OL
id|bytes
suffix:semicolon
id|i
op_add_assign
l_int|4
comma
id|p
op_add_assign
l_int|4
)paren
id|swab32s
c_func
(paren
(paren
id|u32
op_star
)paren
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
DECL|variable|idma_pci9_init
id|EXPORT_SYMBOL
c_func
(paren
id|idma_pci9_init
)paren
suffix:semicolon
DECL|variable|idma_pci9_read
id|EXPORT_SYMBOL
c_func
(paren
id|idma_pci9_read
)paren
suffix:semicolon
DECL|variable|idma_pci9_read_le
id|EXPORT_SYMBOL
c_func
(paren
id|idma_pci9_read_le
)paren
suffix:semicolon
DECL|function|is_pci_mem
r_static
r_inline
r_int
id|is_pci_mem
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_if
c_cond
(paren
id|addr
op_ge
id|MPC826x_PCI_LOWER_MMIO
op_logical_and
id|addr
op_le
id|MPC826x_PCI_UPPER_MMIO
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_ge
id|MPC826x_PCI_LOWER_MEM
op_logical_and
id|addr
op_le
id|MPC826x_PCI_UPPER_MEM
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|is_pci_mem
mdefine_line|#define is_pci_mem(pa) ( (pa &gt; 0x80000000) &amp;&amp; (pa &lt; 0xc0000000))
DECL|function|readb
r_int
id|readb
c_func
(paren
r_volatile
r_int
r_char
op_star
id|addr
)paren
(brace
id|u8
id|val
suffix:semicolon
r_int
r_int
id|pa
op_assign
id|iopa
c_func
(paren
(paren
r_int
r_int
)paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_pci_mem
c_func
(paren
id|pa
)paren
)paren
r_return
id|in_8
c_func
(paren
id|addr
)paren
suffix:semicolon
id|idma_pci9_read
c_func
(paren
(paren
id|u8
op_star
)paren
op_amp
id|val
comma
(paren
id|u8
op_star
)paren
id|pa
comma
r_sizeof
(paren
id|val
)paren
comma
r_sizeof
(paren
id|val
)paren
comma
l_int|0
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
DECL|function|readw
r_int
id|readw
c_func
(paren
r_volatile
r_int
r_int
op_star
id|addr
)paren
(brace
id|u16
id|val
suffix:semicolon
r_int
r_int
id|pa
op_assign
id|iopa
c_func
(paren
(paren
r_int
r_int
)paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_pci_mem
c_func
(paren
id|pa
)paren
)paren
r_return
id|in_le16
c_func
(paren
id|addr
)paren
suffix:semicolon
id|idma_pci9_read
c_func
(paren
(paren
id|u8
op_star
)paren
op_amp
id|val
comma
(paren
id|u8
op_star
)paren
id|pa
comma
r_sizeof
(paren
id|val
)paren
comma
r_sizeof
(paren
id|val
)paren
comma
l_int|0
)paren
suffix:semicolon
r_return
id|swab16
c_func
(paren
id|val
)paren
suffix:semicolon
)brace
DECL|function|readl
r_int
id|readl
c_func
(paren
r_volatile
r_int
op_star
id|addr
)paren
(brace
id|u32
id|val
suffix:semicolon
r_int
r_int
id|pa
op_assign
id|iopa
c_func
(paren
(paren
r_int
r_int
)paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_pci_mem
c_func
(paren
id|pa
)paren
)paren
r_return
id|in_le32
c_func
(paren
id|addr
)paren
suffix:semicolon
id|idma_pci9_read
c_func
(paren
(paren
id|u8
op_star
)paren
op_amp
id|val
comma
(paren
id|u8
op_star
)paren
id|pa
comma
r_sizeof
(paren
id|val
)paren
comma
r_sizeof
(paren
id|val
)paren
comma
l_int|0
)paren
suffix:semicolon
r_return
id|swab32
c_func
(paren
id|val
)paren
suffix:semicolon
)brace
DECL|function|inb
r_int
id|inb
c_func
(paren
r_int
id|port
)paren
(brace
id|u8
id|val
suffix:semicolon
id|u8
op_star
id|addr
op_assign
(paren
id|u8
op_star
)paren
(paren
id|port
op_plus
id|_IO_BASE
)paren
suffix:semicolon
id|idma_pci9_read
c_func
(paren
(paren
id|u8
op_star
)paren
op_amp
id|val
comma
(paren
id|u8
op_star
)paren
id|addr
comma
r_sizeof
(paren
id|val
)paren
comma
r_sizeof
(paren
id|val
)paren
comma
l_int|0
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
DECL|function|inw
r_int
id|inw
c_func
(paren
r_int
id|port
)paren
(brace
id|u16
id|val
suffix:semicolon
id|u8
op_star
id|addr
op_assign
(paren
id|u8
op_star
)paren
(paren
id|port
op_plus
id|_IO_BASE
)paren
suffix:semicolon
id|idma_pci9_read
c_func
(paren
(paren
id|u8
op_star
)paren
op_amp
id|val
comma
(paren
id|u8
op_star
)paren
id|addr
comma
r_sizeof
(paren
id|val
)paren
comma
r_sizeof
(paren
id|val
)paren
comma
l_int|0
)paren
suffix:semicolon
r_return
id|swab16
c_func
(paren
id|val
)paren
suffix:semicolon
)brace
DECL|function|inl
r_int
id|inl
c_func
(paren
r_int
id|port
)paren
(brace
id|u32
id|val
suffix:semicolon
id|u8
op_star
id|addr
op_assign
(paren
id|u8
op_star
)paren
(paren
id|port
op_plus
id|_IO_BASE
)paren
suffix:semicolon
id|idma_pci9_read
c_func
(paren
(paren
id|u8
op_star
)paren
op_amp
id|val
comma
(paren
id|u8
op_star
)paren
id|addr
comma
r_sizeof
(paren
id|val
)paren
comma
r_sizeof
(paren
id|val
)paren
comma
l_int|0
)paren
suffix:semicolon
r_return
id|swab32
c_func
(paren
id|val
)paren
suffix:semicolon
)brace
DECL|function|insb
r_void
id|insb
c_func
(paren
r_int
id|port
comma
r_void
op_star
id|buf
comma
r_int
id|ns
)paren
(brace
id|u8
op_star
id|addr
op_assign
(paren
id|u8
op_star
)paren
(paren
id|port
op_plus
id|_IO_BASE
)paren
suffix:semicolon
id|idma_pci9_read
c_func
(paren
(paren
id|u8
op_star
)paren
id|buf
comma
(paren
id|u8
op_star
)paren
id|addr
comma
id|ns
op_star
r_sizeof
(paren
id|u8
)paren
comma
r_sizeof
(paren
id|u8
)paren
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|insw
r_void
id|insw
c_func
(paren
r_int
id|port
comma
r_void
op_star
id|buf
comma
r_int
id|ns
)paren
(brace
id|u8
op_star
id|addr
op_assign
(paren
id|u8
op_star
)paren
(paren
id|port
op_plus
id|_IO_BASE
)paren
suffix:semicolon
id|idma_pci9_read
c_func
(paren
(paren
id|u8
op_star
)paren
id|buf
comma
(paren
id|u8
op_star
)paren
id|addr
comma
id|ns
op_star
r_sizeof
(paren
id|u16
)paren
comma
r_sizeof
(paren
id|u16
)paren
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|insl
r_void
id|insl
c_func
(paren
r_int
id|port
comma
r_void
op_star
id|buf
comma
r_int
id|nl
)paren
(brace
id|u8
op_star
id|addr
op_assign
(paren
id|u8
op_star
)paren
(paren
id|port
op_plus
id|_IO_BASE
)paren
suffix:semicolon
id|idma_pci9_read
c_func
(paren
(paren
id|u8
op_star
)paren
id|buf
comma
(paren
id|u8
op_star
)paren
id|addr
comma
id|nl
op_star
r_sizeof
(paren
id|u32
)paren
comma
r_sizeof
(paren
id|u32
)paren
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|insw_ns
r_void
id|insw_ns
c_func
(paren
r_int
id|port
comma
r_void
op_star
id|buf
comma
r_int
id|ns
)paren
(brace
id|u8
op_star
id|addr
op_assign
(paren
id|u8
op_star
)paren
(paren
id|port
op_plus
id|_IO_BASE
)paren
suffix:semicolon
id|idma_pci9_read
c_func
(paren
(paren
id|u8
op_star
)paren
id|buf
comma
(paren
id|u8
op_star
)paren
id|addr
comma
id|ns
op_star
r_sizeof
(paren
id|u16
)paren
comma
r_sizeof
(paren
id|u16
)paren
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|insl_ns
r_void
id|insl_ns
c_func
(paren
r_int
id|port
comma
r_void
op_star
id|buf
comma
r_int
id|nl
)paren
(brace
id|u8
op_star
id|addr
op_assign
(paren
id|u8
op_star
)paren
(paren
id|port
op_plus
id|_IO_BASE
)paren
suffix:semicolon
id|idma_pci9_read
c_func
(paren
(paren
id|u8
op_star
)paren
id|buf
comma
(paren
id|u8
op_star
)paren
id|addr
comma
id|nl
op_star
r_sizeof
(paren
id|u32
)paren
comma
r_sizeof
(paren
id|u32
)paren
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|memcpy_fromio
r_void
op_star
id|memcpy_fromio
c_func
(paren
r_void
op_star
id|dest
comma
r_int
r_int
id|src
comma
r_int
id|count
)paren
(brace
r_int
r_int
id|pa
op_assign
id|iopa
c_func
(paren
(paren
r_int
r_int
)paren
id|src
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_pci_mem
c_func
(paren
id|pa
)paren
)paren
id|idma_pci9_read
c_func
(paren
(paren
id|u8
op_star
)paren
id|dest
comma
(paren
id|u8
op_star
)paren
id|pa
comma
id|count
comma
l_int|32
comma
l_int|1
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
id|dest
comma
(paren
r_void
op_star
)paren
id|src
comma
id|count
)paren
suffix:semicolon
r_return
id|dest
suffix:semicolon
)brace
DECL|variable|readb
id|EXPORT_SYMBOL
c_func
(paren
id|readb
)paren
suffix:semicolon
DECL|variable|readw
id|EXPORT_SYMBOL
c_func
(paren
id|readw
)paren
suffix:semicolon
DECL|variable|readl
id|EXPORT_SYMBOL
c_func
(paren
id|readl
)paren
suffix:semicolon
DECL|variable|inb
id|EXPORT_SYMBOL
c_func
(paren
id|inb
)paren
suffix:semicolon
DECL|variable|inw
id|EXPORT_SYMBOL
c_func
(paren
id|inw
)paren
suffix:semicolon
DECL|variable|inl
id|EXPORT_SYMBOL
c_func
(paren
id|inl
)paren
suffix:semicolon
DECL|variable|insb
id|EXPORT_SYMBOL
c_func
(paren
id|insb
)paren
suffix:semicolon
DECL|variable|insw
id|EXPORT_SYMBOL
c_func
(paren
id|insw
)paren
suffix:semicolon
DECL|variable|insl
id|EXPORT_SYMBOL
c_func
(paren
id|insl
)paren
suffix:semicolon
DECL|variable|insw_ns
id|EXPORT_SYMBOL
c_func
(paren
id|insw_ns
)paren
suffix:semicolon
DECL|variable|insl_ns
id|EXPORT_SYMBOL
c_func
(paren
id|insl_ns
)paren
suffix:semicolon
DECL|variable|memcpy_fromio
id|EXPORT_SYMBOL
c_func
(paren
id|memcpy_fromio
)paren
suffix:semicolon
macro_line|#endif&t;/* ifdef CONFIG_8260_PCI9 */
multiline_comment|/* Indirect PCI routines adapted from arch/ppc/kernel/indirect_pci.c.&n; * Copyright (C) 1998 Gabriel Paubert.&n; */
macro_line|#ifndef CONFIG_8260_PCI9
DECL|macro|cfg_read
mdefine_line|#define cfg_read(val, addr, type, op)&t;*val = op((type)(addr))
macro_line|#else
DECL|macro|cfg_read
mdefine_line|#define cfg_read(val, addr, type, op) &bslash;&n;&t;idma_pci9_read_le((u8*)(val),(u8*)(addr),sizeof(*(val)),sizeof(*(val)),0)
macro_line|#endif
DECL|macro|cfg_write
mdefine_line|#define cfg_write(val, addr, type, op)&t;op((type *)(addr), (val))
DECL|function|indirect_write_config
r_static
r_int
id|indirect_write_config
c_func
(paren
r_struct
id|pci_bus
op_star
id|pbus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
id|value
)paren
(brace
r_struct
id|pci_controller
op_star
id|hose
op_assign
id|pbus-&gt;sysdata
suffix:semicolon
id|u8
id|cfg_type
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ppc_md.pci_exclude_device
)paren
r_if
c_cond
(paren
id|ppc_md
dot
id|pci_exclude_device
c_func
(paren
id|pbus-&gt;number
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_if
c_cond
(paren
id|hose-&gt;set_cfg_type
)paren
r_if
c_cond
(paren
id|pbus-&gt;number
op_ne
id|hose-&gt;first_busno
)paren
id|cfg_type
op_assign
l_int|1
suffix:semicolon
id|out_be32
c_func
(paren
id|hose-&gt;cfg_addr
comma
(paren
(paren
(paren
id|where
op_amp
l_int|0xfc
)paren
op_or
id|cfg_type
)paren
op_lshift
l_int|24
)paren
op_or
(paren
id|devfn
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|pbus-&gt;number
op_minus
id|hose-&gt;bus_offset
)paren
op_lshift
l_int|8
)paren
op_or
l_int|0x80
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
l_int|1
suffix:colon
id|cfg_write
c_func
(paren
id|value
comma
id|hose-&gt;cfg_data
op_plus
(paren
id|where
op_amp
l_int|3
)paren
comma
id|u8
comma
id|out_8
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|cfg_write
c_func
(paren
id|value
comma
id|hose-&gt;cfg_data
op_plus
(paren
id|where
op_amp
l_int|2
)paren
comma
id|u16
comma
id|out_le16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|cfg_write
c_func
(paren
id|value
comma
id|hose-&gt;cfg_data
op_plus
(paren
id|where
op_amp
l_int|0
)paren
comma
id|u32
comma
id|out_le32
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|indirect_read_config
r_static
r_int
id|indirect_read_config
c_func
(paren
r_struct
id|pci_bus
op_star
id|pbus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
op_star
id|value
)paren
(brace
r_struct
id|pci_controller
op_star
id|hose
op_assign
id|pbus-&gt;sysdata
suffix:semicolon
id|u8
id|cfg_type
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ppc_md.pci_exclude_device
)paren
r_if
c_cond
(paren
id|ppc_md
dot
id|pci_exclude_device
c_func
(paren
id|pbus-&gt;number
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_if
c_cond
(paren
id|hose-&gt;set_cfg_type
)paren
r_if
c_cond
(paren
id|pbus-&gt;number
op_ne
id|hose-&gt;first_busno
)paren
id|cfg_type
op_assign
l_int|1
suffix:semicolon
id|out_be32
c_func
(paren
id|hose-&gt;cfg_addr
comma
(paren
(paren
(paren
id|where
op_amp
l_int|0xfc
)paren
op_or
id|cfg_type
)paren
op_lshift
l_int|24
)paren
op_or
(paren
id|devfn
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|pbus-&gt;number
op_minus
id|hose-&gt;bus_offset
)paren
op_lshift
l_int|8
)paren
op_or
l_int|0x80
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
l_int|1
suffix:colon
id|cfg_read
c_func
(paren
id|value
comma
id|hose-&gt;cfg_data
op_plus
(paren
id|where
op_amp
l_int|3
)paren
comma
id|u8
op_star
comma
id|in_8
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|cfg_read
c_func
(paren
id|value
comma
id|hose-&gt;cfg_data
op_plus
(paren
id|where
op_amp
l_int|2
)paren
comma
id|u16
op_star
comma
id|in_le16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|cfg_read
c_func
(paren
id|value
comma
id|hose-&gt;cfg_data
op_plus
(paren
id|where
op_amp
l_int|0
)paren
comma
id|u32
op_star
comma
id|in_le32
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|variable|indirect_pci_ops
r_static
r_struct
id|pci_ops
id|indirect_pci_ops
op_assign
(brace
dot
id|read
op_assign
id|indirect_read_config
comma
dot
id|write
op_assign
id|indirect_write_config
comma
)brace
suffix:semicolon
r_void
DECL|function|setup_m8260_indirect_pci
id|setup_m8260_indirect_pci
c_func
(paren
r_struct
id|pci_controller
op_star
id|hose
comma
id|u32
id|cfg_addr
comma
id|u32
id|cfg_data
)paren
(brace
id|hose-&gt;ops
op_assign
op_amp
id|indirect_pci_ops
suffix:semicolon
id|hose-&gt;cfg_addr
op_assign
(paren
r_int
r_int
op_star
)paren
id|ioremap
c_func
(paren
id|cfg_addr
comma
l_int|4
)paren
suffix:semicolon
id|hose-&gt;cfg_data
op_assign
(paren
r_int
r_char
op_star
)paren
id|ioremap
c_func
(paren
id|cfg_data
comma
l_int|4
)paren
suffix:semicolon
)brace
eof
