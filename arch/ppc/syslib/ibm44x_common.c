multiline_comment|/*&n; * arch/ppc/syslib/ibm44x_common.c&n; *&n; * PPC44x system library&n; *&n; * Matt Porter &lt;mporter@kernel.crashing.org&gt;&n; * Copyright 2002-2005 MontaVista Software Inc.&n; *&n; * Eugene Surovegin &lt;eugene.surovegin@zultys.com&gt; or &lt;ebs@ebshome.net&gt;&n; * Copyright (c) 2003, 2004 Zultys Technologies&n; *&n; * This program is free software; you can redistribute  it and/or modify it&n; * under  the terms of  the GNU General  Public License as published by the&n; * Free Software Foundation;  either version 2 of the  License, or (at your&n; * option) any later version.&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/ibm44x.h&gt;
macro_line|#include &lt;asm/mmu.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/time.h&gt;
macro_line|#include &lt;asm/ppc4xx_pic.h&gt;
macro_line|#include &lt;asm/param.h&gt;
macro_line|#include &lt;syslib/gen550.h&gt;
DECL|function|fixup_bigphys_addr
id|phys_addr_t
id|fixup_bigphys_addr
c_func
(paren
id|phys_addr_t
id|addr
comma
id|phys_addr_t
id|size
)paren
(brace
id|phys_addr_t
id|page_4gb
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Trap the least significant 32-bit portions of an&n;&t; * address in the 440&squot;s 36-bit address space.  Fix&n;&t; * them up with the appropriate ERPN&n;&t; */
r_if
c_cond
(paren
(paren
id|addr
op_ge
id|PPC44x_IO_LO
)paren
op_logical_and
(paren
id|addr
op_le
id|PPC44x_IO_HI
)paren
)paren
id|page_4gb
op_assign
id|PPC44x_IO_PAGE
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|addr
op_ge
id|PPC44x_PCI0CFG_LO
)paren
op_logical_and
(paren
id|addr
op_le
id|PPC44x_PCI0CFG_HI
)paren
)paren
id|page_4gb
op_assign
id|PPC44x_PCICFG_PAGE
suffix:semicolon
macro_line|#ifdef CONFIG_440SP
r_else
r_if
c_cond
(paren
(paren
id|addr
op_ge
id|PPC44x_PCI1CFG_LO
)paren
op_logical_and
(paren
id|addr
op_le
id|PPC44x_PCI1CFG_HI
)paren
)paren
id|page_4gb
op_assign
id|PPC44x_PCICFG_PAGE
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|addr
op_ge
id|PPC44x_PCI2CFG_LO
)paren
op_logical_and
(paren
id|addr
op_le
id|PPC44x_PCI2CFG_HI
)paren
)paren
id|page_4gb
op_assign
id|PPC44x_PCICFG_PAGE
suffix:semicolon
macro_line|#endif
r_else
r_if
c_cond
(paren
(paren
id|addr
op_ge
id|PPC44x_PCIMEM_LO
)paren
op_logical_and
(paren
id|addr
op_le
id|PPC44x_PCIMEM_HI
)paren
)paren
id|page_4gb
op_assign
id|PPC44x_PCIMEM_PAGE
suffix:semicolon
r_return
(paren
id|page_4gb
op_or
id|addr
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|fixup_bigphys_addr
id|EXPORT_SYMBOL
c_func
(paren
id|fixup_bigphys_addr
)paren
suffix:semicolon
DECL|function|ibm44x_calibrate_decr
r_void
id|__init
id|ibm44x_calibrate_decr
c_func
(paren
r_int
r_int
id|freq
)paren
(brace
id|tb_ticks_per_jiffy
op_assign
id|freq
op_div
id|HZ
suffix:semicolon
id|tb_to_us
op_assign
id|mulhwu_scale_factor
c_func
(paren
id|freq
comma
l_int|1000000
)paren
suffix:semicolon
multiline_comment|/* Set the time base to zero */
id|mtspr
c_func
(paren
id|SPRN_TBWL
comma
l_int|0
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|SPRN_TBWU
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Clear any pending timer interrupts */
id|mtspr
c_func
(paren
id|SPRN_TSR
comma
id|TSR_ENW
op_or
id|TSR_WIS
op_or
id|TSR_DIS
op_or
id|TSR_FIS
)paren
suffix:semicolon
multiline_comment|/* Enable decrementer interrupt */
id|mtspr
c_func
(paren
id|SPRN_TCR
comma
id|TCR_DIE
)paren
suffix:semicolon
)brace
r_extern
r_void
m_abort
(paren
r_void
)paren
suffix:semicolon
DECL|function|ibm44x_restart
r_static
r_void
id|ibm44x_restart
c_func
(paren
r_char
op_star
id|cmd
)paren
(brace
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
m_abort
(paren
)paren
suffix:semicolon
)brace
DECL|function|ibm44x_power_off
r_static
r_void
id|ibm44x_power_off
c_func
(paren
r_void
)paren
(brace
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
suffix:semicolon
)brace
)brace
DECL|function|ibm44x_halt
r_static
r_void
id|ibm44x_halt
c_func
(paren
r_void
)paren
(brace
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Read the 44x memory controller to get size of system memory.&n; */
DECL|function|ibm44x_find_end_of_memory
r_static
r_int
r_int
id|__init
id|ibm44x_find_end_of_memory
c_func
(paren
r_void
)paren
(brace
id|u32
id|i
comma
id|bank_config
suffix:semicolon
id|u32
id|mem_size
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_switch
c_cond
(paren
id|i
)paren
(brace
r_case
l_int|0
suffix:colon
id|mtdcr
c_func
(paren
id|DCRN_SDRAM0_CFGADDR
comma
id|SDRAM0_B0CR
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|mtdcr
c_func
(paren
id|DCRN_SDRAM0_CFGADDR
comma
id|SDRAM0_B1CR
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|mtdcr
c_func
(paren
id|DCRN_SDRAM0_CFGADDR
comma
id|SDRAM0_B2CR
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|mtdcr
c_func
(paren
id|DCRN_SDRAM0_CFGADDR
comma
id|SDRAM0_B3CR
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|bank_config
op_assign
id|mfdcr
c_func
(paren
id|DCRN_SDRAM0_CFGDATA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bank_config
op_amp
id|SDRAM_CONFIG_BANK_ENABLE
)paren
)paren
r_continue
suffix:semicolon
r_switch
c_cond
(paren
id|SDRAM_CONFIG_BANK_SIZE
c_func
(paren
id|bank_config
)paren
)paren
(brace
r_case
id|SDRAM_CONFIG_SIZE_8M
suffix:colon
id|mem_size
op_add_assign
id|PPC44x_MEM_SIZE_8M
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SDRAM_CONFIG_SIZE_16M
suffix:colon
id|mem_size
op_add_assign
id|PPC44x_MEM_SIZE_16M
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SDRAM_CONFIG_SIZE_32M
suffix:colon
id|mem_size
op_add_assign
id|PPC44x_MEM_SIZE_32M
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SDRAM_CONFIG_SIZE_64M
suffix:colon
id|mem_size
op_add_assign
id|PPC44x_MEM_SIZE_64M
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SDRAM_CONFIG_SIZE_128M
suffix:colon
id|mem_size
op_add_assign
id|PPC44x_MEM_SIZE_128M
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SDRAM_CONFIG_SIZE_256M
suffix:colon
id|mem_size
op_add_assign
id|PPC44x_MEM_SIZE_256M
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SDRAM_CONFIG_SIZE_512M
suffix:colon
id|mem_size
op_add_assign
id|PPC44x_MEM_SIZE_512M
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|mem_size
suffix:semicolon
)brace
DECL|function|ibm44x_platform_init
r_void
id|__init
id|ibm44x_platform_init
c_func
(paren
r_void
)paren
(brace
id|ppc_md.init_IRQ
op_assign
id|ppc4xx_pic_init
suffix:semicolon
id|ppc_md.find_end_of_memory
op_assign
id|ibm44x_find_end_of_memory
suffix:semicolon
id|ppc_md.restart
op_assign
id|ibm44x_restart
suffix:semicolon
id|ppc_md.power_off
op_assign
id|ibm44x_power_off
suffix:semicolon
id|ppc_md.halt
op_assign
id|ibm44x_halt
suffix:semicolon
macro_line|#ifdef CONFIG_SERIAL_TEXT_DEBUG
id|ppc_md.progress
op_assign
id|gen550_progress
suffix:semicolon
macro_line|#endif /* CONFIG_SERIAL_TEXT_DEBUG */
macro_line|#ifdef CONFIG_KGDB
id|ppc_md.kgdb_map_scc
op_assign
id|gen550_kgdb_map_scc
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * The Abatron BDI JTAG debugger does not tolerate others&n;&t; * mucking with the debug registers.&n;&t; */
macro_line|#if !defined(CONFIG_BDI_SWITCH)
multiline_comment|/* Enable internal debug mode */
id|mtspr
c_func
(paren
id|SPRN_DBCR0
comma
(paren
id|DBCR0_IDM
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear any residual debug events */
id|mtspr
c_func
(paren
id|SPRN_DBSR
comma
l_int|0xffffffff
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Called from MachineCheckException */
DECL|function|platform_machine_check
r_void
id|platform_machine_check
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PLB0: BEAR=0x%08x%08x ACR=  0x%08x BESR= 0x%08x&bslash;n&quot;
comma
id|mfdcr
c_func
(paren
id|DCRN_PLB0_BEARH
)paren
comma
id|mfdcr
c_func
(paren
id|DCRN_PLB0_BEARL
)paren
comma
id|mfdcr
c_func
(paren
id|DCRN_PLB0_ACR
)paren
comma
id|mfdcr
c_func
(paren
id|DCRN_PLB0_BESR
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;POB0: BEAR=0x%08x%08x BESR0=0x%08x BESR1=0x%08x&bslash;n&quot;
comma
id|mfdcr
c_func
(paren
id|DCRN_POB0_BEARH
)paren
comma
id|mfdcr
c_func
(paren
id|DCRN_POB0_BEARL
)paren
comma
id|mfdcr
c_func
(paren
id|DCRN_POB0_BESR0
)paren
comma
id|mfdcr
c_func
(paren
id|DCRN_POB0_BESR1
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;OPB0: BEAR=0x%08x%08x BSTAT=0x%08x&bslash;n&quot;
comma
id|mfdcr
c_func
(paren
id|DCRN_OPB0_BEARH
)paren
comma
id|mfdcr
c_func
(paren
id|DCRN_OPB0_BEARL
)paren
comma
id|mfdcr
c_func
(paren
id|DCRN_OPB0_BSTAT
)paren
)paren
suffix:semicolon
)brace
eof
