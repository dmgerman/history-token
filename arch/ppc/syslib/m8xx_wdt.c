multiline_comment|/*&n; * m8xx_wdt.c - MPC8xx watchdog driver&n; *&n; * Author: Florian Schirmer &lt;jolt@tuxbox.org&gt;&n; *&n; * 2002 (c) Florian Schirmer &lt;jolt@tuxbox.org&gt; This file is licensed under&n; * the terms of the GNU General Public License version 2. This program&n; * is licensed &quot;as is&quot; without any warranty of any kind, whether express&n; * or implied.&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/8xx_immap.h&gt;
macro_line|#include &lt;syslib/m8xx_wdt.h&gt;
DECL|variable|wdt_timeout
r_static
r_int
id|wdt_timeout
suffix:semicolon
DECL|function|m8xx_wdt_reset
r_void
id|m8xx_wdt_reset
c_func
(paren
r_void
)paren
(brace
r_volatile
id|immap_t
op_star
id|imap
op_assign
(paren
r_volatile
id|immap_t
op_star
)paren
id|IMAP_ADDR
suffix:semicolon
id|imap-&gt;im_siu_conf.sc_swsr
op_assign
l_int|0x556c
suffix:semicolon
multiline_comment|/* write magic1 */
id|imap-&gt;im_siu_conf.sc_swsr
op_assign
l_int|0xaa39
suffix:semicolon
multiline_comment|/* write magic2 */
)brace
DECL|function|m8xx_wdt_interrupt
r_static
id|irqreturn_t
id|m8xx_wdt_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_volatile
id|immap_t
op_star
id|imap
op_assign
(paren
r_volatile
id|immap_t
op_star
)paren
id|IMAP_ADDR
suffix:semicolon
id|m8xx_wdt_reset
c_func
(paren
)paren
suffix:semicolon
id|imap-&gt;im_sit.sit_piscr
op_or_assign
id|PISCR_PS
suffix:semicolon
multiline_comment|/* clear irq */
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|m8xx_wdt_handler_install
r_void
id|__init
id|m8xx_wdt_handler_install
c_func
(paren
id|bd_t
op_star
id|binfo
)paren
(brace
r_volatile
id|immap_t
op_star
id|imap
op_assign
(paren
r_volatile
id|immap_t
op_star
)paren
id|IMAP_ADDR
suffix:semicolon
id|u32
id|pitc
suffix:semicolon
id|u32
id|sypcr
suffix:semicolon
id|u32
id|pitrtclk
suffix:semicolon
id|sypcr
op_assign
id|imap-&gt;im_siu_conf.sc_sypcr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sypcr
op_amp
l_int|0x04
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;m8xx_wdt: wdt disabled (SYPCR: 0x%08X)&bslash;n&quot;
comma
id|sypcr
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|m8xx_wdt_reset
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;m8xx_wdt: active wdt found (SWTC: 0x%04X, SWP: 0x%01X)&bslash;n&quot;
comma
(paren
id|sypcr
op_rshift
l_int|16
)paren
comma
id|sypcr
op_amp
l_int|0x01
)paren
suffix:semicolon
id|wdt_timeout
op_assign
(paren
id|sypcr
op_rshift
l_int|16
)paren
op_amp
l_int|0xFFFF
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|wdt_timeout
)paren
id|wdt_timeout
op_assign
l_int|0xFFFF
suffix:semicolon
r_if
c_cond
(paren
id|sypcr
op_amp
l_int|0x01
)paren
id|wdt_timeout
op_mul_assign
l_int|2048
suffix:semicolon
multiline_comment|/*&n;&t; * Fire trigger if half of the wdt ticked down &n;&t; */
r_if
c_cond
(paren
id|imap-&gt;im_sit.sit_rtcsc
op_amp
id|RTCSC_38K
)paren
id|pitrtclk
op_assign
l_int|9600
suffix:semicolon
r_else
id|pitrtclk
op_assign
l_int|8192
suffix:semicolon
r_if
c_cond
(paren
(paren
id|wdt_timeout
)paren
OG
(paren
id|UINT_MAX
op_div
id|pitrtclk
)paren
)paren
id|pitc
op_assign
id|wdt_timeout
op_div
id|binfo-&gt;bi_intfreq
op_star
id|pitrtclk
op_div
l_int|2
suffix:semicolon
r_else
id|pitc
op_assign
id|pitrtclk
op_star
id|wdt_timeout
op_div
id|binfo-&gt;bi_intfreq
op_div
l_int|2
suffix:semicolon
id|imap-&gt;im_sit.sit_pitc
op_assign
id|pitc
op_lshift
l_int|16
suffix:semicolon
id|imap-&gt;im_sit.sit_piscr
op_assign
(paren
id|mk_int_int_mask
c_func
(paren
id|PIT_INTERRUPT
)paren
op_lshift
l_int|8
)paren
op_or
id|PISCR_PIE
op_or
id|PISCR_PTE
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|PIT_INTERRUPT
comma
id|m8xx_wdt_interrupt
comma
l_int|0
comma
l_string|&quot;watchdog&quot;
comma
l_int|NULL
)paren
)paren
id|panic
c_func
(paren
l_string|&quot;m8xx_wdt: could not allocate watchdog irq!&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;m8xx_wdt: keep-alive trigger installed (PITC: 0x%04X)&bslash;n&quot;
comma
id|pitc
)paren
suffix:semicolon
id|wdt_timeout
op_div_assign
id|binfo-&gt;bi_intfreq
suffix:semicolon
)brace
DECL|function|m8xx_wdt_get_timeout
r_int
id|m8xx_wdt_get_timeout
c_func
(paren
r_void
)paren
(brace
r_return
id|wdt_timeout
suffix:semicolon
)brace
eof
