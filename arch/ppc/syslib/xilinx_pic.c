multiline_comment|/*&n; * arch/ppc/syslib/xilinx_pic.c&n; *&n; * Interrupt controller driver for Xilinx Virtex-II Pro.&n; *&n; * Author: MontaVista Software, Inc.&n; *         source@mvista.com&n; *&n; * 2002-2004 (c) MontaVista Software, Inc. This file is licensed under&n; * the terms of the GNU General Public License version 2. This program&n; * is licensed &quot;as is&quot; without any warranty of any kind, whether express&n; * or implied.&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/xparameters.h&gt;
macro_line|#include &lt;asm/ibm4xx.h&gt;
multiline_comment|/* No one else should require these constants, so define them locally here. */
DECL|macro|ISR
mdefine_line|#define ISR 0&t;&t;&t;/* Interrupt Status Register */
DECL|macro|IPR
mdefine_line|#define IPR 1&t;&t;&t;/* Interrupt Pending Register */
DECL|macro|IER
mdefine_line|#define IER 2&t;&t;&t;/* Interrupt Enable Register */
DECL|macro|IAR
mdefine_line|#define IAR 3&t;&t;&t;/* Interrupt Acknowledge Register */
DECL|macro|SIE
mdefine_line|#define SIE 4&t;&t;&t;/* Set Interrupt Enable bits */
DECL|macro|CIE
mdefine_line|#define CIE 5&t;&t;&t;/* Clear Interrupt Enable bits */
DECL|macro|IVR
mdefine_line|#define IVR 6&t;&t;&t;/* Interrupt Vector Register */
DECL|macro|MER
mdefine_line|#define MER 7&t;&t;&t;/* Master Enable Register */
macro_line|#if XPAR_XINTC_USE_DCR == 0
DECL|variable|intc
r_static
r_volatile
id|u32
op_star
id|intc
suffix:semicolon
DECL|macro|intc_out_be32
mdefine_line|#define intc_out_be32(addr, mask)     out_be32((addr), (mask))
DECL|macro|intc_in_be32
mdefine_line|#define intc_in_be32(addr)            in_be32((addr))
macro_line|#else
DECL|macro|intc
mdefine_line|#define intc    XPAR_INTC_0_BASEADDR
DECL|macro|intc_out_be32
mdefine_line|#define intc_out_be32(addr, mask)     mtdcr((addr), (mask))
DECL|macro|intc_in_be32
mdefine_line|#define intc_in_be32(addr)            mfdcr((addr))
macro_line|#endif
r_static
r_void
DECL|function|xilinx_intc_enable
id|xilinx_intc_enable
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_int
id|mask
op_assign
(paren
l_int|0x00000001
op_lshift
(paren
id|irq
op_amp
l_int|31
)paren
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;enable: %d&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
id|intc_out_be32
c_func
(paren
id|intc
op_plus
id|SIE
comma
id|mask
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|xilinx_intc_disable
id|xilinx_intc_disable
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_int
id|mask
op_assign
(paren
l_int|0x00000001
op_lshift
(paren
id|irq
op_amp
l_int|31
)paren
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;disable: %d&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
id|intc_out_be32
c_func
(paren
id|intc
op_plus
id|CIE
comma
id|mask
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|xilinx_intc_disable_and_ack
id|xilinx_intc_disable_and_ack
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_int
id|mask
op_assign
(paren
l_int|0x00000001
op_lshift
(paren
id|irq
op_amp
l_int|31
)paren
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;disable_and_ack: %d&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
id|intc_out_be32
c_func
(paren
id|intc
op_plus
id|CIE
comma
id|mask
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|irq_desc
(braket
id|irq
)braket
dot
id|status
op_amp
id|IRQ_LEVEL
)paren
)paren
id|intc_out_be32
c_func
(paren
id|intc
op_plus
id|IAR
comma
id|mask
)paren
suffix:semicolon
multiline_comment|/* ack edge triggered intr */
)brace
r_static
r_void
DECL|function|xilinx_intc_end
id|xilinx_intc_end
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_int
id|mask
op_assign
(paren
l_int|0x00000001
op_lshift
(paren
id|irq
op_amp
l_int|31
)paren
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;end: %d&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|irq_desc
(braket
id|irq
)braket
dot
id|status
op_amp
(paren
id|IRQ_DISABLED
op_or
id|IRQ_INPROGRESS
)paren
)paren
)paren
(brace
id|intc_out_be32
c_func
(paren
id|intc
op_plus
id|SIE
comma
id|mask
)paren
suffix:semicolon
multiline_comment|/* ack level sensitive intr */
r_if
c_cond
(paren
id|irq_desc
(braket
id|irq
)braket
dot
id|status
op_amp
id|IRQ_LEVEL
)paren
id|intc_out_be32
c_func
(paren
id|intc
op_plus
id|IAR
comma
id|mask
)paren
suffix:semicolon
)brace
)brace
DECL|variable|xilinx_intc
r_static
r_struct
id|hw_interrupt_type
id|xilinx_intc
op_assign
(brace
l_string|&quot;Xilinx Interrupt Controller&quot;
comma
l_int|NULL
comma
l_int|NULL
comma
id|xilinx_intc_enable
comma
id|xilinx_intc_disable
comma
id|xilinx_intc_disable_and_ack
comma
id|xilinx_intc_end
comma
l_int|0
)brace
suffix:semicolon
r_int
DECL|function|xilinx_pic_get_irq
id|xilinx_pic_get_irq
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|irq
suffix:semicolon
multiline_comment|/*&n;&t; * NOTE: This function is the one that needs to be improved in&n;&t; * order to handle multiple interrupt controllers.  It currently&n;&t; * is hardcoded to check for interrupts only on the first INTC.&n;&t; */
id|irq
op_assign
id|intc_in_be32
c_func
(paren
id|intc
op_plus
id|IVR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_ne
op_minus
l_int|1
)paren
id|irq
op_assign
id|irq
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;get_irq: %d&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
(paren
id|irq
)paren
suffix:semicolon
)brace
r_void
id|__init
DECL|function|ppc4xx_pic_init
id|ppc4xx_pic_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
macro_line|#if XPAR_XINTC_USE_DCR == 0
id|intc
op_assign
id|ioremap
c_func
(paren
id|XPAR_INTC_0_BASEADDR
comma
l_int|32
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Xilinx INTC #0 at 0x%08lX mapped to 0x%08lX&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|XPAR_INTC_0_BASEADDR
comma
(paren
r_int
r_int
)paren
id|intc
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Xilinx INTC #0 at 0x%08lX (DCR)&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|XPAR_INTC_0_BASEADDR
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * Disable all external interrupts until they are&n;&t; * explicity requested.&n;&t; */
id|intc_out_be32
c_func
(paren
id|intc
op_plus
id|IER
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Acknowledge any pending interrupts just in case. */
id|intc_out_be32
c_func
(paren
id|intc
op_plus
id|IAR
comma
op_complement
(paren
id|u32
)paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Turn on the Master Enable. */
id|intc_out_be32
c_func
(paren
id|intc
op_plus
id|MER
comma
l_int|0x3UL
)paren
suffix:semicolon
id|ppc_md.get_irq
op_assign
id|xilinx_pic_get_irq
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_IRQS
suffix:semicolon
op_increment
id|i
)paren
id|irq_desc
(braket
id|i
)braket
dot
id|handler
op_assign
op_amp
id|xilinx_intc
suffix:semicolon
)brace
eof
