multiline_comment|/* The CPM2 internal interrupt controller.  It is usually&n; * the only interrupt controller.&n; * There are two 32-bit registers (high/low) for up to 64&n; * possible interrupts.&n; *&n; * Now, the fun starts.....Interrupt Numbers DO NOT MAP&n; * in a simple arithmetic fashion to mask or pending registers.&n; * That is, interrupt 4 does not map to bit position 4.&n; * We create two tables, indexed by vector number, to indicate&n; * which register to use and which bit in the register to use.&n; */
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;asm/immap_cpm2.h&gt;
macro_line|#include &lt;asm/mpc8260.h&gt;
macro_line|#include &quot;cpm2_pic.h&quot;
DECL|variable|irq_to_siureg
r_static
id|u_char
id|irq_to_siureg
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|irq_to_siubit
r_static
id|u_char
id|irq_to_siubit
(braket
)braket
op_assign
(brace
l_int|31
comma
l_int|16
comma
l_int|17
comma
l_int|18
comma
l_int|19
comma
l_int|20
comma
l_int|21
comma
l_int|22
comma
l_int|23
comma
l_int|24
comma
l_int|25
comma
l_int|26
comma
l_int|27
comma
l_int|28
comma
l_int|29
comma
l_int|30
comma
l_int|29
comma
l_int|30
comma
l_int|16
comma
l_int|17
comma
l_int|18
comma
l_int|19
comma
l_int|20
comma
l_int|21
comma
l_int|22
comma
l_int|23
comma
l_int|24
comma
l_int|25
comma
l_int|26
comma
l_int|27
comma
l_int|28
comma
l_int|31
comma
l_int|0
comma
l_int|1
comma
l_int|2
comma
l_int|3
comma
l_int|4
comma
l_int|5
comma
l_int|6
comma
l_int|7
comma
l_int|8
comma
l_int|9
comma
l_int|10
comma
l_int|11
comma
l_int|12
comma
l_int|13
comma
l_int|14
comma
l_int|15
comma
l_int|15
comma
l_int|14
comma
l_int|13
comma
l_int|12
comma
l_int|11
comma
l_int|10
comma
l_int|9
comma
l_int|8
comma
l_int|7
comma
l_int|6
comma
l_int|5
comma
l_int|4
comma
l_int|3
comma
l_int|2
comma
l_int|1
comma
l_int|0
)brace
suffix:semicolon
DECL|function|cpm2_mask_irq
r_static
r_void
id|cpm2_mask_irq
c_func
(paren
r_int
r_int
id|irq_nr
)paren
(brace
r_int
id|bit
comma
id|word
suffix:semicolon
r_volatile
id|uint
op_star
id|simr
suffix:semicolon
id|irq_nr
op_sub_assign
id|CPM_IRQ_OFFSET
suffix:semicolon
id|bit
op_assign
id|irq_to_siubit
(braket
id|irq_nr
)braket
suffix:semicolon
id|word
op_assign
id|irq_to_siureg
(braket
id|irq_nr
)braket
suffix:semicolon
id|simr
op_assign
op_amp
(paren
id|cpm2_immr-&gt;im_intctl.ic_simrh
)paren
suffix:semicolon
id|ppc_cached_irq_mask
(braket
id|word
)braket
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
l_int|31
op_minus
id|bit
)paren
)paren
suffix:semicolon
id|simr
(braket
id|word
)braket
op_assign
id|ppc_cached_irq_mask
(braket
id|word
)braket
suffix:semicolon
)brace
DECL|function|cpm2_unmask_irq
r_static
r_void
id|cpm2_unmask_irq
c_func
(paren
r_int
r_int
id|irq_nr
)paren
(brace
r_int
id|bit
comma
id|word
suffix:semicolon
r_volatile
id|uint
op_star
id|simr
suffix:semicolon
id|irq_nr
op_sub_assign
id|CPM_IRQ_OFFSET
suffix:semicolon
id|bit
op_assign
id|irq_to_siubit
(braket
id|irq_nr
)braket
suffix:semicolon
id|word
op_assign
id|irq_to_siureg
(braket
id|irq_nr
)braket
suffix:semicolon
id|simr
op_assign
op_amp
(paren
id|cpm2_immr-&gt;im_intctl.ic_simrh
)paren
suffix:semicolon
id|ppc_cached_irq_mask
(braket
id|word
)braket
op_or_assign
(paren
l_int|1
op_lshift
(paren
l_int|31
op_minus
id|bit
)paren
)paren
suffix:semicolon
id|simr
(braket
id|word
)braket
op_assign
id|ppc_cached_irq_mask
(braket
id|word
)braket
suffix:semicolon
)brace
DECL|function|cpm2_mask_and_ack
r_static
r_void
id|cpm2_mask_and_ack
c_func
(paren
r_int
r_int
id|irq_nr
)paren
(brace
r_int
id|bit
comma
id|word
suffix:semicolon
r_volatile
id|uint
op_star
id|simr
comma
op_star
id|sipnr
suffix:semicolon
id|irq_nr
op_sub_assign
id|CPM_IRQ_OFFSET
suffix:semicolon
id|bit
op_assign
id|irq_to_siubit
(braket
id|irq_nr
)braket
suffix:semicolon
id|word
op_assign
id|irq_to_siureg
(braket
id|irq_nr
)braket
suffix:semicolon
id|simr
op_assign
op_amp
(paren
id|cpm2_immr-&gt;im_intctl.ic_simrh
)paren
suffix:semicolon
id|sipnr
op_assign
op_amp
(paren
id|cpm2_immr-&gt;im_intctl.ic_sipnrh
)paren
suffix:semicolon
id|ppc_cached_irq_mask
(braket
id|word
)braket
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
l_int|31
op_minus
id|bit
)paren
)paren
suffix:semicolon
id|simr
(braket
id|word
)braket
op_assign
id|ppc_cached_irq_mask
(braket
id|word
)braket
suffix:semicolon
id|sipnr
(braket
id|word
)braket
op_assign
l_int|1
op_lshift
(paren
l_int|31
op_minus
id|bit
)paren
suffix:semicolon
)brace
DECL|function|cpm2_end_irq
r_static
r_void
id|cpm2_end_irq
c_func
(paren
r_int
r_int
id|irq_nr
)paren
(brace
r_int
id|bit
comma
id|word
suffix:semicolon
r_volatile
id|uint
op_star
id|simr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|irq_desc
(braket
id|irq_nr
)braket
dot
id|status
op_amp
(paren
id|IRQ_DISABLED
op_or
id|IRQ_INPROGRESS
)paren
)paren
op_logical_and
id|irq_desc
(braket
id|irq_nr
)braket
dot
id|action
)paren
(brace
id|irq_nr
op_sub_assign
id|CPM_IRQ_OFFSET
suffix:semicolon
id|bit
op_assign
id|irq_to_siubit
(braket
id|irq_nr
)braket
suffix:semicolon
id|word
op_assign
id|irq_to_siureg
(braket
id|irq_nr
)braket
suffix:semicolon
id|simr
op_assign
op_amp
(paren
id|cpm2_immr-&gt;im_intctl.ic_simrh
)paren
suffix:semicolon
id|ppc_cached_irq_mask
(braket
id|word
)braket
op_or_assign
(paren
l_int|1
op_lshift
(paren
l_int|31
op_minus
id|bit
)paren
)paren
suffix:semicolon
id|simr
(braket
id|word
)braket
op_assign
id|ppc_cached_irq_mask
(braket
id|word
)braket
suffix:semicolon
)brace
)brace
DECL|variable|cpm2_pic
r_static
r_struct
id|hw_interrupt_type
id|cpm2_pic
op_assign
(brace
dot
r_typename
op_assign
l_string|&quot; CPM2 SIU &quot;
comma
dot
id|enable
op_assign
id|cpm2_unmask_irq
comma
dot
id|disable
op_assign
id|cpm2_mask_irq
comma
dot
id|ack
op_assign
id|cpm2_mask_and_ack
comma
dot
id|end
op_assign
id|cpm2_end_irq
comma
)brace
suffix:semicolon
DECL|function|cpm2_get_irq
r_int
id|cpm2_get_irq
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|irq
suffix:semicolon
r_int
r_int
id|bits
suffix:semicolon
multiline_comment|/* For CPM2, read the SIVEC register and shift the bits down&n;         * to get the irq number.         */
id|bits
op_assign
id|cpm2_immr-&gt;im_intctl.ic_sivec
suffix:semicolon
id|irq
op_assign
id|bits
op_rshift
l_int|26
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_eq
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
id|irq
op_plus
id|CPM_IRQ_OFFSET
suffix:semicolon
)brace
DECL|function|cpm2_init_IRQ
r_void
id|cpm2_init_IRQ
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Clear the CPM IRQ controller, in case it has any bits set&n;&t; * from the bootloader&n;&t; */
multiline_comment|/* Mask out everything */
id|cpm2_immr-&gt;im_intctl.ic_simrh
op_assign
l_int|0x00000000
suffix:semicolon
id|cpm2_immr-&gt;im_intctl.ic_simrl
op_assign
l_int|0x00000000
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Ack everything */
id|cpm2_immr-&gt;im_intctl.ic_sipnrh
op_assign
l_int|0xffffffff
suffix:semicolon
id|cpm2_immr-&gt;im_intctl.ic_sipnrl
op_assign
l_int|0xffffffff
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Dummy read of the vector */
id|i
op_assign
id|cpm2_immr-&gt;im_intctl.ic_sivec
suffix:semicolon
id|rmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Initialize the default interrupt mapping priorities,&n;&t; * in case the boot rom changed something on us.&n;&t; */
id|cpm2_immr-&gt;im_intctl.ic_sicr
op_assign
l_int|0
suffix:semicolon
id|cpm2_immr-&gt;im_intctl.ic_scprrh
op_assign
l_int|0x05309770
suffix:semicolon
id|cpm2_immr-&gt;im_intctl.ic_scprrl
op_assign
l_int|0x05309770
suffix:semicolon
multiline_comment|/* Enable chaining to OpenPIC, and make everything level&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_CPM_INTS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|irq_desc
(braket
id|i
op_plus
id|CPM_IRQ_OFFSET
)braket
dot
id|handler
op_assign
op_amp
id|cpm2_pic
suffix:semicolon
id|irq_desc
(braket
id|i
op_plus
id|CPM_IRQ_OFFSET
)braket
dot
id|status
op_or_assign
id|IRQ_LEVEL
suffix:semicolon
)brace
)brace
eof
