multiline_comment|/*&n; * Support for indirect PCI bridges.&n; *&n; * Copyright (C) 1998 Gabriel Paubert.&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#ifdef CONFIG_PPC_INDIRECT_PCI_BE
DECL|macro|PCI_CFG_OUT
mdefine_line|#define PCI_CFG_OUT out_be32
macro_line|#else
DECL|macro|PCI_CFG_OUT
mdefine_line|#define PCI_CFG_OUT out_le32
macro_line|#endif
r_static
r_int
DECL|function|indirect_read_config
id|indirect_read_config
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|offset
comma
r_int
id|len
comma
id|u32
op_star
id|val
)paren
(brace
r_struct
id|pci_controller
op_star
id|hose
op_assign
id|bus-&gt;sysdata
suffix:semicolon
r_volatile
r_int
r_char
op_star
id|cfg_data
suffix:semicolon
id|u8
id|cfg_type
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ppc_md.pci_exclude_device
)paren
r_if
c_cond
(paren
id|ppc_md
dot
id|pci_exclude_device
c_func
(paren
id|bus-&gt;number
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_if
c_cond
(paren
id|hose-&gt;set_cfg_type
)paren
r_if
c_cond
(paren
id|bus-&gt;number
op_ne
id|hose-&gt;first_busno
)paren
id|cfg_type
op_assign
l_int|1
suffix:semicolon
id|PCI_CFG_OUT
c_func
(paren
id|hose-&gt;cfg_addr
comma
(paren
l_int|0x80000000
op_or
(paren
(paren
id|bus-&gt;number
op_minus
id|hose-&gt;bus_offset
)paren
op_lshift
l_int|16
)paren
op_or
(paren
id|devfn
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|offset
op_amp
l_int|0xfc
)paren
op_or
id|cfg_type
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Note: the caller has already checked that offset is&n;&t; * suitably aligned and that len is 1, 2 or 4.&n;&t; */
id|cfg_data
op_assign
id|hose-&gt;cfg_data
op_plus
(paren
id|offset
op_amp
l_int|3
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|len
)paren
(brace
r_case
l_int|1
suffix:colon
op_star
id|val
op_assign
id|in_8
c_func
(paren
(paren
id|u8
op_star
)paren
id|cfg_data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
op_star
id|val
op_assign
id|in_le16
c_func
(paren
(paren
id|u16
op_star
)paren
id|cfg_data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
op_star
id|val
op_assign
id|in_le32
c_func
(paren
(paren
id|u32
op_star
)paren
id|cfg_data
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
r_static
r_int
DECL|function|indirect_write_config
id|indirect_write_config
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|offset
comma
r_int
id|len
comma
id|u32
id|val
)paren
(brace
r_struct
id|pci_controller
op_star
id|hose
op_assign
id|bus-&gt;sysdata
suffix:semicolon
r_volatile
r_int
r_char
op_star
id|cfg_data
suffix:semicolon
id|u8
id|cfg_type
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ppc_md.pci_exclude_device
)paren
r_if
c_cond
(paren
id|ppc_md
dot
id|pci_exclude_device
c_func
(paren
id|bus-&gt;number
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_if
c_cond
(paren
id|hose-&gt;set_cfg_type
)paren
r_if
c_cond
(paren
id|bus-&gt;number
op_ne
id|hose-&gt;first_busno
)paren
id|cfg_type
op_assign
l_int|1
suffix:semicolon
id|PCI_CFG_OUT
c_func
(paren
id|hose-&gt;cfg_addr
comma
(paren
l_int|0x80000000
op_or
(paren
(paren
id|bus-&gt;number
op_minus
id|hose-&gt;bus_offset
)paren
op_lshift
l_int|16
)paren
op_or
(paren
id|devfn
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|offset
op_amp
l_int|0xfc
)paren
op_or
id|cfg_type
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Note: the caller has already checked that offset is&n;&t; * suitably aligned and that len is 1, 2 or 4.&n;&t; */
id|cfg_data
op_assign
id|hose-&gt;cfg_data
op_plus
(paren
id|offset
op_amp
l_int|3
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|len
)paren
(brace
r_case
l_int|1
suffix:colon
id|out_8
c_func
(paren
(paren
id|u8
op_star
)paren
id|cfg_data
comma
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|out_le16
c_func
(paren
(paren
id|u16
op_star
)paren
id|cfg_data
comma
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|out_le32
c_func
(paren
(paren
id|u32
op_star
)paren
id|cfg_data
comma
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|variable|indirect_pci_ops
r_static
r_struct
id|pci_ops
id|indirect_pci_ops
op_assign
(brace
id|indirect_read_config
comma
id|indirect_write_config
)brace
suffix:semicolon
r_void
id|__init
DECL|function|setup_indirect_pci_nomap
id|setup_indirect_pci_nomap
c_func
(paren
r_struct
id|pci_controller
op_star
id|hose
comma
id|u32
id|cfg_addr
comma
id|u32
id|cfg_data
)paren
(brace
id|hose-&gt;cfg_addr
op_assign
(paren
r_int
r_int
op_star
)paren
id|cfg_addr
suffix:semicolon
id|hose-&gt;cfg_data
op_assign
(paren
r_int
r_char
op_star
)paren
id|cfg_data
suffix:semicolon
id|hose-&gt;ops
op_assign
op_amp
id|indirect_pci_ops
suffix:semicolon
)brace
r_void
id|__init
DECL|function|setup_indirect_pci
id|setup_indirect_pci
c_func
(paren
r_struct
id|pci_controller
op_star
id|hose
comma
id|u32
id|cfg_addr
comma
id|u32
id|cfg_data
)paren
(brace
r_int
r_int
id|base
op_assign
id|cfg_addr
op_amp
id|PAGE_MASK
suffix:semicolon
r_char
op_star
id|mbase
suffix:semicolon
id|mbase
op_assign
id|ioremap
c_func
(paren
id|base
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|cfg_addr
op_assign
(paren
id|u32
)paren
(paren
id|mbase
op_plus
(paren
id|cfg_addr
op_amp
op_complement
id|PAGE_MASK
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cfg_data
op_amp
id|PAGE_MASK
)paren
op_ne
id|base
)paren
id|mbase
op_assign
id|ioremap
c_func
(paren
id|cfg_data
op_amp
id|PAGE_MASK
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|cfg_data
op_assign
(paren
id|u32
)paren
(paren
id|mbase
op_plus
(paren
id|cfg_data
op_amp
op_complement
id|PAGE_MASK
)paren
)paren
suffix:semicolon
id|setup_indirect_pci_nomap
c_func
(paren
id|hose
comma
id|cfg_addr
comma
id|cfg_data
)paren
suffix:semicolon
)brace
eof
