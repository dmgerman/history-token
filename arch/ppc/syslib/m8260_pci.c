multiline_comment|/*&n; * (C) Copyright 2003&n; * Wolfgang Denk, DENX Software Engineering, wd@denx.de.&n; *&n; * (C) Copyright 2004 Red Hat, Inc.&n; *&n; * See file CREDITS for list of people who contributed to this&n; * project.&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License as&n; * published by the Free Software Foundation; either version 2 of&n; * the License, or (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.&t; See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston,&n; * MA 02111-1307 USA&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#include &lt;asm/immap_cpm2.h&gt;
macro_line|#include &lt;asm/mpc8260.h&gt;
macro_line|#include &quot;m8260_pci.h&quot;
multiline_comment|/* PCI bus configuration registers.&n; */
DECL|function|m8260_setup_pci
r_static
r_void
id|__init
id|m8260_setup_pci
c_func
(paren
r_struct
id|pci_controller
op_star
id|hose
)paren
(brace
r_volatile
id|cpm2_map_t
op_star
id|immap
op_assign
id|cpm2_immr
suffix:semicolon
r_int
r_int
id|pocmr
suffix:semicolon
id|u16
id|tempShort
suffix:semicolon
macro_line|#ifndef CONFIG_ATC &t;/* already done in U-Boot */
multiline_comment|/* &n;&t; * Setting required to enable IRQ1-IRQ7 (SIUMCR [DPPC]), &n;&t; * and local bus for PCI (SIUMCR [LBPC]).&n;&t; */
id|immap-&gt;im_siu_conf.siu_82xx.sc_siumcr
op_assign
l_int|0x00640000
suffix:semicolon
macro_line|#endif
multiline_comment|/* Make PCI lowest priority */
multiline_comment|/* Each 4 bits is a device bus request  and the MS 4bits &n;&t;   is highest priority */
multiline_comment|/* Bus               4bit value &n;&t;   ---               ----------&n;&t;   CPM high          0b0000&n;&t;   CPM middle        0b0001&n;&t;   CPM low           0b0010&n;&t;   PCI reguest       0b0011&n;&t;   Reserved          0b0100&n;&t;   Reserved          0b0101&n;&t;   Internal Core     0b0110&n;&t;   External Master 1 0b0111&n;&t;   External Master 2 0b1000&n;&t;   External Master 3 0b1001&n;&t;   The rest are reserved */
id|immap-&gt;im_siu_conf.siu_82xx.sc_ppc_alrh
op_assign
l_int|0x61207893
suffix:semicolon
multiline_comment|/* Park bus on core while modifying PCI Bus accesses */
id|immap-&gt;im_siu_conf.siu_82xx.sc_ppc_acr
op_assign
l_int|0x6
suffix:semicolon
multiline_comment|/* &n;&t; * Set up master window that allows the CPU to access PCI space. This &n;&t; * window is set up using the first SIU PCIBR registers.&n;&t; */
id|immap-&gt;im_memctl.memc_pcimsk0
op_assign
id|MPC826x_PCI_MASK
suffix:semicolon
id|immap-&gt;im_memctl.memc_pcibr0
op_assign
id|MPC826x_PCI_BASE
op_or
id|PCIBR_ENABLE
suffix:semicolon
multiline_comment|/* Disable machine check on no response or target abort */
id|immap-&gt;im_pci.pci_emr
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0x1fe7
)paren
suffix:semicolon
multiline_comment|/* Release PCI RST (by default the PCI RST signal is held low)  */
id|immap-&gt;im_pci.pci_gcr
op_assign
id|cpu_to_le32
c_func
(paren
id|PCIGCR_PCI_BUS_EN
)paren
suffix:semicolon
multiline_comment|/* give it some time */
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Set up master window that allows the CPU to access PCI Memory (prefetch) &n;&t; * space. This window is set up using the first set of Outbound ATU registers.&n;&t; */
id|immap-&gt;im_pci.pci_potar0
op_assign
id|cpu_to_le32
c_func
(paren
id|MPC826x_PCI_LOWER_MEM
op_rshift
l_int|12
)paren
suffix:semicolon
id|immap-&gt;im_pci.pci_pobar0
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|MPC826x_PCI_LOWER_MEM
op_minus
id|MPC826x_PCI_MEM_OFFSET
)paren
op_rshift
l_int|12
)paren
suffix:semicolon
id|pocmr
op_assign
(paren
(paren
id|MPC826x_PCI_UPPER_MEM
op_minus
id|MPC826x_PCI_LOWER_MEM
)paren
op_rshift
l_int|12
)paren
op_xor
l_int|0xfffff
suffix:semicolon
id|immap-&gt;im_pci.pci_pocmr0
op_assign
id|cpu_to_le32
c_func
(paren
id|pocmr
op_or
id|POCMR_ENABLE
op_or
id|POCMR_PREFETCH_EN
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Set up master window that allows the CPU to access PCI Memory (non-prefetch) &n;&t; * space. This window is set up using the second set of Outbound ATU registers.&n;&t; */
id|immap-&gt;im_pci.pci_potar1
op_assign
id|cpu_to_le32
c_func
(paren
id|MPC826x_PCI_LOWER_MMIO
op_rshift
l_int|12
)paren
suffix:semicolon
id|immap-&gt;im_pci.pci_pobar1
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|MPC826x_PCI_LOWER_MMIO
op_minus
id|MPC826x_PCI_MMIO_OFFSET
)paren
op_rshift
l_int|12
)paren
suffix:semicolon
id|pocmr
op_assign
(paren
(paren
id|MPC826x_PCI_UPPER_MMIO
op_minus
id|MPC826x_PCI_LOWER_MMIO
)paren
op_rshift
l_int|12
)paren
op_xor
l_int|0xfffff
suffix:semicolon
id|immap-&gt;im_pci.pci_pocmr1
op_assign
id|cpu_to_le32
c_func
(paren
id|pocmr
op_or
id|POCMR_ENABLE
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Set up master window that allows the CPU to access PCI IO space. This window&n;&t; * is set up using the third set of Outbound ATU registers.&n;&t; */
id|immap-&gt;im_pci.pci_potar2
op_assign
id|cpu_to_le32
c_func
(paren
id|MPC826x_PCI_IO_BASE
op_rshift
l_int|12
)paren
suffix:semicolon
id|immap-&gt;im_pci.pci_pobar2
op_assign
id|cpu_to_le32
c_func
(paren
id|MPC826x_PCI_LOWER_IO
op_rshift
l_int|12
)paren
suffix:semicolon
id|pocmr
op_assign
(paren
(paren
id|MPC826x_PCI_UPPER_IO
op_minus
id|MPC826x_PCI_LOWER_IO
)paren
op_rshift
l_int|12
)paren
op_xor
l_int|0xfffff
suffix:semicolon
id|immap-&gt;im_pci.pci_pocmr2
op_assign
id|cpu_to_le32
c_func
(paren
id|pocmr
op_or
id|POCMR_ENABLE
op_or
id|POCMR_PCI_IO
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Set up slave window that allows PCI masters to access MPC826x local memory. &n;&t; * This window is set up using the first set of Inbound ATU registers&n;&t; */
id|immap-&gt;im_pci.pci_pitar0
op_assign
id|cpu_to_le32
c_func
(paren
id|MPC826x_PCI_SLAVE_MEM_LOCAL
op_rshift
l_int|12
)paren
suffix:semicolon
id|immap-&gt;im_pci.pci_pibar0
op_assign
id|cpu_to_le32
c_func
(paren
id|MPC826x_PCI_SLAVE_MEM_BUS
op_rshift
l_int|12
)paren
suffix:semicolon
id|pocmr
op_assign
(paren
(paren
id|MPC826x_PCI_SLAVE_MEM_SIZE
op_minus
l_int|1
)paren
op_rshift
l_int|12
)paren
op_xor
l_int|0xfffff
suffix:semicolon
id|immap-&gt;im_pci.pci_picmr0
op_assign
id|cpu_to_le32
c_func
(paren
id|pocmr
op_or
id|PICMR_ENABLE
op_or
id|PICMR_PREFETCH_EN
)paren
suffix:semicolon
multiline_comment|/* See above for description - puts PCI request as highest priority */
id|immap-&gt;im_siu_conf.siu_82xx.sc_ppc_alrh
op_assign
l_int|0x03124567
suffix:semicolon
multiline_comment|/* Park the bus on the PCI */
id|immap-&gt;im_siu_conf.siu_82xx.sc_ppc_acr
op_assign
id|PPC_ACR_BUS_PARK_PCI
suffix:semicolon
multiline_comment|/* Host mode - specify the bridge as a host-PCI bridge */
id|early_write_config_word
c_func
(paren
id|hose
comma
l_int|0
comma
l_int|0
comma
id|PCI_CLASS_DEVICE
comma
id|PCI_CLASS_BRIDGE_HOST
)paren
suffix:semicolon
multiline_comment|/* Enable the host bridge to be a master on the PCI bus, and to act as a PCI memory target */
id|early_read_config_word
c_func
(paren
id|hose
comma
l_int|0
comma
l_int|0
comma
id|PCI_COMMAND
comma
op_amp
id|tempShort
)paren
suffix:semicolon
id|early_write_config_word
c_func
(paren
id|hose
comma
l_int|0
comma
l_int|0
comma
id|PCI_COMMAND
comma
id|tempShort
op_or
id|PCI_COMMAND_MASTER
op_or
id|PCI_COMMAND_MEMORY
)paren
suffix:semicolon
)brace
DECL|function|m8260_find_bridges
r_void
id|__init
id|m8260_find_bridges
c_func
(paren
r_void
)paren
(brace
r_extern
r_int
id|pci_assign_all_busses
suffix:semicolon
r_struct
id|pci_controller
op_star
id|hose
suffix:semicolon
id|pci_assign_all_busses
op_assign
l_int|1
suffix:semicolon
id|hose
op_assign
id|pcibios_alloc_controller
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hose
)paren
r_return
suffix:semicolon
id|ppc_md.pci_swizzle
op_assign
id|common_swizzle
suffix:semicolon
id|hose-&gt;first_busno
op_assign
l_int|0
suffix:semicolon
id|hose-&gt;bus_offset
op_assign
l_int|0
suffix:semicolon
id|hose-&gt;last_busno
op_assign
l_int|0xff
suffix:semicolon
id|setup_indirect_pci
c_func
(paren
id|hose
comma
(paren
r_int
r_int
)paren
op_amp
id|cpm2_immr-&gt;im_pci.pci_cfg_addr
comma
(paren
r_int
r_int
)paren
op_amp
id|cpm2_immr-&gt;im_pci.pci_cfg_data
)paren
suffix:semicolon
id|m8260_setup_pci
c_func
(paren
id|hose
)paren
suffix:semicolon
id|hose-&gt;pci_mem_offset
op_assign
id|MPC826x_PCI_MEM_OFFSET
suffix:semicolon
id|isa_io_base
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|MPC826x_PCI_IO_BASE
comma
id|MPC826x_PCI_IO_SIZE
)paren
suffix:semicolon
id|hose-&gt;io_base_virt
op_assign
(paren
r_void
op_star
)paren
id|isa_io_base
suffix:semicolon
multiline_comment|/* setup resources */
id|pci_init_resource
c_func
(paren
op_amp
id|hose-&gt;mem_resources
(braket
l_int|0
)braket
comma
id|MPC826x_PCI_LOWER_MEM
comma
id|MPC826x_PCI_UPPER_MEM
comma
id|IORESOURCE_MEM
op_or
id|IORESOURCE_PREFETCH
comma
l_string|&quot;PCI prefetchable memory&quot;
)paren
suffix:semicolon
id|pci_init_resource
c_func
(paren
op_amp
id|hose-&gt;mem_resources
(braket
l_int|1
)braket
comma
id|MPC826x_PCI_LOWER_MMIO
comma
id|MPC826x_PCI_UPPER_MMIO
comma
id|IORESOURCE_MEM
comma
l_string|&quot;PCI memory&quot;
)paren
suffix:semicolon
id|pci_init_resource
c_func
(paren
op_amp
id|hose-&gt;io_resource
comma
id|MPC826x_PCI_LOWER_IO
comma
id|MPC826x_PCI_UPPER_IO
comma
id|IORESOURCE_IO
comma
l_string|&quot;PCI I/O&quot;
)paren
suffix:semicolon
)brace
eof
