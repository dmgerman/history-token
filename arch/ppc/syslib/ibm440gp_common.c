multiline_comment|/*&n; * arch/ppc/syslib/ibm440gp_common.c&n; *&n; * PPC440GP system library&n; *&n; * Matt Porter &lt;mporter@mvista.com&gt;&n; * Copyright 2002-2003 MontaVista Software Inc.&n; *&n; * Eugene Surovegin &lt;eugene.surovegin@zultys.com&gt; or &lt;ebs@ebshome.net&gt;&n; * Copyright (c) 2003 Zultys Technologies&n; *&n; * This program is free software; you can redistribute  it and/or modify it&n; * under  the terms of  the GNU General  Public License as published by the&n; * Free Software Foundation;  either version 2 of the  License, or (at your&n; * option) any later version.&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;asm/reg.h&gt;
macro_line|#include &lt;asm/ibm44x.h&gt;
macro_line|#include &lt;asm/mmu.h&gt;
multiline_comment|/*&n; * Calculate 440GP clocks&n; */
DECL|function|ibm440gp_get_clocks
r_void
id|__init
id|ibm440gp_get_clocks
c_func
(paren
r_struct
id|ibm44x_clocks
op_star
id|p
comma
r_int
r_int
id|sys_clk
comma
r_int
r_int
id|ser_clk
)paren
(brace
id|u32
id|cpc0_sys0
op_assign
id|mfdcr
c_func
(paren
id|DCRN_CPC0_SYS0
)paren
suffix:semicolon
id|u32
id|cpc0_cr0
op_assign
id|mfdcr
c_func
(paren
id|DCRN_CPC0_CR0
)paren
suffix:semicolon
id|u32
id|opdv
comma
id|epdv
suffix:semicolon
r_if
c_cond
(paren
id|cpc0_sys0
op_amp
l_int|0x2
)paren
(brace
multiline_comment|/* Bypass system PLL */
id|p-&gt;cpu
op_assign
id|p-&gt;plb
op_assign
id|sys_clk
suffix:semicolon
)brace
r_else
(brace
id|u32
id|fbdv
comma
id|fwdva
comma
id|fwdvb
comma
id|m
comma
id|vco
suffix:semicolon
id|fbdv
op_assign
(paren
id|cpc0_sys0
op_rshift
l_int|18
)paren
op_amp
l_int|0x0f
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fbdv
)paren
id|fbdv
op_assign
l_int|16
suffix:semicolon
id|fwdva
op_assign
l_int|8
op_minus
(paren
(paren
id|cpc0_sys0
op_rshift
l_int|15
)paren
op_amp
l_int|0x7
)paren
suffix:semicolon
id|fwdvb
op_assign
l_int|8
op_minus
(paren
(paren
id|cpc0_sys0
op_rshift
l_int|12
)paren
op_amp
l_int|0x7
)paren
suffix:semicolon
multiline_comment|/* Feedback path */
r_if
c_cond
(paren
id|cpc0_sys0
op_amp
l_int|0x00000080
)paren
(brace
multiline_comment|/* PerClk */
id|m
op_assign
id|fwdvb
op_star
id|opdv
op_star
id|epdv
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* CPU clock */
id|m
op_assign
id|fbdv
op_star
id|fwdva
suffix:semicolon
)brace
id|vco
op_assign
id|sys_clk
op_star
id|m
suffix:semicolon
id|p-&gt;cpu
op_assign
id|vco
op_div
id|fwdva
suffix:semicolon
id|p-&gt;plb
op_assign
id|vco
op_div
id|fwdvb
suffix:semicolon
)brace
id|opdv
op_assign
(paren
(paren
id|cpc0_sys0
op_rshift
l_int|10
)paren
op_amp
l_int|0x3
)paren
op_plus
l_int|1
suffix:semicolon
id|epdv
op_assign
(paren
(paren
id|cpc0_sys0
op_rshift
l_int|8
)paren
op_amp
l_int|0x3
)paren
op_plus
l_int|1
suffix:semicolon
id|p-&gt;opb
op_assign
id|p-&gt;plb
op_div
id|opdv
suffix:semicolon
id|p-&gt;ebc
op_assign
id|p-&gt;opb
op_div
id|epdv
suffix:semicolon
r_if
c_cond
(paren
id|cpc0_cr0
op_amp
l_int|0x00400000
)paren
(brace
multiline_comment|/* External UART clock */
id|p-&gt;uart0
op_assign
id|p-&gt;uart1
op_assign
id|ser_clk
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Internal UART clock */
id|u32
id|uart_div
op_assign
(paren
(paren
id|cpc0_cr0
op_rshift
l_int|16
)paren
op_amp
l_int|0x1f
)paren
op_plus
l_int|1
suffix:semicolon
id|p-&gt;uart0
op_assign
id|p-&gt;uart1
op_assign
id|p-&gt;plb
op_div
id|uart_div
suffix:semicolon
)brace
)brace
eof
