multiline_comment|/*&n; * Modifications by Kumar Gala (kumar.gala@freescale.com) to support&n; * E500 Book E processors.&n; *&n; * Copyright 2004 Freescale Semiconductor, Inc&n; *&n; * This file contains the routines for initializing the MMU&n; * on the 4xx series of chips.&n; *  -- paulus&n; *&n; *  Derived from arch/ppc/mm/init.c:&n; *    Copyright (C) 1995-1996 Gary Thomas (gdt@linuxppc.org)&n; *&n; *  Modifications by Paul Mackerras (PowerMac) (paulus@cs.anu.edu.au)&n; *  and Cort Dougan (PReP) (cort@cs.nmt.edu)&n; *    Copyright (C) 1996 Paul Mackerras&n; *  Amiga/APUS changes by Jesper Skov (jskov@cygnus.co.uk).&n; *&n; *  Derived from &quot;arch/i386/mm/init.c&quot;&n; *    Copyright (C) 1991, 1992, 1993, 1994  Linus Torvalds&n; *&n; *  This program is free software; you can redistribute it and/or&n; *  modify it under the terms of the GNU General Public License&n; *  as published by the Free Software Foundation; either version&n; *  2 of the License, or (at your option) any later version.&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/mman.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/swap.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;linux/highmem.h&gt;
macro_line|#include &lt;asm/pgalloc.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/mmu_context.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/mmu.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/smp.h&gt;
macro_line|#include &lt;asm/bootx.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/setup.h&gt;
r_extern
r_void
id|loadcam_entry
c_func
(paren
r_int
r_int
id|index
)paren
suffix:semicolon
DECL|variable|tlbcam_index
r_int
r_int
id|tlbcam_index
suffix:semicolon
DECL|variable|num_tlbcam_entries
r_int
r_int
id|num_tlbcam_entries
suffix:semicolon
DECL|variable|__cam0
DECL|variable|__cam1
DECL|variable|__cam2
r_static
r_int
r_int
id|__cam0
comma
id|__cam1
comma
id|__cam2
suffix:semicolon
r_extern
r_int
r_int
id|total_lowmem
suffix:semicolon
r_extern
r_int
r_int
id|__max_low_memory
suffix:semicolon
DECL|macro|MAX_LOW_MEM
mdefine_line|#define MAX_LOW_MEM&t;CONFIG_LOWMEM_SIZE
DECL|struct|tlbcam
r_struct
id|tlbcam
(brace
DECL|member|MAS0
id|u32
id|MAS0
suffix:semicolon
DECL|member|MAS1
id|u32
id|MAS1
suffix:semicolon
DECL|member|MAS2
id|u32
id|MAS2
suffix:semicolon
DECL|member|MAS3
id|u32
id|MAS3
suffix:semicolon
DECL|member|MAS7
id|u32
id|MAS7
suffix:semicolon
DECL|variable|TLBCAM
)brace
id|TLBCAM
(braket
id|NUM_TLBCAMS
)braket
suffix:semicolon
DECL|struct|tlbcamrange
r_struct
id|tlbcamrange
(brace
DECL|member|start
r_int
r_int
id|start
suffix:semicolon
DECL|member|limit
r_int
r_int
id|limit
suffix:semicolon
DECL|member|phys
id|phys_addr_t
id|phys
suffix:semicolon
DECL|variable|tlbcam_addrs
)brace
id|tlbcam_addrs
(braket
id|NUM_TLBCAMS
)braket
suffix:semicolon
r_extern
r_int
r_int
id|tlbcam_index
suffix:semicolon
multiline_comment|/*&n; * Return PA for this VA if it is mapped by a CAM, or 0&n; */
DECL|function|v_mapped_by_tlbcam
r_int
r_int
id|v_mapped_by_tlbcam
c_func
(paren
r_int
r_int
id|va
)paren
(brace
r_int
id|b
suffix:semicolon
r_for
c_loop
(paren
id|b
op_assign
l_int|0
suffix:semicolon
id|b
OL
id|tlbcam_index
suffix:semicolon
op_increment
id|b
)paren
r_if
c_cond
(paren
id|va
op_ge
id|tlbcam_addrs
(braket
id|b
)braket
dot
id|start
op_logical_and
id|va
OL
id|tlbcam_addrs
(braket
id|b
)braket
dot
id|limit
)paren
r_return
id|tlbcam_addrs
(braket
id|b
)braket
dot
id|phys
op_plus
(paren
id|va
op_minus
id|tlbcam_addrs
(braket
id|b
)braket
dot
id|start
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Return VA for a given PA or 0 if not mapped&n; */
DECL|function|p_mapped_by_tlbcam
r_int
r_int
id|p_mapped_by_tlbcam
c_func
(paren
r_int
r_int
id|pa
)paren
(brace
r_int
id|b
suffix:semicolon
r_for
c_loop
(paren
id|b
op_assign
l_int|0
suffix:semicolon
id|b
OL
id|tlbcam_index
suffix:semicolon
op_increment
id|b
)paren
r_if
c_cond
(paren
id|pa
op_ge
id|tlbcam_addrs
(braket
id|b
)braket
dot
id|phys
op_logical_and
id|pa
OL
(paren
id|tlbcam_addrs
(braket
id|b
)braket
dot
id|limit
op_minus
id|tlbcam_addrs
(braket
id|b
)braket
dot
id|start
)paren
op_plus
id|tlbcam_addrs
(braket
id|b
)braket
dot
id|phys
)paren
r_return
id|tlbcam_addrs
(braket
id|b
)braket
dot
id|start
op_plus
(paren
id|pa
op_minus
id|tlbcam_addrs
(braket
id|b
)braket
dot
id|phys
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Set up one of the I/D BAT (block address translation) register pairs.&n; * The parameters are not checked; in particular size must be a power&n; * of 4 between 4k and 256M.&n; */
DECL|function|settlbcam
r_void
id|settlbcam
c_func
(paren
r_int
id|index
comma
r_int
r_int
id|virt
comma
id|phys_addr_t
id|phys
comma
r_int
r_int
id|size
comma
r_int
id|flags
comma
r_int
r_int
id|pid
)paren
(brace
r_int
r_int
id|tsize
comma
id|lz
suffix:semicolon
id|asm
(paren
l_string|&quot;cntlzw %0,%1&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|lz
)paren
suffix:colon
l_string|&quot;r&quot;
(paren
id|size
)paren
)paren
suffix:semicolon
id|tsize
op_assign
(paren
l_int|21
op_minus
id|lz
)paren
op_div
l_int|2
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
r_if
c_cond
(paren
(paren
id|flags
op_amp
id|_PAGE_NO_CACHE
)paren
op_eq
l_int|0
)paren
id|flags
op_or_assign
id|_PAGE_COHERENT
suffix:semicolon
macro_line|#endif
id|TLBCAM
(braket
id|index
)braket
dot
id|MAS0
op_assign
id|MAS0_TLBSEL
op_or
(paren
id|index
op_lshift
l_int|16
)paren
suffix:semicolon
id|TLBCAM
(braket
id|index
)braket
dot
id|MAS1
op_assign
id|MAS1_VALID
op_or
id|MAS1_IPROT
op_or
id|MAS1_TSIZE
c_func
(paren
id|tsize
)paren
op_or
(paren
(paren
id|pid
op_lshift
l_int|16
)paren
op_amp
id|MAS1_TID
)paren
suffix:semicolon
id|TLBCAM
(braket
id|index
)braket
dot
id|MAS2
op_assign
id|virt
op_amp
id|PAGE_MASK
suffix:semicolon
id|TLBCAM
(braket
id|index
)braket
dot
id|MAS2
op_or_assign
(paren
id|flags
op_amp
id|_PAGE_WRITETHRU
)paren
ques
c_cond
id|MAS2_W
suffix:colon
l_int|0
suffix:semicolon
id|TLBCAM
(braket
id|index
)braket
dot
id|MAS2
op_or_assign
(paren
id|flags
op_amp
id|_PAGE_NO_CACHE
)paren
ques
c_cond
id|MAS2_I
suffix:colon
l_int|0
suffix:semicolon
id|TLBCAM
(braket
id|index
)braket
dot
id|MAS2
op_or_assign
(paren
id|flags
op_amp
id|_PAGE_COHERENT
)paren
ques
c_cond
id|MAS2_M
suffix:colon
l_int|0
suffix:semicolon
id|TLBCAM
(braket
id|index
)braket
dot
id|MAS2
op_or_assign
(paren
id|flags
op_amp
id|_PAGE_GUARDED
)paren
ques
c_cond
id|MAS2_G
suffix:colon
l_int|0
suffix:semicolon
id|TLBCAM
(braket
id|index
)braket
dot
id|MAS2
op_or_assign
(paren
id|flags
op_amp
id|_PAGE_ENDIAN
)paren
ques
c_cond
id|MAS2_E
suffix:colon
l_int|0
suffix:semicolon
id|TLBCAM
(braket
id|index
)braket
dot
id|MAS3
op_assign
(paren
id|phys
op_amp
id|PAGE_MASK
)paren
op_or
id|MAS3_SX
op_or
id|MAS3_SR
suffix:semicolon
id|TLBCAM
(braket
id|index
)braket
dot
id|MAS3
op_or_assign
(paren
(paren
id|flags
op_amp
id|_PAGE_RW
)paren
ques
c_cond
id|MAS3_SW
suffix:colon
l_int|0
)paren
suffix:semicolon
macro_line|#ifndef CONFIG_KGDB /* want user access for breakpoints */
r_if
c_cond
(paren
id|flags
op_amp
id|_PAGE_USER
)paren
(brace
id|TLBCAM
(braket
id|index
)braket
dot
id|MAS3
op_or_assign
id|MAS3_UX
op_or
id|MAS3_UR
suffix:semicolon
id|TLBCAM
(braket
id|index
)braket
dot
id|MAS3
op_or_assign
(paren
(paren
id|flags
op_amp
id|_PAGE_RW
)paren
ques
c_cond
id|MAS3_UW
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#else
id|TLBCAM
(braket
id|index
)braket
dot
id|MAS3
op_or_assign
id|MAS3_UX
op_or
id|MAS3_UR
suffix:semicolon
id|TLBCAM
(braket
id|index
)braket
dot
id|MAS3
op_or_assign
(paren
(paren
id|flags
op_amp
id|_PAGE_RW
)paren
ques
c_cond
id|MAS3_UW
suffix:colon
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|tlbcam_addrs
(braket
id|index
)braket
dot
id|start
op_assign
id|virt
suffix:semicolon
id|tlbcam_addrs
(braket
id|index
)braket
dot
id|limit
op_assign
id|virt
op_plus
id|size
op_minus
l_int|1
suffix:semicolon
id|tlbcam_addrs
(braket
id|index
)braket
dot
id|phys
op_assign
id|phys
suffix:semicolon
id|loadcam_entry
c_func
(paren
id|index
)paren
suffix:semicolon
)brace
DECL|function|invalidate_tlbcam_entry
r_void
id|invalidate_tlbcam_entry
c_func
(paren
r_int
id|index
)paren
(brace
id|TLBCAM
(braket
id|index
)braket
dot
id|MAS0
op_assign
id|MAS0_TLBSEL
op_or
(paren
id|index
op_lshift
l_int|16
)paren
suffix:semicolon
id|TLBCAM
(braket
id|index
)braket
dot
id|MAS1
op_assign
op_complement
id|MAS1_VALID
suffix:semicolon
id|loadcam_entry
c_func
(paren
id|index
)paren
suffix:semicolon
)brace
DECL|function|cam_mapin_ram
r_void
id|__init
id|cam_mapin_ram
c_func
(paren
r_int
r_int
id|cam0
comma
r_int
r_int
id|cam1
comma
r_int
r_int
id|cam2
)paren
(brace
id|settlbcam
c_func
(paren
l_int|0
comma
id|KERNELBASE
comma
id|PPC_MEMSTART
comma
id|cam0
comma
id|_PAGE_KERNEL
comma
l_int|0
)paren
suffix:semicolon
id|tlbcam_index
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|cam1
)paren
(brace
id|tlbcam_index
op_increment
suffix:semicolon
id|settlbcam
c_func
(paren
l_int|1
comma
id|KERNELBASE
op_plus
id|cam0
comma
id|PPC_MEMSTART
op_plus
id|cam0
comma
id|cam1
comma
id|_PAGE_KERNEL
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cam2
)paren
(brace
id|tlbcam_index
op_increment
suffix:semicolon
id|settlbcam
c_func
(paren
l_int|2
comma
id|KERNELBASE
op_plus
id|cam0
op_plus
id|cam1
comma
id|PPC_MEMSTART
op_plus
id|cam0
op_plus
id|cam1
comma
id|cam2
comma
id|_PAGE_KERNEL
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * MMU_init_hw does the chip-specific initialization of the MMU hardware.&n; */
DECL|function|MMU_init_hw
r_void
id|__init
id|MMU_init_hw
c_func
(paren
r_void
)paren
(brace
id|flush_instruction_cache
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|mmu_mapin_ram
r_int
r_int
id|__init
id|mmu_mapin_ram
c_func
(paren
r_void
)paren
(brace
id|cam_mapin_ram
c_func
(paren
id|__cam0
comma
id|__cam1
comma
id|__cam2
)paren
suffix:semicolon
r_return
id|__cam0
op_plus
id|__cam1
op_plus
id|__cam2
suffix:semicolon
)brace
r_void
id|__init
DECL|function|adjust_total_lowmem
id|adjust_total_lowmem
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|max_low_mem
op_assign
id|MAX_LOW_MEM
suffix:semicolon
r_int
r_int
id|cam_max
op_assign
l_int|0x10000000
suffix:semicolon
r_int
r_int
id|ram
suffix:semicolon
multiline_comment|/* adjust CAM size to max_low_mem */
r_if
c_cond
(paren
id|max_low_mem
OL
id|cam_max
)paren
id|cam_max
op_assign
id|max_low_mem
suffix:semicolon
multiline_comment|/* adjust lowmem size to max_low_mem */
r_if
c_cond
(paren
id|max_low_mem
OL
id|total_lowmem
)paren
id|ram
op_assign
id|max_low_mem
suffix:semicolon
r_else
id|ram
op_assign
id|total_lowmem
suffix:semicolon
multiline_comment|/* Calculate CAM values */
id|__cam0
op_assign
l_int|1UL
op_lshift
l_int|2
op_star
(paren
id|__ilog2
c_func
(paren
id|ram
)paren
op_div
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|__cam0
OG
id|cam_max
)paren
id|__cam0
op_assign
id|cam_max
suffix:semicolon
id|ram
op_sub_assign
id|__cam0
suffix:semicolon
r_if
c_cond
(paren
id|ram
)paren
(brace
id|__cam1
op_assign
l_int|1UL
op_lshift
l_int|2
op_star
(paren
id|__ilog2
c_func
(paren
id|ram
)paren
op_div
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|__cam1
OG
id|cam_max
)paren
id|__cam1
op_assign
id|cam_max
suffix:semicolon
id|ram
op_sub_assign
id|__cam1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ram
)paren
(brace
id|__cam2
op_assign
l_int|1UL
op_lshift
l_int|2
op_star
(paren
id|__ilog2
c_func
(paren
id|ram
)paren
op_div
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|__cam2
OG
id|cam_max
)paren
id|__cam2
op_assign
id|cam_max
suffix:semicolon
id|ram
op_sub_assign
id|__cam2
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Memory CAM mapping: CAM0=%ldMb, CAM1=%ldMb,&quot;
l_string|&quot; CAM2=%ldMb residual: %ldMb&bslash;n&quot;
comma
id|__cam0
op_rshift
l_int|20
comma
id|__cam1
op_rshift
l_int|20
comma
id|__cam2
op_rshift
l_int|20
comma
(paren
id|total_lowmem
op_minus
id|__cam0
op_minus
id|__cam1
op_minus
id|__cam2
)paren
op_rshift
l_int|20
)paren
suffix:semicolon
id|__max_low_memory
op_assign
id|max_low_mem
op_assign
id|__cam0
op_plus
id|__cam1
op_plus
id|__cam2
suffix:semicolon
)brace
eof
