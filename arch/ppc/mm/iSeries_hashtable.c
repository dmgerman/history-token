multiline_comment|/*&n; * &n; *&n; *    Copyright (c) 2000 Mike Corrigan &lt;mikejc@us.ibm.com&gt;  IBM Corporation&n; *    updated by Dave Boutcher (boutcher@us.ibm.com)&n; *&n; *    Module name: iSeries_hashtable.c&n; *&n; *    Description:&n; *      Handles Hash Table faults for iSeries LPAR.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; * &n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; * &n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; */
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/mmu_context.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/types.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/iSeries/HvCallHpt.h&gt;
macro_line|#include &lt;asm/iSeries/LparData.h&gt;
macro_line|#include &lt;asm/mmu_context.h&gt;
DECL|variable|iSeries_hpt_loaded
r_int
id|iSeries_hpt_loaded
suffix:semicolon
DECL|variable|hash_table_lock
r_static
id|spinlock_t
id|hash_table_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
r_extern
r_int
r_int
id|htab_reloads
suffix:semicolon
singleline_comment|// Defined in ppc/kernel/ppc_htab.c
r_extern
r_int
r_int
id|htab_evicts
suffix:semicolon
DECL|variable|htab_pp_update
r_int
r_int
id|htab_pp_update
op_assign
l_int|0
suffix:semicolon
DECL|variable|flush_hash_page_count
r_int
r_int
id|flush_hash_page_count
op_assign
l_int|0
suffix:semicolon
DECL|variable|Hash_mask
r_int
r_int
id|Hash_mask
suffix:semicolon
DECL|variable|flush_hash_range_count
r_int
r_int
id|flush_hash_range_count
op_assign
l_int|0
suffix:semicolon
DECL|variable|flush_hash_range_hv_finds
r_int
r_int
id|flush_hash_range_hv_finds
op_assign
l_int|0
suffix:semicolon
DECL|variable|flush_hash_range_hv_evicts
r_int
r_int
id|flush_hash_range_hv_evicts
op_assign
l_int|0
suffix:semicolon
r_extern
r_int
id|iSeries_max_kernel_hpt_slot
suffix:semicolon
DECL|variable|next_slot
r_static
r_int
id|next_slot
op_assign
l_int|4
suffix:semicolon
singleline_comment|// good enough starting value
r_extern
r_void
id|flush_hash_range
c_func
(paren
id|u64
comma
id|u64
comma
r_int
)paren
suffix:semicolon
DECL|function|computeHptePP
r_static
r_inline
id|u32
id|computeHptePP
c_func
(paren
r_int
r_int
id|pte
)paren
(brace
r_return
(paren
(paren
id|pte
op_amp
id|_PAGE_USER
)paren
op_rshift
l_int|1
)paren
op_or
(paren
(paren
(paren
id|pte
op_amp
id|_PAGE_USER
)paren
op_rshift
l_int|2
)paren
op_amp
(paren
(paren
op_complement
id|pte
op_amp
id|_PAGE_RW
)paren
op_rshift
l_int|10
)paren
)paren
suffix:semicolon
)brace
DECL|function|computeHpteHash
r_static
r_inline
id|u32
id|computeHpteHash
c_func
(paren
r_int
r_int
id|vsid
comma
r_int
r_int
id|pid
)paren
(brace
r_return
(paren
id|vsid
op_xor
id|pid
)paren
op_amp
id|Hash_mask
suffix:semicolon
)brace
multiline_comment|/*&n; * Should be called with hash page lock&n; */
DECL|function|__create_hpte
r_static
r_void
id|__create_hpte
c_func
(paren
r_int
r_int
id|vsid
comma
r_int
r_int
id|va
comma
r_int
r_int
id|newpte
)paren
(brace
id|PTE
id|hpte
suffix:semicolon
id|u64
id|vpn
suffix:semicolon
id|u64
id|rtnIndex
suffix:semicolon
id|u64
op_star
id|hpte0Ptr
comma
op_star
id|hpte1Ptr
suffix:semicolon
id|u32
id|newpp
comma
id|gIndex
suffix:semicolon
id|vsid
op_assign
id|vsid
op_amp
l_int|0x7ffffff
suffix:semicolon
id|vpn
op_assign
(paren
(paren
id|u64
)paren
id|vsid
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|va
op_rshift
l_int|12
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|hpte0Ptr
op_assign
(paren
id|u64
op_star
)paren
op_amp
id|hpte
suffix:semicolon
id|hpte1Ptr
op_assign
id|hpte0Ptr
op_plus
l_int|1
suffix:semicolon
op_star
id|hpte0Ptr
op_assign
op_star
id|hpte1Ptr
op_assign
l_int|0
suffix:semicolon
id|rtnIndex
op_assign
id|HvCallHpt_findValid
c_func
(paren
op_amp
id|hpte
comma
id|vpn
)paren
suffix:semicolon
id|newpp
op_assign
id|computeHptePP
c_func
(paren
id|newpte
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hpte.v
)paren
(brace
multiline_comment|/* A matching valid entry was found&n;&t;&t; * Just update the pp bits&n;&t;&t; */
op_increment
id|htab_pp_update
suffix:semicolon
id|HvCallHpt_setPp
c_func
(paren
id|rtnIndex
comma
id|newpp
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* No matching entry was found  Build new hpte */
id|hpte.vsid
op_assign
id|vsid
suffix:semicolon
id|hpte.api
op_assign
(paren
id|va
op_rshift
l_int|23
)paren
op_amp
l_int|0x1f
suffix:semicolon
id|hpte.v
op_assign
l_int|1
suffix:semicolon
id|hpte.rpn
op_assign
id|physRpn_to_absRpn
c_func
(paren
id|newpte
op_rshift
l_int|12
)paren
suffix:semicolon
id|hpte.r
op_assign
l_int|1
suffix:semicolon
id|hpte.c
op_assign
l_int|1
suffix:semicolon
id|hpte.m
op_assign
l_int|1
suffix:semicolon
id|hpte.pp
op_assign
id|newpp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rtnIndex
op_ne
op_complement
l_int|0
)paren
op_logical_and
(paren
id|rtnIndex
op_ne
l_int|0x00000000ffffffff
)paren
)paren
(brace
multiline_comment|/* Free entry was found */
r_if
c_cond
(paren
(paren
id|rtnIndex
op_rshift
l_int|63
)paren
op_logical_or
(paren
id|rtnIndex
op_amp
l_int|0x80000000
)paren
)paren
id|hpte.h
op_assign
l_int|1
suffix:semicolon
id|HvCallHpt_addValidate
c_func
(paren
id|rtnIndex
comma
id|hpte.h
comma
op_amp
id|hpte
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* No free entry was found */
id|gIndex
op_assign
id|computeHpteHash
c_func
(paren
id|vsid
comma
id|vpn
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|rtnIndex
op_assign
id|gIndex
op_star
l_int|8
op_plus
id|next_slot
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|next_slot
OG
l_int|7
)paren
id|next_slot
op_assign
id|iSeries_max_kernel_hpt_slot
op_plus
l_int|1
suffix:semicolon
id|HvCallHpt_invalidateSetSwBitsGet
c_func
(paren
id|rtnIndex
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|HvCallHpt_addValidate
c_func
(paren
id|rtnIndex
comma
l_int|0
comma
op_amp
id|hpte
)paren
suffix:semicolon
op_increment
id|htab_evicts
suffix:semicolon
)brace
)brace
)brace
DECL|function|iSeries_create_hpte
r_int
id|iSeries_create_hpte
c_func
(paren
r_int
r_int
id|access
comma
r_int
r_int
id|va
)paren
(brace
r_struct
id|thread_struct
op_star
id|ts
suffix:semicolon
id|pgd_t
op_star
id|pg
suffix:semicolon
id|pmd_t
op_star
id|pm
suffix:semicolon
id|pte_t
op_star
id|pt
suffix:semicolon
id|u32
id|vsid
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|vsid
op_assign
id|mfsrin
c_func
(paren
id|va
)paren
op_amp
l_int|0x07ffffff
suffix:semicolon
r_if
c_cond
(paren
id|va
op_ge
id|KERNELBASE
)paren
id|pg
op_assign
id|swapper_pg_dir
suffix:semicolon
r_else
(brace
singleline_comment|// Get the thread structure
id|ts
op_assign
(paren
r_struct
id|thread_struct
op_star
)paren
id|mfspr
c_func
(paren
id|SPRG3
)paren
suffix:semicolon
singleline_comment|// Get the page directory
id|pg
op_assign
id|ts-&gt;pgdir
suffix:semicolon
)brace
id|pg
op_assign
id|pg
op_plus
id|pgd_index
c_func
(paren
id|va
)paren
suffix:semicolon
singleline_comment|// offset into first level
id|pm
op_assign
id|pmd_offset
c_func
(paren
id|pg
comma
id|va
)paren
suffix:semicolon
singleline_comment|// offset into second level
r_if
c_cond
(paren
id|pmd_none
c_func
(paren
op_star
id|pm
)paren
)paren
singleline_comment|// if no third level
r_return
l_int|1
suffix:semicolon
singleline_comment|// indicate failure&t;&t;
id|pt
op_assign
id|pte_offset
c_func
(paren
id|pm
comma
id|va
)paren
suffix:semicolon
singleline_comment|// offset into third level
id|access
op_or_assign
id|_PAGE_PRESENT
suffix:semicolon
singleline_comment|// _PAGE_PRESENT also needed
id|spin_lock
c_func
(paren
op_amp
id|hash_table_lock
)paren
suffix:semicolon
singleline_comment|// check if pte is in the required state
r_if
c_cond
(paren
(paren
id|access
op_amp
op_complement
(paren
id|pte_val
c_func
(paren
op_star
id|pt
)paren
)paren
)paren
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|hash_table_lock
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* pte allows the access we are making */
id|flags
op_assign
id|_PAGE_ACCESSED
op_or
id|_PAGE_HASHPTE
op_or
id|_PAGE_COHERENT
suffix:semicolon
r_if
c_cond
(paren
id|access
op_amp
id|_PAGE_RW
)paren
multiline_comment|/* If write access */
id|flags
op_or_assign
id|_PAGE_RW
suffix:semicolon
multiline_comment|/* atomically update pte */
id|pte_update
c_func
(paren
id|pt
comma
l_int|0
comma
id|flags
)paren
suffix:semicolon
id|__create_hpte
c_func
(paren
id|vsid
comma
id|va
comma
id|pte_val
c_func
(paren
op_star
id|pt
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|hash_table_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|add_hash_page
r_void
id|add_hash_page
c_func
(paren
r_int
id|context
comma
r_int
r_int
id|va
comma
id|pte_t
op_star
id|ptep
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|hash_table_lock
)paren
suffix:semicolon
id|pte_update
c_func
(paren
id|ptep
comma
l_int|0
comma
id|_PAGE_HASHPTE
)paren
suffix:semicolon
id|__create_hpte
c_func
(paren
id|CTX_TO_VSID
c_func
(paren
id|context
comma
id|va
)paren
comma
id|va
comma
id|pte_val
c_func
(paren
op_star
id|ptep
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|hash_table_lock
)paren
suffix:semicolon
)brace
DECL|function|flush_hash_page
r_int
id|flush_hash_page
c_func
(paren
r_int
id|context
comma
r_int
r_int
id|va
comma
id|pte_t
op_star
id|ptep
)paren
(brace
r_int
id|rc
suffix:semicolon
id|PTE
id|hpte
suffix:semicolon
id|u64
id|vpn
suffix:semicolon
r_int
r_int
id|vsid
suffix:semicolon
id|u64
id|rtnIndex
suffix:semicolon
id|u64
op_star
id|hpte0Ptr
comma
op_star
id|hpte1Ptr
suffix:semicolon
id|vsid
op_assign
id|CTX_TO_VSID
c_func
(paren
id|context
comma
id|va
)paren
suffix:semicolon
id|vpn
op_assign
(paren
(paren
id|u64
)paren
id|vsid
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|va
op_rshift
l_int|12
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|hpte0Ptr
op_assign
(paren
id|u64
op_star
)paren
op_amp
id|hpte
suffix:semicolon
id|hpte1Ptr
op_assign
id|hpte0Ptr
op_plus
l_int|1
suffix:semicolon
op_star
id|hpte0Ptr
op_assign
op_star
id|hpte1Ptr
op_assign
l_int|0
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|hash_table_lock
)paren
suffix:semicolon
id|rtnIndex
op_assign
id|HvCallHpt_findValid
c_func
(paren
op_amp
id|hpte
comma
id|vpn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hpte.v
)paren
(brace
id|pte_update
c_func
(paren
id|ptep
comma
id|_PAGE_HASHPTE
comma
l_int|0
)paren
suffix:semicolon
id|HvCallHpt_invalidateSetSwBitsGet
c_func
(paren
id|rtnIndex
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|rc
op_assign
l_int|1
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|hash_table_lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
eof
