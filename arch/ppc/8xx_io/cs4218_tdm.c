multiline_comment|/* This is a modified version of linux/drivers/sound/dmasound.c to&n; * support the CS4218 codec on the 8xx TDM port.  Thanks to everyone&n; * that contributed to the dmasound software (which includes me :-).&n; *&n; * The CS4218 is configured in Mode 4, sub-mode 0.  This provides&n; * left/right data only on the TDM port, as a 32-bit word, per frame&n; * pulse.  The control of the CS4218 is provided by some other means,&n; * like the SPI port.&n; * Dan Malek (dmalek@jlc.net)&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/sound.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
multiline_comment|/* Should probably do something different with this path name.....&n; * Actually, I should just stop using it...&n; */
macro_line|#include &quot;cs4218.h&quot;
macro_line|#include &lt;linux/soundcard.h&gt;
macro_line|#include &lt;asm/mpc8xx.h&gt;
macro_line|#include &lt;asm/8xx_immap.h&gt;
macro_line|#include &lt;asm/commproc.h&gt;
DECL|macro|DMASND_CS4218
mdefine_line|#define DMASND_CS4218&t;&t;5
DECL|macro|MAX_CATCH_RADIUS
mdefine_line|#define MAX_CATCH_RADIUS&t;10
DECL|macro|MIN_BUFFERS
mdefine_line|#define MIN_BUFFERS&t;&t;4
DECL|macro|MIN_BUFSIZE
mdefine_line|#define MIN_BUFSIZE &t;&t;4
DECL|macro|MAX_BUFSIZE
mdefine_line|#define MAX_BUFSIZE&t;&t;128
DECL|macro|HAS_8BIT_TABLES
mdefine_line|#define HAS_8BIT_TABLES
DECL|variable|sq_unit
r_static
r_int
id|sq_unit
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|mixer_unit
r_static
r_int
id|mixer_unit
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|state_unit
r_static
r_int
id|state_unit
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|irq_installed
r_static
r_int
id|irq_installed
op_assign
l_int|0
suffix:semicolon
DECL|variable|sound_buffers
r_static
r_char
op_star
op_star
id|sound_buffers
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|sound_read_buffers
r_static
r_char
op_star
op_star
id|sound_read_buffers
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Local copies of things we put in the control register.  Output&n; * volume, like most codecs is really attenuation.&n; */
DECL|variable|cs4218_rate_index
r_static
r_int
id|cs4218_rate_index
suffix:semicolon
multiline_comment|/*&n; * Stuff for outputting a beep.  The values range from -327 to +327&n; * so we can multiply by an amplitude in the range 0..100 to get a&n; * signed short value to put in the output buffer.&n; */
DECL|variable|beep_wform
r_static
r_int
id|beep_wform
(braket
l_int|256
)braket
op_assign
(brace
l_int|0
comma
l_int|40
comma
l_int|79
comma
l_int|117
comma
l_int|153
comma
l_int|187
comma
l_int|218
comma
l_int|245
comma
l_int|269
comma
l_int|288
comma
l_int|304
comma
l_int|316
comma
l_int|323
comma
l_int|327
comma
l_int|327
comma
l_int|324
comma
l_int|318
comma
l_int|310
comma
l_int|299
comma
l_int|288
comma
l_int|275
comma
l_int|262
comma
l_int|249
comma
l_int|236
comma
l_int|224
comma
l_int|213
comma
l_int|204
comma
l_int|196
comma
l_int|190
comma
l_int|186
comma
l_int|183
comma
l_int|182
comma
l_int|182
comma
l_int|183
comma
l_int|186
comma
l_int|189
comma
l_int|192
comma
l_int|196
comma
l_int|200
comma
l_int|203
comma
l_int|206
comma
l_int|208
comma
l_int|209
comma
l_int|209
comma
l_int|209
comma
l_int|207
comma
l_int|204
comma
l_int|201
comma
l_int|197
comma
l_int|193
comma
l_int|188
comma
l_int|183
comma
l_int|179
comma
l_int|174
comma
l_int|170
comma
l_int|166
comma
l_int|163
comma
l_int|161
comma
l_int|160
comma
l_int|159
comma
l_int|159
comma
l_int|160
comma
l_int|161
comma
l_int|162
comma
l_int|164
comma
l_int|166
comma
l_int|168
comma
l_int|169
comma
l_int|171
comma
l_int|171
comma
l_int|171
comma
l_int|170
comma
l_int|169
comma
l_int|167
comma
l_int|163
comma
l_int|159
comma
l_int|155
comma
l_int|150
comma
l_int|144
comma
l_int|139
comma
l_int|133
comma
l_int|128
comma
l_int|122
comma
l_int|117
comma
l_int|113
comma
l_int|110
comma
l_int|107
comma
l_int|105
comma
l_int|103
comma
l_int|103
comma
l_int|103
comma
l_int|103
comma
l_int|104
comma
l_int|104
comma
l_int|105
comma
l_int|105
comma
l_int|105
comma
l_int|103
comma
l_int|101
comma
l_int|97
comma
l_int|92
comma
l_int|86
comma
l_int|78
comma
l_int|68
comma
l_int|58
comma
l_int|45
comma
l_int|32
comma
l_int|18
comma
l_int|3
comma
op_minus
l_int|11
comma
op_minus
l_int|26
comma
op_minus
l_int|41
comma
op_minus
l_int|55
comma
op_minus
l_int|68
comma
op_minus
l_int|79
comma
op_minus
l_int|88
comma
op_minus
l_int|95
comma
op_minus
l_int|100
comma
op_minus
l_int|102
comma
op_minus
l_int|102
comma
op_minus
l_int|99
comma
op_minus
l_int|93
comma
op_minus
l_int|85
comma
op_minus
l_int|75
comma
op_minus
l_int|62
comma
op_minus
l_int|48
comma
op_minus
l_int|33
comma
op_minus
l_int|16
comma
l_int|0
comma
l_int|16
comma
l_int|33
comma
l_int|48
comma
l_int|62
comma
l_int|75
comma
l_int|85
comma
l_int|93
comma
l_int|99
comma
l_int|102
comma
l_int|102
comma
l_int|100
comma
l_int|95
comma
l_int|88
comma
l_int|79
comma
l_int|68
comma
l_int|55
comma
l_int|41
comma
l_int|26
comma
l_int|11
comma
op_minus
l_int|3
comma
op_minus
l_int|18
comma
op_minus
l_int|32
comma
op_minus
l_int|45
comma
op_minus
l_int|58
comma
op_minus
l_int|68
comma
op_minus
l_int|78
comma
op_minus
l_int|86
comma
op_minus
l_int|92
comma
op_minus
l_int|97
comma
op_minus
l_int|101
comma
op_minus
l_int|103
comma
op_minus
l_int|105
comma
op_minus
l_int|105
comma
op_minus
l_int|105
comma
op_minus
l_int|104
comma
op_minus
l_int|104
comma
op_minus
l_int|103
comma
op_minus
l_int|103
comma
op_minus
l_int|103
comma
op_minus
l_int|103
comma
op_minus
l_int|105
comma
op_minus
l_int|107
comma
op_minus
l_int|110
comma
op_minus
l_int|113
comma
op_minus
l_int|117
comma
op_minus
l_int|122
comma
op_minus
l_int|128
comma
op_minus
l_int|133
comma
op_minus
l_int|139
comma
op_minus
l_int|144
comma
op_minus
l_int|150
comma
op_minus
l_int|155
comma
op_minus
l_int|159
comma
op_minus
l_int|163
comma
op_minus
l_int|167
comma
op_minus
l_int|169
comma
op_minus
l_int|170
comma
op_minus
l_int|171
comma
op_minus
l_int|171
comma
op_minus
l_int|171
comma
op_minus
l_int|169
comma
op_minus
l_int|168
comma
op_minus
l_int|166
comma
op_minus
l_int|164
comma
op_minus
l_int|162
comma
op_minus
l_int|161
comma
op_minus
l_int|160
comma
op_minus
l_int|159
comma
op_minus
l_int|159
comma
op_minus
l_int|160
comma
op_minus
l_int|161
comma
op_minus
l_int|163
comma
op_minus
l_int|166
comma
op_minus
l_int|170
comma
op_minus
l_int|174
comma
op_minus
l_int|179
comma
op_minus
l_int|183
comma
op_minus
l_int|188
comma
op_minus
l_int|193
comma
op_minus
l_int|197
comma
op_minus
l_int|201
comma
op_minus
l_int|204
comma
op_minus
l_int|207
comma
op_minus
l_int|209
comma
op_minus
l_int|209
comma
op_minus
l_int|209
comma
op_minus
l_int|208
comma
op_minus
l_int|206
comma
op_minus
l_int|203
comma
op_minus
l_int|200
comma
op_minus
l_int|196
comma
op_minus
l_int|192
comma
op_minus
l_int|189
comma
op_minus
l_int|186
comma
op_minus
l_int|183
comma
op_minus
l_int|182
comma
op_minus
l_int|182
comma
op_minus
l_int|183
comma
op_minus
l_int|186
comma
op_minus
l_int|190
comma
op_minus
l_int|196
comma
op_minus
l_int|204
comma
op_minus
l_int|213
comma
op_minus
l_int|224
comma
op_minus
l_int|236
comma
op_minus
l_int|249
comma
op_minus
l_int|262
comma
op_minus
l_int|275
comma
op_minus
l_int|288
comma
op_minus
l_int|299
comma
op_minus
l_int|310
comma
op_minus
l_int|318
comma
op_minus
l_int|324
comma
op_minus
l_int|327
comma
op_minus
l_int|327
comma
op_minus
l_int|323
comma
op_minus
l_int|316
comma
op_minus
l_int|304
comma
op_minus
l_int|288
comma
op_minus
l_int|269
comma
op_minus
l_int|245
comma
op_minus
l_int|218
comma
op_minus
l_int|187
comma
op_minus
l_int|153
comma
op_minus
l_int|117
comma
op_minus
l_int|79
comma
op_minus
l_int|40
comma
)brace
suffix:semicolon
DECL|macro|BEEP_SPEED
mdefine_line|#define BEEP_SPEED&t;5&t;/* 22050 Hz sample rate */
DECL|macro|BEEP_BUFLEN
mdefine_line|#define BEEP_BUFLEN&t;512
DECL|macro|BEEP_VOLUME
mdefine_line|#define BEEP_VOLUME&t;15&t;/* 0 - 100 */
DECL|variable|beep_volume
r_static
r_int
id|beep_volume
op_assign
id|BEEP_VOLUME
suffix:semicolon
DECL|variable|beep_playing
r_static
r_int
id|beep_playing
op_assign
l_int|0
suffix:semicolon
DECL|variable|beep_state
r_static
r_int
id|beep_state
op_assign
l_int|0
suffix:semicolon
DECL|variable|beep_buf
r_static
r_int
op_star
id|beep_buf
suffix:semicolon
DECL|variable|orig_mksound
r_static
r_void
(paren
op_star
id|orig_mksound
)paren
(paren
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
multiline_comment|/* This is found someplace else......I guess in the keyboard driver&n; * we don&squot;t include.&n; */
DECL|variable|kd_mksound
r_static
r_void
(paren
op_star
id|kd_mksound
)paren
(paren
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
DECL|variable|catchRadius
r_static
r_int
id|catchRadius
op_assign
l_int|0
suffix:semicolon
DECL|variable|numBufs
DECL|variable|bufSize
r_static
r_int
id|numBufs
op_assign
l_int|4
comma
id|bufSize
op_assign
l_int|32
suffix:semicolon
DECL|variable|numReadBufs
DECL|variable|readbufSize
r_static
r_int
id|numReadBufs
op_assign
l_int|4
comma
id|readbufSize
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* TDM/Serial transmit and receive buffer descriptors.&n;*/
DECL|variable|rx_base
DECL|variable|rx_cur
DECL|variable|tx_base
DECL|variable|tx_cur
r_static
r_volatile
id|cbd_t
op_star
id|rx_base
comma
op_star
id|rx_cur
comma
op_star
id|tx_base
comma
op_star
id|tx_cur
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|catchRadius
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|numBufs
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|bufSize
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|numreadBufs
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|readbufSize
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|macro|arraysize
mdefine_line|#define arraysize(x)&t;(sizeof(x)/sizeof(*(x)))
DECL|macro|le2be16
mdefine_line|#define le2be16(x)&t;(((x)&lt;&lt;8 &amp; 0xff00) | ((x)&gt;&gt;8 &amp; 0x00ff))
DECL|macro|le2be16dbl
mdefine_line|#define le2be16dbl(x)&t;(((x)&lt;&lt;8 &amp; 0xff00ff00) | ((x)&gt;&gt;8 &amp; 0x00ff00ff))
DECL|macro|IOCTL_IN
mdefine_line|#define IOCTL_IN(arg, ret) &bslash;&n;&t;do { int error = get_user(ret, (int *)(arg)); &bslash;&n;&t;&t;if (error) return error; &bslash;&n;&t;} while (0)
DECL|macro|IOCTL_OUT
mdefine_line|#define IOCTL_OUT(arg, ret)&t;ioctl_return((int *)(arg), ret)
multiline_comment|/* CS4218 serial port control in mode 4.&n;*/
DECL|macro|CS_INTMASK
mdefine_line|#define CS_INTMASK&t;((uint)0x40000000)
DECL|macro|CS_DO1
mdefine_line|#define CS_DO1&t;&t;((uint)0x20000000)
DECL|macro|CS_LATTEN
mdefine_line|#define CS_LATTEN&t;((uint)0x1f000000)
DECL|macro|CS_RATTEN
mdefine_line|#define CS_RATTEN&t;((uint)0x00f80000)
DECL|macro|CS_MUTE
mdefine_line|#define CS_MUTE&t;&t;((uint)0x00040000)
DECL|macro|CS_ISL
mdefine_line|#define CS_ISL&t;&t;((uint)0x00020000)
DECL|macro|CS_ISR
mdefine_line|#define CS_ISR&t;&t;((uint)0x00010000)
DECL|macro|CS_LGAIN
mdefine_line|#define CS_LGAIN&t;((uint)0x0000f000)
DECL|macro|CS_RGAIN
mdefine_line|#define CS_RGAIN&t;((uint)0x00000f00)
DECL|macro|CS_LATTEN_SET
mdefine_line|#define CS_LATTEN_SET(X)&t;(((X) &amp; 0x1f) &lt;&lt; 24)
DECL|macro|CS_RATTEN_SET
mdefine_line|#define CS_RATTEN_SET(X)&t;(((X) &amp; 0x1f) &lt;&lt; 19)
DECL|macro|CS_LGAIN_SET
mdefine_line|#define CS_LGAIN_SET(X)&t;&t;(((X) &amp; 0x0f) &lt;&lt; 12)
DECL|macro|CS_RGAIN_SET
mdefine_line|#define CS_RGAIN_SET(X)&t;&t;(((X) &amp; 0x0f) &lt;&lt; 8)
DECL|macro|CS_LATTEN_GET
mdefine_line|#define CS_LATTEN_GET(X)&t;(((X) &gt;&gt; 24) &amp; 0x1f)
DECL|macro|CS_RATTEN_GET
mdefine_line|#define CS_RATTEN_GET(X)&t;(((X) &gt;&gt; 19) &amp; 0x1f)
DECL|macro|CS_LGAIN_GET
mdefine_line|#define CS_LGAIN_GET(X)&t;&t;(((X) &gt;&gt; 12) &amp; 0x0f)
DECL|macro|CS_RGAIN_GET
mdefine_line|#define CS_RGAIN_GET(X)&t;&t;(((X) &gt;&gt; 8) &amp; 0x0f)
multiline_comment|/* The control register is effectively write only.  We have to keep a copy&n; * of what we write.&n; */
DECL|variable|cs4218_control
r_static
id|uint
id|cs4218_control
suffix:semicolon
multiline_comment|/* A place to store expanding information.&n;*/
DECL|variable|expand_bal
r_static
r_int
id|expand_bal
suffix:semicolon
DECL|variable|expand_data
r_static
r_int
id|expand_data
suffix:semicolon
multiline_comment|/* Since I can&squot;t make the microcode patch work for the SPI, I just&n; * clock the bits using software.&n; */
r_static
r_void
id|sw_spi_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|sw_spi_io
c_func
(paren
id|u_char
op_star
id|obuf
comma
id|u_char
op_star
id|ibuf
comma
id|uint
id|bcnt
)paren
suffix:semicolon
r_static
id|uint
id|cs4218_ctl_write
c_func
(paren
id|uint
id|ctlreg
)paren
suffix:semicolon
multiline_comment|/*** Some low level helpers **************************************************/
multiline_comment|/* 16 bit mu-law */
DECL|variable|ulaw2dma16
r_static
r_int
id|ulaw2dma16
(braket
)braket
op_assign
(brace
op_minus
l_int|32124
comma
op_minus
l_int|31100
comma
op_minus
l_int|30076
comma
op_minus
l_int|29052
comma
op_minus
l_int|28028
comma
op_minus
l_int|27004
comma
op_minus
l_int|25980
comma
op_minus
l_int|24956
comma
op_minus
l_int|23932
comma
op_minus
l_int|22908
comma
op_minus
l_int|21884
comma
op_minus
l_int|20860
comma
op_minus
l_int|19836
comma
op_minus
l_int|18812
comma
op_minus
l_int|17788
comma
op_minus
l_int|16764
comma
op_minus
l_int|15996
comma
op_minus
l_int|15484
comma
op_minus
l_int|14972
comma
op_minus
l_int|14460
comma
op_minus
l_int|13948
comma
op_minus
l_int|13436
comma
op_minus
l_int|12924
comma
op_minus
l_int|12412
comma
op_minus
l_int|11900
comma
op_minus
l_int|11388
comma
op_minus
l_int|10876
comma
op_minus
l_int|10364
comma
op_minus
l_int|9852
comma
op_minus
l_int|9340
comma
op_minus
l_int|8828
comma
op_minus
l_int|8316
comma
op_minus
l_int|7932
comma
op_minus
l_int|7676
comma
op_minus
l_int|7420
comma
op_minus
l_int|7164
comma
op_minus
l_int|6908
comma
op_minus
l_int|6652
comma
op_minus
l_int|6396
comma
op_minus
l_int|6140
comma
op_minus
l_int|5884
comma
op_minus
l_int|5628
comma
op_minus
l_int|5372
comma
op_minus
l_int|5116
comma
op_minus
l_int|4860
comma
op_minus
l_int|4604
comma
op_minus
l_int|4348
comma
op_minus
l_int|4092
comma
op_minus
l_int|3900
comma
op_minus
l_int|3772
comma
op_minus
l_int|3644
comma
op_minus
l_int|3516
comma
op_minus
l_int|3388
comma
op_minus
l_int|3260
comma
op_minus
l_int|3132
comma
op_minus
l_int|3004
comma
op_minus
l_int|2876
comma
op_minus
l_int|2748
comma
op_minus
l_int|2620
comma
op_minus
l_int|2492
comma
op_minus
l_int|2364
comma
op_minus
l_int|2236
comma
op_minus
l_int|2108
comma
op_minus
l_int|1980
comma
op_minus
l_int|1884
comma
op_minus
l_int|1820
comma
op_minus
l_int|1756
comma
op_minus
l_int|1692
comma
op_minus
l_int|1628
comma
op_minus
l_int|1564
comma
op_minus
l_int|1500
comma
op_minus
l_int|1436
comma
op_minus
l_int|1372
comma
op_minus
l_int|1308
comma
op_minus
l_int|1244
comma
op_minus
l_int|1180
comma
op_minus
l_int|1116
comma
op_minus
l_int|1052
comma
op_minus
l_int|988
comma
op_minus
l_int|924
comma
op_minus
l_int|876
comma
op_minus
l_int|844
comma
op_minus
l_int|812
comma
op_minus
l_int|780
comma
op_minus
l_int|748
comma
op_minus
l_int|716
comma
op_minus
l_int|684
comma
op_minus
l_int|652
comma
op_minus
l_int|620
comma
op_minus
l_int|588
comma
op_minus
l_int|556
comma
op_minus
l_int|524
comma
op_minus
l_int|492
comma
op_minus
l_int|460
comma
op_minus
l_int|428
comma
op_minus
l_int|396
comma
op_minus
l_int|372
comma
op_minus
l_int|356
comma
op_minus
l_int|340
comma
op_minus
l_int|324
comma
op_minus
l_int|308
comma
op_minus
l_int|292
comma
op_minus
l_int|276
comma
op_minus
l_int|260
comma
op_minus
l_int|244
comma
op_minus
l_int|228
comma
op_minus
l_int|212
comma
op_minus
l_int|196
comma
op_minus
l_int|180
comma
op_minus
l_int|164
comma
op_minus
l_int|148
comma
op_minus
l_int|132
comma
op_minus
l_int|120
comma
op_minus
l_int|112
comma
op_minus
l_int|104
comma
op_minus
l_int|96
comma
op_minus
l_int|88
comma
op_minus
l_int|80
comma
op_minus
l_int|72
comma
op_minus
l_int|64
comma
op_minus
l_int|56
comma
op_minus
l_int|48
comma
op_minus
l_int|40
comma
op_minus
l_int|32
comma
op_minus
l_int|24
comma
op_minus
l_int|16
comma
op_minus
l_int|8
comma
l_int|0
comma
l_int|32124
comma
l_int|31100
comma
l_int|30076
comma
l_int|29052
comma
l_int|28028
comma
l_int|27004
comma
l_int|25980
comma
l_int|24956
comma
l_int|23932
comma
l_int|22908
comma
l_int|21884
comma
l_int|20860
comma
l_int|19836
comma
l_int|18812
comma
l_int|17788
comma
l_int|16764
comma
l_int|15996
comma
l_int|15484
comma
l_int|14972
comma
l_int|14460
comma
l_int|13948
comma
l_int|13436
comma
l_int|12924
comma
l_int|12412
comma
l_int|11900
comma
l_int|11388
comma
l_int|10876
comma
l_int|10364
comma
l_int|9852
comma
l_int|9340
comma
l_int|8828
comma
l_int|8316
comma
l_int|7932
comma
l_int|7676
comma
l_int|7420
comma
l_int|7164
comma
l_int|6908
comma
l_int|6652
comma
l_int|6396
comma
l_int|6140
comma
l_int|5884
comma
l_int|5628
comma
l_int|5372
comma
l_int|5116
comma
l_int|4860
comma
l_int|4604
comma
l_int|4348
comma
l_int|4092
comma
l_int|3900
comma
l_int|3772
comma
l_int|3644
comma
l_int|3516
comma
l_int|3388
comma
l_int|3260
comma
l_int|3132
comma
l_int|3004
comma
l_int|2876
comma
l_int|2748
comma
l_int|2620
comma
l_int|2492
comma
l_int|2364
comma
l_int|2236
comma
l_int|2108
comma
l_int|1980
comma
l_int|1884
comma
l_int|1820
comma
l_int|1756
comma
l_int|1692
comma
l_int|1628
comma
l_int|1564
comma
l_int|1500
comma
l_int|1436
comma
l_int|1372
comma
l_int|1308
comma
l_int|1244
comma
l_int|1180
comma
l_int|1116
comma
l_int|1052
comma
l_int|988
comma
l_int|924
comma
l_int|876
comma
l_int|844
comma
l_int|812
comma
l_int|780
comma
l_int|748
comma
l_int|716
comma
l_int|684
comma
l_int|652
comma
l_int|620
comma
l_int|588
comma
l_int|556
comma
l_int|524
comma
l_int|492
comma
l_int|460
comma
l_int|428
comma
l_int|396
comma
l_int|372
comma
l_int|356
comma
l_int|340
comma
l_int|324
comma
l_int|308
comma
l_int|292
comma
l_int|276
comma
l_int|260
comma
l_int|244
comma
l_int|228
comma
l_int|212
comma
l_int|196
comma
l_int|180
comma
l_int|164
comma
l_int|148
comma
l_int|132
comma
l_int|120
comma
l_int|112
comma
l_int|104
comma
l_int|96
comma
l_int|88
comma
l_int|80
comma
l_int|72
comma
l_int|64
comma
l_int|56
comma
l_int|48
comma
l_int|40
comma
l_int|32
comma
l_int|24
comma
l_int|16
comma
l_int|8
comma
l_int|0
comma
)brace
suffix:semicolon
multiline_comment|/* 16 bit A-law */
DECL|variable|alaw2dma16
r_static
r_int
id|alaw2dma16
(braket
)braket
op_assign
(brace
op_minus
l_int|5504
comma
op_minus
l_int|5248
comma
op_minus
l_int|6016
comma
op_minus
l_int|5760
comma
op_minus
l_int|4480
comma
op_minus
l_int|4224
comma
op_minus
l_int|4992
comma
op_minus
l_int|4736
comma
op_minus
l_int|7552
comma
op_minus
l_int|7296
comma
op_minus
l_int|8064
comma
op_minus
l_int|7808
comma
op_minus
l_int|6528
comma
op_minus
l_int|6272
comma
op_minus
l_int|7040
comma
op_minus
l_int|6784
comma
op_minus
l_int|2752
comma
op_minus
l_int|2624
comma
op_minus
l_int|3008
comma
op_minus
l_int|2880
comma
op_minus
l_int|2240
comma
op_minus
l_int|2112
comma
op_minus
l_int|2496
comma
op_minus
l_int|2368
comma
op_minus
l_int|3776
comma
op_minus
l_int|3648
comma
op_minus
l_int|4032
comma
op_minus
l_int|3904
comma
op_minus
l_int|3264
comma
op_minus
l_int|3136
comma
op_minus
l_int|3520
comma
op_minus
l_int|3392
comma
op_minus
l_int|22016
comma
op_minus
l_int|20992
comma
op_minus
l_int|24064
comma
op_minus
l_int|23040
comma
op_minus
l_int|17920
comma
op_minus
l_int|16896
comma
op_minus
l_int|19968
comma
op_minus
l_int|18944
comma
op_minus
l_int|30208
comma
op_minus
l_int|29184
comma
op_minus
l_int|32256
comma
op_minus
l_int|31232
comma
op_minus
l_int|26112
comma
op_minus
l_int|25088
comma
op_minus
l_int|28160
comma
op_minus
l_int|27136
comma
op_minus
l_int|11008
comma
op_minus
l_int|10496
comma
op_minus
l_int|12032
comma
op_minus
l_int|11520
comma
op_minus
l_int|8960
comma
op_minus
l_int|8448
comma
op_minus
l_int|9984
comma
op_minus
l_int|9472
comma
op_minus
l_int|15104
comma
op_minus
l_int|14592
comma
op_minus
l_int|16128
comma
op_minus
l_int|15616
comma
op_minus
l_int|13056
comma
op_minus
l_int|12544
comma
op_minus
l_int|14080
comma
op_minus
l_int|13568
comma
op_minus
l_int|344
comma
op_minus
l_int|328
comma
op_minus
l_int|376
comma
op_minus
l_int|360
comma
op_minus
l_int|280
comma
op_minus
l_int|264
comma
op_minus
l_int|312
comma
op_minus
l_int|296
comma
op_minus
l_int|472
comma
op_minus
l_int|456
comma
op_minus
l_int|504
comma
op_minus
l_int|488
comma
op_minus
l_int|408
comma
op_minus
l_int|392
comma
op_minus
l_int|440
comma
op_minus
l_int|424
comma
op_minus
l_int|88
comma
op_minus
l_int|72
comma
op_minus
l_int|120
comma
op_minus
l_int|104
comma
op_minus
l_int|24
comma
op_minus
l_int|8
comma
op_minus
l_int|56
comma
op_minus
l_int|40
comma
op_minus
l_int|216
comma
op_minus
l_int|200
comma
op_minus
l_int|248
comma
op_minus
l_int|232
comma
op_minus
l_int|152
comma
op_minus
l_int|136
comma
op_minus
l_int|184
comma
op_minus
l_int|168
comma
op_minus
l_int|1376
comma
op_minus
l_int|1312
comma
op_minus
l_int|1504
comma
op_minus
l_int|1440
comma
op_minus
l_int|1120
comma
op_minus
l_int|1056
comma
op_minus
l_int|1248
comma
op_minus
l_int|1184
comma
op_minus
l_int|1888
comma
op_minus
l_int|1824
comma
op_minus
l_int|2016
comma
op_minus
l_int|1952
comma
op_minus
l_int|1632
comma
op_minus
l_int|1568
comma
op_minus
l_int|1760
comma
op_minus
l_int|1696
comma
op_minus
l_int|688
comma
op_minus
l_int|656
comma
op_minus
l_int|752
comma
op_minus
l_int|720
comma
op_minus
l_int|560
comma
op_minus
l_int|528
comma
op_minus
l_int|624
comma
op_minus
l_int|592
comma
op_minus
l_int|944
comma
op_minus
l_int|912
comma
op_minus
l_int|1008
comma
op_minus
l_int|976
comma
op_minus
l_int|816
comma
op_minus
l_int|784
comma
op_minus
l_int|880
comma
op_minus
l_int|848
comma
l_int|5504
comma
l_int|5248
comma
l_int|6016
comma
l_int|5760
comma
l_int|4480
comma
l_int|4224
comma
l_int|4992
comma
l_int|4736
comma
l_int|7552
comma
l_int|7296
comma
l_int|8064
comma
l_int|7808
comma
l_int|6528
comma
l_int|6272
comma
l_int|7040
comma
l_int|6784
comma
l_int|2752
comma
l_int|2624
comma
l_int|3008
comma
l_int|2880
comma
l_int|2240
comma
l_int|2112
comma
l_int|2496
comma
l_int|2368
comma
l_int|3776
comma
l_int|3648
comma
l_int|4032
comma
l_int|3904
comma
l_int|3264
comma
l_int|3136
comma
l_int|3520
comma
l_int|3392
comma
l_int|22016
comma
l_int|20992
comma
l_int|24064
comma
l_int|23040
comma
l_int|17920
comma
l_int|16896
comma
l_int|19968
comma
l_int|18944
comma
l_int|30208
comma
l_int|29184
comma
l_int|32256
comma
l_int|31232
comma
l_int|26112
comma
l_int|25088
comma
l_int|28160
comma
l_int|27136
comma
l_int|11008
comma
l_int|10496
comma
l_int|12032
comma
l_int|11520
comma
l_int|8960
comma
l_int|8448
comma
l_int|9984
comma
l_int|9472
comma
l_int|15104
comma
l_int|14592
comma
l_int|16128
comma
l_int|15616
comma
l_int|13056
comma
l_int|12544
comma
l_int|14080
comma
l_int|13568
comma
l_int|344
comma
l_int|328
comma
l_int|376
comma
l_int|360
comma
l_int|280
comma
l_int|264
comma
l_int|312
comma
l_int|296
comma
l_int|472
comma
l_int|456
comma
l_int|504
comma
l_int|488
comma
l_int|408
comma
l_int|392
comma
l_int|440
comma
l_int|424
comma
l_int|88
comma
l_int|72
comma
l_int|120
comma
l_int|104
comma
l_int|24
comma
l_int|8
comma
l_int|56
comma
l_int|40
comma
l_int|216
comma
l_int|200
comma
l_int|248
comma
l_int|232
comma
l_int|152
comma
l_int|136
comma
l_int|184
comma
l_int|168
comma
l_int|1376
comma
l_int|1312
comma
l_int|1504
comma
l_int|1440
comma
l_int|1120
comma
l_int|1056
comma
l_int|1248
comma
l_int|1184
comma
l_int|1888
comma
l_int|1824
comma
l_int|2016
comma
l_int|1952
comma
l_int|1632
comma
l_int|1568
comma
l_int|1760
comma
l_int|1696
comma
l_int|688
comma
l_int|656
comma
l_int|752
comma
l_int|720
comma
l_int|560
comma
l_int|528
comma
l_int|624
comma
l_int|592
comma
l_int|944
comma
l_int|912
comma
l_int|1008
comma
l_int|976
comma
l_int|816
comma
l_int|784
comma
l_int|880
comma
l_int|848
comma
)brace
suffix:semicolon
multiline_comment|/*** Translations ************************************************************/
r_static
id|ssize_t
id|cs4218_ct_law
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
suffix:semicolon
r_static
id|ssize_t
id|cs4218_ct_s8
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
suffix:semicolon
r_static
id|ssize_t
id|cs4218_ct_u8
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
suffix:semicolon
r_static
id|ssize_t
id|cs4218_ct_s16
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
suffix:semicolon
r_static
id|ssize_t
id|cs4218_ct_u16
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
suffix:semicolon
r_static
id|ssize_t
id|cs4218_ctx_law
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
suffix:semicolon
r_static
id|ssize_t
id|cs4218_ctx_s8
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
suffix:semicolon
r_static
id|ssize_t
id|cs4218_ctx_u8
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
suffix:semicolon
r_static
id|ssize_t
id|cs4218_ctx_s16
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
suffix:semicolon
r_static
id|ssize_t
id|cs4218_ctx_u16
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
suffix:semicolon
r_static
id|ssize_t
id|cs4218_ct_s16_read
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
suffix:semicolon
r_static
id|ssize_t
id|cs4218_ct_u16_read
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
suffix:semicolon
multiline_comment|/*** Low level stuff *********************************************************/
DECL|struct|cs_sound_settings
r_struct
id|cs_sound_settings
(brace
DECL|member|mach
id|MACHINE
id|mach
suffix:semicolon
multiline_comment|/* machine dependent things */
DECL|member|hard
id|SETTINGS
id|hard
suffix:semicolon
multiline_comment|/* hardware settings */
DECL|member|soft
id|SETTINGS
id|soft
suffix:semicolon
multiline_comment|/* software settings */
DECL|member|dsp
id|SETTINGS
id|dsp
suffix:semicolon
multiline_comment|/* /dev/dsp default settings */
DECL|member|trans_write
id|TRANS
op_star
id|trans_write
suffix:semicolon
multiline_comment|/* supported translations for playback */
DECL|member|trans_read
id|TRANS
op_star
id|trans_read
suffix:semicolon
multiline_comment|/* supported translations for record */
DECL|member|volume_left
r_int
id|volume_left
suffix:semicolon
multiline_comment|/* volume (range is machine dependent) */
DECL|member|volume_right
r_int
id|volume_right
suffix:semicolon
DECL|member|bass
r_int
id|bass
suffix:semicolon
multiline_comment|/* tone (range is machine dependent) */
DECL|member|treble
r_int
id|treble
suffix:semicolon
DECL|member|gain
r_int
id|gain
suffix:semicolon
DECL|member|minDev
r_int
id|minDev
suffix:semicolon
multiline_comment|/* minor device number currently open */
)brace
suffix:semicolon
DECL|variable|sound
r_static
r_struct
id|cs_sound_settings
id|sound
suffix:semicolon
r_static
r_void
op_star
id|CS_Alloc
c_func
(paren
r_int
r_int
id|size
comma
r_int
id|flags
)paren
suffix:semicolon
r_static
r_void
id|CS_Free
c_func
(paren
r_void
op_star
id|ptr
comma
r_int
r_int
id|size
)paren
suffix:semicolon
r_static
r_int
id|CS_IrqInit
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#ifdef MODULE
r_static
r_void
id|CS_IrqCleanup
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif /* MODULE */
r_static
r_void
id|CS_Silence
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|CS_Init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|CS_Play
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|CS_Record
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|CS_SetFormat
c_func
(paren
r_int
id|format
)paren
suffix:semicolon
r_static
r_int
id|CS_SetVolume
c_func
(paren
r_int
id|volume
)paren
suffix:semicolon
r_static
r_void
id|cs4218_tdm_tx_intr
c_func
(paren
r_void
op_star
id|devid
)paren
suffix:semicolon
r_static
r_void
id|cs4218_tdm_rx_intr
c_func
(paren
r_void
op_star
id|devid
)paren
suffix:semicolon
r_static
r_void
id|cs4218_intr
c_func
(paren
r_void
op_star
id|devid
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|cs_get_volume
c_func
(paren
id|uint
id|reg
)paren
suffix:semicolon
r_static
r_int
id|cs_volume_setter
c_func
(paren
r_int
id|volume
comma
r_int
id|mute
)paren
suffix:semicolon
r_static
r_int
id|cs_get_gain
c_func
(paren
id|uint
id|reg
)paren
suffix:semicolon
r_static
r_int
id|cs_set_gain
c_func
(paren
r_int
id|gain
)paren
suffix:semicolon
r_static
r_void
id|cs_mksound
c_func
(paren
r_int
r_int
id|hz
comma
r_int
r_int
id|ticks
)paren
suffix:semicolon
r_static
r_void
id|cs_nosound
c_func
(paren
r_int
r_int
id|xx
)paren
suffix:semicolon
multiline_comment|/*** Mid level stuff *********************************************************/
r_static
r_void
id|sound_silence
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|sound_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|sound_set_format
c_func
(paren
r_int
id|format
)paren
suffix:semicolon
r_static
r_int
id|sound_set_speed
c_func
(paren
r_int
id|speed
)paren
suffix:semicolon
r_static
r_int
id|sound_set_stereo
c_func
(paren
r_int
id|stereo
)paren
suffix:semicolon
r_static
r_int
id|sound_set_volume
c_func
(paren
r_int
id|volume
)paren
suffix:semicolon
r_static
id|ssize_t
id|sound_copy_translate
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
suffix:semicolon
r_static
id|ssize_t
id|sound_copy_translate_read
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
suffix:semicolon
multiline_comment|/*&n; * /dev/mixer abstraction&n; */
DECL|struct|sound_mixer
r_struct
id|sound_mixer
(brace
DECL|member|busy
r_int
id|busy
suffix:semicolon
DECL|member|modify_counter
r_int
id|modify_counter
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|mixer
r_static
r_struct
id|sound_mixer
id|mixer
suffix:semicolon
DECL|variable|sq
r_static
r_struct
id|sound_queue
id|sq
suffix:semicolon
DECL|variable|read_sq
r_static
r_struct
id|sound_queue
id|read_sq
suffix:semicolon
DECL|macro|sq_block_address
mdefine_line|#define sq_block_address(i)&t;(sq.buffers[i])
DECL|macro|SIGNAL_RECEIVED
mdefine_line|#define SIGNAL_RECEIVED&t;(signal_pending(current))
DECL|macro|NON_BLOCKING
mdefine_line|#define NON_BLOCKING(open_mode)&t;(open_mode &amp; O_NONBLOCK)
DECL|macro|ONE_SECOND
mdefine_line|#define ONE_SECOND&t;HZ&t;/* in jiffies (100ths of a second) */
DECL|macro|NO_TIME_LIMIT
mdefine_line|#define NO_TIME_LIMIT&t;0xffffffff
multiline_comment|/*&n; * /dev/sndstat&n; */
DECL|struct|sound_state
r_struct
id|sound_state
(brace
DECL|member|busy
r_int
id|busy
suffix:semicolon
DECL|member|buf
r_char
id|buf
(braket
l_int|512
)braket
suffix:semicolon
DECL|member|len
DECL|member|ptr
r_int
id|len
comma
id|ptr
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|state
r_static
r_struct
id|sound_state
id|state
suffix:semicolon
multiline_comment|/*** Common stuff ********************************************************/
r_static
r_int
r_int
id|sound_lseek
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|offset
comma
r_int
id|orig
)paren
suffix:semicolon
multiline_comment|/*** Config &amp; Setup **********************************************************/
r_void
id|dmasound_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
suffix:semicolon
multiline_comment|/*** Translations ************************************************************/
multiline_comment|/* ++TeSche: radically changed for new expanding purposes...&n; *&n; * These two routines now deal with copying/expanding/translating the samples&n; * from user space into our buffer at the right frequency. They take care about&n; * how much data there&squot;s actually to read, how much buffer space there is and&n; * to convert samples into the right frequency/encoding. They will only work on&n; * complete samples so it may happen they leave some bytes in the input stream&n; * if the user didn&squot;t write a multiple of the current sample size. They both&n; * return the number of bytes they&squot;ve used from both streams so you may detect&n; * such a situation. Luckily all programs should be able to cope with that.&n; *&n; * I think I&squot;ve optimized anything as far as one can do in plain C, all&n; * variables should fit in registers and the loops are really short. There&squot;s&n; * one loop for every possible situation. Writing a more generalized and thus&n; * parameterized loop would only produce slower code. Feel free to optimize&n; * this in assembler if you like. :)&n; *&n; * I think these routines belong here because they&squot;re not yet really hardware&n; * independent, especially the fact that the Falcon can play 16bit samples&n; * only in stereo is hardcoded in both of them!&n; *&n; * ++geert: split in even more functions (one per format)&n; */
DECL|function|cs4218_ct_law
r_static
id|ssize_t
id|cs4218_ct_law
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
(brace
r_int
op_star
id|table
op_assign
id|sound.soft.format
op_eq
id|AFMT_MU_LAW
ques
c_cond
id|ulaw2dma16
suffix:colon
id|alaw2dma16
suffix:semicolon
id|ssize_t
id|count
comma
id|used
suffix:semicolon
r_int
op_star
id|p
op_assign
(paren
r_int
op_star
)paren
op_amp
id|frame
(braket
op_star
id|frameUsed
)braket
suffix:semicolon
r_int
id|val
comma
id|stereo
op_assign
id|sound.soft.stereo
suffix:semicolon
id|frameLeft
op_rshift_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|stereo
)paren
id|userCount
op_rshift_assign
l_int|1
suffix:semicolon
id|used
op_assign
id|count
op_assign
id|min
c_func
(paren
id|userCount
comma
id|frameLeft
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
id|u_char
id|data
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|data
comma
id|userPtr
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|val
op_assign
id|table
(braket
id|data
)braket
suffix:semicolon
op_star
id|p
op_increment
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
id|stereo
)paren
(brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|data
comma
id|userPtr
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|val
op_assign
id|table
(braket
id|data
)braket
suffix:semicolon
)brace
op_star
id|p
op_increment
op_assign
id|val
suffix:semicolon
id|count
op_decrement
suffix:semicolon
)brace
op_star
id|frameUsed
op_add_assign
id|used
op_star
l_int|4
suffix:semicolon
r_return
id|stereo
ques
c_cond
id|used
op_star
l_int|2
suffix:colon
id|used
suffix:semicolon
)brace
DECL|function|cs4218_ct_s8
r_static
id|ssize_t
id|cs4218_ct_s8
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
(brace
id|ssize_t
id|count
comma
id|used
suffix:semicolon
r_int
op_star
id|p
op_assign
(paren
r_int
op_star
)paren
op_amp
id|frame
(braket
op_star
id|frameUsed
)braket
suffix:semicolon
r_int
id|val
comma
id|stereo
op_assign
id|sound.soft.stereo
suffix:semicolon
id|frameLeft
op_rshift_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|stereo
)paren
id|userCount
op_rshift_assign
l_int|1
suffix:semicolon
id|used
op_assign
id|count
op_assign
id|min
c_func
(paren
id|userCount
comma
id|frameLeft
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
id|u_char
id|data
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|data
comma
id|userPtr
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|val
op_assign
id|data
op_lshift
l_int|8
suffix:semicolon
op_star
id|p
op_increment
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
id|stereo
)paren
(brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|data
comma
id|userPtr
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|val
op_assign
id|data
op_lshift
l_int|8
suffix:semicolon
)brace
op_star
id|p
op_increment
op_assign
id|val
suffix:semicolon
id|count
op_decrement
suffix:semicolon
)brace
op_star
id|frameUsed
op_add_assign
id|used
op_star
l_int|4
suffix:semicolon
r_return
id|stereo
ques
c_cond
id|used
op_star
l_int|2
suffix:colon
id|used
suffix:semicolon
)brace
DECL|function|cs4218_ct_u8
r_static
id|ssize_t
id|cs4218_ct_u8
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
(brace
id|ssize_t
id|count
comma
id|used
suffix:semicolon
r_int
op_star
id|p
op_assign
(paren
r_int
op_star
)paren
op_amp
id|frame
(braket
op_star
id|frameUsed
)braket
suffix:semicolon
r_int
id|val
comma
id|stereo
op_assign
id|sound.soft.stereo
suffix:semicolon
id|frameLeft
op_rshift_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|stereo
)paren
id|userCount
op_rshift_assign
l_int|1
suffix:semicolon
id|used
op_assign
id|count
op_assign
id|min
c_func
(paren
id|userCount
comma
id|frameLeft
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
id|u_char
id|data
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|data
comma
id|userPtr
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|val
op_assign
(paren
id|data
op_xor
l_int|0x80
)paren
op_lshift
l_int|8
suffix:semicolon
op_star
id|p
op_increment
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
id|stereo
)paren
(brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|data
comma
id|userPtr
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|val
op_assign
(paren
id|data
op_xor
l_int|0x80
)paren
op_lshift
l_int|8
suffix:semicolon
)brace
op_star
id|p
op_increment
op_assign
id|val
suffix:semicolon
id|count
op_decrement
suffix:semicolon
)brace
op_star
id|frameUsed
op_add_assign
id|used
op_star
l_int|4
suffix:semicolon
r_return
id|stereo
ques
c_cond
id|used
op_star
l_int|2
suffix:colon
id|used
suffix:semicolon
)brace
multiline_comment|/* This is the default format of the codec.  Signed, 16-bit stereo&n; * generated by an application shouldn&squot;t have to be copied at all.&n; * We should just get the phsical address of the buffers and update&n; * the TDM BDs directly.&n; */
DECL|function|cs4218_ct_s16
r_static
id|ssize_t
id|cs4218_ct_s16
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
(brace
id|ssize_t
id|count
comma
id|used
suffix:semicolon
r_int
id|stereo
op_assign
id|sound.soft.stereo
suffix:semicolon
r_int
op_star
id|fp
op_assign
(paren
r_int
op_star
)paren
op_amp
id|frame
(braket
op_star
id|frameUsed
)braket
suffix:semicolon
id|frameLeft
op_rshift_assign
l_int|2
suffix:semicolon
id|userCount
op_rshift_assign
(paren
id|stereo
ques
c_cond
l_int|2
suffix:colon
l_int|1
)paren
suffix:semicolon
id|used
op_assign
id|count
op_assign
id|min
c_func
(paren
id|userCount
comma
id|frameLeft
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stereo
)paren
(brace
r_int
op_star
id|up
op_assign
(paren
r_int
op_star
)paren
id|userPtr
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
r_int
id|data
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|data
comma
id|up
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
op_star
id|fp
op_increment
op_assign
id|data
suffix:semicolon
op_star
id|fp
op_increment
op_assign
id|data
suffix:semicolon
id|count
op_decrement
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|fp
comma
id|userPtr
comma
id|count
op_star
l_int|4
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
op_star
id|frameUsed
op_add_assign
id|used
op_star
l_int|4
suffix:semicolon
r_return
id|stereo
ques
c_cond
id|used
op_star
l_int|4
suffix:colon
id|used
op_star
l_int|2
suffix:semicolon
)brace
DECL|function|cs4218_ct_u16
r_static
id|ssize_t
id|cs4218_ct_u16
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
(brace
id|ssize_t
id|count
comma
id|used
suffix:semicolon
r_int
id|mask
op_assign
(paren
id|sound.soft.format
op_eq
id|AFMT_U16_LE
ques
c_cond
l_int|0x0080
suffix:colon
l_int|0x8000
)paren
suffix:semicolon
r_int
id|stereo
op_assign
id|sound.soft.stereo
suffix:semicolon
r_int
op_star
id|fp
op_assign
(paren
r_int
op_star
)paren
op_amp
id|frame
(braket
op_star
id|frameUsed
)braket
suffix:semicolon
r_int
op_star
id|up
op_assign
(paren
r_int
op_star
)paren
id|userPtr
suffix:semicolon
id|frameLeft
op_rshift_assign
l_int|2
suffix:semicolon
id|userCount
op_rshift_assign
(paren
id|stereo
ques
c_cond
l_int|2
suffix:colon
l_int|1
)paren
suffix:semicolon
id|used
op_assign
id|count
op_assign
id|min
c_func
(paren
id|userCount
comma
id|frameLeft
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
r_int
id|data
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|data
comma
id|up
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|data
op_xor_assign
id|mask
suffix:semicolon
op_star
id|fp
op_increment
op_assign
id|data
suffix:semicolon
r_if
c_cond
(paren
id|stereo
)paren
(brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|data
comma
id|up
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|data
op_xor_assign
id|mask
suffix:semicolon
)brace
op_star
id|fp
op_increment
op_assign
id|data
suffix:semicolon
id|count
op_decrement
suffix:semicolon
)brace
op_star
id|frameUsed
op_add_assign
id|used
op_star
l_int|4
suffix:semicolon
r_return
id|stereo
ques
c_cond
id|used
op_star
l_int|4
suffix:colon
id|used
op_star
l_int|2
suffix:semicolon
)brace
DECL|function|cs4218_ctx_law
r_static
id|ssize_t
id|cs4218_ctx_law
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
(brace
r_int
r_int
op_star
id|table
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
id|sound.soft.format
op_eq
id|AFMT_MU_LAW
ques
c_cond
id|ulaw2dma16
suffix:colon
id|alaw2dma16
)paren
suffix:semicolon
r_int
r_int
id|data
op_assign
id|expand_data
suffix:semicolon
r_int
r_int
op_star
id|p
op_assign
(paren
r_int
r_int
op_star
)paren
op_amp
id|frame
(braket
op_star
id|frameUsed
)braket
suffix:semicolon
r_int
id|bal
op_assign
id|expand_bal
suffix:semicolon
r_int
id|hSpeed
op_assign
id|sound.hard.speed
comma
id|sSpeed
op_assign
id|sound.soft.speed
suffix:semicolon
r_int
id|utotal
comma
id|ftotal
suffix:semicolon
r_int
id|stereo
op_assign
id|sound.soft.stereo
suffix:semicolon
id|frameLeft
op_rshift_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|stereo
)paren
id|userCount
op_rshift_assign
l_int|1
suffix:semicolon
id|ftotal
op_assign
id|frameLeft
suffix:semicolon
id|utotal
op_assign
id|userCount
suffix:semicolon
r_while
c_loop
(paren
id|frameLeft
)paren
(brace
id|u_char
id|c
suffix:semicolon
r_if
c_cond
(paren
id|bal
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|userCount
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|c
comma
id|userPtr
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|data
op_assign
id|table
(braket
id|c
)braket
suffix:semicolon
r_if
c_cond
(paren
id|stereo
)paren
(brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|c
comma
id|userPtr
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|data
op_assign
(paren
id|data
op_lshift
l_int|16
)paren
op_plus
id|table
(braket
id|c
)braket
suffix:semicolon
)brace
r_else
id|data
op_assign
(paren
id|data
op_lshift
l_int|16
)paren
op_plus
id|data
suffix:semicolon
id|userCount
op_decrement
suffix:semicolon
id|bal
op_add_assign
id|hSpeed
suffix:semicolon
)brace
op_star
id|p
op_increment
op_assign
id|data
suffix:semicolon
id|frameLeft
op_decrement
suffix:semicolon
id|bal
op_sub_assign
id|sSpeed
suffix:semicolon
)brace
id|expand_bal
op_assign
id|bal
suffix:semicolon
id|expand_data
op_assign
id|data
suffix:semicolon
op_star
id|frameUsed
op_add_assign
(paren
id|ftotal
op_minus
id|frameLeft
)paren
op_star
l_int|4
suffix:semicolon
id|utotal
op_sub_assign
id|userCount
suffix:semicolon
r_return
id|stereo
ques
c_cond
id|utotal
op_star
l_int|2
suffix:colon
id|utotal
suffix:semicolon
)brace
DECL|function|cs4218_ctx_s8
r_static
id|ssize_t
id|cs4218_ctx_s8
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
(brace
r_int
r_int
op_star
id|p
op_assign
(paren
r_int
r_int
op_star
)paren
op_amp
id|frame
(braket
op_star
id|frameUsed
)braket
suffix:semicolon
r_int
r_int
id|data
op_assign
id|expand_data
suffix:semicolon
r_int
id|bal
op_assign
id|expand_bal
suffix:semicolon
r_int
id|hSpeed
op_assign
id|sound.hard.speed
comma
id|sSpeed
op_assign
id|sound.soft.speed
suffix:semicolon
r_int
id|stereo
op_assign
id|sound.soft.stereo
suffix:semicolon
r_int
id|utotal
comma
id|ftotal
suffix:semicolon
id|frameLeft
op_rshift_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|stereo
)paren
id|userCount
op_rshift_assign
l_int|1
suffix:semicolon
id|ftotal
op_assign
id|frameLeft
suffix:semicolon
id|utotal
op_assign
id|userCount
suffix:semicolon
r_while
c_loop
(paren
id|frameLeft
)paren
(brace
id|u_char
id|c
suffix:semicolon
r_if
c_cond
(paren
id|bal
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|userCount
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|c
comma
id|userPtr
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|data
op_assign
id|c
op_lshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|stereo
)paren
(brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|c
comma
id|userPtr
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|data
op_assign
(paren
id|data
op_lshift
l_int|16
)paren
op_plus
(paren
id|c
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
r_else
id|data
op_assign
(paren
id|data
op_lshift
l_int|16
)paren
op_plus
id|data
suffix:semicolon
id|userCount
op_decrement
suffix:semicolon
id|bal
op_add_assign
id|hSpeed
suffix:semicolon
)brace
op_star
id|p
op_increment
op_assign
id|data
suffix:semicolon
id|frameLeft
op_decrement
suffix:semicolon
id|bal
op_sub_assign
id|sSpeed
suffix:semicolon
)brace
id|expand_bal
op_assign
id|bal
suffix:semicolon
id|expand_data
op_assign
id|data
suffix:semicolon
op_star
id|frameUsed
op_add_assign
(paren
id|ftotal
op_minus
id|frameLeft
)paren
op_star
l_int|4
suffix:semicolon
id|utotal
op_sub_assign
id|userCount
suffix:semicolon
r_return
id|stereo
ques
c_cond
id|utotal
op_star
l_int|2
suffix:colon
id|utotal
suffix:semicolon
)brace
DECL|function|cs4218_ctx_u8
r_static
id|ssize_t
id|cs4218_ctx_u8
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
(brace
r_int
r_int
op_star
id|p
op_assign
(paren
r_int
r_int
op_star
)paren
op_amp
id|frame
(braket
op_star
id|frameUsed
)braket
suffix:semicolon
r_int
r_int
id|data
op_assign
id|expand_data
suffix:semicolon
r_int
id|bal
op_assign
id|expand_bal
suffix:semicolon
r_int
id|hSpeed
op_assign
id|sound.hard.speed
comma
id|sSpeed
op_assign
id|sound.soft.speed
suffix:semicolon
r_int
id|stereo
op_assign
id|sound.soft.stereo
suffix:semicolon
r_int
id|utotal
comma
id|ftotal
suffix:semicolon
id|frameLeft
op_rshift_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|stereo
)paren
id|userCount
op_rshift_assign
l_int|1
suffix:semicolon
id|ftotal
op_assign
id|frameLeft
suffix:semicolon
id|utotal
op_assign
id|userCount
suffix:semicolon
r_while
c_loop
(paren
id|frameLeft
)paren
(brace
id|u_char
id|c
suffix:semicolon
r_if
c_cond
(paren
id|bal
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|userCount
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|c
comma
id|userPtr
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|data
op_assign
(paren
id|c
op_xor
l_int|0x80
)paren
op_lshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|stereo
)paren
(brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|c
comma
id|userPtr
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|data
op_assign
(paren
id|data
op_lshift
l_int|16
)paren
op_plus
(paren
(paren
id|c
op_xor
l_int|0x80
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
r_else
id|data
op_assign
(paren
id|data
op_lshift
l_int|16
)paren
op_plus
id|data
suffix:semicolon
id|userCount
op_decrement
suffix:semicolon
id|bal
op_add_assign
id|hSpeed
suffix:semicolon
)brace
op_star
id|p
op_increment
op_assign
id|data
suffix:semicolon
id|frameLeft
op_decrement
suffix:semicolon
id|bal
op_sub_assign
id|sSpeed
suffix:semicolon
)brace
id|expand_bal
op_assign
id|bal
suffix:semicolon
id|expand_data
op_assign
id|data
suffix:semicolon
op_star
id|frameUsed
op_add_assign
(paren
id|ftotal
op_minus
id|frameLeft
)paren
op_star
l_int|4
suffix:semicolon
id|utotal
op_sub_assign
id|userCount
suffix:semicolon
r_return
id|stereo
ques
c_cond
id|utotal
op_star
l_int|2
suffix:colon
id|utotal
suffix:semicolon
)brace
DECL|function|cs4218_ctx_s16
r_static
id|ssize_t
id|cs4218_ctx_s16
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
(brace
r_int
r_int
op_star
id|p
op_assign
(paren
r_int
r_int
op_star
)paren
op_amp
id|frame
(braket
op_star
id|frameUsed
)braket
suffix:semicolon
r_int
r_int
id|data
op_assign
id|expand_data
suffix:semicolon
r_int
r_int
op_star
id|up
op_assign
(paren
r_int
r_int
op_star
)paren
id|userPtr
suffix:semicolon
r_int
id|bal
op_assign
id|expand_bal
suffix:semicolon
r_int
id|hSpeed
op_assign
id|sound.hard.speed
comma
id|sSpeed
op_assign
id|sound.soft.speed
suffix:semicolon
r_int
id|stereo
op_assign
id|sound.soft.stereo
suffix:semicolon
r_int
id|utotal
comma
id|ftotal
suffix:semicolon
id|frameLeft
op_rshift_assign
l_int|2
suffix:semicolon
id|userCount
op_rshift_assign
(paren
id|stereo
ques
c_cond
l_int|2
suffix:colon
l_int|1
)paren
suffix:semicolon
id|ftotal
op_assign
id|frameLeft
suffix:semicolon
id|utotal
op_assign
id|userCount
suffix:semicolon
r_while
c_loop
(paren
id|frameLeft
)paren
(brace
r_int
r_int
id|c
suffix:semicolon
r_if
c_cond
(paren
id|bal
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|userCount
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|data
comma
id|up
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|stereo
)paren
(brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|c
comma
id|up
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|data
op_assign
(paren
id|data
op_lshift
l_int|16
)paren
op_plus
id|c
suffix:semicolon
)brace
r_else
id|data
op_assign
(paren
id|data
op_lshift
l_int|16
)paren
op_plus
id|data
suffix:semicolon
id|userCount
op_decrement
suffix:semicolon
id|bal
op_add_assign
id|hSpeed
suffix:semicolon
)brace
op_star
id|p
op_increment
op_assign
id|data
suffix:semicolon
id|frameLeft
op_decrement
suffix:semicolon
id|bal
op_sub_assign
id|sSpeed
suffix:semicolon
)brace
id|expand_bal
op_assign
id|bal
suffix:semicolon
id|expand_data
op_assign
id|data
suffix:semicolon
op_star
id|frameUsed
op_add_assign
(paren
id|ftotal
op_minus
id|frameLeft
)paren
op_star
l_int|4
suffix:semicolon
id|utotal
op_sub_assign
id|userCount
suffix:semicolon
r_return
id|stereo
ques
c_cond
id|utotal
op_star
l_int|4
suffix:colon
id|utotal
op_star
l_int|2
suffix:semicolon
)brace
DECL|function|cs4218_ctx_u16
r_static
id|ssize_t
id|cs4218_ctx_u16
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
(brace
r_int
id|mask
op_assign
(paren
id|sound.soft.format
op_eq
id|AFMT_U16_LE
ques
c_cond
l_int|0x0080
suffix:colon
l_int|0x8000
)paren
suffix:semicolon
r_int
r_int
op_star
id|p
op_assign
(paren
r_int
r_int
op_star
)paren
op_amp
id|frame
(braket
op_star
id|frameUsed
)braket
suffix:semicolon
r_int
r_int
id|data
op_assign
id|expand_data
suffix:semicolon
r_int
r_int
op_star
id|up
op_assign
(paren
r_int
r_int
op_star
)paren
id|userPtr
suffix:semicolon
r_int
id|bal
op_assign
id|expand_bal
suffix:semicolon
r_int
id|hSpeed
op_assign
id|sound.hard.speed
comma
id|sSpeed
op_assign
id|sound.soft.speed
suffix:semicolon
r_int
id|stereo
op_assign
id|sound.soft.stereo
suffix:semicolon
r_int
id|utotal
comma
id|ftotal
suffix:semicolon
id|frameLeft
op_rshift_assign
l_int|2
suffix:semicolon
id|userCount
op_rshift_assign
(paren
id|stereo
ques
c_cond
l_int|2
suffix:colon
l_int|1
)paren
suffix:semicolon
id|ftotal
op_assign
id|frameLeft
suffix:semicolon
id|utotal
op_assign
id|userCount
suffix:semicolon
r_while
c_loop
(paren
id|frameLeft
)paren
(brace
r_int
r_int
id|c
suffix:semicolon
r_if
c_cond
(paren
id|bal
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|userCount
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|data
comma
id|up
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|data
op_xor_assign
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|stereo
)paren
(brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|c
comma
id|up
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|data
op_assign
(paren
id|data
op_lshift
l_int|16
)paren
op_plus
(paren
id|c
op_xor
id|mask
)paren
suffix:semicolon
)brace
r_else
id|data
op_assign
(paren
id|data
op_lshift
l_int|16
)paren
op_plus
id|data
suffix:semicolon
id|userCount
op_decrement
suffix:semicolon
id|bal
op_add_assign
id|hSpeed
suffix:semicolon
)brace
op_star
id|p
op_increment
op_assign
id|data
suffix:semicolon
id|frameLeft
op_decrement
suffix:semicolon
id|bal
op_sub_assign
id|sSpeed
suffix:semicolon
)brace
id|expand_bal
op_assign
id|bal
suffix:semicolon
id|expand_data
op_assign
id|data
suffix:semicolon
op_star
id|frameUsed
op_add_assign
(paren
id|ftotal
op_minus
id|frameLeft
)paren
op_star
l_int|4
suffix:semicolon
id|utotal
op_sub_assign
id|userCount
suffix:semicolon
r_return
id|stereo
ques
c_cond
id|utotal
op_star
l_int|4
suffix:colon
id|utotal
op_star
l_int|2
suffix:semicolon
)brace
DECL|function|cs4218_ct_s8_read
r_static
id|ssize_t
id|cs4218_ct_s8_read
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
(brace
id|ssize_t
id|count
comma
id|used
suffix:semicolon
r_int
op_star
id|p
op_assign
(paren
r_int
op_star
)paren
op_amp
id|frame
(braket
op_star
id|frameUsed
)braket
suffix:semicolon
r_int
id|val
comma
id|stereo
op_assign
id|sound.soft.stereo
suffix:semicolon
id|frameLeft
op_rshift_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|stereo
)paren
id|userCount
op_rshift_assign
l_int|1
suffix:semicolon
id|used
op_assign
id|count
op_assign
id|min
c_func
(paren
id|userCount
comma
id|frameLeft
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
id|u_char
id|data
suffix:semicolon
id|val
op_assign
op_star
id|p
op_increment
suffix:semicolon
id|data
op_assign
id|val
op_rshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|data
comma
(paren
id|u_char
op_star
)paren
id|userPtr
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|stereo
)paren
(brace
id|val
op_assign
op_star
id|p
suffix:semicolon
id|data
op_assign
id|val
op_rshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|data
comma
(paren
id|u_char
op_star
)paren
id|userPtr
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|p
op_increment
suffix:semicolon
id|count
op_decrement
suffix:semicolon
)brace
op_star
id|frameUsed
op_add_assign
id|used
op_star
l_int|4
suffix:semicolon
r_return
id|stereo
ques
c_cond
id|used
op_star
l_int|2
suffix:colon
id|used
suffix:semicolon
)brace
DECL|function|cs4218_ct_u8_read
r_static
id|ssize_t
id|cs4218_ct_u8_read
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
(brace
id|ssize_t
id|count
comma
id|used
suffix:semicolon
r_int
op_star
id|p
op_assign
(paren
r_int
op_star
)paren
op_amp
id|frame
(braket
op_star
id|frameUsed
)braket
suffix:semicolon
r_int
id|val
comma
id|stereo
op_assign
id|sound.soft.stereo
suffix:semicolon
id|frameLeft
op_rshift_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|stereo
)paren
id|userCount
op_rshift_assign
l_int|1
suffix:semicolon
id|used
op_assign
id|count
op_assign
id|min
c_func
(paren
id|userCount
comma
id|frameLeft
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
id|u_char
id|data
suffix:semicolon
id|val
op_assign
op_star
id|p
op_increment
suffix:semicolon
id|data
op_assign
(paren
id|val
op_rshift
l_int|8
)paren
op_xor
l_int|0x80
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|data
comma
(paren
id|u_char
op_star
)paren
id|userPtr
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|stereo
)paren
(brace
id|val
op_assign
op_star
id|p
suffix:semicolon
id|data
op_assign
(paren
id|val
op_rshift
l_int|8
)paren
op_xor
l_int|0x80
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|data
comma
(paren
id|u_char
op_star
)paren
id|userPtr
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|p
op_increment
suffix:semicolon
id|count
op_decrement
suffix:semicolon
)brace
op_star
id|frameUsed
op_add_assign
id|used
op_star
l_int|4
suffix:semicolon
r_return
id|stereo
ques
c_cond
id|used
op_star
l_int|2
suffix:colon
id|used
suffix:semicolon
)brace
DECL|function|cs4218_ct_s16_read
r_static
id|ssize_t
id|cs4218_ct_s16_read
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
(brace
id|ssize_t
id|count
comma
id|used
suffix:semicolon
r_int
id|stereo
op_assign
id|sound.soft.stereo
suffix:semicolon
r_int
op_star
id|fp
op_assign
(paren
r_int
op_star
)paren
op_amp
id|frame
(braket
op_star
id|frameUsed
)braket
suffix:semicolon
id|frameLeft
op_rshift_assign
l_int|2
suffix:semicolon
id|userCount
op_rshift_assign
(paren
id|stereo
ques
c_cond
l_int|2
suffix:colon
l_int|1
)paren
suffix:semicolon
id|used
op_assign
id|count
op_assign
id|min
c_func
(paren
id|userCount
comma
id|frameLeft
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stereo
)paren
(brace
r_int
op_star
id|up
op_assign
(paren
r_int
op_star
)paren
id|userPtr
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
r_int
id|data
suffix:semicolon
id|data
op_assign
op_star
id|fp
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|data
comma
id|up
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|fp
op_add_assign
l_int|2
suffix:semicolon
id|count
op_decrement
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
id|u_char
op_star
)paren
id|userPtr
comma
id|fp
comma
id|count
op_star
l_int|4
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
op_star
id|frameUsed
op_add_assign
id|used
op_star
l_int|4
suffix:semicolon
r_return
id|stereo
ques
c_cond
id|used
op_star
l_int|4
suffix:colon
id|used
op_star
l_int|2
suffix:semicolon
)brace
DECL|function|cs4218_ct_u16_read
r_static
id|ssize_t
id|cs4218_ct_u16_read
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
(brace
id|ssize_t
id|count
comma
id|used
suffix:semicolon
r_int
id|mask
op_assign
(paren
id|sound.soft.format
op_eq
id|AFMT_U16_LE
ques
c_cond
l_int|0x0080
suffix:colon
l_int|0x8000
)paren
suffix:semicolon
r_int
id|stereo
op_assign
id|sound.soft.stereo
suffix:semicolon
r_int
op_star
id|fp
op_assign
(paren
r_int
op_star
)paren
op_amp
id|frame
(braket
op_star
id|frameUsed
)braket
suffix:semicolon
r_int
op_star
id|up
op_assign
(paren
r_int
op_star
)paren
id|userPtr
suffix:semicolon
id|frameLeft
op_rshift_assign
l_int|2
suffix:semicolon
id|userCount
op_rshift_assign
(paren
id|stereo
ques
c_cond
l_int|2
suffix:colon
l_int|1
)paren
suffix:semicolon
id|used
op_assign
id|count
op_assign
id|min
c_func
(paren
id|userCount
comma
id|frameLeft
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
r_int
id|data
suffix:semicolon
id|data
op_assign
op_star
id|fp
op_increment
suffix:semicolon
id|data
op_xor_assign
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|data
comma
id|up
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|stereo
)paren
(brace
id|data
op_assign
op_star
id|fp
suffix:semicolon
id|data
op_xor_assign
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|data
comma
id|up
op_increment
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|fp
op_increment
suffix:semicolon
id|count
op_decrement
suffix:semicolon
)brace
op_star
id|frameUsed
op_add_assign
id|used
op_star
l_int|4
suffix:semicolon
r_return
id|stereo
ques
c_cond
id|used
op_star
l_int|4
suffix:colon
id|used
op_star
l_int|2
suffix:semicolon
)brace
DECL|variable|transCSNormal
r_static
id|TRANS
id|transCSNormal
op_assign
(brace
id|cs4218_ct_law
comma
id|cs4218_ct_law
comma
id|cs4218_ct_s8
comma
id|cs4218_ct_u8
comma
id|cs4218_ct_s16
comma
id|cs4218_ct_u16
comma
id|cs4218_ct_s16
comma
id|cs4218_ct_u16
)brace
suffix:semicolon
DECL|variable|transCSExpand
r_static
id|TRANS
id|transCSExpand
op_assign
(brace
id|cs4218_ctx_law
comma
id|cs4218_ctx_law
comma
id|cs4218_ctx_s8
comma
id|cs4218_ctx_u8
comma
id|cs4218_ctx_s16
comma
id|cs4218_ctx_u16
comma
id|cs4218_ctx_s16
comma
id|cs4218_ctx_u16
)brace
suffix:semicolon
DECL|variable|transCSNormalRead
r_static
id|TRANS
id|transCSNormalRead
op_assign
(brace
l_int|NULL
comma
l_int|NULL
comma
id|cs4218_ct_s8_read
comma
id|cs4218_ct_u8_read
comma
id|cs4218_ct_s16_read
comma
id|cs4218_ct_u16_read
comma
id|cs4218_ct_s16_read
comma
id|cs4218_ct_u16_read
)brace
suffix:semicolon
multiline_comment|/*** Low level stuff *********************************************************/
DECL|function|CS_Alloc
r_static
r_void
op_star
id|CS_Alloc
c_func
(paren
r_int
r_int
id|size
comma
r_int
id|flags
)paren
(brace
r_int
id|order
suffix:semicolon
id|size
op_rshift_assign
l_int|13
suffix:semicolon
r_for
c_loop
(paren
id|order
op_assign
l_int|0
suffix:semicolon
id|order
OL
l_int|5
suffix:semicolon
id|order
op_increment
)paren
(brace
r_if
c_cond
(paren
id|size
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|size
op_rshift_assign
l_int|1
suffix:semicolon
)brace
r_return
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|flags
comma
id|order
)paren
suffix:semicolon
)brace
DECL|function|CS_Free
r_static
r_void
id|CS_Free
c_func
(paren
r_void
op_star
id|ptr
comma
r_int
r_int
id|size
)paren
(brace
r_int
id|order
suffix:semicolon
id|size
op_rshift_assign
l_int|13
suffix:semicolon
r_for
c_loop
(paren
id|order
op_assign
l_int|0
suffix:semicolon
id|order
OL
l_int|5
suffix:semicolon
id|order
op_increment
)paren
(brace
r_if
c_cond
(paren
id|size
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|size
op_rshift_assign
l_int|1
suffix:semicolon
)brace
id|free_pages
c_func
(paren
(paren
id|ulong
)paren
id|ptr
comma
id|order
)paren
suffix:semicolon
)brace
DECL|function|CS_IrqInit
r_static
r_int
id|__init
id|CS_IrqInit
c_func
(paren
r_void
)paren
(brace
id|cpm_install_handler
c_func
(paren
id|CPMVEC_SMC2
comma
id|cs4218_intr
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|CS_IrqCleanup
r_static
r_void
id|CS_IrqCleanup
c_func
(paren
r_void
)paren
(brace
r_volatile
id|smc_t
op_star
id|sp
suffix:semicolon
r_volatile
id|cpm8xx_t
op_star
id|cp
suffix:semicolon
multiline_comment|/* First disable transmitter and receiver.&n;&t;*/
id|sp
op_assign
op_amp
id|cpmp-&gt;cp_smc
(braket
l_int|1
)braket
suffix:semicolon
id|sp-&gt;smc_smcmr
op_and_assign
op_complement
(paren
id|SMCMR_REN
op_or
id|SMCMR_TEN
)paren
suffix:semicolon
multiline_comment|/* And now shut down the SMC.&n;&t;*/
id|cp
op_assign
id|cpmp
suffix:semicolon
multiline_comment|/* Get pointer to Communication Processor */
id|cp-&gt;cp_cpcr
op_assign
id|mk_cr_cmd
c_func
(paren
id|CPM_CR_CH_SMC2
comma
id|CPM_CR_STOP_TX
)paren
op_or
id|CPM_CR_FLG
suffix:semicolon
r_while
c_loop
(paren
id|cp-&gt;cp_cpcr
op_amp
id|CPM_CR_FLG
)paren
suffix:semicolon
multiline_comment|/* Release the interrupt handler.&n;&t;*/
id|cpm_free_handler
c_func
(paren
id|CPMVEC_SMC2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|beep_buf
)paren
id|kfree
c_func
(paren
id|beep_buf
)paren
suffix:semicolon
id|kd_mksound
op_assign
id|orig_mksound
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
DECL|function|CS_Silence
r_static
r_void
id|CS_Silence
c_func
(paren
r_void
)paren
(brace
r_volatile
id|smc_t
op_star
id|sp
suffix:semicolon
multiline_comment|/* Disable transmitter.&n;&t;*/
id|sp
op_assign
op_amp
id|cpmp-&gt;cp_smc
(braket
l_int|1
)braket
suffix:semicolon
id|sp-&gt;smc_smcmr
op_and_assign
op_complement
id|SMCMR_TEN
suffix:semicolon
)brace
multiline_comment|/* Frequencies depend upon external oscillator.  There are two&n; * choices, 12.288 and 11.2896 MHz.  The RPCG audio supports both through&n; * and external control register selection bit.&n; */
DECL|variable|cs4218_freqs
r_static
r_int
id|cs4218_freqs
(braket
)braket
op_assign
(brace
multiline_comment|/* 12.288  11.2896  */
l_int|48000
comma
l_int|44100
comma
l_int|32000
comma
l_int|29400
comma
l_int|24000
comma
l_int|22050
comma
l_int|19200
comma
l_int|17640
comma
l_int|16000
comma
l_int|14700
comma
l_int|12000
comma
l_int|11025
comma
l_int|9600
comma
l_int|8820
comma
l_int|8000
comma
l_int|7350
)brace
suffix:semicolon
DECL|function|CS_Init
r_static
r_void
id|CS_Init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|tolerance
suffix:semicolon
r_switch
c_cond
(paren
id|sound.soft.format
)paren
(brace
r_case
id|AFMT_S16_LE
suffix:colon
r_case
id|AFMT_U16_LE
suffix:colon
id|sound.hard.format
op_assign
id|AFMT_S16_LE
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|sound.hard.format
op_assign
id|AFMT_S16_BE
suffix:semicolon
r_break
suffix:semicolon
)brace
id|sound.hard.stereo
op_assign
l_int|1
suffix:semicolon
id|sound.hard.size
op_assign
l_int|16
suffix:semicolon
multiline_comment|/*&n;&t; * If we have a sample rate which is within catchRadius percent&n;&t; * of the requested value, we don&squot;t have to expand the samples.&n;&t; * Otherwise choose the next higher rate.&n;&t; */
id|i
op_assign
(paren
r_sizeof
(paren
id|cs4218_freqs
)paren
op_div
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_do
(brace
id|tolerance
op_assign
id|catchRadius
op_star
id|cs4218_freqs
(braket
op_decrement
id|i
)braket
op_div
l_int|100
suffix:semicolon
)brace
r_while
c_loop
(paren
id|sound.soft.speed
OG
id|cs4218_freqs
(braket
id|i
)braket
op_plus
id|tolerance
op_logical_and
id|i
OG
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sound.soft.speed
op_ge
id|cs4218_freqs
(braket
id|i
)braket
op_minus
id|tolerance
)paren
id|sound.trans_write
op_assign
op_amp
id|transCSNormal
suffix:semicolon
r_else
id|sound.trans_write
op_assign
op_amp
id|transCSExpand
suffix:semicolon
id|sound.trans_read
op_assign
op_amp
id|transCSNormalRead
suffix:semicolon
id|sound.hard.speed
op_assign
id|cs4218_freqs
(braket
id|i
)braket
suffix:semicolon
id|cs4218_rate_index
op_assign
id|i
suffix:semicolon
multiline_comment|/* The CS4218 has seven selectable clock dividers for the sample&n;&t; * clock.  The HIOX then provides one of two external rates.&n;&t; * An even numbered frequency table index uses the high external&n;&t; * clock rate.&n;&t; */
op_star
(paren
id|uint
op_star
)paren
id|HIOX_CSR4_ADDR
op_and_assign
op_complement
(paren
id|HIOX_CSR4_AUDCLKHI
op_or
id|HIOX_CSR4_AUDCLKSEL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
op_star
(paren
id|uint
op_star
)paren
id|HIOX_CSR4_ADDR
op_or_assign
id|HIOX_CSR4_AUDCLKHI
suffix:semicolon
id|i
op_rshift_assign
l_int|1
suffix:semicolon
op_star
(paren
id|uint
op_star
)paren
id|HIOX_CSR4_ADDR
op_or_assign
(paren
id|i
op_amp
id|HIOX_CSR4_AUDCLKSEL
)paren
suffix:semicolon
id|expand_bal
op_assign
op_minus
id|sound.soft.speed
suffix:semicolon
)brace
DECL|function|CS_SetFormat
r_static
r_int
id|CS_SetFormat
c_func
(paren
r_int
id|format
)paren
(brace
r_int
id|size
suffix:semicolon
r_switch
c_cond
(paren
id|format
)paren
(brace
r_case
id|AFMT_QUERY
suffix:colon
r_return
id|sound.soft.format
suffix:semicolon
r_case
id|AFMT_MU_LAW
suffix:colon
r_case
id|AFMT_A_LAW
suffix:colon
r_case
id|AFMT_U8
suffix:colon
r_case
id|AFMT_S8
suffix:colon
id|size
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_S16_BE
suffix:colon
r_case
id|AFMT_U16_BE
suffix:colon
r_case
id|AFMT_S16_LE
suffix:colon
r_case
id|AFMT_U16_LE
suffix:colon
id|size
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* :-) */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dmasound: unknown format 0x%x, using AFMT_U8&bslash;n&quot;
comma
id|format
)paren
suffix:semicolon
id|size
op_assign
l_int|8
suffix:semicolon
id|format
op_assign
id|AFMT_U8
suffix:semicolon
)brace
id|sound.soft.format
op_assign
id|format
suffix:semicolon
id|sound.soft.size
op_assign
id|size
suffix:semicolon
r_if
c_cond
(paren
id|sound.minDev
op_eq
id|SND_DEV_DSP
)paren
(brace
id|sound.dsp.format
op_assign
id|format
suffix:semicolon
id|sound.dsp.size
op_assign
id|size
suffix:semicolon
)brace
id|CS_Init
c_func
(paren
)paren
suffix:semicolon
r_return
id|format
suffix:semicolon
)brace
multiline_comment|/* Volume is the amount of attenuation we tell the codec to impose&n; * on the outputs.  There are 32 levels, with 0 the &quot;loudest&quot;.&n; */
DECL|macro|CS_VOLUME_TO_MASK
mdefine_line|#define CS_VOLUME_TO_MASK(x)&t;(31 - ((((x) - 1) * 31) / 99))
DECL|macro|CS_MASK_TO_VOLUME
mdefine_line|#define CS_MASK_TO_VOLUME(y)&t;(100 - ((y) * 99 / 31))
DECL|function|cs_get_volume
r_static
r_int
id|cs_get_volume
c_func
(paren
id|uint
id|reg
)paren
(brace
r_int
id|volume
suffix:semicolon
id|volume
op_assign
id|CS_MASK_TO_VOLUME
c_func
(paren
id|CS_LATTEN_GET
c_func
(paren
id|reg
)paren
)paren
suffix:semicolon
id|volume
op_or_assign
id|CS_MASK_TO_VOLUME
c_func
(paren
id|CS_RATTEN_GET
c_func
(paren
id|reg
)paren
)paren
op_lshift
l_int|8
suffix:semicolon
r_return
id|volume
suffix:semicolon
)brace
DECL|function|cs_volume_setter
r_static
r_int
id|cs_volume_setter
c_func
(paren
r_int
id|volume
comma
r_int
id|mute
)paren
(brace
id|uint
id|tempctl
suffix:semicolon
r_if
c_cond
(paren
id|mute
op_logical_and
id|volume
op_eq
l_int|0
)paren
(brace
id|tempctl
op_assign
id|cs4218_control
op_or
id|CS_MUTE
suffix:semicolon
)brace
r_else
(brace
id|tempctl
op_assign
id|cs4218_control
op_amp
op_complement
id|CS_MUTE
suffix:semicolon
id|tempctl
op_assign
id|tempctl
op_amp
op_complement
(paren
id|CS_LATTEN
op_or
id|CS_RATTEN
)paren
suffix:semicolon
id|tempctl
op_or_assign
id|CS_LATTEN_SET
c_func
(paren
id|CS_VOLUME_TO_MASK
c_func
(paren
id|volume
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|tempctl
op_or_assign
id|CS_RATTEN_SET
c_func
(paren
id|CS_VOLUME_TO_MASK
c_func
(paren
(paren
id|volume
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|volume
op_assign
id|cs_get_volume
c_func
(paren
id|tempctl
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tempctl
op_ne
id|cs4218_control
)paren
(brace
id|cs4218_ctl_write
c_func
(paren
id|tempctl
)paren
suffix:semicolon
)brace
r_return
id|volume
suffix:semicolon
)brace
multiline_comment|/* Gain has 16 steps from 0 to 15.  These are in 1.5dB increments from&n; * 0 (no gain) to 22.5 dB.&n; */
DECL|macro|CS_RECLEVEL_TO_GAIN
mdefine_line|#define CS_RECLEVEL_TO_GAIN(v) &bslash;&n;&t;((v) &lt; 0 ? 0 : (v) &gt; 100 ? 15 : (v) * 3 / 20)
DECL|macro|CS_GAIN_TO_RECLEVEL
mdefine_line|#define CS_GAIN_TO_RECLEVEL(v) (((v) * 20 + 2) / 3)
DECL|function|cs_get_gain
r_static
r_int
id|cs_get_gain
c_func
(paren
id|uint
id|reg
)paren
(brace
r_int
id|gain
suffix:semicolon
id|gain
op_assign
id|CS_GAIN_TO_RECLEVEL
c_func
(paren
id|CS_LGAIN_GET
c_func
(paren
id|reg
)paren
)paren
suffix:semicolon
id|gain
op_or_assign
id|CS_GAIN_TO_RECLEVEL
c_func
(paren
id|CS_RGAIN_GET
c_func
(paren
id|reg
)paren
)paren
op_lshift
l_int|8
suffix:semicolon
r_return
id|gain
suffix:semicolon
)brace
DECL|function|cs_set_gain
r_static
r_int
id|cs_set_gain
c_func
(paren
r_int
id|gain
)paren
(brace
id|uint
id|tempctl
suffix:semicolon
id|tempctl
op_assign
id|cs4218_control
op_amp
op_complement
(paren
id|CS_LGAIN
op_or
id|CS_RGAIN
)paren
suffix:semicolon
id|tempctl
op_or_assign
id|CS_LGAIN_SET
c_func
(paren
id|CS_RECLEVEL_TO_GAIN
c_func
(paren
id|gain
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|tempctl
op_or_assign
id|CS_RGAIN_SET
c_func
(paren
id|CS_RECLEVEL_TO_GAIN
c_func
(paren
(paren
id|gain
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|gain
op_assign
id|cs_get_gain
c_func
(paren
id|tempctl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tempctl
op_ne
id|cs4218_control
)paren
(brace
id|cs4218_ctl_write
c_func
(paren
id|tempctl
)paren
suffix:semicolon
)brace
r_return
id|gain
suffix:semicolon
)brace
DECL|function|CS_SetVolume
r_static
r_int
id|CS_SetVolume
c_func
(paren
r_int
id|volume
)paren
(brace
r_return
id|cs_volume_setter
c_func
(paren
id|volume
comma
id|CS_MUTE
)paren
suffix:semicolon
)brace
DECL|function|CS_Play
r_static
r_void
id|CS_Play
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|count
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_volatile
id|cbd_t
op_star
id|bdp
suffix:semicolon
r_volatile
id|cpm8xx_t
op_star
id|cp
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|awacs_beep_state
)paren
(brace
multiline_comment|/* sound takes precedence over beeps */
id|out_le32
c_func
(paren
op_amp
id|awacs_txdma-&gt;control
comma
(paren
id|RUN
op_or
id|PAUSE
op_or
id|FLUSH
op_or
id|WAKE
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|awacs-&gt;control
comma
(paren
id|in_le32
c_func
(paren
op_amp
id|awacs-&gt;control
)paren
op_amp
op_complement
l_int|0x1f00
)paren
op_or
(paren
id|awacs_rate_index
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|awacs-&gt;byteswap
comma
id|sound.hard.format
op_ne
id|AFMT_S16_BE
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|awacs_txdma-&gt;cmdptr
comma
id|virt_to_bus
c_func
(paren
op_amp
(paren
id|awacs_tx_cmds
(braket
(paren
id|sq.front
op_plus
id|sq.active
)paren
op_mod
id|sq.max_count
)braket
)paren
)paren
)paren
suffix:semicolon
id|beep_playing
op_assign
l_int|0
suffix:semicolon
id|awacs_beep_state
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
id|i
op_assign
id|sq.front
op_plus
id|sq.active
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|sq.max_count
)paren
id|i
op_sub_assign
id|sq.max_count
suffix:semicolon
r_while
c_loop
(paren
id|sq.active
OL
l_int|2
op_logical_and
id|sq.active
OL
id|sq.count
)paren
(brace
id|count
op_assign
(paren
id|sq.count
op_eq
id|sq.active
op_plus
l_int|1
)paren
ques
c_cond
id|sq.rear_size
suffix:colon
id|sq.block_size
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
id|sq.block_size
op_logical_and
op_logical_neg
id|sq.syncing
)paren
multiline_comment|/* last block not yet filled, and we&squot;re not syncing. */
r_break
suffix:semicolon
id|bdp
op_assign
op_amp
id|tx_base
(braket
id|i
)braket
suffix:semicolon
id|bdp-&gt;cbd_datlen
op_assign
id|count
suffix:semicolon
id|flush_dcache_range
c_func
(paren
(paren
id|ulong
)paren
id|sound_buffers
(braket
id|i
)braket
comma
(paren
id|ulong
)paren
(paren
id|sound_buffers
(braket
id|i
)braket
op_plus
id|count
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|i
op_ge
id|sq.max_count
)paren
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sq.active
op_eq
l_int|0
)paren
(brace
multiline_comment|/* The SMC does not load its fifo until the first&n;&t;&t;&t; * TDM frame pulse, so the transmit data gets shifted&n;&t;&t;&t; * by one word.  To compensate for this, we incorrectly&n;&t;&t;&t; * transmit the first buffer and shorten it by one&n;&t;&t;&t; * word.  Subsequent buffers are then aligned properly.&n;&t;&t;&t; */
id|bdp-&gt;cbd_datlen
op_sub_assign
l_int|2
suffix:semicolon
multiline_comment|/* Start up the SMC Transmitter.&n;&t;&t;&t;*/
id|cp
op_assign
id|cpmp
suffix:semicolon
id|cp-&gt;cp_smc
(braket
l_int|1
)braket
dot
id|smc_smcmr
op_or_assign
id|SMCMR_TEN
suffix:semicolon
id|cp-&gt;cp_cpcr
op_assign
id|mk_cr_cmd
c_func
(paren
id|CPM_CR_CH_SMC2
comma
id|CPM_CR_RESTART_TX
)paren
op_or
id|CPM_CR_FLG
suffix:semicolon
r_while
c_loop
(paren
id|cp-&gt;cp_cpcr
op_amp
id|CPM_CR_FLG
)paren
suffix:semicolon
)brace
multiline_comment|/* Buffer is ready now.&n;&t;&t;*/
id|bdp-&gt;cbd_sc
op_or_assign
id|BD_SC_READY
suffix:semicolon
op_increment
id|sq.active
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|CS_Record
r_static
r_void
id|CS_Record
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_volatile
id|smc_t
op_star
id|sp
suffix:semicolon
r_if
c_cond
(paren
id|read_sq.active
)paren
r_return
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* This is all we have to do......Just start it up.&n;&t;*/
id|sp
op_assign
op_amp
id|cpmp-&gt;cp_smc
(braket
l_int|1
)braket
suffix:semicolon
id|sp-&gt;smc_smcmr
op_or_assign
id|SMCMR_REN
suffix:semicolon
id|read_sq.active
op_assign
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|cs4218_tdm_tx_intr
id|cs4218_tdm_tx_intr
c_func
(paren
r_void
op_star
id|devid
)paren
(brace
r_int
id|i
op_assign
id|sq.front
suffix:semicolon
r_volatile
id|cbd_t
op_star
id|bdp
suffix:semicolon
r_while
c_loop
(paren
id|sq.active
OG
l_int|0
)paren
(brace
id|bdp
op_assign
op_amp
id|tx_base
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|bdp-&gt;cbd_sc
op_amp
id|BD_SC_READY
)paren
r_break
suffix:semicolon
multiline_comment|/* this frame is still going */
op_decrement
id|sq.count
suffix:semicolon
op_decrement
id|sq.active
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|i
op_ge
id|sq.max_count
)paren
id|i
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ne
id|sq.front
)paren
id|WAKE_UP
c_func
(paren
id|sq.action_queue
)paren
suffix:semicolon
id|sq.front
op_assign
id|i
suffix:semicolon
id|CS_Play
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sq.active
)paren
id|WAKE_UP
c_func
(paren
id|sq.sync_queue
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|cs4218_tdm_rx_intr
id|cs4218_tdm_rx_intr
c_func
(paren
r_void
op_star
id|devid
)paren
(brace
multiline_comment|/* We want to blow &squot;em off when shutting down.&n;&t;*/
r_if
c_cond
(paren
id|read_sq.active
op_eq
l_int|0
)paren
r_return
suffix:semicolon
multiline_comment|/* Check multiple buffers in case we were held off from&n;&t; * interrupt processing for a long time.  Geeze, I really hope&n;&t; * this doesn&squot;t happen.&n;&t; */
r_while
c_loop
(paren
(paren
id|rx_base
(braket
id|read_sq.rear
)braket
dot
id|cbd_sc
op_amp
id|BD_SC_EMPTY
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Invalidate the data cache range for this buffer.&n;&t;&t;*/
id|invalidate_dcache_range
c_func
(paren
(paren
id|uint
)paren
(paren
id|sound_read_buffers
(braket
id|read_sq.rear
)braket
)paren
comma
(paren
id|uint
)paren
(paren
id|sound_read_buffers
(braket
id|read_sq.rear
)braket
op_plus
id|read_sq.block_size
)paren
)paren
suffix:semicolon
multiline_comment|/* Make buffer available again and move on.&n;&t;&t;*/
id|rx_base
(braket
id|read_sq.rear
)braket
dot
id|cbd_sc
op_or_assign
id|BD_SC_EMPTY
suffix:semicolon
id|read_sq.rear
op_increment
suffix:semicolon
multiline_comment|/* Wrap the buffer ring.&n;&t;&t;*/
r_if
c_cond
(paren
id|read_sq.rear
op_ge
id|read_sq.max_active
)paren
id|read_sq.rear
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* If we have caught up to the front buffer, bump it.&n;&t;&t; * This will cause weird (but not fatal) results if the&n;&t;&t; * read loop is currently using this buffer.  The user is&n;&t;&t; * behind in this case anyway, so weird things are going&n;&t;&t; * to happen.&n;&t;&t; */
r_if
c_cond
(paren
id|read_sq.rear
op_eq
id|read_sq.front
)paren
(brace
id|read_sq.front
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|read_sq.front
op_ge
id|read_sq.max_active
)paren
id|read_sq.front
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|WAKE_UP
c_func
(paren
id|read_sq.action_queue
)paren
suffix:semicolon
)brace
DECL|function|cs_nosound
r_static
r_void
id|cs_nosound
c_func
(paren
r_int
r_int
id|xx
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|beep_playing
)paren
(brace
macro_line|#if 0
id|st_le16
c_func
(paren
op_amp
id|beep_dbdma_cmd-&gt;command
comma
id|DBDMA_STOP
)paren
suffix:semicolon
macro_line|#endif
id|beep_playing
op_assign
l_int|0
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|variable|beep_timer
r_static
r_struct
id|timer_list
id|beep_timer
op_assign
id|TIMER_INITIALIZER
c_func
(paren
id|cs_nosound
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
suffix:semicolon
r_static
r_void
id|cs_mksound
c_func
(paren
r_int
r_int
id|hz
comma
r_int
r_int
id|ticks
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|beep_speed
op_assign
id|BEEP_SPEED
suffix:semicolon
r_int
id|srate
op_assign
id|cs4218_freqs
(braket
id|beep_speed
)braket
suffix:semicolon
r_int
id|period
comma
id|ncycles
comma
id|nsamples
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|f
suffix:semicolon
r_int
op_star
id|p
suffix:semicolon
r_static
r_int
id|beep_hz_cache
suffix:semicolon
r_static
r_int
id|beep_nsamples_cache
suffix:semicolon
r_static
r_int
id|beep_volume_cache
suffix:semicolon
r_if
c_cond
(paren
id|hz
op_le
id|srate
op_div
id|BEEP_BUFLEN
op_logical_or
id|hz
OG
id|srate
op_div
l_int|2
)paren
(brace
macro_line|#if 1
multiline_comment|/* this is a hack for broken X server code */
id|hz
op_assign
l_int|750
suffix:semicolon
id|ticks
op_assign
l_int|12
suffix:semicolon
macro_line|#else
multiline_comment|/* cancel beep currently playing */
id|awacs_nosound
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
macro_line|#endif
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|beep_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ticks
)paren
(brace
id|beep_timer.expires
op_assign
id|jiffies
op_plus
id|ticks
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|beep_timer
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|beep_playing
op_logical_or
id|sq.active
op_logical_or
id|beep_buf
op_eq
l_int|NULL
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* too hard, sorry :-( */
)brace
id|beep_playing
op_assign
l_int|1
suffix:semicolon
macro_line|#if 0
id|st_le16
c_func
(paren
op_amp
id|beep_dbdma_cmd-&gt;command
comma
id|OUTPUT_MORE
op_plus
id|BR_ALWAYS
)paren
suffix:semicolon
macro_line|#endif
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hz
op_eq
id|beep_hz_cache
op_logical_and
id|beep_volume
op_eq
id|beep_volume_cache
)paren
(brace
id|nsamples
op_assign
id|beep_nsamples_cache
suffix:semicolon
)brace
r_else
(brace
id|period
op_assign
id|srate
op_star
l_int|256
op_div
id|hz
suffix:semicolon
multiline_comment|/* fixed point */
id|ncycles
op_assign
id|BEEP_BUFLEN
op_star
l_int|256
op_div
id|period
suffix:semicolon
id|nsamples
op_assign
(paren
id|period
op_star
id|ncycles
)paren
op_rshift
l_int|8
suffix:semicolon
id|f
op_assign
id|ncycles
op_star
l_int|65536
op_div
id|nsamples
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
id|p
op_assign
id|beep_buf
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nsamples
suffix:semicolon
op_increment
id|i
comma
id|p
op_add_assign
l_int|2
)paren
(brace
id|p
(braket
l_int|0
)braket
op_assign
id|p
(braket
l_int|1
)braket
op_assign
id|beep_wform
(braket
id|j
op_rshift
l_int|8
)braket
op_star
id|beep_volume
suffix:semicolon
id|j
op_assign
(paren
id|j
op_plus
id|f
)paren
op_amp
l_int|0xffff
suffix:semicolon
)brace
id|beep_hz_cache
op_assign
id|hz
suffix:semicolon
id|beep_volume_cache
op_assign
id|beep_volume
suffix:semicolon
id|beep_nsamples_cache
op_assign
id|nsamples
suffix:semicolon
)brace
macro_line|#if 0
id|st_le16
c_func
(paren
op_amp
id|beep_dbdma_cmd-&gt;req_count
comma
id|nsamples
op_star
l_int|4
)paren
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|beep_dbdma_cmd-&gt;xfer_status
comma
l_int|0
)paren
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|beep_dbdma_cmd-&gt;cmd_dep
comma
id|virt_to_bus
c_func
(paren
id|beep_dbdma_cmd
)paren
)paren
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|beep_dbdma_cmd-&gt;phy_addr
comma
id|virt_to_bus
c_func
(paren
id|beep_buf
)paren
)paren
suffix:semicolon
id|awacs_beep_state
op_assign
l_int|1
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|beep_playing
)paren
(brace
multiline_comment|/* i.e. haven&squot;t been terminated already */
id|out_le32
c_func
(paren
op_amp
id|awacs_txdma-&gt;control
comma
(paren
id|RUN
op_or
id|WAKE
op_or
id|FLUSH
op_or
id|PAUSE
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|awacs-&gt;control
comma
(paren
id|in_le32
c_func
(paren
op_amp
id|awacs-&gt;control
)paren
op_amp
op_complement
l_int|0x1f00
)paren
op_or
(paren
id|beep_speed
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|awacs-&gt;byteswap
comma
l_int|0
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|awacs_txdma-&gt;cmdptr
comma
id|virt_to_bus
c_func
(paren
id|beep_dbdma_cmd
)paren
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|awacs_txdma-&gt;control
comma
id|RUN
op_or
(paren
id|RUN
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
id|CS_open
c_func
(paren
r_void
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
)brace
r_static
r_void
id|CS_release
c_func
(paren
r_void
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
r_static
id|MACHINE
id|mach_cs4218
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;HIOX CS4218&quot;
comma
dot
id|name2
op_assign
l_string|&quot;Built-in Sound&quot;
comma
dot
id|open
op_assign
id|CS_open
comma
dot
id|release
op_assign
id|CS_release
comma
dot
id|dma_alloc
op_assign
id|CS_Alloc
comma
dot
id|dma_free
op_assign
id|CS_Free
comma
dot
id|irqinit
op_assign
id|CS_IrqInit
comma
macro_line|#ifdef MODULE
dot
id|irqcleanup
op_assign
id|CS_IrqCleanup
comma
macro_line|#endif /* MODULE */
dot
id|init
op_assign
id|CS_Init
comma
dot
id|silence
op_assign
id|CS_Silence
comma
dot
id|setFormat
op_assign
id|CS_SetFormat
comma
dot
id|setVolume
op_assign
id|CS_SetVolume
comma
dot
id|play
op_assign
id|CS_Play
)brace
suffix:semicolon
multiline_comment|/*** Mid level stuff *********************************************************/
r_static
r_void
id|sound_silence
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* update hardware settings one more */
(paren
op_star
id|sound.mach.init
)paren
(paren
)paren
suffix:semicolon
(paren
op_star
id|sound.mach.silence
)paren
(paren
)paren
suffix:semicolon
)brace
r_static
r_void
id|sound_init
c_func
(paren
r_void
)paren
(brace
(paren
op_star
id|sound.mach.init
)paren
(paren
)paren
suffix:semicolon
)brace
r_static
r_int
id|sound_set_format
c_func
(paren
r_int
id|format
)paren
(brace
r_return
(paren
op_star
id|sound.mach.setFormat
)paren
(paren
id|format
)paren
suffix:semicolon
)brace
r_static
r_int
id|sound_set_speed
c_func
(paren
r_int
id|speed
)paren
(brace
r_if
c_cond
(paren
id|speed
OL
l_int|0
)paren
r_return
id|sound.soft.speed
suffix:semicolon
id|sound.soft.speed
op_assign
id|speed
suffix:semicolon
(paren
op_star
id|sound.mach.init
)paren
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sound.minDev
op_eq
id|SND_DEV_DSP
)paren
id|sound.dsp.speed
op_assign
id|sound.soft.speed
suffix:semicolon
r_return
id|sound.soft.speed
suffix:semicolon
)brace
r_static
r_int
id|sound_set_stereo
c_func
(paren
r_int
id|stereo
)paren
(brace
r_if
c_cond
(paren
id|stereo
OL
l_int|0
)paren
r_return
id|sound.soft.stereo
suffix:semicolon
id|stereo
op_assign
op_logical_neg
op_logical_neg
id|stereo
suffix:semicolon
multiline_comment|/* should be 0 or 1 now */
id|sound.soft.stereo
op_assign
id|stereo
suffix:semicolon
r_if
c_cond
(paren
id|sound.minDev
op_eq
id|SND_DEV_DSP
)paren
id|sound.dsp.stereo
op_assign
id|stereo
suffix:semicolon
(paren
op_star
id|sound.mach.init
)paren
(paren
)paren
suffix:semicolon
r_return
id|stereo
suffix:semicolon
)brace
r_static
r_int
id|sound_set_volume
c_func
(paren
r_int
id|volume
)paren
(brace
r_return
(paren
op_star
id|sound.mach.setVolume
)paren
(paren
id|volume
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
id|sound_copy_translate
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
(brace
id|ssize_t
(paren
op_star
id|ct_func
)paren
(paren
r_const
id|u_char
op_star
comma
r_int
comma
id|u_char
op_star
comma
id|ssize_t
op_star
comma
id|ssize_t
)paren
op_assign
l_int|NULL
suffix:semicolon
r_switch
c_cond
(paren
id|sound.soft.format
)paren
(brace
r_case
id|AFMT_MU_LAW
suffix:colon
id|ct_func
op_assign
id|sound.trans_write-&gt;ct_ulaw
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_A_LAW
suffix:colon
id|ct_func
op_assign
id|sound.trans_write-&gt;ct_alaw
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_S8
suffix:colon
id|ct_func
op_assign
id|sound.trans_write-&gt;ct_s8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_U8
suffix:colon
id|ct_func
op_assign
id|sound.trans_write-&gt;ct_u8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_S16_BE
suffix:colon
id|ct_func
op_assign
id|sound.trans_write-&gt;ct_s16be
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_U16_BE
suffix:colon
id|ct_func
op_assign
id|sound.trans_write-&gt;ct_u16be
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_S16_LE
suffix:colon
id|ct_func
op_assign
id|sound.trans_write-&gt;ct_s16le
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_U16_LE
suffix:colon
id|ct_func
op_assign
id|sound.trans_write-&gt;ct_u16le
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ct_func
)paren
r_return
id|ct_func
c_func
(paren
id|userPtr
comma
id|userCount
comma
id|frame
comma
id|frameUsed
comma
id|frameLeft
)paren
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
)brace
r_static
id|ssize_t
id|sound_copy_translate_read
c_func
(paren
r_const
id|u_char
op_star
id|userPtr
comma
r_int
id|userCount
comma
id|u_char
id|frame
(braket
)braket
comma
id|ssize_t
op_star
id|frameUsed
comma
id|ssize_t
id|frameLeft
)paren
(brace
id|ssize_t
(paren
op_star
id|ct_func
)paren
(paren
r_const
id|u_char
op_star
comma
r_int
comma
id|u_char
op_star
comma
id|ssize_t
op_star
comma
id|ssize_t
)paren
op_assign
l_int|NULL
suffix:semicolon
r_switch
c_cond
(paren
id|sound.soft.format
)paren
(brace
r_case
id|AFMT_MU_LAW
suffix:colon
id|ct_func
op_assign
id|sound.trans_read-&gt;ct_ulaw
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_A_LAW
suffix:colon
id|ct_func
op_assign
id|sound.trans_read-&gt;ct_alaw
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_S8
suffix:colon
id|ct_func
op_assign
id|sound.trans_read-&gt;ct_s8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_U8
suffix:colon
id|ct_func
op_assign
id|sound.trans_read-&gt;ct_u8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_S16_BE
suffix:colon
id|ct_func
op_assign
id|sound.trans_read-&gt;ct_s16be
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_U16_BE
suffix:colon
id|ct_func
op_assign
id|sound.trans_read-&gt;ct_u16be
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_S16_LE
suffix:colon
id|ct_func
op_assign
id|sound.trans_read-&gt;ct_s16le
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_U16_LE
suffix:colon
id|ct_func
op_assign
id|sound.trans_read-&gt;ct_u16le
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ct_func
)paren
r_return
id|ct_func
c_func
(paren
id|userPtr
comma
id|userCount
comma
id|frame
comma
id|frameUsed
comma
id|frameLeft
)paren
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * /dev/mixer abstraction&n; */
r_static
r_int
id|mixer_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|mixer.busy
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|mixer_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|mixer.busy
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|mixer_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
id|u_int
id|cmd
comma
id|u_long
id|arg
)paren
(brace
r_int
id|data
suffix:semicolon
id|uint
id|tmpcs
suffix:semicolon
r_if
c_cond
(paren
id|_SIOC_DIR
c_func
(paren
id|cmd
)paren
op_amp
id|_SIOC_WRITE
)paren
id|mixer.modify_counter
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|OSS_GETVERSION
)paren
r_return
id|IOCTL_OUT
c_func
(paren
id|arg
comma
id|SOUND_VERSION
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SOUND_MIXER_INFO
suffix:colon
(brace
id|mixer_info
id|info
suffix:semicolon
id|strncpy
c_func
(paren
id|info.id
comma
l_string|&quot;CS4218_TDM&quot;
comma
r_sizeof
(paren
id|info.id
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|info.name
comma
l_string|&quot;CS4218_TDM&quot;
comma
r_sizeof
(paren
id|info.name
)paren
)paren
suffix:semicolon
id|info.name
(braket
r_sizeof
(paren
id|info.name
)paren
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|info.modify_counter
op_assign
id|mixer.modify_counter
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_int
op_star
)paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|SOUND_MIXER_READ_DEVMASK
suffix:colon
id|data
op_assign
id|SOUND_MASK_VOLUME
op_or
id|SOUND_MASK_LINE
op_or
id|SOUND_MASK_MIC
op_or
id|SOUND_MASK_RECLEV
op_or
id|SOUND_MASK_ALTPCM
suffix:semicolon
r_return
id|IOCTL_OUT
c_func
(paren
id|arg
comma
id|data
)paren
suffix:semicolon
r_case
id|SOUND_MIXER_READ_RECMASK
suffix:colon
id|data
op_assign
id|SOUND_MASK_LINE
op_or
id|SOUND_MASK_MIC
suffix:semicolon
r_return
id|IOCTL_OUT
c_func
(paren
id|arg
comma
id|data
)paren
suffix:semicolon
r_case
id|SOUND_MIXER_READ_RECSRC
suffix:colon
r_if
c_cond
(paren
id|cs4218_control
op_amp
id|CS_DO1
)paren
id|data
op_assign
id|SOUND_MASK_LINE
suffix:semicolon
r_else
id|data
op_assign
id|SOUND_MASK_MIC
suffix:semicolon
r_return
id|IOCTL_OUT
c_func
(paren
id|arg
comma
id|data
)paren
suffix:semicolon
r_case
id|SOUND_MIXER_WRITE_RECSRC
suffix:colon
id|IOCTL_IN
c_func
(paren
id|arg
comma
id|data
)paren
suffix:semicolon
id|data
op_and_assign
(paren
id|SOUND_MASK_LINE
op_or
id|SOUND_MASK_MIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_amp
id|SOUND_MASK_LINE
)paren
id|tmpcs
op_assign
id|cs4218_control
op_or
(paren
id|CS_ISL
op_or
id|CS_ISR
op_or
id|CS_DO1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_amp
id|SOUND_MASK_MIC
)paren
id|tmpcs
op_assign
id|cs4218_control
op_amp
op_complement
(paren
id|CS_ISL
op_or
id|CS_ISR
op_or
id|CS_DO1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmpcs
op_ne
id|cs4218_control
)paren
id|cs4218_ctl_write
c_func
(paren
id|tmpcs
)paren
suffix:semicolon
r_return
id|IOCTL_OUT
c_func
(paren
id|arg
comma
id|data
)paren
suffix:semicolon
r_case
id|SOUND_MIXER_READ_STEREODEVS
suffix:colon
id|data
op_assign
id|SOUND_MASK_VOLUME
op_or
id|SOUND_MASK_RECLEV
suffix:semicolon
r_return
id|IOCTL_OUT
c_func
(paren
id|arg
comma
id|data
)paren
suffix:semicolon
r_case
id|SOUND_MIXER_READ_CAPS
suffix:colon
r_return
id|IOCTL_OUT
c_func
(paren
id|arg
comma
l_int|0
)paren
suffix:semicolon
r_case
id|SOUND_MIXER_READ_VOLUME
suffix:colon
id|data
op_assign
(paren
id|cs4218_control
op_amp
id|CS_MUTE
)paren
ques
c_cond
l_int|0
suffix:colon
id|cs_get_volume
c_func
(paren
id|cs4218_control
)paren
suffix:semicolon
r_return
id|IOCTL_OUT
c_func
(paren
id|arg
comma
id|data
)paren
suffix:semicolon
r_case
id|SOUND_MIXER_WRITE_VOLUME
suffix:colon
id|IOCTL_IN
c_func
(paren
id|arg
comma
id|data
)paren
suffix:semicolon
r_return
id|IOCTL_OUT
c_func
(paren
id|arg
comma
id|sound_set_volume
c_func
(paren
id|data
)paren
)paren
suffix:semicolon
r_case
id|SOUND_MIXER_WRITE_ALTPCM
suffix:colon
multiline_comment|/* really bell volume */
id|IOCTL_IN
c_func
(paren
id|arg
comma
id|data
)paren
suffix:semicolon
id|beep_volume
op_assign
id|data
op_amp
l_int|0xff
suffix:semicolon
multiline_comment|/* fall through */
r_case
id|SOUND_MIXER_READ_ALTPCM
suffix:colon
r_return
id|IOCTL_OUT
c_func
(paren
id|arg
comma
id|beep_volume
)paren
suffix:semicolon
r_case
id|SOUND_MIXER_WRITE_RECLEV
suffix:colon
id|IOCTL_IN
c_func
(paren
id|arg
comma
id|data
)paren
suffix:semicolon
id|data
op_assign
id|cs_set_gain
c_func
(paren
id|data
)paren
suffix:semicolon
r_return
id|IOCTL_OUT
c_func
(paren
id|arg
comma
id|data
)paren
suffix:semicolon
r_case
id|SOUND_MIXER_READ_RECLEV
suffix:colon
id|data
op_assign
id|cs_get_gain
c_func
(paren
id|cs4218_control
)paren
suffix:semicolon
r_return
id|IOCTL_OUT
c_func
(paren
id|arg
comma
id|data
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_static
r_struct
id|file_operations
id|mixer_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|llseek
op_assign
id|sound_lseek
comma
dot
id|ioctl
op_assign
id|mixer_ioctl
comma
dot
id|open
op_assign
id|mixer_open
comma
dot
id|release
op_assign
id|mixer_release
comma
)brace
suffix:semicolon
r_static
r_void
id|__init
id|mixer_init
c_func
(paren
r_void
)paren
(brace
id|mixer_unit
op_assign
id|register_sound_mixer
c_func
(paren
op_amp
id|mixer_fops
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mixer_unit
OL
l_int|0
)paren
r_return
suffix:semicolon
id|mixer.busy
op_assign
l_int|0
suffix:semicolon
id|sound.treble
op_assign
l_int|0
suffix:semicolon
id|sound.bass
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set Line input, no gain, no attenuation.&n;&t;*/
id|cs4218_control
op_assign
id|CS_ISL
op_or
id|CS_ISR
op_or
id|CS_DO1
suffix:semicolon
id|cs4218_control
op_or_assign
id|CS_LGAIN_SET
c_func
(paren
l_int|0
)paren
op_or
id|CS_RGAIN_SET
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|cs4218_control
op_or_assign
id|CS_LATTEN_SET
c_func
(paren
l_int|0
)paren
op_or
id|CS_RATTEN_SET
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|cs4218_ctl_write
c_func
(paren
id|cs4218_control
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Sound queue stuff, the heart of the driver&n; */
r_static
r_int
id|sq_allocate_buffers
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|sound_buffers
)paren
r_return
l_int|0
suffix:semicolon
id|sound_buffers
op_assign
id|kmalloc
(paren
id|numBufs
op_star
r_sizeof
(paren
r_char
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sound_buffers
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|numBufs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sound_buffers
(braket
id|i
)braket
op_assign
id|sound.mach.dma_alloc
(paren
id|bufSize
op_lshift
l_int|10
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sound_buffers
(braket
id|i
)braket
)paren
(brace
r_while
c_loop
(paren
id|i
op_decrement
)paren
id|sound.mach.dma_free
(paren
id|sound_buffers
(braket
id|i
)braket
comma
id|bufSize
op_lshift
l_int|10
)paren
suffix:semicolon
id|kfree
(paren
id|sound_buffers
)paren
suffix:semicolon
id|sound_buffers
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|sq_release_buffers
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|sound_buffers
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|numBufs
suffix:semicolon
id|i
op_increment
)paren
id|sound.mach.dma_free
(paren
id|sound_buffers
(braket
id|i
)braket
comma
id|bufSize
op_lshift
l_int|10
)paren
suffix:semicolon
id|kfree
(paren
id|sound_buffers
)paren
suffix:semicolon
id|sound_buffers
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_static
r_int
id|sq_allocate_read_buffers
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|sound_read_buffers
)paren
r_return
l_int|0
suffix:semicolon
id|sound_read_buffers
op_assign
id|kmalloc
c_func
(paren
id|numReadBufs
op_star
r_sizeof
(paren
r_char
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sound_read_buffers
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|numBufs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sound_read_buffers
(braket
id|i
)braket
op_assign
id|sound.mach.dma_alloc
(paren
id|readbufSize
op_lshift
l_int|10
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sound_read_buffers
(braket
id|i
)braket
)paren
(brace
r_while
c_loop
(paren
id|i
op_decrement
)paren
id|sound.mach.dma_free
(paren
id|sound_read_buffers
(braket
id|i
)braket
comma
id|readbufSize
op_lshift
l_int|10
)paren
suffix:semicolon
id|kfree
(paren
id|sound_read_buffers
)paren
suffix:semicolon
id|sound_read_buffers
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|sq_release_read_buffers
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|sound_read_buffers
)paren
(brace
id|cpmp-&gt;cp_smc
(braket
l_int|1
)braket
dot
id|smc_smcmr
op_and_assign
op_complement
id|SMCMR_REN
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|numReadBufs
suffix:semicolon
id|i
op_increment
)paren
id|sound.mach.dma_free
(paren
id|sound_read_buffers
(braket
id|i
)braket
comma
id|bufSize
op_lshift
l_int|10
)paren
suffix:semicolon
id|kfree
(paren
id|sound_read_buffers
)paren
suffix:semicolon
id|sound_read_buffers
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_static
r_void
id|sq_setup
c_func
(paren
r_int
id|numBufs
comma
r_int
id|bufSize
comma
r_char
op_star
op_star
id|write_buffers
)paren
(brace
r_int
id|i
suffix:semicolon
r_volatile
id|cbd_t
op_star
id|bdp
suffix:semicolon
r_volatile
id|cpm8xx_t
op_star
id|cp
suffix:semicolon
r_volatile
id|smc_t
op_star
id|sp
suffix:semicolon
multiline_comment|/* Make sure the SMC transmit is shut down.&n;&t;*/
id|cp
op_assign
id|cpmp
suffix:semicolon
id|sp
op_assign
op_amp
id|cpmp-&gt;cp_smc
(braket
l_int|1
)braket
suffix:semicolon
id|sp-&gt;smc_smcmr
op_and_assign
op_complement
id|SMCMR_TEN
suffix:semicolon
id|sq.max_count
op_assign
id|numBufs
suffix:semicolon
id|sq.max_active
op_assign
id|numBufs
suffix:semicolon
id|sq.block_size
op_assign
id|bufSize
suffix:semicolon
id|sq.buffers
op_assign
id|write_buffers
suffix:semicolon
id|sq.front
op_assign
id|sq.count
op_assign
l_int|0
suffix:semicolon
id|sq.rear
op_assign
op_minus
l_int|1
suffix:semicolon
id|sq.syncing
op_assign
l_int|0
suffix:semicolon
id|sq.active
op_assign
l_int|0
suffix:semicolon
id|bdp
op_assign
id|tx_base
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|numBufs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|bdp-&gt;cbd_bufaddr
op_assign
id|virt_to_bus
c_func
(paren
id|write_buffers
(braket
id|i
)braket
)paren
suffix:semicolon
id|bdp
op_increment
suffix:semicolon
)brace
multiline_comment|/* This causes the SMC to sync up with the first buffer again.&n;&t;*/
id|cp-&gt;cp_cpcr
op_assign
id|mk_cr_cmd
c_func
(paren
id|CPM_CR_CH_SMC2
comma
id|CPM_CR_INIT_TX
)paren
op_or
id|CPM_CR_FLG
suffix:semicolon
r_while
c_loop
(paren
id|cp-&gt;cp_cpcr
op_amp
id|CPM_CR_FLG
)paren
suffix:semicolon
)brace
r_static
r_void
id|read_sq_setup
c_func
(paren
r_int
id|numBufs
comma
r_int
id|bufSize
comma
r_char
op_star
op_star
id|read_buffers
)paren
(brace
r_int
id|i
suffix:semicolon
r_volatile
id|cbd_t
op_star
id|bdp
suffix:semicolon
r_volatile
id|cpm8xx_t
op_star
id|cp
suffix:semicolon
r_volatile
id|smc_t
op_star
id|sp
suffix:semicolon
multiline_comment|/* Make sure the SMC receive is shut down.&n;&t;*/
id|cp
op_assign
id|cpmp
suffix:semicolon
id|sp
op_assign
op_amp
id|cpmp-&gt;cp_smc
(braket
l_int|1
)braket
suffix:semicolon
id|sp-&gt;smc_smcmr
op_and_assign
op_complement
id|SMCMR_REN
suffix:semicolon
id|read_sq.max_count
op_assign
id|numBufs
suffix:semicolon
id|read_sq.max_active
op_assign
id|numBufs
suffix:semicolon
id|read_sq.block_size
op_assign
id|bufSize
suffix:semicolon
id|read_sq.buffers
op_assign
id|read_buffers
suffix:semicolon
id|read_sq.front
op_assign
id|read_sq.count
op_assign
l_int|0
suffix:semicolon
id|read_sq.rear
op_assign
l_int|0
suffix:semicolon
id|read_sq.rear_size
op_assign
l_int|0
suffix:semicolon
id|read_sq.syncing
op_assign
l_int|0
suffix:semicolon
id|read_sq.active
op_assign
l_int|0
suffix:semicolon
id|bdp
op_assign
id|rx_base
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|numReadBufs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|bdp-&gt;cbd_bufaddr
op_assign
id|virt_to_bus
c_func
(paren
id|read_buffers
(braket
id|i
)braket
)paren
suffix:semicolon
id|bdp-&gt;cbd_datlen
op_assign
id|read_sq.block_size
suffix:semicolon
id|bdp
op_increment
suffix:semicolon
)brace
multiline_comment|/* This causes the SMC to sync up with the first buffer again.&n;&t;*/
id|cp-&gt;cp_cpcr
op_assign
id|mk_cr_cmd
c_func
(paren
id|CPM_CR_CH_SMC2
comma
id|CPM_CR_INIT_RX
)paren
op_or
id|CPM_CR_FLG
suffix:semicolon
r_while
c_loop
(paren
id|cp-&gt;cp_cpcr
op_amp
id|CPM_CR_FLG
)paren
suffix:semicolon
)brace
r_static
r_void
id|sq_play
c_func
(paren
r_void
)paren
(brace
(paren
op_star
id|sound.mach.play
)paren
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* ++TeSche: radically changed this one too */
r_static
id|ssize_t
id|sq_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|src
comma
r_int
id|uLeft
comma
id|loff_t
op_star
id|ppos
)paren
(brace
id|ssize_t
id|uWritten
op_assign
l_int|0
suffix:semicolon
id|u_char
op_star
id|dest
suffix:semicolon
id|ssize_t
id|uUsed
comma
id|bUsed
comma
id|bLeft
suffix:semicolon
multiline_comment|/* ++TeSche: Is something like this necessary?&n;&t; * Hey, that&squot;s an honest question! Or does any other part of the&n;&t; * filesystem already checks this situation? I really don&squot;t know.&n;&t; */
r_if
c_cond
(paren
id|uLeft
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* The interrupt doesn&squot;t start to play the last, incomplete frame.&n;&t; * Thus we can append to it without disabling the interrupts! (Note&n;&t; * also that sq.rear isn&squot;t affected by the interrupt.)&n;&t; */
r_if
c_cond
(paren
id|sq.count
OG
l_int|0
op_logical_and
(paren
id|bLeft
op_assign
id|sq.block_size
op_minus
id|sq.rear_size
)paren
OG
l_int|0
)paren
(brace
id|dest
op_assign
id|sq_block_address
c_func
(paren
id|sq.rear
)paren
suffix:semicolon
id|bUsed
op_assign
id|sq.rear_size
suffix:semicolon
id|uUsed
op_assign
id|sound_copy_translate
c_func
(paren
id|src
comma
id|uLeft
comma
id|dest
comma
op_amp
id|bUsed
comma
id|bLeft
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uUsed
op_le
l_int|0
)paren
r_return
id|uUsed
suffix:semicolon
id|src
op_add_assign
id|uUsed
suffix:semicolon
id|uWritten
op_add_assign
id|uUsed
suffix:semicolon
id|uLeft
op_sub_assign
id|uUsed
suffix:semicolon
id|sq.rear_size
op_assign
id|bUsed
suffix:semicolon
)brace
r_do
(brace
r_while
c_loop
(paren
id|sq.count
op_eq
id|sq.max_active
)paren
(brace
id|sq_play
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|NON_BLOCKING
c_func
(paren
id|sq.open_mode
)paren
)paren
r_return
id|uWritten
OG
l_int|0
ques
c_cond
id|uWritten
suffix:colon
op_minus
id|EAGAIN
suffix:semicolon
id|SLEEP
c_func
(paren
id|sq.action_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SIGNAL_RECEIVED
)paren
r_return
id|uWritten
OG
l_int|0
ques
c_cond
id|uWritten
suffix:colon
op_minus
id|EINTR
suffix:semicolon
)brace
multiline_comment|/* Here, we can avoid disabling the interrupt by first&n;&t;&t; * copying and translating the data, and then updating&n;&t;&t; * the sq variables. Until this is done, the interrupt&n;&t;&t; * won&squot;t see the new frame and we can work on it&n;&t;&t; * undisturbed.&n;&t;&t; */
id|dest
op_assign
id|sq_block_address
c_func
(paren
(paren
id|sq.rear
op_plus
l_int|1
)paren
op_mod
id|sq.max_count
)paren
suffix:semicolon
id|bUsed
op_assign
l_int|0
suffix:semicolon
id|bLeft
op_assign
id|sq.block_size
suffix:semicolon
id|uUsed
op_assign
id|sound_copy_translate
c_func
(paren
id|src
comma
id|uLeft
comma
id|dest
comma
op_amp
id|bUsed
comma
id|bLeft
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uUsed
op_le
l_int|0
)paren
r_break
suffix:semicolon
id|src
op_add_assign
id|uUsed
suffix:semicolon
id|uWritten
op_add_assign
id|uUsed
suffix:semicolon
id|uLeft
op_sub_assign
id|uUsed
suffix:semicolon
r_if
c_cond
(paren
id|bUsed
)paren
(brace
id|sq.rear
op_assign
(paren
id|sq.rear
op_plus
l_int|1
)paren
op_mod
id|sq.max_count
suffix:semicolon
id|sq.rear_size
op_assign
id|bUsed
suffix:semicolon
id|sq.count
op_increment
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|bUsed
)paren
suffix:semicolon
multiline_comment|/* uUsed may have been 0 */
id|sq_play
c_func
(paren
)paren
suffix:semicolon
r_return
id|uUsed
OL
l_int|0
ques
c_cond
id|uUsed
suffix:colon
id|uWritten
suffix:semicolon
)brace
multiline_comment|/***********/
multiline_comment|/* Here is how the values are used for reading.&n; * The value &squot;active&squot; simply indicates the DMA is running.  This is&n; * done so the driver semantics are DMA starts when the first read is&n; * posted.  The value &squot;front&squot; indicates the buffer we should next&n; * send to the user.  The value &squot;rear&squot; indicates the buffer the DMA is&n; * currently filling.  When &squot;front&squot; == &squot;rear&squot; the buffer &quot;ring&quot; is&n; * empty (we always have an empty available).  The &squot;rear_size&squot; is used&n; * to track partial offsets into the current buffer.  Right now, I just keep&n; * The DMA running.  If the reader can&squot;t keep up, the interrupt tosses&n; * the oldest buffer.  We could also shut down the DMA in this case.&n; */
r_static
id|ssize_t
id|sq_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|dst
comma
r_int
id|uLeft
comma
id|loff_t
op_star
id|ppos
)paren
(brace
id|ssize_t
id|uRead
comma
id|bLeft
comma
id|bUsed
comma
id|uUsed
suffix:semicolon
r_if
c_cond
(paren
id|uLeft
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|read_sq.active
)paren
id|CS_Record
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Kick off the record process. */
id|uRead
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Move what the user requests, depending upon other options.&n;&t;*/
r_while
c_loop
(paren
id|uLeft
OG
l_int|0
)paren
(brace
multiline_comment|/* When front == rear, the DMA is not done yet.&n;&t;&t;*/
r_while
c_loop
(paren
id|read_sq.front
op_eq
id|read_sq.rear
)paren
(brace
r_if
c_cond
(paren
id|NON_BLOCKING
c_func
(paren
id|read_sq.open_mode
)paren
)paren
(brace
r_return
id|uRead
OG
l_int|0
ques
c_cond
id|uRead
suffix:colon
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|SLEEP
c_func
(paren
id|read_sq.action_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SIGNAL_RECEIVED
)paren
r_return
id|uRead
OG
l_int|0
ques
c_cond
id|uRead
suffix:colon
op_minus
id|EINTR
suffix:semicolon
)brace
multiline_comment|/* The amount we move is either what is left in the&n;&t;&t; * current buffer or what the user wants.&n;&t;&t; */
id|bLeft
op_assign
id|read_sq.block_size
op_minus
id|read_sq.rear_size
suffix:semicolon
id|bUsed
op_assign
id|read_sq.rear_size
suffix:semicolon
id|uUsed
op_assign
id|sound_copy_translate_read
c_func
(paren
id|dst
comma
id|uLeft
comma
id|read_sq.buffers
(braket
id|read_sq.front
)braket
comma
op_amp
id|bUsed
comma
id|bLeft
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uUsed
op_le
l_int|0
)paren
r_return
id|uUsed
suffix:semicolon
id|dst
op_add_assign
id|uUsed
suffix:semicolon
id|uRead
op_add_assign
id|uUsed
suffix:semicolon
id|uLeft
op_sub_assign
id|uUsed
suffix:semicolon
id|read_sq.rear_size
op_add_assign
id|bUsed
suffix:semicolon
r_if
c_cond
(paren
id|read_sq.rear_size
op_ge
id|read_sq.block_size
)paren
(brace
id|read_sq.rear_size
op_assign
l_int|0
suffix:semicolon
id|read_sq.front
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|read_sq.front
op_ge
id|read_sq.max_active
)paren
id|read_sq.front
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
id|uRead
suffix:semicolon
)brace
r_static
r_int
id|sq_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
id|sq.busy
)paren
(brace
id|rc
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|NON_BLOCKING
c_func
(paren
id|file-&gt;f_flags
)paren
)paren
r_goto
id|err_out
suffix:semicolon
id|rc
op_assign
op_minus
id|EINTR
suffix:semicolon
r_while
c_loop
(paren
id|sq.busy
)paren
(brace
id|SLEEP
c_func
(paren
id|sq.open_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SIGNAL_RECEIVED
)paren
r_goto
id|err_out
suffix:semicolon
)brace
)brace
id|sq.busy
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Let&squot;s play spot-the-race-condition */
r_if
c_cond
(paren
id|sq_allocate_buffers
c_func
(paren
)paren
)paren
r_goto
id|err_out_nobusy
suffix:semicolon
id|sq_setup
c_func
(paren
id|numBufs
comma
id|bufSize
op_lshift
l_int|10
comma
id|sound_buffers
)paren
suffix:semicolon
id|sq.open_mode
op_assign
id|file-&gt;f_mode
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_if
c_cond
(paren
id|read_sq.busy
)paren
(brace
id|rc
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|NON_BLOCKING
c_func
(paren
id|file-&gt;f_flags
)paren
)paren
r_goto
id|err_out
suffix:semicolon
id|rc
op_assign
op_minus
id|EINTR
suffix:semicolon
r_while
c_loop
(paren
id|read_sq.busy
)paren
(brace
id|SLEEP
c_func
(paren
id|read_sq.open_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SIGNAL_RECEIVED
)paren
r_goto
id|err_out
suffix:semicolon
)brace
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
id|read_sq.busy
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sq_allocate_read_buffers
c_func
(paren
)paren
)paren
r_goto
id|err_out_nobusy
suffix:semicolon
id|read_sq_setup
c_func
(paren
id|numReadBufs
comma
id|readbufSize
op_lshift
l_int|10
comma
id|sound_read_buffers
)paren
suffix:semicolon
id|read_sq.open_mode
op_assign
id|file-&gt;f_mode
suffix:semicolon
)brace
multiline_comment|/* Start up the 4218 by:&n;&t; * Reset.&n;&t; * Enable, unreset.&n;&t; */
op_star
(paren
(paren
r_volatile
id|uint
op_star
)paren
id|HIOX_CSR4_ADDR
)paren
op_and_assign
op_complement
id|HIOX_CSR4_RSTAUDIO
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
op_star
(paren
(paren
r_volatile
id|uint
op_star
)paren
id|HIOX_CSR4_ADDR
)paren
op_or_assign
id|HIOX_CSR4_ENAUDIO
suffix:semicolon
id|mdelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
op_star
(paren
(paren
r_volatile
id|uint
op_star
)paren
id|HIOX_CSR4_ADDR
)paren
op_or_assign
id|HIOX_CSR4_RSTAUDIO
suffix:semicolon
multiline_comment|/* We need to send the current control word in case someone&n;&t; * opened /dev/mixer and changed things while we were shut&n;&t; * down.  Chances are good the initialization that follows&n;&t; * would have done this, but it is still possible it wouldn&squot;t.&n;&t; */
id|cs4218_ctl_write
c_func
(paren
id|cs4218_control
)paren
suffix:semicolon
id|sound.minDev
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
op_amp
l_int|0x0f
suffix:semicolon
id|sound.soft
op_assign
id|sound.dsp
suffix:semicolon
id|sound.hard
op_assign
id|sound.dsp
suffix:semicolon
id|sound_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
op_amp
l_int|0x0f
)paren
op_eq
id|SND_DEV_AUDIO
)paren
(brace
id|sound_set_speed
c_func
(paren
l_int|8000
)paren
suffix:semicolon
id|sound_set_stereo
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|sound_set_format
c_func
(paren
id|AFMT_MU_LAW
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|err_out_nobusy
suffix:colon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|sq.busy
op_assign
l_int|0
suffix:semicolon
id|WAKE_UP
c_func
(paren
id|sq.open_queue
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|read_sq.busy
op_assign
l_int|0
suffix:semicolon
id|WAKE_UP
c_func
(paren
id|read_sq.open_queue
)paren
suffix:semicolon
)brace
id|err_out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_void
id|sq_reset
c_func
(paren
r_void
)paren
(brace
id|sound_silence
c_func
(paren
)paren
suffix:semicolon
id|sq.active
op_assign
l_int|0
suffix:semicolon
id|sq.count
op_assign
l_int|0
suffix:semicolon
id|sq.front
op_assign
(paren
id|sq.rear
op_plus
l_int|1
)paren
op_mod
id|sq.max_count
suffix:semicolon
macro_line|#if 0
id|init_tdm_buffers
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
r_static
r_int
id|sq_fsync
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|sq.syncing
op_assign
l_int|1
suffix:semicolon
id|sq_play
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* there may be an incomplete frame waiting */
r_while
c_loop
(paren
id|sq.active
)paren
(brace
id|SLEEP
c_func
(paren
id|sq.sync_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SIGNAL_RECEIVED
)paren
(brace
multiline_comment|/* While waiting for audio output to drain, an&n;&t;&t;&t; * interrupt occurred.  Stop audio output immediately&n;&t;&t;&t; * and clear the queue. */
id|sq_reset
c_func
(paren
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EINTR
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|sq.syncing
op_assign
l_int|0
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
id|sq_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sq.busy
)paren
id|rc
op_assign
id|sq_fsync
c_func
(paren
id|file
comma
id|file-&gt;f_dentry
)paren
suffix:semicolon
id|sound.soft
op_assign
id|sound.dsp
suffix:semicolon
id|sound.hard
op_assign
id|sound.dsp
suffix:semicolon
id|sound_silence
c_func
(paren
)paren
suffix:semicolon
id|sq_release_read_buffers
c_func
(paren
)paren
suffix:semicolon
id|sq_release_buffers
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|read_sq.busy
op_assign
l_int|0
suffix:semicolon
id|WAKE_UP
c_func
(paren
id|read_sq.open_queue
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|sq.busy
op_assign
l_int|0
suffix:semicolon
id|WAKE_UP
c_func
(paren
id|sq.open_queue
)paren
suffix:semicolon
)brace
multiline_comment|/* Shut down the SMC.&n;&t;*/
id|cpmp-&gt;cp_smc
(braket
l_int|1
)braket
dot
id|smc_smcmr
op_and_assign
op_complement
(paren
id|SMCMR_TEN
op_or
id|SMCMR_REN
)paren
suffix:semicolon
multiline_comment|/* Shut down the codec.&n;&t;*/
op_star
(paren
(paren
r_volatile
id|uint
op_star
)paren
id|HIOX_CSR4_ADDR
)paren
op_or_assign
id|HIOX_CSR4_RSTAUDIO
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
op_star
(paren
(paren
r_volatile
id|uint
op_star
)paren
id|HIOX_CSR4_ADDR
)paren
op_and_assign
op_complement
id|HIOX_CSR4_ENAUDIO
suffix:semicolon
multiline_comment|/* Wake up a process waiting for the queue being released.&n;&t; * Note: There may be several processes waiting for a call&n;&t; * to open() returning. */
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
id|sq_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
id|u_int
id|cmd
comma
id|u_long
id|arg
)paren
(brace
id|u_long
id|fmt
suffix:semicolon
r_int
id|data
suffix:semicolon
macro_line|#if 0
r_int
id|size
comma
id|nbufs
suffix:semicolon
macro_line|#else
r_int
id|size
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SNDCTL_DSP_RESET
suffix:colon
id|sq_reset
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_POST
suffix:colon
r_case
id|SNDCTL_DSP_SYNC
suffix:colon
r_return
id|sq_fsync
c_func
(paren
id|file
comma
id|file-&gt;f_dentry
)paren
suffix:semicolon
multiline_comment|/* ++TeSche: before changing any of these it&squot;s&n;&t;&t; * probably wise to wait until sound playing has&n;&t;&t; * settled down. */
r_case
id|SNDCTL_DSP_SPEED
suffix:colon
id|sq_fsync
c_func
(paren
id|file
comma
id|file-&gt;f_dentry
)paren
suffix:semicolon
id|IOCTL_IN
c_func
(paren
id|arg
comma
id|data
)paren
suffix:semicolon
r_return
id|IOCTL_OUT
c_func
(paren
id|arg
comma
id|sound_set_speed
c_func
(paren
id|data
)paren
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_STEREO
suffix:colon
id|sq_fsync
c_func
(paren
id|file
comma
id|file-&gt;f_dentry
)paren
suffix:semicolon
id|IOCTL_IN
c_func
(paren
id|arg
comma
id|data
)paren
suffix:semicolon
r_return
id|IOCTL_OUT
c_func
(paren
id|arg
comma
id|sound_set_stereo
c_func
(paren
id|data
)paren
)paren
suffix:semicolon
r_case
id|SOUND_PCM_WRITE_CHANNELS
suffix:colon
id|sq_fsync
c_func
(paren
id|file
comma
id|file-&gt;f_dentry
)paren
suffix:semicolon
id|IOCTL_IN
c_func
(paren
id|arg
comma
id|data
)paren
suffix:semicolon
r_return
id|IOCTL_OUT
c_func
(paren
id|arg
comma
id|sound_set_stereo
c_func
(paren
id|data
op_minus
l_int|1
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFMT
suffix:colon
id|sq_fsync
c_func
(paren
id|file
comma
id|file-&gt;f_dentry
)paren
suffix:semicolon
id|IOCTL_IN
c_func
(paren
id|arg
comma
id|data
)paren
suffix:semicolon
r_return
id|IOCTL_OUT
c_func
(paren
id|arg
comma
id|sound_set_format
c_func
(paren
id|data
)paren
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETFMTS
suffix:colon
id|fmt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sound.trans_write
)paren
(brace
r_if
c_cond
(paren
id|sound.trans_write-&gt;ct_ulaw
)paren
id|fmt
op_or_assign
id|AFMT_MU_LAW
suffix:semicolon
r_if
c_cond
(paren
id|sound.trans_write-&gt;ct_alaw
)paren
id|fmt
op_or_assign
id|AFMT_A_LAW
suffix:semicolon
r_if
c_cond
(paren
id|sound.trans_write-&gt;ct_s8
)paren
id|fmt
op_or_assign
id|AFMT_S8
suffix:semicolon
r_if
c_cond
(paren
id|sound.trans_write-&gt;ct_u8
)paren
id|fmt
op_or_assign
id|AFMT_U8
suffix:semicolon
r_if
c_cond
(paren
id|sound.trans_write-&gt;ct_s16be
)paren
id|fmt
op_or_assign
id|AFMT_S16_BE
suffix:semicolon
r_if
c_cond
(paren
id|sound.trans_write-&gt;ct_u16be
)paren
id|fmt
op_or_assign
id|AFMT_U16_BE
suffix:semicolon
r_if
c_cond
(paren
id|sound.trans_write-&gt;ct_s16le
)paren
id|fmt
op_or_assign
id|AFMT_S16_LE
suffix:semicolon
r_if
c_cond
(paren
id|sound.trans_write-&gt;ct_u16le
)paren
id|fmt
op_or_assign
id|AFMT_U16_LE
suffix:semicolon
)brace
r_return
id|IOCTL_OUT
c_func
(paren
id|arg
comma
id|fmt
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETBLKSIZE
suffix:colon
id|size
op_assign
id|sq.block_size
op_star
id|sound.soft.size
op_star
(paren
id|sound.soft.stereo
op_plus
l_int|1
)paren
op_div
(paren
id|sound.hard.size
op_star
(paren
id|sound.hard.stereo
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_return
id|IOCTL_OUT
c_func
(paren
id|arg
comma
id|size
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SUBDIVIDE
suffix:colon
r_break
suffix:semicolon
macro_line|#if 0&t;/* Sorry can&squot;t do this at the moment.  The CPM allocated buffers&n;&t; * long ago that can&squot;t be changed.&n;&t; */
r_case
id|SNDCTL_DSP_SETFRAGMENT
suffix:colon
r_if
c_cond
(paren
id|sq.count
op_logical_or
id|sq.active
op_logical_or
id|sq.syncing
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|IOCTL_IN
c_func
(paren
id|arg
comma
id|size
)paren
suffix:semicolon
id|nbufs
op_assign
id|size
op_rshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|nbufs
template_param
id|numBufs
)paren
id|nbufs
op_assign
id|numBufs
suffix:semicolon
id|size
op_and_assign
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|size
op_ge
l_int|8
op_logical_and
id|size
op_le
l_int|30
)paren
(brace
id|size
op_assign
l_int|1
op_lshift
id|size
suffix:semicolon
id|size
op_mul_assign
id|sound.hard.size
op_star
(paren
id|sound.hard.stereo
op_plus
l_int|1
)paren
suffix:semicolon
id|size
op_div_assign
id|sound.soft.size
op_star
(paren
id|sound.soft.stereo
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
(paren
id|bufSize
op_lshift
l_int|10
)paren
)paren
id|size
op_assign
id|bufSize
op_lshift
l_int|10
suffix:semicolon
)brace
r_else
id|size
op_assign
id|bufSize
op_lshift
l_int|10
suffix:semicolon
id|sq_setup
c_func
(paren
id|numBufs
comma
id|size
comma
id|sound_buffers
)paren
suffix:semicolon
id|sq.max_active
op_assign
id|nbufs
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
r_return
id|mixer_ioctl
c_func
(paren
id|inode
comma
id|file
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_static
r_struct
id|file_operations
id|sq_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|llseek
op_assign
id|sound_lseek
comma
dot
id|read
op_assign
id|sq_read
comma
multiline_comment|/* sq_read */
dot
id|write
op_assign
id|sq_write
comma
dot
id|ioctl
op_assign
id|sq_ioctl
comma
dot
id|open
op_assign
id|sq_open
comma
dot
id|release
op_assign
id|sq_release
comma
)brace
suffix:semicolon
r_static
r_void
id|__init
id|sq_init
c_func
(paren
r_void
)paren
(brace
id|sq_unit
op_assign
id|register_sound_dsp
c_func
(paren
op_amp
id|sq_fops
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sq_unit
OL
l_int|0
)paren
r_return
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|sq.action_queue
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|sq.open_queue
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|sq.sync_queue
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|read_sq.action_queue
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|read_sq.open_queue
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|read_sq.sync_queue
)paren
suffix:semicolon
id|sq.busy
op_assign
l_int|0
suffix:semicolon
id|read_sq.busy
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* whatever you like as startup mode for /dev/dsp,&n;&t; * (/dev/audio hasn&squot;t got a startup mode). note that&n;&t; * once changed a new open() will *not* restore these!&n;&t; */
id|sound.dsp.format
op_assign
id|AFMT_S16_BE
suffix:semicolon
id|sound.dsp.stereo
op_assign
l_int|1
suffix:semicolon
id|sound.dsp.size
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* set minimum rate possible without expanding */
id|sound.dsp.speed
op_assign
l_int|8000
suffix:semicolon
multiline_comment|/* before the first open to /dev/dsp this wouldn&squot;t be set */
id|sound.soft
op_assign
id|sound.dsp
suffix:semicolon
id|sound.hard
op_assign
id|sound.dsp
suffix:semicolon
id|sound_silence
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * /dev/sndstat&n; */
multiline_comment|/* state.buf should not overflow! */
r_static
r_int
id|state_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_char
op_star
id|buffer
op_assign
id|state.buf
comma
op_star
id|mach
op_assign
l_string|&quot;&quot;
comma
id|cs4218_buf
(braket
l_int|50
)braket
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|state.busy
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|state.ptr
op_assign
l_int|0
suffix:semicolon
id|state.busy
op_assign
l_int|1
suffix:semicolon
id|sprintf
c_func
(paren
id|cs4218_buf
comma
l_string|&quot;Crystal CS4218 on TDM, &quot;
)paren
suffix:semicolon
id|mach
op_assign
id|cs4218_buf
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%sDMA sound driver:&bslash;n&quot;
comma
id|mach
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;&bslash;tsound.format = 0x%x&quot;
comma
id|sound.soft.format
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|sound.soft.format
)paren
(brace
r_case
id|AFMT_MU_LAW
suffix:colon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot; (mu-law)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_A_LAW
suffix:colon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot; (A-law)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_U8
suffix:colon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot; (unsigned 8 bit)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_S8
suffix:colon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot; (signed 8 bit)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_S16_BE
suffix:colon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot; (signed 16 bit big)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_U16_BE
suffix:colon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot; (unsigned 16 bit big)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_S16_LE
suffix:colon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot; (signed 16 bit little)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_U16_LE
suffix:colon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot; (unsigned 16 bit little)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;&bslash;tsound.speed = %dHz (phys. %dHz)&bslash;n&quot;
comma
id|sound.soft.speed
comma
id|sound.hard.speed
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;&bslash;tsound.stereo = 0x%x (%s)&bslash;n&quot;
comma
id|sound.soft.stereo
comma
id|sound.soft.stereo
ques
c_cond
l_string|&quot;stereo&quot;
suffix:colon
l_string|&quot;mono&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;&bslash;tsq.block_size = %d sq.max_count = %d&quot;
l_string|&quot; sq.max_active = %d&bslash;n&quot;
comma
id|sq.block_size
comma
id|sq.max_count
comma
id|sq.max_active
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;&bslash;tsq.count = %d sq.rear_size = %d&bslash;n&quot;
comma
id|sq.count
comma
id|sq.rear_size
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;&bslash;tsq.active = %d sq.syncing = %d&bslash;n&quot;
comma
id|sq.active
comma
id|sq.syncing
)paren
suffix:semicolon
id|state.len
op_assign
id|len
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|state_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|state.busy
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
id|ssize_t
id|state_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
id|n
op_assign
id|state.len
op_minus
id|state.ptr
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
id|count
)paren
id|n
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|n
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buf
comma
op_amp
id|state.buf
(braket
id|state.ptr
)braket
comma
id|n
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|state.ptr
op_add_assign
id|n
suffix:semicolon
r_return
id|n
suffix:semicolon
)brace
r_static
r_struct
id|file_operations
id|state_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|llseek
op_assign
id|sound_lseek
comma
dot
id|read
op_assign
id|state_read
comma
dot
id|open
op_assign
id|state_open
comma
dot
id|release
op_assign
id|state_release
comma
)brace
suffix:semicolon
r_static
r_void
id|__init
id|state_init
c_func
(paren
r_void
)paren
(brace
id|state_unit
op_assign
id|register_sound_special
c_func
(paren
op_amp
id|state_fops
comma
id|SND_DEV_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state_unit
OL
l_int|0
)paren
r_return
suffix:semicolon
id|state.busy
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*** Common stuff ********************************************************/
r_static
r_int
r_int
id|sound_lseek
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|offset
comma
r_int
id|orig
)paren
(brace
r_return
op_minus
id|ESPIPE
suffix:semicolon
)brace
multiline_comment|/*** Config &amp; Setup **********************************************************/
r_int
id|__init
id|tdm8xx_sound_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|has_sound
suffix:semicolon
id|uint
id|dp_addr
suffix:semicolon
r_volatile
id|uint
op_star
id|sirp
suffix:semicolon
r_volatile
id|cbd_t
op_star
id|bdp
suffix:semicolon
r_volatile
id|cpm8xx_t
op_star
id|cp
suffix:semicolon
r_volatile
id|smc_t
op_star
id|sp
suffix:semicolon
r_volatile
id|smc_uart_t
op_star
id|up
suffix:semicolon
r_volatile
id|immap_t
op_star
id|immap
suffix:semicolon
id|has_sound
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Program the SI/TSA to use TDMa, connected to SMC2, for 4 bytes.&n;&t;*/
id|cp
op_assign
id|cpmp
suffix:semicolon
multiline_comment|/* Get pointer to Communication Processor */
id|immap
op_assign
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
suffix:semicolon
multiline_comment|/* and to internal registers */
multiline_comment|/* Set all TDMa control bits to zero.  This enables most features&n;&t; * we want.&n;&t; */
id|cp-&gt;cp_simode
op_and_assign
op_complement
l_int|0x00000fff
suffix:semicolon
multiline_comment|/* Enable common receive/transmit clock pins, use IDL format.&n;&t; * Sync on falling edge, transmit rising clock, recieve falling&n;&t; * clock, delay 1 bit on both Tx and Rx.  Common Tx/Rx clocks and&n;&t; * sync.&n;&t; * Connect SMC2 to TSA.&n;&t; */
id|cp-&gt;cp_simode
op_or_assign
l_int|0x80000141
suffix:semicolon
multiline_comment|/* Configure port A pins for TDMa operation.&n;&t; * The RPX-Lite (MPC850/823) loses SMC2 when TDM is used.&n;&t; */
id|immap-&gt;im_ioport.iop_papar
op_or_assign
l_int|0x01c0
suffix:semicolon
multiline_comment|/* Enable TDMa functions */
id|immap-&gt;im_ioport.iop_padir
op_or_assign
l_int|0x00c0
suffix:semicolon
multiline_comment|/* Enable TDMa Tx/Rx */
id|immap-&gt;im_ioport.iop_padir
op_and_assign
op_complement
l_int|0x0100
suffix:semicolon
multiline_comment|/* Enable L1RCLKa */
id|immap-&gt;im_ioport.iop_pcpar
op_or_assign
l_int|0x0800
suffix:semicolon
multiline_comment|/* Enable L1RSYNCa */
id|immap-&gt;im_ioport.iop_pcdir
op_and_assign
op_complement
l_int|0x0800
suffix:semicolon
multiline_comment|/* Initialize the SI TDM routing table.  We use TDMa only.&n;&t; * The receive table and transmit table each have only one&n;&t; * entry, to capture/send four bytes after each frame pulse.&n;&t; * The 16-bit ram entry is 0000 0001 1000 1111. (SMC2)&n;&t; */
id|cp-&gt;cp_sigmr
op_assign
l_int|0
suffix:semicolon
id|sirp
op_assign
(paren
id|uint
op_star
)paren
id|cp-&gt;cp_siram
suffix:semicolon
op_star
id|sirp
op_assign
l_int|0x018f0000
suffix:semicolon
multiline_comment|/* Receive entry */
id|sirp
op_add_assign
l_int|64
suffix:semicolon
op_star
id|sirp
op_assign
l_int|0x018f0000
suffix:semicolon
multiline_comment|/* Tramsmit entry */
multiline_comment|/* Enable single TDMa routing.&n;&t;*/
id|cp-&gt;cp_sigmr
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* Initialize the SMC for transparent operation.&n;&t;*/
id|sp
op_assign
op_amp
id|cpmp-&gt;cp_smc
(braket
l_int|1
)braket
suffix:semicolon
id|up
op_assign
(paren
id|smc_uart_t
op_star
)paren
op_amp
id|cp-&gt;cp_dparam
(braket
id|PROFF_SMC2
)braket
suffix:semicolon
multiline_comment|/* We need to allocate a transmit and receive buffer&n;&t; * descriptors from dual port ram.&n;&t; */
id|dp_addr
op_assign
id|m8xx_cpm_dpalloc
c_func
(paren
r_sizeof
(paren
id|cbd_t
)paren
op_star
id|numReadBufs
)paren
suffix:semicolon
multiline_comment|/* Set the physical address of the host memory&n;&t; * buffers in the buffer descriptors, and the&n;&t; * virtual address for us to work with.&n;&t; */
id|bdp
op_assign
(paren
id|cbd_t
op_star
)paren
op_amp
id|cp-&gt;cp_dpmem
(braket
id|dp_addr
)braket
suffix:semicolon
id|up-&gt;smc_rbase
op_assign
id|dp_addr
suffix:semicolon
id|rx_cur
op_assign
id|rx_base
op_assign
(paren
id|cbd_t
op_star
)paren
id|bdp
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|numReadBufs
op_minus
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|bdp-&gt;cbd_bufaddr
op_assign
l_int|0
suffix:semicolon
id|bdp-&gt;cbd_datlen
op_assign
l_int|0
suffix:semicolon
id|bdp-&gt;cbd_sc
op_assign
id|BD_SC_EMPTY
op_or
id|BD_SC_INTRPT
suffix:semicolon
id|bdp
op_increment
suffix:semicolon
)brace
id|bdp-&gt;cbd_bufaddr
op_assign
l_int|0
suffix:semicolon
id|bdp-&gt;cbd_datlen
op_assign
l_int|0
suffix:semicolon
id|bdp-&gt;cbd_sc
op_assign
id|BD_SC_WRAP
op_or
id|BD_SC_EMPTY
op_or
id|BD_SC_INTRPT
suffix:semicolon
multiline_comment|/* Now, do the same for the transmit buffers.&n;&t;*/
id|dp_addr
op_assign
id|m8xx_cpm_dpalloc
c_func
(paren
r_sizeof
(paren
id|cbd_t
)paren
op_star
id|numBufs
)paren
suffix:semicolon
id|bdp
op_assign
(paren
id|cbd_t
op_star
)paren
op_amp
id|cp-&gt;cp_dpmem
(braket
id|dp_addr
)braket
suffix:semicolon
id|up-&gt;smc_tbase
op_assign
id|dp_addr
suffix:semicolon
id|tx_cur
op_assign
id|tx_base
op_assign
(paren
id|cbd_t
op_star
)paren
id|bdp
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|numBufs
op_minus
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|bdp-&gt;cbd_bufaddr
op_assign
l_int|0
suffix:semicolon
id|bdp-&gt;cbd_datlen
op_assign
l_int|0
suffix:semicolon
id|bdp-&gt;cbd_sc
op_assign
id|BD_SC_INTRPT
suffix:semicolon
id|bdp
op_increment
suffix:semicolon
)brace
id|bdp-&gt;cbd_bufaddr
op_assign
l_int|0
suffix:semicolon
id|bdp-&gt;cbd_datlen
op_assign
l_int|0
suffix:semicolon
id|bdp-&gt;cbd_sc
op_assign
(paren
id|BD_SC_WRAP
op_or
id|BD_SC_INTRPT
)paren
suffix:semicolon
multiline_comment|/* Set transparent SMC mode.&n;&t; * A few things are specific to our application.  The codec interface&n;&t; * is MSB first, hence the REVD selection.  The CD/CTS pulse are&n;&t; * used by the TSA to indicate the frame start to the SMC.&n;&t; */
id|up-&gt;smc_rfcr
op_assign
id|SCC_EB
suffix:semicolon
id|up-&gt;smc_tfcr
op_assign
id|SCC_EB
suffix:semicolon
id|up-&gt;smc_mrblr
op_assign
id|readbufSize
op_star
l_int|1024
suffix:semicolon
multiline_comment|/* Set 16-bit reversed data, transparent mode.&n;&t;*/
id|sp-&gt;smc_smcmr
op_assign
id|smcr_mk_clen
c_func
(paren
l_int|15
)paren
op_or
id|SMCMR_SM_TRANS
op_or
id|SMCMR_REVD
op_or
id|SMCMR_BS
suffix:semicolon
multiline_comment|/* Enable and clear events.&n;&t; * Because of FIFO delays, all we need is the receive interrupt&n;&t; * and we can process both the current receive and current&n;&t; * transmit interrupt within a few microseconds of the transmit.&n;&t; */
id|sp-&gt;smc_smce
op_assign
l_int|0xff
suffix:semicolon
id|sp-&gt;smc_smcm
op_assign
id|SMCM_TXE
op_or
id|SMCM_TX
op_or
id|SMCM_RX
suffix:semicolon
multiline_comment|/* Send the CPM an initialize command.&n;&t;*/
id|cp-&gt;cp_cpcr
op_assign
id|mk_cr_cmd
c_func
(paren
id|CPM_CR_CH_SMC2
comma
id|CPM_CR_INIT_TRX
)paren
op_or
id|CPM_CR_FLG
suffix:semicolon
r_while
c_loop
(paren
id|cp-&gt;cp_cpcr
op_amp
id|CPM_CR_FLG
)paren
suffix:semicolon
id|sound.mach
op_assign
id|mach_cs4218
suffix:semicolon
id|has_sound
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Initialize beep stuff */
id|orig_mksound
op_assign
id|kd_mksound
suffix:semicolon
id|kd_mksound
op_assign
id|cs_mksound
suffix:semicolon
id|beep_buf
op_assign
(paren
r_int
op_star
)paren
id|kmalloc
c_func
(paren
id|BEEP_BUFLEN
op_star
l_int|4
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|beep_buf
op_eq
l_int|NULL
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;dmasound: no memory for &quot;
l_string|&quot;beep buffer&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|has_sound
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Initialize the software SPI.&n;&t;*/
id|sw_spi_init
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Set up sound queue, /dev/audio and /dev/dsp. */
multiline_comment|/* Set default settings. */
id|sq_init
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Set up /dev/sndstat. */
id|state_init
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Set up /dev/mixer. */
id|mixer_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sound.mach
dot
id|irqinit
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DMA sound driver: Interrupt initialization failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|irq_installed
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DMA sound driver installed, using %d buffers of %dk.&bslash;n&quot;
comma
id|numBufs
comma
id|bufSize
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Due to FIFOs and bit delays, the transmit interrupt occurs a few&n; * microseconds ahead of the receive interrupt.&n; * When we get an interrupt, we service the transmit first, then&n; * check for a receive to prevent the overhead of returning through&n; * the interrupt handler only to get back here right away during&n; * full duplex operation.&n; */
r_static
r_void
id|cs4218_intr
c_func
(paren
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_volatile
id|smc_t
op_star
id|sp
suffix:semicolon
r_volatile
id|cpm8xx_t
op_star
id|cp
suffix:semicolon
id|sp
op_assign
op_amp
id|cpmp-&gt;cp_smc
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;smc_smce
op_amp
id|SCCM_TX
)paren
(brace
id|sp-&gt;smc_smce
op_assign
id|SCCM_TX
suffix:semicolon
id|cs4218_tdm_tx_intr
c_func
(paren
(paren
r_void
op_star
)paren
id|sp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sp-&gt;smc_smce
op_amp
id|SCCM_RX
)paren
(brace
id|sp-&gt;smc_smce
op_assign
id|SCCM_RX
suffix:semicolon
id|cs4218_tdm_rx_intr
c_func
(paren
(paren
r_void
op_star
)paren
id|sp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sp-&gt;smc_smce
op_amp
id|SCCM_TXE
)paren
(brace
multiline_comment|/* Transmit underrun.  This happens with the application&n;&t;&t; * didn&squot;t keep up sending buffers.  We tell the SMC to&n;&t;&t; * restart, which will cause it to poll the current (next)&n;&t;&t; * BD.  If the user supplied data since this occurred,&n;&t;&t; * we just start running again.  If they didn&squot;t, the SMC&n;&t;&t; * will poll the descriptor until data is placed there.&n;&t;&t; */
id|sp-&gt;smc_smce
op_assign
id|SCCM_TXE
suffix:semicolon
id|cp
op_assign
id|cpmp
suffix:semicolon
multiline_comment|/* Get pointer to Communication Processor */
id|cp-&gt;cp_cpcr
op_assign
id|mk_cr_cmd
c_func
(paren
id|CPM_CR_CH_SMC2
comma
id|CPM_CR_RESTART_TX
)paren
op_or
id|CPM_CR_FLG
suffix:semicolon
r_while
c_loop
(paren
id|cp-&gt;cp_cpcr
op_amp
id|CPM_CR_FLG
)paren
suffix:semicolon
)brace
)brace
mdefine_line|#define MAXARGS&t;&t;8&t;/* Should be sufficient for now */
r_void
id|__init
id|dmasound_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
multiline_comment|/* check the bootstrap parameter for &quot;dmasound=&quot; */
r_switch
c_cond
(paren
id|ints
(braket
l_int|0
)braket
)paren
(brace
r_case
l_int|3
suffix:colon
r_if
c_cond
(paren
(paren
id|ints
(braket
l_int|3
)braket
OL
l_int|0
)paren
op_logical_or
(paren
id|ints
(braket
l_int|3
)braket
OG
id|MAX_CATCH_RADIUS
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;dmasound_setup: illegal catch radius, using default = %d&bslash;n&quot;
comma
id|catchRadius
)paren
suffix:semicolon
r_else
id|catchRadius
op_assign
id|ints
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* fall through */
r_case
l_int|2
suffix:colon
r_if
c_cond
(paren
id|ints
(braket
l_int|1
)braket
OL
id|MIN_BUFFERS
)paren
id|printk
c_func
(paren
l_string|&quot;dmasound_setup: illegal number of buffers, using default = %d&bslash;n&quot;
comma
id|numBufs
)paren
suffix:semicolon
r_else
id|numBufs
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|2
)braket
template_param
id|MAX_BUFSIZE
)paren
id|printk
c_func
(paren
l_string|&quot;dmasound_setup: illegal buffer size, using default = %d&bslash;n&quot;
comma
id|bufSize
)paren
suffix:semicolon
r_else
id|bufSize
op_assign
id|ints
(braket
l_int|2
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;dmasound_setup: illegal number of arguments&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Software SPI functions.&n; * These are on Port B.&n; */
mdefine_line|#define PB_SPICLK&t;((uint)0x00000002)
mdefine_line|#define PB_SPIMOSI&t;((uint)0x00000004)
mdefine_line|#define PB_SPIMISO&t;((uint)0x00000008)
r_static
r_void
id|sw_spi_init
c_func
(paren
r_void
)paren
(brace
r_volatile
id|cpm8xx_t
op_star
id|cp
suffix:semicolon
r_volatile
id|uint
op_star
id|hcsr4
suffix:semicolon
id|hcsr4
op_assign
(paren
r_volatile
id|uint
op_star
)paren
id|HIOX_CSR4_ADDR
suffix:semicolon
id|cp
op_assign
id|cpmp
suffix:semicolon
multiline_comment|/* Get pointer to Communication Processor */
op_star
id|hcsr4
op_and_assign
op_complement
id|HIOX_CSR4_AUDSPISEL
suffix:semicolon
multiline_comment|/* Disable SPI select */
multiline_comment|/* Make these Port B signals general purpose I/O.&n;&t; * First, make sure the clock is low.&n;&t; */
id|cp-&gt;cp_pbdat
op_and_assign
op_complement
id|PB_SPICLK
suffix:semicolon
id|cp-&gt;cp_pbpar
op_and_assign
op_complement
(paren
id|PB_SPICLK
op_or
id|PB_SPIMOSI
op_or
id|PB_SPIMISO
)paren
suffix:semicolon
multiline_comment|/* Clock and Master Output are outputs.&n;&t;*/
id|cp-&gt;cp_pbdir
op_or_assign
(paren
id|PB_SPICLK
op_or
id|PB_SPIMOSI
)paren
suffix:semicolon
multiline_comment|/* Master Input.&n;&t;*/
id|cp-&gt;cp_pbdir
op_and_assign
op_complement
id|PB_SPIMISO
suffix:semicolon
)brace
multiline_comment|/* Write the CS4218 control word out the SPI port.  While the&n; * the control word is going out, the status word is arriving.&n; */
r_static
id|uint
id|cs4218_ctl_write
c_func
(paren
id|uint
id|ctlreg
)paren
(brace
id|uint
id|status
suffix:semicolon
id|sw_spi_io
c_func
(paren
(paren
id|u_char
op_star
)paren
op_amp
id|ctlreg
comma
(paren
id|u_char
op_star
)paren
op_amp
id|status
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Shadow the control register.....I guess we could do&n;&t; * the same for the status, but for now we just return it&n;&t; * and let the caller decide.&n;&t; */
id|cs4218_control
op_assign
id|ctlreg
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
r_static
r_void
id|sw_spi_io
c_func
(paren
id|u_char
op_star
id|obuf
comma
id|u_char
op_star
id|ibuf
comma
id|uint
id|bcnt
)paren
(brace
r_int
id|bits
comma
id|i
suffix:semicolon
id|u_char
id|outbyte
comma
id|inbyte
suffix:semicolon
r_volatile
id|cpm8xx_t
op_star
id|cp
suffix:semicolon
r_volatile
id|uint
op_star
id|hcsr4
suffix:semicolon
id|hcsr4
op_assign
(paren
r_volatile
id|uint
op_star
)paren
id|HIOX_CSR4_ADDR
suffix:semicolon
id|cp
op_assign
id|cpmp
suffix:semicolon
multiline_comment|/* Get pointer to Communication Processor */
multiline_comment|/* The timing on the bus is pretty slow.  Code inefficiency&n;&t; * and eieio() is our friend here :-).&n;&t; */
id|cp-&gt;cp_pbdat
op_and_assign
op_complement
id|PB_SPICLK
suffix:semicolon
op_star
id|hcsr4
op_or_assign
id|HIOX_CSR4_AUDSPISEL
suffix:semicolon
multiline_comment|/* Enable SPI select */
id|eieio
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Clock in/out the bytes.  Data is valid on the falling edge&n;&t; * of the clock.  Data is MSB first.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|bcnt
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outbyte
op_assign
op_star
id|obuf
op_increment
suffix:semicolon
id|inbyte
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|bits
op_assign
l_int|0
suffix:semicolon
id|bits
OL
l_int|8
suffix:semicolon
id|bits
op_increment
)paren
(brace
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|cp-&gt;cp_pbdat
op_or_assign
id|PB_SPICLK
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|outbyte
op_amp
l_int|0x80
)paren
id|cp-&gt;cp_pbdat
op_or_assign
id|PB_SPIMOSI
suffix:semicolon
r_else
id|cp-&gt;cp_pbdat
op_and_assign
op_complement
id|PB_SPIMOSI
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|cp-&gt;cp_pbdat
op_and_assign
op_complement
id|PB_SPICLK
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|outbyte
op_lshift_assign
l_int|1
suffix:semicolon
id|inbyte
op_lshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|cp-&gt;cp_pbdat
op_amp
id|PB_SPIMISO
)paren
id|inbyte
op_or_assign
l_int|1
suffix:semicolon
)brace
op_star
id|ibuf
op_increment
op_assign
id|inbyte
suffix:semicolon
)brace
op_star
id|hcsr4
op_and_assign
op_complement
id|HIOX_CSR4_AUDSPISEL
suffix:semicolon
multiline_comment|/* Disable SPI select */
id|eieio
c_func
(paren
)paren
suffix:semicolon
)brace
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|irq_installed
)paren
(brace
id|sound_silence
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef MODULE
id|sound.mach
dot
id|irqcleanup
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
id|sq_release_read_buffers
c_func
(paren
)paren
suffix:semicolon
id|sq_release_buffers
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mixer_unit
op_ge
l_int|0
)paren
id|unregister_sound_mixer
c_func
(paren
id|mixer_unit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state_unit
op_ge
l_int|0
)paren
id|unregister_sound_special
c_func
(paren
id|state_unit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sq_unit
op_ge
l_int|0
)paren
id|unregister_sound_dsp
c_func
(paren
id|sq_unit
)paren
suffix:semicolon
)brace
id|module_init
c_func
(paren
id|tdm8xx_sound_init
)paren
suffix:semicolon
id|module_exit
c_func
(paren
id|cleanup_module
)paren
suffix:semicolon
eof
