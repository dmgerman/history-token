multiline_comment|/*&n; * iSeries_pci.c&n; *&n; * Copyright (C) 2001 Allan Trautman, IBM Corporation&n; *&n; * iSeries specific routines for PCI.&n; * &n; * Based on code from pci.c and iSeries_pci.c 32bit&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; * &n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; * &n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/list.h&gt; 
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/ide.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#include &lt;asm/ppcdebug.h&gt;
macro_line|#include &lt;asm/iommu.h&gt;
macro_line|#include &lt;asm/iSeries/HvCallPci.h&gt;
macro_line|#include &lt;asm/iSeries/HvCallSm.h&gt;
macro_line|#include &lt;asm/iSeries/HvCallXm.h&gt;
macro_line|#include &lt;asm/iSeries/LparData.h&gt;
macro_line|#include &lt;asm/iSeries/iSeries_irq.h&gt;
macro_line|#include &lt;asm/iSeries/iSeries_pci.h&gt;
macro_line|#include &lt;asm/iSeries/mf.h&gt;
macro_line|#include &quot;pci.h&quot;
r_extern
r_int
r_int
id|io_page_mask
suffix:semicolon
multiline_comment|/*&n; * Forward declares of prototypes. &n; */
r_static
r_struct
id|iSeries_Device_Node
op_star
id|find_Device_Node
c_func
(paren
r_int
id|bus
comma
r_int
id|devfn
)paren
suffix:semicolon
r_static
r_void
id|scan_PHB_slots
c_func
(paren
r_struct
id|pci_controller
op_star
id|Phb
)paren
suffix:semicolon
r_static
r_void
id|scan_EADS_bridge
c_func
(paren
id|HvBusNumber
id|Bus
comma
id|HvSubBusNumber
id|SubBus
comma
r_int
id|IdSel
)paren
suffix:semicolon
r_static
r_int
id|scan_bridge_slot
c_func
(paren
id|HvBusNumber
id|Bus
comma
r_struct
id|HvCallPci_BridgeInfo
op_star
id|Info
)paren
suffix:semicolon
DECL|variable|iSeries_Global_Device_List
id|LIST_HEAD
c_func
(paren
id|iSeries_Global_Device_List
)paren
suffix:semicolon
DECL|variable|DeviceCount
r_static
r_int
id|DeviceCount
suffix:semicolon
multiline_comment|/* Counters and control flags. */
DECL|variable|Pci_Io_Read_Count
r_static
r_int
id|Pci_Io_Read_Count
suffix:semicolon
DECL|variable|Pci_Io_Write_Count
r_static
r_int
id|Pci_Io_Write_Count
suffix:semicolon
macro_line|#if 0
r_static
r_int
id|Pci_Cfg_Read_Count
suffix:semicolon
r_static
r_int
id|Pci_Cfg_Write_Count
suffix:semicolon
macro_line|#endif
DECL|variable|Pci_Error_Count
r_static
r_int
id|Pci_Error_Count
suffix:semicolon
DECL|variable|Pci_Retry_Max
r_static
r_int
id|Pci_Retry_Max
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* Only retry 3 times  */
DECL|variable|Pci_Error_Flag
r_static
r_int
id|Pci_Error_Flag
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Set Retry Error on. */
DECL|variable|iSeries_pci_ops
r_static
r_struct
id|pci_ops
id|iSeries_pci_ops
suffix:semicolon
multiline_comment|/*&n; * Table defines&n; * Each Entry size is 4 MB * 1024 Entries = 4GB I/O address space.&n; */
DECL|macro|IOMM_TABLE_MAX_ENTRIES
mdefine_line|#define IOMM_TABLE_MAX_ENTRIES&t;1024
DECL|macro|IOMM_TABLE_ENTRY_SIZE
mdefine_line|#define IOMM_TABLE_ENTRY_SIZE&t;0x0000000000400000UL
DECL|macro|BASE_IO_MEMORY
mdefine_line|#define BASE_IO_MEMORY&t;&t;0xE000000000000000UL
DECL|variable|max_io_memory
r_static
r_int
r_int
id|max_io_memory
op_assign
l_int|0xE000000000000000UL
suffix:semicolon
DECL|variable|current_iomm_table_entry
r_static
r_int
id|current_iomm_table_entry
suffix:semicolon
multiline_comment|/*&n; * Lookup Tables.&n; */
DECL|variable|iomm_table
r_static
r_struct
id|iSeries_Device_Node
op_star
op_star
id|iomm_table
suffix:semicolon
DECL|variable|iobar_table
r_static
id|u8
op_star
id|iobar_table
suffix:semicolon
multiline_comment|/*&n; * Static and Global variables&n; */
DECL|variable|pci_io_text
r_static
r_char
op_star
id|pci_io_text
op_assign
l_string|&quot;iSeries PCI I/O&quot;
suffix:semicolon
DECL|variable|iomm_table_lock
r_static
id|spinlock_t
id|iomm_table_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/*&n; * iomm_table_initialize&n; *&n; * Allocates and initalizes the Address Translation Table and Bar&n; * Tables to get them ready for use.  Must be called before any&n; * I/O space is handed out to the device BARs.&n; */
DECL|function|iomm_table_initialize
r_static
r_void
id|iomm_table_initialize
c_func
(paren
r_void
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|iomm_table_lock
)paren
suffix:semicolon
id|iomm_table
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|iomm_table
)paren
op_star
id|IOMM_TABLE_MAX_ENTRIES
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|iobar_table
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|iobar_table
)paren
op_star
id|IOMM_TABLE_MAX_ENTRIES
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|iomm_table_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|iomm_table
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|iobar_table
op_eq
l_int|NULL
)paren
)paren
id|panic
c_func
(paren
l_string|&quot;PCI: I/O tables allocation failed.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * iomm_table_allocate_entry&n; *&n; * Adds pci_dev entry in address translation table&n; *&n; * - Allocates the number of entries required in table base on BAR&n; *   size.&n; * - Allocates starting at BASE_IO_MEMORY and increases.&n; * - The size is round up to be a multiple of entry size.&n; * - CurrentIndex is incremented to keep track of the last entry.&n; * - Builds the resource entry for allocated BARs.&n; */
DECL|function|iomm_table_allocate_entry
r_static
r_void
id|iomm_table_allocate_entry
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|bar_num
)paren
(brace
r_struct
id|resource
op_star
id|bar_res
op_assign
op_amp
id|dev-&gt;resource
(braket
id|bar_num
)braket
suffix:semicolon
r_int
id|bar_size
op_assign
id|pci_resource_len
c_func
(paren
id|dev
comma
id|bar_num
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * No space to allocate, quick exit, skip Allocation.&n;&t; */
r_if
c_cond
(paren
id|bar_size
op_eq
l_int|0
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * Set Resource values.&n;&t; */
id|spin_lock
c_func
(paren
op_amp
id|iomm_table_lock
)paren
suffix:semicolon
id|bar_res-&gt;name
op_assign
id|pci_io_text
suffix:semicolon
id|bar_res-&gt;start
op_assign
id|IOMM_TABLE_ENTRY_SIZE
op_star
id|current_iomm_table_entry
suffix:semicolon
id|bar_res-&gt;start
op_add_assign
id|BASE_IO_MEMORY
suffix:semicolon
id|bar_res-&gt;end
op_assign
id|bar_res-&gt;start
op_plus
id|bar_size
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Allocate the number of table entries needed for BAR.&n;&t; */
r_while
c_loop
(paren
id|bar_size
OG
l_int|0
)paren
(brace
id|iomm_table
(braket
id|current_iomm_table_entry
)braket
op_assign
id|dev-&gt;sysdata
suffix:semicolon
id|iobar_table
(braket
id|current_iomm_table_entry
)braket
op_assign
id|bar_num
suffix:semicolon
id|bar_size
op_sub_assign
id|IOMM_TABLE_ENTRY_SIZE
suffix:semicolon
op_increment
id|current_iomm_table_entry
suffix:semicolon
)brace
id|max_io_memory
op_assign
id|BASE_IO_MEMORY
op_plus
(paren
id|IOMM_TABLE_ENTRY_SIZE
op_star
id|current_iomm_table_entry
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|iomm_table_lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * allocate_device_bars&n; *&n; * - Allocates ALL pci_dev BAR&squot;s and updates the resources with the&n; *   BAR value.  BARS with zero length will have the resources&n; *   The HvCallPci_getBarParms is used to get the size of the BAR&n; *   space.  It calls iomm_table_allocate_entry to allocate&n; *   each entry.&n; * - Loops through The Bar resources(0 - 5) including the ROM&n; *   is resource(6).&n; */
DECL|function|allocate_device_bars
r_static
r_void
id|allocate_device_bars
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_struct
id|resource
op_star
id|bar_res
suffix:semicolon
r_int
id|bar_num
suffix:semicolon
r_for
c_loop
(paren
id|bar_num
op_assign
l_int|0
suffix:semicolon
id|bar_num
op_le
id|PCI_ROM_RESOURCE
suffix:semicolon
op_increment
id|bar_num
)paren
(brace
id|bar_res
op_assign
op_amp
id|dev-&gt;resource
(braket
id|bar_num
)braket
suffix:semicolon
id|iomm_table_allocate_entry
c_func
(paren
id|dev
comma
id|bar_num
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Log error information to system console.&n; * Filter out the device not there errors.&n; * PCI: EADs Connect Failed 0x18.58.10 Rc: 0x00xx&n; * PCI: Read Vendor Failed 0x18.58.10 Rc: 0x00xx&n; * PCI: Connect Bus Unit Failed 0x18.58.10 Rc: 0x00xx&n; */
DECL|function|pci_Log_Error
r_static
r_void
id|pci_Log_Error
c_func
(paren
r_char
op_star
id|Error_Text
comma
r_int
id|Bus
comma
r_int
id|SubBus
comma
r_int
id|AgentId
comma
r_int
id|HvRc
)paren
(brace
r_if
c_cond
(paren
id|HvRc
op_eq
l_int|0x0302
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PCI: %s Failed: 0x%02X.%02X.%02X Rc: 0x%04X&quot;
comma
id|Error_Text
comma
id|Bus
comma
id|SubBus
comma
id|AgentId
comma
id|HvRc
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * build_device_node(u16 Bus, int SubBus, u8 DevFn)&n; */
DECL|function|build_device_node
r_static
r_struct
id|iSeries_Device_Node
op_star
id|build_device_node
c_func
(paren
id|HvBusNumber
id|Bus
comma
id|HvSubBusNumber
id|SubBus
comma
r_int
id|AgentId
comma
r_int
id|Function
)paren
(brace
r_struct
id|iSeries_Device_Node
op_star
id|node
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;-build_device_node 0x%02X.%02X.%02X Function: %02X&bslash;n&quot;
comma
id|Bus
comma
id|SubBus
comma
id|AgentId
comma
id|Function
)paren
suffix:semicolon
id|node
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|iSeries_Device_Node
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|node
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|node
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|iSeries_Device_Node
)paren
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|node-&gt;Device_List
comma
op_amp
id|iSeries_Global_Device_List
)paren
suffix:semicolon
macro_line|#if 0
id|node-&gt;DsaAddr
op_assign
(paren
(paren
id|u64
)paren
id|Bus
op_lshift
l_int|48
)paren
op_plus
(paren
(paren
id|u64
)paren
id|SubBus
op_lshift
l_int|40
)paren
op_plus
(paren
(paren
id|u64
)paren
l_int|0x10
op_lshift
l_int|32
)paren
suffix:semicolon
macro_line|#endif
id|node-&gt;DsaAddr.DsaAddr
op_assign
l_int|0
suffix:semicolon
id|node-&gt;DsaAddr.Dsa.busNumber
op_assign
id|Bus
suffix:semicolon
id|node-&gt;DsaAddr.Dsa.subBusNumber
op_assign
id|SubBus
suffix:semicolon
id|node-&gt;DsaAddr.Dsa.deviceId
op_assign
l_int|0x10
suffix:semicolon
id|node-&gt;AgentId
op_assign
id|AgentId
suffix:semicolon
id|node-&gt;DevFn
op_assign
id|PCI_DEVFN
c_func
(paren
id|ISERIES_ENCODE_DEVICE
c_func
(paren
id|AgentId
)paren
comma
id|Function
)paren
suffix:semicolon
id|node-&gt;IoRetry
op_assign
l_int|0
suffix:semicolon
id|iSeries_Get_Location_Code
c_func
(paren
id|node
)paren
suffix:semicolon
r_return
id|node
suffix:semicolon
)brace
multiline_comment|/*&n; * unsigned long __init find_and_init_phbs(void)&n; *&n; * Description:&n; *   This function checks for all possible system PCI host bridges that connect&n; *   PCI buses.  The system hypervisor is queried as to the guest partition&n; *   ownership status.  A pci_controller is built for any bus which is partially&n; *   owned or fully owned by this guest partition.&n; */
DECL|function|find_and_init_phbs
r_int
r_int
id|__init
id|find_and_init_phbs
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_controller
op_star
id|phb
suffix:semicolon
id|HvBusNumber
id|bus
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;find_and_init_phbs Entry&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Check all possible buses. */
r_for
c_loop
(paren
id|bus
op_assign
l_int|0
suffix:semicolon
id|bus
OL
l_int|256
suffix:semicolon
id|bus
op_increment
)paren
(brace
r_int
id|ret
op_assign
id|HvCallXm_testBus
c_func
(paren
id|bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;bus %d appears to exist&bslash;n&quot;
comma
id|bus
)paren
suffix:semicolon
id|phb
op_assign
(paren
r_struct
id|pci_controller
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pci_controller
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|phb
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|pci_setup_pci_controller
c_func
(paren
id|phb
)paren
suffix:semicolon
id|phb-&gt;pci_mem_offset
op_assign
id|phb-&gt;local_number
op_assign
id|bus
suffix:semicolon
id|phb-&gt;first_busno
op_assign
id|bus
suffix:semicolon
id|phb-&gt;last_busno
op_assign
id|bus
suffix:semicolon
id|phb-&gt;ops
op_assign
op_amp
id|iSeries_pci_ops
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;PCI:Create iSeries pci_controller(%p), Bus: %04X&bslash;n&quot;
comma
id|phb
comma
id|bus
)paren
suffix:semicolon
multiline_comment|/* Find and connect the devices. */
id|scan_PHB_slots
c_func
(paren
id|phb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Check for Unexpected Return code, a clue that something&n;&t;&t; * has gone wrong.&n;&t;&t; */
r_else
r_if
c_cond
(paren
id|ret
op_ne
l_int|0x0301
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Unexpected Return on Probe(0x%04X): 0x%04X&quot;
comma
id|bus
comma
id|ret
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * iSeries_pcibios_init&n; *  &n; * Chance to initialize and structures or variable before PCI Bus walk.&n; */
DECL|function|iSeries_pcibios_init
r_void
id|iSeries_pcibios_init
c_func
(paren
r_void
)paren
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;iSeries_pcibios_init Entry.&bslash;n&quot;
)paren
suffix:semicolon
id|iomm_table_initialize
c_func
(paren
)paren
suffix:semicolon
id|find_and_init_phbs
c_func
(paren
)paren
suffix:semicolon
id|io_page_mask
op_assign
op_minus
l_int|1
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;iSeries_pcibios_init Exit.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * iSeries_pci_final_fixup(void)  &n; */
DECL|function|iSeries_pci_final_fixup
r_void
id|__init
id|iSeries_pci_final_fixup
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|iSeries_Device_Node
op_star
id|node
suffix:semicolon
r_char
id|Buffer
(braket
l_int|256
)braket
suffix:semicolon
r_int
id|DeviceCount
op_assign
l_int|0
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;iSeries_pcibios_fixup Entry.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Fix up at the device node and pci_dev relationship */
id|mf_display_src
c_func
(paren
l_int|0xC9000100
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;pcibios_final_fixup&bslash;n&quot;
)paren
suffix:semicolon
id|for_each_pci_dev
c_func
(paren
id|pdev
)paren
(brace
id|node
op_assign
id|find_Device_Node
c_func
(paren
id|pdev-&gt;bus-&gt;number
comma
id|pdev-&gt;devfn
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;pci dev %p (%x.%x), node %p&bslash;n&quot;
comma
id|pdev
comma
id|pdev-&gt;bus-&gt;number
comma
id|pdev-&gt;devfn
comma
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|node
op_ne
l_int|NULL
)paren
(brace
op_increment
id|DeviceCount
suffix:semicolon
id|pdev-&gt;sysdata
op_assign
(paren
r_void
op_star
)paren
id|node
suffix:semicolon
id|node-&gt;PciDev
op_assign
id|pdev
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;pdev 0x%p &lt;==&gt; DevNode 0x%p&bslash;n&quot;
comma
id|pdev
comma
id|node
)paren
suffix:semicolon
id|allocate_device_bars
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|iSeries_Device_Information
c_func
(paren
id|pdev
comma
id|Buffer
comma
r_sizeof
(paren
id|Buffer
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%d. %s&bslash;n&quot;
comma
id|DeviceCount
comma
id|Buffer
)paren
suffix:semicolon
id|iommu_devnode_init_iSeries
c_func
(paren
id|node
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;PCI: Device Tree not found for 0x%016lX&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|pdev
)paren
suffix:semicolon
id|pdev-&gt;irq
op_assign
id|node-&gt;Irq
suffix:semicolon
)brace
id|iSeries_activate_IRQs
c_func
(paren
)paren
suffix:semicolon
id|mf_display_src
c_func
(paren
l_int|0xC9000200
)paren
suffix:semicolon
)brace
DECL|function|pcibios_fixup_bus
r_void
id|pcibios_fixup_bus
c_func
(paren
r_struct
id|pci_bus
op_star
id|PciBus
)paren
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;iSeries_pcibios_fixup_bus(0x%04X) Entry.&bslash;n&quot;
comma
id|PciBus-&gt;number
)paren
suffix:semicolon
)brace
DECL|function|pcibios_fixup_resources
r_void
id|pcibios_fixup_resources
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;fixup_resources pdev %p&bslash;n&quot;
comma
id|pdev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Loop through each node function to find usable EADs bridges.  &n; */
DECL|function|scan_PHB_slots
r_static
r_void
id|scan_PHB_slots
c_func
(paren
r_struct
id|pci_controller
op_star
id|Phb
)paren
(brace
r_struct
id|HvCallPci_DeviceInfo
op_star
id|DevInfo
suffix:semicolon
id|HvBusNumber
id|bus
op_assign
id|Phb-&gt;local_number
suffix:semicolon
multiline_comment|/* System Bus */
r_const
id|HvSubBusNumber
id|SubBus
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* EADs is always 0. */
r_int
id|HvRc
op_assign
l_int|0
suffix:semicolon
r_int
id|IdSel
suffix:semicolon
r_const
r_int
id|MaxAgents
op_assign
l_int|8
suffix:semicolon
id|DevInfo
op_assign
(paren
r_struct
id|HvCallPci_DeviceInfo
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|HvCallPci_DeviceInfo
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DevInfo
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * Probe for EADs Bridges      &n;&t; */
r_for
c_loop
(paren
id|IdSel
op_assign
l_int|1
suffix:semicolon
id|IdSel
OL
id|MaxAgents
suffix:semicolon
op_increment
id|IdSel
)paren
(brace
id|HvRc
op_assign
id|HvCallPci_getDeviceInfo
c_func
(paren
id|bus
comma
id|SubBus
comma
id|IdSel
comma
id|ISERIES_HV_ADDR
c_func
(paren
id|DevInfo
)paren
comma
r_sizeof
(paren
r_struct
id|HvCallPci_DeviceInfo
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HvRc
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|DevInfo-&gt;deviceType
op_eq
id|HvCallPci_NodeDevice
)paren
id|scan_EADS_bridge
c_func
(paren
id|bus
comma
id|SubBus
comma
id|IdSel
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;PCI: Invalid System Configuration(0x%02X)&quot;
l_string|&quot; for bus 0x%02x id 0x%02x.&bslash;n&quot;
comma
id|DevInfo-&gt;deviceType
comma
id|bus
comma
id|IdSel
)paren
suffix:semicolon
)brace
r_else
id|pci_Log_Error
c_func
(paren
l_string|&quot;getDeviceInfo&quot;
comma
id|bus
comma
id|SubBus
comma
id|IdSel
comma
id|HvRc
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|DevInfo
)paren
suffix:semicolon
)brace
DECL|function|scan_EADS_bridge
r_static
r_void
id|scan_EADS_bridge
c_func
(paren
id|HvBusNumber
id|bus
comma
id|HvSubBusNumber
id|SubBus
comma
r_int
id|IdSel
)paren
(brace
r_struct
id|HvCallPci_BridgeInfo
op_star
id|BridgeInfo
suffix:semicolon
id|HvAgentId
id|AgentId
suffix:semicolon
r_int
id|Function
suffix:semicolon
r_int
id|HvRc
suffix:semicolon
id|BridgeInfo
op_assign
(paren
r_struct
id|HvCallPci_BridgeInfo
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|HvCallPci_BridgeInfo
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BridgeInfo
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
multiline_comment|/* Note: hvSubBus and irq is always be 0 at this level! */
r_for
c_loop
(paren
id|Function
op_assign
l_int|0
suffix:semicolon
id|Function
OL
l_int|8
suffix:semicolon
op_increment
id|Function
)paren
(brace
id|AgentId
op_assign
id|ISERIES_PCI_AGENTID
c_func
(paren
id|IdSel
comma
id|Function
)paren
suffix:semicolon
id|HvRc
op_assign
id|HvCallXm_connectBusUnit
c_func
(paren
id|bus
comma
id|SubBus
comma
id|AgentId
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HvRc
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;found device at bus %d idsel %d func %d (AgentId %x)&bslash;n&quot;
comma
id|bus
comma
id|IdSel
comma
id|Function
comma
id|AgentId
)paren
suffix:semicolon
multiline_comment|/*  Connect EADs: 0x18.00.12 = 0x00 */
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;PCI:Connect EADs: 0x%02X.%02X.%02X&bslash;n&quot;
comma
id|bus
comma
id|SubBus
comma
id|AgentId
)paren
suffix:semicolon
id|HvRc
op_assign
id|HvCallPci_getBusUnitInfo
c_func
(paren
id|bus
comma
id|SubBus
comma
id|AgentId
comma
id|ISERIES_HV_ADDR
c_func
(paren
id|BridgeInfo
)paren
comma
r_sizeof
(paren
r_struct
id|HvCallPci_BridgeInfo
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HvRc
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;bridge info: type %x subbus %x maxAgents %x maxsubbus %x logslot %x&bslash;n&quot;
comma
id|BridgeInfo-&gt;busUnitInfo.deviceType
comma
id|BridgeInfo-&gt;subBusNumber
comma
id|BridgeInfo-&gt;maxAgents
comma
id|BridgeInfo-&gt;maxSubBusNumber
comma
id|BridgeInfo-&gt;logicalSlotNumber
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;PCI: BridgeInfo, Type:0x%02X, SubBus:0x%02X, MaxAgents:0x%02X, MaxSubBus: 0x%02X, LSlot: 0x%02X&bslash;n&quot;
comma
id|BridgeInfo-&gt;busUnitInfo.deviceType
comma
id|BridgeInfo-&gt;subBusNumber
comma
id|BridgeInfo-&gt;maxAgents
comma
id|BridgeInfo-&gt;maxSubBusNumber
comma
id|BridgeInfo-&gt;logicalSlotNumber
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BridgeInfo-&gt;busUnitInfo.deviceType
op_eq
id|HvCallPci_BridgeDevice
)paren
(brace
multiline_comment|/* Scan_Bridge_Slot...: 0x18.00.12 */
id|scan_bridge_slot
c_func
(paren
id|bus
comma
id|BridgeInfo
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;PCI: Invalid Bridge Configuration(0x%02X)&quot;
comma
id|BridgeInfo-&gt;busUnitInfo.deviceType
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|HvRc
op_ne
l_int|0x000B
)paren
id|pci_Log_Error
c_func
(paren
l_string|&quot;EADs Connect&quot;
comma
id|bus
comma
id|SubBus
comma
id|AgentId
comma
id|HvRc
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|BridgeInfo
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This assumes that the node slot is always on the primary bus!&n; */
DECL|function|scan_bridge_slot
r_static
r_int
id|scan_bridge_slot
c_func
(paren
id|HvBusNumber
id|Bus
comma
r_struct
id|HvCallPci_BridgeInfo
op_star
id|BridgeInfo
)paren
(brace
r_struct
id|iSeries_Device_Node
op_star
id|node
suffix:semicolon
id|HvSubBusNumber
id|SubBus
op_assign
id|BridgeInfo-&gt;subBusNumber
suffix:semicolon
id|u16
id|VendorId
op_assign
l_int|0
suffix:semicolon
r_int
id|HvRc
op_assign
l_int|0
suffix:semicolon
id|u8
id|Irq
op_assign
l_int|0
suffix:semicolon
r_int
id|IdSel
op_assign
id|ISERIES_GET_DEVICE_FROM_SUBBUS
c_func
(paren
id|SubBus
)paren
suffix:semicolon
r_int
id|Function
op_assign
id|ISERIES_GET_FUNCTION_FROM_SUBBUS
c_func
(paren
id|SubBus
)paren
suffix:semicolon
id|HvAgentId
id|EADsIdSel
op_assign
id|ISERIES_PCI_AGENTID
c_func
(paren
id|IdSel
comma
id|Function
)paren
suffix:semicolon
multiline_comment|/* iSeries_allocate_IRQ.: 0x18.00.12(0xA3) */
id|Irq
op_assign
id|iSeries_allocate_IRQ
c_func
(paren
id|Bus
comma
l_int|0
comma
id|EADsIdSel
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;PCI:- allocate and assign IRQ 0x%02X.%02X.%02X = 0x%02X&bslash;n&quot;
comma
id|Bus
comma
l_int|0
comma
id|EADsIdSel
comma
id|Irq
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Connect all functions of any device found.  &n;&t; */
r_for
c_loop
(paren
id|IdSel
op_assign
l_int|1
suffix:semicolon
id|IdSel
op_le
id|BridgeInfo-&gt;maxAgents
suffix:semicolon
op_increment
id|IdSel
)paren
(brace
r_for
c_loop
(paren
id|Function
op_assign
l_int|0
suffix:semicolon
id|Function
OL
l_int|8
suffix:semicolon
op_increment
id|Function
)paren
(brace
id|HvAgentId
id|AgentId
op_assign
id|ISERIES_PCI_AGENTID
c_func
(paren
id|IdSel
comma
id|Function
)paren
suffix:semicolon
id|HvRc
op_assign
id|HvCallXm_connectBusUnit
c_func
(paren
id|Bus
comma
id|SubBus
comma
id|AgentId
comma
id|Irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HvRc
op_ne
l_int|0
)paren
(brace
id|pci_Log_Error
c_func
(paren
l_string|&quot;Connect Bus Unit&quot;
comma
id|Bus
comma
id|SubBus
comma
id|AgentId
comma
id|HvRc
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|HvRc
op_assign
id|HvCallPci_configLoad16
c_func
(paren
id|Bus
comma
id|SubBus
comma
id|AgentId
comma
id|PCI_VENDOR_ID
comma
op_amp
id|VendorId
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HvRc
op_ne
l_int|0
)paren
(brace
id|pci_Log_Error
c_func
(paren
l_string|&quot;Read Vendor&quot;
comma
id|Bus
comma
id|SubBus
comma
id|AgentId
comma
id|HvRc
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;read vendor ID: %x&bslash;n&quot;
comma
id|VendorId
)paren
suffix:semicolon
multiline_comment|/* FoundDevice: 0x18.28.10 = 0x12AE */
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;PCI:- FoundDevice: 0x%02X.%02X.%02X = 0x%04X, irq %d&bslash;n&quot;
comma
id|Bus
comma
id|SubBus
comma
id|AgentId
comma
id|VendorId
comma
id|Irq
)paren
suffix:semicolon
id|HvRc
op_assign
id|HvCallPci_configStore8
c_func
(paren
id|Bus
comma
id|SubBus
comma
id|AgentId
comma
id|PCI_INTERRUPT_LINE
comma
id|Irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HvRc
op_ne
l_int|0
)paren
id|pci_Log_Error
c_func
(paren
l_string|&quot;PciCfgStore Irq Failed!&quot;
comma
id|Bus
comma
id|SubBus
comma
id|AgentId
comma
id|HvRc
)paren
suffix:semicolon
op_increment
id|DeviceCount
suffix:semicolon
id|node
op_assign
id|build_device_node
c_func
(paren
id|Bus
comma
id|SubBus
comma
id|EADsIdSel
comma
id|Function
)paren
suffix:semicolon
id|node-&gt;Vendor
op_assign
id|VendorId
suffix:semicolon
id|node-&gt;Irq
op_assign
id|Irq
suffix:semicolon
id|node-&gt;LogicalSlot
op_assign
id|BridgeInfo-&gt;logicalSlotNumber
suffix:semicolon
)brace
multiline_comment|/* for (Function = 0; Function &lt; 8; ++Function) */
)brace
multiline_comment|/* for (IdSel = 1; IdSel &lt;= MaxAgents; ++IdSel) */
r_return
id|HvRc
suffix:semicolon
)brace
multiline_comment|/*&n; * I/0 Memory copy MUST use mmio commands on iSeries&n; * To do; For performance, include the hv call directly&n; */
DECL|function|iSeries_memset_io
r_void
id|iSeries_memset_io
c_func
(paren
r_volatile
r_void
id|__iomem
op_star
id|dest
comma
r_char
id|c
comma
r_int
id|Count
)paren
(brace
id|u8
id|ByteValue
op_assign
id|c
suffix:semicolon
r_int
id|NumberOfBytes
op_assign
id|Count
suffix:semicolon
r_while
c_loop
(paren
id|NumberOfBytes
OG
l_int|0
)paren
(brace
id|iSeries_Write_Byte
c_func
(paren
id|ByteValue
comma
id|dest
op_increment
)paren
suffix:semicolon
op_decrement
id|NumberOfBytes
suffix:semicolon
)brace
)brace
DECL|variable|iSeries_memset_io
id|EXPORT_SYMBOL
c_func
(paren
id|iSeries_memset_io
)paren
suffix:semicolon
DECL|function|iSeries_memcpy_toio
r_void
id|iSeries_memcpy_toio
c_func
(paren
r_volatile
r_void
id|__iomem
op_star
id|dest
comma
r_void
op_star
id|source
comma
r_int
id|count
)paren
(brace
r_char
op_star
id|src
op_assign
id|source
suffix:semicolon
r_int
id|NumberOfBytes
op_assign
id|count
suffix:semicolon
r_while
c_loop
(paren
id|NumberOfBytes
OG
l_int|0
)paren
(brace
id|iSeries_Write_Byte
c_func
(paren
op_star
id|src
op_increment
comma
id|dest
op_increment
)paren
suffix:semicolon
op_decrement
id|NumberOfBytes
suffix:semicolon
)brace
)brace
DECL|variable|iSeries_memcpy_toio
id|EXPORT_SYMBOL
c_func
(paren
id|iSeries_memcpy_toio
)paren
suffix:semicolon
DECL|function|iSeries_memcpy_fromio
r_void
id|iSeries_memcpy_fromio
c_func
(paren
r_void
op_star
id|dest
comma
r_const
r_volatile
r_void
id|__iomem
op_star
id|src
comma
r_int
id|count
)paren
(brace
r_char
op_star
id|dst
op_assign
id|dest
suffix:semicolon
r_int
id|NumberOfBytes
op_assign
id|count
suffix:semicolon
r_while
c_loop
(paren
id|NumberOfBytes
OG
l_int|0
)paren
(brace
op_star
id|dst
op_increment
op_assign
id|iSeries_Read_Byte
c_func
(paren
id|src
op_increment
)paren
suffix:semicolon
op_decrement
id|NumberOfBytes
suffix:semicolon
)brace
)brace
DECL|variable|iSeries_memcpy_fromio
id|EXPORT_SYMBOL
c_func
(paren
id|iSeries_memcpy_fromio
)paren
suffix:semicolon
multiline_comment|/*&n; * Look down the chain to find the matching Device Device&n; */
DECL|function|find_Device_Node
r_static
r_struct
id|iSeries_Device_Node
op_star
id|find_Device_Node
c_func
(paren
r_int
id|bus
comma
r_int
id|devfn
)paren
(brace
r_struct
id|list_head
op_star
id|pos
suffix:semicolon
id|list_for_each
c_func
(paren
id|pos
comma
op_amp
id|iSeries_Global_Device_List
)paren
(brace
r_struct
id|iSeries_Device_Node
op_star
id|node
op_assign
id|list_entry
c_func
(paren
id|pos
comma
r_struct
id|iSeries_Device_Node
comma
id|Device_List
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bus
op_eq
id|ISERIES_BUS
c_func
(paren
id|node
)paren
)paren
op_logical_and
(paren
id|devfn
op_eq
id|node-&gt;DevFn
)paren
)paren
r_return
id|node
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/*&n; * Returns the device node for the passed pci_dev&n; * Sanity Check Node PciDev to passed pci_dev&n; * If none is found, returns a NULL which the client must handle.&n; */
r_static
r_struct
id|iSeries_Device_Node
op_star
id|get_Device_Node
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|iSeries_Device_Node
op_star
id|node
suffix:semicolon
id|node
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
r_if
c_cond
(paren
id|node
op_eq
l_int|NULL
op_logical_or
id|node-&gt;PciDev
op_ne
id|pdev
)paren
id|node
op_assign
id|find_Device_Node
c_func
(paren
id|pdev-&gt;bus-&gt;number
comma
id|pdev-&gt;devfn
)paren
suffix:semicolon
r_return
id|node
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Config space read and write functions.&n; * For now at least, we look for the device node for the bus and devfn&n; * that we are asked to access.  It may be possible to translate the devfn&n; * to a subbus and deviceid more directly.&n; */
DECL|variable|hv_cfg_read_func
r_static
id|u64
id|hv_cfg_read_func
(braket
l_int|4
)braket
op_assign
(brace
id|HvCallPciConfigLoad8
comma
id|HvCallPciConfigLoad16
comma
id|HvCallPciConfigLoad32
comma
id|HvCallPciConfigLoad32
)brace
suffix:semicolon
DECL|variable|hv_cfg_write_func
r_static
id|u64
id|hv_cfg_write_func
(braket
l_int|4
)braket
op_assign
(brace
id|HvCallPciConfigStore8
comma
id|HvCallPciConfigStore16
comma
id|HvCallPciConfigStore32
comma
id|HvCallPciConfigStore32
)brace
suffix:semicolon
multiline_comment|/*&n; * Read PCI config space&n; */
DECL|function|iSeries_pci_read_config
r_static
r_int
id|iSeries_pci_read_config
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|offset
comma
r_int
id|size
comma
id|u32
op_star
id|val
)paren
(brace
r_struct
id|iSeries_Device_Node
op_star
id|node
op_assign
id|find_Device_Node
c_func
(paren
id|bus-&gt;number
comma
id|devfn
)paren
suffix:semicolon
id|u64
id|fn
suffix:semicolon
r_struct
id|HvCallPci_LoadReturn
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|node
op_eq
l_int|NULL
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|fn
op_assign
id|hv_cfg_read_func
(braket
(paren
id|size
op_minus
l_int|1
)paren
op_amp
l_int|3
)braket
suffix:semicolon
id|HvCall3Ret16
c_func
(paren
id|fn
comma
op_amp
id|ret
comma
id|node-&gt;DsaAddr.DsaAddr
comma
id|offset
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret.rc
op_ne
l_int|0
)paren
(brace
op_star
id|val
op_assign
op_complement
l_int|0
suffix:semicolon
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
multiline_comment|/* or something */
)brace
op_star
id|val
op_assign
id|ret.value
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Write PCI config space&n; */
DECL|function|iSeries_pci_write_config
r_static
r_int
id|iSeries_pci_write_config
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|offset
comma
r_int
id|size
comma
id|u32
id|val
)paren
(brace
r_struct
id|iSeries_Device_Node
op_star
id|node
op_assign
id|find_Device_Node
c_func
(paren
id|bus-&gt;number
comma
id|devfn
)paren
suffix:semicolon
id|u64
id|fn
suffix:semicolon
id|u64
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|node
op_eq
l_int|NULL
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|fn
op_assign
id|hv_cfg_write_func
(braket
(paren
id|size
op_minus
l_int|1
)paren
op_amp
l_int|3
)braket
suffix:semicolon
id|ret
op_assign
id|HvCall4
c_func
(paren
id|fn
comma
id|node-&gt;DsaAddr.DsaAddr
comma
id|offset
comma
id|val
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|iSeries_pci_ops
r_static
r_struct
id|pci_ops
id|iSeries_pci_ops
op_assign
(brace
dot
id|read
op_assign
id|iSeries_pci_read_config
comma
dot
id|write
op_assign
id|iSeries_pci_write_config
)brace
suffix:semicolon
multiline_comment|/*&n; * Check Return Code&n; * -&gt; On Failure, print and log information.&n; *    Increment Retry Count, if exceeds max, panic partition.&n; * -&gt; If in retry, print and log success &n; *&n; * PCI: Device 23.90 ReadL I/O Error( 0): 0x1234&n; * PCI: Device 23.90 ReadL Retry( 1)&n; * PCI: Device 23.90 ReadL Retry Successful(1)&n; */
DECL|function|CheckReturnCode
r_static
r_int
id|CheckReturnCode
c_func
(paren
r_char
op_star
id|TextHdr
comma
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
comma
id|u64
id|ret
)paren
(brace
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
op_increment
id|Pci_Error_Count
suffix:semicolon
op_increment
id|DevNode-&gt;IoRetry
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI: %s: Device 0x%04X:%02X  I/O Error(%2d): 0x%04X&bslash;n&quot;
comma
id|TextHdr
comma
id|DevNode-&gt;DsaAddr.Dsa.busNumber
comma
id|DevNode-&gt;DevFn
comma
id|DevNode-&gt;IoRetry
comma
(paren
r_int
)paren
id|ret
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Bump the retry and check for retry count exceeded.&n;&t;&t; * If, Exceeded, panic the system.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|DevNode-&gt;IoRetry
OG
id|Pci_Retry_Max
)paren
op_logical_and
(paren
id|Pci_Error_Flag
OG
l_int|0
)paren
)paren
(brace
id|mf_display_src
c_func
(paren
l_int|0xB6000103
)paren
suffix:semicolon
id|panic_timeout
op_assign
l_int|0
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;PCI: Hardware I/O Error, SRC B6000103, &quot;
l_string|&quot;Automatic Reboot Disabled.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Retry Try */
)brace
multiline_comment|/* If retry was in progress, log success and rest retry count */
r_if
c_cond
(paren
id|DevNode-&gt;IoRetry
OG
l_int|0
)paren
id|DevNode-&gt;IoRetry
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Translate the I/O Address into a device node, bar, and bar offset.&n; * Note: Make sure the passed variable end up on the stack to avoid&n; * the exposure of being device global.&n; */
DECL|function|xlate_iomm_address
r_static
r_inline
r_struct
id|iSeries_Device_Node
op_star
id|xlate_iomm_address
c_func
(paren
r_const
r_volatile
r_void
id|__iomem
op_star
id|IoAddress
comma
id|u64
op_star
id|dsaptr
comma
id|u64
op_star
id|BarOffsetPtr
)paren
(brace
r_int
r_int
id|OrigIoAddr
suffix:semicolon
r_int
r_int
id|BaseIoAddr
suffix:semicolon
r_int
r_int
id|TableIndex
suffix:semicolon
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
suffix:semicolon
id|OrigIoAddr
op_assign
(paren
r_int
r_int
id|__force
)paren
id|IoAddress
suffix:semicolon
r_if
c_cond
(paren
(paren
id|OrigIoAddr
OL
id|BASE_IO_MEMORY
)paren
op_logical_or
(paren
id|OrigIoAddr
op_ge
id|max_io_memory
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
id|BaseIoAddr
op_assign
id|OrigIoAddr
op_minus
id|BASE_IO_MEMORY
suffix:semicolon
id|TableIndex
op_assign
id|BaseIoAddr
op_div
id|IOMM_TABLE_ENTRY_SIZE
suffix:semicolon
id|DevNode
op_assign
id|iomm_table
(braket
id|TableIndex
)braket
suffix:semicolon
r_if
c_cond
(paren
id|DevNode
op_ne
l_int|NULL
)paren
(brace
r_int
id|barnum
op_assign
id|iobar_table
(braket
id|TableIndex
)braket
suffix:semicolon
op_star
id|dsaptr
op_assign
id|DevNode-&gt;DsaAddr.DsaAddr
op_or
(paren
id|barnum
op_lshift
l_int|24
)paren
suffix:semicolon
op_star
id|BarOffsetPtr
op_assign
id|BaseIoAddr
op_mod
id|IOMM_TABLE_ENTRY_SIZE
suffix:semicolon
)brace
r_else
id|panic
c_func
(paren
l_string|&quot;PCI: Invalid PCI IoAddress detected!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|DevNode
suffix:semicolon
)brace
multiline_comment|/*&n; * Read MM I/O Instructions for the iSeries&n; * On MM I/O error, all ones are returned and iSeries_pci_IoError is cal&n; * else, data is returned in big Endian format.&n; *&n; * iSeries_Read_Byte = Read Byte  ( 8 bit)&n; * iSeries_Read_Word = Read Word  (16 bit)&n; * iSeries_Read_Long = Read Long  (32 bit)&n; */
DECL|function|iSeries_Read_Byte
id|u8
id|iSeries_Read_Byte
c_func
(paren
r_const
r_volatile
r_void
id|__iomem
op_star
id|IoAddress
)paren
(brace
id|u64
id|BarOffset
suffix:semicolon
id|u64
id|dsa
suffix:semicolon
r_struct
id|HvCallPci_LoadReturn
id|ret
suffix:semicolon
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
op_assign
id|xlate_iomm_address
c_func
(paren
id|IoAddress
comma
op_amp
id|dsa
comma
op_amp
id|BarOffset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DevNode
op_eq
l_int|NULL
)paren
(brace
r_static
r_int
r_int
id|last_jiffies
suffix:semicolon
r_static
r_int
id|num_printed
suffix:semicolon
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|last_jiffies
)paren
OG
l_int|60
op_star
id|HZ
)paren
(brace
id|last_jiffies
op_assign
id|jiffies
suffix:semicolon
id|num_printed
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|num_printed
op_increment
OL
l_int|10
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;iSeries_Read_Byte: invalid access at IO address %p&bslash;n&quot;
comma
id|IoAddress
)paren
suffix:semicolon
r_return
l_int|0xff
suffix:semicolon
)brace
r_do
(brace
op_increment
id|Pci_Io_Read_Count
suffix:semicolon
id|HvCall3Ret16
c_func
(paren
id|HvCallPciBarLoad8
comma
op_amp
id|ret
comma
id|dsa
comma
id|BarOffset
comma
l_int|0
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|CheckReturnCode
c_func
(paren
l_string|&quot;RDB&quot;
comma
id|DevNode
comma
id|ret.rc
)paren
op_ne
l_int|0
)paren
suffix:semicolon
r_return
(paren
id|u8
)paren
id|ret.value
suffix:semicolon
)brace
DECL|variable|iSeries_Read_Byte
id|EXPORT_SYMBOL
c_func
(paren
id|iSeries_Read_Byte
)paren
suffix:semicolon
DECL|function|iSeries_Read_Word
id|u16
id|iSeries_Read_Word
c_func
(paren
r_const
r_volatile
r_void
id|__iomem
op_star
id|IoAddress
)paren
(brace
id|u64
id|BarOffset
suffix:semicolon
id|u64
id|dsa
suffix:semicolon
r_struct
id|HvCallPci_LoadReturn
id|ret
suffix:semicolon
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
op_assign
id|xlate_iomm_address
c_func
(paren
id|IoAddress
comma
op_amp
id|dsa
comma
op_amp
id|BarOffset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DevNode
op_eq
l_int|NULL
)paren
(brace
r_static
r_int
r_int
id|last_jiffies
suffix:semicolon
r_static
r_int
id|num_printed
suffix:semicolon
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|last_jiffies
)paren
OG
l_int|60
op_star
id|HZ
)paren
(brace
id|last_jiffies
op_assign
id|jiffies
suffix:semicolon
id|num_printed
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|num_printed
op_increment
OL
l_int|10
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;iSeries_Read_Word: invalid access at IO address %p&bslash;n&quot;
comma
id|IoAddress
)paren
suffix:semicolon
r_return
l_int|0xffff
suffix:semicolon
)brace
r_do
(brace
op_increment
id|Pci_Io_Read_Count
suffix:semicolon
id|HvCall3Ret16
c_func
(paren
id|HvCallPciBarLoad16
comma
op_amp
id|ret
comma
id|dsa
comma
id|BarOffset
comma
l_int|0
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|CheckReturnCode
c_func
(paren
l_string|&quot;RDW&quot;
comma
id|DevNode
comma
id|ret.rc
)paren
op_ne
l_int|0
)paren
suffix:semicolon
r_return
id|swab16
c_func
(paren
(paren
id|u16
)paren
id|ret.value
)paren
suffix:semicolon
)brace
DECL|variable|iSeries_Read_Word
id|EXPORT_SYMBOL
c_func
(paren
id|iSeries_Read_Word
)paren
suffix:semicolon
DECL|function|iSeries_Read_Long
id|u32
id|iSeries_Read_Long
c_func
(paren
r_const
r_volatile
r_void
id|__iomem
op_star
id|IoAddress
)paren
(brace
id|u64
id|BarOffset
suffix:semicolon
id|u64
id|dsa
suffix:semicolon
r_struct
id|HvCallPci_LoadReturn
id|ret
suffix:semicolon
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
op_assign
id|xlate_iomm_address
c_func
(paren
id|IoAddress
comma
op_amp
id|dsa
comma
op_amp
id|BarOffset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DevNode
op_eq
l_int|NULL
)paren
(brace
r_static
r_int
r_int
id|last_jiffies
suffix:semicolon
r_static
r_int
id|num_printed
suffix:semicolon
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|last_jiffies
)paren
OG
l_int|60
op_star
id|HZ
)paren
(brace
id|last_jiffies
op_assign
id|jiffies
suffix:semicolon
id|num_printed
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|num_printed
op_increment
OL
l_int|10
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;iSeries_Read_Long: invalid access at IO address %p&bslash;n&quot;
comma
id|IoAddress
)paren
suffix:semicolon
r_return
l_int|0xffffffff
suffix:semicolon
)brace
r_do
(brace
op_increment
id|Pci_Io_Read_Count
suffix:semicolon
id|HvCall3Ret16
c_func
(paren
id|HvCallPciBarLoad32
comma
op_amp
id|ret
comma
id|dsa
comma
id|BarOffset
comma
l_int|0
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|CheckReturnCode
c_func
(paren
l_string|&quot;RDL&quot;
comma
id|DevNode
comma
id|ret.rc
)paren
op_ne
l_int|0
)paren
suffix:semicolon
r_return
id|swab32
c_func
(paren
(paren
id|u32
)paren
id|ret.value
)paren
suffix:semicolon
)brace
DECL|variable|iSeries_Read_Long
id|EXPORT_SYMBOL
c_func
(paren
id|iSeries_Read_Long
)paren
suffix:semicolon
multiline_comment|/*&n; * Write MM I/O Instructions for the iSeries&n; *&n; * iSeries_Write_Byte = Write Byte (8 bit)&n; * iSeries_Write_Word = Write Word(16 bit)&n; * iSeries_Write_Long = Write Long(32 bit)&n; */
DECL|function|iSeries_Write_Byte
r_void
id|iSeries_Write_Byte
c_func
(paren
id|u8
id|data
comma
r_volatile
r_void
id|__iomem
op_star
id|IoAddress
)paren
(brace
id|u64
id|BarOffset
suffix:semicolon
id|u64
id|dsa
suffix:semicolon
id|u64
id|rc
suffix:semicolon
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
op_assign
id|xlate_iomm_address
c_func
(paren
id|IoAddress
comma
op_amp
id|dsa
comma
op_amp
id|BarOffset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DevNode
op_eq
l_int|NULL
)paren
(brace
r_static
r_int
r_int
id|last_jiffies
suffix:semicolon
r_static
r_int
id|num_printed
suffix:semicolon
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|last_jiffies
)paren
OG
l_int|60
op_star
id|HZ
)paren
(brace
id|last_jiffies
op_assign
id|jiffies
suffix:semicolon
id|num_printed
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|num_printed
op_increment
OL
l_int|10
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;iSeries_Write_Byte: invalid access at IO address %p&bslash;n&quot;
comma
id|IoAddress
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_do
(brace
op_increment
id|Pci_Io_Write_Count
suffix:semicolon
id|rc
op_assign
id|HvCall4
c_func
(paren
id|HvCallPciBarStore8
comma
id|dsa
comma
id|BarOffset
comma
id|data
comma
l_int|0
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|CheckReturnCode
c_func
(paren
l_string|&quot;WWB&quot;
comma
id|DevNode
comma
id|rc
)paren
op_ne
l_int|0
)paren
suffix:semicolon
)brace
DECL|variable|iSeries_Write_Byte
id|EXPORT_SYMBOL
c_func
(paren
id|iSeries_Write_Byte
)paren
suffix:semicolon
DECL|function|iSeries_Write_Word
r_void
id|iSeries_Write_Word
c_func
(paren
id|u16
id|data
comma
r_volatile
r_void
id|__iomem
op_star
id|IoAddress
)paren
(brace
id|u64
id|BarOffset
suffix:semicolon
id|u64
id|dsa
suffix:semicolon
id|u64
id|rc
suffix:semicolon
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
op_assign
id|xlate_iomm_address
c_func
(paren
id|IoAddress
comma
op_amp
id|dsa
comma
op_amp
id|BarOffset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DevNode
op_eq
l_int|NULL
)paren
(brace
r_static
r_int
r_int
id|last_jiffies
suffix:semicolon
r_static
r_int
id|num_printed
suffix:semicolon
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|last_jiffies
)paren
OG
l_int|60
op_star
id|HZ
)paren
(brace
id|last_jiffies
op_assign
id|jiffies
suffix:semicolon
id|num_printed
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|num_printed
op_increment
OL
l_int|10
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;iSeries_Write_Word: invalid access at IO address %p&bslash;n&quot;
comma
id|IoAddress
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_do
(brace
op_increment
id|Pci_Io_Write_Count
suffix:semicolon
id|rc
op_assign
id|HvCall4
c_func
(paren
id|HvCallPciBarStore16
comma
id|dsa
comma
id|BarOffset
comma
id|swab16
c_func
(paren
id|data
)paren
comma
l_int|0
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|CheckReturnCode
c_func
(paren
l_string|&quot;WWW&quot;
comma
id|DevNode
comma
id|rc
)paren
op_ne
l_int|0
)paren
suffix:semicolon
)brace
DECL|variable|iSeries_Write_Word
id|EXPORT_SYMBOL
c_func
(paren
id|iSeries_Write_Word
)paren
suffix:semicolon
DECL|function|iSeries_Write_Long
r_void
id|iSeries_Write_Long
c_func
(paren
id|u32
id|data
comma
r_volatile
r_void
id|__iomem
op_star
id|IoAddress
)paren
(brace
id|u64
id|BarOffset
suffix:semicolon
id|u64
id|dsa
suffix:semicolon
id|u64
id|rc
suffix:semicolon
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
op_assign
id|xlate_iomm_address
c_func
(paren
id|IoAddress
comma
op_amp
id|dsa
comma
op_amp
id|BarOffset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DevNode
op_eq
l_int|NULL
)paren
(brace
r_static
r_int
r_int
id|last_jiffies
suffix:semicolon
r_static
r_int
id|num_printed
suffix:semicolon
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|last_jiffies
)paren
OG
l_int|60
op_star
id|HZ
)paren
(brace
id|last_jiffies
op_assign
id|jiffies
suffix:semicolon
id|num_printed
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|num_printed
op_increment
OL
l_int|10
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;iSeries_Write_Long: invalid access at IO address %p&bslash;n&quot;
comma
id|IoAddress
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_do
(brace
op_increment
id|Pci_Io_Write_Count
suffix:semicolon
id|rc
op_assign
id|HvCall4
c_func
(paren
id|HvCallPciBarStore32
comma
id|dsa
comma
id|BarOffset
comma
id|swab32
c_func
(paren
id|data
)paren
comma
l_int|0
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|CheckReturnCode
c_func
(paren
l_string|&quot;WWL&quot;
comma
id|DevNode
comma
id|rc
)paren
op_ne
l_int|0
)paren
suffix:semicolon
)brace
DECL|variable|iSeries_Write_Long
id|EXPORT_SYMBOL
c_func
(paren
id|iSeries_Write_Long
)paren
suffix:semicolon
eof
