multiline_comment|/*&n; * iSeries_pci.c&n; *&n; * Copyright (C) 2001 Allan Trautman, IBM Corporation&n; *&n; * iSeries specific routines for PCI.&n; * &n; * Based on code from pci.c and iSeries_pci.c 32bit&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; * &n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; * &n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/list.h&gt; 
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ide.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#include &lt;asm/ppcdebug.h&gt;
macro_line|#include &lt;asm/naca.h&gt;
macro_line|#include &lt;asm/flight_recorder.h&gt;
macro_line|#include &lt;asm/pci_dma.h&gt;
macro_line|#include &lt;asm/iSeries/HvCallPci.h&gt;
macro_line|#include &lt;asm/iSeries/HvCallSm.h&gt;
macro_line|#include &lt;asm/iSeries/HvCallXm.h&gt;
macro_line|#include &lt;asm/iSeries/LparData.h&gt;
macro_line|#include &lt;asm/iSeries/iSeries_irq.h&gt;
macro_line|#include &lt;asm/iSeries/iSeries_pci.h&gt;
macro_line|#include &lt;asm/iSeries/mf.h&gt;
macro_line|#include &quot;iSeries_IoMmTable.h&quot;
macro_line|#include &quot;pci.h&quot;
r_extern
r_struct
id|pci_controller
op_star
id|hose_head
suffix:semicolon
r_extern
r_struct
id|pci_controller
op_star
op_star
id|hose_tail
suffix:semicolon
r_extern
r_int
id|global_phb_number
suffix:semicolon
r_extern
r_int
id|panic_timeout
suffix:semicolon
r_extern
r_struct
id|device_node
op_star
id|allnodes
suffix:semicolon
r_extern
r_int
r_int
id|phb_tce_table_init
c_func
(paren
r_struct
id|pci_controller
op_star
id|phb
)paren
suffix:semicolon
r_extern
r_int
r_int
id|iSeries_Base_Io_Memory
suffix:semicolon
r_extern
r_struct
id|pci_ops
id|iSeries_pci_ops
suffix:semicolon
r_extern
r_struct
id|flightRecorder
op_star
id|PciFr
suffix:semicolon
r_extern
r_struct
id|TceTable
op_star
id|tceTables
(braket
l_int|256
)braket
suffix:semicolon
multiline_comment|/*******************************************************************&n; * Counters and control flags. &n; *******************************************************************/
r_extern
r_int
id|Pci_Io_Read_Count
suffix:semicolon
r_extern
r_int
id|Pci_Io_Write_Count
suffix:semicolon
r_extern
r_int
id|Pci_Cfg_Read_Count
suffix:semicolon
r_extern
r_int
id|Pci_Cfg_Write_Count
suffix:semicolon
r_extern
r_int
id|Pci_Error_Count
suffix:semicolon
r_extern
r_int
id|Pci_Retry_Max
suffix:semicolon
r_extern
r_int
id|Pci_Error_Flag
suffix:semicolon
r_extern
r_int
id|Pci_Trace_Flag
suffix:semicolon
r_extern
r_void
id|iSeries_MmIoTest
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/*******************************************************************&n; * Forward declares of prototypes. &n; *******************************************************************/
r_struct
id|iSeries_Device_Node
op_star
id|find_Device_Node
c_func
(paren
r_struct
id|pci_dev
op_star
id|PciDev
)paren
suffix:semicolon
r_struct
id|iSeries_Device_Node
op_star
id|get_Device_Node
c_func
(paren
r_struct
id|pci_dev
op_star
id|PciDev
)paren
suffix:semicolon
r_int
r_int
id|find_and_init_phbs
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|fixup_resources
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
suffix:semicolon
r_void
id|iSeries_pcibios_fixup
c_func
(paren
r_void
)paren
suffix:semicolon
r_struct
id|pci_controller
op_star
id|alloc_phb
c_func
(paren
r_struct
id|device_node
op_star
id|dev
comma
r_char
op_star
id|model
comma
r_int
r_int
id|addr_size_words
)paren
suffix:semicolon
r_void
id|iSeries_Scan_PHBs_Slots
c_func
(paren
r_struct
id|pci_controller
op_star
id|Phb
)paren
suffix:semicolon
r_void
id|iSeries_Scan_EADs_Bridge
c_func
(paren
id|HvBusNumber
id|Bus
comma
id|HvSubBusNumber
id|SubBus
comma
r_int
id|IdSel
)paren
suffix:semicolon
r_int
id|iSeries_Scan_Bridge_Slot
c_func
(paren
id|HvBusNumber
id|Bus
comma
r_struct
id|HvCallPci_BridgeInfo
op_star
id|Info
)paren
suffix:semicolon
r_void
id|list_device_nodes
c_func
(paren
r_void
)paren
suffix:semicolon
r_struct
id|pci_dev
suffix:semicolon
r_extern
r_struct
id|list_head
id|iSeries_Global_Device_List
suffix:semicolon
DECL|variable|DeviceCount
r_int
id|DeviceCount
op_assign
l_int|0
suffix:semicolon
multiline_comment|/**********************************************************************************&n; * Log Error infor in Flight Recorder to system Console.&n; * Filter out the device not there errors.&n; * PCI: EADs Connect Failed 0x18.58.10 Rc: 0x00xx&n; * PCI: Read Vendor Failed 0x18.58.10 Rc: 0x00xx&n; * PCI: Connect Bus Unit Failed 0x18.58.10 Rc: 0x00xx&n; **********************************************************************************/
DECL|function|pci_Log_Error
r_void
id|pci_Log_Error
c_func
(paren
r_char
op_star
id|Error_Text
comma
r_int
id|Bus
comma
r_int
id|SubBus
comma
r_int
id|AgentId
comma
r_int
id|HvRc
)paren
(brace
r_if
c_cond
(paren
id|HvRc
op_ne
l_int|0x0302
)paren
(brace
r_char
id|ErrorString
(braket
l_int|128
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|ErrorString
comma
l_string|&quot;%s Failed: 0x%02X.%02X.%02X Rc: 0x%04X&quot;
comma
id|Error_Text
comma
id|Bus
comma
id|SubBus
comma
id|AgentId
comma
id|HvRc
)paren
suffix:semicolon
id|PCIFR
c_func
(paren
id|ErrorString
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI: %s&bslash;n&quot;
comma
id|ErrorString
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**********************************************************************************&n; * Dump the iSeries Temp Device Node &n; *&lt;4&gt;buswalk [swapper : - DeviceNode: 0xC000000000634300&n; *&lt;4&gt;00. Device Node   = 0xC000000000634300&n; *&lt;4&gt;    - PciDev      = 0x0000000000000000&n; *&lt;4&gt;    - tDevice     = 0x  17:01.00  0x1022 00&n; *&lt;4&gt;  4. Device Node = 0xC000000000634480&n; *&lt;4&gt;     - PciDev    = 0x0000000000000000&n; *&lt;4&gt;     - Device    = 0x  18:38.16 Irq:0xA7 Vendor:0x1014  Flags:0x00&n; *&lt;4&gt;     - Devfn     = 0xB0: 22.18&n; **********************************************************************************/
DECL|function|dumpDevice_Node
r_void
id|dumpDevice_Node
c_func
(paren
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
)paren
(brace
id|udbg_printf
c_func
(paren
l_string|&quot;Device Node      = 0x%p&bslash;n&quot;
comma
id|DevNode
)paren
suffix:semicolon
id|udbg_printf
c_func
(paren
l_string|&quot;     - PciDev    = 0x%p&bslash;n&quot;
comma
id|DevNode-&gt;PciDev
)paren
suffix:semicolon
id|udbg_printf
c_func
(paren
l_string|&quot;     - Device    = 0x%4X:%02X.%02X (0x%02X)&bslash;n&quot;
comma
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|ISERIES_SUBBUS
c_func
(paren
id|DevNode
)paren
comma
id|DevNode-&gt;AgentId
comma
id|DevNode-&gt;DevFn
)paren
suffix:semicolon
id|udbg_printf
c_func
(paren
l_string|&quot;     - LSlot     = 0x%02X&bslash;n&quot;
comma
id|DevNode-&gt;LogicalSlot
)paren
suffix:semicolon
id|udbg_printf
c_func
(paren
l_string|&quot;     - TceTable  = 0x%p&bslash;n  &quot;
comma
id|DevNode-&gt;DevTceTable
)paren
suffix:semicolon
id|udbg_printf
c_func
(paren
l_string|&quot;     - DSA       = 0x%04X&bslash;n&quot;
comma
id|ISERIES_DSA
c_func
(paren
id|DevNode
)paren
op_rshift
l_int|32
)paren
suffix:semicolon
id|udbg_printf
c_func
(paren
l_string|&quot;                 = Irq:0x%02X Vendor:0x%04X  Flags:0x%02X&bslash;n&quot;
comma
id|DevNode-&gt;Irq
comma
id|DevNode-&gt;Vendor
comma
id|DevNode-&gt;Flags
)paren
suffix:semicolon
id|udbg_printf
c_func
(paren
l_string|&quot;     - Location  = %s&bslash;n&quot;
comma
id|DevNode-&gt;CardLocation
)paren
suffix:semicolon
)brace
multiline_comment|/**********************************************************************************&n; * Walk down the device node chain &n; **********************************************************************************/
DECL|function|list_device_nodes
r_void
id|list_device_nodes
c_func
(paren
r_void
)paren
(brace
r_struct
id|list_head
op_star
id|Device_Node_Ptr
op_assign
id|iSeries_Global_Device_List.next
suffix:semicolon
r_while
c_loop
(paren
id|Device_Node_Ptr
op_ne
op_amp
id|iSeries_Global_Device_List
)paren
(brace
id|dumpDevice_Node
c_func
(paren
(paren
r_struct
id|iSeries_Device_Node
op_star
)paren
id|Device_Node_Ptr
)paren
suffix:semicolon
id|Device_Node_Ptr
op_assign
id|Device_Node_Ptr-&gt;next
suffix:semicolon
)brace
)brace
multiline_comment|/***********************************************************************&n; * build_device_node(u16 Bus, int SubBus, u8 DevFn)&n; *&n; ***********************************************************************/
DECL|function|build_device_node
r_struct
id|iSeries_Device_Node
op_star
id|build_device_node
c_func
(paren
id|HvBusNumber
id|Bus
comma
id|HvSubBusNumber
id|SubBus
comma
r_int
id|AgentId
comma
r_int
id|Function
)paren
(brace
r_struct
id|iSeries_Device_Node
op_star
id|DeviceNode
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;-build_device_node 0x%02X.%02X.%02X Function: %02X&bslash;n&quot;
comma
id|Bus
comma
id|SubBus
comma
id|AgentId
comma
id|Function
)paren
suffix:semicolon
id|DeviceNode
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|iSeries_Device_Node
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DeviceNode
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|DeviceNode
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|iSeries_Device_Node
)paren
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|DeviceNode-&gt;Device_List
comma
op_amp
id|iSeries_Global_Device_List
)paren
suffix:semicolon
multiline_comment|/*DeviceNode-&gt;DsaAddr      = ((u64)Bus&lt;&lt;48)+((u64)SubBus&lt;&lt;40)+((u64)0x10&lt;&lt;32); */
id|ISERIES_BUS
c_func
(paren
id|DeviceNode
)paren
op_assign
id|Bus
suffix:semicolon
id|ISERIES_SUBBUS
c_func
(paren
id|DeviceNode
)paren
op_assign
id|SubBus
suffix:semicolon
id|DeviceNode-&gt;DsaAddr.deviceId
op_assign
l_int|0x10
suffix:semicolon
id|DeviceNode-&gt;DsaAddr.barNumber
op_assign
l_int|0
suffix:semicolon
id|DeviceNode-&gt;AgentId
op_assign
id|AgentId
suffix:semicolon
id|DeviceNode-&gt;DevFn
op_assign
id|PCI_DEVFN
c_func
(paren
id|ISERIES_ENCODE_DEVICE
c_func
(paren
id|AgentId
)paren
comma
id|Function
)paren
suffix:semicolon
id|DeviceNode-&gt;IoRetry
op_assign
l_int|0
suffix:semicolon
id|iSeries_Get_Location_Code
c_func
(paren
id|DeviceNode
)paren
suffix:semicolon
id|PCIFR
c_func
(paren
l_string|&quot;Device 0x%02X.%2X, Node:0x%p &quot;
comma
id|ISERIES_BUS
c_func
(paren
id|DeviceNode
)paren
comma
id|ISERIES_DEVFUN
c_func
(paren
id|DeviceNode
)paren
comma
id|DeviceNode
)paren
suffix:semicolon
r_return
id|DeviceNode
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n;* &n;* Allocate pci_controller(phb) initialized common variables. &n;* &n;*****************************************************************************/
DECL|function|pci_alloc_pci_controllerX
r_struct
id|pci_controller
op_star
id|pci_alloc_pci_controllerX
c_func
(paren
r_char
op_star
id|model
comma
r_enum
id|phb_types
id|controller_type
)paren
(brace
r_struct
id|pci_controller
op_star
id|hose
suffix:semicolon
id|hose
op_assign
(paren
r_struct
id|pci_controller
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pci_controller
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hose
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|hose
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pci_controller
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|model
)paren
OL
l_int|8
)paren
(brace
id|strcpy
c_func
(paren
id|hose-&gt;what
comma
id|model
)paren
suffix:semicolon
)brace
r_else
id|memcpy
c_func
(paren
id|hose-&gt;what
comma
id|model
comma
l_int|7
)paren
suffix:semicolon
id|hose-&gt;type
op_assign
id|controller_type
suffix:semicolon
id|hose-&gt;global_number
op_assign
id|global_phb_number
suffix:semicolon
id|global_phb_number
op_increment
suffix:semicolon
op_star
id|hose_tail
op_assign
id|hose
suffix:semicolon
id|hose_tail
op_assign
op_amp
id|hose-&gt;next
suffix:semicolon
r_return
id|hose
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * unsigned int __init find_and_init_phbs(void)&n; *&n; * Description:&n; *   This function checks for all possible system PCI host bridges that connect&n; *   PCI buses.  The system hypervisor is queried as to the guest partition&n; *   ownership status.  A pci_controller is build for any bus which is partially&n; *   owned or fully owned by this guest partition.&n; ****************************************************************************/
DECL|function|find_and_init_phbs
r_int
r_int
id|__init
id|find_and_init_phbs
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_controller
op_star
id|phb
suffix:semicolon
id|HvBusNumber
id|BusNumber
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;find_and_init_phbs Entry&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Check all possible buses. */
r_for
c_loop
(paren
id|BusNumber
op_assign
l_int|0
suffix:semicolon
id|BusNumber
OL
l_int|256
suffix:semicolon
id|BusNumber
op_increment
)paren
(brace
r_int
id|RtnCode
op_assign
id|HvCallXm_testBus
c_func
(paren
id|BusNumber
)paren
suffix:semicolon
r_if
c_cond
(paren
id|RtnCode
op_eq
l_int|0
)paren
(brace
id|phb
op_assign
id|pci_alloc_pci_controllerX
c_func
(paren
l_string|&quot;PHB HV&quot;
comma
id|phb_type_hypervisor
)paren
suffix:semicolon
r_if
c_cond
(paren
id|phb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: Allocate pci_controller failed.&bslash;n&quot;
)paren
suffix:semicolon
id|PCIFR
c_func
(paren
l_string|&quot;Allocate pci_controller failed.&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|phb-&gt;pci_mem_offset
op_assign
id|phb-&gt;local_number
op_assign
id|BusNumber
suffix:semicolon
id|phb-&gt;first_busno
op_assign
id|BusNumber
suffix:semicolon
id|phb-&gt;last_busno
op_assign
id|BusNumber
suffix:semicolon
id|phb-&gt;ops
op_assign
op_amp
id|iSeries_pci_ops
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;PCI:Create iSeries pci_controller(%p), Bus: %04X&bslash;n&quot;
comma
id|phb
comma
id|BusNumber
)paren
suffix:semicolon
id|PCIFR
c_func
(paren
l_string|&quot;Create iSeries PHB controller: %04X&quot;
comma
id|BusNumber
)paren
suffix:semicolon
multiline_comment|/***************************************************/
multiline_comment|/* Find and connect the devices.                   */
multiline_comment|/***************************************************/
id|iSeries_Scan_PHBs_Slots
c_func
(paren
id|phb
)paren
suffix:semicolon
)brace
multiline_comment|/* Check for Unexpected Return code, a clue that something */
multiline_comment|/* has gone wrong.                                         */
r_else
r_if
c_cond
(paren
id|RtnCode
op_ne
l_int|0x0301
)paren
(brace
id|PCIFR
c_func
(paren
l_string|&quot;Unexpected Return on Probe(0x%04X): 0x%04X&quot;
comma
id|BusNumber
comma
id|RtnCode
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*********************************************************************** &n; * ppc64_pcibios_init&n; *  &n; * Chance to initialize and structures or variable before PCI Bus walk.&n; *  &n; *&lt;4&gt;buswalk [swapper : iSeries_pcibios_init Entry.&n; *&lt;4&gt;buswalk [swapper : IoMmTable Initialized 0xC00000000034BD30&n; *&lt;4&gt;buswalk [swapper : find_and_init_phbs Entry&n; *&lt;4&gt;buswalk [swapper : Create iSeries pci_controller:(0xC00000001F5C7000), Bus 0x0017&n; *&lt;4&gt;buswalk [swapper : Connect EADs: 0x17.00.12 = 0x00&n; *&lt;4&gt;buswalk [swapper : iSeries_assign_IRQ   0x0017.00.12 = 0x0091&n; *&lt;4&gt;buswalk [swapper : - allocate and assign IRQ 0x17.00.12 = 0x91&n; *&lt;4&gt;buswalk [swapper : - FoundDevice: 0x17.28.10 = 0x12AE&n; *&lt;4&gt;buswalk [swapper : - build_device_node 0x17.28.12&n; *&lt;4&gt;buswalk [swapper : iSeries_pcibios_init Exit.&n; ***********************************************************************/
DECL|function|iSeries_pcibios_init
r_void
id|iSeries_pcibios_init
c_func
(paren
r_void
)paren
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;iSeries_pcibios_init Entry.&bslash;n&quot;
)paren
suffix:semicolon
id|iSeries_IoMmTable_Initialize
c_func
(paren
)paren
suffix:semicolon
id|find_and_init_phbs
c_func
(paren
)paren
suffix:semicolon
id|pci_assign_all_busses
op_assign
l_int|0
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;iSeries_pcibios_init Exit.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n; * iSeries_pcibios_fixup(void)  &n; ***********************************************************************/
DECL|function|iSeries_pcibios_fixup
r_void
id|__init
id|iSeries_pcibios_fixup
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|PciDev
suffix:semicolon
r_struct
id|iSeries_Device_Node
op_star
id|DeviceNode
suffix:semicolon
r_char
id|Buffer
(braket
l_int|256
)braket
suffix:semicolon
r_int
id|DeviceCount
op_assign
l_int|0
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;iSeries_pcibios_fixup Entry.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/******************************************************/
multiline_comment|/* Fix up at the device node and pci_dev relationship */
multiline_comment|/******************************************************/
id|mf_displaySrc
c_func
(paren
l_int|0xC9000100
)paren
suffix:semicolon
id|pci_for_each_dev
c_func
(paren
id|PciDev
)paren
(brace
id|DeviceNode
op_assign
id|find_Device_Node
c_func
(paren
id|PciDev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DeviceNode
op_ne
l_int|NULL
)paren
(brace
op_increment
id|DeviceCount
suffix:semicolon
id|PciDev-&gt;sysdata
op_assign
(paren
r_void
op_star
)paren
id|DeviceNode
suffix:semicolon
id|DeviceNode-&gt;PciDev
op_assign
id|PciDev
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;PciDev 0x%p &lt;==&gt; DevNode 0x%p&bslash;n&quot;
comma
id|PciDev
comma
id|DeviceNode
)paren
suffix:semicolon
id|iSeries_allocateDeviceBars
c_func
(paren
id|PciDev
)paren
suffix:semicolon
id|PPCDBGCALL
c_func
(paren
id|PPCDBG_BUSWALK
comma
id|dumpPci_Dev
c_func
(paren
id|PciDev
)paren
)paren
suffix:semicolon
id|iSeries_Device_Information
c_func
(paren
id|PciDev
comma
id|Buffer
comma
r_sizeof
(paren
id|Buffer
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%d. %s&bslash;n&quot;
comma
id|DeviceCount
comma
id|Buffer
)paren
suffix:semicolon
id|create_pci_bus_tce_table
c_func
(paren
(paren
r_int
r_int
)paren
id|DeviceNode
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: Device Tree not found for 0x%016lX&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|PciDev
)paren
suffix:semicolon
)brace
)brace
id|iSeries_IoMmTable_Status
c_func
(paren
)paren
suffix:semicolon
id|iSeries_activate_IRQs
c_func
(paren
)paren
suffix:semicolon
id|mf_displaySrc
c_func
(paren
l_int|0xC9000200
)paren
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n; * iSeries_pcibios_fixup_bus(int Bus)&n; *&n; ***********************************************************************/
DECL|function|iSeries_pcibios_fixup_bus
r_void
id|iSeries_pcibios_fixup_bus
c_func
(paren
r_struct
id|pci_bus
op_star
id|PciBus
)paren
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;iSeries_pcibios_fixup_bus(0x%04X) Entry.&bslash;n&quot;
comma
id|PciBus-&gt;number
)paren
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n; * fixup_resources(struct pci_dev *dev) &n; *&t;&n; ***********************************************************************/
DECL|function|fixup_resources
r_void
id|fixup_resources
c_func
(paren
r_struct
id|pci_dev
op_star
id|PciDev
)paren
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;fixup_resources PciDev %p&bslash;n&quot;
comma
id|PciDev
)paren
suffix:semicolon
)brace
multiline_comment|/********************************************************************************&n;* Loop through each node function to find usable EADs bridges.  &n;*********************************************************************************/
DECL|function|iSeries_Scan_PHBs_Slots
r_void
id|iSeries_Scan_PHBs_Slots
c_func
(paren
r_struct
id|pci_controller
op_star
id|Phb
)paren
(brace
r_struct
id|HvCallPci_DeviceInfo
op_star
id|DevInfo
suffix:semicolon
id|HvBusNumber
id|Bus
op_assign
id|Phb-&gt;local_number
suffix:semicolon
multiline_comment|/* System Bus        */
id|HvSubBusNumber
id|SubBus
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* EADs is always 0. */
r_int
id|HvRc
op_assign
l_int|0
suffix:semicolon
r_int
id|IdSel
op_assign
l_int|1
suffix:semicolon
r_int
id|MaxAgents
op_assign
l_int|8
suffix:semicolon
id|DevInfo
op_assign
(paren
r_struct
id|HvCallPci_DeviceInfo
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|HvCallPci_DeviceInfo
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DevInfo
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/********************************************************************************&n;&t; * Probe for EADs Bridges      &n;&t; ********************************************************************************/
r_for
c_loop
(paren
id|IdSel
op_assign
l_int|1
suffix:semicolon
id|IdSel
OL
id|MaxAgents
suffix:semicolon
op_increment
id|IdSel
)paren
(brace
id|HvRc
op_assign
id|HvCallPci_getDeviceInfo
c_func
(paren
id|Bus
comma
id|SubBus
comma
id|IdSel
comma
id|REALADDR
c_func
(paren
id|DevInfo
)paren
comma
r_sizeof
(paren
r_struct
id|HvCallPci_DeviceInfo
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HvRc
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|DevInfo-&gt;deviceType
op_eq
id|HvCallPci_NodeDevice
)paren
(brace
id|iSeries_Scan_EADs_Bridge
c_func
(paren
id|Bus
comma
id|SubBus
comma
id|IdSel
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;PCI: Invalid System Configuration(0x%02X.&bslash;n&quot;
comma
id|DevInfo-&gt;deviceType
)paren
suffix:semicolon
)brace
r_else
id|pci_Log_Error
c_func
(paren
l_string|&quot;getDeviceInfo&quot;
comma
id|Bus
comma
id|SubBus
comma
id|IdSel
comma
id|HvRc
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|DevInfo
)paren
suffix:semicolon
)brace
multiline_comment|/********************************************************************************&n;* &n;*********************************************************************************/
DECL|function|iSeries_Scan_EADs_Bridge
r_void
id|iSeries_Scan_EADs_Bridge
c_func
(paren
id|HvBusNumber
id|Bus
comma
id|HvSubBusNumber
id|SubBus
comma
r_int
id|IdSel
)paren
(brace
r_struct
id|HvCallPci_BridgeInfo
op_star
id|BridgeInfo
suffix:semicolon
id|HvAgentId
id|AgentId
suffix:semicolon
r_int
id|Function
suffix:semicolon
r_int
id|HvRc
suffix:semicolon
id|BridgeInfo
op_assign
(paren
r_struct
id|HvCallPci_BridgeInfo
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|HvCallPci_BridgeInfo
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BridgeInfo
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/*********************************************************************&n;&t; * Note: hvSubBus and irq is always be 0 at this level!&n;&t; *********************************************************************/
r_for
c_loop
(paren
id|Function
op_assign
l_int|0
suffix:semicolon
id|Function
OL
l_int|8
suffix:semicolon
op_increment
id|Function
)paren
(brace
id|AgentId
op_assign
id|ISERIES_PCI_AGENTID
c_func
(paren
id|IdSel
comma
id|Function
)paren
suffix:semicolon
id|HvRc
op_assign
id|HvCallXm_connectBusUnit
c_func
(paren
id|Bus
comma
id|SubBus
comma
id|AgentId
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HvRc
op_eq
l_int|0
)paren
(brace
multiline_comment|/*  Connect EADs: 0x18.00.12 = 0x00 */
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;PCI:Connect EADs: 0x%02X.%02X.%02X&bslash;n&quot;
comma
id|Bus
comma
id|SubBus
comma
id|AgentId
)paren
suffix:semicolon
id|PCIFR
c_func
(paren
l_string|&quot;Connect EADs: 0x%02X.%02X.%02X&quot;
comma
id|Bus
comma
id|SubBus
comma
id|AgentId
)paren
suffix:semicolon
id|HvRc
op_assign
id|HvCallPci_getBusUnitInfo
c_func
(paren
id|Bus
comma
id|SubBus
comma
id|AgentId
comma
id|REALADDR
c_func
(paren
id|BridgeInfo
)paren
comma
r_sizeof
(paren
r_struct
id|HvCallPci_BridgeInfo
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HvRc
op_eq
l_int|0
)paren
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;PCI: BridgeInfo, Type:0x%02X, SubBus:0x%02X, MaxAgents:0x%02X, MaxSubBus: 0x%02X, LSlot: 0x%02X&bslash;n&quot;
comma
id|BridgeInfo-&gt;busUnitInfo.deviceType
comma
id|BridgeInfo-&gt;subBusNumber
comma
id|BridgeInfo-&gt;maxAgents
comma
id|BridgeInfo-&gt;maxSubBusNumber
comma
id|BridgeInfo-&gt;logicalSlotNumber
)paren
suffix:semicolon
id|PCIFR
c_func
(paren
l_string|&quot;BridgeInfo, Type:0x%02X, SubBus:0x%02X, MaxAgents:0x%02X, MaxSubBus: 0x%02X, LSlot: 0x%02X&quot;
comma
id|BridgeInfo-&gt;busUnitInfo.deviceType
comma
id|BridgeInfo-&gt;subBusNumber
comma
id|BridgeInfo-&gt;maxAgents
comma
id|BridgeInfo-&gt;maxSubBusNumber
comma
id|BridgeInfo-&gt;logicalSlotNumber
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BridgeInfo-&gt;busUnitInfo.deviceType
op_eq
id|HvCallPci_BridgeDevice
)paren
(brace
multiline_comment|/* Scan_Bridge_Slot...: 0x18.00.12 */
id|iSeries_Scan_Bridge_Slot
c_func
(paren
id|Bus
comma
id|BridgeInfo
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;PCI: Invalid Bridge Configuration(0x%02X)&quot;
comma
id|BridgeInfo-&gt;busUnitInfo.deviceType
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|HvRc
op_ne
l_int|0x000B
)paren
(brace
id|pci_Log_Error
c_func
(paren
l_string|&quot;EADs Connect&quot;
comma
id|Bus
comma
id|SubBus
comma
id|AgentId
comma
id|HvRc
)paren
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|BridgeInfo
)paren
suffix:semicolon
)brace
multiline_comment|/********************************************************************************&n;* &n;* This assumes that the node slot is always on the primary bus!&n;*&n;*********************************************************************************/
DECL|function|iSeries_Scan_Bridge_Slot
r_int
id|iSeries_Scan_Bridge_Slot
c_func
(paren
id|HvBusNumber
id|Bus
comma
r_struct
id|HvCallPci_BridgeInfo
op_star
id|BridgeInfo
)paren
(brace
r_struct
id|iSeries_Device_Node
op_star
id|DeviceNode
suffix:semicolon
id|HvSubBusNumber
id|SubBus
op_assign
id|BridgeInfo-&gt;subBusNumber
suffix:semicolon
id|u16
id|VendorId
op_assign
l_int|0
suffix:semicolon
r_int
id|HvRc
op_assign
l_int|0
suffix:semicolon
id|u8
id|Irq
op_assign
l_int|0
suffix:semicolon
r_int
id|IdSel
op_assign
id|ISERIES_GET_DEVICE_FROM_SUBBUS
c_func
(paren
id|SubBus
)paren
suffix:semicolon
r_int
id|Function
op_assign
id|ISERIES_GET_FUNCTION_FROM_SUBBUS
c_func
(paren
id|SubBus
)paren
suffix:semicolon
id|HvAgentId
id|AgentId
op_assign
id|ISERIES_PCI_AGENTID
c_func
(paren
id|IdSel
comma
id|Function
)paren
suffix:semicolon
id|HvAgentId
id|EADsIdSel
op_assign
id|ISERIES_PCI_AGENTID
c_func
(paren
id|IdSel
comma
id|Function
)paren
suffix:semicolon
r_int
id|FirstSlotId
op_assign
l_int|0
suffix:semicolon
multiline_comment|/**********************************************************/
multiline_comment|/* iSeries_allocate_IRQ.: 0x18.00.12(0xA3)                */
multiline_comment|/**********************************************************/
id|Irq
op_assign
id|iSeries_allocate_IRQ
c_func
(paren
id|Bus
comma
l_int|0
comma
id|AgentId
)paren
suffix:semicolon
id|iSeries_assign_IRQ
c_func
(paren
id|Irq
comma
id|Bus
comma
l_int|0
comma
id|AgentId
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;PCI:- allocate and assign IRQ 0x%02X.%02X.%02X = 0x%02X&bslash;n&quot;
comma
id|Bus
comma
l_int|0
comma
id|AgentId
comma
id|Irq
)paren
suffix:semicolon
multiline_comment|/****************************************************************************&n;&t; * Connect all functions of any device found.  &n;&t; ****************************************************************************/
r_for
c_loop
(paren
id|IdSel
op_assign
l_int|1
suffix:semicolon
id|IdSel
op_le
id|BridgeInfo-&gt;maxAgents
suffix:semicolon
op_increment
id|IdSel
)paren
(brace
r_for
c_loop
(paren
id|Function
op_assign
l_int|0
suffix:semicolon
id|Function
OL
l_int|8
suffix:semicolon
op_increment
id|Function
)paren
(brace
id|AgentId
op_assign
id|ISERIES_PCI_AGENTID
c_func
(paren
id|IdSel
comma
id|Function
)paren
suffix:semicolon
id|HvRc
op_assign
id|HvCallXm_connectBusUnit
c_func
(paren
id|Bus
comma
id|SubBus
comma
id|AgentId
comma
id|Irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HvRc
op_eq
l_int|0
)paren
(brace
id|HvRc
op_assign
id|HvCallPci_configLoad16
c_func
(paren
id|Bus
comma
id|SubBus
comma
id|AgentId
comma
id|PCI_VENDOR_ID
comma
op_amp
id|VendorId
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HvRc
op_eq
l_int|0
)paren
(brace
multiline_comment|/**********************************************************/
multiline_comment|/* FoundDevice: 0x18.28.10 = 0x12AE                       */
multiline_comment|/**********************************************************/
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;PCI:- FoundDevice: 0x%02X.%02X.%02X = 0x%04X&bslash;n&quot;
comma
id|Bus
comma
id|SubBus
comma
id|AgentId
comma
id|VendorId
)paren
suffix:semicolon
id|HvRc
op_assign
id|HvCallPci_configStore8
c_func
(paren
id|Bus
comma
id|SubBus
comma
id|AgentId
comma
id|PCI_INTERRUPT_LINE
comma
id|Irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HvRc
op_ne
l_int|0
)paren
(brace
id|pci_Log_Error
c_func
(paren
l_string|&quot;PciCfgStore Irq Failed!&quot;
comma
id|Bus
comma
id|SubBus
comma
id|AgentId
comma
id|HvRc
)paren
suffix:semicolon
)brace
op_increment
id|DeviceCount
suffix:semicolon
id|DeviceNode
op_assign
id|build_device_node
c_func
(paren
id|Bus
comma
id|SubBus
comma
id|EADsIdSel
comma
id|Function
)paren
suffix:semicolon
id|DeviceNode-&gt;Vendor
op_assign
id|VendorId
suffix:semicolon
id|DeviceNode-&gt;Irq
op_assign
id|Irq
suffix:semicolon
id|DeviceNode-&gt;LogicalSlot
op_assign
id|BridgeInfo-&gt;logicalSlotNumber
suffix:semicolon
id|PCIFR
c_func
(paren
l_string|&quot;Device(%4d): 0x%02X.%02X.%02X 0x%02X 0x%04X&quot;
comma
id|DeviceCount
comma
id|Bus
comma
id|SubBus
comma
id|AgentId
comma
id|DeviceNode-&gt;LogicalSlot
comma
id|DeviceNode-&gt;Vendor
)paren
suffix:semicolon
multiline_comment|/***********************************************************&n;&t;&t;&t;&t;&t; * On the first device/function, assign irq to slot&n;&t;&t;&t;&t;&t; ***********************************************************/
r_if
c_cond
(paren
id|Function
op_eq
l_int|0
)paren
(brace
id|FirstSlotId
op_assign
id|AgentId
suffix:semicolon
singleline_comment|// AHT iSeries_assign_IRQ(Irq, Bus, SubBus, AgentId);
)brace
)brace
r_else
id|pci_Log_Error
c_func
(paren
l_string|&quot;Read Vendor&quot;
comma
id|Bus
comma
id|SubBus
comma
id|AgentId
comma
id|HvRc
)paren
suffix:semicolon
)brace
r_else
id|pci_Log_Error
c_func
(paren
l_string|&quot;Connect Bus Unit&quot;
comma
id|Bus
comma
id|SubBus
comma
id|AgentId
comma
id|HvRc
)paren
suffix:semicolon
)brace
multiline_comment|/* for (Function = 0; Function &lt; 8; ++Function) */
)brace
multiline_comment|/* for (IdSel = 1; IdSel &lt;= MaxAgents; ++IdSel) */
r_return
id|HvRc
suffix:semicolon
)brace
multiline_comment|/************************************************************************/
multiline_comment|/* I/0 Memory copy MUST use mmio commands on iSeries                    */
multiline_comment|/* To do; For performance, include the hv call directly                 */
multiline_comment|/************************************************************************/
DECL|function|iSeries_memset_io
r_void
op_star
id|iSeries_memset_io
c_func
(paren
r_void
op_star
id|dest
comma
r_char
id|c
comma
r_int
id|Count
)paren
(brace
id|u8
id|ByteValue
op_assign
id|c
suffix:semicolon
r_int
id|NumberOfBytes
op_assign
id|Count
suffix:semicolon
r_char
op_star
id|IoBuffer
op_assign
id|dest
suffix:semicolon
r_while
c_loop
(paren
id|NumberOfBytes
OG
l_int|0
)paren
(brace
id|iSeries_Write_Byte
c_func
(paren
id|ByteValue
comma
(paren
r_void
op_star
)paren
id|IoBuffer
)paren
suffix:semicolon
op_increment
id|IoBuffer
suffix:semicolon
op_decrement
id|NumberOfBytes
suffix:semicolon
)brace
r_return
id|dest
suffix:semicolon
)brace
DECL|function|iSeries_memcpy_toio
r_void
op_star
id|iSeries_memcpy_toio
c_func
(paren
r_void
op_star
id|dest
comma
r_void
op_star
id|source
comma
r_int
id|count
)paren
(brace
r_char
op_star
id|dst
op_assign
id|dest
suffix:semicolon
r_char
op_star
id|src
op_assign
id|source
suffix:semicolon
r_int
id|NumberOfBytes
op_assign
id|count
suffix:semicolon
r_while
c_loop
(paren
id|NumberOfBytes
OG
l_int|0
)paren
(brace
id|iSeries_Write_Byte
c_func
(paren
op_star
id|src
op_increment
comma
(paren
r_void
op_star
)paren
id|dst
op_increment
)paren
suffix:semicolon
op_decrement
id|NumberOfBytes
suffix:semicolon
)brace
r_return
id|dest
suffix:semicolon
)brace
DECL|function|iSeries_memcpy_fromio
r_void
op_star
id|iSeries_memcpy_fromio
c_func
(paren
r_void
op_star
id|dest
comma
r_void
op_star
id|source
comma
r_int
id|count
)paren
(brace
r_char
op_star
id|dst
op_assign
id|dest
suffix:semicolon
r_char
op_star
id|src
op_assign
id|source
suffix:semicolon
r_int
id|NumberOfBytes
op_assign
id|count
suffix:semicolon
r_while
c_loop
(paren
id|NumberOfBytes
OG
l_int|0
)paren
(brace
op_star
id|dst
op_increment
op_assign
id|iSeries_Read_Byte
c_func
(paren
(paren
r_void
op_star
)paren
id|src
op_increment
)paren
suffix:semicolon
op_decrement
id|NumberOfBytes
suffix:semicolon
)brace
r_return
id|dest
suffix:semicolon
)brace
multiline_comment|/**********************************************************************************&n; * Look down the chain to find the matching Device Device&n; **********************************************************************************/
DECL|function|find_Device_Node
r_struct
id|iSeries_Device_Node
op_star
id|find_Device_Node
c_func
(paren
r_struct
id|pci_dev
op_star
id|PciDev
)paren
(brace
r_struct
id|list_head
op_star
id|Device_Node_Ptr
op_assign
id|iSeries_Global_Device_List.next
suffix:semicolon
r_int
id|Bus
op_assign
id|PciDev-&gt;bus-&gt;number
suffix:semicolon
r_int
id|DevFn
op_assign
id|PciDev-&gt;devfn
suffix:semicolon
r_while
c_loop
(paren
id|Device_Node_Ptr
op_ne
op_amp
id|iSeries_Global_Device_List
)paren
(brace
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
op_assign
(paren
r_struct
id|iSeries_Device_Node
op_star
)paren
id|Device_Node_Ptr
suffix:semicolon
r_if
c_cond
(paren
id|Bus
op_eq
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
op_logical_and
id|DevFn
op_eq
id|DevNode-&gt;DevFn
)paren
(brace
r_return
id|DevNode
suffix:semicolon
)brace
id|Device_Node_Ptr
op_assign
id|Device_Node_Ptr-&gt;next
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/******************************************************************/
multiline_comment|/* Returns the device node for the passed pci_dev                 */
multiline_comment|/* Sanity Check Node PciDev to passed pci_dev                     */
multiline_comment|/* If none is found, returns a NULL which the client must handle. */
multiline_comment|/******************************************************************/
DECL|function|get_Device_Node
r_struct
id|iSeries_Device_Node
op_star
id|get_Device_Node
c_func
(paren
r_struct
id|pci_dev
op_star
id|PciDev
)paren
(brace
r_struct
id|iSeries_Device_Node
op_star
id|Node
suffix:semicolon
id|Node
op_assign
(paren
r_struct
id|iSeries_Device_Node
op_star
)paren
id|PciDev-&gt;sysdata
suffix:semicolon
r_if
c_cond
(paren
id|Node
op_eq
l_int|NULL
)paren
(brace
id|Node
op_assign
id|find_Device_Node
c_func
(paren
id|PciDev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|Node-&gt;PciDev
op_ne
id|PciDev
)paren
(brace
id|Node
op_assign
id|find_Device_Node
c_func
(paren
id|PciDev
)paren
suffix:semicolon
)brace
r_return
id|Node
suffix:semicolon
)brace
multiline_comment|/**********************************************************************************&n; *&n; * Read PCI Config Space Code &n; *&n; **********************************************************************************/
multiline_comment|/** BYTE  *************************************************************************/
DECL|function|iSeries_Node_read_config_byte
r_int
id|iSeries_Node_read_config_byte
c_func
(paren
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
comma
r_int
id|Offset
comma
id|u8
op_star
id|ReadValue
)paren
(brace
id|u8
id|ReadData
suffix:semicolon
r_if
c_cond
(paren
id|DevNode
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|0x301
suffix:semicolon
)brace
op_increment
id|Pci_Cfg_Read_Count
suffix:semicolon
id|DevNode-&gt;ReturnCode
op_assign
id|HvCallPci_configLoad8
c_func
(paren
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|ISERIES_SUBBUS
c_func
(paren
id|DevNode
)paren
comma
l_int|0x10
comma
id|Offset
comma
op_amp
id|ReadData
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Pci_Trace_Flag
op_eq
l_int|1
)paren
(brace
id|PCIFR
c_func
(paren
l_string|&quot;RCB: 0x%04X.%02X 0x%04X = 0x%02X&quot;
comma
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|DevNode-&gt;DevFn
comma
id|Offset
comma
id|ReadData
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|DevNode-&gt;ReturnCode
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: RCB: 0x%04X.%02X  Error: 0x%04X&bslash;n&quot;
comma
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|DevNode-&gt;DevFn
comma
id|DevNode-&gt;ReturnCode
)paren
suffix:semicolon
id|PCIFR
c_func
(paren
l_string|&quot;RCB: 0x%04X.%02X  Error: 0x%04X&quot;
comma
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|DevNode-&gt;DevFn
comma
id|DevNode-&gt;ReturnCode
)paren
suffix:semicolon
)brace
op_star
id|ReadValue
op_assign
id|ReadData
suffix:semicolon
r_return
id|DevNode-&gt;ReturnCode
suffix:semicolon
)brace
multiline_comment|/** WORD  *************************************************************************/
DECL|function|iSeries_Node_read_config_word
r_int
id|iSeries_Node_read_config_word
c_func
(paren
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
comma
r_int
id|Offset
comma
id|u16
op_star
id|ReadValue
)paren
(brace
id|u16
id|ReadData
suffix:semicolon
r_if
c_cond
(paren
id|DevNode
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|0x301
suffix:semicolon
)brace
op_increment
id|Pci_Cfg_Read_Count
suffix:semicolon
id|DevNode-&gt;ReturnCode
op_assign
id|HvCallPci_configLoad16
c_func
(paren
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|ISERIES_SUBBUS
c_func
(paren
id|DevNode
)paren
comma
l_int|0x10
comma
id|Offset
comma
op_amp
id|ReadData
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Pci_Trace_Flag
op_eq
l_int|1
)paren
(brace
id|PCIFR
c_func
(paren
l_string|&quot;RCW: 0x%04X.%02X 0x%04X = 0x%04X&quot;
comma
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|DevNode-&gt;DevFn
comma
id|Offset
comma
id|ReadData
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|DevNode-&gt;ReturnCode
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: RCW: 0x%04X.%02X  Error: 0x%04X&bslash;n&quot;
comma
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|DevNode-&gt;DevFn
comma
id|DevNode-&gt;ReturnCode
)paren
suffix:semicolon
id|PCIFR
c_func
(paren
l_string|&quot;RCW: 0x%04X.%02X  Error: 0x%04X&quot;
comma
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|DevNode-&gt;DevFn
comma
id|DevNode-&gt;ReturnCode
)paren
suffix:semicolon
)brace
op_star
id|ReadValue
op_assign
id|ReadData
suffix:semicolon
r_return
id|DevNode-&gt;ReturnCode
suffix:semicolon
)brace
multiline_comment|/** DWORD *************************************************************************/
DECL|function|iSeries_Node_read_config_dword
r_int
id|iSeries_Node_read_config_dword
c_func
(paren
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
comma
r_int
id|Offset
comma
id|u32
op_star
id|ReadValue
)paren
(brace
id|u32
id|ReadData
suffix:semicolon
r_if
c_cond
(paren
id|DevNode
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|0x301
suffix:semicolon
)brace
op_increment
id|Pci_Cfg_Read_Count
suffix:semicolon
id|DevNode-&gt;ReturnCode
op_assign
id|HvCallPci_configLoad32
c_func
(paren
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|ISERIES_SUBBUS
c_func
(paren
id|DevNode
)paren
comma
l_int|0x10
comma
id|Offset
comma
op_amp
id|ReadData
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Pci_Trace_Flag
op_eq
l_int|1
)paren
(brace
id|PCIFR
c_func
(paren
l_string|&quot;RCL: 0x%04X.%02X 0x%04X = 0x%08X&quot;
comma
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|DevNode-&gt;DevFn
comma
id|Offset
comma
id|ReadData
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|DevNode-&gt;ReturnCode
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: RCL: 0x%04X.%02X  Error: 0x%04X&bslash;n&quot;
comma
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|DevNode-&gt;DevFn
comma
id|DevNode-&gt;ReturnCode
)paren
suffix:semicolon
id|PCIFR
c_func
(paren
l_string|&quot;RCL: 0x%04X.%02X  Error: 0x%04X&quot;
comma
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|DevNode-&gt;DevFn
comma
id|DevNode-&gt;ReturnCode
)paren
suffix:semicolon
)brace
op_star
id|ReadValue
op_assign
id|ReadData
suffix:semicolon
r_return
id|DevNode-&gt;ReturnCode
suffix:semicolon
)brace
DECL|function|iSeries_pci_read_config_byte
r_int
id|iSeries_pci_read_config_byte
c_func
(paren
r_struct
id|pci_dev
op_star
id|PciDev
comma
r_int
id|Offset
comma
id|u8
op_star
id|ReadValue
)paren
(brace
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
op_assign
id|get_Device_Node
c_func
(paren
id|PciDev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DevNode
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|0x0301
suffix:semicolon
)brace
r_return
id|iSeries_Node_read_config_byte
c_func
(paren
id|DevNode
comma
id|Offset
comma
id|ReadValue
)paren
suffix:semicolon
)brace
DECL|function|iSeries_pci_read_config_word
r_int
id|iSeries_pci_read_config_word
c_func
(paren
r_struct
id|pci_dev
op_star
id|PciDev
comma
r_int
id|Offset
comma
id|u16
op_star
id|ReadValue
)paren
(brace
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
op_assign
id|get_Device_Node
c_func
(paren
id|PciDev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DevNode
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|0x0301
suffix:semicolon
)brace
r_return
id|iSeries_Node_read_config_word
c_func
(paren
id|DevNode
comma
id|Offset
comma
id|ReadValue
)paren
suffix:semicolon
)brace
DECL|function|iSeries_pci_read_config_dword
r_int
id|iSeries_pci_read_config_dword
c_func
(paren
r_struct
id|pci_dev
op_star
id|PciDev
comma
r_int
id|Offset
comma
id|u32
op_star
id|ReadValue
)paren
(brace
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
op_assign
id|get_Device_Node
c_func
(paren
id|PciDev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DevNode
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|0x0301
suffix:semicolon
)brace
r_return
id|iSeries_Node_read_config_dword
c_func
(paren
id|DevNode
comma
id|Offset
comma
id|ReadValue
)paren
suffix:semicolon
)brace
multiline_comment|/**********************************************************************************/
multiline_comment|/*                                                                                */
multiline_comment|/* Write PCI Config Space                                                         */
multiline_comment|/*                                                                                */
multiline_comment|/** BYTE  *************************************************************************/
DECL|function|iSeries_Node_write_config_byte
r_int
id|iSeries_Node_write_config_byte
c_func
(paren
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
comma
r_int
id|Offset
comma
id|u8
id|WriteData
)paren
(brace
op_increment
id|Pci_Cfg_Write_Count
suffix:semicolon
id|DevNode-&gt;ReturnCode
op_assign
id|HvCallPci_configStore8
c_func
(paren
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|ISERIES_SUBBUS
c_func
(paren
id|DevNode
)paren
comma
l_int|0x10
comma
id|Offset
comma
id|WriteData
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Pci_Trace_Flag
op_eq
l_int|1
)paren
(brace
id|PCIFR
c_func
(paren
l_string|&quot;WCB: 0x%04X.%02X 0x%04X = 0x%02X&quot;
comma
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|DevNode-&gt;DevFn
comma
id|Offset
comma
id|WriteData
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|DevNode-&gt;ReturnCode
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: WCB: 0x%04X.%02X  Error: 0x%04X&bslash;n&quot;
comma
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|DevNode-&gt;DevFn
comma
id|DevNode-&gt;ReturnCode
)paren
suffix:semicolon
id|PCIFR
c_func
(paren
l_string|&quot;WCB: 0x%04X.%02X  Error: 0x%04X&quot;
comma
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|DevNode-&gt;DevFn
comma
id|DevNode-&gt;ReturnCode
)paren
suffix:semicolon
)brace
r_return
id|DevNode-&gt;ReturnCode
suffix:semicolon
)brace
multiline_comment|/** WORD  *************************************************************************/
DECL|function|iSeries_Node_write_config_word
r_int
id|iSeries_Node_write_config_word
c_func
(paren
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
comma
r_int
id|Offset
comma
id|u16
id|WriteData
)paren
(brace
op_increment
id|Pci_Cfg_Write_Count
suffix:semicolon
id|DevNode-&gt;ReturnCode
op_assign
id|HvCallPci_configStore16
c_func
(paren
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|ISERIES_SUBBUS
c_func
(paren
id|DevNode
)paren
comma
l_int|0x10
comma
id|Offset
comma
id|WriteData
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Pci_Trace_Flag
op_eq
l_int|1
)paren
(brace
id|PCIFR
c_func
(paren
l_string|&quot;WCW: 0x%04X.%02X 0x%04X = 0x%04X&quot;
comma
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|DevNode-&gt;DevFn
comma
id|Offset
comma
id|WriteData
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|DevNode-&gt;ReturnCode
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: WCW: 0x%04X.%02X  Error: 0x%04X&bslash;n&quot;
comma
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|DevNode-&gt;DevFn
comma
id|DevNode-&gt;ReturnCode
)paren
suffix:semicolon
id|PCIFR
c_func
(paren
l_string|&quot;WCW: 0x%04X.%02X  Error: 0x%04X&quot;
comma
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|DevNode-&gt;DevFn
comma
id|DevNode-&gt;ReturnCode
)paren
suffix:semicolon
)brace
r_return
id|DevNode-&gt;ReturnCode
suffix:semicolon
)brace
multiline_comment|/** DWORD *************************************************************************/
DECL|function|iSeries_Node_write_config_dword
r_int
id|iSeries_Node_write_config_dword
c_func
(paren
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
comma
r_int
id|Offset
comma
id|u32
id|WriteData
)paren
(brace
op_increment
id|Pci_Cfg_Write_Count
suffix:semicolon
id|DevNode-&gt;ReturnCode
op_assign
id|HvCallPci_configStore32
c_func
(paren
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|ISERIES_SUBBUS
c_func
(paren
id|DevNode
)paren
comma
l_int|0x10
comma
id|Offset
comma
id|WriteData
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Pci_Trace_Flag
op_eq
l_int|1
)paren
(brace
id|PCIFR
c_func
(paren
l_string|&quot;WCL: 0x%04X.%02X 0x%04X = 0x%08X&quot;
comma
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|DevNode-&gt;DevFn
comma
id|Offset
comma
id|WriteData
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|DevNode-&gt;ReturnCode
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: WCL: 0x%04X.%02X  Error: 0x%04X&bslash;n&quot;
comma
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|DevNode-&gt;DevFn
comma
id|DevNode-&gt;ReturnCode
)paren
suffix:semicolon
id|PCIFR
c_func
(paren
l_string|&quot;WCL: 0x%04X.%02X  Error: 0x%04X&quot;
comma
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|DevNode-&gt;DevFn
comma
id|DevNode-&gt;ReturnCode
)paren
suffix:semicolon
)brace
r_return
id|DevNode-&gt;ReturnCode
suffix:semicolon
)brace
DECL|function|iSeries_pci_write_config_byte
r_int
id|iSeries_pci_write_config_byte
c_func
(paren
r_struct
id|pci_dev
op_star
id|PciDev
comma
r_int
id|Offset
comma
id|u8
id|WriteValue
)paren
(brace
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
op_assign
id|get_Device_Node
c_func
(paren
id|PciDev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DevNode
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|0x0301
suffix:semicolon
)brace
r_return
id|iSeries_Node_write_config_byte
c_func
(paren
id|DevNode
comma
id|Offset
comma
id|WriteValue
)paren
suffix:semicolon
)brace
DECL|function|iSeries_pci_write_config_word
r_int
id|iSeries_pci_write_config_word
c_func
(paren
r_struct
id|pci_dev
op_star
id|PciDev
comma
r_int
id|Offset
comma
id|u16
id|WriteValue
)paren
(brace
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
op_assign
id|get_Device_Node
c_func
(paren
id|PciDev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DevNode
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|0x0301
suffix:semicolon
)brace
r_return
id|iSeries_Node_write_config_word
c_func
(paren
id|DevNode
comma
id|Offset
comma
id|WriteValue
)paren
suffix:semicolon
)brace
DECL|function|iSeries_pci_write_config_dword
r_int
id|iSeries_pci_write_config_dword
c_func
(paren
r_struct
id|pci_dev
op_star
id|PciDev
comma
r_int
id|Offset
comma
id|u32
id|WriteValue
)paren
(brace
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
op_assign
id|get_Device_Node
c_func
(paren
id|PciDev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DevNode
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|0x0301
suffix:semicolon
)brace
r_return
id|iSeries_Node_write_config_dword
c_func
(paren
id|DevNode
comma
id|Offset
comma
id|WriteValue
)paren
suffix:semicolon
)brace
multiline_comment|/************************************************************************/
multiline_comment|/* Branch Table                                                         */
multiline_comment|/************************************************************************/
DECL|variable|iSeries_pci_ops
r_struct
id|pci_ops
id|iSeries_pci_ops
op_assign
(brace
id|iSeries_pci_read_config_byte
comma
id|iSeries_pci_read_config_word
comma
id|iSeries_pci_read_config_dword
comma
id|iSeries_pci_write_config_byte
comma
id|iSeries_pci_write_config_word
comma
id|iSeries_pci_write_config_dword
)brace
suffix:semicolon
multiline_comment|/************************************************************************&n; * Check Return Code&n; * -&gt; On Failure, print and log information.&n; *    Increment Retry Count, if exceeds max, panic partition.&n; * -&gt; If in retry, print and log success &n; ************************************************************************&n; * PCI: Device 23.90 ReadL I/O Error( 0): 0x1234&n; * PCI: Device 23.90 ReadL Retry( 1)&n; * PCI: Device 23.90 ReadL Retry Successful(1)&n; ************************************************************************/
DECL|function|CheckReturnCode
r_int
id|CheckReturnCode
c_func
(paren
r_char
op_star
id|TextHdr
comma
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
comma
id|u64
id|RtnCode
)paren
(brace
r_if
c_cond
(paren
id|RtnCode
op_ne
l_int|0
)paren
(brace
op_increment
id|Pci_Error_Count
suffix:semicolon
op_increment
id|DevNode-&gt;IoRetry
suffix:semicolon
id|PCIFR
c_func
(paren
l_string|&quot;%s: Device 0x%04X:%02X  I/O Error(%2d): 0x%04X&quot;
comma
id|TextHdr
comma
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|DevNode-&gt;DevFn
comma
id|DevNode-&gt;IoRetry
comma
(paren
r_int
)paren
id|RtnCode
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI: %s: Device 0x%04X:%02X  I/O Error(%2d): 0x%04X&bslash;n&quot;
comma
id|TextHdr
comma
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|DevNode-&gt;DevFn
comma
id|DevNode-&gt;IoRetry
comma
(paren
r_int
)paren
id|RtnCode
)paren
suffix:semicolon
multiline_comment|/*******************************************************/
multiline_comment|/* Bump the retry and check for retry count exceeded.  */
multiline_comment|/* If, Exceeded, panic the system.                     */
multiline_comment|/*******************************************************/
r_if
c_cond
(paren
id|DevNode-&gt;IoRetry
OG
id|Pci_Retry_Max
op_logical_and
id|Pci_Error_Flag
OG
l_int|0
)paren
(brace
id|mf_displaySrc
c_func
(paren
l_int|0xB6000103
)paren
suffix:semicolon
id|panic_timeout
op_assign
l_int|0
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;PCI: Hardware I/O Error, SRC B6000103, Automatic Reboot Disabled.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Retry Try */
)brace
multiline_comment|/********************************************************************&n;&t;* If retry was in progress, log success and rest retry count        *&n;&t;*********************************************************************/
r_else
r_if
c_cond
(paren
id|DevNode-&gt;IoRetry
OG
l_int|0
)paren
(brace
id|PCIFR
c_func
(paren
l_string|&quot;%s: Device 0x%04X:%02X Retry Successful(%2d).&quot;
comma
id|TextHdr
comma
id|ISERIES_BUS
c_func
(paren
id|DevNode
)paren
comma
id|DevNode-&gt;DevFn
comma
id|DevNode-&gt;IoRetry
)paren
suffix:semicolon
id|DevNode-&gt;IoRetry
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/************************************************************************/
multiline_comment|/* Translate the I/O Address into a device node, bar, and bar offset.   */
multiline_comment|/* Note: Make sure the passed variable end up on the stack to avoid     */
multiline_comment|/* the exposure of being device global.                                 */
multiline_comment|/************************************************************************/
DECL|function|xlateIoMmAddress
r_static
r_inline
r_struct
id|iSeries_Device_Node
op_star
id|xlateIoMmAddress
c_func
(paren
r_void
op_star
id|IoAddress
comma
r_union
id|HvDsaMap
op_star
id|DsaPtr
comma
id|u64
op_star
id|BarOffsetPtr
)paren
(brace
r_int
r_int
id|BaseIoAddr
op_assign
(paren
r_int
r_int
)paren
id|IoAddress
op_minus
id|iSeries_Base_Io_Memory
suffix:semicolon
r_int
id|TableIndex
op_assign
id|BaseIoAddr
op_div
id|iSeries_IoMmTable_Entry_Size
suffix:semicolon
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
op_assign
op_star
(paren
id|iSeries_IoMmTable
op_plus
id|TableIndex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DevNode
op_ne
l_int|NULL
)paren
(brace
id|DsaPtr-&gt;DsaAddr
op_assign
id|ISERIES_DSA
c_func
(paren
id|DevNode
)paren
suffix:semicolon
id|DsaPtr-&gt;Dsa.barNumber
op_assign
op_star
(paren
id|iSeries_IoBarTable
op_plus
id|TableIndex
)paren
suffix:semicolon
op_star
id|BarOffsetPtr
op_assign
id|BaseIoAddr
op_mod
id|iSeries_IoMmTable_Entry_Size
suffix:semicolon
)brace
r_else
(brace
id|panic
c_func
(paren
l_string|&quot;PCI: Invalid PCI IoAddress detected!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|DevNode
suffix:semicolon
)brace
multiline_comment|/************************************************************************/
multiline_comment|/* Read MM I/O Instructions for the iSeries                             */
multiline_comment|/* On MM I/O error, all ones are returned and iSeries_pci_IoError is cal*/
multiline_comment|/* else, data is returned in big Endian format.                         */
multiline_comment|/************************************************************************/
multiline_comment|/* iSeries_Read_Byte = Read Byte  ( 8 bit)                              */
multiline_comment|/* iSeries_Read_Word = Read Word  (16 bit)                              */
multiline_comment|/* iSeries_Read_Long = Read Long  (32 bit)                              */
multiline_comment|/************************************************************************/
DECL|function|iSeries_Read_Byte
id|u8
id|iSeries_Read_Byte
c_func
(paren
r_void
op_star
id|IoAddress
)paren
(brace
id|u64
id|BarOffset
suffix:semicolon
r_union
id|HvDsaMap
id|DsaData
suffix:semicolon
r_struct
id|HvCallPci_LoadReturn
id|Return
suffix:semicolon
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
op_assign
id|xlateIoMmAddress
c_func
(paren
id|IoAddress
comma
op_amp
id|DsaData
comma
op_amp
id|BarOffset
)paren
suffix:semicolon
r_do
(brace
op_increment
id|Pci_Io_Read_Count
suffix:semicolon
id|HvCall3Ret16
c_func
(paren
id|HvCallPciBarLoad8
comma
op_amp
id|Return
comma
id|DsaData.DsaAddr
comma
id|BarOffset
comma
l_int|0
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|CheckReturnCode
c_func
(paren
l_string|&quot;RDB&quot;
comma
id|DevNode
comma
id|Return.rc
)paren
op_ne
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Pci_Trace_Flag
op_eq
l_int|1
)paren
(brace
id|PCIFR
c_func
(paren
l_string|&quot;RDB: IoAddress 0x%p = 0x%02X&quot;
comma
id|IoAddress
comma
(paren
id|u8
)paren
id|Return.value
)paren
suffix:semicolon
)brace
r_return
(paren
id|u8
)paren
id|Return.value
suffix:semicolon
)brace
DECL|function|iSeries_Read_Word
id|u16
id|iSeries_Read_Word
c_func
(paren
r_void
op_star
id|IoAddress
)paren
(brace
id|u64
id|BarOffset
suffix:semicolon
r_union
id|HvDsaMap
id|DsaData
suffix:semicolon
r_struct
id|HvCallPci_LoadReturn
id|Return
suffix:semicolon
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
op_assign
id|xlateIoMmAddress
c_func
(paren
id|IoAddress
comma
op_amp
id|DsaData
comma
op_amp
id|BarOffset
)paren
suffix:semicolon
r_do
(brace
op_increment
id|Pci_Io_Read_Count
suffix:semicolon
id|HvCall3Ret16
c_func
(paren
id|HvCallPciBarLoad16
comma
op_amp
id|Return
comma
id|DsaData.DsaAddr
comma
id|BarOffset
comma
l_int|0
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|CheckReturnCode
c_func
(paren
l_string|&quot;RDW&quot;
comma
id|DevNode
comma
id|Return.rc
)paren
op_ne
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Pci_Trace_Flag
op_eq
l_int|1
)paren
(brace
id|PCIFR
c_func
(paren
l_string|&quot;RDW: IoAddress 0x%p = 0x%04X&quot;
comma
id|IoAddress
comma
id|swab16
c_func
(paren
(paren
id|u16
)paren
id|Return.value
)paren
)paren
suffix:semicolon
)brace
r_return
id|swab16
c_func
(paren
(paren
id|u16
)paren
id|Return.value
)paren
suffix:semicolon
)brace
DECL|function|iSeries_Read_Long
id|u32
id|iSeries_Read_Long
c_func
(paren
r_void
op_star
id|IoAddress
)paren
(brace
id|u64
id|BarOffset
suffix:semicolon
r_union
id|HvDsaMap
id|DsaData
suffix:semicolon
r_struct
id|HvCallPci_LoadReturn
id|Return
suffix:semicolon
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
op_assign
id|xlateIoMmAddress
c_func
(paren
id|IoAddress
comma
op_amp
id|DsaData
comma
op_amp
id|BarOffset
)paren
suffix:semicolon
r_do
(brace
op_increment
id|Pci_Io_Read_Count
suffix:semicolon
id|HvCall3Ret16
c_func
(paren
id|HvCallPciBarLoad32
comma
op_amp
id|Return
comma
id|DsaData.DsaAddr
comma
id|BarOffset
comma
l_int|0
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|CheckReturnCode
c_func
(paren
l_string|&quot;RDL&quot;
comma
id|DevNode
comma
id|Return.rc
)paren
op_ne
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Pci_Trace_Flag
op_eq
l_int|1
)paren
(brace
id|PCIFR
c_func
(paren
l_string|&quot;RDL: IoAddress 0x%p = 0x%04X&quot;
comma
id|IoAddress
comma
id|swab32
c_func
(paren
(paren
id|u32
)paren
id|Return.value
)paren
)paren
suffix:semicolon
)brace
r_return
id|swab32
c_func
(paren
(paren
id|u32
)paren
id|Return.value
)paren
suffix:semicolon
)brace
multiline_comment|/************************************************************************/
multiline_comment|/* Write MM I/O Instructions for the iSeries                            */
multiline_comment|/************************************************************************/
multiline_comment|/* iSeries_Write_Byte = Write Byte (8 bit)                              */
multiline_comment|/* iSeries_Write_Word = Write Word(16 bit)                              */
multiline_comment|/* iSeries_Write_Long = Write Long(32 bit)                              */
multiline_comment|/************************************************************************/
DECL|function|iSeries_Write_Byte
r_void
id|iSeries_Write_Byte
c_func
(paren
id|u8
id|Data
comma
r_void
op_star
id|IoAddress
)paren
(brace
id|u64
id|BarOffset
suffix:semicolon
r_union
id|HvDsaMap
id|DsaData
suffix:semicolon
r_struct
id|HvCallPci_LoadReturn
id|Return
suffix:semicolon
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
op_assign
id|xlateIoMmAddress
c_func
(paren
id|IoAddress
comma
op_amp
id|DsaData
comma
op_amp
id|BarOffset
)paren
suffix:semicolon
r_do
(brace
op_increment
id|Pci_Io_Write_Count
suffix:semicolon
id|Return.rc
op_assign
id|HvCall4
c_func
(paren
id|HvCallPciBarStore8
comma
id|DsaData.DsaAddr
comma
id|BarOffset
comma
id|Data
comma
l_int|0
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|CheckReturnCode
c_func
(paren
l_string|&quot;WWB&quot;
comma
id|DevNode
comma
id|Return.rc
)paren
op_ne
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Pci_Trace_Flag
op_eq
l_int|1
)paren
(brace
id|PCIFR
c_func
(paren
l_string|&quot;WWB: IoAddress 0x%p = 0x%02X&quot;
comma
id|IoAddress
comma
id|Data
)paren
suffix:semicolon
)brace
)brace
DECL|function|iSeries_Write_Word
r_void
id|iSeries_Write_Word
c_func
(paren
id|u16
id|Data
comma
r_void
op_star
id|IoAddress
)paren
(brace
id|u64
id|BarOffset
suffix:semicolon
r_union
id|HvDsaMap
id|DsaData
suffix:semicolon
r_struct
id|HvCallPci_LoadReturn
id|Return
suffix:semicolon
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
op_assign
id|xlateIoMmAddress
c_func
(paren
id|IoAddress
comma
op_amp
id|DsaData
comma
op_amp
id|BarOffset
)paren
suffix:semicolon
r_do
(brace
op_increment
id|Pci_Io_Write_Count
suffix:semicolon
id|Return.rc
op_assign
id|HvCall4
c_func
(paren
id|HvCallPciBarStore16
comma
id|DsaData.DsaAddr
comma
id|BarOffset
comma
id|swab16
c_func
(paren
id|Data
)paren
comma
l_int|0
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|CheckReturnCode
c_func
(paren
l_string|&quot;WWW&quot;
comma
id|DevNode
comma
id|Return.rc
)paren
op_ne
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Pci_Trace_Flag
op_eq
l_int|1
)paren
(brace
id|PCIFR
c_func
(paren
l_string|&quot;WWW: IoAddress 0x%p = 0x%04X&quot;
comma
id|IoAddress
comma
id|Data
)paren
suffix:semicolon
)brace
)brace
DECL|function|iSeries_Write_Long
r_void
id|iSeries_Write_Long
c_func
(paren
id|u32
id|Data
comma
r_void
op_star
id|IoAddress
)paren
(brace
id|u64
id|BarOffset
suffix:semicolon
r_union
id|HvDsaMap
id|DsaData
suffix:semicolon
r_struct
id|HvCallPci_LoadReturn
id|Return
suffix:semicolon
r_struct
id|iSeries_Device_Node
op_star
id|DevNode
op_assign
id|xlateIoMmAddress
c_func
(paren
id|IoAddress
comma
op_amp
id|DsaData
comma
op_amp
id|BarOffset
)paren
suffix:semicolon
r_do
(brace
op_increment
id|Pci_Io_Write_Count
suffix:semicolon
id|Return.rc
op_assign
id|HvCall4
c_func
(paren
id|HvCallPciBarStore32
comma
id|DsaData.DsaAddr
comma
id|BarOffset
comma
id|swab32
c_func
(paren
id|Data
)paren
comma
l_int|0
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|CheckReturnCode
c_func
(paren
l_string|&quot;WWL&quot;
comma
id|DevNode
comma
id|Return.rc
)paren
op_ne
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Pci_Trace_Flag
op_eq
l_int|1
)paren
(brace
id|PCIFR
c_func
(paren
l_string|&quot;WWL: IoAddress 0x%p = 0x%08X&quot;
comma
id|IoAddress
comma
id|Data
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * This is called very early before the page table is setup.&n; * There are warnings here because of type mismatches.. Okay for now. AHT&n; */
r_void
DECL|function|iSeries_pcibios_init_early
id|iSeries_pcibios_init_early
c_func
(paren
r_void
)paren
(brace
singleline_comment|//ppc_md.pcibios_read_config_byte   = iSeries_Node_read_config_byte;
singleline_comment|//ppc_md.pcibios_read_config_word   = iSeries_Node_read_config_word;
singleline_comment|//ppc_md.pcibios_read_config_dword  = iSeries_Node_read_config_dword;
singleline_comment|//ppc_md.pcibios_write_config_byte  = iSeries_Node_write_config_byte;
singleline_comment|//ppc_md.pcibios_write_config_word  = iSeries_Node_write_config_word;
singleline_comment|//ppc_md.pcibios_write_config_dword = iSeries_Node_write_config_dword;
)brace
multiline_comment|/************************************************************************/
multiline_comment|/* Set the slot reset line to the state passed in.                      */
multiline_comment|/* This is the platform specific for code for the pci_reset_device      */
multiline_comment|/* function.                                                            */
multiline_comment|/************************************************************************/
DECL|function|pci_set_reset
r_int
id|pci_set_reset
c_func
(paren
r_struct
id|pci_dev
op_star
id|PciDev
comma
r_int
id|State
)paren
(brace
r_struct
id|iSeries_Device_Node
op_star
id|DeviceNode
op_assign
(paren
r_struct
id|iSeries_Device_Node
op_star
)paren
id|PciDev-&gt;sysdata
suffix:semicolon
r_if
c_cond
(paren
id|DeviceNode
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: Pci Reset Failed, Device Node not found for pci_dev %p&bslash;n&quot;
comma
id|PciDev
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|DeviceNode-&gt;ReturnCode
op_assign
id|HvCallPci_setSlotReset
c_func
(paren
id|ISERIES_BUS
c_func
(paren
id|DeviceNode
)paren
comma
l_int|0x00
comma
id|DeviceNode-&gt;AgentId
comma
id|State
)paren
suffix:semicolon
r_return
id|DeviceNode-&gt;ReturnCode
suffix:semicolon
)brace
eof
