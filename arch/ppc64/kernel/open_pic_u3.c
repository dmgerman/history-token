multiline_comment|/*&n; *  arch/ppc/kernel/open_pic.c -- OpenPIC Interrupt Handling&n; *&n; *  Copyright (C) 1997 Geert Uytterhoeven&n; *&n; *  This file is subject to the terms and conditions of the GNU General Public&n; *  License.  See the file COPYING in the main directory of this archive&n; *  for more details.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/signal.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &quot;open_pic.h&quot;
macro_line|#include &quot;open_pic_defs.h&quot;
DECL|variable|OpenPIC2_Addr
r_void
op_star
id|OpenPIC2_Addr
suffix:semicolon
DECL|variable|OpenPIC2
r_static
r_volatile
r_struct
id|OpenPIC
op_star
id|OpenPIC2
op_assign
l_int|NULL
suffix:semicolon
r_extern
id|u_int
id|OpenPIC_NumInitSenses
suffix:semicolon
r_extern
id|u_char
op_star
id|OpenPIC_InitSenses
suffix:semicolon
DECL|variable|NumSources
r_static
id|u_int
id|NumSources
suffix:semicolon
DECL|variable|NumISUs
r_static
r_int
id|NumISUs
suffix:semicolon
DECL|variable|open_pic2_irq_offset
r_static
r_int
id|open_pic2_irq_offset
suffix:semicolon
DECL|variable|ISU2
r_static
id|OpenPIC_SourcePtr
id|ISU2
(braket
id|OPENPIC_MAX_ISU
)braket
suffix:semicolon
DECL|variable|openpic2_vec_spurious
r_int
r_int
id|openpic2_vec_spurious
suffix:semicolon
multiline_comment|/*&n; *  Accesses to the current processor&squot;s openpic registers&n; *  U3 secondary openpic has only one output&n; */
DECL|macro|THIS_CPU
mdefine_line|#define THIS_CPU&t;&t;Processor[0]
DECL|macro|DECL_THIS_CPU
mdefine_line|#define DECL_THIS_CPU
DECL|macro|CHECK_THIS_CPU
mdefine_line|#define CHECK_THIS_CPU
DECL|macro|GET_ISU
mdefine_line|#define GET_ISU(source)&t;ISU2[(source) &gt;&gt; 4][(source) &amp; 0xf]
DECL|function|openpic2_read
r_static
r_inline
id|u_int
id|openpic2_read
c_func
(paren
r_volatile
id|u_int
op_star
id|addr
)paren
(brace
id|u_int
id|val
suffix:semicolon
id|val
op_assign
id|in_be32
c_func
(paren
id|addr
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
DECL|function|openpic2_write
r_static
r_inline
r_void
id|openpic2_write
c_func
(paren
r_volatile
id|u_int
op_star
id|addr
comma
id|u_int
id|val
)paren
(brace
id|out_be32
c_func
(paren
id|addr
comma
id|val
)paren
suffix:semicolon
)brace
DECL|function|openpic2_readfield
r_static
r_inline
id|u_int
id|openpic2_readfield
c_func
(paren
r_volatile
id|u_int
op_star
id|addr
comma
id|u_int
id|mask
)paren
(brace
id|u_int
id|val
op_assign
id|openpic2_read
c_func
(paren
id|addr
)paren
suffix:semicolon
r_return
id|val
op_amp
id|mask
suffix:semicolon
)brace
DECL|function|openpic2_writefield
r_static
r_inline
r_void
id|openpic2_writefield
c_func
(paren
r_volatile
id|u_int
op_star
id|addr
comma
id|u_int
id|mask
comma
id|u_int
id|field
)paren
(brace
id|u_int
id|val
op_assign
id|openpic2_read
c_func
(paren
id|addr
)paren
suffix:semicolon
id|openpic2_write
c_func
(paren
id|addr
comma
(paren
id|val
op_amp
op_complement
id|mask
)paren
op_or
(paren
id|field
op_amp
id|mask
)paren
)paren
suffix:semicolon
)brace
DECL|function|openpic2_clearfield
r_static
r_inline
r_void
id|openpic2_clearfield
c_func
(paren
r_volatile
id|u_int
op_star
id|addr
comma
id|u_int
id|mask
)paren
(brace
id|openpic2_writefield
c_func
(paren
id|addr
comma
id|mask
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|openpic2_setfield
r_static
r_inline
r_void
id|openpic2_setfield
c_func
(paren
r_volatile
id|u_int
op_star
id|addr
comma
id|u_int
id|mask
)paren
(brace
id|openpic2_writefield
c_func
(paren
id|addr
comma
id|mask
comma
id|mask
)paren
suffix:semicolon
)brace
DECL|function|openpic2_safe_writefield
r_static
r_void
id|openpic2_safe_writefield
c_func
(paren
r_volatile
id|u_int
op_star
id|addr
comma
id|u_int
id|mask
comma
id|u_int
id|field
)paren
(brace
r_int
r_int
id|loops
op_assign
l_int|100000
suffix:semicolon
id|openpic2_setfield
c_func
(paren
id|addr
comma
id|OPENPIC_MASK
)paren
suffix:semicolon
r_while
c_loop
(paren
id|openpic2_read
c_func
(paren
id|addr
)paren
op_amp
id|OPENPIC_ACTIVITY
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|loops
op_decrement
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;openpic2_safe_writefield timeout&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|openpic2_writefield
c_func
(paren
id|addr
comma
id|mask
op_or
id|OPENPIC_MASK
comma
id|field
op_or
id|OPENPIC_MASK
)paren
suffix:semicolon
)brace
DECL|function|openpic2_reset
r_static
r_inline
r_void
id|openpic2_reset
c_func
(paren
r_void
)paren
(brace
id|openpic2_setfield
c_func
(paren
op_amp
id|OpenPIC2-&gt;Global.Global_Configuration0
comma
id|OPENPIC_CONFIG_RESET
)paren
suffix:semicolon
)brace
DECL|function|openpic2_disable_8259_pass_through
r_static
r_void
id|openpic2_disable_8259_pass_through
c_func
(paren
r_void
)paren
(brace
id|openpic2_setfield
c_func
(paren
op_amp
id|OpenPIC2-&gt;Global.Global_Configuration0
comma
id|OPENPIC_CONFIG_8259_PASSTHROUGH_DISABLE
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  Find out the current interrupt&n; */
DECL|function|openpic2_irq
r_static
id|u_int
id|openpic2_irq
c_func
(paren
r_void
)paren
(brace
id|u_int
id|vec
suffix:semicolon
id|DECL_THIS_CPU
suffix:semicolon
id|CHECK_THIS_CPU
suffix:semicolon
id|vec
op_assign
id|openpic2_readfield
c_func
(paren
op_amp
id|OpenPIC2-&gt;THIS_CPU.Interrupt_Acknowledge
comma
id|OPENPIC_VECTOR_MASK
)paren
suffix:semicolon
r_return
id|vec
suffix:semicolon
)brace
DECL|function|openpic2_eoi
r_static
r_void
id|openpic2_eoi
c_func
(paren
r_void
)paren
(brace
id|DECL_THIS_CPU
suffix:semicolon
id|CHECK_THIS_CPU
suffix:semicolon
id|openpic2_write
c_func
(paren
op_amp
id|OpenPIC2-&gt;THIS_CPU.EOI
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Handle PCI write posting */
(paren
r_void
)paren
id|openpic2_read
c_func
(paren
op_amp
id|OpenPIC2-&gt;THIS_CPU.EOI
)paren
suffix:semicolon
)brace
DECL|function|openpic2_get_priority
r_static
r_inline
id|u_int
id|openpic2_get_priority
c_func
(paren
r_void
)paren
(brace
id|DECL_THIS_CPU
suffix:semicolon
id|CHECK_THIS_CPU
suffix:semicolon
r_return
id|openpic2_readfield
c_func
(paren
op_amp
id|OpenPIC2-&gt;THIS_CPU.Current_Task_Priority
comma
id|OPENPIC_CURRENT_TASK_PRIORITY_MASK
)paren
suffix:semicolon
)brace
DECL|function|openpic2_set_priority
r_static
r_void
id|openpic2_set_priority
c_func
(paren
id|u_int
id|pri
)paren
(brace
id|DECL_THIS_CPU
suffix:semicolon
id|CHECK_THIS_CPU
suffix:semicolon
id|openpic2_writefield
c_func
(paren
op_amp
id|OpenPIC2-&gt;THIS_CPU.Current_Task_Priority
comma
id|OPENPIC_CURRENT_TASK_PRIORITY_MASK
comma
id|pri
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  Get/set the spurious vector&n; */
DECL|function|openpic2_get_spurious
r_static
r_inline
id|u_int
id|openpic2_get_spurious
c_func
(paren
r_void
)paren
(brace
r_return
id|openpic2_readfield
c_func
(paren
op_amp
id|OpenPIC2-&gt;Global.Spurious_Vector
comma
id|OPENPIC_VECTOR_MASK
)paren
suffix:semicolon
)brace
DECL|function|openpic2_set_spurious
r_static
r_void
id|openpic2_set_spurious
c_func
(paren
id|u_int
id|vec
)paren
(brace
id|openpic2_writefield
c_func
(paren
op_amp
id|OpenPIC2-&gt;Global.Spurious_Vector
comma
id|OPENPIC_VECTOR_MASK
comma
id|vec
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  Enable/disable an external interrupt source&n; *&n; *  Externally called, irq is an offseted system-wide interrupt number&n; */
DECL|function|openpic2_enable_irq
r_static
r_void
id|openpic2_enable_irq
c_func
(paren
id|u_int
id|irq
)paren
(brace
r_int
r_int
id|loops
op_assign
l_int|100000
suffix:semicolon
id|openpic2_clearfield
c_func
(paren
op_amp
id|GET_ISU
c_func
(paren
id|irq
op_minus
id|open_pic2_irq_offset
)paren
dot
id|Vector_Priority
comma
id|OPENPIC_MASK
)paren
suffix:semicolon
multiline_comment|/* make sure mask gets to controller before we return to user */
r_do
(brace
r_if
c_cond
(paren
op_logical_neg
id|loops
op_decrement
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;openpic_enable_irq timeout&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|mb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* sync is probably useless here */
)brace
r_while
c_loop
(paren
id|openpic2_readfield
c_func
(paren
op_amp
id|GET_ISU
c_func
(paren
id|irq
op_minus
id|open_pic2_irq_offset
)paren
dot
id|Vector_Priority
comma
id|OPENPIC_MASK
)paren
)paren
(brace
suffix:semicolon
)brace
)brace
DECL|function|openpic2_disable_irq
r_static
r_void
id|openpic2_disable_irq
c_func
(paren
id|u_int
id|irq
)paren
(brace
id|u32
id|vp
suffix:semicolon
r_int
r_int
id|loops
op_assign
l_int|100000
suffix:semicolon
id|openpic2_setfield
c_func
(paren
op_amp
id|GET_ISU
c_func
(paren
id|irq
op_minus
id|open_pic2_irq_offset
)paren
dot
id|Vector_Priority
comma
id|OPENPIC_MASK
)paren
suffix:semicolon
multiline_comment|/* make sure mask gets to controller before we return to user */
r_do
(brace
r_if
c_cond
(paren
op_logical_neg
id|loops
op_decrement
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;openpic_disable_irq timeout&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|mb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* sync is probably useless here */
id|vp
op_assign
id|openpic2_readfield
c_func
(paren
op_amp
id|GET_ISU
c_func
(paren
id|irq
op_minus
id|open_pic2_irq_offset
)paren
dot
id|Vector_Priority
comma
id|OPENPIC_MASK
op_or
id|OPENPIC_ACTIVITY
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|vp
op_amp
id|OPENPIC_ACTIVITY
)paren
op_logical_and
op_logical_neg
(paren
id|vp
op_amp
id|OPENPIC_MASK
)paren
)paren
(brace
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *  Initialize an interrupt source (and disable it!)&n; *&n; *  irq: OpenPIC interrupt number&n; *  pri: interrupt source priority&n; *  vec: the vector it will produce&n; *  pol: polarity (1 for positive, 0 for negative)&n; *  sense: 1 for level, 0 for edge&n; */
DECL|function|openpic2_initirq
r_static
r_void
id|openpic2_initirq
c_func
(paren
id|u_int
id|irq
comma
id|u_int
id|pri
comma
id|u_int
id|vec
comma
r_int
id|pol
comma
r_int
id|sense
)paren
(brace
id|openpic2_safe_writefield
c_func
(paren
op_amp
id|GET_ISU
c_func
(paren
id|irq
)paren
dot
id|Vector_Priority
comma
id|OPENPIC_PRIORITY_MASK
op_or
id|OPENPIC_VECTOR_MASK
op_or
id|OPENPIC_SENSE_MASK
op_or
id|OPENPIC_POLARITY_MASK
comma
(paren
id|pri
op_lshift
id|OPENPIC_PRIORITY_SHIFT
)paren
op_or
id|vec
op_or
(paren
id|pol
ques
c_cond
id|OPENPIC_POLARITY_POSITIVE
suffix:colon
id|OPENPIC_POLARITY_NEGATIVE
)paren
op_or
(paren
id|sense
ques
c_cond
id|OPENPIC_SENSE_LEVEL
suffix:colon
id|OPENPIC_SENSE_EDGE
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  Map an interrupt source to one or more CPUs&n; */
DECL|function|openpic2_mapirq
r_static
r_void
id|openpic2_mapirq
c_func
(paren
id|u_int
id|irq
comma
id|u_int
id|physmask
)paren
(brace
id|openpic2_write
c_func
(paren
op_amp
id|GET_ISU
c_func
(paren
id|irq
)paren
dot
id|Destination
comma
id|physmask
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  Set the sense for an interrupt source (and disable it!)&n; *&n; *  sense: 1 for level, 0 for edge&n; */
DECL|function|openpic2_set_sense
r_static
r_inline
r_void
id|openpic2_set_sense
c_func
(paren
id|u_int
id|irq
comma
r_int
id|sense
)paren
(brace
id|openpic2_safe_writefield
c_func
(paren
op_amp
id|GET_ISU
c_func
(paren
id|irq
)paren
dot
id|Vector_Priority
comma
id|OPENPIC_SENSE_LEVEL
comma
(paren
id|sense
ques
c_cond
id|OPENPIC_SENSE_LEVEL
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
)brace
DECL|function|openpic2_end_irq
r_static
r_void
id|openpic2_end_irq
c_func
(paren
r_int
r_int
id|irq_nr
)paren
(brace
id|openpic2_eoi
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|openpic2_get_irq
r_int
id|openpic2_get_irq
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|irq
op_assign
id|openpic2_irq
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_eq
id|openpic2_vec_spurious
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
id|irq
op_plus
id|open_pic2_irq_offset
suffix:semicolon
)brace
DECL|variable|open_pic2
r_struct
id|hw_interrupt_type
id|open_pic2
op_assign
(brace
l_string|&quot; OpenPIC2 &quot;
comma
l_int|NULL
comma
l_int|NULL
comma
id|openpic2_enable_irq
comma
id|openpic2_disable_irq
comma
l_int|NULL
comma
id|openpic2_end_irq
comma
)brace
suffix:semicolon
DECL|function|openpic2_init
r_void
id|__init
id|openpic2_init
c_func
(paren
r_int
id|offset
)paren
(brace
id|u_int
id|t
comma
id|i
suffix:semicolon
r_const
r_char
op_star
id|version
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|OpenPIC2_Addr
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;No OpenPIC2 found !&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|OpenPIC2
op_assign
(paren
r_volatile
r_struct
id|OpenPIC
op_star
)paren
id|OpenPIC2_Addr
suffix:semicolon
id|ppc64_boot_msg
c_func
(paren
l_int|0x20
comma
l_string|&quot;OpenPic U3 Init&quot;
)paren
suffix:semicolon
id|t
op_assign
id|openpic2_read
c_func
(paren
op_amp
id|OpenPIC2-&gt;Global.Feature_Reporting0
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|t
op_amp
id|OPENPIC_FEATURE_VERSION_MASK
)paren
(brace
r_case
l_int|1
suffix:colon
id|version
op_assign
l_string|&quot;1.0&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|version
op_assign
l_string|&quot;1.2&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|version
op_assign
l_string|&quot;1.3&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|version
op_assign
l_string|&quot;?&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;OpenPIC (U3) Version %s&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
id|open_pic2_irq_offset
op_assign
id|offset
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|128
suffix:semicolon
id|i
op_add_assign
l_int|0x10
)paren
(brace
id|ISU2
(braket
id|i
op_rshift
l_int|4
)braket
op_assign
op_amp
(paren
(paren
r_struct
id|OpenPIC
op_star
)paren
id|OpenPIC2_Addr
)paren
op_member_access_from_pointer
id|Source
(braket
id|i
)braket
suffix:semicolon
id|NumISUs
op_increment
suffix:semicolon
)brace
id|NumSources
op_assign
id|NumISUs
op_star
l_int|0x10
suffix:semicolon
id|openpic2_vec_spurious
op_assign
id|NumSources
suffix:semicolon
id|openpic2_set_priority
c_func
(paren
l_int|0xf
)paren
suffix:semicolon
multiline_comment|/* Init all external sources */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NumSources
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|pri
comma
id|sense
suffix:semicolon
multiline_comment|/* the bootloader may have left it enabled (bad !) */
id|openpic2_disable_irq
c_func
(paren
id|i
op_plus
id|offset
)paren
suffix:semicolon
id|pri
op_assign
l_int|8
suffix:semicolon
id|sense
op_assign
(paren
id|i
OL
id|OpenPIC_NumInitSenses
)paren
ques
c_cond
id|OpenPIC_InitSenses
(braket
id|i
)braket
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sense
)paren
id|irq_desc
(braket
id|i
op_plus
id|offset
)braket
dot
id|status
op_assign
id|IRQ_LEVEL
suffix:semicolon
multiline_comment|/* Enabled, Priority 8 or 9 */
id|openpic2_initirq
c_func
(paren
id|i
comma
id|pri
comma
id|i
comma
op_logical_neg
id|sense
comma
id|sense
)paren
suffix:semicolon
multiline_comment|/* Processor 0 */
id|openpic2_mapirq
c_func
(paren
id|i
comma
l_int|0x1
)paren
suffix:semicolon
)brace
multiline_comment|/* Init descriptors */
r_for
c_loop
(paren
id|i
op_assign
id|offset
suffix:semicolon
id|i
OL
id|NumSources
op_plus
id|offset
suffix:semicolon
id|i
op_increment
)paren
id|irq_desc
(braket
id|i
)braket
dot
id|handler
op_assign
op_amp
id|open_pic2
suffix:semicolon
multiline_comment|/* Initialize the spurious interrupt */
id|openpic2_set_spurious
c_func
(paren
id|openpic2_vec_spurious
)paren
suffix:semicolon
id|openpic2_set_priority
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|openpic2_disable_8259_pass_through
c_func
(paren
)paren
suffix:semicolon
id|ppc64_boot_msg
c_func
(paren
l_int|0x25
comma
l_string|&quot;OpenPic U3 Done&quot;
)paren
suffix:semicolon
)brace
eof
