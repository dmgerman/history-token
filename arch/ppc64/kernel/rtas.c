multiline_comment|/*&n; *&n; * Procedures for interfacing to the RTAS on CHRP machines.&n; *&n; * Peter Bergner, IBM&t;March 2001.&n; * Copyright (C) 2001 IBM.&n; *&n; *      This program is free software; you can redistribute it and/or&n; *      modify it under the terms of the GNU General Public License&n; *      as published by the Free Software Foundation; either version&n; *      2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;stdarg.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/rtas.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/paca.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/param.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/abs_addr.h&gt;
macro_line|#include &lt;asm/udbg.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|variable|rtas_firmware_flash_list
r_struct
id|flash_block_list_header
id|rtas_firmware_flash_list
op_assign
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/*&n; * prom_init() is called very early on, before the kernel text&n; * and data have been mapped to KERNELBASE.  At this point the code&n; * is running at whatever address it has been loaded at, so&n; * references to extern and static variables must be relocated&n; * explicitly.  The procedure reloc_offset() returns the address&n; * we&squot;re currently running at minus the address we were linked at.&n; * (Note that strings count as static variables.)&n; *&n; * Because OF may have mapped I/O devices into the area starting at&n; * KERNELBASE, particularly on CHRP machines, we can&squot;t safely call&n; * OF once the kernel has been mapped to KERNELBASE.  Therefore all&n; * OF calls should be done within prom_init(), and prom_init()&n; * and all routines called within it must be careful to relocate&n; * references as necessary.&n; *&n; * Note that the bss is cleared *after* prom_init runs, so we have&n; * to make sure that any static or extern variables it accesses&n; * are put in the data segment.&n; */
DECL|variable|rtas
r_struct
id|rtas_t
id|rtas
op_assign
(brace
dot
id|lock
op_assign
id|SPIN_LOCK_UNLOCKED
)brace
suffix:semicolon
DECL|variable|rtas_err_buf
r_char
id|rtas_err_buf
(braket
id|RTAS_ERROR_LOG_MAX
)braket
suffix:semicolon
r_extern
r_int
r_int
id|reloc_offset
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|variable|rtas_data_buf_lock
id|spinlock_t
id|rtas_data_buf_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|__page_aligned
r_char
id|rtas_data_buf
(braket
id|RTAS_DATA_BUF_SIZE
)braket
id|__page_aligned
suffix:semicolon
r_void
DECL|function|call_rtas_display_status
id|call_rtas_display_status
c_func
(paren
r_char
id|c
)paren
(brace
r_struct
id|rtas_args
op_star
id|args
suffix:semicolon
r_int
r_int
id|s
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|rtas.lock
comma
id|s
)paren
suffix:semicolon
id|args
op_assign
op_amp
(paren
id|get_paca
c_func
(paren
)paren
op_member_access_from_pointer
id|xRtas
)paren
suffix:semicolon
id|args-&gt;token
op_assign
l_int|10
suffix:semicolon
id|args-&gt;nargs
op_assign
l_int|1
suffix:semicolon
id|args-&gt;nret
op_assign
l_int|1
suffix:semicolon
id|args-&gt;rets
op_assign
(paren
id|rtas_arg_t
op_star
)paren
op_amp
(paren
id|args-&gt;args
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|args-&gt;args
(braket
l_int|0
)braket
op_assign
(paren
r_int
)paren
id|c
suffix:semicolon
id|enter_rtas
c_func
(paren
id|__pa
c_func
(paren
id|args
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|rtas.lock
comma
id|s
)paren
suffix:semicolon
)brace
r_int
DECL|function|rtas_token
id|rtas_token
c_func
(paren
r_const
r_char
op_star
id|service
)paren
(brace
r_int
op_star
id|tokp
suffix:semicolon
r_if
c_cond
(paren
id|rtas.dev
op_eq
l_int|NULL
)paren
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_RTAS
comma
l_string|&quot;&bslash;tNo rtas device in device-tree...&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RTAS_UNKNOWN_SERVICE
suffix:semicolon
)brace
id|tokp
op_assign
(paren
r_int
op_star
)paren
id|get_property
c_func
(paren
id|rtas.dev
comma
id|service
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|tokp
ques
c_cond
op_star
id|tokp
suffix:colon
id|RTAS_UNKNOWN_SERVICE
suffix:semicolon
)brace
r_static
r_int
DECL|function|__log_rtas_error
id|__log_rtas_error
c_func
(paren
r_struct
id|rtas_args
op_star
id|rtas_args
)paren
(brace
r_struct
id|rtas_args
id|err_args
comma
id|temp_args
suffix:semicolon
id|err_args.token
op_assign
id|rtas_token
c_func
(paren
l_string|&quot;rtas-last-error&quot;
)paren
suffix:semicolon
id|err_args.nargs
op_assign
l_int|2
suffix:semicolon
id|err_args.nret
op_assign
l_int|1
suffix:semicolon
id|err_args.rets
op_assign
(paren
id|rtas_arg_t
op_star
)paren
op_amp
(paren
id|err_args.args
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|err_args.args
(braket
l_int|0
)braket
op_assign
(paren
id|rtas_arg_t
)paren
id|__pa
c_func
(paren
id|rtas_err_buf
)paren
suffix:semicolon
id|err_args.args
(braket
l_int|1
)braket
op_assign
id|RTAS_ERROR_LOG_MAX
suffix:semicolon
id|err_args.args
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|temp_args
op_assign
op_star
id|rtas_args
suffix:semicolon
id|get_paca
c_func
(paren
)paren
op_member_access_from_pointer
id|xRtas
op_assign
id|err_args
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_RTAS
comma
l_string|&quot;&bslash;tentering rtas with 0x%lx&bslash;n&quot;
comma
id|__pa
c_func
(paren
op_amp
id|err_args
)paren
)paren
suffix:semicolon
id|enter_rtas
c_func
(paren
id|__pa
c_func
(paren
op_amp
id|get_paca
c_func
(paren
)paren
op_member_access_from_pointer
id|xRtas
)paren
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_RTAS
comma
l_string|&quot;&bslash;treturned from rtas ...&bslash;n&quot;
)paren
suffix:semicolon
id|err_args
op_assign
id|get_paca
c_func
(paren
)paren
op_member_access_from_pointer
id|xRtas
suffix:semicolon
id|get_paca
c_func
(paren
)paren
op_member_access_from_pointer
id|xRtas
op_assign
id|temp_args
suffix:semicolon
r_return
id|err_args.rets
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_void
DECL|function|log_rtas_error
id|log_rtas_error
c_func
(paren
r_struct
id|rtas_args
op_star
id|rtas_args
)paren
(brace
r_int
r_int
id|s
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|rtas.lock
comma
id|s
)paren
suffix:semicolon
id|rc
op_assign
id|__log_rtas_error
c_func
(paren
id|rtas_args
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|rtas.lock
comma
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
id|log_error
c_func
(paren
id|rtas_err_buf
comma
id|ERR_TYPE_RTAS_LOG
comma
l_int|0
)paren
suffix:semicolon
)brace
r_int
DECL|function|rtas_call
id|rtas_call
c_func
(paren
r_int
id|token
comma
r_int
id|nargs
comma
r_int
id|nret
comma
r_int
r_int
op_star
id|outputs
comma
dot
dot
dot
)paren
(brace
id|va_list
id|list
suffix:semicolon
r_int
id|i
comma
id|logit
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|s
suffix:semicolon
r_struct
id|rtas_args
op_star
id|rtas_args
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_RTAS
comma
l_string|&quot;Entering rtas_call&bslash;n&quot;
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_RTAS
comma
l_string|&quot;&bslash;ttoken    = 0x%x&bslash;n&quot;
comma
id|token
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_RTAS
comma
l_string|&quot;&bslash;tnargs    = %d&bslash;n&quot;
comma
id|nargs
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_RTAS
comma
l_string|&quot;&bslash;tnret     = %d&bslash;n&quot;
comma
id|nret
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_RTAS
comma
l_string|&quot;&bslash;t&amp;outputs = 0x%lx&bslash;n&quot;
comma
id|outputs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|token
op_eq
id|RTAS_UNKNOWN_SERVICE
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Gotta do something different here, use global lock for now... */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|rtas.lock
comma
id|s
)paren
suffix:semicolon
id|rtas_args
op_assign
op_amp
(paren
id|get_paca
c_func
(paren
)paren
op_member_access_from_pointer
id|xRtas
)paren
suffix:semicolon
id|rtas_args-&gt;token
op_assign
id|token
suffix:semicolon
id|rtas_args-&gt;nargs
op_assign
id|nargs
suffix:semicolon
id|rtas_args-&gt;nret
op_assign
id|nret
suffix:semicolon
id|rtas_args-&gt;rets
op_assign
(paren
id|rtas_arg_t
op_star
)paren
op_amp
(paren
id|rtas_args-&gt;args
(braket
id|nargs
)braket
)paren
suffix:semicolon
id|va_start
c_func
(paren
id|list
comma
id|outputs
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nargs
suffix:semicolon
op_increment
id|i
)paren
(brace
id|rtas_args-&gt;args
(braket
id|i
)braket
op_assign
(paren
id|rtas_arg_t
)paren
id|LONG_LSW
c_func
(paren
id|va_arg
c_func
(paren
id|list
comma
id|ulong
)paren
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_RTAS
comma
l_string|&quot;&bslash;tnarg[%d] = 0x%lx&bslash;n&quot;
comma
id|i
comma
id|rtas_args-&gt;args
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|va_end
c_func
(paren
id|list
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nret
suffix:semicolon
op_increment
id|i
)paren
id|rtas_args-&gt;rets
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_RTAS
comma
l_string|&quot;&bslash;tentering rtas with 0x%lx&bslash;n&quot;
comma
id|__pa
c_func
(paren
id|rtas_args
)paren
)paren
suffix:semicolon
id|enter_rtas
c_func
(paren
id|__pa
c_func
(paren
id|rtas_args
)paren
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_RTAS
comma
l_string|&quot;&bslash;treturned from rtas ...&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rtas_args-&gt;rets
(braket
l_int|0
)braket
op_eq
op_minus
l_int|1
)paren
id|logit
op_assign
(paren
id|__log_rtas_error
c_func
(paren
id|rtas_args
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|ifppcdebug
c_func
(paren
id|PPCDBG_RTAS
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nret
suffix:semicolon
id|i
op_increment
)paren
(brace
id|udbg_printf
c_func
(paren
l_string|&quot;&bslash;tnret[%d] = 0x%lx&bslash;n&quot;
comma
id|i
comma
(paren
id|ulong
)paren
id|rtas_args-&gt;rets
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|nret
OG
l_int|1
op_logical_and
id|outputs
op_ne
l_int|NULL
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nret
op_minus
l_int|1
suffix:semicolon
op_increment
id|i
)paren
id|outputs
(braket
id|i
)braket
op_assign
id|rtas_args-&gt;rets
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
id|ret
op_assign
(paren
id|ulong
)paren
(paren
(paren
id|nret
OG
l_int|0
)paren
ques
c_cond
id|rtas_args-&gt;rets
(braket
l_int|0
)braket
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Gotta do something different here, use global lock for now... */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|rtas.lock
comma
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|logit
)paren
id|log_error
c_func
(paren
id|rtas_err_buf
comma
id|ERR_TYPE_RTAS_LOG
comma
l_int|0
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Given an RTAS status code of 990n compute the hinted delay of 10^n&n; * (last digit) milliseconds.  For now we bound at n=5 (100 sec).&n; */
r_int
r_int
DECL|function|rtas_extended_busy_delay_time
id|rtas_extended_busy_delay_time
c_func
(paren
r_int
id|status
)paren
(brace
r_int
id|order
op_assign
id|status
op_minus
l_int|9900
suffix:semicolon
r_int
r_int
id|ms
suffix:semicolon
r_if
c_cond
(paren
id|order
OL
l_int|0
)paren
id|order
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* RTC depends on this for -2 clock busy */
r_else
r_if
c_cond
(paren
id|order
OG
l_int|5
)paren
id|order
op_assign
l_int|5
suffix:semicolon
multiline_comment|/* bound */
multiline_comment|/* Use microseconds for reasonable accuracy */
r_for
c_loop
(paren
id|ms
op_assign
l_int|1
suffix:semicolon
id|order
OG
l_int|0
suffix:semicolon
id|order
op_decrement
)paren
id|ms
op_mul_assign
l_int|10
suffix:semicolon
r_return
id|ms
suffix:semicolon
)brace
r_int
DECL|function|rtas_get_power_level
id|rtas_get_power_level
c_func
(paren
r_int
id|powerdomain
comma
r_int
op_star
id|level
)paren
(brace
r_int
id|token
op_assign
id|rtas_token
c_func
(paren
l_string|&quot;get-power-level&quot;
)paren
suffix:semicolon
r_int
id|powerlevel
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|token
op_eq
id|RTAS_UNKNOWN_SERVICE
)paren
r_return
id|RTAS_UNKNOWN_OP
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|rc
op_assign
(paren
r_int
)paren
id|rtas_call
c_func
(paren
id|token
comma
l_int|1
comma
l_int|2
comma
op_amp
id|powerlevel
comma
id|powerdomain
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|RTAS_BUSY
)paren
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_else
r_break
suffix:semicolon
)brace
op_star
id|level
op_assign
(paren
r_int
)paren
id|powerlevel
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|rtas_set_power_level
id|rtas_set_power_level
c_func
(paren
r_int
id|powerdomain
comma
r_int
id|level
comma
r_int
op_star
id|setlevel
)paren
(brace
r_int
id|token
op_assign
id|rtas_token
c_func
(paren
l_string|&quot;set-power-level&quot;
)paren
suffix:semicolon
r_int
r_int
id|wait_time
suffix:semicolon
r_int
id|returned_level
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|token
op_eq
id|RTAS_UNKNOWN_SERVICE
)paren
r_return
id|RTAS_UNKNOWN_OP
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|rc
op_assign
(paren
r_int
)paren
id|rtas_call
c_func
(paren
id|token
comma
l_int|2
comma
l_int|2
comma
op_amp
id|returned_level
comma
id|powerdomain
comma
id|level
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|RTAS_BUSY
)paren
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rtas_is_extended_busy
c_func
(paren
id|rc
)paren
)paren
(brace
id|wait_time
op_assign
id|rtas_extended_busy_delay_time
c_func
(paren
id|rc
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|wait_time
op_star
l_int|1000
)paren
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
)brace
op_star
id|setlevel
op_assign
(paren
r_int
)paren
id|returned_level
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|rtas_get_sensor
id|rtas_get_sensor
c_func
(paren
r_int
id|sensor
comma
r_int
id|index
comma
r_int
op_star
id|state
)paren
(brace
r_int
id|token
op_assign
id|rtas_token
c_func
(paren
l_string|&quot;get-sensor-state&quot;
)paren
suffix:semicolon
r_int
r_int
id|wait_time
suffix:semicolon
r_int
id|returned_state
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|token
op_eq
id|RTAS_UNKNOWN_SERVICE
)paren
r_return
id|RTAS_UNKNOWN_OP
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|rc
op_assign
(paren
r_int
)paren
id|rtas_call
c_func
(paren
id|token
comma
l_int|2
comma
l_int|2
comma
op_amp
id|returned_state
comma
id|sensor
comma
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|RTAS_BUSY
)paren
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rtas_is_extended_busy
c_func
(paren
id|rc
)paren
)paren
(brace
id|wait_time
op_assign
id|rtas_extended_busy_delay_time
c_func
(paren
id|rc
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|wait_time
op_star
l_int|1000
)paren
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
)brace
op_star
id|state
op_assign
(paren
r_int
)paren
id|returned_state
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|rtas_set_indicator
id|rtas_set_indicator
c_func
(paren
r_int
id|indicator
comma
r_int
id|index
comma
r_int
id|new_value
)paren
(brace
r_int
id|token
op_assign
id|rtas_token
c_func
(paren
l_string|&quot;set-indicator&quot;
)paren
suffix:semicolon
r_int
r_int
id|wait_time
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|token
op_eq
id|RTAS_UNKNOWN_SERVICE
)paren
r_return
id|RTAS_UNKNOWN_OP
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|rc
op_assign
(paren
r_int
)paren
id|rtas_call
c_func
(paren
id|token
comma
l_int|3
comma
l_int|1
comma
l_int|NULL
comma
id|indicator
comma
id|index
comma
id|new_value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|RTAS_BUSY
)paren
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rtas_is_extended_busy
c_func
(paren
id|rc
)paren
)paren
(brace
id|wait_time
op_assign
id|rtas_extended_busy_delay_time
c_func
(paren
id|rc
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|wait_time
op_star
l_int|1000
)paren
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
DECL|macro|FLASH_BLOCK_LIST_VERSION
mdefine_line|#define FLASH_BLOCK_LIST_VERSION (1UL)
r_static
r_void
DECL|function|rtas_flash_firmware
id|rtas_flash_firmware
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|image_size
suffix:semicolon
r_struct
id|flash_block_list
op_star
id|f
comma
op_star
id|next
comma
op_star
id|flist
suffix:semicolon
r_int
r_int
id|rtas_block_list
suffix:semicolon
r_int
id|i
comma
id|status
comma
id|update_token
suffix:semicolon
id|update_token
op_assign
id|rtas_token
c_func
(paren
l_string|&quot;ibm,update-flash-64-and-reboot&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|update_token
op_eq
id|RTAS_UNKNOWN_SERVICE
)paren
(brace
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;FLASH: ibm,update-flash-64-and-reboot is not available -- not a service partition?&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;FLASH: firmware will not be flashed&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* NOTE: the &quot;first&quot; block list is a global var with no data&n;&t; * blocks in the kernel data segment.  We do this because&n;&t; * we want to ensure this block_list addr is under 4GB.&n;&t; */
id|rtas_firmware_flash_list.num_blocks
op_assign
l_int|0
suffix:semicolon
id|flist
op_assign
(paren
r_struct
id|flash_block_list
op_star
)paren
op_amp
id|rtas_firmware_flash_list
suffix:semicolon
id|rtas_block_list
op_assign
id|virt_to_abs
c_func
(paren
id|flist
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rtas_block_list
op_ge
l_int|4UL
op_star
l_int|1024
op_star
l_int|1024
op_star
l_int|1024
)paren
(brace
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;FLASH: kernel bug...flash list header addr above 4GB&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;FLASH: preparing saved firmware image for flash&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Update the block_list in place. */
id|image_size
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|f
op_assign
id|flist
suffix:semicolon
id|f
suffix:semicolon
id|f
op_assign
id|next
)paren
(brace
multiline_comment|/* Translate data addrs to absolute */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|f-&gt;num_blocks
suffix:semicolon
id|i
op_increment
)paren
(brace
id|f-&gt;blocks
(braket
id|i
)braket
dot
id|data
op_assign
(paren
r_char
op_star
)paren
id|virt_to_abs
c_func
(paren
id|f-&gt;blocks
(braket
id|i
)braket
dot
id|data
)paren
suffix:semicolon
id|image_size
op_add_assign
id|f-&gt;blocks
(braket
id|i
)braket
dot
id|length
suffix:semicolon
)brace
id|next
op_assign
id|f-&gt;next
suffix:semicolon
multiline_comment|/* Don&squot;t translate NULL pointer for last entry */
r_if
c_cond
(paren
id|f-&gt;next
)paren
id|f-&gt;next
op_assign
(paren
r_struct
id|flash_block_list
op_star
)paren
id|virt_to_abs
c_func
(paren
id|f-&gt;next
)paren
suffix:semicolon
r_else
id|f-&gt;next
op_assign
l_int|0LL
suffix:semicolon
multiline_comment|/* make num_blocks into the version/length field */
id|f-&gt;num_blocks
op_assign
(paren
id|FLASH_BLOCK_LIST_VERSION
op_lshift
l_int|56
)paren
op_or
(paren
(paren
id|f-&gt;num_blocks
op_plus
l_int|1
)paren
op_star
l_int|16
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;FLASH: flash image is %ld bytes&bslash;n&quot;
comma
id|image_size
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;FLASH: performing flash and reboot&bslash;n&quot;
)paren
suffix:semicolon
id|ppc_md
dot
id|progress
c_func
(paren
l_string|&quot;Flashing        &bslash;n&quot;
comma
l_int|0x0
)paren
suffix:semicolon
id|ppc_md
dot
id|progress
c_func
(paren
l_string|&quot;Please Wait...  &quot;
comma
l_int|0x0
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;FLASH: this will take several minutes.  Do not power off!&bslash;n&quot;
)paren
suffix:semicolon
id|status
op_assign
id|rtas_call
c_func
(paren
id|update_token
comma
l_int|1
comma
l_int|1
comma
l_int|NULL
comma
id|rtas_block_list
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|status
)paren
(brace
multiline_comment|/* should only get &quot;bad&quot; status */
r_case
l_int|0
suffix:colon
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;FLASH: success&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
l_int|1
suffix:colon
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;FLASH: hardware error.  Firmware may not be not flashed&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
l_int|3
suffix:colon
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;FLASH: image is corrupt or not correct for this platform.  Firmware not flashed&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
l_int|4
suffix:colon
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;FLASH: flash failed when partially complete.  System may not reboot&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;FLASH: unknown flash return code %d&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|rtas_flash_bypass_warning
r_void
id|rtas_flash_bypass_warning
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;FLASH: firmware flash requires a reboot&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;FLASH: the firmware image will NOT be flashed&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_void
DECL|function|rtas_restart
id|rtas_restart
c_func
(paren
r_char
op_star
id|cmd
)paren
(brace
r_if
c_cond
(paren
id|rtas_firmware_flash_list.next
)paren
id|rtas_flash_firmware
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;RTAS system-reboot returned %ld&bslash;n&quot;
comma
id|rtas_call
c_func
(paren
id|rtas_token
c_func
(paren
l_string|&quot;system-reboot&quot;
)paren
comma
l_int|0
comma
l_int|1
comma
l_int|NULL
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
suffix:semicolon
)brace
r_void
DECL|function|rtas_power_off
id|rtas_power_off
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|rtas_firmware_flash_list.next
)paren
id|rtas_flash_bypass_warning
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* allow power on only with power button press */
id|printk
c_func
(paren
l_string|&quot;RTAS power-off returned %ld&bslash;n&quot;
comma
id|rtas_call
c_func
(paren
id|rtas_token
c_func
(paren
l_string|&quot;power-off&quot;
)paren
comma
l_int|2
comma
l_int|1
comma
l_int|NULL
comma
l_int|0xffffffff
comma
l_int|0xffffffff
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
suffix:semicolon
)brace
r_void
DECL|function|rtas_halt
id|rtas_halt
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|rtas_firmware_flash_list.next
)paren
id|rtas_flash_bypass_warning
c_func
(paren
)paren
suffix:semicolon
id|rtas_power_off
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Must be in the RMO region, so we place it here */
DECL|variable|rtas_os_term_buf
r_static
r_char
id|rtas_os_term_buf
(braket
l_int|2048
)braket
suffix:semicolon
DECL|function|rtas_os_term
r_void
id|rtas_os_term
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|status
suffix:semicolon
id|snprintf
c_func
(paren
id|rtas_os_term_buf
comma
l_int|2048
comma
l_string|&quot;OS panic: %s&quot;
comma
id|str
)paren
suffix:semicolon
r_do
(brace
id|status
op_assign
id|rtas_call
c_func
(paren
id|rtas_token
c_func
(paren
l_string|&quot;ibm,os-term&quot;
)paren
comma
l_int|1
comma
l_int|1
comma
l_int|NULL
comma
id|__pa
c_func
(paren
id|rtas_os_term_buf
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
id|RTAS_BUSY
)paren
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|status
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;ibm,os-term call failed %ld&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|status
op_eq
id|RTAS_BUSY
)paren
suffix:semicolon
)brace
DECL|variable|rtas_rmo_buf
r_int
r_int
id|rtas_rmo_buf
op_assign
l_int|0
suffix:semicolon
DECL|function|ppc_rtas
id|asmlinkage
r_int
id|ppc_rtas
c_func
(paren
r_struct
id|rtas_args
id|__user
op_star
id|uargs
)paren
(brace
r_struct
id|rtas_args
id|args
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|nargs
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|args
comma
id|uargs
comma
l_int|3
op_star
r_sizeof
(paren
id|u32
)paren
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|nargs
op_assign
id|args.nargs
suffix:semicolon
r_if
c_cond
(paren
id|nargs
OG
id|ARRAY_SIZE
c_func
(paren
id|args.args
)paren
op_logical_or
id|args.nret
OG
id|ARRAY_SIZE
c_func
(paren
id|args.args
)paren
op_logical_or
id|nargs
op_plus
id|args.nret
OG
id|ARRAY_SIZE
c_func
(paren
id|args.args
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Copy in args. */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|args.args
comma
id|uargs-&gt;args
comma
id|nargs
op_star
r_sizeof
(paren
id|rtas_arg_t
)paren
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|rtas.lock
comma
id|flags
)paren
suffix:semicolon
id|get_paca
c_func
(paren
)paren
op_member_access_from_pointer
id|xRtas
op_assign
id|args
suffix:semicolon
id|enter_rtas
c_func
(paren
id|__pa
c_func
(paren
op_amp
id|get_paca
c_func
(paren
)paren
op_member_access_from_pointer
id|xRtas
)paren
)paren
suffix:semicolon
id|args
op_assign
id|get_paca
c_func
(paren
)paren
op_member_access_from_pointer
id|xRtas
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|rtas.lock
comma
id|flags
)paren
suffix:semicolon
id|args.rets
op_assign
(paren
id|rtas_arg_t
op_star
)paren
op_amp
(paren
id|args.args
(braket
id|nargs
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|args.rets
(braket
l_int|0
)braket
op_eq
op_minus
l_int|1
)paren
id|log_rtas_error
c_func
(paren
op_amp
id|args
)paren
suffix:semicolon
multiline_comment|/* Copy out args. */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|uargs-&gt;args
op_plus
id|nargs
comma
id|args.args
op_plus
id|nargs
comma
id|args.nret
op_star
r_sizeof
(paren
id|rtas_arg_t
)paren
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_HOTPLUG_CPU
multiline_comment|/* This version can&squot;t take the spinlock. */
DECL|function|rtas_stop_self
r_void
id|rtas_stop_self
c_func
(paren
r_void
)paren
(brace
r_struct
id|rtas_args
op_star
id|rtas_args
op_assign
op_amp
(paren
id|get_paca
c_func
(paren
)paren
op_member_access_from_pointer
id|xRtas
)paren
suffix:semicolon
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
id|rtas_args-&gt;token
op_assign
id|rtas_token
c_func
(paren
l_string|&quot;stop-self&quot;
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|rtas_args-&gt;token
op_eq
id|RTAS_UNKNOWN_SERVICE
)paren
suffix:semicolon
id|rtas_args-&gt;nargs
op_assign
l_int|0
suffix:semicolon
id|rtas_args-&gt;nret
op_assign
l_int|1
suffix:semicolon
id|rtas_args-&gt;rets
op_assign
op_amp
(paren
id|rtas_args-&gt;args
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%u %u Ready to die...&bslash;n&quot;
comma
id|smp_processor_id
c_func
(paren
)paren
comma
id|hard_smp_processor_id
c_func
(paren
)paren
)paren
suffix:semicolon
id|enter_rtas
c_func
(paren
id|__pa
c_func
(paren
id|rtas_args
)paren
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;Alas, I survived.&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_HOTPLUG_CPU */
DECL|variable|rtas_firmware_flash_list
id|EXPORT_SYMBOL
c_func
(paren
id|rtas_firmware_flash_list
)paren
suffix:semicolon
DECL|variable|rtas_token
id|EXPORT_SYMBOL
c_func
(paren
id|rtas_token
)paren
suffix:semicolon
DECL|variable|rtas_call
id|EXPORT_SYMBOL
c_func
(paren
id|rtas_call
)paren
suffix:semicolon
DECL|variable|rtas_data_buf
id|EXPORT_SYMBOL
c_func
(paren
id|rtas_data_buf
)paren
suffix:semicolon
DECL|variable|rtas_data_buf_lock
id|EXPORT_SYMBOL
c_func
(paren
id|rtas_data_buf_lock
)paren
suffix:semicolon
DECL|variable|rtas_extended_busy_delay_time
id|EXPORT_SYMBOL
c_func
(paren
id|rtas_extended_busy_delay_time
)paren
suffix:semicolon
DECL|variable|rtas_get_sensor
id|EXPORT_SYMBOL
c_func
(paren
id|rtas_get_sensor
)paren
suffix:semicolon
DECL|variable|rtas_get_power_level
id|EXPORT_SYMBOL
c_func
(paren
id|rtas_get_power_level
)paren
suffix:semicolon
DECL|variable|rtas_set_power_level
id|EXPORT_SYMBOL
c_func
(paren
id|rtas_set_power_level
)paren
suffix:semicolon
DECL|variable|rtas_set_indicator
id|EXPORT_SYMBOL
c_func
(paren
id|rtas_set_indicator
)paren
suffix:semicolon
eof
