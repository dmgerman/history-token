multiline_comment|/*&n; * IBM PowerPC Virtual I/O Infrastructure Support.&n; *&n; *    Copyright (c) 2003 IBM Corp.&n; *     Dave Engebretsen engebret@us.ibm.com&n; *     Santiago Leon santil@us.ibm.com&n; *&n; *      This program is free software; you can redistribute it and/or&n; *      modify it under the terms of the GNU General Public License&n; *      as published by the Free Software Foundation; either version&n; *      2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/rtas.h&gt;
macro_line|#include &lt;asm/pci_dma.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/ppcdebug.h&gt;
macro_line|#include &lt;asm/vio.h&gt;
macro_line|#include &lt;asm/hvcall.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &quot;open_pic.h&quot; &t;/* temporary, until we merge large irq support */
r_extern
r_struct
id|TceTable
op_star
id|build_tce_table
c_func
(paren
r_struct
id|TceTable
op_star
id|tbl
)paren
suffix:semicolon
r_extern
id|dma_addr_t
id|get_tces
c_func
(paren
r_struct
id|TceTable
op_star
comma
r_int
id|order
comma
r_void
op_star
id|page
comma
r_int
id|numPages
comma
r_int
id|direction
)paren
suffix:semicolon
r_extern
r_void
id|tce_free
c_func
(paren
r_struct
id|TceTable
op_star
id|tbl
comma
id|dma_addr_t
id|dma_addr
comma
r_int
id|order
comma
r_int
id|num_pages
)paren
suffix:semicolon
DECL|variable|vio_bus
r_static
r_struct
id|vio_bus
id|vio_bus
suffix:semicolon
r_static
id|LIST_HEAD
c_func
(paren
id|registered_vio_drivers
)paren
suffix:semicolon
DECL|variable|vio_num_address_cells
r_int
id|vio_num_address_cells
suffix:semicolon
DECL|variable|vio_num_address_cells
id|EXPORT_SYMBOL
c_func
(paren
id|vio_num_address_cells
)paren
suffix:semicolon
multiline_comment|/* TODO:&n; *   really fit into driver model (see include/linux/device.h)&n; *   locking around list accesses&n; */
multiline_comment|/**&n; * vio_register_driver: - Register a new vio driver&n; * @drv:&t;The vio_driver structure to be registered.&n; *&n; * Adds the driver structure to the list of registered drivers&n; * Returns the number of vio devices which were claimed by the driver&n; * during registration.  The driver remains registered even if the&n; * return value is zero.&n; */
DECL|function|vio_register_driver
r_int
id|vio_register_driver
c_func
(paren
r_struct
id|vio_driver
op_star
id|drv
)paren
(brace
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_struct
id|vio_dev
op_star
id|dev
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: driver %s/%s registering&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|drv-&gt;id_table
(braket
l_int|0
)braket
dot
id|type
comma
id|drv-&gt;id_table
(braket
l_int|0
)braket
dot
id|type
)paren
suffix:semicolon
multiline_comment|/* find matching devices not already claimed by other drivers and pass&n;&t; * them to probe() */
id|list_for_each_entry
c_func
(paren
id|dev
comma
op_amp
id|vio_bus.devices
comma
id|devices_list
)paren
(brace
r_const
r_struct
id|vio_device_id
op_star
id|id
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;driver
)paren
r_continue
suffix:semicolon
multiline_comment|/* this device is already owned */
id|id
op_assign
id|vio_match_device
c_func
(paren
id|drv-&gt;id_table
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drv
op_logical_and
id|id
)paren
(brace
r_if
c_cond
(paren
l_int|0
op_eq
id|drv
op_member_access_from_pointer
id|probe
c_func
(paren
id|dev
comma
id|id
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  took device %p&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|dev-&gt;driver
op_assign
id|drv
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
)brace
)brace
id|list_add_tail
c_func
(paren
op_amp
id|drv-&gt;node
comma
op_amp
id|registered_vio_drivers
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|variable|vio_register_driver
id|EXPORT_SYMBOL
c_func
(paren
id|vio_register_driver
)paren
suffix:semicolon
multiline_comment|/**&n; * vio_unregister_driver - Remove registration of vio driver.&n; * @driver:&t;The vio_driver struct to be removed form registration&n; *&n; * Searches for devices that are assigned to the driver and calls&n; * driver-&gt;remove() for each one.  Removes the driver from the list&n; * of registered drivers.  Returns the number of devices that were&n; * assigned to that driver.&n; */
DECL|function|vio_unregister_driver
r_int
id|vio_unregister_driver
c_func
(paren
r_struct
id|vio_driver
op_star
id|driver
)paren
(brace
r_struct
id|vio_dev
op_star
id|dev
suffix:semicolon
r_int
id|devices_found
op_assign
l_int|0
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|dev
comma
op_amp
id|vio_bus.devices
comma
id|devices_list
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;driver
op_eq
id|driver
)paren
(brace
id|driver
op_member_access_from_pointer
id|remove
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;driver
op_assign
l_int|NULL
suffix:semicolon
id|devices_found
op_increment
suffix:semicolon
)brace
)brace
id|list_del
c_func
(paren
op_amp
id|driver-&gt;node
)paren
suffix:semicolon
r_return
id|devices_found
suffix:semicolon
)brace
DECL|variable|vio_unregister_driver
id|EXPORT_SYMBOL
c_func
(paren
id|vio_unregister_driver
)paren
suffix:semicolon
multiline_comment|/**&n; * vio_match_device: - Tell if a VIO device has a matching VIO device id structure.&n; * @ids: &t;array of VIO device id structures to search in&n; * @dev: &t;the VIO device structure to match against&n; *&n; * Used by a driver to check whether a VIO device present in the&n; * system is in its list of supported devices. Returns the matching&n; * vio_device_id structure or NULL if there is no match.&n; */
r_const
r_struct
id|vio_device_id
op_star
DECL|function|vio_match_device
id|vio_match_device
c_func
(paren
r_const
r_struct
id|vio_device_id
op_star
id|ids
comma
r_const
r_struct
id|vio_dev
op_star
id|dev
)paren
(brace
r_while
c_loop
(paren
id|ids-&gt;type
)paren
(brace
r_if
c_cond
(paren
(paren
id|strncmp
c_func
(paren
id|dev-&gt;archdata-&gt;type
comma
id|ids-&gt;type
comma
id|strlen
c_func
(paren
id|ids-&gt;type
)paren
)paren
op_eq
l_int|0
)paren
op_logical_and
id|device_is_compatible
c_func
(paren
(paren
r_struct
id|device_node
op_star
)paren
id|dev-&gt;archdata
comma
id|ids-&gt;compat
)paren
)paren
r_return
id|ids
suffix:semicolon
id|ids
op_increment
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/**&n; * vio_bus_init: - Initialize the virtual IO bus&n; */
r_int
id|__init
DECL|function|vio_bus_init
id|vio_bus_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|node_vroot
comma
op_star
id|node_vdev
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|vio_bus.devices
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Create device node entries for each virtual device&n;&t; * identified in the device tree.&n;&t; * Functionally takes the place of pci_scan_bus&n;&t; */
id|node_vroot
op_assign
id|find_devices
c_func
(paren
l_string|&quot;vdevice&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|node_vroot
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|node_vroot-&gt;child
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;VIO: missing or empty /vdevice node; no virtual IO&quot;
l_string|&quot; devices present.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|vio_num_address_cells
op_assign
id|prom_n_addr_cells
c_func
(paren
id|node_vroot-&gt;child
)paren
suffix:semicolon
r_for
c_loop
(paren
id|node_vdev
op_assign
id|node_vroot-&gt;child
suffix:semicolon
id|node_vdev
op_ne
l_int|NULL
suffix:semicolon
id|node_vdev
op_assign
id|node_vdev-&gt;sibling
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: processing %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|node_vdev
)paren
suffix:semicolon
id|vio_register_device
c_func
(paren
id|node_vdev
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|vio_bus_init
id|__initcall
c_func
(paren
id|vio_bus_init
)paren
suffix:semicolon
multiline_comment|/**&n; * vio_probe_device - attach dev to appropriate driver&n; * @dev:&t;device to find a driver for&n; *&n; * Walks the list of registered VIO drivers looking for one to take this&n; * device.&n; *&n; * Returns a pointer to the matched driver or NULL if driver is not&n; * found.&n; */
DECL|function|vio_probe_device
r_struct
id|vio_driver
op_star
id|__devinit
id|vio_probe_device
c_func
(paren
r_struct
id|vio_dev
op_star
id|dev
)paren
(brace
r_struct
id|vio_driver
op_star
id|driver
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|driver
comma
op_amp
id|registered_vio_drivers
comma
id|node
)paren
(brace
r_const
r_struct
id|vio_device_id
op_star
id|id
suffix:semicolon
id|id
op_assign
id|vio_match_device
c_func
(paren
id|driver-&gt;id_table
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|id
op_logical_and
(paren
l_int|0
OL
id|driver
op_member_access_from_pointer
id|probe
c_func
(paren
id|dev
comma
id|id
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: driver %s/%s took device %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|id-&gt;type
comma
id|id-&gt;compat
comma
id|dev
)paren
suffix:semicolon
id|dev-&gt;driver
op_assign
id|driver
suffix:semicolon
r_return
id|driver
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: device %p found no driver&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/**&n; * vio_register_device: - Register a new vio device.&n; * @archdata:&t;The OF node for this device.&n; *&n; * Creates and initializes a vio_dev structure from the data in&n; * node_vdev (archdata) and adds it to the list of virtual devices.&n; * Returns a pointer to the created vio_dev or NULL if node has&n; * NULL device_type or compatible fields.&n; */
DECL|function|vio_register_device
r_struct
id|vio_dev
op_star
id|__devinit
id|vio_register_device
c_func
(paren
r_struct
id|device_node
op_star
id|node_vdev
)paren
(brace
r_struct
id|vio_dev
op_star
id|dev
suffix:semicolon
r_int
r_int
op_star
id|unit_address
suffix:semicolon
r_int
r_int
op_star
id|irq_p
suffix:semicolon
multiline_comment|/* guarantee all vio_devs have &squot;device_type&squot; field*/
r_if
c_cond
(paren
(paren
l_int|NULL
op_eq
id|node_vdev-&gt;type
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: node %s missing &squot;device_type&squot;&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|node_vdev-&gt;name
ques
c_cond
id|node_vdev-&gt;name
suffix:colon
l_string|&quot;&lt;unknown&gt;&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|unit_address
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_property
c_func
(paren
id|node_vdev
comma
l_string|&quot;reg&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|unit_address
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: node %s missing &squot;reg&squot;&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|node_vdev-&gt;name
ques
c_cond
id|node_vdev-&gt;name
suffix:colon
l_string|&quot;&lt;unknown&gt;&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* allocate a vio_dev for this node */
id|dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|dev
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|dev
)paren
)paren
suffix:semicolon
id|dev-&gt;archdata
op_assign
(paren
r_void
op_star
)paren
id|of_node_get
c_func
(paren
id|node_vdev
)paren
suffix:semicolon
id|dev-&gt;bus
op_assign
op_amp
id|vio_bus
suffix:semicolon
id|dev-&gt;unit_address
op_assign
op_star
id|unit_address
suffix:semicolon
id|dev-&gt;tce_table
op_assign
id|vio_build_tce_table
c_func
(paren
id|dev
)paren
suffix:semicolon
id|irq_p
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_property
c_func
(paren
id|node_vdev
comma
l_string|&quot;interrupts&quot;
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq_p
)paren
(brace
id|dev-&gt;irq
op_assign
id|openpic_to_irq
c_func
(paren
id|virt_irq_create_mapping
c_func
(paren
op_star
id|irq_p
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;irq
op_assign
(paren
r_int
r_int
)paren
op_minus
l_int|1
suffix:semicolon
)brace
id|list_add_tail
c_func
(paren
op_amp
id|dev-&gt;devices_list
comma
op_amp
id|vio_bus.devices
)paren
suffix:semicolon
id|vio_probe_device
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* finally, assign it to a driver */
r_return
id|dev
suffix:semicolon
)brace
DECL|variable|vio_register_device
id|EXPORT_SYMBOL
c_func
(paren
id|vio_register_device
)paren
suffix:semicolon
DECL|function|vio_unregister_device
r_int
id|__devinit
id|vio_unregister_device
c_func
(paren
r_struct
id|vio_dev
op_star
id|dev
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|dev-&gt;devices_list
)paren
suffix:semicolon
id|of_node_put
c_func
(paren
id|dev-&gt;archdata
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|vio_unregister_device
id|EXPORT_SYMBOL
c_func
(paren
id|vio_unregister_device
)paren
suffix:semicolon
multiline_comment|/**&n; * vio_get_attribute: - get attribute for virtual device&n; * @vdev:&t;The vio device to get property.&n; * @which:&t;The property/attribute to be extracted.&n; * @length:&t;Pointer to length of returned data size (unused if NULL).&n; *&n; * Calls prom.c&squot;s get_property() to return the value of the&n; * attribute specified by the preprocessor constant @which&n;*/
DECL|function|vio_get_attribute
r_const
r_void
op_star
id|vio_get_attribute
c_func
(paren
r_struct
id|vio_dev
op_star
id|vdev
comma
r_void
op_star
id|which
comma
r_int
op_star
id|length
)paren
(brace
r_return
id|get_property
c_func
(paren
(paren
r_struct
id|device_node
op_star
)paren
id|vdev-&gt;archdata
comma
(paren
r_char
op_star
)paren
id|which
comma
id|length
)paren
suffix:semicolon
)brace
DECL|variable|vio_get_attribute
id|EXPORT_SYMBOL
c_func
(paren
id|vio_get_attribute
)paren
suffix:semicolon
multiline_comment|/**&n; * vio_build_tce_table: - gets the dma information from OF and builds the TCE tree.&n; * @dev: the virtual device.&n; *&n; * Returns a pointer to the built tce tree, or NULL if it can&squot;t&n; * find property.&n;*/
DECL|function|vio_build_tce_table
r_struct
id|TceTable
op_star
id|vio_build_tce_table
c_func
(paren
r_struct
id|vio_dev
op_star
id|dev
)paren
(brace
r_int
r_int
op_star
id|dma_window
suffix:semicolon
r_struct
id|TceTable
op_star
id|newTceTable
suffix:semicolon
r_int
r_int
id|offset
suffix:semicolon
r_int
r_int
id|size
suffix:semicolon
r_int
id|dma_window_property_size
suffix:semicolon
id|dma_window
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_property
c_func
(paren
(paren
r_struct
id|device_node
op_star
)paren
id|dev-&gt;archdata
comma
l_string|&quot;ibm,my-dma-window&quot;
comma
op_amp
id|dma_window_property_size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dma_window
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|newTceTable
op_assign
(paren
r_struct
id|TceTable
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|TceTable
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
multiline_comment|/* RPA docs say that #address-cells is always 1 for virtual&n;&t;&t;devices, but some older boxes&squot; OF returns 2.  This should&n;&t;&t;be removed by GA, unless there is legacy OFs that still&n;&t;&t;have 2 for #address-cells */
id|size
op_assign
(paren
(paren
id|dma_window
(braket
l_int|1
op_plus
id|vio_num_address_cells
)braket
op_rshift
id|PAGE_SHIFT
)paren
op_lshift
l_int|3
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
multiline_comment|/* This is just an ugly kludge. Remove as soon as the OF for all&n;&t;machines actually follow the spec and encodes the offset field&n;&t;as phys-encode (that is, #address-cells wide)*/
r_if
c_cond
(paren
id|dma_window_property_size
op_eq
l_int|12
)paren
(brace
id|size
op_assign
(paren
(paren
id|dma_window
(braket
l_int|1
)braket
op_rshift
id|PAGE_SHIFT
)paren
op_lshift
l_int|3
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dma_window_property_size
op_eq
l_int|20
)paren
(brace
id|size
op_assign
(paren
(paren
id|dma_window
(braket
l_int|4
)braket
op_rshift
id|PAGE_SHIFT
)paren
op_lshift
l_int|3
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;vio_build_tce_table: Invalid size of ibm,my-dma-window=%i, using 0x80 for size&bslash;n&quot;
comma
id|dma_window_property_size
)paren
suffix:semicolon
id|size
op_assign
l_int|0x80
suffix:semicolon
)brace
multiline_comment|/*  There should be some code to extract the phys-encoded offset&n;&t;&t;using prom_n_addr_cells(). However, according to a comment&n;&t;&t;on earlier versions, it&squot;s always zero, so we don&squot;t bother */
id|offset
op_assign
id|dma_window
(braket
l_int|1
)braket
op_rshift
id|PAGE_SHIFT
suffix:semicolon
multiline_comment|/* TCE table size - measured in units of pages of tce table */
id|newTceTable-&gt;size
op_assign
id|size
suffix:semicolon
multiline_comment|/* offset for VIO should always be 0 */
id|newTceTable-&gt;startOffset
op_assign
id|offset
suffix:semicolon
id|newTceTable-&gt;busNumber
op_assign
l_int|0
suffix:semicolon
id|newTceTable-&gt;index
op_assign
(paren
r_int
r_int
)paren
id|dma_window
(braket
l_int|0
)braket
suffix:semicolon
id|newTceTable-&gt;tceType
op_assign
id|TCE_VB
suffix:semicolon
r_return
id|build_tce_table
c_func
(paren
id|newTceTable
)paren
suffix:semicolon
)brace
DECL|function|vio_enable_interrupts
r_int
id|vio_enable_interrupts
c_func
(paren
r_struct
id|vio_dev
op_star
id|dev
)paren
(brace
r_int
id|rc
op_assign
id|h_vio_signal
c_func
(paren
id|dev-&gt;unit_address
comma
id|VIO_IRQ_ENABLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
id|H_Success
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;vio: Error 0x%x enabling interrupts&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
DECL|variable|vio_enable_interrupts
id|EXPORT_SYMBOL
c_func
(paren
id|vio_enable_interrupts
)paren
suffix:semicolon
DECL|function|vio_disable_interrupts
r_int
id|vio_disable_interrupts
c_func
(paren
r_struct
id|vio_dev
op_star
id|dev
)paren
(brace
r_int
id|rc
op_assign
id|h_vio_signal
c_func
(paren
id|dev-&gt;unit_address
comma
id|VIO_IRQ_DISABLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
id|H_Success
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;vio: Error 0x%x disabling interrupts&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
DECL|variable|vio_disable_interrupts
id|EXPORT_SYMBOL
c_func
(paren
id|vio_disable_interrupts
)paren
suffix:semicolon
DECL|function|vio_map_single
id|dma_addr_t
id|vio_map_single
c_func
(paren
r_struct
id|vio_dev
op_star
id|dev
comma
r_void
op_star
id|vaddr
comma
r_int
id|size
comma
r_int
id|direction
)paren
(brace
r_struct
id|TceTable
op_star
id|tbl
suffix:semicolon
id|dma_addr_t
id|dma_handle
op_assign
id|NO_TCE
suffix:semicolon
r_int
r_int
id|uaddr
suffix:semicolon
r_int
id|order
comma
id|nPages
suffix:semicolon
r_if
c_cond
(paren
id|direction
op_eq
id|PCI_DMA_NONE
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|uaddr
op_assign
(paren
r_int
r_int
)paren
id|vaddr
suffix:semicolon
id|nPages
op_assign
id|PAGE_ALIGN
c_func
(paren
id|uaddr
op_plus
id|size
)paren
op_minus
(paren
id|uaddr
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
id|order
op_assign
id|get_order
c_func
(paren
id|nPages
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
id|nPages
op_rshift_assign
id|PAGE_SHIFT
suffix:semicolon
multiline_comment|/* Client asked for way to much space.  This is checked later anyway */
multiline_comment|/* It is easier to debug here for the drivers than in the tce tables.*/
r_if
c_cond
(paren
id|order
op_ge
id|NUM_TCE_LEVELS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;VIO_DMA: vio_map_single size to large: 0x%lx &bslash;n&quot;
comma
id|size
)paren
suffix:semicolon
r_return
id|NO_TCE
suffix:semicolon
)brace
id|tbl
op_assign
id|dev-&gt;tce_table
suffix:semicolon
r_if
c_cond
(paren
id|tbl
)paren
(brace
id|dma_handle
op_assign
id|get_tces
c_func
(paren
id|tbl
comma
id|order
comma
id|vaddr
comma
id|nPages
comma
id|direction
)paren
suffix:semicolon
id|dma_handle
op_or_assign
(paren
id|uaddr
op_amp
op_complement
id|PAGE_MASK
)paren
suffix:semicolon
)brace
r_return
id|dma_handle
suffix:semicolon
)brace
DECL|variable|vio_map_single
id|EXPORT_SYMBOL
c_func
(paren
id|vio_map_single
)paren
suffix:semicolon
DECL|function|vio_unmap_single
r_void
id|vio_unmap_single
c_func
(paren
r_struct
id|vio_dev
op_star
id|dev
comma
id|dma_addr_t
id|dma_handle
comma
r_int
id|size
comma
r_int
id|direction
)paren
(brace
r_struct
id|TceTable
op_star
id|tbl
suffix:semicolon
r_int
id|order
comma
id|nPages
suffix:semicolon
r_if
c_cond
(paren
id|direction
op_eq
id|PCI_DMA_NONE
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|nPages
op_assign
id|PAGE_ALIGN
c_func
(paren
id|dma_handle
op_plus
id|size
)paren
op_minus
(paren
id|dma_handle
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
id|order
op_assign
id|get_order
c_func
(paren
id|nPages
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
id|nPages
op_rshift_assign
id|PAGE_SHIFT
suffix:semicolon
multiline_comment|/* Client asked for way to much space.  This is checked later anyway */
multiline_comment|/* It is easier to debug here for the drivers than in the tce tables.*/
r_if
c_cond
(paren
id|order
op_ge
id|NUM_TCE_LEVELS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;VIO_DMA: vio_unmap_single 0x%lx size to large: 0x%lx &bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|dma_handle
comma
(paren
r_int
r_int
)paren
id|size
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tbl
op_assign
id|dev-&gt;tce_table
suffix:semicolon
r_if
c_cond
(paren
id|tbl
)paren
(brace
id|tce_free
c_func
(paren
id|tbl
comma
id|dma_handle
comma
id|order
comma
id|nPages
)paren
suffix:semicolon
)brace
)brace
DECL|variable|vio_unmap_single
id|EXPORT_SYMBOL
c_func
(paren
id|vio_unmap_single
)paren
suffix:semicolon
DECL|function|vio_map_sg
r_int
id|vio_map_sg
c_func
(paren
r_struct
id|vio_dev
op_star
id|vdev
comma
r_struct
id|scatterlist
op_star
id|sglist
comma
r_int
id|nelems
comma
r_int
id|direction
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nelems
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* 2.4 scsi scatterlists use address field.&n;&t;&t;   Not sure about other subsystems. */
r_void
op_star
id|vaddr
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt;= KERNEL_VERSION(2,5,0)
r_if
c_cond
(paren
id|sglist-&gt;address
)paren
id|vaddr
op_assign
id|sglist-&gt;address
suffix:semicolon
r_else
macro_line|#endif
id|vaddr
op_assign
id|page_address
c_func
(paren
id|sglist-&gt;page
)paren
op_plus
id|sglist-&gt;offset
suffix:semicolon
id|sglist-&gt;dma_address
op_assign
id|vio_map_single
c_func
(paren
id|vdev
comma
id|vaddr
comma
id|sglist-&gt;length
comma
id|direction
)paren
suffix:semicolon
id|sglist-&gt;dma_length
op_assign
id|sglist-&gt;length
suffix:semicolon
id|sglist
op_increment
suffix:semicolon
)brace
r_return
id|nelems
suffix:semicolon
)brace
DECL|variable|vio_map_sg
id|EXPORT_SYMBOL
c_func
(paren
id|vio_map_sg
)paren
suffix:semicolon
DECL|function|vio_unmap_sg
r_void
id|vio_unmap_sg
c_func
(paren
r_struct
id|vio_dev
op_star
id|vdev
comma
r_struct
id|scatterlist
op_star
id|sglist
comma
r_int
id|nelems
comma
r_int
id|direction
)paren
(brace
r_while
c_loop
(paren
id|nelems
op_decrement
)paren
(brace
id|vio_unmap_single
c_func
(paren
id|vdev
comma
id|sglist-&gt;dma_address
comma
id|sglist-&gt;dma_length
comma
id|direction
)paren
suffix:semicolon
id|sglist
op_increment
suffix:semicolon
)brace
)brace
DECL|function|vio_alloc_consistent
r_void
op_star
id|vio_alloc_consistent
c_func
(paren
r_struct
id|vio_dev
op_star
id|dev
comma
r_int
id|size
comma
id|dma_addr_t
op_star
id|dma_handle
)paren
(brace
r_struct
id|TceTable
op_star
id|tbl
suffix:semicolon
r_void
op_star
id|ret
op_assign
l_int|NULL
suffix:semicolon
r_int
id|order
comma
id|nPages
suffix:semicolon
id|dma_addr_t
id|tce
suffix:semicolon
id|size
op_assign
id|PAGE_ALIGN
c_func
(paren
id|size
)paren
suffix:semicolon
id|order
op_assign
id|get_order
c_func
(paren
id|size
)paren
suffix:semicolon
id|nPages
op_assign
l_int|1
op_lshift
id|order
suffix:semicolon
multiline_comment|/* Client asked for way to much space.  This is checked later anyway */
multiline_comment|/* It is easier to debug here for the drivers than in the tce tables.*/
r_if
c_cond
(paren
id|order
op_ge
id|NUM_TCE_LEVELS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;VIO_DMA: vio_alloc_consistent size to large: 0x%lx &bslash;n&quot;
comma
id|size
)paren
suffix:semicolon
r_return
(paren
r_void
op_star
)paren
id|NO_TCE
suffix:semicolon
)brace
id|tbl
op_assign
id|dev-&gt;tce_table
suffix:semicolon
r_if
c_cond
(paren
id|tbl
)paren
(brace
multiline_comment|/* Alloc enough pages (and possibly more) */
id|ret
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_ATOMIC
comma
id|order
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
multiline_comment|/* Page allocation succeeded */
id|memset
c_func
(paren
id|ret
comma
l_int|0
comma
id|nPages
op_lshift
id|PAGE_SHIFT
)paren
suffix:semicolon
multiline_comment|/* Set up tces to cover the allocated range */
id|tce
op_assign
id|get_tces
c_func
(paren
id|tbl
comma
id|order
comma
id|ret
comma
id|nPages
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tce
op_eq
id|NO_TCE
)paren
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_TCE
comma
l_string|&quot;vio_alloc_consistent: get_tces failed&bslash;n&quot;
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|ret
comma
id|order
)paren
suffix:semicolon
id|ret
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
op_star
id|dma_handle
op_assign
id|tce
suffix:semicolon
)brace
)brace
r_else
id|PPCDBG
c_func
(paren
id|PPCDBG_TCE
comma
l_string|&quot;vio_alloc_consistent: __get_free_pages failed for order = %d&bslash;n&quot;
comma
id|order
)paren
suffix:semicolon
)brace
r_else
id|PPCDBG
c_func
(paren
id|PPCDBG_TCE
comma
l_string|&quot;vio_alloc_consistent: get_tce_table failed for 0x%016lx&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_TCE
comma
l_string|&quot;&bslash;tvio_alloc_consistent: dma_handle = 0x%16.16lx&bslash;n&quot;
comma
op_star
id|dma_handle
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_TCE
comma
l_string|&quot;&bslash;tvio_alloc_consistent: return     = 0x%16.16lx&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|vio_alloc_consistent
id|EXPORT_SYMBOL
c_func
(paren
id|vio_alloc_consistent
)paren
suffix:semicolon
DECL|function|vio_free_consistent
r_void
id|vio_free_consistent
c_func
(paren
r_struct
id|vio_dev
op_star
id|dev
comma
r_int
id|size
comma
r_void
op_star
id|vaddr
comma
id|dma_addr_t
id|dma_handle
)paren
(brace
r_struct
id|TceTable
op_star
id|tbl
suffix:semicolon
r_int
id|order
comma
id|nPages
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_TCE
comma
l_string|&quot;vio_free_consistent:&bslash;n&quot;
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_TCE
comma
l_string|&quot;&bslash;tdev = 0x%16.16lx, size = 0x%16.16lx, dma_handle = 0x%16.16lx, vaddr = 0x%16.16lx&bslash;n&quot;
comma
id|dev
comma
id|size
comma
id|dma_handle
comma
id|vaddr
)paren
suffix:semicolon
id|size
op_assign
id|PAGE_ALIGN
c_func
(paren
id|size
)paren
suffix:semicolon
id|order
op_assign
id|get_order
c_func
(paren
id|size
)paren
suffix:semicolon
id|nPages
op_assign
l_int|1
op_lshift
id|order
suffix:semicolon
multiline_comment|/* Client asked for way to much space.  This is checked later anyway */
multiline_comment|/* It is easier to debug here for the drivers than in the tce tables.*/
r_if
c_cond
(paren
id|order
op_ge
id|NUM_TCE_LEVELS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI_DMA: pci_free_consistent size to large: 0x%lx &bslash;n&quot;
comma
id|size
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tbl
op_assign
id|dev-&gt;tce_table
suffix:semicolon
r_if
c_cond
(paren
id|tbl
)paren
(brace
id|tce_free
c_func
(paren
id|tbl
comma
id|dma_handle
comma
id|order
comma
id|nPages
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|vaddr
comma
id|order
)paren
suffix:semicolon
)brace
)brace
DECL|variable|vio_free_consistent
id|EXPORT_SYMBOL
c_func
(paren
id|vio_free_consistent
)paren
suffix:semicolon
DECL|variable|plpar_hcall_norets
id|EXPORT_SYMBOL
c_func
(paren
id|plpar_hcall_norets
)paren
suffix:semicolon
DECL|variable|plpar_hcall_8arg_2ret
id|EXPORT_SYMBOL
c_func
(paren
id|plpar_hcall_8arg_2ret
)paren
suffix:semicolon
eof
