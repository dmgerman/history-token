multiline_comment|/*&n; * arch/ppc64/kernel/pci_iommu.c&n; * Copyright (C) 2001 Mike Corrigan &amp; Dave Engebretsen, IBM Corporation&n; * &n; * Rewrite, cleanup, new allocation schemes: &n; * Copyright (C) 2004 Olof Johansson, IBM Corporation&n; *&n; * Dynamic DMA mapping support, platform-independent parts.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; * &n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; * &n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/iommu.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &quot;pci.h&quot;
macro_line|#ifdef CONFIG_PPC_ISERIES
macro_line|#include &lt;asm/iSeries/iSeries_pci.h&gt;
macro_line|#endif /* CONFIG_PPC_ISERIES */
multiline_comment|/*&n; * We can use -&gt;sysdata directly and avoid the extra work in&n; * pci_device_to_OF_node since -&gt;sysdata will have been initialised&n; * in the iommu init code for all devices.&n; */
DECL|macro|PCI_GET_DN
mdefine_line|#define PCI_GET_DN(dev) ((struct device_node *)((dev)-&gt;sysdata))
DECL|function|devnode_table
r_static
r_inline
r_struct
id|iommu_table
op_star
id|devnode_table
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
id|dev
op_assign
id|ppc64_isabridge_dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
l_int|NULL
suffix:semicolon
macro_line|#ifdef CONFIG_PPC_ISERIES
r_return
id|ISERIES_DEVNODE
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
id|iommu_table
suffix:semicolon
macro_line|#endif /* CONFIG_PPC_ISERIES */
macro_line|#ifdef CONFIG_PPC_MULTIPLATFORM
r_return
id|PCI_GET_DN
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
id|iommu_table
suffix:semicolon
macro_line|#endif /* CONFIG_PPC_MULTIPLATFORM */
)brace
multiline_comment|/* Allocates a contiguous real buffer and creates mappings over it.&n; * Returns the virtual address of the buffer and sets dma_handle&n; * to the dma address (mapping) of the first page.&n; */
DECL|function|pci_iommu_alloc_consistent
r_static
r_void
op_star
id|pci_iommu_alloc_consistent
c_func
(paren
r_struct
id|pci_dev
op_star
id|hwdev
comma
r_int
id|size
comma
id|dma_addr_t
op_star
id|dma_handle
)paren
(brace
r_return
id|iommu_alloc_consistent
c_func
(paren
id|devnode_table
c_func
(paren
id|hwdev
)paren
comma
id|size
comma
id|dma_handle
)paren
suffix:semicolon
)brace
DECL|function|pci_iommu_free_consistent
r_static
r_void
id|pci_iommu_free_consistent
c_func
(paren
r_struct
id|pci_dev
op_star
id|hwdev
comma
r_int
id|size
comma
r_void
op_star
id|vaddr
comma
id|dma_addr_t
id|dma_handle
)paren
(brace
id|iommu_free_consistent
c_func
(paren
id|devnode_table
c_func
(paren
id|hwdev
)paren
comma
id|size
comma
id|vaddr
comma
id|dma_handle
)paren
suffix:semicolon
)brace
multiline_comment|/* Creates TCEs for a user provided buffer.  The user buffer must be &n; * contiguous real kernel storage (not vmalloc).  The address of the buffer&n; * passed here is the kernel (virtual) address of the buffer.  The buffer&n; * need not be page aligned, the dma_addr_t returned will point to the same&n; * byte within the page as vaddr.&n; */
DECL|function|pci_iommu_map_single
r_static
id|dma_addr_t
id|pci_iommu_map_single
c_func
(paren
r_struct
id|pci_dev
op_star
id|hwdev
comma
r_void
op_star
id|vaddr
comma
r_int
id|size
comma
r_enum
id|dma_data_direction
id|direction
)paren
(brace
r_return
id|iommu_map_single
c_func
(paren
id|devnode_table
c_func
(paren
id|hwdev
)paren
comma
id|vaddr
comma
id|size
comma
id|direction
)paren
suffix:semicolon
)brace
DECL|function|pci_iommu_unmap_single
r_static
r_void
id|pci_iommu_unmap_single
c_func
(paren
r_struct
id|pci_dev
op_star
id|hwdev
comma
id|dma_addr_t
id|dma_handle
comma
r_int
id|size
comma
r_enum
id|dma_data_direction
id|direction
)paren
(brace
id|iommu_unmap_single
c_func
(paren
id|devnode_table
c_func
(paren
id|hwdev
)paren
comma
id|dma_handle
comma
id|size
comma
id|direction
)paren
suffix:semicolon
)brace
DECL|function|pci_iommu_map_sg
r_static
r_int
id|pci_iommu_map_sg
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_struct
id|scatterlist
op_star
id|sglist
comma
r_int
id|nelems
comma
r_enum
id|dma_data_direction
id|direction
)paren
(brace
r_return
id|iommu_map_sg
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
id|devnode_table
c_func
(paren
id|pdev
)paren
comma
id|sglist
comma
id|nelems
comma
id|direction
)paren
suffix:semicolon
)brace
DECL|function|pci_iommu_unmap_sg
r_static
r_void
id|pci_iommu_unmap_sg
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_struct
id|scatterlist
op_star
id|sglist
comma
r_int
id|nelems
comma
r_enum
id|dma_data_direction
id|direction
)paren
(brace
id|iommu_unmap_sg
c_func
(paren
id|devnode_table
c_func
(paren
id|pdev
)paren
comma
id|sglist
comma
id|nelems
comma
id|direction
)paren
suffix:semicolon
)brace
multiline_comment|/* We support DMA to/from any memory page via the iommu */
DECL|function|pci_iommu_dma_supported
r_static
r_int
id|pci_iommu_dma_supported
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u64
id|mask
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|pci_iommu_init
r_void
id|pci_iommu_init
c_func
(paren
r_void
)paren
(brace
id|pci_dma_ops.pci_alloc_consistent
op_assign
id|pci_iommu_alloc_consistent
suffix:semicolon
id|pci_dma_ops.pci_free_consistent
op_assign
id|pci_iommu_free_consistent
suffix:semicolon
id|pci_dma_ops.pci_map_single
op_assign
id|pci_iommu_map_single
suffix:semicolon
id|pci_dma_ops.pci_unmap_single
op_assign
id|pci_iommu_unmap_single
suffix:semicolon
id|pci_dma_ops.pci_map_sg
op_assign
id|pci_iommu_map_sg
suffix:semicolon
id|pci_dma_ops.pci_unmap_sg
op_assign
id|pci_iommu_unmap_sg
suffix:semicolon
id|pci_dma_ops.pci_dma_supported
op_assign
id|pci_iommu_dma_supported
suffix:semicolon
)brace
eof
