multiline_comment|/*&n; * pSeries_pci.c&n; *&n; * Copyright (C) 2001 Dave Engebretsen, IBM Corporation&n; *&n; * pSeries specific routines for PCI.&n; * &n; * Based on code from pci.c and chrp_pci.c&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *    &n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; * &n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/threads.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#include &lt;asm/ppcdebug.h&gt;
macro_line|#include &lt;asm/naca.h&gt;
macro_line|#include &lt;asm/pci_dma.h&gt;
macro_line|#include &quot;open_pic.h&quot;
macro_line|#include &quot;pci.h&quot;
multiline_comment|/* RTAS tokens */
DECL|variable|read_pci_config
r_static
r_int
id|read_pci_config
suffix:semicolon
DECL|variable|write_pci_config
r_static
r_int
id|write_pci_config
suffix:semicolon
DECL|variable|ibm_read_pci_config
r_static
r_int
id|ibm_read_pci_config
suffix:semicolon
DECL|variable|ibm_write_pci_config
r_static
r_int
id|ibm_write_pci_config
suffix:semicolon
DECL|variable|s7a_workaround
r_static
r_int
id|s7a_workaround
suffix:semicolon
DECL|function|rtas_read_config
r_static
r_int
id|rtas_read_config
c_func
(paren
r_struct
id|device_node
op_star
id|dn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
op_star
id|val
)paren
(brace
r_int
r_int
id|returnval
op_assign
op_complement
l_int|0L
suffix:semicolon
r_int
r_int
id|buid
comma
id|addr
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dn
)paren
r_return
op_minus
l_int|2
suffix:semicolon
id|addr
op_assign
(paren
id|dn-&gt;busno
op_lshift
l_int|16
)paren
op_or
(paren
id|dn-&gt;devfn
op_lshift
l_int|8
)paren
op_or
id|where
suffix:semicolon
id|buid
op_assign
id|dn-&gt;phb-&gt;buid
suffix:semicolon
r_if
c_cond
(paren
id|buid
)paren
(brace
id|ret
op_assign
id|rtas_call
c_func
(paren
id|ibm_read_pci_config
comma
l_int|4
comma
l_int|2
comma
op_amp
id|returnval
comma
id|addr
comma
id|buid
op_rshift
l_int|32
comma
id|buid
op_amp
l_int|0xffffffff
comma
id|size
)paren
suffix:semicolon
)brace
r_else
(brace
id|ret
op_assign
id|rtas_call
c_func
(paren
id|read_pci_config
comma
l_int|2
comma
l_int|2
comma
op_amp
id|returnval
comma
id|addr
comma
id|size
)paren
suffix:semicolon
)brace
op_star
id|val
op_assign
id|returnval
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|rtas_pci_read_config
r_static
r_int
id|rtas_pci_read_config
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
op_star
id|val
)paren
(brace
r_struct
id|device_node
op_star
id|busdn
comma
op_star
id|dn
suffix:semicolon
r_if
c_cond
(paren
id|bus-&gt;self
)paren
id|busdn
op_assign
id|pci_device_to_OF_node
c_func
(paren
id|bus-&gt;self
)paren
suffix:semicolon
r_else
id|busdn
op_assign
id|bus-&gt;sysdata
suffix:semicolon
multiline_comment|/* must be a phb */
multiline_comment|/* Search only direct children of the bus */
r_for
c_loop
(paren
id|dn
op_assign
id|busdn-&gt;child
suffix:semicolon
id|dn
suffix:semicolon
id|dn
op_assign
id|dn-&gt;sibling
)paren
r_if
c_cond
(paren
id|dn-&gt;devfn
op_eq
id|devfn
)paren
r_return
id|rtas_read_config
c_func
(paren
id|dn
comma
id|where
comma
id|size
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
)brace
DECL|function|rtas_write_config
r_static
r_int
id|rtas_write_config
c_func
(paren
r_struct
id|device_node
op_star
id|dn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
id|val
)paren
(brace
r_int
r_int
id|buid
comma
id|addr
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dn
)paren
r_return
op_minus
l_int|2
suffix:semicolon
id|addr
op_assign
(paren
id|dn-&gt;busno
op_lshift
l_int|16
)paren
op_or
(paren
id|dn-&gt;devfn
op_lshift
l_int|8
)paren
op_or
id|where
suffix:semicolon
id|buid
op_assign
id|dn-&gt;phb-&gt;buid
suffix:semicolon
r_if
c_cond
(paren
id|buid
)paren
(brace
id|ret
op_assign
id|rtas_call
c_func
(paren
id|ibm_write_pci_config
comma
l_int|5
comma
l_int|1
comma
l_int|NULL
comma
id|addr
comma
id|buid
op_rshift
l_int|32
comma
id|buid
op_amp
l_int|0xffffffff
comma
id|size
comma
(paren
id|ulong
)paren
id|val
)paren
suffix:semicolon
)brace
r_else
(brace
id|ret
op_assign
id|rtas_call
c_func
(paren
id|write_pci_config
comma
l_int|3
comma
l_int|1
comma
l_int|NULL
comma
id|addr
comma
id|size
comma
(paren
id|ulong
)paren
id|val
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|rtas_pci_write_config
r_static
r_int
id|rtas_pci_write_config
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
id|val
)paren
(brace
r_struct
id|device_node
op_star
id|busdn
comma
op_star
id|dn
suffix:semicolon
r_if
c_cond
(paren
id|bus-&gt;self
)paren
id|busdn
op_assign
id|pci_device_to_OF_node
c_func
(paren
id|bus-&gt;self
)paren
suffix:semicolon
r_else
id|busdn
op_assign
id|bus-&gt;sysdata
suffix:semicolon
multiline_comment|/* must be a phb */
multiline_comment|/* Search only direct children of the bus */
r_for
c_loop
(paren
id|dn
op_assign
id|busdn-&gt;child
suffix:semicolon
id|dn
suffix:semicolon
id|dn
op_assign
id|dn-&gt;sibling
)paren
r_if
c_cond
(paren
id|dn-&gt;devfn
op_eq
id|devfn
)paren
r_return
id|rtas_write_config
c_func
(paren
id|dn
comma
id|where
comma
id|size
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
)brace
DECL|variable|rtas_pci_ops
r_struct
id|pci_ops
id|rtas_pci_ops
op_assign
(brace
id|rtas_pci_read_config
comma
id|rtas_pci_write_config
)brace
suffix:semicolon
multiline_comment|/******************************************************************&n; * pci_read_irq_line&n; *&n; * Reads the Interrupt Pin to determine if interrupt is use by card.&n; * If the interrupt is used, then gets the interrupt line from the &n; * openfirmware and sets it in the pci_dev and pci_config line.&n; *&n; ******************************************************************/
DECL|function|pci_read_irq_line
r_int
id|pci_read_irq_line
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
)paren
(brace
id|u8
id|intpin
suffix:semicolon
r_struct
id|device_node
op_star
id|node
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pci_dev
comma
id|PCI_INTERRUPT_PIN
comma
op_amp
id|intpin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intpin
op_eq
l_int|0
)paren
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;&bslash;tDevice: %s No Interrupt used by device.&bslash;n&quot;
comma
id|pci_dev-&gt;slot_name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|node
op_assign
id|pci_device_to_OF_node
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|node
op_eq
l_int|NULL
)paren
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;&bslash;tDevice: %s Device Node not found.&bslash;n&quot;
comma
id|pci_dev-&gt;slot_name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|node-&gt;n_intrs
op_eq
l_int|0
)paren
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;&bslash;tDevice: %s No Device OF interrupts defined.&bslash;n&quot;
comma
id|pci_dev-&gt;slot_name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|pci_dev-&gt;irq
op_assign
id|node-&gt;intrs
(braket
l_int|0
)braket
dot
id|line
suffix:semicolon
r_if
c_cond
(paren
id|s7a_workaround
)paren
(brace
r_if
c_cond
(paren
id|pci_dev-&gt;irq
OG
l_int|16
)paren
id|pci_dev-&gt;irq
op_sub_assign
l_int|3
suffix:semicolon
)brace
id|pci_write_config_byte
c_func
(paren
id|pci_dev
comma
id|PCI_INTERRUPT_LINE
comma
id|pci_dev-&gt;irq
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;&bslash;tDevice: %s pci_dev-&gt;irq = 0x%02X&bslash;n&quot;
comma
id|pci_dev-&gt;slot_name
comma
id|pci_dev-&gt;irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pci_process_bridge_OF_ranges
r_static
r_void
id|__init
id|pci_process_bridge_OF_ranges
c_func
(paren
r_struct
id|pci_controller
op_star
id|hose
comma
r_struct
id|device_node
op_star
id|dev
comma
r_int
id|primary
)paren
(brace
r_int
r_int
op_star
id|ranges
suffix:semicolon
r_int
r_int
id|size
suffix:semicolon
r_int
id|rlen
op_assign
l_int|0
suffix:semicolon
r_int
id|memno
op_assign
l_int|0
suffix:semicolon
r_struct
id|resource
op_star
id|res
suffix:semicolon
r_int
id|np
comma
id|na
op_assign
id|prom_n_addr_cells
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|pci_addr
comma
id|cpu_phys_addr
suffix:semicolon
id|np
op_assign
id|na
op_plus
l_int|5
suffix:semicolon
multiline_comment|/*&n;&t; * The ranges property is laid out as an array of elements,&n;&t; * each of which comprises:&n;&t; *   cells 0 - 2:&t;a PCI address&n;&t; *   cells 3 or 3+4:&t;a CPU physical address&n;&t; *&t;&t;&t;(size depending on dev-&gt;n_addr_cells)&n;&t; *   cells 4+5 or 5+6:&t;the size of the range&n;&t; */
id|rlen
op_assign
l_int|0
suffix:semicolon
id|hose-&gt;io_base_phys
op_assign
l_int|0
suffix:semicolon
id|ranges
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_property
c_func
(paren
id|dev
comma
l_string|&quot;ranges&quot;
comma
op_amp
id|rlen
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|rlen
op_sub_assign
id|np
op_star
r_sizeof
(paren
r_int
r_int
)paren
)paren
op_ge
l_int|0
)paren
(brace
id|res
op_assign
l_int|NULL
suffix:semicolon
id|pci_addr
op_assign
(paren
r_int
r_int
)paren
id|ranges
(braket
l_int|1
)braket
op_lshift
l_int|32
op_or
id|ranges
(braket
l_int|2
)braket
suffix:semicolon
id|cpu_phys_addr
op_assign
id|ranges
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|na
op_eq
l_int|2
)paren
id|cpu_phys_addr
op_assign
id|cpu_phys_addr
op_lshift
l_int|32
op_or
id|ranges
(braket
l_int|4
)braket
suffix:semicolon
id|size
op_assign
(paren
r_int
r_int
)paren
id|ranges
(braket
id|na
op_plus
l_int|3
)braket
op_lshift
l_int|32
op_or
id|ranges
(braket
id|na
op_plus
l_int|4
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|ranges
(braket
l_int|0
)braket
op_rshift
l_int|24
)paren
(brace
r_case
l_int|1
suffix:colon
multiline_comment|/* I/O space */
id|hose-&gt;io_base_phys
op_assign
id|cpu_phys_addr
suffix:semicolon
id|hose-&gt;io_base_virt
op_assign
id|__ioremap
c_func
(paren
id|hose-&gt;io_base_phys
comma
id|size
comma
id|_PAGE_NO_CACHE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|primary
)paren
(brace
id|pci_io_base
op_assign
(paren
r_int
r_int
)paren
id|hose-&gt;io_base_virt
suffix:semicolon
r_if
c_cond
(paren
id|find_type_devices
c_func
(paren
l_string|&quot;isa&quot;
)paren
)paren
id|isa_io_base
op_assign
id|pci_io_base
suffix:semicolon
)brace
id|res
op_assign
op_amp
id|hose-&gt;io_resource
suffix:semicolon
id|res-&gt;flags
op_assign
id|IORESOURCE_IO
suffix:semicolon
id|res-&gt;start
op_assign
id|pci_addr
suffix:semicolon
id|res-&gt;start
op_add_assign
(paren
r_int
r_int
)paren
id|hose-&gt;io_base_virt
op_minus
id|pci_io_base
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* memory space */
id|memno
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|memno
OL
l_int|3
op_logical_and
id|hose-&gt;mem_resources
(braket
id|memno
)braket
dot
id|flags
)paren
op_increment
id|memno
suffix:semicolon
r_if
c_cond
(paren
id|memno
op_eq
l_int|0
)paren
id|hose-&gt;pci_mem_offset
op_assign
id|cpu_phys_addr
op_minus
id|pci_addr
suffix:semicolon
r_if
c_cond
(paren
id|memno
OL
l_int|3
)paren
(brace
id|res
op_assign
op_amp
id|hose-&gt;mem_resources
(braket
id|memno
)braket
suffix:semicolon
id|res-&gt;flags
op_assign
id|IORESOURCE_MEM
suffix:semicolon
id|res-&gt;start
op_assign
id|cpu_phys_addr
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|res
op_ne
l_int|NULL
)paren
(brace
id|res-&gt;name
op_assign
id|dev-&gt;full_name
suffix:semicolon
id|res-&gt;end
op_assign
id|res-&gt;start
op_plus
id|size
op_minus
l_int|1
suffix:semicolon
id|res-&gt;parent
op_assign
l_int|NULL
suffix:semicolon
id|res-&gt;sibling
op_assign
l_int|NULL
suffix:semicolon
id|res-&gt;child
op_assign
l_int|NULL
suffix:semicolon
)brace
id|ranges
op_add_assign
id|np
suffix:semicolon
)brace
)brace
DECL|function|python_countermeasures
r_static
r_void
id|python_countermeasures
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_void
op_star
id|chip_regs
suffix:semicolon
r_volatile
id|u32
op_star
id|tmp
comma
id|i
suffix:semicolon
multiline_comment|/* Python&squot;s register file is 1 MB in size. */
id|chip_regs
op_assign
id|ioremap
c_func
(paren
id|addr
op_amp
op_complement
(paren
l_int|0xfffffUL
)paren
comma
l_int|0x100000
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Firmware doesn&squot;t always clear this bit which is critical&n;&t; * for good performance - Anton&n;&t; */
DECL|macro|PRG_CL_RESET_VALID
mdefine_line|#define PRG_CL_RESET_VALID 0x00010000
id|tmp
op_assign
(paren
id|u32
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|chip_regs
op_plus
l_int|0xf6030
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|tmp
op_amp
id|PRG_CL_RESET_VALID
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Python workaround: &quot;
)paren
suffix:semicolon
op_star
id|tmp
op_and_assign
op_complement
id|PRG_CL_RESET_VALID
suffix:semicolon
multiline_comment|/*&n;&t;&t; * We must read it back for changes to&n;&t;&t; * take effect&n;&t;&t; */
id|i
op_assign
op_star
id|tmp
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;reg0: %x&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
id|iounmap
c_func
(paren
id|chip_regs
)paren
suffix:semicolon
)brace
DECL|function|alloc_phb
r_struct
id|pci_controller
op_star
id|alloc_phb
c_func
(paren
r_struct
id|device_node
op_star
id|dev
comma
r_int
r_int
id|addr_size_words
)paren
(brace
r_struct
id|pci_controller
op_star
id|phb
suffix:semicolon
r_int
r_int
op_star
id|ui_ptr
op_assign
l_int|NULL
comma
id|len
suffix:semicolon
r_struct
id|reg_property64
id|reg_struct
suffix:semicolon
r_int
op_star
id|bus_range
suffix:semicolon
r_int
op_star
id|buid_vals
suffix:semicolon
r_char
op_star
id|model
suffix:semicolon
r_enum
id|phb_types
id|phb_type
suffix:semicolon
id|model
op_assign
(paren
r_char
op_star
)paren
id|get_property
c_func
(paren
id|dev
comma
l_string|&quot;model&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|model
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;alloc_phb: phb has no model property&bslash;n&quot;
)paren
suffix:semicolon
id|model
op_assign
l_string|&quot;&lt;empty&gt;&quot;
suffix:semicolon
)brace
multiline_comment|/* Found a PHB, now figure out where his registers are mapped. */
id|ui_ptr
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_property
c_func
(paren
id|dev
comma
l_string|&quot;reg&quot;
comma
op_amp
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ui_ptr
op_eq
l_int|NULL
)paren
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tget reg failed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|addr_size_words
op_eq
l_int|1
)paren
(brace
id|reg_struct.address
op_assign
(paren
(paren
r_struct
id|reg_property32
op_star
)paren
id|ui_ptr
)paren
op_member_access_from_pointer
id|address
suffix:semicolon
id|reg_struct.size
op_assign
(paren
(paren
r_struct
id|reg_property32
op_star
)paren
id|ui_ptr
)paren
op_member_access_from_pointer
id|size
suffix:semicolon
)brace
r_else
(brace
id|reg_struct
op_assign
op_star
(paren
(paren
r_struct
id|reg_property64
op_star
)paren
id|ui_ptr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strstr
c_func
(paren
id|model
comma
l_string|&quot;Python&quot;
)paren
)paren
(brace
id|phb_type
op_assign
id|phb_type_python
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strstr
c_func
(paren
id|model
comma
l_string|&quot;Speedwagon&quot;
)paren
)paren
(brace
id|phb_type
op_assign
id|phb_type_speedwagon
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strstr
c_func
(paren
id|model
comma
l_string|&quot;Winnipeg&quot;
)paren
)paren
(brace
id|phb_type
op_assign
id|phb_type_winnipeg
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;alloc_phb: unknown PHB %s&bslash;n&quot;
comma
id|model
)paren
suffix:semicolon
id|phb_type
op_assign
id|phb_type_unknown
suffix:semicolon
)brace
id|phb
op_assign
id|pci_alloc_pci_controller
c_func
(paren
id|phb_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|phb
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|phb_type
op_eq
id|phb_type_python
)paren
id|python_countermeasures
c_func
(paren
id|reg_struct.address
)paren
suffix:semicolon
id|bus_range
op_assign
(paren
r_int
op_star
)paren
id|get_property
c_func
(paren
id|dev
comma
l_string|&quot;bus-range&quot;
comma
op_amp
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bus_range
op_eq
l_int|NULL
op_logical_or
id|len
OL
l_int|2
op_star
r_sizeof
(paren
r_int
)paren
)paren
(brace
id|kfree
c_func
(paren
id|phb
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|phb-&gt;first_busno
op_assign
id|bus_range
(braket
l_int|0
)braket
suffix:semicolon
id|phb-&gt;last_busno
op_assign
id|bus_range
(braket
l_int|1
)braket
suffix:semicolon
id|phb-&gt;arch_data
op_assign
id|dev
suffix:semicolon
id|phb-&gt;ops
op_assign
op_amp
id|rtas_pci_ops
suffix:semicolon
id|buid_vals
op_assign
(paren
r_int
op_star
)paren
id|get_property
c_func
(paren
id|dev
comma
l_string|&quot;ibm,fw-phb-id&quot;
comma
op_amp
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buid_vals
op_eq
l_int|NULL
)paren
(brace
id|phb-&gt;buid
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_struct
id|pci_bus
id|check
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
id|check.number
)paren
op_eq
l_int|1
op_logical_or
r_sizeof
(paren
id|check.primary
)paren
op_eq
l_int|1
op_logical_or
r_sizeof
(paren
id|check.secondary
)paren
op_eq
l_int|1
op_logical_or
r_sizeof
(paren
id|check.subordinate
)paren
op_eq
l_int|1
)paren
(brace
id|udbg_printf
c_func
(paren
l_string|&quot;pSeries_pci:  this system has large bus numbers and the kernel was not&bslash;n&quot;
l_string|&quot;built with the patch that fixes include/linux/pci.h struct pci_bus so&bslash;n&quot;
l_string|&quot;number, primary, secondary and subordinate are ints.&bslash;n&quot;
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;pSeries_pci:  this system has large bus numbers and the kernel was not&bslash;n&quot;
l_string|&quot;built with the patch that fixes include/linux/pci.h struct pci_bus so&bslash;n&quot;
l_string|&quot;number, primary, secondary and subordinate are ints.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OL
l_int|2
op_star
r_sizeof
(paren
r_int
)paren
)paren
singleline_comment|// Support for new OF that only has 1 integer for buid.
id|phb-&gt;buid
op_assign
(paren
r_int
r_int
)paren
id|buid_vals
(braket
l_int|0
)braket
suffix:semicolon
r_else
id|phb-&gt;buid
op_assign
(paren
(paren
(paren
r_int
r_int
)paren
id|buid_vals
(braket
l_int|0
)braket
)paren
op_lshift
l_int|32UL
)paren
op_or
(paren
(paren
(paren
r_int
r_int
)paren
id|buid_vals
(braket
l_int|1
)braket
)paren
op_amp
l_int|0xffffffff
)paren
suffix:semicolon
id|phb-&gt;first_busno
op_add_assign
(paren
id|phb-&gt;global_number
op_lshift
l_int|8
)paren
suffix:semicolon
id|phb-&gt;last_busno
op_add_assign
(paren
id|phb-&gt;global_number
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
multiline_comment|/* Dump PHB information for Debug */
id|PPCDBGCALL
c_func
(paren
id|PPCDBG_PHBINIT
comma
id|dumpPci_Controller
c_func
(paren
id|phb
)paren
)paren
suffix:semicolon
r_return
id|phb
suffix:semicolon
)brace
DECL|function|find_and_init_phbs
r_int
r_int
id|__init
id|find_and_init_phbs
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|node
suffix:semicolon
r_struct
id|pci_controller
op_star
id|phb
suffix:semicolon
r_int
r_int
id|root_size_cells
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|index
suffix:semicolon
r_int
r_int
op_star
id|opprop
suffix:semicolon
r_struct
id|device_node
op_star
id|root
op_assign
id|find_path_device
c_func
(paren
l_string|&quot;/&quot;
)paren
suffix:semicolon
id|read_pci_config
op_assign
id|rtas_token
c_func
(paren
l_string|&quot;read-pci-config&quot;
)paren
suffix:semicolon
id|write_pci_config
op_assign
id|rtas_token
c_func
(paren
l_string|&quot;write-pci-config&quot;
)paren
suffix:semicolon
id|ibm_read_pci_config
op_assign
id|rtas_token
c_func
(paren
l_string|&quot;ibm,read-pci-config&quot;
)paren
suffix:semicolon
id|ibm_write_pci_config
op_assign
id|rtas_token
c_func
(paren
l_string|&quot;ibm,write-pci-config&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|naca-&gt;interrupt_controller
op_eq
id|IC_OPEN_PIC
)paren
(brace
id|opprop
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_property
c_func
(paren
id|root
comma
l_string|&quot;platform-open-pic&quot;
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|root_size_cells
op_assign
id|prom_n_size_cells
c_func
(paren
id|root
)paren
suffix:semicolon
id|index
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|node
op_assign
id|root-&gt;child
suffix:semicolon
id|node
op_ne
l_int|NULL
suffix:semicolon
id|node
op_assign
id|node-&gt;sibling
)paren
(brace
r_if
c_cond
(paren
id|node-&gt;type
op_eq
l_int|NULL
op_logical_or
id|strcmp
c_func
(paren
id|node-&gt;type
comma
l_string|&quot;pci&quot;
)paren
op_ne
l_int|0
)paren
r_continue
suffix:semicolon
id|phb
op_assign
id|alloc_phb
c_func
(paren
id|node
comma
id|root_size_cells
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|phb
)paren
r_continue
suffix:semicolon
id|pci_process_bridge_OF_ranges
c_func
(paren
id|phb
comma
id|node
comma
id|index
op_eq
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|naca-&gt;interrupt_controller
op_eq
id|IC_OPEN_PIC
)paren
(brace
r_int
id|addr
op_assign
id|root_size_cells
op_star
(paren
id|index
op_plus
l_int|2
)paren
op_minus
l_int|1
suffix:semicolon
id|openpic_setup_ISU
c_func
(paren
id|index
comma
id|opprop
(braket
id|addr
)braket
)paren
suffix:semicolon
)brace
id|index
op_increment
suffix:semicolon
)brace
id|pci_devs_phb_init
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|fixup_resources
id|fixup_resources
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|pci_controller
op_star
id|phb
op_assign
id|PCI_GET_PHB_PTR
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|device_node
op_star
id|dn
suffix:semicolon
multiline_comment|/* Add IBM loc code (slot) as a prefix to the device names for service */
id|dn
op_assign
id|pci_device_to_OF_node
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dn
)paren
(brace
r_char
op_star
id|loc_code
op_assign
id|get_property
c_func
(paren
id|dn
comma
l_string|&quot;ibm,loc-code&quot;
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|loc_code
)paren
(brace
r_int
id|loc_len
op_assign
id|strlen
c_func
(paren
id|loc_code
)paren
suffix:semicolon
r_if
c_cond
(paren
id|loc_len
OL
r_sizeof
(paren
id|dev-&gt;dev.name
)paren
)paren
(brace
id|memmove
c_func
(paren
id|dev-&gt;dev.name
op_plus
id|loc_len
op_plus
l_int|1
comma
id|dev-&gt;dev.name
comma
r_sizeof
(paren
id|dev-&gt;dev.name
)paren
op_minus
id|loc_len
op_minus
l_int|1
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;dev.name
comma
id|loc_code
comma
id|loc_len
)paren
suffix:semicolon
id|dev-&gt;dev.name
(braket
id|loc_len
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
id|dev-&gt;dev.name
(braket
r_sizeof
(paren
id|dev-&gt;dev.name
)paren
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
)brace
)brace
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;fixup_resources:&bslash;n&quot;
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tphb                 = 0x%016LX&bslash;n&quot;
comma
id|phb
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tphb-&gt;pci_io_offset  = 0x%016LX&bslash;n&quot;
comma
id|phb-&gt;pci_io_offset
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tphb-&gt;pci_mem_offset = 0x%016LX&bslash;n&quot;
comma
id|phb-&gt;pci_mem_offset
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tdev-&gt;dev.name   = %s&bslash;n&quot;
comma
id|dev-&gt;dev.name
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tdev-&gt;vendor:device = 0x%04X : 0x%04X&bslash;n&quot;
comma
id|dev-&gt;vendor
comma
id|dev-&gt;device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|phb
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEVICE_COUNT_RESOURCE
suffix:semicolon
op_increment
id|i
)paren
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tdevice %x.%x[%d] (flags %x) [%lx..%lx]&bslash;n&quot;
comma
id|dev-&gt;bus-&gt;number
comma
id|dev-&gt;devfn
comma
id|i
comma
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|flags
comma
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
comma
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_eq
l_int|0
)paren
op_logical_and
(paren
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
op_eq
l_int|0
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
OG
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
)paren
(brace
multiline_comment|/* Bogus resource.  Just clear it out. */
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_assign
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|flags
op_amp
id|IORESOURCE_IO
)paren
(brace
r_int
r_int
id|offset
op_assign
(paren
r_int
r_int
)paren
id|phb-&gt;io_base_virt
op_minus
id|pci_io_base
suffix:semicolon
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_add_assign
id|offset
suffix:semicolon
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
op_add_assign
id|offset
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;t&bslash;t-&gt; now [%lx .. %lx]&bslash;n&quot;
comma
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
comma
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|flags
op_amp
id|IORESOURCE_MEM
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Bogus.  Probably an unused bridge. */
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_add_assign
id|phb-&gt;pci_mem_offset
suffix:semicolon
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
op_add_assign
id|phb-&gt;pci_mem_offset
suffix:semicolon
)brace
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;t&bslash;t-&gt; now [%lx..%lx]&bslash;n&quot;
comma
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
comma
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
)paren
suffix:semicolon
)brace
r_else
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* zap the 2nd function of the winbond chip */
r_if
c_cond
(paren
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|flags
op_amp
id|IORESOURCE_IO
op_logical_and
id|dev-&gt;bus-&gt;number
op_eq
l_int|0
op_logical_and
id|dev-&gt;devfn
op_eq
l_int|0x81
)paren
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|flags
op_and_assign
op_complement
id|IORESOURCE_IO
suffix:semicolon
)brace
)brace
DECL|function|check_s7a
r_static
r_void
id|check_s7a
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|root
suffix:semicolon
r_char
op_star
id|model
suffix:semicolon
id|root
op_assign
id|find_path_device
c_func
(paren
l_string|&quot;/&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|root
)paren
(brace
id|model
op_assign
id|get_property
c_func
(paren
id|root
comma
l_string|&quot;model&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|model
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
id|model
comma
l_string|&quot;IBM,7013-S7A&quot;
)paren
)paren
id|s7a_workaround
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_void
id|__init
DECL|function|pSeries_pcibios_fixup
id|pSeries_pcibios_fixup
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;pSeries_pcibios_fixup: start&bslash;n&quot;
)paren
suffix:semicolon
id|check_s7a
c_func
(paren
)paren
suffix:semicolon
id|pci_for_each_dev
c_func
(paren
id|dev
)paren
(brace
id|pci_read_irq_line
c_func
(paren
id|dev
)paren
suffix:semicolon
id|PPCDBGCALL
c_func
(paren
id|PPCDBG_PHBINIT
comma
id|dumpPci_Dev
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*********************************************************************** &n; * pci_find_hose_for_OF_device&n; *&n; * This function finds the PHB that matching device_node in the &n; * OpenFirmware by scanning all the pci_controllers.&n; * &n; ***********************************************************************/
r_struct
id|pci_controller
op_star
DECL|function|pci_find_hose_for_OF_device
id|pci_find_hose_for_OF_device
c_func
(paren
r_struct
id|device_node
op_star
id|node
)paren
(brace
r_while
c_loop
(paren
id|node
)paren
(brace
r_struct
id|pci_controller
op_star
id|hose
suffix:semicolon
r_for
c_loop
(paren
id|hose
op_assign
id|hose_head
suffix:semicolon
id|hose
suffix:semicolon
id|hose
op_assign
id|hose-&gt;next
)paren
r_if
c_cond
(paren
id|hose-&gt;arch_data
op_eq
id|node
)paren
r_return
id|hose
suffix:semicolon
id|node
op_assign
id|node-&gt;parent
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*********************************************************************** &n; * ppc64_pcibios_init&n; *  &n; * Chance to initialize and structures or variable before PCI Bus walk.&n; *  &n; ***********************************************************************/
r_void
DECL|function|pSeries_pcibios_init
id|pSeries_pcibios_init
c_func
(paren
r_void
)paren
(brace
)brace
multiline_comment|/*&n; * This is called very early before the page table is setup.&n; */
r_void
DECL|function|pSeries_pcibios_init_early
id|pSeries_pcibios_init_early
c_func
(paren
r_void
)paren
(brace
id|ppc_md.pcibios_read_config
op_assign
id|rtas_read_config
suffix:semicolon
id|ppc_md.pcibios_write_config
op_assign
id|rtas_write_config
suffix:semicolon
)brace
eof
