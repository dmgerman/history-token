multiline_comment|/*&n; * pSeries_pci.c&n; *&n; * pSeries_pcibios_init(void)opyright (C) 2001 Dave Engebretsen, IBM Corporation&n; *&n; * pSeries specific routines for PCI.&n; * &n; * Based on code from pci.c and chrp_pci.c&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *    &n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; * &n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/threads.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/init.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#include &lt;asm/ppcdebug.h&gt;
macro_line|#include &lt;asm/naca.h&gt;
macro_line|#include &lt;asm/pci_dma.h&gt;
macro_line|#include &lt;asm/eeh.h&gt;
macro_line|#include &quot;xics.h&quot;
macro_line|#include &quot;open_pic.h&quot;
macro_line|#include &quot;pci.h&quot;
r_extern
r_struct
id|device_node
op_star
id|allnodes
suffix:semicolon
multiline_comment|/*******************************************************************&n; * Forward declares of prototypes. &n; *******************************************************************/
r_int
r_int
id|find_and_init_phbs
c_func
(paren
r_void
)paren
suffix:semicolon
r_struct
id|pci_controller
op_star
id|alloc_phb
c_func
(paren
r_struct
id|device_node
op_star
id|dev
comma
r_char
op_star
id|model
comma
r_int
r_int
id|addr_size_words
)paren
suffix:semicolon
r_void
id|pSeries_pcibios_fixup
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|rtas_fake_read
c_func
(paren
r_struct
id|device_node
op_star
id|dn
comma
r_int
id|offset
comma
r_int
id|nbytes
comma
r_int
r_int
op_star
id|returnval
)paren
suffix:semicolon
multiline_comment|/* RTAS tokens */
DECL|variable|read_pci_config
r_static
r_int
id|read_pci_config
suffix:semicolon
DECL|variable|write_pci_config
r_static
r_int
id|write_pci_config
suffix:semicolon
DECL|variable|ibm_read_pci_config
r_static
r_int
id|ibm_read_pci_config
suffix:semicolon
DECL|variable|ibm_write_pci_config
r_static
r_int
id|ibm_write_pci_config
suffix:semicolon
DECL|variable|s7a_workaround
r_static
r_int
id|s7a_workaround
suffix:semicolon
multiline_comment|/******************************************************************************&n; *&n; * pSeries I/O Operations to access the PCI configuration space.&n; *&n; *****************************************************************************/
DECL|macro|RTAS_PCI_READ_OP
mdefine_line|#define RTAS_PCI_READ_OP(size, type, nbytes) &bslash;&n;int __chrp &bslash;&n;rtas_read_config_##size(struct device_node *dn, int offset, type val) {  &bslash;&n;&t;unsigned long returnval = ~0L; &bslash;&n;&t;unsigned long buid; &bslash;&n;&t;unsigned int addr; &bslash;&n;&t;int ret; &bslash;&n;&t; &bslash;&n;&t;if (dn == NULL) { &bslash;&n;&t;&t;ret = -2; &bslash;&n;&t;} else if (dn-&gt;status) { &bslash;&n;&t;&t;ret = -1; &bslash;&n;&t;} else { &bslash;&n;&t;&t;addr = (dn-&gt;busno &lt;&lt; 16) | (dn-&gt;devfn &lt;&lt; 8) | offset; &bslash;&n;&t;&t;buid = dn-&gt;phb-&gt;buid; &bslash;&n;&t;&t;if (buid) { &bslash;&n;&t;&t;&t;ret = rtas_call(ibm_read_pci_config, 4, 2, &amp;returnval, addr, buid &gt;&gt; 32, buid &amp; 0xffffffff, nbytes); &bslash;&n;                        if (ret &lt; 0) &bslash;&n;                               ret = rtas_fake_read(dn, offset, nbytes, &amp;returnval); &bslash;&n;&t;&t;} else { &bslash;&n;&t;&t;&t;ret = rtas_call(read_pci_config, 2, 2, &amp;returnval, addr, nbytes); &bslash;&n;&t;&t;} &bslash;&n;&t;} &bslash;&n;&t;*val = returnval; &bslash;&n;&t;return ret; &bslash;&n;} &bslash;&n;int __chrp &bslash;&n;rtas_pci_read_config_##size(struct pci_dev *dev, int offset, type val) {  &bslash;&n;        struct device_node *dn = pci_device_to_OF_node(dev); &bslash;&n;&t;int ret = rtas_read_config_##size(dn, offset, val); &bslash;&n;        /* udbg_printf(&quot;read bus=%x, devfn=%x, ret=%d phb=%lx, dn=%lx&bslash;n&quot;, dev-&gt;bus-&gt;number, dev-&gt;devfn, ret, dn ? dn-&gt;phb : 0, dn); */ &bslash;&n;        return ret ? PCIBIOS_DEVICE_NOT_FOUND : PCIBIOS_SUCCESSFUL; &bslash;&n;}
DECL|macro|RTAS_PCI_WRITE_OP
mdefine_line|#define RTAS_PCI_WRITE_OP(size, type, nbytes) &bslash;&n;int __chrp &bslash;&n;rtas_write_config_##size(struct device_node *dn, int offset, type val) { &bslash;&n;&t;unsigned long buid; &bslash;&n;&t;unsigned int addr; &bslash;&n;&t;int ret; &bslash;&n;&t; &bslash;&n;&t;if (dn == NULL) { &bslash;&n;&t;&t;ret = -2; &bslash;&n;&t;} else if (dn-&gt;status) { &bslash;&n;&t;&t;ret = -1; &bslash;&n;&t;} else { &bslash;&n;&t;&t;buid = dn-&gt;phb-&gt;buid; &bslash;&n;&t;&t;addr = (dn-&gt;busno &lt;&lt; 16) | (dn-&gt;devfn &lt;&lt; 8) | offset; &bslash;&n;&t;&t;if (buid) { &bslash;&n;&t;&t;&t;ret = rtas_call(ibm_write_pci_config, 5, 1, NULL, addr, buid &gt;&gt; 32, buid &amp; 0xffffffff, nbytes, (ulong) val); &bslash;&n;&t;&t;} else { &bslash;&n;&t;&t;&t;ret = rtas_call(write_pci_config, 3, 1, NULL, addr, nbytes, (ulong)val); &bslash;&n;&t;&t;} &bslash;&n;&t;} &bslash;&n;&t;return ret; &bslash;&n;} &bslash;&n;int __chrp &bslash;&n;rtas_pci_write_config_##size(struct pci_dev *dev, int offset, type val) { &bslash;&n;&t;return rtas_write_config_##size(pci_device_to_OF_node(dev), offset, val); &bslash;&n;}
id|RTAS_PCI_READ_OP
c_func
(paren
id|byte
comma
id|u8
op_star
comma
l_int|1
)paren
id|RTAS_PCI_READ_OP
c_func
(paren
id|word
comma
id|u16
op_star
comma
l_int|2
)paren
id|RTAS_PCI_READ_OP
c_func
(paren
id|dword
comma
id|u32
op_star
comma
l_int|4
)paren
id|RTAS_PCI_WRITE_OP
c_func
(paren
id|byte
comma
id|u8
comma
l_int|1
)paren
id|RTAS_PCI_WRITE_OP
c_func
(paren
id|word
comma
id|u16
comma
l_int|2
)paren
id|RTAS_PCI_WRITE_OP
c_func
(paren
id|dword
comma
id|u32
comma
l_int|4
)paren
DECL|variable|rtas_pci_ops
r_struct
id|pci_ops
id|rtas_pci_ops
op_assign
(brace
id|rtas_pci_read_config_byte
comma
id|rtas_pci_read_config_word
comma
id|rtas_pci_read_config_dword
comma
id|rtas_pci_write_config_byte
comma
id|rtas_pci_write_config_word
comma
id|rtas_pci_write_config_dword
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Handle the case where rtas refuses to do a pci config read.&n; * This currently only happens with some PHBs in which case we totally fake&n; * out the values (and call it a speedwagaon -- something we could look up&n; * in the device tree).&n; */
r_static
r_int
DECL|function|rtas_fake_read
id|rtas_fake_read
c_func
(paren
r_struct
id|device_node
op_star
id|dn
comma
r_int
id|offset
comma
r_int
id|nbytes
comma
r_int
r_int
op_star
id|returnval
)paren
(brace
r_char
op_star
id|device_type
op_assign
(paren
r_char
op_star
)paren
id|get_property
c_func
(paren
id|dn
comma
l_string|&quot;device_type&quot;
comma
l_int|0
)paren
suffix:semicolon
id|u32
op_star
id|class_code
op_assign
(paren
id|u32
op_star
)paren
id|get_property
c_func
(paren
id|dn
comma
l_string|&quot;class-code&quot;
comma
l_int|0
)paren
suffix:semicolon
op_star
id|returnval
op_assign
op_complement
l_int|0
suffix:semicolon
multiline_comment|/* float by default */
multiline_comment|/* udbg_printf(&quot;rtas_fake_read dn=%p, offset=0x%02x, nbytes=%d, device_type=%s&bslash;n&quot;, dn, offset, nbytes, device_type ? device_type : &quot;&lt;none&gt;&quot;); */
r_if
c_cond
(paren
id|device_type
op_logical_and
id|strcmp
c_func
(paren
id|device_type
comma
l_string|&quot;pci&quot;
)paren
op_ne
l_int|0
)paren
r_return
op_minus
l_int|3
suffix:semicolon
multiline_comment|/* Not a phb or bridge */
multiline_comment|/* NOTE: class_code != NULL =&gt; EADS pci bridge.  Else a PHB */
r_if
c_cond
(paren
id|nbytes
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|offset
op_eq
id|PCI_HEADER_TYPE
)paren
op_star
id|returnval
op_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* multifunction */
r_else
r_if
c_cond
(paren
id|offset
op_eq
id|PCI_INTERRUPT_PIN
op_logical_or
id|offset
op_eq
id|PCI_INTERRUPT_LINE
)paren
op_star
id|returnval
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|nbytes
op_eq
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|offset
op_eq
id|PCI_SUBSYSTEM_VENDOR_ID
op_logical_or
id|offset
op_eq
id|PCI_SUBSYSTEM_ID
)paren
op_star
id|returnval
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|offset
op_eq
id|PCI_COMMAND
)paren
op_star
id|returnval
op_assign
id|PCI_COMMAND_PARITY
op_or
id|PCI_COMMAND_MASTER
op_or
id|PCI_COMMAND_MEMORY
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|nbytes
op_eq
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|offset
op_eq
id|PCI_VENDOR_ID
)paren
op_star
id|returnval
op_assign
l_int|0x1014
op_or
(paren
(paren
id|class_code
ques
c_cond
l_int|0x8b
suffix:colon
l_int|0x102
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* a phb */
r_else
r_if
c_cond
(paren
id|offset
op_eq
id|PCI_REVISION_ID
)paren
op_star
id|returnval
op_assign
(paren
id|class_code
ques
c_cond
id|PCI_CLASS_BRIDGE_PCI
suffix:colon
id|PCI_CLASS_BRIDGE_HOST
)paren
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* revs are zero */
r_else
r_if
c_cond
(paren
(paren
id|offset
op_ge
id|PCI_BASE_ADDRESS_0
op_logical_and
id|offset
op_le
id|PCI_BASE_ADDRESS_5
)paren
op_logical_or
id|offset
op_eq
id|PCI_ROM_ADDRESS
)paren
op_star
id|returnval
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* printk(&quot;fake: %s nbytes=%d, offset=%lx ret=%lx&bslash;n&quot;, class_code ? &quot;EADS&quot; : &quot;PHB&quot;, nbytes, offset, *returnval); */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******************************************************************&n; * pci_read_irq_line&n; *&n; * Reads the Interrupt Pin to determine if interrupt is use by card.&n; * If the interrupt is used, then gets the interrupt line from the &n; * openfirmware and sets it in the pci_dev and pci_config line.&n; *&n; ******************************************************************/
r_int
DECL|function|pci_read_irq_line
id|pci_read_irq_line
c_func
(paren
r_struct
id|pci_dev
op_star
id|Pci_Dev
)paren
(brace
id|u8
id|InterruptPin
suffix:semicolon
r_struct
id|device_node
op_star
id|Node
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|Pci_Dev
comma
id|PCI_INTERRUPT_PIN
comma
op_amp
id|InterruptPin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|InterruptPin
op_eq
l_int|0
)paren
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;&bslash;tDevice: %s No Interrupt used by device.&bslash;n&quot;
comma
id|Pci_Dev-&gt;slot_name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|Node
op_assign
id|pci_device_to_OF_node
c_func
(paren
id|Pci_Dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Node
op_eq
l_int|NULL
)paren
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;&bslash;tDevice: %s Device Node not found.&bslash;n&quot;
comma
id|Pci_Dev-&gt;slot_name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|Node-&gt;n_intrs
op_eq
l_int|0
)paren
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;&bslash;tDevice: %s No Device OF interrupts defined.&bslash;n&quot;
comma
id|Pci_Dev-&gt;slot_name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|Pci_Dev-&gt;irq
op_assign
id|Node-&gt;intrs
(braket
l_int|0
)braket
dot
id|line
suffix:semicolon
r_if
c_cond
(paren
id|s7a_workaround
)paren
(brace
r_if
c_cond
(paren
id|Pci_Dev-&gt;irq
OG
l_int|16
)paren
id|Pci_Dev-&gt;irq
op_sub_assign
l_int|3
suffix:semicolon
)brace
id|pci_write_config_byte
c_func
(paren
id|Pci_Dev
comma
id|PCI_INTERRUPT_LINE
comma
id|Pci_Dev-&gt;irq
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_BUSWALK
comma
l_string|&quot;&bslash;tDevice: %s pci_dev-&gt;irq = 0x%02X&bslash;n&quot;
comma
id|Pci_Dev-&gt;slot_name
comma
id|Pci_Dev-&gt;irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******************************************************************&n; * Find all PHBs in the system and initialize a set of data &n; * structures to represent them.&n; ******************************************************************/
r_int
r_int
id|__init
DECL|function|find_and_init_phbs
id|find_and_init_phbs
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|Pci_Node
suffix:semicolon
r_struct
id|pci_controller
op_star
id|phb
suffix:semicolon
r_int
r_int
id|root_addr_size_words
op_assign
l_int|0
comma
id|this_addr_size_words
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|this_addr_count
op_assign
l_int|0
comma
id|range_stride
suffix:semicolon
r_int
r_int
op_star
id|ui_ptr
op_assign
l_int|NULL
comma
op_star
id|ranges
suffix:semicolon
r_char
op_star
id|model
suffix:semicolon
r_struct
id|pci_range64
id|range
suffix:semicolon
r_struct
id|resource
op_star
id|res
suffix:semicolon
r_int
r_int
id|memno
comma
id|rlen
comma
id|i
comma
id|index
suffix:semicolon
r_int
r_int
op_star
id|opprop
suffix:semicolon
r_int
id|has_isa
op_assign
l_int|0
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;find_and_init_phbs&bslash;n&quot;
)paren
suffix:semicolon
id|read_pci_config
op_assign
id|rtas_token
c_func
(paren
l_string|&quot;read-pci-config&quot;
)paren
suffix:semicolon
id|write_pci_config
op_assign
id|rtas_token
c_func
(paren
l_string|&quot;write-pci-config&quot;
)paren
suffix:semicolon
id|ibm_read_pci_config
op_assign
id|rtas_token
c_func
(paren
l_string|&quot;ibm,read-pci-config&quot;
)paren
suffix:semicolon
id|ibm_write_pci_config
op_assign
id|rtas_token
c_func
(paren
l_string|&quot;ibm,write-pci-config&quot;
)paren
suffix:semicolon
id|eeh_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|naca-&gt;interrupt_controller
op_eq
id|IC_OPEN_PIC
)paren
(brace
id|opprop
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_property
c_func
(paren
id|find_path_device
c_func
(paren
l_string|&quot;/&quot;
)paren
comma
l_string|&quot;platform-open-pic&quot;
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/* Get the root address word size. */
id|ui_ptr
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_property
c_func
(paren
id|find_path_device
c_func
(paren
l_string|&quot;/&quot;
)paren
comma
l_string|&quot;#size-cells&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ui_ptr
)paren
(brace
id|root_addr_size_words
op_assign
op_star
id|ui_ptr
suffix:semicolon
)brace
r_else
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tget #size-cells failed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|find_type_devices
c_func
(paren
l_string|&quot;isa&quot;
)paren
)paren
(brace
id|has_isa
op_assign
l_int|1
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tFound an ISA bus.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|index
op_assign
l_int|0
suffix:semicolon
multiline_comment|/******************************************************************&n;&t;* Find all PHB devices and create an object for them.&n;&t;******************************************************************/
r_for
c_loop
(paren
id|Pci_Node
op_assign
id|find_devices
c_func
(paren
l_string|&quot;pci&quot;
)paren
suffix:semicolon
id|Pci_Node
op_ne
l_int|NULL
suffix:semicolon
id|Pci_Node
op_assign
id|Pci_Node-&gt;next
)paren
(brace
id|model
op_assign
(paren
r_char
op_star
)paren
id|get_property
c_func
(paren
id|Pci_Node
comma
l_string|&quot;model&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|model
op_ne
l_int|NULL
)paren
(brace
id|phb
op_assign
id|alloc_phb
c_func
(paren
id|Pci_Node
comma
id|model
comma
id|root_addr_size_words
)paren
suffix:semicolon
r_if
c_cond
(paren
id|phb
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* Get this node&squot;s address word size. */
id|ui_ptr
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_property
c_func
(paren
id|Pci_Node
comma
l_string|&quot;#size-cells&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ui_ptr
)paren
id|this_addr_size_words
op_assign
op_star
id|ui_ptr
suffix:semicolon
r_else
id|this_addr_size_words
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Get this node&squot;s address word count. */
id|ui_ptr
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_property
c_func
(paren
id|Pci_Node
comma
l_string|&quot;#address-cells&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ui_ptr
)paren
id|this_addr_count
op_assign
op_star
id|ui_ptr
suffix:semicolon
r_else
id|this_addr_count
op_assign
l_int|3
suffix:semicolon
id|range_stride
op_assign
id|this_addr_count
op_plus
id|root_addr_size_words
op_plus
id|this_addr_size_words
suffix:semicolon
id|memno
op_assign
l_int|0
suffix:semicolon
id|phb-&gt;io_base_phys
op_assign
l_int|0
suffix:semicolon
id|ranges
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_property
c_func
(paren
id|Pci_Node
comma
l_string|&quot;ranges&quot;
comma
op_amp
id|rlen
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;trange_stride = 0x%lx, rlen = 0x%x&bslash;n&quot;
comma
id|range_stride
comma
id|rlen
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|rlen
op_div
r_sizeof
(paren
op_star
id|ranges
)paren
)paren
suffix:semicolon
id|i
op_add_assign
id|range_stride
)paren
(brace
multiline_comment|/* Put the PCI addr part of the current element into a &n;&t;&t;&t; * &squot;64&squot; struct. &n;&t;&t;&t; */
id|range
op_assign
op_star
(paren
(paren
r_struct
id|pci_range64
op_star
)paren
(paren
id|ranges
op_plus
id|i
)paren
)paren
suffix:semicolon
multiline_comment|/* If this is a &squot;32&squot; element, map into a 64 struct. */
r_if
c_cond
(paren
(paren
id|range_stride
op_star
r_sizeof
(paren
r_int
)paren
)paren
op_eq
r_sizeof
(paren
r_struct
id|pci_range32
)paren
)paren
(brace
id|range.parent_addr
op_assign
(paren
r_int
r_int
)paren
(paren
op_star
(paren
id|ranges
op_plus
id|i
op_plus
l_int|3
)paren
)paren
suffix:semicolon
id|range.size
op_assign
(paren
(paren
(paren
r_int
r_int
)paren
(paren
op_star
(paren
id|ranges
op_plus
id|i
op_plus
l_int|4
)paren
)paren
)paren
op_lshift
l_int|32
)paren
op_or
(paren
op_star
(paren
id|ranges
op_plus
id|i
op_plus
l_int|5
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|range.parent_addr
op_assign
(paren
(paren
(paren
r_int
r_int
)paren
(paren
op_star
(paren
id|ranges
op_plus
id|i
op_plus
l_int|3
)paren
)paren
)paren
op_lshift
l_int|32
)paren
op_or
(paren
op_star
(paren
id|ranges
op_plus
id|i
op_plus
l_int|4
)paren
)paren
suffix:semicolon
id|range.size
op_assign
(paren
(paren
(paren
r_int
r_int
)paren
(paren
op_star
(paren
id|ranges
op_plus
id|i
op_plus
l_int|5
)paren
)paren
)paren
op_lshift
l_int|32
)paren
op_or
(paren
op_star
(paren
id|ranges
op_plus
id|i
op_plus
l_int|6
)paren
)paren
suffix:semicolon
)brace
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;trange.parent_addr    = 0x%lx&bslash;n&quot;
comma
id|range.parent_addr
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;trange.child_addr.hi  = 0x%lx&bslash;n&quot;
comma
id|range.child_addr.a_hi
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;trange.child_addr.mid = 0x%lx&bslash;n&quot;
comma
id|range.child_addr.a_mid
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;trange.child_addr.lo  = 0x%lx&bslash;n&quot;
comma
id|range.child_addr.a_lo
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;trange.size           = 0x%lx&bslash;n&quot;
comma
id|range.size
)paren
suffix:semicolon
id|res
op_assign
l_int|NULL
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|range.child_addr.a_hi
op_rshift
l_int|24
)paren
op_amp
l_int|0x3
)paren
(brace
r_case
l_int|1
suffix:colon
multiline_comment|/* I/O space */
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tIO Space&bslash;n&quot;
)paren
suffix:semicolon
id|phb-&gt;io_base_phys
op_assign
id|range.parent_addr
suffix:semicolon
id|res
op_assign
op_amp
id|phb-&gt;io_resource
suffix:semicolon
id|res-&gt;name
op_assign
id|Pci_Node-&gt;full_name
suffix:semicolon
id|res-&gt;flags
op_assign
id|IORESOURCE_IO
suffix:semicolon
r_if
c_cond
(paren
id|is_eeh_implemented
c_func
(paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|isa_io_base
op_logical_and
id|has_isa
)paren
(brace
multiline_comment|/* map a page for ISA ports.  Not EEH protected. */
id|isa_io_base
op_assign
(paren
r_int
r_int
)paren
id|__ioremap
c_func
(paren
id|phb-&gt;io_base_phys
comma
id|PAGE_SIZE
comma
id|_PAGE_NO_CACHE
)paren
suffix:semicolon
)brace
id|res-&gt;start
op_assign
id|phb-&gt;io_base_virt
op_assign
id|eeh_token
c_func
(paren
id|index
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|res-&gt;end
op_assign
id|eeh_token
c_func
(paren
id|index
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xffffffff
)paren
suffix:semicolon
)brace
r_else
(brace
id|phb-&gt;io_base_virt
op_assign
id|ioremap
c_func
(paren
id|phb-&gt;io_base_phys
comma
id|range.size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_io_base
)paren
(brace
id|pci_io_base
op_assign
(paren
r_int
r_int
)paren
id|phb-&gt;io_base_virt
suffix:semicolon
r_if
c_cond
(paren
id|has_isa
)paren
id|isa_io_base
op_assign
id|pci_io_base
suffix:semicolon
)brace
id|res-&gt;start
op_assign
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|range.child_addr.a_mid
)paren
op_lshift
l_int|32
)paren
op_or
(paren
id|range.child_addr.a_lo
)paren
)paren
suffix:semicolon
id|res-&gt;start
op_add_assign
(paren
r_int
r_int
)paren
id|phb-&gt;io_base_virt
suffix:semicolon
id|res-&gt;end
op_assign
id|res-&gt;start
op_plus
id|range.size
op_minus
l_int|1
suffix:semicolon
)brace
id|res-&gt;parent
op_assign
l_int|NULL
suffix:semicolon
id|res-&gt;sibling
op_assign
l_int|NULL
suffix:semicolon
id|res-&gt;child
op_assign
l_int|NULL
suffix:semicolon
id|phb-&gt;pci_io_offset
op_assign
id|range.parent_addr
op_minus
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|range.child_addr.a_mid
)paren
op_lshift
l_int|32
)paren
op_or
(paren
id|range.child_addr.a_lo
)paren
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tpci_io_offset  = 0x%lx&bslash;n&quot;
comma
id|phb-&gt;pci_io_offset
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* mem space */
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tMem Space&bslash;n&quot;
)paren
suffix:semicolon
id|phb-&gt;pci_mem_offset
op_assign
id|range.parent_addr
op_minus
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|range.child_addr.a_mid
)paren
op_lshift
l_int|32
)paren
op_or
(paren
id|range.child_addr.a_lo
)paren
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tpci_mem_offset = 0x%lx&bslash;n&quot;
comma
id|phb-&gt;pci_mem_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|memno
OL
r_sizeof
(paren
id|phb-&gt;mem_resources
)paren
op_div
r_sizeof
(paren
id|phb-&gt;mem_resources
(braket
l_int|0
)braket
)paren
)paren
(brace
id|res
op_assign
op_amp
(paren
id|phb-&gt;mem_resources
(braket
id|memno
)braket
)paren
suffix:semicolon
op_increment
id|memno
suffix:semicolon
id|res-&gt;name
op_assign
id|Pci_Node-&gt;full_name
suffix:semicolon
id|res-&gt;flags
op_assign
id|IORESOURCE_MEM
suffix:semicolon
r_if
c_cond
(paren
id|is_eeh_implemented
c_func
(paren
)paren
)paren
(brace
id|res-&gt;start
op_assign
id|eeh_token
c_func
(paren
id|index
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|res-&gt;end
op_assign
id|eeh_token
c_func
(paren
id|index
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xffffffff
)paren
suffix:semicolon
)brace
r_else
(brace
id|res-&gt;start
op_assign
id|range.parent_addr
suffix:semicolon
id|res-&gt;end
op_assign
id|range.parent_addr
op_plus
id|range.size
op_minus
l_int|1
suffix:semicolon
)brace
id|res-&gt;parent
op_assign
l_int|NULL
suffix:semicolon
id|res-&gt;sibling
op_assign
l_int|NULL
suffix:semicolon
id|res-&gt;child
op_assign
l_int|NULL
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tphb-&gt;io_base_phys   = 0x%lx&bslash;n&quot;
comma
id|phb-&gt;io_base_phys
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tphb-&gt;pci_mem_offset = 0x%lx&bslash;n&quot;
comma
id|phb-&gt;pci_mem_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|naca-&gt;interrupt_controller
op_eq
id|IC_OPEN_PIC
)paren
(brace
r_int
id|addr
op_assign
id|root_addr_size_words
op_star
(paren
id|index
op_plus
l_int|2
)paren
op_minus
l_int|1
suffix:semicolon
id|openpic_setup_ISU
c_func
(paren
id|index
comma
id|opprop
(braket
id|addr
)braket
)paren
suffix:semicolon
)brace
id|index
op_increment
suffix:semicolon
)brace
id|pci_devs_phb_init
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/*Success */
)brace
multiline_comment|/******************************************************************&n; *&n; * Allocate and partially initialize a structure to represent a PHB.&n; *&n; ******************************************************************/
r_struct
id|pci_controller
op_star
DECL|function|alloc_phb
id|alloc_phb
c_func
(paren
r_struct
id|device_node
op_star
id|dev
comma
r_char
op_star
id|model
comma
r_int
r_int
id|addr_size_words
)paren
(brace
r_struct
id|pci_controller
op_star
id|phb
suffix:semicolon
r_int
r_int
op_star
id|ui_ptr
op_assign
l_int|NULL
comma
id|len
suffix:semicolon
r_struct
id|reg_property64
id|reg_struct
suffix:semicolon
r_int
op_star
id|bus_range
suffix:semicolon
r_int
op_star
id|buid_vals
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;alloc_phb: %s&bslash;n&quot;
comma
id|dev-&gt;full_name
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tdev             = 0x%lx&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tmodel           = 0x%lx&bslash;n&quot;
comma
id|model
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;taddr_size_words = 0x%lx&bslash;n&quot;
comma
id|addr_size_words
)paren
suffix:semicolon
multiline_comment|/* Found a PHB, now figure out where his registers are mapped. */
id|ui_ptr
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_property
c_func
(paren
id|dev
comma
l_string|&quot;reg&quot;
comma
op_amp
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ui_ptr
op_eq
l_int|NULL
)paren
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tget reg failed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|addr_size_words
op_eq
l_int|1
)paren
(brace
id|reg_struct.address
op_assign
(paren
(paren
r_struct
id|reg_property32
op_star
)paren
id|ui_ptr
)paren
op_member_access_from_pointer
id|address
suffix:semicolon
id|reg_struct.size
op_assign
(paren
(paren
r_struct
id|reg_property32
op_star
)paren
id|ui_ptr
)paren
op_member_access_from_pointer
id|size
suffix:semicolon
)brace
r_else
(brace
id|reg_struct
op_assign
op_star
(paren
(paren
r_struct
id|reg_property64
op_star
)paren
id|ui_ptr
)paren
suffix:semicolon
)brace
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;treg_struct.address = 0x%lx&bslash;n&quot;
comma
id|reg_struct.address
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;treg_struct.size    = 0x%lx&bslash;n&quot;
comma
id|reg_struct.size
)paren
suffix:semicolon
multiline_comment|/***************************************************************&n;&t;* Set chip specific data in the phb, including types &amp; &n;&t;* register pointers.&n;&t;***************************************************************/
multiline_comment|/****************************************************************&n;&t;* Python&n;&t;***************************************************************/
r_if
c_cond
(paren
id|strstr
c_func
(paren
id|model
comma
l_string|&quot;Python&quot;
)paren
)paren
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tCreate python&bslash;n&quot;
)paren
suffix:semicolon
id|phb
op_assign
id|pci_alloc_pci_controller
c_func
(paren
l_string|&quot;PHB PY&quot;
comma
id|phb_type_python
)paren
suffix:semicolon
r_if
c_cond
(paren
id|phb
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|phb-&gt;cfg_addr
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|ioremap
c_func
(paren
id|reg_struct.address
op_plus
l_int|0xf8000
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tcfg_addr_r = 0x%lx&bslash;n&quot;
comma
id|reg_struct.address
op_plus
l_int|0xf8000
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tcfg_addr_v = 0x%lx&bslash;n&quot;
comma
id|phb-&gt;cfg_addr
)paren
suffix:semicolon
id|phb-&gt;cfg_data
op_assign
(paren
r_char
op_star
)paren
(paren
id|phb-&gt;cfg_addr
op_plus
l_int|0x02
)paren
suffix:semicolon
id|phb-&gt;phb_regs
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|ioremap
c_func
(paren
id|reg_struct.address
op_plus
l_int|0xf7000
comma
id|PAGE_SIZE
)paren
suffix:semicolon
multiline_comment|/* Python&squot;s register file is 1 MB in size. */
id|phb-&gt;chip_regs
op_assign
id|ioremap
c_func
(paren
id|reg_struct.address
op_amp
op_complement
(paren
l_int|0xfffffUL
)paren
comma
l_int|0x100000
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t; * Firmware doesnt always clear this bit which is critical&n;&t;&t; * for good performance - Anton&n;&t;&t; */
(brace
r_volatile
id|u32
op_star
id|tmp
comma
id|i
suffix:semicolon
DECL|macro|PRG_CL_RESET_VALID
mdefine_line|#define PRG_CL_RESET_VALID 0x00010000
id|tmp
op_assign
(paren
id|u32
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|phb-&gt;chip_regs
op_plus
l_int|0xf6030
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|tmp
op_amp
id|PRG_CL_RESET_VALID
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Python workaround: &quot;
)paren
suffix:semicolon
op_star
id|tmp
op_and_assign
op_complement
id|PRG_CL_RESET_VALID
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * We must read it back for changes to&n;&t;&t;&t;&t; * take effect&n;&t;&t;&t;&t; */
id|i
op_assign
op_star
id|tmp
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;reg0: %x&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/***************************************************************&n;&t;* Speedwagon&n;&t;***************************************************************/
)brace
r_else
r_if
c_cond
(paren
id|strstr
c_func
(paren
id|model
comma
l_string|&quot;Speedwagon&quot;
)paren
)paren
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tCreate speedwagon&bslash;n&quot;
)paren
suffix:semicolon
id|phb
op_assign
id|pci_alloc_pci_controller
c_func
(paren
l_string|&quot;PHB SW&quot;
comma
id|phb_type_speedwagon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|phb
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|naca-&gt;platform
op_eq
id|PLATFORM_PSERIES
)paren
(brace
id|phb-&gt;cfg_addr
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|ioremap
c_func
(paren
id|reg_struct.address
op_plus
l_int|0x140
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|phb-&gt;cfg_data
op_assign
(paren
r_char
op_star
)paren
(paren
id|phb-&gt;cfg_addr
op_minus
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* minus is correct */
id|phb-&gt;phb_regs
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|ioremap
c_func
(paren
id|reg_struct.address
comma
id|PAGE_SIZE
)paren
suffix:semicolon
multiline_comment|/* Speedwagon&squot;s register file is 1 MB in size. */
id|phb-&gt;chip_regs
op_assign
id|ioremap
c_func
(paren
id|reg_struct.address
op_amp
op_complement
(paren
l_int|0xfffffUL
)paren
comma
l_int|0x100000
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tmapping chip_regs from 0x%lx -&gt; 0x%lx&bslash;n&quot;
comma
id|reg_struct.address
op_amp
l_int|0xfffff
comma
id|phb-&gt;chip_regs
)paren
suffix:semicolon
)brace
r_else
(brace
id|phb-&gt;cfg_addr
op_assign
l_int|NULL
suffix:semicolon
id|phb-&gt;cfg_data
op_assign
l_int|NULL
suffix:semicolon
id|phb-&gt;phb_regs
op_assign
l_int|NULL
suffix:semicolon
id|phb-&gt;chip_regs
op_assign
l_int|NULL
suffix:semicolon
)brace
id|phb-&gt;local_number
op_assign
(paren
(paren
id|reg_struct.address
op_rshift
l_int|12
)paren
op_amp
l_int|0xf
)paren
op_minus
l_int|0x8
suffix:semicolon
multiline_comment|/***************************************************************&n;&t;* Trying to build a known just gets the code in trouble.&n;&t;***************************************************************/
)brace
r_else
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tUnknown PHB Type!&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI: Unknown Phb Type!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|bus_range
op_assign
(paren
r_int
op_star
)paren
id|get_property
c_func
(paren
id|dev
comma
l_string|&quot;bus-range&quot;
comma
op_amp
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bus_range
op_eq
l_int|NULL
op_logical_or
id|len
OL
l_int|2
op_star
r_sizeof
(paren
r_int
)paren
)paren
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;Can&squot;t get bus-range for %s&bslash;n&quot;
comma
id|dev-&gt;full_name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|phb
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/***************************************************************&n;&t;* Finished with the initialization&n;&t;***************************************************************/
id|phb-&gt;first_busno
op_assign
id|bus_range
(braket
l_int|0
)braket
suffix:semicolon
id|phb-&gt;last_busno
op_assign
id|bus_range
(braket
l_int|1
)braket
suffix:semicolon
id|phb-&gt;arch_data
op_assign
id|dev
suffix:semicolon
id|phb-&gt;ops
op_assign
op_amp
id|rtas_pci_ops
suffix:semicolon
id|buid_vals
op_assign
(paren
r_int
op_star
)paren
id|get_property
c_func
(paren
id|dev
comma
l_string|&quot;ibm,fw-phb-id&quot;
comma
op_amp
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buid_vals
op_eq
l_int|NULL
)paren
(brace
id|phb-&gt;buid
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_struct
id|pci_bus
id|check
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
id|check.number
)paren
op_eq
l_int|1
op_logical_or
r_sizeof
(paren
id|check.primary
)paren
op_eq
l_int|1
op_logical_or
r_sizeof
(paren
id|check.secondary
)paren
op_eq
l_int|1
op_logical_or
r_sizeof
(paren
id|check.subordinate
)paren
op_eq
l_int|1
)paren
(brace
id|udbg_printf
c_func
(paren
l_string|&quot;pSeries_pci:  this system has large bus numbers and the kernel was not&bslash;n&quot;
l_string|&quot;built with the patch that fixes include/linux/pci.h struct pci_bus so&bslash;n&quot;
l_string|&quot;number, primary, secondary and subordinate are ints.&bslash;n&quot;
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;pSeries_pci:  this system has large bus numbers and the kernel was not&bslash;n&quot;
l_string|&quot;built with the patch that fixes include/linux/pci.h struct pci_bus so&bslash;n&quot;
l_string|&quot;number, primary, secondary and subordinate are ints.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OL
l_int|2
op_star
r_sizeof
(paren
r_int
)paren
)paren
id|phb-&gt;buid
op_assign
(paren
r_int
r_int
)paren
id|buid_vals
(braket
l_int|0
)braket
suffix:semicolon
singleline_comment|// Support for new OF that only has 1 integer for buid.
r_else
id|phb-&gt;buid
op_assign
(paren
(paren
(paren
r_int
r_int
)paren
id|buid_vals
(braket
l_int|0
)braket
)paren
op_lshift
l_int|32UL
)paren
op_or
(paren
(paren
(paren
r_int
r_int
)paren
id|buid_vals
(braket
l_int|1
)braket
)paren
op_amp
l_int|0xffffffff
)paren
suffix:semicolon
id|phb-&gt;first_busno
op_add_assign
(paren
id|phb-&gt;global_number
op_lshift
l_int|8
)paren
suffix:semicolon
id|phb-&gt;last_busno
op_add_assign
(paren
id|phb-&gt;global_number
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
multiline_comment|/* Dump PHB information for Debug */
id|PPCDBGCALL
c_func
(paren
id|PPCDBG_PHBINIT
comma
id|dumpPci_Controller
c_func
(paren
id|phb
)paren
)paren
suffix:semicolon
r_return
id|phb
suffix:semicolon
)brace
r_void
DECL|function|fixup_resources
id|fixup_resources
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|pci_controller
op_star
id|phb
op_assign
id|PCI_GET_PHB_PTR
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|device_node
op_star
id|dn
suffix:semicolon
r_int
r_int
id|eeh_disable_bit
suffix:semicolon
multiline_comment|/* Add IBM loc code (slot) as a prefix to the device names for service */
id|dn
op_assign
id|pci_device_to_OF_node
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dn
)paren
(brace
r_char
op_star
id|loc_code
op_assign
id|get_property
c_func
(paren
id|dn
comma
l_string|&quot;ibm,loc-code&quot;
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|loc_code
)paren
(brace
r_int
id|loc_len
op_assign
id|strlen
c_func
(paren
id|loc_code
)paren
suffix:semicolon
r_if
c_cond
(paren
id|loc_len
OL
r_sizeof
(paren
id|dev-&gt;name
)paren
)paren
(brace
id|memmove
c_func
(paren
id|dev-&gt;name
op_plus
id|loc_len
op_plus
l_int|1
comma
id|dev-&gt;name
comma
r_sizeof
(paren
id|dev-&gt;name
)paren
op_minus
id|loc_len
op_minus
l_int|1
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;name
comma
id|loc_code
comma
id|loc_len
)paren
suffix:semicolon
id|dev-&gt;name
(braket
id|loc_len
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
id|dev-&gt;name
(braket
r_sizeof
(paren
id|dev-&gt;name
)paren
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|is_eeh_implemented
c_func
(paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|is_eeh_configured
c_func
(paren
id|dev
)paren
)paren
(brace
id|eeh_disable_bit
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|eeh_set_option
c_func
(paren
id|dev
comma
id|EEH_ENABLE
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: failed to enable EEH for %s %s&bslash;n&quot;
comma
id|dev-&gt;slot_name
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|eeh_disable_bit
op_assign
id|EEH_TOKEN_DISABLED
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Assume device is by default EEH_DISABLE&squot;d */
id|printk
c_func
(paren
l_string|&quot;PCI: eeh NOT configured for %s %s&bslash;n&quot;
comma
id|dev-&gt;slot_name
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|eeh_disable_bit
op_assign
id|EEH_TOKEN_DISABLED
suffix:semicolon
)brace
)brace
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;fixup_resources:&bslash;n&quot;
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tphb                 = 0x%016LX&bslash;n&quot;
comma
id|phb
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tphb-&gt;pci_io_offset  = 0x%016LX&bslash;n&quot;
comma
id|phb-&gt;pci_io_offset
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tphb-&gt;pci_mem_offset = 0x%016LX&bslash;n&quot;
comma
id|phb-&gt;pci_mem_offset
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tdev-&gt;name   = %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tdev-&gt;vendor:device = 0x%04X : 0x%04X&bslash;n&quot;
comma
id|dev-&gt;vendor
comma
id|dev-&gt;device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|phb
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEVICE_COUNT_RESOURCE
suffix:semicolon
op_increment
id|i
)paren
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tdevice %x.%x[%d] (flags %x) [%lx..%lx]&bslash;n&quot;
comma
id|dev-&gt;bus-&gt;number
comma
id|dev-&gt;devfn
comma
id|i
comma
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|flags
comma
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
comma
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_eq
l_int|0
)paren
op_logical_and
(paren
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
op_eq
l_int|0
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|flags
op_amp
id|IORESOURCE_IO
)paren
(brace
r_if
c_cond
(paren
id|is_eeh_implemented
c_func
(paren
)paren
)paren
(brace
r_int
r_int
id|busno
op_assign
id|dev-&gt;bus
ques
c_cond
id|dev-&gt;bus-&gt;number
suffix:colon
l_int|0
suffix:semicolon
r_int
r_int
id|size
op_assign
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
op_minus
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
suffix:semicolon
r_int
r_int
id|addr
op_assign
(paren
r_int
r_int
)paren
id|__ioremap
c_func
(paren
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_plus
id|phb-&gt;io_base_phys
comma
id|size
comma
id|_PAGE_NO_CACHE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
id|panic
c_func
(paren
l_string|&quot;fixup_resources: ioremap failed!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_assign
id|eeh_token
c_func
(paren
id|phb-&gt;global_number
comma
id|busno
comma
id|dev-&gt;devfn
comma
id|addr
)paren
op_or
id|eeh_disable_bit
suffix:semicolon
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
op_assign
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_plus
id|size
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|offset
op_assign
(paren
r_int
r_int
)paren
id|phb-&gt;io_base_virt
suffix:semicolon
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_add_assign
id|offset
suffix:semicolon
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
op_add_assign
id|offset
suffix:semicolon
)brace
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;t&bslash;t-&gt; now [%lx .. %lx]&bslash;n&quot;
comma
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
comma
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|flags
op_amp
id|IORESOURCE_MEM
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Bogus.  Probably an unused bridge. */
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|is_eeh_implemented
c_func
(paren
)paren
)paren
(brace
r_int
r_int
id|busno
op_assign
id|dev-&gt;bus
ques
c_cond
id|dev-&gt;bus-&gt;number
suffix:colon
l_int|0
suffix:semicolon
r_int
r_int
id|size
op_assign
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
op_minus
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
suffix:semicolon
r_int
r_int
id|addr
op_assign
(paren
r_int
r_int
)paren
id|__ioremap
c_func
(paren
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_plus
id|phb-&gt;pci_mem_offset
comma
id|size
comma
id|_PAGE_NO_CACHE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
id|panic
c_func
(paren
l_string|&quot;fixup_resources: ioremap failed!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_assign
id|eeh_token
c_func
(paren
id|phb-&gt;global_number
comma
id|busno
comma
id|dev-&gt;devfn
comma
id|addr
)paren
op_or
id|eeh_disable_bit
suffix:semicolon
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
op_assign
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_plus
id|size
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_add_assign
id|phb-&gt;pci_mem_offset
suffix:semicolon
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
op_add_assign
id|phb-&gt;pci_mem_offset
suffix:semicolon
)brace
)brace
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;t&bslash;t-&gt; now [%lx..%lx]&bslash;n&quot;
comma
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
comma
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
)paren
suffix:semicolon
)brace
r_else
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* zap the 2nd function of the winbond chip */
r_if
c_cond
(paren
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|flags
op_amp
id|IORESOURCE_IO
op_logical_and
id|dev-&gt;bus-&gt;number
op_eq
l_int|0
op_logical_and
id|dev-&gt;devfn
op_eq
l_int|0x81
)paren
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|flags
op_and_assign
op_complement
id|IORESOURCE_IO
suffix:semicolon
)brace
)brace
DECL|function|check_s7a
r_static
r_void
id|check_s7a
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|root
suffix:semicolon
r_char
op_star
id|model
suffix:semicolon
id|root
op_assign
id|find_path_device
c_func
(paren
l_string|&quot;/&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|root
)paren
(brace
id|model
op_assign
id|get_property
c_func
(paren
id|root
comma
l_string|&quot;model&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|model
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
id|model
comma
l_string|&quot;IBM,7013-S7A&quot;
)paren
)paren
id|s7a_workaround
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_void
id|__init
DECL|function|pSeries_pcibios_fixup
id|pSeries_pcibios_fixup
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;pSeries_pcibios_fixup: start&bslash;n&quot;
)paren
suffix:semicolon
id|pci_assign_all_busses
op_assign
l_int|0
suffix:semicolon
id|check_s7a
c_func
(paren
)paren
suffix:semicolon
id|pci_for_each_dev
c_func
(paren
id|dev
)paren
(brace
id|pci_read_irq_line
c_func
(paren
id|dev
)paren
suffix:semicolon
id|PPCDBGCALL
c_func
(paren
id|PPCDBG_PHBINIT
comma
id|dumpPci_Dev
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|naca-&gt;interrupt_controller
op_eq
id|IC_PPC_XIC
)paren
(brace
id|xics_isa_init
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*********************************************************************** &n; * pci_find_hose_for_OF_device&n; *&n; * This function finds the PHB that matching device_node in the &n; * OpenFirmware by scanning all the pci_controllers.&n; * &n; ***********************************************************************/
r_struct
id|pci_controller
op_star
DECL|function|pci_find_hose_for_OF_device
id|pci_find_hose_for_OF_device
c_func
(paren
r_struct
id|device_node
op_star
id|node
)paren
(brace
r_while
c_loop
(paren
id|node
)paren
(brace
r_struct
id|pci_controller
op_star
id|hose
suffix:semicolon
r_for
c_loop
(paren
id|hose
op_assign
id|hose_head
suffix:semicolon
id|hose
suffix:semicolon
id|hose
op_assign
id|hose-&gt;next
)paren
r_if
c_cond
(paren
id|hose-&gt;arch_data
op_eq
id|node
)paren
r_return
id|hose
suffix:semicolon
id|node
op_assign
id|node-&gt;parent
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*********************************************************************** &n; * ppc64_pcibios_init&n; *  &n; * Chance to initialize and structures or variable before PCI Bus walk.&n; *  &n; ***********************************************************************/
r_void
DECL|function|pSeries_pcibios_init
id|pSeries_pcibios_init
c_func
(paren
r_void
)paren
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tppc64_pcibios_init Entry.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|get_property
c_func
(paren
id|find_path_device
c_func
(paren
l_string|&quot;/rtas&quot;
)paren
comma
l_string|&quot;ibm,fw-phb-id&quot;
comma
l_int|NULL
)paren
op_ne
l_int|NULL
)paren
(brace
id|PPCDBG
c_func
(paren
id|PPCDBG_PHBINIT
comma
l_string|&quot;&bslash;tFound: ibm,fw-phb-id&bslash;n&quot;
)paren
suffix:semicolon
id|Pci_Large_Bus_System
op_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * This is called very early before the page table is setup.&n; */
r_void
DECL|function|pSeries_pcibios_init_early
id|pSeries_pcibios_init_early
c_func
(paren
r_void
)paren
(brace
id|ppc_md.pcibios_read_config_byte
op_assign
id|rtas_read_config_byte
suffix:semicolon
id|ppc_md.pcibios_read_config_word
op_assign
id|rtas_read_config_word
suffix:semicolon
id|ppc_md.pcibios_read_config_dword
op_assign
id|rtas_read_config_dword
suffix:semicolon
id|ppc_md.pcibios_write_config_byte
op_assign
id|rtas_write_config_byte
suffix:semicolon
id|ppc_md.pcibios_write_config_word
op_assign
id|rtas_write_config_word
suffix:semicolon
id|ppc_md.pcibios_write_config_dword
op_assign
id|rtas_write_config_dword
suffix:semicolon
)brace
multiline_comment|/************************************************************************/
multiline_comment|/* Get a char* of the device physical location(U0.3-P1-I8)              */
multiline_comment|/* See the Product Topology in the RS/6000 Architecture.                */
multiline_comment|/************************************************************************/
DECL|function|device_Location
r_int
id|device_Location
c_func
(paren
r_struct
id|pci_dev
op_star
id|PciDev
comma
r_char
op_star
id|BufPtr
)paren
(brace
r_struct
id|device_node
op_star
id|DevNode
op_assign
(paren
r_struct
id|device_node
op_star
)paren
id|PciDev-&gt;sysdata
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|BufPtr
comma
l_string|&quot;PCI: Bus%3d, Device%3d, Vendor %04X, Location %-12s&quot;
comma
id|PciDev-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|PciDev-&gt;devfn
)paren
comma
id|PciDev-&gt;vendor
comma
(paren
r_char
op_star
)paren
id|get_property
c_func
(paren
id|DevNode
comma
l_string|&quot;ibm,loc-code&quot;
comma
l_int|0
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/************************************************************************/
multiline_comment|/* Set the slot reset line to the state passed in.                      */
multiline_comment|/* This is the platform specific for code for the pci_reset_device      */
multiline_comment|/* function.                                                            */
multiline_comment|/************************************************************************/
DECL|function|pci_set_reset
r_int
id|pci_set_reset
c_func
(paren
r_struct
id|pci_dev
op_star
id|PciDev
comma
r_int
id|state
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
eof
