multiline_comment|/*&n; * Idle daemon for PowerPC.  Idle daemon will handle any action&n; * that needs to be taken when the system becomes idle.&n; *&n; * Written by Cort Dougan (cort@cs.nmt.edu)&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/mmu.h&gt;
macro_line|#include &lt;asm/cache.h&gt;
macro_line|#include &lt;asm/time.h&gt;
macro_line|#include &lt;asm/iSeries/LparData.h&gt;
macro_line|#include &lt;asm/iSeries/HvCall.h&gt;
macro_line|#include &lt;asm/iSeries/ItLpQueue.h&gt;
DECL|variable|maxYieldTime
r_int
r_int
id|maxYieldTime
op_assign
l_int|0
suffix:semicolon
DECL|variable|minYieldTime
r_int
r_int
id|minYieldTime
op_assign
l_int|0xffffffffffffffffUL
suffix:semicolon
macro_line|#ifdef CONFIG_PPC_ISERIES
DECL|function|yield_shared_processor
r_static
r_void
id|yield_shared_processor
c_func
(paren
r_void
)paren
(brace
r_struct
id|Paca
op_star
id|paca
suffix:semicolon
r_int
r_int
id|tb
suffix:semicolon
r_int
r_int
id|yieldTime
suffix:semicolon
id|paca
op_assign
(paren
r_struct
id|Paca
op_star
)paren
id|mfspr
c_func
(paren
id|SPRG3
)paren
suffix:semicolon
id|HvCall_setEnabledInterrupts
c_func
(paren
id|HvCall_MaskIPI
op_or
id|HvCall_MaskLpEvent
op_or
id|HvCall_MaskLpProd
op_or
id|HvCall_MaskTimeout
)paren
suffix:semicolon
id|tb
op_assign
id|get_tb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Compute future tb value when yield should expire */
id|HvCall_yieldProcessor
c_func
(paren
id|HvCall_YieldTimed
comma
id|tb
op_plus
id|tb_ticks_per_jiffy
)paren
suffix:semicolon
id|yieldTime
op_assign
id|get_tb
c_func
(paren
)paren
op_minus
id|tb
suffix:semicolon
r_if
c_cond
(paren
id|yieldTime
OG
id|maxYieldTime
)paren
id|maxYieldTime
op_assign
id|yieldTime
suffix:semicolon
r_if
c_cond
(paren
id|yieldTime
OL
id|minYieldTime
)paren
id|minYieldTime
op_assign
id|yieldTime
suffix:semicolon
multiline_comment|/* The decrementer stops during the yield.  Force a fake decrementer&n;&t; * here and let the timer_interrupt code sort out the actual time.&n;&t; */
id|paca-&gt;xLpPaca.xIntDword.xFields.xDecrInt
op_assign
l_int|1
suffix:semicolon
id|process_iSeries_events
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PPC_ISERIES */
DECL|function|idled
r_int
id|idled
c_func
(paren
r_void
)paren
(brace
r_struct
id|Paca
op_star
id|paca
suffix:semicolon
r_int
id|oldval
suffix:semicolon
macro_line|#ifdef CONFIG_PPC_ISERIES
r_int
r_int
id|CTRL
suffix:semicolon
macro_line|#endif
multiline_comment|/* endless loop with no priority at all */
macro_line|#ifdef CONFIG_PPC_ISERIES
multiline_comment|/* ensure iSeries run light will be out when idle */
id|current-&gt;thread.flags
op_and_assign
op_complement
id|PPC_FLAG_RUN_LIGHT
suffix:semicolon
id|CTRL
op_assign
id|mfspr
c_func
(paren
id|CTRLF
)paren
suffix:semicolon
id|CTRL
op_and_assign
op_complement
id|RUNLATCH
suffix:semicolon
id|mtspr
c_func
(paren
id|CTRLT
comma
id|CTRL
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;cpu %d hits idle loop&bslash;n&quot;
comma
id|smp_processor_id
c_func
(paren
)paren
)paren
suffix:semicolon
id|paca
op_assign
(paren
r_struct
id|Paca
op_star
)paren
id|mfspr
c_func
(paren
id|SPRG3
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|need_resched
c_func
(paren
)paren
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|check_pgt_cache
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
macro_line|#ifdef CONFIG_PPC_ISERIES
r_if
c_cond
(paren
id|paca-&gt;xLpPaca.xSharedProc
)paren
(brace
r_if
c_cond
(paren
id|ItLpQueue_isLpIntPending
c_func
(paren
id|paca-&gt;lpQueuePtr
)paren
)paren
id|process_iSeries_events
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|need_resched
c_func
(paren
)paren
)paren
id|yield_shared_processor
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
(brace
r_if
c_cond
(paren
op_logical_neg
id|need_resched
c_func
(paren
)paren
)paren
(brace
id|set_thread_flag
c_func
(paren
id|TIF_POLLING_NRFLAG
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|test_thread_flag
c_func
(paren
id|TIF_NEED_RESCHED
)paren
)paren
(brace
macro_line|#ifdef CONFIG_PPC_ISERIES
id|HMT_medium
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ItLpQueue_isLpIntPending
c_func
(paren
id|paca-&gt;lpQueuePtr
)paren
)paren
id|process_iSeries_events
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|HMT_low
c_func
(paren
)paren
suffix:semicolon
)brace
id|clear_thread_flag
c_func
(paren
id|TIF_POLLING_NRFLAG
)paren
suffix:semicolon
)brace
)brace
id|HMT_medium
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|need_resched
c_func
(paren
)paren
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|check_pgt_cache
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * SMP entry into the idle task - calls the same thing as the&n; * non-smp versions. -- Cort&n; */
DECL|function|cpu_idle
r_int
id|cpu_idle
c_func
(paren
r_void
)paren
(brace
id|idled
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
