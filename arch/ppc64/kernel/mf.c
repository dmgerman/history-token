multiline_comment|/*&n;  * mf.c&n;  * Copyright (C) 2001 Troy D. Armstrong  IBM Corporation&n;  * Copyright (C) 2004 Stephen Rothwell  IBM Corporation&n;  *&n;  * This modules exists as an interface between a Linux secondary partition&n;  * running on an iSeries and the primary partition&squot;s Virtual Service&n;  * Processor (VSP) object.  The VSP has final authority over powering on/off&n;  * all partitions in the iSeries.  It also provides miscellaneous low-level&n;  * machine facility type operations.&n;  *&n;  *&n;  * This program is free software; you can redistribute it and/or modify&n;  * it under the terms of the GNU General Public License as published by&n;  * the Free Software Foundation; either version 2 of the License, or&n;  * (at your option) any later version.&n;  *&n;  * This program is distributed in the hope that it will be useful,&n;  * but WITHOUT ANY WARRANTY; without even the implied warranty of&n;  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;  * GNU General Public License for more details.&n;  *&n;  * You should have received a copy of the GNU General Public License&n;  * along with this program; if not, write to the Free Software&n;  * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n;  */
macro_line|#include &lt;asm/iSeries/mf.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/completion.h&gt;
macro_line|#include &lt;asm/iSeries/HvLpConfig.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/nvram.h&gt;
macro_line|#include &lt;asm/time.h&gt;
macro_line|#include &lt;asm/iSeries/ItSpCommArea.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &lt;linux/bcd.h&gt;
macro_line|#include &lt;asm/iSeries/vio.h&gt;
multiline_comment|/*&n; * This is the structure layout for the Machine Facilites LPAR event&n; * flows.&n; */
DECL|union|safe_cast
r_union
id|safe_cast
(brace
DECL|member|ptr_as_u64
id|u64
id|ptr_as_u64
suffix:semicolon
DECL|member|ptr
r_void
op_star
id|ptr
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|VspCmdData
r_struct
id|VspCmdData
(brace
DECL|member|token
r_union
id|safe_cast
id|token
suffix:semicolon
DECL|member|cmd
id|u16
id|cmd
suffix:semicolon
DECL|member|lp_index
id|HvLpIndex
id|lp_index
suffix:semicolon
DECL|member|result_code
id|u8
id|result_code
suffix:semicolon
DECL|member|reserved
id|u32
id|reserved
suffix:semicolon
r_union
(brace
DECL|member|state
id|u64
id|state
suffix:semicolon
multiline_comment|/* GetStateOut */
DECL|member|ipl_type
id|u64
id|ipl_type
suffix:semicolon
multiline_comment|/* GetIplTypeOut, Function02SelectIplTypeIn */
DECL|member|ipl_mode
id|u64
id|ipl_mode
suffix:semicolon
multiline_comment|/* GetIplModeOut, Function02SelectIplModeIn */
DECL|member|page
id|u64
id|page
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* GetSrcHistoryIn */
DECL|member|flag
id|u64
id|flag
suffix:semicolon
multiline_comment|/* GetAutoIplWhenPrimaryIplsOut,&n;&t;&t;&t;&t;   SetAutoIplWhenPrimaryIplsIn,&n;&t;&t;&t;&t;   WhiteButtonPowerOffIn,&n;&t;&t;&t;&t;   Function08FastPowerOffIn,&n;&t;&t;&t;&t;   IsSpcnRackPowerIncompleteOut */
r_struct
(brace
DECL|member|token
id|u64
id|token
suffix:semicolon
DECL|member|address_type
id|u64
id|address_type
suffix:semicolon
DECL|member|side
id|u64
id|side
suffix:semicolon
DECL|member|length
id|u32
id|length
suffix:semicolon
DECL|member|offset
id|u32
id|offset
suffix:semicolon
DECL|member|kern
)brace
id|kern
suffix:semicolon
multiline_comment|/* SetKernelImageIn, GetKernelImageIn,&n;&t;&t;&t;&t;   SetKernelCmdLineIn, GetKernelCmdLineIn */
DECL|member|length_out
id|u32
id|length_out
suffix:semicolon
multiline_comment|/* GetKernelImageOut, GetKernelCmdLineOut */
DECL|member|reserved
id|u8
id|reserved
(braket
l_int|80
)braket
suffix:semicolon
DECL|member|sub_data
)brace
id|sub_data
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|VspRspData
r_struct
id|VspRspData
(brace
DECL|member|com
r_struct
id|completion
id|com
suffix:semicolon
DECL|member|response
r_struct
id|VspCmdData
op_star
id|response
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|AllocData
r_struct
id|AllocData
(brace
DECL|member|size
id|u16
id|size
suffix:semicolon
DECL|member|type
id|u16
id|type
suffix:semicolon
DECL|member|count
id|u32
id|count
suffix:semicolon
DECL|member|reserved1
id|u16
id|reserved1
suffix:semicolon
DECL|member|reserved2
id|u8
id|reserved2
suffix:semicolon
DECL|member|target_lp
id|HvLpIndex
id|target_lp
suffix:semicolon
)brace
suffix:semicolon
r_struct
id|CeMsgData
suffix:semicolon
DECL|typedef|CeMsgCompleteHandler
r_typedef
r_void
(paren
op_star
id|CeMsgCompleteHandler
)paren
(paren
r_void
op_star
id|token
comma
r_struct
id|CeMsgData
op_star
id|vspCmdRsp
)paren
suffix:semicolon
DECL|struct|CeMsgCompleteData
r_struct
id|CeMsgCompleteData
(brace
DECL|member|handler
id|CeMsgCompleteHandler
id|handler
suffix:semicolon
DECL|member|token
r_void
op_star
id|token
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|CeMsgData
r_struct
id|CeMsgData
(brace
DECL|member|ce_msg
id|u8
id|ce_msg
(braket
l_int|12
)braket
suffix:semicolon
DECL|member|reserved
r_char
id|reserved
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|completion
r_struct
id|CeMsgCompleteData
op_star
id|completion
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|IoMFLpEvent
r_struct
id|IoMFLpEvent
(brace
DECL|member|hp_lp_event
r_struct
id|HvLpEvent
id|hp_lp_event
suffix:semicolon
DECL|member|subtype_result_code
id|u16
id|subtype_result_code
suffix:semicolon
DECL|member|reserved1
id|u16
id|reserved1
suffix:semicolon
DECL|member|reserved2
id|u32
id|reserved2
suffix:semicolon
r_union
(brace
DECL|member|alloc
r_struct
id|AllocData
id|alloc
suffix:semicolon
DECL|member|ce_msg
r_struct
id|CeMsgData
id|ce_msg
suffix:semicolon
DECL|member|vsp_cmd
r_struct
id|VspCmdData
id|vsp_cmd
suffix:semicolon
DECL|member|data
)brace
id|data
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|subtype_data
mdefine_line|#define subtype_data(a, b, c, d)&t;&bslash;&n;&t;&t;(((a) &lt;&lt; 24) + ((b) &lt;&lt; 16) + ((c) &lt;&lt; 8) + (d))
multiline_comment|/*&n; * All outgoing event traffic is kept on a FIFO queue.  The first&n; * pointer points to the one that is outstanding, and all new&n; * requests get stuck on the end.  Also, we keep a certain number of&n; * preallocated pending events so that we can operate very early in&n; * the boot up sequence (before kmalloc is ready).&n; */
DECL|struct|pending_event
r_struct
id|pending_event
(brace
DECL|member|next
r_struct
id|pending_event
op_star
id|next
suffix:semicolon
DECL|member|event
r_struct
id|IoMFLpEvent
id|event
suffix:semicolon
DECL|member|hdlr
id|MFCompleteHandler
id|hdlr
suffix:semicolon
DECL|member|dma_data
r_char
id|dma_data
(braket
l_int|72
)braket
suffix:semicolon
DECL|member|dma_data_length
r_int
id|dma_data_length
suffix:semicolon
DECL|member|remote_address
r_int
id|remote_address
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|pending_event_spinlock
r_static
id|spinlock_t
id|pending_event_spinlock
suffix:semicolon
DECL|variable|pending_event_head
r_static
r_struct
id|pending_event
op_star
id|pending_event_head
suffix:semicolon
DECL|variable|pending_event_tail
r_static
r_struct
id|pending_event
op_star
id|pending_event_tail
suffix:semicolon
DECL|variable|pending_event_avail
r_static
r_struct
id|pending_event
op_star
id|pending_event_avail
suffix:semicolon
DECL|variable|pending_event_prealloc
r_static
r_struct
id|pending_event
id|pending_event_prealloc
(braket
l_int|16
)braket
suffix:semicolon
multiline_comment|/*&n; * Put a pending event onto the available queue, so it can get reused.&n; * Attention! You must have the pending_event_spinlock before calling!&n; */
DECL|function|free_pending_event
r_static
r_void
id|free_pending_event
c_func
(paren
r_struct
id|pending_event
op_star
id|ev
)paren
(brace
r_if
c_cond
(paren
id|ev
op_ne
l_int|NULL
)paren
(brace
id|ev-&gt;next
op_assign
id|pending_event_avail
suffix:semicolon
id|pending_event_avail
op_assign
id|ev
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Enqueue the outbound event onto the stack.  If the queue was&n; * empty to begin with, we must also issue it via the Hypervisor&n; * interface.  There is a section of code below that will touch&n; * the first stack pointer without the protection of the pending_event_spinlock.&n; * This is OK, because we know that nobody else will be modifying&n; * the first pointer when we do this.&n; */
DECL|function|signal_event
r_static
r_int
id|signal_event
c_func
(paren
r_struct
id|pending_event
op_star
id|ev
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|go
op_assign
l_int|1
suffix:semicolon
r_struct
id|pending_event
op_star
id|ev1
suffix:semicolon
id|HvLpEvent_Rc
id|hvRc
suffix:semicolon
multiline_comment|/* enqueue the event */
r_if
c_cond
(paren
id|ev
op_ne
l_int|NULL
)paren
(brace
id|ev-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pending_event_spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pending_event_head
op_eq
l_int|NULL
)paren
id|pending_event_head
op_assign
id|ev
suffix:semicolon
r_else
(brace
id|go
op_assign
l_int|0
suffix:semicolon
id|pending_event_tail-&gt;next
op_assign
id|ev
suffix:semicolon
)brace
id|pending_event_tail
op_assign
id|ev
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pending_event_spinlock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* send the event */
r_while
c_loop
(paren
id|go
)paren
(brace
id|go
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* any DMA data to send beforehand? */
r_if
c_cond
(paren
id|pending_event_head-&gt;dma_data_length
OG
l_int|0
)paren
id|HvCallEvent_dmaToSp
c_func
(paren
id|pending_event_head-&gt;dma_data
comma
id|pending_event_head-&gt;remote_address
comma
id|pending_event_head-&gt;dma_data_length
comma
id|HvLpDma_Direction_LocalToRemote
)paren
suffix:semicolon
id|hvRc
op_assign
id|HvCallEvent_signalLpEvent
c_func
(paren
op_amp
id|pending_event_head-&gt;event.hp_lp_event
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hvRc
op_ne
id|HvLpEvent_Rc_Good
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mf.c: HvCallEvent_signalLpEvent() failed with %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|hvRc
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pending_event_spinlock
comma
id|flags
)paren
suffix:semicolon
id|ev1
op_assign
id|pending_event_head
suffix:semicolon
id|pending_event_head
op_assign
id|pending_event_head-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|pending_event_head
op_ne
l_int|NULL
)paren
id|go
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pending_event_spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ev1
op_eq
id|ev
)paren
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ev1-&gt;hdlr
op_ne
l_int|NULL
)paren
(brace
r_union
id|safe_cast
id|mySafeCast
suffix:semicolon
id|mySafeCast.ptr_as_u64
op_assign
id|ev1-&gt;event.hp_lp_event.xCorrelationToken
suffix:semicolon
(paren
op_star
id|ev1-&gt;hdlr
)paren
(paren
id|mySafeCast.ptr
comma
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pending_event_spinlock
comma
id|flags
)paren
suffix:semicolon
id|free_pending_event
c_func
(paren
id|ev1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pending_event_spinlock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Allocate a new pending_event structure, and initialize it.&n; */
DECL|function|new_pending_event
r_static
r_struct
id|pending_event
op_star
id|new_pending_event
c_func
(paren
r_void
)paren
(brace
r_struct
id|pending_event
op_star
id|ev
op_assign
l_int|NULL
suffix:semicolon
id|HvLpIndex
id|primaryLp
op_assign
id|HvLpConfig_getPrimaryLpIndex
c_func
(paren
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|HvLpEvent
op_star
id|hev
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pending_event_spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pending_event_avail
op_ne
l_int|NULL
)paren
(brace
id|ev
op_assign
id|pending_event_avail
suffix:semicolon
id|pending_event_avail
op_assign
id|pending_event_avail-&gt;next
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pending_event_spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ev
op_eq
l_int|NULL
)paren
id|ev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pending_event
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mf.c: unable to kmalloc %ld bytes&bslash;n&quot;
comma
r_sizeof
(paren
r_struct
id|pending_event
)paren
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pending_event
)paren
)paren
suffix:semicolon
id|hev
op_assign
op_amp
id|ev-&gt;event.hp_lp_event
suffix:semicolon
id|hev-&gt;xFlags.xValid
op_assign
l_int|1
suffix:semicolon
id|hev-&gt;xFlags.xAckType
op_assign
id|HvLpEvent_AckType_ImmediateAck
suffix:semicolon
id|hev-&gt;xFlags.xAckInd
op_assign
id|HvLpEvent_AckInd_DoAck
suffix:semicolon
id|hev-&gt;xFlags.xFunction
op_assign
id|HvLpEvent_Function_Int
suffix:semicolon
id|hev-&gt;xType
op_assign
id|HvLpEvent_Type_MachineFac
suffix:semicolon
id|hev-&gt;xSourceLp
op_assign
id|HvLpConfig_getLpIndex
c_func
(paren
)paren
suffix:semicolon
id|hev-&gt;xTargetLp
op_assign
id|primaryLp
suffix:semicolon
id|hev-&gt;xSizeMinus1
op_assign
r_sizeof
(paren
id|ev-&gt;event
)paren
op_minus
l_int|1
suffix:semicolon
id|hev-&gt;xRc
op_assign
id|HvLpEvent_Rc_Good
suffix:semicolon
id|hev-&gt;xSourceInstanceId
op_assign
id|HvCallEvent_getSourceLpInstanceId
c_func
(paren
id|primaryLp
comma
id|HvLpEvent_Type_MachineFac
)paren
suffix:semicolon
id|hev-&gt;xTargetInstanceId
op_assign
id|HvCallEvent_getTargetLpInstanceId
c_func
(paren
id|primaryLp
comma
id|HvLpEvent_Type_MachineFac
)paren
suffix:semicolon
r_return
id|ev
suffix:semicolon
)brace
DECL|function|signal_vsp_instruction
r_static
r_int
id|signal_vsp_instruction
c_func
(paren
r_struct
id|VspCmdData
op_star
id|vspCmd
)paren
(brace
r_struct
id|pending_event
op_star
id|ev
op_assign
id|new_pending_event
c_func
(paren
)paren
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_struct
id|VspRspData
id|response
suffix:semicolon
r_if
c_cond
(paren
id|ev
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|init_completion
c_func
(paren
op_amp
id|response.com
)paren
suffix:semicolon
id|response.response
op_assign
id|vspCmd
suffix:semicolon
id|ev-&gt;event.hp_lp_event.xSubtype
op_assign
l_int|6
suffix:semicolon
id|ev-&gt;event.hp_lp_event.x.xSubtypeData
op_assign
id|subtype_data
c_func
(paren
l_char|&squot;M&squot;
comma
l_char|&squot;F&squot;
comma
l_char|&squot;V&squot;
comma
l_char|&squot;I&squot;
)paren
suffix:semicolon
id|ev-&gt;event.data.vsp_cmd.token.ptr
op_assign
op_amp
id|response
suffix:semicolon
id|ev-&gt;event.data.vsp_cmd.cmd
op_assign
id|vspCmd-&gt;cmd
suffix:semicolon
id|ev-&gt;event.data.vsp_cmd.lp_index
op_assign
id|HvLpConfig_getLpIndex
c_func
(paren
)paren
suffix:semicolon
id|ev-&gt;event.data.vsp_cmd.result_code
op_assign
l_int|0xFF
suffix:semicolon
id|ev-&gt;event.data.vsp_cmd.reserved
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
(paren
id|ev-&gt;event.data.vsp_cmd.sub_data
)paren
comma
op_amp
(paren
id|vspCmd-&gt;sub_data
)paren
comma
r_sizeof
(paren
id|vspCmd-&gt;sub_data
)paren
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|rc
op_assign
id|signal_event
c_func
(paren
id|ev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
id|wait_for_completion
c_func
(paren
op_amp
id|response.com
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Send a 12-byte CE message to the primary partition VSP object&n; */
DECL|function|signal_ce_msg
r_static
r_int
id|signal_ce_msg
c_func
(paren
r_char
op_star
id|ce_msg
comma
r_struct
id|CeMsgCompleteData
op_star
id|completion
)paren
(brace
r_struct
id|pending_event
op_star
id|ev
op_assign
id|new_pending_event
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ev
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|ev-&gt;event.hp_lp_event.xSubtype
op_assign
l_int|0
suffix:semicolon
id|ev-&gt;event.hp_lp_event.x.xSubtypeData
op_assign
id|subtype_data
c_func
(paren
l_char|&squot;M&squot;
comma
l_char|&squot;F&squot;
comma
l_char|&squot;C&squot;
comma
l_char|&squot;E&squot;
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ev-&gt;event.data.ce_msg.ce_msg
comma
id|ce_msg
comma
l_int|12
)paren
suffix:semicolon
id|ev-&gt;event.data.ce_msg.completion
op_assign
id|completion
suffix:semicolon
r_return
id|signal_event
c_func
(paren
id|ev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Send a 12-byte CE message and DMA data to the primary partition VSP object&n; */
DECL|function|dma_and_signal_ce_msg
r_static
r_int
id|dma_and_signal_ce_msg
c_func
(paren
r_char
op_star
id|ce_msg
comma
r_struct
id|CeMsgCompleteData
op_star
id|completion
comma
r_void
op_star
id|dma_data
comma
r_int
id|dma_data_length
comma
r_int
id|remote_address
)paren
(brace
r_struct
id|pending_event
op_star
id|ev
op_assign
id|new_pending_event
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ev
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|ev-&gt;event.hp_lp_event.xSubtype
op_assign
l_int|0
suffix:semicolon
id|ev-&gt;event.hp_lp_event.x.xSubtypeData
op_assign
id|subtype_data
c_func
(paren
l_char|&squot;M&squot;
comma
l_char|&squot;F&squot;
comma
l_char|&squot;C&squot;
comma
l_char|&squot;E&squot;
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ev-&gt;event.data.ce_msg.ce_msg
comma
id|ce_msg
comma
l_int|12
)paren
suffix:semicolon
id|ev-&gt;event.data.ce_msg.completion
op_assign
id|completion
suffix:semicolon
id|memcpy
c_func
(paren
id|ev-&gt;dma_data
comma
id|dma_data
comma
id|dma_data_length
)paren
suffix:semicolon
id|ev-&gt;dma_data_length
op_assign
id|dma_data_length
suffix:semicolon
id|ev-&gt;remote_address
op_assign
id|remote_address
suffix:semicolon
r_return
id|signal_event
c_func
(paren
id|ev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Initiate a nice (hopefully) shutdown of Linux.  We simply are&n; * going to try and send the init process a SIGINT signal.  If&n; * this fails (why?), we&squot;ll simply force it off in a not-so-nice&n; * manner.&n; */
DECL|function|shutdown
r_static
r_int
id|shutdown
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
op_assign
id|kill_proc
c_func
(paren
l_int|1
comma
id|SIGINT
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;mf.c: SIGINT to init failed (%d), &quot;
l_string|&quot;hard shutdown commencing&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|mf_powerOff
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;mf.c: init has been successfully notified &quot;
l_string|&quot;to proceed with shutdown&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * The primary partition VSP object is sending us a new&n; * event flow.  Handle it...&n; */
DECL|function|intReceived
r_static
r_void
id|intReceived
c_func
(paren
r_struct
id|IoMFLpEvent
op_star
id|event
)paren
(brace
r_int
id|freeIt
op_assign
l_int|0
suffix:semicolon
r_struct
id|pending_event
op_star
id|two
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* ack the interrupt */
id|event-&gt;hp_lp_event.xRc
op_assign
id|HvLpEvent_Rc_Good
suffix:semicolon
id|HvCallEvent_ackLpEvent
c_func
(paren
op_amp
id|event-&gt;hp_lp_event
)paren
suffix:semicolon
multiline_comment|/* process interrupt */
r_switch
c_cond
(paren
id|event-&gt;hp_lp_event.xSubtype
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* CE message */
r_switch
c_cond
(paren
id|event-&gt;data.ce_msg.ce_msg
(braket
l_int|3
)braket
)paren
(brace
r_case
l_int|0x5B
suffix:colon
multiline_comment|/* power control notification */
r_if
c_cond
(paren
(paren
id|event-&gt;data.ce_msg.ce_msg
(braket
l_int|5
)braket
op_amp
l_int|0x20
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;mf.c: Commencing partition shutdown&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|shutdown
c_func
(paren
)paren
op_eq
l_int|0
)paren
id|signal_ce_msg
c_func
(paren
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;xDB&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0xC0
suffix:colon
multiline_comment|/* get time */
r_if
c_cond
(paren
(paren
id|pending_event_head
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|pending_event_head-&gt;event.data.ce_msg.ce_msg
(braket
l_int|3
)braket
op_ne
l_int|0x40
)paren
)paren
r_break
suffix:semicolon
id|freeIt
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pending_event_head-&gt;event.data.ce_msg.completion
op_ne
l_int|0
)paren
(brace
id|CeMsgCompleteHandler
id|handler
op_assign
id|pending_event_head-&gt;event.data.ce_msg.completion-&gt;handler
suffix:semicolon
r_void
op_star
id|token
op_assign
id|pending_event_head-&gt;event.data.ce_msg.completion-&gt;token
suffix:semicolon
r_if
c_cond
(paren
id|handler
op_ne
l_int|NULL
)paren
(paren
op_star
id|handler
)paren
(paren
id|token
comma
op_amp
(paren
id|event-&gt;data.ce_msg
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/* remove from queue */
r_if
c_cond
(paren
id|freeIt
op_eq
l_int|1
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pending_event_spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pending_event_head
op_ne
l_int|NULL
)paren
(brace
r_struct
id|pending_event
op_star
id|oldHead
op_assign
id|pending_event_head
suffix:semicolon
id|pending_event_head
op_assign
id|pending_event_head-&gt;next
suffix:semicolon
id|two
op_assign
id|pending_event_head
suffix:semicolon
id|free_pending_event
c_func
(paren
id|oldHead
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pending_event_spinlock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* send next waiting event */
r_if
c_cond
(paren
id|two
op_ne
l_int|NULL
)paren
id|signal_event
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* IT sys shutdown */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;mf.c: Commencing system shutdown&bslash;n&quot;
)paren
suffix:semicolon
id|shutdown
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * The primary partition VSP object is acknowledging the receipt&n; * of a flow we sent to them.  If there are other flows queued&n; * up, we must send another one now...&n; */
DECL|function|ackReceived
r_static
r_void
id|ackReceived
c_func
(paren
r_struct
id|IoMFLpEvent
op_star
id|event
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|pending_event
op_star
id|two
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|freeIt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* handle current event */
r_if
c_cond
(paren
id|pending_event_head
op_ne
l_int|NULL
)paren
(brace
r_switch
c_cond
(paren
id|event-&gt;hp_lp_event.xSubtype
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* CE msg */
r_if
c_cond
(paren
id|event-&gt;data.ce_msg.ce_msg
(braket
l_int|3
)braket
op_eq
l_int|0x40
)paren
(brace
r_if
c_cond
(paren
id|event-&gt;data.ce_msg.ce_msg
(braket
l_int|2
)braket
op_ne
l_int|0
)paren
(brace
id|freeIt
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pending_event_head-&gt;event.data.ce_msg.completion
op_ne
l_int|0
)paren
(brace
id|CeMsgCompleteHandler
id|handler
op_assign
id|pending_event_head-&gt;event.data.ce_msg.completion-&gt;handler
suffix:semicolon
r_void
op_star
id|token
op_assign
id|pending_event_head-&gt;event.data.ce_msg.completion-&gt;token
suffix:semicolon
r_if
c_cond
(paren
id|handler
op_ne
l_int|NULL
)paren
(paren
op_star
id|handler
)paren
(paren
id|token
comma
op_amp
(paren
id|event-&gt;data.ce_msg
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
id|freeIt
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
multiline_comment|/* allocate */
r_case
l_int|5
suffix:colon
multiline_comment|/* deallocate */
r_if
c_cond
(paren
id|pending_event_head-&gt;hdlr
op_ne
l_int|NULL
)paren
(brace
r_union
id|safe_cast
id|mySafeCast
suffix:semicolon
id|mySafeCast.ptr_as_u64
op_assign
id|event-&gt;hp_lp_event.xCorrelationToken
suffix:semicolon
(paren
op_star
id|pending_event_head-&gt;hdlr
)paren
(paren
id|mySafeCast.ptr
comma
id|event-&gt;data.alloc.count
)paren
suffix:semicolon
)brace
id|freeIt
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
(brace
r_struct
id|VspRspData
op_star
id|rsp
op_assign
(paren
r_struct
id|VspRspData
op_star
)paren
id|event-&gt;data.vsp_cmd.token.ptr
suffix:semicolon
r_if
c_cond
(paren
id|rsp
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|rsp-&gt;response
op_ne
l_int|NULL
)paren
id|memcpy
c_func
(paren
id|rsp-&gt;response
comma
op_amp
(paren
id|event-&gt;data.vsp_cmd
)paren
comma
r_sizeof
(paren
id|event-&gt;data.vsp_cmd
)paren
)paren
suffix:semicolon
id|complete
c_func
(paren
op_amp
id|rsp-&gt;com
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mf.c: no rsp&bslash;n&quot;
)paren
suffix:semicolon
id|freeIt
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mf.c: stack empty for receiving ack&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* remove from queue */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pending_event_spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pending_event_head
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|freeIt
op_eq
l_int|1
)paren
)paren
(brace
r_struct
id|pending_event
op_star
id|oldHead
op_assign
id|pending_event_head
suffix:semicolon
id|pending_event_head
op_assign
id|pending_event_head-&gt;next
suffix:semicolon
id|two
op_assign
id|pending_event_head
suffix:semicolon
id|free_pending_event
c_func
(paren
id|oldHead
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pending_event_spinlock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* send next waiting event */
r_if
c_cond
(paren
id|two
op_ne
l_int|NULL
)paren
id|signal_event
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This is the generic event handler we are registering with&n; * the Hypervisor.  Ensure the flows are for us, and then&n; * parse it enough to know if it is an interrupt or an&n; * acknowledge.&n; */
DECL|function|hvHandler
r_static
r_void
id|hvHandler
c_func
(paren
r_struct
id|HvLpEvent
op_star
id|event
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_if
c_cond
(paren
(paren
id|event
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|event-&gt;xType
op_eq
id|HvLpEvent_Type_MachineFac
)paren
)paren
(brace
r_switch
c_cond
(paren
id|event-&gt;xFlags.xFunction
)paren
(brace
r_case
id|HvLpEvent_Function_Ack
suffix:colon
id|ackReceived
c_func
(paren
(paren
r_struct
id|IoMFLpEvent
op_star
)paren
id|event
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HvLpEvent_Function_Int
suffix:colon
id|intReceived
c_func
(paren
(paren
r_struct
id|IoMFLpEvent
op_star
)paren
id|event
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mf.c: non ack/int event received&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mf.c: alien event received&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Global kernel interface to allocate and seed events into the&n; * Hypervisor.&n; */
DECL|function|mf_allocateLpEvents
r_void
id|mf_allocateLpEvents
c_func
(paren
id|HvLpIndex
id|targetLp
comma
id|HvLpEvent_Type
id|type
comma
r_int
id|size
comma
r_int
id|count
comma
id|MFCompleteHandler
id|hdlr
comma
r_void
op_star
id|userToken
)paren
(brace
r_struct
id|pending_event
op_star
id|ev
op_assign
id|new_pending_event
c_func
(paren
)paren
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|ev
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_else
(brace
r_union
id|safe_cast
id|mine
suffix:semicolon
id|mine.ptr
op_assign
id|userToken
suffix:semicolon
id|ev-&gt;event.hp_lp_event.xSubtype
op_assign
l_int|4
suffix:semicolon
id|ev-&gt;event.hp_lp_event.xCorrelationToken
op_assign
id|mine.ptr_as_u64
suffix:semicolon
id|ev-&gt;event.hp_lp_event.x.xSubtypeData
op_assign
id|subtype_data
c_func
(paren
l_char|&squot;M&squot;
comma
l_char|&squot;F&squot;
comma
l_char|&squot;M&squot;
comma
l_char|&squot;A&squot;
)paren
suffix:semicolon
id|ev-&gt;event.data.alloc.target_lp
op_assign
id|targetLp
suffix:semicolon
id|ev-&gt;event.data.alloc.type
op_assign
id|type
suffix:semicolon
id|ev-&gt;event.data.alloc.size
op_assign
id|size
suffix:semicolon
id|ev-&gt;event.data.alloc.count
op_assign
id|count
suffix:semicolon
id|ev-&gt;hdlr
op_assign
id|hdlr
suffix:semicolon
id|rc
op_assign
id|signal_event
c_func
(paren
id|ev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rc
op_ne
l_int|0
)paren
op_logical_and
(paren
id|hdlr
op_ne
l_int|NULL
)paren
)paren
(paren
op_star
id|hdlr
)paren
(paren
id|userToken
comma
id|rc
)paren
suffix:semicolon
)brace
DECL|variable|mf_allocateLpEvents
id|EXPORT_SYMBOL
c_func
(paren
id|mf_allocateLpEvents
)paren
suffix:semicolon
multiline_comment|/*&n; * Global kernel interface to unseed and deallocate events already in&n; * Hypervisor.&n; */
DECL|function|mf_deallocateLpEvents
r_void
id|mf_deallocateLpEvents
c_func
(paren
id|HvLpIndex
id|targetLp
comma
id|HvLpEvent_Type
id|type
comma
r_int
id|count
comma
id|MFCompleteHandler
id|hdlr
comma
r_void
op_star
id|userToken
)paren
(brace
r_struct
id|pending_event
op_star
id|ev
op_assign
id|new_pending_event
c_func
(paren
)paren
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|ev
op_eq
l_int|NULL
)paren
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_else
(brace
r_union
id|safe_cast
id|mine
suffix:semicolon
id|mine.ptr
op_assign
id|userToken
suffix:semicolon
id|ev-&gt;event.hp_lp_event.xSubtype
op_assign
l_int|5
suffix:semicolon
id|ev-&gt;event.hp_lp_event.xCorrelationToken
op_assign
id|mine.ptr_as_u64
suffix:semicolon
id|ev-&gt;event.hp_lp_event.x.xSubtypeData
op_assign
id|subtype_data
c_func
(paren
l_char|&squot;M&squot;
comma
l_char|&squot;F&squot;
comma
l_char|&squot;M&squot;
comma
l_char|&squot;D&squot;
)paren
suffix:semicolon
id|ev-&gt;event.data.alloc.target_lp
op_assign
id|targetLp
suffix:semicolon
id|ev-&gt;event.data.alloc.type
op_assign
id|type
suffix:semicolon
id|ev-&gt;event.data.alloc.count
op_assign
id|count
suffix:semicolon
id|ev-&gt;hdlr
op_assign
id|hdlr
suffix:semicolon
id|rc
op_assign
id|signal_event
c_func
(paren
id|ev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rc
op_ne
l_int|0
)paren
op_logical_and
(paren
id|hdlr
op_ne
l_int|NULL
)paren
)paren
(paren
op_star
id|hdlr
)paren
(paren
id|userToken
comma
id|rc
)paren
suffix:semicolon
)brace
DECL|variable|mf_deallocateLpEvents
id|EXPORT_SYMBOL
c_func
(paren
id|mf_deallocateLpEvents
)paren
suffix:semicolon
multiline_comment|/*&n; * Global kernel interface to tell the VSP object in the primary&n; * partition to power this partition off.&n; */
DECL|function|mf_powerOff
r_void
id|mf_powerOff
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;mf.c: Down it goes...&bslash;n&quot;
)paren
suffix:semicolon
id|signal_ce_msg
c_func
(paren
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x4D&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Global kernel interface to tell the VSP object in the primary&n; * partition to reboot this partition.&n; */
DECL|function|mf_reboot
r_void
id|mf_reboot
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;mf.c: Preparing to bounce...&bslash;n&quot;
)paren
suffix:semicolon
id|signal_ce_msg
c_func
(paren
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x4E&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Display a single word SRC onto the VSP control panel.&n; */
DECL|function|mf_displaySrc
r_void
id|mf_displaySrc
c_func
(paren
id|u32
id|word
)paren
(brace
id|u8
id|ce
(braket
l_int|12
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|ce
comma
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x4A&bslash;x00&bslash;x00&bslash;x00&bslash;x01&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
comma
l_int|12
)paren
suffix:semicolon
id|ce
(braket
l_int|8
)braket
op_assign
id|word
op_rshift
l_int|24
suffix:semicolon
id|ce
(braket
l_int|9
)braket
op_assign
id|word
op_rshift
l_int|16
suffix:semicolon
id|ce
(braket
l_int|10
)braket
op_assign
id|word
op_rshift
l_int|8
suffix:semicolon
id|ce
(braket
l_int|11
)braket
op_assign
id|word
suffix:semicolon
id|signal_ce_msg
c_func
(paren
id|ce
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Display a single word SRC of the form &quot;PROGXXXX&quot; on the VSP control panel.&n; */
DECL|function|mf_displayProgress
r_void
id|mf_displayProgress
c_func
(paren
id|u16
id|value
)paren
(brace
id|u8
id|ce
(braket
l_int|12
)braket
suffix:semicolon
id|u8
id|src
(braket
l_int|72
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|ce
comma
l_string|&quot;&bslash;x00&bslash;x00&bslash;x04&bslash;x4A&bslash;x00&bslash;x00&bslash;x00&bslash;x48&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
comma
l_int|12
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|src
comma
l_string|&quot;&bslash;x01&bslash;x00&bslash;x00&bslash;x01&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x00PROGxxxx                        &quot;
comma
l_int|72
)paren
suffix:semicolon
id|src
(braket
l_int|6
)braket
op_assign
id|value
op_rshift
l_int|8
suffix:semicolon
id|src
(braket
l_int|7
)braket
op_assign
id|value
op_amp
l_int|255
suffix:semicolon
id|src
(braket
l_int|44
)braket
op_assign
l_string|&quot;0123456789ABCDEF&quot;
(braket
(paren
id|value
op_rshift
l_int|12
)paren
op_amp
l_int|15
)braket
suffix:semicolon
id|src
(braket
l_int|45
)braket
op_assign
l_string|&quot;0123456789ABCDEF&quot;
(braket
(paren
id|value
op_rshift
l_int|8
)paren
op_amp
l_int|15
)braket
suffix:semicolon
id|src
(braket
l_int|46
)braket
op_assign
l_string|&quot;0123456789ABCDEF&quot;
(braket
(paren
id|value
op_rshift
l_int|4
)paren
op_amp
l_int|15
)braket
suffix:semicolon
id|src
(braket
l_int|47
)braket
op_assign
l_string|&quot;0123456789ABCDEF&quot;
(braket
id|value
op_amp
l_int|15
)braket
suffix:semicolon
id|dma_and_signal_ce_msg
c_func
(paren
id|ce
comma
l_int|NULL
comma
id|src
comma
r_sizeof
(paren
id|src
)paren
comma
l_int|9
op_star
l_int|64
op_star
l_int|1024
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Clear the VSP control panel.  Used to &quot;erase&quot; an SRC that was&n; * previously displayed.&n; */
DECL|function|mf_clearSrc
r_void
id|mf_clearSrc
c_func
(paren
r_void
)paren
(brace
id|signal_ce_msg
c_func
(paren
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x4B&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialization code here.&n; */
DECL|function|mf_init
r_void
id|mf_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* initialize */
id|spin_lock_init
c_func
(paren
op_amp
id|pending_event_spinlock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|pending_event_prealloc
)paren
op_div
r_sizeof
(paren
op_star
id|pending_event_prealloc
)paren
suffix:semicolon
op_increment
id|i
)paren
id|free_pending_event
c_func
(paren
op_amp
id|pending_event_prealloc
(braket
id|i
)braket
)paren
suffix:semicolon
id|HvLpEvent_registerHandler
c_func
(paren
id|HvLpEvent_Type_MachineFac
comma
op_amp
id|hvHandler
)paren
suffix:semicolon
multiline_comment|/* virtual continue ack */
id|signal_ce_msg
c_func
(paren
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x57&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* initialization complete */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;mf.c: iSeries Linux LPAR Machine Facilities initialized&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|mf_setSide
r_void
id|mf_setSide
c_func
(paren
r_char
id|side
)paren
(brace
id|u64
id|newSide
suffix:semicolon
r_struct
id|VspCmdData
id|myVspCmd
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|myVspCmd
comma
l_int|0
comma
r_sizeof
(paren
id|myVspCmd
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|side
)paren
(brace
r_case
l_char|&squot;A&squot;
suffix:colon
id|newSide
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;B&squot;
suffix:colon
id|newSide
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;C&squot;
suffix:colon
id|newSide
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|newSide
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
)brace
id|myVspCmd.sub_data.ipl_type
op_assign
id|newSide
suffix:semicolon
id|myVspCmd.cmd
op_assign
l_int|10
suffix:semicolon
(paren
r_void
)paren
id|signal_vsp_instruction
c_func
(paren
op_amp
id|myVspCmd
)paren
suffix:semicolon
)brace
DECL|function|mf_getSide
r_char
id|mf_getSide
c_func
(paren
r_void
)paren
(brace
r_char
id|returnValue
op_assign
l_char|&squot; &squot;
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|VspCmdData
id|myVspCmd
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|myVspCmd
comma
l_int|0
comma
r_sizeof
(paren
id|myVspCmd
)paren
)paren
suffix:semicolon
id|myVspCmd.cmd
op_assign
l_int|2
suffix:semicolon
id|myVspCmd.sub_data.ipl_type
op_assign
l_int|0
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|rc
op_assign
id|signal_vsp_instruction
c_func
(paren
op_amp
id|myVspCmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
r_return
id|returnValue
suffix:semicolon
r_if
c_cond
(paren
id|myVspCmd.result_code
op_eq
l_int|0
)paren
(brace
r_switch
c_cond
(paren
id|myVspCmd.sub_data.ipl_type
)paren
(brace
r_case
l_int|0
suffix:colon
id|returnValue
op_assign
l_char|&squot;A&squot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|returnValue
op_assign
l_char|&squot;B&squot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|returnValue
op_assign
l_char|&squot;C&squot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|returnValue
op_assign
l_char|&squot;D&squot;
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|returnValue
suffix:semicolon
)brace
DECL|function|mf_getSrcHistory
r_void
id|mf_getSrcHistory
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
id|size
)paren
(brace
macro_line|#if 0
r_struct
id|IplTypeReturnStuff
id|returnStuff
suffix:semicolon
r_struct
id|pending_event
op_star
id|ev
op_assign
id|new_pending_event
c_func
(paren
)paren
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|pages
(braket
l_int|4
)braket
suffix:semicolon
id|pages
(braket
l_int|0
)braket
op_assign
id|kmalloc
c_func
(paren
l_int|4096
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|pages
(braket
l_int|1
)braket
op_assign
id|kmalloc
c_func
(paren
l_int|4096
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|pages
(braket
l_int|2
)braket
op_assign
id|kmalloc
c_func
(paren
l_int|4096
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|pages
(braket
l_int|3
)braket
op_assign
id|kmalloc
c_func
(paren
l_int|4096
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ev
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|pages
(braket
l_int|0
)braket
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|pages
(braket
l_int|1
)braket
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|pages
(braket
l_int|2
)braket
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|pages
(braket
l_int|3
)braket
op_eq
l_int|NULL
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|returnStuff.xType
op_assign
l_int|0
suffix:semicolon
id|returnStuff.xRc
op_assign
l_int|0
suffix:semicolon
id|returnStuff.xDone
op_assign
l_int|0
suffix:semicolon
id|ev-&gt;event.hp_lp_event.xSubtype
op_assign
l_int|6
suffix:semicolon
id|ev-&gt;event.hp_lp_event.x.xSubtypeData
op_assign
id|subtype_data
c_func
(paren
l_char|&squot;M&squot;
comma
l_char|&squot;F&squot;
comma
l_char|&squot;V&squot;
comma
l_char|&squot;I&squot;
)paren
suffix:semicolon
id|ev-&gt;event.data.vsp_cmd.xEvent
op_assign
op_amp
id|returnStuff
suffix:semicolon
id|ev-&gt;event.data.vsp_cmd.cmd
op_assign
l_int|4
suffix:semicolon
id|ev-&gt;event.data.vsp_cmd.lp_index
op_assign
id|HvLpConfig_getLpIndex
c_func
(paren
)paren
suffix:semicolon
id|ev-&gt;event.data.vsp_cmd.result_code
op_assign
l_int|0xFF
suffix:semicolon
id|ev-&gt;event.data.vsp_cmd.reserved
op_assign
l_int|0
suffix:semicolon
id|ev-&gt;event.data.vsp_cmd.sub_data.page
(braket
l_int|0
)braket
op_assign
id|ISERIES_HV_ADDR
c_func
(paren
id|pages
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|ev-&gt;event.data.vsp_cmd.sub_data.page
(braket
l_int|1
)braket
op_assign
id|ISERIES_HV_ADDR
c_func
(paren
id|pages
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|ev-&gt;event.data.vsp_cmd.sub_data.page
(braket
l_int|2
)braket
op_assign
id|ISERIES_HV_ADDR
c_func
(paren
id|pages
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|ev-&gt;event.data.vsp_cmd.sub_data.page
(braket
l_int|3
)braket
op_assign
id|ISERIES_HV_ADDR
c_func
(paren
id|pages
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_event
c_func
(paren
id|ev
)paren
op_ne
l_int|0
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
id|returnStuff.xDone
op_ne
l_int|1
)paren
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|returnStuff.xRc
op_eq
l_int|0
)paren
id|memcpy
c_func
(paren
id|buffer
comma
id|pages
(braket
l_int|0
)braket
comma
id|size
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pages
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pages
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pages
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pages
(braket
l_int|3
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|mf_setCmdLine
r_void
id|mf_setCmdLine
c_func
(paren
r_const
r_char
op_star
id|cmdline
comma
r_int
id|size
comma
id|u64
id|side
)paren
(brace
r_struct
id|VspCmdData
id|myVspCmd
suffix:semicolon
id|dma_addr_t
id|dma_addr
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|page
op_assign
id|dma_alloc_coherent
c_func
(paren
id|iSeries_vio_dev
comma
id|size
comma
op_amp
id|dma_addr
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mf.c: couldn&squot;t allocate memory to set command line&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|copy_from_user
c_func
(paren
id|page
comma
id|cmdline
comma
id|size
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|myVspCmd
comma
l_int|0
comma
r_sizeof
(paren
id|myVspCmd
)paren
)paren
suffix:semicolon
id|myVspCmd.cmd
op_assign
l_int|31
suffix:semicolon
id|myVspCmd.sub_data.kern.token
op_assign
id|dma_addr
suffix:semicolon
id|myVspCmd.sub_data.kern.address_type
op_assign
id|HvLpDma_AddressType_TceIndex
suffix:semicolon
id|myVspCmd.sub_data.kern.side
op_assign
id|side
suffix:semicolon
id|myVspCmd.sub_data.kern.length
op_assign
id|size
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
(paren
r_void
)paren
id|signal_vsp_instruction
c_func
(paren
op_amp
id|myVspCmd
)paren
suffix:semicolon
id|dma_free_coherent
c_func
(paren
id|iSeries_vio_dev
comma
id|size
comma
id|page
comma
id|dma_addr
)paren
suffix:semicolon
)brace
DECL|function|mf_getCmdLine
r_int
id|mf_getCmdLine
c_func
(paren
r_char
op_star
id|cmdline
comma
r_int
op_star
id|size
comma
id|u64
id|side
)paren
(brace
r_struct
id|VspCmdData
id|myVspCmd
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_int
id|len
op_assign
op_star
id|size
suffix:semicolon
id|dma_addr_t
id|dma_addr
suffix:semicolon
id|dma_addr
op_assign
id|dma_map_single
c_func
(paren
id|iSeries_vio_dev
comma
id|cmdline
comma
id|len
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
id|memset
c_func
(paren
id|cmdline
comma
l_int|0
comma
id|len
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|myVspCmd
comma
l_int|0
comma
r_sizeof
(paren
id|myVspCmd
)paren
)paren
suffix:semicolon
id|myVspCmd.cmd
op_assign
l_int|33
suffix:semicolon
id|myVspCmd.sub_data.kern.token
op_assign
id|dma_addr
suffix:semicolon
id|myVspCmd.sub_data.kern.address_type
op_assign
id|HvLpDma_AddressType_TceIndex
suffix:semicolon
id|myVspCmd.sub_data.kern.side
op_assign
id|side
suffix:semicolon
id|myVspCmd.sub_data.kern.length
op_assign
id|len
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|rc
op_assign
id|signal_vsp_instruction
c_func
(paren
op_amp
id|myVspCmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|myVspCmd.result_code
op_eq
l_int|0
)paren
id|len
op_assign
id|myVspCmd.sub_data.length_out
suffix:semicolon
macro_line|#if 0
r_else
id|memcpy
c_func
(paren
id|cmdline
comma
l_string|&quot;Bad cmdline&quot;
comma
l_int|11
)paren
suffix:semicolon
macro_line|#endif
)brace
id|dma_unmap_single
c_func
(paren
id|iSeries_vio_dev
comma
id|dma_addr
comma
op_star
id|size
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|mf_setVmlinuxChunk
r_int
id|mf_setVmlinuxChunk
c_func
(paren
r_const
r_char
op_star
id|buffer
comma
r_int
id|size
comma
r_int
id|offset
comma
id|u64
id|side
)paren
(brace
r_struct
id|VspCmdData
id|myVspCmd
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|dma_addr_t
id|dma_addr
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|page
op_assign
id|dma_alloc_coherent
c_func
(paren
id|iSeries_vio_dev
comma
id|size
comma
op_amp
id|dma_addr
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mf.c: couldn&squot;t allocate memory to set vmlinux chunk&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|copy_from_user
c_func
(paren
id|page
comma
id|buffer
comma
id|size
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|myVspCmd
comma
l_int|0
comma
r_sizeof
(paren
id|myVspCmd
)paren
)paren
suffix:semicolon
id|myVspCmd.cmd
op_assign
l_int|30
suffix:semicolon
id|myVspCmd.sub_data.kern.token
op_assign
id|dma_addr
suffix:semicolon
id|myVspCmd.sub_data.kern.address_type
op_assign
id|HvLpDma_AddressType_TceIndex
suffix:semicolon
id|myVspCmd.sub_data.kern.side
op_assign
id|side
suffix:semicolon
id|myVspCmd.sub_data.kern.offset
op_assign
id|offset
suffix:semicolon
id|myVspCmd.sub_data.kern.length
op_assign
id|size
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|rc
op_assign
id|signal_vsp_instruction
c_func
(paren
op_amp
id|myVspCmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|myVspCmd.result_code
op_eq
l_int|0
)paren
id|rc
op_assign
l_int|0
suffix:semicolon
r_else
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|dma_free_coherent
c_func
(paren
id|iSeries_vio_dev
comma
id|size
comma
id|page
comma
id|dma_addr
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|mf_getVmlinuxChunk
r_int
id|mf_getVmlinuxChunk
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
op_star
id|size
comma
r_int
id|offset
comma
id|u64
id|side
)paren
(brace
r_struct
id|VspCmdData
id|myVspCmd
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_int
id|len
op_assign
op_star
id|size
suffix:semicolon
id|dma_addr_t
id|dma_addr
suffix:semicolon
id|dma_addr
op_assign
id|dma_map_single
c_func
(paren
id|iSeries_vio_dev
comma
id|buffer
comma
id|len
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
id|memset
c_func
(paren
id|buffer
comma
l_int|0
comma
id|len
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|myVspCmd
comma
l_int|0
comma
r_sizeof
(paren
id|myVspCmd
)paren
)paren
suffix:semicolon
id|myVspCmd.cmd
op_assign
l_int|32
suffix:semicolon
id|myVspCmd.sub_data.kern.token
op_assign
id|dma_addr
suffix:semicolon
id|myVspCmd.sub_data.kern.address_type
op_assign
id|HvLpDma_AddressType_TceIndex
suffix:semicolon
id|myVspCmd.sub_data.kern.side
op_assign
id|side
suffix:semicolon
id|myVspCmd.sub_data.kern.offset
op_assign
id|offset
suffix:semicolon
id|myVspCmd.sub_data.kern.length
op_assign
id|len
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|rc
op_assign
id|signal_vsp_instruction
c_func
(paren
op_amp
id|myVspCmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|myVspCmd.result_code
op_eq
l_int|0
)paren
op_star
id|size
op_assign
id|myVspCmd.sub_data.length_out
suffix:semicolon
r_else
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|dma_unmap_single
c_func
(paren
id|iSeries_vio_dev
comma
id|dma_addr
comma
id|len
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|mf_setRtcTime
r_int
id|mf_setRtcTime
c_func
(paren
r_int
r_int
id|time
)paren
(brace
r_struct
id|rtc_time
id|tm
suffix:semicolon
id|to_tm
c_func
(paren
id|time
comma
op_amp
id|tm
)paren
suffix:semicolon
r_return
id|mf_setRtc
c_func
(paren
op_amp
id|tm
)paren
suffix:semicolon
)brace
DECL|struct|RtcTimeData
r_struct
id|RtcTimeData
(brace
DECL|member|com
r_struct
id|completion
id|com
suffix:semicolon
DECL|member|xCeMsg
r_struct
id|CeMsgData
id|xCeMsg
suffix:semicolon
DECL|member|xRc
r_int
id|xRc
suffix:semicolon
)brace
suffix:semicolon
DECL|function|getRtcTimeComplete
r_void
id|getRtcTimeComplete
c_func
(paren
r_void
op_star
id|token
comma
r_struct
id|CeMsgData
op_star
id|ceMsg
)paren
(brace
r_struct
id|RtcTimeData
op_star
id|rtc
op_assign
(paren
r_struct
id|RtcTimeData
op_star
)paren
id|token
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
(paren
id|rtc-&gt;xCeMsg
)paren
comma
id|ceMsg
comma
r_sizeof
(paren
id|rtc-&gt;xCeMsg
)paren
)paren
suffix:semicolon
id|rtc-&gt;xRc
op_assign
l_int|0
suffix:semicolon
id|complete
c_func
(paren
op_amp
id|rtc-&gt;com
)paren
suffix:semicolon
)brace
DECL|variable|lastsec
r_static
r_int
r_int
id|lastsec
op_assign
l_int|1
suffix:semicolon
DECL|function|mf_getRtcTime
r_int
id|mf_getRtcTime
c_func
(paren
r_int
r_int
op_star
id|time
)paren
(brace
id|u32
id|dataWord1
op_assign
op_star
(paren
(paren
id|u32
op_star
)paren
(paren
op_amp
id|xSpCommArea.xBcdTimeAtIplStart
)paren
)paren
suffix:semicolon
id|u32
id|dataWord2
op_assign
op_star
(paren
(paren
(paren
id|u32
op_star
)paren
op_amp
(paren
id|xSpCommArea.xBcdTimeAtIplStart
)paren
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_int
id|year
op_assign
l_int|1970
suffix:semicolon
r_int
id|year1
op_assign
(paren
id|dataWord1
op_rshift
l_int|24
)paren
op_amp
l_int|0x000000FF
suffix:semicolon
r_int
id|year2
op_assign
(paren
id|dataWord1
op_rshift
l_int|16
)paren
op_amp
l_int|0x000000FF
suffix:semicolon
r_int
id|sec
op_assign
(paren
id|dataWord1
op_rshift
l_int|8
)paren
op_amp
l_int|0x000000FF
suffix:semicolon
r_int
id|min
op_assign
id|dataWord1
op_amp
l_int|0x000000FF
suffix:semicolon
r_int
id|hour
op_assign
(paren
id|dataWord2
op_rshift
l_int|24
)paren
op_amp
l_int|0x000000FF
suffix:semicolon
r_int
id|day
op_assign
(paren
id|dataWord2
op_rshift
l_int|8
)paren
op_amp
l_int|0x000000FF
suffix:semicolon
r_int
id|mon
op_assign
id|dataWord2
op_amp
l_int|0x000000FF
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|sec
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|min
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|hour
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|day
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|mon
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|year1
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|year2
)paren
suffix:semicolon
id|year
op_assign
id|year1
op_star
l_int|100
op_plus
id|year2
suffix:semicolon
op_star
id|time
op_assign
id|mktime
c_func
(paren
id|year
comma
id|mon
comma
id|day
comma
id|hour
comma
id|min
comma
id|sec
)paren
suffix:semicolon
op_star
id|time
op_add_assign
(paren
id|jiffies
op_div
id|HZ
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Now THIS is a nasty hack!&n;&t; * It ensures that the first two calls to mf_getRtcTime get different&n;&t; * answers.  That way the loop in init_time (time.c) will not think&n;&t; * the clock is stuck.&n;&t; */
r_if
c_cond
(paren
id|lastsec
)paren
(brace
op_star
id|time
op_sub_assign
id|lastsec
suffix:semicolon
op_decrement
id|lastsec
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mf_getRtc
r_int
id|mf_getRtc
c_func
(paren
r_struct
id|rtc_time
op_star
id|tm
)paren
(brace
r_struct
id|CeMsgCompleteData
id|ceComplete
suffix:semicolon
r_struct
id|RtcTimeData
id|rtcData
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|ceComplete
comma
l_int|0
comma
r_sizeof
(paren
id|ceComplete
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|rtcData
comma
l_int|0
comma
r_sizeof
(paren
id|rtcData
)paren
)paren
suffix:semicolon
id|init_completion
c_func
(paren
op_amp
id|rtcData.com
)paren
suffix:semicolon
id|ceComplete.handler
op_assign
op_amp
id|getRtcTimeComplete
suffix:semicolon
id|ceComplete.token
op_assign
(paren
r_void
op_star
)paren
op_amp
id|rtcData
suffix:semicolon
id|rc
op_assign
id|signal_ce_msg
c_func
(paren
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x40&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
comma
op_amp
id|ceComplete
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|wait_for_completion
c_func
(paren
op_amp
id|rtcData.com
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rtcData.xRc
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|rtcData.xCeMsg.ce_msg
(braket
l_int|2
)braket
op_eq
l_int|0xa9
)paren
op_logical_or
(paren
id|rtcData.xCeMsg.ce_msg
(braket
l_int|2
)braket
op_eq
l_int|0xaf
)paren
)paren
(brace
multiline_comment|/* TOD clock is not set */
id|tm-&gt;tm_sec
op_assign
l_int|1
suffix:semicolon
id|tm-&gt;tm_min
op_assign
l_int|1
suffix:semicolon
id|tm-&gt;tm_hour
op_assign
l_int|1
suffix:semicolon
id|tm-&gt;tm_mday
op_assign
l_int|10
suffix:semicolon
id|tm-&gt;tm_mon
op_assign
l_int|8
suffix:semicolon
id|tm-&gt;tm_year
op_assign
l_int|71
suffix:semicolon
id|mf_setRtc
c_func
(paren
id|tm
)paren
suffix:semicolon
)brace
(brace
id|u32
id|dataWord1
op_assign
op_star
(paren
(paren
id|u32
op_star
)paren
(paren
id|rtcData.xCeMsg.ce_msg
op_plus
l_int|4
)paren
)paren
suffix:semicolon
id|u32
id|dataWord2
op_assign
op_star
(paren
(paren
id|u32
op_star
)paren
(paren
id|rtcData.xCeMsg.ce_msg
op_plus
l_int|8
)paren
)paren
suffix:semicolon
id|u8
id|year
op_assign
(paren
id|dataWord1
op_rshift
l_int|16
)paren
op_amp
l_int|0x000000FF
suffix:semicolon
id|u8
id|sec
op_assign
(paren
id|dataWord1
op_rshift
l_int|8
)paren
op_amp
l_int|0x000000FF
suffix:semicolon
id|u8
id|min
op_assign
id|dataWord1
op_amp
l_int|0x000000FF
suffix:semicolon
id|u8
id|hour
op_assign
(paren
id|dataWord2
op_rshift
l_int|24
)paren
op_amp
l_int|0x000000FF
suffix:semicolon
id|u8
id|day
op_assign
(paren
id|dataWord2
op_rshift
l_int|8
)paren
op_amp
l_int|0x000000FF
suffix:semicolon
id|u8
id|mon
op_assign
id|dataWord2
op_amp
l_int|0x000000FF
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|sec
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|min
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|hour
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|day
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|mon
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|year
)paren
suffix:semicolon
r_if
c_cond
(paren
id|year
op_le
l_int|69
)paren
id|year
op_add_assign
l_int|100
suffix:semicolon
id|tm-&gt;tm_sec
op_assign
id|sec
suffix:semicolon
id|tm-&gt;tm_min
op_assign
id|min
suffix:semicolon
id|tm-&gt;tm_hour
op_assign
id|hour
suffix:semicolon
id|tm-&gt;tm_mday
op_assign
id|day
suffix:semicolon
id|tm-&gt;tm_mon
op_assign
id|mon
suffix:semicolon
id|tm-&gt;tm_year
op_assign
id|year
suffix:semicolon
)brace
)brace
r_else
(brace
id|rc
op_assign
id|rtcData.xRc
suffix:semicolon
id|tm-&gt;tm_sec
op_assign
l_int|0
suffix:semicolon
id|tm-&gt;tm_min
op_assign
l_int|0
suffix:semicolon
id|tm-&gt;tm_hour
op_assign
l_int|0
suffix:semicolon
id|tm-&gt;tm_mday
op_assign
l_int|15
suffix:semicolon
id|tm-&gt;tm_mon
op_assign
l_int|5
suffix:semicolon
id|tm-&gt;tm_year
op_assign
l_int|52
suffix:semicolon
)brace
id|tm-&gt;tm_wday
op_assign
l_int|0
suffix:semicolon
id|tm-&gt;tm_yday
op_assign
l_int|0
suffix:semicolon
id|tm-&gt;tm_isdst
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
DECL|function|mf_setRtc
r_int
id|mf_setRtc
c_func
(paren
r_struct
id|rtc_time
op_star
id|tm
)paren
(brace
r_char
id|ceTime
(braket
l_int|12
)braket
op_assign
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x41&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
suffix:semicolon
id|u8
id|day
comma
id|mon
comma
id|hour
comma
id|min
comma
id|sec
comma
id|y1
comma
id|y2
suffix:semicolon
r_int
id|year
suffix:semicolon
id|year
op_assign
l_int|1900
op_plus
id|tm-&gt;tm_year
suffix:semicolon
id|y1
op_assign
id|year
op_div
l_int|100
suffix:semicolon
id|y2
op_assign
id|year
op_mod
l_int|100
suffix:semicolon
id|sec
op_assign
id|tm-&gt;tm_sec
suffix:semicolon
id|min
op_assign
id|tm-&gt;tm_min
suffix:semicolon
id|hour
op_assign
id|tm-&gt;tm_hour
suffix:semicolon
id|day
op_assign
id|tm-&gt;tm_mday
suffix:semicolon
id|mon
op_assign
id|tm-&gt;tm_mon
op_plus
l_int|1
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|sec
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|min
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|hour
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|mon
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|day
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|y1
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|y2
)paren
suffix:semicolon
id|ceTime
(braket
l_int|4
)braket
op_assign
id|y1
suffix:semicolon
id|ceTime
(braket
l_int|5
)braket
op_assign
id|y2
suffix:semicolon
id|ceTime
(braket
l_int|6
)braket
op_assign
id|sec
suffix:semicolon
id|ceTime
(braket
l_int|7
)braket
op_assign
id|min
suffix:semicolon
id|ceTime
(braket
l_int|8
)braket
op_assign
id|hour
suffix:semicolon
id|ceTime
(braket
l_int|10
)braket
op_assign
id|day
suffix:semicolon
id|ceTime
(braket
l_int|11
)braket
op_assign
id|mon
suffix:semicolon
r_return
id|signal_ce_msg
c_func
(paren
id|ceTime
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|proc_mf_dump_cmdline
r_static
r_int
id|proc_mf_dump_cmdline
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|len
op_assign
id|count
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|off
)paren
(brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|len
op_assign
id|mf_getCmdLine
c_func
(paren
id|page
comma
op_amp
id|len
comma
(paren
id|u64
)paren
id|data
)paren
suffix:semicolon
id|p
op_assign
id|page
suffix:semicolon
r_while
c_loop
(paren
id|len
OL
(paren
id|count
op_minus
l_int|1
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|p
op_logical_or
op_star
id|p
op_eq
l_char|&squot;&bslash;n&squot;
)paren
r_break
suffix:semicolon
id|p
op_increment
suffix:semicolon
id|len
op_increment
suffix:semicolon
)brace
op_star
id|p
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
id|p
op_increment
suffix:semicolon
op_star
id|p
op_assign
l_int|0
suffix:semicolon
r_return
id|p
op_minus
id|page
suffix:semicolon
)brace
macro_line|#if 0
r_static
r_int
id|proc_mf_dump_vmlinux
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|sizeToGet
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
id|mf_getVmlinuxChunk
c_func
(paren
id|page
comma
op_amp
id|sizeToGet
comma
id|off
comma
(paren
id|u64
)paren
id|data
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|sizeToGet
op_ne
l_int|0
)paren
(brace
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
r_return
id|sizeToGet
suffix:semicolon
)brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|proc_mf_dump_side
r_static
r_int
id|proc_mf_dump_side
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|len
suffix:semicolon
r_char
id|mf_current_side
op_assign
id|mf_getSide
c_func
(paren
)paren
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;%c&bslash;n&quot;
comma
id|mf_current_side
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
(paren
id|off
op_plus
id|count
)paren
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
id|len
op_sub_assign
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|proc_mf_change_side
r_static
r_int
id|proc_mf_change_side
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_char
id|stkbuf
(braket
l_int|10
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
(paren
r_sizeof
(paren
id|stkbuf
)paren
op_minus
l_int|1
)paren
)paren
id|count
op_assign
r_sizeof
(paren
id|stkbuf
)paren
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|stkbuf
comma
id|buffer
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|stkbuf
(braket
id|count
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|stkbuf
op_ne
l_char|&squot;A&squot;
)paren
op_logical_and
(paren
op_star
id|stkbuf
op_ne
l_char|&squot;B&squot;
)paren
op_logical_and
(paren
op_star
id|stkbuf
op_ne
l_char|&squot;C&squot;
)paren
op_logical_and
(paren
op_star
id|stkbuf
op_ne
l_char|&squot;D&squot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mf_proc.c: proc_mf_change_side: invalid side&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|mf_setSide
c_func
(paren
op_star
id|stkbuf
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|proc_mf_dump_src
r_static
r_int
id|proc_mf_dump_src
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|len
suffix:semicolon
id|mf_getSrcHistory
c_func
(paren
id|page
comma
id|count
)paren
suffix:semicolon
id|len
op_assign
id|count
suffix:semicolon
id|len
op_sub_assign
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|count
)paren
(brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|len
op_assign
id|count
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|proc_mf_change_src
r_static
r_int
id|proc_mf_change_src
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_char
id|stkbuf
(braket
l_int|10
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
OL
l_int|4
)paren
op_logical_and
(paren
id|count
op_ne
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mf_proc: invalid src&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
OG
(paren
r_sizeof
(paren
id|stkbuf
)paren
op_minus
l_int|1
)paren
)paren
id|count
op_assign
r_sizeof
(paren
id|stkbuf
)paren
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|stkbuf
comma
id|buffer
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
op_eq
l_int|1
)paren
op_logical_and
(paren
op_star
id|stkbuf
op_eq
l_char|&squot;&bslash;0&squot;
)paren
)paren
id|mf_clearSrc
c_func
(paren
)paren
suffix:semicolon
r_else
id|mf_displaySrc
c_func
(paren
op_star
(paren
id|u32
op_star
)paren
id|stkbuf
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|proc_mf_change_cmdline
r_static
r_int
id|proc_mf_change_cmdline
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|mf_setCmdLine
c_func
(paren
id|buffer
comma
id|count
comma
(paren
id|u64
)paren
id|data
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|proc_mf_change_vmlinux
r_static
id|ssize_t
id|proc_mf_change_vmlinux
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|file-&gt;f_dentry-&gt;d_inode
suffix:semicolon
r_struct
id|proc_dir_entry
op_star
id|dp
op_assign
id|PDE
c_func
(paren
id|inode
)paren
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|rc
op_assign
id|mf_setVmlinuxChunk
c_func
(paren
id|buf
comma
id|count
comma
op_star
id|ppos
comma
(paren
id|u64
)paren
id|dp-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
op_star
id|ppos
op_add_assign
id|count
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|variable|proc_vmlinux_operations
r_static
r_struct
id|file_operations
id|proc_vmlinux_operations
op_assign
(brace
dot
id|write
op_assign
id|proc_mf_change_vmlinux
comma
)brace
suffix:semicolon
DECL|function|mf_proc_init
r_static
r_int
id|__init
id|mf_proc_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|mf_proc_root
suffix:semicolon
r_struct
id|proc_dir_entry
op_star
id|ent
suffix:semicolon
r_struct
id|proc_dir_entry
op_star
id|mf
suffix:semicolon
r_char
id|name
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|mf_proc_root
op_assign
id|proc_mkdir
c_func
(paren
l_string|&quot;iSeries/mf&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mf_proc_root
)paren
r_return
l_int|1
suffix:semicolon
id|name
(braket
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|name
(braket
l_int|0
)braket
op_assign
l_char|&squot;A&squot;
op_plus
id|i
suffix:semicolon
id|mf
op_assign
id|proc_mkdir
c_func
(paren
id|name
comma
id|mf_proc_root
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mf
)paren
r_return
l_int|1
suffix:semicolon
id|ent
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;cmdline&quot;
comma
id|S_IFREG
op_or
id|S_IRUSR
op_or
id|S_IWUSR
comma
id|mf
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ent
)paren
r_return
l_int|1
suffix:semicolon
id|ent-&gt;nlink
op_assign
l_int|1
suffix:semicolon
id|ent-&gt;data
op_assign
(paren
r_void
op_star
)paren
(paren
r_int
)paren
id|i
suffix:semicolon
id|ent-&gt;read_proc
op_assign
id|proc_mf_dump_cmdline
suffix:semicolon
id|ent-&gt;write_proc
op_assign
id|proc_mf_change_cmdline
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|3
)paren
multiline_comment|/* no vmlinux entry for &squot;D&squot; */
r_continue
suffix:semicolon
id|ent
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;vmlinux&quot;
comma
id|S_IFREG
op_or
id|S_IWUSR
comma
id|mf
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ent
)paren
r_return
l_int|1
suffix:semicolon
id|ent-&gt;nlink
op_assign
l_int|1
suffix:semicolon
id|ent-&gt;data
op_assign
(paren
r_void
op_star
)paren
(paren
r_int
)paren
id|i
suffix:semicolon
id|ent-&gt;proc_fops
op_assign
op_amp
id|proc_vmlinux_operations
suffix:semicolon
)brace
id|ent
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;side&quot;
comma
id|S_IFREG
op_or
id|S_IRUSR
op_or
id|S_IWUSR
comma
id|mf_proc_root
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ent
)paren
r_return
l_int|1
suffix:semicolon
id|ent-&gt;nlink
op_assign
l_int|1
suffix:semicolon
id|ent-&gt;data
op_assign
(paren
r_void
op_star
)paren
l_int|0
suffix:semicolon
id|ent-&gt;read_proc
op_assign
id|proc_mf_dump_side
suffix:semicolon
id|ent-&gt;write_proc
op_assign
id|proc_mf_change_side
suffix:semicolon
id|ent
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;src&quot;
comma
id|S_IFREG
op_or
id|S_IRUSR
op_or
id|S_IWUSR
comma
id|mf_proc_root
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ent
)paren
r_return
l_int|1
suffix:semicolon
id|ent-&gt;nlink
op_assign
l_int|1
suffix:semicolon
id|ent-&gt;data
op_assign
(paren
r_void
op_star
)paren
l_int|0
suffix:semicolon
id|ent-&gt;read_proc
op_assign
id|proc_mf_dump_src
suffix:semicolon
id|ent-&gt;write_proc
op_assign
id|proc_mf_change_src
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|mf_proc_init
id|__initcall
c_func
(paren
id|mf_proc_init
)paren
suffix:semicolon
eof
