multiline_comment|/*&n;  * mf.c&n;  * Copyright (C) 2001 Troy D. Armstrong  IBM Corporation&n;  *&n;  * This modules exists as an interface between a Linux secondary partition&n;  * running on an iSeries and the primary partition&squot;s Virtual Service&n;  * Processor (VSP) object.  The VSP has final authority over powering on/off&n;  * all partitions in the iSeries.  It also provides miscellaneous low-level&n;  * machine facility type operations.&n;  *&n;  * &n;  * This program is free software; you can redistribute it and/or modify&n;  * it under the terms of the GNU General Public License as published by&n;  * the Free Software Foundation; either version 2 of the License, or&n;  * (at your option) any later version.&n;  * &n;  * This program is distributed in the hope that it will be useful,&n;  * but WITHOUT ANY WARRANTY; without even the implied warranty of&n;  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;  * GNU General Public License for more details.&n;  * &n;  * You should have received a copy of the GNU General Public License&n;  * along with this program; if not, write to the Free Software&n;  * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n;  */
macro_line|#include &lt;asm/iSeries/mf.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/iSeries/HvLpConfig.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/nvram.h&gt;
macro_line|#include &lt;asm/time.h&gt;
macro_line|#include &lt;asm/iSeries/ItSpCommArea.h&gt;
macro_line|#include &lt;asm/iSeries/mf_proc.h&gt;
macro_line|#include &lt;asm/iSeries/iSeries_proc.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
r_extern
r_struct
id|pci_dev
op_star
id|iSeries_vio_dev
suffix:semicolon
multiline_comment|/*&n; * This is the structure layout for the Machine Facilites LPAR event&n; * flows.&n; */
r_struct
id|VspCmdData
suffix:semicolon
r_struct
id|CeMsgData
suffix:semicolon
DECL|union|SafeCast
r_union
id|SafeCast
(brace
DECL|member|ptrAsU64
id|u64
id|ptrAsU64
suffix:semicolon
DECL|member|ptr
r_void
op_star
id|ptr
suffix:semicolon
)brace
suffix:semicolon
DECL|typedef|CeMsgCompleteHandler
r_typedef
r_void
(paren
op_star
id|CeMsgCompleteHandler
)paren
(paren
r_void
op_star
id|token
comma
r_struct
id|CeMsgData
op_star
id|vspCmdRsp
)paren
suffix:semicolon
DECL|struct|CeMsgCompleteData
r_struct
id|CeMsgCompleteData
(brace
DECL|member|xHdlr
id|CeMsgCompleteHandler
id|xHdlr
suffix:semicolon
DECL|member|xToken
r_void
op_star
id|xToken
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|VspRspData
r_struct
id|VspRspData
(brace
DECL|member|xSemaphore
r_struct
id|semaphore
op_star
id|xSemaphore
suffix:semicolon
DECL|member|xResponse
r_struct
id|VspCmdData
op_star
id|xResponse
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|IoMFLpEvent
r_struct
id|IoMFLpEvent
(brace
DECL|member|xHvLpEvent
r_struct
id|HvLpEvent
id|xHvLpEvent
suffix:semicolon
DECL|member|xSubtypeRc
id|u16
id|xSubtypeRc
suffix:semicolon
DECL|member|xRsvd1
id|u16
id|xRsvd1
suffix:semicolon
DECL|member|xRsvd2
id|u32
id|xRsvd2
suffix:semicolon
r_union
(brace
DECL|struct|AllocData
r_struct
id|AllocData
(brace
DECL|member|xSize
id|u16
id|xSize
suffix:semicolon
DECL|member|xType
id|u16
id|xType
suffix:semicolon
DECL|member|xCount
id|u32
id|xCount
suffix:semicolon
DECL|member|xRsvd3
id|u16
id|xRsvd3
suffix:semicolon
DECL|member|xRsvd4
id|u8
id|xRsvd4
suffix:semicolon
DECL|member|xTargetLp
id|HvLpIndex
id|xTargetLp
suffix:semicolon
DECL|member|xAllocData
)brace
id|xAllocData
suffix:semicolon
DECL|struct|CeMsgData
r_struct
id|CeMsgData
(brace
DECL|member|xCEMsg
id|u8
id|xCEMsg
(braket
l_int|12
)braket
suffix:semicolon
DECL|member|xReserved
r_char
id|xReserved
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|xToken
r_struct
id|CeMsgCompleteData
op_star
id|xToken
suffix:semicolon
DECL|member|xCEMsgData
)brace
id|xCEMsgData
suffix:semicolon
DECL|struct|VspCmdData
r_struct
id|VspCmdData
(brace
DECL|member|xTokenUnion
r_union
id|SafeCast
id|xTokenUnion
suffix:semicolon
DECL|member|xCmd
id|u16
id|xCmd
suffix:semicolon
DECL|member|xLpIndex
id|HvLpIndex
id|xLpIndex
suffix:semicolon
DECL|member|xRc
id|u8
id|xRc
suffix:semicolon
DECL|member|xReserved1
id|u32
id|xReserved1
suffix:semicolon
DECL|union|VspCmdSubData
r_union
id|VspCmdSubData
(brace
r_struct
(brace
DECL|member|xState
id|u64
id|xState
suffix:semicolon
DECL|member|xGetStateOut
)brace
id|xGetStateOut
suffix:semicolon
r_struct
(brace
DECL|member|xIplType
id|u64
id|xIplType
suffix:semicolon
DECL|member|xGetIplTypeOut
DECL|member|xFunction02SelectIplTypeIn
)brace
id|xGetIplTypeOut
comma
id|xFunction02SelectIplTypeIn
suffix:semicolon
r_struct
(brace
DECL|member|xIplMode
id|u64
id|xIplMode
suffix:semicolon
DECL|member|xGetIplModeOut
DECL|member|xFunction02SelectIplModeIn
)brace
id|xGetIplModeOut
comma
id|xFunction02SelectIplModeIn
suffix:semicolon
r_struct
(brace
DECL|member|xPage
id|u64
id|xPage
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|xGetSrcHistoryIn
)brace
id|xGetSrcHistoryIn
suffix:semicolon
r_struct
(brace
DECL|member|xFlag
id|u64
id|xFlag
suffix:semicolon
DECL|member|xGetAutoIplWhenPrimaryIplsOut
)brace
id|xGetAutoIplWhenPrimaryIplsOut
comma
DECL|member|xSetAutoIplWhenPrimaryIplsIn
id|xSetAutoIplWhenPrimaryIplsIn
comma
DECL|member|xWhiteButtonPowerOffIn
id|xWhiteButtonPowerOffIn
comma
DECL|member|xFunction08FastPowerOffIn
id|xFunction08FastPowerOffIn
comma
DECL|member|xIsSpcnRackPowerIncompleteOut
id|xIsSpcnRackPowerIncompleteOut
suffix:semicolon
r_struct
(brace
DECL|member|xToken
id|u64
id|xToken
suffix:semicolon
DECL|member|xAddressType
id|u64
id|xAddressType
suffix:semicolon
DECL|member|xSide
id|u64
id|xSide
suffix:semicolon
DECL|member|xTransferLength
id|u32
id|xTransferLength
suffix:semicolon
DECL|member|xOffset
id|u32
id|xOffset
suffix:semicolon
DECL|member|xSetKernelImageIn
)brace
id|xSetKernelImageIn
comma
DECL|member|xGetKernelImageIn
id|xGetKernelImageIn
comma
DECL|member|xSetKernelCmdLineIn
id|xSetKernelCmdLineIn
comma
DECL|member|xGetKernelCmdLineIn
id|xGetKernelCmdLineIn
suffix:semicolon
r_struct
(brace
DECL|member|xTransferLength
id|u32
id|xTransferLength
suffix:semicolon
DECL|member|xGetKernelImageOut
DECL|member|xGetKernelCmdLineOut
)brace
id|xGetKernelImageOut
comma
id|xGetKernelCmdLineOut
suffix:semicolon
DECL|member|xReserved2
id|u8
id|xReserved2
(braket
l_int|80
)braket
suffix:semicolon
DECL|member|xSubData
)brace
id|xSubData
suffix:semicolon
DECL|member|xVspCmd
)brace
id|xVspCmd
suffix:semicolon
DECL|member|xUnion
)brace
id|xUnion
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * All outgoing event traffic is kept on a FIFO queue.  The first&n; * pointer points to the one that is outstanding, and all new&n; * requests get stuck on the end.  Also, we keep a certain number of&n; * preallocated stack elements so that we can operate very early in&n; * the boot up sequence (before kmalloc is ready).&n; */
DECL|struct|StackElement
r_struct
id|StackElement
(brace
DECL|member|next
r_struct
id|StackElement
op_star
id|next
suffix:semicolon
DECL|member|event
r_struct
id|IoMFLpEvent
id|event
suffix:semicolon
DECL|member|hdlr
id|MFCompleteHandler
id|hdlr
suffix:semicolon
DECL|member|dmaData
r_char
id|dmaData
(braket
l_int|72
)braket
suffix:semicolon
DECL|member|dmaDataLength
r_int
id|dmaDataLength
suffix:semicolon
DECL|member|remoteAddress
r_int
id|remoteAddress
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|spinlock
r_static
id|spinlock_t
id|spinlock
suffix:semicolon
DECL|variable|head
r_static
r_struct
id|StackElement
op_star
id|head
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|tail
r_static
r_struct
id|StackElement
op_star
id|tail
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|avail
r_static
r_struct
id|StackElement
op_star
id|avail
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|prealloc
r_static
r_struct
id|StackElement
id|prealloc
(braket
l_int|16
)braket
suffix:semicolon
multiline_comment|/*&n; * Put a stack element onto the available queue, so it can get reused.&n; * Attention! You must have the spinlock before calling!&n; */
DECL|function|free
r_void
id|free
c_func
(paren
r_struct
id|StackElement
op_star
id|element
)paren
(brace
r_if
c_cond
(paren
id|element
op_ne
l_int|NULL
)paren
(brace
id|element-&gt;next
op_assign
id|avail
suffix:semicolon
id|avail
op_assign
id|element
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Enqueue the outbound event onto the stack.  If the queue was&n; * empty to begin with, we must also issue it via the Hypervisor&n; * interface.  There is a section of code below that will touch&n; * the first stack pointer without the protection of the spinlock.&n; * This is OK, because we know that nobody else will be modifying&n; * the first pointer when we do this.&n; */
DECL|function|signalEvent
r_static
r_int
id|signalEvent
c_func
(paren
r_struct
id|StackElement
op_star
id|newElement
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|go
op_assign
l_int|1
suffix:semicolon
r_struct
id|StackElement
op_star
id|element
suffix:semicolon
id|HvLpEvent_Rc
id|hvRc
suffix:semicolon
multiline_comment|/* enqueue the event */
r_if
c_cond
(paren
id|newElement
op_ne
l_int|NULL
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|head
op_eq
l_int|NULL
)paren
id|head
op_assign
id|newElement
suffix:semicolon
r_else
(brace
id|go
op_assign
l_int|0
suffix:semicolon
id|tail-&gt;next
op_assign
id|newElement
suffix:semicolon
)brace
id|newElement-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|tail
op_assign
id|newElement
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|spinlock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* send the event */
r_while
c_loop
(paren
id|go
)paren
(brace
id|go
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* any DMA data to send beforehand? */
r_if
c_cond
(paren
id|head-&gt;dmaDataLength
OG
l_int|0
)paren
id|HvCallEvent_dmaToSp
c_func
(paren
id|head-&gt;dmaData
comma
id|head-&gt;remoteAddress
comma
id|head-&gt;dmaDataLength
comma
id|HvLpDma_Direction_LocalToRemote
)paren
suffix:semicolon
id|hvRc
op_assign
id|HvCallEvent_signalLpEvent
c_func
(paren
op_amp
id|head-&gt;event.xHvLpEvent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hvRc
op_ne
id|HvLpEvent_Rc_Good
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mf.c: HvCallEvent_signalLpEvent() failed with %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|hvRc
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|spinlock
comma
id|flags
)paren
suffix:semicolon
id|element
op_assign
id|head
suffix:semicolon
id|head
op_assign
id|head-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|head
op_ne
l_int|NULL
)paren
id|go
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|element
op_eq
id|newElement
)paren
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|element-&gt;hdlr
op_ne
l_int|NULL
)paren
(brace
r_union
id|SafeCast
id|mySafeCast
suffix:semicolon
id|mySafeCast.ptrAsU64
op_assign
id|element-&gt;event.xHvLpEvent.xCorrelationToken
suffix:semicolon
(paren
op_star
id|element-&gt;hdlr
)paren
(paren
id|mySafeCast.ptr
comma
op_minus
id|EIO
)paren
suffix:semicolon
)brace
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|spinlock
comma
id|flags
)paren
suffix:semicolon
id|free
c_func
(paren
id|element
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|spinlock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Allocate a new StackElement structure, and initialize it.&n; */
DECL|function|newStackElement
r_static
r_struct
id|StackElement
op_star
id|newStackElement
c_func
(paren
r_void
)paren
(brace
r_struct
id|StackElement
op_star
id|newElement
op_assign
l_int|NULL
suffix:semicolon
id|HvLpIndex
id|primaryLp
op_assign
id|HvLpConfig_getPrimaryLpIndex
c_func
(paren
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|newElement
op_eq
l_int|NULL
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|avail
op_ne
l_int|NULL
)paren
(brace
id|newElement
op_assign
id|avail
suffix:semicolon
id|avail
op_assign
id|avail-&gt;next
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|spinlock
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|newElement
op_eq
l_int|NULL
)paren
id|newElement
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|StackElement
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|newElement
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mf.c: unable to kmalloc %ld bytes&bslash;n&quot;
comma
r_sizeof
(paren
r_struct
id|StackElement
)paren
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|newElement
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|StackElement
)paren
)paren
suffix:semicolon
id|newElement-&gt;event.xHvLpEvent.xFlags.xValid
op_assign
l_int|1
suffix:semicolon
id|newElement-&gt;event.xHvLpEvent.xFlags.xAckType
op_assign
id|HvLpEvent_AckType_ImmediateAck
suffix:semicolon
id|newElement-&gt;event.xHvLpEvent.xFlags.xAckInd
op_assign
id|HvLpEvent_AckInd_DoAck
suffix:semicolon
id|newElement-&gt;event.xHvLpEvent.xFlags.xFunction
op_assign
id|HvLpEvent_Function_Int
suffix:semicolon
id|newElement-&gt;event.xHvLpEvent.xType
op_assign
id|HvLpEvent_Type_MachineFac
suffix:semicolon
id|newElement-&gt;event.xHvLpEvent.xSourceLp
op_assign
id|HvLpConfig_getLpIndex
c_func
(paren
)paren
suffix:semicolon
id|newElement-&gt;event.xHvLpEvent.xTargetLp
op_assign
id|primaryLp
suffix:semicolon
id|newElement-&gt;event.xHvLpEvent.xSizeMinus1
op_assign
r_sizeof
(paren
id|newElement-&gt;event
)paren
op_minus
l_int|1
suffix:semicolon
id|newElement-&gt;event.xHvLpEvent.xRc
op_assign
id|HvLpEvent_Rc_Good
suffix:semicolon
id|newElement-&gt;event.xHvLpEvent.xSourceInstanceId
op_assign
id|HvCallEvent_getSourceLpInstanceId
c_func
(paren
id|primaryLp
comma
id|HvLpEvent_Type_MachineFac
)paren
suffix:semicolon
id|newElement-&gt;event.xHvLpEvent.xTargetInstanceId
op_assign
id|HvCallEvent_getTargetLpInstanceId
c_func
(paren
id|primaryLp
comma
id|HvLpEvent_Type_MachineFac
)paren
suffix:semicolon
r_return
id|newElement
suffix:semicolon
)brace
DECL|function|signalVspInstruction
r_static
r_int
id|signalVspInstruction
c_func
(paren
r_struct
id|VspCmdData
op_star
id|vspCmd
)paren
(brace
r_struct
id|StackElement
op_star
id|newElement
op_assign
id|newStackElement
c_func
(paren
)paren
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|VspRspData
id|response
suffix:semicolon
id|DECLARE_MUTEX_LOCKED
c_func
(paren
id|Semaphore
)paren
suffix:semicolon
id|response.xSemaphore
op_assign
op_amp
id|Semaphore
suffix:semicolon
id|response.xResponse
op_assign
id|vspCmd
suffix:semicolon
r_if
c_cond
(paren
id|newElement
op_eq
l_int|NULL
)paren
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_else
(brace
id|newElement-&gt;event.xHvLpEvent.xSubtype
op_assign
l_int|6
suffix:semicolon
id|newElement-&gt;event.xHvLpEvent.x.xSubtypeData
op_assign
(paren
l_char|&squot;M&squot;
op_lshift
l_int|24
)paren
op_plus
(paren
l_char|&squot;F&squot;
op_lshift
l_int|16
)paren
op_plus
(paren
l_char|&squot;V&squot;
op_lshift
l_int|8
)paren
op_plus
(paren
l_char|&squot;I&squot;
op_lshift
l_int|0
)paren
suffix:semicolon
id|newElement-&gt;event.xUnion.xVspCmd.xTokenUnion.ptr
op_assign
op_amp
id|response
suffix:semicolon
id|newElement-&gt;event.xUnion.xVspCmd.xCmd
op_assign
id|vspCmd-&gt;xCmd
suffix:semicolon
id|newElement-&gt;event.xUnion.xVspCmd.xLpIndex
op_assign
id|HvLpConfig_getLpIndex
c_func
(paren
)paren
suffix:semicolon
id|newElement-&gt;event.xUnion.xVspCmd.xRc
op_assign
l_int|0xFF
suffix:semicolon
id|newElement-&gt;event.xUnion.xVspCmd.xReserved1
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
(paren
id|newElement-&gt;event.xUnion.xVspCmd.xSubData
)paren
comma
op_amp
(paren
id|vspCmd-&gt;xSubData
)paren
comma
r_sizeof
(paren
id|vspCmd-&gt;xSubData
)paren
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|rc
op_assign
id|signalEvent
c_func
(paren
id|newElement
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|down
c_func
(paren
op_amp
id|Semaphore
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Send a 12-byte CE message to the primary partition VSP object&n; */
DECL|function|signalCEMsg
r_static
r_int
id|signalCEMsg
c_func
(paren
r_char
op_star
id|ceMsg
comma
r_void
op_star
id|token
)paren
(brace
r_struct
id|StackElement
op_star
id|newElement
op_assign
id|newStackElement
c_func
(paren
)paren
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|newElement
op_eq
l_int|NULL
)paren
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_else
(brace
id|newElement-&gt;event.xHvLpEvent.xSubtype
op_assign
l_int|0
suffix:semicolon
id|newElement-&gt;event.xHvLpEvent.x.xSubtypeData
op_assign
(paren
l_char|&squot;M&squot;
op_lshift
l_int|24
)paren
op_plus
(paren
l_char|&squot;F&squot;
op_lshift
l_int|16
)paren
op_plus
(paren
l_char|&squot;C&squot;
op_lshift
l_int|8
)paren
op_plus
(paren
l_char|&squot;E&squot;
op_lshift
l_int|0
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|newElement-&gt;event.xUnion.xCEMsgData.xCEMsg
comma
id|ceMsg
comma
l_int|12
)paren
suffix:semicolon
id|newElement-&gt;event.xUnion.xCEMsgData.xToken
op_assign
id|token
suffix:semicolon
id|rc
op_assign
id|signalEvent
c_func
(paren
id|newElement
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Send a 12-byte CE message and DMA data to the primary partition VSP object&n; */
DECL|function|dmaAndSignalCEMsg
r_static
r_int
id|dmaAndSignalCEMsg
c_func
(paren
r_char
op_star
id|ceMsg
comma
r_void
op_star
id|token
comma
r_void
op_star
id|dmaData
comma
r_int
id|dmaDataLength
comma
r_int
id|remoteAddress
)paren
(brace
r_struct
id|StackElement
op_star
id|newElement
op_assign
id|newStackElement
c_func
(paren
)paren
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|newElement
op_eq
l_int|NULL
)paren
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_else
(brace
id|newElement-&gt;event.xHvLpEvent.xSubtype
op_assign
l_int|0
suffix:semicolon
id|newElement-&gt;event.xHvLpEvent.x.xSubtypeData
op_assign
(paren
l_char|&squot;M&squot;
op_lshift
l_int|24
)paren
op_plus
(paren
l_char|&squot;F&squot;
op_lshift
l_int|16
)paren
op_plus
(paren
l_char|&squot;C&squot;
op_lshift
l_int|8
)paren
op_plus
(paren
l_char|&squot;E&squot;
op_lshift
l_int|0
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|newElement-&gt;event.xUnion.xCEMsgData.xCEMsg
comma
id|ceMsg
comma
l_int|12
)paren
suffix:semicolon
id|newElement-&gt;event.xUnion.xCEMsgData.xToken
op_assign
id|token
suffix:semicolon
id|memcpy
c_func
(paren
id|newElement-&gt;dmaData
comma
id|dmaData
comma
id|dmaDataLength
)paren
suffix:semicolon
id|newElement-&gt;dmaDataLength
op_assign
id|dmaDataLength
suffix:semicolon
id|newElement-&gt;remoteAddress
op_assign
id|remoteAddress
suffix:semicolon
id|rc
op_assign
id|signalEvent
c_func
(paren
id|newElement
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Initiate a nice (hopefully) shutdown of Linux.  We simply are&n; * going to try and send the init process a SIGINT signal.  If&n; * this fails (why?), we&squot;ll simply force it off in a not-so-nice&n; * manner.&n; */
DECL|function|shutdown
r_static
r_int
id|shutdown
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
op_assign
id|kill_proc
c_func
(paren
l_int|1
comma
id|SIGINT
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;mf.c: SIGINT to init failed (%d), hard shutdown commencing&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|mf_powerOff
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;mf.c: init has been successfully notified to proceed with shutdown&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * The primary partition VSP object is sending us a new&n; * event flow.  Handle it...&n; */
DECL|function|intReceived
r_static
r_void
id|intReceived
c_func
(paren
r_struct
id|IoMFLpEvent
op_star
id|event
)paren
(brace
r_int
id|freeIt
op_assign
l_int|0
suffix:semicolon
r_struct
id|StackElement
op_star
id|two
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* ack the interrupt */
id|event-&gt;xHvLpEvent.xRc
op_assign
id|HvLpEvent_Rc_Good
suffix:semicolon
id|HvCallEvent_ackLpEvent
c_func
(paren
op_amp
id|event-&gt;xHvLpEvent
)paren
suffix:semicolon
multiline_comment|/* process interrupt */
r_switch
c_cond
(paren
id|event-&gt;xHvLpEvent.xSubtype
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* CE message */
r_switch
c_cond
(paren
id|event-&gt;xUnion.xCEMsgData.xCEMsg
(braket
l_int|3
)braket
)paren
(brace
r_case
l_int|0x5B
suffix:colon
multiline_comment|/* power control notification */
r_if
c_cond
(paren
(paren
id|event-&gt;xUnion.xCEMsgData.xCEMsg
(braket
l_int|5
)braket
op_amp
l_int|0x20
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;mf.c: Commencing partition shutdown&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|shutdown
c_func
(paren
)paren
op_eq
l_int|0
)paren
id|signalCEMsg
c_func
(paren
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;xDB&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0xC0
suffix:colon
multiline_comment|/* get time */
(brace
r_if
c_cond
(paren
(paren
id|head
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|head-&gt;event.xUnion.xCEMsgData.xCEMsg
(braket
l_int|3
)braket
op_eq
l_int|0x40
)paren
)paren
(brace
id|freeIt
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|head-&gt;event.xUnion.xCEMsgData.xToken
op_ne
l_int|0
)paren
(brace
id|CeMsgCompleteHandler
id|xHdlr
op_assign
id|head-&gt;event.xUnion.xCEMsgData.xToken-&gt;xHdlr
suffix:semicolon
r_void
op_star
id|token
op_assign
id|head-&gt;event.xUnion.xCEMsgData.xToken-&gt;xToken
suffix:semicolon
r_if
c_cond
(paren
id|xHdlr
op_ne
l_int|NULL
)paren
(paren
op_star
id|xHdlr
)paren
(paren
id|token
comma
op_amp
(paren
id|event-&gt;xUnion.xCEMsgData
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/* remove from queue */
r_if
c_cond
(paren
id|freeIt
op_eq
l_int|1
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|head
op_ne
l_int|NULL
)paren
(brace
r_struct
id|StackElement
op_star
id|oldHead
op_assign
id|head
suffix:semicolon
id|head
op_assign
id|head-&gt;next
suffix:semicolon
id|two
op_assign
id|head
suffix:semicolon
id|free
c_func
(paren
id|oldHead
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|spinlock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* send next waiting event */
r_if
c_cond
(paren
id|two
op_ne
l_int|NULL
)paren
id|signalEvent
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* IT sys shutdown */
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;mf.c: Commencing system shutdown&bslash;n&quot;
)paren
suffix:semicolon
id|shutdown
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * The primary partition VSP object is acknowledging the receipt&n; * of a flow we sent to them.  If there are other flows queued&n; * up, we must send another one now...&n; */
DECL|function|ackReceived
r_static
r_void
id|ackReceived
c_func
(paren
r_struct
id|IoMFLpEvent
op_star
id|event
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|StackElement
op_star
id|two
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|freeIt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* handle current event */
r_if
c_cond
(paren
id|head
op_ne
l_int|NULL
)paren
(brace
r_switch
c_cond
(paren
id|event-&gt;xHvLpEvent.xSubtype
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* CE msg */
r_if
c_cond
(paren
id|event-&gt;xUnion.xCEMsgData.xCEMsg
(braket
l_int|3
)braket
op_eq
l_int|0x40
)paren
(brace
r_if
c_cond
(paren
id|event-&gt;xUnion.xCEMsgData.xCEMsg
(braket
l_int|2
)braket
op_ne
l_int|0
)paren
(brace
id|freeIt
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|head-&gt;event.xUnion.xCEMsgData.xToken
op_ne
l_int|0
)paren
(brace
id|CeMsgCompleteHandler
id|xHdlr
op_assign
id|head-&gt;event.xUnion.xCEMsgData.xToken-&gt;xHdlr
suffix:semicolon
r_void
op_star
id|token
op_assign
id|head-&gt;event.xUnion.xCEMsgData.xToken-&gt;xToken
suffix:semicolon
r_if
c_cond
(paren
id|xHdlr
op_ne
l_int|NULL
)paren
(paren
op_star
id|xHdlr
)paren
(paren
id|token
comma
op_amp
(paren
id|event-&gt;xUnion.xCEMsgData
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|freeIt
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
multiline_comment|/* allocate */
r_case
l_int|5
suffix:colon
multiline_comment|/* deallocate */
r_if
c_cond
(paren
id|head-&gt;hdlr
op_ne
l_int|NULL
)paren
(brace
r_union
id|SafeCast
id|mySafeCast
suffix:semicolon
id|mySafeCast.ptrAsU64
op_assign
id|event-&gt;xHvLpEvent.xCorrelationToken
suffix:semicolon
(paren
op_star
id|head-&gt;hdlr
)paren
(paren
id|mySafeCast.ptr
comma
id|event-&gt;xUnion.xAllocData.xCount
)paren
suffix:semicolon
)brace
id|freeIt
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
(brace
r_struct
id|VspRspData
op_star
id|rsp
op_assign
(paren
r_struct
id|VspRspData
op_star
)paren
id|event-&gt;xUnion.xVspCmd.xTokenUnion.ptr
suffix:semicolon
r_if
c_cond
(paren
id|rsp
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|rsp-&gt;xResponse
op_ne
l_int|NULL
)paren
id|memcpy
c_func
(paren
id|rsp-&gt;xResponse
comma
op_amp
(paren
id|event-&gt;xUnion.xVspCmd
)paren
comma
r_sizeof
(paren
id|event-&gt;xUnion.xVspCmd
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rsp-&gt;xSemaphore
op_ne
l_int|NULL
)paren
id|up
c_func
(paren
id|rsp-&gt;xSemaphore
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mf.c: no rsp&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|freeIt
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mf.c: stack empty for receiving ack&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* remove from queue */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|head
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|freeIt
op_eq
l_int|1
)paren
)paren
(brace
r_struct
id|StackElement
op_star
id|oldHead
op_assign
id|head
suffix:semicolon
id|head
op_assign
id|head-&gt;next
suffix:semicolon
id|two
op_assign
id|head
suffix:semicolon
id|free
c_func
(paren
id|oldHead
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|spinlock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* send next waiting event */
r_if
c_cond
(paren
id|two
op_ne
l_int|NULL
)paren
id|signalEvent
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This is the generic event handler we are registering with&n; * the Hypervisor.  Ensure the flows are for us, and then&n; * parse it enough to know if it is an interrupt or an&n; * acknowledge.&n; */
DECL|function|hvHandler
r_static
r_void
id|hvHandler
c_func
(paren
r_struct
id|HvLpEvent
op_star
id|event
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_if
c_cond
(paren
(paren
id|event
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|event-&gt;xType
op_eq
id|HvLpEvent_Type_MachineFac
)paren
)paren
(brace
r_switch
c_cond
(paren
id|event-&gt;xFlags.xFunction
)paren
(brace
r_case
id|HvLpEvent_Function_Ack
suffix:colon
id|ackReceived
c_func
(paren
(paren
r_struct
id|IoMFLpEvent
op_star
)paren
id|event
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HvLpEvent_Function_Int
suffix:colon
id|intReceived
c_func
(paren
(paren
r_struct
id|IoMFLpEvent
op_star
)paren
id|event
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mf.c: non ack/int event received&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mf.c: alien event received&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Global kernel interface to allocate and seed events into the&n; * Hypervisor.&n; */
DECL|function|mf_allocateLpEvents
r_void
id|mf_allocateLpEvents
c_func
(paren
id|HvLpIndex
id|targetLp
comma
id|HvLpEvent_Type
id|type
comma
r_int
id|size
comma
r_int
id|count
comma
id|MFCompleteHandler
id|hdlr
comma
r_void
op_star
id|userToken
)paren
(brace
r_struct
id|StackElement
op_star
id|newElement
op_assign
id|newStackElement
c_func
(paren
)paren
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|newElement
op_eq
l_int|NULL
)paren
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_else
(brace
r_union
id|SafeCast
id|mine
suffix:semicolon
id|mine.ptr
op_assign
id|userToken
suffix:semicolon
id|newElement-&gt;event.xHvLpEvent.xSubtype
op_assign
l_int|4
suffix:semicolon
id|newElement-&gt;event.xHvLpEvent.xCorrelationToken
op_assign
id|mine.ptrAsU64
suffix:semicolon
id|newElement-&gt;event.xHvLpEvent.x.xSubtypeData
op_assign
(paren
l_char|&squot;M&squot;
op_lshift
l_int|24
)paren
op_plus
(paren
l_char|&squot;F&squot;
op_lshift
l_int|16
)paren
op_plus
(paren
l_char|&squot;M&squot;
op_lshift
l_int|8
)paren
op_plus
(paren
l_char|&squot;A&squot;
op_lshift
l_int|0
)paren
suffix:semicolon
id|newElement-&gt;event.xUnion.xAllocData.xTargetLp
op_assign
id|targetLp
suffix:semicolon
id|newElement-&gt;event.xUnion.xAllocData.xType
op_assign
id|type
suffix:semicolon
id|newElement-&gt;event.xUnion.xAllocData.xSize
op_assign
id|size
suffix:semicolon
id|newElement-&gt;event.xUnion.xAllocData.xCount
op_assign
id|count
suffix:semicolon
id|newElement-&gt;hdlr
op_assign
id|hdlr
suffix:semicolon
id|rc
op_assign
id|signalEvent
c_func
(paren
id|newElement
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rc
op_ne
l_int|0
)paren
op_logical_and
(paren
id|hdlr
op_ne
l_int|NULL
)paren
)paren
(paren
op_star
id|hdlr
)paren
(paren
id|userToken
comma
id|rc
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Global kernel interface to unseed and deallocate events already in&n; * Hypervisor.&n; */
DECL|function|mf_deallocateLpEvents
r_void
id|mf_deallocateLpEvents
c_func
(paren
id|HvLpIndex
id|targetLp
comma
id|HvLpEvent_Type
id|type
comma
r_int
id|count
comma
id|MFCompleteHandler
id|hdlr
comma
r_void
op_star
id|userToken
)paren
(brace
r_struct
id|StackElement
op_star
id|newElement
op_assign
id|newStackElement
c_func
(paren
)paren
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|newElement
op_eq
l_int|NULL
)paren
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_else
(brace
r_union
id|SafeCast
id|mine
suffix:semicolon
id|mine.ptr
op_assign
id|userToken
suffix:semicolon
id|newElement-&gt;event.xHvLpEvent.xSubtype
op_assign
l_int|5
suffix:semicolon
id|newElement-&gt;event.xHvLpEvent.xCorrelationToken
op_assign
id|mine.ptrAsU64
suffix:semicolon
id|newElement-&gt;event.xHvLpEvent.x.xSubtypeData
op_assign
(paren
l_char|&squot;M&squot;
op_lshift
l_int|24
)paren
op_plus
(paren
l_char|&squot;F&squot;
op_lshift
l_int|16
)paren
op_plus
(paren
l_char|&squot;M&squot;
op_lshift
l_int|8
)paren
op_plus
(paren
l_char|&squot;D&squot;
op_lshift
l_int|0
)paren
suffix:semicolon
id|newElement-&gt;event.xUnion.xAllocData.xTargetLp
op_assign
id|targetLp
suffix:semicolon
id|newElement-&gt;event.xUnion.xAllocData.xType
op_assign
id|type
suffix:semicolon
id|newElement-&gt;event.xUnion.xAllocData.xCount
op_assign
id|count
suffix:semicolon
id|newElement-&gt;hdlr
op_assign
id|hdlr
suffix:semicolon
id|rc
op_assign
id|signalEvent
c_func
(paren
id|newElement
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rc
op_ne
l_int|0
)paren
op_logical_and
(paren
id|hdlr
op_ne
l_int|NULL
)paren
)paren
(paren
op_star
id|hdlr
)paren
(paren
id|userToken
comma
id|rc
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Global kernel interface to tell the VSP object in the primary&n; * partition to power this partition off.&n; */
DECL|function|mf_powerOff
r_void
id|mf_powerOff
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;mf.c: Down it goes...&bslash;n&quot;
)paren
suffix:semicolon
id|signalCEMsg
c_func
(paren
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x4D&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Global kernel interface to tell the VSP object in the primary&n; * partition to reboot this partition.&n; */
DECL|function|mf_reboot
r_void
id|mf_reboot
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;mf.c: Preparing to bounce...&bslash;n&quot;
)paren
suffix:semicolon
id|signalCEMsg
c_func
(paren
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x4E&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Display a single word SRC onto the VSP control panel.&n; */
DECL|function|mf_displaySrc
r_void
id|mf_displaySrc
c_func
(paren
id|u32
id|word
)paren
(brace
id|u8
id|ce
(braket
l_int|12
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|ce
comma
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x4A&bslash;x00&bslash;x00&bslash;x00&bslash;x01&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
comma
l_int|12
)paren
suffix:semicolon
id|ce
(braket
l_int|8
)braket
op_assign
id|word
op_rshift
l_int|24
suffix:semicolon
id|ce
(braket
l_int|9
)braket
op_assign
id|word
op_rshift
l_int|16
suffix:semicolon
id|ce
(braket
l_int|10
)braket
op_assign
id|word
op_rshift
l_int|8
suffix:semicolon
id|ce
(braket
l_int|11
)braket
op_assign
id|word
suffix:semicolon
id|signalCEMsg
c_func
(paren
id|ce
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Display a single word SRC of the form &quot;PROGXXXX&quot; on the VSP control panel.&n; */
DECL|function|mf_displayProgress
r_void
id|mf_displayProgress
c_func
(paren
id|u16
id|value
)paren
(brace
id|u8
id|ce
(braket
l_int|12
)braket
suffix:semicolon
id|u8
id|src
(braket
l_int|72
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|ce
comma
l_string|&quot;&bslash;x00&bslash;x00&bslash;x04&bslash;x4A&bslash;x00&bslash;x00&bslash;x00&bslash;x48&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
comma
l_int|12
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|src
comma
l_string|&quot;&bslash;x01&bslash;x00&bslash;x00&bslash;x01&quot;
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
l_string|&quot;PROGxxxx&quot;
l_string|&quot;                        &quot;
comma
l_int|72
)paren
suffix:semicolon
id|src
(braket
l_int|6
)braket
op_assign
id|value
op_rshift
l_int|8
suffix:semicolon
id|src
(braket
l_int|7
)braket
op_assign
id|value
op_amp
l_int|255
suffix:semicolon
id|src
(braket
l_int|44
)braket
op_assign
l_string|&quot;0123456789ABCDEF&quot;
(braket
(paren
id|value
op_rshift
l_int|12
)paren
op_amp
l_int|15
)braket
suffix:semicolon
id|src
(braket
l_int|45
)braket
op_assign
l_string|&quot;0123456789ABCDEF&quot;
(braket
(paren
id|value
op_rshift
l_int|8
)paren
op_amp
l_int|15
)braket
suffix:semicolon
id|src
(braket
l_int|46
)braket
op_assign
l_string|&quot;0123456789ABCDEF&quot;
(braket
(paren
id|value
op_rshift
l_int|4
)paren
op_amp
l_int|15
)braket
suffix:semicolon
id|src
(braket
l_int|47
)braket
op_assign
l_string|&quot;0123456789ABCDEF&quot;
(braket
id|value
op_amp
l_int|15
)braket
suffix:semicolon
id|dmaAndSignalCEMsg
c_func
(paren
id|ce
comma
l_int|NULL
comma
id|src
comma
r_sizeof
(paren
id|src
)paren
comma
l_int|9
op_star
l_int|64
op_star
l_int|1024
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Clear the VSP control panel.  Used to &quot;erase&quot; an SRC that was&n; * previously displayed.&n; */
DECL|function|mf_clearSrc
r_void
id|mf_clearSrc
c_func
(paren
r_void
)paren
(brace
id|signalCEMsg
c_func
(paren
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x4B&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialization code here.&n; */
DECL|function|mf_init
r_void
id|mf_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* initialize */
id|spin_lock_init
c_func
(paren
op_amp
id|spinlock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|prealloc
)paren
op_div
r_sizeof
(paren
op_star
id|prealloc
)paren
suffix:semicolon
op_increment
id|i
)paren
id|free
c_func
(paren
op_amp
id|prealloc
(braket
id|i
)braket
)paren
suffix:semicolon
id|HvLpEvent_registerHandler
c_func
(paren
id|HvLpEvent_Type_MachineFac
comma
op_amp
id|hvHandler
)paren
suffix:semicolon
multiline_comment|/* virtual continue ack */
id|signalCEMsg
c_func
(paren
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x57&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* initialization complete */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;mf.c: iSeries Linux LPAR Machine Facilities initialized&bslash;n&quot;
)paren
suffix:semicolon
id|iSeries_proc_callback
c_func
(paren
op_amp
id|mf_proc_init
)paren
suffix:semicolon
)brace
DECL|function|mf_setSide
r_void
id|mf_setSide
c_func
(paren
r_char
id|side
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|u64
id|newSide
op_assign
l_int|0
suffix:semicolon
r_struct
id|VspCmdData
id|myVspCmd
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|myVspCmd
comma
l_int|0
comma
r_sizeof
(paren
id|myVspCmd
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|side
op_eq
l_char|&squot;A&squot;
)paren
id|newSide
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|side
op_eq
l_char|&squot;B&squot;
)paren
id|newSide
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|side
op_eq
l_char|&squot;C&squot;
)paren
id|newSide
op_assign
l_int|2
suffix:semicolon
r_else
id|newSide
op_assign
l_int|3
suffix:semicolon
id|myVspCmd.xSubData.xFunction02SelectIplTypeIn.xIplType
op_assign
id|newSide
suffix:semicolon
id|myVspCmd.xCmd
op_assign
l_int|10
suffix:semicolon
id|rc
op_assign
id|signalVspInstruction
c_func
(paren
op_amp
id|myVspCmd
)paren
suffix:semicolon
)brace
DECL|function|mf_getSide
r_char
id|mf_getSide
c_func
(paren
r_void
)paren
(brace
r_char
id|returnValue
op_assign
l_char|&squot; &squot;
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|VspCmdData
id|myVspCmd
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|myVspCmd
comma
l_int|0
comma
r_sizeof
(paren
id|myVspCmd
)paren
)paren
suffix:semicolon
id|myVspCmd.xCmd
op_assign
l_int|2
suffix:semicolon
id|myVspCmd.xSubData.xFunction02SelectIplTypeIn.xIplType
op_assign
l_int|0
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|rc
op_assign
id|signalVspInstruction
c_func
(paren
op_amp
id|myVspCmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
r_return
id|returnValue
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|myVspCmd.xRc
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|myVspCmd.xSubData.xGetIplTypeOut.xIplType
op_eq
l_int|0
)paren
id|returnValue
op_assign
l_char|&squot;A&squot;
suffix:semicolon
r_else
r_if
c_cond
(paren
id|myVspCmd.xSubData.xGetIplTypeOut.xIplType
op_eq
l_int|1
)paren
id|returnValue
op_assign
l_char|&squot;B&squot;
suffix:semicolon
r_else
r_if
c_cond
(paren
id|myVspCmd.xSubData.xGetIplTypeOut.xIplType
op_eq
l_int|2
)paren
id|returnValue
op_assign
l_char|&squot;C&squot;
suffix:semicolon
r_else
id|returnValue
op_assign
l_char|&squot;D&squot;
suffix:semicolon
)brace
)brace
r_return
id|returnValue
suffix:semicolon
)brace
DECL|function|mf_getSrcHistory
r_void
id|mf_getSrcHistory
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
id|size
)paren
(brace
multiline_comment|/*    struct IplTypeReturnStuff returnStuff;&n;     struct StackElement * newElement = newStackElement();&n;     int rc = 0;&n;     char *pages[4];&n;&n;     pages[0] = kmalloc(4096, GFP_ATOMIC);&n;     pages[1] = kmalloc(4096, GFP_ATOMIC);&n;     pages[2] = kmalloc(4096, GFP_ATOMIC);&n;     pages[3] = kmalloc(4096, GFP_ATOMIC);&n;     if (( newElement == NULL ) || (pages[0] == NULL) || (pages[1] == NULL) || (pages[2] == NULL) || (pages[3] == NULL))&n;     rc = -ENOMEM;&n;     else&n;     {&n;     returnStuff.xType = 0;&n;     returnStuff.xRc = 0;&n;     returnStuff.xDone = 0;&n;     newElement-&gt;event.xHvLpEvent.xSubtype = 6;&n;     newElement-&gt;event.xHvLpEvent.x.xSubtypeData = (&squot;M&squot;&lt;&lt;24)+(&squot;F&squot;&lt;&lt;16)+(&squot;V&squot;&lt;&lt;8)+(&squot;I&squot;&lt;&lt;0);&n;     newElement-&gt;event.xUnion.xVspCmd.xEvent = &amp;returnStuff;&n;     newElement-&gt;event.xUnion.xVspCmd.xCmd = 4;&n;     newElement-&gt;event.xUnion.xVspCmd.xLpIndex = HvLpConfig_getLpIndex();&n;     newElement-&gt;event.xUnion.xVspCmd.xRc = 0xFF;&n;     newElement-&gt;event.xUnion.xVspCmd.xReserved1 = 0;&n;     newElement-&gt;event.xUnion.xVspCmd.xSubData.xGetSrcHistoryIn.xPage[0] = (0x8000000000000000ULL | virt_to_absolute((unsigned long)pages[0]));&n;     newElement-&gt;event.xUnion.xVspCmd.xSubData.xGetSrcHistoryIn.xPage[1] = (0x8000000000000000ULL | virt_to_absolute((unsigned long)pages[1]));&n;     newElement-&gt;event.xUnion.xVspCmd.xSubData.xGetSrcHistoryIn.xPage[2] = (0x8000000000000000ULL | virt_to_absolute((unsigned long)pages[2]));&n;     newElement-&gt;event.xUnion.xVspCmd.xSubData.xGetSrcHistoryIn.xPage[3] = (0x8000000000000000ULL | virt_to_absolute((unsigned long)pages[3]));&n;     mb();&n;     rc = signalEvent(newElement);&n;     }&n;&n;     if (rc != 0)&n;     {&n;     return;&n;     }&n;     else&n;     {&n;     while (returnStuff.xDone != 1)&n;     {&n;     udelay(10);&n;     }&n;&n;     if (returnStuff.xRc == 0)&n;     {&n;     memcpy(buffer, pages[0], size);&n;     }&n;     }&n;&n;     kfree(pages[0]);&n;     kfree(pages[1]);&n;     kfree(pages[2]);&n;     kfree(pages[3]);*/
)brace
DECL|function|mf_setCmdLine
r_void
id|mf_setCmdLine
c_func
(paren
r_const
r_char
op_star
id|cmdline
comma
r_int
id|size
comma
id|u64
id|side
)paren
(brace
r_struct
id|VspCmdData
id|myVspCmd
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|dma_addr_t
id|dma_addr
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|page
op_assign
id|pci_alloc_consistent
c_func
(paren
id|iSeries_vio_dev
comma
id|size
comma
op_amp
id|dma_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mf.c: couldn&squot;t allocate memory to set command line&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|copy_from_user
c_func
(paren
id|page
comma
id|cmdline
comma
id|size
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|myVspCmd
comma
l_int|0
comma
r_sizeof
(paren
id|myVspCmd
)paren
)paren
suffix:semicolon
id|myVspCmd.xCmd
op_assign
l_int|31
suffix:semicolon
id|myVspCmd.xSubData.xSetKernelCmdLineIn.xToken
op_assign
id|dma_addr
suffix:semicolon
id|myVspCmd.xSubData.xSetKernelCmdLineIn.xAddressType
op_assign
id|HvLpDma_AddressType_TceIndex
suffix:semicolon
id|myVspCmd.xSubData.xSetKernelCmdLineIn.xSide
op_assign
id|side
suffix:semicolon
id|myVspCmd.xSubData.xSetKernelCmdLineIn.xTransferLength
op_assign
id|size
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|rc
op_assign
id|signalVspInstruction
c_func
(paren
op_amp
id|myVspCmd
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|iSeries_vio_dev
comma
id|size
comma
id|page
comma
id|dma_addr
)paren
suffix:semicolon
)brace
DECL|function|mf_getCmdLine
r_int
id|mf_getCmdLine
c_func
(paren
r_char
op_star
id|cmdline
comma
r_int
op_star
id|size
comma
id|u64
id|side
)paren
(brace
r_struct
id|VspCmdData
id|myVspCmd
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|len
op_assign
op_star
id|size
suffix:semicolon
id|dma_addr_t
id|dma_addr
op_assign
id|pci_map_single
c_func
(paren
id|iSeries_vio_dev
comma
id|cmdline
comma
op_star
id|size
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|memset
c_func
(paren
id|cmdline
comma
l_int|0
comma
op_star
id|size
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|myVspCmd
comma
l_int|0
comma
r_sizeof
(paren
id|myVspCmd
)paren
)paren
suffix:semicolon
id|myVspCmd.xCmd
op_assign
l_int|33
suffix:semicolon
id|myVspCmd.xSubData.xGetKernelCmdLineIn.xToken
op_assign
id|dma_addr
suffix:semicolon
id|myVspCmd.xSubData.xGetKernelCmdLineIn.xAddressType
op_assign
id|HvLpDma_AddressType_TceIndex
suffix:semicolon
id|myVspCmd.xSubData.xGetKernelCmdLineIn.xSide
op_assign
id|side
suffix:semicolon
id|myVspCmd.xSubData.xGetKernelCmdLineIn.xTransferLength
op_assign
op_star
id|size
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|rc
op_assign
id|signalVspInstruction
c_func
(paren
op_amp
id|myVspCmd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
r_if
c_cond
(paren
id|myVspCmd.xRc
op_eq
l_int|0
)paren
(brace
id|len
op_assign
id|myVspCmd.xSubData.xGetKernelCmdLineOut.xTransferLength
suffix:semicolon
)brace
multiline_comment|/* else&n;&t;&t;&t;{&n;&t;&t;&t;memcpy(cmdline, &quot;Bad cmdline&quot;, 11);&n;&t;&t;&t;}&n;&t;&t;*/
)brace
id|pci_unmap_single
c_func
(paren
id|iSeries_vio_dev
comma
id|dma_addr
comma
op_star
id|size
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|mf_setVmlinuxChunk
r_int
id|mf_setVmlinuxChunk
c_func
(paren
r_const
r_char
op_star
id|buffer
comma
r_int
id|size
comma
r_int
id|offset
comma
id|u64
id|side
)paren
(brace
r_struct
id|VspCmdData
id|myVspCmd
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|dma_addr_t
id|dma_addr
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|page
op_assign
id|pci_alloc_consistent
c_func
(paren
id|iSeries_vio_dev
comma
id|size
comma
op_amp
id|dma_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mf.c: couldn&squot;t allocate memory to set vmlinux chunk&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|copy_from_user
c_func
(paren
id|page
comma
id|buffer
comma
id|size
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|myVspCmd
comma
l_int|0
comma
r_sizeof
(paren
id|myVspCmd
)paren
)paren
suffix:semicolon
id|myVspCmd.xCmd
op_assign
l_int|30
suffix:semicolon
id|myVspCmd.xSubData.xGetKernelImageIn.xToken
op_assign
id|dma_addr
suffix:semicolon
id|myVspCmd.xSubData.xGetKernelImageIn.xAddressType
op_assign
id|HvLpDma_AddressType_TceIndex
suffix:semicolon
id|myVspCmd.xSubData.xGetKernelImageIn.xSide
op_assign
id|side
suffix:semicolon
id|myVspCmd.xSubData.xGetKernelImageIn.xOffset
op_assign
id|offset
suffix:semicolon
id|myVspCmd.xSubData.xGetKernelImageIn.xTransferLength
op_assign
id|size
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|rc
op_assign
id|signalVspInstruction
c_func
(paren
op_amp
id|myVspCmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|myVspCmd.xRc
op_eq
l_int|0
)paren
(brace
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
id|pci_free_consistent
c_func
(paren
id|iSeries_vio_dev
comma
id|size
comma
id|page
comma
id|dma_addr
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|mf_getVmlinuxChunk
r_int
id|mf_getVmlinuxChunk
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
op_star
id|size
comma
r_int
id|offset
comma
id|u64
id|side
)paren
(brace
r_struct
id|VspCmdData
id|myVspCmd
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|len
op_assign
op_star
id|size
suffix:semicolon
id|dma_addr_t
id|dma_addr
op_assign
id|pci_map_single
c_func
(paren
id|iSeries_vio_dev
comma
id|buffer
comma
op_star
id|size
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|memset
c_func
(paren
id|buffer
comma
l_int|0
comma
id|len
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|myVspCmd
comma
l_int|0
comma
r_sizeof
(paren
id|myVspCmd
)paren
)paren
suffix:semicolon
id|myVspCmd.xCmd
op_assign
l_int|32
suffix:semicolon
id|myVspCmd.xSubData.xGetKernelImageIn.xToken
op_assign
id|dma_addr
suffix:semicolon
id|myVspCmd.xSubData.xGetKernelImageIn.xAddressType
op_assign
id|HvLpDma_AddressType_TceIndex
suffix:semicolon
id|myVspCmd.xSubData.xGetKernelImageIn.xSide
op_assign
id|side
suffix:semicolon
id|myVspCmd.xSubData.xGetKernelImageIn.xOffset
op_assign
id|offset
suffix:semicolon
id|myVspCmd.xSubData.xGetKernelImageIn.xTransferLength
op_assign
id|len
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|rc
op_assign
id|signalVspInstruction
c_func
(paren
op_amp
id|myVspCmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|myVspCmd.xRc
op_eq
l_int|0
)paren
(brace
op_star
id|size
op_assign
id|myVspCmd.xSubData.xGetKernelImageOut.xTransferLength
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
id|pci_unmap_single
c_func
(paren
id|iSeries_vio_dev
comma
id|dma_addr
comma
id|len
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|mf_setRtcTime
r_int
id|mf_setRtcTime
c_func
(paren
r_int
r_int
id|time
)paren
(brace
r_struct
id|rtc_time
id|tm
suffix:semicolon
id|to_tm
c_func
(paren
id|time
comma
op_amp
id|tm
)paren
suffix:semicolon
r_return
id|mf_setRtc
c_func
(paren
op_amp
id|tm
)paren
suffix:semicolon
)brace
DECL|struct|RtcTimeData
r_struct
id|RtcTimeData
(brace
DECL|member|xSemaphore
r_struct
id|semaphore
op_star
id|xSemaphore
suffix:semicolon
DECL|member|xCeMsg
r_struct
id|CeMsgData
id|xCeMsg
suffix:semicolon
DECL|member|xRc
r_int
id|xRc
suffix:semicolon
)brace
suffix:semicolon
DECL|function|getRtcTimeComplete
r_void
id|getRtcTimeComplete
c_func
(paren
r_void
op_star
id|token
comma
r_struct
id|CeMsgData
op_star
id|ceMsg
)paren
(brace
r_struct
id|RtcTimeData
op_star
id|rtc
op_assign
(paren
r_struct
id|RtcTimeData
op_star
)paren
id|token
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
(paren
id|rtc-&gt;xCeMsg
)paren
comma
id|ceMsg
comma
r_sizeof
(paren
id|rtc-&gt;xCeMsg
)paren
)paren
suffix:semicolon
id|rtc-&gt;xRc
op_assign
l_int|0
suffix:semicolon
id|up
c_func
(paren
id|rtc-&gt;xSemaphore
)paren
suffix:semicolon
)brace
DECL|variable|lastsec
r_static
r_int
r_int
id|lastsec
op_assign
l_int|1
suffix:semicolon
DECL|function|mf_getRtcTime
r_int
id|mf_getRtcTime
c_func
(paren
r_int
r_int
op_star
id|time
)paren
(brace
multiline_comment|/*    unsigned long usec, tsec; */
id|u32
id|dataWord1
op_assign
op_star
(paren
(paren
id|u32
op_star
)paren
(paren
op_amp
id|xSpCommArea.xBcdTimeAtIplStart
)paren
)paren
suffix:semicolon
id|u32
id|dataWord2
op_assign
op_star
(paren
(paren
(paren
id|u32
op_star
)paren
op_amp
(paren
id|xSpCommArea.xBcdTimeAtIplStart
)paren
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_int
id|year
op_assign
l_int|1970
suffix:semicolon
r_int
id|year1
op_assign
(paren
id|dataWord1
op_rshift
l_int|24
)paren
op_amp
l_int|0x000000FF
suffix:semicolon
r_int
id|year2
op_assign
(paren
id|dataWord1
op_rshift
l_int|16
)paren
op_amp
l_int|0x000000FF
suffix:semicolon
r_int
id|sec
op_assign
(paren
id|dataWord1
op_rshift
l_int|8
)paren
op_amp
l_int|0x000000FF
suffix:semicolon
r_int
id|min
op_assign
id|dataWord1
op_amp
l_int|0x000000FF
suffix:semicolon
r_int
id|hour
op_assign
(paren
id|dataWord2
op_rshift
l_int|24
)paren
op_amp
l_int|0x000000FF
suffix:semicolon
r_int
id|day
op_assign
(paren
id|dataWord2
op_rshift
l_int|8
)paren
op_amp
l_int|0x000000FF
suffix:semicolon
r_int
id|mon
op_assign
id|dataWord2
op_amp
l_int|0x000000FF
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|sec
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|min
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|hour
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|day
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|mon
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|year1
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|year2
)paren
suffix:semicolon
id|year
op_assign
id|year1
op_star
l_int|100
op_plus
id|year2
suffix:semicolon
op_star
id|time
op_assign
id|mktime
c_func
(paren
id|year
comma
id|mon
comma
id|day
comma
id|hour
comma
id|min
comma
id|sec
)paren
suffix:semicolon
op_star
id|time
op_add_assign
(paren
id|jiffies
op_div
id|HZ
)paren
suffix:semicolon
multiline_comment|/* Now THIS is a nasty hack!&n;&t; * It ensures that the first two calls to mf_getRtcTime get different&n;&t; * answers.  That way the loop in init_time (time.c) will not think&n;&t; * the clock is stuck.&n;&t; */
r_if
c_cond
(paren
id|lastsec
)paren
(brace
op_star
id|time
op_sub_assign
id|lastsec
suffix:semicolon
op_decrement
id|lastsec
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mf_getRtc
r_int
id|mf_getRtc
c_func
(paren
r_struct
id|rtc_time
op_star
id|tm
)paren
(brace
r_struct
id|CeMsgCompleteData
id|ceComplete
suffix:semicolon
r_struct
id|RtcTimeData
id|rtcData
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|DECLARE_MUTEX_LOCKED
c_func
(paren
id|Semaphore
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|ceComplete
comma
l_int|0
comma
r_sizeof
(paren
id|ceComplete
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|rtcData
comma
l_int|0
comma
r_sizeof
(paren
id|rtcData
)paren
)paren
suffix:semicolon
id|rtcData.xSemaphore
op_assign
op_amp
id|Semaphore
suffix:semicolon
id|ceComplete.xHdlr
op_assign
op_amp
id|getRtcTimeComplete
suffix:semicolon
id|ceComplete.xToken
op_assign
(paren
r_void
op_star
)paren
op_amp
id|rtcData
suffix:semicolon
id|rc
op_assign
id|signalCEMsg
c_func
(paren
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x40&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
comma
op_amp
id|ceComplete
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|down
c_func
(paren
op_amp
id|Semaphore
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rtcData.xRc
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|rtcData.xCeMsg.xCEMsg
(braket
l_int|2
)braket
op_eq
l_int|0xa9
)paren
op_logical_or
(paren
id|rtcData.xCeMsg.xCEMsg
(braket
l_int|2
)braket
op_eq
l_int|0xaf
)paren
)paren
(brace
multiline_comment|/* TOD clock is not set */
id|tm-&gt;tm_sec
op_assign
l_int|1
suffix:semicolon
id|tm-&gt;tm_min
op_assign
l_int|1
suffix:semicolon
id|tm-&gt;tm_hour
op_assign
l_int|1
suffix:semicolon
id|tm-&gt;tm_mday
op_assign
l_int|10
suffix:semicolon
id|tm-&gt;tm_mon
op_assign
l_int|8
suffix:semicolon
id|tm-&gt;tm_year
op_assign
l_int|71
suffix:semicolon
id|mf_setRtc
c_func
(paren
id|tm
)paren
suffix:semicolon
)brace
(brace
id|u32
id|dataWord1
op_assign
op_star
(paren
(paren
id|u32
op_star
)paren
(paren
id|rtcData.xCeMsg.xCEMsg
op_plus
l_int|4
)paren
)paren
suffix:semicolon
id|u32
id|dataWord2
op_assign
op_star
(paren
(paren
id|u32
op_star
)paren
(paren
id|rtcData.xCeMsg.xCEMsg
op_plus
l_int|8
)paren
)paren
suffix:semicolon
id|u8
id|year
op_assign
(paren
id|dataWord1
op_rshift
l_int|16
)paren
op_amp
l_int|0x000000FF
suffix:semicolon
id|u8
id|sec
op_assign
(paren
id|dataWord1
op_rshift
l_int|8
)paren
op_amp
l_int|0x000000FF
suffix:semicolon
id|u8
id|min
op_assign
id|dataWord1
op_amp
l_int|0x000000FF
suffix:semicolon
id|u8
id|hour
op_assign
(paren
id|dataWord2
op_rshift
l_int|24
)paren
op_amp
l_int|0x000000FF
suffix:semicolon
id|u8
id|day
op_assign
(paren
id|dataWord2
op_rshift
l_int|8
)paren
op_amp
l_int|0x000000FF
suffix:semicolon
id|u8
id|mon
op_assign
id|dataWord2
op_amp
l_int|0x000000FF
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|sec
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|min
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|hour
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|day
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|mon
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|year
)paren
suffix:semicolon
r_if
c_cond
(paren
id|year
op_le
l_int|69
)paren
id|year
op_add_assign
l_int|100
suffix:semicolon
id|tm-&gt;tm_sec
op_assign
id|sec
suffix:semicolon
id|tm-&gt;tm_min
op_assign
id|min
suffix:semicolon
id|tm-&gt;tm_hour
op_assign
id|hour
suffix:semicolon
id|tm-&gt;tm_mday
op_assign
id|day
suffix:semicolon
id|tm-&gt;tm_mon
op_assign
id|mon
suffix:semicolon
id|tm-&gt;tm_year
op_assign
id|year
suffix:semicolon
)brace
)brace
r_else
(brace
id|rc
op_assign
id|rtcData.xRc
suffix:semicolon
id|tm-&gt;tm_sec
op_assign
l_int|0
suffix:semicolon
id|tm-&gt;tm_min
op_assign
l_int|0
suffix:semicolon
id|tm-&gt;tm_hour
op_assign
l_int|0
suffix:semicolon
id|tm-&gt;tm_mday
op_assign
l_int|15
suffix:semicolon
id|tm-&gt;tm_mon
op_assign
l_int|5
suffix:semicolon
id|tm-&gt;tm_year
op_assign
l_int|52
suffix:semicolon
)brace
id|tm-&gt;tm_wday
op_assign
l_int|0
suffix:semicolon
id|tm-&gt;tm_yday
op_assign
l_int|0
suffix:semicolon
id|tm-&gt;tm_isdst
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
DECL|function|mf_setRtc
r_int
id|mf_setRtc
c_func
(paren
r_struct
id|rtc_time
op_star
id|tm
)paren
(brace
r_char
id|ceTime
(braket
l_int|12
)braket
op_assign
l_string|&quot;&bslash;x00&bslash;x00&bslash;x00&bslash;x41&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&bslash;x00&quot;
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|u8
id|day
comma
id|mon
comma
id|hour
comma
id|min
comma
id|sec
comma
id|y1
comma
id|y2
suffix:semicolon
r_int
id|year
suffix:semicolon
id|year
op_assign
l_int|1900
op_plus
id|tm-&gt;tm_year
suffix:semicolon
id|y1
op_assign
id|year
op_div
l_int|100
suffix:semicolon
id|y2
op_assign
id|year
op_mod
l_int|100
suffix:semicolon
id|sec
op_assign
id|tm-&gt;tm_sec
suffix:semicolon
id|min
op_assign
id|tm-&gt;tm_min
suffix:semicolon
id|hour
op_assign
id|tm-&gt;tm_hour
suffix:semicolon
id|day
op_assign
id|tm-&gt;tm_mday
suffix:semicolon
id|mon
op_assign
id|tm-&gt;tm_mon
op_plus
l_int|1
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|sec
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|min
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|hour
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|mon
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|day
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|y1
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|y2
)paren
suffix:semicolon
id|ceTime
(braket
l_int|4
)braket
op_assign
id|y1
suffix:semicolon
id|ceTime
(braket
l_int|5
)braket
op_assign
id|y2
suffix:semicolon
id|ceTime
(braket
l_int|6
)braket
op_assign
id|sec
suffix:semicolon
id|ceTime
(braket
l_int|7
)braket
op_assign
id|min
suffix:semicolon
id|ceTime
(braket
l_int|8
)braket
op_assign
id|hour
suffix:semicolon
id|ceTime
(braket
l_int|10
)braket
op_assign
id|day
suffix:semicolon
id|ceTime
(braket
l_int|11
)braket
op_assign
id|mon
suffix:semicolon
id|rc
op_assign
id|signalCEMsg
c_func
(paren
id|ceTime
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
eof
