multiline_comment|/*&n; * iSeries hashtable management.&n; * &t;Derived from pSeries_htab.c&n; *&n; * SMP scalability work:&n; *    Copyright (C) 2001 Anton Blanchard &lt;anton@au.ibm.com&gt;, IBM&n; * &n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/mmu.h&gt;
macro_line|#include &lt;asm/mmu_context.h&gt;
macro_line|#include &lt;asm/iSeries/HvCallHpt.h&gt;
macro_line|#include &lt;asm/abs_addr.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
DECL|variable|__cacheline_aligned_in_smp
r_static
id|spinlock_t
id|iSeries_hlocks
(braket
l_int|64
)braket
id|__cacheline_aligned_in_smp
op_assign
(brace
(braket
l_int|0
dot
dot
dot
l_int|63
)braket
op_assign
id|SPIN_LOCK_UNLOCKED
)brace
suffix:semicolon
multiline_comment|/*&n; * Very primitive algorithm for picking up a lock&n; */
DECL|function|iSeries_hlock
r_static
r_inline
r_void
id|iSeries_hlock
c_func
(paren
r_int
r_int
id|slot
)paren
(brace
r_if
c_cond
(paren
id|slot
op_amp
l_int|0x8
)paren
id|slot
op_assign
op_complement
id|slot
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|iSeries_hlocks
(braket
(paren
id|slot
op_rshift
l_int|4
)paren
op_amp
l_int|0x3f
)braket
)paren
suffix:semicolon
)brace
DECL|function|iSeries_hunlock
r_static
r_inline
r_void
id|iSeries_hunlock
c_func
(paren
r_int
r_int
id|slot
)paren
(brace
r_if
c_cond
(paren
id|slot
op_amp
l_int|0x8
)paren
id|slot
op_assign
op_complement
id|slot
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|iSeries_hlocks
(braket
(paren
id|slot
op_rshift
l_int|4
)paren
op_amp
l_int|0x3f
)braket
)paren
suffix:semicolon
)brace
DECL|function|iSeries_hpte_insert
r_static
r_int
id|iSeries_hpte_insert
c_func
(paren
r_int
r_int
id|hpte_group
comma
r_int
r_int
id|va
comma
r_int
r_int
id|prpn
comma
r_int
id|secondary
comma
r_int
r_int
id|hpteflags
comma
r_int
id|bolted
comma
r_int
id|large
)paren
(brace
r_int
id|slot
suffix:semicolon
id|HPTE
id|lhpte
suffix:semicolon
multiline_comment|/*&n;&t; * The hypervisor tries both primary and secondary.&n;&t; * If we are being called to insert in the secondary,&n;&t; * it means we have already tried both primary and secondary,&n;&t; * so we return failure immediately.&n;&t; */
r_if
c_cond
(paren
id|secondary
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|iSeries_hlock
c_func
(paren
id|hpte_group
)paren
suffix:semicolon
id|slot
op_assign
id|HvCallHpt_findValid
c_func
(paren
op_amp
id|lhpte
comma
id|va
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|lhpte.dw0.dw0.v
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot
op_eq
op_minus
l_int|1
)paren
(brace
multiline_comment|/* No available entry found in either group */
id|iSeries_hunlock
c_func
(paren
id|hpte_group
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot
OL
l_int|0
)paren
(brace
multiline_comment|/* MSB set means secondary group */
id|secondary
op_assign
l_int|1
suffix:semicolon
id|slot
op_and_assign
l_int|0x7fffffffffffffff
suffix:semicolon
)brace
id|lhpte.dw1.dword1
op_assign
l_int|0
suffix:semicolon
id|lhpte.dw1.dw1.rpn
op_assign
id|physRpn_to_absRpn
c_func
(paren
id|prpn
)paren
suffix:semicolon
id|lhpte.dw1.flags.flags
op_assign
id|hpteflags
suffix:semicolon
id|lhpte.dw0.dword0
op_assign
l_int|0
suffix:semicolon
id|lhpte.dw0.dw0.avpn
op_assign
id|va
op_rshift
l_int|23
suffix:semicolon
id|lhpte.dw0.dw0.h
op_assign
id|secondary
suffix:semicolon
id|lhpte.dw0.dw0.bolted
op_assign
id|bolted
suffix:semicolon
id|lhpte.dw0.dw0.v
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Now fill in the actual HPTE */
id|HvCallHpt_addValidate
c_func
(paren
id|slot
comma
id|secondary
comma
op_amp
id|lhpte
)paren
suffix:semicolon
id|iSeries_hunlock
c_func
(paren
id|hpte_group
)paren
suffix:semicolon
r_return
(paren
id|secondary
op_lshift
l_int|3
)paren
op_or
(paren
id|slot
op_amp
l_int|7
)paren
suffix:semicolon
)brace
DECL|function|iSeries_hpte_getword0
r_static
r_int
r_int
id|iSeries_hpte_getword0
c_func
(paren
r_int
r_int
id|slot
)paren
(brace
r_int
r_int
id|dword0
suffix:semicolon
id|HPTE
id|hpte
suffix:semicolon
id|HvCallHpt_get
c_func
(paren
op_amp
id|hpte
comma
id|slot
)paren
suffix:semicolon
id|dword0
op_assign
id|hpte.dw0.dword0
suffix:semicolon
r_return
id|dword0
suffix:semicolon
)brace
DECL|function|iSeries_hpte_remove
r_static
r_int
id|iSeries_hpte_remove
c_func
(paren
r_int
r_int
id|hpte_group
)paren
(brace
r_int
r_int
id|slot_offset
suffix:semicolon
r_int
id|i
suffix:semicolon
id|HPTE
id|lhpte
suffix:semicolon
multiline_comment|/* Pick a random slot to start at */
id|slot_offset
op_assign
id|mftb
c_func
(paren
)paren
op_amp
l_int|0x7
suffix:semicolon
id|iSeries_hlock
c_func
(paren
id|hpte_group
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HPTES_PER_GROUP
suffix:semicolon
id|i
op_increment
)paren
(brace
id|lhpte.dw0.dword0
op_assign
id|iSeries_hpte_getword0
c_func
(paren
id|hpte_group
op_plus
id|slot_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lhpte.dw0.dw0.bolted
)paren
(brace
id|HvCallHpt_invalidateSetSwBitsGet
c_func
(paren
id|hpte_group
op_plus
id|slot_offset
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|iSeries_hunlock
c_func
(paren
id|hpte_group
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
id|slot_offset
op_increment
suffix:semicolon
id|slot_offset
op_and_assign
l_int|0x7
suffix:semicolon
)brace
id|iSeries_hunlock
c_func
(paren
id|hpte_group
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * The HyperVisor expects the &quot;flags&quot; argument in this form:&n; * &t;bits  0..59 : reserved&n; * &t;bit      60 : N&n; * &t;bits 61..63 : PP2,PP1,PP0&n; */
DECL|function|iSeries_hpte_updatepp
r_static
r_int
id|iSeries_hpte_updatepp
c_func
(paren
r_int
r_int
id|slot
comma
r_int
r_int
id|newpp
comma
r_int
r_int
id|va
comma
r_int
id|large
comma
r_int
id|local
)paren
(brace
id|HPTE
id|hpte
suffix:semicolon
r_int
r_int
id|avpn
op_assign
id|va
op_rshift
l_int|23
suffix:semicolon
id|iSeries_hlock
c_func
(paren
id|slot
)paren
suffix:semicolon
id|HvCallHpt_get
c_func
(paren
op_amp
id|hpte
comma
id|slot
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hpte.dw0.dw0.avpn
op_eq
id|avpn
)paren
op_logical_and
(paren
id|hpte.dw0.dw0.v
)paren
)paren
(brace
id|HvCallHpt_setPp
c_func
(paren
id|slot
comma
(paren
id|newpp
op_amp
l_int|0x3
)paren
op_or
(paren
(paren
id|newpp
op_amp
l_int|0x4
)paren
op_lshift
l_int|1
)paren
)paren
suffix:semicolon
id|iSeries_hunlock
c_func
(paren
id|slot
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|iSeries_hunlock
c_func
(paren
id|slot
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Functions used to find the PTE for a particular virtual address. &n; * Only used during boot when bolting pages.&n; *&n; * Input : vpn      : virtual page number&n; * Output: PTE index within the page table of the entry&n; *         -1 on failure&n; */
DECL|function|iSeries_hpte_find
r_static
r_int
id|iSeries_hpte_find
c_func
(paren
r_int
r_int
id|vpn
)paren
(brace
id|HPTE
id|hpte
suffix:semicolon
r_int
id|slot
suffix:semicolon
multiline_comment|/*&n;&t; * The HvCallHpt_findValid interface is as follows:&n;&t; * 0xffffffffffffffff : No entry found.&n;&t; * 0x00000000xxxxxxxx : Entry found in primary group, slot x&n;&t; * 0x80000000xxxxxxxx : Entry found in secondary group, slot x&n;&t; */
id|slot
op_assign
id|HvCallHpt_findValid
c_func
(paren
op_amp
id|hpte
comma
id|vpn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hpte.dw0.dw0.v
)paren
(brace
r_if
c_cond
(paren
id|slot
OL
l_int|0
)paren
(brace
id|slot
op_and_assign
l_int|0x7fffffffffffffff
suffix:semicolon
id|slot
op_assign
op_minus
id|slot
suffix:semicolon
)brace
)brace
r_else
id|slot
op_assign
op_minus
l_int|1
suffix:semicolon
r_return
id|slot
suffix:semicolon
)brace
multiline_comment|/*&n; * Update the page protection bits. Intended to be used to create&n; * guard pages for kernel data structures on pages which are bolted&n; * in the HPT. Assumes pages being operated on will not be stolen.&n; * Does not work on large pages.&n; *&n; * No need to lock here because we should be the only user.&n; */
DECL|function|iSeries_hpte_updateboltedpp
r_static
r_void
id|iSeries_hpte_updateboltedpp
c_func
(paren
r_int
r_int
id|newpp
comma
r_int
r_int
id|ea
)paren
(brace
r_int
r_int
id|vsid
comma
id|va
comma
id|vpn
suffix:semicolon
r_int
id|slot
suffix:semicolon
id|vsid
op_assign
id|get_kernel_vsid
c_func
(paren
id|ea
)paren
suffix:semicolon
id|va
op_assign
(paren
id|vsid
op_lshift
l_int|28
)paren
op_or
(paren
id|ea
op_amp
l_int|0x0fffffff
)paren
suffix:semicolon
id|vpn
op_assign
id|va
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|slot
op_assign
id|iSeries_hpte_find
c_func
(paren
id|vpn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot
op_eq
op_minus
l_int|1
)paren
id|panic
c_func
(paren
l_string|&quot;updateboltedpp: Could not find page to bolt&bslash;n&quot;
)paren
suffix:semicolon
id|HvCallHpt_setPp
c_func
(paren
id|slot
comma
id|newpp
)paren
suffix:semicolon
)brace
DECL|function|iSeries_hpte_invalidate
r_static
r_void
id|iSeries_hpte_invalidate
c_func
(paren
r_int
r_int
id|slot
comma
r_int
r_int
id|va
comma
r_int
id|large
comma
r_int
id|local
)paren
(brace
id|HPTE
id|lhpte
suffix:semicolon
r_int
r_int
id|avpn
op_assign
id|va
op_rshift
l_int|23
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|iSeries_hlock
c_func
(paren
id|slot
)paren
suffix:semicolon
id|lhpte.dw0.dword0
op_assign
id|iSeries_hpte_getword0
c_func
(paren
id|slot
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lhpte.dw0.dw0.avpn
op_eq
id|avpn
)paren
op_logical_and
id|lhpte.dw0.dw0.v
)paren
id|HvCallHpt_invalidateSetSwBitsGet
c_func
(paren
id|slot
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|iSeries_hunlock
c_func
(paren
id|slot
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|hpte_init_iSeries
r_void
id|hpte_init_iSeries
c_func
(paren
r_void
)paren
(brace
id|ppc_md.hpte_invalidate
op_assign
id|iSeries_hpte_invalidate
suffix:semicolon
id|ppc_md.hpte_updatepp
op_assign
id|iSeries_hpte_updatepp
suffix:semicolon
id|ppc_md.hpte_updateboltedpp
op_assign
id|iSeries_hpte_updateboltedpp
suffix:semicolon
id|ppc_md.hpte_insert
op_assign
id|iSeries_hpte_insert
suffix:semicolon
id|ppc_md.hpte_remove
op_assign
id|iSeries_hpte_remove
suffix:semicolon
id|htab_finish_init
c_func
(paren
)paren
suffix:semicolon
)brace
eof
