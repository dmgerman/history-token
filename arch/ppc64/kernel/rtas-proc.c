multiline_comment|/*&n; *   arch/ppc64/kernel/rtas-proc.c&n; *   Copyright (C) 2000 Tilmann Bitterberg&n; *   (tilmann@bitterberg.de)&n; *&n; *   RTAS (Runtime Abstraction Services) stuff&n; *   Intention is to provide a clean user interface&n; *   to use the RTAS.&n; *&n; *   TODO:&n; *   Split off a header file and maybe move it to a different&n; *   location. Write Documentation on what the /proc/rtas/ entries&n; *   actually do.&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/seq_file.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/rtas.h&gt;
macro_line|#include &lt;asm/machdep.h&gt; /* for ppc_md */
macro_line|#include &lt;asm/time.h&gt;
macro_line|#include &lt;asm/systemcfg.h&gt;
multiline_comment|/* Token for Sensors */
DECL|macro|KEY_SWITCH
mdefine_line|#define KEY_SWITCH&t;&t;0x0001
DECL|macro|ENCLOSURE_SWITCH
mdefine_line|#define ENCLOSURE_SWITCH&t;0x0002
DECL|macro|THERMAL_SENSOR
mdefine_line|#define THERMAL_SENSOR&t;&t;0x0003
DECL|macro|LID_STATUS
mdefine_line|#define LID_STATUS&t;&t;0x0004
DECL|macro|POWER_SOURCE
mdefine_line|#define POWER_SOURCE&t;&t;0x0005
DECL|macro|BATTERY_VOLTAGE
mdefine_line|#define BATTERY_VOLTAGE&t;&t;0x0006
DECL|macro|BATTERY_REMAINING
mdefine_line|#define BATTERY_REMAINING&t;0x0007
DECL|macro|BATTERY_PERCENTAGE
mdefine_line|#define BATTERY_PERCENTAGE&t;0x0008
DECL|macro|EPOW_SENSOR
mdefine_line|#define EPOW_SENSOR&t;&t;0x0009
DECL|macro|BATTERY_CYCLESTATE
mdefine_line|#define BATTERY_CYCLESTATE&t;0x000a
DECL|macro|BATTERY_CHARGING
mdefine_line|#define BATTERY_CHARGING&t;0x000b
multiline_comment|/* IBM specific sensors */
DECL|macro|IBM_SURVEILLANCE
mdefine_line|#define IBM_SURVEILLANCE&t;0x2328 /* 9000 */
DECL|macro|IBM_FANRPM
mdefine_line|#define IBM_FANRPM&t;&t;0x2329 /* 9001 */
DECL|macro|IBM_VOLTAGE
mdefine_line|#define IBM_VOLTAGE&t;&t;0x232a /* 9002 */
DECL|macro|IBM_DRCONNECTOR
mdefine_line|#define IBM_DRCONNECTOR&t;&t;0x232b /* 9003 */
DECL|macro|IBM_POWERSUPPLY
mdefine_line|#define IBM_POWERSUPPLY&t;&t;0x232c /* 9004 */
multiline_comment|/* Status return values */
DECL|macro|SENSOR_CRITICAL_HIGH
mdefine_line|#define SENSOR_CRITICAL_HIGH&t;13
DECL|macro|SENSOR_WARNING_HIGH
mdefine_line|#define SENSOR_WARNING_HIGH&t;12
DECL|macro|SENSOR_NORMAL
mdefine_line|#define SENSOR_NORMAL&t;&t;11
DECL|macro|SENSOR_WARNING_LOW
mdefine_line|#define SENSOR_WARNING_LOW&t;10
DECL|macro|SENSOR_CRITICAL_LOW
mdefine_line|#define SENSOR_CRITICAL_LOW&t; 9
DECL|macro|SENSOR_SUCCESS
mdefine_line|#define SENSOR_SUCCESS&t;&t; 0
DECL|macro|SENSOR_HW_ERROR
mdefine_line|#define SENSOR_HW_ERROR&t;&t;-1
DECL|macro|SENSOR_BUSY
mdefine_line|#define SENSOR_BUSY&t;&t;-2
DECL|macro|SENSOR_NOT_EXIST
mdefine_line|#define SENSOR_NOT_EXIST&t;-3
DECL|macro|SENSOR_DR_ENTITY
mdefine_line|#define SENSOR_DR_ENTITY&t;-9000
multiline_comment|/* Location Codes */
DECL|macro|LOC_SCSI_DEV_ADDR
mdefine_line|#define LOC_SCSI_DEV_ADDR&t;&squot;A&squot;
DECL|macro|LOC_SCSI_DEV_LOC
mdefine_line|#define LOC_SCSI_DEV_LOC&t;&squot;B&squot;
DECL|macro|LOC_CPU
mdefine_line|#define LOC_CPU&t;&t;&t;&squot;C&squot;
DECL|macro|LOC_DISKETTE
mdefine_line|#define LOC_DISKETTE&t;&t;&squot;D&squot;
DECL|macro|LOC_ETHERNET
mdefine_line|#define LOC_ETHERNET&t;&t;&squot;E&squot;
DECL|macro|LOC_FAN
mdefine_line|#define LOC_FAN&t;&t;&t;&squot;F&squot;
DECL|macro|LOC_GRAPHICS
mdefine_line|#define LOC_GRAPHICS&t;&t;&squot;G&squot;
multiline_comment|/* reserved / not used&t;&t;&squot;H&squot; */
DECL|macro|LOC_IO_ADAPTER
mdefine_line|#define LOC_IO_ADAPTER&t;&t;&squot;I&squot;
multiline_comment|/* reserved / not used&t;&t;&squot;J&squot; */
DECL|macro|LOC_KEYBOARD
mdefine_line|#define LOC_KEYBOARD&t;&t;&squot;K&squot;
DECL|macro|LOC_LCD
mdefine_line|#define LOC_LCD&t;&t;&t;&squot;L&squot;
DECL|macro|LOC_MEMORY
mdefine_line|#define LOC_MEMORY&t;&t;&squot;M&squot;
DECL|macro|LOC_NV_MEMORY
mdefine_line|#define LOC_NV_MEMORY&t;&t;&squot;N&squot;
DECL|macro|LOC_MOUSE
mdefine_line|#define LOC_MOUSE&t;&t;&squot;O&squot;
DECL|macro|LOC_PLANAR
mdefine_line|#define LOC_PLANAR&t;&t;&squot;P&squot;
DECL|macro|LOC_OTHER_IO
mdefine_line|#define LOC_OTHER_IO&t;&t;&squot;Q&squot;
DECL|macro|LOC_PARALLEL
mdefine_line|#define LOC_PARALLEL&t;&t;&squot;R&squot;
DECL|macro|LOC_SERIAL
mdefine_line|#define LOC_SERIAL&t;&t;&squot;S&squot;
DECL|macro|LOC_DEAD_RING
mdefine_line|#define LOC_DEAD_RING&t;&t;&squot;T&squot;
DECL|macro|LOC_RACKMOUNTED
mdefine_line|#define LOC_RACKMOUNTED&t;&t;&squot;U&squot; /* for _u_nit is rack mounted */
DECL|macro|LOC_VOLTAGE
mdefine_line|#define LOC_VOLTAGE&t;&t;&squot;V&squot;
DECL|macro|LOC_SWITCH_ADAPTER
mdefine_line|#define LOC_SWITCH_ADAPTER&t;&squot;W&squot;
DECL|macro|LOC_OTHER
mdefine_line|#define LOC_OTHER&t;&t;&squot;X&squot;
DECL|macro|LOC_FIRMWARE
mdefine_line|#define LOC_FIRMWARE&t;&t;&squot;Y&squot;
DECL|macro|LOC_SCSI
mdefine_line|#define LOC_SCSI&t;&t;&squot;Z&squot;
multiline_comment|/* Tokens for indicators */
DECL|macro|TONE_FREQUENCY
mdefine_line|#define TONE_FREQUENCY&t;&t;0x0001 /* 0 - 1000 (HZ)*/
DECL|macro|TONE_VOLUME
mdefine_line|#define TONE_VOLUME&t;&t;0x0002 /* 0 - 100 (%) */
DECL|macro|SYSTEM_POWER_STATE
mdefine_line|#define SYSTEM_POWER_STATE&t;0x0003 
DECL|macro|WARNING_LIGHT
mdefine_line|#define WARNING_LIGHT&t;&t;0x0004
DECL|macro|DISK_ACTIVITY_LIGHT
mdefine_line|#define DISK_ACTIVITY_LIGHT&t;0x0005
DECL|macro|HEX_DISPLAY_UNIT
mdefine_line|#define HEX_DISPLAY_UNIT&t;0x0006
DECL|macro|BATTERY_WARNING_TIME
mdefine_line|#define BATTERY_WARNING_TIME&t;0x0007
DECL|macro|CONDITION_CYCLE_REQUEST
mdefine_line|#define CONDITION_CYCLE_REQUEST&t;0x0008
DECL|macro|SURVEILLANCE_INDICATOR
mdefine_line|#define SURVEILLANCE_INDICATOR&t;0x2328 /* 9000 */
DECL|macro|DR_ACTION
mdefine_line|#define DR_ACTION&t;&t;0x2329 /* 9001 */
DECL|macro|DR_INDICATOR
mdefine_line|#define DR_INDICATOR&t;&t;0x232a /* 9002 */
multiline_comment|/* 9003 - 9004: Vendor specific */
multiline_comment|/* 9006 - 9999: Vendor specific */
multiline_comment|/* other */
DECL|macro|MAX_SENSORS
mdefine_line|#define MAX_SENSORS&t;&t; 17  /* I only know of 17 sensors */    
DECL|macro|MAX_LINELENGTH
mdefine_line|#define MAX_LINELENGTH          256
DECL|macro|SENSOR_PREFIX
mdefine_line|#define SENSOR_PREFIX&t;&t;&quot;ibm,sensor-&quot;
DECL|macro|cel_to_fahr
mdefine_line|#define cel_to_fahr(x)&t;&t;((x*9/5)+32)
multiline_comment|/* Globals */
DECL|variable|sensors
r_static
r_struct
id|rtas_sensors
id|sensors
suffix:semicolon
DECL|variable|rtas_node
r_static
r_struct
id|device_node
op_star
id|rtas_node
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|power_on_time
r_static
r_int
r_int
id|power_on_time
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Save the time the user set */
DECL|variable|progress_led
r_static
r_char
id|progress_led
(braket
id|MAX_LINELENGTH
)braket
suffix:semicolon
DECL|variable|rtas_tone_frequency
r_static
r_int
r_int
id|rtas_tone_frequency
op_assign
l_int|1000
suffix:semicolon
DECL|variable|rtas_tone_volume
r_static
r_int
r_int
id|rtas_tone_volume
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* ****************STRUCTS******************************************* */
DECL|struct|individual_sensor
r_struct
id|individual_sensor
(brace
DECL|member|token
r_int
r_int
id|token
suffix:semicolon
DECL|member|quant
r_int
r_int
id|quant
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|rtas_sensors
r_struct
id|rtas_sensors
(brace
DECL|member|sensor
r_struct
id|individual_sensor
id|sensor
(braket
id|MAX_SENSORS
)braket
suffix:semicolon
DECL|member|quant
r_int
r_int
id|quant
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* ****************************************************************** */
multiline_comment|/* Declarations */
r_static
r_int
id|ppc_rtas_sensors_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
suffix:semicolon
r_static
r_int
id|ppc_rtas_clock_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
suffix:semicolon
r_static
id|ssize_t
id|ppc_rtas_clock_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
r_static
r_int
id|ppc_rtas_progress_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
suffix:semicolon
r_static
id|ssize_t
id|ppc_rtas_progress_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
r_static
r_int
id|ppc_rtas_poweron_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
suffix:semicolon
r_static
id|ssize_t
id|ppc_rtas_poweron_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
r_static
id|ssize_t
id|ppc_rtas_tone_freq_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
r_static
r_int
id|ppc_rtas_tone_freq_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
suffix:semicolon
r_static
id|ssize_t
id|ppc_rtas_tone_volume_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
r_static
r_int
id|ppc_rtas_tone_volume_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
suffix:semicolon
r_static
r_int
id|ppc_rtas_rmo_buf_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
suffix:semicolon
DECL|function|sensors_open
r_static
r_int
id|sensors_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|single_open
c_func
(paren
id|file
comma
id|ppc_rtas_sensors_show
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|ppc_rtas_sensors_operations
r_struct
id|file_operations
id|ppc_rtas_sensors_operations
op_assign
(brace
dot
id|open
op_assign
id|sensors_open
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|release
op_assign
id|single_release
comma
)brace
suffix:semicolon
DECL|function|poweron_open
r_static
r_int
id|poweron_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|single_open
c_func
(paren
id|file
comma
id|ppc_rtas_poweron_show
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|ppc_rtas_poweron_operations
r_struct
id|file_operations
id|ppc_rtas_poweron_operations
op_assign
(brace
dot
id|open
op_assign
id|poweron_open
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|write
op_assign
id|ppc_rtas_poweron_write
comma
dot
id|release
op_assign
id|single_release
comma
)brace
suffix:semicolon
DECL|function|progress_open
r_static
r_int
id|progress_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|single_open
c_func
(paren
id|file
comma
id|ppc_rtas_progress_show
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|ppc_rtas_progress_operations
r_struct
id|file_operations
id|ppc_rtas_progress_operations
op_assign
(brace
dot
id|open
op_assign
id|progress_open
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|write
op_assign
id|ppc_rtas_progress_write
comma
dot
id|release
op_assign
id|single_release
comma
)brace
suffix:semicolon
DECL|function|clock_open
r_static
r_int
id|clock_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|single_open
c_func
(paren
id|file
comma
id|ppc_rtas_clock_show
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|ppc_rtas_clock_operations
r_struct
id|file_operations
id|ppc_rtas_clock_operations
op_assign
(brace
dot
id|open
op_assign
id|clock_open
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|write
op_assign
id|ppc_rtas_clock_write
comma
dot
id|release
op_assign
id|single_release
comma
)brace
suffix:semicolon
DECL|function|tone_freq_open
r_static
r_int
id|tone_freq_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|single_open
c_func
(paren
id|file
comma
id|ppc_rtas_tone_freq_show
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|ppc_rtas_tone_freq_operations
r_struct
id|file_operations
id|ppc_rtas_tone_freq_operations
op_assign
(brace
dot
id|open
op_assign
id|tone_freq_open
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|write
op_assign
id|ppc_rtas_tone_freq_write
comma
dot
id|release
op_assign
id|single_release
comma
)brace
suffix:semicolon
DECL|function|tone_volume_open
r_static
r_int
id|tone_volume_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|single_open
c_func
(paren
id|file
comma
id|ppc_rtas_tone_volume_show
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|ppc_rtas_tone_volume_operations
r_struct
id|file_operations
id|ppc_rtas_tone_volume_operations
op_assign
(brace
dot
id|open
op_assign
id|tone_volume_open
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|write
op_assign
id|ppc_rtas_tone_volume_write
comma
dot
id|release
op_assign
id|single_release
comma
)brace
suffix:semicolon
DECL|function|rmo_buf_open
r_static
r_int
id|rmo_buf_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|single_open
c_func
(paren
id|file
comma
id|ppc_rtas_rmo_buf_show
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|ppc_rtas_rmo_buf_ops
r_struct
id|file_operations
id|ppc_rtas_rmo_buf_ops
op_assign
(brace
dot
id|open
op_assign
id|rmo_buf_open
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|release
op_assign
id|single_release
comma
)brace
suffix:semicolon
r_static
r_int
id|ppc_rtas_find_all_sensors
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|ppc_rtas_process_sensor
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_struct
id|individual_sensor
op_star
id|s
comma
r_int
id|state
comma
r_int
id|error
comma
r_char
op_star
id|loc
)paren
suffix:semicolon
r_static
r_char
op_star
id|ppc_rtas_process_error
c_func
(paren
r_int
id|error
)paren
suffix:semicolon
r_static
r_void
id|get_location_code
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_struct
id|individual_sensor
op_star
id|s
comma
r_char
op_star
id|loc
)paren
suffix:semicolon
r_static
r_void
id|check_location_string
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_char
op_star
id|c
)paren
suffix:semicolon
r_static
r_void
id|check_location
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_char
op_star
id|c
)paren
suffix:semicolon
DECL|function|proc_rtas_init
r_static
r_int
id|__init
id|proc_rtas_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|entry
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|systemcfg-&gt;platform
op_amp
id|PLATFORM_PSERIES
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|rtas_node
op_assign
id|of_find_node_by_name
c_func
(paren
l_int|NULL
comma
l_string|&quot;rtas&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rtas_node
op_eq
l_int|NULL
)paren
r_return
l_int|1
suffix:semicolon
id|entry
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;ppc64/rtas/progress&quot;
comma
id|S_IRUGO
op_or
id|S_IWUSR
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
)paren
id|entry-&gt;proc_fops
op_assign
op_amp
id|ppc_rtas_progress_operations
suffix:semicolon
id|entry
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;ppc64/rtas/clock&quot;
comma
id|S_IRUGO
op_or
id|S_IWUSR
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
)paren
id|entry-&gt;proc_fops
op_assign
op_amp
id|ppc_rtas_clock_operations
suffix:semicolon
id|entry
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;ppc64/rtas/poweron&quot;
comma
id|S_IWUSR
op_or
id|S_IRUGO
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
)paren
id|entry-&gt;proc_fops
op_assign
op_amp
id|ppc_rtas_poweron_operations
suffix:semicolon
id|entry
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;ppc64/rtas/sensors&quot;
comma
id|S_IRUGO
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
)paren
id|entry-&gt;proc_fops
op_assign
op_amp
id|ppc_rtas_sensors_operations
suffix:semicolon
id|entry
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;ppc64/rtas/frequency&quot;
comma
id|S_IWUSR
op_or
id|S_IRUGO
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
)paren
id|entry-&gt;proc_fops
op_assign
op_amp
id|ppc_rtas_tone_freq_operations
suffix:semicolon
id|entry
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;ppc64/rtas/volume&quot;
comma
id|S_IWUSR
op_or
id|S_IRUGO
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
)paren
id|entry-&gt;proc_fops
op_assign
op_amp
id|ppc_rtas_tone_volume_operations
suffix:semicolon
id|entry
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;ppc64/rtas/rmo_buffer&quot;
comma
id|S_IRUSR
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
)paren
id|entry-&gt;proc_fops
op_assign
op_amp
id|ppc_rtas_rmo_buf_ops
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|proc_rtas_init
id|__initcall
c_func
(paren
id|proc_rtas_init
)paren
suffix:semicolon
DECL|function|parse_number
r_static
r_int
id|parse_number
c_func
(paren
r_const
r_char
id|__user
op_star
id|p
comma
r_int
id|count
comma
r_int
r_int
op_star
id|val
)paren
(brace
r_char
id|buf
(braket
l_int|40
)braket
suffix:semicolon
r_char
op_star
id|end
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|39
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|buf
comma
id|p
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|buf
(braket
id|count
)braket
op_assign
l_int|0
suffix:semicolon
op_star
id|val
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
op_amp
id|end
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|end
op_logical_and
op_star
id|end
op_ne
l_char|&squot;&bslash;n&squot;
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
multiline_comment|/* POWER-ON-TIME                                                      */
multiline_comment|/* ****************************************************************** */
DECL|function|ppc_rtas_poweron_write
r_static
id|ssize_t
id|ppc_rtas_poweron_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|rtc_time
id|tm
suffix:semicolon
r_int
r_int
id|nowtime
suffix:semicolon
r_int
id|error
op_assign
id|parse_number
c_func
(paren
id|buf
comma
id|count
comma
op_amp
id|nowtime
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|power_on_time
op_assign
id|nowtime
suffix:semicolon
multiline_comment|/* save the time */
id|to_tm
c_func
(paren
id|nowtime
comma
op_amp
id|tm
)paren
suffix:semicolon
id|error
op_assign
id|rtas_call
c_func
(paren
id|rtas_token
c_func
(paren
l_string|&quot;set-time-for-power-on&quot;
)paren
comma
l_int|7
comma
l_int|1
comma
l_int|NULL
comma
id|tm.tm_year
comma
id|tm.tm_mon
comma
id|tm.tm_mday
comma
id|tm.tm_hour
comma
id|tm.tm_min
comma
id|tm.tm_sec
comma
l_int|0
multiline_comment|/* nano */
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;error: setting poweron time returned: %s&bslash;n&quot;
comma
id|ppc_rtas_process_error
c_func
(paren
id|error
)paren
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
DECL|function|ppc_rtas_poweron_show
r_static
r_int
id|ppc_rtas_poweron_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
(brace
r_if
c_cond
(paren
id|power_on_time
op_eq
l_int|0
)paren
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Power on time not set&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%lu&bslash;n&quot;
comma
id|power_on_time
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
multiline_comment|/* PROGRESS                                                           */
multiline_comment|/* ****************************************************************** */
DECL|function|ppc_rtas_progress_write
r_static
id|ssize_t
id|ppc_rtas_progress_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
r_int
id|hex
suffix:semicolon
r_if
c_cond
(paren
id|count
op_ge
id|MAX_LINELENGTH
)paren
id|count
op_assign
id|MAX_LINELENGTH
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|progress_led
comma
id|buf
comma
id|count
)paren
)paren
(brace
multiline_comment|/* save the string */
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|progress_led
(braket
id|count
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Lets see if the user passed hexdigits */
id|hex
op_assign
id|simple_strtoul
c_func
(paren
id|progress_led
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|ppc_md.progress
(paren
(paren
r_char
op_star
)paren
id|progress_led
comma
id|hex
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
multiline_comment|/* clear the line */
multiline_comment|/* ppc_md.progress(&quot;                   &quot;, 0xffff);*/
)brace
multiline_comment|/* ****************************************************************** */
DECL|function|ppc_rtas_progress_show
r_static
r_int
id|ppc_rtas_progress_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
(brace
r_if
c_cond
(paren
id|progress_led
)paren
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|progress_led
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
multiline_comment|/* CLOCK                                                              */
multiline_comment|/* ****************************************************************** */
DECL|function|ppc_rtas_clock_write
r_static
id|ssize_t
id|ppc_rtas_clock_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|rtc_time
id|tm
suffix:semicolon
r_int
r_int
id|nowtime
suffix:semicolon
r_int
id|error
op_assign
id|parse_number
c_func
(paren
id|buf
comma
id|count
comma
op_amp
id|nowtime
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|to_tm
c_func
(paren
id|nowtime
comma
op_amp
id|tm
)paren
suffix:semicolon
id|error
op_assign
id|rtas_call
c_func
(paren
id|rtas_token
c_func
(paren
l_string|&quot;set-time-of-day&quot;
)paren
comma
l_int|7
comma
l_int|1
comma
l_int|NULL
comma
id|tm.tm_year
comma
id|tm.tm_mon
comma
id|tm.tm_mday
comma
id|tm.tm_hour
comma
id|tm.tm_min
comma
id|tm.tm_sec
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;error: setting the clock returned: %s&bslash;n&quot;
comma
id|ppc_rtas_process_error
c_func
(paren
id|error
)paren
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
DECL|function|ppc_rtas_clock_show
r_static
r_int
id|ppc_rtas_clock_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
(brace
r_int
id|ret
(braket
l_int|8
)braket
suffix:semicolon
r_int
id|error
op_assign
id|rtas_call
c_func
(paren
id|rtas_token
c_func
(paren
l_string|&quot;get-time-of-day&quot;
)paren
comma
l_int|0
comma
l_int|8
comma
id|ret
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;error: reading the clock returned: %s&bslash;n&quot;
comma
id|ppc_rtas_process_error
c_func
(paren
id|error
)paren
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;0&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|year
comma
id|mon
comma
id|day
comma
id|hour
comma
id|min
comma
id|sec
suffix:semicolon
id|year
op_assign
id|ret
(braket
l_int|0
)braket
suffix:semicolon
id|mon
op_assign
id|ret
(braket
l_int|1
)braket
suffix:semicolon
id|day
op_assign
id|ret
(braket
l_int|2
)braket
suffix:semicolon
id|hour
op_assign
id|ret
(braket
l_int|3
)braket
suffix:semicolon
id|min
op_assign
id|ret
(braket
l_int|4
)braket
suffix:semicolon
id|sec
op_assign
id|ret
(braket
l_int|5
)braket
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%lu&bslash;n&quot;
comma
id|mktime
c_func
(paren
id|year
comma
id|mon
comma
id|day
comma
id|hour
comma
id|min
comma
id|sec
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
multiline_comment|/* SENSOR STUFF                                                       */
multiline_comment|/* ****************************************************************** */
DECL|function|ppc_rtas_sensors_show
r_static
r_int
id|ppc_rtas_sensors_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_int
id|state
comma
id|error
suffix:semicolon
r_int
id|get_sensor_state
op_assign
id|rtas_token
c_func
(paren
l_string|&quot;get-sensor-state&quot;
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;RTAS (RunTime Abstraction Services) Sensor Information&bslash;n&quot;
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Sensor&bslash;t&bslash;tValue&bslash;t&bslash;tCondition&bslash;tLocation&bslash;n&quot;
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;********************************************************&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppc_rtas_find_all_sensors
c_func
(paren
)paren
op_ne
l_int|0
)paren
(brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;&bslash;nNo sensors are available&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sensors.quant
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|individual_sensor
op_star
id|p
op_assign
op_amp
id|sensors.sensor
(braket
id|i
)braket
suffix:semicolon
r_char
id|rstr
(braket
l_int|64
)braket
suffix:semicolon
r_char
op_star
id|loc
suffix:semicolon
r_int
id|llen
comma
id|offs
suffix:semicolon
id|sprintf
(paren
id|rstr
comma
id|SENSOR_PREFIX
l_string|&quot;%04d&quot;
comma
id|p-&gt;token
)paren
suffix:semicolon
id|loc
op_assign
(paren
r_char
op_star
)paren
id|get_property
c_func
(paren
id|rtas_node
comma
id|rstr
comma
op_amp
id|llen
)paren
suffix:semicolon
multiline_comment|/* A sensor may have multiple instances */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
comma
id|offs
op_assign
l_int|0
suffix:semicolon
id|j
op_le
id|p-&gt;quant
suffix:semicolon
id|j
op_increment
)paren
(brace
id|error
op_assign
id|rtas_call
c_func
(paren
id|get_sensor_state
comma
l_int|2
comma
l_int|2
comma
op_amp
id|state
comma
id|p-&gt;token
comma
id|j
)paren
suffix:semicolon
id|ppc_rtas_process_sensor
c_func
(paren
id|m
comma
id|p
comma
id|state
comma
id|error
comma
id|loc
)paren
suffix:semicolon
id|seq_putc
c_func
(paren
id|m
comma
l_char|&squot;&bslash;n&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|loc
)paren
(brace
id|offs
op_add_assign
id|strlen
c_func
(paren
id|loc
)paren
op_plus
l_int|1
suffix:semicolon
id|loc
op_add_assign
id|strlen
c_func
(paren
id|loc
)paren
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|offs
op_ge
id|llen
)paren
id|loc
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
DECL|function|ppc_rtas_find_all_sensors
r_static
r_int
id|ppc_rtas_find_all_sensors
c_func
(paren
r_void
)paren
(brace
r_int
r_int
op_star
id|utmp
suffix:semicolon
r_int
id|len
comma
id|i
suffix:semicolon
id|utmp
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_property
c_func
(paren
id|rtas_node
comma
l_string|&quot;rtas-sensors&quot;
comma
op_amp
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|utmp
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;error: could not get rtas-sensors&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|sensors.quant
op_assign
id|len
op_div
l_int|8
suffix:semicolon
multiline_comment|/* int + int */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sensors.quant
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sensors.sensor
(braket
id|i
)braket
dot
id|token
op_assign
op_star
id|utmp
op_increment
suffix:semicolon
id|sensors.sensor
(braket
id|i
)braket
dot
id|quant
op_assign
op_star
id|utmp
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
multiline_comment|/*&n; * Builds a string of what rtas returned&n; */
DECL|function|ppc_rtas_process_error
r_static
r_char
op_star
id|ppc_rtas_process_error
c_func
(paren
r_int
id|error
)paren
(brace
r_switch
c_cond
(paren
id|error
)paren
(brace
r_case
id|SENSOR_CRITICAL_HIGH
suffix:colon
r_return
l_string|&quot;(critical high)&quot;
suffix:semicolon
r_case
id|SENSOR_WARNING_HIGH
suffix:colon
r_return
l_string|&quot;(warning high)&quot;
suffix:semicolon
r_case
id|SENSOR_NORMAL
suffix:colon
r_return
l_string|&quot;(normal)&quot;
suffix:semicolon
r_case
id|SENSOR_WARNING_LOW
suffix:colon
r_return
l_string|&quot;(warning low)&quot;
suffix:semicolon
r_case
id|SENSOR_CRITICAL_LOW
suffix:colon
r_return
l_string|&quot;(critical low)&quot;
suffix:semicolon
r_case
id|SENSOR_SUCCESS
suffix:colon
r_return
l_string|&quot;(read ok)&quot;
suffix:semicolon
r_case
id|SENSOR_HW_ERROR
suffix:colon
r_return
l_string|&quot;(hardware error)&quot;
suffix:semicolon
r_case
id|SENSOR_BUSY
suffix:colon
r_return
l_string|&quot;(busy)&quot;
suffix:semicolon
r_case
id|SENSOR_NOT_EXIST
suffix:colon
r_return
l_string|&quot;(non existent)&quot;
suffix:semicolon
r_case
id|SENSOR_DR_ENTITY
suffix:colon
r_return
l_string|&quot;(dr entity removed)&quot;
suffix:semicolon
r_default
suffix:colon
r_return
l_string|&quot;(UNKNOWN)&quot;
suffix:semicolon
)brace
)brace
multiline_comment|/* ****************************************************************** */
multiline_comment|/*&n; * Builds a string out of what the sensor said&n; */
DECL|function|ppc_rtas_process_sensor
r_static
r_void
id|ppc_rtas_process_sensor
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_struct
id|individual_sensor
op_star
id|s
comma
r_int
id|state
comma
r_int
id|error
comma
r_char
op_star
id|loc
)paren
(brace
multiline_comment|/* Defined return vales */
r_const
r_char
op_star
id|key_switch
(braket
)braket
op_assign
(brace
l_string|&quot;Off&bslash;t&quot;
comma
l_string|&quot;Normal&bslash;t&quot;
comma
l_string|&quot;Secure&bslash;t&quot;
comma
l_string|&quot;Maintenance&quot;
)brace
suffix:semicolon
r_const
r_char
op_star
id|enclosure_switch
(braket
)braket
op_assign
(brace
l_string|&quot;Closed&quot;
comma
l_string|&quot;Open&quot;
)brace
suffix:semicolon
r_const
r_char
op_star
id|lid_status
(braket
)braket
op_assign
(brace
l_string|&quot; &quot;
comma
l_string|&quot;Open&quot;
comma
l_string|&quot;Closed&quot;
)brace
suffix:semicolon
r_const
r_char
op_star
id|power_source
(braket
)braket
op_assign
(brace
l_string|&quot;AC&bslash;t&quot;
comma
l_string|&quot;Battery&quot;
comma
l_string|&quot;AC &amp; Battery&quot;
)brace
suffix:semicolon
r_const
r_char
op_star
id|battery_remaining
(braket
)braket
op_assign
(brace
l_string|&quot;Very Low&quot;
comma
l_string|&quot;Low&quot;
comma
l_string|&quot;Mid&quot;
comma
l_string|&quot;High&quot;
)brace
suffix:semicolon
r_const
r_char
op_star
id|epow_sensor
(braket
)braket
op_assign
(brace
l_string|&quot;EPOW Reset&quot;
comma
l_string|&quot;Cooling warning&quot;
comma
l_string|&quot;Power warning&quot;
comma
l_string|&quot;System shutdown&quot;
comma
l_string|&quot;System halt&quot;
comma
l_string|&quot;EPOW main enclosure&quot;
comma
l_string|&quot;EPOW power off&quot;
)brace
suffix:semicolon
r_const
r_char
op_star
id|battery_cyclestate
(braket
)braket
op_assign
(brace
l_string|&quot;None&quot;
comma
l_string|&quot;In progress&quot;
comma
l_string|&quot;Requested&quot;
)brace
suffix:semicolon
r_const
r_char
op_star
id|battery_charging
(braket
)braket
op_assign
(brace
l_string|&quot;Charging&quot;
comma
l_string|&quot;Discharching&quot;
comma
l_string|&quot;No current flow&quot;
)brace
suffix:semicolon
r_const
r_char
op_star
id|ibm_drconnector
(braket
)braket
op_assign
(brace
l_string|&quot;Empty&quot;
comma
l_string|&quot;Present&quot;
comma
l_string|&quot;Unusable&quot;
comma
l_string|&quot;Exchange&quot;
)brace
suffix:semicolon
r_int
id|have_strings
op_assign
l_int|0
suffix:semicolon
r_int
id|num_states
op_assign
l_int|0
suffix:semicolon
r_int
id|temperature
op_assign
l_int|0
suffix:semicolon
r_int
id|unknown
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* What kind of sensor do we have here? */
r_switch
c_cond
(paren
id|s-&gt;token
)paren
(brace
r_case
id|KEY_SWITCH
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Key switch:&bslash;t&quot;
)paren
suffix:semicolon
id|num_states
op_assign
r_sizeof
(paren
id|key_switch
)paren
op_div
r_sizeof
(paren
r_char
op_star
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
OL
id|num_states
)paren
(brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%s&bslash;t&quot;
comma
id|key_switch
(braket
id|state
)braket
)paren
suffix:semicolon
id|have_strings
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ENCLOSURE_SWITCH
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Enclosure switch:&bslash;t&quot;
)paren
suffix:semicolon
id|num_states
op_assign
r_sizeof
(paren
id|enclosure_switch
)paren
op_div
r_sizeof
(paren
r_char
op_star
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
OL
id|num_states
)paren
(brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%s&bslash;t&quot;
comma
id|enclosure_switch
(braket
id|state
)braket
)paren
suffix:semicolon
id|have_strings
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|THERMAL_SENSOR
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Temp. (C/F):&bslash;t&quot;
)paren
suffix:semicolon
id|temperature
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LID_STATUS
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Lid status:&bslash;t&quot;
)paren
suffix:semicolon
id|num_states
op_assign
r_sizeof
(paren
id|lid_status
)paren
op_div
r_sizeof
(paren
r_char
op_star
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
OL
id|num_states
)paren
(brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%s&bslash;t&quot;
comma
id|lid_status
(braket
id|state
)braket
)paren
suffix:semicolon
id|have_strings
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|POWER_SOURCE
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Power source:&bslash;t&quot;
)paren
suffix:semicolon
id|num_states
op_assign
r_sizeof
(paren
id|power_source
)paren
op_div
r_sizeof
(paren
r_char
op_star
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
OL
id|num_states
)paren
(brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%s&bslash;t&quot;
comma
id|power_source
(braket
id|state
)braket
)paren
suffix:semicolon
id|have_strings
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BATTERY_VOLTAGE
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Battery voltage:&bslash;t&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BATTERY_REMAINING
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Battery remaining:&bslash;t&quot;
)paren
suffix:semicolon
id|num_states
op_assign
r_sizeof
(paren
id|battery_remaining
)paren
op_div
r_sizeof
(paren
r_char
op_star
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
OL
id|num_states
)paren
(brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%s&bslash;t&quot;
comma
id|battery_remaining
(braket
id|state
)braket
)paren
suffix:semicolon
id|have_strings
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BATTERY_PERCENTAGE
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Battery percentage:&bslash;t&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EPOW_SENSOR
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;EPOW Sensor:&bslash;t&quot;
)paren
suffix:semicolon
id|num_states
op_assign
r_sizeof
(paren
id|epow_sensor
)paren
op_div
r_sizeof
(paren
r_char
op_star
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
OL
id|num_states
)paren
(brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%s&bslash;t&quot;
comma
id|epow_sensor
(braket
id|state
)braket
)paren
suffix:semicolon
id|have_strings
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BATTERY_CYCLESTATE
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Battery cyclestate:&bslash;t&quot;
)paren
suffix:semicolon
id|num_states
op_assign
r_sizeof
(paren
id|battery_cyclestate
)paren
op_div
r_sizeof
(paren
r_char
op_star
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
OL
id|num_states
)paren
(brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%s&bslash;t&quot;
comma
id|battery_cyclestate
(braket
id|state
)braket
)paren
suffix:semicolon
id|have_strings
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BATTERY_CHARGING
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Battery Charging:&bslash;t&quot;
)paren
suffix:semicolon
id|num_states
op_assign
r_sizeof
(paren
id|battery_charging
)paren
op_div
r_sizeof
(paren
r_char
op_star
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
OL
id|num_states
)paren
(brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%s&bslash;t&quot;
comma
id|battery_charging
(braket
id|state
)braket
)paren
suffix:semicolon
id|have_strings
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|IBM_SURVEILLANCE
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Surveillance:&bslash;t&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IBM_FANRPM
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Fan (rpm):&bslash;t&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IBM_VOLTAGE
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Voltage (mv):&bslash;t&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IBM_DRCONNECTOR
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;DR connector:&bslash;t&quot;
)paren
suffix:semicolon
id|num_states
op_assign
r_sizeof
(paren
id|ibm_drconnector
)paren
op_div
r_sizeof
(paren
r_char
op_star
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
OL
id|num_states
)paren
(brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%s&bslash;t&quot;
comma
id|ibm_drconnector
(braket
id|state
)braket
)paren
suffix:semicolon
id|have_strings
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|IBM_POWERSUPPLY
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Powersupply:&bslash;t&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Unknown sensor (type %d), ignoring it&bslash;n&quot;
comma
id|s-&gt;token
)paren
suffix:semicolon
id|unknown
op_assign
l_int|1
suffix:semicolon
id|have_strings
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|have_strings
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|temperature
)paren
(brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%4d /%4d&bslash;t&quot;
comma
id|state
comma
id|cel_to_fahr
c_func
(paren
id|state
)paren
)paren
suffix:semicolon
)brace
r_else
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%10d&bslash;t&quot;
comma
id|state
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|unknown
op_eq
l_int|0
)paren
(brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%s&bslash;t&quot;
comma
id|ppc_rtas_process_error
c_func
(paren
id|error
)paren
)paren
suffix:semicolon
id|get_location_code
c_func
(paren
id|m
comma
id|s
comma
id|loc
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* ****************************************************************** */
DECL|function|check_location
r_static
r_void
id|check_location
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_char
op_star
id|c
)paren
(brace
r_switch
c_cond
(paren
id|c
(braket
l_int|0
)braket
)paren
(brace
r_case
id|LOC_PLANAR
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Planar #%c&quot;
comma
id|c
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LOC_CPU
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;CPU #%c&quot;
comma
id|c
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LOC_FAN
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Fan #%c&quot;
comma
id|c
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LOC_RACKMOUNTED
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Rack #%c&quot;
comma
id|c
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LOC_VOLTAGE
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Voltage #%c&quot;
comma
id|c
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LOC_LCD
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;LCD #%c&quot;
comma
id|c
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;.&squot;
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;- %c&quot;
comma
id|c
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Unknown location&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* ****************************************************************** */
multiline_comment|/* &n; * Format: &n; * ${LETTER}${NUMBER}[[-/]${LETTER}${NUMBER} [ ... ] ]&n; * the &squot;.&squot; may be an abbrevation&n; */
DECL|function|check_location_string
r_static
r_void
id|check_location_string
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_char
op_star
id|c
)paren
(brace
r_while
c_loop
(paren
op_star
id|c
)paren
(brace
r_if
c_cond
(paren
id|isalpha
c_func
(paren
op_star
id|c
)paren
op_logical_or
op_star
id|c
op_eq
l_char|&squot;.&squot;
)paren
id|check_location
c_func
(paren
id|m
comma
id|c
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_star
id|c
op_eq
l_char|&squot;/&squot;
op_logical_or
op_star
id|c
op_eq
l_char|&squot;-&squot;
)paren
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot; at &quot;
)paren
suffix:semicolon
id|c
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* ****************************************************************** */
DECL|function|get_location_code
r_static
r_void
id|get_location_code
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_struct
id|individual_sensor
op_star
id|s
comma
r_char
op_star
id|loc
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|loc
op_logical_or
op_logical_neg
op_star
id|loc
)paren
(brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;---&quot;
)paren
suffix:semicolon
multiline_comment|/* does not have a location */
)brace
r_else
(brace
id|check_location_string
c_func
(paren
id|m
comma
id|loc
)paren
suffix:semicolon
)brace
id|seq_putc
c_func
(paren
id|m
comma
l_char|&squot; &squot;
)paren
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
multiline_comment|/* INDICATORS - Tone Frequency                                        */
multiline_comment|/* ****************************************************************** */
DECL|function|ppc_rtas_tone_freq_write
r_static
id|ssize_t
id|ppc_rtas_tone_freq_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
r_int
id|freq
suffix:semicolon
r_int
id|error
op_assign
id|parse_number
c_func
(paren
id|buf
comma
id|count
comma
op_amp
id|freq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|rtas_tone_frequency
op_assign
id|freq
suffix:semicolon
multiline_comment|/* save it for later */
id|error
op_assign
id|rtas_call
c_func
(paren
id|rtas_token
c_func
(paren
l_string|&quot;set-indicator&quot;
)paren
comma
l_int|3
comma
l_int|1
comma
l_int|NULL
comma
id|TONE_FREQUENCY
comma
l_int|0
comma
id|freq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;error: setting tone frequency returned: %s&bslash;n&quot;
comma
id|ppc_rtas_process_error
c_func
(paren
id|error
)paren
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
DECL|function|ppc_rtas_tone_freq_show
r_static
r_int
id|ppc_rtas_tone_freq_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
(brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%lu&bslash;n&quot;
comma
id|rtas_tone_frequency
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
multiline_comment|/* INDICATORS - Tone Volume                                           */
multiline_comment|/* ****************************************************************** */
DECL|function|ppc_rtas_tone_volume_write
r_static
id|ssize_t
id|ppc_rtas_tone_volume_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
r_int
id|volume
suffix:semicolon
r_int
id|error
op_assign
id|parse_number
c_func
(paren
id|buf
comma
id|count
comma
op_amp
id|volume
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
r_if
c_cond
(paren
id|volume
OG
l_int|100
)paren
id|volume
op_assign
l_int|100
suffix:semicolon
id|rtas_tone_volume
op_assign
id|volume
suffix:semicolon
multiline_comment|/* save it for later */
id|error
op_assign
id|rtas_call
c_func
(paren
id|rtas_token
c_func
(paren
l_string|&quot;set-indicator&quot;
)paren
comma
l_int|3
comma
l_int|1
comma
l_int|NULL
comma
id|TONE_VOLUME
comma
l_int|0
comma
id|volume
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;error: setting tone volume returned: %s&bslash;n&quot;
comma
id|ppc_rtas_process_error
c_func
(paren
id|error
)paren
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* ****************************************************************** */
DECL|function|ppc_rtas_tone_volume_show
r_static
r_int
id|ppc_rtas_tone_volume_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
(brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%lu&bslash;n&quot;
comma
id|rtas_tone_volume
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|RMO_READ_BUF_MAX
mdefine_line|#define RMO_READ_BUF_MAX 30
multiline_comment|/* RTAS Userspace access */
DECL|function|ppc_rtas_rmo_buf_show
r_static
r_int
id|ppc_rtas_rmo_buf_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
(brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%016lx %x&bslash;n&quot;
comma
id|rtas_rmo_buf
comma
id|RTAS_RMOBUF_MAX
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
