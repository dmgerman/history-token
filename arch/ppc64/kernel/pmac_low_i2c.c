multiline_comment|/*&n; *  arch/ppc/platforms/pmac_low_i2c.c&n; *&n; *  Copyright (C) 2003 Ben. Herrenschmidt (benh@kernel.crashing.org)&n; *&n; *  This program is free software; you can redistribute it and/or&n; *  modify it under the terms of the GNU General Public License&n; *  as published by the Free Software Foundation; either version&n; *  2 of the License, or (at your option) any later version.&n; *&n; *  This file contains some low-level i2c access routines that&n; *  need to be used by various bits of the PowerMac platform code&n; *  at times where the real asynchronous &amp; interrupt driven driver&n; *  cannot be used. The API borrows some semantics from the darwin&n; *  driver in order to ease the implementation of the platform&n; *  properties parser&n; */
DECL|macro|DEBUG
macro_line|#undef DEBUG
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/adb.h&gt;
macro_line|#include &lt;linux/pmu.h&gt;
macro_line|#include &lt;asm/keylargo.h&gt;
macro_line|#include &lt;asm/uninorth.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/pmac_low_i2c.h&gt;
DECL|macro|MAX_LOW_I2C_HOST
mdefine_line|#define MAX_LOW_I2C_HOST&t;4
macro_line|#ifdef DEBUG
DECL|macro|DBG
mdefine_line|#define DBG(x...) do {&bslash;&n;&t;&t;printk(KERN_DEBUG &quot;KW:&quot; x);&t;&bslash;&n;&t;} while(0)
macro_line|#else
DECL|macro|DBG
mdefine_line|#define DBG(x...)
macro_line|#endif
r_struct
id|low_i2c_host
suffix:semicolon
DECL|typedef|low_i2c_func_t
r_typedef
r_int
(paren
op_star
id|low_i2c_func_t
)paren
(paren
r_struct
id|low_i2c_host
op_star
id|host
comma
id|u8
id|addr
comma
id|u8
id|sub
comma
id|u8
op_star
id|data
comma
r_int
id|len
)paren
suffix:semicolon
DECL|struct|low_i2c_host
r_struct
id|low_i2c_host
(brace
DECL|member|np
r_struct
id|device_node
op_star
id|np
suffix:semicolon
multiline_comment|/* OF device node */
DECL|member|mutex
r_struct
id|semaphore
id|mutex
suffix:semicolon
multiline_comment|/* Access mutex for use by i2c-keywest */
DECL|member|func
id|low_i2c_func_t
id|func
suffix:semicolon
multiline_comment|/* Access function */
DECL|member|is_open
r_int
r_int
id|is_open
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Poor man&squot;s access control */
DECL|member|mode
r_int
id|mode
suffix:semicolon
multiline_comment|/* Current mode */
DECL|member|channel
r_int
id|channel
suffix:semicolon
multiline_comment|/* Current channel */
DECL|member|num_channels
r_int
id|num_channels
suffix:semicolon
multiline_comment|/* Number of channels */
DECL|member|base
r_void
id|__iomem
op_star
id|base
suffix:semicolon
multiline_comment|/* For keywest-i2c, base address */
DECL|member|bsteps
r_int
id|bsteps
suffix:semicolon
multiline_comment|/* And register stepping */
DECL|member|speed
r_int
id|speed
suffix:semicolon
multiline_comment|/* And speed */
)brace
suffix:semicolon
DECL|variable|low_i2c_hosts
r_static
r_struct
id|low_i2c_host
id|low_i2c_hosts
(braket
id|MAX_LOW_I2C_HOST
)braket
suffix:semicolon
multiline_comment|/* No locking is necessary on allocation, we are running way before&n; * anything can race with us&n; */
DECL|function|find_low_i2c_host
r_static
r_struct
id|low_i2c_host
op_star
id|find_low_i2c_host
c_func
(paren
r_struct
id|device_node
op_star
id|np
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_LOW_I2C_HOST
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|low_i2c_hosts
(braket
id|i
)braket
dot
id|np
op_eq
id|np
)paren
r_return
op_amp
id|low_i2c_hosts
(braket
id|i
)braket
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *&n; * i2c-keywest implementation (UniNorth, U2, U3, Keylargo&squot;s)&n; *&n; */
multiline_comment|/*&n; * Keywest i2c definitions borrowed from drivers/i2c/i2c-keywest.h,&n; * should be moved somewhere in include/asm-ppc/&n; */
multiline_comment|/* Register indices */
r_typedef
r_enum
(brace
DECL|enumerator|reg_mode
id|reg_mode
op_assign
l_int|0
comma
DECL|enumerator|reg_control
id|reg_control
comma
DECL|enumerator|reg_status
id|reg_status
comma
DECL|enumerator|reg_isr
id|reg_isr
comma
DECL|enumerator|reg_ier
id|reg_ier
comma
DECL|enumerator|reg_addr
id|reg_addr
comma
DECL|enumerator|reg_subaddr
id|reg_subaddr
comma
DECL|enumerator|reg_data
id|reg_data
DECL|typedef|reg_t
)brace
id|reg_t
suffix:semicolon
multiline_comment|/* Mode register */
DECL|macro|KW_I2C_MODE_100KHZ
mdefine_line|#define KW_I2C_MODE_100KHZ&t;0x00
DECL|macro|KW_I2C_MODE_50KHZ
mdefine_line|#define KW_I2C_MODE_50KHZ&t;0x01
DECL|macro|KW_I2C_MODE_25KHZ
mdefine_line|#define KW_I2C_MODE_25KHZ&t;0x02
DECL|macro|KW_I2C_MODE_DUMB
mdefine_line|#define KW_I2C_MODE_DUMB&t;0x00
DECL|macro|KW_I2C_MODE_STANDARD
mdefine_line|#define KW_I2C_MODE_STANDARD&t;0x04
DECL|macro|KW_I2C_MODE_STANDARDSUB
mdefine_line|#define KW_I2C_MODE_STANDARDSUB&t;0x08
DECL|macro|KW_I2C_MODE_COMBINED
mdefine_line|#define KW_I2C_MODE_COMBINED&t;0x0C
DECL|macro|KW_I2C_MODE_MODE_MASK
mdefine_line|#define KW_I2C_MODE_MODE_MASK&t;0x0C
DECL|macro|KW_I2C_MODE_CHAN_MASK
mdefine_line|#define KW_I2C_MODE_CHAN_MASK&t;0xF0
multiline_comment|/* Control register */
DECL|macro|KW_I2C_CTL_AAK
mdefine_line|#define KW_I2C_CTL_AAK&t;&t;0x01
DECL|macro|KW_I2C_CTL_XADDR
mdefine_line|#define KW_I2C_CTL_XADDR&t;0x02
DECL|macro|KW_I2C_CTL_STOP
mdefine_line|#define KW_I2C_CTL_STOP&t;&t;0x04
DECL|macro|KW_I2C_CTL_START
mdefine_line|#define KW_I2C_CTL_START&t;0x08
multiline_comment|/* Status register */
DECL|macro|KW_I2C_STAT_BUSY
mdefine_line|#define KW_I2C_STAT_BUSY&t;0x01
DECL|macro|KW_I2C_STAT_LAST_AAK
mdefine_line|#define KW_I2C_STAT_LAST_AAK&t;0x02
DECL|macro|KW_I2C_STAT_LAST_RW
mdefine_line|#define KW_I2C_STAT_LAST_RW&t;0x04
DECL|macro|KW_I2C_STAT_SDA
mdefine_line|#define KW_I2C_STAT_SDA&t;&t;0x08
DECL|macro|KW_I2C_STAT_SCL
mdefine_line|#define KW_I2C_STAT_SCL&t;&t;0x10
multiline_comment|/* IER &amp; ISR registers */
DECL|macro|KW_I2C_IRQ_DATA
mdefine_line|#define KW_I2C_IRQ_DATA&t;&t;0x01
DECL|macro|KW_I2C_IRQ_ADDR
mdefine_line|#define KW_I2C_IRQ_ADDR&t;&t;0x02
DECL|macro|KW_I2C_IRQ_STOP
mdefine_line|#define KW_I2C_IRQ_STOP&t;&t;0x04
DECL|macro|KW_I2C_IRQ_START
mdefine_line|#define KW_I2C_IRQ_START&t;0x08
DECL|macro|KW_I2C_IRQ_MASK
mdefine_line|#define KW_I2C_IRQ_MASK&t;&t;0x0F
multiline_comment|/* State machine states */
r_enum
(brace
DECL|enumerator|state_idle
id|state_idle
comma
DECL|enumerator|state_addr
id|state_addr
comma
DECL|enumerator|state_read
id|state_read
comma
DECL|enumerator|state_write
id|state_write
comma
DECL|enumerator|state_stop
id|state_stop
comma
DECL|enumerator|state_dead
id|state_dead
)brace
suffix:semicolon
DECL|macro|WRONG_STATE
mdefine_line|#define WRONG_STATE(name) do {&bslash;&n;&t;&t;printk(KERN_DEBUG &quot;KW: wrong state. Got %s, state: %s (isr: %02x)&bslash;n&quot;, &bslash;&n;&t;&t;       name, __kw_state_names[state], isr); &bslash;&n;&t;} while(0)
DECL|variable|__kw_state_names
r_static
r_const
r_char
op_star
id|__kw_state_names
(braket
)braket
op_assign
(brace
l_string|&quot;state_idle&quot;
comma
l_string|&quot;state_addr&quot;
comma
l_string|&quot;state_read&quot;
comma
l_string|&quot;state_write&quot;
comma
l_string|&quot;state_stop&quot;
comma
l_string|&quot;state_dead&quot;
)brace
suffix:semicolon
DECL|function|__kw_read_reg
r_static
r_inline
id|u8
id|__kw_read_reg
c_func
(paren
r_struct
id|low_i2c_host
op_star
id|host
comma
id|reg_t
id|reg
)paren
(brace
r_return
id|readb
c_func
(paren
id|host-&gt;base
op_plus
(paren
(paren
(paren
r_int
r_int
)paren
id|reg
)paren
op_lshift
id|host-&gt;bsteps
)paren
)paren
suffix:semicolon
)brace
DECL|function|__kw_write_reg
r_static
r_inline
r_void
id|__kw_write_reg
c_func
(paren
r_struct
id|low_i2c_host
op_star
id|host
comma
id|reg_t
id|reg
comma
id|u8
id|val
)paren
(brace
id|writeb
c_func
(paren
id|val
comma
id|host-&gt;base
op_plus
(paren
(paren
(paren
r_int
)paren
id|reg
)paren
op_lshift
id|host-&gt;bsteps
)paren
)paren
suffix:semicolon
(paren
r_void
)paren
id|__kw_read_reg
c_func
(paren
id|host
comma
id|reg_subaddr
)paren
suffix:semicolon
)brace
DECL|macro|kw_write_reg
mdefine_line|#define kw_write_reg(reg, val)&t;__kw_write_reg(host, reg, val) 
DECL|macro|kw_read_reg
mdefine_line|#define kw_read_reg(reg)&t;__kw_read_reg(host, reg) 
multiline_comment|/* Don&squot;t schedule, the g5 fan controller is too&n; * timing sensitive&n; */
DECL|function|kw_wait_interrupt
r_static
id|u8
id|kw_wait_interrupt
c_func
(paren
r_struct
id|low_i2c_host
op_star
id|host
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|u8
id|isr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100000
suffix:semicolon
id|i
op_increment
)paren
(brace
id|isr
op_assign
id|kw_read_reg
c_func
(paren
id|reg_isr
)paren
op_amp
id|KW_I2C_IRQ_MASK
suffix:semicolon
r_if
c_cond
(paren
id|isr
op_ne
l_int|0
)paren
r_return
id|isr
suffix:semicolon
multiline_comment|/* This code is used with the timebase frozen, we cannot rely&n;&t;&t; * on udelay ! For now, just use a bogus loop&n;&t;&t; */
r_for
c_loop
(paren
id|j
op_assign
l_int|1
suffix:semicolon
id|j
OL
l_int|10000
suffix:semicolon
id|j
op_increment
)paren
id|mb
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
id|isr
suffix:semicolon
)brace
DECL|function|kw_handle_interrupt
r_static
r_int
id|kw_handle_interrupt
c_func
(paren
r_struct
id|low_i2c_host
op_star
id|host
comma
r_int
id|state
comma
r_int
id|rw
comma
r_int
op_star
id|rc
comma
id|u8
op_star
op_star
id|data
comma
r_int
op_star
id|len
comma
id|u8
id|isr
)paren
(brace
id|u8
id|ack
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;kw_handle_interrupt(%s, isr: %x)&bslash;n&quot;
comma
id|__kw_state_names
(braket
id|state
)braket
comma
id|isr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|state
op_ne
id|state_stop
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;KW: Timeout !&bslash;n&quot;
)paren
suffix:semicolon
op_star
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|stop
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_eq
id|state_stop
)paren
(brace
id|ack
op_assign
id|kw_read_reg
c_func
(paren
id|reg_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ack
op_amp
id|KW_I2C_STAT_BUSY
)paren
)paren
(brace
id|state
op_assign
id|state_idle
suffix:semicolon
id|kw_write_reg
c_func
(paren
id|reg_ier
comma
l_int|0x00
)paren
suffix:semicolon
)brace
)brace
r_return
id|state
suffix:semicolon
)brace
r_if
c_cond
(paren
id|isr
op_amp
id|KW_I2C_IRQ_ADDR
)paren
(brace
id|ack
op_assign
id|kw_read_reg
c_func
(paren
id|reg_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_ne
id|state_addr
)paren
(brace
id|kw_write_reg
c_func
(paren
id|reg_isr
comma
id|KW_I2C_IRQ_ADDR
)paren
suffix:semicolon
id|WRONG_STATE
c_func
(paren
l_string|&quot;KW_I2C_IRQ_ADDR&quot;
)paren
suffix:semicolon
op_star
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|stop
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ack
op_amp
id|KW_I2C_STAT_LAST_AAK
)paren
op_eq
l_int|0
)paren
(brace
op_star
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;KW: NAK on address&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|state_stop
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|rw
)paren
(brace
id|state
op_assign
id|state_read
suffix:semicolon
r_if
c_cond
(paren
op_star
id|len
OG
l_int|1
)paren
id|kw_write_reg
c_func
(paren
id|reg_control
comma
id|KW_I2C_CTL_AAK
)paren
suffix:semicolon
)brace
r_else
(brace
id|state
op_assign
id|state_write
suffix:semicolon
id|kw_write_reg
c_func
(paren
id|reg_data
comma
op_star
op_star
id|data
)paren
suffix:semicolon
(paren
op_star
id|data
)paren
op_increment
suffix:semicolon
(paren
op_star
id|len
)paren
op_decrement
suffix:semicolon
)brace
)brace
id|kw_write_reg
c_func
(paren
id|reg_isr
comma
id|KW_I2C_IRQ_ADDR
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|isr
op_amp
id|KW_I2C_IRQ_DATA
)paren
(brace
r_if
c_cond
(paren
id|state
op_eq
id|state_read
)paren
(brace
op_star
op_star
id|data
op_assign
id|kw_read_reg
c_func
(paren
id|reg_data
)paren
suffix:semicolon
(paren
op_star
id|data
)paren
op_increment
suffix:semicolon
(paren
op_star
id|len
)paren
op_decrement
suffix:semicolon
id|kw_write_reg
c_func
(paren
id|reg_isr
comma
id|KW_I2C_IRQ_DATA
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|len
)paren
op_eq
l_int|0
)paren
id|state
op_assign
id|state_stop
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
op_star
id|len
)paren
op_eq
l_int|1
)paren
id|kw_write_reg
c_func
(paren
id|reg_control
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|state
op_eq
id|state_write
)paren
(brace
id|ack
op_assign
id|kw_read_reg
c_func
(paren
id|reg_status
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ack
op_amp
id|KW_I2C_STAT_LAST_AAK
)paren
op_eq
l_int|0
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;KW: nack on data write&bslash;n&quot;
)paren
suffix:semicolon
op_star
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|stop
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_star
id|len
)paren
(brace
id|kw_write_reg
c_func
(paren
id|reg_data
comma
op_star
op_star
id|data
)paren
suffix:semicolon
(paren
op_star
id|data
)paren
op_increment
suffix:semicolon
(paren
op_star
id|len
)paren
op_decrement
suffix:semicolon
)brace
r_else
(brace
id|kw_write_reg
c_func
(paren
id|reg_control
comma
id|KW_I2C_CTL_STOP
)paren
suffix:semicolon
id|state
op_assign
id|state_stop
suffix:semicolon
op_star
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
id|kw_write_reg
c_func
(paren
id|reg_isr
comma
id|KW_I2C_IRQ_DATA
)paren
suffix:semicolon
)brace
r_else
(brace
id|kw_write_reg
c_func
(paren
id|reg_isr
comma
id|KW_I2C_IRQ_DATA
)paren
suffix:semicolon
id|WRONG_STATE
c_func
(paren
l_string|&quot;KW_I2C_IRQ_DATA&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_ne
id|state_stop
)paren
(brace
op_star
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|stop
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|isr
op_amp
id|KW_I2C_IRQ_STOP
)paren
(brace
id|kw_write_reg
c_func
(paren
id|reg_isr
comma
id|KW_I2C_IRQ_STOP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_ne
id|state_stop
)paren
(brace
id|WRONG_STATE
c_func
(paren
l_string|&quot;KW_I2C_IRQ_STOP&quot;
)paren
suffix:semicolon
op_star
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_return
id|state_idle
suffix:semicolon
)brace
r_if
c_cond
(paren
id|isr
op_amp
id|KW_I2C_IRQ_START
)paren
id|kw_write_reg
c_func
(paren
id|reg_isr
comma
id|KW_I2C_IRQ_START
)paren
suffix:semicolon
r_return
id|state
suffix:semicolon
id|stop
suffix:colon
id|kw_write_reg
c_func
(paren
id|reg_control
comma
id|KW_I2C_CTL_STOP
)paren
suffix:semicolon
r_return
id|state_stop
suffix:semicolon
)brace
DECL|function|keywest_low_i2c_func
r_static
r_int
id|keywest_low_i2c_func
c_func
(paren
r_struct
id|low_i2c_host
op_star
id|host
comma
id|u8
id|addr
comma
id|u8
id|subaddr
comma
id|u8
op_star
id|data
comma
r_int
id|len
)paren
(brace
id|u8
id|mode_reg
op_assign
id|host-&gt;speed
suffix:semicolon
r_int
id|state
op_assign
id|state_addr
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Setup mode &amp; subaddress if any */
r_switch
c_cond
(paren
id|host-&gt;mode
)paren
(brace
r_case
id|pmac_low_i2c_mode_dumb
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;low_i2c: Dumb mode not supported !&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|pmac_low_i2c_mode_std
suffix:colon
id|mode_reg
op_or_assign
id|KW_I2C_MODE_STANDARD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|pmac_low_i2c_mode_stdsub
suffix:colon
id|mode_reg
op_or_assign
id|KW_I2C_MODE_STANDARDSUB
suffix:semicolon
r_break
suffix:semicolon
r_case
id|pmac_low_i2c_mode_combined
suffix:colon
id|mode_reg
op_or_assign
id|KW_I2C_MODE_COMBINED
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Setup channel &amp; clear pending irqs */
id|kw_write_reg
c_func
(paren
id|reg_isr
comma
id|kw_read_reg
c_func
(paren
id|reg_isr
)paren
)paren
suffix:semicolon
id|kw_write_reg
c_func
(paren
id|reg_mode
comma
id|mode_reg
op_or
(paren
id|host-&gt;channel
op_lshift
l_int|4
)paren
)paren
suffix:semicolon
id|kw_write_reg
c_func
(paren
id|reg_status
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set up address and r/w bit */
id|kw_write_reg
c_func
(paren
id|reg_addr
comma
id|addr
)paren
suffix:semicolon
multiline_comment|/* Set up the sub address */
r_if
c_cond
(paren
(paren
id|mode_reg
op_amp
id|KW_I2C_MODE_MODE_MASK
)paren
op_eq
id|KW_I2C_MODE_STANDARDSUB
op_logical_or
(paren
id|mode_reg
op_amp
id|KW_I2C_MODE_MODE_MASK
)paren
op_eq
id|KW_I2C_MODE_COMBINED
)paren
id|kw_write_reg
c_func
(paren
id|reg_subaddr
comma
id|subaddr
)paren
suffix:semicolon
multiline_comment|/* Start sending address &amp; disable interrupt*/
id|kw_write_reg
c_func
(paren
id|reg_ier
comma
l_int|0
multiline_comment|/*KW_I2C_IRQ_MASK*/
)paren
suffix:semicolon
id|kw_write_reg
c_func
(paren
id|reg_control
comma
id|KW_I2C_CTL_XADDR
)paren
suffix:semicolon
multiline_comment|/* State machine, to turn into an interrupt handler */
r_while
c_loop
(paren
id|state
op_ne
id|state_idle
)paren
(brace
id|u8
id|isr
op_assign
id|kw_wait_interrupt
c_func
(paren
id|host
)paren
suffix:semicolon
id|state
op_assign
id|kw_handle_interrupt
c_func
(paren
id|host
comma
id|state
comma
id|addr
op_amp
l_int|1
comma
op_amp
id|rc
comma
op_amp
id|data
comma
op_amp
id|len
comma
id|isr
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
DECL|function|keywest_low_i2c_add
r_static
r_void
id|keywest_low_i2c_add
c_func
(paren
r_struct
id|device_node
op_star
id|np
)paren
(brace
r_struct
id|low_i2c_host
op_star
id|host
op_assign
id|find_low_i2c_host
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
id|u32
op_star
id|psteps
comma
op_star
id|prate
comma
id|steps
comma
id|aoffset
op_assign
l_int|0
suffix:semicolon
r_struct
id|device_node
op_star
id|parent
suffix:semicolon
r_if
c_cond
(paren
id|host
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;low_i2c: Can&squot;t allocate host for %s&bslash;n&quot;
comma
id|np-&gt;full_name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memset
c_func
(paren
id|host
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|host
)paren
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|host-&gt;mutex
)paren
suffix:semicolon
id|host-&gt;np
op_assign
id|of_node_get
c_func
(paren
id|np
)paren
suffix:semicolon
id|psteps
op_assign
(paren
id|u32
op_star
)paren
id|get_property
c_func
(paren
id|np
comma
l_string|&quot;AAPL,address-step&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|steps
op_assign
id|psteps
ques
c_cond
(paren
op_star
id|psteps
)paren
suffix:colon
l_int|0x10
suffix:semicolon
r_for
c_loop
(paren
id|host-&gt;bsteps
op_assign
l_int|0
suffix:semicolon
(paren
id|steps
op_amp
l_int|0x01
)paren
op_eq
l_int|0
suffix:semicolon
id|host-&gt;bsteps
op_increment
)paren
id|steps
op_rshift_assign
l_int|1
suffix:semicolon
id|parent
op_assign
id|of_get_parent
c_func
(paren
id|np
)paren
suffix:semicolon
id|host-&gt;num_channels
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|parent
op_logical_and
id|parent-&gt;name
(braket
l_int|0
)braket
op_eq
l_char|&squot;u&squot;
)paren
(brace
id|host-&gt;num_channels
op_assign
l_int|2
suffix:semicolon
id|aoffset
op_assign
l_int|3
suffix:semicolon
)brace
multiline_comment|/* Select interface rate */
id|host-&gt;speed
op_assign
id|KW_I2C_MODE_100KHZ
suffix:semicolon
id|prate
op_assign
(paren
id|u32
op_star
)paren
id|get_property
c_func
(paren
id|np
comma
l_string|&quot;AAPL,i2c-rate&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prate
)paren
r_switch
c_cond
(paren
op_star
id|prate
)paren
(brace
r_case
l_int|100
suffix:colon
id|host-&gt;speed
op_assign
id|KW_I2C_MODE_100KHZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|50
suffix:colon
id|host-&gt;speed
op_assign
id|KW_I2C_MODE_50KHZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|25
suffix:colon
id|host-&gt;speed
op_assign
id|KW_I2C_MODE_25KHZ
suffix:semicolon
r_break
suffix:semicolon
)brace
id|host-&gt;mode
op_assign
id|pmac_low_i2c_mode_std
suffix:semicolon
id|host-&gt;base
op_assign
id|ioremap
c_func
(paren
id|np-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
op_plus
id|aoffset
comma
id|np-&gt;addrs
(braket
l_int|0
)braket
dot
id|size
)paren
suffix:semicolon
id|host-&gt;func
op_assign
id|keywest_low_i2c_func
suffix:semicolon
)brace
multiline_comment|/*&n; *&n; * PMU implementation&n; *&n; */
macro_line|#ifdef CONFIG_ADB_PMU
DECL|function|pmu_low_i2c_func
r_static
r_int
id|pmu_low_i2c_func
c_func
(paren
r_struct
id|low_i2c_host
op_star
id|host
comma
id|u8
id|addr
comma
id|u8
id|sub
comma
id|u8
op_star
id|data
comma
r_int
id|len
)paren
(brace
singleline_comment|// TODO
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|pmu_low_i2c_add
r_static
r_void
id|pmu_low_i2c_add
c_func
(paren
r_struct
id|device_node
op_star
id|np
)paren
(brace
r_struct
id|low_i2c_host
op_star
id|host
op_assign
id|find_low_i2c_host
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;low_i2c: Can&squot;t allocate host for %s&bslash;n&quot;
comma
id|np-&gt;full_name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memset
c_func
(paren
id|host
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|host
)paren
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|host-&gt;mutex
)paren
suffix:semicolon
id|host-&gt;np
op_assign
id|of_node_get
c_func
(paren
id|np
)paren
suffix:semicolon
id|host-&gt;num_channels
op_assign
l_int|3
suffix:semicolon
id|host-&gt;mode
op_assign
id|pmac_low_i2c_mode_std
suffix:semicolon
id|host-&gt;func
op_assign
id|pmu_low_i2c_func
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ADB_PMU */
DECL|function|pmac_init_low_i2c
r_void
id|__init
id|pmac_init_low_i2c
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|np
suffix:semicolon
multiline_comment|/* Probe keywest-i2c busses */
id|np
op_assign
id|of_find_compatible_node
c_func
(paren
l_int|NULL
comma
l_string|&quot;i2c&quot;
comma
l_string|&quot;keywest-i2c&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|np
)paren
(brace
id|keywest_low_i2c_add
c_func
(paren
id|np
)paren
suffix:semicolon
id|np
op_assign
id|of_find_compatible_node
c_func
(paren
id|np
comma
l_string|&quot;i2c&quot;
comma
l_string|&quot;keywest-i2c&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ADB_PMU
multiline_comment|/* Probe PMU busses */
id|np
op_assign
id|of_find_node_by_name
c_func
(paren
l_int|NULL
comma
l_string|&quot;via-pmu&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np
)paren
id|pmu_low_i2c_add
c_func
(paren
id|np
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_ADB_PMU */
multiline_comment|/* TODO: Add CUDA support as well */
)brace
DECL|function|pmac_low_i2c_lock
r_int
id|pmac_low_i2c_lock
c_func
(paren
r_struct
id|device_node
op_star
id|np
)paren
(brace
r_struct
id|low_i2c_host
op_star
id|host
op_assign
id|find_low_i2c_host
c_func
(paren
id|np
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|down
c_func
(paren
op_amp
id|host-&gt;mutex
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|pmac_low_i2c_lock
id|EXPORT_SYMBOL
c_func
(paren
id|pmac_low_i2c_lock
)paren
suffix:semicolon
DECL|function|pmac_low_i2c_unlock
r_int
id|pmac_low_i2c_unlock
c_func
(paren
r_struct
id|device_node
op_star
id|np
)paren
(brace
r_struct
id|low_i2c_host
op_star
id|host
op_assign
id|find_low_i2c_host
c_func
(paren
id|np
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|up
c_func
(paren
op_amp
id|host-&gt;mutex
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|pmac_low_i2c_unlock
id|EXPORT_SYMBOL
c_func
(paren
id|pmac_low_i2c_unlock
)paren
suffix:semicolon
DECL|function|pmac_low_i2c_open
r_int
id|pmac_low_i2c_open
c_func
(paren
r_struct
id|device_node
op_star
id|np
comma
r_int
id|channel
)paren
(brace
r_struct
id|low_i2c_host
op_star
id|host
op_assign
id|find_low_i2c_host
c_func
(paren
id|np
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|channel
op_ge
id|host-&gt;num_channels
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|down
c_func
(paren
op_amp
id|host-&gt;mutex
)paren
suffix:semicolon
id|host-&gt;is_open
op_assign
l_int|1
suffix:semicolon
id|host-&gt;channel
op_assign
id|channel
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|pmac_low_i2c_open
id|EXPORT_SYMBOL
c_func
(paren
id|pmac_low_i2c_open
)paren
suffix:semicolon
DECL|function|pmac_low_i2c_close
r_int
id|pmac_low_i2c_close
c_func
(paren
r_struct
id|device_node
op_star
id|np
)paren
(brace
r_struct
id|low_i2c_host
op_star
id|host
op_assign
id|find_low_i2c_host
c_func
(paren
id|np
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|host-&gt;is_open
op_assign
l_int|0
suffix:semicolon
id|up
c_func
(paren
op_amp
id|host-&gt;mutex
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|pmac_low_i2c_close
id|EXPORT_SYMBOL
c_func
(paren
id|pmac_low_i2c_close
)paren
suffix:semicolon
DECL|function|pmac_low_i2c_setmode
r_int
id|pmac_low_i2c_setmode
c_func
(paren
r_struct
id|device_node
op_star
id|np
comma
r_int
id|mode
)paren
(brace
r_struct
id|low_i2c_host
op_star
id|host
op_assign
id|find_low_i2c_host
c_func
(paren
id|np
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|WARN_ON
c_func
(paren
op_logical_neg
id|host-&gt;is_open
)paren
suffix:semicolon
id|host-&gt;mode
op_assign
id|mode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|pmac_low_i2c_setmode
id|EXPORT_SYMBOL
c_func
(paren
id|pmac_low_i2c_setmode
)paren
suffix:semicolon
DECL|function|pmac_low_i2c_xfer
r_int
id|pmac_low_i2c_xfer
c_func
(paren
r_struct
id|device_node
op_star
id|np
comma
id|u8
id|addrdir
comma
id|u8
id|subaddr
comma
id|u8
op_star
id|data
comma
r_int
id|len
)paren
(brace
r_struct
id|low_i2c_host
op_star
id|host
op_assign
id|find_low_i2c_host
c_func
(paren
id|np
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|WARN_ON
c_func
(paren
op_logical_neg
id|host-&gt;is_open
)paren
suffix:semicolon
r_return
id|host
op_member_access_from_pointer
id|func
c_func
(paren
id|host
comma
id|addrdir
comma
id|subaddr
comma
id|data
comma
id|len
)paren
suffix:semicolon
)brace
DECL|variable|pmac_low_i2c_xfer
id|EXPORT_SYMBOL
c_func
(paren
id|pmac_low_i2c_xfer
)paren
suffix:semicolon
eof
