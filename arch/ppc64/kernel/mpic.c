multiline_comment|/*&n; *  arch/ppc64/kernel/mpic.c&n; *&n; *  Driver for interrupt controllers following the OpenPIC standard, the&n; *  common implementation beeing IBM&squot;s MPIC. This driver also can deal&n; *  with various broken implementations of this HW.&n; *&n; *  Copyright (C) 2004 Benjamin Herrenschmidt, IBM Corp.&n; *&n; *  This file is subject to the terms and conditions of the GNU General Public&n; *  License.  See the file COPYING in the main directory of this archive&n; *  for more details.&n; */
DECL|macro|DEBUG
macro_line|#undef DEBUG
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/signal.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &quot;mpic.h&quot;
macro_line|#ifdef DEBUG
DECL|macro|DBG
mdefine_line|#define DBG(fmt...) printk(fmt)
macro_line|#else
DECL|macro|DBG
mdefine_line|#define DBG(fmt...)
macro_line|#endif
DECL|variable|mpics
r_static
r_struct
id|mpic
op_star
id|mpics
suffix:semicolon
DECL|variable|mpic_primary
r_static
r_struct
id|mpic
op_star
id|mpic_primary
suffix:semicolon
DECL|variable|mpic_lock
r_static
id|spinlock_t
id|mpic_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/*&n; * Register accessor functions&n; */
DECL|function|_mpic_read
r_static
r_inline
id|u32
id|_mpic_read
c_func
(paren
r_int
r_int
id|be
comma
r_volatile
id|u32
id|__iomem
op_star
id|base
comma
r_int
r_int
id|reg
)paren
(brace
r_if
c_cond
(paren
id|be
)paren
r_return
id|in_be32
c_func
(paren
id|base
op_plus
(paren
id|reg
op_rshift
l_int|2
)paren
)paren
suffix:semicolon
r_else
r_return
id|in_le32
c_func
(paren
id|base
op_plus
(paren
id|reg
op_rshift
l_int|2
)paren
)paren
suffix:semicolon
)brace
DECL|function|_mpic_write
r_static
r_inline
r_void
id|_mpic_write
c_func
(paren
r_int
r_int
id|be
comma
r_volatile
id|u32
id|__iomem
op_star
id|base
comma
r_int
r_int
id|reg
comma
id|u32
id|value
)paren
(brace
r_if
c_cond
(paren
id|be
)paren
id|out_be32
c_func
(paren
id|base
op_plus
(paren
id|reg
op_rshift
l_int|2
)paren
comma
id|value
)paren
suffix:semicolon
r_else
id|out_le32
c_func
(paren
id|base
op_plus
(paren
id|reg
op_rshift
l_int|2
)paren
comma
id|value
)paren
suffix:semicolon
)brace
DECL|function|_mpic_ipi_read
r_static
r_inline
id|u32
id|_mpic_ipi_read
c_func
(paren
r_struct
id|mpic
op_star
id|mpic
comma
r_int
r_int
id|ipi
)paren
(brace
r_int
r_int
id|be
op_assign
(paren
id|mpic-&gt;flags
op_amp
id|MPIC_BIG_ENDIAN
)paren
op_ne
l_int|0
suffix:semicolon
r_int
r_int
id|offset
op_assign
id|MPIC_GREG_IPI_VECTOR_PRI_0
op_plus
(paren
id|ipi
op_star
l_int|0x10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpic-&gt;flags
op_amp
id|MPIC_BROKEN_IPI
)paren
id|be
op_assign
op_logical_neg
id|be
suffix:semicolon
r_return
id|_mpic_read
c_func
(paren
id|be
comma
id|mpic-&gt;gregs
comma
id|offset
)paren
suffix:semicolon
)brace
DECL|function|_mpic_ipi_write
r_static
r_inline
r_void
id|_mpic_ipi_write
c_func
(paren
r_struct
id|mpic
op_star
id|mpic
comma
r_int
r_int
id|ipi
comma
id|u32
id|value
)paren
(brace
r_int
r_int
id|offset
op_assign
id|MPIC_GREG_IPI_VECTOR_PRI_0
op_plus
(paren
id|ipi
op_star
l_int|0x10
)paren
suffix:semicolon
id|_mpic_write
c_func
(paren
id|mpic-&gt;flags
op_amp
id|MPIC_BIG_ENDIAN
comma
id|mpic-&gt;gregs
comma
id|offset
comma
id|value
)paren
suffix:semicolon
)brace
DECL|function|_mpic_cpu_read
r_static
r_inline
id|u32
id|_mpic_cpu_read
c_func
(paren
r_struct
id|mpic
op_star
id|mpic
comma
r_int
r_int
id|reg
)paren
(brace
r_int
r_int
id|cpu
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mpic-&gt;flags
op_amp
id|MPIC_PRIMARY
)paren
id|cpu
op_assign
id|hard_smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_return
id|_mpic_read
c_func
(paren
id|mpic-&gt;flags
op_amp
id|MPIC_BIG_ENDIAN
comma
id|mpic-&gt;cpuregs
(braket
id|cpu
)braket
comma
id|reg
)paren
suffix:semicolon
)brace
DECL|function|_mpic_cpu_write
r_static
r_inline
r_void
id|_mpic_cpu_write
c_func
(paren
r_struct
id|mpic
op_star
id|mpic
comma
r_int
r_int
id|reg
comma
id|u32
id|value
)paren
(brace
r_int
r_int
id|cpu
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mpic-&gt;flags
op_amp
id|MPIC_PRIMARY
)paren
id|cpu
op_assign
id|hard_smp_processor_id
c_func
(paren
)paren
suffix:semicolon
id|_mpic_write
c_func
(paren
id|mpic-&gt;flags
op_amp
id|MPIC_BIG_ENDIAN
comma
id|mpic-&gt;cpuregs
(braket
id|cpu
)braket
comma
id|reg
comma
id|value
)paren
suffix:semicolon
)brace
DECL|function|_mpic_irq_read
r_static
r_inline
id|u32
id|_mpic_irq_read
c_func
(paren
r_struct
id|mpic
op_star
id|mpic
comma
r_int
r_int
id|src_no
comma
r_int
r_int
id|reg
)paren
(brace
r_int
r_int
id|isu
op_assign
id|src_no
op_rshift
id|mpic-&gt;isu_shift
suffix:semicolon
r_int
r_int
id|idx
op_assign
id|src_no
op_amp
id|mpic-&gt;isu_mask
suffix:semicolon
r_return
id|_mpic_read
c_func
(paren
id|mpic-&gt;flags
op_amp
id|MPIC_BIG_ENDIAN
comma
id|mpic-&gt;isus
(braket
id|isu
)braket
comma
id|reg
op_plus
(paren
id|idx
op_star
id|MPIC_IRQ_STRIDE
)paren
)paren
suffix:semicolon
)brace
DECL|function|_mpic_irq_write
r_static
r_inline
r_void
id|_mpic_irq_write
c_func
(paren
r_struct
id|mpic
op_star
id|mpic
comma
r_int
r_int
id|src_no
comma
r_int
r_int
id|reg
comma
id|u32
id|value
)paren
(brace
r_int
r_int
id|isu
op_assign
id|src_no
op_rshift
id|mpic-&gt;isu_shift
suffix:semicolon
r_int
r_int
id|idx
op_assign
id|src_no
op_amp
id|mpic-&gt;isu_mask
suffix:semicolon
id|_mpic_write
c_func
(paren
id|mpic-&gt;flags
op_amp
id|MPIC_BIG_ENDIAN
comma
id|mpic-&gt;isus
(braket
id|isu
)braket
comma
id|reg
op_plus
(paren
id|idx
op_star
id|MPIC_IRQ_STRIDE
)paren
comma
id|value
)paren
suffix:semicolon
)brace
DECL|macro|mpic_read
mdefine_line|#define mpic_read(b,r)&t;&t;_mpic_read(mpic-&gt;flags &amp; MPIC_BIG_ENDIAN,(b),(r))
DECL|macro|mpic_write
mdefine_line|#define mpic_write(b,r,v)&t;_mpic_write(mpic-&gt;flags &amp; MPIC_BIG_ENDIAN,(b),(r),(v))
DECL|macro|mpic_ipi_read
mdefine_line|#define mpic_ipi_read(i)&t;_mpic_ipi_read(mpic,(i))
DECL|macro|mpic_ipi_write
mdefine_line|#define mpic_ipi_write(i,v)&t;_mpic_ipi_write(mpic,(i),(v))
DECL|macro|mpic_cpu_read
mdefine_line|#define mpic_cpu_read(i)&t;_mpic_cpu_read(mpic,(i))
DECL|macro|mpic_cpu_write
mdefine_line|#define mpic_cpu_write(i,v)&t;_mpic_cpu_write(mpic,(i),(v))
DECL|macro|mpic_irq_read
mdefine_line|#define mpic_irq_read(s,r)&t;_mpic_irq_read(mpic,(s),(r))
DECL|macro|mpic_irq_write
mdefine_line|#define mpic_irq_write(s,r,v)&t;_mpic_irq_write(mpic,(s),(r),(v))
multiline_comment|/*&n; * Low level utility functions&n; */
multiline_comment|/* Check if we have one of those nice broken MPICs with a flipped endian on&n; * reads from IPI registers&n; */
DECL|function|mpic_test_broken_ipi
r_static
r_void
id|__init
id|mpic_test_broken_ipi
c_func
(paren
r_struct
id|mpic
op_star
id|mpic
)paren
(brace
id|u32
id|r
suffix:semicolon
id|mpic_write
c_func
(paren
id|mpic-&gt;gregs
comma
id|MPIC_GREG_IPI_VECTOR_PRI_0
comma
id|MPIC_VECPRI_MASK
)paren
suffix:semicolon
id|r
op_assign
id|mpic_read
c_func
(paren
id|mpic-&gt;gregs
comma
id|MPIC_GREG_IPI_VECTOR_PRI_0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
op_eq
id|le32_to_cpu
c_func
(paren
id|MPIC_VECPRI_MASK
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;mpic: Detected reversed IPI registers&bslash;n&quot;
)paren
suffix:semicolon
id|mpic-&gt;flags
op_or_assign
id|MPIC_BROKEN_IPI
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_MPIC_BROKEN_U3
multiline_comment|/* Test if an interrupt is sourced from HyperTransport (used on broken U3s)&n; * to force the edge setting on the MPIC and do the ack workaround.&n; */
DECL|function|mpic_is_ht_interrupt
r_static
r_inline
r_int
id|mpic_is_ht_interrupt
c_func
(paren
r_struct
id|mpic
op_star
id|mpic
comma
r_int
r_int
id|source_no
)paren
(brace
r_if
c_cond
(paren
id|source_no
op_ge
l_int|128
op_logical_or
op_logical_neg
id|mpic-&gt;fixups
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|mpic-&gt;fixups
(braket
id|source_no
)braket
dot
id|base
op_ne
l_int|NULL
suffix:semicolon
)brace
DECL|function|mpic_apic_end_irq
r_static
r_inline
r_void
id|mpic_apic_end_irq
c_func
(paren
r_struct
id|mpic
op_star
id|mpic
comma
r_int
r_int
id|source_no
)paren
(brace
r_struct
id|mpic_irq_fixup
op_star
id|fixup
op_assign
op_amp
id|mpic-&gt;fixups
(braket
id|source_no
)braket
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|mpic-&gt;fixup_lock
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x11
op_plus
l_int|2
op_star
id|fixup-&gt;irq
comma
id|fixup-&gt;base
)paren
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
id|fixup-&gt;base
op_plus
l_int|2
)paren
suffix:semicolon
id|writel
c_func
(paren
id|tmp
op_or
l_int|0x80000000ul
comma
id|fixup-&gt;base
op_plus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* config writes shouldn&squot;t be posted but let&squot;s be safe ... */
(paren
r_void
)paren
id|readl
c_func
(paren
id|fixup-&gt;base
op_plus
l_int|2
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|mpic-&gt;fixup_lock
)paren
suffix:semicolon
)brace
DECL|function|mpic_amd8111_read_irq
r_static
r_void
id|__init
id|mpic_amd8111_read_irq
c_func
(paren
r_struct
id|mpic
op_star
id|mpic
comma
id|u8
id|__iomem
op_star
id|devbase
)paren
(brace
r_int
id|i
comma
id|irq
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;mpic:    - Workarounds on AMD 8111 @ %p&bslash;n&quot;
comma
id|devbase
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|24
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writeb
c_func
(paren
l_int|0x10
op_plus
l_int|2
op_star
id|i
comma
id|devbase
op_plus
l_int|0xf2
)paren
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
id|devbase
op_plus
l_int|0xf4
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_amp
l_int|0x1
)paren
op_logical_or
op_logical_neg
(paren
id|tmp
op_amp
l_int|0x20
)paren
)paren
r_continue
suffix:semicolon
id|irq
op_assign
(paren
id|tmp
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|mpic-&gt;fixups
(braket
id|irq
)braket
dot
id|irq
op_assign
id|i
suffix:semicolon
id|mpic-&gt;fixups
(braket
id|irq
)braket
dot
id|base
op_assign
id|devbase
op_plus
l_int|0xf2
suffix:semicolon
)brace
)brace
DECL|function|mpic_amd8131_read_irq
r_static
r_void
id|__init
id|mpic_amd8131_read_irq
c_func
(paren
r_struct
id|mpic
op_star
id|mpic
comma
id|u8
id|__iomem
op_star
id|devbase
)paren
(brace
r_int
id|i
comma
id|irq
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;mpic:    - Workarounds on AMD 8131 @ %p&bslash;n&quot;
comma
id|devbase
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writeb
c_func
(paren
l_int|0x10
op_plus
l_int|2
op_star
id|i
comma
id|devbase
op_plus
l_int|0xba
)paren
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
id|devbase
op_plus
l_int|0xbc
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_amp
l_int|0x1
)paren
op_logical_or
op_logical_neg
(paren
id|tmp
op_amp
l_int|0x20
)paren
)paren
r_continue
suffix:semicolon
id|irq
op_assign
(paren
id|tmp
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|mpic-&gt;fixups
(braket
id|irq
)braket
dot
id|irq
op_assign
id|i
suffix:semicolon
id|mpic-&gt;fixups
(braket
id|irq
)braket
dot
id|base
op_assign
id|devbase
op_plus
l_int|0xba
suffix:semicolon
)brace
)brace
DECL|function|mpic_scan_ioapics
r_static
r_void
id|__init
id|mpic_scan_ioapics
c_func
(paren
r_struct
id|mpic
op_star
id|mpic
)paren
(brace
r_int
r_int
id|devfn
suffix:semicolon
id|u8
id|__iomem
op_star
id|cfgspace
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;mpic: Setting up IO-APICs workarounds for U3&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Allocate fixups array */
id|mpic-&gt;fixups
op_assign
id|alloc_bootmem
c_func
(paren
l_int|128
op_star
r_sizeof
(paren
r_struct
id|mpic_irq_fixup
)paren
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|mpic-&gt;fixups
op_eq
l_int|NULL
)paren
suffix:semicolon
id|memset
c_func
(paren
id|mpic-&gt;fixups
comma
l_int|0
comma
l_int|128
op_star
r_sizeof
(paren
r_struct
id|mpic_irq_fixup
)paren
)paren
suffix:semicolon
multiline_comment|/* Init spinlock */
id|spin_lock_init
c_func
(paren
op_amp
id|mpic-&gt;fixup_lock
)paren
suffix:semicolon
multiline_comment|/* Map u3 config space. We assume all IO-APICs are on the primary bus&n;&t; * and slot will never be above &quot;0xf&quot; so we only need to map 32k&n;&t; */
id|cfgspace
op_assign
(paren
r_int
r_char
id|__iomem
op_star
)paren
id|ioremap
c_func
(paren
l_int|0xf2000000
comma
l_int|0x8000
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|cfgspace
op_eq
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Now we scan all slots. We do a very quick scan, we read the header type,&n;&t; * vendor ID and device ID only, that&squot;s plenty enough&n;&t; */
r_for
c_loop
(paren
id|devfn
op_assign
l_int|0
suffix:semicolon
id|devfn
OL
id|PCI_DEVFN
c_func
(paren
l_int|0x10
comma
l_int|0
)paren
suffix:semicolon
id|devfn
op_increment
)paren
(brace
id|u8
id|__iomem
op_star
id|devbase
op_assign
id|cfgspace
op_plus
(paren
id|devfn
op_lshift
l_int|8
)paren
suffix:semicolon
id|u8
id|hdr_type
op_assign
id|readb
c_func
(paren
id|devbase
op_plus
id|PCI_HEADER_TYPE
)paren
suffix:semicolon
id|u32
id|l
op_assign
id|readl
c_func
(paren
id|devbase
op_plus
id|PCI_VENDOR_ID
)paren
suffix:semicolon
id|u16
id|vendor_id
comma
id|device_id
suffix:semicolon
r_int
id|multifunc
op_assign
l_int|0
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;devfn %x, l: %x&bslash;n&quot;
comma
id|devfn
comma
id|l
)paren
suffix:semicolon
multiline_comment|/* If no device, skip */
r_if
c_cond
(paren
id|l
op_eq
l_int|0xffffffff
op_logical_or
id|l
op_eq
l_int|0x00000000
op_logical_or
id|l
op_eq
l_int|0x0000ffff
op_logical_or
id|l
op_eq
l_int|0xffff0000
)paren
r_goto
id|next
suffix:semicolon
multiline_comment|/* Check if it&squot;s a multifunction device (only really used&n;&t;&t; * to function 0 though&n;&t;&t; */
id|multifunc
op_assign
op_logical_neg
op_logical_neg
(paren
id|hdr_type
op_amp
l_int|0x80
)paren
suffix:semicolon
id|vendor_id
op_assign
id|l
op_amp
l_int|0xffff
suffix:semicolon
id|device_id
op_assign
(paren
id|l
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
multiline_comment|/* If a known device, go to fixup setup code */
r_if
c_cond
(paren
id|vendor_id
op_eq
id|PCI_VENDOR_ID_AMD
op_logical_and
id|device_id
op_eq
l_int|0x7460
)paren
id|mpic_amd8111_read_irq
c_func
(paren
id|mpic
comma
id|devbase
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vendor_id
op_eq
id|PCI_VENDOR_ID_AMD
op_logical_and
id|device_id
op_eq
l_int|0x7450
)paren
id|mpic_amd8131_read_irq
c_func
(paren
id|mpic
comma
id|devbase
)paren
suffix:semicolon
id|next
suffix:colon
multiline_comment|/* next device, if function 0 */
r_if
c_cond
(paren
(paren
id|PCI_FUNC
c_func
(paren
id|devfn
)paren
op_eq
l_int|0
)paren
op_logical_and
op_logical_neg
id|multifunc
)paren
id|devfn
op_add_assign
l_int|7
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_MPIC_BROKEN_U3 */
multiline_comment|/* Find an mpic associated with a given linux interrupt */
DECL|function|mpic_find
r_static
r_struct
id|mpic
op_star
id|mpic_find
c_func
(paren
r_int
r_int
id|irq
comma
r_int
r_int
op_star
id|is_ipi
)paren
(brace
r_struct
id|mpic
op_star
id|mpic
op_assign
id|mpics
suffix:semicolon
r_while
c_loop
(paren
id|mpic
)paren
(brace
multiline_comment|/* search IPIs first since they may override the main interrupts */
r_if
c_cond
(paren
id|irq
op_ge
id|mpic-&gt;ipi_offset
op_logical_and
id|irq
OL
(paren
id|mpic-&gt;ipi_offset
op_plus
l_int|4
)paren
)paren
(brace
r_if
c_cond
(paren
id|is_ipi
)paren
op_star
id|is_ipi
op_assign
l_int|1
suffix:semicolon
r_return
id|mpic
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irq
op_ge
id|mpic-&gt;irq_offset
op_logical_and
id|irq
OL
(paren
id|mpic-&gt;irq_offset
op_plus
id|mpic-&gt;irq_count
)paren
)paren
(brace
r_if
c_cond
(paren
id|is_ipi
)paren
op_star
id|is_ipi
op_assign
l_int|0
suffix:semicolon
r_return
id|mpic
suffix:semicolon
)brace
id|mpic
op_assign
id|mpic
op_member_access_from_pointer
id|next
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Convert a cpu mask from logical to physical cpu numbers. */
DECL|function|mpic_physmask
r_static
r_inline
id|u32
id|mpic_physmask
c_func
(paren
id|u32
id|cpumask
)paren
(brace
r_int
id|i
suffix:semicolon
id|u32
id|mask
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_CPUS
suffix:semicolon
op_increment
id|i
comma
id|cpumask
op_rshift_assign
l_int|1
)paren
id|mask
op_or_assign
(paren
id|cpumask
op_amp
l_int|1
)paren
op_lshift
id|get_hard_smp_processor_id
c_func
(paren
id|i
)paren
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SMP
multiline_comment|/* Get the mpic structure from the IPI number */
DECL|function|mpic_from_ipi
r_static
r_inline
r_struct
id|mpic
op_star
id|mpic_from_ipi
c_func
(paren
r_int
r_int
id|ipi
)paren
(brace
r_return
id|container_of
c_func
(paren
id|irq_desc
(braket
id|ipi
)braket
dot
id|handler
comma
r_struct
id|mpic
comma
id|hc_ipi
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Get the mpic structure from the irq number */
DECL|function|mpic_from_irq
r_static
r_inline
r_struct
id|mpic
op_star
id|mpic_from_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_return
id|container_of
c_func
(paren
id|irq_desc
(braket
id|irq
)braket
dot
id|handler
comma
r_struct
id|mpic
comma
id|hc_irq
)paren
suffix:semicolon
)brace
multiline_comment|/* Send an EOI */
DECL|function|mpic_eoi
r_static
r_inline
r_void
id|mpic_eoi
c_func
(paren
r_struct
id|mpic
op_star
id|mpic
)paren
(brace
id|mpic_cpu_write
c_func
(paren
id|MPIC_CPU_EOI
comma
l_int|0
)paren
suffix:semicolon
(paren
r_void
)paren
id|mpic_cpu_read
c_func
(paren
id|MPIC_CPU_WHOAMI
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SMP
DECL|function|mpic_ipi_action
r_static
id|irqreturn_t
id|mpic_ipi_action
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|mpic
op_star
id|mpic
op_assign
id|dev_id
suffix:semicolon
id|smp_message_recv
c_func
(paren
id|irq
op_minus
id|mpic-&gt;ipi_offset
comma
id|regs
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_SMP */
multiline_comment|/*&n; * Linux descriptor level callbacks&n; */
DECL|function|mpic_enable_irq
r_static
r_void
id|mpic_enable_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_int
id|loops
op_assign
l_int|100000
suffix:semicolon
r_struct
id|mpic
op_star
id|mpic
op_assign
id|mpic_from_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
r_int
r_int
id|src
op_assign
id|irq
op_minus
id|mpic-&gt;irq_offset
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s: enable_irq: %d (src %d)&bslash;n&quot;
comma
id|mpic-&gt;name
comma
id|irq
comma
id|src
)paren
suffix:semicolon
id|mpic_irq_write
c_func
(paren
id|src
comma
id|MPIC_IRQ_VECTOR_PRI
comma
id|mpic_irq_read
c_func
(paren
id|src
comma
id|MPIC_IRQ_VECTOR_PRI
)paren
op_amp
op_complement
id|MPIC_VECPRI_MASK
)paren
suffix:semicolon
multiline_comment|/* make sure mask gets to controller before we return to user */
r_do
(brace
r_if
c_cond
(paren
op_logical_neg
id|loops
op_decrement
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mpic_enable_irq timeout&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|mpic_irq_read
c_func
(paren
id|src
comma
id|MPIC_IRQ_VECTOR_PRI
)paren
op_amp
id|MPIC_VECPRI_MASK
)paren
(brace
suffix:semicolon
)brace
)brace
DECL|function|mpic_disable_irq
r_static
r_void
id|mpic_disable_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_int
id|loops
op_assign
l_int|100000
suffix:semicolon
r_struct
id|mpic
op_star
id|mpic
op_assign
id|mpic_from_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
r_int
r_int
id|src
op_assign
id|irq
op_minus
id|mpic-&gt;irq_offset
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s: disable_irq: %d (src %d)&bslash;n&quot;
comma
id|mpic-&gt;name
comma
id|irq
comma
id|src
)paren
suffix:semicolon
id|mpic_irq_write
c_func
(paren
id|src
comma
id|MPIC_IRQ_VECTOR_PRI
comma
id|mpic_irq_read
c_func
(paren
id|src
comma
id|MPIC_IRQ_VECTOR_PRI
)paren
op_or
id|MPIC_VECPRI_MASK
)paren
suffix:semicolon
multiline_comment|/* make sure mask gets to controller before we return to user */
r_do
(brace
r_if
c_cond
(paren
op_logical_neg
id|loops
op_decrement
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mpic_enable_irq timeout&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|mpic_irq_read
c_func
(paren
id|src
comma
id|MPIC_IRQ_VECTOR_PRI
)paren
op_amp
id|MPIC_VECPRI_MASK
)paren
)paren
(brace
suffix:semicolon
)brace
)brace
DECL|function|mpic_end_irq
r_static
r_void
id|mpic_end_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_struct
id|mpic
op_star
id|mpic
op_assign
id|mpic_from_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s: end_irq: %d&bslash;n&quot;
comma
id|mpic-&gt;name
comma
id|irq
)paren
suffix:semicolon
multiline_comment|/* We always EOI on end_irq() even for edge interrupts since that&n;&t; * should only lower the priority, the MPIC should have properly&n;&t; * latched another edge interrupt coming in anyway&n;&t; */
macro_line|#ifdef CONFIG_MPIC_BROKEN_U3
r_if
c_cond
(paren
id|mpic-&gt;flags
op_amp
id|MPIC_BROKEN_U3
)paren
(brace
r_int
r_int
id|src
op_assign
id|irq
op_minus
id|mpic-&gt;irq_offset
suffix:semicolon
r_if
c_cond
(paren
id|mpic_is_ht_interrupt
c_func
(paren
id|mpic
comma
id|src
)paren
)paren
id|mpic_apic_end_irq
c_func
(paren
id|mpic
comma
id|src
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_MPIC_BROKEN_U3 */
id|mpic_eoi
c_func
(paren
id|mpic
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SMP
DECL|function|mpic_enable_ipi
r_static
r_void
id|mpic_enable_ipi
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_struct
id|mpic
op_star
id|mpic
op_assign
id|mpic_from_ipi
c_func
(paren
id|irq
)paren
suffix:semicolon
r_int
r_int
id|src
op_assign
id|irq
op_minus
id|mpic-&gt;ipi_offset
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s: enable_ipi: %d (ipi %d)&bslash;n&quot;
comma
id|mpic-&gt;name
comma
id|irq
comma
id|src
)paren
suffix:semicolon
id|mpic_ipi_write
c_func
(paren
id|src
comma
id|mpic_ipi_read
c_func
(paren
id|src
)paren
op_amp
op_complement
id|MPIC_VECPRI_MASK
)paren
suffix:semicolon
)brace
DECL|function|mpic_disable_ipi
r_static
r_void
id|mpic_disable_ipi
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
multiline_comment|/* NEVER disable an IPI... that&squot;s just plain wrong! */
)brace
DECL|function|mpic_end_ipi
r_static
r_void
id|mpic_end_ipi
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_struct
id|mpic
op_star
id|mpic
op_assign
id|mpic_from_ipi
c_func
(paren
id|irq
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * IPIs are marked IRQ_PER_CPU. This has the side effect of&n;&t; * preventing the IRQ_PENDING/IRQ_INPROGRESS logic from&n;&t; * applying to them. We EOI them late to avoid re-entering.&n;&t; * We mark IPI&squot;s with SA_INTERRUPT as they must run with&n;&t; * irqs disabled.&n;&t; */
id|mpic_eoi
c_func
(paren
id|mpic
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_SMP */
DECL|function|mpic_set_affinity
r_static
r_void
id|mpic_set_affinity
c_func
(paren
r_int
r_int
id|irq
comma
id|cpumask_t
id|cpumask
)paren
(brace
r_struct
id|mpic
op_star
id|mpic
op_assign
id|mpic_from_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
id|cpumask_t
id|tmp
suffix:semicolon
id|cpus_and
c_func
(paren
id|tmp
comma
id|cpumask
comma
id|cpu_online_map
)paren
suffix:semicolon
id|mpic_irq_write
c_func
(paren
id|irq
op_minus
id|mpic-&gt;irq_offset
comma
id|MPIC_IRQ_DESTINATION
comma
id|mpic_physmask
c_func
(paren
id|cpus_addr
c_func
(paren
id|tmp
)paren
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Exported functions&n; */
DECL|function|mpic_alloc
r_struct
id|mpic
op_star
id|__init
id|mpic_alloc
c_func
(paren
r_int
r_int
id|phys_addr
comma
r_int
r_int
id|flags
comma
r_int
r_int
id|isu_size
comma
r_int
r_int
id|irq_offset
comma
r_int
r_int
id|irq_count
comma
r_int
r_int
id|ipi_offset
comma
r_int
r_char
op_star
id|senses
comma
r_int
r_int
id|senses_count
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_struct
id|mpic
op_star
id|mpic
suffix:semicolon
id|u32
id|reg
suffix:semicolon
r_const
r_char
op_star
id|vers
suffix:semicolon
r_int
id|i
suffix:semicolon
id|mpic
op_assign
(paren
r_struct
id|mpic
op_star
)paren
id|alloc_bootmem
c_func
(paren
r_sizeof
(paren
r_struct
id|mpic
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpic
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|mpic
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|mpic
)paren
)paren
suffix:semicolon
id|mpic-&gt;name
op_assign
id|name
suffix:semicolon
id|mpic-&gt;hc_irq
dot
r_typename
op_assign
id|name
suffix:semicolon
id|mpic-&gt;hc_irq.enable
op_assign
id|mpic_enable_irq
suffix:semicolon
id|mpic-&gt;hc_irq.disable
op_assign
id|mpic_disable_irq
suffix:semicolon
id|mpic-&gt;hc_irq.end
op_assign
id|mpic_end_irq
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MPIC_PRIMARY
)paren
id|mpic-&gt;hc_irq.set_affinity
op_assign
id|mpic_set_affinity
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
id|mpic-&gt;hc_ipi
dot
r_typename
op_assign
id|name
suffix:semicolon
id|mpic-&gt;hc_ipi.enable
op_assign
id|mpic_enable_ipi
suffix:semicolon
id|mpic-&gt;hc_ipi.disable
op_assign
id|mpic_disable_ipi
suffix:semicolon
id|mpic-&gt;hc_ipi.end
op_assign
id|mpic_end_ipi
suffix:semicolon
macro_line|#endif /* CONFIG_SMP */
id|mpic-&gt;flags
op_assign
id|flags
suffix:semicolon
id|mpic-&gt;isu_size
op_assign
id|isu_size
suffix:semicolon
id|mpic-&gt;irq_offset
op_assign
id|irq_offset
suffix:semicolon
id|mpic-&gt;irq_count
op_assign
id|irq_count
suffix:semicolon
id|mpic-&gt;ipi_offset
op_assign
id|ipi_offset
suffix:semicolon
id|mpic-&gt;num_sources
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* so far */
id|mpic-&gt;senses
op_assign
id|senses
suffix:semicolon
id|mpic-&gt;senses_count
op_assign
id|senses_count
suffix:semicolon
multiline_comment|/* Map the global registers */
id|mpic-&gt;gregs
op_assign
id|ioremap
c_func
(paren
id|phys_addr
op_plus
id|MPIC_GREG_BASE
comma
l_int|0x1000
)paren
suffix:semicolon
id|mpic-&gt;tmregs
op_assign
id|mpic-&gt;gregs
op_plus
(paren
id|MPIC_TIMER_BASE
op_rshift
l_int|2
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|mpic-&gt;gregs
op_eq
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Reset */
r_if
c_cond
(paren
id|flags
op_amp
id|MPIC_WANTS_RESET
)paren
(brace
id|mpic_write
c_func
(paren
id|mpic-&gt;gregs
comma
id|MPIC_GREG_GLOBAL_CONF_0
comma
id|mpic_read
c_func
(paren
id|mpic-&gt;gregs
comma
id|MPIC_GREG_GLOBAL_CONF_0
)paren
op_or
id|MPIC_GREG_GCONF_RESET
)paren
suffix:semicolon
r_while
c_loop
(paren
id|mpic_read
c_func
(paren
id|mpic-&gt;gregs
comma
id|MPIC_GREG_GLOBAL_CONF_0
)paren
op_amp
id|MPIC_GREG_GCONF_RESET
)paren
(brace
id|mb
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Read feature register, calculate num CPUs and, for non-ISU&n;&t; * MPICs, num sources as well. On ISU MPICs, sources are counted&n;&t; * as ISUs are added&n;&t; */
id|reg
op_assign
id|mpic_read
c_func
(paren
id|mpic-&gt;gregs
comma
id|MPIC_GREG_FEATURE_0
)paren
suffix:semicolon
id|mpic-&gt;num_cpus
op_assign
(paren
(paren
id|reg
op_amp
id|MPIC_GREG_FEATURE_LAST_CPU_MASK
)paren
op_rshift
id|MPIC_GREG_FEATURE_LAST_CPU_SHIFT
)paren
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|isu_size
op_eq
l_int|0
)paren
id|mpic-&gt;num_sources
op_assign
(paren
(paren
id|reg
op_amp
id|MPIC_GREG_FEATURE_LAST_SRC_MASK
)paren
op_rshift
id|MPIC_GREG_FEATURE_LAST_SRC_SHIFT
)paren
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* Map the per-CPU registers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mpic-&gt;num_cpus
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mpic-&gt;cpuregs
(braket
id|i
)braket
op_assign
id|ioremap
c_func
(paren
id|phys_addr
op_plus
id|MPIC_CPU_BASE
op_plus
id|i
op_star
id|MPIC_CPU_STRIDE
comma
l_int|0x1000
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|mpic-&gt;cpuregs
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize main ISU if none provided */
r_if
c_cond
(paren
id|mpic-&gt;isu_size
op_eq
l_int|0
)paren
(brace
id|mpic-&gt;isu_size
op_assign
id|mpic-&gt;num_sources
suffix:semicolon
id|mpic-&gt;isus
(braket
l_int|0
)braket
op_assign
id|ioremap
c_func
(paren
id|phys_addr
op_plus
id|MPIC_IRQ_BASE
comma
id|MPIC_IRQ_STRIDE
op_star
id|mpic-&gt;isu_size
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|mpic-&gt;isus
(braket
l_int|0
)braket
op_eq
l_int|NULL
)paren
suffix:semicolon
)brace
id|mpic-&gt;isu_shift
op_assign
l_int|1
op_plus
id|__ilog2
c_func
(paren
id|mpic-&gt;isu_size
op_minus
l_int|1
)paren
suffix:semicolon
id|mpic-&gt;isu_mask
op_assign
(paren
l_int|1
op_lshift
id|mpic-&gt;isu_shift
)paren
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Display version */
r_switch
c_cond
(paren
id|reg
op_amp
id|MPIC_GREG_FEATURE_VERSION_MASK
)paren
(brace
r_case
l_int|1
suffix:colon
id|vers
op_assign
l_string|&quot;1.0&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|vers
op_assign
l_string|&quot;1.2&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|vers
op_assign
l_string|&quot;1.3&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|vers
op_assign
l_string|&quot;&lt;unknown&gt;&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;mpic: Setting up MPIC &bslash;&quot;%s&bslash;&quot; version %s at %lx, max %d CPUs&bslash;n&quot;
comma
id|name
comma
id|vers
comma
id|phys_addr
comma
id|mpic-&gt;num_cpus
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;mpic: ISU size: %d, shift: %d, mask: %x&bslash;n&quot;
comma
id|mpic-&gt;isu_size
comma
id|mpic-&gt;isu_shift
comma
id|mpic-&gt;isu_mask
)paren
suffix:semicolon
id|mpic-&gt;next
op_assign
id|mpics
suffix:semicolon
id|mpics
op_assign
id|mpic
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MPIC_PRIMARY
)paren
id|mpic_primary
op_assign
id|mpic
suffix:semicolon
r_return
id|mpic
suffix:semicolon
)brace
DECL|function|mpic_assign_isu
r_void
id|__init
id|mpic_assign_isu
c_func
(paren
r_struct
id|mpic
op_star
id|mpic
comma
r_int
r_int
id|isu_num
comma
r_int
r_int
id|phys_addr
)paren
(brace
r_int
r_int
id|isu_first
op_assign
id|isu_num
op_star
id|mpic-&gt;isu_size
suffix:semicolon
id|BUG_ON
c_func
(paren
id|isu_num
op_ge
id|MPIC_MAX_ISU
)paren
suffix:semicolon
id|mpic-&gt;isus
(braket
id|isu_num
)braket
op_assign
id|ioremap
c_func
(paren
id|phys_addr
comma
id|MPIC_IRQ_STRIDE
op_star
id|mpic-&gt;isu_size
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|isu_first
op_plus
id|mpic-&gt;isu_size
)paren
OG
id|mpic-&gt;num_sources
)paren
id|mpic-&gt;num_sources
op_assign
id|isu_first
op_plus
id|mpic-&gt;isu_size
suffix:semicolon
)brace
DECL|function|mpic_setup_cascade
r_void
id|__init
id|mpic_setup_cascade
c_func
(paren
r_int
r_int
id|irq
comma
id|mpic_cascade_t
id|handler
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|mpic
op_star
id|mpic
op_assign
id|mpic_find
c_func
(paren
id|irq
comma
l_int|NULL
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Synchronization here is a bit dodgy, so don&squot;t try to replace cascade&n;&t; * interrupts on the fly too often ... but normally it&squot;s set up at boot.&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mpic_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpic-&gt;cascade
)paren
id|mpic_disable_irq
c_func
(paren
id|mpic-&gt;cascade_vec
op_plus
id|mpic-&gt;irq_offset
)paren
suffix:semicolon
id|mpic-&gt;cascade
op_assign
l_int|NULL
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|mpic-&gt;cascade_vec
op_assign
id|irq
op_minus
id|mpic-&gt;irq_offset
suffix:semicolon
id|mpic-&gt;cascade_data
op_assign
id|data
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|mpic-&gt;cascade
op_assign
id|handler
suffix:semicolon
id|mpic_enable_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mpic_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|mpic_init
r_void
id|__init
id|mpic_init
c_func
(paren
r_struct
id|mpic
op_star
id|mpic
)paren
(brace
r_int
id|i
suffix:semicolon
id|BUG_ON
c_func
(paren
id|mpic-&gt;num_sources
op_eq
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;mpic: Initializing for %d sources&bslash;n&quot;
comma
id|mpic-&gt;num_sources
)paren
suffix:semicolon
multiline_comment|/* Set current processor priority to max */
id|mpic_cpu_write
c_func
(paren
id|MPIC_CPU_CURRENT_TASK_PRI
comma
l_int|0xf
)paren
suffix:semicolon
multiline_comment|/* Initialize timers: just disable them all */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mpic_write
c_func
(paren
id|mpic-&gt;tmregs
comma
id|i
op_star
id|MPIC_TIMER_STRIDE
op_plus
id|MPIC_TIMER_DESTINATION
comma
l_int|0
)paren
suffix:semicolon
id|mpic_write
c_func
(paren
id|mpic-&gt;tmregs
comma
id|i
op_star
id|MPIC_TIMER_STRIDE
op_plus
id|MPIC_TIMER_VECTOR_PRI
comma
id|MPIC_VECPRI_MASK
op_or
(paren
id|MPIC_VEC_TIMER_0
op_plus
id|i
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize IPIs to our reserved vectors and mark them disabled for now */
id|mpic_test_broken_ipi
c_func
(paren
id|mpic
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mpic_ipi_write
c_func
(paren
id|i
comma
id|MPIC_VECPRI_MASK
op_or
(paren
l_int|10
op_lshift
id|MPIC_VECPRI_PRIORITY_SHIFT
)paren
op_or
(paren
id|MPIC_VEC_IPI_0
op_plus
id|i
)paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
r_if
c_cond
(paren
op_logical_neg
(paren
id|mpic-&gt;flags
op_amp
id|MPIC_PRIMARY
)paren
)paren
r_continue
suffix:semicolon
id|irq_desc
(braket
id|mpic-&gt;ipi_offset
op_plus
id|i
)braket
dot
id|status
op_or_assign
id|IRQ_PER_CPU
suffix:semicolon
id|irq_desc
(braket
id|mpic-&gt;ipi_offset
op_plus
id|i
)braket
dot
id|handler
op_assign
op_amp
id|mpic-&gt;hc_ipi
suffix:semicolon
macro_line|#endif /* CONFIG_SMP */
)brace
multiline_comment|/* Initialize interrupt sources */
r_if
c_cond
(paren
id|mpic-&gt;irq_count
op_eq
l_int|0
)paren
id|mpic-&gt;irq_count
op_assign
id|mpic-&gt;num_sources
suffix:semicolon
macro_line|#ifdef CONFIG_MPIC_BROKEN_U3
multiline_comment|/* Do the ioapic fixups on U3 broken mpic */
id|DBG
c_func
(paren
l_string|&quot;MPIC flags: %x&bslash;n&quot;
comma
id|mpic-&gt;flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mpic-&gt;flags
op_amp
id|MPIC_BROKEN_U3
)paren
op_logical_and
(paren
id|mpic-&gt;flags
op_amp
id|MPIC_PRIMARY
)paren
)paren
id|mpic_scan_ioapics
c_func
(paren
id|mpic
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_MPIC_BROKEN_U3 */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mpic-&gt;num_sources
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* start with vector = source number, and masked */
id|u32
id|vecpri
op_assign
id|MPIC_VECPRI_MASK
op_or
id|i
op_or
(paren
l_int|8
op_lshift
id|MPIC_VECPRI_PRIORITY_SHIFT
)paren
suffix:semicolon
r_int
id|level
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* if it&squot;s an IPI, we skip it */
r_if
c_cond
(paren
(paren
id|mpic-&gt;irq_offset
op_plus
id|i
)paren
op_ge
(paren
id|mpic-&gt;ipi_offset
op_plus
id|i
)paren
op_logical_and
(paren
id|mpic-&gt;irq_offset
op_plus
id|i
)paren
OL
(paren
id|mpic-&gt;ipi_offset
op_plus
id|i
op_plus
l_int|4
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* do senses munging */
r_if
c_cond
(paren
id|mpic-&gt;senses
op_logical_and
id|i
OL
id|mpic-&gt;senses_count
)paren
(brace
r_if
c_cond
(paren
id|mpic-&gt;senses
(braket
id|i
)braket
op_amp
id|IRQ_SENSE_LEVEL
)paren
id|vecpri
op_or_assign
id|MPIC_VECPRI_SENSE_LEVEL
suffix:semicolon
r_if
c_cond
(paren
id|mpic-&gt;senses
(braket
id|i
)braket
op_amp
id|IRQ_POLARITY_POSITIVE
)paren
id|vecpri
op_or_assign
id|MPIC_VECPRI_POLARITY_POSITIVE
suffix:semicolon
)brace
r_else
id|vecpri
op_or_assign
id|MPIC_VECPRI_SENSE_LEVEL
suffix:semicolon
multiline_comment|/* remember if it was a level interrupts */
id|level
op_assign
(paren
id|vecpri
op_amp
id|MPIC_VECPRI_SENSE_LEVEL
)paren
suffix:semicolon
multiline_comment|/* deal with broken U3 */
r_if
c_cond
(paren
id|mpic-&gt;flags
op_amp
id|MPIC_BROKEN_U3
)paren
(brace
macro_line|#ifdef CONFIG_MPIC_BROKEN_U3
r_if
c_cond
(paren
id|mpic_is_ht_interrupt
c_func
(paren
id|mpic
comma
id|i
)paren
)paren
(brace
id|vecpri
op_and_assign
op_complement
(paren
id|MPIC_VECPRI_SENSE_MASK
op_or
id|MPIC_VECPRI_POLARITY_MASK
)paren
suffix:semicolon
id|vecpri
op_or_assign
id|MPIC_VECPRI_POLARITY_POSITIVE
suffix:semicolon
)brace
macro_line|#else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mpic: BROKEN_U3 set, but CONFIG doesn&squot;t match&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
id|DBG
c_func
(paren
l_string|&quot;setup source %d, vecpri: %08x, level: %d&bslash;n&quot;
comma
id|i
comma
id|vecpri
comma
(paren
id|level
op_ne
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* init hw */
id|mpic_irq_write
c_func
(paren
id|i
comma
id|MPIC_IRQ_VECTOR_PRI
comma
id|vecpri
)paren
suffix:semicolon
id|mpic_irq_write
c_func
(paren
id|i
comma
id|MPIC_IRQ_DESTINATION
comma
l_int|1
op_lshift
id|get_hard_smp_processor_id
c_func
(paren
id|boot_cpuid
)paren
)paren
suffix:semicolon
multiline_comment|/* init linux descriptors */
r_if
c_cond
(paren
id|i
OL
id|mpic-&gt;irq_count
)paren
(brace
id|irq_desc
(braket
id|mpic-&gt;irq_offset
op_plus
id|i
)braket
dot
id|status
op_assign
id|level
ques
c_cond
id|IRQ_LEVEL
suffix:colon
l_int|0
suffix:semicolon
id|irq_desc
(braket
id|mpic-&gt;irq_offset
op_plus
id|i
)braket
dot
id|handler
op_assign
op_amp
id|mpic-&gt;hc_irq
suffix:semicolon
)brace
)brace
multiline_comment|/* Init spurrious vector */
id|mpic_write
c_func
(paren
id|mpic-&gt;gregs
comma
id|MPIC_GREG_SPURIOUS
comma
id|MPIC_VEC_SPURRIOUS
)paren
suffix:semicolon
multiline_comment|/* Disable 8259 passthrough */
id|mpic_write
c_func
(paren
id|mpic-&gt;gregs
comma
id|MPIC_GREG_GLOBAL_CONF_0
comma
id|mpic_read
c_func
(paren
id|mpic-&gt;gregs
comma
id|MPIC_GREG_GLOBAL_CONF_0
)paren
op_or
id|MPIC_GREG_GCONF_8259_PTHROU_DIS
)paren
suffix:semicolon
multiline_comment|/* Set current processor priority to 0 */
id|mpic_cpu_write
c_func
(paren
id|MPIC_CPU_CURRENT_TASK_PRI
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|mpic_irq_set_priority
r_void
id|mpic_irq_set_priority
c_func
(paren
r_int
r_int
id|irq
comma
r_int
r_int
id|pri
)paren
(brace
r_int
id|is_ipi
suffix:semicolon
r_struct
id|mpic
op_star
id|mpic
op_assign
id|mpic_find
c_func
(paren
id|irq
comma
op_amp
id|is_ipi
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|reg
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mpic_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_ipi
)paren
(brace
id|reg
op_assign
id|mpic_ipi_read
c_func
(paren
id|irq
op_minus
id|mpic-&gt;ipi_offset
)paren
op_amp
id|MPIC_VECPRI_PRIORITY_MASK
suffix:semicolon
id|mpic_ipi_write
c_func
(paren
id|irq
op_minus
id|mpic-&gt;ipi_offset
comma
id|reg
op_or
(paren
id|pri
op_lshift
id|MPIC_VECPRI_PRIORITY_SHIFT
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|reg
op_assign
id|mpic_irq_read
c_func
(paren
id|irq
op_minus
id|mpic-&gt;irq_offset
comma
id|MPIC_IRQ_VECTOR_PRI
)paren
op_amp
id|MPIC_VECPRI_PRIORITY_MASK
suffix:semicolon
id|mpic_irq_write
c_func
(paren
id|irq
op_minus
id|mpic-&gt;irq_offset
comma
id|MPIC_IRQ_VECTOR_PRI
comma
id|reg
op_or
(paren
id|pri
op_lshift
id|MPIC_VECPRI_PRIORITY_SHIFT
)paren
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mpic_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|mpic_irq_get_priority
r_int
r_int
id|mpic_irq_get_priority
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
id|is_ipi
suffix:semicolon
r_struct
id|mpic
op_star
id|mpic
op_assign
id|mpic_find
c_func
(paren
id|irq
comma
op_amp
id|is_ipi
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|reg
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mpic_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_ipi
)paren
id|reg
op_assign
id|mpic_ipi_read
c_func
(paren
id|irq
op_minus
id|mpic-&gt;ipi_offset
)paren
suffix:semicolon
r_else
id|reg
op_assign
id|mpic_irq_read
c_func
(paren
id|irq
op_minus
id|mpic-&gt;irq_offset
comma
id|MPIC_IRQ_VECTOR_PRI
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mpic_lock
comma
id|flags
)paren
suffix:semicolon
r_return
(paren
id|reg
op_amp
id|MPIC_VECPRI_PRIORITY_MASK
)paren
op_rshift
id|MPIC_VECPRI_PRIORITY_SHIFT
suffix:semicolon
)brace
DECL|function|mpic_setup_this_cpu
r_void
id|mpic_setup_this_cpu
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_SMP
r_struct
id|mpic
op_star
id|mpic
op_assign
id|mpic_primary
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef CONFIG_IRQ_ALL_CPUS
id|u32
id|msk
op_assign
l_int|1
op_lshift
id|hard_smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
macro_line|#endif
id|BUG_ON
c_func
(paren
id|mpic
op_eq
l_int|NULL
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s: setup_this_cpu(%d)&bslash;n&quot;
comma
id|mpic-&gt;name
comma
id|hard_smp_processor_id
c_func
(paren
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mpic_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IRQ_ALL_CPUS
multiline_comment|/* let the mpic know we want intrs. default affinity is 0xffffffff&n;&t; * until changed via /proc. That&squot;s how it&squot;s done on x86. If we want&n;&t; * it differently, then we should make sure we also change the default&n;&t; * values of irq_affinity in irq.c.&n; &t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mpic-&gt;num_sources
suffix:semicolon
id|i
op_increment
)paren
id|mpic_irq_write
c_func
(paren
id|i
comma
id|MPIC_IRQ_DESTINATION
comma
id|mpic_irq_read
c_func
(paren
id|i
comma
id|MPIC_IRQ_DESTINATION
)paren
op_or
id|msk
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_IRQ_ALL_CPUS */
multiline_comment|/* Set current processor priority to 0 */
id|mpic_cpu_write
c_func
(paren
id|MPIC_CPU_CURRENT_TASK_PRI
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mpic_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_SMP */
)brace
DECL|function|mpic_send_ipi
r_void
id|mpic_send_ipi
c_func
(paren
r_int
r_int
id|ipi_no
comma
r_int
r_int
id|cpu_mask
)paren
(brace
r_struct
id|mpic
op_star
id|mpic
op_assign
id|mpic_primary
suffix:semicolon
id|BUG_ON
c_func
(paren
id|mpic
op_eq
l_int|NULL
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s: send_ipi(ipi_no: %d)&bslash;n&quot;
comma
id|mpic-&gt;name
comma
id|ipi_no
)paren
suffix:semicolon
id|mpic_cpu_write
c_func
(paren
id|MPIC_CPU_IPI_DISPATCH_0
op_plus
id|ipi_no
op_star
l_int|0x10
comma
id|mpic_physmask
c_func
(paren
id|cpu_mask
op_amp
id|cpus_addr
c_func
(paren
id|cpu_online_map
)paren
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
)brace
DECL|function|mpic_get_one_irq
r_int
id|mpic_get_one_irq
c_func
(paren
r_struct
id|mpic
op_star
id|mpic
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|u32
id|irq
suffix:semicolon
id|irq
op_assign
id|mpic_cpu_read
c_func
(paren
id|MPIC_CPU_INTACK
)paren
op_amp
id|MPIC_VECPRI_VECTOR_MASK
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s: get_one_irq(): %d&bslash;n&quot;
comma
id|mpic-&gt;name
comma
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpic-&gt;cascade
op_logical_and
id|irq
op_eq
id|mpic-&gt;cascade_vec
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;%s: cascading ...&bslash;n&quot;
comma
id|mpic-&gt;name
)paren
suffix:semicolon
id|irq
op_assign
id|mpic
op_member_access_from_pointer
id|cascade
c_func
(paren
id|regs
comma
id|mpic-&gt;cascade_data
)paren
suffix:semicolon
id|mpic_eoi
c_func
(paren
id|mpic
)paren
suffix:semicolon
r_return
id|irq
suffix:semicolon
)brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|irq
op_eq
id|MPIC_VEC_SPURRIOUS
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|irq
OL
id|MPIC_VEC_IPI_0
)paren
r_return
id|irq
op_plus
id|mpic-&gt;irq_offset
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s: ipi %d !&bslash;n&quot;
comma
id|mpic-&gt;name
comma
id|irq
op_minus
id|MPIC_VEC_IPI_0
)paren
suffix:semicolon
r_return
id|irq
op_minus
id|MPIC_VEC_IPI_0
op_plus
id|mpic-&gt;ipi_offset
suffix:semicolon
)brace
DECL|function|mpic_get_irq
r_int
id|mpic_get_irq
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|mpic
op_star
id|mpic
op_assign
id|mpic_primary
suffix:semicolon
id|BUG_ON
c_func
(paren
id|mpic
op_eq
l_int|NULL
)paren
suffix:semicolon
r_return
id|mpic_get_one_irq
c_func
(paren
id|mpic
comma
id|regs
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SMP
DECL|function|mpic_request_ipis
r_void
id|mpic_request_ipis
c_func
(paren
r_void
)paren
(brace
r_struct
id|mpic
op_star
id|mpic
op_assign
id|mpic_primary
suffix:semicolon
id|BUG_ON
c_func
(paren
id|mpic
op_eq
l_int|NULL
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;requesting IPIs ... &bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* IPIs are marked SA_INTERRUPT as they must run with irqs disabled */
id|request_irq
c_func
(paren
id|mpic-&gt;ipi_offset
op_plus
l_int|0
comma
id|mpic_ipi_action
comma
id|SA_INTERRUPT
comma
l_string|&quot;IPI0 (call function)&quot;
comma
id|mpic
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|mpic-&gt;ipi_offset
op_plus
l_int|1
comma
id|mpic_ipi_action
comma
id|SA_INTERRUPT
comma
l_string|&quot;IPI1 (reschedule)&quot;
comma
id|mpic
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|mpic-&gt;ipi_offset
op_plus
l_int|2
comma
id|mpic_ipi_action
comma
id|SA_INTERRUPT
comma
l_string|&quot;IPI2 (unused)&quot;
comma
id|mpic
)paren
suffix:semicolon
id|request_irq
c_func
(paren
id|mpic-&gt;ipi_offset
op_plus
l_int|3
comma
id|mpic_ipi_action
comma
id|SA_INTERRUPT
comma
l_string|&quot;IPI3 (debugger break)&quot;
comma
id|mpic
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;IPIs requested... &bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_SMP */
eof
