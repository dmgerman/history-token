multiline_comment|/*&n; *  arch/ppc/platforms/pmac_nvram.c&n; *&n; *  Copyright (C) 2002 Benjamin Herrenschmidt (benh@kernel.crashing.org)&n; *&n; *  This program is free software; you can redistribute it and/or&n; *  modify it under the terms of the GNU General Public License&n; *  as published by the Free Software Foundation; either version&n; *  2 of the License, or (at your option) any later version.&n; *&n; *  Todo: - add support for the OF persistent properties&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;linux/completion.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/sections.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/nvram.h&gt;
DECL|macro|DEBUG
mdefine_line|#define DEBUG
macro_line|#ifdef DEBUG
DECL|macro|DBG
mdefine_line|#define DBG(x...) printk(x)
macro_line|#else
DECL|macro|DBG
mdefine_line|#define DBG(x...)
macro_line|#endif
DECL|macro|NVRAM_SIZE
mdefine_line|#define NVRAM_SIZE&t;&t;0x2000&t;/* 8kB of non-volatile RAM */
DECL|macro|CORE99_SIGNATURE
mdefine_line|#define CORE99_SIGNATURE&t;0x5a
DECL|macro|CORE99_ADLER_START
mdefine_line|#define CORE99_ADLER_START&t;0x14
multiline_comment|/* On Core99, nvram is either a sharp, a micron or an AMD flash */
DECL|macro|SM_FLASH_STATUS_DONE
mdefine_line|#define SM_FLASH_STATUS_DONE&t;0x80
DECL|macro|SM_FLASH_STATUS_ERR
mdefine_line|#define SM_FLASH_STATUS_ERR&t;0x38
DECL|macro|SM_FLASH_CMD_ERASE_CONFIRM
mdefine_line|#define SM_FLASH_CMD_ERASE_CONFIRM&t;0xd0
DECL|macro|SM_FLASH_CMD_ERASE_SETUP
mdefine_line|#define SM_FLASH_CMD_ERASE_SETUP&t;0x20
DECL|macro|SM_FLASH_CMD_RESET
mdefine_line|#define SM_FLASH_CMD_RESET&t;&t;0xff
DECL|macro|SM_FLASH_CMD_WRITE_SETUP
mdefine_line|#define SM_FLASH_CMD_WRITE_SETUP&t;0x40
DECL|macro|SM_FLASH_CMD_CLEAR_STATUS
mdefine_line|#define SM_FLASH_CMD_CLEAR_STATUS&t;0x50
DECL|macro|SM_FLASH_CMD_READ_STATUS
mdefine_line|#define SM_FLASH_CMD_READ_STATUS&t;0x70
multiline_comment|/* CHRP NVRAM header */
DECL|struct|chrp_header
r_struct
id|chrp_header
(brace
DECL|member|signature
id|u8
id|signature
suffix:semicolon
DECL|member|cksum
id|u8
id|cksum
suffix:semicolon
DECL|member|len
id|u16
id|len
suffix:semicolon
DECL|member|name
r_char
id|name
(braket
l_int|12
)braket
suffix:semicolon
DECL|member|data
id|u8
id|data
(braket
l_int|0
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|core99_header
r_struct
id|core99_header
(brace
DECL|member|hdr
r_struct
id|chrp_header
id|hdr
suffix:semicolon
DECL|member|adler
id|u32
id|adler
suffix:semicolon
DECL|member|generation
id|u32
id|generation
suffix:semicolon
DECL|member|reserved
id|u32
id|reserved
(braket
l_int|2
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * Read and write the non-volatile RAM on PowerMacs and CHRP machines.&n; */
DECL|variable|nvram_data
r_static
r_volatile
r_int
r_char
op_star
id|nvram_data
suffix:semicolon
DECL|variable|core99_bank
r_static
r_int
id|core99_bank
op_assign
l_int|0
suffix:semicolon
singleline_comment|// XXX Turn that into a sem
DECL|variable|nv_lock
r_static
id|spinlock_t
id|nv_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
r_extern
r_int
id|system_running
suffix:semicolon
DECL|variable|core99_write_bank
r_static
r_int
(paren
op_star
id|core99_write_bank
)paren
(paren
r_int
id|bank
comma
id|u8
op_star
id|datas
)paren
suffix:semicolon
DECL|variable|core99_erase_bank
r_static
r_int
(paren
op_star
id|core99_erase_bank
)paren
(paren
r_int
id|bank
)paren
suffix:semicolon
DECL|variable|__pmacdata
r_static
r_char
op_star
id|nvram_image
id|__pmacdata
suffix:semicolon
DECL|function|core99_nvram_read
r_static
id|ssize_t
id|__pmac
id|core99_nvram_read
c_func
(paren
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|index
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|nvram_image
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_star
id|index
OG
id|NVRAM_SIZE
)paren
r_return
l_int|0
suffix:semicolon
id|i
op_assign
op_star
id|index
suffix:semicolon
r_if
c_cond
(paren
id|i
op_plus
id|count
OG
id|NVRAM_SIZE
)paren
id|count
op_assign
id|NVRAM_SIZE
op_minus
id|i
suffix:semicolon
id|memcpy
c_func
(paren
id|buf
comma
op_amp
id|nvram_image
(braket
id|i
)braket
comma
id|count
)paren
suffix:semicolon
op_star
id|index
op_assign
id|i
op_plus
id|count
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|core99_nvram_write
r_static
id|ssize_t
id|__pmac
id|core99_nvram_write
c_func
(paren
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|index
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|nvram_image
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_star
id|index
OG
id|NVRAM_SIZE
)paren
r_return
l_int|0
suffix:semicolon
id|i
op_assign
op_star
id|index
suffix:semicolon
r_if
c_cond
(paren
id|i
op_plus
id|count
OG
id|NVRAM_SIZE
)paren
id|count
op_assign
id|NVRAM_SIZE
op_minus
id|i
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|nvram_image
(braket
id|i
)braket
comma
id|buf
comma
id|count
)paren
suffix:semicolon
op_star
id|index
op_assign
id|i
op_plus
id|count
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|core99_nvram_size
r_static
id|ssize_t
id|__pmac
id|core99_nvram_size
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|nvram_image
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
id|NVRAM_SIZE
suffix:semicolon
)brace
DECL|function|chrp_checksum
r_static
id|u8
id|__pmac
id|chrp_checksum
c_func
(paren
r_struct
id|chrp_header
op_star
id|hdr
)paren
(brace
id|u8
op_star
id|ptr
suffix:semicolon
id|u16
id|sum
op_assign
id|hdr-&gt;signature
suffix:semicolon
r_for
c_loop
(paren
id|ptr
op_assign
(paren
id|u8
op_star
)paren
op_amp
id|hdr-&gt;len
suffix:semicolon
id|ptr
OL
id|hdr-&gt;data
suffix:semicolon
id|ptr
op_increment
)paren
id|sum
op_add_assign
op_star
id|ptr
suffix:semicolon
r_while
c_loop
(paren
id|sum
OG
l_int|0xFF
)paren
id|sum
op_assign
(paren
id|sum
op_amp
l_int|0xFF
)paren
op_plus
(paren
id|sum
op_rshift
l_int|8
)paren
suffix:semicolon
r_return
id|sum
suffix:semicolon
)brace
DECL|function|core99_calc_adler
r_static
id|u32
id|__pmac
id|core99_calc_adler
c_func
(paren
id|u8
op_star
id|buffer
)paren
(brace
r_int
id|cnt
suffix:semicolon
id|u32
id|low
comma
id|high
suffix:semicolon
id|buffer
op_add_assign
id|CORE99_ADLER_START
suffix:semicolon
id|low
op_assign
l_int|1
suffix:semicolon
id|high
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
(paren
id|NVRAM_SIZE
op_minus
id|CORE99_ADLER_START
)paren
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|cnt
op_mod
l_int|5000
)paren
op_eq
l_int|0
)paren
(brace
id|high
op_mod_assign
l_int|65521UL
suffix:semicolon
id|high
op_mod_assign
l_int|65521UL
suffix:semicolon
)brace
id|low
op_add_assign
id|buffer
(braket
id|cnt
)braket
suffix:semicolon
id|high
op_add_assign
id|low
suffix:semicolon
)brace
id|low
op_mod_assign
l_int|65521UL
suffix:semicolon
id|high
op_mod_assign
l_int|65521UL
suffix:semicolon
r_return
(paren
id|high
op_lshift
l_int|16
)paren
op_or
id|low
suffix:semicolon
)brace
DECL|function|core99_check
r_static
id|u32
id|__pmac
id|core99_check
c_func
(paren
id|u8
op_star
id|datas
)paren
(brace
r_struct
id|core99_header
op_star
id|hdr99
op_assign
(paren
r_struct
id|core99_header
op_star
)paren
id|datas
suffix:semicolon
r_if
c_cond
(paren
id|hdr99-&gt;hdr.signature
op_ne
id|CORE99_SIGNATURE
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Invalid signature&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hdr99-&gt;hdr.cksum
op_ne
id|chrp_checksum
c_func
(paren
op_amp
id|hdr99-&gt;hdr
)paren
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Invalid checksum&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hdr99-&gt;adler
op_ne
id|core99_calc_adler
c_func
(paren
id|datas
)paren
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Invalid adler&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|hdr99-&gt;generation
suffix:semicolon
)brace
DECL|function|sm_erase_bank
r_static
r_int
id|__pmac
id|sm_erase_bank
c_func
(paren
r_int
id|bank
)paren
(brace
r_int
id|stat
comma
id|i
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
id|u8
op_star
id|base
op_assign
(paren
id|u8
op_star
)paren
id|nvram_data
op_plus
id|core99_bank
op_star
id|NVRAM_SIZE
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;nvram: Sharp/Micron Erasing bank %d...&bslash;n&quot;
comma
id|bank
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|base
comma
id|SM_FLASH_CMD_ERASE_SETUP
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|base
comma
id|SM_FLASH_CMD_ERASE_CONFIRM
)paren
suffix:semicolon
id|timeout
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
op_increment
id|timeout
OG
l_int|1000000
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;nvram: Sharp/Miron flash erase timeout !&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|out_8
c_func
(paren
id|base
comma
id|SM_FLASH_CMD_READ_STATUS
)paren
suffix:semicolon
id|stat
op_assign
id|in_8
c_func
(paren
id|base
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|stat
op_amp
id|SM_FLASH_STATUS_DONE
)paren
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|base
comma
id|SM_FLASH_CMD_CLEAR_STATUS
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|base
comma
id|SM_FLASH_CMD_RESET
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NVRAM_SIZE
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|base
(braket
id|i
)braket
op_ne
l_int|0xff
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;nvram: Sharp/Micron flash erase failed !&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sm_write_bank
r_static
r_int
id|__pmac
id|sm_write_bank
c_func
(paren
r_int
id|bank
comma
id|u8
op_star
id|datas
)paren
(brace
r_int
id|i
comma
id|stat
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
id|u8
op_star
id|base
op_assign
(paren
id|u8
op_star
)paren
id|nvram_data
op_plus
id|core99_bank
op_star
id|NVRAM_SIZE
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;nvram: Sharp/Micron Writing bank %d...&bslash;n&quot;
comma
id|bank
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NVRAM_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|out_8
c_func
(paren
id|base
op_plus
id|i
comma
id|SM_FLASH_CMD_WRITE_SETUP
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|base
op_plus
id|i
comma
id|datas
(braket
id|i
)braket
)paren
suffix:semicolon
id|timeout
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
op_increment
id|timeout
OG
l_int|1000000
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;nvram: Sharp/Micron flash write timeout !&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|out_8
c_func
(paren
id|base
comma
id|SM_FLASH_CMD_READ_STATUS
)paren
suffix:semicolon
id|stat
op_assign
id|in_8
c_func
(paren
id|base
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|stat
op_amp
id|SM_FLASH_STATUS_DONE
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|stat
op_amp
id|SM_FLASH_STATUS_DONE
)paren
)paren
r_break
suffix:semicolon
)brace
id|out_8
c_func
(paren
id|base
comma
id|SM_FLASH_CMD_CLEAR_STATUS
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|base
comma
id|SM_FLASH_CMD_RESET
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NVRAM_SIZE
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|base
(braket
id|i
)braket
op_ne
id|datas
(braket
id|i
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;nvram: Sharp/Micron flash write failed !&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|amd_erase_bank
r_static
r_int
id|__pmac
id|amd_erase_bank
c_func
(paren
r_int
id|bank
)paren
(brace
r_int
id|i
comma
id|stat
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
id|u8
op_star
id|base
op_assign
(paren
id|u8
op_star
)paren
id|nvram_data
op_plus
id|core99_bank
op_star
id|NVRAM_SIZE
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;nvram: AMD Erasing bank %d...&bslash;n&quot;
comma
id|bank
)paren
suffix:semicolon
multiline_comment|/* Unlock 1 */
id|out_8
c_func
(paren
id|base
op_plus
l_int|0x555
comma
l_int|0xaa
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Unlock 2 */
id|out_8
c_func
(paren
id|base
op_plus
l_int|0x2aa
comma
l_int|0x55
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Sector-Erase */
id|out_8
c_func
(paren
id|base
op_plus
l_int|0x555
comma
l_int|0x80
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|base
op_plus
l_int|0x555
comma
l_int|0xaa
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|base
op_plus
l_int|0x2aa
comma
l_int|0x55
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|base
comma
l_int|0x30
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|timeout
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
op_increment
id|timeout
OG
l_int|1000000
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;nvram: AMD flash erase timeout !&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|stat
op_assign
id|in_8
c_func
(paren
id|base
)paren
op_xor
id|in_8
c_func
(paren
id|base
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|stat
op_ne
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Reset */
id|out_8
c_func
(paren
id|base
comma
l_int|0xf0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NVRAM_SIZE
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|base
(braket
id|i
)braket
op_ne
l_int|0xff
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;nvram: AMD flash erase failed !&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|amd_write_bank
r_static
r_int
id|__pmac
id|amd_write_bank
c_func
(paren
r_int
id|bank
comma
id|u8
op_star
id|datas
)paren
(brace
r_int
id|i
comma
id|stat
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
id|u8
op_star
id|base
op_assign
(paren
id|u8
op_star
)paren
id|nvram_data
op_plus
id|core99_bank
op_star
id|NVRAM_SIZE
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;nvram: AMD Writing bank %d...&bslash;n&quot;
comma
id|bank
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NVRAM_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Unlock 1 */
id|out_8
c_func
(paren
id|base
op_plus
l_int|0x555
comma
l_int|0xaa
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Unlock 2 */
id|out_8
c_func
(paren
id|base
op_plus
l_int|0x2aa
comma
l_int|0x55
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Write single word */
id|out_8
c_func
(paren
id|base
op_plus
l_int|0x555
comma
l_int|0xa0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|base
op_plus
id|i
comma
id|datas
(braket
id|i
)braket
)paren
suffix:semicolon
id|timeout
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
op_increment
id|timeout
OG
l_int|1000000
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;nvram: AMD flash write timeout !&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|stat
op_assign
id|in_8
c_func
(paren
id|base
)paren
op_xor
id|in_8
c_func
(paren
id|base
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|stat
op_ne
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_ne
l_int|0
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/* Reset */
id|out_8
c_func
(paren
id|base
comma
l_int|0xf0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NVRAM_SIZE
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|base
(braket
id|i
)braket
op_ne
id|datas
(braket
id|i
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;nvram: AMD flash write failed !&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|core99_nvram_sync
r_static
r_int
id|__pmac
id|core99_nvram_sync
c_func
(paren
r_void
)paren
(brace
r_struct
id|core99_header
op_star
id|hdr99
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|nv_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|nvram_image
comma
(paren
id|u8
op_star
)paren
id|nvram_data
op_plus
id|core99_bank
op_star
id|NVRAM_SIZE
comma
id|NVRAM_SIZE
)paren
)paren
r_goto
id|bail
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;Updating nvram...&bslash;n&quot;
)paren
suffix:semicolon
id|hdr99
op_assign
(paren
r_struct
id|core99_header
op_star
)paren
id|nvram_image
suffix:semicolon
id|hdr99-&gt;generation
op_increment
suffix:semicolon
id|hdr99-&gt;hdr.signature
op_assign
id|CORE99_SIGNATURE
suffix:semicolon
id|hdr99-&gt;hdr.cksum
op_assign
id|chrp_checksum
c_func
(paren
op_amp
id|hdr99-&gt;hdr
)paren
suffix:semicolon
id|hdr99-&gt;adler
op_assign
id|core99_calc_adler
c_func
(paren
id|nvram_image
)paren
suffix:semicolon
id|core99_bank
op_assign
id|core99_bank
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|core99_erase_bank
)paren
r_if
c_cond
(paren
id|core99_erase_bank
c_func
(paren
id|core99_bank
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nvram: Error erasing bank %d&bslash;n&quot;
comma
id|core99_bank
)paren
suffix:semicolon
r_goto
id|bail
suffix:semicolon
)brace
r_if
c_cond
(paren
id|core99_write_bank
)paren
r_if
c_cond
(paren
id|core99_write_bank
c_func
(paren
id|core99_bank
comma
id|nvram_image
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;nvram: Error writing bank %d&bslash;n&quot;
comma
id|core99_bank
)paren
suffix:semicolon
id|bail
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|nv_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pmac_nvram_init
r_int
id|__init
id|pmac_nvram_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|dp
suffix:semicolon
id|u32
id|gen_bank0
comma
id|gen_bank1
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dp
op_assign
id|find_devices
c_func
(paren
l_string|&quot;nvram&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dp
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Can&squot;t find NVRAM device&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|device_is_compatible
c_func
(paren
id|dp
comma
l_string|&quot;nvram,flash&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Incompatible type of NVRAM&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|nvram_image
op_assign
id|alloc_bootmem
c_func
(paren
id|NVRAM_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nvram_image
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;nvram: can&squot;t allocate ram image&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|nvram_data
op_assign
id|ioremap
c_func
(paren
id|dp-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
comma
id|NVRAM_SIZE
op_star
l_int|2
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;nvram: Checking bank 0...&bslash;n&quot;
)paren
suffix:semicolon
id|gen_bank0
op_assign
id|core99_check
c_func
(paren
(paren
id|u8
op_star
)paren
id|nvram_data
)paren
suffix:semicolon
id|gen_bank1
op_assign
id|core99_check
c_func
(paren
(paren
id|u8
op_star
)paren
id|nvram_data
op_plus
id|NVRAM_SIZE
)paren
suffix:semicolon
id|core99_bank
op_assign
(paren
id|gen_bank0
OL
id|gen_bank1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;nvram: gen0=%d, gen1=%d&bslash;n&quot;
comma
id|gen_bank0
comma
id|gen_bank1
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;nvram: Active bank is: %d&bslash;n&quot;
comma
id|core99_bank
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NVRAM_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|nvram_image
(braket
id|i
)braket
op_assign
id|nvram_data
(braket
id|i
op_plus
id|core99_bank
op_star
id|NVRAM_SIZE
)braket
suffix:semicolon
id|ppc_md.nvram_read
op_assign
id|core99_nvram_read
suffix:semicolon
id|ppc_md.nvram_write
op_assign
id|core99_nvram_write
suffix:semicolon
id|ppc_md.nvram_size
op_assign
id|core99_nvram_size
suffix:semicolon
id|ppc_md.nvram_sync
op_assign
id|core99_nvram_sync
suffix:semicolon
multiline_comment|/* &n;&t; * Maybe we could be smarter here though making an exclusive list&n;&t; * of known flash chips is a bit nasty as older OF didn&squot;t provide us&n;&t; * with a useful &quot;compatible&quot; entry. A solution would be to really&n;&t; * identify the chip using flash id commands and base ourselves on&n;&t; * a list of known chips IDs&n;&t; */
r_if
c_cond
(paren
id|device_is_compatible
c_func
(paren
id|dp
comma
l_string|&quot;amd-0137&quot;
)paren
)paren
(brace
id|core99_erase_bank
op_assign
id|amd_erase_bank
suffix:semicolon
id|core99_write_bank
op_assign
id|amd_write_bank
suffix:semicolon
)brace
r_else
(brace
id|core99_erase_bank
op_assign
id|sm_erase_bank
suffix:semicolon
id|core99_write_bank
op_assign
id|sm_write_bank
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pmac_get_partition
r_int
id|__pmac
id|pmac_get_partition
c_func
(paren
r_int
id|partition
)paren
(brace
r_struct
id|nvram_partition
op_star
id|part
suffix:semicolon
r_const
r_char
op_star
id|name
suffix:semicolon
r_int
id|sig
suffix:semicolon
r_switch
c_cond
(paren
id|partition
)paren
(brace
r_case
id|pmac_nvram_OF
suffix:colon
id|name
op_assign
l_string|&quot;common&quot;
suffix:semicolon
id|sig
op_assign
id|NVRAM_SIG_SYS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|pmac_nvram_XPRAM
suffix:colon
id|name
op_assign
l_string|&quot;APL,MacOS75&quot;
suffix:semicolon
id|sig
op_assign
id|NVRAM_SIG_OS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|pmac_nvram_NR
suffix:colon
r_default
suffix:colon
multiline_comment|/* Oldworld stuff */
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|part
op_assign
id|nvram_find_partition
c_func
(paren
id|sig
comma
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|part
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|part-&gt;index
suffix:semicolon
)brace
DECL|function|pmac_xpram_read
id|u8
id|__pmac
id|pmac_xpram_read
c_func
(paren
r_int
id|xpaddr
)paren
(brace
r_int
id|offset
op_assign
id|pmac_get_partition
c_func
(paren
id|pmac_nvram_XPRAM
)paren
suffix:semicolon
id|loff_t
id|index
suffix:semicolon
id|u8
id|buf
suffix:semicolon
id|ssize_t
id|count
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
l_int|0
op_logical_or
id|xpaddr
template_param
l_int|0x100
)paren
r_return
l_int|0xff
suffix:semicolon
id|index
op_assign
id|offset
op_plus
id|xpaddr
suffix:semicolon
id|count
op_assign
id|ppc_md
dot
id|nvram_read
c_func
(paren
op_amp
id|buf
comma
l_int|1
comma
op_amp
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_ne
l_int|1
)paren
r_return
l_int|0xff
suffix:semicolon
r_return
id|buf
suffix:semicolon
)brace
DECL|function|pmac_xpram_write
r_void
id|__pmac
id|pmac_xpram_write
c_func
(paren
r_int
id|xpaddr
comma
id|u8
id|data
)paren
(brace
r_int
id|offset
op_assign
id|pmac_get_partition
c_func
(paren
id|pmac_nvram_XPRAM
)paren
suffix:semicolon
id|loff_t
id|index
suffix:semicolon
id|u8
id|buf
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
l_int|0
op_logical_or
id|xpaddr
template_param
l_int|0x100
)paren
r_return
suffix:semicolon
id|index
op_assign
id|offset
op_plus
id|xpaddr
suffix:semicolon
id|buf
op_assign
id|data
suffix:semicolon
id|ppc_md
dot
id|nvram_write
c_func
(paren
op_amp
id|buf
comma
l_int|1
comma
op_amp
id|index
)paren
suffix:semicolon
)brace
DECL|variable|pmac_get_partition
id|EXPORT_SYMBOL
c_func
(paren
id|pmac_get_partition
)paren
suffix:semicolon
DECL|variable|pmac_xpram_read
id|EXPORT_SYMBOL
c_func
(paren
id|pmac_xpram_read
)paren
suffix:semicolon
DECL|variable|pmac_xpram_write
id|EXPORT_SYMBOL
c_func
(paren
id|pmac_xpram_write
)paren
suffix:semicolon
eof
