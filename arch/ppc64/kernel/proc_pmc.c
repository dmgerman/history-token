multiline_comment|/*&n; * proc_pmc.c&n; * Copyright (C) 2001 Mike Corrigan &amp; Dave Engebretsen IBM Corporation&n; * &n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; * &n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; * &n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; */
multiline_comment|/* Change Activity:&n; * 2001       : mikec    : Created&n; * 2001/06/05 : engebret : Software event count support.&n; * End Change Activity &n; */
macro_line|#include &lt;asm/proc_fs.h&gt;
macro_line|#include &lt;asm/paca.h&gt;
macro_line|#include &lt;asm/iSeries/ItLpPaca.h&gt;
macro_line|#include &lt;asm/iSeries/ItLpQueue.h&gt;
macro_line|#include &lt;asm/iSeries/HvCallXm.h&gt;
macro_line|#include &lt;asm/iSeries/IoHriMainStore.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/time.h&gt;
macro_line|#include &lt;asm/iSeries/LparData.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/pmc.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/naca.h&gt;
DECL|variable|proc_pmc_control_mode
r_static
r_int
id|proc_pmc_control_mode
op_assign
l_int|0
suffix:semicolon
DECL|variable|proc_ppc64_root
r_static
r_struct
id|proc_dir_entry
op_star
id|proc_ppc64_root
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|proc_ppc64_pmc_root
r_static
r_struct
id|proc_dir_entry
op_star
id|proc_ppc64_pmc_root
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|proc_ppc64_pmc_system_root
r_static
r_struct
id|proc_dir_entry
op_star
id|proc_ppc64_pmc_system_root
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|proc_ppc64_pmc_cpu_root
r_static
r_struct
id|proc_dir_entry
op_star
id|proc_ppc64_pmc_cpu_root
(braket
id|NR_CPUS
)braket
op_assign
(brace
l_int|NULL
comma
)brace
suffix:semicolon
DECL|variable|proc_ppc64_lock
r_static
id|spinlock_t
id|proc_ppc64_lock
suffix:semicolon
r_int
id|proc_ppc64_pmc_find_file
c_func
(paren
r_void
op_star
id|data
)paren
suffix:semicolon
r_int
id|proc_ppc64_pmc_read
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_char
op_star
id|buffer
)paren
suffix:semicolon
r_int
id|proc_ppc64_pmc_stab_read
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_int
id|proc_ppc64_pmc_htab_read
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_int
id|proc_ppc64_pmc_hw_read
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
DECL|variable|pmc_proc_root
r_static
r_struct
id|proc_dir_entry
op_star
id|pmc_proc_root
op_assign
l_int|NULL
suffix:semicolon
r_int
id|proc_get_lpevents
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_int
id|proc_reset_lpevents
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_int
id|proc_get_titanTod
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_int
id|proc_pmc_get_control
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_int
id|proc_pmc_set_control
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_int
id|proc_pmc_set_mmcr0
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_int
id|proc_pmc_set_mmcr1
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_int
id|proc_pmc_set_mmcra
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_int
id|proc_pmc_set_pmc1
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_int
id|proc_pmc_set_pmc2
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_int
id|proc_pmc_set_pmc3
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_int
id|proc_pmc_set_pmc4
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_int
id|proc_pmc_set_pmc5
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_int
id|proc_pmc_set_pmc6
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_int
id|proc_pmc_set_pmc7
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_int
id|proc_pmc_set_pmc8
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
suffix:semicolon
DECL|function|proc_ppc64_init
r_void
id|proc_ppc64_init
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
r_struct
id|proc_dir_entry
op_star
id|ent
op_assign
l_int|NULL
suffix:semicolon
r_char
id|buf
(braket
l_int|256
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;proc_ppc64: Creating /proc/ppc64/pmc&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Create the root, system, and cpu directories as follows:&n;&t; *   /proc/ppc64/pmc/system &n;&t; *   /proc/ppc64/pmc/cpu0 &n;&t; */
id|spin_lock
c_func
(paren
op_amp
id|proc_ppc64_lock
)paren
suffix:semicolon
id|proc_ppc64_root
op_assign
id|proc_mkdir
c_func
(paren
l_string|&quot;ppc64&quot;
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|proc_ppc64_root
)paren
r_return
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|proc_ppc64_lock
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PPC_EEH
id|eeh_init_proc
c_func
(paren
id|proc_ppc64_root
)paren
suffix:semicolon
macro_line|#endif
id|proc_ppc64_pmc_root
op_assign
id|proc_mkdir
c_func
(paren
l_string|&quot;pmc&quot;
comma
id|proc_ppc64_root
)paren
suffix:semicolon
id|proc_ppc64_pmc_system_root
op_assign
id|proc_mkdir
c_func
(paren
l_string|&quot;system&quot;
comma
id|proc_ppc64_pmc_root
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|naca-&gt;processorCount
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;cpu%ld&quot;
comma
id|i
)paren
suffix:semicolon
id|proc_ppc64_pmc_cpu_root
(braket
id|i
)braket
op_assign
id|proc_mkdir
c_func
(paren
id|buf
comma
id|proc_ppc64_pmc_root
)paren
suffix:semicolon
)brace
multiline_comment|/* Create directories for the software counters. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|naca-&gt;processorCount
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ent
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;stab&quot;
comma
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|proc_ppc64_pmc_cpu_root
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ent
)paren
(brace
id|ent-&gt;nlink
op_assign
l_int|1
suffix:semicolon
id|ent-&gt;data
op_assign
(paren
r_void
op_star
)paren
id|proc_ppc64_pmc_cpu_root
(braket
id|i
)braket
suffix:semicolon
id|ent-&gt;read_proc
op_assign
(paren
r_void
op_star
)paren
id|proc_ppc64_pmc_stab_read
suffix:semicolon
id|ent-&gt;write_proc
op_assign
(paren
r_void
op_star
)paren
id|proc_ppc64_pmc_stab_read
suffix:semicolon
)brace
id|ent
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;htab&quot;
comma
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|proc_ppc64_pmc_cpu_root
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ent
)paren
(brace
id|ent-&gt;nlink
op_assign
l_int|1
suffix:semicolon
id|ent-&gt;data
op_assign
(paren
r_void
op_star
)paren
id|proc_ppc64_pmc_cpu_root
(braket
id|i
)braket
suffix:semicolon
id|ent-&gt;read_proc
op_assign
(paren
r_void
op_star
)paren
id|proc_ppc64_pmc_htab_read
suffix:semicolon
id|ent-&gt;write_proc
op_assign
(paren
r_void
op_star
)paren
id|proc_ppc64_pmc_htab_read
suffix:semicolon
)brace
)brace
id|ent
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;stab&quot;
comma
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|proc_ppc64_pmc_system_root
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ent
)paren
(brace
id|ent-&gt;nlink
op_assign
l_int|1
suffix:semicolon
id|ent-&gt;data
op_assign
(paren
r_void
op_star
)paren
id|proc_ppc64_pmc_system_root
suffix:semicolon
id|ent-&gt;read_proc
op_assign
(paren
r_void
op_star
)paren
id|proc_ppc64_pmc_stab_read
suffix:semicolon
id|ent-&gt;write_proc
op_assign
(paren
r_void
op_star
)paren
id|proc_ppc64_pmc_stab_read
suffix:semicolon
)brace
id|ent
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;htab&quot;
comma
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|proc_ppc64_pmc_system_root
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ent
)paren
(brace
id|ent-&gt;nlink
op_assign
l_int|1
suffix:semicolon
id|ent-&gt;data
op_assign
(paren
r_void
op_star
)paren
id|proc_ppc64_pmc_system_root
suffix:semicolon
id|ent-&gt;read_proc
op_assign
(paren
r_void
op_star
)paren
id|proc_ppc64_pmc_htab_read
suffix:semicolon
id|ent-&gt;write_proc
op_assign
(paren
r_void
op_star
)paren
id|proc_ppc64_pmc_htab_read
suffix:semicolon
)brace
multiline_comment|/* Create directories for the hardware counters. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|naca-&gt;processorCount
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ent
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;hardware&quot;
comma
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|proc_ppc64_pmc_cpu_root
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ent
)paren
(brace
id|ent-&gt;nlink
op_assign
l_int|1
suffix:semicolon
id|ent-&gt;data
op_assign
(paren
r_void
op_star
)paren
id|proc_ppc64_pmc_cpu_root
(braket
id|i
)braket
suffix:semicolon
id|ent-&gt;read_proc
op_assign
(paren
r_void
op_star
)paren
id|proc_ppc64_pmc_hw_read
suffix:semicolon
id|ent-&gt;write_proc
op_assign
(paren
r_void
op_star
)paren
id|proc_ppc64_pmc_hw_read
suffix:semicolon
)brace
)brace
id|ent
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;hardware&quot;
comma
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|proc_ppc64_pmc_system_root
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ent
)paren
(brace
id|ent-&gt;nlink
op_assign
l_int|1
suffix:semicolon
id|ent-&gt;data
op_assign
(paren
r_void
op_star
)paren
id|proc_ppc64_pmc_system_root
suffix:semicolon
id|ent-&gt;read_proc
op_assign
(paren
r_void
op_star
)paren
id|proc_ppc64_pmc_hw_read
suffix:semicolon
id|ent-&gt;write_proc
op_assign
(paren
r_void
op_star
)paren
id|proc_ppc64_pmc_hw_read
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Find the requested &squot;file&squot; given a proc token.&n; *&n; * Inputs: void * data: proc token&n; * Output: int        : (0, ..., +N) = CPU number.&n; *                      -1           = System.&n; */
DECL|function|proc_ppc64_pmc_find_file
r_int
id|proc_ppc64_pmc_find_file
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|data
op_eq
(paren
r_int
r_int
)paren
id|proc_ppc64_pmc_system_root
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|naca-&gt;processorCount
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|data
op_eq
(paren
r_int
r_int
)paren
id|proc_ppc64_pmc_cpu_root
(braket
id|i
)braket
)paren
(brace
r_return
id|i
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* On error, just default to a type of system. */
id|printk
c_func
(paren
l_string|&quot;proc_ppc64_pmc_find_file: failed to find file token.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_int
DECL|function|proc_ppc64_pmc_read
id|proc_ppc64_pmc_read
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_char
op_star
id|buffer
)paren
(brace
r_int
id|buffer_size
comma
id|n
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|buffer
op_eq
l_int|NULL
)paren
(brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Check for read beyond EOF */
id|buffer_size
op_assign
id|n
op_assign
id|strlen
c_func
(paren
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|off
op_ge
id|buffer_size
)paren
(brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n
OG
(paren
id|buffer_size
op_minus
id|off
)paren
)paren
id|n
op_assign
id|buffer_size
op_minus
id|off
suffix:semicolon
multiline_comment|/* Never return more than was requested */
r_if
c_cond
(paren
id|n
OG
id|count
)paren
(brace
id|n
op_assign
id|count
suffix:semicolon
)brace
r_else
(brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|page
comma
id|buffer
op_plus
id|off
comma
id|n
)paren
suffix:semicolon
op_star
id|start
op_assign
id|page
suffix:semicolon
r_return
id|n
suffix:semicolon
)brace
r_int
DECL|function|proc_ppc64_pmc_stab_read
id|proc_ppc64_pmc_stab_read
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|n
comma
id|file
suffix:semicolon
r_char
op_star
id|buffer
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|proc_ppc64_lock
)paren
suffix:semicolon
multiline_comment|/* Figure out which file is being request. */
id|file
op_assign
id|proc_ppc64_pmc_find_file
c_func
(paren
id|data
)paren
suffix:semicolon
multiline_comment|/* Update the counters and the text buffer representation. */
id|buffer
op_assign
id|ppc64_pmc_stab
c_func
(paren
id|file
)paren
suffix:semicolon
multiline_comment|/* Put the data into the requestor&squot;s buffer. */
id|n
op_assign
id|proc_ppc64_pmc_read
c_func
(paren
id|page
comma
id|start
comma
id|off
comma
id|count
comma
id|eof
comma
id|buffer
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|proc_ppc64_lock
)paren
suffix:semicolon
r_return
id|n
suffix:semicolon
)brace
r_int
DECL|function|proc_ppc64_pmc_htab_read
id|proc_ppc64_pmc_htab_read
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|n
comma
id|file
suffix:semicolon
r_char
op_star
id|buffer
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|proc_ppc64_lock
)paren
suffix:semicolon
multiline_comment|/* Figure out which file is being request. */
id|file
op_assign
id|proc_ppc64_pmc_find_file
c_func
(paren
id|data
)paren
suffix:semicolon
multiline_comment|/* Update the counters and the text buffer representation. */
id|buffer
op_assign
id|ppc64_pmc_htab
c_func
(paren
id|file
)paren
suffix:semicolon
multiline_comment|/* Put the data into the requestor&squot;s buffer. */
id|n
op_assign
id|proc_ppc64_pmc_read
c_func
(paren
id|page
comma
id|start
comma
id|off
comma
id|count
comma
id|eof
comma
id|buffer
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|proc_ppc64_lock
)paren
suffix:semicolon
r_return
id|n
suffix:semicolon
)brace
r_int
DECL|function|proc_ppc64_pmc_hw_read
id|proc_ppc64_pmc_hw_read
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|n
comma
id|file
suffix:semicolon
r_char
op_star
id|buffer
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|proc_ppc64_lock
)paren
suffix:semicolon
multiline_comment|/* Figure out which file is being request. */
id|file
op_assign
id|proc_ppc64_pmc_find_file
c_func
(paren
id|data
)paren
suffix:semicolon
multiline_comment|/* Update the counters and the text buffer representation. */
id|buffer
op_assign
id|ppc64_pmc_hw
c_func
(paren
id|file
)paren
suffix:semicolon
multiline_comment|/* Put the data into the requestor&squot;s buffer. */
id|n
op_assign
id|proc_ppc64_pmc_read
c_func
(paren
id|page
comma
id|start
comma
id|off
comma
id|count
comma
id|eof
comma
id|buffer
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|proc_ppc64_lock
)paren
suffix:semicolon
r_return
id|n
suffix:semicolon
)brace
multiline_comment|/* &n; * DRENG the remainder of these functions still need work ...&n; */
DECL|function|pmc_proc_init
r_void
id|pmc_proc_init
c_func
(paren
r_struct
id|proc_dir_entry
op_star
id|iSeries_proc
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|ent
op_assign
l_int|NULL
suffix:semicolon
id|ent
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;lpevents&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
id|iSeries_proc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ent
)paren
r_return
suffix:semicolon
id|ent-&gt;nlink
op_assign
l_int|1
suffix:semicolon
id|ent-&gt;data
op_assign
(paren
r_void
op_star
)paren
l_int|0
suffix:semicolon
id|ent-&gt;read_proc
op_assign
id|proc_get_lpevents
suffix:semicolon
id|ent-&gt;write_proc
op_assign
id|proc_reset_lpevents
suffix:semicolon
id|ent
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;titanTod&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
id|iSeries_proc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ent
)paren
r_return
suffix:semicolon
id|ent-&gt;nlink
op_assign
l_int|1
suffix:semicolon
id|ent-&gt;data
op_assign
(paren
r_void
op_star
)paren
l_int|0
suffix:semicolon
id|ent-&gt;read_proc
op_assign
id|proc_get_titanTod
suffix:semicolon
id|ent-&gt;write_proc
op_assign
l_int|NULL
suffix:semicolon
id|pmc_proc_root
op_assign
id|proc_mkdir
c_func
(paren
l_string|&quot;pmc&quot;
comma
id|iSeries_proc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pmc_proc_root
)paren
r_return
suffix:semicolon
id|ent
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;control&quot;
comma
id|S_IFREG
op_or
id|S_IRUSR
op_or
id|S_IWUSR
comma
id|pmc_proc_root
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ent
)paren
r_return
suffix:semicolon
id|ent-&gt;nlink
op_assign
l_int|1
suffix:semicolon
id|ent-&gt;data
op_assign
(paren
r_void
op_star
)paren
l_int|0
suffix:semicolon
id|ent-&gt;read_proc
op_assign
id|proc_pmc_get_control
suffix:semicolon
id|ent-&gt;write_proc
op_assign
id|proc_pmc_set_control
suffix:semicolon
)brace
DECL|function|pmc_calc_metrics
r_static
r_int
id|pmc_calc_metrics
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_int
id|len
)paren
(brace
r_if
c_cond
(paren
id|len
op_le
id|off
op_plus
id|count
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
id|len
op_sub_assign
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|variable|lpEventTypes
r_static
r_char
op_star
id|lpEventTypes
(braket
l_int|9
)braket
op_assign
(brace
l_string|&quot;Hypervisor&bslash;t&bslash;t&quot;
comma
l_string|&quot;Machine Facilities&bslash;t&quot;
comma
l_string|&quot;Session Manager&bslash;t&quot;
comma
l_string|&quot;SPD I/O&bslash;t&bslash;t&quot;
comma
l_string|&quot;Virtual Bus&bslash;t&bslash;t&quot;
comma
l_string|&quot;PCI I/O&bslash;t&bslash;t&quot;
comma
l_string|&quot;RIO I/O&bslash;t&bslash;t&quot;
comma
l_string|&quot;Virtual Lan&bslash;t&bslash;t&quot;
comma
l_string|&quot;Virtual I/O&bslash;t&bslash;t&quot;
)brace
suffix:semicolon
DECL|function|proc_get_lpevents
r_int
id|proc_get_lpevents
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;LpEventQueue 0&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;  events processed:&bslash;t%lu&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|xItLpQueue.xLpIntCount
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|9
suffix:semicolon
op_increment
id|i
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;    %s %10lu&bslash;n&quot;
comma
id|lpEventTypes
(braket
id|i
)braket
comma
(paren
r_int
r_int
)paren
id|xItLpQueue.xLpIntCountByType
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;&bslash;n  events processed by processor:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|naca-&gt;processorCount
suffix:semicolon
op_increment
id|i
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;    CPU%02d  %10u&bslash;n&quot;
comma
id|i
comma
id|paca
(braket
id|i
)braket
dot
id|lpEvent_count
)paren
suffix:semicolon
)brace
r_return
id|pmc_calc_metrics
c_func
(paren
id|page
comma
id|start
comma
id|off
comma
id|count
comma
id|eof
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|proc_reset_lpevents
r_int
id|proc_reset_lpevents
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_return
id|count
suffix:semicolon
)brace
DECL|variable|startTitan
r_static
r_int
r_int
id|startTitan
op_assign
l_int|0
suffix:semicolon
DECL|variable|startTb
r_static
r_int
r_int
id|startTb
op_assign
l_int|0
suffix:semicolon
DECL|function|proc_get_titanTod
r_int
id|proc_get_titanTod
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|tb0
comma
id|titan_tod
suffix:semicolon
id|tb0
op_assign
id|get_tb
c_func
(paren
)paren
suffix:semicolon
id|titan_tod
op_assign
id|HvCallXm_loadTod
c_func
(paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;Titan&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;  time base =          %016lx&bslash;n&quot;
comma
id|tb0
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;  titan tod =          %016lx&bslash;n&quot;
comma
id|titan_tod
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;  xProcFreq =          %016x&bslash;n&quot;
comma
id|xIoHriProcessorVpd
(braket
l_int|0
)braket
dot
id|xProcFreq
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;  xTimeBaseFreq =      %016x&bslash;n&quot;
comma
id|xIoHriProcessorVpd
(braket
l_int|0
)braket
dot
id|xTimeBaseFreq
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;  tb_ticks_per_jiffy = %lu&bslash;n&quot;
comma
id|tb_ticks_per_jiffy
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;  tb_ticks_per_usec  = %lu&bslash;n&quot;
comma
id|tb_ticks_per_usec
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|startTitan
)paren
(brace
id|startTitan
op_assign
id|titan_tod
suffix:semicolon
id|startTb
op_assign
id|tb0
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|titan_usec
op_assign
(paren
id|titan_tod
op_minus
id|startTitan
)paren
op_rshift
l_int|12
suffix:semicolon
r_int
r_int
id|tb_ticks
op_assign
(paren
id|tb0
op_minus
id|startTb
)paren
suffix:semicolon
r_int
r_int
id|titan_jiffies
op_assign
id|titan_usec
op_div
(paren
l_int|1000000
op_div
id|HZ
)paren
suffix:semicolon
r_int
r_int
id|titan_jiff_usec
op_assign
id|titan_jiffies
op_star
(paren
l_int|1000000
op_div
id|HZ
)paren
suffix:semicolon
r_int
r_int
id|titan_jiff_rem_usec
op_assign
id|titan_usec
op_minus
id|titan_jiff_usec
suffix:semicolon
r_int
r_int
id|tb_jiffies
op_assign
id|tb_ticks
op_div
id|tb_ticks_per_jiffy
suffix:semicolon
r_int
r_int
id|tb_jiff_ticks
op_assign
id|tb_jiffies
op_star
id|tb_ticks_per_jiffy
suffix:semicolon
r_int
r_int
id|tb_jiff_rem_ticks
op_assign
id|tb_ticks
op_minus
id|tb_jiff_ticks
suffix:semicolon
r_int
r_int
id|tb_jiff_rem_usec
op_assign
id|tb_jiff_rem_ticks
op_div
id|tb_ticks_per_usec
suffix:semicolon
r_int
r_int
id|new_tb_ticks_per_jiffy
op_assign
(paren
id|tb_ticks
op_star
(paren
l_int|1000000
op_div
id|HZ
)paren
)paren
op_div
id|titan_usec
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;  titan elapsed = %lu uSec&bslash;n&quot;
comma
id|titan_usec
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;  tb elapsed    = %lu ticks&bslash;n&quot;
comma
id|tb_ticks
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;  titan jiffies = %lu.%04lu &bslash;n&quot;
comma
id|titan_jiffies
comma
id|titan_jiff_rem_usec
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;  tb jiffies    = %lu.%04lu&bslash;n&quot;
comma
id|tb_jiffies
comma
id|tb_jiff_rem_usec
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;  new tb_ticks_per_jiffy = %lu&bslash;n&quot;
comma
id|new_tb_ticks_per_jiffy
)paren
suffix:semicolon
)brace
r_return
id|pmc_calc_metrics
c_func
(paren
id|page
comma
id|start
comma
id|off
comma
id|count
comma
id|eof
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|proc_pmc_get_control
r_int
id|proc_pmc_get_control
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|proc_pmc_control_mode
op_eq
id|PMC_CONTROL_CPI
)paren
(brace
r_int
r_int
id|mach_cycles
op_assign
id|mfspr
c_func
(paren
id|PMC5
)paren
suffix:semicolon
r_int
r_int
id|inst_complete
op_assign
id|mfspr
c_func
(paren
id|PMC4
)paren
suffix:semicolon
r_int
r_int
id|inst_dispatch
op_assign
id|mfspr
c_func
(paren
id|PMC3
)paren
suffix:semicolon
r_int
r_int
id|thread_active_run
op_assign
id|mfspr
c_func
(paren
id|PMC1
)paren
suffix:semicolon
r_int
r_int
id|thread_active
op_assign
id|mfspr
c_func
(paren
id|PMC2
)paren
suffix:semicolon
r_int
r_int
id|cpi
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|cpithou
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|remain
suffix:semicolon
r_if
c_cond
(paren
id|inst_complete
)paren
(brace
id|cpi
op_assign
id|thread_active_run
op_div
id|inst_complete
suffix:semicolon
id|remain
op_assign
id|thread_active_run
op_mod
id|inst_complete
suffix:semicolon
r_if
c_cond
(paren
id|inst_complete
OG
l_int|1000000
)paren
id|cpithou
op_assign
id|remain
op_div
(paren
id|inst_complete
op_div
l_int|1000
)paren
suffix:semicolon
r_else
id|cpithou
op_assign
(paren
id|remain
op_star
l_int|1000
)paren
op_div
id|inst_complete
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;PMC CPI Mode&bslash;nRaw Counts&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;machine cycles           : %12lu&bslash;n&quot;
comma
id|mach_cycles
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;thread active cycles     : %12lu&bslash;n&bslash;n&quot;
comma
id|thread_active
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;instructions completed   : %12lu&bslash;n&quot;
comma
id|inst_complete
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;instructions dispatched  : %12lu&bslash;n&quot;
comma
id|inst_dispatch
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;thread active run cycles : %12lu&bslash;n&quot;
comma
id|thread_active_run
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;thread active run cycles/instructions completed&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;CPI = %lu.%03lu&bslash;n&quot;
comma
id|cpi
comma
id|cpithou
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|proc_pmc_control_mode
op_eq
id|PMC_CONTROL_TLB
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;PMC TLB Mode&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;I-miss count             : %12lu&bslash;n&quot;
comma
id|mfspr
c_func
(paren
id|PMC1
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;I-miss latency           : %12lu&bslash;n&quot;
comma
id|mfspr
c_func
(paren
id|PMC2
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;D-miss count             : %12lu&bslash;n&quot;
comma
id|mfspr
c_func
(paren
id|PMC3
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;D-miss latency           : %12lu&bslash;n&quot;
comma
id|mfspr
c_func
(paren
id|PMC4
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;IERAT miss count         : %12lu&bslash;n&quot;
comma
id|mfspr
c_func
(paren
id|PMC5
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;D-reference count        : %12lu&bslash;n&quot;
comma
id|mfspr
c_func
(paren
id|PMC6
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;miss PTEs searched       : %12lu&bslash;n&quot;
comma
id|mfspr
c_func
(paren
id|PMC7
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;miss &gt;8 PTEs searched    : %12lu&bslash;n&quot;
comma
id|mfspr
c_func
(paren
id|PMC8
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* IMPLEMENT ME */
r_return
id|pmc_calc_metrics
c_func
(paren
id|page
comma
id|start
comma
id|off
comma
id|count
comma
id|eof
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|proc_pmc_conv_int
r_int
r_int
id|proc_pmc_conv_int
c_func
(paren
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_const
r_char
op_star
id|p
suffix:semicolon
r_char
id|b0
comma
id|b1
suffix:semicolon
r_int
id|v
comma
id|multiplier
comma
id|mult
comma
id|i
suffix:semicolon
r_int
r_int
id|val
suffix:semicolon
id|multiplier
op_assign
l_int|10
suffix:semicolon
id|p
op_assign
id|buf
suffix:semicolon
r_if
c_cond
(paren
id|count
op_ge
l_int|3
)paren
(brace
id|b0
op_assign
id|buf
(braket
l_int|0
)braket
suffix:semicolon
id|b1
op_assign
id|buf
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|b0
op_eq
l_char|&squot;0&squot;
)paren
op_logical_and
(paren
(paren
id|b1
op_eq
l_char|&squot;x&squot;
)paren
op_logical_or
(paren
id|b1
op_eq
l_char|&squot;X&squot;
)paren
)paren
)paren
(brace
id|p
op_assign
id|buf
op_plus
l_int|2
suffix:semicolon
id|count
op_sub_assign
l_int|2
suffix:semicolon
id|multiplier
op_assign
l_int|16
suffix:semicolon
)brace
)brace
id|val
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
op_increment
id|i
)paren
(brace
id|b0
op_assign
op_star
id|p
op_increment
suffix:semicolon
id|v
op_assign
l_int|0
suffix:semicolon
id|mult
op_assign
id|multiplier
suffix:semicolon
r_if
c_cond
(paren
(paren
id|b0
op_ge
l_char|&squot;0&squot;
)paren
op_logical_and
(paren
id|b0
op_le
l_char|&squot;9&squot;
)paren
)paren
id|v
op_assign
id|b0
op_minus
l_char|&squot;0&squot;
suffix:semicolon
r_else
r_if
c_cond
(paren
id|multiplier
op_eq
l_int|16
)paren
(brace
r_if
c_cond
(paren
(paren
id|b0
op_ge
l_char|&squot;a&squot;
)paren
op_logical_and
(paren
id|b0
op_le
l_char|&squot;f&squot;
)paren
)paren
id|v
op_assign
id|b0
op_minus
l_char|&squot;a&squot;
op_plus
l_int|10
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|b0
op_ge
l_char|&squot;A&squot;
)paren
op_logical_and
(paren
id|b0
op_le
l_char|&squot;F&squot;
)paren
)paren
id|v
op_assign
id|b0
op_minus
l_char|&squot;A&squot;
op_plus
l_int|10
suffix:semicolon
r_else
id|mult
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|mult
op_assign
l_int|1
suffix:semicolon
id|val
op_mul_assign
id|mult
suffix:semicolon
id|val
op_add_assign
id|v
suffix:semicolon
)brace
r_return
id|val
suffix:semicolon
)brace
DECL|function|proc_pmc_stop
r_static
r_inline
r_void
id|proc_pmc_stop
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Freeze all counters, leave everything else alone */
id|mtspr
c_func
(paren
id|MMCR0
comma
id|mfspr
c_func
(paren
id|MMCR0
)paren
op_or
l_int|0x80000000
)paren
suffix:semicolon
)brace
DECL|function|proc_pmc_start
r_static
r_inline
r_void
id|proc_pmc_start
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Unfreeze all counters, leave everything else alone */
id|mtspr
c_func
(paren
id|MMCR0
comma
id|mfspr
c_func
(paren
id|MMCR0
)paren
op_amp
op_complement
l_int|0x80000000
)paren
suffix:semicolon
)brace
DECL|function|proc_pmc_reset
r_static
r_inline
r_void
id|proc_pmc_reset
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Clear all the PMCs to zeros &n;&t; * Assume a &quot;stop&quot; has already frozen the counters&n;&t; * Clear all the PMCs&n;&t; */
id|mtspr
c_func
(paren
id|PMC1
comma
l_int|0
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC2
comma
l_int|0
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC3
comma
l_int|0
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC4
comma
l_int|0
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC5
comma
l_int|0
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC6
comma
l_int|0
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC7
comma
l_int|0
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC8
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|proc_pmc_cpi
r_static
r_inline
r_void
id|proc_pmc_cpi
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Configure the PMC registers to count cycles and instructions */
multiline_comment|/* so we can compute cpi */
multiline_comment|/*&n;&t; * MMCRA[30]    = 1     Don&squot;t count in wait state (CTRL[31]=0)&n;&t; * MMCR0[6]     = 1     Freeze counters when any overflow&n;&t; * MMCR0[19:25] = 0x01  PMC1 counts Thread Active Run Cycles&n;&t; * MMCR0[26:31] = 0x05&t;PMC2 counts Thread Active Cycles&n;&t; * MMCR1[0:4]   = 0x07&t;PMC3 counts Instructions Dispatched&n;&t; * MMCR1[5:9]   = 0x03&t;PMC4 counts Instructions Completed&n;&t; * MMCR1[10:14] = 0x06&t;PMC5 counts Machine Cycles&n;&t; *&n;&t; */
id|proc_pmc_control_mode
op_assign
id|PMC_CONTROL_CPI
suffix:semicolon
multiline_comment|/* Indicate to hypervisor that we are using the PMCs */
id|get_paca
c_func
(paren
)paren
op_member_access_from_pointer
id|xLpPacaPtr-&gt;xPMCRegsInUse
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Freeze all counters */
id|mtspr
c_func
(paren
id|MMCR0
comma
l_int|0x80000000
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|MMCR1
comma
l_int|0x00000000
)paren
suffix:semicolon
multiline_comment|/* Clear all the PMCs */
id|mtspr
c_func
(paren
id|PMC1
comma
l_int|0
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC2
comma
l_int|0
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC3
comma
l_int|0
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC4
comma
l_int|0
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC5
comma
l_int|0
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC6
comma
l_int|0
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC7
comma
l_int|0
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC8
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Freeze counters in Wait State (CTRL[31]=0) */
id|mtspr
c_func
(paren
id|MMCRA
comma
l_int|0x00000002
)paren
suffix:semicolon
multiline_comment|/* PMC3&lt;-0x07, PMC4&lt;-0x03, PMC5&lt;-0x06 */
id|mtspr
c_func
(paren
id|MMCR1
comma
l_int|0x38cc0000
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* PMC1&lt;-0x01, PMC2&lt;-0x05&n;&t; * Start all counters&n;&t; */
id|mtspr
c_func
(paren
id|MMCR0
comma
l_int|0x02000045
)paren
suffix:semicolon
)brace
DECL|function|proc_pmc_tlb
r_static
r_inline
r_void
id|proc_pmc_tlb
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Configure the PMC registers to count tlb misses  */
multiline_comment|/*&n;&t; * MMCR0[6]     = 1     Freeze counters when any overflow&n;&t; * MMCR0[19:25] = 0x55  Group count&n;&t; *   PMC1 counts  I misses&n;&t; *   PMC2 counts  I miss duration (latency)&n;&t; *   PMC3 counts  D misses&n;&t; *   PMC4 counts  D miss duration (latency)&n;&t; *   PMC5 counts  IERAT misses&n;&t; *   PMC6 counts  D references (including PMC7)&n;&t; *   PMC7 counts  miss PTEs searched&n;&t; *   PMC8 counts  miss &gt;8 PTEs searched&n;&t; *   &n;&t; */
id|proc_pmc_control_mode
op_assign
id|PMC_CONTROL_TLB
suffix:semicolon
multiline_comment|/* Indicate to hypervisor that we are using the PMCs */
id|get_paca
c_func
(paren
)paren
op_member_access_from_pointer
id|xLpPacaPtr-&gt;xPMCRegsInUse
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Freeze all counters */
id|mtspr
c_func
(paren
id|MMCR0
comma
l_int|0x80000000
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|MMCR1
comma
l_int|0x00000000
)paren
suffix:semicolon
multiline_comment|/* Clear all the PMCs */
id|mtspr
c_func
(paren
id|PMC1
comma
l_int|0
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC2
comma
l_int|0
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC3
comma
l_int|0
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC4
comma
l_int|0
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC5
comma
l_int|0
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC6
comma
l_int|0
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC7
comma
l_int|0
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC8
comma
l_int|0
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|MMCRA
comma
l_int|0x00000000
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* PMC1&lt;-0x55&n;&t; * Start all counters&n;&t; */
id|mtspr
c_func
(paren
id|MMCR0
comma
l_int|0x02001540
)paren
suffix:semicolon
)brace
DECL|function|proc_pmc_set_control
r_int
id|proc_pmc_set_control
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|buffer
comma
l_string|&quot;stop&quot;
comma
l_int|4
)paren
)paren
id|proc_pmc_stop
c_func
(paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|buffer
comma
l_string|&quot;start&quot;
comma
l_int|5
)paren
)paren
id|proc_pmc_start
c_func
(paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|buffer
comma
l_string|&quot;reset&quot;
comma
l_int|5
)paren
)paren
id|proc_pmc_reset
c_func
(paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|buffer
comma
l_string|&quot;cpi&quot;
comma
l_int|3
)paren
)paren
id|proc_pmc_cpi
c_func
(paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|buffer
comma
l_string|&quot;tlb&quot;
comma
l_int|3
)paren
)paren
id|proc_pmc_tlb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* IMPLEMENT ME */
r_return
id|count
suffix:semicolon
)brace
DECL|function|proc_pmc_set_mmcr0
r_int
id|proc_pmc_set_mmcr0
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_int
r_int
id|v
suffix:semicolon
id|v
op_assign
id|proc_pmc_conv_int
c_func
(paren
id|buffer
comma
id|count
)paren
suffix:semicolon
id|v
op_assign
id|v
op_amp
op_complement
l_int|0x04000000
suffix:semicolon
multiline_comment|/* Don&squot;t allow interrupts for now */
r_if
c_cond
(paren
id|v
op_amp
op_complement
l_int|0x80000000
)paren
multiline_comment|/* Inform hypervisor we are using PMCs */
id|get_paca
c_func
(paren
)paren
op_member_access_from_pointer
id|xLpPacaPtr-&gt;xPMCRegsInUse
op_assign
l_int|1
suffix:semicolon
r_else
id|get_paca
c_func
(paren
)paren
op_member_access_from_pointer
id|xLpPacaPtr-&gt;xPMCRegsInUse
op_assign
l_int|0
suffix:semicolon
id|mtspr
c_func
(paren
id|MMCR0
comma
id|v
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|proc_pmc_set_mmcr1
r_int
id|proc_pmc_set_mmcr1
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_int
r_int
id|v
suffix:semicolon
id|v
op_assign
id|proc_pmc_conv_int
c_func
(paren
id|buffer
comma
id|count
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|MMCR1
comma
id|v
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|proc_pmc_set_mmcra
r_int
id|proc_pmc_set_mmcra
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_int
r_int
id|v
suffix:semicolon
id|v
op_assign
id|proc_pmc_conv_int
c_func
(paren
id|buffer
comma
id|count
)paren
suffix:semicolon
id|v
op_assign
id|v
op_amp
op_complement
l_int|0x00008000
suffix:semicolon
multiline_comment|/* Don&squot;t allow interrupts for now */
id|mtspr
c_func
(paren
id|MMCRA
comma
id|v
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|proc_pmc_set_pmc1
r_int
id|proc_pmc_set_pmc1
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_int
r_int
id|v
suffix:semicolon
id|v
op_assign
id|proc_pmc_conv_int
c_func
(paren
id|buffer
comma
id|count
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC1
comma
id|v
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|proc_pmc_set_pmc2
r_int
id|proc_pmc_set_pmc2
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_int
r_int
id|v
suffix:semicolon
id|v
op_assign
id|proc_pmc_conv_int
c_func
(paren
id|buffer
comma
id|count
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC2
comma
id|v
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|proc_pmc_set_pmc3
r_int
id|proc_pmc_set_pmc3
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_int
r_int
id|v
suffix:semicolon
id|v
op_assign
id|proc_pmc_conv_int
c_func
(paren
id|buffer
comma
id|count
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC3
comma
id|v
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|proc_pmc_set_pmc4
r_int
id|proc_pmc_set_pmc4
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_int
r_int
id|v
suffix:semicolon
id|v
op_assign
id|proc_pmc_conv_int
c_func
(paren
id|buffer
comma
id|count
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC4
comma
id|v
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|proc_pmc_set_pmc5
r_int
id|proc_pmc_set_pmc5
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_int
r_int
id|v
suffix:semicolon
id|v
op_assign
id|proc_pmc_conv_int
c_func
(paren
id|buffer
comma
id|count
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC5
comma
id|v
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|proc_pmc_set_pmc6
r_int
id|proc_pmc_set_pmc6
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_int
r_int
id|v
suffix:semicolon
id|v
op_assign
id|proc_pmc_conv_int
c_func
(paren
id|buffer
comma
id|count
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC6
comma
id|v
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|proc_pmc_set_pmc7
r_int
id|proc_pmc_set_pmc7
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_int
r_int
id|v
suffix:semicolon
id|v
op_assign
id|proc_pmc_conv_int
c_func
(paren
id|buffer
comma
id|count
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC7
comma
id|v
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|proc_pmc_set_pmc8
r_int
id|proc_pmc_set_pmc8
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_int
r_int
id|v
suffix:semicolon
id|v
op_assign
id|proc_pmc_conv_int
c_func
(paren
id|buffer
comma
id|count
)paren
suffix:semicolon
id|mtspr
c_func
(paren
id|PMC8
comma
id|v
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
eof
