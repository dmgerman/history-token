multiline_comment|/*&n; * iSeries_proc.c&n; * Copyright (C) 2001  Kyle A. Lucke IBM Corporation&n; * Copyright (C) 2001 Mike Corrigan &amp; Dave Engebretsen IBM Corporation&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/seq_file.h&gt;
macro_line|#include &lt;linux/param.h&gt;&t;&t;/* for HZ */
macro_line|#include &lt;asm/paca.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/time.h&gt;
macro_line|#include &lt;asm/iSeries/ItLpPaca.h&gt;
macro_line|#include &lt;asm/iSeries/ItLpQueue.h&gt;
macro_line|#include &lt;asm/iSeries/HvCallXm.h&gt;
macro_line|#include &lt;asm/iSeries/IoHriMainStore.h&gt;
macro_line|#include &lt;asm/iSeries/LparData.h&gt;
macro_line|#include &lt;asm/iSeries/iSeries_proc.h&gt;
DECL|function|iseries_proc_create
r_static
r_int
id|__init
id|iseries_proc_create
c_func
(paren
r_void
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|e
op_assign
id|proc_mkdir
c_func
(paren
l_string|&quot;iSeries&quot;
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|e
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|iseries_proc_create
id|core_initcall
c_func
(paren
id|iseries_proc_create
)paren
suffix:semicolon
DECL|variable|event_types
r_static
r_char
op_star
id|event_types
(braket
l_int|9
)braket
op_assign
(brace
l_string|&quot;Hypervisor&bslash;t&bslash;t&quot;
comma
l_string|&quot;Machine Facilities&bslash;t&quot;
comma
l_string|&quot;Session Manager&bslash;t&quot;
comma
l_string|&quot;SPD I/O&bslash;t&bslash;t&quot;
comma
l_string|&quot;Virtual Bus&bslash;t&bslash;t&quot;
comma
l_string|&quot;PCI I/O&bslash;t&bslash;t&quot;
comma
l_string|&quot;RIO I/O&bslash;t&bslash;t&quot;
comma
l_string|&quot;Virtual Lan&bslash;t&bslash;t&quot;
comma
l_string|&quot;Virtual I/O&bslash;t&bslash;t&quot;
)brace
suffix:semicolon
DECL|function|proc_lpevents_show
r_static
r_int
id|proc_lpevents_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;LpEventQueue 0&bslash;n&quot;
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;  events processed:&bslash;t%lu&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|xItLpQueue.xLpIntCount
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|9
suffix:semicolon
op_increment
id|i
)paren
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;    %s %10lu&bslash;n&quot;
comma
id|event_types
(braket
id|i
)braket
comma
(paren
r_int
r_int
)paren
id|xItLpQueue.xLpIntCountByType
(braket
id|i
)braket
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;&bslash;n  events processed by processor:&bslash;n&quot;
)paren
suffix:semicolon
id|for_each_online_cpu
c_func
(paren
id|i
)paren
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;    CPU%02d  %10u&bslash;n&quot;
comma
id|i
comma
id|paca
(braket
id|i
)braket
dot
id|lpevent_count
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|proc_lpevents_open
r_static
r_int
id|proc_lpevents_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|single_open
c_func
(paren
id|file
comma
id|proc_lpevents_show
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|proc_lpevents_operations
r_static
r_struct
id|file_operations
id|proc_lpevents_operations
op_assign
(brace
dot
id|open
op_assign
id|proc_lpevents_open
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|release
op_assign
id|single_release
comma
)brace
suffix:semicolon
DECL|variable|startTitan
r_static
r_int
r_int
id|startTitan
op_assign
l_int|0
suffix:semicolon
DECL|variable|startTb
r_static
r_int
r_int
id|startTb
op_assign
l_int|0
suffix:semicolon
DECL|function|proc_titantod_show
r_static
r_int
id|proc_titantod_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
(brace
r_int
r_int
id|tb0
comma
id|titan_tod
suffix:semicolon
id|tb0
op_assign
id|get_tb
c_func
(paren
)paren
suffix:semicolon
id|titan_tod
op_assign
id|HvCallXm_loadTod
c_func
(paren
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Titan&bslash;n&quot;
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;  time base =          %016lx&bslash;n&quot;
comma
id|tb0
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;  titan tod =          %016lx&bslash;n&quot;
comma
id|titan_tod
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;  xProcFreq =          %016x&bslash;n&quot;
comma
id|xIoHriProcessorVpd
(braket
l_int|0
)braket
dot
id|xProcFreq
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;  xTimeBaseFreq =      %016x&bslash;n&quot;
comma
id|xIoHriProcessorVpd
(braket
l_int|0
)braket
dot
id|xTimeBaseFreq
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;  tb_ticks_per_jiffy = %lu&bslash;n&quot;
comma
id|tb_ticks_per_jiffy
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;  tb_ticks_per_usec  = %lu&bslash;n&quot;
comma
id|tb_ticks_per_usec
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|startTitan
)paren
(brace
id|startTitan
op_assign
id|titan_tod
suffix:semicolon
id|startTb
op_assign
id|tb0
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|titan_usec
op_assign
(paren
id|titan_tod
op_minus
id|startTitan
)paren
op_rshift
l_int|12
suffix:semicolon
r_int
r_int
id|tb_ticks
op_assign
(paren
id|tb0
op_minus
id|startTb
)paren
suffix:semicolon
r_int
r_int
id|titan_jiffies
op_assign
id|titan_usec
op_div
(paren
l_int|1000000
op_div
id|HZ
)paren
suffix:semicolon
r_int
r_int
id|titan_jiff_usec
op_assign
id|titan_jiffies
op_star
(paren
l_int|1000000
op_div
id|HZ
)paren
suffix:semicolon
r_int
r_int
id|titan_jiff_rem_usec
op_assign
id|titan_usec
op_minus
id|titan_jiff_usec
suffix:semicolon
r_int
r_int
id|tb_jiffies
op_assign
id|tb_ticks
op_div
id|tb_ticks_per_jiffy
suffix:semicolon
r_int
r_int
id|tb_jiff_ticks
op_assign
id|tb_jiffies
op_star
id|tb_ticks_per_jiffy
suffix:semicolon
r_int
r_int
id|tb_jiff_rem_ticks
op_assign
id|tb_ticks
op_minus
id|tb_jiff_ticks
suffix:semicolon
r_int
r_int
id|tb_jiff_rem_usec
op_assign
id|tb_jiff_rem_ticks
op_div
id|tb_ticks_per_usec
suffix:semicolon
r_int
r_int
id|new_tb_ticks_per_jiffy
op_assign
(paren
id|tb_ticks
op_star
(paren
l_int|1000000
op_div
id|HZ
)paren
)paren
op_div
id|titan_usec
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;  titan elapsed = %lu uSec&bslash;n&quot;
comma
id|titan_usec
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;  tb elapsed    = %lu ticks&bslash;n&quot;
comma
id|tb_ticks
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;  titan jiffies = %lu.%04lu &bslash;n&quot;
comma
id|titan_jiffies
comma
id|titan_jiff_rem_usec
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;  tb jiffies    = %lu.%04lu&bslash;n&quot;
comma
id|tb_jiffies
comma
id|tb_jiff_rem_usec
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;  new tb_ticks_per_jiffy = %lu&bslash;n&quot;
comma
id|new_tb_ticks_per_jiffy
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|proc_titantod_open
r_static
r_int
id|proc_titantod_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|single_open
c_func
(paren
id|file
comma
id|proc_titantod_show
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|proc_titantod_operations
r_static
r_struct
id|file_operations
id|proc_titantod_operations
op_assign
(brace
dot
id|open
op_assign
id|proc_titantod_open
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|release
op_assign
id|single_release
comma
)brace
suffix:semicolon
DECL|function|iseries_proc_init
r_static
r_int
id|__init
id|iseries_proc_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|e
suffix:semicolon
id|e
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;iSeries/lpevents&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|e
)paren
id|e-&gt;proc_fops
op_assign
op_amp
id|proc_lpevents_operations
suffix:semicolon
id|e
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;iSeries/titanTod&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|e
)paren
id|e-&gt;proc_fops
op_assign
op_amp
id|proc_titantod_operations
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|iseries_proc_init
id|__initcall
c_func
(paren
id|iseries_proc_init
)paren
suffix:semicolon
eof
