multiline_comment|/*&n; * SMP support for power macintosh.&n; *&n; * We support both the old &quot;powersurge&quot; SMP architecture&n; * and the current Core99 (G4 PowerMac) machines.&n; *&n; * Note that we don&squot;t support the very first rev. of&n; * Apple/DayStar 2 CPUs board, the one with the funky&n; * watchdog. Hopefully, none of these should be there except&n; * maybe internally to Apple. I should probably still add some&n; * code to detect this card though and disable SMP. --BenH.&n; *&n; * Support Macintosh G4 SMP by Troy Benjegerdes (hozer@drgw.net)&n; * and Ben Herrenschmidt &lt;benh@kernel.crashing.org&gt;.&n; *&n; * Support for DayStar quad CPU cards&n; * Copyright (C) XLR8, Inc. 1994-2000&n; *&n; *  This program is free software; you can redistribute it and/or&n; *  modify it under the terms of the GNU General Public License&n; *  as published by the Free Software Foundation; either version&n; *  2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/kernel_stat.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
DECL|macro|__KERNEL_SYSCALLS__
mdefine_line|#define __KERNEL_SYSCALLS__
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/hardirq.h&gt;
macro_line|#include &lt;asm/sections.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/smp.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/pmac_feature.h&gt;
macro_line|#include &lt;asm/time.h&gt;
macro_line|#include &lt;asm/cacheflush.h&gt;
macro_line|#include &lt;asm/keylargo.h&gt;
macro_line|#include &quot;open_pic.h&quot;
r_extern
r_void
id|pmac_secondary_start_1
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|pmac_secondary_start_2
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|pmac_secondary_start_3
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|smp_openpic_message_pass
c_func
(paren
r_int
id|target
comma
r_int
id|msg
)paren
suffix:semicolon
r_extern
r_struct
id|smp_ops_t
op_star
id|smp_ops
suffix:semicolon
DECL|function|smp_core99_probe
r_static
r_int
id|__init
id|smp_core99_probe
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|cpus
suffix:semicolon
r_int
id|ncpus
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Maybe use systemconfiguration here ? */
r_if
c_cond
(paren
id|ppc_md.progress
)paren
id|ppc_md
dot
id|progress
c_func
(paren
l_string|&quot;smp_core99_probe&quot;
comma
l_int|0x345
)paren
suffix:semicolon
id|cpus
op_assign
id|find_type_devices
c_func
(paren
l_string|&quot;cpu&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpus
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|cpus
op_assign
id|cpus-&gt;next
)paren
op_ne
l_int|NULL
)paren
op_increment
id|ncpus
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PowerMac SMP probe found %d cpus&bslash;n&quot;
comma
id|ncpus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ncpus
OG
l_int|1
)paren
id|openpic_request_IPIs
c_func
(paren
)paren
suffix:semicolon
r_return
id|ncpus
suffix:semicolon
)brace
DECL|function|smp_core99_kick_cpu
r_static
r_void
id|__init
id|smp_core99_kick_cpu
c_func
(paren
r_int
id|nr
)paren
(brace
r_int
id|save_vector
suffix:semicolon
r_int
r_int
id|new_vector
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_volatile
r_int
r_int
op_star
id|vector
op_assign
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
(paren
id|KERNELBASE
op_plus
l_int|0x100
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nr
template_param
l_int|3
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|ppc_md.progress
)paren
id|ppc_md
dot
id|progress
c_func
(paren
l_string|&quot;smp_core99_kick_cpu&quot;
comma
l_int|0x346
)paren
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Save reset vector */
id|save_vector
op_assign
op_star
id|vector
suffix:semicolon
multiline_comment|/* Setup fake reset vector that does&t;&n;&t; *   b .pmac_secondary_start - KERNELBASE&n;&t; */
r_switch
c_cond
(paren
id|nr
)paren
(brace
r_case
l_int|1
suffix:colon
id|new_vector
op_assign
(paren
r_int
r_int
)paren
id|pmac_secondary_start_1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|new_vector
op_assign
(paren
r_int
r_int
)paren
id|pmac_secondary_start_2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|new_vector
op_assign
(paren
r_int
r_int
)paren
id|pmac_secondary_start_3
suffix:semicolon
r_break
suffix:semicolon
)brace
op_star
id|vector
op_assign
l_int|0x48000002
op_plus
(paren
id|new_vector
op_minus
id|KERNELBASE
)paren
suffix:semicolon
multiline_comment|/* flush data cache and inval instruction cache */
id|flush_icache_range
c_func
(paren
(paren
r_int
r_int
)paren
id|vector
comma
(paren
r_int
r_int
)paren
id|vector
op_plus
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Put some life in our friend */
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_RESET_CPU
comma
l_int|NULL
comma
id|nr
comma
l_int|0
)paren
suffix:semicolon
id|paca
(braket
id|nr
)braket
dot
id|xProcStart
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* FIXME: We wait a bit for the CPU to take the exception, I should&n;&t; * instead wait for the entry code to set something for me. Well,&n;&t; * ideally, all that crap will be done in prom.c and the CPU left&n;&t; * in a RAM-based wait loop like CHRP.&n;&t; */
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Restore our exception vector */
op_star
id|vector
op_assign
id|save_vector
suffix:semicolon
id|flush_icache_range
c_func
(paren
(paren
r_int
r_int
)paren
id|vector
comma
(paren
r_int
r_int
)paren
id|vector
op_plus
l_int|4
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppc_md.progress
)paren
id|ppc_md
dot
id|progress
c_func
(paren
l_string|&quot;smp_core99_kick_cpu done&quot;
comma
l_int|0x347
)paren
suffix:semicolon
)brace
DECL|function|smp_core99_setup_cpu
r_static
r_void
id|__init
id|smp_core99_setup_cpu
c_func
(paren
r_int
id|cpu_nr
)paren
(brace
multiline_comment|/* Setup openpic */
id|do_openpic_setup_cpu
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpu_nr
op_eq
l_int|0
)paren
(brace
r_extern
r_void
id|g5_phy_disable_cpu1
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* If we didn&squot;t start the second CPU, we must take&n;&t;&t; * it off the bus&n;&t;&t; */
r_if
c_cond
(paren
id|num_online_cpus
c_func
(paren
)paren
OL
l_int|2
)paren
id|g5_phy_disable_cpu1
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppc_md.progress
)paren
id|ppc_md
dot
id|progress
c_func
(paren
l_string|&quot;core99_setup_cpu 0 done&quot;
comma
l_int|0x349
)paren
suffix:semicolon
)brace
)brace
r_extern
r_void
id|smp_generic_give_timebase
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|smp_generic_take_timebase
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|variable|__pmacdata
r_struct
id|smp_ops_t
id|core99_smp_ops
id|__pmacdata
op_assign
(brace
dot
id|message_pass
op_assign
id|smp_openpic_message_pass
comma
dot
id|probe
op_assign
id|smp_core99_probe
comma
dot
id|kick_cpu
op_assign
id|smp_core99_kick_cpu
comma
dot
id|setup_cpu
op_assign
id|smp_core99_setup_cpu
comma
dot
id|give_timebase
op_assign
id|smp_generic_give_timebase
comma
dot
id|take_timebase
op_assign
id|smp_generic_take_timebase
comma
)brace
suffix:semicolon
DECL|function|pmac_setup_smp
r_void
id|__init
id|pmac_setup_smp
c_func
(paren
r_void
)paren
(brace
id|smp_ops
op_assign
op_amp
id|core99_smp_ops
suffix:semicolon
)brace
eof
