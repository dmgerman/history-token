multiline_comment|/*&n; *  linux/arch/m68knommu/kernel/traps.c&n; *&n; *  Copyright (C) 1993, 1994 by Hamish Macdonald&n; *&n; *  68040 fixes by Michael Rausch&n; *  68040 fixes by Martin Apel&n; *  68060 fixes by Roman Hodek&n; *  68060 fixes by Jesper Skov&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file COPYING in the main directory of this archive&n; * for more details.&n; */
multiline_comment|/*&n; * Sets up all exception vectors&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/a.out.h&gt;
macro_line|#include &lt;linux/user.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/linkage.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/setup.h&gt;
macro_line|#include &lt;asm/fpu.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/traps.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/siginfo.h&gt;
DECL|variable|vec_names
r_static
r_char
op_star
id|vec_names
(braket
)braket
op_assign
(brace
l_string|&quot;RESET SP&quot;
comma
l_string|&quot;RESET PC&quot;
comma
l_string|&quot;BUS ERROR&quot;
comma
l_string|&quot;ADDRESS ERROR&quot;
comma
l_string|&quot;ILLEGAL INSTRUCTION&quot;
comma
l_string|&quot;ZERO DIVIDE&quot;
comma
l_string|&quot;CHK&quot;
comma
l_string|&quot;TRAPcc&quot;
comma
l_string|&quot;PRIVILEGE VIOLATION&quot;
comma
l_string|&quot;TRACE&quot;
comma
l_string|&quot;LINE 1010&quot;
comma
l_string|&quot;LINE 1111&quot;
comma
l_string|&quot;UNASSIGNED RESERVED 12&quot;
comma
l_string|&quot;COPROCESSOR PROTOCOL VIOLATION&quot;
comma
l_string|&quot;FORMAT ERROR&quot;
comma
l_string|&quot;UNINITIALIZED INTERRUPT&quot;
comma
l_string|&quot;UNASSIGNED RESERVED 16&quot;
comma
l_string|&quot;UNASSIGNED RESERVED 17&quot;
comma
l_string|&quot;UNASSIGNED RESERVED 18&quot;
comma
l_string|&quot;UNASSIGNED RESERVED 19&quot;
comma
l_string|&quot;UNASSIGNED RESERVED 20&quot;
comma
l_string|&quot;UNASSIGNED RESERVED 21&quot;
comma
l_string|&quot;UNASSIGNED RESERVED 22&quot;
comma
l_string|&quot;UNASSIGNED RESERVED 23&quot;
comma
l_string|&quot;SPURIOUS INTERRUPT&quot;
comma
l_string|&quot;LEVEL 1 INT&quot;
comma
l_string|&quot;LEVEL 2 INT&quot;
comma
l_string|&quot;LEVEL 3 INT&quot;
comma
l_string|&quot;LEVEL 4 INT&quot;
comma
l_string|&quot;LEVEL 5 INT&quot;
comma
l_string|&quot;LEVEL 6 INT&quot;
comma
l_string|&quot;LEVEL 7 INT&quot;
comma
l_string|&quot;SYSCALL&quot;
comma
l_string|&quot;TRAP #1&quot;
comma
l_string|&quot;TRAP #2&quot;
comma
l_string|&quot;TRAP #3&quot;
comma
l_string|&quot;TRAP #4&quot;
comma
l_string|&quot;TRAP #5&quot;
comma
l_string|&quot;TRAP #6&quot;
comma
l_string|&quot;TRAP #7&quot;
comma
l_string|&quot;TRAP #8&quot;
comma
l_string|&quot;TRAP #9&quot;
comma
l_string|&quot;TRAP #10&quot;
comma
l_string|&quot;TRAP #11&quot;
comma
l_string|&quot;TRAP #12&quot;
comma
l_string|&quot;TRAP #13&quot;
comma
l_string|&quot;TRAP #14&quot;
comma
l_string|&quot;TRAP #15&quot;
comma
l_string|&quot;FPCP BSUN&quot;
comma
l_string|&quot;FPCP INEXACT&quot;
comma
l_string|&quot;FPCP DIV BY 0&quot;
comma
l_string|&quot;FPCP UNDERFLOW&quot;
comma
l_string|&quot;FPCP OPERAND ERROR&quot;
comma
l_string|&quot;FPCP OVERFLOW&quot;
comma
l_string|&quot;FPCP SNAN&quot;
comma
l_string|&quot;FPCP UNSUPPORTED OPERATION&quot;
comma
l_string|&quot;MMU CONFIGURATION ERROR&quot;
)brace
suffix:semicolon
DECL|function|trap_init
r_void
id|__init
id|trap_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|mach_trap_init
)paren
id|mach_trap_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|die_if_kernel
r_void
id|die_if_kernel
c_func
(paren
r_char
op_star
id|str
comma
r_struct
id|pt_regs
op_star
id|fp
comma
r_int
id|nr
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|fp-&gt;sr
op_amp
id|PS_S
)paren
)paren
r_return
suffix:semicolon
id|console_verbose
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: %08x&bslash;n&quot;
comma
id|str
comma
id|nr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PC: [&lt;%08lx&gt;]&bslash;nSR: %04x  SP: %p  a2: %08lx&bslash;n&quot;
comma
id|fp-&gt;pc
comma
id|fp-&gt;sr
comma
id|fp
comma
id|fp-&gt;a2
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;d0: %08lx    d1: %08lx    d2: %08lx    d3: %08lx&bslash;n&quot;
comma
id|fp-&gt;d0
comma
id|fp-&gt;d1
comma
id|fp-&gt;d2
comma
id|fp-&gt;d3
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;d4: %08lx    d5: %08lx    a0: %08lx    a1: %08lx&bslash;n&quot;
comma
id|fp-&gt;d4
comma
id|fp-&gt;d5
comma
id|fp-&gt;a0
comma
id|fp-&gt;a1
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Process %s (pid: %d, stackpage=%08lx)&bslash;n&quot;
comma
id|current-&gt;comm
comma
id|current-&gt;pid
comma
id|PAGE_SIZE
op_plus
(paren
r_int
r_int
)paren
id|current
)paren
suffix:semicolon
id|show_stack
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|fp
)paren
suffix:semicolon
id|do_exit
c_func
(paren
id|SIGSEGV
)paren
suffix:semicolon
)brace
DECL|function|buserr_c
id|asmlinkage
r_void
id|buserr_c
c_func
(paren
r_struct
id|frame
op_star
id|fp
)paren
(brace
multiline_comment|/* Only set esp0 if coming from user mode */
r_if
c_cond
(paren
id|user_mode
c_func
(paren
op_amp
id|fp-&gt;ptregs
)paren
)paren
id|current-&gt;thread.esp0
op_assign
(paren
r_int
r_int
)paren
id|fp
suffix:semicolon
macro_line|#if DEBUG
id|printk
(paren
l_string|&quot;*** Bus Error *** Format is %x&bslash;n&quot;
comma
id|fp-&gt;ptregs.format
)paren
suffix:semicolon
macro_line|#endif
id|die_if_kernel
c_func
(paren
l_string|&quot;bad frame format&quot;
comma
op_amp
id|fp-&gt;ptregs
comma
l_int|0
)paren
suffix:semicolon
macro_line|#if DEBUG
id|printk
c_func
(paren
l_string|&quot;Unknown SIGSEGV - 4&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|force_sig
c_func
(paren
id|SIGSEGV
comma
id|current
)paren
suffix:semicolon
)brace
DECL|variable|kstack_depth_to_print
r_int
id|kstack_depth_to_print
op_assign
l_int|48
suffix:semicolon
DECL|function|show_stack
r_void
id|show_stack
c_func
(paren
r_int
r_int
op_star
id|esp
)paren
(brace
r_int
r_int
op_star
id|stack
comma
op_star
id|endstack
comma
id|addr
suffix:semicolon
r_extern
r_char
id|_start
comma
id|_etext
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|esp
op_eq
l_int|NULL
)paren
id|esp
op_assign
(paren
r_int
r_int
op_star
)paren
op_amp
id|esp
suffix:semicolon
id|stack
op_assign
id|esp
suffix:semicolon
id|addr
op_assign
(paren
r_int
r_int
)paren
id|esp
suffix:semicolon
id|endstack
op_assign
(paren
r_int
r_int
op_star
)paren
id|PAGE_ALIGN
c_func
(paren
id|addr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Stack from %08lx:&quot;
comma
(paren
r_int
r_int
)paren
id|stack
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|kstack_depth_to_print
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|stack
op_plus
l_int|1
OG
id|endstack
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_mod
l_int|8
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n       &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; %08lx&quot;
comma
op_star
id|stack
op_increment
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;nCall Trace:&quot;
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|stack
op_plus
l_int|1
op_le
id|endstack
)paren
(brace
id|addr
op_assign
op_star
id|stack
op_increment
suffix:semicolon
multiline_comment|/*&n;&t;&t; * If the address is either in the text segment of the&n;&t;&t; * kernel, or in the region which contains vmalloc&squot;ed&n;&t;&t; * memory, it *may* be the address of a calling&n;&t;&t; * routine; if so, print it so that someone tracing&n;&t;&t; * down the cause of the crash will be able to figure&n;&t;&t; * out the call path that was taken.&n;&t;&t; */
r_if
c_cond
(paren
(paren
(paren
id|addr
op_ge
(paren
r_int
r_int
)paren
op_amp
id|_start
)paren
op_logical_and
(paren
id|addr
op_le
(paren
r_int
r_int
)paren
op_amp
id|_etext
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|i
op_mod
l_int|4
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n       &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; [&lt;%08lx&gt;]&quot;
comma
id|addr
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|bad_super_trap
r_void
id|bad_super_trap
c_func
(paren
r_struct
id|frame
op_star
id|fp
)paren
(brace
id|console_verbose
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fp-&gt;ptregs.vector
OL
l_int|4
op_star
r_sizeof
(paren
id|vec_names
)paren
op_div
r_sizeof
(paren
id|vec_names
(braket
l_int|0
)braket
)paren
)paren
id|printk
(paren
l_string|&quot;*** %s ***   FORMAT=%X&bslash;n&quot;
comma
id|vec_names
(braket
(paren
id|fp-&gt;ptregs.vector
)paren
op_rshift
l_int|2
)braket
comma
id|fp-&gt;ptregs.format
)paren
suffix:semicolon
r_else
id|printk
(paren
l_string|&quot;*** Exception %d ***   FORMAT=%X&bslash;n&quot;
comma
(paren
id|fp-&gt;ptregs.vector
)paren
op_rshift
l_int|2
comma
id|fp-&gt;ptregs.format
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;Current process id is %d&bslash;n&quot;
comma
id|current-&gt;pid
)paren
suffix:semicolon
id|die_if_kernel
c_func
(paren
l_string|&quot;BAD KERNEL TRAP&quot;
comma
op_amp
id|fp-&gt;ptregs
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|trap_c
id|asmlinkage
r_void
id|trap_c
c_func
(paren
r_struct
id|frame
op_star
id|fp
)paren
(brace
r_int
id|sig
suffix:semicolon
id|siginfo_t
id|info
suffix:semicolon
r_if
c_cond
(paren
id|fp-&gt;ptregs.sr
op_amp
id|PS_S
)paren
(brace
r_if
c_cond
(paren
(paren
id|fp-&gt;ptregs.vector
op_rshift
l_int|2
)paren
op_eq
id|VEC_TRACE
)paren
(brace
multiline_comment|/* traced a trapping instruction */
id|current-&gt;ptrace
op_or_assign
id|PT_DTRACE
suffix:semicolon
)brace
r_else
id|bad_super_trap
c_func
(paren
id|fp
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* send the appropriate signal to the user program */
r_switch
c_cond
(paren
(paren
id|fp-&gt;ptregs.vector
)paren
op_rshift
l_int|2
)paren
(brace
r_case
id|VEC_ADDRERR
suffix:colon
id|info.si_code
op_assign
id|BUS_ADRALN
suffix:semicolon
id|sig
op_assign
id|SIGBUS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_ILLEGAL
suffix:colon
r_case
id|VEC_LINE10
suffix:colon
r_case
id|VEC_LINE11
suffix:colon
id|info.si_code
op_assign
id|ILL_ILLOPC
suffix:semicolon
id|sig
op_assign
id|SIGILL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_PRIV
suffix:colon
id|info.si_code
op_assign
id|ILL_PRVOPC
suffix:semicolon
id|sig
op_assign
id|SIGILL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_COPROC
suffix:colon
id|info.si_code
op_assign
id|ILL_COPROC
suffix:semicolon
id|sig
op_assign
id|SIGILL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_TRAP1
suffix:colon
multiline_comment|/* gdbserver breakpoint */
id|fp-&gt;ptregs.pc
op_sub_assign
l_int|2
suffix:semicolon
id|info.si_code
op_assign
id|TRAP_TRACE
suffix:semicolon
id|sig
op_assign
id|SIGTRAP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_TRAP2
suffix:colon
r_case
id|VEC_TRAP3
suffix:colon
r_case
id|VEC_TRAP4
suffix:colon
r_case
id|VEC_TRAP5
suffix:colon
r_case
id|VEC_TRAP6
suffix:colon
r_case
id|VEC_TRAP7
suffix:colon
r_case
id|VEC_TRAP8
suffix:colon
r_case
id|VEC_TRAP9
suffix:colon
r_case
id|VEC_TRAP10
suffix:colon
r_case
id|VEC_TRAP11
suffix:colon
r_case
id|VEC_TRAP12
suffix:colon
r_case
id|VEC_TRAP13
suffix:colon
r_case
id|VEC_TRAP14
suffix:colon
id|info.si_code
op_assign
id|ILL_ILLTRP
suffix:semicolon
id|sig
op_assign
id|SIGILL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_FPBRUC
suffix:colon
r_case
id|VEC_FPOE
suffix:colon
r_case
id|VEC_FPNAN
suffix:colon
id|info.si_code
op_assign
id|FPE_FLTINV
suffix:semicolon
id|sig
op_assign
id|SIGFPE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_FPIR
suffix:colon
id|info.si_code
op_assign
id|FPE_FLTRES
suffix:semicolon
id|sig
op_assign
id|SIGFPE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_FPDIVZ
suffix:colon
id|info.si_code
op_assign
id|FPE_FLTDIV
suffix:semicolon
id|sig
op_assign
id|SIGFPE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_FPUNDER
suffix:colon
id|info.si_code
op_assign
id|FPE_FLTUND
suffix:semicolon
id|sig
op_assign
id|SIGFPE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_FPOVER
suffix:colon
id|info.si_code
op_assign
id|FPE_FLTOVF
suffix:semicolon
id|sig
op_assign
id|SIGFPE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_ZERODIV
suffix:colon
id|info.si_code
op_assign
id|FPE_INTDIV
suffix:semicolon
id|sig
op_assign
id|SIGFPE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_CHK
suffix:colon
r_case
id|VEC_TRAP
suffix:colon
id|info.si_code
op_assign
id|FPE_INTOVF
suffix:semicolon
id|sig
op_assign
id|SIGFPE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_TRACE
suffix:colon
multiline_comment|/* ptrace single step */
id|info.si_code
op_assign
id|TRAP_TRACE
suffix:semicolon
id|sig
op_assign
id|SIGTRAP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VEC_TRAP15
suffix:colon
multiline_comment|/* breakpoint */
id|info.si_code
op_assign
id|TRAP_BRKPT
suffix:semicolon
id|sig
op_assign
id|SIGTRAP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|info.si_code
op_assign
id|ILL_ILLOPC
suffix:semicolon
id|sig
op_assign
id|SIGILL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|info.si_signo
op_assign
id|sig
suffix:semicolon
id|info.si_errno
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|fp-&gt;ptregs.format
)paren
(brace
r_default
suffix:colon
id|info.si_addr
op_assign
(paren
r_void
op_star
)paren
id|fp-&gt;ptregs.pc
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|info.si_addr
op_assign
(paren
r_void
op_star
)paren
id|fp-&gt;un.fmt2.iaddr
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|info.si_addr
op_assign
(paren
r_void
op_star
)paren
id|fp-&gt;un.fmt7.effaddr
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9
suffix:colon
id|info.si_addr
op_assign
(paren
r_void
op_star
)paren
id|fp-&gt;un.fmt9.iaddr
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|10
suffix:colon
id|info.si_addr
op_assign
(paren
r_void
op_star
)paren
id|fp-&gt;un.fmta.daddr
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|11
suffix:colon
id|info.si_addr
op_assign
(paren
r_void
op_star
)paren
id|fp-&gt;un.fmtb.daddr
suffix:semicolon
r_break
suffix:semicolon
)brace
id|force_sig_info
(paren
id|sig
comma
op_amp
id|info
comma
id|current
)paren
suffix:semicolon
)brace
DECL|function|set_esp0
id|asmlinkage
r_void
id|set_esp0
c_func
(paren
r_int
r_int
id|ssp
)paren
(brace
id|current-&gt;thread.esp0
op_assign
id|ssp
suffix:semicolon
)brace
DECL|function|show_trace_task
r_void
id|show_trace_task
c_func
(paren
r_struct
id|task_struct
op_star
id|tsk
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STACK ksp=0x%lx, usp=0x%lx&bslash;n&quot;
comma
id|tsk-&gt;thread.ksp
comma
id|tsk-&gt;thread.usp
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_M68KFPU_EMU
DECL|function|fpemu_signal
id|asmlinkage
r_void
id|fpemu_signal
c_func
(paren
r_int
id|signal
comma
r_int
id|code
comma
r_void
op_star
id|addr
)paren
(brace
id|siginfo_t
id|info
suffix:semicolon
id|info.si_signo
op_assign
id|signal
suffix:semicolon
id|info.si_errno
op_assign
l_int|0
suffix:semicolon
id|info.si_code
op_assign
id|code
suffix:semicolon
id|info.si_addr
op_assign
id|addr
suffix:semicolon
id|force_sig_info
c_func
(paren
id|signal
comma
op_amp
id|info
comma
id|current
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
