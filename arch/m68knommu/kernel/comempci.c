multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;comemlite.c -- PCI access code for embedded CO-MEM Lite PCI controller.&n; *&n; *&t;(C) Copyright 1999-2002, Greg Ungerer (gerg@snapgear.com).&n; *&t;(C) Copyright 2000, Lineo (www.lineo.com)&n; */
multiline_comment|/*****************************************************************************/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/coldfire.h&gt;
macro_line|#include &lt;asm/mcfsim.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/anchor.h&gt;
macro_line|#ifdef CONFIG_eLIA
macro_line|#include &lt;asm/elia.h&gt;
macro_line|#endif
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Debug configuration defines. DEBUGRES sets debugging output for&n; *&t;the resource allocation phase. DEBUGPCI traces on pcibios_ function&n; *&t;calls, and DEBUGIO traces all accesses to devices on the PCI bus.&n; */
multiline_comment|/*#define&t;DEBUGRES&t;1*/
multiline_comment|/*#define&t;DEBUGPCI&t;1*/
multiline_comment|/*#define&t;DEBUGIO&t;&t;1*/
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;PCI markers for bus present and active slots.&n; */
DECL|variable|pci_bus_is_present
r_int
id|pci_bus_is_present
op_assign
l_int|0
suffix:semicolon
DECL|variable|pci_slotmask
r_int
r_int
id|pci_slotmask
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; *&t;We may or may not need to swap the bytes of PCI bus tranfers.&n; *&t;The endianess is re-roder automatically by the CO-MEM, but it&n; *&t;will get the wrong byte order for a pure data stream.&n; */
DECL|macro|pci_byteswap
mdefine_line|#define&t;pci_byteswap&t;0
multiline_comment|/*&n; *&t;Resource tracking. The CO-MEM part creates a virtual address&n; *&t;space that all the PCI devices live in - it is not in any way&n; *&t;directly mapped into the ColdFire address space. So we can&n; *&t;really assign any resources we like to devices, as long as&n; *&t;they do not clash with other PCI devices.&n; */
DECL|variable|pci_iobase
r_int
r_int
id|pci_iobase
op_assign
l_int|0x100
suffix:semicolon
multiline_comment|/* Arbitary start address */
DECL|variable|pci_membase
r_int
r_int
id|pci_membase
op_assign
l_int|0x00010000
suffix:semicolon
multiline_comment|/* Arbitary start address */
DECL|macro|PCI_MINIO
mdefine_line|#define&t;PCI_MINIO&t;0x100&t;&t;&t;/* 256 byte minimum I/O */
DECL|macro|PCI_MINMEM
mdefine_line|#define&t;PCI_MINMEM&t;0x00010000&t;&t;/* 64k minimum chunk */
multiline_comment|/*&n; *&t;The CO-MEM&squot;s shared memory segment is visible inside the PCI&n; *&t;memory address space. We need to keep track of the address that&n; *&t;this is mapped at, to setup the bus masters pointers.&n; */
DECL|variable|pci_shmemaddr
r_int
r_int
id|pci_shmemaddr
suffix:semicolon
multiline_comment|/*****************************************************************************/
r_void
id|pci_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|id
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
suffix:semicolon
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Some platforms have custom ways of reseting the PCI bus.&n; */
DECL|function|pci_resetbus
r_void
id|pci_resetbus
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_eLIA
r_int
id|i
suffix:semicolon
macro_line|#ifdef DEBUGPCI
id|printk
c_func
(paren
l_string|&quot;pci_resetbus()&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
op_star
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
(paren
id|MCF_MBAR
op_plus
id|MCFSIM_PADDR
)paren
)paren
op_or_assign
id|eLIA_PCIRESET
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
l_int|1000
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
(paren
id|MCF_MBAR
op_plus
id|MCFSIM_PADAT
)paren
)paren
op_assign
(paren
id|ppdata
op_or
id|eLIA_PCIRESET
)paren
suffix:semicolon
)brace
op_star
(paren
(paren
r_volatile
r_int
r_int
op_star
)paren
(paren
id|MCF_MBAR
op_plus
id|MCFSIM_PADAT
)paren
)paren
op_assign
id|ppdata
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pcibios_assignres
r_int
id|pcibios_assignres
c_func
(paren
r_int
id|slot
)paren
(brace
r_volatile
r_int
r_int
op_star
id|rp
suffix:semicolon
r_volatile
r_int
r_char
op_star
id|ip
suffix:semicolon
r_int
r_int
id|idsel
comma
id|addr
comma
id|val
comma
id|align
comma
id|i
suffix:semicolon
r_int
id|bar
suffix:semicolon
macro_line|#ifdef DEBUGPCI
id|printk
c_func
(paren
l_string|&quot;pcibios_assignres(slot=%x)&bslash;n&quot;
comma
id|slot
)paren
suffix:semicolon
macro_line|#endif
id|rp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|idsel
op_assign
id|COMEM_DA_ADDR
c_func
(paren
l_int|0x1
op_lshift
(paren
id|slot
op_plus
l_int|16
)paren
)paren
suffix:semicolon
multiline_comment|/* Try to assign resource to each BAR */
r_for
c_loop
(paren
id|bar
op_assign
l_int|0
suffix:semicolon
(paren
id|bar
OL
l_int|6
)paren
suffix:semicolon
id|bar
op_increment
)paren
(brace
id|addr
op_assign
id|COMEM_PCIBUS
op_plus
id|PCI_BASE_ADDRESS_0
op_plus
(paren
id|bar
op_star
l_int|4
)paren
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|COMEM_DA_CFGRD
op_or
id|idsel
suffix:semicolon
id|val
op_assign
id|rp
(braket
id|LREG
c_func
(paren
id|addr
)paren
)braket
suffix:semicolon
macro_line|#ifdef DEBUGRES
id|printk
c_func
(paren
l_string|&quot;-----------------------------------&quot;
l_string|&quot;-------------------------------------&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;BAR[%d]: read=%08x &quot;
comma
id|bar
comma
id|val
)paren
suffix:semicolon
macro_line|#endif
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|COMEM_DA_CFGWR
op_or
id|idsel
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|addr
)paren
)braket
op_assign
l_int|0xffffffff
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|COMEM_DA_CFGRD
op_or
id|idsel
suffix:semicolon
id|val
op_assign
id|rp
(braket
id|LREG
c_func
(paren
id|addr
)paren
)braket
suffix:semicolon
macro_line|#ifdef DEBUGRES
id|printk
c_func
(paren
l_string|&quot;write=%08x &quot;
comma
id|val
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|val
op_eq
l_int|0
)paren
(brace
macro_line|#ifdef DEBUGRES
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_continue
suffix:semicolon
)brace
multiline_comment|/* Determine space required by BAR */
multiline_comment|/* FIXME: this should go backwords from 0x80000000... */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
l_int|32
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
l_int|0x1
op_lshift
id|i
)paren
op_amp
(paren
id|val
op_amp
l_int|0xfffffffc
)paren
)paren
r_break
suffix:semicolon
)brace
macro_line|#ifdef DEBUGRES
id|printk
c_func
(paren
l_string|&quot;size=%08x(%d)&bslash;n&quot;
comma
(paren
l_int|0x1
op_lshift
id|i
)paren
comma
id|i
)paren
suffix:semicolon
macro_line|#endif
id|i
op_assign
l_int|0x1
op_lshift
id|i
suffix:semicolon
multiline_comment|/* Assign a resource */
r_if
c_cond
(paren
id|val
op_amp
id|PCI_BASE_ADDRESS_SPACE_IO
)paren
(brace
r_if
c_cond
(paren
id|i
OL
id|PCI_MINIO
)paren
id|i
op_assign
id|PCI_MINIO
suffix:semicolon
macro_line|#ifdef DEBUGRES
id|printk
c_func
(paren
l_string|&quot;BAR[%d]: IO size=%08x iobase=%08x&bslash;n&quot;
comma
id|bar
comma
id|i
comma
id|pci_iobase
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|i
OG
l_int|0xffff
)paren
(brace
multiline_comment|/* Invalid size?? */
id|val
op_assign
l_int|0
op_or
id|PCI_BASE_ADDRESS_SPACE_IO
suffix:semicolon
macro_line|#ifdef DEBUGRES
id|printk
c_func
(paren
l_string|&quot;BAR[%d]: too big for IO??&bslash;n&quot;
comma
id|bar
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
multiline_comment|/* Check for un-alignment */
r_if
c_cond
(paren
(paren
id|align
op_assign
id|pci_iobase
op_mod
id|i
)paren
)paren
id|pci_iobase
op_add_assign
(paren
id|i
op_minus
id|align
)paren
suffix:semicolon
id|val
op_assign
id|pci_iobase
op_or
id|PCI_BASE_ADDRESS_SPACE_IO
suffix:semicolon
id|pci_iobase
op_add_assign
id|i
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|i
OL
id|PCI_MINMEM
)paren
id|i
op_assign
id|PCI_MINMEM
suffix:semicolon
macro_line|#ifdef DEBUGRES
id|printk
c_func
(paren
l_string|&quot;BAR[%d]: MEMORY size=%08x membase=%08x&bslash;n&quot;
comma
id|bar
comma
id|i
comma
id|pci_membase
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Check for un-alignment */
r_if
c_cond
(paren
(paren
id|align
op_assign
id|pci_membase
op_mod
id|i
)paren
)paren
id|pci_membase
op_add_assign
(paren
id|i
op_minus
id|align
)paren
suffix:semicolon
id|val
op_assign
id|pci_membase
op_or
id|PCI_BASE_ADDRESS_SPACE_MEMORY
suffix:semicolon
id|pci_membase
op_add_assign
id|i
suffix:semicolon
)brace
multiline_comment|/* Write resource back into BAR register */
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|COMEM_DA_CFGWR
op_or
id|idsel
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|addr
)paren
)braket
op_assign
id|val
suffix:semicolon
macro_line|#ifdef DEBUGRES
id|printk
c_func
(paren
l_string|&quot;BAR[%d]: assigned bar=%08x&bslash;n&quot;
comma
id|bar
comma
id|val
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#ifdef DEBUGRES
id|printk
c_func
(paren
l_string|&quot;-----------------------------------&quot;
l_string|&quot;-------------------------------------&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Assign IRQ if one is wanted... */
id|ip
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
(paren
id|COMEM_BASE
op_plus
id|COMEM_PCIBUS
)paren
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|COMEM_DA_CFGRD
op_or
id|idsel
suffix:semicolon
id|addr
op_assign
(paren
id|PCI_INTERRUPT_PIN
op_amp
l_int|0xfc
)paren
op_plus
(paren
op_complement
id|PCI_INTERRUPT_PIN
op_amp
l_int|0x03
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip
(braket
id|addr
)braket
)paren
(brace
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|COMEM_DA_CFGWR
op_or
id|idsel
suffix:semicolon
id|addr
op_assign
(paren
id|PCI_INTERRUPT_LINE
op_amp
l_int|0xfc
)paren
op_plus
(paren
op_complement
id|PCI_INTERRUPT_LINE
op_amp
l_int|0x03
)paren
suffix:semicolon
id|ip
(braket
id|addr
)braket
op_assign
l_int|25
suffix:semicolon
macro_line|#ifdef DEBUGRES
id|printk
c_func
(paren
l_string|&quot;IRQ LINE=25&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pcibios_enable
r_int
id|pcibios_enable
c_func
(paren
r_int
id|slot
)paren
(brace
r_volatile
r_int
r_int
op_star
id|rp
suffix:semicolon
r_volatile
r_int
r_int
op_star
id|wp
suffix:semicolon
r_int
r_int
id|idsel
comma
id|addr
suffix:semicolon
r_int
r_int
id|cmd
suffix:semicolon
macro_line|#ifdef DEBUGPCI
id|printk
c_func
(paren
l_string|&quot;pcibios_enbale(slot=%x)&bslash;n&quot;
comma
id|slot
)paren
suffix:semicolon
macro_line|#endif
id|rp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|wp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|idsel
op_assign
id|COMEM_DA_ADDR
c_func
(paren
l_int|0x1
op_lshift
(paren
id|slot
op_plus
l_int|16
)paren
)paren
suffix:semicolon
multiline_comment|/* Get current command settings */
id|addr
op_assign
id|COMEM_PCIBUS
op_plus
id|PCI_COMMAND
suffix:semicolon
id|addr
op_assign
(paren
id|addr
op_amp
op_complement
l_int|0x3
)paren
op_plus
(paren
op_complement
id|addr
op_amp
l_int|0x02
)paren
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|COMEM_DA_CFGRD
op_or
id|idsel
suffix:semicolon
id|cmd
op_assign
id|wp
(braket
id|WREG
c_func
(paren
id|addr
)paren
)braket
suffix:semicolon
multiline_comment|/*val = ((val &amp; 0xff) &lt;&lt; 8) | ((val &gt;&gt; 8) &amp; 0xff);*/
multiline_comment|/* Enable I/O and memory accesses to this device */
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|COMEM_DA_CFGWR
op_or
id|idsel
suffix:semicolon
id|cmd
op_or_assign
id|PCI_COMMAND_IO
op_or
id|PCI_COMMAND_MEMORY
op_or
id|PCI_COMMAND_MASTER
suffix:semicolon
id|wp
(braket
id|WREG
c_func
(paren
id|addr
)paren
)braket
op_assign
id|cmd
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pcibios_init
r_int
r_int
id|pcibios_init
c_func
(paren
r_int
r_int
id|mem_start
comma
r_int
r_int
id|mem_end
)paren
(brace
r_volatile
r_int
r_int
op_star
id|rp
suffix:semicolon
r_int
r_int
id|sel
comma
id|id
suffix:semicolon
r_int
id|slot
suffix:semicolon
macro_line|#ifdef DEBUGPCI
id|printk
c_func
(paren
l_string|&quot;pcibios_init()&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|pci_resetbus
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Do some sort of basic check to see if the CO-MEM part&n;&t; *&t;is present... This works ok, but I think we really need&n;&t; *&t;something better...&n;&t; */
id|rp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_LBUSCFG
)paren
)braket
op_amp
l_int|0xff
)paren
op_ne
l_int|0x50
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: no PCI bus present&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|mem_start
suffix:semicolon
)brace
macro_line|#ifdef COMEM_BRIDGEDEV
multiline_comment|/*&n;&t; *&t;Setup the PCI bridge device first. It needs resources too,&n;&t; *&t;so that bus masters can get to its shared memory.&n;&t; */
id|slot
op_assign
id|COMEM_BRIDGEDEV
suffix:semicolon
id|sel
op_assign
id|COMEM_DA_CFGRD
op_or
id|COMEM_DA_ADDR
c_func
(paren
l_int|0x1
op_lshift
(paren
id|slot
op_plus
l_int|16
)paren
)paren
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|sel
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_PCIBUS
)paren
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear bus */
id|id
op_assign
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_PCIBUS
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|id
op_eq
l_int|0
)paren
op_logical_or
(paren
(paren
id|id
op_amp
l_int|0xffff0000
)paren
op_eq
(paren
id|sel
op_amp
l_int|0xffff0000
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: no PCI bus bridge present&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|mem_start
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;PCI: bridge device at slot=%d id=%08x&bslash;n&quot;
comma
id|slot
comma
(paren
r_int
)paren
id|id
)paren
suffix:semicolon
id|pci_slotmask
op_or_assign
l_int|0x1
op_lshift
id|slot
suffix:semicolon
id|pci_shmemaddr
op_assign
id|pci_membase
suffix:semicolon
id|pcibios_assignres
c_func
(paren
id|slot
)paren
suffix:semicolon
id|pcibios_enable
c_func
(paren
id|slot
)paren
suffix:semicolon
macro_line|#endif
id|pci_bus_is_present
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Do a quick scan of the PCI bus and see what is here.&n;&t; */
r_for
c_loop
(paren
id|slot
op_assign
id|COMEM_MINDEV
suffix:semicolon
(paren
id|slot
op_le
id|COMEM_MAXDEV
)paren
suffix:semicolon
id|slot
op_increment
)paren
(brace
id|sel
op_assign
id|COMEM_DA_CFGRD
op_or
id|COMEM_DA_ADDR
c_func
(paren
l_int|0x1
op_lshift
(paren
id|slot
op_plus
l_int|16
)paren
)paren
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|sel
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_PCIBUS
)paren
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear bus */
id|id
op_assign
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_PCIBUS
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|id
op_ne
l_int|0
)paren
op_logical_and
(paren
(paren
id|id
op_amp
l_int|0xffff0000
)paren
op_ne
(paren
id|sel
op_amp
l_int|0xffff0000
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: slot=%d id=%08x&bslash;n&quot;
comma
id|slot
comma
(paren
r_int
)paren
id|id
)paren
suffix:semicolon
id|pci_slotmask
op_or_assign
l_int|0x1
op_lshift
id|slot
suffix:semicolon
id|pcibios_assignres
c_func
(paren
id|slot
)paren
suffix:semicolon
id|pcibios_enable
c_func
(paren
id|slot
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Get PCI irq for local vectoring */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|COMEM_IRQ
comma
id|pci_interrupt
comma
l_int|0
comma
l_string|&quot;PCI bridge&quot;
comma
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: failed to acquire interrupt %d&bslash;n&quot;
comma
id|COMEM_IRQ
)paren
suffix:semicolon
)brace
r_else
(brace
id|mcf_autovector
c_func
(paren
id|COMEM_IRQ
)paren
suffix:semicolon
)brace
r_return
id|mem_start
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pcibios_fixup
r_int
r_int
id|pcibios_fixup
c_func
(paren
r_int
r_int
id|mem_start
comma
r_int
r_int
id|mem_end
)paren
(brace
r_return
id|mem_start
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pcibios_present
r_int
id|pcibios_present
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_bus_is_present
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pcibios_read_config_dword
r_int
id|pcibios_read_config_dword
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev
comma
r_int
r_char
id|offset
comma
r_int
r_int
op_star
id|val
)paren
(brace
r_volatile
r_int
r_int
op_star
id|rp
suffix:semicolon
r_int
r_int
id|idsel
comma
id|fnsel
suffix:semicolon
macro_line|#ifdef DEBUGPCI
id|printk
c_func
(paren
l_string|&quot;pcibios_read_config_dword(bus=%x,dev=%x,offset=%x,val=%x)&bslash;n&quot;
comma
id|bus
comma
id|dev
comma
id|offset
comma
id|val
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|bus
op_logical_or
(paren
(paren
id|pci_slotmask
op_amp
(paren
l_int|0x1
op_lshift
id|PCI_SLOT
c_func
(paren
id|dev
)paren
)paren
)paren
op_eq
l_int|0
)paren
)paren
(brace
op_star
id|val
op_assign
l_int|0xffffffff
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
id|rp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|idsel
op_assign
id|COMEM_DA_CFGRD
op_or
id|COMEM_DA_ADDR
c_func
(paren
l_int|0x1
op_lshift
(paren
(paren
id|dev
op_rshift
l_int|3
)paren
op_plus
l_int|16
)paren
)paren
suffix:semicolon
id|fnsel
op_assign
(paren
id|dev
op_amp
l_int|0x7
)paren
op_lshift
l_int|8
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|idsel
suffix:semicolon
op_star
id|val
op_assign
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_PCIBUS
op_plus
(paren
id|offset
op_amp
l_int|0xfc
)paren
op_plus
id|fnsel
)paren
)braket
suffix:semicolon
macro_line|#if 1
multiline_comment|/* If we get back what we wrote, then nothing there */
multiline_comment|/* This is pretty dodgy, but, hey, what else do we do?? */
r_if
c_cond
(paren
op_logical_neg
id|offset
op_logical_and
(paren
op_star
id|val
op_eq
(paren
(paren
id|idsel
op_amp
l_int|0xfffff000
)paren
op_or
(paren
id|offset
op_amp
l_int|0x00000fff
)paren
)paren
)paren
)paren
op_star
id|val
op_assign
l_int|0xffffffff
suffix:semicolon
macro_line|#endif
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pcibios_read_config_word
r_int
id|pcibios_read_config_word
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev
comma
r_int
r_char
id|offset
comma
r_int
r_int
op_star
id|val
)paren
(brace
r_volatile
r_int
r_int
op_star
id|rp
suffix:semicolon
r_volatile
r_int
r_int
op_star
id|bp
suffix:semicolon
r_int
r_int
id|idsel
comma
id|fnsel
suffix:semicolon
r_int
r_char
id|swapoffset
suffix:semicolon
macro_line|#ifdef DEBUGPCI
id|printk
c_func
(paren
l_string|&quot;pcibios_read_config_word(bus=%x,dev=%x,offset=%x)&bslash;n&quot;
comma
id|bus
comma
id|dev
comma
id|offset
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|bus
op_logical_or
(paren
(paren
id|pci_slotmask
op_amp
(paren
l_int|0x1
op_lshift
id|PCI_SLOT
c_func
(paren
id|dev
)paren
)paren
)paren
op_eq
l_int|0
)paren
)paren
(brace
op_star
id|val
op_assign
l_int|0xffff
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
id|rp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|bp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|idsel
op_assign
id|COMEM_DA_CFGRD
op_or
id|COMEM_DA_ADDR
c_func
(paren
l_int|0x1
op_lshift
(paren
(paren
id|dev
op_rshift
l_int|3
)paren
op_plus
l_int|16
)paren
)paren
suffix:semicolon
id|fnsel
op_assign
(paren
id|dev
op_amp
l_int|0x7
)paren
op_lshift
l_int|8
suffix:semicolon
id|swapoffset
op_assign
(paren
id|offset
op_amp
l_int|0xfc
)paren
op_plus
(paren
op_complement
id|offset
op_amp
l_int|0x02
)paren
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|idsel
suffix:semicolon
op_star
id|val
op_assign
id|bp
(braket
id|WREG
c_func
(paren
id|COMEM_PCIBUS
op_plus
id|swapoffset
op_plus
id|fnsel
)paren
)braket
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pcibios_read_config_byte
r_int
id|pcibios_read_config_byte
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev
comma
r_int
r_char
id|offset
comma
r_int
r_char
op_star
id|val
)paren
(brace
r_volatile
r_int
r_int
op_star
id|rp
suffix:semicolon
r_volatile
r_int
r_char
op_star
id|bp
suffix:semicolon
r_int
r_int
id|idsel
comma
id|fnsel
suffix:semicolon
r_int
r_char
id|swapoffset
suffix:semicolon
macro_line|#ifdef DEBUGPCI
id|printk
c_func
(paren
l_string|&quot;pcibios_read_config_byte(bus=%x,dev=%x,offset=%x)&bslash;n&quot;
comma
id|bus
comma
id|dev
comma
id|offset
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|bus
op_logical_or
(paren
(paren
id|pci_slotmask
op_amp
(paren
l_int|0x1
op_lshift
id|PCI_SLOT
c_func
(paren
id|dev
)paren
)paren
)paren
op_eq
l_int|0
)paren
)paren
(brace
op_star
id|val
op_assign
l_int|0xff
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
id|rp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|bp
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|idsel
op_assign
id|COMEM_DA_CFGRD
op_or
id|COMEM_DA_ADDR
c_func
(paren
l_int|0x1
op_lshift
(paren
(paren
id|dev
op_rshift
l_int|3
)paren
op_plus
l_int|16
)paren
)paren
suffix:semicolon
id|fnsel
op_assign
(paren
id|dev
op_amp
l_int|0x7
)paren
op_lshift
l_int|8
suffix:semicolon
id|swapoffset
op_assign
(paren
id|offset
op_amp
l_int|0xfc
)paren
op_plus
(paren
op_complement
id|offset
op_amp
l_int|0x03
)paren
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|idsel
suffix:semicolon
op_star
id|val
op_assign
id|bp
(braket
(paren
id|COMEM_PCIBUS
op_plus
id|swapoffset
op_plus
id|fnsel
)paren
)braket
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pcibios_write_config_dword
r_int
id|pcibios_write_config_dword
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev
comma
r_int
r_char
id|offset
comma
r_int
r_int
id|val
)paren
(brace
r_volatile
r_int
r_int
op_star
id|rp
suffix:semicolon
r_int
r_int
id|idsel
comma
id|fnsel
suffix:semicolon
macro_line|#ifdef DEBUGPCI
id|printk
c_func
(paren
l_string|&quot;pcibios_write_config_dword(bus=%x,dev=%x,offset=%x,val=%x)&bslash;n&quot;
comma
id|bus
comma
id|dev
comma
id|offset
comma
id|val
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|bus
op_logical_or
(paren
(paren
id|pci_slotmask
op_amp
(paren
l_int|0x1
op_lshift
id|PCI_SLOT
c_func
(paren
id|dev
)paren
)paren
)paren
op_eq
l_int|0
)paren
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
id|rp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|idsel
op_assign
id|COMEM_DA_CFGRD
op_or
id|COMEM_DA_ADDR
c_func
(paren
l_int|0x1
op_lshift
(paren
(paren
id|dev
op_rshift
l_int|3
)paren
op_plus
l_int|16
)paren
)paren
suffix:semicolon
id|fnsel
op_assign
(paren
id|dev
op_amp
l_int|0x7
)paren
op_lshift
l_int|8
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|idsel
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_PCIBUS
op_plus
(paren
id|offset
op_amp
l_int|0xfc
)paren
op_plus
id|fnsel
)paren
)braket
op_assign
id|val
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pcibios_write_config_word
r_int
id|pcibios_write_config_word
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev
comma
r_int
r_char
id|offset
comma
r_int
r_int
id|val
)paren
(brace
r_volatile
r_int
r_int
op_star
id|rp
suffix:semicolon
r_volatile
r_int
r_int
op_star
id|bp
suffix:semicolon
r_int
r_int
id|idsel
comma
id|fnsel
suffix:semicolon
r_int
r_char
id|swapoffset
suffix:semicolon
macro_line|#ifdef DEBUGPCI
id|printk
c_func
(paren
l_string|&quot;pcibios_write_config_word(bus=%x,dev=%x,offset=%x,val=%x)&bslash;n&quot;
comma
id|bus
comma
id|dev
comma
id|offset
comma
id|val
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|bus
op_logical_or
(paren
(paren
id|pci_slotmask
op_amp
(paren
l_int|0x1
op_lshift
id|PCI_SLOT
c_func
(paren
id|dev
)paren
)paren
)paren
op_eq
l_int|0
)paren
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
id|rp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|bp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|idsel
op_assign
id|COMEM_DA_CFGRD
op_or
id|COMEM_DA_ADDR
c_func
(paren
l_int|0x1
op_lshift
(paren
(paren
id|dev
op_rshift
l_int|3
)paren
op_plus
l_int|16
)paren
)paren
suffix:semicolon
id|fnsel
op_assign
(paren
id|dev
op_amp
l_int|0x7
)paren
op_lshift
l_int|8
suffix:semicolon
id|swapoffset
op_assign
(paren
id|offset
op_amp
l_int|0xfc
)paren
op_plus
(paren
op_complement
id|offset
op_amp
l_int|0x02
)paren
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|idsel
suffix:semicolon
id|bp
(braket
id|WREG
c_func
(paren
id|COMEM_PCIBUS
op_plus
id|swapoffset
op_plus
id|fnsel
)paren
)braket
op_assign
id|val
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pcibios_write_config_byte
r_int
id|pcibios_write_config_byte
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_char
id|dev
comma
r_int
r_char
id|offset
comma
r_int
r_char
id|val
)paren
(brace
r_volatile
r_int
r_int
op_star
id|rp
suffix:semicolon
r_volatile
r_int
r_char
op_star
id|bp
suffix:semicolon
r_int
r_int
id|idsel
comma
id|fnsel
suffix:semicolon
r_int
r_char
id|swapoffset
suffix:semicolon
macro_line|#ifdef DEBUGPCI
id|printk
c_func
(paren
l_string|&quot;pcibios_write_config_byte(bus=%x,dev=%x,offset=%x,val=%x)&bslash;n&quot;
comma
id|bus
comma
id|dev
comma
id|offset
comma
id|val
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|bus
op_logical_or
(paren
(paren
id|pci_slotmask
op_amp
(paren
l_int|0x1
op_lshift
id|PCI_SLOT
c_func
(paren
id|dev
)paren
)paren
)paren
op_eq
l_int|0
)paren
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
id|rp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|bp
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|idsel
op_assign
id|COMEM_DA_CFGRD
op_or
id|COMEM_DA_ADDR
c_func
(paren
l_int|0x1
op_lshift
(paren
(paren
id|dev
op_rshift
l_int|3
)paren
op_plus
l_int|16
)paren
)paren
suffix:semicolon
id|fnsel
op_assign
(paren
id|dev
op_amp
l_int|0x7
)paren
op_lshift
l_int|8
suffix:semicolon
id|swapoffset
op_assign
(paren
id|offset
op_amp
l_int|0xfc
)paren
op_plus
(paren
op_complement
id|offset
op_amp
l_int|0x03
)paren
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|idsel
suffix:semicolon
id|bp
(braket
(paren
id|COMEM_PCIBUS
op_plus
id|swapoffset
op_plus
id|fnsel
)paren
)braket
op_assign
id|val
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pcibios_find_device
r_int
id|pcibios_find_device
c_func
(paren
r_int
r_int
id|vendor
comma
r_int
r_int
id|devid
comma
r_int
r_int
id|index
comma
r_int
r_char
op_star
id|bus
comma
r_int
r_char
op_star
id|dev
)paren
(brace
r_int
r_int
id|vendev
comma
id|val
suffix:semicolon
r_int
r_char
id|devnr
suffix:semicolon
macro_line|#ifdef DEBUGPCI
id|printk
c_func
(paren
l_string|&quot;pcibios_find_device(vendor=%04x,devid=%04x,index=%d)&bslash;n&quot;
comma
id|vendor
comma
id|devid
comma
id|index
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|vendor
op_eq
l_int|0xffff
)paren
r_return
id|PCIBIOS_BAD_VENDOR_ID
suffix:semicolon
id|vendev
op_assign
(paren
id|devid
op_lshift
l_int|16
)paren
op_or
id|vendor
suffix:semicolon
r_for
c_loop
(paren
id|devnr
op_assign
l_int|0
suffix:semicolon
(paren
id|devnr
OL
l_int|32
)paren
suffix:semicolon
id|devnr
op_increment
)paren
(brace
id|pcibios_read_config_dword
c_func
(paren
l_int|0
comma
id|devnr
comma
id|PCI_VENDOR_ID
comma
op_amp
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vendev
op_eq
id|val
)paren
(brace
r_if
c_cond
(paren
id|index
op_decrement
op_eq
l_int|0
)paren
(brace
op_star
id|bus
op_assign
l_int|0
suffix:semicolon
op_star
id|dev
op_assign
id|devnr
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
)brace
)brace
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pcibios_find_class
r_int
id|pcibios_find_class
c_func
(paren
r_int
r_int
r_class
comma
r_int
r_int
id|index
comma
r_int
r_char
op_star
id|bus
comma
r_int
r_char
op_star
id|dev
)paren
(brace
r_int
r_int
id|val
suffix:semicolon
r_int
r_char
id|devnr
suffix:semicolon
macro_line|#ifdef DEBUGPCI
id|printk
c_func
(paren
l_string|&quot;pcibios_find_class(class=%04x,index=%d)&bslash;n&quot;
comma
r_class
comma
id|index
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* FIXME: this ignores multi-function devices... */
r_for
c_loop
(paren
id|devnr
op_assign
l_int|0
suffix:semicolon
(paren
id|devnr
OL
l_int|128
)paren
suffix:semicolon
id|devnr
op_add_assign
l_int|8
)paren
(brace
id|pcibios_read_config_dword
c_func
(paren
l_int|0
comma
id|devnr
comma
id|PCI_CLASS_REVISION
comma
op_amp
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|val
op_rshift
l_int|8
)paren
op_eq
r_class
)paren
(brace
r_if
c_cond
(paren
id|index
op_decrement
op_eq
l_int|0
)paren
(brace
op_star
id|bus
op_assign
l_int|0
suffix:semicolon
op_star
id|dev
op_assign
id|devnr
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
)brace
)brace
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;Local routines to interrcept the standard I/O and vector handling&n; *&t;code. Don&squot;t include this &squot;till now - initialization code above needs&n; *&t;access to the real code too.&n; */
macro_line|#include &lt;asm/mcfpci.h&gt;
multiline_comment|/*****************************************************************************/
DECL|function|pci_outb
r_void
id|pci_outb
c_func
(paren
r_int
r_char
id|val
comma
r_int
r_int
id|addr
)paren
(brace
r_volatile
r_int
r_int
op_star
id|rp
suffix:semicolon
r_volatile
r_int
r_char
op_star
id|bp
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;pci_outb(val=%02x,addr=%x)&bslash;n&quot;
comma
id|val
comma
id|addr
)paren
suffix:semicolon
macro_line|#endif
id|rp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|bp
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|COMEM_DA_IOWR
op_or
id|COMEM_DA_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|addr
op_assign
(paren
id|addr
op_amp
op_complement
l_int|0x3
)paren
op_plus
(paren
op_complement
id|addr
op_amp
l_int|0x03
)paren
suffix:semicolon
id|bp
(braket
(paren
id|COMEM_PCIBUS
op_plus
id|COMEM_DA_OFFSET
c_func
(paren
id|addr
)paren
)paren
)braket
op_assign
id|val
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pci_outw
r_void
id|pci_outw
c_func
(paren
r_int
r_int
id|val
comma
r_int
r_int
id|addr
)paren
(brace
r_volatile
r_int
r_int
op_star
id|rp
suffix:semicolon
r_volatile
r_int
r_int
op_star
id|sp
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;pci_outw(val=%04x,addr=%x)&quot;
comma
id|val
comma
id|addr
)paren
suffix:semicolon
macro_line|#endif
id|rp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|sp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|COMEM_DA_IOWR
op_or
id|COMEM_DA_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|addr
op_assign
(paren
id|addr
op_amp
op_complement
l_int|0x3
)paren
op_plus
(paren
op_complement
id|addr
op_amp
l_int|0x02
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_byteswap
)paren
id|val
op_assign
(paren
(paren
id|val
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|val
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|sp
(braket
id|WREG
c_func
(paren
id|COMEM_PCIBUS
op_plus
id|COMEM_DA_OFFSET
c_func
(paren
id|addr
)paren
)paren
)braket
op_assign
id|val
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pci_outl
r_void
id|pci_outl
c_func
(paren
r_int
r_int
id|val
comma
r_int
r_int
id|addr
)paren
(brace
r_volatile
r_int
r_int
op_star
id|rp
suffix:semicolon
r_volatile
r_int
r_int
op_star
id|lp
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;pci_outl(val=%08x,addr=%x)&bslash;n&quot;
comma
id|val
comma
id|addr
)paren
suffix:semicolon
macro_line|#endif
id|rp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|lp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|COMEM_DA_IOWR
op_or
id|COMEM_DA_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_byteswap
)paren
id|val
op_assign
(paren
id|val
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|val
op_amp
l_int|0x0000ff00
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|val
op_amp
l_int|0x00ff0000
)paren
op_rshift
l_int|8
)paren
op_or
(paren
id|val
op_rshift
l_int|24
)paren
suffix:semicolon
id|lp
(braket
id|LREG
c_func
(paren
id|COMEM_PCIBUS
op_plus
id|COMEM_DA_OFFSET
c_func
(paren
id|addr
)paren
)paren
)braket
op_assign
id|val
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|variable|pci_blmask
r_int
r_int
id|pci_blmask
(braket
)braket
op_assign
(brace
l_int|0x000000e0
comma
l_int|0x000000d0
comma
l_int|0x000000b0
comma
l_int|0x00000070
)brace
suffix:semicolon
DECL|function|pci_inb
r_int
r_char
id|pci_inb
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_volatile
r_int
r_int
op_star
id|rp
suffix:semicolon
r_volatile
r_int
r_char
op_star
id|bp
suffix:semicolon
r_int
r_int
id|r
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;pci_inb(addr=%x)&quot;
comma
id|addr
)paren
suffix:semicolon
macro_line|#endif
id|rp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|bp
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|r
op_assign
id|COMEM_DA_IORD
op_or
id|COMEM_DA_ADDR
c_func
(paren
id|addr
)paren
op_or
id|pci_blmask
(braket
(paren
id|addr
op_amp
l_int|0x3
)paren
)braket
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|r
suffix:semicolon
id|addr
op_assign
(paren
id|addr
op_amp
op_complement
l_int|0x3
)paren
op_plus
(paren
op_complement
id|addr
op_amp
l_int|0x3
)paren
suffix:semicolon
id|val
op_assign
id|bp
(braket
(paren
id|COMEM_PCIBUS
op_plus
id|COMEM_DA_OFFSET
c_func
(paren
id|addr
)paren
)paren
)braket
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|variable|pci_bwmask
r_int
r_int
id|pci_bwmask
(braket
)braket
op_assign
(brace
l_int|0x000000c0
comma
l_int|0x000000c0
comma
l_int|0x00000030
comma
l_int|0x00000030
)brace
suffix:semicolon
DECL|function|pci_inw
r_int
r_int
id|pci_inw
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_volatile
r_int
r_int
op_star
id|rp
suffix:semicolon
r_volatile
r_int
r_int
op_star
id|sp
suffix:semicolon
r_int
r_int
id|r
suffix:semicolon
r_int
r_int
id|val
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;pci_inw(addr=%x)&quot;
comma
id|addr
)paren
suffix:semicolon
macro_line|#endif
id|rp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|r
op_assign
id|COMEM_DA_IORD
op_or
id|COMEM_DA_ADDR
c_func
(paren
id|addr
)paren
op_or
id|pci_bwmask
(braket
(paren
id|addr
op_amp
l_int|0x3
)paren
)braket
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|r
suffix:semicolon
id|sp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|addr
op_assign
(paren
id|addr
op_amp
op_complement
l_int|0x3
)paren
op_plus
(paren
op_complement
id|addr
op_amp
l_int|0x02
)paren
suffix:semicolon
id|val
op_assign
id|sp
(braket
id|WREG
c_func
(paren
id|COMEM_PCIBUS
op_plus
id|COMEM_DA_OFFSET
c_func
(paren
id|addr
)paren
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pci_byteswap
)paren
id|val
op_assign
(paren
(paren
id|val
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|val
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;=%04x&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
macro_line|#endif
r_return
id|val
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pci_inl
r_int
r_int
id|pci_inl
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_volatile
r_int
r_int
op_star
id|rp
suffix:semicolon
r_volatile
r_int
r_int
op_star
id|lp
suffix:semicolon
r_int
r_int
id|val
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;pci_inl(addr=%x)&quot;
comma
id|addr
)paren
suffix:semicolon
macro_line|#endif
id|rp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|lp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|COMEM_DA_IORD
op_or
id|COMEM_DA_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|val
op_assign
id|lp
(braket
id|LREG
c_func
(paren
id|COMEM_PCIBUS
op_plus
id|COMEM_DA_OFFSET
c_func
(paren
id|addr
)paren
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pci_byteswap
)paren
id|val
op_assign
(paren
id|val
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|val
op_amp
l_int|0x0000ff00
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|val
op_amp
l_int|0x00ff0000
)paren
op_rshift
l_int|8
)paren
op_or
(paren
id|val
op_rshift
l_int|24
)paren
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;=%08x&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
macro_line|#endif
r_return
id|val
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pci_outsb
r_void
id|pci_outsb
c_func
(paren
r_void
op_star
id|addr
comma
r_void
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_volatile
r_int
r_int
op_star
id|rp
suffix:semicolon
r_volatile
r_int
r_char
op_star
id|bp
suffix:semicolon
r_int
r_char
op_star
id|dp
op_assign
(paren
r_int
r_char
op_star
)paren
id|buf
suffix:semicolon
r_int
r_int
id|a
op_assign
(paren
r_int
r_int
)paren
id|addr
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;pci_outsb(addr=%x,buf=%x,len=%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|addr
comma
(paren
r_int
)paren
id|buf
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
id|rp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|COMEM_DA_IOWR
op_or
id|COMEM_DA_ADDR
c_func
(paren
id|a
)paren
suffix:semicolon
id|a
op_assign
(paren
id|a
op_amp
op_complement
l_int|0x3
)paren
op_plus
(paren
op_complement
id|a
op_amp
l_int|0x03
)paren
suffix:semicolon
id|bp
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
(paren
id|COMEM_BASE
op_plus
id|COMEM_PCIBUS
op_plus
id|COMEM_DA_OFFSET
c_func
(paren
id|a
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
op_decrement
)paren
op_star
id|bp
op_assign
op_star
id|dp
op_increment
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pci_outsw
r_void
id|pci_outsw
c_func
(paren
r_void
op_star
id|addr
comma
r_void
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_volatile
r_int
r_int
op_star
id|rp
suffix:semicolon
r_volatile
r_int
r_int
op_star
id|wp
suffix:semicolon
r_int
r_int
id|w
comma
op_star
id|dp
op_assign
(paren
r_int
r_int
op_star
)paren
id|buf
suffix:semicolon
r_int
r_int
id|a
op_assign
(paren
r_int
r_int
)paren
id|addr
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;pci_outsw(addr=%x,buf=%x,len=%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|addr
comma
(paren
r_int
)paren
id|buf
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
id|rp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|COMEM_DA_IOWR
op_or
id|COMEM_DA_ADDR
c_func
(paren
id|a
)paren
suffix:semicolon
id|a
op_assign
(paren
id|a
op_amp
op_complement
l_int|0x3
)paren
op_plus
(paren
op_complement
id|a
op_amp
l_int|0x2
)paren
suffix:semicolon
id|wp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
(paren
id|COMEM_BASE
op_plus
id|COMEM_PCIBUS
op_plus
id|COMEM_DA_OFFSET
c_func
(paren
id|a
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
id|w
op_assign
op_star
id|dp
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|pci_byteswap
)paren
id|w
op_assign
(paren
(paren
id|w
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|w
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
op_star
id|wp
op_assign
id|w
suffix:semicolon
)brace
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pci_outsl
r_void
id|pci_outsl
c_func
(paren
r_void
op_star
id|addr
comma
r_void
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_volatile
r_int
r_int
op_star
id|rp
suffix:semicolon
r_volatile
r_int
r_int
op_star
id|lp
suffix:semicolon
r_int
r_int
id|l
comma
op_star
id|dp
op_assign
(paren
r_int
r_int
op_star
)paren
id|buf
suffix:semicolon
r_int
r_int
id|a
op_assign
(paren
r_int
r_int
)paren
id|addr
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;pci_outsl(addr=%x,buf=%x,len=%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|addr
comma
(paren
r_int
)paren
id|buf
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
id|rp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|COMEM_DA_IOWR
op_or
id|COMEM_DA_ADDR
c_func
(paren
id|a
)paren
suffix:semicolon
id|lp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
(paren
id|COMEM_BASE
op_plus
id|COMEM_PCIBUS
op_plus
id|COMEM_DA_OFFSET
c_func
(paren
id|a
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
id|l
op_assign
op_star
id|dp
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|pci_byteswap
)paren
id|l
op_assign
(paren
id|l
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|l
op_amp
l_int|0x0000ff00
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|l
op_amp
l_int|0x00ff0000
)paren
op_rshift
l_int|8
)paren
op_or
(paren
id|l
op_rshift
l_int|24
)paren
suffix:semicolon
op_star
id|lp
op_assign
id|l
suffix:semicolon
)brace
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pci_insb
r_void
id|pci_insb
c_func
(paren
r_void
op_star
id|addr
comma
r_void
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_volatile
r_int
r_int
op_star
id|rp
suffix:semicolon
r_volatile
r_int
r_char
op_star
id|bp
suffix:semicolon
r_int
r_char
op_star
id|dp
op_assign
(paren
r_int
r_char
op_star
)paren
id|buf
suffix:semicolon
r_int
r_int
id|a
op_assign
(paren
r_int
r_int
)paren
id|addr
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;pci_insb(addr=%x,buf=%x,len=%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|addr
comma
(paren
r_int
)paren
id|buf
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
id|rp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|COMEM_DA_IORD
op_or
id|COMEM_DA_ADDR
c_func
(paren
id|a
)paren
suffix:semicolon
id|a
op_assign
(paren
id|a
op_amp
op_complement
l_int|0x3
)paren
op_plus
(paren
op_complement
id|a
op_amp
l_int|0x03
)paren
suffix:semicolon
id|bp
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
(paren
id|COMEM_BASE
op_plus
id|COMEM_PCIBUS
op_plus
id|COMEM_DA_OFFSET
c_func
(paren
id|a
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
op_decrement
)paren
op_star
id|dp
op_increment
op_assign
op_star
id|bp
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pci_insw
r_void
id|pci_insw
c_func
(paren
r_void
op_star
id|addr
comma
r_void
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_volatile
r_int
r_int
op_star
id|rp
suffix:semicolon
r_volatile
r_int
r_int
op_star
id|wp
suffix:semicolon
r_int
r_int
id|w
comma
op_star
id|dp
op_assign
(paren
r_int
r_int
op_star
)paren
id|buf
suffix:semicolon
r_int
r_int
id|a
op_assign
(paren
r_int
r_int
)paren
id|addr
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;pci_insw(addr=%x,buf=%x,len=%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|addr
comma
(paren
r_int
)paren
id|buf
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
id|rp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|COMEM_DA_IORD
op_or
id|COMEM_DA_ADDR
c_func
(paren
id|a
)paren
suffix:semicolon
id|a
op_assign
(paren
id|a
op_amp
op_complement
l_int|0x3
)paren
op_plus
(paren
op_complement
id|a
op_amp
l_int|0x2
)paren
suffix:semicolon
id|wp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
(paren
id|COMEM_BASE
op_plus
id|COMEM_PCIBUS
op_plus
id|COMEM_DA_OFFSET
c_func
(paren
id|a
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
id|w
op_assign
op_star
id|wp
suffix:semicolon
r_if
c_cond
(paren
id|pci_byteswap
)paren
id|w
op_assign
(paren
(paren
id|w
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|w
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
op_star
id|dp
op_increment
op_assign
id|w
suffix:semicolon
)brace
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pci_insl
r_void
id|pci_insl
c_func
(paren
r_void
op_star
id|addr
comma
r_void
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_volatile
r_int
r_int
op_star
id|rp
suffix:semicolon
r_volatile
r_int
r_int
op_star
id|lp
suffix:semicolon
r_int
r_int
id|l
comma
op_star
id|dp
op_assign
(paren
r_int
r_int
op_star
)paren
id|buf
suffix:semicolon
r_int
r_int
id|a
op_assign
(paren
r_int
r_int
)paren
id|addr
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;pci_insl(addr=%x,buf=%x,len=%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|addr
comma
(paren
r_int
)paren
id|buf
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
id|rp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
id|COMEM_BASE
suffix:semicolon
id|rp
(braket
id|LREG
c_func
(paren
id|COMEM_DAHBASE
)paren
)braket
op_assign
id|COMEM_DA_IORD
op_or
id|COMEM_DA_ADDR
c_func
(paren
id|a
)paren
suffix:semicolon
id|lp
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
(paren
id|COMEM_BASE
op_plus
id|COMEM_PCIBUS
op_plus
id|COMEM_DA_OFFSET
c_func
(paren
id|a
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
id|l
op_assign
op_star
id|lp
suffix:semicolon
r_if
c_cond
(paren
id|pci_byteswap
)paren
id|l
op_assign
(paren
id|l
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|l
op_amp
l_int|0x0000ff00
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|l
op_amp
l_int|0x00ff0000
)paren
op_rshift
l_int|8
)paren
op_or
(paren
id|l
op_rshift
l_int|24
)paren
suffix:semicolon
op_star
id|dp
op_increment
op_assign
id|l
suffix:semicolon
)brace
)brace
multiline_comment|/*****************************************************************************/
DECL|struct|pci_localirqlist
r_struct
id|pci_localirqlist
(brace
DECL|member|handler
r_void
(paren
op_star
id|handler
)paren
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
DECL|member|device
r_const
r_char
op_star
id|device
suffix:semicolon
DECL|member|dev_id
r_void
op_star
id|dev_id
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|pci_irqlist
r_struct
id|pci_localirqlist
id|pci_irqlist
(braket
id|COMEM_MAXPCI
)braket
suffix:semicolon
multiline_comment|/*****************************************************************************/
DECL|function|pci_request_irq
r_int
id|pci_request_irq
c_func
(paren
r_int
r_int
id|irq
comma
r_void
(paren
op_star
id|handler
)paren
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
comma
r_int
r_int
id|flags
comma
r_const
r_char
op_star
id|device
comma
r_void
op_star
id|dev_id
)paren
(brace
r_int
id|i
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;pci_request_irq(irq=%d,handler=%x,flags=%x,device=%s,&quot;
l_string|&quot;dev_id=%x)&bslash;n&quot;
comma
id|irq
comma
(paren
r_int
)paren
id|handler
comma
(paren
r_int
)paren
id|flags
comma
id|device
comma
(paren
r_int
)paren
id|dev_id
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Check if this interrupt handler is already lodged */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|COMEM_MAXPCI
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pci_irqlist
(braket
id|i
)braket
dot
id|handler
op_eq
id|handler
)paren
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Find a free spot to put this handler */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|COMEM_MAXPCI
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pci_irqlist
(braket
id|i
)braket
dot
id|handler
op_eq
l_int|0
)paren
(brace
id|pci_irqlist
(braket
id|i
)braket
dot
id|handler
op_assign
id|handler
suffix:semicolon
id|pci_irqlist
(braket
id|i
)braket
dot
id|device
op_assign
id|device
suffix:semicolon
id|pci_irqlist
(braket
id|i
)braket
dot
id|dev_id
op_assign
id|dev_id
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Couldn&squot;t fit?? */
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pci_free_irq
r_void
id|pci_free_irq
c_func
(paren
r_int
r_int
id|irq
comma
r_void
op_star
id|dev_id
)paren
(brace
r_int
id|i
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;pci_free_irq(irq=%d,dev_id=%x)&bslash;n&quot;
comma
id|irq
comma
(paren
r_int
)paren
id|dev_id
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|dev_id
op_eq
(paren
r_void
op_star
)paren
l_int|NULL
)paren
r_return
suffix:semicolon
multiline_comment|/* Check if this interrupt handler is lodged */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|COMEM_MAXPCI
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pci_irqlist
(braket
id|i
)braket
dot
id|dev_id
op_eq
id|dev_id
)paren
(brace
id|pci_irqlist
(braket
id|i
)braket
dot
id|handler
op_assign
l_int|NULL
suffix:semicolon
id|pci_irqlist
(braket
id|i
)braket
dot
id|device
op_assign
l_int|NULL
suffix:semicolon
id|pci_irqlist
(braket
id|i
)braket
dot
id|dev_id
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pci_interrupt
r_void
id|pci_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|id
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
(brace
r_int
id|i
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;pci_interrupt(irq=%d,id=%x,fp=%x)&bslash;n&quot;
comma
id|irq
comma
(paren
r_int
)paren
id|id
comma
(paren
r_int
)paren
id|fp
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|COMEM_MAXPCI
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pci_irqlist
(braket
id|i
)braket
dot
id|handler
)paren
(paren
op_star
id|pci_irqlist
(braket
id|i
)braket
dot
id|handler
)paren
(paren
id|irq
comma
id|pci_irqlist
(braket
id|i
)braket
dot
id|dev_id
comma
id|fp
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&t;The shared memory region is broken up into contiguous 512 byte&n; *&t;regions for easy allocation... This is not an optimal solution&n; *&t;but it makes allocation and freeing regions really easy.&n; */
DECL|macro|PCI_MEMSLOTSIZE
mdefine_line|#define&t;PCI_MEMSLOTSIZE&t;&t;512
DECL|macro|PCI_MEMSLOTS
mdefine_line|#define&t;PCI_MEMSLOTS&t;&t;(COMEM_SHMEMSIZE / PCI_MEMSLOTSIZE)
DECL|variable|pci_shmemmap
r_char
id|pci_shmemmap
(braket
id|PCI_MEMSLOTS
)braket
suffix:semicolon
DECL|function|pci_bmalloc
r_void
op_star
id|pci_bmalloc
c_func
(paren
r_int
id|size
)paren
(brace
r_int
id|i
comma
id|j
comma
id|nrslots
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;pci_bmalloc(size=%d)&bslash;n&quot;
comma
id|size
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|size
op_le
l_int|0
)paren
r_return
(paren
r_void
op_star
)paren
l_int|NULL
suffix:semicolon
id|nrslots
op_assign
(paren
id|size
op_minus
l_int|1
)paren
op_div
id|PCI_MEMSLOTSIZE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
(paren
id|PCI_MEMSLOTS
op_minus
id|nrslots
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pci_shmemmap
(braket
id|i
)braket
op_eq
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
(paren
id|j
OL
(paren
id|i
op_plus
id|nrslots
)paren
)paren
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pci_shmemmap
(braket
id|j
)braket
)paren
r_goto
id|restart
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
id|i
suffix:semicolon
(paren
id|j
op_le
id|i
op_plus
id|nrslots
)paren
suffix:semicolon
id|j
op_increment
)paren
id|pci_shmemmap
(braket
id|j
)braket
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|restart
suffix:colon
)brace
r_return
(paren
r_void
op_star
)paren
(paren
id|COMEM_BASE
op_plus
id|COMEM_SHMEM
op_plus
(paren
id|i
op_star
id|PCI_MEMSLOTSIZE
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pci_bmfree
r_void
id|pci_bmfree
c_func
(paren
r_void
op_star
id|mp
comma
r_int
id|size
)paren
(brace
r_int
id|i
comma
id|j
comma
id|nrslots
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;pci_bmfree(mp=%x,size=%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|mp
comma
id|size
)paren
suffix:semicolon
macro_line|#endif
id|nrslots
op_assign
id|size
op_div
id|PCI_MEMSLOTSIZE
suffix:semicolon
id|i
op_assign
(paren
(paren
(paren
r_int
r_int
)paren
id|mp
)paren
op_minus
(paren
id|COMEM_BASE
op_plus
id|COMEM_SHMEM
)paren
)paren
op_div
id|PCI_MEMSLOTSIZE
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
id|i
suffix:semicolon
(paren
id|j
OL
(paren
id|i
op_plus
id|nrslots
)paren
)paren
suffix:semicolon
id|j
op_increment
)paren
id|pci_shmemmap
(braket
id|j
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pci_virt_to_bus
r_int
r_int
id|pci_virt_to_bus
c_func
(paren
r_volatile
r_void
op_star
id|address
)paren
(brace
r_int
r_int
id|l
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;pci_virt_to_bus(address=%x)&quot;
comma
(paren
r_int
)paren
id|address
)paren
suffix:semicolon
macro_line|#endif
id|l
op_assign
(paren
(paren
r_int
r_int
)paren
id|address
)paren
op_minus
id|COMEM_BASE
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;=%x&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|l
op_plus
id|pci_shmemaddr
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
id|l
op_plus
id|pci_shmemaddr
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pci_bus_to_virt
r_void
op_star
id|pci_bus_to_virt
c_func
(paren
r_int
r_int
id|address
)paren
(brace
r_int
r_int
id|l
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;pci_bus_to_virt(address=%x)&quot;
comma
(paren
r_int
)paren
id|address
)paren
suffix:semicolon
macro_line|#endif
id|l
op_assign
id|address
op_minus
id|pci_shmemaddr
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;=%x&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|address
op_plus
id|COMEM_BASE
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
r_void
op_star
)paren
(paren
id|address
op_plus
id|COMEM_BASE
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pci_bmcpyto
r_void
id|pci_bmcpyto
c_func
(paren
r_void
op_star
id|dst
comma
r_void
op_star
id|src
comma
r_int
id|len
)paren
(brace
r_int
r_int
op_star
id|dp
comma
op_star
id|sp
comma
id|val
suffix:semicolon
r_int
r_char
op_star
id|dcp
comma
op_star
id|scp
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;pci_bmcpyto(dst=%x,src=%x,len=%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|dst
comma
(paren
r_int
)paren
id|src
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
id|dp
op_assign
(paren
r_int
r_int
op_star
)paren
id|dst
suffix:semicolon
id|sp
op_assign
(paren
r_int
r_int
op_star
)paren
id|src
suffix:semicolon
id|i
op_assign
id|len
op_rshift
l_int|2
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;DATA:&quot;
)paren
suffix:semicolon
id|scp
op_assign
(paren
r_int
r_char
op_star
)paren
id|sp
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|len
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_mod
l_int|16
)paren
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n%04x: &quot;
comma
id|i
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
op_star
id|scp
op_increment
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
(paren
id|i
op_ge
l_int|0
)paren
suffix:semicolon
id|i
op_decrement
comma
id|j
op_increment
)paren
(brace
id|val
op_assign
op_star
id|sp
op_increment
suffix:semicolon
id|val
op_assign
(paren
id|val
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|val
op_amp
l_int|0x0000ff00
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|val
op_amp
l_int|0x00ff0000
)paren
op_rshift
l_int|8
)paren
op_or
(paren
id|val
op_rshift
l_int|24
)paren
suffix:semicolon
op_star
id|dp
op_increment
op_assign
id|val
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_amp
l_int|0x3
)paren
(brace
id|dcp
op_assign
(paren
r_int
r_char
op_star
)paren
id|dp
suffix:semicolon
id|scp
op_assign
(paren
(paren
r_int
r_char
op_star
)paren
id|sp
)paren
op_plus
l_int|3
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
(paren
id|len
op_amp
l_int|0x3
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
op_star
id|dcp
op_increment
op_assign
op_star
id|scp
op_decrement
suffix:semicolon
)brace
)brace
multiline_comment|/*****************************************************************************/
DECL|function|pci_bmcpyfrom
r_void
id|pci_bmcpyfrom
c_func
(paren
r_void
op_star
id|dst
comma
r_void
op_star
id|src
comma
r_int
id|len
)paren
(brace
r_int
r_int
op_star
id|dp
comma
op_star
id|sp
comma
id|val
suffix:semicolon
r_int
r_char
op_star
id|dcp
comma
op_star
id|scp
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#ifdef DEBUGIO
id|printk
c_func
(paren
l_string|&quot;pci_bmcpyfrom(dst=%x,src=%x,len=%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|dst
comma
(paren
r_int
)paren
id|src
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
id|dp
op_assign
(paren
r_int
r_int
op_star
)paren
id|dst
suffix:semicolon
id|sp
op_assign
(paren
r_int
r_int
op_star
)paren
id|src
suffix:semicolon
id|i
op_assign
id|len
op_rshift
l_int|2
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
(paren
id|i
op_ge
l_int|0
)paren
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|val
op_assign
op_star
id|sp
op_increment
suffix:semicolon
id|val
op_assign
(paren
id|val
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|val
op_amp
l_int|0x0000ff00
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|val
op_amp
l_int|0x00ff0000
)paren
op_rshift
l_int|8
)paren
op_or
(paren
id|val
op_rshift
l_int|24
)paren
suffix:semicolon
op_star
id|dp
op_increment
op_assign
id|val
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_amp
l_int|0x3
)paren
(brace
id|dcp
op_assign
(paren
(paren
r_int
r_char
op_star
)paren
id|dp
)paren
op_plus
l_int|3
suffix:semicolon
id|scp
op_assign
(paren
r_int
r_char
op_star
)paren
id|sp
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
(paren
id|len
op_amp
l_int|0x3
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
op_star
id|dcp
op_increment
op_assign
op_star
id|scp
op_decrement
suffix:semicolon
)brace
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;DATA:&quot;
)paren
suffix:semicolon
id|dcp
op_assign
(paren
r_int
r_char
op_star
)paren
id|dst
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|len
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_mod
l_int|16
)paren
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n%04x: &quot;
comma
id|i
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
op_star
id|dcp
op_increment
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*****************************************************************************/
eof
