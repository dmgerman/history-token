multiline_comment|/***************************************************************************/
multiline_comment|/*&n; *&t;timers.c -- generic ColdFire hardware timer support.&n; *&n; *&t;Copyright (C) 1999-2003, Greg Ungerer (gerg@snapgear.com)&n; */
multiline_comment|/***************************************************************************/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/param.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/traps.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/coldfire.h&gt;
macro_line|#include &lt;asm/mcftimer.h&gt;
macro_line|#include &lt;asm/mcfsim.h&gt;
multiline_comment|/***************************************************************************/
multiline_comment|/*&n; *&t;Default the timer and vector to use for ColdFire. Some ColdFire&n; *&t;CPU&squot;s and some boards may want different. Their sub-architecture&n; *&t;startup code (in config.c) can change these if they want.&n; */
DECL|variable|mcf_timervector
r_int
r_int
id|mcf_timervector
op_assign
l_int|29
suffix:semicolon
DECL|variable|mcf_profilevector
r_int
r_int
id|mcf_profilevector
op_assign
l_int|31
suffix:semicolon
DECL|variable|mcf_timerlevel
r_int
r_int
id|mcf_timerlevel
op_assign
l_int|5
suffix:semicolon
DECL|variable|mcf_timerp
r_static
r_volatile
r_struct
id|mcftimer
op_star
id|mcf_timerp
suffix:semicolon
multiline_comment|/*&n; *&t;These provide the underlying interrupt vector support.&n; *&t;Unfortunately it is a little different on each ColdFire.&n; */
r_extern
r_void
id|mcf_settimericr
c_func
(paren
r_int
id|timer
comma
r_int
id|level
)paren
suffix:semicolon
r_extern
r_int
id|mcf_timerirqpending
c_func
(paren
r_int
id|timer
)paren
suffix:semicolon
multiline_comment|/***************************************************************************/
DECL|function|coldfire_tick
r_void
id|coldfire_tick
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Reset the ColdFire timer */
id|mcf_timerp-&gt;ter
op_assign
id|MCFTIMER_TER_CAP
op_or
id|MCFTIMER_TER_REF
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
DECL|function|coldfire_timer_init
r_void
id|coldfire_timer_init
c_func
(paren
id|irqreturn_t
(paren
op_star
id|handler
)paren
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
)paren
(brace
multiline_comment|/* Set up an internal TIMER as poll clock */
id|mcf_timerp
op_assign
(paren
r_volatile
r_struct
id|mcftimer
op_star
)paren
(paren
id|MCF_MBAR
op_plus
id|MCFTIMER_BASE1
)paren
suffix:semicolon
id|mcf_timerp-&gt;tmr
op_assign
id|MCFTIMER_TMR_DISABLE
suffix:semicolon
id|mcf_timerp-&gt;trr
op_assign
(paren
r_int
r_int
)paren
(paren
(paren
id|MCF_BUSCLK
op_div
l_int|16
)paren
op_div
id|HZ
)paren
suffix:semicolon
id|mcf_timerp-&gt;tmr
op_assign
id|MCFTIMER_TMR_ENORI
op_or
id|MCFTIMER_TMR_CLK16
op_or
id|MCFTIMER_TMR_RESTART
op_or
id|MCFTIMER_TMR_ENABLE
suffix:semicolon
id|request_irq
c_func
(paren
id|mcf_timervector
comma
id|handler
comma
id|SA_INTERRUPT
comma
l_string|&quot;timer&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|mcf_settimericr
c_func
(paren
l_int|1
comma
id|mcf_timerlevel
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_HIGHPROFILE
id|coldfire_profile_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/***************************************************************************/
DECL|function|coldfire_timer_offset
r_int
r_int
id|coldfire_timer_offset
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|trr
comma
id|tcn
comma
id|offset
suffix:semicolon
multiline_comment|/*&n;&t; * The change to pointer and de-reference is to force the compiler&n;&t; * to read the registers with a single 16bit access. Otherwise it&n;&t; * does some crazy 8bit read combining.&n;&t; */
id|tcn
op_assign
op_star
(paren
op_amp
id|mcf_timerp-&gt;tcn
)paren
suffix:semicolon
id|trr
op_assign
op_star
(paren
op_amp
id|mcf_timerp-&gt;trr
)paren
suffix:semicolon
id|offset
op_assign
(paren
id|tcn
op_star
(paren
l_int|1000000
op_div
id|HZ
)paren
)paren
op_div
id|trr
suffix:semicolon
multiline_comment|/* Check if we just wrapped the counters and maybe missed a tick */
r_if
c_cond
(paren
(paren
id|offset
OL
(paren
l_int|1000000
op_div
id|HZ
op_div
l_int|2
)paren
)paren
op_logical_and
id|mcf_timerirqpending
c_func
(paren
l_int|1
)paren
)paren
id|offset
op_add_assign
l_int|1000000
op_div
id|HZ
suffix:semicolon
r_return
id|offset
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
macro_line|#ifdef CONFIG_HIGHPROFILE
multiline_comment|/***************************************************************************/
multiline_comment|/*&n; *&t;Choose a reasonably fast profile timer. Make it an odd value to&n; *&t;try and get good coverage of kernal operations.&n; */
DECL|macro|PROFILEHZ
mdefine_line|#define&t;PROFILEHZ&t;1013
DECL|variable|mcf_proftp
r_static
r_volatile
r_struct
id|mcftimer
op_star
id|mcf_proftp
suffix:semicolon
multiline_comment|/*&n; *&t;Use the other timer to provide high accuracy profiling info.&n; */
DECL|function|coldfire_profile_tick
r_void
id|coldfire_profile_tick
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dummy
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
multiline_comment|/* Reset ColdFire timer2 */
id|mcf_proftp-&gt;ter
op_assign
id|MCFTIMER_TER_CAP
op_or
id|MCFTIMER_TER_REF
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|user_mode
c_func
(paren
id|regs
)paren
)paren
(brace
r_if
c_cond
(paren
id|prof_buffer
op_logical_and
id|current-&gt;pid
)paren
(brace
r_extern
r_int
id|_stext
suffix:semicolon
r_int
r_int
id|ip
op_assign
id|instruction_pointer
c_func
(paren
id|regs
)paren
suffix:semicolon
id|ip
op_sub_assign
(paren
r_int
r_int
)paren
op_amp
id|_stext
suffix:semicolon
id|ip
op_rshift_assign
id|prof_shift
suffix:semicolon
r_if
c_cond
(paren
id|ip
OL
id|prof_len
)paren
id|prof_buffer
(braket
id|ip
)braket
op_increment
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/***************************************************************************/
DECL|function|coldfire_profile_init
r_void
id|coldfire_profile_init
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PROFILE: lodging TIMER2 @ %dHz as profile timer&bslash;n&quot;
comma
id|PROFILEHZ
)paren
suffix:semicolon
multiline_comment|/* Set up TIMER 2 as high speed profile clock */
id|mcf_proftp
op_assign
(paren
r_volatile
r_struct
id|mcftimer
op_star
)paren
(paren
id|MCF_MBAR
op_plus
id|MCFTIMER_BASE2
)paren
suffix:semicolon
id|mcf_proftp-&gt;tmr
op_assign
id|MCFTIMER_TMR_DISABLE
suffix:semicolon
id|mcf_proftp-&gt;trr
op_assign
(paren
r_int
r_int
)paren
(paren
(paren
id|MCF_CLK
op_div
l_int|16
)paren
op_div
id|PROFILEHZ
)paren
suffix:semicolon
id|mcf_proftp-&gt;tmr
op_assign
id|MCFTIMER_TMR_ENORI
op_or
id|MCFTIMER_TMR_CLK16
op_or
id|MCFTIMER_TMR_RESTART
op_or
id|MCFTIMER_TMR_ENABLE
suffix:semicolon
id|request_irq
c_func
(paren
id|mcf_profilevector
comma
id|coldfire_profile_tick
comma
(paren
id|SA_INTERRUPT
op_or
id|IRQ_FLG_FAST
)paren
comma
l_string|&quot;profile timer&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|mcf_settimericr
c_func
(paren
l_int|2
comma
l_int|7
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************/
macro_line|#endif&t;/* CONFIG_HIGHPROFILE */
multiline_comment|/***************************************************************************/
eof
