multiline_comment|/*&n; * linux/arch/m68knommu/platform/68328/ints.c&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file COPYING in the main directory of this archive&n; * for more details.&n; *&n; * Copyright 1996 Roman Zippel&n; * Copyright 1999 D. Jeff Dionne &lt;jeff@rt-control.com&gt;&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel_stat.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/traps.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/setup.h&gt;
macro_line|#if defined(CONFIG_M68328)
macro_line|#include &lt;asm/MC68328.h&gt;
macro_line|#elif defined(CONFIG_M68EZ328)
macro_line|#include &lt;asm/MC68EZ328.h&gt;
macro_line|#elif defined(CONFIG_M68VZ328)
macro_line|#include &lt;asm/MC68VZ328.h&gt;
macro_line|#endif
multiline_comment|/* assembler routines */
id|asmlinkage
r_void
id|system_call
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|buserr
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap3
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap4
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap5
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap6
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap7
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap8
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap9
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap10
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap11
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap12
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap13
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap14
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap15
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap33
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap34
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap35
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap36
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap37
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap38
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap39
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap40
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap41
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap42
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap43
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap44
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap45
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap46
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|trap47
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|bad_interrupt
c_func
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
id|asmlinkage
r_void
id|inthandler
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|inthandler1
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|inthandler2
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|inthandler3
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|inthandler4
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|inthandler5
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|inthandler6
c_func
(paren
r_void
)paren
suffix:semicolon
id|asmlinkage
r_void
id|inthandler7
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
id|e_vector
op_star
id|_ramvec
suffix:semicolon
multiline_comment|/* The number of spurious interrupts */
DECL|variable|num_spurious
r_volatile
r_int
r_int
id|num_spurious
suffix:semicolon
DECL|variable|local_irq_count
r_int
r_int
id|local_irq_count
(braket
id|NR_CPUS
)braket
suffix:semicolon
multiline_comment|/* irq node variables for the 32 (potential) on chip sources */
DECL|variable|int_irq_list
r_static
id|irq_node_t
id|int_irq_list
(braket
id|NR_IRQS
)braket
suffix:semicolon
macro_line|#if !defined(CONFIG_DRAGEN2)
id|asm
(paren
"&quot;"
dot
id|global
id|_start
comma
id|__ramend
dot
id|section
dot
id|romvec
id|e_vectors
suffix:colon
dot
r_int
id|__ramend
op_minus
l_int|4
comma
id|_start
comma
id|buserr
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
dot
r_int
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
dot
r_int
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
dot
r_int
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
dot
r_int
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
multiline_comment|/*.long inthandler, inthandler, inthandler, inthandler&n;&t;.long inthandler4, inthandler, inthandler, inthandler   */
multiline_comment|/* TRAP #0-15 */
dot
r_int
id|system_call
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
dot
r_int
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
comma
id|trap
dot
r_int
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
dot
id|text
id|ignore
suffix:colon
id|rte
"&quot;"
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * This function should be called during kernel startup to initialize&n; * the IRQ handling routines.&n; */
DECL|function|init_IRQ
r_void
id|init_IRQ
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* set up the vectors */
r_for
c_loop
(paren
id|i
op_assign
l_int|72
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
op_increment
id|i
)paren
id|_ramvec
(braket
id|i
)braket
op_assign
(paren
id|e_vector
)paren
id|bad_interrupt
suffix:semicolon
id|_ramvec
(braket
l_int|32
)braket
op_assign
id|system_call
suffix:semicolon
id|_ramvec
(braket
l_int|65
)braket
op_assign
id|inthandler1
suffix:semicolon
id|_ramvec
(braket
l_int|66
)braket
op_assign
id|inthandler2
suffix:semicolon
id|_ramvec
(braket
l_int|67
)braket
op_assign
id|inthandler3
suffix:semicolon
id|_ramvec
(braket
l_int|68
)braket
op_assign
id|inthandler4
suffix:semicolon
id|_ramvec
(braket
l_int|69
)braket
op_assign
id|inthandler5
suffix:semicolon
id|_ramvec
(braket
l_int|70
)braket
op_assign
id|inthandler6
suffix:semicolon
id|_ramvec
(braket
l_int|71
)braket
op_assign
id|inthandler7
suffix:semicolon
id|IVR
op_assign
l_int|0x40
suffix:semicolon
multiline_comment|/* Set DragonBall IVR (interrupt base) to 64 */
multiline_comment|/* initialize handlers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_IRQS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|int_irq_list
(braket
id|i
)braket
dot
id|handler
op_assign
id|bad_interrupt
suffix:semicolon
id|int_irq_list
(braket
id|i
)braket
dot
id|flags
op_assign
id|IRQ_FLG_STD
suffix:semicolon
id|int_irq_list
(braket
id|i
)braket
dot
id|dev_id
op_assign
l_int|NULL
suffix:semicolon
id|int_irq_list
(braket
id|i
)braket
dot
id|devname
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* turn off all interrupts */
id|IMR
op_assign
op_complement
l_int|0
suffix:semicolon
)brace
DECL|function|request_irq
r_int
id|request_irq
c_func
(paren
r_int
r_int
id|irq
comma
r_void
(paren
op_star
id|handler
)paren
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
comma
r_int
r_int
id|flags
comma
r_const
r_char
op_star
id|devname
comma
r_void
op_star
id|dev_id
)paren
(brace
r_if
c_cond
(paren
id|irq
op_ge
id|NR_IRQS
)paren
(brace
id|printk
(paren
l_string|&quot;%s: Unknown IRQ %d from %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|irq
comma
id|devname
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|int_irq_list
(braket
id|irq
)braket
dot
id|flags
op_amp
id|IRQ_FLG_STD
)paren
)paren
(brace
r_if
c_cond
(paren
id|int_irq_list
(braket
id|irq
)braket
dot
id|flags
op_amp
id|IRQ_FLG_LOCK
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: IRQ %d from %s is not replaceable&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|irq
comma
id|int_irq_list
(braket
id|irq
)braket
dot
id|devname
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|IRQ_FLG_REPLACE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: %s can&squot;t replace IRQ %d from %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|devname
comma
id|irq
comma
id|int_irq_list
(braket
id|irq
)braket
dot
id|devname
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
)brace
id|int_irq_list
(braket
id|irq
)braket
dot
id|handler
op_assign
id|handler
suffix:semicolon
id|int_irq_list
(braket
id|irq
)braket
dot
id|flags
op_assign
id|flags
suffix:semicolon
id|int_irq_list
(braket
id|irq
)braket
dot
id|dev_id
op_assign
id|dev_id
suffix:semicolon
id|int_irq_list
(braket
id|irq
)braket
dot
id|devname
op_assign
id|devname
suffix:semicolon
id|IMR
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|free_irq
r_void
id|free_irq
c_func
(paren
r_int
r_int
id|irq
comma
r_void
op_star
id|dev_id
)paren
(brace
r_if
c_cond
(paren
id|irq
op_ge
id|NR_IRQS
)paren
(brace
id|printk
(paren
l_string|&quot;%s: Unknown IRQ %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|int_irq_list
(braket
id|irq
)braket
dot
id|dev_id
op_ne
id|dev_id
)paren
id|printk
c_func
(paren
l_string|&quot;%s: removing probably wrong IRQ %d from %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|irq
comma
id|int_irq_list
(braket
id|irq
)braket
dot
id|devname
)paren
suffix:semicolon
id|int_irq_list
(braket
id|irq
)braket
dot
id|handler
op_assign
id|bad_interrupt
suffix:semicolon
id|int_irq_list
(braket
id|irq
)braket
dot
id|flags
op_assign
id|IRQ_FLG_STD
suffix:semicolon
id|int_irq_list
(braket
id|irq
)braket
dot
id|dev_id
op_assign
l_int|NULL
suffix:semicolon
id|int_irq_list
(braket
id|irq
)braket
dot
id|devname
op_assign
l_int|NULL
suffix:semicolon
id|IMR
op_or_assign
l_int|1
op_lshift
id|irq
suffix:semicolon
)brace
DECL|function|show_interrupts
r_int
id|show_interrupts
c_func
(paren
r_struct
id|seq_file
op_star
id|p
comma
r_void
op_star
id|v
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_IRQS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|int_irq_list
(braket
id|i
)braket
dot
id|flags
op_amp
id|IRQ_FLG_STD
)paren
r_continue
suffix:semicolon
id|seq_printf
c_func
(paren
id|p
comma
l_string|&quot;%3d: %10u &quot;
comma
id|i
comma
id|kstat_cpu
c_func
(paren
l_int|0
)paren
dot
id|irqs
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|int_irq_list
(braket
id|i
)braket
dot
id|flags
op_amp
id|IRQ_FLG_LOCK
)paren
id|seq_printf
c_func
(paren
id|p
comma
l_string|&quot;L &quot;
)paren
suffix:semicolon
r_else
id|seq_printf
c_func
(paren
id|p
comma
l_string|&quot;  &quot;
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|p
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|int_irq_list
(braket
id|i
)braket
dot
id|devname
)paren
suffix:semicolon
)brace
id|seq_printf
c_func
(paren
id|p
comma
l_string|&quot;   : %10u   spurious&bslash;n&quot;
comma
id|num_spurious
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The 68k family did not have a good way to determine the source&n; * of interrupts until later in the family.  The EC000 core does&n; * not provide the vector number on the stack, we vector everything&n; * into one vector and look in the blasted mask register...&n; * This code is designed to be fast, almost constant time, not clean!&n; */
DECL|function|process_int
r_void
id|process_int
c_func
(paren
r_int
id|vec
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
(brace
r_int
id|irq
suffix:semicolon
r_int
id|mask
suffix:semicolon
r_int
r_int
id|pend
op_assign
id|ISR
suffix:semicolon
r_while
c_loop
(paren
id|pend
)paren
(brace
r_if
c_cond
(paren
id|pend
op_amp
l_int|0x0000ffff
)paren
(brace
r_if
c_cond
(paren
id|pend
op_amp
l_int|0x000000ff
)paren
(brace
r_if
c_cond
(paren
id|pend
op_amp
l_int|0x0000000f
)paren
(brace
id|mask
op_assign
l_int|0x00000001
suffix:semicolon
id|irq
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|mask
op_assign
l_int|0x00000010
suffix:semicolon
id|irq
op_assign
l_int|4
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|pend
op_amp
l_int|0x00000f00
)paren
(brace
id|mask
op_assign
l_int|0x00000100
suffix:semicolon
id|irq
op_assign
l_int|8
suffix:semicolon
)brace
r_else
(brace
id|mask
op_assign
l_int|0x00001000
suffix:semicolon
id|irq
op_assign
l_int|12
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|pend
op_amp
l_int|0x00ff0000
)paren
(brace
r_if
c_cond
(paren
id|pend
op_amp
l_int|0x000f0000
)paren
(brace
id|mask
op_assign
l_int|0x00010000
suffix:semicolon
id|irq
op_assign
l_int|16
suffix:semicolon
)brace
r_else
(brace
id|mask
op_assign
l_int|0x00100000
suffix:semicolon
id|irq
op_assign
l_int|20
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|pend
op_amp
l_int|0x0f000000
)paren
(brace
id|mask
op_assign
l_int|0x01000000
suffix:semicolon
id|irq
op_assign
l_int|24
suffix:semicolon
)brace
r_else
(brace
id|mask
op_assign
l_int|0x10000000
suffix:semicolon
id|irq
op_assign
l_int|28
suffix:semicolon
)brace
)brace
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|mask
op_amp
id|pend
)paren
)paren
(brace
id|mask
op_lshift_assign
l_int|1
suffix:semicolon
id|irq
op_increment
suffix:semicolon
)brace
id|kstat_cpu
c_func
(paren
l_int|0
)paren
dot
id|irqs
(braket
id|irq
)braket
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|int_irq_list
(braket
id|irq
)braket
dot
id|handler
)paren
(brace
id|int_irq_list
(braket
id|irq
)braket
dot
id|handler
c_func
(paren
id|irq
comma
id|int_irq_list
(braket
id|irq
)braket
dot
id|dev_id
comma
id|fp
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;unregistered interrupt %d!&bslash;nTurning it off in the IMR...&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
id|IMR
op_or_assign
id|mask
suffix:semicolon
)brace
id|pend
op_and_assign
op_complement
id|mask
suffix:semicolon
)brace
)brace
eof
