multiline_comment|/*&n; *&t;linux/arch/alpha/kernel/core_marvel.c&n; *&n; * Code common to all Marvel based systems.&n; */
macro_line|#include &lt;linux/config.h&gt;
DECL|macro|__EXTERN_INLINE
mdefine_line|#define __EXTERN_INLINE inline
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/core_marvel.h&gt;
DECL|macro|__EXTERN_INLINE
macro_line|#undef __EXTERN_INLINE
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/mc146818rtc.h&gt;
macro_line|#include &lt;linux/rtc.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/smp.h&gt;
macro_line|#include &lt;asm/hwrpb.h&gt;
macro_line|#include &lt;asm/gct.h&gt;
macro_line|#include &lt;asm/pgalloc.h&gt;
macro_line|#include &lt;asm/tlbflush.h&gt;
macro_line|#include &lt;asm/rtc.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &quot;proto.h&quot;
macro_line|#include &quot;pci_impl.h&quot;
"&f;"
multiline_comment|/*&n; * Debug helpers&n; */
DECL|macro|DEBUG_CONFIG
mdefine_line|#define DEBUG_CONFIG 0
macro_line|#if DEBUG_CONFIG
DECL|macro|DBG_CFG
macro_line|# define DBG_CFG(args) printk args
macro_line|#else
DECL|macro|DBG_CFG
macro_line|# define DBG_CFG(args)
macro_line|#endif
"&f;"
multiline_comment|/*&n; * Private data&n; */
DECL|variable|io7_head
r_static
r_struct
id|io7
op_star
id|io7_head
op_assign
l_int|NULL
suffix:semicolon
"&f;"
multiline_comment|/*&n; * Helper functions&n; */
r_static
r_int
r_int
id|__attribute__
(paren
(paren
id|unused
)paren
)paren
DECL|function|read_ev7_csr
id|read_ev7_csr
c_func
(paren
r_int
id|pe
comma
r_int
r_int
id|offset
)paren
(brace
id|ev7_csr
op_star
id|ev7csr
op_assign
id|EV7_CSR_KERN
c_func
(paren
id|pe
comma
id|offset
)paren
suffix:semicolon
r_int
r_int
id|q
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|q
op_assign
id|ev7csr-&gt;csr
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
r_return
id|q
suffix:semicolon
)brace
r_static
r_void
id|__attribute__
(paren
(paren
id|unused
)paren
)paren
DECL|function|write_ev7_csr
id|write_ev7_csr
c_func
(paren
r_int
id|pe
comma
r_int
r_int
id|offset
comma
r_int
r_int
id|q
)paren
(brace
id|ev7_csr
op_star
id|ev7csr
op_assign
id|EV7_CSR_KERN
c_func
(paren
id|pe
comma
id|offset
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|ev7csr-&gt;csr
op_assign
id|q
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_char
op_star
id|__init
DECL|function|mk_resource_name
id|mk_resource_name
c_func
(paren
r_int
id|pe
comma
r_int
id|port
comma
r_char
op_star
id|str
)paren
(brace
r_char
id|tmp
(braket
l_int|80
)braket
suffix:semicolon
r_char
op_star
id|name
suffix:semicolon
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;PCI %s PE %d PORT %d&quot;
comma
id|str
comma
id|pe
comma
id|port
)paren
suffix:semicolon
id|name
op_assign
id|alloc_bootmem
c_func
(paren
id|strlen
c_func
(paren
id|tmp
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|name
comma
id|tmp
)paren
suffix:semicolon
r_return
id|name
suffix:semicolon
)brace
r_inline
r_struct
id|io7
op_star
DECL|function|marvel_next_io7
id|marvel_next_io7
c_func
(paren
r_struct
id|io7
op_star
id|prev
)paren
(brace
r_return
(paren
id|prev
ques
c_cond
id|prev-&gt;next
suffix:colon
id|io7_head
)paren
suffix:semicolon
)brace
r_struct
id|io7
op_star
DECL|function|marvel_find_io7
id|marvel_find_io7
c_func
(paren
r_int
id|pe
)paren
(brace
r_struct
id|io7
op_star
id|io7
suffix:semicolon
r_for
c_loop
(paren
id|io7
op_assign
id|io7_head
suffix:semicolon
id|io7
op_logical_and
id|io7-&gt;pe
op_ne
id|pe
suffix:semicolon
id|io7
op_assign
id|io7-&gt;next
)paren
r_continue
suffix:semicolon
r_return
id|io7
suffix:semicolon
)brace
r_static
r_struct
id|io7
op_star
id|__init
DECL|function|alloc_io7
id|alloc_io7
c_func
(paren
r_int
r_int
id|pe
)paren
(brace
r_struct
id|io7
op_star
id|io7
suffix:semicolon
r_struct
id|io7
op_star
id|insp
suffix:semicolon
r_int
id|h
suffix:semicolon
r_if
c_cond
(paren
id|marvel_find_io7
c_func
(paren
id|pe
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;IO7 at PE %d already allocated!&bslash;n&quot;
comma
id|pe
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|io7
op_assign
id|alloc_bootmem
c_func
(paren
r_sizeof
(paren
op_star
id|io7
)paren
)paren
suffix:semicolon
id|io7-&gt;pe
op_assign
id|pe
suffix:semicolon
id|io7-&gt;irq_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
r_for
c_loop
(paren
id|h
op_assign
l_int|0
suffix:semicolon
id|h
OL
l_int|4
suffix:semicolon
id|h
op_increment
)paren
(brace
id|io7-&gt;ports
(braket
id|h
)braket
dot
id|io7
op_assign
id|io7
suffix:semicolon
id|io7-&gt;ports
(braket
id|h
)braket
dot
id|port
op_assign
id|h
suffix:semicolon
id|io7-&gt;ports
(braket
id|h
)braket
dot
id|enabled
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* default to disabled */
)brace
multiline_comment|/*&n;&t; * Insert in pe sorted order.&n;&t; */
r_if
c_cond
(paren
l_int|NULL
op_eq
id|io7_head
)paren
multiline_comment|/* empty list */
id|io7_head
op_assign
id|io7
suffix:semicolon
r_else
r_if
c_cond
(paren
id|io7_head-&gt;pe
OG
id|io7-&gt;pe
)paren
(brace
multiline_comment|/* insert at head */
id|io7-&gt;next
op_assign
id|io7_head
suffix:semicolon
id|io7_head
op_assign
id|io7
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* insert at position */
r_for
c_loop
(paren
id|insp
op_assign
id|io7_head
suffix:semicolon
id|insp
suffix:semicolon
id|insp
op_assign
id|insp-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|insp-&gt;pe
op_eq
id|io7-&gt;pe
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Too many IO7s at PE %d&bslash;n&quot;
comma
id|io7-&gt;pe
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|NULL
op_eq
id|insp-&gt;next
op_logical_or
id|insp-&gt;next-&gt;pe
OG
id|io7-&gt;pe
)paren
(brace
multiline_comment|/* insert here */
id|io7-&gt;next
op_assign
id|insp-&gt;next
suffix:semicolon
id|insp-&gt;next
op_assign
id|io7
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
l_int|NULL
op_eq
id|insp
)paren
(brace
multiline_comment|/* couldn&squot;t insert ?!? */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Failed to insert IO7 at PE %d &quot;
l_string|&quot; - adding at head of list&bslash;n&quot;
comma
id|io7-&gt;pe
)paren
suffix:semicolon
id|io7-&gt;next
op_assign
id|io7_head
suffix:semicolon
id|io7_head
op_assign
id|io7
suffix:semicolon
)brace
)brace
r_return
id|io7
suffix:semicolon
)brace
r_void
DECL|function|io7_clear_errors
id|io7_clear_errors
c_func
(paren
r_struct
id|io7
op_star
id|io7
)paren
(brace
id|io7_port7_csrs
op_star
id|p7csrs
suffix:semicolon
id|io7_ioport_csrs
op_star
id|csrs
suffix:semicolon
r_int
id|port
suffix:semicolon
multiline_comment|/*&n;&t; * First the IO ports.&n;&t; */
r_for
c_loop
(paren
id|port
op_assign
l_int|0
suffix:semicolon
id|port
OL
l_int|4
suffix:semicolon
id|port
op_increment
)paren
(brace
id|csrs
op_assign
id|IO7_CSRS_KERN
c_func
(paren
id|io7-&gt;pe
comma
id|port
)paren
suffix:semicolon
id|csrs-&gt;POx_ERR_SUM.csr
op_assign
op_minus
l_int|1UL
suffix:semicolon
id|csrs-&gt;POx_TLB_ERR.csr
op_assign
op_minus
l_int|1UL
suffix:semicolon
id|csrs-&gt;POx_SPL_COMPLT.csr
op_assign
op_minus
l_int|1UL
suffix:semicolon
id|csrs-&gt;POx_TRANS_SUM.csr
op_assign
op_minus
l_int|1UL
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Then the common ones.&n;&t; */
id|p7csrs
op_assign
id|IO7_PORT7_CSRS_KERN
c_func
(paren
id|io7-&gt;pe
)paren
suffix:semicolon
id|p7csrs-&gt;PO7_ERROR_SUM.csr
op_assign
op_minus
l_int|1UL
suffix:semicolon
id|p7csrs-&gt;PO7_UNCRR_SYM.csr
op_assign
op_minus
l_int|1UL
suffix:semicolon
id|p7csrs-&gt;PO7_CRRCT_SYM.csr
op_assign
op_minus
l_int|1UL
suffix:semicolon
)brace
"&f;"
multiline_comment|/*&n; * IO7 PCI, PCI/X, AGP configuration.&n; */
r_static
r_void
id|__init
DECL|function|io7_init_hose
id|io7_init_hose
c_func
(paren
r_struct
id|io7
op_star
id|io7
comma
r_int
id|port
)paren
(brace
r_static
r_int
id|hose_index
op_assign
l_int|0
suffix:semicolon
r_struct
id|pci_controller
op_star
id|hose
op_assign
id|alloc_pci_controller
c_func
(paren
)paren
suffix:semicolon
r_struct
id|io7_port
op_star
id|io7_port
op_assign
op_amp
id|io7-&gt;ports
(braket
id|port
)braket
suffix:semicolon
id|io7_ioport_csrs
op_star
id|csrs
op_assign
id|IO7_CSRS_KERN
c_func
(paren
id|io7-&gt;pe
comma
id|port
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
id|hose-&gt;index
op_assign
id|hose_index
op_increment
suffix:semicolon
multiline_comment|/* arbitrary */
multiline_comment|/*&n;&t; * We don&squot;t have an isa or legacy hose, but glibc expects to be&n;&t; * able to use the bus == 0 / dev == 0 form of the iobase syscall&n;&t; * to determine information about the i/o system. Since XFree86 &n;&t; * relies on glibc&squot;s determination to tell whether or not to use&n;&t; * sparse access, we need to point the pci_isa_hose at a real hose&n;&t; * so at least that determination is correct.&n;&t; */
r_if
c_cond
(paren
id|hose-&gt;index
op_eq
l_int|0
)paren
id|pci_isa_hose
op_assign
id|hose
suffix:semicolon
id|io7_port-&gt;csrs
op_assign
id|csrs
suffix:semicolon
id|io7_port-&gt;hose
op_assign
id|hose
suffix:semicolon
id|hose-&gt;sysdata
op_assign
id|io7_port
suffix:semicolon
id|hose-&gt;io_space
op_assign
id|alloc_resource
c_func
(paren
)paren
suffix:semicolon
id|hose-&gt;mem_space
op_assign
id|alloc_resource
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Base addresses for userland consumption. Since these are going&n;&t; * to be mapped, they are pure physical addresses.&n;&t; */
id|hose-&gt;sparse_mem_base
op_assign
id|hose-&gt;sparse_io_base
op_assign
l_int|0
suffix:semicolon
id|hose-&gt;dense_mem_base
op_assign
id|IO7_MEM_PHYS
c_func
(paren
id|io7-&gt;pe
comma
id|port
)paren
suffix:semicolon
id|hose-&gt;dense_io_base
op_assign
id|IO7_IO_PHYS
c_func
(paren
id|io7-&gt;pe
comma
id|port
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Base addresses and resource ranges for kernel consumption.&n;&t; */
id|hose-&gt;config_space_base
op_assign
(paren
r_int
r_int
)paren
id|IO7_CONF_KERN
c_func
(paren
id|io7-&gt;pe
comma
id|port
)paren
suffix:semicolon
id|hose-&gt;io_space-&gt;start
op_assign
(paren
r_int
r_int
)paren
id|IO7_IO_KERN
c_func
(paren
id|io7-&gt;pe
comma
id|port
)paren
suffix:semicolon
id|hose-&gt;io_space-&gt;end
op_assign
id|hose-&gt;io_space-&gt;start
op_plus
id|IO7_IO_SPACE
op_minus
l_int|1
suffix:semicolon
id|hose-&gt;io_space-&gt;name
op_assign
id|mk_resource_name
c_func
(paren
id|io7-&gt;pe
comma
id|port
comma
l_string|&quot;IO&quot;
)paren
suffix:semicolon
id|hose-&gt;io_space-&gt;flags
op_assign
id|IORESOURCE_IO
suffix:semicolon
id|hose-&gt;mem_space-&gt;start
op_assign
(paren
r_int
r_int
)paren
id|IO7_MEM_KERN
c_func
(paren
id|io7-&gt;pe
comma
id|port
)paren
suffix:semicolon
id|hose-&gt;mem_space-&gt;end
op_assign
id|hose-&gt;mem_space-&gt;start
op_plus
id|IO7_MEM_SPACE
op_minus
l_int|1
suffix:semicolon
id|hose-&gt;mem_space-&gt;name
op_assign
id|mk_resource_name
c_func
(paren
id|io7-&gt;pe
comma
id|port
comma
l_string|&quot;MEM&quot;
)paren
suffix:semicolon
id|hose-&gt;mem_space-&gt;flags
op_assign
id|IORESOURCE_MEM
suffix:semicolon
r_if
c_cond
(paren
id|request_resource
c_func
(paren
op_amp
id|ioport_resource
comma
id|hose-&gt;io_space
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Failed to request IO on hose %d&bslash;n&quot;
comma
id|hose-&gt;index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_resource
c_func
(paren
op_amp
id|iomem_resource
comma
id|hose-&gt;mem_space
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Failed to request MEM on hose %d&bslash;n&quot;
comma
id|hose-&gt;index
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Save the existing DMA window settings for later restoration.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|io7_port-&gt;saved_wbase
(braket
id|i
)braket
op_assign
id|csrs-&gt;POx_WBASE
(braket
id|i
)braket
dot
id|csr
suffix:semicolon
id|io7_port-&gt;saved_wmask
(braket
id|i
)braket
op_assign
id|csrs-&gt;POx_WMASK
(braket
id|i
)braket
dot
id|csr
suffix:semicolon
id|io7_port-&gt;saved_tbase
(braket
id|i
)braket
op_assign
id|csrs-&gt;POx_TBASE
(braket
id|i
)braket
dot
id|csr
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Set up the PCI to main memory translation windows.&n;&t; *&n;&t; * Window 0 is scatter-gather 8MB at 8MB&n;&t; * Window 1 is direct access 1GB at 2GB&n;&t; * Window 2 is scatter-gather (up-to) 1GB at 3GB&n;&t; * Window 3 is disabled&n;&t; */
multiline_comment|/*&n;&t; * TBIA before modifying windows.&n;&t; */
id|marvel_pci_tbi
c_func
(paren
id|hose
comma
l_int|0
comma
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set up window 0 for scatter-gather 8MB at 8MB.&n;&t; */
id|hose-&gt;sg_isa
op_assign
id|iommu_arena_new_node
c_func
(paren
id|marvel_cpuid_to_nid
c_func
(paren
id|io7-&gt;pe
)paren
comma
id|hose
comma
l_int|0x00800000
comma
l_int|0x00800000
comma
l_int|0
)paren
suffix:semicolon
id|hose-&gt;sg_isa-&gt;align_entry
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* cache line boundary */
id|csrs-&gt;POx_WBASE
(braket
l_int|0
)braket
dot
id|csr
op_assign
id|hose-&gt;sg_isa-&gt;dma_base
op_or
id|wbase_m_ena
op_or
id|wbase_m_sg
suffix:semicolon
id|csrs-&gt;POx_WMASK
(braket
l_int|0
)braket
dot
id|csr
op_assign
(paren
id|hose-&gt;sg_isa-&gt;size
op_minus
l_int|1
)paren
op_amp
id|wbase_m_addr
suffix:semicolon
id|csrs-&gt;POx_TBASE
(braket
l_int|0
)braket
dot
id|csr
op_assign
id|virt_to_phys
c_func
(paren
id|hose-&gt;sg_isa-&gt;ptes
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set up window 1 for direct-mapped 1GB at 2GB.&n;&t; */
id|csrs-&gt;POx_WBASE
(braket
l_int|1
)braket
dot
id|csr
op_assign
id|__direct_map_base
op_or
id|wbase_m_ena
suffix:semicolon
id|csrs-&gt;POx_WMASK
(braket
l_int|1
)braket
dot
id|csr
op_assign
(paren
id|__direct_map_size
op_minus
l_int|1
)paren
op_amp
id|wbase_m_addr
suffix:semicolon
id|csrs-&gt;POx_TBASE
(braket
l_int|1
)braket
dot
id|csr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Set up window 2 for scatter-gather (up-to) 1GB at 3GB.&n;&t; */
id|hose-&gt;sg_pci
op_assign
id|iommu_arena_new_node
c_func
(paren
id|marvel_cpuid_to_nid
c_func
(paren
id|io7-&gt;pe
)paren
comma
id|hose
comma
l_int|0xc0000000
comma
l_int|0x40000000
comma
l_int|0
)paren
suffix:semicolon
id|hose-&gt;sg_pci-&gt;align_entry
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* cache line boundary */
id|csrs-&gt;POx_WBASE
(braket
l_int|2
)braket
dot
id|csr
op_assign
id|hose-&gt;sg_pci-&gt;dma_base
op_or
id|wbase_m_ena
op_or
id|wbase_m_sg
suffix:semicolon
id|csrs-&gt;POx_WMASK
(braket
l_int|2
)braket
dot
id|csr
op_assign
(paren
id|hose-&gt;sg_pci-&gt;size
op_minus
l_int|1
)paren
op_amp
id|wbase_m_addr
suffix:semicolon
id|csrs-&gt;POx_TBASE
(braket
l_int|2
)braket
dot
id|csr
op_assign
id|virt_to_phys
c_func
(paren
id|hose-&gt;sg_pci-&gt;ptes
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Disable window 3.&n;&t; */
id|csrs-&gt;POx_WBASE
(braket
l_int|3
)braket
dot
id|csr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Make sure that the AGP Monster Window is disabled.&n;&t; */
id|csrs-&gt;POx_CTRL.csr
op_and_assign
op_complement
(paren
l_int|1UL
op_lshift
l_int|61
)paren
suffix:semicolon
macro_line|#if 1
id|printk
c_func
(paren
l_string|&quot;FIXME: disabling master aborts&bslash;n&quot;
)paren
suffix:semicolon
id|csrs-&gt;POx_MSK_HEI.csr
op_and_assign
op_complement
(paren
l_int|3UL
op_lshift
l_int|14
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * TBIA after modifying windows.&n;&t; */
id|marvel_pci_tbi
c_func
(paren
id|hose
comma
l_int|0
comma
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_static
r_void
id|__init
DECL|function|marvel_init_io7
id|marvel_init_io7
c_func
(paren
r_struct
id|io7
op_star
id|io7
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Initializing IO7 at PID %d&bslash;n&quot;
comma
id|io7-&gt;pe
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Get the Port 7 CSR pointer.&n;&t; */
id|io7-&gt;csrs
op_assign
id|IO7_PORT7_CSRS_KERN
c_func
(paren
id|io7-&gt;pe
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Init this IO7&squot;s hoses.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IO7_NUM_PORTS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|io7_ioport_csrs
op_star
id|csrs
op_assign
id|IO7_CSRS_KERN
c_func
(paren
id|io7-&gt;pe
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csrs-&gt;POx_CACHE_CTL.csr
op_eq
l_int|8
)paren
(brace
id|io7-&gt;ports
(braket
id|i
)braket
dot
id|enabled
op_assign
l_int|1
suffix:semicolon
id|io7_init_hose
c_func
(paren
id|io7
comma
id|i
)paren
suffix:semicolon
)brace
)brace
)brace
r_void
DECL|function|marvel_io7_present
id|marvel_io7_present
c_func
(paren
id|gct6_node
op_star
id|node
)paren
(brace
r_int
id|pe
suffix:semicolon
r_if
c_cond
(paren
id|node-&gt;type
op_ne
id|GCT_TYPE_HOSE
op_logical_or
id|node-&gt;subtype
op_ne
id|GCT_SUBTYPE_IO_PORT_MODULE
)paren
r_return
suffix:semicolon
id|pe
op_assign
(paren
id|node-&gt;id
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Found an IO7 at PID %d&bslash;n&quot;
comma
id|pe
)paren
suffix:semicolon
id|alloc_io7
c_func
(paren
id|pe
)paren
suffix:semicolon
)brace
r_static
r_void
id|__init
DECL|function|marvel_init_vga_hose
id|marvel_init_vga_hose
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_VGA_HOSE
id|u64
op_star
id|pu64
op_assign
(paren
id|u64
op_star
)paren
(paren
(paren
id|u64
)paren
id|hwrpb
op_plus
id|hwrpb-&gt;ctbt_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pu64
(braket
l_int|7
)braket
op_eq
l_int|3
)paren
(brace
multiline_comment|/* TERM_TYPE == graphics */
r_struct
id|pci_controller
op_star
id|hose
op_assign
l_int|NULL
suffix:semicolon
r_int
id|h
op_assign
(paren
id|pu64
(braket
l_int|30
)braket
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
suffix:semicolon
multiline_comment|/* TERM_OUT_LOC, hose # */
r_struct
id|io7
op_star
id|io7
suffix:semicolon
r_int
id|pid
comma
id|port
suffix:semicolon
multiline_comment|/* FIXME - encoding is going to have to change for Marvel&n;&t;&t; *         since hose will be able to overflow a byte...&n;&t;&t; *         need to fix this decode when the console &n;&t;&t; *         changes its encoding&n;&t;&t; */
id|printk
c_func
(paren
l_string|&quot;console graphics is on hose %d (console)&bslash;n&quot;
comma
id|h
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * The console&squot;s hose numbering is:&n;&t;&t; *&n;&t;&t; *&t;hose&lt;n:2&gt;: PID&n;&t;&t; *&t;hose&lt;1:0&gt;: PORT&n;&t;&t; *&n;&t;&t; * We need to find the hose at that pid and port&n;&t;&t; */
id|pid
op_assign
id|h
op_rshift
l_int|2
suffix:semicolon
id|port
op_assign
id|h
op_amp
l_int|3
suffix:semicolon
r_if
c_cond
(paren
(paren
id|io7
op_assign
id|marvel_find_io7
c_func
(paren
id|pid
)paren
)paren
)paren
id|hose
op_assign
id|io7-&gt;ports
(braket
id|port
)braket
dot
id|hose
suffix:semicolon
r_if
c_cond
(paren
id|hose
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Console graphics on hose %d&bslash;n&quot;
comma
id|hose-&gt;index
)paren
suffix:semicolon
id|pci_vga_hose
op_assign
id|hose
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_VGA_HOSE */
)brace
DECL|variable|gct_wanted_node_list
id|gct6_search_struct
id|gct_wanted_node_list
(braket
)braket
op_assign
(brace
(brace
id|GCT_TYPE_HOSE
comma
id|GCT_SUBTYPE_IO_PORT_MODULE
comma
id|marvel_io7_present
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|NULL
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; * In case the GCT is not complete, let the user specify PIDs with IO7s&n; * at boot time. Syntax is &squot;io7=a,b,c,...,n&squot; where a-n are the PIDs (decimal)&n; * where IO7s are connected&n; */
r_static
r_int
id|__init
DECL|function|marvel_specify_io7
id|marvel_specify_io7
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_int
r_int
id|pid
suffix:semicolon
r_struct
id|io7
op_star
id|io7
suffix:semicolon
r_char
op_star
id|pchar
suffix:semicolon
r_do
(brace
id|pid
op_assign
id|simple_strtoul
c_func
(paren
id|str
comma
op_amp
id|pchar
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pchar
op_ne
id|str
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;User-specified IO7 at PID %lu&bslash;n&quot;
comma
id|pid
)paren
suffix:semicolon
id|io7
op_assign
id|alloc_io7
c_func
(paren
id|pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|io7
)paren
id|marvel_init_io7
c_func
(paren
id|io7
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pchar
op_eq
id|str
)paren
id|pchar
op_increment
suffix:semicolon
id|str
op_assign
id|pchar
suffix:semicolon
)brace
r_while
c_loop
(paren
op_star
id|str
)paren
(brace
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;io7=&quot;
comma
id|marvel_specify_io7
)paren
suffix:semicolon
r_void
id|__init
DECL|function|marvel_init_arch
id|marvel_init_arch
c_func
(paren
r_void
)paren
(brace
r_struct
id|io7
op_star
id|io7
suffix:semicolon
multiline_comment|/* With multiple PCI busses, we play with I/O as physical addrs.  */
id|ioport_resource.end
op_assign
op_complement
l_int|0UL
suffix:semicolon
id|iomem_resource.end
op_assign
op_complement
l_int|0UL
suffix:semicolon
multiline_comment|/* PCI DMA Direct Mapping is 1GB at 2GB.  */
id|__direct_map_base
op_assign
l_int|0x80000000
suffix:semicolon
id|__direct_map_size
op_assign
l_int|0x40000000
suffix:semicolon
multiline_comment|/* Parse the config tree.  */
id|gct6_find_nodes
c_func
(paren
id|GCT_NODE_PTR
c_func
(paren
l_int|0
)paren
comma
id|gct_wanted_node_list
)paren
suffix:semicolon
multiline_comment|/* Init the io7s.  */
r_for
c_loop
(paren
id|io7
op_assign
l_int|NULL
suffix:semicolon
l_int|NULL
op_ne
(paren
id|io7
op_assign
id|marvel_next_io7
c_func
(paren
id|io7
)paren
)paren
suffix:semicolon
)paren
id|marvel_init_io7
c_func
(paren
id|io7
)paren
suffix:semicolon
multiline_comment|/* Check for graphic console location (if any).  */
id|marvel_init_vga_hose
c_func
(paren
)paren
suffix:semicolon
)brace
r_void
DECL|function|marvel_kill_arch
id|marvel_kill_arch
c_func
(paren
r_int
id|mode
)paren
(brace
)brace
"&f;"
multiline_comment|/*&n; * PCI Configuration Space access functions&n; *&n; * Configuration space addresses have the following format:&n; *&n; * &t;|2 2 2 2|1 1 1 1|1 1 1 1|1 1 &n; * &t;|3 2 1 0|9 8 7 6|5 4 3 2|1 0 9 8|7 6 5 4|3 2 1 0&n; * &t;+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n; * &t;|B|B|B|B|B|B|B|B|D|D|D|D|D|F|F|F|R|R|R|R|R|R|R|R|&n; * &t;+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n; *&n; *&t; n:24&t;reserved for hose base&n; *&t;23:16&t;bus number (8 bits = 128 possible buses)&n; *&t;15:11&t;Device number (5 bits)&n; *&t;10:8&t;function number&n; *&t; 7:2&t;register number&n; *  &n; * Notes:&n; *&t;IO7 determines whether to use a type 0 or type 1 config cycle&n; *&t;based on the bus number. Therefore the bus number must be set &n; *&t;to 0 for the root bus on any hose.&n; *&t;&n; *&t;The function number selects which function of a multi-function device &n; *&t;(e.g., SCSI and Ethernet).&n; * &n; */
r_static
r_inline
r_int
r_int
DECL|function|build_conf_addr
id|build_conf_addr
c_func
(paren
r_struct
id|pci_controller
op_star
id|hose
comma
id|u8
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
)paren
(brace
r_return
(paren
id|hose-&gt;config_space_base
op_or
(paren
id|bus
op_lshift
l_int|16
)paren
op_or
(paren
id|devfn
op_lshift
l_int|8
)paren
op_or
id|where
)paren
suffix:semicolon
)brace
r_static
r_int
r_int
DECL|function|mk_conf_addr
id|mk_conf_addr
c_func
(paren
r_struct
id|pci_bus
op_star
id|pbus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
)paren
(brace
r_struct
id|pci_controller
op_star
id|hose
op_assign
id|pbus-&gt;sysdata
suffix:semicolon
r_struct
id|io7_port
op_star
id|io7_port
suffix:semicolon
r_int
r_int
id|addr
op_assign
l_int|0
suffix:semicolon
id|u8
id|bus
op_assign
id|pbus-&gt;number
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hose
)paren
r_return
id|addr
suffix:semicolon
multiline_comment|/* Check for enabled.  */
id|io7_port
op_assign
id|hose-&gt;sysdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|io7_port-&gt;enabled
)paren
r_return
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|hose-&gt;first_busno
op_eq
id|bus
)paren
(brace
multiline_comment|/* Don&squot;t support idsel &gt; 20 on primary bus.  */
r_if
c_cond
(paren
id|devfn
op_ge
id|PCI_DEVFN
c_func
(paren
l_int|21
comma
l_int|0
)paren
)paren
r_return
id|addr
suffix:semicolon
id|bus
op_assign
l_int|0
suffix:semicolon
)brace
id|addr
op_assign
id|build_conf_addr
c_func
(paren
id|hose
comma
id|bus
comma
id|devfn
comma
id|where
)paren
suffix:semicolon
id|DBG_CFG
c_func
(paren
(paren
l_string|&quot;mk_conf_addr: returning pci_addr 0x%lx&bslash;n&quot;
comma
id|addr
)paren
)paren
suffix:semicolon
r_return
id|addr
suffix:semicolon
)brace
r_static
r_int
DECL|function|marvel_read_config
id|marvel_read_config
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
op_star
id|value
)paren
(brace
r_int
r_int
id|addr
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
(paren
id|addr
op_assign
id|mk_conf_addr
c_func
(paren
id|bus
comma
id|devfn
comma
id|where
)paren
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
l_int|1
suffix:colon
op_star
id|value
op_assign
id|__kernel_ldbu
c_func
(paren
op_star
(paren
id|vucp
)paren
id|addr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
op_star
id|value
op_assign
id|__kernel_ldwu
c_func
(paren
op_star
(paren
id|vusp
)paren
id|addr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
op_star
id|value
op_assign
op_star
(paren
id|vuip
)paren
id|addr
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|PCIBIOS_FUNC_NOT_SUPPORTED
suffix:semicolon
)brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
r_static
r_int
DECL|function|marvel_write_config
id|marvel_write_config
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
id|value
)paren
(brace
r_int
r_int
id|addr
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
(paren
id|addr
op_assign
id|mk_conf_addr
c_func
(paren
id|bus
comma
id|devfn
comma
id|where
)paren
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
l_int|1
suffix:colon
id|__kernel_stb
c_func
(paren
id|value
comma
op_star
(paren
id|vucp
)paren
id|addr
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|__kernel_ldbu
c_func
(paren
op_star
(paren
id|vucp
)paren
id|addr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|__kernel_stw
c_func
(paren
id|value
comma
op_star
(paren
id|vusp
)paren
id|addr
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|__kernel_ldwu
c_func
(paren
op_star
(paren
id|vusp
)paren
id|addr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
op_star
(paren
id|vuip
)paren
id|addr
op_assign
id|value
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
op_star
(paren
id|vuip
)paren
id|addr
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|PCIBIOS_FUNC_NOT_SUPPORTED
suffix:semicolon
)brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|variable|marvel_pci_ops
r_struct
id|pci_ops
id|marvel_pci_ops
op_assign
(brace
dot
id|read
op_assign
id|marvel_read_config
comma
dot
id|write
op_assign
id|marvel_write_config
comma
)brace
suffix:semicolon
"&f;"
multiline_comment|/*&n; * Other PCI helper functions.&n; */
r_void
DECL|function|marvel_pci_tbi
id|marvel_pci_tbi
c_func
(paren
r_struct
id|pci_controller
op_star
id|hose
comma
id|dma_addr_t
id|start
comma
id|dma_addr_t
id|end
)paren
(brace
id|io7_ioport_csrs
op_star
id|csrs
op_assign
(paren
(paren
r_struct
id|io7_port
op_star
)paren
id|hose-&gt;sysdata
)paren
op_member_access_from_pointer
id|csrs
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|csrs-&gt;POx_SG_TBIA.csr
op_assign
l_int|0
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|csrs-&gt;POx_SG_TBIA.csr
suffix:semicolon
)brace
"&f;"
multiline_comment|/*&n; * IO map support.&n; */
r_int
r_int
DECL|function|marvel_ioremap
id|marvel_ioremap
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|size
)paren
(brace
r_struct
id|pci_controller
op_star
id|hose
suffix:semicolon
r_int
r_int
id|baddr
comma
id|last
suffix:semicolon
r_struct
id|vm_struct
op_star
id|area
suffix:semicolon
r_int
r_int
id|vaddr
suffix:semicolon
r_int
r_int
op_star
id|ptes
suffix:semicolon
r_int
r_int
id|pfn
suffix:semicolon
multiline_comment|/*&n;&t; * Adjust the addr.&n;&t; */
macro_line|#ifdef CONFIG_VGA_HOSE
r_if
c_cond
(paren
id|pci_vga_hose
op_logical_and
id|__marvel_is_mem_vga
c_func
(paren
id|addr
)paren
)paren
(brace
id|addr
op_add_assign
id|pci_vga_hose-&gt;mem_space-&gt;start
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|marvel_is_ioaddr
c_func
(paren
id|addr
)paren
)paren
r_return
l_int|0UL
suffix:semicolon
multiline_comment|/*&n;&t; * Find the hose.&n;&t; */
r_for
c_loop
(paren
id|hose
op_assign
id|hose_head
suffix:semicolon
id|hose
suffix:semicolon
id|hose
op_assign
id|hose-&gt;next
)paren
(brace
r_if
c_cond
(paren
(paren
id|addr
op_rshift
l_int|32
)paren
op_eq
(paren
id|hose-&gt;mem_space-&gt;start
op_rshift
l_int|32
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|hose
)paren
r_return
l_int|0UL
suffix:semicolon
multiline_comment|/*&n;&t; * We have the hose - calculate the bus limits.&n;&t; */
id|baddr
op_assign
id|addr
op_minus
id|hose-&gt;mem_space-&gt;start
suffix:semicolon
id|last
op_assign
id|baddr
op_plus
id|size
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Is it direct-mapped?&n;&t; */
r_if
c_cond
(paren
(paren
id|baddr
op_ge
id|__direct_map_base
)paren
op_logical_and
(paren
(paren
id|baddr
op_plus
id|size
op_minus
l_int|1
)paren
OL
id|__direct_map_base
op_plus
id|__direct_map_size
)paren
)paren
r_return
id|IDENT_ADDR
op_or
(paren
id|baddr
op_minus
id|__direct_map_base
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Check the scatter-gather arena.&n;&t; */
r_if
c_cond
(paren
id|hose-&gt;sg_pci
op_logical_and
id|baddr
op_ge
(paren
r_int
r_int
)paren
id|hose-&gt;sg_pci-&gt;dma_base
op_logical_and
id|last
OL
(paren
r_int
r_int
)paren
id|hose-&gt;sg_pci-&gt;dma_base
op_plus
id|hose-&gt;sg_pci-&gt;size
)paren
(brace
multiline_comment|/*&n;&t;&t; * Adjust the limits (mappings must be page aligned)&n;&t;&t; */
id|baddr
op_sub_assign
id|hose-&gt;sg_pci-&gt;dma_base
suffix:semicolon
id|last
op_sub_assign
id|hose-&gt;sg_pci-&gt;dma_base
suffix:semicolon
id|baddr
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|size
op_assign
id|PAGE_ALIGN
c_func
(paren
id|last
)paren
op_minus
id|baddr
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Map it.&n;&t;&t; */
id|area
op_assign
id|get_vm_area
c_func
(paren
id|size
comma
id|VM_IOREMAP
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|area
)paren
r_return
(paren
r_int
r_int
)paren
l_int|NULL
suffix:semicolon
id|ptes
op_assign
id|hose-&gt;sg_pci-&gt;ptes
suffix:semicolon
r_for
c_loop
(paren
id|vaddr
op_assign
(paren
r_int
r_int
)paren
id|area-&gt;addr
suffix:semicolon
id|baddr
op_le
id|last
suffix:semicolon
id|baddr
op_add_assign
id|PAGE_SIZE
comma
id|vaddr
op_add_assign
id|PAGE_SIZE
)paren
(brace
id|pfn
op_assign
id|ptes
(braket
id|baddr
op_rshift
id|PAGE_SHIFT
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pfn
op_amp
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ioremap failed... pte not valid...&bslash;n&quot;
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|area-&gt;addr
)paren
suffix:semicolon
r_return
l_int|0UL
suffix:semicolon
)brace
id|pfn
op_rshift_assign
l_int|1
suffix:semicolon
multiline_comment|/* make it a true pfn */
r_if
c_cond
(paren
id|__alpha_remap_area_pages
c_func
(paren
id|VMALLOC_VMADDR
c_func
(paren
id|vaddr
)paren
comma
id|pfn
op_lshift
id|PAGE_SHIFT
comma
id|PAGE_SIZE
comma
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;FAILED to map...&bslash;n&quot;
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|area-&gt;addr
)paren
suffix:semicolon
r_return
l_int|0UL
suffix:semicolon
)brace
)brace
id|flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
id|vaddr
op_assign
(paren
r_int
r_int
)paren
id|area-&gt;addr
op_plus
(paren
id|addr
op_amp
op_complement
id|PAGE_MASK
)paren
suffix:semicolon
r_return
id|vaddr
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Not found - assume legacy ioremap.&n;&t; */
r_return
id|addr
suffix:semicolon
)brace
r_void
DECL|function|marvel_iounmap
id|marvel_iounmap
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
r_int
)paren
id|addr
op_rshift
l_int|41
)paren
op_eq
op_minus
l_int|2
)paren
r_return
suffix:semicolon
multiline_comment|/* kseg map, nothing to do */
r_if
c_cond
(paren
id|addr
)paren
r_return
id|vfree
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|PAGE_MASK
op_amp
id|addr
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifndef CONFIG_ALPHA_GENERIC
DECL|variable|marvel_ioremap
id|EXPORT_SYMBOL
c_func
(paren
id|marvel_ioremap
)paren
suffix:semicolon
DECL|variable|marvel_iounmap
id|EXPORT_SYMBOL
c_func
(paren
id|marvel_iounmap
)paren
suffix:semicolon
macro_line|#endif
"&f;"
multiline_comment|/*&n; * RTC Support&n; */
DECL|struct|marvel_rtc_access_info
r_struct
id|marvel_rtc_access_info
(brace
DECL|member|function
r_int
r_int
id|function
suffix:semicolon
DECL|member|index
r_int
r_int
id|index
suffix:semicolon
DECL|member|data
r_int
r_int
id|data
suffix:semicolon
)brace
suffix:semicolon
r_static
r_void
DECL|function|__marvel_access_rtc
id|__marvel_access_rtc
c_func
(paren
r_void
op_star
id|info
)paren
(brace
r_struct
id|marvel_rtc_access_info
op_star
id|rtc_access
op_assign
id|info
suffix:semicolon
r_register
r_int
r_int
id|__r0
id|__asm__
c_func
(paren
l_string|&quot;$0&quot;
)paren
suffix:semicolon
r_register
r_int
r_int
id|__r16
id|__asm__
c_func
(paren
l_string|&quot;$16&quot;
)paren
op_assign
id|rtc_access-&gt;function
suffix:semicolon
r_register
r_int
r_int
id|__r17
id|__asm__
c_func
(paren
l_string|&quot;$17&quot;
)paren
op_assign
id|rtc_access-&gt;index
suffix:semicolon
r_register
r_int
r_int
id|__r18
id|__asm__
c_func
(paren
l_string|&quot;$18&quot;
)paren
op_assign
id|rtc_access-&gt;data
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;call_pal %4 # cserve rtc&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|__r16
)paren
comma
l_string|&quot;=r&quot;
(paren
id|__r17
)paren
comma
l_string|&quot;=r&quot;
(paren
id|__r18
)paren
comma
l_string|&quot;=r&quot;
(paren
id|__r0
)paren
suffix:colon
l_string|&quot;i&quot;
(paren
id|PAL_cserve
)paren
comma
l_string|&quot;0&quot;
(paren
id|__r16
)paren
comma
l_string|&quot;1&quot;
(paren
id|__r17
)paren
comma
l_string|&quot;2&quot;
(paren
id|__r18
)paren
suffix:colon
l_string|&quot;$1&quot;
comma
l_string|&quot;$22&quot;
comma
l_string|&quot;$23&quot;
comma
l_string|&quot;$24&quot;
comma
l_string|&quot;$25&quot;
)paren
suffix:semicolon
id|rtc_access-&gt;data
op_assign
id|__r0
suffix:semicolon
)brace
id|u8
DECL|function|__marvel_rtc_io
id|__marvel_rtc_io
c_func
(paren
r_int
id|write
comma
id|u8
id|b
comma
r_int
r_int
id|addr
)paren
(brace
r_struct
id|marvel_rtc_access_info
id|rtc_access
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
r_static
id|u8
id|index
op_assign
l_int|0
suffix:semicolon
id|u8
id|ret
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|addr
)paren
(brace
r_case
l_int|0x70
suffix:colon
multiline_comment|/* RTC_PORT(0) */
r_if
c_cond
(paren
id|write
)paren
id|index
op_assign
id|b
suffix:semicolon
id|ret
op_assign
id|index
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x71
suffix:colon
multiline_comment|/* RTC_PORT(1) */
id|rtc_access.index
op_assign
id|index
suffix:semicolon
id|rtc_access.data
op_assign
id|BCD_TO_BIN
c_func
(paren
id|b
)paren
suffix:semicolon
id|rtc_access.function
op_assign
l_int|0x49
suffix:semicolon
multiline_comment|/* GET_TOY */
r_if
c_cond
(paren
id|write
)paren
id|rtc_access.function
op_assign
l_int|0x48
suffix:semicolon
multiline_comment|/* PUT_TOY */
macro_line|#if CONFIG_SMP
r_if
c_cond
(paren
id|smp_processor_id
c_func
(paren
)paren
op_ne
id|boot_cpuid
)paren
id|smp_call_function_on_cpu
c_func
(paren
id|__marvel_access_rtc
comma
op_amp
id|rtc_access
comma
l_int|1
comma
multiline_comment|/* retry */
l_int|1
comma
multiline_comment|/* wait  */
l_int|1UL
op_lshift
id|boot_cpuid
)paren
suffix:semicolon
r_else
id|__marvel_access_rtc
c_func
(paren
op_amp
id|rtc_access
)paren
suffix:semicolon
macro_line|#else
id|__marvel_access_rtc
c_func
(paren
op_amp
id|rtc_access
)paren
suffix:semicolon
macro_line|#endif
id|ret
op_assign
id|BIN_TO_BCD
c_func
(paren
id|rtc_access.data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Illegal RTC port %lx&bslash;n&quot;
comma
id|addr
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
"&f;"
multiline_comment|/*&n; * NUMA Support&n; */
multiline_comment|/**********&n; * FIXME - for now each cpu is a node by itself &n; *              -- no real support for striped mode &n; **********&n; */
r_int
DECL|function|marvel_pa_to_nid
id|marvel_pa_to_nid
c_func
(paren
r_int
r_int
id|pa
)paren
(brace
r_int
id|cpuid
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pa
op_rshift
l_int|43
)paren
op_amp
l_int|1
)paren
multiline_comment|/* I/O */
id|cpuid
op_assign
(paren
op_complement
(paren
id|pa
op_rshift
l_int|35
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
r_else
multiline_comment|/* mem */
id|cpuid
op_assign
(paren
(paren
id|pa
op_rshift
l_int|34
)paren
op_amp
l_int|0x3
)paren
op_or
(paren
(paren
id|pa
op_rshift
(paren
l_int|37
op_minus
l_int|2
)paren
)paren
op_amp
(paren
l_int|0x1f
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
r_return
id|marvel_cpuid_to_nid
c_func
(paren
id|cpuid
)paren
suffix:semicolon
)brace
r_int
DECL|function|marvel_cpuid_to_nid
id|marvel_cpuid_to_nid
c_func
(paren
r_int
id|cpuid
)paren
(brace
r_return
id|cpuid
suffix:semicolon
)brace
r_int
r_int
DECL|function|marvel_node_mem_start
id|marvel_node_mem_start
c_func
(paren
r_int
id|nid
)paren
(brace
r_int
r_int
id|pa
suffix:semicolon
id|pa
op_assign
(paren
id|nid
op_amp
l_int|0x3
)paren
op_or
(paren
(paren
id|nid
op_amp
(paren
l_int|0x1f
op_lshift
l_int|2
)paren
)paren
op_lshift
l_int|1
)paren
suffix:semicolon
id|pa
op_lshift_assign
l_int|34
suffix:semicolon
r_return
id|pa
suffix:semicolon
)brace
r_int
r_int
DECL|function|marvel_node_mem_size
id|marvel_node_mem_size
c_func
(paren
r_int
id|nid
)paren
(brace
r_return
l_int|16UL
op_star
l_int|1024
op_star
l_int|1024
op_star
l_int|1024
suffix:semicolon
multiline_comment|/* 16GB */
)brace
"&f;"
multiline_comment|/* &n; * AGP GART Support.&n; */
macro_line|#include &lt;linux/agp_backend.h&gt;
macro_line|#include &lt;asm/agp_backend.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
DECL|struct|marvel_agp_aperture
r_struct
id|marvel_agp_aperture
(brace
DECL|member|arena
r_struct
id|pci_iommu_arena
op_star
id|arena
suffix:semicolon
DECL|member|pg_start
r_int
id|pg_start
suffix:semicolon
DECL|member|pg_count
r_int
id|pg_count
suffix:semicolon
)brace
suffix:semicolon
r_static
r_int
DECL|function|marvel_agp_setup
id|marvel_agp_setup
c_func
(paren
id|alpha_agp_info
op_star
id|agp
)paren
(brace
r_struct
id|marvel_agp_aperture
op_star
id|aper
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|alpha_agpgart_size
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|aper
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|aper
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|aper
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|aper-&gt;arena
op_assign
id|agp-&gt;hose-&gt;sg_pci
suffix:semicolon
id|aper-&gt;pg_count
op_assign
id|alpha_agpgart_size
op_div
id|PAGE_SIZE
suffix:semicolon
id|aper-&gt;pg_start
op_assign
id|iommu_reserve
c_func
(paren
id|aper-&gt;arena
comma
id|aper-&gt;pg_count
comma
id|aper-&gt;pg_count
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|aper-&gt;pg_start
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Failed to reserve AGP memory&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|aper
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|agp-&gt;aperture.bus_base
op_assign
id|aper-&gt;arena-&gt;dma_base
op_plus
id|aper-&gt;pg_start
op_star
id|PAGE_SIZE
suffix:semicolon
id|agp-&gt;aperture.size
op_assign
id|aper-&gt;pg_count
op_star
id|PAGE_SIZE
suffix:semicolon
id|agp-&gt;aperture.sysdata
op_assign
id|aper
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|marvel_agp_cleanup
id|marvel_agp_cleanup
c_func
(paren
id|alpha_agp_info
op_star
id|agp
)paren
(brace
r_struct
id|marvel_agp_aperture
op_star
id|aper
op_assign
id|agp-&gt;aperture.sysdata
suffix:semicolon
r_int
id|status
suffix:semicolon
id|status
op_assign
id|iommu_release
c_func
(paren
id|aper-&gt;arena
comma
id|aper-&gt;pg_start
comma
id|aper-&gt;pg_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
op_minus
id|EBUSY
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Attempted to release bound AGP memory - unbinding&bslash;n&quot;
)paren
suffix:semicolon
id|iommu_unbind
c_func
(paren
id|aper-&gt;arena
comma
id|aper-&gt;pg_start
comma
id|aper-&gt;pg_count
)paren
suffix:semicolon
id|status
op_assign
id|iommu_release
c_func
(paren
id|aper-&gt;arena
comma
id|aper-&gt;pg_start
comma
id|aper-&gt;pg_count
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Failed to release AGP memory&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|aper
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|agp
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|marvel_agp_configure
id|marvel_agp_configure
c_func
(paren
id|alpha_agp_info
op_star
id|agp
)paren
(brace
id|io7_ioport_csrs
op_star
id|csrs
op_assign
(paren
(paren
r_struct
id|io7_port
op_star
)paren
id|agp-&gt;hose-&gt;sysdata
)paren
op_member_access_from_pointer
id|csrs
suffix:semicolon
r_struct
id|io7
op_star
id|io7
op_assign
(paren
(paren
r_struct
id|io7_port
op_star
)paren
id|agp-&gt;hose-&gt;sysdata
)paren
op_member_access_from_pointer
id|io7
suffix:semicolon
r_int
r_int
id|new_rate
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|agp_pll
suffix:semicolon
multiline_comment|/*&n;&t; * Check the requested mode against the PLL setting.&n;&t; * The agpgart_be code has not programmed the card yet,&n;&t; * so we can still tweak mode here.&n;&t; */
id|agp_pll
op_assign
id|io7-&gt;csrs-&gt;POx_RST
(braket
id|IO7_AGP_PORT
)braket
dot
id|csr
suffix:semicolon
r_switch
c_cond
(paren
id|IO7_PLL_RNGB
c_func
(paren
id|agp_pll
)paren
)paren
(brace
r_case
l_int|0x4
suffix:colon
multiline_comment|/* 2x only */
multiline_comment|/* &n;&t;&t; * The PLL is only programmed for 2x, so adjust the&n;&t;&t; * rate to 2x, if necessary.&n;&t;&t; */
r_if
c_cond
(paren
id|agp-&gt;mode.bits.rate
op_ne
l_int|2
)paren
id|new_rate
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x6
suffix:colon
multiline_comment|/* 1x / 4x */
multiline_comment|/*&n;&t;&t; * The PLL is programmed for 1x or 4x.  Don&squot;t go faster&n;&t;&t; * than requested, so if the requested rate is 2x, use 1x.&n;&t;&t; */
r_if
c_cond
(paren
id|agp-&gt;mode.bits.rate
op_eq
l_int|2
)paren
id|new_rate
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* ??????? */
multiline_comment|/*&n;&t;&t; * Don&squot;t know what this PLL setting is, take the requested&n;&t;&t; * rate, but warn the user.&n;&t;&t; */
id|printk
c_func
(paren
l_string|&quot;%s: unknown PLL setting RNGB=%lx (PLL6_CTL=%016lx)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|IO7_PLL_RNGB
c_func
(paren
id|agp_pll
)paren
comma
id|agp_pll
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Set the new rate, if necessary.&n;&t; */
r_if
c_cond
(paren
id|new_rate
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Requested AGP Rate %dX not compatible &quot;
l_string|&quot;with PLL setting - using %dX&bslash;n&quot;
comma
id|agp-&gt;mode.bits.rate
comma
id|new_rate
)paren
suffix:semicolon
id|agp-&gt;mode.bits.rate
op_assign
id|new_rate
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;Enabling AGP on hose %d: %dX%s RQ %d&bslash;n&quot;
comma
id|agp-&gt;hose-&gt;index
comma
id|agp-&gt;mode.bits.rate
comma
id|agp-&gt;mode.bits.sba
ques
c_cond
l_string|&quot; - SBA&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|agp-&gt;mode.bits.rq
)paren
suffix:semicolon
id|csrs-&gt;AGP_CMD.csr
op_assign
id|agp-&gt;mode.lw
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|marvel_agp_bind_memory
id|marvel_agp_bind_memory
c_func
(paren
id|alpha_agp_info
op_star
id|agp
comma
id|off_t
id|pg_start
comma
id|agp_memory
op_star
id|mem
)paren
(brace
r_struct
id|marvel_agp_aperture
op_star
id|aper
op_assign
id|agp-&gt;aperture.sysdata
suffix:semicolon
r_return
id|iommu_bind
c_func
(paren
id|aper-&gt;arena
comma
id|aper-&gt;pg_start
op_plus
id|pg_start
comma
id|mem-&gt;page_count
comma
id|mem-&gt;memory
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|marvel_agp_unbind_memory
id|marvel_agp_unbind_memory
c_func
(paren
id|alpha_agp_info
op_star
id|agp
comma
id|off_t
id|pg_start
comma
id|agp_memory
op_star
id|mem
)paren
(brace
r_struct
id|marvel_agp_aperture
op_star
id|aper
op_assign
id|agp-&gt;aperture.sysdata
suffix:semicolon
r_return
id|iommu_unbind
c_func
(paren
id|aper-&gt;arena
comma
id|aper-&gt;pg_start
op_plus
id|pg_start
comma
id|mem-&gt;page_count
)paren
suffix:semicolon
)brace
r_static
r_int
r_int
DECL|function|marvel_agp_translate
id|marvel_agp_translate
c_func
(paren
id|alpha_agp_info
op_star
id|agp
comma
id|dma_addr_t
id|addr
)paren
(brace
r_struct
id|marvel_agp_aperture
op_star
id|aper
op_assign
id|agp-&gt;aperture.sysdata
suffix:semicolon
r_int
r_int
id|baddr
op_assign
id|addr
op_minus
id|aper-&gt;arena-&gt;dma_base
suffix:semicolon
r_int
r_int
id|pte
suffix:semicolon
r_if
c_cond
(paren
id|addr
OL
id|agp-&gt;aperture.bus_base
op_logical_or
id|addr
op_ge
id|agp-&gt;aperture.bus_base
op_plus
id|agp-&gt;aperture.size
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: addr out of range&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|pte
op_assign
id|aper-&gt;arena-&gt;ptes
(braket
id|baddr
op_rshift
id|PAGE_SHIFT
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pte
op_amp
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: pte not valid&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
(paren
id|pte
op_rshift
l_int|1
)paren
op_lshift
id|PAGE_SHIFT
suffix:semicolon
)brace
DECL|variable|marvel_agp_ops
r_struct
id|alpha_agp_ops
id|marvel_agp_ops
op_assign
(brace
dot
id|setup
op_assign
id|marvel_agp_setup
comma
dot
id|cleanup
op_assign
id|marvel_agp_cleanup
comma
dot
id|configure
op_assign
id|marvel_agp_configure
comma
dot
id|bind
op_assign
id|marvel_agp_bind_memory
comma
dot
id|unbind
op_assign
id|marvel_agp_unbind_memory
comma
dot
id|translate
op_assign
id|marvel_agp_translate
)brace
suffix:semicolon
id|alpha_agp_info
op_star
DECL|function|marvel_agp_info
id|marvel_agp_info
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_controller
op_star
id|hose
suffix:semicolon
id|io7_ioport_csrs
op_star
id|csrs
suffix:semicolon
id|alpha_agp_info
op_star
id|agp
suffix:semicolon
r_struct
id|io7
op_star
id|io7
suffix:semicolon
multiline_comment|/*&n;&t; * Find the first IO7 with an AGP card.&n;&t; *&n;&t; * FIXME -- there should be a better way (we want to be able to&n;&t; * specify and what if the agp card is not video???)&n;&t; */
id|hose
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|io7
op_assign
l_int|NULL
suffix:semicolon
(paren
id|io7
op_assign
id|marvel_next_io7
c_func
(paren
id|io7
)paren
)paren
op_ne
l_int|NULL
suffix:semicolon
)paren
(brace
r_struct
id|pci_controller
op_star
id|h
suffix:semicolon
id|vuip
id|addr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|io7-&gt;ports
(braket
id|IO7_AGP_PORT
)braket
dot
id|enabled
)paren
r_continue
suffix:semicolon
id|h
op_assign
id|io7-&gt;ports
(braket
id|IO7_AGP_PORT
)braket
dot
id|hose
suffix:semicolon
id|addr
op_assign
(paren
id|vuip
)paren
id|build_conf_addr
c_func
(paren
id|h
comma
l_int|0
comma
id|PCI_DEVFN
c_func
(paren
l_int|5
comma
l_int|0
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|addr
op_ne
l_int|0xffffffffu
)paren
(brace
id|hose
op_assign
id|h
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|hose
op_logical_or
op_logical_neg
id|hose-&gt;sg_pci
)paren
r_return
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;MARVEL - using hose %d as AGP&bslash;n&quot;
comma
id|hose-&gt;index
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Get the csrs from the hose.&n;&t; */
id|csrs
op_assign
(paren
(paren
r_struct
id|io7_port
op_star
)paren
id|hose-&gt;sysdata
)paren
op_member_access_from_pointer
id|csrs
suffix:semicolon
multiline_comment|/*&n;&t; * Allocate the info structure.&n;&t; */
id|agp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|agp
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Fill it in.&n;&t; */
id|agp-&gt;type
op_assign
l_int|0
multiline_comment|/* FIXME: ALPHA_CORE_AGP */
suffix:semicolon
id|agp-&gt;hose
op_assign
id|hose
suffix:semicolon
id|agp
op_member_access_from_pointer
r_private
op_assign
l_int|NULL
suffix:semicolon
id|agp-&gt;ops
op_assign
op_amp
id|marvel_agp_ops
suffix:semicolon
multiline_comment|/*&n;&t; * Aperture - not configured until ops.setup().&n;&t; */
id|agp-&gt;aperture.bus_base
op_assign
l_int|0
suffix:semicolon
id|agp-&gt;aperture.size
op_assign
l_int|0
suffix:semicolon
id|agp-&gt;aperture.sysdata
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t; * Capabilities.&n;&t; *&n;&t; * NOTE: IO7 reports through AGP_STAT that it can support a read queue&n;&t; *       depth of 17 (rq = 0x10). It actually only supports a depth of&n;&t; * &t; 16 (rq = 0xf).&n;&t; */
id|agp-&gt;capability.lw
op_assign
id|csrs-&gt;AGP_STAT.csr
suffix:semicolon
id|agp-&gt;capability.bits.rq
op_assign
l_int|0xf
suffix:semicolon
multiline_comment|/*&n;&t; * Mode.&n;&t; */
id|agp-&gt;mode.lw
op_assign
id|csrs-&gt;AGP_CMD.csr
suffix:semicolon
r_return
id|agp
suffix:semicolon
)brace
eof
