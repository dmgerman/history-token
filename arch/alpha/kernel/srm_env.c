multiline_comment|/*&n; * srm_env.c - Access to SRC environment variables through&n; *             the linux procfs&n; *&n; * (C)2001, Jan-Benedict Glaw &lt;jbglaw@lug-owl.de&gt;&n; *&n; * This driver is at all a modified version of Erik Mouw&squot;s&n; * ./linux/Documentation/DocBook/procfs_example.c, so: thanky&n; * you, Erik! He can be reached via email at&n; * &lt;J.A.K.Mouw@its.tudelft.nl&gt;. It is based on an idea&n; * provided by DEC^WCompaq&squot;s &quot;Jumpstart&quot; CD. They included&n; * a patch like this as well. Thanks for idea!&n; *&n; *&n; * This software has been developed while working on the LART&n; * computing board (http://www.lart.tudelft.nl/). The&n; * development has been sponsored by the Mobile Multi-media&n; * Communications (http://www.mmc.tudelft.nl/) and Ubiquitous&n; * Communications (http://www.ubicom.tudelft.nl/) projects.&n; *&n; * This program is free software; you can redistribute&n; * it and/or modify it under the terms of the GNU General&n; * Public License as published by the Free Software&n; * Foundation version 2.&n; *&n; * This program is distributed in the hope that it will be&n; * useful, but WITHOUT ANY WARRANTY; without even the implied&n; * warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR&n; * PURPOSE.  See the GNU General Public License for more&n; * details.&n; * &n; * You should have received a copy of the GNU General Public&n; * License along with this program; if not, write to the&n; * Free Software Foundation, Inc., 59 Temple Place,&n; * Suite 330, Boston, MA  02111-1307  USA&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;asm/console.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/machvec.h&gt;
DECL|macro|DIRNAME
mdefine_line|#define DIRNAME&t;&t;&quot;srm_environment&quot;&t;/* Subdir in /proc/&t;*/
DECL|macro|VERSION
mdefine_line|#define VERSION&t;&t;&quot;0.0.2&quot;&t;&t;&t;/* Module version&t;*/
DECL|macro|NAME
mdefine_line|#define NAME&t;&t;&quot;srm_env&quot;&t;&t;/* Module name&t;&t;*/
DECL|macro|DEBUG
mdefine_line|#define DEBUG
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Jan-Benedict Glaw &lt;jbglaw@lug-owl.de&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Accessing Alpha SRM environment through procfs interface&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|EXPORT_NO_SYMBOLS
suffix:semicolon
DECL|struct|_srm_env
r_typedef
r_struct
id|_srm_env
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|id
r_int
r_int
id|id
suffix:semicolon
DECL|member|proc_entry
r_struct
id|proc_dir_entry
op_star
id|proc_entry
suffix:semicolon
DECL|typedef|srm_env_t
)brace
id|srm_env_t
suffix:semicolon
DECL|variable|directory
r_static
r_struct
id|proc_dir_entry
op_star
id|directory
suffix:semicolon
DECL|variable|srm_entries
r_static
id|srm_env_t
id|srm_entries
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;auto_action&quot;
comma
id|ENV_AUTO_ACTION
)brace
comma
(brace
l_string|&quot;boot_dev&quot;
comma
id|ENV_BOOT_DEV
)brace
comma
(brace
l_string|&quot;bootdef_dev&quot;
comma
id|ENV_BOOTDEF_DEV
)brace
comma
(brace
l_string|&quot;booted_dev&quot;
comma
id|ENV_BOOTED_DEV
)brace
comma
(brace
l_string|&quot;boot_file&quot;
comma
id|ENV_BOOT_FILE
)brace
comma
(brace
l_string|&quot;booted_file&quot;
comma
id|ENV_BOOTED_FILE
)brace
comma
(brace
l_string|&quot;boot_osflags&quot;
comma
id|ENV_BOOT_OSFLAGS
)brace
comma
(brace
l_string|&quot;booted_osflags&quot;
comma
id|ENV_BOOTED_OSFLAGS
)brace
comma
(brace
l_string|&quot;boot_reset&quot;
comma
id|ENV_BOOT_RESET
)brace
comma
(brace
l_string|&quot;dump_dev&quot;
comma
id|ENV_DUMP_DEV
)brace
comma
(brace
l_string|&quot;enable_audit&quot;
comma
id|ENV_ENABLE_AUDIT
)brace
comma
(brace
l_string|&quot;license&quot;
comma
id|ENV_LICENSE
)brace
comma
(brace
l_string|&quot;char_set&quot;
comma
id|ENV_CHAR_SET
)brace
comma
(brace
l_string|&quot;language&quot;
comma
id|ENV_LANGUAGE
)brace
comma
(brace
l_string|&quot;tty_dev&quot;
comma
id|ENV_TTY_DEV
)brace
comma
(brace
l_int|NULL
comma
l_int|0
)brace
comma
)brace
suffix:semicolon
DECL|function|srm_env_read
r_static
r_int
id|srm_env_read
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|nbytes
suffix:semicolon
r_int
r_int
id|ret
suffix:semicolon
id|srm_env_t
op_star
id|entry
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|off
op_ne
l_int|0
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|entry
op_assign
(paren
id|srm_env_t
op_star
)paren
id|data
suffix:semicolon
id|ret
op_assign
id|callback_getenv
c_func
(paren
id|entry-&gt;id
comma
id|page
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_rshift
l_int|61
)paren
op_eq
l_int|0
)paren
(brace
id|nbytes
op_assign
(paren
r_int
)paren
id|ret
suffix:semicolon
)brace
r_else
id|nbytes
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|nbytes
suffix:semicolon
)brace
DECL|function|srm_env_write
r_static
r_int
id|srm_env_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
DECL|macro|BUFLEN
mdefine_line|#define BUFLEN&t;512
r_int
id|nbytes
suffix:semicolon
id|srm_env_t
op_star
id|entry
suffix:semicolon
r_char
id|buf
(braket
id|BUFLEN
)braket
suffix:semicolon
r_int
r_int
id|ret1
comma
id|ret2
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|entry
op_assign
(paren
id|srm_env_t
op_star
)paren
id|data
suffix:semicolon
id|nbytes
op_assign
id|strlen
c_func
(paren
id|buffer
)paren
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|nbytes
OG
id|BUFLEN
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
singleline_comment|//memcpy(aligned_buffer, buffer, nbytes)
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|buf
comma
id|buffer
comma
id|count
)paren
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|buf
(braket
id|count
)braket
op_assign
l_int|0x00
suffix:semicolon
id|ret1
op_assign
id|callback_setenv
c_func
(paren
id|entry-&gt;id
comma
id|buf
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret1
op_rshift
l_int|61
)paren
op_eq
l_int|0
)paren
(brace
r_do
id|ret2
op_assign
id|callback_save_env
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|ret2
op_rshift
l_int|61
)paren
op_eq
l_int|1
)paren
(brace
suffix:semicolon
)brace
id|nbytes
op_assign
(paren
r_int
)paren
id|ret1
suffix:semicolon
)brace
r_else
id|nbytes
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|nbytes
suffix:semicolon
)brace
DECL|function|srm_env_cleanup
r_static
r_void
id|srm_env_cleanup
c_func
(paren
r_void
)paren
(brace
id|srm_env_t
op_star
id|entry
suffix:semicolon
r_if
c_cond
(paren
id|directory
)paren
(brace
id|entry
op_assign
id|srm_entries
suffix:semicolon
r_while
c_loop
(paren
id|entry-&gt;name
op_ne
l_int|NULL
op_logical_and
id|entry-&gt;id
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|entry-&gt;proc_entry
)paren
(brace
id|remove_proc_entry
c_func
(paren
id|entry-&gt;name
comma
id|directory
)paren
suffix:semicolon
id|entry-&gt;proc_entry
op_assign
l_int|NULL
suffix:semicolon
)brace
id|entry
op_increment
suffix:semicolon
)brace
id|remove_proc_entry
c_func
(paren
id|DIRNAME
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|srm_env_init
r_static
r_int
id|__init
id|srm_env_init
c_func
(paren
r_void
)paren
(brace
id|srm_env_t
op_star
id|entry
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|alpha_using_srm
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: This Alpha system doesn&squot;t &quot;
l_string|&quot;know about SRM...&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|directory
op_assign
id|proc_mkdir
c_func
(paren
id|DIRNAME
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|directory
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|directory-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
multiline_comment|/* Now create all the nodes... */
id|entry
op_assign
id|srm_entries
suffix:semicolon
r_while
c_loop
(paren
id|entry-&gt;name
op_ne
l_int|NULL
op_logical_and
id|entry-&gt;id
op_ne
l_int|0
)paren
(brace
id|entry-&gt;proc_entry
op_assign
id|create_proc_entry
c_func
(paren
id|entry-&gt;name
comma
l_int|0644
comma
id|directory
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry-&gt;proc_entry
op_eq
l_int|NULL
)paren
(brace
r_goto
id|cleanup
suffix:semicolon
)brace
id|entry-&gt;proc_entry-&gt;data
op_assign
id|entry
suffix:semicolon
id|entry-&gt;proc_entry-&gt;read_proc
op_assign
id|srm_env_read
suffix:semicolon
id|entry-&gt;proc_entry-&gt;write_proc
op_assign
id|srm_env_write
suffix:semicolon
id|entry-&gt;proc_entry-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|entry
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: version %s loaded successfully&bslash;n&quot;
comma
id|NAME
comma
id|VERSION
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|cleanup
suffix:colon
id|srm_env_cleanup
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
DECL|function|srm_env_exit
r_static
r_void
id|__exit
id|srm_env_exit
c_func
(paren
r_void
)paren
(brace
id|srm_env_cleanup
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: unloaded successfully&bslash;n&quot;
comma
id|NAME
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|variable|srm_env_init
id|module_init
c_func
(paren
id|srm_env_init
)paren
suffix:semicolon
DECL|variable|srm_env_exit
id|module_exit
c_func
(paren
id|srm_env_exit
)paren
suffix:semicolon
eof
