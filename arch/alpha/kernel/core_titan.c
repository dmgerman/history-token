multiline_comment|/*&n; *&t;linux/arch/alpha/kernel/core_titan.c&n; *&n; * Code common to all TITAN core logic chips.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;asm/hwrpb.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/smp.h&gt;
macro_line|#include &lt;asm/pgalloc.h&gt;
macro_line|#include &lt;asm/tlbflush.h&gt;
DECL|macro|__EXTERN_INLINE
mdefine_line|#define __EXTERN_INLINE inline
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/core_titan.h&gt;
DECL|macro|__EXTERN_INLINE
macro_line|#undef __EXTERN_INLINE
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &quot;proto.h&quot;
macro_line|#include &quot;pci_impl.h&quot;
multiline_comment|/* Save Titan configuration data as the console had it set up.  */
r_struct
(brace
DECL|member|wsba
r_int
r_int
id|wsba
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|wsm
r_int
r_int
id|wsm
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|tba
r_int
r_int
id|tba
(braket
l_int|4
)braket
suffix:semicolon
DECL|variable|saved_config
)brace
id|saved_config
(braket
l_int|4
)braket
id|__attribute__
c_func
(paren
(paren
id|common
)paren
)paren
suffix:semicolon
multiline_comment|/*&n; * BIOS32-style PCI interface:&n; */
DECL|macro|DEBUG_MCHECK
mdefine_line|#define DEBUG_MCHECK 0  /* 0 = minimum, 1 = debug, 2 = dump+dump */
DECL|macro|DEBUG_CONFIG
mdefine_line|#define DEBUG_CONFIG 0
macro_line|#if DEBUG_CONFIG
DECL|macro|DBG_CFG
macro_line|# define DBG_CFG(args)&t;printk args
macro_line|#else
DECL|macro|DBG_CFG
macro_line|# define DBG_CFG(args)
macro_line|#endif
"&f;"
multiline_comment|/*&n; * Routines to access TIG registers.&n; */
r_static
r_inline
r_volatile
r_int
r_int
op_star
DECL|function|mk_tig_addr
id|mk_tig_addr
c_func
(paren
r_int
id|offset
)paren
(brace
r_return
(paren
r_volatile
r_int
r_int
op_star
)paren
(paren
id|TITAN_TIG_SPACE
op_plus
(paren
id|offset
op_lshift
l_int|6
)paren
)paren
suffix:semicolon
)brace
r_static
r_inline
id|u8
DECL|function|titan_read_tig
id|titan_read_tig
c_func
(paren
r_int
id|offset
comma
id|u8
id|value
)paren
(brace
r_volatile
r_int
r_int
op_star
id|tig_addr
op_assign
id|mk_tig_addr
c_func
(paren
id|offset
)paren
suffix:semicolon
r_return
(paren
id|u8
)paren
(paren
op_star
id|tig_addr
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|titan_write_tig
id|titan_write_tig
c_func
(paren
r_int
id|offset
comma
id|u8
id|value
)paren
(brace
r_volatile
r_int
r_int
op_star
id|tig_addr
op_assign
id|mk_tig_addr
c_func
(paren
id|offset
)paren
suffix:semicolon
op_star
id|tig_addr
op_assign
(paren
r_int
r_int
)paren
id|value
suffix:semicolon
)brace
"&f;"
multiline_comment|/*&n; * Given a bus, device, and function number, compute resulting&n; * configuration space address&n; * accordingly.  It is therefore not safe to have concurrent&n; * invocations to configuration space access routines, but there&n; * really shouldn&squot;t be any need for this.&n; *&n; * Note that all config space accesses use Type 1 address format.&n; *&n; * Note also that type 1 is determined by non-zero bus number.&n; *&n; * Type 1:&n; *&n; *  3 3|3 3 2 2|2 2 2 2|2 2 2 2|1 1 1 1|1 1 1 1|1 1 &n; *  3 2|1 0 9 8|7 6 5 4|3 2 1 0|9 8 7 6|5 4 3 2|1 0 9 8|7 6 5 4|3 2 1 0&n; * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n; * | | | | | | | | | | |B|B|B|B|B|B|B|B|D|D|D|D|D|F|F|F|R|R|R|R|R|R|0|1|&n; * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n; *&n; *&t;31:24&t;reserved&n; *&t;23:16&t;bus number (8 bits = 128 possible buses)&n; *&t;15:11&t;Device number (5 bits)&n; *&t;10:8&t;function number&n; *&t; 7:2&t;register number&n; *  &n; * Notes:&n; *&t;The function number selects which function of a multi-function device &n; *&t;(e.g., SCSI and Ethernet).&n; * &n; *&t;The register selects a DWORD (32 bit) register offset.  Hence it&n; *&t;doesn&squot;t get shifted by 2 bits as we want to &quot;drop&quot; the bottom two&n; *&t;bits.&n; */
r_static
r_int
DECL|function|mk_conf_addr
id|mk_conf_addr
c_func
(paren
r_struct
id|pci_bus
op_star
id|pbus
comma
r_int
r_int
id|device_fn
comma
r_int
id|where
comma
r_int
r_int
op_star
id|pci_addr
comma
r_int
r_char
op_star
id|type1
)paren
(brace
r_struct
id|pci_controller
op_star
id|hose
op_assign
id|pbus-&gt;sysdata
suffix:semicolon
r_int
r_int
id|addr
suffix:semicolon
id|u8
id|bus
op_assign
id|pbus-&gt;number
suffix:semicolon
id|DBG_CFG
c_func
(paren
(paren
l_string|&quot;mk_conf_addr(bus=%d ,device_fn=0x%x, where=0x%x, &quot;
l_string|&quot;pci_addr=0x%p, type1=0x%p)&bslash;n&quot;
comma
id|bus
comma
id|device_fn
comma
id|where
comma
id|pci_addr
comma
id|type1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hose-&gt;first_busno
op_eq
id|bus
)paren
id|bus
op_assign
l_int|0
suffix:semicolon
op_star
id|type1
op_assign
(paren
id|bus
op_ne
l_int|0
)paren
suffix:semicolon
id|addr
op_assign
(paren
id|bus
op_lshift
l_int|16
)paren
op_or
(paren
id|device_fn
op_lshift
l_int|8
)paren
op_or
id|where
suffix:semicolon
id|addr
op_or_assign
id|hose-&gt;config_space_base
suffix:semicolon
op_star
id|pci_addr
op_assign
id|addr
suffix:semicolon
id|DBG_CFG
c_func
(paren
(paren
l_string|&quot;mk_conf_addr: returning pci_addr 0x%lx&bslash;n&quot;
comma
id|addr
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|titan_read_config
id|titan_read_config
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
op_star
id|value
)paren
(brace
r_int
r_int
id|addr
suffix:semicolon
r_int
r_char
id|type1
suffix:semicolon
r_if
c_cond
(paren
id|mk_conf_addr
c_func
(paren
id|bus
comma
id|devfn
comma
id|where
comma
op_amp
id|addr
comma
op_amp
id|type1
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
l_int|1
suffix:colon
op_star
id|value
op_assign
id|__kernel_ldbu
c_func
(paren
op_star
(paren
id|vucp
)paren
id|addr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
op_star
id|value
op_assign
id|__kernel_ldwu
c_func
(paren
op_star
(paren
id|vusp
)paren
id|addr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
op_star
id|value
op_assign
op_star
(paren
id|vuip
)paren
id|addr
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
r_static
r_int
DECL|function|titan_write_config
id|titan_write_config
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
id|value
)paren
(brace
r_int
r_int
id|addr
suffix:semicolon
r_int
r_char
id|type1
suffix:semicolon
r_if
c_cond
(paren
id|mk_conf_addr
c_func
(paren
id|bus
comma
id|devfn
comma
id|where
comma
op_amp
id|addr
comma
op_amp
id|type1
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
l_int|1
suffix:colon
id|__kernel_stb
c_func
(paren
id|value
comma
op_star
(paren
id|vucp
)paren
id|addr
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|__kernel_ldbu
c_func
(paren
op_star
(paren
id|vucp
)paren
id|addr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|__kernel_stw
c_func
(paren
id|value
comma
op_star
(paren
id|vusp
)paren
id|addr
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|__kernel_ldwu
c_func
(paren
op_star
(paren
id|vusp
)paren
id|addr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
op_star
(paren
id|vuip
)paren
id|addr
op_assign
id|value
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
op_star
(paren
id|vuip
)paren
id|addr
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|variable|titan_pci_ops
r_struct
id|pci_ops
id|titan_pci_ops
op_assign
(brace
dot
id|read
op_assign
id|titan_read_config
comma
dot
id|write
op_assign
id|titan_write_config
comma
)brace
suffix:semicolon
"&f;"
r_void
DECL|function|titan_pci_tbi
id|titan_pci_tbi
c_func
(paren
r_struct
id|pci_controller
op_star
id|hose
comma
id|dma_addr_t
id|start
comma
id|dma_addr_t
id|end
)paren
(brace
id|titan_pachip
op_star
id|pachip
op_assign
(paren
id|hose-&gt;index
op_amp
l_int|1
)paren
ques
c_cond
id|TITAN_pachip1
suffix:colon
id|TITAN_pachip0
suffix:semicolon
id|titan_pachip_port
op_star
id|port
suffix:semicolon
r_volatile
r_int
r_int
op_star
id|csr
suffix:semicolon
r_int
r_int
id|value
suffix:semicolon
multiline_comment|/* Get the right hose.  */
id|port
op_assign
op_amp
id|pachip-&gt;g_port
suffix:semicolon
r_if
c_cond
(paren
id|hose-&gt;index
op_amp
l_int|2
)paren
id|port
op_assign
op_amp
id|pachip-&gt;a_port
suffix:semicolon
multiline_comment|/* We can invalidate up to 8 tlb entries in a go.  The flush&n;&t;   matches against &lt;31:16&gt; in the pci address.  &n;&t;   Note that gtlbi* and atlbi* are in the same place in the g_port&n;&t;   and a_port, respectively, so the g_port offset can be used&n;&t;   even if hose is an a_port */
id|csr
op_assign
op_amp
id|port-&gt;port_specific.g.gtlbia.csr
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|start
op_xor
id|end
)paren
op_amp
l_int|0xffff0000
)paren
op_eq
l_int|0
)paren
id|csr
op_assign
op_amp
id|port-&gt;port_specific.g.gtlbiv.csr
suffix:semicolon
multiline_comment|/* For TBIA, it doesn&squot;t matter what value we write.  For TBI, &n;&t;   it&squot;s the shifted tag bits.  */
id|value
op_assign
(paren
id|start
op_amp
l_int|0xffff0000
)paren
op_rshift
l_int|12
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
op_star
id|csr
op_assign
id|value
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
op_star
id|csr
suffix:semicolon
)brace
r_static
r_int
DECL|function|titan_query_agp
id|titan_query_agp
c_func
(paren
id|titan_pachip_port
op_star
id|port
)paren
(brace
r_union
id|TPAchipPCTL
id|pctl
suffix:semicolon
multiline_comment|/* set up APCTL */
id|pctl.pctl_q_whole
op_assign
id|port-&gt;pctl.csr
suffix:semicolon
r_return
id|pctl.pctl_r_bits.apctl_v_agp_present
suffix:semicolon
)brace
r_static
r_void
id|__init
DECL|function|titan_init_one_pachip_port
id|titan_init_one_pachip_port
c_func
(paren
id|titan_pachip_port
op_star
id|port
comma
r_int
id|index
)paren
(brace
r_struct
id|pci_controller
op_star
id|hose
suffix:semicolon
id|hose
op_assign
id|alloc_pci_controller
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|index
op_eq
l_int|0
)paren
id|pci_isa_hose
op_assign
id|hose
suffix:semicolon
id|hose-&gt;io_space
op_assign
id|alloc_resource
c_func
(paren
)paren
suffix:semicolon
id|hose-&gt;mem_space
op_assign
id|alloc_resource
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * This is for userland consumption.  The 40-bit PIO bias that we &n;&t; * use in the kernel through KSEG doesn&squot;t work in the page table &n;&t; * based user mappings. (43-bit KSEG sign extends the physical&n;&t; * address from bit 40 to hit the I/O bit - mapped addresses don&squot;t).&n;&t; * So make sure we get the 43-bit PIO bias.  &n;&t; */
id|hose-&gt;sparse_mem_base
op_assign
l_int|0
suffix:semicolon
id|hose-&gt;sparse_io_base
op_assign
l_int|0
suffix:semicolon
id|hose-&gt;dense_mem_base
op_assign
(paren
id|TITAN_MEM
c_func
(paren
id|index
)paren
op_amp
l_int|0xffffffffff
)paren
op_or
l_int|0x80000000000
suffix:semicolon
id|hose-&gt;dense_io_base
op_assign
(paren
id|TITAN_IO
c_func
(paren
id|index
)paren
op_amp
l_int|0xffffffffff
)paren
op_or
l_int|0x80000000000
suffix:semicolon
id|hose-&gt;config_space_base
op_assign
id|TITAN_CONF
c_func
(paren
id|index
)paren
suffix:semicolon
id|hose-&gt;index
op_assign
id|index
suffix:semicolon
id|hose-&gt;io_space-&gt;start
op_assign
id|TITAN_IO
c_func
(paren
id|index
)paren
op_minus
id|TITAN_IO_BIAS
suffix:semicolon
id|hose-&gt;io_space-&gt;end
op_assign
id|hose-&gt;io_space-&gt;start
op_plus
id|TITAN_IO_SPACE
op_minus
l_int|1
suffix:semicolon
id|hose-&gt;io_space-&gt;name
op_assign
id|pci_io_names
(braket
id|index
)braket
suffix:semicolon
id|hose-&gt;io_space-&gt;flags
op_assign
id|IORESOURCE_IO
suffix:semicolon
id|hose-&gt;mem_space-&gt;start
op_assign
id|TITAN_MEM
c_func
(paren
id|index
)paren
op_minus
id|TITAN_MEM_BIAS
suffix:semicolon
id|hose-&gt;mem_space-&gt;end
op_assign
id|hose-&gt;mem_space-&gt;start
op_plus
l_int|0xffffffff
suffix:semicolon
id|hose-&gt;mem_space-&gt;name
op_assign
id|pci_mem_names
(braket
id|index
)braket
suffix:semicolon
id|hose-&gt;mem_space-&gt;flags
op_assign
id|IORESOURCE_MEM
suffix:semicolon
r_if
c_cond
(paren
id|request_resource
c_func
(paren
op_amp
id|ioport_resource
comma
id|hose-&gt;io_space
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Failed to request IO on hose %d&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_resource
c_func
(paren
op_amp
id|iomem_resource
comma
id|hose-&gt;mem_space
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Failed to request MEM on hose %d&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Save the existing PCI window translations.  SRM will &n;&t; * need them when we go to reboot.&n;&t; */
id|saved_config
(braket
id|index
)braket
dot
id|wsba
(braket
l_int|0
)braket
op_assign
id|port-&gt;wsba
(braket
l_int|0
)braket
dot
id|csr
suffix:semicolon
id|saved_config
(braket
id|index
)braket
dot
id|wsm
(braket
l_int|0
)braket
op_assign
id|port-&gt;wsm
(braket
l_int|0
)braket
dot
id|csr
suffix:semicolon
id|saved_config
(braket
id|index
)braket
dot
id|tba
(braket
l_int|0
)braket
op_assign
id|port-&gt;tba
(braket
l_int|0
)braket
dot
id|csr
suffix:semicolon
id|saved_config
(braket
id|index
)braket
dot
id|wsba
(braket
l_int|1
)braket
op_assign
id|port-&gt;wsba
(braket
l_int|1
)braket
dot
id|csr
suffix:semicolon
id|saved_config
(braket
id|index
)braket
dot
id|wsm
(braket
l_int|1
)braket
op_assign
id|port-&gt;wsm
(braket
l_int|1
)braket
dot
id|csr
suffix:semicolon
id|saved_config
(braket
id|index
)braket
dot
id|tba
(braket
l_int|1
)braket
op_assign
id|port-&gt;tba
(braket
l_int|1
)braket
dot
id|csr
suffix:semicolon
id|saved_config
(braket
id|index
)braket
dot
id|wsba
(braket
l_int|2
)braket
op_assign
id|port-&gt;wsba
(braket
l_int|2
)braket
dot
id|csr
suffix:semicolon
id|saved_config
(braket
id|index
)braket
dot
id|wsm
(braket
l_int|2
)braket
op_assign
id|port-&gt;wsm
(braket
l_int|2
)braket
dot
id|csr
suffix:semicolon
id|saved_config
(braket
id|index
)braket
dot
id|tba
(braket
l_int|2
)braket
op_assign
id|port-&gt;tba
(braket
l_int|2
)braket
dot
id|csr
suffix:semicolon
id|saved_config
(braket
id|index
)braket
dot
id|wsba
(braket
l_int|3
)braket
op_assign
id|port-&gt;wsba
(braket
l_int|3
)braket
dot
id|csr
suffix:semicolon
id|saved_config
(braket
id|index
)braket
dot
id|wsm
(braket
l_int|3
)braket
op_assign
id|port-&gt;wsm
(braket
l_int|3
)braket
dot
id|csr
suffix:semicolon
id|saved_config
(braket
id|index
)braket
dot
id|tba
(braket
l_int|3
)braket
op_assign
id|port-&gt;tba
(braket
l_int|3
)braket
dot
id|csr
suffix:semicolon
multiline_comment|/*&n;&t; * Set up the PCI to main memory translation windows.&n;&t; *&n;&t; * Note: Window 3 on Titan is Scatter-Gather ONLY.&n;&t; *&n;&t; * Window 0 is scatter-gather 8MB at 8MB (for isa)&n;&t; * Window 1 is direct access 1GB at 2GB&n;&t; * Window 2 is scatter-gather 1GB at 3GB&n;&t; */
id|hose-&gt;sg_isa
op_assign
id|iommu_arena_new
c_func
(paren
id|hose
comma
l_int|0x00800000
comma
l_int|0x00800000
comma
l_int|0
)paren
suffix:semicolon
id|hose-&gt;sg_isa-&gt;align_entry
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* 64KB for ISA */
id|hose-&gt;sg_pci
op_assign
id|iommu_arena_new
c_func
(paren
id|hose
comma
l_int|0xc0000000
comma
l_int|0x40000000
comma
l_int|0
)paren
suffix:semicolon
id|hose-&gt;sg_pci-&gt;align_entry
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* Titan caches 4 PTEs at a time */
id|port-&gt;wsba
(braket
l_int|0
)braket
dot
id|csr
op_assign
id|hose-&gt;sg_isa-&gt;dma_base
op_or
l_int|3
suffix:semicolon
id|port-&gt;wsm
(braket
l_int|0
)braket
dot
id|csr
op_assign
(paren
id|hose-&gt;sg_isa-&gt;size
op_minus
l_int|1
)paren
op_amp
l_int|0xfff00000
suffix:semicolon
id|port-&gt;tba
(braket
l_int|0
)braket
dot
id|csr
op_assign
id|virt_to_phys
c_func
(paren
id|hose-&gt;sg_isa-&gt;ptes
)paren
suffix:semicolon
id|port-&gt;wsba
(braket
l_int|1
)braket
dot
id|csr
op_assign
id|__direct_map_base
op_or
l_int|1
suffix:semicolon
id|port-&gt;wsm
(braket
l_int|1
)braket
dot
id|csr
op_assign
(paren
id|__direct_map_size
op_minus
l_int|1
)paren
op_amp
l_int|0xfff00000
suffix:semicolon
id|port-&gt;tba
(braket
l_int|1
)braket
dot
id|csr
op_assign
l_int|0
suffix:semicolon
id|port-&gt;wsba
(braket
l_int|2
)braket
dot
id|csr
op_assign
id|hose-&gt;sg_pci-&gt;dma_base
op_or
l_int|3
suffix:semicolon
id|port-&gt;wsm
(braket
l_int|2
)braket
dot
id|csr
op_assign
(paren
id|hose-&gt;sg_pci-&gt;size
op_minus
l_int|1
)paren
op_amp
l_int|0xfff00000
suffix:semicolon
id|port-&gt;tba
(braket
l_int|2
)braket
dot
id|csr
op_assign
id|virt_to_phys
c_func
(paren
id|hose-&gt;sg_pci-&gt;ptes
)paren
suffix:semicolon
id|port-&gt;wsba
(braket
l_int|3
)braket
dot
id|csr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Enable the Monster Window to make DAC pci64 possible.  */
id|port-&gt;pctl.csr
op_or_assign
id|pctl_m_mwin
suffix:semicolon
multiline_comment|/*&n;&t; * If it&squot;s an AGP port, initialize agplastwr.&n;&t; */
r_if
c_cond
(paren
id|titan_query_agp
c_func
(paren
id|port
)paren
)paren
id|port-&gt;port_specific.a.agplastwr.csr
op_assign
id|__direct_map_base
suffix:semicolon
id|titan_pci_tbi
c_func
(paren
id|hose
comma
l_int|0
comma
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_static
r_void
id|__init
DECL|function|titan_init_pachips
id|titan_init_pachips
c_func
(paren
id|titan_pachip
op_star
id|pachip0
comma
id|titan_pachip
op_star
id|pachip1
)paren
(brace
r_int
id|pchip1_present
op_assign
id|TITAN_cchip-&gt;csc.csr
op_amp
l_int|1L
op_lshift
l_int|14
suffix:semicolon
multiline_comment|/* Init the ports in hose order... */
id|titan_init_one_pachip_port
c_func
(paren
op_amp
id|pachip0-&gt;g_port
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* hose 0 */
r_if
c_cond
(paren
id|pchip1_present
)paren
id|titan_init_one_pachip_port
c_func
(paren
op_amp
id|pachip1-&gt;g_port
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* hose 1 */
id|titan_init_one_pachip_port
c_func
(paren
op_amp
id|pachip0-&gt;a_port
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* hose 2 */
r_if
c_cond
(paren
id|pchip1_present
)paren
id|titan_init_one_pachip_port
c_func
(paren
op_amp
id|pachip1-&gt;a_port
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* hose 3 */
)brace
r_static
r_void
id|__init
DECL|function|titan_init_vga_hose
id|titan_init_vga_hose
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_VGA_HOSE
id|u64
op_star
id|pu64
op_assign
(paren
id|u64
op_star
)paren
(paren
(paren
id|u64
)paren
id|hwrpb
op_plus
id|hwrpb-&gt;ctbt_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pu64
(braket
l_int|7
)braket
op_eq
l_int|3
)paren
(brace
multiline_comment|/* TERM_TYPE == graphics */
r_struct
id|pci_controller
op_star
id|hose
suffix:semicolon
r_int
id|h
op_assign
(paren
id|pu64
(braket
l_int|30
)braket
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
suffix:semicolon
multiline_comment|/* console hose # */
multiline_comment|/*&n;&t;&t; * Our hose numbering matches the console&squot;s, so just find&n;&t;&t; * the right one...&n;&t;&t; */
r_for
c_loop
(paren
id|hose
op_assign
id|hose_head
suffix:semicolon
id|hose
suffix:semicolon
id|hose
op_assign
id|hose-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|hose-&gt;index
op_eq
id|h
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hose
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Console graphics on hose %d&bslash;n&quot;
comma
id|hose-&gt;index
)paren
suffix:semicolon
id|pci_vga_hose
op_assign
id|hose
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_VGA_HOSE */
)brace
r_void
id|__init
DECL|function|titan_init_arch
id|titan_init_arch
c_func
(paren
r_void
)paren
(brace
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;%s: titan_init_arch()&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: CChip registers:&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: CSR_CSC 0x%lx&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|TITAN_cchip-&gt;csc.csr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: CSR_MTR 0x%lx&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|TITAN_cchip-&gt;mtr.csr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: CSR_MISC 0x%lx&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|TITAN_cchip-&gt;misc.csr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: CSR_DIM0 0x%lx&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|TITAN_cchip-&gt;dim0.csr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: CSR_DIM1 0x%lx&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|TITAN_cchip-&gt;dim1.csr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: CSR_DIR0 0x%lx&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|TITAN_cchip-&gt;dir0.csr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: CSR_DIR1 0x%lx&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|TITAN_cchip-&gt;dir1.csr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: CSR_DRIR 0x%lx&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|TITAN_cchip-&gt;drir.csr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: DChip registers:&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: CSR_DSC 0x%lx&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|TITAN_dchip-&gt;dsc.csr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: CSR_STR 0x%lx&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|TITAN_dchip-&gt;str.csr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: CSR_DREV 0x%lx&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|TITAN_dchip-&gt;drev.csr
)paren
suffix:semicolon
macro_line|#endif
id|boot_cpuid
op_assign
id|__hard_smp_processor_id
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* With multiple PCI busses, we play with I/O as physical addrs.  */
id|ioport_resource.end
op_assign
op_complement
l_int|0UL
suffix:semicolon
id|iomem_resource.end
op_assign
op_complement
l_int|0UL
suffix:semicolon
multiline_comment|/* PCI DMA Direct Mapping is 1GB at 2GB.  */
id|__direct_map_base
op_assign
l_int|0x80000000
suffix:semicolon
id|__direct_map_size
op_assign
l_int|0x40000000
suffix:semicolon
multiline_comment|/* Init the PA chip(s).  */
id|titan_init_pachips
c_func
(paren
id|TITAN_pachip0
comma
id|TITAN_pachip1
)paren
suffix:semicolon
multiline_comment|/* Check for graphic console location (if any).  */
id|titan_init_vga_hose
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|titan_kill_one_pachip_port
id|titan_kill_one_pachip_port
c_func
(paren
id|titan_pachip_port
op_star
id|port
comma
r_int
id|index
)paren
(brace
id|port-&gt;wsba
(braket
l_int|0
)braket
dot
id|csr
op_assign
id|saved_config
(braket
id|index
)braket
dot
id|wsba
(braket
l_int|0
)braket
suffix:semicolon
id|port-&gt;wsm
(braket
l_int|0
)braket
dot
id|csr
op_assign
id|saved_config
(braket
id|index
)braket
dot
id|wsm
(braket
l_int|0
)braket
suffix:semicolon
id|port-&gt;tba
(braket
l_int|0
)braket
dot
id|csr
op_assign
id|saved_config
(braket
id|index
)braket
dot
id|tba
(braket
l_int|0
)braket
suffix:semicolon
id|port-&gt;wsba
(braket
l_int|1
)braket
dot
id|csr
op_assign
id|saved_config
(braket
id|index
)braket
dot
id|wsba
(braket
l_int|1
)braket
suffix:semicolon
id|port-&gt;wsm
(braket
l_int|1
)braket
dot
id|csr
op_assign
id|saved_config
(braket
id|index
)braket
dot
id|wsm
(braket
l_int|1
)braket
suffix:semicolon
id|port-&gt;tba
(braket
l_int|1
)braket
dot
id|csr
op_assign
id|saved_config
(braket
id|index
)braket
dot
id|tba
(braket
l_int|1
)braket
suffix:semicolon
id|port-&gt;wsba
(braket
l_int|2
)braket
dot
id|csr
op_assign
id|saved_config
(braket
id|index
)braket
dot
id|wsba
(braket
l_int|2
)braket
suffix:semicolon
id|port-&gt;wsm
(braket
l_int|2
)braket
dot
id|csr
op_assign
id|saved_config
(braket
id|index
)braket
dot
id|wsm
(braket
l_int|2
)braket
suffix:semicolon
id|port-&gt;tba
(braket
l_int|2
)braket
dot
id|csr
op_assign
id|saved_config
(braket
id|index
)braket
dot
id|tba
(braket
l_int|2
)braket
suffix:semicolon
id|port-&gt;wsba
(braket
l_int|3
)braket
dot
id|csr
op_assign
id|saved_config
(braket
id|index
)braket
dot
id|wsba
(braket
l_int|3
)braket
suffix:semicolon
id|port-&gt;wsm
(braket
l_int|3
)braket
dot
id|csr
op_assign
id|saved_config
(braket
id|index
)braket
dot
id|wsm
(braket
l_int|3
)braket
suffix:semicolon
id|port-&gt;tba
(braket
l_int|3
)braket
dot
id|csr
op_assign
id|saved_config
(braket
id|index
)braket
dot
id|tba
(braket
l_int|3
)braket
suffix:semicolon
)brace
r_static
r_void
DECL|function|titan_kill_pachips
id|titan_kill_pachips
c_func
(paren
id|titan_pachip
op_star
id|pachip0
comma
id|titan_pachip
op_star
id|pachip1
)paren
(brace
r_int
id|pchip1_present
op_assign
id|TITAN_cchip-&gt;csc.csr
op_amp
l_int|1L
op_lshift
l_int|14
suffix:semicolon
r_if
c_cond
(paren
id|pchip1_present
)paren
(brace
id|titan_kill_one_pachip_port
c_func
(paren
op_amp
id|pachip1-&gt;g_port
comma
l_int|1
)paren
suffix:semicolon
id|titan_kill_one_pachip_port
c_func
(paren
op_amp
id|pachip1-&gt;a_port
comma
l_int|3
)paren
suffix:semicolon
)brace
id|titan_kill_one_pachip_port
c_func
(paren
op_amp
id|pachip0-&gt;g_port
comma
l_int|0
)paren
suffix:semicolon
id|titan_kill_one_pachip_port
c_func
(paren
op_amp
id|pachip0-&gt;a_port
comma
l_int|2
)paren
suffix:semicolon
)brace
r_void
DECL|function|titan_kill_arch
id|titan_kill_arch
c_func
(paren
r_int
id|mode
)paren
(brace
id|titan_kill_pachips
c_func
(paren
id|TITAN_pachip0
comma
id|TITAN_pachip1
)paren
suffix:semicolon
)brace
"&f;"
multiline_comment|/*&n; * IO map support.&n; */
r_int
r_int
DECL|function|titan_ioremap
id|titan_ioremap
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|size
)paren
(brace
r_int
id|h
op_assign
(paren
id|addr
op_amp
id|TITAN_HOSE_MASK
)paren
op_rshift
id|TITAN_HOSE_SHIFT
suffix:semicolon
r_int
r_int
id|baddr
op_assign
id|addr
op_amp
op_complement
id|TITAN_HOSE_MASK
suffix:semicolon
r_int
r_int
id|last
op_assign
id|baddr
op_plus
id|size
op_minus
l_int|1
suffix:semicolon
r_struct
id|pci_controller
op_star
id|hose
suffix:semicolon
r_struct
id|vm_struct
op_star
id|area
suffix:semicolon
r_int
r_int
id|vaddr
suffix:semicolon
r_int
r_int
op_star
id|ptes
suffix:semicolon
r_int
r_int
id|pfn
suffix:semicolon
multiline_comment|/*&n;&t; * Adjust the addr.&n;&t; */
macro_line|#ifdef CONFIG_VGA_HOSE
r_if
c_cond
(paren
id|pci_vga_hose
op_logical_and
id|__titan_is_mem_vga
c_func
(paren
id|addr
)paren
)paren
(brace
id|h
op_assign
id|pci_vga_hose-&gt;index
suffix:semicolon
id|addr
op_add_assign
id|pci_vga_hose-&gt;mem_space-&gt;start
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t; * Find the hose.&n;&t; */
r_for
c_loop
(paren
id|hose
op_assign
id|hose_head
suffix:semicolon
id|hose
suffix:semicolon
id|hose
op_assign
id|hose-&gt;next
)paren
r_if
c_cond
(paren
id|hose-&gt;index
op_eq
id|h
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hose
)paren
r_return
(paren
r_int
r_int
)paren
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t; * Is it direct-mapped?&n;&t; */
r_if
c_cond
(paren
(paren
id|baddr
op_ge
id|__direct_map_base
)paren
op_logical_and
(paren
(paren
id|baddr
op_plus
id|size
op_minus
l_int|1
)paren
OL
id|__direct_map_base
op_plus
id|__direct_map_size
)paren
)paren
r_return
id|addr
op_minus
id|__direct_map_base
op_plus
id|TITAN_MEM_BIAS
suffix:semicolon
multiline_comment|/* &n;&t; * Check the scatter-gather arena.&n;&t; */
r_if
c_cond
(paren
id|hose-&gt;sg_pci
op_logical_and
id|baddr
op_ge
(paren
r_int
r_int
)paren
id|hose-&gt;sg_pci-&gt;dma_base
op_logical_and
id|last
OL
(paren
r_int
r_int
)paren
id|hose-&gt;sg_pci-&gt;dma_base
op_plus
id|hose-&gt;sg_pci-&gt;size
)paren
(brace
multiline_comment|/*&n;&t;&t; * Adjust the limits (mappings must be page aligned)&n;&t;&t; */
id|baddr
op_sub_assign
id|hose-&gt;sg_pci-&gt;dma_base
suffix:semicolon
id|last
op_sub_assign
id|hose-&gt;sg_pci-&gt;dma_base
suffix:semicolon
id|baddr
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|size
op_assign
id|PAGE_ALIGN
c_func
(paren
id|last
)paren
op_minus
id|baddr
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Map it&n;&t;&t; */
id|area
op_assign
id|get_vm_area
c_func
(paren
id|size
comma
id|VM_IOREMAP
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|area
)paren
r_return
(paren
r_int
r_int
)paren
l_int|NULL
suffix:semicolon
id|ptes
op_assign
id|hose-&gt;sg_pci-&gt;ptes
suffix:semicolon
r_for
c_loop
(paren
id|vaddr
op_assign
(paren
r_int
r_int
)paren
id|area-&gt;addr
suffix:semicolon
id|baddr
op_le
id|last
suffix:semicolon
id|baddr
op_add_assign
id|PAGE_SIZE
comma
id|vaddr
op_add_assign
id|PAGE_SIZE
)paren
(brace
id|pfn
op_assign
id|ptes
(braket
id|baddr
op_rshift
id|PAGE_SHIFT
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pfn
op_amp
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ioremap failed... pte not valid...&bslash;n&quot;
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|area-&gt;addr
)paren
suffix:semicolon
r_return
(paren
r_int
r_int
)paren
l_int|NULL
suffix:semicolon
)brace
id|pfn
op_rshift_assign
l_int|1
suffix:semicolon
multiline_comment|/* make it a true pfn */
r_if
c_cond
(paren
id|__alpha_remap_area_pages
c_func
(paren
id|VMALLOC_VMADDR
c_func
(paren
id|vaddr
)paren
comma
id|pfn
op_lshift
id|PAGE_SHIFT
comma
id|PAGE_SIZE
comma
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;FAILED to map...&bslash;n&quot;
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|area-&gt;addr
)paren
suffix:semicolon
r_return
(paren
r_int
r_int
)paren
l_int|NULL
suffix:semicolon
)brace
)brace
id|flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
id|vaddr
op_assign
(paren
r_int
r_int
)paren
id|area-&gt;addr
op_plus
(paren
id|addr
op_amp
op_complement
id|PAGE_MASK
)paren
suffix:semicolon
r_return
id|vaddr
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Not found - assume legacy ioremap.&n;&t; */
r_return
id|addr
op_plus
id|TITAN_MEM_BIAS
suffix:semicolon
)brace
r_void
DECL|function|titan_iounmap
id|titan_iounmap
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
r_int
)paren
id|addr
op_rshift
l_int|41
)paren
op_eq
op_minus
l_int|2
)paren
r_return
suffix:semicolon
multiline_comment|/* kseg map, nothing to do */
r_if
c_cond
(paren
id|addr
)paren
id|vfree
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|PAGE_MASK
op_amp
id|addr
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifndef CONFIG_ALPHA_GENERIC
DECL|variable|titan_ioremap
id|EXPORT_SYMBOL
c_func
(paren
id|titan_ioremap
)paren
suffix:semicolon
DECL|variable|titan_iounmap
id|EXPORT_SYMBOL
c_func
(paren
id|titan_iounmap
)paren
suffix:semicolon
macro_line|#endif
"&f;"
multiline_comment|/*&n; * AGP GART Support.&n; */
macro_line|#include &lt;linux/agp_backend.h&gt;
macro_line|#include &lt;asm/agp_backend.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
DECL|macro|TITAN_AGP_APER_SIZE
mdefine_line|#define TITAN_AGP_APER_SIZE (64 * 1024 * 1024)
DECL|struct|titan_agp_aperture
r_struct
id|titan_agp_aperture
(brace
DECL|member|arena
r_struct
id|pci_iommu_arena
op_star
id|arena
suffix:semicolon
DECL|member|pg_start
r_int
id|pg_start
suffix:semicolon
DECL|member|pg_count
r_int
id|pg_count
suffix:semicolon
)brace
suffix:semicolon
r_static
r_int
DECL|function|titan_agp_setup
id|titan_agp_setup
c_func
(paren
id|alpha_agp_info
op_star
id|agp
)paren
(brace
r_struct
id|titan_agp_aperture
op_star
id|aper
suffix:semicolon
id|aper
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|titan_agp_aperture
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|aper
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|aper-&gt;arena
op_assign
id|agp-&gt;hose-&gt;sg_pci
suffix:semicolon
id|aper-&gt;pg_count
op_assign
id|TITAN_AGP_APER_SIZE
op_div
id|PAGE_SIZE
suffix:semicolon
id|aper-&gt;pg_start
op_assign
id|iommu_reserve
c_func
(paren
id|aper-&gt;arena
comma
id|aper-&gt;pg_count
comma
id|aper-&gt;pg_count
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|aper-&gt;pg_start
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Failed to reserve AGP memory&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|aper
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|agp-&gt;aperture.bus_base
op_assign
id|aper-&gt;arena-&gt;dma_base
op_plus
id|aper-&gt;pg_start
op_star
id|PAGE_SIZE
suffix:semicolon
id|agp-&gt;aperture.size
op_assign
id|aper-&gt;pg_count
op_star
id|PAGE_SIZE
suffix:semicolon
id|agp-&gt;aperture.sysdata
op_assign
id|aper
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|titan_agp_cleanup
id|titan_agp_cleanup
c_func
(paren
id|alpha_agp_info
op_star
id|agp
)paren
(brace
r_struct
id|titan_agp_aperture
op_star
id|aper
op_assign
id|agp-&gt;aperture.sysdata
suffix:semicolon
r_int
id|status
suffix:semicolon
id|status
op_assign
id|iommu_release
c_func
(paren
id|aper-&gt;arena
comma
id|aper-&gt;pg_start
comma
id|aper-&gt;pg_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
op_minus
id|EBUSY
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Attempted to release bound AGP memory - unbinding&bslash;n&quot;
)paren
suffix:semicolon
id|iommu_unbind
c_func
(paren
id|aper-&gt;arena
comma
id|aper-&gt;pg_start
comma
id|aper-&gt;pg_count
)paren
suffix:semicolon
id|status
op_assign
id|iommu_release
c_func
(paren
id|aper-&gt;arena
comma
id|aper-&gt;pg_start
comma
id|aper-&gt;pg_count
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Failed to release AGP memory&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|aper
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|agp
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|titan_agp_configure
id|titan_agp_configure
c_func
(paren
id|alpha_agp_info
op_star
id|agp
)paren
(brace
r_union
id|TPAchipPCTL
id|pctl
suffix:semicolon
id|titan_pachip_port
op_star
id|port
op_assign
id|agp
op_member_access_from_pointer
r_private
suffix:semicolon
id|pctl.pctl_q_whole
op_assign
id|port-&gt;pctl.csr
suffix:semicolon
multiline_comment|/* Side-Band Addressing? */
id|pctl.pctl_r_bits.apctl_v_agp_sba_en
op_assign
id|agp-&gt;mode.bits.sba
suffix:semicolon
multiline_comment|/* AGP Rate? */
id|pctl.pctl_r_bits.apctl_v_agp_rate
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 1x */
r_if
c_cond
(paren
id|agp-&gt;mode.bits.rate
op_amp
l_int|2
)paren
id|pctl.pctl_r_bits.apctl_v_agp_rate
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* 2x */
macro_line|#if 0
r_if
c_cond
(paren
id|agp-&gt;mode.bits.rate
op_amp
l_int|4
)paren
id|pctl.pctl_r_bits.apctl_v_agp_rate
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* 4x */
macro_line|#endif
multiline_comment|/* RQ Depth? */
id|pctl.pctl_r_bits.apctl_v_agp_hp_rd
op_assign
l_int|2
suffix:semicolon
id|pctl.pctl_r_bits.apctl_v_agp_lp_rd
op_assign
l_int|7
suffix:semicolon
multiline_comment|/*&n;&t; * AGP Enable.&n;&t; */
id|pctl.pctl_r_bits.apctl_v_agp_en
op_assign
id|agp-&gt;mode.bits.enable
suffix:semicolon
multiline_comment|/* Tell the user.  */
id|printk
c_func
(paren
l_string|&quot;Enabling AGP: %dX%s&bslash;n&quot;
comma
l_int|1
op_lshift
id|pctl.pctl_r_bits.apctl_v_agp_rate
comma
id|pctl.pctl_r_bits.apctl_v_agp_sba_en
ques
c_cond
l_string|&quot; - SBA&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
multiline_comment|/* Write it.  */
id|port-&gt;pctl.csr
op_assign
id|pctl.pctl_q_whole
suffix:semicolon
multiline_comment|/* And wait at least 5000 66MHz cycles (per Titan spec).  */
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|titan_agp_bind_memory
id|titan_agp_bind_memory
c_func
(paren
id|alpha_agp_info
op_star
id|agp
comma
id|off_t
id|pg_start
comma
id|agp_memory
op_star
id|mem
)paren
(brace
r_struct
id|titan_agp_aperture
op_star
id|aper
op_assign
id|agp-&gt;aperture.sysdata
suffix:semicolon
r_return
id|iommu_bind
c_func
(paren
id|aper-&gt;arena
comma
id|aper-&gt;pg_start
op_plus
id|pg_start
comma
id|mem-&gt;page_count
comma
id|mem-&gt;memory
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|titan_agp_unbind_memory
id|titan_agp_unbind_memory
c_func
(paren
id|alpha_agp_info
op_star
id|agp
comma
id|off_t
id|pg_start
comma
id|agp_memory
op_star
id|mem
)paren
(brace
r_struct
id|titan_agp_aperture
op_star
id|aper
op_assign
id|agp-&gt;aperture.sysdata
suffix:semicolon
r_return
id|iommu_unbind
c_func
(paren
id|aper-&gt;arena
comma
id|aper-&gt;pg_start
op_plus
id|pg_start
comma
id|mem-&gt;page_count
)paren
suffix:semicolon
)brace
r_static
r_int
r_int
DECL|function|titan_agp_translate
id|titan_agp_translate
c_func
(paren
id|alpha_agp_info
op_star
id|agp
comma
id|dma_addr_t
id|addr
)paren
(brace
r_struct
id|titan_agp_aperture
op_star
id|aper
op_assign
id|agp-&gt;aperture.sysdata
suffix:semicolon
r_int
r_int
id|baddr
op_assign
id|addr
op_minus
id|aper-&gt;arena-&gt;dma_base
suffix:semicolon
r_int
r_int
id|pte
suffix:semicolon
r_if
c_cond
(paren
id|addr
OL
id|agp-&gt;aperture.bus_base
op_logical_or
id|addr
op_ge
id|agp-&gt;aperture.bus_base
op_plus
id|agp-&gt;aperture.size
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: addr out of range&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|pte
op_assign
id|aper-&gt;arena-&gt;ptes
(braket
id|baddr
op_rshift
id|PAGE_SHIFT
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pte
op_amp
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: pte not valid&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
(paren
id|pte
op_rshift
l_int|1
)paren
op_lshift
id|PAGE_SHIFT
suffix:semicolon
)brace
DECL|variable|titan_agp_ops
r_struct
id|alpha_agp_ops
id|titan_agp_ops
op_assign
(brace
id|setup
suffix:colon
id|titan_agp_setup
comma
id|cleanup
suffix:colon
id|titan_agp_cleanup
comma
id|configure
suffix:colon
id|titan_agp_configure
comma
id|bind
suffix:colon
id|titan_agp_bind_memory
comma
id|unbind
suffix:colon
id|titan_agp_unbind_memory
comma
id|translate
suffix:colon
id|titan_agp_translate
)brace
suffix:semicolon
id|alpha_agp_info
op_star
DECL|function|titan_agp_info
id|titan_agp_info
c_func
(paren
r_void
)paren
(brace
id|alpha_agp_info
op_star
id|agp
suffix:semicolon
r_struct
id|pci_controller
op_star
id|hose
suffix:semicolon
id|titan_pachip_port
op_star
id|port
suffix:semicolon
r_int
id|hosenum
op_assign
op_minus
l_int|1
suffix:semicolon
r_union
id|TPAchipPCTL
id|pctl
suffix:semicolon
multiline_comment|/*&n;&t; * Find the AGP port.&n;&t; */
id|port
op_assign
op_amp
id|TITAN_pachip0-&gt;a_port
suffix:semicolon
r_if
c_cond
(paren
id|titan_query_agp
c_func
(paren
id|port
)paren
)paren
id|hosenum
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|hosenum
OL
l_int|0
op_logical_and
id|titan_query_agp
c_func
(paren
id|port
op_assign
op_amp
id|TITAN_pachip1-&gt;a_port
)paren
)paren
id|hosenum
op_assign
l_int|3
suffix:semicolon
multiline_comment|/*&n;&t; * Find the hose the port is on.&n;&t; */
r_for
c_loop
(paren
id|hose
op_assign
id|hose_head
suffix:semicolon
id|hose
suffix:semicolon
id|hose
op_assign
id|hose-&gt;next
)paren
r_if
c_cond
(paren
id|hose-&gt;index
op_eq
id|hosenum
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hose
op_logical_or
op_logical_neg
id|hose-&gt;sg_pci
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t; * Allocate the info structure.&n;&t; */
id|agp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|agp
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Fill it in.&n;&t; */
id|agp-&gt;type
op_assign
l_int|0
multiline_comment|/* FIXME: ALPHA_CORE_AGP */
suffix:semicolon
id|agp-&gt;hose
op_assign
id|hose
suffix:semicolon
id|agp
op_member_access_from_pointer
r_private
op_assign
id|port
suffix:semicolon
id|agp-&gt;ops
op_assign
op_amp
id|titan_agp_ops
suffix:semicolon
multiline_comment|/*&n;&t; * Aperture - not configured until ops.setup().&n;&t; *&n;&t; * FIXME - should we go ahead and allocate it here?&n;&t; */
id|agp-&gt;aperture.bus_base
op_assign
l_int|0
suffix:semicolon
id|agp-&gt;aperture.size
op_assign
l_int|0
suffix:semicolon
id|agp-&gt;aperture.sysdata
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t; * Capabilities.&n;&t; */
id|agp-&gt;capability.lw
op_assign
l_int|0
suffix:semicolon
id|agp-&gt;capability.bits.rate
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* 2x, 1x */
id|agp-&gt;capability.bits.sba
op_assign
l_int|1
suffix:semicolon
id|agp-&gt;capability.bits.rq
op_assign
l_int|7
suffix:semicolon
multiline_comment|/* 8 - 1 */
multiline_comment|/*&n;&t; * Mode.&n;&t; */
id|pctl.pctl_q_whole
op_assign
id|port-&gt;pctl.csr
suffix:semicolon
id|agp-&gt;mode.lw
op_assign
l_int|0
suffix:semicolon
id|agp-&gt;mode.bits.rate
op_assign
l_int|1
op_lshift
id|pctl.pctl_r_bits.apctl_v_agp_rate
suffix:semicolon
id|agp-&gt;mode.bits.sba
op_assign
id|pctl.pctl_r_bits.apctl_v_agp_sba_en
suffix:semicolon
id|agp-&gt;mode.bits.rq
op_assign
l_int|7
suffix:semicolon
multiline_comment|/* RQ Depth? */
id|agp-&gt;mode.bits.enable
op_assign
id|pctl.pctl_r_bits.apctl_v_agp_en
suffix:semicolon
r_return
id|agp
suffix:semicolon
)brace
eof
