multiline_comment|/**&n; * @file arch/alpha/oprofile/op_model_ev6.c&n; *&n; * @remark Copyright 2002 OProfile authors&n; * @remark Read the file COPYING&n; *&n; * @author Richard Henderson &lt;rth@twiddle.net&gt;&n; */
macro_line|#include &lt;linux/oprofile.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &quot;op_impl.h&quot;
multiline_comment|/* Compute all of the registers in preparation for enabling profiling.  */
r_static
r_void
DECL|function|ev6_reg_setup
id|ev6_reg_setup
c_func
(paren
r_struct
id|op_register_config
op_star
id|reg
comma
r_struct
id|op_counter_config
op_star
id|ctr
comma
r_struct
id|op_system_config
op_star
id|sys
)paren
(brace
r_int
r_int
id|ctl
comma
id|reset
comma
id|need_reset
comma
id|i
suffix:semicolon
multiline_comment|/* Select desired events.  We&squot;ve mapped the event numbers&n;&t;   such that they fit directly into the event selection fields.  */
id|ctl
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ctr
(braket
l_int|0
)braket
dot
id|enabled
op_logical_and
id|ctr
(braket
l_int|0
)braket
dot
id|event
)paren
id|ctl
op_or_assign
(paren
id|ctr
(braket
l_int|0
)braket
dot
id|event
op_amp
l_int|1
)paren
op_lshift
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|ctr
(braket
l_int|1
)braket
dot
id|enabled
)paren
id|ctl
op_or_assign
(paren
id|ctr
(braket
l_int|1
)braket
dot
id|event
op_minus
l_int|2
)paren
op_amp
l_int|15
suffix:semicolon
id|reg-&gt;mux_select
op_assign
id|ctl
suffix:semicolon
multiline_comment|/* Select logging options.  */
multiline_comment|/* ??? Need to come up with some mechanism to trace only&n;&t;   selected processes.  EV6 does not have a mechanism to&n;&t;   select kernel or user mode only.  For now, enable always.  */
id|reg-&gt;proc_mode
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* EV6 cannot change the width of the counters as with the&n;&t;   other implementations.  But fortunately, we can write to&n;&t;   the counters and set the value such that it will overflow&n;&t;   at the right time.  */
id|reset
op_assign
id|need_reset
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
op_increment
id|i
)paren
(brace
r_int
r_int
id|count
op_assign
id|ctr
(braket
id|i
)braket
dot
id|count
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctr
(braket
id|i
)braket
dot
id|enabled
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|0x100000
)paren
id|count
op_assign
l_int|0x100000
suffix:semicolon
id|ctr
(braket
id|i
)braket
dot
id|count
op_assign
id|count
suffix:semicolon
id|reset
op_or_assign
(paren
l_int|0x100000
op_minus
id|count
)paren
op_lshift
(paren
id|i
ques
c_cond
l_int|6
suffix:colon
l_int|28
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_ne
l_int|0x100000
)paren
id|need_reset
op_or_assign
l_int|1
op_lshift
id|i
suffix:semicolon
)brace
id|reg-&gt;reset_values
op_assign
id|reset
suffix:semicolon
id|reg-&gt;need_reset
op_assign
id|need_reset
suffix:semicolon
)brace
multiline_comment|/* Program all of the registers in preparation for enabling profiling.  */
r_static
r_void
DECL|function|ev6_cpu_setup
id|ev6_cpu_setup
(paren
r_void
op_star
id|x
)paren
(brace
r_struct
id|op_register_config
op_star
id|reg
op_assign
id|x
suffix:semicolon
id|wrperfmon
c_func
(paren
l_int|2
comma
id|reg-&gt;mux_select
)paren
suffix:semicolon
id|wrperfmon
c_func
(paren
l_int|3
comma
id|reg-&gt;proc_mode
)paren
suffix:semicolon
id|wrperfmon
c_func
(paren
l_int|6
comma
id|reg-&gt;reset_values
op_or
l_int|3
)paren
suffix:semicolon
)brace
multiline_comment|/* CTR is a counter for which the user has requested an interrupt count&n;   in between one of the widths selectable in hardware.  Reset the count&n;   for CTR to the value stored in REG-&gt;RESET_VALUES.  */
r_static
r_void
DECL|function|ev6_reset_ctr
id|ev6_reset_ctr
c_func
(paren
r_struct
id|op_register_config
op_star
id|reg
comma
r_int
r_int
id|ctr
)paren
(brace
id|wrperfmon
c_func
(paren
l_int|6
comma
id|reg-&gt;reset_values
op_or
(paren
l_int|1
op_lshift
id|ctr
)paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ev6_handle_interrupt
id|ev6_handle_interrupt
c_func
(paren
r_int
r_int
id|which
comma
r_struct
id|pt_regs
op_star
id|regs
comma
r_struct
id|op_counter_config
op_star
id|ctr
)paren
(brace
multiline_comment|/* Record the sample.  */
id|oprofile_add_sample
c_func
(paren
id|regs-&gt;pc
comma
id|which
comma
id|smp_processor_id
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
DECL|variable|op_model_ev6
r_struct
id|op_axp_model
id|op_model_ev6
op_assign
(brace
dot
id|reg_setup
op_assign
id|ev6_reg_setup
comma
dot
id|cpu_setup
op_assign
id|ev6_cpu_setup
comma
dot
id|reset_ctr
op_assign
id|ev6_reset_ctr
comma
dot
id|handle_interrupt
op_assign
id|ev6_handle_interrupt
comma
dot
id|cpu
op_assign
l_string|&quot;alpha/ev6&quot;
comma
dot
id|num_counters
op_assign
l_int|2
comma
dot
id|can_set_proc_mode
op_assign
l_int|0
comma
)brace
suffix:semicolon
eof
