multiline_comment|/* $Id: old_checksum.c,v 1.1 2000/07/10 16:25:21 bjornw Exp $&n; *&n; * INET&t;&t;An implementation of the TCP/IP protocol suite for the LINUX&n; *&t;&t;operating system.  INET is implemented using the  BSD Socket&n; *&t;&t;interface as the means of communication with the user level.&n; *&n; *&t;&t;IP/TCP/UDP checksumming routines&n; *&n; * Authors:&t;Jorge Cwik, &lt;jorge@laser.satlink.net&gt;&n; *&t;&t;Arnt Gulbrandsen, &lt;agulbra@nvg.unit.no&gt;&n; *&t;&t;Tom May, &lt;ftom@netcom.com&gt;&n; *&t;&t;Lots of code moved from tcp.c and ip.c; see those files&n; *&t;&t;for more names.&n; *&n; *&t;&t;This program is free software; you can redistribute it and/or&n; *&t;&t;modify it under the terms of the GNU General Public License&n; *&t;&t;as published by the Free Software Foundation; either version&n; *&t;&t;2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;net/checksum.h&gt;
DECL|macro|PROFILE_CHECKSUM
macro_line|#undef PROFILE_CHECKSUM
macro_line|#ifdef PROFILE_CHECKSUM
multiline_comment|/* these are just for profiling the checksum code with an oscillioscope.. uh */
macro_line|#if 0
mdefine_line|#define BITOFF *((unsigned char *)0xb0000030) = 0xff
mdefine_line|#define BITON *((unsigned char *)0xb0000030) = 0x0
macro_line|#endif
macro_line|#include &lt;asm/io.h&gt;
DECL|macro|CBITON
mdefine_line|#define CBITON LED_ACTIVE_SET(1)
DECL|macro|CBITOFF
mdefine_line|#define CBITOFF LED_ACTIVE_SET(0)
DECL|macro|BITOFF
mdefine_line|#define BITOFF
DECL|macro|BITON
mdefine_line|#define BITON
macro_line|#else
DECL|macro|BITOFF
mdefine_line|#define BITOFF
DECL|macro|BITON
mdefine_line|#define BITON
DECL|macro|CBITOFF
mdefine_line|#define CBITOFF
DECL|macro|CBITON
mdefine_line|#define CBITON
macro_line|#endif
multiline_comment|/*&n; * computes a partial checksum, e.g. for TCP/UDP fragments&n; */
macro_line|#include &lt;asm/delay.h&gt;
DECL|function|csum_partial
r_int
r_int
id|csum_partial
c_func
(paren
r_const
r_int
r_char
op_star
id|buff
comma
r_int
id|len
comma
r_int
r_int
id|sum
)paren
(brace
multiline_comment|/*&n;   * Experiments with ethernet and slip connections show that buff&n;   * is aligned on either a 2-byte or 4-byte boundary.&n;   */
r_const
r_int
r_char
op_star
id|endMarker
op_assign
id|buff
op_plus
id|len
suffix:semicolon
r_const
r_int
r_char
op_star
id|marker
op_assign
id|endMarker
op_minus
(paren
id|len
op_mod
l_int|16
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
(paren
r_int
)paren
id|buff
op_amp
l_int|0x3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;unaligned buff %p&bslash;n&quot;
comma
id|buff
)paren
suffix:semicolon
)brace
id|__delay
c_func
(paren
l_int|900
)paren
suffix:semicolon
multiline_comment|/* extra delay of 90 us to test performance hit */
macro_line|#endif
id|BITON
suffix:semicolon
r_while
c_loop
(paren
id|buff
OL
id|marker
)paren
(brace
id|sum
op_add_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|buff
)paren
op_increment
suffix:semicolon
id|sum
op_add_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|buff
)paren
op_increment
suffix:semicolon
id|sum
op_add_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|buff
)paren
op_increment
suffix:semicolon
id|sum
op_add_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|buff
)paren
op_increment
suffix:semicolon
id|sum
op_add_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|buff
)paren
op_increment
suffix:semicolon
id|sum
op_add_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|buff
)paren
op_increment
suffix:semicolon
id|sum
op_add_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|buff
)paren
op_increment
suffix:semicolon
id|sum
op_add_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|buff
)paren
op_increment
suffix:semicolon
)brace
id|marker
op_assign
id|endMarker
op_minus
(paren
id|len
op_mod
l_int|2
)paren
suffix:semicolon
r_while
c_loop
(paren
id|buff
OL
id|marker
)paren
(brace
id|sum
op_add_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|buff
)paren
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|endMarker
op_minus
id|buff
OG
l_int|0
)paren
(brace
id|sum
op_add_assign
op_star
id|buff
suffix:semicolon
multiline_comment|/* add extra byte seperately */
)brace
id|BITOFF
suffix:semicolon
r_return
id|sum
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/*&n; * copy while checksumming, otherwise like csum_partial&n; */
r_int
r_int
id|csum_partial_copy
c_func
(paren
r_const
r_int
r_char
op_star
id|src
comma
r_int
r_char
op_star
id|dst
comma
r_int
id|len
comma
r_int
r_int
id|sum
)paren
(brace
r_const
r_int
r_char
op_star
id|endMarker
suffix:semicolon
r_const
r_int
r_char
op_star
id|marker
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;csum_partial_copy len %d.&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
(paren
r_int
)paren
id|src
op_amp
l_int|0x3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;unaligned src %p&bslash;n&quot;
comma
id|src
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
r_int
)paren
id|dst
op_amp
l_int|0x3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;unaligned dst %p&bslash;n&quot;
comma
id|dst
)paren
suffix:semicolon
)brace
id|__delay
c_func
(paren
l_int|1800
)paren
suffix:semicolon
multiline_comment|/* extra delay of 90 us to test performance hit */
macro_line|#endif
id|endMarker
op_assign
id|src
op_plus
id|len
suffix:semicolon
id|marker
op_assign
id|endMarker
op_minus
(paren
id|len
op_mod
l_int|16
)paren
suffix:semicolon
id|CBITON
suffix:semicolon
r_while
c_loop
(paren
id|src
OL
id|marker
)paren
(brace
id|sum
op_add_assign
(paren
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|dst
)paren
op_increment
op_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|src
)paren
op_increment
)paren
suffix:semicolon
id|sum
op_add_assign
(paren
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|dst
)paren
op_increment
op_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|src
)paren
op_increment
)paren
suffix:semicolon
id|sum
op_add_assign
(paren
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|dst
)paren
op_increment
op_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|src
)paren
op_increment
)paren
suffix:semicolon
id|sum
op_add_assign
(paren
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|dst
)paren
op_increment
op_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|src
)paren
op_increment
)paren
suffix:semicolon
id|sum
op_add_assign
(paren
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|dst
)paren
op_increment
op_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|src
)paren
op_increment
)paren
suffix:semicolon
id|sum
op_add_assign
(paren
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|dst
)paren
op_increment
op_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|src
)paren
op_increment
)paren
suffix:semicolon
id|sum
op_add_assign
(paren
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|dst
)paren
op_increment
op_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|src
)paren
op_increment
)paren
suffix:semicolon
id|sum
op_add_assign
(paren
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|dst
)paren
op_increment
op_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|src
)paren
op_increment
)paren
suffix:semicolon
)brace
id|marker
op_assign
id|endMarker
op_minus
(paren
id|len
op_mod
l_int|2
)paren
suffix:semicolon
r_while
c_loop
(paren
id|src
OL
id|marker
)paren
(brace
id|sum
op_add_assign
(paren
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|dst
)paren
op_increment
op_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|src
)paren
op_increment
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|endMarker
op_minus
id|src
OG
l_int|0
)paren
(brace
id|sum
op_add_assign
(paren
op_star
id|dst
op_assign
op_star
id|src
)paren
suffix:semicolon
multiline_comment|/* add extra byte seperately */
)brace
id|CBITOFF
suffix:semicolon
r_return
id|sum
suffix:semicolon
)brace
macro_line|#endif
eof
