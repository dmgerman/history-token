multiline_comment|/*&n; *  linux/arch/cris/mm/fault.c&n; *&n; *  Low level bus fault handler&n; *&n; *&n; *  Copyright (C) 2000, 2001  Axis Communications AB&n; *&n; *  Authors:  Bjorn Wesen &n; * &n; */
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/arch/svinto.h&gt;
multiline_comment|/* debug of low-level TLB reload */
DECL|macro|DEBUG
macro_line|#undef DEBUG
macro_line|#ifdef DEBUG
DECL|macro|D
mdefine_line|#define D(x) x
macro_line|#else
DECL|macro|D
mdefine_line|#define D(x)
macro_line|#endif
r_extern
r_volatile
id|pgd_t
op_star
id|current_pgd
suffix:semicolon
r_extern
r_const
r_struct
id|exception_table_entry
op_star
id|search_exception_tables
c_func
(paren
r_int
r_int
id|addr
)paren
suffix:semicolon
id|asmlinkage
r_void
id|do_page_fault
c_func
(paren
r_int
r_int
id|address
comma
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|protection
comma
r_int
id|writeaccess
)paren
suffix:semicolon
multiline_comment|/* fast TLB-fill fault handler&n; * this is called from entry.S with interrupts disabled&n; */
r_void
DECL|function|handle_mmu_bus_fault
id|handle_mmu_bus_fault
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|cause
suffix:semicolon
r_int
id|select
suffix:semicolon
macro_line|#ifdef DEBUG
r_int
id|index
suffix:semicolon
r_int
id|page_id
suffix:semicolon
r_int
id|acc
comma
id|inv
suffix:semicolon
macro_line|#endif
id|pgd_t
op_star
id|pgd
op_assign
(paren
id|pgd_t
op_star
)paren
id|current_pgd
suffix:semicolon
id|pmd_t
op_star
id|pmd
suffix:semicolon
id|pte_t
id|pte
suffix:semicolon
r_int
id|miss
comma
id|we
comma
id|writeac
suffix:semicolon
r_int
r_int
id|address
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|cause
op_assign
op_star
id|R_MMU_CAUSE
suffix:semicolon
id|address
op_assign
id|cause
op_amp
id|PAGE_MASK
suffix:semicolon
multiline_comment|/* get faulting address */
id|select
op_assign
op_star
id|R_TLB_SELECT
suffix:semicolon
macro_line|#ifdef DEBUG
id|page_id
op_assign
id|IO_EXTRACT
c_func
(paren
id|R_MMU_CAUSE
comma
id|page_id
comma
id|cause
)paren
suffix:semicolon
id|acc
op_assign
id|IO_EXTRACT
c_func
(paren
id|R_MMU_CAUSE
comma
id|acc_excp
comma
id|cause
)paren
suffix:semicolon
id|inv
op_assign
id|IO_EXTRACT
c_func
(paren
id|R_MMU_CAUSE
comma
id|inv_excp
comma
id|cause
)paren
suffix:semicolon
id|index
op_assign
id|IO_EXTRACT
c_func
(paren
id|R_TLB_SELECT
comma
id|index
comma
id|select
)paren
suffix:semicolon
macro_line|#endif
id|miss
op_assign
id|IO_EXTRACT
c_func
(paren
id|R_MMU_CAUSE
comma
id|miss_excp
comma
id|cause
)paren
suffix:semicolon
id|we
op_assign
id|IO_EXTRACT
c_func
(paren
id|R_MMU_CAUSE
comma
id|we_excp
comma
id|cause
)paren
suffix:semicolon
id|writeac
op_assign
id|IO_EXTRACT
c_func
(paren
id|R_MMU_CAUSE
comma
id|wr_rd
comma
id|cause
)paren
suffix:semicolon
id|D
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;bus_fault from IRP 0x%lx: addr 0x%lx, miss %d, inv %d, we %d, acc %d, dx %d pid %d&bslash;n&quot;
comma
id|regs-&gt;irp
comma
id|address
comma
id|miss
comma
id|inv
comma
id|we
comma
id|acc
comma
id|index
comma
id|page_id
)paren
)paren
suffix:semicolon
multiline_comment|/* leave it to the MM system fault handler */
r_if
c_cond
(paren
id|miss
)paren
id|do_page_fault
c_func
(paren
id|address
comma
id|regs
comma
l_int|0
comma
id|writeac
)paren
suffix:semicolon
r_else
id|do_page_fault
c_func
(paren
id|address
comma
id|regs
comma
l_int|1
comma
id|we
)paren
suffix:semicolon
multiline_comment|/* Reload TLB with new entry to avoid an extra miss exception.&n;&t; * do_page_fault may have flushed the TLB so we have to restore&n;&t; * the MMU registers.&n;&t; */
id|local_save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
id|pmd
op_assign
(paren
id|pmd_t
op_star
)paren
(paren
id|pgd
op_plus
id|pgd_index
c_func
(paren
id|address
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmd_none
c_func
(paren
op_star
id|pmd
)paren
)paren
r_return
suffix:semicolon
id|pte
op_assign
op_star
id|pte_offset_kernel
c_func
(paren
id|pmd
comma
id|address
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pte_present
c_func
(paren
id|pte
)paren
)paren
r_return
suffix:semicolon
op_star
id|R_TLB_SELECT
op_assign
id|select
suffix:semicolon
op_star
id|R_TLB_HI
op_assign
id|cause
suffix:semicolon
op_star
id|R_TLB_LO
op_assign
id|pte_val
c_func
(paren
id|pte
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Called from arch/cris/mm/fault.c to find fixup code. */
r_int
DECL|function|find_fixup_code
id|find_fixup_code
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_const
r_struct
id|exception_table_entry
op_star
id|fixup
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fixup
op_assign
id|search_exception_tables
c_func
(paren
id|regs-&gt;irp
)paren
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Adjust the instruction pointer in the stackframe. */
id|regs-&gt;irp
op_assign
id|fixup-&gt;fixup
suffix:semicolon
multiline_comment|/* &n;&t;&t; * Don&squot;t return by restoring the CPU state, so switch&n;&t;&t; * frame-type. &n;&t;&t; */
id|regs-&gt;frametype
op_assign
id|CRIS_FRAME_NORMAL
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
