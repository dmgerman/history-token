multiline_comment|/* Serialport functions for debugging&n; *&n; * Copyright (c) 2000 Axis Communications AB&n; *&n; * Authors:  Bjorn Wesen&n; *&n; * Exports:&n; *    console_print_etrax(char *buf)&n; *    int getDebugChar()&n; *    putDebugChar(int)&n; *    enableDebugIRQ()&n; *    init_etrax_debug()&n; *&n; * $Log: debugport.c,v $&n; * Revision 1.19  2004/10/21 07:26:16  starvik&n; * Made it possible to specify console settings on kernel command line.&n; *&n; * Revision 1.18  2004/10/19 13:07:37  starvik&n; * Merge of Linux 2.6.9&n; *&n; * Revision 1.17  2004/09/29 10:33:46  starvik&n; * Resolved a dealock when printing debug from kernel.&n; *&n; * Revision 1.16  2004/08/24 06:12:19  starvik&n; * Whitespace cleanup&n; *&n; * Revision 1.15  2004/08/16 12:37:19  starvik&n; * Merge of Linux 2.6.8&n; *&n; * Revision 1.14  2004/05/17 13:11:29  starvik&n; * Disable DMA until real serial driver is up&n; *&n; * Revision 1.13  2004/05/14 07:58:01  starvik&n; * Merge of changes from 2.4&n; *&n; * Revision 1.12  2003/09/11 07:29:49  starvik&n; * Merge of Linux 2.6.0-test5&n; *&n; * Revision 1.11  2003/07/07 09:53:36  starvik&n; * Revert all the 2.5.74 merge changes to make the console work again&n; *&n; * Revision 1.9  2003/02/17 17:07:23  starvik&n; * Solved the problem with corrupted debug output (from Linux 2.4)&n; *   * Wait until DMA, FIFO and pipe is empty before and after transmissions&n; *   * Buffer data until a FIFO flush can be triggered.&n; *&n; * Revision 1.8  2003/01/22 06:48:36  starvik&n; * Fixed warnings issued by GCC 3.2.1&n; *&n; * Revision 1.7  2002/12/12 08:26:32  starvik&n; * Don&squot;t use C-comments inside CVS comments&n; *&n; * Revision 1.6  2002/12/11 15:42:02  starvik&n; * Extracted v10 (ETRAX 100LX) specific stuff from arch/cris/kernel/&n; *&n; * Revision 1.5  2002/11/20 06:58:03  starvik&n; * Compiles with kgdb&n; *&n; * Revision 1.4  2002/11/19 14:35:24  starvik&n; * Changes from linux 2.4&n; * Changed struct initializer syntax to the currently prefered notation&n; *&n; * Revision 1.3  2002/11/06 09:47:03  starvik&n; * Modified for new interrupt macros&n; *&n; * Revision 1.2  2002/01/21 15:21:50  bjornw&n; * Update for kdev_t changes&n; *&n; * Revision 1.6  2001/04/17 13:58:39  orjanf&n; * * Renamed CONFIG_KGDB to CONFIG_ETRAX_KGDB.&n; *&n; * Revision 1.5  2001/03/26 14:22:05  bjornw&n; * Namechange of some config options&n; *&n; * Revision 1.4  2000/10/06 12:37:26  bjornw&n; * Use physical addresses when talking to DMA&n; *&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/arch/svinto.h&gt;
macro_line|#include &lt;asm/io.h&gt;             /* Get SIMCOUT. */
DECL|struct|dbg_port
r_struct
id|dbg_port
(brace
DECL|member|index
r_int
r_int
id|index
suffix:semicolon
DECL|member|read
r_const
r_volatile
r_int
op_star
id|read
suffix:semicolon
DECL|member|write
r_volatile
r_char
op_star
id|write
suffix:semicolon
DECL|member|xoff
r_volatile
r_int
op_star
id|xoff
suffix:semicolon
DECL|member|baud
r_volatile
r_char
op_star
id|baud
suffix:semicolon
DECL|member|tr_ctrl
r_volatile
r_char
op_star
id|tr_ctrl
suffix:semicolon
DECL|member|rec_ctrl
r_volatile
r_char
op_star
id|rec_ctrl
suffix:semicolon
DECL|member|irq
r_int
r_int
id|irq
suffix:semicolon
DECL|member|started
r_int
r_int
id|started
suffix:semicolon
DECL|member|baudrate
r_int
r_int
id|baudrate
suffix:semicolon
DECL|member|parity
r_int
r_char
id|parity
suffix:semicolon
DECL|member|bits
r_int
r_int
id|bits
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|ports
r_struct
id|dbg_port
id|ports
(braket
)braket
op_assign
(brace
(brace
l_int|0
comma
id|R_SERIAL0_READ
comma
id|R_SERIAL0_TR_DATA
comma
id|R_SERIAL0_XOFF
comma
id|R_SERIAL0_BAUD
comma
id|R_SERIAL0_TR_CTRL
comma
id|R_SERIAL0_REC_CTRL
comma
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK1_SET
comma
id|ser0_data
comma
id|set
)paren
)brace
comma
(brace
l_int|1
comma
id|R_SERIAL1_READ
comma
id|R_SERIAL1_TR_DATA
comma
id|R_SERIAL1_XOFF
comma
id|R_SERIAL1_BAUD
comma
id|R_SERIAL1_TR_CTRL
comma
id|R_SERIAL1_REC_CTRL
comma
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK1_SET
comma
id|ser1_data
comma
id|set
)paren
)brace
comma
(brace
l_int|2
comma
id|R_SERIAL2_READ
comma
id|R_SERIAL2_TR_DATA
comma
id|R_SERIAL2_XOFF
comma
id|R_SERIAL2_BAUD
comma
id|R_SERIAL2_TR_CTRL
comma
id|R_SERIAL2_REC_CTRL
comma
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK1_SET
comma
id|ser2_data
comma
id|set
)paren
)brace
comma
(brace
l_int|3
comma
id|R_SERIAL3_READ
comma
id|R_SERIAL3_TR_DATA
comma
id|R_SERIAL3_XOFF
comma
id|R_SERIAL3_BAUD
comma
id|R_SERIAL3_TR_CTRL
comma
id|R_SERIAL3_REC_CTRL
comma
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK1_SET
comma
id|ser3_data
comma
id|set
)paren
)brace
)brace
suffix:semicolon
DECL|variable|serial_driver
r_static
r_struct
id|tty_driver
op_star
id|serial_driver
suffix:semicolon
DECL|variable|port
r_struct
id|dbg_port
op_star
id|port
op_assign
macro_line|#if defined(CONFIG_ETRAX_DEBUG_PORT0)
op_amp
id|ports
(braket
l_int|0
)braket
suffix:semicolon
macro_line|#elif defined(CONFIG_ETRAX_DEBUG_PORT1)
op_amp
id|ports
(braket
l_int|1
)braket
suffix:semicolon
macro_line|#elif defined(CONFIG_ETRAX_DEBUG_PORT2)
op_amp
id|ports
(braket
l_int|2
)braket
suffix:semicolon
macro_line|#elif defined(CONFIG_ETRAX_DEBUG_PORT3)
op_amp
id|ports
(braket
l_int|3
)braket
suffix:semicolon
macro_line|#else
l_int|NULL
suffix:semicolon
macro_line|#endif
multiline_comment|/* Used by serial.c to register a debug_write_function so that the normal&n; * serial driver is used for kernel debug output&n; */
DECL|typedef|debugport_write_function
r_typedef
r_int
(paren
op_star
id|debugport_write_function
)paren
(paren
r_int
id|i
comma
r_const
r_char
op_star
id|buf
comma
r_int
r_int
id|len
)paren
suffix:semicolon
DECL|variable|debug_write_function
id|debugport_write_function
id|debug_write_function
op_assign
l_int|NULL
suffix:semicolon
r_static
r_void
DECL|function|start_port
id|start_port
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|rec_ctrl
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|tr_ctrl
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;started
)paren
r_return
suffix:semicolon
id|port-&gt;started
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;index
op_eq
l_int|0
)paren
(brace
id|genconfig_shadow
op_and_assign
op_complement
id|IO_MASK
c_func
(paren
id|R_GEN_CONFIG
comma
id|dma6
)paren
suffix:semicolon
id|genconfig_shadow
op_or_assign
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|dma6
comma
id|unused
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|port-&gt;index
op_eq
l_int|1
)paren
(brace
id|genconfig_shadow
op_and_assign
op_complement
id|IO_MASK
c_func
(paren
id|R_GEN_CONFIG
comma
id|dma8
)paren
suffix:semicolon
id|genconfig_shadow
op_or_assign
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|dma8
comma
id|usb
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|port-&gt;index
op_eq
l_int|2
)paren
(brace
id|genconfig_shadow
op_and_assign
op_complement
id|IO_MASK
c_func
(paren
id|R_GEN_CONFIG
comma
id|dma2
)paren
suffix:semicolon
id|genconfig_shadow
op_or_assign
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|dma2
comma
id|par0
)paren
suffix:semicolon
id|genconfig_shadow
op_and_assign
op_complement
id|IO_MASK
c_func
(paren
id|R_GEN_CONFIG
comma
id|dma3
)paren
suffix:semicolon
id|genconfig_shadow
op_or_assign
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|dma3
comma
id|par0
)paren
suffix:semicolon
id|genconfig_shadow
op_or_assign
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|ser2
comma
id|select
)paren
suffix:semicolon
)brace
r_else
(brace
id|genconfig_shadow
op_and_assign
op_complement
id|IO_MASK
c_func
(paren
id|R_GEN_CONFIG
comma
id|dma4
)paren
suffix:semicolon
id|genconfig_shadow
op_or_assign
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|dma4
comma
id|par1
)paren
suffix:semicolon
id|genconfig_shadow
op_and_assign
op_complement
id|IO_MASK
c_func
(paren
id|R_GEN_CONFIG
comma
id|dma5
)paren
suffix:semicolon
id|genconfig_shadow
op_or_assign
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|dma5
comma
id|par1
)paren
suffix:semicolon
id|genconfig_shadow
op_or_assign
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|ser3
comma
id|select
)paren
suffix:semicolon
)brace
op_star
id|R_GEN_CONFIG
op_assign
id|genconfig_shadow
suffix:semicolon
op_star
id|port-&gt;xoff
op_assign
id|IO_STATE
c_func
(paren
id|R_SERIAL0_XOFF
comma
id|tx_stop
comma
id|enable
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SERIAL0_XOFF
comma
id|auto_xoff
comma
id|disable
)paren
op_or
id|IO_FIELD
c_func
(paren
id|R_SERIAL0_XOFF
comma
id|xoff_char
comma
l_int|0
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|port-&gt;baudrate
)paren
(brace
r_case
l_int|0
suffix:colon
r_case
l_int|115200
suffix:colon
op_star
id|port-&gt;baud
op_assign
id|IO_STATE
c_func
(paren
id|R_SERIAL0_BAUD
comma
id|tr_baud
comma
id|c115k2Hz
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SERIAL0_BAUD
comma
id|rec_baud
comma
id|c115k2Hz
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1200
suffix:colon
op_star
id|port-&gt;baud
op_assign
id|IO_STATE
c_func
(paren
id|R_SERIAL0_BAUD
comma
id|tr_baud
comma
id|c1200Hz
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SERIAL0_BAUD
comma
id|rec_baud
comma
id|c1200Hz
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2400
suffix:colon
op_star
id|port-&gt;baud
op_assign
id|IO_STATE
c_func
(paren
id|R_SERIAL0_BAUD
comma
id|tr_baud
comma
id|c2400Hz
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SERIAL0_BAUD
comma
id|rec_baud
comma
id|c2400Hz
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4800
suffix:colon
op_star
id|port-&gt;baud
op_assign
id|IO_STATE
c_func
(paren
id|R_SERIAL0_BAUD
comma
id|tr_baud
comma
id|c4800Hz
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SERIAL0_BAUD
comma
id|rec_baud
comma
id|c4800Hz
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9600
suffix:colon
op_star
id|port-&gt;baud
op_assign
id|IO_STATE
c_func
(paren
id|R_SERIAL0_BAUD
comma
id|tr_baud
comma
id|c9600Hz
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SERIAL0_BAUD
comma
id|rec_baud
comma
id|c9600Hz
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|19200
suffix:colon
op_star
id|port-&gt;baud
op_assign
id|IO_STATE
c_func
(paren
id|R_SERIAL0_BAUD
comma
id|tr_baud
comma
id|c19k2Hz
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SERIAL0_BAUD
comma
id|rec_baud
comma
id|c19k2Hz
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|38400
suffix:colon
op_star
id|port-&gt;baud
op_assign
id|IO_STATE
c_func
(paren
id|R_SERIAL0_BAUD
comma
id|tr_baud
comma
id|c38k4Hz
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SERIAL0_BAUD
comma
id|rec_baud
comma
id|c38k4Hz
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|57600
suffix:colon
op_star
id|port-&gt;baud
op_assign
id|IO_STATE
c_func
(paren
id|R_SERIAL0_BAUD
comma
id|tr_baud
comma
id|c57k6Hz
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SERIAL0_BAUD
comma
id|rec_baud
comma
id|c57k6Hz
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
op_star
id|port-&gt;baud
op_assign
id|IO_STATE
c_func
(paren
id|R_SERIAL0_BAUD
comma
id|tr_baud
comma
id|c115k2Hz
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SERIAL0_BAUD
comma
id|rec_baud
comma
id|c115k2Hz
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|port-&gt;parity
op_eq
l_char|&squot;E&squot;
)paren
(brace
id|rec_ctrl
op_assign
id|IO_STATE
c_func
(paren
id|R_SERIAL0_REC_CTRL
comma
id|rec_par
comma
id|even
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SERIAL0_REC_CTRL
comma
id|rec_par_en
comma
id|enable
)paren
suffix:semicolon
id|tr_ctrl
op_assign
id|IO_STATE
c_func
(paren
id|R_SERIAL0_TR_CTRL
comma
id|tr_par
comma
id|even
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SERIAL0_TR_CTRL
comma
id|tr_par_en
comma
id|enable
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|port-&gt;parity
op_eq
l_char|&squot;O&squot;
)paren
(brace
id|rec_ctrl
op_assign
id|IO_STATE
c_func
(paren
id|R_SERIAL0_REC_CTRL
comma
id|rec_par
comma
id|odd
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SERIAL0_REC_CTRL
comma
id|rec_par_en
comma
id|enable
)paren
suffix:semicolon
id|tr_ctrl
op_assign
id|IO_STATE
c_func
(paren
id|R_SERIAL0_TR_CTRL
comma
id|tr_par
comma
id|odd
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SERIAL0_TR_CTRL
comma
id|tr_par_en
comma
id|enable
)paren
suffix:semicolon
)brace
r_else
(brace
id|rec_ctrl
op_assign
id|IO_STATE
c_func
(paren
id|R_SERIAL0_REC_CTRL
comma
id|rec_par
comma
id|even
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SERIAL0_REC_CTRL
comma
id|rec_par_en
comma
id|disable
)paren
suffix:semicolon
id|tr_ctrl
op_assign
id|IO_STATE
c_func
(paren
id|R_SERIAL0_TR_CTRL
comma
id|tr_par
comma
id|even
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SERIAL0_TR_CTRL
comma
id|tr_par_en
comma
id|disable
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|port-&gt;bits
op_eq
l_int|7
)paren
(brace
id|rec_ctrl
op_or_assign
id|IO_STATE
c_func
(paren
id|R_SERIAL0_REC_CTRL
comma
id|rec_bitnr
comma
id|rec_7bit
)paren
suffix:semicolon
id|tr_ctrl
op_or_assign
id|IO_STATE
c_func
(paren
id|R_SERIAL0_TR_CTRL
comma
id|tr_bitnr
comma
id|tr_7bit
)paren
suffix:semicolon
)brace
r_else
(brace
id|rec_ctrl
op_or_assign
id|IO_STATE
c_func
(paren
id|R_SERIAL0_REC_CTRL
comma
id|rec_bitnr
comma
id|rec_8bit
)paren
suffix:semicolon
id|tr_ctrl
op_or_assign
id|IO_STATE
c_func
(paren
id|R_SERIAL0_TR_CTRL
comma
id|tr_bitnr
comma
id|tr_8bit
)paren
suffix:semicolon
)brace
op_star
id|port-&gt;rec_ctrl
op_assign
id|IO_STATE
c_func
(paren
id|R_SERIAL0_REC_CTRL
comma
id|dma_err
comma
id|stop
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SERIAL0_REC_CTRL
comma
id|rec_enable
comma
id|enable
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SERIAL0_REC_CTRL
comma
id|rts_
comma
id|active
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SERIAL0_REC_CTRL
comma
id|sampling
comma
id|middle
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SERIAL0_REC_CTRL
comma
id|rec_stick_par
comma
id|normal
)paren
op_or
id|rec_ctrl
suffix:semicolon
op_star
id|port-&gt;tr_ctrl
op_assign
id|IO_FIELD
c_func
(paren
id|R_SERIAL0_TR_CTRL
comma
id|txd
comma
l_int|0
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SERIAL0_TR_CTRL
comma
id|tr_enable
comma
id|enable
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SERIAL0_TR_CTRL
comma
id|auto_cts
comma
id|disabled
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SERIAL0_TR_CTRL
comma
id|stop_bits
comma
id|one_bit
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SERIAL0_TR_CTRL
comma
id|tr_stick_par
comma
id|normal
)paren
op_or
id|tr_ctrl
suffix:semicolon
)brace
r_static
r_void
DECL|function|console_write_direct
id|console_write_direct
c_func
(paren
r_struct
id|console
op_star
id|co
comma
r_const
r_char
op_star
id|buf
comma
r_int
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Send data */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Wait until transmitter is ready and send.*/
r_while
c_loop
(paren
op_logical_neg
(paren
op_star
id|port-&gt;read
op_amp
id|IO_MASK
c_func
(paren
id|R_SERIAL0_READ
comma
id|tr_ready
)paren
)paren
)paren
suffix:semicolon
op_star
id|port-&gt;write
op_assign
id|buf
(braket
id|i
)braket
suffix:semicolon
)brace
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|console_write
id|console_write
c_func
(paren
r_struct
id|console
op_star
id|co
comma
r_const
r_char
op_star
id|buf
comma
r_int
r_int
id|len
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|port
)paren
r_return
suffix:semicolon
macro_line|#ifdef CONFIG_SVINTO_SIM
multiline_comment|/* no use to simulate the serial debug output */
id|SIMCOUT
c_func
(paren
id|buf
comma
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
macro_line|#endif
id|start_port
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ETRAX_KGDB
multiline_comment|/* kgdb needs to output debug info using the gdb protocol */
id|putDebugString
c_func
(paren
id|buf
comma
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|debug_write_function
)paren
id|debug_write_function
c_func
(paren
id|co-&gt;index
comma
id|buf
comma
id|len
)paren
suffix:semicolon
r_else
id|console_write_direct
c_func
(paren
id|co
comma
id|buf
comma
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/* legacy function */
r_void
DECL|function|console_print_etrax
id|console_print_etrax
c_func
(paren
r_const
r_char
op_star
id|buf
)paren
(brace
id|console_write
c_func
(paren
l_int|NULL
comma
id|buf
comma
id|strlen
c_func
(paren
id|buf
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Use polling to get a single character FROM the debug port */
r_int
DECL|function|getDebugChar
id|getDebugChar
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|readval
suffix:semicolon
r_do
(brace
id|readval
op_assign
op_star
id|port-&gt;read
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|readval
op_amp
id|IO_MASK
c_func
(paren
id|R_SERIAL0_READ
comma
id|data_avail
)paren
)paren
)paren
suffix:semicolon
r_return
(paren
id|readval
op_amp
id|IO_MASK
c_func
(paren
id|R_SERIAL0_READ
comma
id|data_in
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Use polling to put a single character to the debug port */
r_void
DECL|function|putDebugChar
id|putDebugChar
c_func
(paren
r_int
id|val
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
(paren
op_star
id|port-&gt;read
op_amp
id|IO_MASK
c_func
(paren
id|R_SERIAL0_READ
comma
id|tr_ready
)paren
)paren
)paren
suffix:semicolon
op_star
id|port-&gt;write
op_assign
id|val
suffix:semicolon
)brace
multiline_comment|/* Enable irq for receiving chars on the debug port, used by kgdb */
r_void
DECL|function|enableDebugIRQ
id|enableDebugIRQ
c_func
(paren
r_void
)paren
(brace
op_star
id|R_IRQ_MASK1_SET
op_assign
id|port-&gt;irq
suffix:semicolon
multiline_comment|/* use R_VECT_MASK directly, since we really bypass Linux normal&n;&t; * IRQ handling in kgdb anyway, we don&squot;t need to use enable_irq&n;&t; */
op_star
id|R_VECT_MASK_SET
op_assign
id|IO_STATE
c_func
(paren
id|R_VECT_MASK_SET
comma
id|serial
comma
id|set
)paren
suffix:semicolon
op_star
id|port-&gt;rec_ctrl
op_assign
id|IO_STATE
c_func
(paren
id|R_SERIAL0_REC_CTRL
comma
id|rec_enable
comma
id|enable
)paren
suffix:semicolon
)brace
r_static
r_struct
id|tty_driver
op_star
DECL|function|etrax_console_device
id|etrax_console_device
c_func
(paren
r_struct
id|console
op_star
id|co
comma
r_int
op_star
id|index
)paren
(brace
r_return
id|serial_driver
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|console_setup
id|console_setup
c_func
(paren
r_struct
id|console
op_star
id|co
comma
r_char
op_star
id|options
)paren
(brace
r_char
op_star
id|s
suffix:semicolon
r_if
c_cond
(paren
id|options
)paren
(brace
id|port
op_assign
op_amp
id|ports
(braket
id|co-&gt;index
)braket
suffix:semicolon
id|port-&gt;baudrate
op_assign
l_int|115200
suffix:semicolon
id|port-&gt;parity
op_assign
l_char|&squot;N&squot;
suffix:semicolon
id|port-&gt;bits
op_assign
l_int|8
suffix:semicolon
id|port-&gt;baudrate
op_assign
id|simple_strtoul
c_func
(paren
id|options
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|s
op_assign
id|options
suffix:semicolon
r_while
c_loop
(paren
op_star
id|s
op_ge
l_char|&squot;0&squot;
op_logical_and
op_star
id|s
op_le
l_char|&squot;9&squot;
)paren
(brace
id|s
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|s
)paren
id|port-&gt;parity
op_assign
op_star
id|s
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_star
id|s
)paren
id|port-&gt;bits
op_assign
op_star
id|s
op_increment
op_minus
l_char|&squot;0&squot;
suffix:semicolon
id|port-&gt;started
op_assign
l_int|0
suffix:semicolon
id|start_port
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sercons
r_static
r_struct
id|console
id|sercons
op_assign
(brace
id|name
suffix:colon
l_string|&quot;ttyS&quot;
comma
id|write
suffix:colon
id|console_write
comma
id|read
suffix:colon
l_int|NULL
comma
id|device
suffix:colon
id|etrax_console_device
comma
id|unblank
suffix:colon
l_int|NULL
comma
id|setup
suffix:colon
id|console_setup
comma
id|flags
suffix:colon
id|CON_PRINTBUFFER
comma
id|index
suffix:colon
op_minus
l_int|1
comma
id|cflag
suffix:colon
l_int|0
comma
id|next
suffix:colon
l_int|NULL
)brace
suffix:semicolon
DECL|variable|sercons0
r_static
r_struct
id|console
id|sercons0
op_assign
(brace
id|name
suffix:colon
l_string|&quot;ttyS&quot;
comma
id|write
suffix:colon
id|console_write
comma
id|read
suffix:colon
l_int|NULL
comma
id|device
suffix:colon
id|etrax_console_device
comma
id|unblank
suffix:colon
l_int|NULL
comma
id|setup
suffix:colon
id|console_setup
comma
id|flags
suffix:colon
id|CON_PRINTBUFFER
comma
id|index
suffix:colon
l_int|0
comma
id|cflag
suffix:colon
l_int|0
comma
id|next
suffix:colon
l_int|NULL
)brace
suffix:semicolon
DECL|variable|sercons1
r_static
r_struct
id|console
id|sercons1
op_assign
(brace
id|name
suffix:colon
l_string|&quot;ttyS&quot;
comma
id|write
suffix:colon
id|console_write
comma
id|read
suffix:colon
l_int|NULL
comma
id|device
suffix:colon
id|etrax_console_device
comma
id|unblank
suffix:colon
l_int|NULL
comma
id|setup
suffix:colon
id|console_setup
comma
id|flags
suffix:colon
id|CON_PRINTBUFFER
comma
id|index
suffix:colon
l_int|1
comma
id|cflag
suffix:colon
l_int|0
comma
id|next
suffix:colon
l_int|NULL
)brace
suffix:semicolon
DECL|variable|sercons2
r_static
r_struct
id|console
id|sercons2
op_assign
(brace
id|name
suffix:colon
l_string|&quot;ttyS&quot;
comma
id|write
suffix:colon
id|console_write
comma
id|read
suffix:colon
l_int|NULL
comma
id|device
suffix:colon
id|etrax_console_device
comma
id|unblank
suffix:colon
l_int|NULL
comma
id|setup
suffix:colon
id|console_setup
comma
id|flags
suffix:colon
id|CON_PRINTBUFFER
comma
id|index
suffix:colon
l_int|2
comma
id|cflag
suffix:colon
l_int|0
comma
id|next
suffix:colon
l_int|NULL
)brace
suffix:semicolon
DECL|variable|sercons3
r_static
r_struct
id|console
id|sercons3
op_assign
(brace
id|name
suffix:colon
l_string|&quot;ttyS&quot;
comma
id|write
suffix:colon
id|console_write
comma
id|read
suffix:colon
l_int|NULL
comma
id|device
suffix:colon
id|etrax_console_device
comma
id|unblank
suffix:colon
l_int|NULL
comma
id|setup
suffix:colon
id|console_setup
comma
id|flags
suffix:colon
id|CON_PRINTBUFFER
comma
id|index
suffix:colon
l_int|3
comma
id|cflag
suffix:colon
l_int|0
comma
id|next
suffix:colon
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/*&n; *      Register console (for printk&squot;s etc)&n; */
r_int
id|__init
DECL|function|init_etrax_debug
id|init_etrax_debug
c_func
(paren
r_void
)paren
(brace
r_static
r_int
id|first
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|first
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|port
)paren
(brace
id|register_console
c_func
(paren
op_amp
id|sercons0
)paren
suffix:semicolon
id|register_console
c_func
(paren
op_amp
id|sercons1
)paren
suffix:semicolon
id|register_console
c_func
(paren
op_amp
id|sercons2
)paren
suffix:semicolon
id|register_console
c_func
(paren
op_amp
id|sercons3
)paren
suffix:semicolon
id|unregister_console
c_func
(paren
op_amp
id|sercons
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
id|first
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|port
)paren
id|register_console
c_func
(paren
op_amp
id|sercons
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
id|__init
DECL|function|init_console
id|init_console
c_func
(paren
r_void
)paren
(brace
id|serial_driver
op_assign
id|alloc_tty_driver
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|serial_driver
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|init_etrax_debug
id|__initcall
c_func
(paren
id|init_etrax_debug
)paren
suffix:semicolon
eof
