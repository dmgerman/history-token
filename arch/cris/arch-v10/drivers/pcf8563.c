multiline_comment|/*&n; * PCF8563 RTC&n; *&n; * From Phillips&squot; datasheet:&n; *&n; * The PCF8563 is a CMOS real-time clock/calendar optimized for low power&n; * consumption. A programmable clock output, interupt output and voltage&n; * low detector are also provided. All address and data are transferred&n; * serially via two-line bidirectional I2C-bus. Maximum bus speed is&n; * 400 kbits/s. The built-in word address register is incremented&n; * automatically after each written or read bute.&n; *&n; * Copyright (c) 2002, Axis Communications AB&n; * All rights reserved.&n; *&n; * Author: Tobias Anderberg &lt;tobiasa@axis.com&gt;.&n; *&n; * $Id: pcf8563.c,v 1.1 2002/12/12 08:27:26 starvik Exp $&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/ioctl.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/arch/svinto.h&gt;
macro_line|#include &lt;asm/rtc.h&gt;
macro_line|#include &quot;i2c.h&quot;
DECL|macro|PCF8563_MAJOR
mdefine_line|#define PCF8563_MAJOR 121&t;&t;/* Local major number. */
DECL|macro|DEVICE_NAME
mdefine_line|#define DEVICE_NAME &quot;rtc&quot;&t;&t;/* Name which is registered in /proc/devices. */
DECL|macro|PCF8563_NAME
mdefine_line|#define PCF8563_NAME &quot;PCF8563&quot;
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION &quot;$Revision: 1.1 $&quot;
multiline_comment|/* I2C bus slave registers. */
DECL|macro|RTC_I2C_READ
mdefine_line|#define RTC_I2C_READ&t;&t;0xa3
DECL|macro|RTC_I2C_WRITE
mdefine_line|#define RTC_I2C_WRITE&t;&t;0xa2
multiline_comment|/* Two simple wrapper macros, saves a few keystrokes. */
DECL|macro|rtc_read
mdefine_line|#define rtc_read(x) i2c_readreg(RTC_I2C_READ, x)
DECL|macro|rtc_write
mdefine_line|#define rtc_write(x,y) i2c_writereg(RTC_I2C_WRITE, x, y)
DECL|variable|days_in_month
r_static
r_const
r_int
r_char
id|days_in_month
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|31
comma
l_int|28
comma
l_int|31
comma
l_int|30
comma
l_int|31
comma
l_int|30
comma
l_int|31
comma
l_int|31
comma
l_int|30
comma
l_int|31
comma
l_int|30
comma
l_int|31
)brace
suffix:semicolon
r_int
id|pcf8563_ioctl
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
DECL|variable|pcf8563_fops
r_static
r_struct
id|file_operations
id|pcf8563_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|ioctl
op_assign
id|pcf8563_ioctl
comma
)brace
suffix:semicolon
r_int
r_char
DECL|function|pcf8563_readreg
id|pcf8563_readreg
c_func
(paren
r_int
id|reg
)paren
(brace
r_int
r_char
id|res
op_assign
id|i2c_readreg
c_func
(paren
id|RTC_I2C_READ
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* The PCF8563 does not return 0 for unimplemented bits */
r_switch
c_cond
(paren
id|reg
)paren
(brace
r_case
id|RTC_SECONDS
suffix:colon
r_case
id|RTC_MINUTES
suffix:colon
id|res
op_and_assign
l_int|0x7f
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RTC_HOURS
suffix:colon
r_case
id|RTC_DAY_OF_MONTH
suffix:colon
id|res
op_and_assign
l_int|0x3f
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RTC_MONTH
suffix:colon
id|res
op_assign
(paren
id|res
op_amp
l_int|0x1f
)paren
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* PCF8563 returns month in range 1-12 */
r_break
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
r_void
DECL|function|pcf8563_writereg
id|pcf8563_writereg
c_func
(paren
r_int
id|reg
comma
r_int
r_char
id|val
)paren
(brace
id|i2c_writereg
c_func
(paren
id|RTC_I2C_WRITE
comma
id|reg
comma
id|val
)paren
suffix:semicolon
)brace
r_void
DECL|function|get_rtc_time
id|get_rtc_time
c_func
(paren
r_struct
id|rtc_time
op_star
id|tm
)paren
(brace
id|tm-&gt;tm_sec
op_assign
id|rtc_read
c_func
(paren
id|RTC_SECONDS
)paren
suffix:semicolon
id|tm-&gt;tm_min
op_assign
id|rtc_read
c_func
(paren
id|RTC_MINUTES
)paren
suffix:semicolon
id|tm-&gt;tm_hour
op_assign
id|rtc_read
c_func
(paren
id|RTC_HOURS
)paren
suffix:semicolon
id|tm-&gt;tm_mday
op_assign
id|rtc_read
c_func
(paren
id|RTC_DAY_OF_MONTH
)paren
suffix:semicolon
id|tm-&gt;tm_mon
op_assign
id|rtc_read
c_func
(paren
id|RTC_MONTH
)paren
suffix:semicolon
id|tm-&gt;tm_year
op_assign
id|rtc_read
c_func
(paren
id|RTC_YEAR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tm-&gt;tm_sec
op_amp
l_int|0x80
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: RTC Low Voltage - date/time is not reliable!&bslash;n&quot;
comma
id|PCF8563_NAME
)paren
suffix:semicolon
id|tm-&gt;tm_year
op_assign
id|BCD_TO_BIN
c_func
(paren
id|tm-&gt;tm_year
)paren
op_plus
(paren
(paren
id|tm-&gt;tm_mon
op_amp
l_int|0x80
)paren
ques
c_cond
l_int|100
suffix:colon
l_int|0
)paren
suffix:semicolon
id|tm-&gt;tm_sec
op_and_assign
l_int|0x7f
suffix:semicolon
id|tm-&gt;tm_min
op_and_assign
l_int|0x7f
suffix:semicolon
id|tm-&gt;tm_hour
op_and_assign
l_int|0x3f
suffix:semicolon
id|tm-&gt;tm_mday
op_and_assign
l_int|0x3f
suffix:semicolon
id|tm-&gt;tm_mon
op_and_assign
l_int|0x1f
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|tm-&gt;tm_sec
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|tm-&gt;tm_min
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|tm-&gt;tm_hour
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|tm-&gt;tm_mday
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|tm-&gt;tm_mon
)paren
suffix:semicolon
id|tm-&gt;tm_mon
op_decrement
suffix:semicolon
multiline_comment|/* Month is 1..12 in RTC but 0..11 in linux */
)brace
r_int
id|__init
DECL|function|pcf8563_init
id|pcf8563_init
c_func
(paren
r_void
)paren
(brace
r_int
r_char
id|ret
suffix:semicolon
multiline_comment|/*&n;&t; * First of all we need to reset the chip. This is done by&n;&t; * clearing control1, control2 and clk freq, clear the &n;&t; * Voltage Low bit, and resetting all alarms.&n;&t; */
r_if
c_cond
(paren
id|rtc_write
c_func
(paren
id|RTC_CONTROL1
comma
l_int|0x00
)paren
OL
l_int|0
)paren
r_goto
id|err
suffix:semicolon
r_if
c_cond
(paren
id|rtc_write
c_func
(paren
id|RTC_CONTROL2
comma
l_int|0x00
)paren
OL
l_int|0
)paren
r_goto
id|err
suffix:semicolon
r_if
c_cond
(paren
id|rtc_write
c_func
(paren
id|RTC_CLOCKOUT_FREQ
comma
l_int|0x00
)paren
OL
l_int|0
)paren
r_goto
id|err
suffix:semicolon
multiline_comment|/* Clear the VL bit in the seconds register. */
id|ret
op_assign
id|rtc_read
c_func
(paren
id|RTC_SECONDS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rtc_write
c_func
(paren
id|RTC_SECONDS
comma
(paren
id|ret
op_amp
l_int|0x7f
)paren
)paren
OL
l_int|0
)paren
r_goto
id|err
suffix:semicolon
multiline_comment|/* Reset the alarms. */
r_if
c_cond
(paren
id|rtc_write
c_func
(paren
id|RTC_MINUTE_ALARM
comma
l_int|0x00
)paren
OL
l_int|0
)paren
r_goto
id|err
suffix:semicolon
r_if
c_cond
(paren
id|rtc_write
c_func
(paren
id|RTC_HOUR_ALARM
comma
l_int|0x00
)paren
OL
l_int|0
)paren
r_goto
id|err
suffix:semicolon
r_if
c_cond
(paren
id|rtc_write
c_func
(paren
id|RTC_DAY_ALARM
comma
l_int|0x00
)paren
OL
l_int|0
)paren
r_goto
id|err
suffix:semicolon
r_if
c_cond
(paren
id|rtc_write
c_func
(paren
id|RTC_WEEKDAY_ALARM
comma
l_int|0x00
)paren
OL
l_int|0
)paren
r_goto
id|err
suffix:semicolon
r_if
c_cond
(paren
id|register_chrdev
c_func
(paren
id|PCF8563_MAJOR
comma
id|DEVICE_NAME
comma
op_amp
id|pcf8563_fops
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unable to get major numer %d for RTC device.&bslash;n&quot;
comma
id|PCF8563_NAME
comma
id|PCF8563_MAJOR
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s Real-Time Clock Driver, %s&bslash;n&quot;
comma
id|PCF8563_NAME
comma
id|DRIVER_VERSION
)paren
suffix:semicolon
multiline_comment|/* Check for low voltage, and warn about it.. */
r_if
c_cond
(paren
id|rtc_read
c_func
(paren
id|RTC_SECONDS
)paren
op_amp
l_int|0x80
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: RTC Low Voltage - date/time is not reliable!&bslash;n&quot;
comma
id|PCF8563_NAME
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Error initializing chip.&bslash;n&quot;
comma
id|PCF8563_NAME
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_void
id|__exit
DECL|function|pcf8563_exit
id|pcf8563_exit
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|unregister_chrdev
c_func
(paren
id|PCF8563_MAJOR
comma
id|DEVICE_NAME
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unable to unregister device.&bslash;n&quot;
comma
id|PCF8563_NAME
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * ioctl calls for this driver. Why return -ENOTTY upon error? Because&n; * POSIX says so!&n; */
r_int
DECL|function|pcf8563_ioctl
id|pcf8563_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
multiline_comment|/* Some sanity checks. */
r_if
c_cond
(paren
id|_IOC_TYPE
c_func
(paren
id|cmd
)paren
op_ne
id|RTC_MAGIC
)paren
r_return
op_minus
id|ENOTTY
suffix:semicolon
r_if
c_cond
(paren
id|_IOC_NR
c_func
(paren
id|cmd
)paren
OG
id|RTC_MAX_IOCTL
)paren
r_return
op_minus
id|ENOTTY
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|RTC_RD_TIME
suffix:colon
(brace
r_struct
id|rtc_time
id|tm
suffix:semicolon
id|get_rtc_time
c_func
(paren
op_amp
id|tm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_struct
id|rtc_time
op_star
)paren
id|arg
comma
op_amp
id|tm
comma
r_sizeof
(paren
r_struct
id|rtc_time
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RTC_SET_TIME
suffix:colon
(brace
r_int
id|leap
suffix:semicolon
r_int
id|century
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|rtc_time
id|tm
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|tm
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|rtc_time
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_TIME
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|tm
comma
(paren
r_struct
id|rtc_time
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|rtc_time
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* Convert from struct tm to struct rtc_time. */
id|tm.tm_year
op_add_assign
l_int|1900
suffix:semicolon
id|tm.tm_mon
op_add_assign
l_int|1
suffix:semicolon
id|leap
op_assign
(paren
(paren
id|tm.tm_mon
op_eq
l_int|2
)paren
op_logical_and
(paren
(paren
id|tm.tm_year
op_mod
l_int|4
)paren
op_eq
l_int|0
)paren
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* Perform some sanity checks. */
r_if
c_cond
(paren
(paren
id|tm.tm_year
OL
l_int|1970
)paren
op_logical_or
(paren
id|tm.tm_mon
OG
l_int|12
)paren
op_logical_or
(paren
id|tm.tm_mday
op_eq
l_int|0
)paren
op_logical_or
(paren
id|tm.tm_mday
OG
id|days_in_month
(braket
id|tm.tm_mon
)braket
op_plus
id|leap
)paren
op_logical_or
(paren
id|tm.tm_hour
op_ge
l_int|24
)paren
op_logical_or
(paren
id|tm.tm_min
op_ge
l_int|60
)paren
op_logical_or
(paren
id|tm.tm_sec
op_ge
l_int|60
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|century
op_assign
(paren
id|tm.tm_year
op_ge
l_int|2000
)paren
ques
c_cond
l_int|0x80
suffix:colon
l_int|0
suffix:semicolon
id|tm.tm_year
op_assign
id|tm.tm_year
op_mod
l_int|100
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|tm.tm_year
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|tm.tm_mday
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|tm.tm_hour
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|tm.tm_min
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|tm.tm_sec
)paren
suffix:semicolon
id|tm.tm_mon
op_or_assign
id|century
suffix:semicolon
id|rtc_write
c_func
(paren
id|RTC_YEAR
comma
id|tm.tm_year
)paren
suffix:semicolon
id|rtc_write
c_func
(paren
id|RTC_MONTH
comma
id|tm.tm_mon
)paren
suffix:semicolon
id|rtc_write
c_func
(paren
id|RTC_DAY_OF_MONTH
comma
id|tm.tm_mday
)paren
suffix:semicolon
id|rtc_write
c_func
(paren
id|RTC_HOURS
comma
id|tm.tm_hour
)paren
suffix:semicolon
id|rtc_write
c_func
(paren
id|RTC_MINUTES
comma
id|tm.tm_min
)paren
suffix:semicolon
id|rtc_write
c_func
(paren
id|RTC_SECONDS
comma
id|tm.tm_sec
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOTTY
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|pcf8563_init
id|module_init
c_func
(paren
id|pcf8563_init
)paren
suffix:semicolon
DECL|variable|pcf8563_exit
id|module_exit
c_func
(paren
id|pcf8563_exit
)paren
suffix:semicolon
eof
