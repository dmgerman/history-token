multiline_comment|/* $Id: gpio.c,v 1.12 2004/08/24 07:19:59 starvik Exp $&n; *&n; * Etrax general port I/O device&n; *&n; * Copyright (c) 1999, 2000, 2001, 2002 Axis Communications AB&n; *&n; * Authors:    Bjorn Wesen      (initial version)&n; *             Ola Knutsson     (LED handling)&n; *             Johan Adolfsson  (read/set directions, write, port G)&n; *&n; * $Log: gpio.c,v $&n; * Revision 1.12  2004/08/24 07:19:59  starvik&n; * Whitespace cleanup&n; *&n; * Revision 1.11  2004/05/14 07:58:03  starvik&n; * Merge of changes from 2.4&n; *&n; * Revision 1.9  2003/09/11 07:29:48  starvik&n; * Merge of Linux 2.6.0-test5&n; *&n; * Revision 1.8  2003/07/04 08:27:37  starvik&n; * Merge of Linux 2.5.74&n; *&n; * Revision 1.7  2003/01/10 07:44:07  starvik&n; * init_ioremap is now called by kernel before drivers are initialized&n; *&n; * Revision 1.6  2002/12/11 13:13:57  starvik&n; * Added arch/ to v10 specific includes&n; * Added fix from Linux 2.4 in serial.c (flush_to_flip_buffer)&n; *&n; * Revision 1.5  2002/11/20 11:56:11  starvik&n; * Merge of Linux 2.5.48&n; *&n; * Revision 1.4  2002/11/18 10:10:05  starvik&n; * Linux 2.5 port of latest gpio.c from Linux 2.4&n; *&n; * Revision 1.20  2002/10/16 21:16:24  johana&n; * Added support for PA high level interrupt.&n; * That gives 2ms response time with iodtest for high levels and 2-12 ms&n; * response time on low levels if the check is not made in&n; * process.c:cpu_idle() as well.&n; *&n; * Revision 1.19  2002/10/14 18:27:33  johana&n; * Implemented alarm handling so select() now works.&n; * Latency is around 6-9 ms with a etrax_gpio_wake_up_check() in&n; * cpu_idle().&n; * Otherwise I get 15-18 ms (same as doing the poll in userspace -&n; * but less overhead).&n; * TODO? Perhaps we should add the check in IMMEDIATE_BH (or whatever it&n; * is in 2.4) as well?&n; * TODO? Perhaps call request_irq()/free_irq() only when needed?&n; * Increased version to 2.5&n; *&n; * Revision 1.18  2002/10/11 15:02:00  johana&n; * Mask inverted 8 bit value in setget_input().&n; *&n; * Revision 1.17  2002/06/17 15:53:01  johana&n; * Added IO_READ_INBITS, IO_READ_OUTBITS, IO_SETGET_INPUT and IO_SETGET_OUTPUT&n; * that take a pointer as argument and thus can handle 32 bit ports (G)&n; * correctly.&n; * These should be used instead of IO_READBITS, IO_SETINPUT and IO_SETOUTPUT.&n; * (especially if Port G bit 31 is used)&n; *&n; * Revision 1.16  2002/06/17 09:59:51  johana&n; * Returning 32 bit values in the ioctl return value doesn&squot;t work if bit&n; * 31 is set (could happen for port G), so mask it of with 0x7FFFFFFF.&n; * A new set of ioctl&squot;s will be added.&n; *&n; * Revision 1.15  2002/05/06 13:19:13  johana&n; * IO_SETINPUT returns mask with bit set = inputs for PA and PB as well.&n; *&n; * Revision 1.14  2002/04/12 12:01:53  johana&n; * Use global r_port_g_data_shadow.&n; * Moved gpio_init_port_g() closer to gpio_init() and marked it __init.&n; *&n; * Revision 1.13  2002/04/10 12:03:55  johana&n; * Added support for port G /dev/gpiog (minor 3).&n; * Changed indentation on switch cases.&n; * Fixed other spaces to tabs.&n; *&n; * Revision 1.12  2001/11/12 19:42:15  pkj&n; * * Corrected return values from gpio_leds_ioctl().&n; * * Fixed compiler warnings.&n; *&n; * Revision 1.11  2001/10/30 14:39:12  johana&n; * Added D() around gpio_write printk.&n; *&n; * Revision 1.10  2001/10/25 10:24:42  johana&n; * Added IO_CFG_WRITE_MODE ioctl and write method that can do fast&n; * bittoggling in the kernel. (This speeds up programming an FPGA with 450kB&n; * from ~60 seconds to 4 seconds).&n; * Added save_flags/cli/restore_flags in ioctl.&n; *&n; * Revision 1.9  2001/05/04 14:16:07  matsfg&n; * Corrected spelling error&n; *&n; * Revision 1.8  2001/04/27 13:55:26  matsfg&n; * Moved initioremap.&n; * Turns off all LEDS on init.&n; * Added support for shutdown and powerbutton.&n; *&n; * Revision 1.7  2001/04/04 13:30:08  matsfg&n; * Added bitset and bitclear for leds. Calls init_ioremap to set up memmapping&n; *&n; * Revision 1.6  2001/03/26 16:03:06  bjornw&n; * Needs linux/config.h&n; *&n; * Revision 1.5  2001/03/26 14:22:03  bjornw&n; * Namechange of some config options&n; *&n; * Revision 1.4  2001/02/27 13:52:48  bjornw&n; * malloc.h -&gt; slab.h&n; *&n; * Revision 1.3  2001/01/24 15:06:48  bjornw&n; * gpio_wq correct type&n; *&n; * Revision 1.2  2001/01/18 16:07:30  bjornw&n; * 2.4 port&n; *&n; * Revision 1.1  2001/01/18 15:55:16  bjornw&n; * Verbatim copy of etraxgpio.c from elinux 2.0 added&n; *&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/etraxgpio.h&gt;
macro_line|#include &lt;asm/arch/svinto.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
DECL|macro|GPIO_MAJOR
mdefine_line|#define GPIO_MAJOR 120  /* experimental MAJOR number */
DECL|macro|D
mdefine_line|#define D(x)
macro_line|#if 0
r_static
r_int
id|dp_cnt
suffix:semicolon
mdefine_line|#define DP(x) do { dp_cnt++; if (dp_cnt % 1000 == 0) x; }while(0)
macro_line|#else
DECL|macro|DP
mdefine_line|#define DP(x)
macro_line|#endif
DECL|variable|gpio_name
r_static
r_char
id|gpio_name
(braket
)braket
op_assign
l_string|&quot;etrax gpio&quot;
suffix:semicolon
macro_line|#if 0
r_static
id|wait_queue_head_t
op_star
id|gpio_wq
suffix:semicolon
macro_line|#endif
r_static
r_int
id|gpio_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
id|ssize_t
id|gpio_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|off
)paren
suffix:semicolon
r_static
r_int
id|gpio_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_int
id|gpio_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_int
r_int
id|gpio_poll
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_struct
id|poll_table_struct
op_star
id|wait
)paren
suffix:semicolon
multiline_comment|/* private data per open() of this driver */
DECL|struct|gpio_private
r_struct
id|gpio_private
(brace
DECL|member|next
r_struct
id|gpio_private
op_star
id|next
suffix:semicolon
multiline_comment|/* These fields are for PA and PB only */
DECL|member|port
DECL|member|shadow
r_volatile
r_int
r_char
op_star
id|port
comma
op_star
id|shadow
suffix:semicolon
DECL|member|dir
DECL|member|dir_shadow
r_volatile
r_int
r_char
op_star
id|dir
comma
op_star
id|dir_shadow
suffix:semicolon
DECL|member|changeable_dir
r_int
r_char
id|changeable_dir
suffix:semicolon
DECL|member|changeable_bits
r_int
r_char
id|changeable_bits
suffix:semicolon
DECL|member|clk_mask
r_int
r_char
id|clk_mask
suffix:semicolon
DECL|member|data_mask
r_int
r_char
id|data_mask
suffix:semicolon
DECL|member|write_msb
r_int
r_char
id|write_msb
suffix:semicolon
DECL|member|pad1
DECL|member|pad2
DECL|member|pad3
r_int
r_char
id|pad1
comma
id|pad2
comma
id|pad3
suffix:semicolon
multiline_comment|/* These fields are generic */
DECL|member|highalarm
DECL|member|lowalarm
r_int
r_int
id|highalarm
comma
id|lowalarm
suffix:semicolon
DECL|member|alarm_wq
id|wait_queue_head_t
id|alarm_wq
suffix:semicolon
DECL|member|minor
r_int
id|minor
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* linked list of alarms to check for */
DECL|variable|alarmlist
r_static
r_struct
id|gpio_private
op_star
id|alarmlist
op_assign
l_int|0
suffix:semicolon
DECL|variable|gpio_some_alarms
r_static
r_int
id|gpio_some_alarms
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set if someone uses alarm */
DECL|variable|gpio_pa_irq_enabled_mask
r_static
r_int
r_int
id|gpio_pa_irq_enabled_mask
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Port A and B use 8 bit access, but Port G is 32 bit */
DECL|macro|NUM_PORTS
mdefine_line|#define NUM_PORTS (GPIO_MINOR_B+1)
DECL|variable|ports
r_static
r_volatile
r_int
r_char
op_star
id|ports
(braket
id|NUM_PORTS
)braket
op_assign
(brace
id|R_PORT_PA_DATA
comma
id|R_PORT_PB_DATA
comma
)brace
suffix:semicolon
DECL|variable|shads
r_static
r_volatile
r_int
r_char
op_star
id|shads
(braket
id|NUM_PORTS
)braket
op_assign
(brace
op_amp
id|port_pa_data_shadow
comma
op_amp
id|port_pb_data_shadow
)brace
suffix:semicolon
multiline_comment|/* What direction bits that are user changeable 1=changeable*/
macro_line|#ifndef CONFIG_ETRAX_PA_CHANGEABLE_DIR
DECL|macro|CONFIG_ETRAX_PA_CHANGEABLE_DIR
mdefine_line|#define CONFIG_ETRAX_PA_CHANGEABLE_DIR 0x00
macro_line|#endif
macro_line|#ifndef CONFIG_ETRAX_PB_CHANGEABLE_DIR
DECL|macro|CONFIG_ETRAX_PB_CHANGEABLE_DIR
mdefine_line|#define CONFIG_ETRAX_PB_CHANGEABLE_DIR 0x00
macro_line|#endif
macro_line|#ifndef CONFIG_ETRAX_PA_CHANGEABLE_BITS
DECL|macro|CONFIG_ETRAX_PA_CHANGEABLE_BITS
mdefine_line|#define CONFIG_ETRAX_PA_CHANGEABLE_BITS 0xFF
macro_line|#endif
macro_line|#ifndef CONFIG_ETRAX_PB_CHANGEABLE_BITS
DECL|macro|CONFIG_ETRAX_PB_CHANGEABLE_BITS
mdefine_line|#define CONFIG_ETRAX_PB_CHANGEABLE_BITS 0xFF
macro_line|#endif
DECL|variable|changeable_dir
r_static
r_int
r_char
id|changeable_dir
(braket
id|NUM_PORTS
)braket
op_assign
(brace
id|CONFIG_ETRAX_PA_CHANGEABLE_DIR
comma
id|CONFIG_ETRAX_PB_CHANGEABLE_DIR
)brace
suffix:semicolon
DECL|variable|changeable_bits
r_static
r_int
r_char
id|changeable_bits
(braket
id|NUM_PORTS
)braket
op_assign
(brace
id|CONFIG_ETRAX_PA_CHANGEABLE_BITS
comma
id|CONFIG_ETRAX_PB_CHANGEABLE_BITS
)brace
suffix:semicolon
DECL|variable|dir
r_static
r_volatile
r_int
r_char
op_star
id|dir
(braket
id|NUM_PORTS
)braket
op_assign
(brace
id|R_PORT_PA_DIR
comma
id|R_PORT_PB_DIR
)brace
suffix:semicolon
DECL|variable|dir_shadow
r_static
r_volatile
r_int
r_char
op_star
id|dir_shadow
(braket
id|NUM_PORTS
)braket
op_assign
(brace
op_amp
id|port_pa_dir_shadow
comma
op_amp
id|port_pb_dir_shadow
)brace
suffix:semicolon
multiline_comment|/* Port G is 32 bit, handle it special, some bits are both inputs &n;   and outputs at the same time, only some of the bits can change direction&n;   and some of them in groups of 8 bit. */
DECL|variable|changeable_dir_g
r_static
r_int
r_int
id|changeable_dir_g
suffix:semicolon
DECL|variable|dir_g_in_bits
r_static
r_int
r_int
id|dir_g_in_bits
suffix:semicolon
DECL|variable|dir_g_out_bits
r_static
r_int
r_int
id|dir_g_out_bits
suffix:semicolon
DECL|variable|dir_g_shadow
r_static
r_int
r_int
id|dir_g_shadow
suffix:semicolon
multiline_comment|/* 1=output */
DECL|macro|USE_PORTS
mdefine_line|#define USE_PORTS(priv) ((priv)-&gt;minor &lt;= GPIO_MINOR_B)
r_static
r_int
r_int
DECL|function|gpio_poll
id|gpio_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|poll_table
op_star
id|wait
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|0
suffix:semicolon
r_struct
id|gpio_private
op_star
id|priv
op_assign
(paren
r_struct
id|gpio_private
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_int
r_int
id|data
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|priv-&gt;alarm_wq
comma
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;minor
op_eq
id|GPIO_MINOR_A
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|tmp
suffix:semicolon
id|data
op_assign
op_star
id|R_PORT_PA_DATA
suffix:semicolon
multiline_comment|/* PA has support for high level interrupt -&n;&t;&t; * lets activate for those low and with highalarm set&n;&t;&t; */
id|tmp
op_assign
op_complement
id|data
op_amp
id|priv-&gt;highalarm
op_amp
l_int|0xFF
suffix:semicolon
id|tmp
op_assign
(paren
id|tmp
op_lshift
id|R_IRQ_MASK1_SET__pa0__BITNR
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|gpio_pa_irq_enabled_mask
op_or_assign
id|tmp
suffix:semicolon
op_star
id|R_IRQ_MASK1_SET
op_assign
id|tmp
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;minor
op_eq
id|GPIO_MINOR_B
)paren
id|data
op_assign
op_star
id|R_PORT_PB_DATA
suffix:semicolon
r_else
r_if
c_cond
(paren
id|priv-&gt;minor
op_eq
id|GPIO_MINOR_G
)paren
id|data
op_assign
op_star
id|R_PORT_G_DATA
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data
op_amp
id|priv-&gt;highalarm
)paren
op_logical_or
(paren
op_complement
id|data
op_amp
id|priv-&gt;lowalarm
)paren
)paren
(brace
id|mask
op_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
)brace
id|DP
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;gpio_poll ready: mask 0x%08X&bslash;n&quot;
comma
id|mask
)paren
)paren
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
DECL|function|etrax_gpio_wake_up_check
r_int
id|etrax_gpio_wake_up_check
c_func
(paren
r_void
)paren
(brace
r_struct
id|gpio_private
op_star
id|priv
op_assign
id|alarmlist
suffix:semicolon
r_int
r_int
id|data
op_assign
l_int|0
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|priv
)paren
(brace
r_if
c_cond
(paren
id|USE_PORTS
c_func
(paren
id|priv
)paren
)paren
(brace
id|data
op_assign
op_star
id|priv-&gt;port
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;minor
op_eq
id|GPIO_MINOR_G
)paren
(brace
id|data
op_assign
op_star
id|R_PORT_G_DATA
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|data
op_amp
id|priv-&gt;highalarm
)paren
op_logical_or
(paren
op_complement
id|data
op_amp
id|priv-&gt;lowalarm
)paren
)paren
(brace
id|DP
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;etrax_gpio_wake_up_check %i&bslash;n&quot;
comma
id|priv-&gt;minor
)paren
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|priv-&gt;alarm_wq
)paren
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
id|priv
op_assign
id|priv-&gt;next
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
r_static
id|irqreturn_t
DECL|function|gpio_poll_timer_interrupt
id|gpio_poll_timer_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_if
c_cond
(paren
id|gpio_some_alarms
)paren
(brace
id|etrax_gpio_wake_up_check
c_func
(paren
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_return
id|IRQ_NONE
suffix:semicolon
)brace
r_static
id|irqreturn_t
DECL|function|gpio_pa_interrupt
id|gpio_pa_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
multiline_comment|/* Find what PA interrupts are active */
id|tmp
op_assign
(paren
op_star
id|R_IRQ_READ1
)paren
suffix:semicolon
multiline_comment|/* Find those that we have enabled */
id|tmp
op_and_assign
id|gpio_pa_irq_enabled_mask
suffix:semicolon
multiline_comment|/* Clear them.. */
op_star
id|R_IRQ_MASK1_CLR
op_assign
id|tmp
suffix:semicolon
id|gpio_pa_irq_enabled_mask
op_and_assign
op_complement
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|gpio_some_alarms
)paren
(brace
r_return
id|IRQ_RETVAL
c_func
(paren
id|etrax_gpio_wake_up_check
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
r_return
id|IRQ_NONE
suffix:semicolon
)brace
DECL|function|gpio_write
r_static
id|ssize_t
id|gpio_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|off
)paren
(brace
r_struct
id|gpio_private
op_star
id|priv
op_assign
(paren
r_struct
id|gpio_private
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_int
r_char
id|data
comma
id|clk_mask
comma
id|data_mask
comma
id|write_msb
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|ssize_t
id|retval
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;minor
op_ne
id|GPIO_MINOR_A
op_logical_and
id|priv-&gt;minor
op_ne
id|GPIO_MINOR_B
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|buf
comma
id|count
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|clk_mask
op_assign
id|priv-&gt;clk_mask
suffix:semicolon
id|data_mask
op_assign
id|priv-&gt;data_mask
suffix:semicolon
multiline_comment|/* It must have been configured using the IO_CFG_WRITE_MODE */
multiline_comment|/* Perhaps a better error code? */
r_if
c_cond
(paren
id|clk_mask
op_eq
l_int|0
op_logical_or
id|data_mask
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|write_msb
op_assign
id|priv-&gt;write_msb
suffix:semicolon
id|D
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;gpio_write: %lu to data 0x%02X clk 0x%02X msb: %i&bslash;n&quot;
comma
id|count
comma
id|data_mask
comma
id|clk_mask
comma
id|write_msb
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
)paren
(brace
r_int
id|i
suffix:semicolon
id|data
op_assign
op_star
id|buf
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;write_msb
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|7
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
op_star
id|priv-&gt;port
op_assign
op_star
id|priv-&gt;shadow
op_and_assign
op_complement
id|clk_mask
suffix:semicolon
r_if
c_cond
(paren
id|data
op_amp
l_int|1
op_lshift
id|i
)paren
op_star
id|priv-&gt;port
op_assign
op_star
id|priv-&gt;shadow
op_or_assign
id|data_mask
suffix:semicolon
r_else
op_star
id|priv-&gt;port
op_assign
op_star
id|priv-&gt;shadow
op_and_assign
op_complement
id|data_mask
suffix:semicolon
multiline_comment|/* For FPGA: min 5.0ns (DCC) before CCLK high */
op_star
id|priv-&gt;port
op_assign
op_star
id|priv-&gt;shadow
op_or_assign
id|clk_mask
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|7
suffix:semicolon
id|i
op_increment
)paren
(brace
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
op_star
id|priv-&gt;port
op_assign
op_star
id|priv-&gt;shadow
op_and_assign
op_complement
id|clk_mask
suffix:semicolon
r_if
c_cond
(paren
id|data
op_amp
l_int|1
op_lshift
id|i
)paren
op_star
id|priv-&gt;port
op_assign
op_star
id|priv-&gt;shadow
op_or_assign
id|data_mask
suffix:semicolon
r_else
op_star
id|priv-&gt;port
op_assign
op_star
id|priv-&gt;shadow
op_and_assign
op_complement
id|data_mask
suffix:semicolon
multiline_comment|/* For FPGA: min 5.0ns (DCC) before CCLK high */
op_star
id|priv-&gt;port
op_assign
op_star
id|priv-&gt;shadow
op_or_assign
id|clk_mask
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
id|retval
suffix:semicolon
)brace
r_static
r_int
DECL|function|gpio_open
id|gpio_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|gpio_private
op_star
id|priv
suffix:semicolon
r_int
id|p
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
OG
id|GPIO_MINOR_LAST
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|priv
op_assign
(paren
r_struct
id|gpio_private
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|gpio_private
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|priv-&gt;minor
op_assign
id|p
suffix:semicolon
multiline_comment|/* initialize the io/alarm struct and link it into our alarmlist */
id|priv-&gt;next
op_assign
id|alarmlist
suffix:semicolon
id|alarmlist
op_assign
id|priv
suffix:semicolon
r_if
c_cond
(paren
id|USE_PORTS
c_func
(paren
id|priv
)paren
)paren
(brace
multiline_comment|/* A and B */
id|priv-&gt;port
op_assign
id|ports
(braket
id|p
)braket
suffix:semicolon
id|priv-&gt;shadow
op_assign
id|shads
(braket
id|p
)braket
suffix:semicolon
id|priv-&gt;dir
op_assign
id|dir
(braket
id|p
)braket
suffix:semicolon
id|priv-&gt;dir_shadow
op_assign
id|dir_shadow
(braket
id|p
)braket
suffix:semicolon
id|priv-&gt;changeable_dir
op_assign
id|changeable_dir
(braket
id|p
)braket
suffix:semicolon
id|priv-&gt;changeable_bits
op_assign
id|changeable_bits
(braket
id|p
)braket
suffix:semicolon
)brace
r_else
(brace
id|priv-&gt;port
op_assign
l_int|NULL
suffix:semicolon
id|priv-&gt;shadow
op_assign
l_int|NULL
suffix:semicolon
id|priv-&gt;dir
op_assign
l_int|NULL
suffix:semicolon
id|priv-&gt;dir_shadow
op_assign
l_int|NULL
suffix:semicolon
id|priv-&gt;changeable_dir
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;changeable_bits
op_assign
l_int|0
suffix:semicolon
)brace
id|priv-&gt;highalarm
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;lowalarm
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;clk_mask
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;data_mask
op_assign
l_int|0
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|priv-&gt;alarm_wq
)paren
suffix:semicolon
id|filp-&gt;private_data
op_assign
(paren
r_void
op_star
)paren
id|priv
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|gpio_release
id|gpio_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|gpio_private
op_star
id|p
op_assign
id|alarmlist
suffix:semicolon
r_struct
id|gpio_private
op_star
id|todel
op_assign
(paren
r_struct
id|gpio_private
op_star
)paren
id|filp-&gt;private_data
suffix:semicolon
multiline_comment|/* unlink from alarmlist and free the private structure */
r_if
c_cond
(paren
id|p
op_eq
id|todel
)paren
(brace
id|alarmlist
op_assign
id|todel-&gt;next
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
id|p-&gt;next
op_ne
id|todel
)paren
id|p
op_assign
id|p-&gt;next
suffix:semicolon
id|p-&gt;next
op_assign
id|todel-&gt;next
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|todel
)paren
suffix:semicolon
multiline_comment|/* Check if there are still any alarms set */
id|p
op_assign
id|alarmlist
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;highalarm
op_or
id|p-&gt;lowalarm
)paren
(brace
id|gpio_some_alarms
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|p
op_assign
id|p-&gt;next
suffix:semicolon
)brace
id|gpio_some_alarms
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Main device API. ioctl&squot;s to read/set/clear bits, as well as to &n; * set alarms to wait for using a subsequent select().&n; */
DECL|function|setget_input
r_int
r_int
r_inline
id|setget_input
c_func
(paren
r_struct
id|gpio_private
op_star
id|priv
comma
r_int
r_int
id|arg
)paren
(brace
multiline_comment|/* Set direction 0=unchanged 1=input, &n;&t; * return mask with 1=input &n;&t; */
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|USE_PORTS
c_func
(paren
id|priv
)paren
)paren
(brace
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
op_star
id|priv-&gt;dir
op_assign
op_star
id|priv-&gt;dir_shadow
op_and_assign
op_complement
(paren
(paren
r_int
r_char
)paren
id|arg
op_amp
id|priv-&gt;changeable_dir
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_complement
(paren
op_star
id|priv-&gt;dir_shadow
)paren
op_amp
l_int|0xFF
suffix:semicolon
multiline_comment|/* Only 8 bits */
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;minor
op_eq
id|GPIO_MINOR_G
)paren
(brace
multiline_comment|/* We must fiddle with R_GEN_CONFIG to change dir */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|arg
op_amp
id|dir_g_in_bits
)paren
op_ne
id|arg
)paren
op_logical_and
(paren
id|arg
op_amp
id|changeable_dir_g
)paren
)paren
(brace
id|arg
op_and_assign
id|changeable_dir_g
suffix:semicolon
multiline_comment|/* Clear bits in genconfig to set to input */
r_if
c_cond
(paren
id|arg
op_amp
(paren
l_int|1
op_lshift
l_int|0
)paren
)paren
(brace
id|genconfig_shadow
op_and_assign
op_complement
id|IO_MASK
c_func
(paren
id|R_GEN_CONFIG
comma
id|g0dir
)paren
suffix:semicolon
id|dir_g_in_bits
op_or_assign
(paren
l_int|1
op_lshift
l_int|0
)paren
suffix:semicolon
id|dir_g_out_bits
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|arg
op_amp
l_int|0x0000FF00
)paren
op_eq
l_int|0x0000FF00
)paren
(brace
id|genconfig_shadow
op_and_assign
op_complement
id|IO_MASK
c_func
(paren
id|R_GEN_CONFIG
comma
id|g8_15dir
)paren
suffix:semicolon
id|dir_g_in_bits
op_or_assign
l_int|0x0000FF00
suffix:semicolon
id|dir_g_out_bits
op_and_assign
op_complement
l_int|0x0000FF00
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|arg
op_amp
l_int|0x00FF0000
)paren
op_eq
l_int|0x00FF0000
)paren
(brace
id|genconfig_shadow
op_and_assign
op_complement
id|IO_MASK
c_func
(paren
id|R_GEN_CONFIG
comma
id|g16_23dir
)paren
suffix:semicolon
id|dir_g_in_bits
op_or_assign
l_int|0x00FF0000
suffix:semicolon
id|dir_g_out_bits
op_and_assign
op_complement
l_int|0x00FF0000
suffix:semicolon
)brace
r_if
c_cond
(paren
id|arg
op_amp
(paren
l_int|1
op_lshift
l_int|24
)paren
)paren
(brace
id|genconfig_shadow
op_and_assign
op_complement
id|IO_MASK
c_func
(paren
id|R_GEN_CONFIG
comma
id|g24dir
)paren
suffix:semicolon
id|dir_g_in_bits
op_or_assign
(paren
l_int|1
op_lshift
l_int|24
)paren
suffix:semicolon
id|dir_g_out_bits
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|24
)paren
suffix:semicolon
)brace
id|D
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;gpio: SETINPUT on port G set &quot;
l_string|&quot;genconfig to 0x%08lX &quot;
l_string|&quot;in_bits: 0x%08lX &quot;
l_string|&quot;out_bits: 0x%08lX&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|genconfig_shadow
comma
id|dir_g_in_bits
comma
id|dir_g_out_bits
)paren
)paren
suffix:semicolon
op_star
id|R_GEN_CONFIG
op_assign
id|genconfig_shadow
suffix:semicolon
multiline_comment|/* Must be a &gt;120 ns delay before writing this again */
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|dir_g_in_bits
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* setget_input */
DECL|function|setget_output
r_int
r_int
r_inline
id|setget_output
c_func
(paren
r_struct
id|gpio_private
op_star
id|priv
comma
r_int
r_int
id|arg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|USE_PORTS
c_func
(paren
id|priv
)paren
)paren
(brace
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
op_star
id|priv-&gt;dir
op_assign
op_star
id|priv-&gt;dir_shadow
op_or_assign
(paren
(paren
r_int
r_char
)paren
id|arg
op_amp
id|priv-&gt;changeable_dir
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_star
id|priv-&gt;dir_shadow
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;minor
op_eq
id|GPIO_MINOR_G
)paren
(brace
multiline_comment|/* We must fiddle with R_GEN_CONFIG to change dir */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|arg
op_amp
id|dir_g_out_bits
)paren
op_ne
id|arg
)paren
op_logical_and
(paren
id|arg
op_amp
id|changeable_dir_g
)paren
)paren
(brace
multiline_comment|/* Set bits in genconfig to set to output */
r_if
c_cond
(paren
id|arg
op_amp
(paren
l_int|1
op_lshift
l_int|0
)paren
)paren
(brace
id|genconfig_shadow
op_or_assign
id|IO_MASK
c_func
(paren
id|R_GEN_CONFIG
comma
id|g0dir
)paren
suffix:semicolon
id|dir_g_out_bits
op_or_assign
(paren
l_int|1
op_lshift
l_int|0
)paren
suffix:semicolon
id|dir_g_in_bits
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|arg
op_amp
l_int|0x0000FF00
)paren
op_eq
l_int|0x0000FF00
)paren
(brace
id|genconfig_shadow
op_or_assign
id|IO_MASK
c_func
(paren
id|R_GEN_CONFIG
comma
id|g8_15dir
)paren
suffix:semicolon
id|dir_g_out_bits
op_or_assign
l_int|0x0000FF00
suffix:semicolon
id|dir_g_in_bits
op_and_assign
op_complement
l_int|0x0000FF00
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|arg
op_amp
l_int|0x00FF0000
)paren
op_eq
l_int|0x00FF0000
)paren
(brace
id|genconfig_shadow
op_or_assign
id|IO_MASK
c_func
(paren
id|R_GEN_CONFIG
comma
id|g16_23dir
)paren
suffix:semicolon
id|dir_g_out_bits
op_or_assign
l_int|0x00FF0000
suffix:semicolon
id|dir_g_in_bits
op_and_assign
op_complement
l_int|0x00FF0000
suffix:semicolon
)brace
r_if
c_cond
(paren
id|arg
op_amp
(paren
l_int|1
op_lshift
l_int|24
)paren
)paren
(brace
id|genconfig_shadow
op_or_assign
id|IO_MASK
c_func
(paren
id|R_GEN_CONFIG
comma
id|g24dir
)paren
suffix:semicolon
id|dir_g_out_bits
op_or_assign
(paren
l_int|1
op_lshift
l_int|24
)paren
suffix:semicolon
id|dir_g_in_bits
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|24
)paren
suffix:semicolon
)brace
id|D
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;gpio: SETOUTPUT on port G set &quot;
l_string|&quot;genconfig to 0x%08lX &quot;
l_string|&quot;in_bits: 0x%08lX &quot;
l_string|&quot;out_bits: 0x%08lX&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|genconfig_shadow
comma
id|dir_g_in_bits
comma
id|dir_g_out_bits
)paren
)paren
suffix:semicolon
op_star
id|R_GEN_CONFIG
op_assign
id|genconfig_shadow
suffix:semicolon
multiline_comment|/* Must be a &gt;120 ns delay before writing this again */
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|dir_g_out_bits
op_amp
l_int|0x7FFFFFFF
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* setget_output */
r_static
r_int
id|gpio_leds_ioctl
c_func
(paren
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
DECL|function|gpio_ioctl
id|gpio_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|val
suffix:semicolon
r_struct
id|gpio_private
op_star
id|priv
op_assign
(paren
r_struct
id|gpio_private
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|_IOC_TYPE
c_func
(paren
id|cmd
)paren
op_ne
id|ETRAXGPIO_IOCTYPE
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|_IOC_NR
c_func
(paren
id|cmd
)paren
)paren
(brace
r_case
id|IO_READBITS
suffix:colon
multiline_comment|/* Use IO_READ_INBITS and IO_READ_OUTBITS instead */
singleline_comment|// read the port
r_if
c_cond
(paren
id|USE_PORTS
c_func
(paren
id|priv
)paren
)paren
(brace
r_return
op_star
id|priv-&gt;port
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;minor
op_eq
id|GPIO_MINOR_G
)paren
(brace
r_return
(paren
op_star
id|R_PORT_G_DATA
)paren
op_amp
l_int|0x7FFFFFFF
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|IO_SETBITS
suffix:colon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
singleline_comment|// set changeable bits with a 1 in arg
r_if
c_cond
(paren
id|USE_PORTS
c_func
(paren
id|priv
)paren
)paren
(brace
op_star
id|priv-&gt;port
op_assign
op_star
id|priv-&gt;shadow
op_or_assign
(paren
(paren
r_int
r_char
)paren
id|arg
op_amp
id|priv-&gt;changeable_bits
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;minor
op_eq
id|GPIO_MINOR_G
)paren
(brace
op_star
id|R_PORT_G_DATA
op_assign
id|port_g_data_shadow
op_or_assign
(paren
id|arg
op_amp
id|dir_g_out_bits
)paren
suffix:semicolon
)brace
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IO_CLRBITS
suffix:colon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
singleline_comment|// clear changeable bits with a 1 in arg
r_if
c_cond
(paren
id|USE_PORTS
c_func
(paren
id|priv
)paren
)paren
(brace
op_star
id|priv-&gt;port
op_assign
op_star
id|priv-&gt;shadow
op_and_assign
op_complement
(paren
(paren
r_int
r_char
)paren
id|arg
op_amp
id|priv-&gt;changeable_bits
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;minor
op_eq
id|GPIO_MINOR_G
)paren
(brace
op_star
id|R_PORT_G_DATA
op_assign
id|port_g_data_shadow
op_and_assign
op_complement
(paren
(paren
r_int
r_int
)paren
id|arg
op_amp
id|dir_g_out_bits
)paren
suffix:semicolon
)brace
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IO_HIGHALARM
suffix:colon
singleline_comment|// set alarm when bits with 1 in arg go high
id|priv-&gt;highalarm
op_or_assign
id|arg
suffix:semicolon
id|gpio_some_alarms
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IO_LOWALARM
suffix:colon
singleline_comment|// set alarm when bits with 1 in arg go low
id|priv-&gt;lowalarm
op_or_assign
id|arg
suffix:semicolon
id|gpio_some_alarms
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IO_CLRALARM
suffix:colon
singleline_comment|// clear alarm for bits with 1 in arg
id|priv-&gt;highalarm
op_and_assign
op_complement
id|arg
suffix:semicolon
id|priv-&gt;lowalarm
op_and_assign
op_complement
id|arg
suffix:semicolon
(brace
multiline_comment|/* Must update gpio_some_alarms */
r_struct
id|gpio_private
op_star
id|p
op_assign
id|alarmlist
suffix:semicolon
r_int
id|some_alarms
suffix:semicolon
id|some_alarms
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;highalarm
op_or
id|p-&gt;lowalarm
)paren
(brace
id|some_alarms
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|p
op_assign
id|p-&gt;next
suffix:semicolon
)brace
id|gpio_some_alarms
op_assign
id|some_alarms
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|IO_READDIR
suffix:colon
multiline_comment|/* Use IO_SETGET_INPUT/OUTPUT instead! */
multiline_comment|/* Read direction 0=input 1=output */
r_if
c_cond
(paren
id|USE_PORTS
c_func
(paren
id|priv
)paren
)paren
(brace
r_return
op_star
id|priv-&gt;dir_shadow
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;minor
op_eq
id|GPIO_MINOR_G
)paren
(brace
multiline_comment|/* Note: Some bits are both in and out,&n;&t;&t;&t; * Those that are dual is set here as well.&n;&t;&t;&t; */
r_return
(paren
id|dir_g_shadow
op_or
id|dir_g_out_bits
)paren
op_amp
l_int|0x7FFFFFFF
suffix:semicolon
)brace
r_case
id|IO_SETINPUT
suffix:colon
multiline_comment|/* Use IO_SETGET_INPUT instead! */
multiline_comment|/* Set direction 0=unchanged 1=input, &n;&t;&t; * return mask with 1=input &n;&t;&t; */
r_return
id|setget_input
c_func
(paren
id|priv
comma
id|arg
)paren
op_amp
l_int|0x7FFFFFFF
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IO_SETOUTPUT
suffix:colon
multiline_comment|/* Use IO_SETGET_OUTPUT instead! */
multiline_comment|/* Set direction 0=unchanged 1=output, &n;&t;&t; * return mask with 1=output &n;&t;&t; */
r_return
id|setget_output
c_func
(paren
id|priv
comma
id|arg
)paren
op_amp
l_int|0x7FFFFFFF
suffix:semicolon
r_case
id|IO_SHUTDOWN
suffix:colon
id|SOFT_SHUTDOWN
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IO_GET_PWR_BT
suffix:colon
macro_line|#if defined (CONFIG_ETRAX_SOFT_SHUTDOWN)
r_return
(paren
op_star
id|R_PORT_G_DATA
op_amp
(paren
l_int|1
op_lshift
id|CONFIG_ETRAX_POWERBUTTON_BIT
)paren
)paren
suffix:semicolon
macro_line|#else
r_return
l_int|0
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|IO_CFG_WRITE_MODE
suffix:colon
id|priv-&gt;clk_mask
op_assign
id|arg
op_amp
l_int|0xFF
suffix:semicolon
id|priv-&gt;data_mask
op_assign
(paren
id|arg
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|priv-&gt;write_msb
op_assign
(paren
id|arg
op_rshift
l_int|16
)paren
op_amp
l_int|0x01
suffix:semicolon
multiline_comment|/* Check if we&squot;re allowed to change the bits and&n;&t;&t; * the direction is correct&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|priv-&gt;clk_mask
op_amp
id|priv-&gt;changeable_bits
)paren
op_logical_and
(paren
id|priv-&gt;data_mask
op_amp
id|priv-&gt;changeable_bits
)paren
op_logical_and
(paren
id|priv-&gt;clk_mask
op_amp
op_star
id|priv-&gt;dir_shadow
)paren
op_logical_and
(paren
id|priv-&gt;data_mask
op_amp
op_star
id|priv-&gt;dir_shadow
)paren
)paren
)paren
(brace
id|priv-&gt;clk_mask
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;data_mask
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|IO_READ_INBITS
suffix:colon
multiline_comment|/* *arg is result of reading the input pins */
r_if
c_cond
(paren
id|USE_PORTS
c_func
(paren
id|priv
)paren
)paren
(brace
id|val
op_assign
op_star
id|priv-&gt;port
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;minor
op_eq
id|GPIO_MINOR_G
)paren
(brace
id|val
op_assign
op_star
id|R_PORT_G_DATA
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|arg
comma
op_amp
id|val
comma
r_sizeof
(paren
id|val
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IO_READ_OUTBITS
suffix:colon
multiline_comment|/* *arg is result of reading the output shadow */
r_if
c_cond
(paren
id|USE_PORTS
c_func
(paren
id|priv
)paren
)paren
(brace
id|val
op_assign
op_star
id|priv-&gt;shadow
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;minor
op_eq
id|GPIO_MINOR_G
)paren
(brace
id|val
op_assign
id|port_g_data_shadow
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|arg
comma
op_amp
id|val
comma
r_sizeof
(paren
id|val
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IO_SETGET_INPUT
suffix:colon
multiline_comment|/* bits set in *arg is set to input,&n;&t;&t; * *arg updated with current input pins.&n;&t;&t; */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|val
comma
(paren
r_int
r_int
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|val
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|val
op_assign
id|setget_input
c_func
(paren
id|priv
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|arg
comma
op_amp
id|val
comma
r_sizeof
(paren
id|val
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IO_SETGET_OUTPUT
suffix:colon
multiline_comment|/* bits set in *arg is set to output,&n;&t;&t; * *arg updated with current output pins.&n;&t;&t; */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|val
comma
(paren
r_int
r_int
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|val
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|val
op_assign
id|setget_output
c_func
(paren
id|priv
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|arg
comma
op_amp
id|val
comma
r_sizeof
(paren
id|val
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|priv-&gt;minor
op_eq
id|GPIO_MINOR_LEDS
)paren
r_return
id|gpio_leds_ioctl
c_func
(paren
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* switch */
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|gpio_leds_ioctl
id|gpio_leds_ioctl
c_func
(paren
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
r_char
id|green
suffix:semicolon
r_int
r_char
id|red
suffix:semicolon
r_switch
c_cond
(paren
id|_IOC_NR
c_func
(paren
id|cmd
)paren
)paren
(brace
r_case
id|IO_LEDACTIVE_SET
suffix:colon
id|green
op_assign
(paren
(paren
r_int
r_char
)paren
id|arg
)paren
op_amp
l_int|1
suffix:semicolon
id|red
op_assign
(paren
(paren
(paren
r_int
r_char
)paren
id|arg
)paren
op_rshift
l_int|1
)paren
op_amp
l_int|1
suffix:semicolon
id|LED_ACTIVE_SET_G
c_func
(paren
id|green
)paren
suffix:semicolon
id|LED_ACTIVE_SET_R
c_func
(paren
id|red
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IO_LED_SETBIT
suffix:colon
id|LED_BIT_SET
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IO_LED_CLRBIT
suffix:colon
id|LED_BIT_CLR
c_func
(paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* switch */
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|gpio_fops
r_struct
id|file_operations
id|gpio_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|poll
op_assign
id|gpio_poll
comma
dot
id|ioctl
op_assign
id|gpio_ioctl
comma
dot
id|write
op_assign
id|gpio_write
comma
dot
id|open
op_assign
id|gpio_open
comma
dot
id|release
op_assign
id|gpio_release
comma
)brace
suffix:semicolon
DECL|function|gpio_init_port_g
r_static
r_void
id|__init
id|gpio_init_port_g
c_func
(paren
r_void
)paren
(brace
DECL|macro|GROUPA
mdefine_line|#define GROUPA (0x0000FF3F)
DECL|macro|GROUPB
mdefine_line|#define GROUPB (1&lt;&lt;6 | 1&lt;&lt;7)
DECL|macro|GROUPC
mdefine_line|#define GROUPC (1&lt;&lt;30 | 1&lt;&lt;31)
DECL|macro|GROUPD
mdefine_line|#define GROUPD (0x3FFF0000)
DECL|macro|GROUPD_LOW
mdefine_line|#define GROUPD_LOW (0x00FF0000)
r_int
r_int
id|used_in_bits
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|used_out_bits
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|genconfig_shadow
op_amp
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|scsi0
comma
id|select
)paren
)paren
(brace
id|used_in_bits
op_or_assign
id|GROUPA
op_or
id|GROUPB
op_or
l_int|0
op_or
l_int|0
suffix:semicolon
id|used_out_bits
op_or_assign
id|GROUPA
op_or
id|GROUPB
op_or
l_int|0
op_or
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|genconfig_shadow
op_amp
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|ata
comma
id|select
)paren
)paren
(brace
id|used_in_bits
op_or_assign
id|GROUPA
op_or
id|GROUPB
op_or
id|GROUPC
op_or
(paren
id|GROUPD
op_amp
op_complement
(paren
l_int|1
op_lshift
l_int|25
op_or
l_int|1
op_lshift
l_int|26
)paren
)paren
suffix:semicolon
id|used_out_bits
op_or_assign
id|GROUPA
op_or
id|GROUPB
op_or
id|GROUPC
op_or
id|GROUPD
suffix:semicolon
)brace
r_if
c_cond
(paren
id|genconfig_shadow
op_amp
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|par0
comma
id|select
)paren
)paren
(brace
id|used_in_bits
op_or_assign
(paren
id|GROUPA
op_amp
op_complement
(paren
l_int|1
op_lshift
l_int|0
)paren
)paren
op_or
l_int|0
op_or
l_int|0
op_or
l_int|0
suffix:semicolon
id|used_out_bits
op_or_assign
(paren
id|GROUPA
op_amp
op_complement
(paren
l_int|1
op_lshift
l_int|0
)paren
)paren
op_or
l_int|0
op_or
l_int|0
op_or
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|genconfig_shadow
op_amp
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|ser2
comma
id|select
)paren
)paren
(brace
id|used_in_bits
op_or_assign
l_int|0
op_or
id|GROUPB
op_or
l_int|0
op_or
l_int|0
suffix:semicolon
id|used_out_bits
op_or_assign
l_int|0
op_or
id|GROUPB
op_or
l_int|0
op_or
l_int|0
suffix:semicolon
)brace
multiline_comment|/* mio same as shared RAM ? */
r_if
c_cond
(paren
id|genconfig_shadow
op_amp
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|mio
comma
id|select
)paren
)paren
(brace
id|used_in_bits
op_or_assign
(paren
id|GROUPA
op_amp
op_complement
(paren
l_int|1
op_lshift
l_int|0
)paren
)paren
op_or
l_int|0
op_or
l_int|0
op_or
id|GROUPD_LOW
suffix:semicolon
id|used_out_bits
op_or_assign
(paren
id|GROUPA
op_amp
op_complement
(paren
l_int|1
op_lshift
l_int|0
op_or
l_int|1
op_lshift
l_int|1
op_or
l_int|1
op_lshift
l_int|2
)paren
)paren
op_or
l_int|0
op_or
l_int|0
op_or
id|GROUPD_LOW
suffix:semicolon
)brace
r_if
c_cond
(paren
id|genconfig_shadow
op_amp
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|scsi1
comma
id|select
)paren
)paren
(brace
id|used_in_bits
op_or_assign
l_int|0
op_or
l_int|0
op_or
id|GROUPC
op_or
id|GROUPD
suffix:semicolon
id|used_out_bits
op_or_assign
l_int|0
op_or
l_int|0
op_or
id|GROUPC
op_or
id|GROUPD
suffix:semicolon
)brace
r_if
c_cond
(paren
id|genconfig_shadow
op_amp
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|scsi0w
comma
id|select
)paren
)paren
(brace
id|used_in_bits
op_or_assign
id|GROUPA
op_or
id|GROUPB
op_or
l_int|0
op_or
(paren
id|GROUPD_LOW
op_or
l_int|1
op_lshift
l_int|24
)paren
suffix:semicolon
id|used_out_bits
op_or_assign
id|GROUPA
op_or
id|GROUPB
op_or
l_int|0
op_or
(paren
id|GROUPD_LOW
op_or
l_int|1
op_lshift
l_int|24
op_or
l_int|1
op_lshift
l_int|25
op_or
l_int|1
op_lshift
l_int|26
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|genconfig_shadow
op_amp
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|par1
comma
id|select
)paren
)paren
(brace
id|used_in_bits
op_or_assign
l_int|0
op_or
l_int|0
op_or
l_int|0
op_or
(paren
id|GROUPD
op_amp
op_complement
(paren
l_int|1
op_lshift
l_int|24
)paren
)paren
suffix:semicolon
id|used_out_bits
op_or_assign
l_int|0
op_or
l_int|0
op_or
l_int|0
op_or
(paren
id|GROUPD
op_amp
op_complement
(paren
l_int|1
op_lshift
l_int|24
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|genconfig_shadow
op_amp
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|ser3
comma
id|select
)paren
)paren
(brace
id|used_in_bits
op_or_assign
l_int|0
op_or
l_int|0
op_or
id|GROUPC
op_or
l_int|0
suffix:semicolon
id|used_out_bits
op_or_assign
l_int|0
op_or
l_int|0
op_or
id|GROUPC
op_or
l_int|0
suffix:semicolon
)brace
multiline_comment|/* mio same as shared RAM-W? */
r_if
c_cond
(paren
id|genconfig_shadow
op_amp
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|mio_w
comma
id|select
)paren
)paren
(brace
id|used_in_bits
op_or_assign
(paren
id|GROUPA
op_amp
op_complement
(paren
l_int|1
op_lshift
l_int|0
)paren
)paren
op_or
l_int|0
op_or
l_int|0
op_or
id|GROUPD_LOW
suffix:semicolon
id|used_out_bits
op_or_assign
(paren
id|GROUPA
op_amp
op_complement
(paren
l_int|1
op_lshift
l_int|0
op_or
l_int|1
op_lshift
l_int|1
op_or
l_int|1
op_lshift
l_int|2
)paren
)paren
op_or
l_int|0
op_or
l_int|0
op_or
id|GROUPD_LOW
suffix:semicolon
)brace
multiline_comment|/* TODO: USB p2, parw, sync ser3? */
multiline_comment|/* Initialise the dir_g_shadow etc. depending on genconfig */
multiline_comment|/* 0=input 1=output */
r_if
c_cond
(paren
id|genconfig_shadow
op_amp
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|g0dir
comma
id|out
)paren
)paren
id|dir_g_shadow
op_or_assign
(paren
l_int|1
op_lshift
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|genconfig_shadow
op_amp
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|g8_15dir
comma
id|out
)paren
)paren
id|dir_g_shadow
op_or_assign
l_int|0x0000FF00
suffix:semicolon
r_if
c_cond
(paren
id|genconfig_shadow
op_amp
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|g16_23dir
comma
id|out
)paren
)paren
id|dir_g_shadow
op_or_assign
l_int|0x00FF0000
suffix:semicolon
r_if
c_cond
(paren
id|genconfig_shadow
op_amp
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|g24dir
comma
id|out
)paren
)paren
id|dir_g_shadow
op_or_assign
(paren
l_int|1
op_lshift
l_int|24
)paren
suffix:semicolon
id|dir_g_in_bits
op_assign
op_complement
id|used_in_bits
suffix:semicolon
id|dir_g_out_bits
op_assign
op_complement
id|used_out_bits
suffix:semicolon
id|changeable_dir_g
op_assign
l_int|0x01FFFF01
suffix:semicolon
multiline_comment|/* all that can change dir */
id|changeable_dir_g
op_and_assign
id|dir_g_out_bits
suffix:semicolon
id|changeable_dir_g
op_and_assign
id|dir_g_in_bits
suffix:semicolon
multiline_comment|/* Correct the bits that can change direction */
id|dir_g_out_bits
op_and_assign
op_complement
id|changeable_dir_g
suffix:semicolon
id|dir_g_out_bits
op_or_assign
id|dir_g_shadow
suffix:semicolon
id|dir_g_in_bits
op_and_assign
op_complement
id|changeable_dir_g
suffix:semicolon
id|dir_g_in_bits
op_or_assign
(paren
op_complement
id|dir_g_shadow
op_amp
id|changeable_dir_g
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;GPIO port G: in_bits: 0x%08lX out_bits: 0x%08lX val: %08lX&bslash;n&quot;
comma
id|dir_g_in_bits
comma
id|dir_g_out_bits
comma
(paren
r_int
r_int
)paren
op_star
id|R_PORT_G_DATA
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;GPIO port G: dir: %08lX changeable: %08lX&bslash;n&quot;
comma
id|dir_g_shadow
comma
id|changeable_dir_g
)paren
suffix:semicolon
)brace
multiline_comment|/* main driver initialization routine, called from mem.c */
r_static
id|__init
r_int
DECL|function|gpio_init
id|gpio_init
c_func
(paren
r_void
)paren
(brace
r_int
id|res
suffix:semicolon
macro_line|#if defined (CONFIG_ETRAX_CSP0_LEDS)
r_int
id|i
suffix:semicolon
macro_line|#endif
multiline_comment|/* do the formalities */
id|res
op_assign
id|register_chrdev
c_func
(paren
id|GPIO_MAJOR
comma
id|gpio_name
comma
op_amp
id|gpio_fops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;gpio: couldn&squot;t get a major number.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/* Clear all leds */
macro_line|#if defined (CONFIG_ETRAX_CSP0_LEDS) ||  defined (CONFIG_ETRAX_PA_LEDS) || defined (CONFIG_ETRAX_PB_LEDS)
id|LED_NETWORK_SET
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|LED_ACTIVE_SET
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|LED_DISK_READ
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|LED_DISK_WRITE
c_func
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#if defined (CONFIG_ETRAX_CSP0_LEDS)
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|LED_BIT_SET
c_func
(paren
id|i
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif
id|gpio_init_port_g
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ETRAX 100LX GPIO driver v2.5, (c) 2001, 2002 Axis Communications AB&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* We call etrax_gpio_wake_up_check() from timer interrupt and&n;&t; * from cpu_idle() in kernel/process.c&n;&t; * The check in cpu_idle() reduces latency from ~15 ms to ~6 ms&n;&t; * in some tests.&n;&t; */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|TIMER0_IRQ_NBR
comma
id|gpio_poll_timer_interrupt
comma
id|SA_SHIRQ
op_or
id|SA_INTERRUPT
comma
l_string|&quot;gpio poll&quot;
comma
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;err: timer0 irq for gpio&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|PA_IRQ_NBR
comma
id|gpio_pa_interrupt
comma
id|SA_SHIRQ
op_or
id|SA_INTERRUPT
comma
l_string|&quot;gpio PA&quot;
comma
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;err: PA irq for gpio&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/* this makes sure that gpio_init is called during kernel boot */
DECL|variable|gpio_init
id|module_init
c_func
(paren
id|gpio_init
)paren
suffix:semicolon
eof
