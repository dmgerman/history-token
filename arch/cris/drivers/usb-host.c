multiline_comment|/*&n; * usb-host.c: ETRAX 100LX USB Host Controller Driver (HCD)&n; *&n; * Copyright (c) 2001 Axis Communications AB.&n; *&n; * $Id: usb-host.c,v 1.11 2001/09/26 11:52:16 bjornw Exp $&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/svinto.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &quot;usb-host.h&quot;
DECL|macro|ETRAX_USB_HC_IRQ
mdefine_line|#define ETRAX_USB_HC_IRQ USB_HC_IRQ_NBR
DECL|macro|ETRAX_USB_RX_IRQ
mdefine_line|#define ETRAX_USB_RX_IRQ USB_DMA_RX_IRQ_NBR
DECL|macro|ETRAX_USB_TX_IRQ
mdefine_line|#define ETRAX_USB_TX_IRQ USB_DMA_TX_IRQ_NBR
DECL|variable|usb_hcd_version
r_static
r_const
r_char
op_star
id|usb_hcd_version
op_assign
l_string|&quot;$Revision: 1.11 $&quot;
suffix:semicolon
DECL|macro|KERN_DEBUG
macro_line|#undef KERN_DEBUG
DECL|macro|KERN_DEBUG
mdefine_line|#define KERN_DEBUG &quot;&quot;
DECL|macro|USB_DEBUG_RH
macro_line|#undef USB_DEBUG_RH
DECL|macro|USB_DEBUG_EP
macro_line|#undef USB_DEBUG_EP
DECL|macro|USB_DEBUG_DESC
macro_line|#undef USB_DEBUG_DESC
DECL|macro|USB_DEBUG_TRACE
macro_line|#undef USB_DEBUG_TRACE
DECL|macro|USB_DEBUG_CTRL
macro_line|#undef USB_DEBUG_CTRL
DECL|macro|USB_DEBUG_BULK
macro_line|#undef USB_DEBUG_BULK
DECL|macro|USB_DEBUG_INTR
macro_line|#undef USB_DEBUG_INTR
macro_line|#ifdef USB_DEBUG_RH
DECL|macro|dbg_rh
mdefine_line|#define dbg_rh(format, arg...) printk(KERN_DEBUG __FILE__ &quot;: (RH) &quot; format &quot;&bslash;n&quot; , ## arg)
macro_line|#else
DECL|macro|dbg_rh
mdefine_line|#define dbg_rh(format, arg...) do {} while (0)
macro_line|#endif
macro_line|#ifdef USB_DEBUG_EP
DECL|macro|dbg_ep
mdefine_line|#define dbg_ep(format, arg...) printk(KERN_DEBUG __FILE__ &quot;: (EP) &quot; format &quot;&bslash;n&quot; , ## arg)
macro_line|#else
DECL|macro|dbg_ep
mdefine_line|#define dbg_ep(format, arg...) do {} while (0)
macro_line|#endif
macro_line|#ifdef USB_DEBUG_CTRL
DECL|macro|dbg_ctrl
mdefine_line|#define dbg_ctrl(format, arg...) printk(KERN_DEBUG __FILE__ &quot;: (CTRL) &quot; format &quot;&bslash;n&quot; , ## arg)
macro_line|#else
DECL|macro|dbg_ctrl
mdefine_line|#define dbg_ctrl(format, arg...) do {} while (0)
macro_line|#endif
macro_line|#ifdef USB_DEBUG_BULK
DECL|macro|dbg_bulk
mdefine_line|#define dbg_bulk(format, arg...) printk(KERN_DEBUG __FILE__ &quot;: (BULK) &quot; format &quot;&bslash;n&quot; , ## arg)
macro_line|#else
DECL|macro|dbg_bulk
mdefine_line|#define dbg_bulk(format, arg...) do {} while (0)
macro_line|#endif
macro_line|#ifdef USB_DEBUG_INTR
DECL|macro|dbg_intr
mdefine_line|#define dbg_intr(format, arg...) printk(KERN_DEBUG __FILE__ &quot;: (INTR) &quot; format &quot;&bslash;n&quot; , ## arg)
macro_line|#else
DECL|macro|dbg_intr
mdefine_line|#define dbg_intr(format, arg...) do {} while (0)
macro_line|#endif
macro_line|#ifdef USB_DEBUG_TRACE
DECL|macro|DBFENTER
mdefine_line|#define DBFENTER (printk(KERN_DEBUG __FILE__ &quot;: Entering : &quot; __FUNCTION__ &quot;&bslash;n&quot;))
DECL|macro|DBFEXIT
mdefine_line|#define DBFEXIT  (printk(KERN_DEBUG __FILE__ &quot;: Exiting  : &quot; __FUNCTION__ &quot;&bslash;n&quot;))
macro_line|#else
DECL|macro|DBFENTER
mdefine_line|#define DBFENTER (NULL)
DECL|macro|DBFEXIT
mdefine_line|#define DBFEXIT  (NULL)
macro_line|#endif
multiline_comment|/*-------------------------------------------------------------------&n; Virtual Root Hub&n; -------------------------------------------------------------------*/
DECL|variable|root_hub_dev_des
r_static
id|__u8
id|root_hub_dev_des
(braket
)braket
op_assign
(brace
l_int|0x12
comma
multiline_comment|/*  __u8  bLength; */
l_int|0x01
comma
multiline_comment|/*  __u8  bDescriptorType; Device */
l_int|0x00
comma
multiline_comment|/*  __u16 bcdUSB; v1.0 */
l_int|0x01
comma
l_int|0x09
comma
multiline_comment|/*  __u8  bDeviceClass; HUB_CLASSCODE */
l_int|0x00
comma
multiline_comment|/*  __u8  bDeviceSubClass; */
l_int|0x00
comma
multiline_comment|/*  __u8  bDeviceProtocol; */
l_int|0x08
comma
multiline_comment|/*  __u8  bMaxPacketSize0; 8 Bytes */
l_int|0x00
comma
multiline_comment|/*  __u16 idVendor; */
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/*  __u16 idProduct; */
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/*  __u16 bcdDevice; */
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/*  __u8  iManufacturer; */
l_int|0x02
comma
multiline_comment|/*  __u8  iProduct; */
l_int|0x01
comma
multiline_comment|/*  __u8  iSerialNumber; */
l_int|0x01
multiline_comment|/*  __u8  bNumConfigurations; */
)brace
suffix:semicolon
multiline_comment|/* Configuration descriptor */
DECL|variable|root_hub_config_des
r_static
id|__u8
id|root_hub_config_des
(braket
)braket
op_assign
(brace
l_int|0x09
comma
multiline_comment|/*  __u8  bLength; */
l_int|0x02
comma
multiline_comment|/*  __u8  bDescriptorType; Configuration */
l_int|0x19
comma
multiline_comment|/*  __u16 wTotalLength; */
l_int|0x00
comma
l_int|0x01
comma
multiline_comment|/*  __u8  bNumInterfaces; */
l_int|0x01
comma
multiline_comment|/*  __u8  bConfigurationValue; */
l_int|0x00
comma
multiline_comment|/*  __u8  iConfiguration; */
l_int|0x40
comma
multiline_comment|/*  __u8  bmAttributes; Bit 7: Bus-powered */
l_int|0x00
comma
multiline_comment|/*  __u8  MaxPower; */
multiline_comment|/* interface */
l_int|0x09
comma
multiline_comment|/*  __u8  if_bLength; */
l_int|0x04
comma
multiline_comment|/*  __u8  if_bDescriptorType; Interface */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bInterfaceNumber; */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bAlternateSetting; */
l_int|0x01
comma
multiline_comment|/*  __u8  if_bNumEndpoints; */
l_int|0x09
comma
multiline_comment|/*  __u8  if_bInterfaceClass; HUB_CLASSCODE */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bInterfaceSubClass; */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bInterfaceProtocol; */
l_int|0x00
comma
multiline_comment|/*  __u8  if_iInterface; */
multiline_comment|/* endpoint */
l_int|0x07
comma
multiline_comment|/*  __u8  ep_bLength; */
l_int|0x05
comma
multiline_comment|/*  __u8  ep_bDescriptorType; Endpoint */
l_int|0x81
comma
multiline_comment|/*  __u8  ep_bEndpointAddress; IN Endpoint 1 */
l_int|0x03
comma
multiline_comment|/*  __u8  ep_bmAttributes; Interrupt */
l_int|0x08
comma
multiline_comment|/*  __u16 ep_wMaxPacketSize; 8 Bytes */
l_int|0x00
comma
l_int|0xff
multiline_comment|/*  __u8  ep_bInterval; 255 ms */
)brace
suffix:semicolon
DECL|variable|root_hub_hub_des
r_static
id|__u8
id|root_hub_hub_des
(braket
)braket
op_assign
(brace
l_int|0x09
comma
multiline_comment|/*  __u8  bLength; */
l_int|0x29
comma
multiline_comment|/*  __u8  bDescriptorType; Hub-descriptor */
l_int|0x02
comma
multiline_comment|/*  __u8  bNbrPorts; */
l_int|0x00
comma
multiline_comment|/* __u16  wHubCharacteristics; */
l_int|0x00
comma
l_int|0x01
comma
multiline_comment|/*  __u8  bPwrOn2pwrGood; 2ms */
l_int|0x00
comma
multiline_comment|/*  __u8  bHubContrCurrent; 0 mA */
l_int|0x00
comma
multiline_comment|/*  __u8  DeviceRemovable; *** 7 Ports max *** */
l_int|0xff
multiline_comment|/*  __u8  PortPwrCtrlMask; *** 7 ports max *** */
)brace
suffix:semicolon
DECL|macro|OK
mdefine_line|#define OK(x) len = (x); dbg_rh(&quot;OK(%d): line: %d&quot;, x, __LINE__); break
DECL|macro|CHECK_ALIGN
mdefine_line|#define CHECK_ALIGN(x) if (((__u32)(x)) &amp; 0x00000003) &bslash;&n;{panic(&quot;Alignment check (DWORD) failed at %s:%s:%d&bslash;n&quot;, __FILE__, __FUNCTION__, __LINE__);}
DECL|variable|submit_urb_count
r_static
id|submit_urb_count
op_assign
l_int|0
suffix:semicolon
singleline_comment|//#define ETRAX_USB_INTR_IRQ
singleline_comment|//#define ETRAX_USB_INTR_ERROR_FATAL
DECL|macro|RX_BUF_SIZE
mdefine_line|#define RX_BUF_SIZE        32768
DECL|macro|RX_DESC_BUF_SIZE
mdefine_line|#define RX_DESC_BUF_SIZE   64
DECL|macro|NBR_OF_RX_DESC
mdefine_line|#define NBR_OF_RX_DESC     (RX_BUF_SIZE / RX_DESC_BUF_SIZE)
DECL|macro|NBR_OF_EP_DESC
mdefine_line|#define NBR_OF_EP_DESC     32
DECL|macro|MAX_INTR_INTERVAL
mdefine_line|#define MAX_INTR_INTERVAL 128
DECL|variable|ep_usage_bitmask
r_static
id|__u32
id|ep_usage_bitmask
suffix:semicolon
DECL|variable|ep_really_active
r_static
id|__u32
id|ep_really_active
suffix:semicolon
DECL|variable|RxBuf
r_static
r_int
r_char
id|RxBuf
(braket
id|RX_BUF_SIZE
)braket
suffix:semicolon
DECL|variable|RxDescList
r_static
id|USB_IN_Desc_t
id|RxDescList
(braket
id|NBR_OF_RX_DESC
)braket
id|__attribute__
(paren
(paren
id|aligned
(paren
l_int|4
)paren
)paren
)paren
suffix:semicolon
DECL|variable|myNextRxDesc
r_static
r_volatile
id|USB_IN_Desc_t
op_star
id|myNextRxDesc
suffix:semicolon
DECL|variable|myLastRxDesc
r_static
r_volatile
id|USB_IN_Desc_t
op_star
id|myLastRxDesc
suffix:semicolon
DECL|variable|myPrevRxDesc
r_static
r_volatile
id|USB_IN_Desc_t
op_star
id|myPrevRxDesc
suffix:semicolon
DECL|variable|TxCtrlEPList
r_static
id|USB_EP_Desc_t
id|TxCtrlEPList
(braket
id|NBR_OF_EP_DESC
)braket
id|__attribute__
(paren
(paren
id|aligned
(paren
l_int|4
)paren
)paren
)paren
suffix:semicolon
DECL|variable|TxBulkEPList
r_static
id|USB_EP_Desc_t
id|TxBulkEPList
(braket
id|NBR_OF_EP_DESC
)braket
id|__attribute__
(paren
(paren
id|aligned
(paren
l_int|4
)paren
)paren
)paren
suffix:semicolon
DECL|variable|TxIntrEPList
r_static
id|USB_EP_Desc_t
id|TxIntrEPList
(braket
id|MAX_INTR_INTERVAL
)braket
id|__attribute__
(paren
(paren
id|aligned
(paren
l_int|4
)paren
)paren
)paren
suffix:semicolon
DECL|variable|TxIntrSB_zout
r_static
id|USB_SB_Desc_t
id|TxIntrSB_zout
id|__attribute__
(paren
(paren
id|aligned
(paren
l_int|4
)paren
)paren
)paren
suffix:semicolon
DECL|variable|URB_List
r_static
id|urb_t
op_star
id|URB_List
(braket
id|NBR_OF_EP_DESC
)braket
suffix:semicolon
DECL|variable|usb_desc_cache
r_static
id|kmem_cache_t
op_star
id|usb_desc_cache
suffix:semicolon
DECL|variable|etrax_usb_bus
r_static
r_struct
id|usb_bus
op_star
id|etrax_usb_bus
suffix:semicolon
r_static
r_void
id|dump_urb
(paren
r_struct
id|urb
op_star
id|urb
)paren
suffix:semicolon
r_static
r_void
id|init_rx_buffers
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|etrax_rh_unlink_urb
(paren
id|urb_t
op_star
id|urb
)paren
suffix:semicolon
r_static
r_void
id|etrax_rh_send_irq
c_func
(paren
id|urb_t
op_star
id|urb
)paren
suffix:semicolon
r_static
r_void
id|etrax_rh_init_int_timer
c_func
(paren
id|urb_t
op_star
id|urb
)paren
suffix:semicolon
r_static
r_void
id|etrax_rh_int_timer_do
c_func
(paren
r_int
r_int
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|etrax_usb_setup_epid
c_func
(paren
r_char
id|epid
comma
r_char
id|devnum
comma
r_char
id|endpoint
comma
r_char
id|packsize
comma
r_char
id|slow
)paren
suffix:semicolon
r_static
r_int
id|etrax_usb_lookup_epid
c_func
(paren
r_int
r_char
id|devnum
comma
r_char
id|endpoint
comma
r_char
id|slow
comma
r_int
id|maxp
)paren
suffix:semicolon
r_static
r_int
id|etrax_usb_allocate_epid
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|etrax_usb_free_epid
c_func
(paren
r_char
id|epid
)paren
suffix:semicolon
r_static
r_void
id|cleanup_sb
c_func
(paren
id|USB_SB_Desc_t
op_star
id|sb
)paren
suffix:semicolon
r_static
r_int
id|etrax_usb_do_ctrl_hw_add
c_func
(paren
id|urb_t
op_star
id|urb
comma
r_char
id|epid
comma
r_char
id|maxlen
)paren
suffix:semicolon
r_static
r_int
id|etrax_usb_do_bulk_hw_add
c_func
(paren
id|urb_t
op_star
id|urb
comma
r_char
id|epid
comma
r_char
id|maxlen
)paren
suffix:semicolon
r_static
r_int
id|etrax_usb_submit_ctrl_urb
c_func
(paren
id|urb_t
op_star
id|urb
)paren
suffix:semicolon
r_static
r_int
id|etrax_usb_submit_urb
c_func
(paren
id|urb_t
op_star
id|urb
)paren
suffix:semicolon
r_static
r_int
id|etrax_usb_unlink_urb
c_func
(paren
id|urb_t
op_star
id|urb
)paren
suffix:semicolon
r_static
r_int
id|etrax_usb_get_frame_number
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
)paren
suffix:semicolon
r_static
r_int
id|etrax_usb_allocate_dev
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
)paren
suffix:semicolon
r_static
r_int
id|etrax_usb_deallocate_dev
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
)paren
suffix:semicolon
r_static
r_void
id|etrax_usb_tx_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|vhc
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|etrax_usb_rx_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|vhc
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|etrax_usb_hc_intr_top_half
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|vhc
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|etrax_rh_submit_urb
(paren
id|urb_t
op_star
id|urb
)paren
suffix:semicolon
r_static
r_int
id|etrax_usb_hc_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|etrax_usb_hc_cleanup
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|variable|etrax_usb_device_operations
r_static
r_struct
id|usb_operations
id|etrax_usb_device_operations
op_assign
(brace
id|etrax_usb_allocate_dev
comma
id|etrax_usb_deallocate_dev
comma
id|etrax_usb_get_frame_number
comma
id|etrax_usb_submit_urb
comma
id|etrax_usb_unlink_urb
)brace
suffix:semicolon
macro_line|#ifdef USB_DEBUG_DESC
DECL|function|dump_urb
r_static
r_void
id|dump_urb
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;nurb                   :0x%08X&bslash;n&quot;
comma
id|urb
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;next                  :0x%08X&bslash;n&quot;
comma
id|urb-&gt;next
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;dev                   :0x%08X&bslash;n&quot;
comma
id|urb-&gt;dev
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;pipe                  :0x%08X&bslash;n&quot;
comma
id|urb-&gt;pipe
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;status                :%d&bslash;n&quot;
comma
id|urb-&gt;status
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;transfer_flags        :0x%08X&bslash;n&quot;
comma
id|urb-&gt;transfer_flags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;transfer_buffer       :0x%08X&bslash;n&quot;
comma
id|urb-&gt;transfer_buffer
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;transfer_buffer_length:%d&bslash;n&quot;
comma
id|urb-&gt;transfer_buffer_length
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;actual_length         :%d&bslash;n&quot;
comma
id|urb-&gt;actual_length
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;setup_packet          :0x%08X&bslash;n&quot;
comma
id|urb-&gt;setup_packet
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;start_frame           :%d&bslash;n&quot;
comma
id|urb-&gt;start_frame
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;number_of_packets     :%d&bslash;n&quot;
comma
id|urb-&gt;number_of_packets
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;interval              :%d&bslash;n&quot;
comma
id|urb-&gt;interval
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;error_count           :%d&bslash;n&quot;
comma
id|urb-&gt;error_count
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;context               :0x%08X&bslash;n&quot;
comma
id|urb-&gt;context
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;complete              :0x%08X&bslash;n&bslash;n&quot;
comma
id|urb-&gt;complete
)paren
suffix:semicolon
)brace
DECL|function|dump_in_desc
r_static
r_void
id|dump_in_desc
c_func
(paren
id|USB_IN_Desc_t
op_star
id|in
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;nUSB_IN_Desc at 0x%08X&bslash;n&quot;
comma
id|in
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  sw_len  : 0x%04X (%d)&bslash;n&quot;
comma
id|in-&gt;sw_len
comma
id|in-&gt;sw_len
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  command : 0x%04X&bslash;n&quot;
comma
id|in-&gt;command
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  next    : 0x%08X&bslash;n&quot;
comma
id|in-&gt;next
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  buf     : 0x%08X&bslash;n&quot;
comma
id|in-&gt;buf
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  hw_len  : 0x%04X (%d)&bslash;n&quot;
comma
id|in-&gt;hw_len
comma
id|in-&gt;hw_len
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  status  : 0x%04X&bslash;n&bslash;n&quot;
comma
id|in-&gt;status
)paren
suffix:semicolon
)brace
DECL|function|dump_sb_desc
r_static
r_void
id|dump_sb_desc
c_func
(paren
id|USB_SB_Desc_t
op_star
id|sb
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;nUSB_SB_Desc at 0x%08X&bslash;n&quot;
comma
id|sb
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  sw_len  : 0x%04X (%d)&bslash;n&quot;
comma
id|sb-&gt;sw_len
comma
id|sb-&gt;sw_len
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  command : 0x%04X&bslash;n&quot;
comma
id|sb-&gt;command
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  next    : 0x%08X&bslash;n&quot;
comma
id|sb-&gt;next
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  buf     : 0x%08X&bslash;n&bslash;n&quot;
comma
id|sb-&gt;buf
)paren
suffix:semicolon
)brace
DECL|function|dump_ep_desc
r_static
r_void
id|dump_ep_desc
c_func
(paren
id|USB_EP_Desc_t
op_star
id|ep
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;nUSB_EP_Desc at 0x%08X&bslash;n&quot;
comma
id|ep
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  hw_len  : 0x%04X (%d)&bslash;n&quot;
comma
id|ep-&gt;hw_len
comma
id|ep-&gt;hw_len
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  command : 0x%08X&bslash;n&quot;
comma
id|ep-&gt;command
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  sub     : 0x%08X&bslash;n&quot;
comma
id|ep-&gt;sub
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  nep     : 0x%08X&bslash;n&bslash;n&quot;
comma
id|ep-&gt;nep
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|macro|dump_urb
mdefine_line|#define dump_urb(...)     (NULL)
DECL|macro|dump_ep_desc
mdefine_line|#define dump_ep_desc(...) (NULL)
DECL|macro|dump_sb_desc
mdefine_line|#define dump_sb_desc(...) (NULL)
DECL|macro|dump_in_desc
mdefine_line|#define dump_in_desc(...) (NULL)
macro_line|#endif
DECL|function|init_rx_buffers
r_static
r_void
id|init_rx_buffers
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|DBFENTER
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|NBR_OF_RX_DESC
op_minus
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|RxDescList
(braket
id|i
)braket
dot
id|sw_len
op_assign
id|RX_DESC_BUF_SIZE
suffix:semicolon
id|RxDescList
(braket
id|i
)braket
dot
id|command
op_assign
l_int|0
suffix:semicolon
id|RxDescList
(braket
id|i
)braket
dot
id|next
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|RxDescList
(braket
id|i
op_plus
l_int|1
)braket
)paren
suffix:semicolon
id|RxDescList
(braket
id|i
)braket
dot
id|buf
op_assign
id|virt_to_phys
c_func
(paren
id|RxBuf
op_plus
(paren
id|i
op_star
id|RX_DESC_BUF_SIZE
)paren
)paren
suffix:semicolon
id|RxDescList
(braket
id|i
)braket
dot
id|hw_len
op_assign
l_int|0
suffix:semicolon
id|RxDescList
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
)brace
id|RxDescList
(braket
id|i
)braket
dot
id|sw_len
op_assign
id|RX_DESC_BUF_SIZE
suffix:semicolon
id|RxDescList
(braket
id|i
)braket
dot
id|command
op_assign
id|IO_STATE
c_func
(paren
id|USB_IN_command
comma
id|eol
comma
id|yes
)paren
suffix:semicolon
id|RxDescList
(braket
id|i
)braket
dot
id|next
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|RxDescList
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|RxDescList
(braket
id|i
)braket
dot
id|buf
op_assign
id|virt_to_phys
c_func
(paren
id|RxBuf
op_plus
(paren
id|i
op_star
id|RX_DESC_BUF_SIZE
)paren
)paren
suffix:semicolon
id|RxDescList
(braket
id|i
)braket
dot
id|hw_len
op_assign
l_int|0
suffix:semicolon
id|RxDescList
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
id|myNextRxDesc
op_assign
op_amp
id|RxDescList
(braket
l_int|0
)braket
suffix:semicolon
id|myLastRxDesc
op_assign
op_amp
id|RxDescList
(braket
id|NBR_OF_RX_DESC
op_minus
l_int|1
)braket
suffix:semicolon
id|myPrevRxDesc
op_assign
op_amp
id|RxDescList
(braket
id|NBR_OF_RX_DESC
op_minus
l_int|1
)braket
suffix:semicolon
op_star
id|R_DMA_CH9_FIRST
op_assign
id|virt_to_phys
c_func
(paren
id|myNextRxDesc
)paren
suffix:semicolon
op_star
id|R_DMA_CH9_CMD
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH9_CMD
comma
id|cmd
comma
id|start
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
)brace
DECL|function|init_tx_ctrl_ep
r_static
r_void
id|init_tx_ctrl_ep
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|DBFENTER
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|NBR_OF_EP_DESC
op_minus
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|TxCtrlEPList
(braket
id|i
)braket
dot
id|hw_len
op_assign
l_int|0
suffix:semicolon
id|TxCtrlEPList
(braket
id|i
)braket
dot
id|command
op_assign
id|IO_FIELD
c_func
(paren
id|USB_EP_command
comma
id|epid
comma
id|i
)paren
suffix:semicolon
id|TxCtrlEPList
(braket
id|i
)braket
dot
id|sub
op_assign
l_int|0
suffix:semicolon
id|TxCtrlEPList
(braket
id|i
)braket
dot
id|nep
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|TxCtrlEPList
(braket
id|i
op_plus
l_int|1
)braket
)paren
suffix:semicolon
)brace
id|TxCtrlEPList
(braket
id|i
)braket
dot
id|hw_len
op_assign
l_int|0
suffix:semicolon
id|TxCtrlEPList
(braket
id|i
)braket
dot
id|command
op_assign
id|IO_STATE
c_func
(paren
id|USB_EP_command
comma
id|eol
comma
id|yes
)paren
op_or
id|IO_FIELD
c_func
(paren
id|USB_EP_command
comma
id|epid
comma
id|i
)paren
suffix:semicolon
id|TxCtrlEPList
(braket
id|i
)braket
dot
id|sub
op_assign
l_int|0
suffix:semicolon
id|TxCtrlEPList
(braket
id|i
)braket
dot
id|nep
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|TxCtrlEPList
(braket
l_int|0
)braket
)paren
suffix:semicolon
op_star
id|R_DMA_CH8_SUB1_EP
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|TxCtrlEPList
(braket
l_int|0
)braket
)paren
suffix:semicolon
op_star
id|R_DMA_CH8_SUB1_CMD
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH8_SUB1_CMD
comma
id|cmd
comma
id|start
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
)brace
DECL|function|init_tx_bulk_ep
r_static
r_void
id|init_tx_bulk_ep
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|DBFENTER
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|NBR_OF_EP_DESC
op_minus
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|TxBulkEPList
(braket
id|i
)braket
dot
id|hw_len
op_assign
l_int|0
suffix:semicolon
id|TxBulkEPList
(braket
id|i
)braket
dot
id|command
op_assign
id|IO_FIELD
c_func
(paren
id|USB_EP_command
comma
id|epid
comma
id|i
)paren
suffix:semicolon
id|TxBulkEPList
(braket
id|i
)braket
dot
id|sub
op_assign
l_int|0
suffix:semicolon
id|TxBulkEPList
(braket
id|i
)braket
dot
id|nep
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|TxBulkEPList
(braket
id|i
op_plus
l_int|1
)braket
)paren
suffix:semicolon
)brace
id|TxBulkEPList
(braket
id|i
)braket
dot
id|hw_len
op_assign
l_int|0
suffix:semicolon
id|TxBulkEPList
(braket
id|i
)braket
dot
id|command
op_assign
id|IO_STATE
c_func
(paren
id|USB_EP_command
comma
id|eol
comma
id|yes
)paren
op_or
id|IO_FIELD
c_func
(paren
id|USB_EP_command
comma
id|epid
comma
id|i
)paren
suffix:semicolon
id|TxBulkEPList
(braket
id|i
)braket
dot
id|sub
op_assign
l_int|0
suffix:semicolon
id|TxBulkEPList
(braket
id|i
)braket
dot
id|nep
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|TxBulkEPList
(braket
l_int|0
)braket
)paren
suffix:semicolon
op_star
id|R_DMA_CH8_SUB0_EP
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|TxBulkEPList
(braket
l_int|0
)braket
)paren
suffix:semicolon
op_star
id|R_DMA_CH8_SUB0_CMD
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH8_SUB0_CMD
comma
id|cmd
comma
id|start
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
)brace
DECL|function|init_tx_intr_ep
r_static
r_void
id|init_tx_intr_ep
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|DBFENTER
suffix:semicolon
id|TxIntrSB_zout.sw_len
op_assign
l_int|0
suffix:semicolon
id|TxIntrSB_zout.next
op_assign
l_int|0
suffix:semicolon
id|TxIntrSB_zout.buf
op_assign
l_int|0
suffix:semicolon
id|TxIntrSB_zout.command
op_assign
id|IO_FIELD
c_func
(paren
id|USB_SB_command
comma
id|rem
comma
l_int|0
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|tt
comma
id|zout
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|full
comma
id|yes
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|eot
comma
id|yes
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|eol
comma
id|yes
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|MAX_INTR_INTERVAL
op_minus
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|TxIntrEPList
(braket
id|i
)braket
dot
id|hw_len
op_assign
l_int|0
suffix:semicolon
id|TxIntrEPList
(braket
id|i
)braket
dot
id|command
op_assign
id|IO_STATE
c_func
(paren
id|USB_EP_command
comma
id|eof
comma
id|yes
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_EP_command
comma
id|enable
comma
id|yes
)paren
op_or
id|IO_FIELD
c_func
(paren
id|USB_EP_command
comma
id|epid
comma
l_int|0
)paren
suffix:semicolon
id|TxIntrEPList
(braket
id|i
)braket
dot
id|sub
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|TxIntrSB_zout
)paren
suffix:semicolon
id|TxIntrEPList
(braket
id|i
)braket
dot
id|nep
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|TxIntrEPList
(braket
id|i
op_plus
l_int|1
)braket
)paren
suffix:semicolon
)brace
id|TxIntrEPList
(braket
id|i
)braket
dot
id|hw_len
op_assign
l_int|0
suffix:semicolon
id|TxIntrEPList
(braket
id|i
)braket
dot
id|command
op_assign
id|IO_STATE
c_func
(paren
id|USB_EP_command
comma
id|eof
comma
id|yes
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_EP_command
comma
id|enable
comma
id|yes
)paren
op_or
id|IO_FIELD
c_func
(paren
id|USB_EP_command
comma
id|epid
comma
l_int|0
)paren
suffix:semicolon
id|TxIntrEPList
(braket
id|i
)braket
dot
id|sub
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|TxIntrSB_zout
)paren
suffix:semicolon
id|TxIntrEPList
(braket
id|i
)braket
dot
id|nep
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|TxIntrEPList
(braket
l_int|0
)braket
)paren
suffix:semicolon
op_star
id|R_DMA_CH8_SUB2_EP
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|TxIntrEPList
(braket
l_int|0
)braket
)paren
suffix:semicolon
op_star
id|R_DMA_CH8_SUB2_CMD
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH8_SUB2_CMD
comma
id|cmd
comma
id|start
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
)brace
DECL|function|etrax_usb_unlink_intr_urb
r_static
r_int
id|etrax_usb_unlink_intr_urb
c_func
(paren
id|urb_t
op_star
id|urb
)paren
(brace
r_struct
id|usb_device
op_star
id|usb_dev
op_assign
id|urb-&gt;dev
suffix:semicolon
id|etrax_hc_t
op_star
id|hc
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
id|USB_EP_Desc_t
op_star
id|tmp_ep
suffix:semicolon
id|USB_EP_Desc_t
op_star
id|first_ep
suffix:semicolon
id|USB_EP_Desc_t
op_star
id|ep_desc
suffix:semicolon
id|USB_SB_Desc_t
op_star
id|sb_desc
suffix:semicolon
r_char
id|epid
suffix:semicolon
r_char
id|devnum
suffix:semicolon
r_char
id|endpoint
suffix:semicolon
r_char
id|slow
suffix:semicolon
r_int
id|maxlen
suffix:semicolon
r_int
id|i
suffix:semicolon
id|etrax_urb_priv_t
op_star
id|urb_priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DBFENTER
suffix:semicolon
id|devnum
op_assign
id|usb_pipedevice
c_func
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
id|endpoint
op_assign
id|usb_pipeendpoint
c_func
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
id|slow
op_assign
id|usb_pipeslow
c_func
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
id|maxlen
op_assign
id|usb_maxpacket
c_func
(paren
id|urb-&gt;dev
comma
id|urb-&gt;pipe
comma
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
id|epid
op_assign
id|etrax_usb_lookup_epid
c_func
(paren
id|devnum
comma
id|endpoint
comma
id|slow
comma
id|maxlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|epid
op_eq
op_minus
l_int|1
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Trying to unlink urb that is not in traffic queue!!&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* fix this */
)brace
op_star
id|R_DMA_CH8_SUB2_CMD
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH8_SUB2_CMD
comma
id|cmd
comma
id|stop
)paren
suffix:semicolon
multiline_comment|/* Somehow wait for the DMA to finish current activities */
id|i
op_assign
id|jiffies
op_plus
l_int|100
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
OL
id|i
)paren
suffix:semicolon
id|first_ep
op_assign
op_amp
id|TxIntrEPList
(braket
l_int|0
)braket
suffix:semicolon
id|tmp_ep
op_assign
id|first_ep
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|IO_EXTRACT
c_func
(paren
id|USB_EP_command
comma
id|epid
comma
(paren
(paren
id|USB_EP_Desc_t
op_star
)paren
id|phys_to_virt
c_func
(paren
id|tmp_ep-&gt;nep
)paren
)paren
op_member_access_from_pointer
id|command
)paren
op_eq
id|epid
)paren
(brace
multiline_comment|/* Unlink it !!! */
id|dbg_intr
c_func
(paren
l_string|&quot;Found urb to unlink for epid %d&quot;
comma
id|epid
)paren
suffix:semicolon
id|ep_desc
op_assign
id|phys_to_virt
c_func
(paren
id|tmp_ep-&gt;nep
)paren
suffix:semicolon
id|tmp_ep-&gt;nep
op_assign
id|ep_desc-&gt;nep
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|usb_desc_cache
comma
id|phys_to_virt
c_func
(paren
id|ep_desc-&gt;sub
)paren
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|usb_desc_cache
comma
id|ep_desc
)paren
suffix:semicolon
)brace
id|tmp_ep
op_assign
id|phys_to_virt
c_func
(paren
id|tmp_ep-&gt;nep
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|tmp_ep
op_ne
id|first_ep
)paren
suffix:semicolon
multiline_comment|/* We should really try to move the EP register to an EP that is not removed&n;&t;   instead of restarting, but this will work too */
op_star
id|R_DMA_CH8_SUB2_EP
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|TxIntrEPList
(braket
l_int|0
)braket
)paren
suffix:semicolon
op_star
id|R_DMA_CH8_SUB2_CMD
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH8_SUB2_CMD
comma
id|cmd
comma
id|start
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|epid
comma
(paren
r_void
op_star
)paren
op_amp
id|ep_really_active
)paren
suffix:semicolon
id|URB_List
(braket
id|epid
)braket
op_assign
l_int|NULL
suffix:semicolon
id|etrax_usb_free_epid
c_func
(paren
id|epid
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|etrax_usb_do_intr_recover
r_void
id|etrax_usb_do_intr_recover
c_func
(paren
r_int
id|epid
)paren
(brace
id|USB_EP_Desc_t
op_star
id|first_ep
comma
op_star
id|tmp_ep
suffix:semicolon
id|first_ep
op_assign
(paren
id|USB_EP_Desc_t
op_star
)paren
id|phys_to_virt
c_func
(paren
op_star
id|R_DMA_CH8_SUB2_EP
)paren
suffix:semicolon
id|tmp_ep
op_assign
id|first_ep
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|IO_EXTRACT
c_func
(paren
id|USB_EP_command
comma
id|epid
comma
id|tmp_ep-&gt;command
)paren
op_eq
id|epid
op_logical_and
op_logical_neg
(paren
id|tmp_ep-&gt;command
op_amp
id|IO_MASK
c_func
(paren
id|USB_EP_command
comma
id|enable
)paren
)paren
)paren
(brace
id|tmp_ep-&gt;command
op_or_assign
id|IO_STATE
c_func
(paren
id|USB_EP_command
comma
id|enable
comma
id|yes
)paren
suffix:semicolon
)brace
id|tmp_ep
op_assign
(paren
id|USB_EP_Desc_t
op_star
)paren
id|phys_to_virt
c_func
(paren
id|tmp_ep-&gt;nep
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|tmp_ep
op_ne
id|first_ep
)paren
suffix:semicolon
)brace
DECL|function|etrax_usb_submit_intr_urb
r_static
r_int
id|etrax_usb_submit_intr_urb
c_func
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|USB_EP_Desc_t
op_star
id|tmp_ep
suffix:semicolon
id|USB_EP_Desc_t
op_star
id|first_ep
suffix:semicolon
id|USB_SB_Desc_t
op_star
id|sb_desc
suffix:semicolon
r_char
id|epid
suffix:semicolon
r_char
id|devnum
suffix:semicolon
r_char
id|endpoint
suffix:semicolon
r_char
id|maxlen
suffix:semicolon
r_char
id|slow
suffix:semicolon
r_int
id|interval
suffix:semicolon
r_int
id|i
suffix:semicolon
id|etrax_urb_priv_t
op_star
id|urb_priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DBFENTER
suffix:semicolon
id|devnum
op_assign
id|usb_pipedevice
c_func
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
id|endpoint
op_assign
id|usb_pipeendpoint
c_func
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
id|maxlen
op_assign
id|usb_maxpacket
c_func
(paren
id|urb-&gt;dev
comma
id|urb-&gt;pipe
comma
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
id|slow
op_assign
id|usb_pipeslow
c_func
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
id|interval
op_assign
id|urb-&gt;interval
suffix:semicolon
id|dbg_intr
c_func
(paren
l_string|&quot;Intr traffic for dev %d, endpoint %d, maxlen %d, slow %d&quot;
comma
id|devnum
comma
id|endpoint
comma
id|maxlen
comma
id|slow
)paren
suffix:semicolon
id|epid
op_assign
id|etrax_usb_lookup_epid
c_func
(paren
id|devnum
comma
id|endpoint
comma
id|slow
comma
id|maxlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|epid
op_eq
op_minus
l_int|1
)paren
(brace
id|epid
op_assign
id|etrax_usb_allocate_epid
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|epid
op_eq
op_minus
l_int|1
)paren
(brace
multiline_comment|/* We&squot;re out of endpoints, return some error */
id|err
c_func
(paren
l_string|&quot;We&squot;re out of endpoints&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Now we have to fill in this ep */
id|etrax_usb_setup_epid
c_func
(paren
id|epid
comma
id|devnum
comma
id|endpoint
comma
id|maxlen
comma
id|slow
)paren
suffix:semicolon
)brace
multiline_comment|/* Ok, now we got valid endpoint, lets insert some traffic */
id|urb_priv
op_assign
(paren
id|etrax_urb_priv_t
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|etrax_urb_priv_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|urb_priv-&gt;first_sb
op_assign
l_int|0
suffix:semicolon
id|urb_priv-&gt;rx_offset
op_assign
l_int|0
suffix:semicolon
id|urb_priv-&gt;eot
op_assign
l_int|0
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|urb_priv-&gt;ep_in_list
)paren
suffix:semicolon
id|urb-&gt;hcpriv
op_assign
id|urb_priv
suffix:semicolon
multiline_comment|/* This is safe since there cannot be any other URB&squot;s for this epid */
id|URB_List
(braket
id|epid
)braket
op_assign
id|urb
suffix:semicolon
macro_line|#if 0
id|first_ep
op_assign
(paren
id|USB_EP_Desc_t
op_star
)paren
id|phys_to_virt
c_func
(paren
op_star
id|R_DMA_CH8_SUB2_EP
)paren
suffix:semicolon
macro_line|#else
id|first_ep
op_assign
op_amp
id|TxIntrEPList
(braket
l_int|0
)braket
suffix:semicolon
macro_line|#endif
multiline_comment|/* Round of the interval to 2^n, it is obvious that this code favours&n;&t;   smaller numbers, but that is actually a good thing */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|interval
suffix:semicolon
id|i
op_increment
)paren
(brace
id|interval
op_assign
id|interval
op_rshift
l_int|1
suffix:semicolon
)brace
id|urb-&gt;interval
op_assign
id|interval
op_assign
l_int|1
op_lshift
(paren
id|i
op_minus
l_int|1
)paren
suffix:semicolon
id|dbg_intr
c_func
(paren
l_string|&quot;Interval rounded to %d&quot;
comma
id|interval
)paren
suffix:semicolon
id|tmp_ep
op_assign
id|first_ep
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|tmp_ep-&gt;command
op_amp
id|IO_MASK
c_func
(paren
id|USB_EP_command
comma
id|eof
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_mod
id|interval
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Insert the traffic ep after tmp_ep */
id|USB_EP_Desc_t
op_star
id|traffic_ep
suffix:semicolon
id|USB_SB_Desc_t
op_star
id|traffic_sb
suffix:semicolon
id|traffic_ep
op_assign
(paren
id|USB_EP_Desc_t
op_star
)paren
id|kmem_cache_alloc
c_func
(paren
id|usb_desc_cache
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|traffic_sb
op_assign
(paren
id|USB_SB_Desc_t
op_star
)paren
id|kmem_cache_alloc
c_func
(paren
id|usb_desc_cache
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|traffic_ep-&gt;hw_len
op_assign
l_int|0
suffix:semicolon
id|traffic_ep-&gt;command
op_assign
id|IO_FIELD
c_func
(paren
id|USB_EP_command
comma
id|epid
comma
id|epid
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_EP_command
comma
id|enable
comma
id|yes
)paren
suffix:semicolon
id|traffic_ep-&gt;sub
op_assign
id|virt_to_phys
c_func
(paren
id|traffic_sb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipein
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
id|traffic_sb-&gt;sw_len
op_assign
id|urb-&gt;transfer_buffer_length
ques
c_cond
(paren
id|urb-&gt;transfer_buffer_length
op_minus
l_int|1
)paren
op_div
id|maxlen
op_plus
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|traffic_sb-&gt;next
op_assign
l_int|0
suffix:semicolon
id|traffic_sb-&gt;buf
op_assign
l_int|0
suffix:semicolon
id|traffic_sb-&gt;command
op_assign
id|IO_FIELD
c_func
(paren
id|USB_SB_command
comma
id|rem
comma
id|urb-&gt;transfer_buffer_length
op_mod
id|maxlen
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|tt
comma
id|in
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|eot
comma
id|yes
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|eol
comma
id|yes
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
id|traffic_sb-&gt;sw_len
op_assign
id|urb-&gt;transfer_buffer_length
suffix:semicolon
id|traffic_sb-&gt;next
op_assign
l_int|0
suffix:semicolon
id|traffic_sb-&gt;buf
op_assign
id|virt_to_phys
c_func
(paren
id|urb-&gt;transfer_buffer
)paren
suffix:semicolon
id|traffic_sb-&gt;command
op_assign
id|IO_FIELD
c_func
(paren
id|USB_SB_command
comma
id|rem
comma
l_int|0
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|tt
comma
id|out
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|eot
comma
id|yes
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|eol
comma
id|yes
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|full
comma
id|yes
)paren
suffix:semicolon
)brace
id|traffic_ep-&gt;nep
op_assign
id|tmp_ep-&gt;nep
suffix:semicolon
id|tmp_ep-&gt;nep
op_assign
id|virt_to_phys
c_func
(paren
id|traffic_ep
)paren
suffix:semicolon
id|dbg_intr
c_func
(paren
l_string|&quot;One ep sucessfully inserted&quot;
)paren
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
)brace
id|tmp_ep
op_assign
(paren
id|USB_EP_Desc_t
op_star
)paren
id|phys_to_virt
c_func
(paren
id|tmp_ep-&gt;nep
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|tmp_ep
op_ne
id|first_ep
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|epid
comma
(paren
r_void
op_star
)paren
op_amp
id|ep_really_active
)paren
suffix:semicolon
op_star
id|R_DMA_CH8_SUB2_CMD
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH8_SUB2_CMD
comma
id|cmd
comma
id|start
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|handle_intr_transfer_attn
r_static
r_int
id|handle_intr_transfer_attn
c_func
(paren
r_char
id|epid
comma
r_int
id|status
)paren
(brace
id|urb_t
op_star
id|old_urb
suffix:semicolon
id|DBFENTER
suffix:semicolon
id|old_urb
op_assign
id|URB_List
(braket
id|epid
)braket
suffix:semicolon
multiline_comment|/* if (status == 0 &amp;&amp; IN) find data and copy to urb */
r_if
c_cond
(paren
id|status
op_eq
l_int|0
op_logical_and
id|usb_pipein
c_func
(paren
id|old_urb-&gt;pipe
)paren
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|etrax_urb_priv_t
op_star
id|urb_priv
suffix:semicolon
r_struct
id|list_head
op_star
id|entry
suffix:semicolon
r_struct
id|in_chunk
op_star
id|in
suffix:semicolon
id|urb_priv
op_assign
(paren
id|etrax_urb_priv_t
op_star
)paren
id|old_urb-&gt;hcpriv
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|entry
comma
op_amp
id|urb_priv-&gt;ep_in_list
)paren
(brace
id|in
op_assign
id|list_entry
c_func
(paren
id|entry
comma
r_struct
id|in_chunk
comma
id|list
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|old_urb-&gt;transfer_buffer
comma
id|in-&gt;data
comma
id|in-&gt;length
)paren
suffix:semicolon
id|old_urb-&gt;actual_length
op_assign
id|in-&gt;length
suffix:semicolon
id|old_urb-&gt;status
op_assign
id|status
suffix:semicolon
r_if
c_cond
(paren
id|old_urb-&gt;complete
)paren
(brace
id|old_urb
op_member_access_from_pointer
id|complete
c_func
(paren
id|old_urb
)paren
suffix:semicolon
)brace
id|list_del
c_func
(paren
id|entry
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|in-&gt;data
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|in
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_ne
l_int|0
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;Some sort of error for INTR EP !!!!&quot;
)paren
suffix:semicolon
macro_line|#ifdef ETRAX_USB_INTR_ERROR_FATAL
multiline_comment|/* This means that an INTR error is fatal for that endpoint */
id|etrax_usb_unlink_intr_urb
c_func
(paren
id|old_urb
)paren
suffix:semicolon
id|old_urb-&gt;status
op_assign
id|status
suffix:semicolon
r_if
c_cond
(paren
id|old_urb-&gt;complete
)paren
(brace
id|old_urb
op_member_access_from_pointer
id|complete
c_func
(paren
id|old_urb
)paren
suffix:semicolon
)brace
macro_line|#else
multiline_comment|/* In this case we reenable the disabled endpoint(s) */
id|etrax_usb_do_intr_recover
c_func
(paren
id|epid
)paren
suffix:semicolon
macro_line|#endif&t;
)brace
id|DBFEXIT
suffix:semicolon
)brace
DECL|function|etrax_rh_unlink_urb
r_static
r_int
id|etrax_rh_unlink_urb
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|etrax_hc_t
op_star
id|hc
suffix:semicolon
id|DBFENTER
suffix:semicolon
id|hc
op_assign
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
id|hc-&gt;rh.urb
op_eq
id|urb
)paren
(brace
id|hc-&gt;rh.send
op_assign
l_int|0
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|hc-&gt;rh.rh_int_timer
)paren
suffix:semicolon
)brace
id|DBFEXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|etrax_rh_send_irq
r_static
r_void
id|etrax_rh_send_irq
c_func
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|__u16
id|data
op_assign
l_int|0
suffix:semicolon
id|etrax_hc_t
op_star
id|hc
op_assign
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
singleline_comment|//&t;static prev_wPortStatus_1 = 0;
singleline_comment|//&t;static prev_wPortStatus_2 = 0;
multiline_comment|/*&t;DBFENTER; */
multiline_comment|/*&n;  dbg_rh(&quot;R_USB_FM_NUMBER   : 0x%08X&quot;, *R_USB_FM_NUMBER);&n;  dbg_rh(&quot;R_USB_FM_REMAINING: 0x%08X&quot;, *R_USB_FM_REMAINING);&n;*/
id|data
op_or_assign
(paren
id|hc-&gt;rh.wPortChange_1
)paren
ques
c_cond
(paren
l_int|1
op_lshift
l_int|1
)paren
suffix:colon
l_int|0
suffix:semicolon
id|data
op_or_assign
(paren
id|hc-&gt;rh.wPortChange_2
)paren
ques
c_cond
(paren
l_int|1
op_lshift
l_int|2
)paren
suffix:colon
l_int|0
suffix:semicolon
op_star
(paren
(paren
id|__u16
op_star
)paren
id|urb-&gt;transfer_buffer
)paren
op_assign
id|cpu_to_le16
c_func
(paren
id|data
)paren
suffix:semicolon
id|urb-&gt;actual_length
op_assign
l_int|1
suffix:semicolon
id|urb-&gt;status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|data
op_logical_and
id|hc-&gt;rh.send
op_logical_and
id|urb-&gt;complete
)paren
(brace
id|dbg_rh
c_func
(paren
l_string|&quot;wPortChange_1: 0x%04X&quot;
comma
id|hc-&gt;rh.wPortChange_1
)paren
suffix:semicolon
id|dbg_rh
c_func
(paren
l_string|&quot;wPortChange_2: 0x%04X&quot;
comma
id|hc-&gt;rh.wPortChange_2
)paren
suffix:semicolon
id|urb
op_member_access_from_pointer
id|complete
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
multiline_comment|/*&t;DBFEXIT; */
)brace
DECL|function|etrax_rh_init_int_timer
r_static
r_void
id|etrax_rh_init_int_timer
c_func
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|etrax_hc_t
op_star
id|hc
suffix:semicolon
multiline_comment|/*&t;DBFENTER; */
id|hc
op_assign
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
id|hc-&gt;rh.interval
op_assign
id|urb-&gt;interval
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|hc-&gt;rh.rh_int_timer
)paren
suffix:semicolon
id|hc-&gt;rh.rh_int_timer.function
op_assign
id|etrax_rh_int_timer_do
suffix:semicolon
id|hc-&gt;rh.rh_int_timer.data
op_assign
(paren
r_int
r_int
)paren
id|urb
suffix:semicolon
id|hc-&gt;rh.rh_int_timer.expires
op_assign
id|jiffies
op_plus
(paren
(paren
id|HZ
op_star
id|hc-&gt;rh.interval
)paren
op_div
l_int|1000
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|hc-&gt;rh.rh_int_timer
)paren
suffix:semicolon
multiline_comment|/*&t;DBFEXIT; */
)brace
DECL|function|etrax_rh_int_timer_do
r_static
r_void
id|etrax_rh_int_timer_do
c_func
(paren
r_int
r_int
id|ptr
)paren
(brace
id|urb_t
op_star
id|urb
suffix:semicolon
id|etrax_hc_t
op_star
id|hc
suffix:semicolon
multiline_comment|/*&t;DBFENTER; */
id|urb
op_assign
(paren
id|urb_t
op_star
)paren
id|ptr
suffix:semicolon
id|hc
op_assign
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
id|hc-&gt;rh.send
)paren
(brace
id|etrax_rh_send_irq
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
id|etrax_rh_init_int_timer
c_func
(paren
id|urb
)paren
suffix:semicolon
multiline_comment|/*&t;DBFEXIT; */
)brace
DECL|function|etrax_usb_setup_epid
r_static
r_void
id|etrax_usb_setup_epid
c_func
(paren
r_char
id|epid
comma
r_char
id|devnum
comma
r_char
id|endpoint
comma
r_char
id|packsize
comma
r_char
id|slow
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|DBFENTER
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|epid
comma
(paren
r_void
op_star
)paren
op_amp
id|ep_usage_bitmask
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|warn
c_func
(paren
l_string|&quot;Trying to setup used epid %d&quot;
comma
id|epid
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
r_return
suffix:semicolon
)brace
id|set_bit
c_func
(paren
id|epid
comma
(paren
r_void
op_star
)paren
op_amp
id|ep_usage_bitmask
)paren
suffix:semicolon
id|dbg_ep
c_func
(paren
l_string|&quot;Setting up ep_id %d with devnum %d, endpoint %d and max_len %d&quot;
comma
id|epid
comma
id|devnum
comma
id|endpoint
comma
id|packsize
)paren
suffix:semicolon
op_star
id|R_USB_EPT_INDEX
op_assign
id|IO_FIELD
c_func
(paren
id|R_USB_EPT_INDEX
comma
id|value
comma
id|epid
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
op_star
id|R_USB_EPT_DATA
op_assign
id|IO_STATE
c_func
(paren
id|R_USB_EPT_DATA
comma
id|valid
comma
id|yes
)paren
op_or
id|IO_FIELD
c_func
(paren
id|R_USB_EPT_DATA
comma
id|ep
comma
id|endpoint
)paren
op_or
id|IO_FIELD
c_func
(paren
id|R_USB_EPT_DATA
comma
id|dev
comma
id|devnum
)paren
op_or
id|IO_FIELD
c_func
(paren
id|R_USB_EPT_DATA
comma
id|max_len
comma
id|packsize
)paren
op_or
id|IO_FIELD
c_func
(paren
id|R_USB_EPT_DATA
comma
id|low_speed
comma
id|slow
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
)brace
DECL|function|etrax_usb_free_epid
r_static
r_void
id|etrax_usb_free_epid
c_func
(paren
r_char
id|epid
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|DBFENTER
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|epid
comma
(paren
r_void
op_star
)paren
op_amp
id|ep_usage_bitmask
)paren
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;Trying to free unused epid %d&quot;
comma
id|epid
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
r_return
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
op_star
id|R_USB_EPT_INDEX
op_assign
id|IO_FIELD
c_func
(paren
id|R_USB_EPT_INDEX
comma
id|value
comma
id|epid
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|R_USB_EPT_DATA
op_amp
id|IO_MASK
c_func
(paren
id|R_USB_EPT_DATA
comma
id|hold
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;+&quot;
)paren
suffix:semicolon
op_star
id|R_USB_EPT_DATA
op_assign
l_int|0
suffix:semicolon
id|clear_bit
c_func
(paren
id|epid
comma
(paren
r_void
op_star
)paren
op_amp
id|ep_usage_bitmask
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|dbg_ep
c_func
(paren
l_string|&quot;epid: %d freed&quot;
comma
id|epid
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
)brace
DECL|function|etrax_usb_lookup_epid
r_static
r_int
id|etrax_usb_lookup_epid
c_func
(paren
r_int
r_char
id|devnum
comma
r_char
id|endpoint
comma
r_char
id|slow
comma
r_int
id|maxp
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|__u32
id|data
suffix:semicolon
id|DBFENTER
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Skip first ep_id since it is reserved when intr. or iso traffic is used */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NBR_OF_EP_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|i
comma
(paren
r_void
op_star
)paren
op_amp
id|ep_usage_bitmask
)paren
)paren
(brace
op_star
id|R_USB_EPT_INDEX
op_assign
id|IO_FIELD
c_func
(paren
id|R_USB_EPT_INDEX
comma
id|value
comma
id|i
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|data
op_assign
op_star
id|R_USB_EPT_DATA
suffix:semicolon
r_if
c_cond
(paren
(paren
id|IO_MASK
c_func
(paren
id|R_USB_EPT_DATA
comma
id|valid
)paren
op_amp
id|data
)paren
op_logical_and
(paren
id|IO_EXTRACT
c_func
(paren
id|R_USB_EPT_DATA
comma
id|dev
comma
id|data
)paren
op_eq
id|devnum
)paren
op_logical_and
(paren
id|IO_EXTRACT
c_func
(paren
id|R_USB_EPT_DATA
comma
id|ep
comma
id|data
)paren
op_eq
id|endpoint
)paren
op_logical_and
(paren
id|IO_EXTRACT
c_func
(paren
id|R_USB_EPT_DATA
comma
id|low_speed
comma
id|data
)paren
op_eq
id|slow
)paren
op_logical_and
(paren
id|IO_EXTRACT
c_func
(paren
id|R_USB_EPT_DATA
comma
id|max_len
comma
id|data
)paren
op_eq
id|maxp
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|dbg_ep
c_func
(paren
l_string|&quot;Found ep_id %d for devnum %d, endpoint %d&quot;
comma
id|i
comma
id|devnum
comma
id|endpoint
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|dbg_ep
c_func
(paren
l_string|&quot;Found no ep_id for devnum %d, endpoint %d&quot;
comma
id|devnum
comma
id|endpoint
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|etrax_usb_allocate_epid
r_static
r_int
id|etrax_usb_allocate_epid
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|DBFENTER
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NBR_OF_EP_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|i
comma
(paren
r_void
op_star
)paren
op_amp
id|ep_usage_bitmask
)paren
)paren
(brace
id|dbg_ep
c_func
(paren
l_string|&quot;Found free ep_id at %d&quot;
comma
id|i
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
)brace
id|dbg_ep
c_func
(paren
l_string|&quot;Found no free ep_id&squot;s&quot;
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|etrax_usb_submit_bulk_urb
r_static
r_int
id|etrax_usb_submit_bulk_urb
c_func
(paren
id|urb_t
op_star
id|urb
)paren
(brace
r_char
id|epid
suffix:semicolon
r_char
id|devnum
suffix:semicolon
r_char
id|endpoint
suffix:semicolon
r_char
id|maxlen
suffix:semicolon
r_char
id|slow
suffix:semicolon
id|urb_t
op_star
id|tmp_urb
suffix:semicolon
id|etrax_urb_priv_t
op_star
id|urb_priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DBFENTER
suffix:semicolon
id|devnum
op_assign
id|usb_pipedevice
c_func
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
id|endpoint
op_assign
id|usb_pipeendpoint
c_func
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
id|maxlen
op_assign
id|usb_maxpacket
c_func
(paren
id|urb-&gt;dev
comma
id|urb-&gt;pipe
comma
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
id|slow
op_assign
id|usb_pipeslow
c_func
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
id|epid
op_assign
id|etrax_usb_lookup_epid
c_func
(paren
id|devnum
comma
id|endpoint
comma
id|slow
comma
id|maxlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|epid
op_eq
op_minus
l_int|1
)paren
(brace
id|epid
op_assign
id|etrax_usb_allocate_epid
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|epid
op_eq
op_minus
l_int|1
)paren
(brace
multiline_comment|/* We&squot;re out of endpoints, return some error */
id|err
c_func
(paren
l_string|&quot;We&squot;re out of endpoints&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Now we have to fill in this ep */
id|etrax_usb_setup_epid
c_func
(paren
id|epid
comma
id|devnum
comma
id|endpoint
comma
id|maxlen
comma
id|slow
)paren
suffix:semicolon
)brace
multiline_comment|/* Ok, now we got valid endpoint, lets insert some traffic */
id|urb-&gt;status
op_assign
op_minus
id|EINPROGRESS
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|URB_List
(braket
id|epid
)braket
)paren
(brace
multiline_comment|/* Find end of list and add */
r_for
c_loop
(paren
id|tmp_urb
op_assign
id|URB_List
(braket
id|epid
)braket
suffix:semicolon
id|tmp_urb-&gt;next
suffix:semicolon
id|tmp_urb
op_assign
id|tmp_urb-&gt;next
)paren
id|dump_urb
c_func
(paren
id|tmp_urb
)paren
suffix:semicolon
id|tmp_urb-&gt;next
op_assign
id|urb
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* If this is the first URB, add the URB and do HW add */
id|URB_List
(braket
id|epid
)braket
op_assign
id|urb
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|etrax_usb_do_bulk_hw_add
c_func
(paren
id|urb
comma
id|epid
comma
id|maxlen
)paren
suffix:semicolon
)brace
id|DBFEXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|etrax_usb_do_bulk_hw_add
r_static
r_int
id|etrax_usb_do_bulk_hw_add
c_func
(paren
id|urb_t
op_star
id|urb
comma
r_char
id|epid
comma
r_char
id|maxlen
)paren
(brace
id|USB_SB_Desc_t
op_star
id|sb_desc_1
suffix:semicolon
id|etrax_urb_priv_t
op_star
id|urb_priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|__u32
id|r_usb_ept_data
suffix:semicolon
id|DBFENTER
suffix:semicolon
id|urb_priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|etrax_urb_priv_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|sb_desc_1
op_assign
(paren
id|USB_SB_Desc_t
op_star
)paren
id|kmem_cache_alloc
c_func
(paren
id|usb_desc_cache
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
id|dbg_bulk
c_func
(paren
l_string|&quot;Bulk transfer for epid %d is OUT&quot;
comma
id|epid
)paren
suffix:semicolon
id|dbg_bulk
c_func
(paren
l_string|&quot;transfer_buffer_length == %d&quot;
comma
id|urb-&gt;transfer_buffer_length
)paren
suffix:semicolon
id|dbg_bulk
c_func
(paren
l_string|&quot;actual_length == %d&quot;
comma
id|urb-&gt;actual_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;transfer_buffer_length
OG
l_int|0xffff
)paren
(brace
id|panic
c_func
(paren
id|__FILE__
id|__FUNCTION__
l_string|&quot;:urb-&gt;transfer_buffer_length &gt; 0xffff&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|sb_desc_1-&gt;sw_len
op_assign
id|urb-&gt;transfer_buffer_length
suffix:semicolon
multiline_comment|/* was actual_length */
id|sb_desc_1-&gt;command
op_assign
id|IO_FIELD
c_func
(paren
id|USB_SB_command
comma
id|rem
comma
l_int|0
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|tt
comma
id|out
)paren
op_or
macro_line|#if 0
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|full
comma
id|no
)paren
op_or
macro_line|#else
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|full
comma
id|yes
)paren
op_or
macro_line|#endif
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|eot
comma
id|yes
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|eol
comma
id|yes
)paren
suffix:semicolon
id|dbg_bulk
c_func
(paren
l_string|&quot;transfer_buffer is at 0x%08X&quot;
comma
id|urb-&gt;transfer_buffer
)paren
suffix:semicolon
id|sb_desc_1-&gt;buf
op_assign
id|virt_to_phys
c_func
(paren
id|urb-&gt;transfer_buffer
)paren
suffix:semicolon
id|sb_desc_1-&gt;next
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|usb_pipein
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
id|dbg_bulk
c_func
(paren
l_string|&quot;Transfer for epid %d is IN&quot;
comma
id|epid
)paren
suffix:semicolon
id|dbg_bulk
c_func
(paren
l_string|&quot;transfer_buffer_length = %d&quot;
comma
id|urb-&gt;transfer_buffer_length
)paren
suffix:semicolon
id|dbg_bulk
c_func
(paren
l_string|&quot;rem is calculated to %d&quot;
comma
id|urb-&gt;transfer_buffer_length
op_mod
id|maxlen
)paren
suffix:semicolon
id|sb_desc_1-&gt;sw_len
op_assign
id|urb-&gt;transfer_buffer_length
ques
c_cond
(paren
id|urb-&gt;transfer_buffer_length
op_minus
l_int|1
)paren
op_div
id|maxlen
op_plus
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|dbg_bulk
c_func
(paren
l_string|&quot;sw_len got %d&quot;
comma
id|sb_desc_1-&gt;sw_len
)paren
suffix:semicolon
id|dbg_bulk
c_func
(paren
l_string|&quot;transfer_buffer is at 0x%08X&quot;
comma
id|urb-&gt;transfer_buffer
)paren
suffix:semicolon
id|sb_desc_1-&gt;command
op_assign
id|IO_FIELD
c_func
(paren
id|USB_SB_command
comma
id|rem
comma
id|urb-&gt;transfer_buffer_length
op_mod
id|maxlen
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|tt
comma
id|in
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|eot
comma
id|yes
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|eol
comma
id|yes
)paren
suffix:semicolon
id|sb_desc_1-&gt;buf
op_assign
l_int|0
suffix:semicolon
id|sb_desc_1-&gt;next
op_assign
l_int|0
suffix:semicolon
id|urb_priv-&gt;rx_offset
op_assign
l_int|0
suffix:semicolon
id|urb_priv-&gt;eot
op_assign
l_int|0
suffix:semicolon
)brace
id|urb_priv-&gt;first_sb
op_assign
id|sb_desc_1
suffix:semicolon
id|urb-&gt;hcpriv
op_assign
(paren
r_void
op_star
)paren
id|urb_priv
suffix:semicolon
multiline_comment|/* Reset toggle bits and reset error count, remeber to di and ei */
multiline_comment|/* Warning: it is possible that this locking doesn&squot;t work with bottom-halves */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
op_star
id|R_USB_EPT_INDEX
op_assign
id|IO_FIELD
c_func
(paren
id|R_USB_EPT_INDEX
comma
id|value
comma
id|epid
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|R_USB_EPT_DATA
op_amp
id|IO_MASK
c_func
(paren
id|R_USB_EPT_DATA
comma
id|hold
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Hold was set in %s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
op_star
id|R_USB_EPT_DATA
op_and_assign
op_complement
(paren
id|IO_MASK
c_func
(paren
id|R_USB_EPT_DATA
comma
id|error_count_in
)paren
op_or
id|IO_MASK
c_func
(paren
id|R_USB_EPT_DATA
comma
id|error_count_out
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
r_char
id|toggle
op_assign
id|usb_gettoggle
c_func
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
c_func
(paren
id|urb-&gt;pipe
)paren
comma
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
op_star
id|R_USB_EPT_DATA
op_and_assign
op_complement
id|IO_MASK
c_func
(paren
id|R_USB_EPT_DATA
comma
id|t_out
)paren
suffix:semicolon
op_star
id|R_USB_EPT_DATA
op_or_assign
id|IO_FIELD
c_func
(paren
id|R_USB_EPT_DATA
comma
id|t_out
comma
id|toggle
)paren
suffix:semicolon
)brace
r_else
(brace
r_char
id|toggle
op_assign
id|usb_gettoggle
c_func
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
c_func
(paren
id|urb-&gt;pipe
)paren
comma
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
op_star
id|R_USB_EPT_DATA
op_and_assign
op_complement
id|IO_MASK
c_func
(paren
id|R_USB_EPT_DATA
comma
id|t_in
)paren
suffix:semicolon
op_star
id|R_USB_EPT_DATA
op_or_assign
id|IO_FIELD
c_func
(paren
id|R_USB_EPT_DATA
comma
id|t_in
comma
id|toggle
)paren
suffix:semicolon
)brace
multiline_comment|/* Enable the EP descr. */
id|set_bit
c_func
(paren
id|epid
comma
(paren
r_void
op_star
)paren
op_amp
id|ep_really_active
)paren
suffix:semicolon
id|TxBulkEPList
(braket
id|epid
)braket
dot
id|sub
op_assign
id|virt_to_phys
c_func
(paren
id|sb_desc_1
)paren
suffix:semicolon
id|TxBulkEPList
(braket
id|epid
)braket
dot
id|hw_len
op_assign
l_int|0
suffix:semicolon
id|TxBulkEPList
(braket
id|epid
)braket
dot
id|command
op_or_assign
id|IO_STATE
c_func
(paren
id|USB_EP_command
comma
id|enable
comma
id|yes
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|R_DMA_CH8_SUB0_CMD
op_amp
id|IO_MASK
c_func
(paren
id|R_DMA_CH8_SUB0_CMD
comma
id|cmd
)paren
)paren
)paren
(brace
op_star
id|R_DMA_CH8_SUB0_CMD
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH8_SUB0_CMD
comma
id|cmd
comma
id|start
)paren
suffix:semicolon
)brace
id|DBFEXIT
suffix:semicolon
)brace
DECL|function|handle_bulk_transfer_attn
r_static
r_int
id|handle_bulk_transfer_attn
c_func
(paren
r_char
id|epid
comma
r_int
id|status
)paren
(brace
id|urb_t
op_star
id|old_urb
suffix:semicolon
id|etrax_urb_priv_t
op_star
id|hc_priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DBFENTER
suffix:semicolon
id|clear_bit
c_func
(paren
id|epid
comma
(paren
r_void
op_star
)paren
op_amp
id|ep_really_active
)paren
suffix:semicolon
id|old_urb
op_assign
id|URB_List
(braket
id|epid
)braket
suffix:semicolon
id|URB_List
(braket
id|epid
)braket
op_assign
id|old_urb-&gt;next
suffix:semicolon
multiline_comment|/* if (status == 0 &amp;&amp; IN) find data and copy to urb */
r_if
c_cond
(paren
id|status
op_eq
l_int|0
op_logical_and
id|usb_pipein
c_func
(paren
id|old_urb-&gt;pipe
)paren
)paren
(brace
id|etrax_urb_priv_t
op_star
id|urb_priv
suffix:semicolon
id|urb_priv
op_assign
(paren
id|etrax_urb_priv_t
op_star
)paren
id|old_urb-&gt;hcpriv
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb_priv-&gt;eot
op_eq
l_int|1
)paren
(brace
id|old_urb-&gt;actual_length
op_assign
id|urb_priv-&gt;rx_offset
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|urb_priv-&gt;rx_offset
op_eq
l_int|0
)paren
(brace
id|status
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
op_minus
id|EPROTO
suffix:semicolon
)brace
id|old_urb-&gt;actual_length
op_assign
l_int|0
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;(BULK) No eot set in IN data!!! rx_offset is: %d&quot;
comma
id|urb_priv-&gt;rx_offset
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
op_star
id|R_USB_EPT_INDEX
op_assign
id|IO_FIELD
c_func
(paren
id|R_USB_EPT_INDEX
comma
id|value
comma
id|epid
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipeout
c_func
(paren
id|old_urb-&gt;pipe
)paren
)paren
(brace
r_char
id|toggle
op_assign
id|IO_EXTRACT
c_func
(paren
id|R_USB_EPT_DATA
comma
id|t_out
comma
op_star
id|R_USB_EPT_DATA
)paren
suffix:semicolon
id|usb_settoggle
c_func
(paren
id|old_urb-&gt;dev
comma
id|usb_pipeendpoint
c_func
(paren
id|old_urb-&gt;pipe
)paren
comma
id|usb_pipeout
c_func
(paren
id|old_urb-&gt;pipe
)paren
comma
id|toggle
)paren
suffix:semicolon
)brace
r_else
(brace
r_char
id|toggle
op_assign
id|IO_EXTRACT
c_func
(paren
id|R_USB_EPT_DATA
comma
id|t_in
comma
op_star
id|R_USB_EPT_DATA
)paren
suffix:semicolon
id|usb_settoggle
c_func
(paren
id|old_urb-&gt;dev
comma
id|usb_pipeendpoint
c_func
(paren
id|old_urb-&gt;pipe
)paren
comma
id|usb_pipeout
c_func
(paren
id|old_urb-&gt;pipe
)paren
comma
id|toggle
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* If there are any more URB&squot;s in the list we&squot;d better start sending */
r_if
c_cond
(paren
id|URB_List
(braket
id|epid
)braket
)paren
(brace
id|etrax_usb_do_bulk_hw_add
c_func
(paren
id|URB_List
(braket
id|epid
)braket
comma
id|epid
comma
id|usb_maxpacket
c_func
(paren
id|URB_List
(braket
id|epid
)braket
op_member_access_from_pointer
id|dev
comma
id|URB_List
(braket
id|epid
)braket
op_member_access_from_pointer
id|pipe
comma
id|usb_pipeout
c_func
(paren
id|URB_List
(braket
id|epid
)braket
op_member_access_from_pointer
id|pipe
)paren
)paren
)paren
suffix:semicolon
)brace
macro_line|#if 1
r_else
(brace
multiline_comment|/* This means that this EP is now free, deconfigure it */
id|etrax_usb_free_epid
c_func
(paren
id|epid
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Remember to free the SB&squot;s */
id|hc_priv
op_assign
(paren
id|etrax_urb_priv_t
op_star
)paren
id|old_urb-&gt;hcpriv
suffix:semicolon
id|cleanup_sb
c_func
(paren
id|hc_priv-&gt;first_sb
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hc_priv
)paren
suffix:semicolon
id|old_urb-&gt;status
op_assign
id|status
suffix:semicolon
r_if
c_cond
(paren
id|old_urb-&gt;complete
)paren
(brace
id|old_urb
op_member_access_from_pointer
id|complete
c_func
(paren
id|old_urb
)paren
suffix:semicolon
)brace
id|DBFEXIT
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------------------------------------- */
DECL|function|etrax_usb_submit_ctrl_urb
r_static
r_int
id|etrax_usb_submit_ctrl_urb
c_func
(paren
id|urb_t
op_star
id|urb
)paren
(brace
r_char
id|epid
suffix:semicolon
r_char
id|devnum
suffix:semicolon
r_char
id|endpoint
suffix:semicolon
r_char
id|maxlen
suffix:semicolon
r_char
id|slow
suffix:semicolon
id|urb_t
op_star
id|tmp_urb
suffix:semicolon
id|etrax_urb_priv_t
op_star
id|urb_priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DBFENTER
suffix:semicolon
id|devnum
op_assign
id|usb_pipedevice
c_func
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
id|endpoint
op_assign
id|usb_pipeendpoint
c_func
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
id|maxlen
op_assign
id|usb_maxpacket
c_func
(paren
id|urb-&gt;dev
comma
id|urb-&gt;pipe
comma
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
id|slow
op_assign
id|usb_pipeslow
c_func
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
id|epid
op_assign
id|etrax_usb_lookup_epid
c_func
(paren
id|devnum
comma
id|endpoint
comma
id|slow
comma
id|maxlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|epid
op_eq
op_minus
l_int|1
)paren
(brace
id|epid
op_assign
id|etrax_usb_allocate_epid
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|epid
op_eq
op_minus
l_int|1
)paren
(brace
multiline_comment|/* We&squot;re out of endpoints, return some error */
id|err
c_func
(paren
l_string|&quot;We&squot;re out of endpoints&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Now we have to fill in this ep */
id|etrax_usb_setup_epid
c_func
(paren
id|epid
comma
id|devnum
comma
id|endpoint
comma
id|maxlen
comma
id|slow
)paren
suffix:semicolon
)brace
multiline_comment|/* Ok, now we got valid endpoint, lets insert some traffic */
id|urb-&gt;status
op_assign
op_minus
id|EINPROGRESS
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|URB_List
(braket
id|epid
)braket
)paren
(brace
multiline_comment|/* Find end of list and add */
r_for
c_loop
(paren
id|tmp_urb
op_assign
id|URB_List
(braket
id|epid
)braket
suffix:semicolon
id|tmp_urb-&gt;next
suffix:semicolon
id|tmp_urb
op_assign
id|tmp_urb-&gt;next
)paren
id|dump_urb
c_func
(paren
id|tmp_urb
)paren
suffix:semicolon
id|tmp_urb-&gt;next
op_assign
id|urb
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* If this is the first URB, add the URB and do HW add */
id|URB_List
(braket
id|epid
)braket
op_assign
id|urb
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|etrax_usb_do_ctrl_hw_add
c_func
(paren
id|urb
comma
id|epid
comma
id|maxlen
)paren
suffix:semicolon
)brace
id|DBFEXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|etrax_usb_do_ctrl_hw_add
r_static
r_int
id|etrax_usb_do_ctrl_hw_add
c_func
(paren
id|urb_t
op_star
id|urb
comma
r_char
id|epid
comma
r_char
id|maxlen
)paren
(brace
id|USB_SB_Desc_t
op_star
id|sb_desc_1
suffix:semicolon
id|USB_SB_Desc_t
op_star
id|sb_desc_2
suffix:semicolon
id|USB_SB_Desc_t
op_star
id|sb_desc_3
suffix:semicolon
id|etrax_urb_priv_t
op_star
id|urb_priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|__u32
id|r_usb_ept_data
suffix:semicolon
id|DBFENTER
suffix:semicolon
id|urb_priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|etrax_urb_priv_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|sb_desc_1
op_assign
(paren
id|USB_SB_Desc_t
op_star
)paren
id|kmem_cache_alloc
c_func
(paren
id|usb_desc_cache
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|sb_desc_2
op_assign
(paren
id|USB_SB_Desc_t
op_star
)paren
id|kmem_cache_alloc
c_func
(paren
id|usb_desc_cache
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb_desc_1
op_logical_and
id|sb_desc_2
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;kmem_cache_alloc in ctrl_hw_add gave NULL pointers !!!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|sb_desc_1-&gt;sw_len
op_assign
l_int|8
suffix:semicolon
id|sb_desc_1-&gt;command
op_assign
id|IO_FIELD
c_func
(paren
id|USB_SB_command
comma
id|rem
comma
l_int|0
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|tt
comma
id|setup
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|full
comma
id|yes
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|eot
comma
id|yes
)paren
suffix:semicolon
id|sb_desc_1-&gt;buf
op_assign
id|virt_to_phys
c_func
(paren
id|urb-&gt;setup_packet
)paren
suffix:semicolon
id|sb_desc_1-&gt;next
op_assign
id|virt_to_phys
c_func
(paren
id|sb_desc_2
)paren
suffix:semicolon
id|dump_sb_desc
c_func
(paren
id|sb_desc_1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
id|dbg_ctrl
c_func
(paren
l_string|&quot;Transfer for epid %d is OUT&quot;
comma
id|epid
)paren
suffix:semicolon
multiline_comment|/* If this Control OUT transfer has an optional data stage we add an OUT token&n;&t;&t;   before the mandatory IN (status) token, hence the reordered SB list */
r_if
c_cond
(paren
id|urb-&gt;transfer_buffer
)paren
(brace
id|dbg_ctrl
c_func
(paren
l_string|&quot;This OUT transfer has an extra data stage&quot;
)paren
suffix:semicolon
id|sb_desc_3
op_assign
(paren
id|USB_SB_Desc_t
op_star
)paren
id|kmem_cache_alloc
c_func
(paren
id|usb_desc_cache
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|sb_desc_1-&gt;next
op_assign
id|virt_to_phys
c_func
(paren
id|sb_desc_3
)paren
suffix:semicolon
id|sb_desc_3-&gt;sw_len
op_assign
id|urb-&gt;transfer_buffer_length
suffix:semicolon
id|sb_desc_3-&gt;command
op_assign
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|tt
comma
id|out
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|full
comma
id|yes
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|eot
comma
id|yes
)paren
suffix:semicolon
id|sb_desc_3-&gt;buf
op_assign
id|virt_to_phys
c_func
(paren
id|urb-&gt;transfer_buffer
)paren
suffix:semicolon
id|sb_desc_3-&gt;next
op_assign
id|virt_to_phys
c_func
(paren
id|sb_desc_2
)paren
suffix:semicolon
)brace
id|sb_desc_2-&gt;sw_len
op_assign
l_int|1
suffix:semicolon
id|sb_desc_2-&gt;command
op_assign
id|IO_FIELD
c_func
(paren
id|USB_SB_command
comma
id|rem
comma
l_int|0
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|tt
comma
id|in
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|eot
comma
id|yes
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|eol
comma
id|yes
)paren
suffix:semicolon
id|sb_desc_2-&gt;buf
op_assign
l_int|0
suffix:semicolon
id|sb_desc_2-&gt;next
op_assign
l_int|0
suffix:semicolon
id|dump_sb_desc
c_func
(paren
id|sb_desc_2
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|usb_pipein
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
id|dbg_ctrl
c_func
(paren
l_string|&quot;Transfer for epid %d is IN&quot;
comma
id|epid
)paren
suffix:semicolon
id|dbg_ctrl
c_func
(paren
l_string|&quot;transfer_buffer_length = %d&quot;
comma
id|urb-&gt;transfer_buffer_length
)paren
suffix:semicolon
id|dbg_ctrl
c_func
(paren
l_string|&quot;rem is calculated to %d&quot;
comma
id|urb-&gt;transfer_buffer_length
op_mod
id|maxlen
)paren
suffix:semicolon
id|sb_desc_3
op_assign
(paren
id|USB_SB_Desc_t
op_star
)paren
id|kmem_cache_alloc
c_func
(paren
id|usb_desc_cache
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|sb_desc_2-&gt;sw_len
op_assign
id|urb-&gt;transfer_buffer_length
ques
c_cond
(paren
id|urb-&gt;transfer_buffer_length
op_minus
l_int|1
)paren
op_div
id|maxlen
op_plus
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|dbg_ctrl
c_func
(paren
l_string|&quot;sw_len got %d&quot;
comma
id|sb_desc_2-&gt;sw_len
)paren
suffix:semicolon
id|sb_desc_2-&gt;command
op_assign
id|IO_FIELD
c_func
(paren
id|USB_SB_command
comma
id|rem
comma
id|urb-&gt;transfer_buffer_length
op_mod
id|maxlen
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|tt
comma
id|in
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|eot
comma
id|yes
)paren
suffix:semicolon
id|sb_desc_2-&gt;buf
op_assign
l_int|0
suffix:semicolon
id|sb_desc_2-&gt;next
op_assign
id|virt_to_phys
c_func
(paren
id|sb_desc_3
)paren
suffix:semicolon
id|dump_sb_desc
c_func
(paren
id|sb_desc_2
)paren
suffix:semicolon
id|sb_desc_3-&gt;sw_len
op_assign
l_int|1
suffix:semicolon
id|sb_desc_3-&gt;command
op_assign
id|IO_FIELD
c_func
(paren
id|USB_SB_command
comma
id|rem
comma
l_int|0
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|tt
comma
id|zout
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|full
comma
id|yes
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|eot
comma
id|yes
)paren
op_or
id|IO_STATE
c_func
(paren
id|USB_SB_command
comma
id|eol
comma
id|yes
)paren
suffix:semicolon
id|sb_desc_3-&gt;buf
op_assign
l_int|0
suffix:semicolon
id|sb_desc_3-&gt;next
op_assign
l_int|0
suffix:semicolon
id|dump_sb_desc
c_func
(paren
id|sb_desc_3
)paren
suffix:semicolon
id|urb_priv-&gt;rx_offset
op_assign
l_int|0
suffix:semicolon
id|urb_priv-&gt;eot
op_assign
l_int|0
suffix:semicolon
)brace
id|urb_priv-&gt;first_sb
op_assign
id|sb_desc_1
suffix:semicolon
id|urb-&gt;hcpriv
op_assign
(paren
r_void
op_star
)paren
id|urb_priv
suffix:semicolon
multiline_comment|/* Reset toggle bits and reset error count, remeber to di and ei */
multiline_comment|/* Warning: it is possible that this locking doesn&squot;t work with bottom-halves */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
op_star
id|R_USB_EPT_INDEX
op_assign
id|IO_FIELD
c_func
(paren
id|R_USB_EPT_INDEX
comma
id|value
comma
id|epid
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|R_USB_EPT_DATA
op_amp
id|IO_MASK
c_func
(paren
id|R_USB_EPT_DATA
comma
id|hold
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Hold was set in %s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
op_star
id|R_USB_EPT_DATA
op_and_assign
op_complement
(paren
id|IO_MASK
c_func
(paren
id|R_USB_EPT_DATA
comma
id|error_count_in
)paren
op_or
id|IO_MASK
c_func
(paren
id|R_USB_EPT_DATA
comma
id|error_count_out
)paren
op_or
id|IO_MASK
c_func
(paren
id|R_USB_EPT_DATA
comma
id|t_in
)paren
op_or
id|IO_MASK
c_func
(paren
id|R_USB_EPT_DATA
comma
id|t_out
)paren
)paren
suffix:semicolon
multiline_comment|/* Enable the EP descr. */
id|set_bit
c_func
(paren
id|epid
comma
(paren
r_void
op_star
)paren
op_amp
id|ep_really_active
)paren
suffix:semicolon
id|TxCtrlEPList
(braket
id|epid
)braket
dot
id|sub
op_assign
id|virt_to_phys
c_func
(paren
id|sb_desc_1
)paren
suffix:semicolon
id|TxCtrlEPList
(braket
id|epid
)braket
dot
id|hw_len
op_assign
l_int|0
suffix:semicolon
id|TxCtrlEPList
(braket
id|epid
)braket
dot
id|command
op_or_assign
id|IO_STATE
c_func
(paren
id|USB_EP_command
comma
id|enable
comma
id|yes
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|dump_ep_desc
c_func
(paren
op_amp
id|TxCtrlEPList
(braket
id|epid
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|R_DMA_CH8_SUB1_CMD
op_amp
id|IO_MASK
c_func
(paren
id|R_DMA_CH8_SUB1_CMD
comma
id|cmd
)paren
)paren
)paren
(brace
op_star
id|R_DMA_CH8_SUB1_CMD
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH8_SUB1_CMD
comma
id|cmd
comma
id|start
)paren
suffix:semicolon
)brace
id|DBFEXIT
suffix:semicolon
)brace
DECL|function|etrax_usb_submit_urb
r_static
r_int
id|etrax_usb_submit_urb
c_func
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|etrax_hc_t
op_star
id|hc
suffix:semicolon
r_int
id|rval
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|DBFENTER
suffix:semicolon
id|dump_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
id|submit_urb_count
op_increment
suffix:semicolon
id|hc
op_assign
(paren
id|etrax_hc_t
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipedevice
c_func
(paren
id|urb-&gt;pipe
)paren
op_eq
id|hc-&gt;rh.devnum
)paren
(brace
multiline_comment|/* This request if for the Virtual Root Hub */
id|rval
op_assign
id|etrax_rh_submit_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|urb-&gt;pipe
)paren
op_eq
id|PIPE_CONTROL
)paren
(brace
id|rval
op_assign
id|etrax_usb_submit_ctrl_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|urb-&gt;pipe
)paren
op_eq
id|PIPE_BULK
)paren
(brace
id|rval
op_assign
id|etrax_usb_submit_bulk_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|urb-&gt;pipe
)paren
op_eq
id|PIPE_INTERRUPT
)paren
(brace
r_int
id|bustime
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;bandwidth
op_eq
l_int|0
)paren
(brace
id|bustime
op_assign
id|usb_check_bandwidth
c_func
(paren
id|urb-&gt;dev
comma
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bustime
OL
l_int|0
)paren
(brace
id|rval
op_assign
id|bustime
suffix:semicolon
)brace
r_else
(brace
id|usb_claim_bandwidth
c_func
(paren
id|urb-&gt;dev
comma
id|urb
comma
id|bustime
comma
l_int|0
)paren
suffix:semicolon
id|rval
op_assign
id|etrax_usb_submit_intr_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|urb-&gt;pipe
)paren
op_eq
id|PIPE_ISOCHRONOUS
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;Isochronous traffic is not supported !!!&quot;
)paren
suffix:semicolon
id|rval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|DBFEXIT
suffix:semicolon
r_return
id|rval
suffix:semicolon
)brace
DECL|function|etrax_usb_unlink_urb
r_static
r_int
id|etrax_usb_unlink_urb
c_func
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|etrax_hc_t
op_star
id|hc
op_assign
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_int
id|epid
suffix:semicolon
r_int
id|pos
suffix:semicolon
r_int
id|devnum
comma
id|endpoint
comma
id|slow
comma
id|maxlen
suffix:semicolon
id|etrax_urb_priv_t
op_star
id|hc_priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DBFENTER
suffix:semicolon
id|dump_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
id|devnum
op_assign
id|usb_pipedevice
c_func
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
id|endpoint
op_assign
id|usb_pipeendpoint
c_func
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
id|slow
op_assign
id|usb_pipeslow
c_func
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
id|maxlen
op_assign
id|usb_maxpacket
c_func
(paren
id|urb-&gt;dev
comma
id|urb-&gt;pipe
comma
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
id|epid
op_assign
id|etrax_usb_lookup_epid
c_func
(paren
id|devnum
comma
id|endpoint
comma
id|slow
comma
id|maxlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|epid
op_eq
op_minus
l_int|1
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipedevice
c_func
(paren
id|urb-&gt;pipe
)paren
op_eq
id|hc-&gt;rh.devnum
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|etrax_rh_unlink_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|URB_List
(braket
id|epid
)braket
op_member_access_from_pointer
id|pipe
)paren
op_eq
id|PIPE_INTERRUPT
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|etrax_usb_unlink_intr_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
id|urb-&gt;status
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;complete
)paren
(brace
id|urb
op_member_access_from_pointer
id|complete
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
id|DBFEXIT
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|info
c_func
(paren
l_string|&quot;Unlink of BULK or CTRL&quot;
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|epid
op_assign
l_int|0
suffix:semicolon
id|epid
OL
l_int|32
suffix:semicolon
id|epid
op_increment
)paren
(brace
id|urb_t
op_star
id|u
op_assign
id|URB_List
(braket
id|epid
)braket
suffix:semicolon
id|pos
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|u
suffix:semicolon
id|u
op_assign
id|u-&gt;next
)paren
(brace
id|pos
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|u
op_eq
id|urb
)paren
(brace
id|info
c_func
(paren
l_string|&quot;Found urb at epid %d, pos %d&quot;
comma
id|epid
comma
id|pos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|u-&gt;pipe
)paren
op_eq
id|PIPE_CONTROL
)paren
(brace
r_if
c_cond
(paren
id|TxCtrlEPList
(braket
id|epid
)braket
dot
id|command
op_amp
id|IO_MASK
c_func
(paren
id|USB_EP_command
comma
id|enable
)paren
)paren
(brace
multiline_comment|/* The EP was enabled, disable it and wait */
id|TxCtrlEPList
(braket
id|epid
)braket
dot
id|command
op_and_assign
op_complement
id|IO_MASK
c_func
(paren
id|USB_EP_command
comma
id|enable
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|R_DMA_CH8_SUB1_EP
op_eq
id|virt_to_phys
c_func
(paren
op_amp
id|TxCtrlEPList
(braket
id|epid
)braket
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|u-&gt;pipe
)paren
op_eq
id|PIPE_BULK
)paren
(brace
r_if
c_cond
(paren
id|TxBulkEPList
(braket
id|epid
)braket
dot
id|command
op_amp
id|IO_MASK
c_func
(paren
id|USB_EP_command
comma
id|enable
)paren
)paren
(brace
id|TxBulkEPList
(braket
id|epid
)braket
dot
id|command
op_and_assign
op_complement
id|IO_MASK
c_func
(paren
id|USB_EP_command
comma
id|enable
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|R_DMA_CH8_SUB0_EP
op_eq
id|virt_to_phys
c_func
(paren
op_amp
id|TxBulkEPList
(braket
id|epid
)braket
)paren
)paren
suffix:semicolon
)brace
)brace
id|URB_List
(braket
id|epid
)braket
op_assign
id|u-&gt;next
suffix:semicolon
)brace
r_else
(brace
id|urb_t
op_star
id|up
suffix:semicolon
r_for
c_loop
(paren
id|up
op_assign
id|URB_List
(braket
id|epid
)braket
suffix:semicolon
id|up-&gt;next
op_ne
id|u
suffix:semicolon
id|up
op_assign
id|up-&gt;next
)paren
suffix:semicolon
id|up-&gt;next
op_assign
id|u-&gt;next
suffix:semicolon
)brace
id|u-&gt;status
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
id|u-&gt;complete
)paren
(brace
id|u
op_member_access_from_pointer
id|complete
c_func
(paren
id|u
)paren
suffix:semicolon
)brace
id|hc_priv
op_assign
(paren
id|etrax_urb_priv_t
op_star
)paren
id|u-&gt;hcpriv
suffix:semicolon
id|cleanup_sb
c_func
(paren
id|hc_priv-&gt;first_sb
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hc_priv
)paren
suffix:semicolon
)brace
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|etrax_usb_get_frame_number
r_static
r_int
id|etrax_usb_get_frame_number
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
)paren
(brace
id|DBFENTER
suffix:semicolon
id|DBFEXIT
suffix:semicolon
r_return
(paren
op_star
id|R_USB_FM_NUMBER
)paren
suffix:semicolon
)brace
DECL|function|etrax_usb_allocate_dev
r_static
r_int
id|etrax_usb_allocate_dev
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
)paren
(brace
id|DBFENTER
suffix:semicolon
id|DBFEXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|etrax_usb_deallocate_dev
r_static
r_int
id|etrax_usb_deallocate_dev
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
)paren
(brace
id|DBFENTER
suffix:semicolon
id|DBFEXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|etrax_usb_tx_interrupt
r_static
r_void
id|etrax_usb_tx_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|vhc
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|etrax_hc_t
op_star
id|hc
op_assign
(paren
id|etrax_hc_t
op_star
)paren
id|vhc
suffix:semicolon
r_int
id|epid
suffix:semicolon
r_char
id|eol
suffix:semicolon
id|urb_t
op_star
id|urb
suffix:semicolon
id|USB_EP_Desc_t
op_star
id|tmp_ep
suffix:semicolon
id|USB_SB_Desc_t
op_star
id|tmp_sb
suffix:semicolon
id|DBFENTER
suffix:semicolon
r_if
c_cond
(paren
op_star
id|R_IRQ_READ2
op_amp
id|IO_MASK
c_func
(paren
id|R_IRQ_READ2
comma
id|dma8_sub0_descr
)paren
)paren
(brace
id|info
c_func
(paren
l_string|&quot;dma8_sub0_descr (BULK) intr.&quot;
)paren
suffix:semicolon
op_star
id|R_DMA_CH8_SUB0_CLR_INTR
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH8_SUB0_CLR_INTR
comma
id|clr_descr
comma
r_do
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|R_IRQ_READ2
op_amp
id|IO_MASK
c_func
(paren
id|R_IRQ_READ2
comma
id|dma8_sub1_descr
)paren
)paren
(brace
id|info
c_func
(paren
l_string|&quot;dma8_sub1_descr (CTRL) intr.&quot;
)paren
suffix:semicolon
op_star
id|R_DMA_CH8_SUB1_CLR_INTR
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH8_SUB1_CLR_INTR
comma
id|clr_descr
comma
r_do
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|R_IRQ_READ2
op_amp
id|IO_MASK
c_func
(paren
id|R_IRQ_READ2
comma
id|dma8_sub2_descr
)paren
)paren
(brace
id|info
c_func
(paren
l_string|&quot;dma8_sub2_descr (INT) intr.&quot;
)paren
suffix:semicolon
op_star
id|R_DMA_CH8_SUB2_CLR_INTR
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH8_SUB2_CLR_INTR
comma
id|clr_descr
comma
r_do
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|R_IRQ_READ2
op_amp
id|IO_MASK
c_func
(paren
id|R_IRQ_READ2
comma
id|dma8_sub3_descr
)paren
)paren
(brace
id|info
c_func
(paren
l_string|&quot;dma8_sub3_descr (ISO) intr.&quot;
)paren
suffix:semicolon
op_star
id|R_DMA_CH8_SUB3_CLR_INTR
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH8_SUB3_CLR_INTR
comma
id|clr_descr
comma
r_do
)paren
suffix:semicolon
)brace
id|DBFEXIT
suffix:semicolon
)brace
DECL|function|etrax_usb_rx_interrupt
r_static
r_void
id|etrax_usb_rx_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|vhc
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|epid
op_assign
l_int|0
suffix:semicolon
id|urb_t
op_star
id|urb
suffix:semicolon
id|etrax_urb_priv_t
op_star
id|urb_priv
suffix:semicolon
op_star
id|R_DMA_CH9_CLR_INTR
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH9_CLR_INTR
comma
id|clr_eop
comma
r_do
)paren
suffix:semicolon
r_while
c_loop
(paren
id|myNextRxDesc-&gt;status
op_amp
id|IO_MASK
c_func
(paren
id|USB_IN_status
comma
id|eop
)paren
)paren
(brace
r_if
c_cond
(paren
id|myNextRxDesc-&gt;status
op_amp
id|IO_MASK
c_func
(paren
id|USB_IN_status
comma
id|nodata
)paren
)paren
(brace
r_goto
id|skip_out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|myNextRxDesc-&gt;status
op_amp
id|IO_MASK
c_func
(paren
id|USB_IN_status
comma
id|error
)paren
)paren
(brace
r_goto
id|skip_out
suffix:semicolon
)brace
id|epid
op_assign
id|IO_EXTRACT
c_func
(paren
id|USB_IN_status
comma
id|epid
comma
id|myNextRxDesc-&gt;status
)paren
suffix:semicolon
id|urb
op_assign
id|URB_List
(braket
id|epid
)braket
suffix:semicolon
r_if
c_cond
(paren
id|urb
op_logical_and
id|usb_pipein
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
id|urb_priv
op_assign
(paren
id|etrax_urb_priv_t
op_star
)paren
id|urb-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|urb-&gt;pipe
)paren
op_eq
id|PIPE_INTERRUPT
)paren
(brace
r_struct
id|in_chunk
op_star
id|in
suffix:semicolon
id|dbg_intr
c_func
(paren
l_string|&quot;Packet for epid %d in rx buffers&quot;
comma
id|epid
)paren
suffix:semicolon
id|in
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|in_chunk
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|in-&gt;length
op_assign
id|myNextRxDesc-&gt;hw_len
suffix:semicolon
id|in-&gt;data
op_assign
id|kmalloc
c_func
(paren
id|in-&gt;length
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|in-&gt;data
comma
id|phys_to_virt
c_func
(paren
id|myNextRxDesc-&gt;buf
)paren
comma
id|in-&gt;length
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|in-&gt;list
comma
op_amp
id|urb_priv-&gt;ep_in_list
)paren
suffix:semicolon
macro_line|#ifndef ETRAX_USB_INTR_IRQ
id|etrax_usb_hc_intr_top_half
c_func
(paren
id|irq
comma
id|vhc
comma
id|regs
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|urb_priv-&gt;rx_offset
op_plus
id|myNextRxDesc-&gt;hw_len
)paren
OG
id|urb-&gt;transfer_buffer_length
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Packet (epid: %d) in RX buffer was bigger &quot;
l_string|&quot;than the URB has room for !!!&quot;
comma
id|epid
)paren
suffix:semicolon
r_goto
id|skip_out
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|urb-&gt;transfer_buffer
op_plus
id|urb_priv-&gt;rx_offset
comma
id|phys_to_virt
c_func
(paren
id|myNextRxDesc-&gt;buf
)paren
comma
id|myNextRxDesc-&gt;hw_len
)paren
suffix:semicolon
id|urb_priv-&gt;rx_offset
op_add_assign
id|myNextRxDesc-&gt;hw_len
suffix:semicolon
)brace
r_if
c_cond
(paren
id|myNextRxDesc-&gt;status
op_amp
id|IO_MASK
c_func
(paren
id|USB_IN_status
comma
id|eot
)paren
)paren
(brace
id|urb_priv-&gt;eot
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;This is almost fatal, inpacket for epid %d which does not exist &quot;
l_string|&quot; or is out !!!&bslash;nURB was at 0x%08X&quot;
comma
id|epid
comma
id|urb
)paren
suffix:semicolon
r_goto
id|skip_out
suffix:semicolon
)brace
id|skip_out
suffix:colon
id|myPrevRxDesc
op_assign
id|myNextRxDesc
suffix:semicolon
id|myPrevRxDesc-&gt;command
op_or_assign
id|IO_MASK
c_func
(paren
id|USB_IN_command
comma
id|eol
)paren
suffix:semicolon
id|myLastRxDesc-&gt;command
op_and_assign
op_complement
id|IO_MASK
c_func
(paren
id|USB_IN_command
comma
id|eol
)paren
suffix:semicolon
id|myLastRxDesc
op_assign
id|myPrevRxDesc
suffix:semicolon
id|myNextRxDesc-&gt;status
op_assign
l_int|0
suffix:semicolon
id|myNextRxDesc
op_assign
id|phys_to_virt
c_func
(paren
id|myNextRxDesc-&gt;next
)paren
suffix:semicolon
)brace
)brace
DECL|function|cleanup_sb
r_static
r_void
id|cleanup_sb
c_func
(paren
id|USB_SB_Desc_t
op_star
id|sb
)paren
(brace
id|USB_SB_Desc_t
op_star
id|next_sb
suffix:semicolon
id|DBFENTER
suffix:semicolon
r_if
c_cond
(paren
id|sb
op_eq
l_int|NULL
)paren
(brace
id|err
c_func
(paren
l_string|&quot;cleanup_sb was given a NULL pointer&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|sb-&gt;command
op_amp
id|IO_MASK
c_func
(paren
id|USB_SB_command
comma
id|eol
)paren
)paren
)paren
(brace
id|next_sb
op_assign
(paren
id|USB_SB_Desc_t
op_star
)paren
id|phys_to_virt
c_func
(paren
id|sb-&gt;next
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|usb_desc_cache
comma
id|sb
)paren
suffix:semicolon
id|sb
op_assign
id|next_sb
suffix:semicolon
)brace
id|kmem_cache_free
c_func
(paren
id|usb_desc_cache
comma
id|sb
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
)brace
DECL|function|handle_control_transfer_attn
r_static
r_int
id|handle_control_transfer_attn
c_func
(paren
r_char
id|epid
comma
r_int
id|status
)paren
(brace
id|urb_t
op_star
id|old_urb
suffix:semicolon
id|etrax_urb_priv_t
op_star
id|hc_priv
suffix:semicolon
id|DBFENTER
suffix:semicolon
id|clear_bit
c_func
(paren
id|epid
comma
(paren
r_void
op_star
)paren
op_amp
id|ep_really_active
)paren
suffix:semicolon
id|old_urb
op_assign
id|URB_List
(braket
id|epid
)braket
suffix:semicolon
id|URB_List
(braket
id|epid
)braket
op_assign
id|old_urb-&gt;next
suffix:semicolon
multiline_comment|/* if (status == 0 &amp;&amp; IN) find data and copy to urb */
r_if
c_cond
(paren
id|status
op_eq
l_int|0
op_logical_and
id|usb_pipein
c_func
(paren
id|old_urb-&gt;pipe
)paren
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|etrax_urb_priv_t
op_star
id|urb_priv
suffix:semicolon
id|urb_priv
op_assign
(paren
id|etrax_urb_priv_t
op_star
)paren
id|old_urb-&gt;hcpriv
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb_priv-&gt;eot
op_eq
l_int|1
)paren
(brace
id|old_urb-&gt;actual_length
op_assign
id|urb_priv-&gt;rx_offset
suffix:semicolon
id|dbg_ctrl
c_func
(paren
l_string|&quot;urb_priv-&gt;rx_offset: %d in handle_control_attn&quot;
comma
id|urb_priv-&gt;rx_offset
)paren
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
op_minus
id|EPROTO
suffix:semicolon
id|old_urb-&gt;actual_length
op_assign
l_int|0
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;(CTRL) No eot set in IN data!!! rx_offset: %d&quot;
comma
id|urb_priv-&gt;rx_offset
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* If there are any more URB&squot;s in the list we&squot;d better start sending */
r_if
c_cond
(paren
id|URB_List
(braket
id|epid
)braket
)paren
(brace
id|etrax_usb_do_ctrl_hw_add
c_func
(paren
id|URB_List
(braket
id|epid
)braket
comma
id|epid
comma
id|usb_maxpacket
c_func
(paren
id|URB_List
(braket
id|epid
)braket
op_member_access_from_pointer
id|dev
comma
id|URB_List
(braket
id|epid
)braket
op_member_access_from_pointer
id|pipe
comma
id|usb_pipeout
c_func
(paren
id|URB_List
(braket
id|epid
)braket
op_member_access_from_pointer
id|pipe
)paren
)paren
)paren
suffix:semicolon
)brace
macro_line|#if 1
r_else
(brace
multiline_comment|/* This means that this EP is now free, deconfigure it */
id|etrax_usb_free_epid
c_func
(paren
id|epid
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Remember to free the SB&squot;s */
id|hc_priv
op_assign
(paren
id|etrax_urb_priv_t
op_star
)paren
id|old_urb-&gt;hcpriv
suffix:semicolon
id|cleanup_sb
c_func
(paren
id|hc_priv-&gt;first_sb
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hc_priv
)paren
suffix:semicolon
id|old_urb-&gt;status
op_assign
id|status
suffix:semicolon
r_if
c_cond
(paren
id|old_urb-&gt;complete
)paren
(brace
id|old_urb
op_member_access_from_pointer
id|complete
c_func
(paren
id|old_urb
)paren
suffix:semicolon
)brace
id|DBFEXIT
suffix:semicolon
)brace
DECL|function|etrax_usb_hc_intr_bottom_half
r_static
r_void
id|etrax_usb_hc_intr_bottom_half
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|usb_reg_context
op_star
id|reg
op_assign
(paren
r_struct
id|usb_reg_context
op_star
)paren
id|data
suffix:semicolon
id|urb_t
op_star
id|old_urb
suffix:semicolon
r_int
id|error_code
suffix:semicolon
r_int
id|epid
suffix:semicolon
id|__u32
id|r_usb_ept_data
suffix:semicolon
id|etrax_hc_t
op_star
id|hc
op_assign
id|reg-&gt;hc
suffix:semicolon
id|__u16
id|r_usb_rh_port_status_1
suffix:semicolon
id|__u16
id|r_usb_rh_port_status_2
suffix:semicolon
id|DBFENTER
suffix:semicolon
r_if
c_cond
(paren
id|reg-&gt;r_usb_irq_mask_read
op_amp
id|IO_MASK
c_func
(paren
id|R_USB_IRQ_MASK_READ
comma
id|port_status
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;  The Etrax RH does not include a wPortChange register, so this has&n;&t;&t;  to be handled in software. See section 11.16.2.6.2 in USB 1.1 spec&n;&t;&t;  for details.&n;&t;&t;*/
id|r_usb_rh_port_status_1
op_assign
id|reg-&gt;r_usb_rh_port_status_1
suffix:semicolon
id|r_usb_rh_port_status_2
op_assign
id|reg-&gt;r_usb_rh_port_status_2
suffix:semicolon
id|dbg_rh
c_func
(paren
l_string|&quot;port_status pending&quot;
)paren
suffix:semicolon
id|dbg_rh
c_func
(paren
l_string|&quot;r_usb_rh_port_status_1: 0x%04X&quot;
comma
id|r_usb_rh_port_status_1
)paren
suffix:semicolon
id|dbg_rh
c_func
(paren
l_string|&quot;r_usb_rh_port_status_2: 0x%04X&quot;
comma
id|r_usb_rh_port_status_2
)paren
suffix:semicolon
multiline_comment|/* C_PORT_CONNECTION is set on any transition */
id|hc-&gt;rh.wPortChange_1
op_or_assign
(paren
(paren
id|r_usb_rh_port_status_1
op_amp
(paren
l_int|1
op_lshift
id|RH_PORT_CONNECTION
)paren
)paren
op_ne
(paren
id|hc-&gt;rh.prev_wPortStatus_1
op_amp
(paren
l_int|1
op_lshift
id|RH_PORT_CONNECTION
)paren
)paren
)paren
ques
c_cond
(paren
l_int|1
op_lshift
id|RH_PORT_CONNECTION
)paren
suffix:colon
l_int|0
suffix:semicolon
id|hc-&gt;rh.wPortChange_2
op_or_assign
(paren
(paren
id|r_usb_rh_port_status_2
op_amp
(paren
l_int|1
op_lshift
id|RH_PORT_CONNECTION
)paren
)paren
op_ne
(paren
id|hc-&gt;rh.prev_wPortStatus_2
op_amp
(paren
l_int|1
op_lshift
id|RH_PORT_CONNECTION
)paren
)paren
)paren
ques
c_cond
(paren
l_int|1
op_lshift
id|RH_PORT_CONNECTION
)paren
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* C_PORT_ENABLE is _only_ set on a one to zero transition */
id|hc-&gt;rh.wPortChange_1
op_or_assign
(paren
(paren
id|hc-&gt;rh.prev_wPortStatus_1
op_amp
(paren
l_int|1
op_lshift
id|RH_PORT_ENABLE
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|r_usb_rh_port_status_1
op_amp
(paren
l_int|1
op_lshift
id|RH_PORT_ENABLE
)paren
)paren
)paren
ques
c_cond
(paren
l_int|1
op_lshift
id|RH_PORT_ENABLE
)paren
suffix:colon
l_int|0
suffix:semicolon
id|hc-&gt;rh.wPortChange_2
op_or_assign
(paren
(paren
id|hc-&gt;rh.prev_wPortStatus_2
op_amp
(paren
l_int|1
op_lshift
id|RH_PORT_ENABLE
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|r_usb_rh_port_status_2
op_amp
(paren
l_int|1
op_lshift
id|RH_PORT_ENABLE
)paren
)paren
)paren
ques
c_cond
(paren
l_int|1
op_lshift
id|RH_PORT_ENABLE
)paren
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* C_PORT_SUSPEND seems difficult, lets ignore it.. (for now) */
multiline_comment|/* C_PORT_RESET is _only_ set on a transition from the resetting state&n;&t;&t;   to the enabled state */
id|hc-&gt;rh.wPortChange_1
op_or_assign
(paren
(paren
id|hc-&gt;rh.prev_wPortStatus_1
op_amp
(paren
l_int|1
op_lshift
id|RH_PORT_RESET
)paren
)paren
op_logical_and
(paren
id|r_usb_rh_port_status_1
op_amp
(paren
l_int|1
op_lshift
id|RH_PORT_ENABLE
)paren
)paren
)paren
ques
c_cond
(paren
l_int|1
op_lshift
id|RH_PORT_RESET
)paren
suffix:colon
l_int|0
suffix:semicolon
id|hc-&gt;rh.wPortChange_2
op_or_assign
(paren
(paren
id|hc-&gt;rh.prev_wPortStatus_2
op_amp
(paren
l_int|1
op_lshift
id|RH_PORT_RESET
)paren
)paren
op_logical_and
(paren
id|r_usb_rh_port_status_2
op_amp
(paren
l_int|1
op_lshift
id|RH_PORT_ENABLE
)paren
)paren
)paren
ques
c_cond
(paren
l_int|1
op_lshift
id|RH_PORT_RESET
)paren
suffix:colon
l_int|0
suffix:semicolon
id|hc-&gt;rh.prev_wPortStatus_1
op_assign
id|r_usb_rh_port_status_1
suffix:semicolon
id|hc-&gt;rh.prev_wPortStatus_2
op_assign
id|r_usb_rh_port_status_2
suffix:semicolon
)brace
r_for
c_loop
(paren
id|epid
op_assign
l_int|0
suffix:semicolon
id|epid
OL
l_int|32
suffix:semicolon
id|epid
op_increment
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
op_star
id|R_USB_EPT_INDEX
op_assign
id|IO_FIELD
c_func
(paren
id|R_USB_EPT_INDEX
comma
id|value
comma
id|epid
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|r_usb_ept_data
op_assign
op_star
id|R_USB_EPT_DATA
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r_usb_ept_data
op_amp
id|IO_MASK
c_func
(paren
id|R_USB_EPT_DATA
comma
id|hold
)paren
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;Was hold for epid %d&quot;
comma
id|epid
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|r_usb_ept_data
op_amp
id|IO_MASK
c_func
(paren
id|R_USB_EPT_DATA
comma
id|valid
)paren
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|epid
comma
(paren
r_void
op_star
)paren
op_amp
id|reg-&gt;r_usb_epid_attn
)paren
)paren
(brace
r_if
c_cond
(paren
id|URB_List
(braket
id|epid
)braket
op_eq
l_int|NULL
)paren
(brace
id|err
c_func
(paren
l_string|&quot;R_USB_EPT_DATA is 0x%08X&quot;
comma
id|r_usb_ept_data
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;submit urb has been called %d times..&quot;
comma
id|submit_urb_count
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;EPID_ATTN for epid %d, with NULL entry in list&quot;
comma
id|epid
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dbg_ep
c_func
(paren
l_string|&quot;r_usb_ept_data [%d] == 0x%08X&quot;
comma
id|epid
comma
id|r_usb_ept_data
)paren
suffix:semicolon
id|error_code
op_assign
id|IO_EXTRACT
c_func
(paren
id|R_USB_EPT_DATA
comma
id|error_code
comma
id|r_usb_ept_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error_code
op_eq
id|IO_STATE_VALUE
c_func
(paren
id|R_USB_EPT_DATA
comma
id|error_code
comma
id|no_error
)paren
)paren
(brace
multiline_comment|/* no_error means that this urb was sucessfully sent or that we have&n;&t;&t;&t;&t;   some undefinde error*/
r_if
c_cond
(paren
id|IO_EXTRACT
c_func
(paren
id|R_USB_EPT_DATA
comma
id|error_count_out
comma
id|r_usb_ept_data
)paren
op_eq
l_int|3
op_logical_or
id|IO_EXTRACT
c_func
(paren
id|R_USB_EPT_DATA
comma
id|error_count_in
comma
id|r_usb_ept_data
)paren
op_eq
l_int|3
)paren
(brace
multiline_comment|/* Actually there were transmission errors */
id|warn
c_func
(paren
l_string|&quot;Undefined error for endpoint %d&quot;
comma
id|epid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|URB_List
(braket
id|epid
)braket
op_member_access_from_pointer
id|pipe
)paren
op_eq
id|PIPE_CONTROL
)paren
(brace
id|handle_control_transfer_attn
c_func
(paren
id|epid
comma
op_minus
id|EPROTO
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|URB_List
(braket
id|epid
)braket
op_member_access_from_pointer
id|pipe
)paren
op_eq
id|PIPE_BULK
)paren
(brace
id|handle_bulk_transfer_attn
c_func
(paren
id|epid
comma
op_minus
id|EPROTO
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|URB_List
(braket
id|epid
)braket
op_member_access_from_pointer
id|pipe
)paren
op_eq
id|PIPE_INTERRUPT
)paren
(brace
id|handle_intr_transfer_attn
c_func
(paren
id|epid
comma
op_minus
id|EPROTO
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|reg-&gt;r_usb_status
op_amp
id|IO_MASK
c_func
(paren
id|R_USB_STATUS
comma
id|perror
)paren
)paren
(brace
r_if
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|URB_List
(braket
id|epid
)braket
op_member_access_from_pointer
id|pipe
)paren
op_eq
id|PIPE_INTERRUPT
)paren
(brace
id|etrax_usb_do_intr_recover
c_func
(paren
id|epid
)paren
suffix:semicolon
)brace
r_else
(brace
id|panic
c_func
(paren
l_string|&quot;Epid attention for epid %d (none INTR), with no errors and no &quot;
l_string|&quot;exessive retry r_usb_status is 0x%02X&bslash;n&quot;
comma
id|epid
comma
id|reg-&gt;r_usb_status
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|reg-&gt;r_usb_status
op_amp
id|IO_MASK
c_func
(paren
id|R_USB_STATUS
comma
id|ourun
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Epid attention for epid %d, with no errors and no &quot;
l_string|&quot;exessive retry r_usb_status is 0x%02X&bslash;n&quot;
comma
id|epid
comma
id|reg-&gt;r_usb_status
)paren
suffix:semicolon
)brace
id|warn
c_func
(paren
l_string|&quot;Epid attention for epid %d, with no errors and no &quot;
l_string|&quot;exessive retry r_usb_status is 0x%02X&quot;
comma
id|epid
comma
id|reg-&gt;r_usb_status
)paren
suffix:semicolon
id|warn
c_func
(paren
l_string|&quot;OUT error count: %d&quot;
comma
id|IO_EXTRACT
c_func
(paren
id|R_USB_EPT_DATA
comma
id|error_count_out
comma
id|r_usb_ept_data
)paren
)paren
suffix:semicolon
id|warn
c_func
(paren
l_string|&quot;IN  error count: %d&quot;
comma
id|IO_EXTRACT
c_func
(paren
id|R_USB_EPT_DATA
comma
id|error_count_in
comma
id|r_usb_ept_data
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|error_code
op_eq
id|IO_STATE_VALUE
c_func
(paren
id|R_USB_EPT_DATA
comma
id|error_code
comma
id|stall
)paren
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;Stall for endpoint %d&quot;
comma
id|epid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|URB_List
(braket
id|epid
)braket
op_member_access_from_pointer
id|pipe
)paren
op_eq
id|PIPE_CONTROL
)paren
(brace
id|handle_control_transfer_attn
c_func
(paren
id|epid
comma
op_minus
id|EPIPE
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|URB_List
(braket
id|epid
)braket
op_member_access_from_pointer
id|pipe
)paren
op_eq
id|PIPE_BULK
)paren
(brace
id|handle_bulk_transfer_attn
c_func
(paren
id|epid
comma
op_minus
id|EPIPE
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|URB_List
(braket
id|epid
)braket
op_member_access_from_pointer
id|pipe
)paren
op_eq
id|PIPE_INTERRUPT
)paren
(brace
id|handle_intr_transfer_attn
c_func
(paren
id|epid
comma
op_minus
id|EPIPE
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|error_code
op_eq
id|IO_STATE_VALUE
c_func
(paren
id|R_USB_EPT_DATA
comma
id|error_code
comma
id|bus_error
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;USB bus error for endpoint %d&bslash;n&quot;
comma
id|epid
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|error_code
op_eq
id|IO_STATE_VALUE
c_func
(paren
id|R_USB_EPT_DATA
comma
id|error_code
comma
id|buffer_error
)paren
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;Buffer error for endpoint %d&quot;
comma
id|epid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|URB_List
(braket
id|epid
)braket
op_member_access_from_pointer
id|pipe
)paren
op_eq
id|PIPE_CONTROL
)paren
(brace
id|handle_control_transfer_attn
c_func
(paren
id|epid
comma
op_minus
id|EPROTO
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|URB_List
(braket
id|epid
)braket
op_member_access_from_pointer
id|pipe
)paren
op_eq
id|PIPE_BULK
)paren
(brace
id|handle_bulk_transfer_attn
c_func
(paren
id|epid
comma
op_minus
id|EPROTO
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|URB_List
(braket
id|epid
)braket
op_member_access_from_pointer
id|pipe
)paren
op_eq
id|PIPE_INTERRUPT
)paren
(brace
id|handle_intr_transfer_attn
c_func
(paren
id|epid
comma
op_minus
id|EPROTO
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|epid
comma
(paren
r_void
op_star
)paren
op_amp
id|ep_really_active
)paren
)paren
(brace
multiline_comment|/* Should really be else if (testbit(really active)) */
r_if
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|URB_List
(braket
id|epid
)braket
op_member_access_from_pointer
id|pipe
)paren
op_eq
id|PIPE_CONTROL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|TxCtrlEPList
(braket
id|epid
)braket
dot
id|command
op_amp
id|IO_MASK
c_func
(paren
id|USB_EP_command
comma
id|enable
)paren
)paren
)paren
(brace
multiline_comment|/* Now we have to verify that this CTRL endpoint got disabled&n;&t;&t;&t;&t;&t;   cause it reached end of list with no error */
r_if
c_cond
(paren
id|IO_EXTRACT
c_func
(paren
id|R_USB_EPT_DATA
comma
id|error_code
comma
id|r_usb_ept_data
)paren
op_eq
id|IO_STATE_VALUE
c_func
(paren
id|R_USB_EPT_DATA
comma
id|error_code
comma
id|no_error
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t;  This means that the endpoint has no error, is disabled&n;&t;&t;&t;&t;&t;&t;  and had inserted traffic,&n;&t;&t;&t;&t;&t;&t;  i.e. transfer sucessfully completed&n;&t;&t;&t;&t;&t;&t;*/
id|dbg_ctrl
c_func
(paren
l_string|&quot;Last SB for CTRL %d sent sucessfully&quot;
comma
id|epid
)paren
suffix:semicolon
id|handle_control_transfer_attn
c_func
(paren
id|epid
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|URB_List
(braket
id|epid
)braket
op_member_access_from_pointer
id|pipe
)paren
op_eq
id|PIPE_BULK
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|TxBulkEPList
(braket
id|epid
)braket
dot
id|command
op_amp
id|IO_MASK
c_func
(paren
id|USB_EP_command
comma
id|enable
)paren
)paren
)paren
(brace
multiline_comment|/* Now we have to verify that this BULK endpoint go disabled&n;&t;&t;&t;&t;&t;   cause it reached end of list with no error */
r_if
c_cond
(paren
id|IO_EXTRACT
c_func
(paren
id|R_USB_EPT_DATA
comma
id|error_code
comma
id|r_usb_ept_data
)paren
op_eq
id|IO_STATE_VALUE
c_func
(paren
id|R_USB_EPT_DATA
comma
id|error_code
comma
id|no_error
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t;  This means that the endpoint has no error, is disabled&n;&t;&t;&t;&t;&t;&t;  and had inserted traffic,&n;&t;&t;&t;&t;&t;&t;  i.e. transfer sucessfully completed&n;&t;&t;&t;&t;&t;&t;*/
id|dbg_bulk
c_func
(paren
l_string|&quot;Last SB for BULK %d sent sucessfully&quot;
comma
id|epid
)paren
suffix:semicolon
id|handle_bulk_transfer_attn
c_func
(paren
id|epid
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|URB_List
(braket
id|epid
)braket
op_member_access_from_pointer
id|pipe
)paren
op_eq
id|PIPE_INTERRUPT
)paren
(brace
id|handle_intr_transfer_attn
c_func
(paren
id|epid
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
)brace
id|kfree
c_func
(paren
id|reg
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
)brace
DECL|function|etrax_usb_hc_intr_top_half
r_static
r_void
id|etrax_usb_hc_intr_top_half
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|vhc
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|usb_reg_context
op_star
id|reg
suffix:semicolon
id|DBFENTER
suffix:semicolon
id|reg
op_assign
(paren
r_struct
id|usb_reg_context
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|usb_reg_context
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;kmalloc failed in top_half&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|reg-&gt;hc
op_assign
(paren
id|etrax_hc_t
op_star
)paren
id|vhc
suffix:semicolon
id|reg-&gt;r_usb_irq_mask_read
op_assign
op_star
id|R_USB_IRQ_MASK_READ
suffix:semicolon
id|reg-&gt;r_usb_status
op_assign
op_star
id|R_USB_STATUS
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|reg-&gt;r_usb_status
op_amp
id|IO_MASK
c_func
(paren
id|R_USB_STATUS
comma
id|perror
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;r_usb_status said perror&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reg-&gt;r_usb_status
op_amp
id|IO_MASK
c_func
(paren
id|R_USB_STATUS
comma
id|ourun
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;r_usb_status said ourun !!!&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|reg-&gt;r_usb_epid_attn
op_assign
op_star
id|R_USB_EPID_ATTN
suffix:semicolon
id|reg-&gt;r_usb_rh_port_status_1
op_assign
op_star
id|R_USB_RH_PORT_STATUS_1
suffix:semicolon
id|reg-&gt;r_usb_rh_port_status_2
op_assign
op_star
id|R_USB_RH_PORT_STATUS_2
suffix:semicolon
id|reg-&gt;usb_bh.sync
op_assign
l_int|0
suffix:semicolon
id|reg-&gt;usb_bh.routine
op_assign
id|etrax_usb_hc_intr_bottom_half
suffix:semicolon
id|reg-&gt;usb_bh.data
op_assign
id|reg
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|reg-&gt;usb_bh
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
)brace
DECL|function|etrax_rh_submit_urb
r_static
r_int
id|etrax_rh_submit_urb
c_func
(paren
id|urb_t
op_star
id|urb
)paren
(brace
r_struct
id|usb_device
op_star
id|usb_dev
op_assign
id|urb-&gt;dev
suffix:semicolon
id|etrax_hc_t
op_star
id|hc
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_int
r_int
id|pipe
op_assign
id|urb-&gt;pipe
suffix:semicolon
id|devrequest
op_star
id|cmd
op_assign
(paren
id|devrequest
op_star
)paren
id|urb-&gt;setup_packet
suffix:semicolon
r_void
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_int
id|leni
op_assign
id|urb-&gt;transfer_buffer_length
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|stat
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|__u16
id|cstatus
suffix:semicolon
id|__u16
id|bmRType_bReq
suffix:semicolon
id|__u16
id|wValue
suffix:semicolon
id|__u16
id|wIndex
suffix:semicolon
id|__u16
id|wLength
suffix:semicolon
id|DBFENTER
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipetype
(paren
id|pipe
)paren
op_eq
id|PIPE_INTERRUPT
)paren
(brace
id|dbg_rh
c_func
(paren
l_string|&quot;Root-Hub submit IRQ: every %d ms&quot;
comma
id|urb-&gt;interval
)paren
suffix:semicolon
id|hc-&gt;rh.urb
op_assign
id|urb
suffix:semicolon
id|hc-&gt;rh.send
op_assign
l_int|1
suffix:semicolon
id|hc-&gt;rh.interval
op_assign
id|urb-&gt;interval
suffix:semicolon
id|etrax_rh_init_int_timer
c_func
(paren
id|urb
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|bmRType_bReq
op_assign
id|cmd-&gt;requesttype
op_or
id|cmd-&gt;request
op_lshift
l_int|8
suffix:semicolon
id|wValue
op_assign
id|le16_to_cpu
c_func
(paren
id|cmd-&gt;value
)paren
suffix:semicolon
id|wIndex
op_assign
id|le16_to_cpu
c_func
(paren
id|cmd-&gt;index
)paren
suffix:semicolon
id|wLength
op_assign
id|le16_to_cpu
c_func
(paren
id|cmd-&gt;length
)paren
suffix:semicolon
id|dbg_rh
c_func
(paren
l_string|&quot;bmRType_bReq : 0x%04X (%d)&quot;
comma
id|bmRType_bReq
comma
id|bmRType_bReq
)paren
suffix:semicolon
id|dbg_rh
c_func
(paren
l_string|&quot;wValue       : 0x%04X (%d)&quot;
comma
id|wValue
comma
id|wValue
)paren
suffix:semicolon
id|dbg_rh
c_func
(paren
l_string|&quot;wIndex       : 0x%04X (%d)&quot;
comma
id|wIndex
comma
id|wIndex
)paren
suffix:semicolon
id|dbg_rh
c_func
(paren
l_string|&quot;wLength      : 0x%04X (%d)&quot;
comma
id|wLength
comma
id|wLength
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|bmRType_bReq
)paren
(brace
multiline_comment|/* Request Destination:&n;&t;&t;   without flags: Device, &n;&t;&t;   RH_INTERFACE: interface, &n;&t;&t;   RH_ENDPOINT: endpoint,&n;&t;&t;   RH_CLASS means HUB here, &n;&t;&t;   RH_OTHER | RH_CLASS  almost ever means HUB_PORT here &n;&t;&t; */
r_case
id|RH_GET_STATUS
suffix:colon
op_star
(paren
id|__u16
op_star
)paren
id|data
op_assign
id|cpu_to_le16
(paren
l_int|1
)paren
suffix:semicolon
id|OK
(paren
l_int|2
)paren
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_INTERFACE
suffix:colon
op_star
(paren
id|__u16
op_star
)paren
id|data
op_assign
id|cpu_to_le16
(paren
l_int|0
)paren
suffix:semicolon
id|OK
(paren
l_int|2
)paren
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_ENDPOINT
suffix:colon
op_star
(paren
id|__u16
op_star
)paren
id|data
op_assign
id|cpu_to_le16
(paren
l_int|0
)paren
suffix:semicolon
id|OK
(paren
l_int|2
)paren
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_CLASS
suffix:colon
op_star
(paren
id|__u32
op_star
)paren
id|data
op_assign
id|cpu_to_le32
(paren
l_int|0
)paren
suffix:semicolon
id|OK
(paren
l_int|4
)paren
suffix:semicolon
multiline_comment|/* hub power ** */
r_case
id|RH_GET_STATUS
op_or
id|RH_OTHER
op_or
id|RH_CLASS
suffix:colon
r_if
c_cond
(paren
id|wIndex
op_eq
l_int|1
)paren
(brace
op_star
(paren
(paren
id|__u16
op_star
)paren
id|data
)paren
op_assign
id|cpu_to_le16
c_func
(paren
id|hc-&gt;rh.prev_wPortStatus_1
)paren
suffix:semicolon
op_star
(paren
(paren
id|__u16
op_star
)paren
id|data
op_plus
l_int|1
)paren
op_assign
id|cpu_to_le16
c_func
(paren
id|hc-&gt;rh.wPortChange_1
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|wIndex
op_eq
l_int|2
)paren
(brace
op_star
(paren
(paren
id|__u16
op_star
)paren
id|data
)paren
op_assign
id|cpu_to_le16
c_func
(paren
id|hc-&gt;rh.prev_wPortStatus_2
)paren
suffix:semicolon
op_star
(paren
(paren
id|__u16
op_star
)paren
id|data
op_plus
l_int|1
)paren
op_assign
id|cpu_to_le16
c_func
(paren
id|hc-&gt;rh.wPortChange_2
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbg_rh
c_func
(paren
l_string|&quot;RH_GET_STATUS whith invalid wIndex !!&quot;
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|OK
c_func
(paren
l_int|4
)paren
suffix:semicolon
r_case
id|RH_CLEAR_FEATURE
op_or
id|RH_ENDPOINT
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
(paren
id|RH_ENDPOINT_STALL
)paren
suffix:colon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_CLEAR_FEATURE
op_or
id|RH_CLASS
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
(paren
id|RH_C_HUB_OVER_CURRENT
)paren
suffix:colon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* hub power over current ** */
)brace
r_break
suffix:semicolon
r_case
id|RH_CLEAR_FEATURE
op_or
id|RH_OTHER
op_or
id|RH_CLASS
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
(paren
id|RH_PORT_ENABLE
)paren
suffix:colon
r_if
c_cond
(paren
id|wIndex
op_eq
l_int|1
)paren
(brace
id|dbg_rh
c_func
(paren
l_string|&quot;trying to do disable of port 1&quot;
)paren
suffix:semicolon
op_star
id|R_USB_PORT1_DISABLE
op_assign
id|IO_STATE
c_func
(paren
id|R_USB_PORT1_DISABLE
comma
id|disable
comma
id|yes
)paren
suffix:semicolon
r_while
c_loop
(paren
id|hc-&gt;rh.prev_wPortStatus_1
op_amp
id|IO_STATE
c_func
(paren
id|R_USB_RH_PORT_STATUS_1
comma
id|enabled
comma
id|yes
)paren
)paren
suffix:semicolon
op_star
id|R_USB_PORT1_DISABLE
op_assign
id|IO_STATE
c_func
(paren
id|R_USB_PORT1_DISABLE
comma
id|disable
comma
id|no
)paren
suffix:semicolon
id|dbg_rh
c_func
(paren
l_string|&quot;Port 1 is disabled&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|wIndex
op_eq
l_int|2
)paren
(brace
id|dbg_rh
c_func
(paren
l_string|&quot;trying to do disable of port 2&quot;
)paren
suffix:semicolon
op_star
id|R_USB_PORT2_DISABLE
op_assign
id|IO_STATE
c_func
(paren
id|R_USB_PORT2_DISABLE
comma
id|disable
comma
id|yes
)paren
suffix:semicolon
r_while
c_loop
(paren
id|hc-&gt;rh.prev_wPortStatus_2
op_amp
id|IO_STATE
c_func
(paren
id|R_USB_RH_PORT_STATUS_2
comma
id|enabled
comma
id|yes
)paren
)paren
suffix:semicolon
op_star
id|R_USB_PORT2_DISABLE
op_assign
id|IO_STATE
c_func
(paren
id|R_USB_PORT2_DISABLE
comma
id|disable
comma
id|no
)paren
suffix:semicolon
id|dbg_rh
c_func
(paren
l_string|&quot;Port 2 is disabled&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbg_rh
c_func
(paren
l_string|&quot;RH_CLEAR_FEATURE-&gt;RH_PORT_ENABLE &quot;
l_string|&quot;with invalid wIndex == %d!!&quot;
comma
id|wIndex
)paren
suffix:semicolon
)brace
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_PORT_SUSPEND
)paren
suffix:colon
multiline_comment|/* Opposite to suspend should be resume, so well do a resume */
r_if
c_cond
(paren
id|wIndex
op_eq
l_int|1
)paren
(brace
op_star
id|R_USB_COMMAND
op_assign
id|IO_STATE
c_func
(paren
id|R_USB_COMMAND
comma
id|port_sel
comma
id|port1
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_USB_COMMAND
comma
id|port_cmd
comma
id|resume
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_USB_COMMAND
comma
id|ctrl_cmd
comma
id|nop
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|wIndex
op_eq
l_int|2
)paren
(brace
op_star
id|R_USB_COMMAND
op_assign
id|IO_STATE
c_func
(paren
id|R_USB_COMMAND
comma
id|port_sel
comma
id|port2
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_USB_COMMAND
comma
id|port_cmd
comma
id|resume
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_USB_COMMAND
comma
id|ctrl_cmd
comma
id|nop
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbg_rh
c_func
(paren
l_string|&quot;RH_CLEAR_FEATURE-&gt;RH_PORT_SUSPEND &quot;
l_string|&quot;with invalid wIndex == %d!!&quot;
comma
id|wIndex
)paren
suffix:semicolon
)brace
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_PORT_POWER
)paren
suffix:colon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* port power ** */
r_case
(paren
id|RH_C_PORT_CONNECTION
)paren
suffix:colon
r_if
c_cond
(paren
id|wIndex
op_eq
l_int|1
)paren
(brace
id|hc-&gt;rh.wPortChange_1
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|RH_PORT_CONNECTION
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|wIndex
op_eq
l_int|2
)paren
(brace
id|hc-&gt;rh.wPortChange_2
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|RH_PORT_CONNECTION
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbg_rh
c_func
(paren
l_string|&quot;RH_CLEAR_FEATURE-&gt;RH_C_PORT_CONNECTION &quot;
l_string|&quot;with invalid wIndex == %d!!&quot;
comma
id|wIndex
)paren
suffix:semicolon
)brace
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_C_PORT_ENABLE
)paren
suffix:colon
r_if
c_cond
(paren
id|wIndex
op_eq
l_int|1
)paren
(brace
id|hc-&gt;rh.wPortChange_1
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|RH_PORT_ENABLE
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|wIndex
op_eq
l_int|2
)paren
(brace
id|hc-&gt;rh.wPortChange_2
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|RH_PORT_ENABLE
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbg_rh
c_func
(paren
l_string|&quot;RH_CLEAR_FEATURE-&gt;RH_C_PORT_ENABLE &quot;
l_string|&quot;with invalid wIndex == %d!!&quot;
comma
id|wIndex
)paren
suffix:semicolon
)brace
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_C_PORT_SUSPEND
)paren
suffix:colon
multiline_comment|/*** WR_RH_PORTSTAT(RH_PS_PSSC); */
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_C_PORT_OVER_CURRENT
)paren
suffix:colon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* port power over current ** */
r_case
(paren
id|RH_C_PORT_RESET
)paren
suffix:colon
r_if
c_cond
(paren
id|wIndex
op_eq
l_int|1
)paren
(brace
id|hc-&gt;rh.wPortChange_1
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|RH_PORT_RESET
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|wIndex
op_eq
l_int|2
)paren
(brace
id|dbg_rh
c_func
(paren
l_string|&quot;This is wPortChange before clear: 0x%04X&quot;
comma
id|hc-&gt;rh.wPortChange_2
)paren
suffix:semicolon
id|hc-&gt;rh.wPortChange_2
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|RH_PORT_RESET
)paren
suffix:semicolon
id|dbg_rh
c_func
(paren
l_string|&quot;This is wPortChange after clear: 0x%04X&quot;
comma
id|hc-&gt;rh.wPortChange_2
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbg_rh
c_func
(paren
l_string|&quot;RH_CLEAR_FEATURE-&gt;RH_C_PORT_RESET &quot;
l_string|&quot;with invalid index == %d!!&quot;
comma
id|wIndex
)paren
suffix:semicolon
)brace
id|OK
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_SET_FEATURE
op_or
id|RH_OTHER
op_or
id|RH_CLASS
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
(paren
id|RH_PORT_SUSPEND
)paren
suffix:colon
r_if
c_cond
(paren
id|wIndex
op_eq
l_int|1
)paren
(brace
op_star
id|R_USB_COMMAND
op_assign
id|IO_STATE
c_func
(paren
id|R_USB_COMMAND
comma
id|port_sel
comma
id|port1
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_USB_COMMAND
comma
id|port_cmd
comma
id|suspend
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_USB_COMMAND
comma
id|ctrl_cmd
comma
id|nop
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|wIndex
op_eq
l_int|2
)paren
(brace
op_star
id|R_USB_COMMAND
op_assign
id|IO_STATE
c_func
(paren
id|R_USB_COMMAND
comma
id|port_sel
comma
id|port2
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_USB_COMMAND
comma
id|port_cmd
comma
id|suspend
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_USB_COMMAND
comma
id|ctrl_cmd
comma
id|nop
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbg_rh
c_func
(paren
l_string|&quot;RH_SET_FEATURE-&gt;RH_C_PORT_SUSPEND &quot;
l_string|&quot;with invalid wIndex == %d!!&quot;
comma
id|wIndex
)paren
suffix:semicolon
)brace
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_PORT_RESET
)paren
suffix:colon
r_if
c_cond
(paren
id|wIndex
op_eq
l_int|1
)paren
(brace
r_int
id|port1_retry
suffix:semicolon
id|port1_redo
suffix:colon
id|dbg_rh
c_func
(paren
l_string|&quot;Doing reset of port 1&quot;
)paren
suffix:semicolon
op_star
id|R_USB_COMMAND
op_assign
id|IO_STATE
c_func
(paren
id|R_USB_COMMAND
comma
id|port_cmd
comma
id|reset
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_USB_COMMAND
comma
id|port_sel
comma
id|port1
)paren
suffix:semicolon
multiline_comment|/* We must once again wait at least 10ms for the device to recover */
id|port1_retry
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
(paren
op_star
(paren
(paren
r_volatile
id|__u16
op_star
)paren
op_amp
id|hc-&gt;rh.prev_wPortStatus_1
)paren
)paren
op_amp
id|IO_STATE
c_func
(paren
id|R_USB_RH_PORT_STATUS_1
comma
id|enabled
comma
id|yes
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port1_retry
op_increment
op_ge
l_int|10000
)paren
(brace
r_goto
id|port1_redo
suffix:semicolon
)brace
)brace
multiline_comment|/* This only seems to work if we use printk,&n;&t;&t;&t;&t;   not even schedule() works !!! WHY ?? */
id|udelay
c_func
(paren
l_int|15000
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|wIndex
op_eq
l_int|2
)paren
(brace
r_int
id|port2_retry
suffix:semicolon
id|port2_redo
suffix:colon
id|dbg_rh
c_func
(paren
l_string|&quot;Doing reset of port 2&quot;
)paren
suffix:semicolon
op_star
id|R_USB_COMMAND
op_assign
id|IO_STATE
c_func
(paren
id|R_USB_COMMAND
comma
id|port_cmd
comma
id|reset
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_USB_COMMAND
comma
id|port_sel
comma
id|port2
)paren
suffix:semicolon
multiline_comment|/* We must once again wait at least 10ms for the device to recover */
id|port2_retry
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
(paren
op_star
(paren
(paren
r_volatile
id|__u16
op_star
)paren
op_amp
id|hc-&gt;rh.prev_wPortStatus_2
)paren
)paren
op_amp
id|IO_STATE
c_func
(paren
id|R_USB_RH_PORT_STATUS_2
comma
id|enabled
comma
id|yes
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port2_retry
op_increment
op_ge
l_int|10000
)paren
(brace
r_goto
id|port2_redo
suffix:semicolon
)brace
)brace
multiline_comment|/* This only seems to work if we use printk,&n;&t;&t;&t;&t;   not even schedule() works !!! WHY ?? */
id|udelay
c_func
(paren
l_int|15000
)paren
suffix:semicolon
)brace
multiline_comment|/* Try to bring the HC into running state */
op_star
id|R_USB_COMMAND
op_assign
id|IO_STATE
c_func
(paren
id|R_USB_COMMAND
comma
id|ctrl_cmd
comma
id|host_run
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|R_USB_COMMAND
op_amp
id|IO_MASK
c_func
(paren
id|R_USB_COMMAND
comma
id|busy
)paren
)paren
suffix:semicolon
id|dbg_rh
c_func
(paren
l_string|&quot;...Done&quot;
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_PORT_POWER
)paren
suffix:colon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* port power ** */
r_case
(paren
id|RH_PORT_ENABLE
)paren
suffix:colon
multiline_comment|/* There is no rh port enable command in the Etrax USB interface!!!! */
id|OK
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_SET_ADDRESS
suffix:colon
id|hc-&gt;rh.devnum
op_assign
id|wValue
suffix:semicolon
id|dbg_rh
c_func
(paren
l_string|&quot;RH address set to: %d&quot;
comma
id|hc-&gt;rh.devnum
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|RH_GET_DESCRIPTOR
suffix:colon
r_switch
c_cond
(paren
(paren
id|wValue
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
)paren
(brace
r_case
(paren
l_int|0x01
)paren
suffix:colon
multiline_comment|/* device descriptor */
id|len
op_assign
id|min_t
c_func
(paren
r_int
r_int
comma
id|leni
comma
id|min_t
c_func
(paren
r_int
r_int
comma
r_sizeof
(paren
id|root_hub_dev_des
)paren
comma
id|wLength
)paren
)paren
suffix:semicolon
id|memcpy
(paren
id|data
comma
id|root_hub_dev_des
comma
id|len
)paren
suffix:semicolon
id|OK
(paren
id|len
)paren
suffix:semicolon
r_case
(paren
l_int|0x02
)paren
suffix:colon
multiline_comment|/* configuration descriptor */
id|len
op_assign
id|min_t
c_func
(paren
r_int
r_int
comma
id|leni
comma
id|min_t
c_func
(paren
r_int
r_int
comma
r_sizeof
(paren
id|root_hub_config_des
)paren
comma
id|wLength
)paren
)paren
suffix:semicolon
id|memcpy
(paren
id|data
comma
id|root_hub_config_des
comma
id|len
)paren
suffix:semicolon
id|OK
(paren
id|len
)paren
suffix:semicolon
r_case
(paren
l_int|0x03
)paren
suffix:colon
multiline_comment|/* string descriptors */
id|len
op_assign
id|usb_root_hub_string
(paren
id|wValue
op_amp
l_int|0xff
comma
l_int|0xff
comma
l_string|&quot;ETRAX 100LX&quot;
comma
id|data
comma
id|wLength
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|OK
c_func
(paren
id|min_t
c_func
(paren
r_int
comma
id|leni
comma
id|len
)paren
)paren
suffix:semicolon
)brace
r_else
id|stat
op_assign
op_minus
id|EPIPE
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_GET_DESCRIPTOR
op_or
id|RH_CLASS
suffix:colon
id|root_hub_hub_des
(braket
l_int|2
)braket
op_assign
id|hc-&gt;rh.numports
suffix:semicolon
id|len
op_assign
id|min_t
c_func
(paren
r_int
r_int
comma
id|leni
comma
id|min_t
c_func
(paren
r_int
r_int
comma
r_sizeof
(paren
id|root_hub_hub_des
)paren
comma
id|wLength
)paren
)paren
suffix:semicolon
id|memcpy
(paren
id|data
comma
id|root_hub_hub_des
comma
id|len
)paren
suffix:semicolon
id|OK
(paren
id|len
)paren
suffix:semicolon
r_case
id|RH_GET_CONFIGURATION
suffix:colon
op_star
(paren
id|__u8
op_star
)paren
id|data
op_assign
l_int|0x01
suffix:semicolon
id|OK
(paren
l_int|1
)paren
suffix:semicolon
r_case
id|RH_SET_CONFIGURATION
suffix:colon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_default
suffix:colon
id|stat
op_assign
op_minus
id|EPIPE
suffix:semicolon
)brace
id|urb-&gt;actual_length
op_assign
id|len
suffix:semicolon
id|urb-&gt;status
op_assign
id|stat
suffix:semicolon
id|urb-&gt;dev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;complete
)paren
(brace
id|urb-&gt;complete
(paren
id|urb
)paren
suffix:semicolon
)brace
id|DBFEXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|etrax_usb_hc_init
r_static
r_int
id|__init
id|etrax_usb_hc_init
c_func
(paren
r_void
)paren
(brace
r_static
id|etrax_hc_t
op_star
id|hc
suffix:semicolon
r_struct
id|usb_bus
op_star
id|bus
suffix:semicolon
r_struct
id|usb_device
op_star
id|usb_rh
suffix:semicolon
id|DBFENTER
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;ETRAX 100LX USB-HCD %s (c) 2001 Axis Communications AB&bslash;n&quot;
comma
id|usb_hcd_version
)paren
suffix:semicolon
id|hc
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|etrax_hc_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
multiline_comment|/* We use kmem_cache_* to make sure that all DMA desc. are dword aligned */
id|usb_desc_cache
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;usb_desc_cache&quot;
comma
r_sizeof
(paren
id|USB_EP_Desc_t
)paren
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|usb_desc_cache
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;USB Desc Cache allocation failed !!!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|etrax_usb_bus
op_assign
id|bus
op_assign
id|usb_alloc_bus
c_func
(paren
op_amp
id|etrax_usb_device_operations
)paren
suffix:semicolon
id|hc-&gt;bus
op_assign
id|bus
suffix:semicolon
id|bus-&gt;hcpriv
op_assign
id|hc
suffix:semicolon
multiline_comment|/* Initalize RH to the default address.&n;&t;   And make sure that we have no status change indication */
id|hc-&gt;rh.numports
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* The RH has two ports */
id|hc-&gt;rh.devnum
op_assign
l_int|0
suffix:semicolon
id|hc-&gt;rh.wPortChange_1
op_assign
l_int|0
suffix:semicolon
id|hc-&gt;rh.wPortChange_2
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Also initate the previous values to zero */
id|hc-&gt;rh.prev_wPortStatus_1
op_assign
l_int|0
suffix:semicolon
id|hc-&gt;rh.prev_wPortStatus_2
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Initialize the intr-traffic flags */
id|hc-&gt;intr.sleeping
op_assign
l_int|0
suffix:semicolon
id|hc-&gt;intr.wq
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Initially all ep&squot;s are free except ep 0 */
id|ep_usage_bitmask
op_assign
l_int|0
suffix:semicolon
id|set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|ep_usage_bitmask
)paren
suffix:semicolon
id|ep_really_active
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|URB_List
comma
l_int|0
comma
r_sizeof
(paren
id|URB_List
)paren
)paren
suffix:semicolon
multiline_comment|/* This code should really be moved */
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|USB_TX_DMA_NBR
comma
l_string|&quot;ETRAX 100LX built-in USB (Tx)&quot;
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Could not allocate DMA ch 8 for USB&quot;
)paren
suffix:semicolon
id|etrax_usb_hc_cleanup
c_func
(paren
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|USB_RX_DMA_NBR
comma
l_string|&quot;ETRAX 100LX built-in USB (Rx)&quot;
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Could not allocate DMA ch 9 for USB&quot;
)paren
suffix:semicolon
id|etrax_usb_hc_cleanup
c_func
(paren
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#if 0  /* Moved to head.S */
op_star
id|R_GEN_CONFIG
op_assign
id|genconfig_shadow
op_assign
(paren
id|genconfig_shadow
op_amp
op_complement
(paren
id|IO_MASK
c_func
(paren
id|R_GEN_CONFIG
comma
id|usb1
)paren
op_or
id|IO_MASK
c_func
(paren
id|R_GEN_CONFIG
comma
id|usb2
)paren
op_or
id|IO_MASK
c_func
(paren
id|R_GEN_CONFIG
comma
id|dma8
)paren
op_or
id|IO_MASK
c_func
(paren
id|R_GEN_CONFIG
comma
id|dma9
)paren
)paren
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|dma8
comma
id|usb
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|dma9
comma
id|usb
)paren
macro_line|#ifdef CONFIG_ETRAX_USB_HOST_PORT1
op_or
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|usb1
comma
id|select
)paren
macro_line|#endif
macro_line|#ifdef CONFIG_ETRAX_USB_HOST_PORT2
op_or
id|IO_STATE
c_func
(paren
id|R_GEN_CONFIG
comma
id|usb2
comma
id|select
)paren
macro_line|#endif
suffix:semicolon
macro_line|#endif
id|usb_register_bus
c_func
(paren
id|hc-&gt;bus
)paren
suffix:semicolon
multiline_comment|/* We may have to set more bits, but these are the obvious ones */
op_star
id|R_IRQ_MASK2_SET
op_assign
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_SET
comma
id|dma8_sub0_descr
comma
id|set
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_SET
comma
id|dma8_sub1_descr
comma
id|set
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_SET
comma
id|dma8_sub2_descr
comma
id|set
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_SET
comma
id|dma8_sub3_descr
comma
id|set
)paren
suffix:semicolon
op_star
id|R_IRQ_MASK2_SET
op_assign
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_SET
comma
id|dma9_eop
comma
id|set
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_SET
comma
id|dma9_descr
comma
id|set
)paren
suffix:semicolon
op_star
id|R_USB_IRQ_MASK_SET
op_assign
id|IO_STATE
c_func
(paren
id|R_USB_IRQ_MASK_SET
comma
id|ctl_status
comma
id|set
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_USB_IRQ_MASK_SET
comma
id|ctl_eot
comma
id|set
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_USB_IRQ_MASK_SET
comma
id|bulk_eot
comma
id|set
)paren
op_or
macro_line|#ifdef ETRAX_USB_INTR_IRQ
id|IO_STATE
c_func
(paren
id|R_USB_IRQ_MASK_SET
comma
id|intr_eot
comma
id|set
)paren
op_or
macro_line|#endif
id|IO_STATE
c_func
(paren
id|R_USB_IRQ_MASK_SET
comma
id|epid_attn
comma
id|set
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_USB_IRQ_MASK_SET
comma
id|port_status
comma
id|set
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|ETRAX_USB_HC_IRQ
comma
id|etrax_usb_hc_intr_top_half
comma
l_int|0
comma
l_string|&quot;ETRAX 100LX built-in USB (HC)&quot;
comma
id|hc
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Could not allocate IRQ %d for USB&quot;
comma
id|ETRAX_USB_HC_IRQ
)paren
suffix:semicolon
id|etrax_usb_hc_cleanup
c_func
(paren
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|ETRAX_USB_RX_IRQ
comma
id|etrax_usb_rx_interrupt
comma
l_int|0
comma
l_string|&quot;ETRAX 100LX built-in USB (Rx)&quot;
comma
id|hc
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Could not allocate IRQ %d for USB&quot;
comma
id|ETRAX_USB_RX_IRQ
)paren
suffix:semicolon
id|etrax_usb_hc_cleanup
c_func
(paren
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|ETRAX_USB_TX_IRQ
comma
id|etrax_usb_tx_interrupt
comma
l_int|0
comma
l_string|&quot;ETRAX 100LX built-in USB (Tx)&quot;
comma
id|hc
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Could not allocate IRQ %d for USB&quot;
comma
id|ETRAX_USB_TX_IRQ
)paren
suffix:semicolon
id|etrax_usb_hc_cleanup
c_func
(paren
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Reset the USB interface (configures as HC) */
op_star
id|R_USB_COMMAND
op_assign
id|IO_STATE
c_func
(paren
id|R_USB_COMMAND
comma
id|ctrl_cmd
comma
id|reset
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_USB_COMMAND
comma
id|port_cmd
comma
id|reset
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|R_USB_COMMAND
op_amp
id|IO_MASK
c_func
(paren
id|R_USB_COMMAND
comma
id|busy
)paren
)paren
suffix:semicolon
macro_line|#if 1
multiline_comment|/* Initate PSTART to all unallocatable bit times */
op_star
id|R_USB_FM_PSTART
op_assign
id|IO_FIELD
c_func
(paren
id|R_USB_FM_PSTART
comma
id|value
comma
l_int|10000
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ETRAX_USB_HOST_PORT1
op_star
id|R_USB_PORT1_DISABLE
op_assign
id|IO_STATE
c_func
(paren
id|R_USB_PORT1_DISABLE
comma
id|disable
comma
id|no
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ETRAX_USB_HOST_PORT2
op_star
id|R_USB_PORT2_DISABLE
op_assign
id|IO_STATE
c_func
(paren
id|R_USB_PORT2_DISABLE
comma
id|disable
comma
id|no
)paren
suffix:semicolon
macro_line|#endif
op_star
id|R_USB_COMMAND
op_assign
id|IO_STATE
c_func
(paren
id|R_USB_COMMAND
comma
id|ctrl_cmd
comma
id|host_config
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_USB_COMMAND
comma
id|port_cmd
comma
id|reset
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|R_USB_COMMAND
op_amp
id|IO_MASK
c_func
(paren
id|R_USB_COMMAND
comma
id|busy
)paren
)paren
suffix:semicolon
op_star
id|R_USB_COMMAND
op_assign
id|IO_STATE
c_func
(paren
id|R_USB_COMMAND
comma
id|port_sel
comma
id|port1
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_USB_COMMAND
comma
id|port_cmd
comma
id|reset
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|R_USB_COMMAND
op_amp
id|IO_MASK
c_func
(paren
id|R_USB_COMMAND
comma
id|busy
)paren
)paren
suffix:semicolon
multiline_comment|/* Here we must wait at least 10ms so the device has time to recover */
id|udelay
c_func
(paren
l_int|15000
)paren
suffix:semicolon
id|init_rx_buffers
c_func
(paren
)paren
suffix:semicolon
id|init_tx_bulk_ep
c_func
(paren
)paren
suffix:semicolon
id|init_tx_ctrl_ep
c_func
(paren
)paren
suffix:semicolon
id|init_tx_intr_ep
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* This works. It seems like the host_run command only has effect when a device is connected,&n;&t; i.e. it has to be done when a interrup */
op_star
id|R_USB_COMMAND
op_assign
id|IO_STATE
c_func
(paren
id|R_USB_COMMAND
comma
id|ctrl_cmd
comma
id|host_run
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|R_USB_COMMAND
op_amp
id|IO_MASK
c_func
(paren
id|R_USB_COMMAND
comma
id|busy
)paren
)paren
suffix:semicolon
id|usb_rh
op_assign
id|usb_alloc_dev
c_func
(paren
l_int|NULL
comma
id|hc-&gt;bus
)paren
suffix:semicolon
id|hc-&gt;bus-&gt;root_hub
op_assign
id|usb_rh
suffix:semicolon
id|usb_connect
c_func
(paren
id|usb_rh
)paren
suffix:semicolon
id|usb_new_device
c_func
(paren
id|usb_rh
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|etrax_usb_hc_cleanup
r_static
r_void
id|etrax_usb_hc_cleanup
c_func
(paren
r_void
)paren
(brace
id|DBFENTER
suffix:semicolon
id|free_irq
c_func
(paren
id|ETRAX_USB_HC_IRQ
comma
l_int|NULL
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|ETRAX_USB_RX_IRQ
comma
l_int|NULL
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|ETRAX_USB_TX_IRQ
comma
l_int|NULL
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|USB_TX_DMA_NBR
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|USB_RX_DMA_NBR
)paren
suffix:semicolon
id|usb_deregister_bus
c_func
(paren
id|etrax_usb_bus
)paren
suffix:semicolon
id|DBFEXIT
suffix:semicolon
)brace
DECL|variable|etrax_usb_hc_init
id|module_init
c_func
(paren
id|etrax_usb_hc_init
)paren
suffix:semicolon
DECL|variable|etrax_usb_hc_cleanup
id|module_exit
c_func
(paren
id|etrax_usb_hc_cleanup
)paren
suffix:semicolon
eof
