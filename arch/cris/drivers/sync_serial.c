multiline_comment|/*  &n; * Simple synchronous serial port driver for ETRAX 100LX.&n; *&n; * Synchronous serial ports are used for continous streamed data like audio.&n; * The default setting for this driver is compatible with the STA 013 MP3&n; * decoder. The driver can easily be tuned to fit other audio encoder/decoders&n; * and SPI&n; *&n; * Copyright (c) 2001 Axis Communications AB&n; * &n; * Author: Mikael Starvik &n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/svinto.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/sync_serial.h&gt;
multiline_comment|/* The receiver is a bit tricky beacuse of the continous stream of data. */
multiline_comment|/*                                                                       */
multiline_comment|/* Two DMA descriptors are linked together. Each DMA descriptor is       */
multiline_comment|/* responsible for one half of a common buffer.                          */
multiline_comment|/*                                                                       */
multiline_comment|/* ------------------------------                                        */
multiline_comment|/* |   ----------   ----------&t;|                                        */
multiline_comment|/* --&gt; | Descr1 |--&gt;| Descr2 |---                                        */
multiline_comment|/*     ----------   ----------                                           */
multiline_comment|/*         |            |                                                */
multiline_comment|/*         v            v                                                */
multiline_comment|/*   -----------------------------                                       */
multiline_comment|/*   |        BUFFER             |                                       */
multiline_comment|/*   -----------------------------                                       */
multiline_comment|/*      |             |                                                  */
multiline_comment|/*    readp          writep                                              */
multiline_comment|/*                                                                       */
multiline_comment|/* If the application keeps up the pace readp will be right after writep.*/
multiline_comment|/* If the application can&squot;t keep the pace we have to throw away data.    */
multiline_comment|/* The idea is that readp should be ready with the data pointed out by&t; */
multiline_comment|/* Descr1 when the DMA has filled in Descr2. Otherwise we will discard&t; */
multiline_comment|/* the rest of the data pointed out by Descr1 and set readp to the start */
multiline_comment|/* of Descr2                                                             */
DECL|macro|SYNC_SERIAL_MAJOR
mdefine_line|#define SYNC_SERIAL_MAJOR 125
multiline_comment|/* IN_BUFFER_SIZE should be a multiple of 6 to make sure that 24 bit */
multiline_comment|/* words can be handled */
DECL|macro|IN_BUFFER_SIZE
mdefine_line|#define IN_BUFFER_SIZE 12288
DECL|macro|OUT_BUFFER_SIZE
mdefine_line|#define OUT_BUFFER_SIZE 4096
DECL|macro|DEFAULT_FRAME_RATE
mdefine_line|#define DEFAULT_FRAME_RATE 0
DECL|macro|DEFAULT_WORD_RATE
mdefine_line|#define DEFAULT_WORD_RATE 7
DECL|macro|DEBUG
mdefine_line|#define DEBUG(x) 
multiline_comment|/* Define some macros to access ETRAX 100 registers */
DECL|macro|SETF
mdefine_line|#define SETF(var, reg, field, val) var = (var &amp; ~IO_MASK(##reg##, field)) | &bslash;&n;&t;&t;&t;&t;&t;  IO_FIELD(##reg##, field, val)
DECL|macro|SETS
mdefine_line|#define SETS(var, reg, field, val) var = (var &amp; ~IO_MASK(##reg##, field)) | &bslash;&n;&t;&t;&t;&t;&t;  IO_STATE(##reg##, field, val)
DECL|struct|sync_port
r_typedef
r_struct
id|sync_port
(brace
multiline_comment|/* Etrax registers and bits*/
DECL|member|status
r_volatile
r_int
op_star
r_const
id|status
suffix:semicolon
DECL|member|ctrl_data
r_volatile
r_int
op_star
r_const
id|ctrl_data
suffix:semicolon
DECL|member|output_dma_first
r_volatile
r_int
op_star
r_const
id|output_dma_first
suffix:semicolon
DECL|member|output_dma_cmd
r_volatile
r_int
r_char
op_star
r_const
id|output_dma_cmd
suffix:semicolon
DECL|member|output_dma_clr_irq
r_volatile
r_int
r_char
op_star
r_const
id|output_dma_clr_irq
suffix:semicolon
DECL|member|input_dma_first
r_volatile
r_int
op_star
r_const
id|input_dma_first
suffix:semicolon
DECL|member|input_dma_cmd
r_volatile
r_int
r_char
op_star
r_const
id|input_dma_cmd
suffix:semicolon
DECL|member|input_dma_clr_irq
r_volatile
r_int
r_char
op_star
r_const
id|input_dma_clr_irq
suffix:semicolon
DECL|member|data_out
r_volatile
r_int
op_star
r_const
id|data_out
suffix:semicolon
DECL|member|data_in
r_volatile
r_int
op_star
r_const
id|data_in
suffix:semicolon
DECL|member|data_avail_bit
r_char
id|data_avail_bit
suffix:semicolon
multiline_comment|/* In R_IRQ_MASK1_RD */
DECL|member|transmitter_ready_bit
r_char
id|transmitter_ready_bit
suffix:semicolon
multiline_comment|/* In R_IRQ_MASK1_RD */
DECL|member|ready_irq_bit
r_char
id|ready_irq_bit
suffix:semicolon
multiline_comment|/* In R_IRQ_MASK1_SET and R_IRQ_MASK1_CLR */
DECL|member|input_dma_descr_bit
r_char
id|input_dma_descr_bit
suffix:semicolon
multiline_comment|/* In R_IRQ_MASK2_RD */
DECL|member|output_dma_bit
r_char
id|output_dma_bit
suffix:semicolon
multiline_comment|/* In R_IRQ_MASK2_RD */
DECL|member|enabled
r_int
id|enabled
suffix:semicolon
multiline_comment|/* 1 if port is enabled */
DECL|member|use_dma
r_int
id|use_dma
suffix:semicolon
multiline_comment|/* 1 if port uses dma */
DECL|member|port_nbr
r_int
id|port_nbr
suffix:semicolon
multiline_comment|/* Port 0 or 1 */
DECL|member|ctrl_data_shadow
r_int
id|ctrl_data_shadow
suffix:semicolon
multiline_comment|/* Register shadow */
DECL|member|busy
r_char
id|busy
suffix:semicolon
multiline_comment|/* 1 if port is busy */
DECL|member|out_wait_q
id|wait_queue_head_t
id|out_wait_q
suffix:semicolon
DECL|member|in_wait_q
id|wait_queue_head_t
id|in_wait_q
suffix:semicolon
DECL|member|out_descr
r_struct
id|etrax_dma_descr
id|out_descr
suffix:semicolon
DECL|member|in_descr1
r_struct
id|etrax_dma_descr
id|in_descr1
suffix:semicolon
DECL|member|in_descr2
r_struct
id|etrax_dma_descr
id|in_descr2
suffix:semicolon
DECL|member|out_buffer
r_char
id|out_buffer
(braket
id|OUT_BUFFER_SIZE
)braket
suffix:semicolon
DECL|member|out_count
r_int
id|out_count
suffix:semicolon
multiline_comment|/* Remaining bytes for current transfer */
DECL|member|outp
r_char
op_star
id|outp
suffix:semicolon
multiline_comment|/* Current position in out_buffer */
DECL|member|in_buffer
r_char
id|in_buffer
(braket
id|IN_BUFFER_SIZE
)braket
suffix:semicolon
DECL|member|readp
r_volatile
r_char
op_star
id|readp
suffix:semicolon
multiline_comment|/* Next byte to be read by application */
DECL|member|writep
r_volatile
r_char
op_star
id|writep
suffix:semicolon
multiline_comment|/* Next byte to be written by etrax */
DECL|member|odd_output
r_int
id|odd_output
suffix:semicolon
multiline_comment|/* 1 if writing odd nible in 12 bit mode */
DECL|member|odd_input
r_int
id|odd_input
suffix:semicolon
multiline_comment|/* 1 if reading odd nible in 12 bit mode */
DECL|typedef|sync_port
)brace
id|sync_port
suffix:semicolon
r_static
r_int
id|etrax_sync_serial_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|initialize_port
c_func
(paren
r_int
id|portnbr
)paren
suffix:semicolon
r_static
r_int
id|sync_serial_open
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
r_static
r_int
id|sync_serial_release
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
r_static
r_int
id|sync_serial_ioctl
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
id|ssize_t
id|sync_serial_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
r_static
id|ssize_t
id|sync_serial_manual_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
r_static
id|ssize_t
id|sync_serial_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
r_static
r_void
id|send_word
c_func
(paren
id|sync_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|start_dma
c_func
(paren
r_struct
id|sync_port
op_star
id|port
comma
r_const
r_char
op_star
id|data
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_void
id|start_dma_in
c_func
(paren
id|sync_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|tr_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|rx_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|manual_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
multiline_comment|/* The ports */
DECL|variable|ports
r_static
r_struct
id|sync_port
id|ports
(braket
)braket
op_assign
(brace
(brace
id|R_SYNC_SERIAL1_STATUS
comma
multiline_comment|/* status */
id|R_SYNC_SERIAL1_CTRL
comma
multiline_comment|/* ctrl_data */
id|R_DMA_CH8_FIRST
comma
multiline_comment|/* output_dma_first */
id|R_DMA_CH8_CMD
comma
multiline_comment|/* output_dma_cmd */
id|R_DMA_CH8_CLR_INTR
comma
multiline_comment|/* output_dma_clr_irq */
id|R_DMA_CH9_FIRST
comma
multiline_comment|/* input_dma_first */
id|R_DMA_CH9_CMD
comma
multiline_comment|/* input_dma_cmd */
id|R_DMA_CH9_CLR_INTR
comma
multiline_comment|/* input_dma_clr_irq */
id|R_SYNC_SERIAL1_TR_DATA
comma
multiline_comment|/* data_out */
id|R_SYNC_SERIAL1_REC_DATA
comma
multiline_comment|/* data in */
id|IO_BITNR
c_func
(paren
id|R_IRQ_MASK1_RD
comma
id|ser1_data
)paren
comma
multiline_comment|/* data_avail_bit */
id|IO_BITNR
c_func
(paren
id|R_IRQ_MASK1_RD
comma
id|ser1_ready
)paren
comma
multiline_comment|/* transmitter_ready_bit */
id|IO_BITNR
c_func
(paren
id|R_IRQ_MASK1_SET
comma
id|ser1_ready
)paren
comma
multiline_comment|/* ready_irq_bit */
id|IO_BITNR
c_func
(paren
id|R_IRQ_MASK2_RD
comma
id|dma9_descr
)paren
comma
multiline_comment|/* input_dma_descr_bit */
id|IO_BITNR
c_func
(paren
id|R_IRQ_MASK2_RD
comma
id|dma8_eop
)paren
comma
multiline_comment|/* output_dma_bit */
)brace
comma
(brace
id|R_SYNC_SERIAL3_STATUS
comma
multiline_comment|/* status */
id|R_SYNC_SERIAL3_CTRL
comma
multiline_comment|/* ctrl_data */
id|R_DMA_CH4_FIRST
comma
multiline_comment|/* output_dma_first */
id|R_DMA_CH4_CMD
comma
multiline_comment|/* output_dma_cmd */
id|R_DMA_CH4_CLR_INTR
comma
multiline_comment|/* output_dma_clr_irq */
id|R_DMA_CH5_FIRST
comma
multiline_comment|/* input_dma_first */
id|R_DMA_CH5_CMD
comma
multiline_comment|/* input_dma_cmd */
id|R_DMA_CH5_CLR_INTR
comma
multiline_comment|/* input_dma_clr_irq */
id|R_SYNC_SERIAL3_TR_DATA
comma
multiline_comment|/* data_out */
id|R_SYNC_SERIAL3_REC_DATA
comma
multiline_comment|/* data in */
id|IO_BITNR
c_func
(paren
id|R_IRQ_MASK1_RD
comma
id|ser3_data
)paren
comma
multiline_comment|/* data_avail_bit */
id|IO_BITNR
c_func
(paren
id|R_IRQ_MASK1_RD
comma
id|ser3_ready
)paren
comma
multiline_comment|/* transmitter_ready_bit */
id|IO_BITNR
c_func
(paren
id|R_IRQ_MASK1_SET
comma
id|ser3_ready
)paren
comma
multiline_comment|/* ready_irq_bit */
id|IO_BITNR
c_func
(paren
id|R_IRQ_MASK2_RD
comma
id|dma5_descr
)paren
comma
multiline_comment|/* input_dma_descr_bit */
id|IO_BITNR
c_func
(paren
id|R_IRQ_MASK2_RD
comma
id|dma4_eop
)paren
comma
multiline_comment|/* output_dma_bit */
)brace
)brace
suffix:semicolon
multiline_comment|/* Register shadows */
DECL|variable|sync_serial_prescale_shadow
r_static
r_int
id|sync_serial_prescale_shadow
op_assign
l_int|0
suffix:semicolon
DECL|variable|gen_config_ii_shadow
r_static
r_int
id|gen_config_ii_shadow
op_assign
l_int|0
suffix:semicolon
DECL|macro|NUMBER_OF_PORTS
mdefine_line|#define NUMBER_OF_PORTS (sizeof(ports)/sizeof(sync_port))
DECL|variable|sync_serial_fops
r_static
r_struct
id|file_operations
id|sync_serial_fops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|write
suffix:colon
id|sync_serial_write
comma
id|read
suffix:colon
id|sync_serial_read
comma
id|ioctl
suffix:colon
id|sync_serial_ioctl
comma
id|open
suffix:colon
id|sync_serial_open
comma
id|release
suffix:colon
id|sync_serial_release
)brace
suffix:semicolon
DECL|function|etrax_sync_serial_init
r_static
r_int
id|__init
id|etrax_sync_serial_init
c_func
(paren
r_void
)paren
(brace
id|ports
(braket
l_int|0
)braket
dot
id|enabled
op_assign
l_int|0
suffix:semicolon
id|ports
(braket
l_int|1
)braket
dot
id|enabled
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|register_chrdev
c_func
(paren
id|SYNC_SERIAL_MAJOR
comma
l_string|&quot;sync serial&quot;
comma
op_amp
id|sync_serial_fops
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;unable to get major for synchronous serial port&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* Deselect synchronous serial ports */
id|SETS
c_func
(paren
id|gen_config_ii_shadow
comma
id|R_GEN_CONFIG_II
comma
id|sermode1
comma
id|async
)paren
suffix:semicolon
id|SETS
c_func
(paren
id|gen_config_ii_shadow
comma
id|R_GEN_CONFIG_II
comma
id|sermode3
comma
id|async
)paren
suffix:semicolon
id|SETS
c_func
(paren
id|gen_config_ii_shadow
comma
id|R_GEN_CONFIG_II
comma
id|ser3
comma
id|select
)paren
suffix:semicolon
op_star
id|R_GEN_CONFIG_II
op_assign
id|gen_config_ii_shadow
suffix:semicolon
multiline_comment|/* Initialize Ports */
macro_line|#if defined(CONFIG_ETRAX_SYNCHRONOUS_SERIAL_PORT0)
id|ports
(braket
l_int|0
)braket
dot
id|enabled
op_assign
l_int|1
suffix:semicolon
id|SETS
c_func
(paren
id|port_pb_i2c_shadow
comma
id|R_PORT_PB_I2C
comma
id|syncser1
comma
id|ss1extra
)paren
suffix:semicolon
id|SETS
c_func
(paren
id|gen_config_ii_shadow
comma
id|R_GEN_CONFIG_II
comma
id|sermode1
comma
id|sync
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_ETRAX_SYNCHRONOUS_SERIAL0_DMA)
id|ports
(braket
l_int|0
)braket
dot
id|use_dma
op_assign
l_int|1
suffix:semicolon
id|initialize_port
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
l_int|24
comma
id|tr_interrupt
comma
l_int|0
comma
l_string|&quot;synchronous serial 1 dma tr&quot;
comma
op_amp
id|ports
(braket
l_int|0
)braket
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Can&squot;t allocate sync serial port 1 IRQ&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
l_int|25
comma
id|rx_interrupt
comma
l_int|0
comma
l_string|&quot;synchronous serial 1 dma rx&quot;
comma
op_amp
id|ports
(braket
l_int|0
)braket
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Can&squot;t allocate sync serial port 1 IRQ&quot;
)paren
suffix:semicolon
)brace
id|RESET_DMA
c_func
(paren
l_int|8
)paren
suffix:semicolon
id|WAIT_DMA
c_func
(paren
l_int|8
)paren
suffix:semicolon
id|RESET_DMA
c_func
(paren
l_int|9
)paren
suffix:semicolon
id|WAIT_DMA
c_func
(paren
l_int|9
)paren
suffix:semicolon
op_star
id|R_DMA_CH8_CLR_INTR
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH8_CLR_INTR
comma
id|clr_eop
comma
r_do
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_DMA_CH8_CLR_INTR
comma
id|clr_descr
comma
r_do
)paren
suffix:semicolon
op_star
id|R_DMA_CH9_CLR_INTR
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH9_CLR_INTR
comma
id|clr_eop
comma
r_do
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_DMA_CH9_CLR_INTR
comma
id|clr_descr
comma
r_do
)paren
suffix:semicolon
op_star
id|R_IRQ_MASK2_SET
op_assign
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_SET
comma
id|dma8_eop
comma
id|set
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_SET
comma
id|dma8_descr
comma
id|set
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_SET
comma
id|dma9_descr
comma
id|set
)paren
suffix:semicolon
id|start_dma_in
c_func
(paren
op_amp
id|ports
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#else
id|ports
(braket
l_int|0
)braket
dot
id|use_dma
op_assign
l_int|0
suffix:semicolon
id|initialize_port
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
l_int|8
comma
id|manual_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;synchronous serial manual irq&quot;
comma
op_amp
id|ports
(braket
l_int|0
)braket
)paren
)paren
id|panic
c_func
(paren
l_string|&quot;Can&squot;t allocate sync serial manual irq&quot;
)paren
suffix:semicolon
op_star
id|R_IRQ_MASK1_SET
op_assign
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK1_SET
comma
id|ser1_data
comma
id|set
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
macro_line|#if defined(CONFIG_ETRAX_SYNCHRONOUS_SERIAL_PORT1)
id|ports
(braket
l_int|1
)braket
dot
id|enabled
op_assign
l_int|1
suffix:semicolon
id|SETS
c_func
(paren
id|port_pb_i2c_shadow
comma
id|R_PORT_PB_I2C
comma
id|syncser3
comma
id|ss3extra
)paren
suffix:semicolon
id|SETS
c_func
(paren
id|gen_config_ii_shadow
comma
id|R_GEN_CONFIG_II
comma
id|sermode3
comma
id|sync
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_ETRAX_SYNCHRONOUS_SERIAL1_DMA)
id|ports
(braket
l_int|1
)braket
dot
id|use_dma
op_assign
l_int|1
suffix:semicolon
id|initialize_port
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
l_int|20
comma
id|tr_interrupt
comma
l_int|0
comma
l_string|&quot;synchronous serial 3 dma tr&quot;
comma
op_amp
id|ports
(braket
l_int|1
)braket
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Can&squot;t allocate sync serial port 1 IRQ&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
l_int|21
comma
id|rx_interrupt
comma
l_int|0
comma
l_string|&quot;synchronous serial 3 dma rx&quot;
comma
op_amp
id|ports
(braket
l_int|1
)braket
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Can&squot;t allocate sync serial port 1 IRQ&quot;
)paren
suffix:semicolon
)brace
id|RESET_DMA
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|WAIT_DMA
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|RESET_DMA
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|WAIT_DMA
c_func
(paren
l_int|5
)paren
suffix:semicolon
op_star
id|R_DMA_CH4_CLR_INTR
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH4_CLR_INTR
comma
id|clr_eop
comma
r_do
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_DMA_CH4_CLR_INTR
comma
id|clr_descr
comma
r_do
)paren
suffix:semicolon
op_star
id|R_DMA_CH5_CLR_INTR
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH5_CLR_INTR
comma
id|clr_eop
comma
r_do
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_DMA_CH5_CLR_INTR
comma
id|clr_descr
comma
r_do
)paren
suffix:semicolon
op_star
id|R_IRQ_MASK2_SET
op_assign
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_SET
comma
id|dma4_eop
comma
id|set
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_SET
comma
id|dma4_descr
comma
id|set
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK2_SET
comma
id|dma5_descr
comma
id|set
)paren
suffix:semicolon
id|start_dma_in
c_func
(paren
op_amp
id|ports
(braket
l_int|1
)braket
)paren
suffix:semicolon
macro_line|#else
id|ports
(braket
l_int|1
)braket
dot
id|use_dma
op_assign
l_int|0
suffix:semicolon
id|initialize_port
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port
(braket
l_int|0
)braket
dot
id|use_dma
)paren
multiline_comment|/* Port 0 uses dma, we must manual allocate IRQ */
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
l_int|8
comma
id|manual_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;synchronous serial manual irq&quot;
comma
op_amp
id|ports
(braket
l_int|1
)braket
)paren
)paren
id|panic
c_func
(paren
l_string|&quot;Can&squot;t allocate sync serial manual irq&quot;
)paren
suffix:semicolon
)brace
op_star
id|R_IRQ_MASK1_SET
op_assign
id|IO_STATE
c_func
(paren
id|R_IRQ_MASK1_SET
comma
id|ser3_data
comma
id|set
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
op_star
id|R_PORT_PB_I2C
op_assign
id|port_pb_i2c_shadow
suffix:semicolon
multiline_comment|/* Use PB4/PB7 */
multiline_comment|/* Set up timing */
op_star
id|R_SYNC_SERIAL_PRESCALE
op_assign
id|sync_serial_prescale_shadow
op_assign
(paren
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL_PRESCALE
comma
id|clk_sel_u1
comma
id|codec
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL_PRESCALE
comma
id|word_stb_sel_u1
comma
id|external
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL_PRESCALE
comma
id|clk_sel_u3
comma
id|codec
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL_PRESCALE
comma
id|word_stb_sel_u3
comma
id|external
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL_PRESCALE
comma
id|prescaler
comma
id|div4
)paren
op_or
id|IO_FIELD
c_func
(paren
id|R_SYNC_SERIAL_PRESCALE
comma
id|frame_rate
comma
id|DEFAULT_FRAME_RATE
)paren
op_or
id|IO_FIELD
c_func
(paren
id|R_SYNC_SERIAL_PRESCALE
comma
id|word_rate
comma
id|DEFAULT_WORD_RATE
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL_PRESCALE
comma
id|warp_mode
comma
id|normal
)paren
)paren
suffix:semicolon
multiline_comment|/* Select synchronous ports */
op_star
id|R_GEN_CONFIG_II
op_assign
id|gen_config_ii_shadow
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ETRAX 100LX synchronous serial port driver&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|initialize_port
r_static
r_void
id|initialize_port
c_func
(paren
r_int
id|portnbr
)paren
(brace
r_struct
id|sync_port
op_star
id|port
op_assign
op_amp
id|ports
(braket
id|portnbr
)braket
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Init sync serial port %d&bslash;n&quot;
comma
id|portnbr
)paren
)paren
suffix:semicolon
id|port-&gt;port_nbr
op_assign
id|portnbr
suffix:semicolon
id|port-&gt;busy
op_assign
l_int|0
suffix:semicolon
id|port-&gt;readp
op_assign
id|port-&gt;in_buffer
suffix:semicolon
id|port-&gt;writep
op_assign
id|port-&gt;in_buffer
op_plus
id|IN_BUFFER_SIZE
op_div
l_int|2
suffix:semicolon
id|port-&gt;odd_input
op_assign
l_int|0
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|port-&gt;out_wait_q
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|port-&gt;in_wait_q
)paren
suffix:semicolon
id|port-&gt;ctrl_data_shadow
op_assign
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|tr_baud
comma
id|c115k2Hz
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|mode
comma
id|master_output
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|error
comma
id|ignore
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|rec_enable
comma
id|disable
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|f_synctype
comma
id|normal
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|f_syncsize
comma
id|word
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|f_sync
comma
id|on
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|clk_mode
comma
id|normal
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|clk_halt
comma
id|stopped
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|bitorder
comma
id|msb
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|tr_enable
comma
id|disable
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|wordsize
comma
id|size8bit
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|buf_empty
comma
id|lmt_8
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|buf_full
comma
id|lmt_8
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|flow_ctrl
comma
id|enabled
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|clk_polarity
comma
id|neg
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|frame_polarity
comma
id|normal
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|status_polarity
comma
id|inverted
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|clk_driver
comma
id|normal
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|frame_driver
comma
id|normal
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|status_driver
comma
id|normal
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|def_out0
comma
id|high
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;use_dma
)paren
id|port-&gt;ctrl_data_shadow
op_or_assign
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|dma_enable
comma
id|on
)paren
suffix:semicolon
r_else
id|port-&gt;ctrl_data_shadow
op_or_assign
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|dma_enable
comma
id|off
)paren
suffix:semicolon
op_star
id|port-&gt;ctrl_data
op_assign
id|port-&gt;ctrl_data_shadow
suffix:semicolon
)brace
DECL|function|sync_serial_open
r_static
r_int
id|sync_serial_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|dev
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Open sync serial port %d&bslash;n&quot;
comma
id|dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|NUMBER_OF_PORTS
op_logical_or
op_logical_neg
id|ports
(braket
id|dev
)braket
dot
id|enabled
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Invalid minor %d&bslash;n&quot;
comma
id|dev
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ports
(braket
id|dev
)braket
dot
id|busy
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Device is busy.. &bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|ports
(braket
id|dev
)braket
dot
id|busy
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sync_serial_release
r_static
r_int
id|sync_serial_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|dev
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|NUMBER_OF_PORTS
op_logical_or
op_logical_neg
id|ports
(braket
id|dev
)braket
dot
id|enabled
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Invalid minor %d&bslash;n&quot;
comma
id|dev
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|ports
(braket
id|dev
)braket
dot
id|busy
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sync_serial_ioctl
r_static
r_int
id|sync_serial_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|return_val
op_assign
l_int|0
suffix:semicolon
r_int
id|dev
op_assign
id|MINOR
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
)paren
suffix:semicolon
id|sync_port
op_star
id|port
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|NUMBER_OF_PORTS
op_logical_or
op_logical_neg
id|ports
(braket
id|dev
)braket
dot
id|enabled
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Invalid minor %d&bslash;n&quot;
comma
id|dev
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|port
op_assign
op_amp
id|ports
(braket
id|dev
)braket
suffix:semicolon
multiline_comment|/* Disable port while changing config */
r_if
c_cond
(paren
id|dev
)paren
(brace
id|RESET_DMA
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|WAIT_DMA
c_func
(paren
l_int|4
)paren
suffix:semicolon
op_star
id|R_DMA_CH4_CLR_INTR
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH4_CLR_INTR
comma
id|clr_eop
comma
r_do
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_DMA_CH4_CLR_INTR
comma
id|clr_descr
comma
r_do
)paren
suffix:semicolon
id|SETS
c_func
(paren
id|gen_config_ii_shadow
comma
id|R_GEN_CONFIG_II
comma
id|sermode3
comma
id|async
)paren
suffix:semicolon
)brace
r_else
(brace
id|RESET_DMA
c_func
(paren
l_int|8
)paren
suffix:semicolon
id|WAIT_DMA
c_func
(paren
l_int|8
)paren
suffix:semicolon
op_star
id|R_DMA_CH8_CLR_INTR
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH8_CLR_INTR
comma
id|clr_eop
comma
r_do
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_DMA_CH8_CLR_INTR
comma
id|clr_descr
comma
r_do
)paren
suffix:semicolon
id|SETS
c_func
(paren
id|gen_config_ii_shadow
comma
id|R_GEN_CONFIG_II
comma
id|sermode1
comma
id|async
)paren
suffix:semicolon
)brace
op_star
id|R_GEN_CONFIG_II
op_assign
id|gen_config_ii_shadow
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SSP_SPEED
suffix:colon
r_if
c_cond
(paren
id|GET_SPEED
c_func
(paren
id|arg
)paren
op_eq
id|CODEC
)paren
(brace
r_if
c_cond
(paren
id|dev
)paren
id|SETS
c_func
(paren
id|sync_serial_prescale_shadow
comma
id|R_SYNC_SERIAL_PRESCALE
comma
id|clk_sel_u3
comma
id|codec
)paren
suffix:semicolon
r_else
id|SETS
c_func
(paren
id|sync_serial_prescale_shadow
comma
id|R_SYNC_SERIAL_PRESCALE
comma
id|clk_sel_u1
comma
id|codec
)paren
suffix:semicolon
id|SETF
c_func
(paren
id|sync_serial_prescale_shadow
comma
id|R_SYNC_SERIAL_PRESCALE
comma
id|prescaler
comma
id|GET_FREQ
c_func
(paren
id|arg
)paren
)paren
suffix:semicolon
id|SETF
c_func
(paren
id|sync_serial_prescale_shadow
comma
id|R_SYNC_SERIAL_PRESCALE
comma
id|frame_rate
comma
id|GET_FRAME_RATE
c_func
(paren
id|arg
)paren
)paren
suffix:semicolon
id|SETF
c_func
(paren
id|sync_serial_prescale_shadow
comma
id|R_SYNC_SERIAL_PRESCALE
comma
id|word_rate
comma
id|GET_WORD_RATE
c_func
(paren
id|arg
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|SETF
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|tr_baud
comma
id|GET_SPEED
c_func
(paren
id|arg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
id|SETS
c_func
(paren
id|sync_serial_prescale_shadow
comma
id|R_SYNC_SERIAL_PRESCALE
comma
id|clk_sel_u3
comma
id|baudrate
)paren
suffix:semicolon
r_else
id|SETS
c_func
(paren
id|sync_serial_prescale_shadow
comma
id|R_SYNC_SERIAL_PRESCALE
comma
id|clk_sel_u1
comma
id|baudrate
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SSP_MODE
suffix:colon
r_if
c_cond
(paren
id|arg
OG
l_int|5
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|SETF
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|mode
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SSP_FRAME_SYNC
suffix:colon
r_if
c_cond
(paren
id|arg
op_amp
id|NORMAL_SYNC
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|f_synctype
comma
id|normal
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|arg
op_amp
id|EARLY_SYNC
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|f_synctype
comma
id|early
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_amp
id|BIT_SYNC
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|f_syncsize
comma
id|bit
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|arg
op_amp
id|WORD_SYNC
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|f_syncsize
comma
id|word
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|arg
op_amp
id|EXTENDED_SYNC
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|f_syncsize
comma
id|extended
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_amp
id|SYNC_ON
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|f_sync
comma
id|on
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|arg
op_amp
id|SYNC_OFF
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|f_sync
comma
id|off
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_amp
id|WORD_SIZE_8
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|wordsize
comma
id|size8bit
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|arg
op_amp
id|WORD_SIZE_12
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|wordsize
comma
id|size12bit
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|arg
op_amp
id|WORD_SIZE_16
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|wordsize
comma
id|size16bit
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|arg
op_amp
id|WORD_SIZE_24
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|wordsize
comma
id|size24bit
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|arg
op_amp
id|WORD_SIZE_32
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|wordsize
comma
id|size32bit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_amp
id|BIT_ORDER_MSB
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|bitorder
comma
id|msb
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|arg
op_amp
id|BIT_ORDER_LSB
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|bitorder
comma
id|lsb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_amp
id|FLOW_CONTROL_ENABLE
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|flow_ctrl
comma
id|enabled
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|arg
op_amp
id|FLOW_CONTROL_DISABLE
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|flow_ctrl
comma
id|disabled
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_amp
id|CLOCK_NOT_GATED
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|clk_mode
comma
id|normal
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|arg
op_amp
id|CLOCK_GATED
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|clk_mode
comma
id|gated
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SSP_IPOLARITY
suffix:colon
r_if
c_cond
(paren
id|arg
op_amp
id|CLOCK_NORMAL
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|clk_polarity
comma
id|neg
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|arg
op_amp
id|CLOCK_INVERT
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|clk_polarity
comma
id|pos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_amp
id|FRAME_NORMAL
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|frame_polarity
comma
id|normal
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|arg
op_amp
id|FRAME_INVERT
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|frame_polarity
comma
id|inverted
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_amp
id|STATUS_NORMAL
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|status_polarity
comma
id|normal
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|arg
op_amp
id|STATUS_INVERT
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|status_polarity
comma
id|inverted
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SSP_OPOLARITY
suffix:colon
r_if
c_cond
(paren
id|arg
op_amp
id|CLOCK_NORMAL
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|clk_driver
comma
id|normal
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|arg
op_amp
id|CLOCK_INVERT
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|clk_driver
comma
id|inverted
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_amp
id|FRAME_NORMAL
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|frame_driver
comma
id|normal
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|arg
op_amp
id|FRAME_INVERT
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|frame_driver
comma
id|inverted
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_amp
id|STATUS_NORMAL
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|status_driver
comma
id|normal
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|arg
op_amp
id|STATUS_INVERT
)paren
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|status_driver
comma
id|inverted
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SSP_SPI
suffix:colon
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|flow_ctrl
comma
id|disabled
)paren
suffix:semicolon
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|bitorder
comma
id|msb
)paren
suffix:semicolon
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|wordsize
comma
id|size8bit
)paren
suffix:semicolon
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|f_sync
comma
id|on
)paren
suffix:semicolon
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|f_syncsize
comma
id|word
)paren
suffix:semicolon
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|f_synctype
comma
id|normal
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_amp
id|SPI_SLAVE
)paren
(brace
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|frame_polarity
comma
id|inverted
)paren
suffix:semicolon
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|clk_polarity
comma
id|neg
)paren
suffix:semicolon
id|SETF
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|mode
comma
id|SLAVE_INPUT
)paren
suffix:semicolon
)brace
r_else
(brace
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|frame_driver
comma
id|inverted
)paren
suffix:semicolon
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|clk_driver
comma
id|inverted
)paren
suffix:semicolon
id|SETF
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|mode
comma
id|MASTER_OUTPUT
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|return_val
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Set config and enable port */
op_star
id|port-&gt;ctrl_data
op_assign
id|port-&gt;ctrl_data_shadow
suffix:semicolon
op_star
id|R_SYNC_SERIAL_PRESCALE
op_assign
id|sync_serial_prescale_shadow
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
id|SETS
c_func
(paren
id|gen_config_ii_shadow
comma
id|R_GEN_CONFIG_II
comma
id|sermode3
comma
id|sync
)paren
suffix:semicolon
r_else
id|SETS
c_func
(paren
id|gen_config_ii_shadow
comma
id|R_GEN_CONFIG_II
comma
id|sermode1
comma
id|sync
)paren
suffix:semicolon
op_star
id|R_GEN_CONFIG_II
op_assign
id|gen_config_ii_shadow
suffix:semicolon
r_return
id|return_val
suffix:semicolon
)brace
DECL|function|sync_serial_manual_write
r_static
id|ssize_t
id|sync_serial_manual_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
id|dev
op_assign
id|MINOR
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
)paren
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|sync_port
op_star
id|port
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|NUMBER_OF_PORTS
op_logical_or
op_logical_neg
id|ports
(braket
id|dev
)braket
dot
id|enabled
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Invalid minor %d&bslash;n&quot;
comma
id|dev
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|port
op_assign
op_amp
id|ports
(braket
id|dev
)braket
suffix:semicolon
id|copy_from_user
c_func
(paren
id|port-&gt;out_buffer
comma
id|buf
comma
id|count
)paren
suffix:semicolon
id|port-&gt;outp
op_assign
id|port-&gt;out_buffer
suffix:semicolon
id|port-&gt;out_count
op_assign
id|count
suffix:semicolon
id|port-&gt;odd_output
op_assign
l_int|1
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|port-&gt;out_wait_q
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
op_star
id|R_IRQ_MASK1_SET
op_assign
l_int|1
op_lshift
id|port-&gt;ready_irq_bit
suffix:semicolon
multiline_comment|/* transmitter ready IRQ on */
id|send_word
c_func
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/* Start sender by sending first word */
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|port-&gt;out_wait_q
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
DECL|function|sync_serial_write
r_static
id|ssize_t
id|sync_serial_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
id|dev
op_assign
id|MINOR
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
)paren
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|sync_port
op_star
id|port
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|NUMBER_OF_PORTS
op_logical_or
op_logical_neg
id|ports
(braket
id|dev
)braket
dot
id|enabled
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Invalid minor %d&bslash;n&quot;
comma
id|dev
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|port
op_assign
op_amp
id|ports
(braket
id|dev
)braket
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Write dev %d count %d&bslash;n&quot;
comma
id|port-&gt;port_nbr
comma
id|count
)paren
)paren
suffix:semicolon
id|count
op_assign
id|count
OG
id|OUT_BUFFER_SIZE
ques
c_cond
id|OUT_BUFFER_SIZE
suffix:colon
id|count
suffix:semicolon
multiline_comment|/* Make sure transmitter is running */
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|clk_halt
comma
id|running
)paren
suffix:semicolon
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|tr_enable
comma
id|enable
)paren
suffix:semicolon
op_star
id|port-&gt;ctrl_data
op_assign
id|port-&gt;ctrl_data_shadow
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;use_dma
)paren
(brace
r_return
id|sync_serial_manual_write
c_func
(paren
id|file
comma
id|buf
comma
id|count
comma
id|ppos
)paren
suffix:semicolon
)brace
id|copy_from_user
c_func
(paren
id|port-&gt;out_buffer
comma
id|buf
comma
id|count
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|port-&gt;out_wait_q
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|start_dma
c_func
(paren
id|port
comma
id|buf
comma
id|count
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|port-&gt;out_wait_q
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
DECL|function|sync_serial_read
r_static
id|ssize_t
id|sync_serial_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
id|dev
op_assign
id|MINOR
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
)paren
suffix:semicolon
r_int
id|avail
suffix:semicolon
id|sync_port
op_star
id|port
suffix:semicolon
r_char
op_star
id|start
suffix:semicolon
r_char
op_star
id|end
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|NUMBER_OF_PORTS
op_logical_or
op_logical_neg
id|ports
(braket
id|dev
)braket
dot
id|enabled
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Invalid minor %d&bslash;n&quot;
comma
id|dev
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|port
op_assign
op_amp
id|ports
(braket
id|dev
)braket
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Read dev %d count %d&bslash;n&quot;
comma
id|dev
comma
id|count
)paren
)paren
suffix:semicolon
multiline_comment|/* Make sure receiver is running */
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|clk_halt
comma
id|running
)paren
suffix:semicolon
id|SETS
c_func
(paren
id|port-&gt;ctrl_data_shadow
comma
id|R_SYNC_SERIAL1_CTRL
comma
id|rec_enable
comma
id|enable
)paren
suffix:semicolon
op_star
id|port-&gt;ctrl_data
op_assign
id|port-&gt;ctrl_data_shadow
suffix:semicolon
multiline_comment|/* Calculate number of available bytes */
r_while
c_loop
(paren
id|port-&gt;readp
op_eq
id|port-&gt;writep
)paren
multiline_comment|/* No data */
(brace
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|port-&gt;in_wait_q
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
)brace
multiline_comment|/* Save pointers to avoid that they are modified by interrupt */
id|start
op_assign
id|port-&gt;readp
suffix:semicolon
id|end
op_assign
id|port-&gt;writep
suffix:semicolon
multiline_comment|/* Lazy read, never return wrapped data. */
r_if
c_cond
(paren
id|end
OG
id|start
)paren
id|avail
op_assign
id|end
op_minus
id|start
suffix:semicolon
r_else
id|avail
op_assign
id|port-&gt;in_buffer
op_plus
id|IN_BUFFER_SIZE
op_minus
id|start
suffix:semicolon
id|count
op_assign
id|count
OG
id|avail
ques
c_cond
id|avail
suffix:colon
id|count
suffix:semicolon
id|copy_to_user
c_func
(paren
id|buf
comma
id|start
comma
id|count
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts while updating readp */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|port-&gt;readp
op_add_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;readp
op_eq
id|port-&gt;in_buffer
op_plus
id|IN_BUFFER_SIZE
)paren
multiline_comment|/* Wrap? */
id|port-&gt;readp
op_assign
id|port-&gt;in_buffer
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%d bytes read&bslash;n&quot;
comma
id|count
)paren
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|send_word
r_static
r_void
id|send_word
c_func
(paren
id|sync_port
op_star
id|port
)paren
(brace
r_switch
c_cond
(paren
id|port-&gt;ctrl_data_shadow
op_amp
id|IO_MASK
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|wordsize
)paren
)paren
(brace
r_case
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|wordsize
comma
id|size8bit
)paren
suffix:colon
id|port-&gt;out_count
op_decrement
suffix:semicolon
op_star
id|port-&gt;data_out
op_assign
op_star
id|port-&gt;outp
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|wordsize
comma
id|size12bit
)paren
suffix:colon
id|port-&gt;out_count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;odd_output
)paren
op_star
id|port-&gt;data_out
op_assign
(paren
(paren
op_star
id|port-&gt;outp
)paren
op_lshift
l_int|16
)paren
op_or
(paren
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|port-&gt;outp
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_else
op_star
id|port-&gt;data_out
op_assign
(paren
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|port-&gt;outp
)paren
op_lshift
l_int|8
)paren
op_or
(paren
op_star
(paren
id|port-&gt;outp
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|port-&gt;odd_output
op_assign
op_logical_neg
id|port-&gt;odd_output
suffix:semicolon
id|port-&gt;outp
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|wordsize
comma
id|size16bit
)paren
suffix:colon
id|port-&gt;out_count
op_sub_assign
l_int|2
suffix:semicolon
op_star
id|port-&gt;data_out
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
id|port-&gt;outp
suffix:semicolon
id|port-&gt;outp
op_add_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|wordsize
comma
id|size24bit
)paren
suffix:colon
id|port-&gt;out_count
op_sub_assign
l_int|3
suffix:semicolon
op_star
id|port-&gt;data_out
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
id|port-&gt;outp
suffix:semicolon
id|port-&gt;outp
op_add_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|wordsize
comma
id|size32bit
)paren
suffix:colon
id|port-&gt;out_count
op_sub_assign
l_int|4
suffix:semicolon
op_star
id|port-&gt;data_out
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
id|port-&gt;outp
suffix:semicolon
id|port-&gt;outp
op_add_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|start_dma
r_static
r_void
id|start_dma
c_func
(paren
r_struct
id|sync_port
op_star
id|port
comma
r_const
r_char
op_star
id|data
comma
r_int
id|count
)paren
(brace
id|port-&gt;out_descr.hw_len
op_assign
l_int|0
suffix:semicolon
id|port-&gt;out_descr.next
op_assign
l_int|0
suffix:semicolon
id|port-&gt;out_descr.ctrl
op_assign
id|d_int
op_or
id|d_eol
op_or
id|d_eop
suffix:semicolon
id|port-&gt;out_descr.sw_len
op_assign
id|count
suffix:semicolon
id|port-&gt;out_descr.buf
op_assign
id|virt_to_phys
c_func
(paren
id|port-&gt;out_buffer
)paren
suffix:semicolon
id|port-&gt;out_descr.status
op_assign
l_int|0
suffix:semicolon
op_star
id|port-&gt;output_dma_first
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|port-&gt;out_descr
)paren
suffix:semicolon
op_star
id|port-&gt;output_dma_cmd
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH0_CMD
comma
id|cmd
comma
id|start
)paren
suffix:semicolon
)brace
DECL|function|start_dma_in
r_static
r_void
id|start_dma_in
c_func
(paren
id|sync_port
op_star
id|port
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;writep
OG
id|port-&gt;in_buffer
op_plus
id|IN_BUFFER_SIZE
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Offset too large in sync serial driver&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|port-&gt;in_descr1.hw_len
op_assign
l_int|0
suffix:semicolon
id|port-&gt;in_descr1.ctrl
op_assign
id|d_int
suffix:semicolon
id|port-&gt;in_descr1.status
op_assign
l_int|0
suffix:semicolon
id|port-&gt;in_descr1.next
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|port-&gt;in_descr2
)paren
suffix:semicolon
id|port-&gt;in_descr2.hw_len
op_assign
l_int|0
suffix:semicolon
id|port-&gt;in_descr2.next
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|port-&gt;in_descr1
)paren
suffix:semicolon
id|port-&gt;in_descr2.ctrl
op_assign
id|d_int
suffix:semicolon
id|port-&gt;in_descr2.status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Find out which descriptor to start */
r_if
c_cond
(paren
id|port-&gt;writep
op_ge
id|port-&gt;in_buffer
op_plus
id|IN_BUFFER_SIZE
op_div
l_int|2
)paren
(brace
multiline_comment|/* Start descriptor 2 */
id|port-&gt;in_descr1.sw_len
op_assign
id|IN_BUFFER_SIZE
op_div
l_int|2
suffix:semicolon
multiline_comment|/* All data available in 1 */
id|port-&gt;in_descr1.buf
op_assign
id|virt_to_phys
c_func
(paren
id|port-&gt;in_buffer
)paren
suffix:semicolon
id|port-&gt;in_descr2.sw_len
op_assign
id|port-&gt;in_buffer
op_plus
id|IN_BUFFER_SIZE
op_minus
id|port-&gt;writep
suffix:semicolon
id|port-&gt;in_descr2.buf
op_assign
id|virt_to_phys
c_func
(paren
id|port-&gt;writep
)paren
suffix:semicolon
op_star
id|port-&gt;input_dma_first
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|port-&gt;in_descr2
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Start descriptor 1 */
id|port-&gt;in_descr1.sw_len
op_assign
id|port-&gt;in_buffer
op_plus
id|IN_BUFFER_SIZE
op_div
l_int|2
op_minus
id|port-&gt;writep
suffix:semicolon
id|port-&gt;in_descr1.buf
op_assign
id|virt_to_phys
c_func
(paren
id|port-&gt;writep
)paren
suffix:semicolon
id|port-&gt;in_descr2.sw_len
op_assign
id|IN_BUFFER_SIZE
op_div
l_int|2
suffix:semicolon
id|port-&gt;in_descr2.buf
op_assign
id|virt_to_phys
c_func
(paren
id|port-&gt;in_buffer
op_plus
id|IN_BUFFER_SIZE
op_div
l_int|2
)paren
suffix:semicolon
op_star
id|port-&gt;input_dma_first
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|port-&gt;in_descr1
)paren
suffix:semicolon
)brace
op_star
id|port-&gt;input_dma_cmd
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH0_CMD
comma
id|cmd
comma
id|start
)paren
suffix:semicolon
)brace
DECL|function|tr_interrupt
r_static
r_void
id|tr_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|ireg
op_assign
op_star
id|R_IRQ_MASK2_RD
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUMBER_OF_PORTS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sync_port
op_star
id|port
op_assign
op_amp
id|ports
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ireg
op_amp
(paren
l_int|1
op_lshift
id|port-&gt;output_dma_bit
)paren
)paren
multiline_comment|/* IRQ active for the port? */
(brace
multiline_comment|/* Clear IRQ */
op_star
id|port-&gt;output_dma_clr_irq
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH0_CLR_INTR
comma
id|clr_eop
comma
r_do
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_DMA_CH0_CLR_INTR
comma
id|clr_descr
comma
r_do
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|port-&gt;out_wait_q
)paren
suffix:semicolon
multiline_comment|/* wake up the waiting process */
)brace
)brace
)brace
DECL|function|rx_interrupt
r_static
r_void
id|rx_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|ireg
op_assign
op_star
id|R_IRQ_MASK2_RD
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUMBER_OF_PORTS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|update
op_assign
l_int|0
suffix:semicolon
id|sync_port
op_star
id|port
op_assign
op_amp
id|ports
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;enabled
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ireg
op_amp
(paren
l_int|1
op_lshift
id|port-&gt;input_dma_descr_bit
)paren
)paren
multiline_comment|/* Descriptor interrupt */
(brace
multiline_comment|/* DMA has reached end of descriptor */
op_star
id|port-&gt;input_dma_clr_irq
op_assign
id|IO_STATE
c_func
(paren
id|R_DMA_CH0_CLR_INTR
comma
id|clr_eop
comma
r_do
)paren
op_or
id|IO_STATE
c_func
(paren
id|R_DMA_CH0_CLR_INTR
comma
id|clr_descr
comma
r_do
)paren
suffix:semicolon
multiline_comment|/* Find out which descriptor that is ready */
r_if
c_cond
(paren
id|port-&gt;writep
op_ge
id|port-&gt;in_buffer
op_plus
id|IN_BUFFER_SIZE
op_div
l_int|2
)paren
(brace
multiline_comment|/* Descr 2 was ready. Restart DMA at descriptor 1 */
id|port-&gt;writep
op_assign
id|port-&gt;in_buffer
suffix:semicolon
multiline_comment|/* Throw away data? */
r_if
c_cond
(paren
id|port-&gt;readp
OL
id|port-&gt;in_buffer
op_plus
id|IN_BUFFER_SIZE
op_div
l_int|2
)paren
id|port-&gt;readp
op_assign
id|port-&gt;in_buffer
op_plus
id|IN_BUFFER_SIZE
op_div
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Descr 1 was ready. Restart DMA at descriptor 2 */
id|port-&gt;writep
op_assign
id|port-&gt;in_buffer
op_plus
id|IN_BUFFER_SIZE
op_div
l_int|2
suffix:semicolon
multiline_comment|/* Throw away data? */
r_if
c_cond
(paren
id|port-&gt;readp
op_ge
id|port-&gt;in_buffer
op_plus
id|IN_BUFFER_SIZE
op_div
l_int|2
)paren
id|port-&gt;readp
op_assign
id|port-&gt;in_buffer
suffix:semicolon
)brace
id|start_dma_in
c_func
(paren
id|port
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|port-&gt;in_wait_q
)paren
suffix:semicolon
multiline_comment|/* wake up the waiting process */
)brace
)brace
)brace
DECL|function|manual_interrupt
r_static
r_void
id|manual_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUMBER_OF_PORTS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sync_port
op_star
id|port
op_assign
op_amp
id|ports
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;enabled
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|R_IRQ_MASK1_RD
op_amp
(paren
l_int|1
op_lshift
id|port-&gt;data_avail_bit
)paren
)paren
multiline_comment|/* Data received? */
(brace
multiline_comment|/* Read data */
r_switch
c_cond
(paren
id|port-&gt;ctrl_data_shadow
op_amp
id|IO_MASK
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|wordsize
)paren
)paren
(brace
r_case
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|wordsize
comma
id|size8bit
)paren
suffix:colon
op_star
id|port-&gt;writep
op_increment
op_assign
op_star
(paren
r_volatile
r_char
op_star
)paren
id|port-&gt;data_in
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|wordsize
comma
id|size12bit
)paren
suffix:colon
(brace
r_int
id|data
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
id|port-&gt;data_in
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;odd_input
)paren
(brace
op_star
id|port-&gt;writep
op_or_assign
(paren
id|data
op_amp
l_int|0x0f00
)paren
op_rshift
l_int|8
suffix:semicolon
op_star
(paren
id|port-&gt;writep
op_plus
l_int|1
)paren
op_assign
id|data
op_amp
l_int|0xff
suffix:semicolon
)brace
r_else
(brace
op_star
id|port-&gt;writep
op_assign
(paren
id|data
op_amp
l_int|0x0ff0
)paren
op_rshift
l_int|4
suffix:semicolon
op_star
(paren
id|port-&gt;writep
op_plus
l_int|1
)paren
op_assign
(paren
id|data
op_amp
l_int|0x0f
)paren
op_lshift
l_int|4
suffix:semicolon
)brace
id|port-&gt;odd_input
op_assign
op_logical_neg
id|port-&gt;odd_input
suffix:semicolon
id|port-&gt;writep
op_add_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|wordsize
comma
id|size16bit
)paren
suffix:colon
op_star
(paren
r_int
r_int
op_star
)paren
id|port-&gt;writep
op_assign
op_star
(paren
r_volatile
r_int
r_int
op_star
)paren
id|port-&gt;data_in
suffix:semicolon
id|port-&gt;writep
op_add_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|wordsize
comma
id|size24bit
)paren
suffix:colon
op_star
(paren
r_int
r_int
op_star
)paren
id|port-&gt;writep
op_assign
op_star
id|port-&gt;data_in
suffix:semicolon
id|port-&gt;writep
op_add_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IO_STATE
c_func
(paren
id|R_SYNC_SERIAL1_CTRL
comma
id|wordsize
comma
id|size32bit
)paren
suffix:colon
op_star
(paren
r_int
r_int
op_star
)paren
id|port-&gt;writep
op_assign
op_star
id|port-&gt;data_in
suffix:semicolon
id|port-&gt;writep
op_add_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|port-&gt;writep
OG
id|port-&gt;in_buffer
op_plus
id|IN_BUFFER_SIZE
)paren
multiline_comment|/* Wrap? */
id|port-&gt;writep
op_assign
id|port-&gt;in_buffer
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|port-&gt;in_wait_q
)paren
suffix:semicolon
multiline_comment|/* Wake up application */
)brace
r_if
c_cond
(paren
op_star
id|R_IRQ_MASK1_RD
op_amp
(paren
l_int|1
op_lshift
id|port-&gt;transmitter_ready_bit
)paren
)paren
multiline_comment|/* Transmitter ready? */
(brace
r_if
c_cond
(paren
id|port-&gt;out_count
)paren
multiline_comment|/* More data to send */
id|send_word
c_func
(paren
id|port
)paren
suffix:semicolon
r_else
multiline_comment|/* transmission finished */
(brace
op_star
id|R_IRQ_MASK1_CLR
op_assign
l_int|1
op_lshift
id|port-&gt;ready_irq_bit
suffix:semicolon
multiline_comment|/* Turn off IRQ */
id|wake_up_interruptible
c_func
(paren
op_amp
id|port-&gt;out_wait_q
)paren
suffix:semicolon
multiline_comment|/* Wake up application */
)brace
)brace
)brace
)brace
DECL|variable|etrax_sync_serial_init
id|module_init
c_func
(paren
id|etrax_sync_serial_init
)paren
suffix:semicolon
eof
