multiline_comment|/*&n; * arch/v850/kernel/memcons.c -- Console I/O to a memory buffer&n; *&n; *  Copyright (C) 2001,02  NEC Corporation&n; *  Copyright (C) 2001,02  Miles Bader &lt;miles@gnu.org&gt;&n; *&n; * This file is subject to the terms and conditions of the GNU General&n; * Public License.  See the file COPYING in the main directory of this&n; * archive for more details.&n; *&n; * Written by Miles Bader &lt;miles@gnu.org&gt;&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_driver.h&gt;
macro_line|#include &lt;linux/init.h&gt;
multiline_comment|/* If this device is enabled, the linker map should define start and&n;   end points for its buffer. */
r_extern
r_char
id|memcons_output
(braket
)braket
comma
id|memcons_output_end
suffix:semicolon
multiline_comment|/* Current offset into the buffer.  */
DECL|variable|memcons_offs
r_static
r_int
r_int
id|memcons_offs
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Spinlock protecting memcons_offs.  */
DECL|variable|memcons_lock
r_static
id|spinlock_t
id|memcons_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|function|write
r_static
r_int
id|write
(paren
r_const
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_int
id|flags
suffix:semicolon
r_char
op_star
id|point
suffix:semicolon
id|spin_lock_irqsave
(paren
id|memcons_lock
comma
id|flags
)paren
suffix:semicolon
id|point
op_assign
id|memcons_output
op_plus
id|memcons_offs
suffix:semicolon
r_if
c_cond
(paren
id|point
op_plus
id|len
op_ge
op_amp
id|memcons_output_end
)paren
(brace
id|len
op_assign
op_amp
id|memcons_output_end
op_minus
id|point
suffix:semicolon
id|memcons_offs
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|memcons_offs
op_add_assign
id|len
suffix:semicolon
id|spin_unlock_irqrestore
(paren
id|memcons_lock
comma
id|flags
)paren
suffix:semicolon
id|memcpy
(paren
id|point
comma
id|buf
comma
id|len
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
"&f;"
multiline_comment|/*  Low-level console. */
DECL|function|memcons_write
r_static
r_void
id|memcons_write
(paren
r_struct
id|console
op_star
id|co
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
id|len
op_sub_assign
id|write
(paren
id|buf
comma
id|len
)paren
suffix:semicolon
)brace
DECL|variable|tty_driver
r_static
r_struct
id|tty_driver
op_star
id|tty_driver
suffix:semicolon
DECL|function|memcons_device
r_static
r_struct
id|tty_driver
op_star
id|memcons_device
(paren
r_struct
id|console
op_star
id|co
comma
r_int
op_star
id|index
)paren
(brace
op_star
id|index
op_assign
id|co-&gt;index
suffix:semicolon
r_return
id|tty_driver
suffix:semicolon
)brace
DECL|variable|memcons
r_static
r_struct
id|console
id|memcons
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;memcons&quot;
comma
dot
id|write
op_assign
id|memcons_write
comma
dot
id|device
op_assign
id|memcons_device
comma
dot
id|flags
op_assign
id|CON_PRINTBUFFER
comma
dot
id|index
op_assign
op_minus
l_int|1
comma
)brace
suffix:semicolon
DECL|function|memcons_setup
r_void
id|memcons_setup
(paren
r_void
)paren
(brace
id|register_console
(paren
op_amp
id|memcons
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;Console: static memory buffer (memcons)&bslash;n&quot;
)paren
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Higher level TTY interface.  */
DECL|function|memcons_tty_open
r_int
id|memcons_tty_open
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|memcons_tty_write
r_int
id|memcons_tty_write
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_return
id|write
(paren
id|buf
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|memcons_tty_write_room
r_int
id|memcons_tty_write_room
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_return
op_amp
id|memcons_output_end
op_minus
(paren
id|memcons_output
op_plus
id|memcons_offs
)paren
suffix:semicolon
)brace
DECL|function|memcons_tty_chars_in_buffer
r_int
id|memcons_tty_chars_in_buffer
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
multiline_comment|/* We have no buffer.  */
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ops
r_static
r_struct
id|tty_operations
id|ops
op_assign
(brace
dot
id|open
op_assign
id|memcons_tty_open
comma
dot
id|write
op_assign
id|memcons_tty_write
comma
dot
id|write_room
op_assign
id|memcons_tty_write_room
comma
dot
id|chars_in_buffer
op_assign
id|memcons_tty_chars_in_buffer
comma
)brace
suffix:semicolon
DECL|function|memcons_tty_init
r_int
id|__init
id|memcons_tty_init
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
r_struct
id|tty_driver
op_star
id|driver
op_assign
id|alloc_tty_driver
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|driver
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|driver-&gt;name
op_assign
l_string|&quot;memcons&quot;
suffix:semicolon
id|driver-&gt;major
op_assign
id|TTY_MAJOR
suffix:semicolon
id|driver-&gt;minor_start
op_assign
l_int|64
suffix:semicolon
id|driver-&gt;type
op_assign
id|TTY_DRIVER_TYPE_SYSCONS
suffix:semicolon
id|driver-&gt;init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|tty_set_operations
c_func
(paren
id|driver
comma
op_amp
id|ops
)paren
suffix:semicolon
id|err
op_assign
id|tty_register_driver
c_func
(paren
id|driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|put_tty_driver
c_func
(paren
id|driver
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|tty_driver
op_assign
id|driver
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|memcons_tty_init
id|__initcall
(paren
id|memcons_tty_init
)paren
suffix:semicolon
eof
