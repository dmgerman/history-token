multiline_comment|/*&n; * arch/v850/kernel/bug.c -- Bug reporting functions&n; *&n; *  Copyright (C) 2001,02,03  NEC Electronics Corporation&n; *  Copyright (C) 2001,02,03  Miles Bader &lt;miles@gnu.org&gt;&n; *&n; * This file is subject to the terms and conditions of the GNU General&n; * Public License.  See the file COPYING in the main directory of this&n; * archive for more details.&n; *&n; * Written by Miles Bader &lt;miles@gnu.org&gt;&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/reboot.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/errno.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/current.h&gt;
multiline_comment|/* We should use __builtin_return_address, but it doesn&squot;t work in gcc-2.90&n;   (which is currently our standard compiler on the v850).  */
DECL|macro|ret_addr
mdefine_line|#define ret_addr() ({ register u32 lp asm (&quot;lp&quot;); lp; })
DECL|macro|stack_addr
mdefine_line|#define stack_addr() ({ register u32 sp asm (&quot;sp&quot;); sp; })
DECL|function|__bug
r_void
id|__bug
(paren
)paren
(brace
id|printk
(paren
id|KERN_CRIT
l_string|&quot;kernel BUG at PC 0x%x (SP ~0x%x)!&bslash;n&quot;
comma
id|ret_addr
c_func
(paren
)paren
op_minus
l_int|4
comma
multiline_comment|/* - 4 for `jarl&squot; */
id|stack_addr
c_func
(paren
)paren
)paren
suffix:semicolon
id|machine_halt
(paren
)paren
suffix:semicolon
)brace
DECL|function|bad_trap
r_int
id|bad_trap
(paren
r_int
id|trap_num
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|printk
(paren
id|KERN_CRIT
l_string|&quot;unimplemented trap %d called at 0x%08lx, pid %d!&bslash;n&quot;
comma
id|trap_num
comma
id|regs-&gt;pc
comma
id|current-&gt;pid
)paren
suffix:semicolon
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_RESET_GUARD
DECL|function|unexpected_reset
r_void
id|unexpected_reset
(paren
r_int
r_int
id|ret_addr
comma
r_int
r_int
id|kmode
comma
r_struct
id|task_struct
op_star
id|task
comma
r_int
r_int
id|sp
)paren
(brace
id|printk
(paren
id|KERN_CRIT
l_string|&quot;unexpected reset in %s mode, pid %d&quot;
l_string|&quot; (ret_addr = 0x%lx, sp = 0x%lx)&bslash;n&quot;
comma
id|kmode
ques
c_cond
l_string|&quot;kernel&quot;
suffix:colon
l_string|&quot;user&quot;
comma
id|task
ques
c_cond
id|task-&gt;pid
suffix:colon
op_minus
l_int|1
comma
id|ret_addr
comma
id|sp
)paren
suffix:semicolon
id|machine_halt
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_RESET_GUARD */
"&f;"
DECL|struct|spec_reg_name
r_struct
id|spec_reg_name
(brace
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|gpr
r_int
id|gpr
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|spec_reg_names
r_struct
id|spec_reg_name
id|spec_reg_names
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;sp&quot;
comma
id|GPR_SP
)brace
comma
(brace
l_string|&quot;gp&quot;
comma
id|GPR_GP
)brace
comma
(brace
l_string|&quot;tp&quot;
comma
id|GPR_TP
)brace
comma
(brace
l_string|&quot;ep&quot;
comma
id|GPR_EP
)brace
comma
(brace
l_string|&quot;lp&quot;
comma
id|GPR_LP
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|function|show_regs
r_void
id|show_regs
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|gpr_base
comma
id|gpr_offs
suffix:semicolon
id|printk
(paren
l_string|&quot;     pc 0x%08lx    psw 0x%08lx                       kernel_mode %d&bslash;n&quot;
comma
id|regs-&gt;pc
comma
id|regs-&gt;psw
comma
id|regs-&gt;kernel_mode
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;   ctpc 0x%08lx  ctpsw 0x%08lx   ctbp 0x%08lx&bslash;n&quot;
comma
id|regs-&gt;ctpc
comma
id|regs-&gt;ctpsw
comma
id|regs-&gt;ctbp
)paren
suffix:semicolon
r_for
c_loop
(paren
id|gpr_base
op_assign
l_int|0
suffix:semicolon
id|gpr_base
OL
id|NUM_GPRS
suffix:semicolon
id|gpr_base
op_add_assign
l_int|4
)paren
(brace
r_for
c_loop
(paren
id|gpr_offs
op_assign
l_int|0
suffix:semicolon
id|gpr_offs
OL
l_int|4
suffix:semicolon
id|gpr_offs
op_increment
)paren
(brace
r_int
id|gpr
op_assign
id|gpr_base
op_plus
id|gpr_offs
suffix:semicolon
r_int
id|val
op_assign
id|regs-&gt;gpr
(braket
id|gpr
)braket
suffix:semicolon
r_struct
id|spec_reg_name
op_star
id|srn
suffix:semicolon
r_for
c_loop
(paren
id|srn
op_assign
id|spec_reg_names
suffix:semicolon
id|srn-&gt;name
suffix:semicolon
id|srn
op_increment
)paren
r_if
c_cond
(paren
id|srn-&gt;gpr
op_eq
id|gpr
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|srn-&gt;name
)paren
id|printk
(paren
l_string|&quot;%7s 0x%08lx&quot;
comma
id|srn-&gt;name
comma
id|val
)paren
suffix:semicolon
r_else
id|printk
(paren
l_string|&quot;    r%02d 0x%08lx&quot;
comma
id|gpr
comma
id|val
)paren
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * TASK is a pointer to the task whose backtrace we want to see (or NULL&n; * for current task), SP is the stack pointer of the first frame that&n; * should be shown in the back trace (or NULL if the entire call-chain of&n; * the task should be shown).&n; */
DECL|function|show_stack
r_void
id|show_stack
(paren
r_struct
id|task_struct
op_star
id|task
comma
r_int
r_int
op_star
id|sp
)paren
(brace
r_int
r_int
id|addr
comma
id|end
suffix:semicolon
r_if
c_cond
(paren
id|sp
)paren
id|addr
op_assign
(paren
r_int
r_int
)paren
id|sp
suffix:semicolon
r_else
r_if
c_cond
(paren
id|task
)paren
id|addr
op_assign
id|task_sp
(paren
id|task
)paren
suffix:semicolon
r_else
id|addr
op_assign
id|stack_addr
(paren
)paren
suffix:semicolon
id|addr
op_assign
id|addr
op_amp
op_complement
l_int|3
suffix:semicolon
id|end
op_assign
(paren
id|addr
op_plus
id|THREAD_SIZE
op_minus
l_int|1
)paren
op_amp
id|THREAD_MASK
suffix:semicolon
r_while
c_loop
(paren
id|addr
OL
id|end
)paren
(brace
id|printk
(paren
l_string|&quot;%8lX: &quot;
comma
id|addr
)paren
suffix:semicolon
r_while
c_loop
(paren
id|addr
OL
id|end
)paren
(brace
id|printk
(paren
l_string|&quot; %8lX&quot;
comma
op_star
(paren
r_int
r_int
op_star
)paren
id|addr
)paren
suffix:semicolon
id|addr
op_add_assign
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|addr
op_amp
l_int|0xF
)paren
)paren
r_break
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|dump_stack
r_void
id|dump_stack
(paren
)paren
(brace
id|show_stack
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|variable|dump_stack
id|EXPORT_SYMBOL
c_func
(paren
id|dump_stack
)paren
suffix:semicolon
eof
