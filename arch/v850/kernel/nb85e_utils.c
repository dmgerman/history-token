multiline_comment|/*&n; * include/asm-v850/nb85e_utils.h -- Utility functions associated with&n; *&t;the NB85E cpu core&n; *&n; *  Copyright (C) 2001,02  NEC Corporation&n; *  Copyright (C) 2001,02  Miles Bader &lt;miles@gnu.org&gt;&n; *&n; * This file is subject to the terms and conditions of the GNU General&n; * Public License.  See the file COPYING in the main directory of this&n; * archive for more details.&n; *&n; * Written by Miles Bader &lt;miles@gnu.org&gt;&n; */
multiline_comment|/* Note: these functions are often associated with the N85E cpu core,&n;   but not always, which is why they&squot;re not in `nb85e.c&squot;.  */
macro_line|#include &lt;asm/nb85e_utils.h&gt;
multiline_comment|/* Calculate counter clock-divider and count values to attain the&n;   desired frequency RATE from the base frequency BASE_FREQ.  The&n;   counter is expected to have a clock-divider, which can divide the&n;   system cpu clock by a power of two value from MIN_DIVLOG2 to&n;   MAX_DIV_LOG2, and a word-size of COUNTER_SIZE bits (the counter&n;   counts up and resets whenever it&squot;s equal to the compare register,&n;   generating an interrupt or whatever when it does so).  The returned&n;   values are: *DIVLOG2 -- log2 of the desired clock divider and *COUNT&n;   -- the counter compare value to use.  Returns true if it was possible&n;   to find a reasonable value, otherwise false (and the other return&n;   values will be set to be as good as possible).  */
DECL|function|calc_counter_params
r_int
id|calc_counter_params
(paren
r_int
r_int
id|base_freq
comma
r_int
r_int
id|rate
comma
r_int
id|min_divlog2
comma
r_int
id|max_divlog2
comma
r_int
id|counter_size
comma
r_int
op_star
id|divlog2
comma
r_int
op_star
id|count
)paren
(brace
r_int
id|_divlog2
suffix:semicolon
r_int
id|ok
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Find the lowest clock divider setting that can represent RATE.  */
r_for
c_loop
(paren
id|_divlog2
op_assign
id|min_divlog2
suffix:semicolon
id|_divlog2
op_le
id|max_divlog2
suffix:semicolon
id|_divlog2
op_increment
)paren
(brace
multiline_comment|/* Minimum interrupt rate possible using this divider.  */
r_int
id|min_int_rate
op_assign
(paren
id|base_freq
op_rshift
id|_divlog2
)paren
op_rshift
id|counter_size
suffix:semicolon
r_if
c_cond
(paren
id|min_int_rate
op_le
id|rate
)paren
(brace
multiline_comment|/* This setting is the highest resolution&n;&t;&t;&t;   setting that&squot;s slow enough enough to attain&n;&t;&t;&t;   RATE interrupts per second, so use it.  */
id|ok
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|_divlog2
OG
id|max_divlog2
)paren
multiline_comment|/* Can&squot;t find correct setting.  */
id|_divlog2
op_assign
id|max_divlog2
suffix:semicolon
r_if
c_cond
(paren
id|divlog2
)paren
op_star
id|divlog2
op_assign
id|_divlog2
suffix:semicolon
r_if
c_cond
(paren
id|count
)paren
op_star
id|count
op_assign
(paren
(paren
id|base_freq
op_rshift
id|_divlog2
)paren
op_plus
id|rate
op_div
l_int|2
)paren
op_div
id|rate
suffix:semicolon
r_return
id|ok
suffix:semicolon
)brace
eof
