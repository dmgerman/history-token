multiline_comment|/*&n; * include/asm-v850/rte_cb_leds.c -- Midas lab RTE-CB board LED device support&n; *&n; *  Copyright (C) 2002,03  NEC Electronics Corporation&n; *  Copyright (C) 2002,03  Miles Bader &lt;miles@gnu.org&gt;&n; *&n; * This file is subject to the terms and conditions of the GNU General&n; * Public License.  See the file COPYING in the main directory of this&n; * archive for more details.&n; *&n; * Written by Miles Bader &lt;miles@gnu.org&gt;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|macro|LEDS_MINOR
mdefine_line|#define LEDS_MINOR&t;169&t;/* Minor device number, using misc major.  */
multiline_comment|/* The actual LED hardware is write-only, so we hold the contents here too.  */
DECL|variable|leds_image
r_static
r_int
r_char
id|leds_image
(braket
id|LED_NUM_DIGITS
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
multiline_comment|/* Spinlock protecting the above leds.  */
DECL|variable|leds_lock
r_static
id|spinlock_t
id|leds_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* Common body of LED read/write functions, checks POS and LEN for&n;   correctness, declares a variable using IMG_DECL, initialized pointing at&n;   the POS position in the LED image buffer, and and iterates COPY_EXPR&n;   until BUF is equal to the last buffer position; finally, sets LEN to be&n;   the amount actually copied.  IMG should be a variable declaration&n;   (without an initializer or a terminating semicolon); POS, BUF, and LEN&n;   should all be simple variables.  */
DECL|macro|DO_LED_COPY
mdefine_line|#define DO_LED_COPY(img_decl, pos, buf, len, copy_expr)&t;&t;&t;&bslash;&n;do {&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;if (pos &gt; LED_NUM_DIGITS)&t;&t;&t;&t;&t;&bslash;&n;&t;&t;len = 0;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;else {&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;if (pos + len &gt; LED_NUM_DIGITS)&t;&t;&t;&t;&bslash;&n;&t;&t;&t;len = LED_NUM_DIGITS - pos;&t;&t;&t;&bslash;&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;if (len &gt; 0) {&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;int _flags;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;const char *_end = buf + len;&t;&t;&t;&bslash;&n;&t;&t;&t;img_decl = &amp;leds_image[pos];&t;&t;&t;&bslash;&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;spin_lock_irqsave (leds_lock, _flags);&t;&t;&bslash;&n;&t;&t;&t;do&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;&t;(copy_expr);&t;&t;&t;&t;&bslash;&n;&t;&t;&t;while (buf != _end);&t;&t;&t;&t;&bslash;&n;&t;&t;&t;spin_unlock_irqrestore (leds_lock, _flags);&t;&bslash;&n;&t;&t;}&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;}&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;} while (0)
multiline_comment|/* Read LEN bytes from LEDs at position POS, into BUF.&n;   Returns actual amount read.  */
DECL|function|read_leds
r_int
id|read_leds
(paren
r_int
id|pos
comma
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
id|DO_LED_COPY
(paren
r_const
r_char
op_star
id|img
comma
id|pos
comma
id|buf
comma
id|len
comma
op_star
id|buf
op_increment
op_assign
op_star
id|img
op_increment
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* Write LEN bytes to LEDs at position POS, from BUF.&n;   Returns actual amount written.  */
DECL|function|write_leds
r_int
id|write_leds
(paren
r_int
id|pos
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
multiline_comment|/* We write the actual LED values backwards, because&n;&t;   increasing memory addresses reflect LEDs right-to-left. */
r_volatile
r_char
op_star
id|led
op_assign
op_amp
id|LED
(paren
id|LED_NUM_DIGITS
op_minus
id|pos
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* We invert the value written to the hardware, because 1 = off,&n;&t;   and 0 = on.  */
id|DO_LED_COPY
(paren
r_char
op_star
id|img
comma
id|pos
comma
id|buf
comma
id|len
comma
op_star
id|led
op_decrement
op_assign
l_int|0xFF
op_xor
(paren
op_star
id|img
op_increment
op_assign
op_star
id|buf
op_increment
)paren
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Device functions.  */
DECL|function|leds_dev_read
r_static
id|ssize_t
id|leds_dev_read
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|len
comma
id|loff_t
op_star
id|pos
)paren
(brace
r_char
id|temp_buf
(braket
id|LED_NUM_DIGITS
)braket
suffix:semicolon
id|len
op_assign
id|read_leds
(paren
op_star
id|pos
comma
id|temp_buf
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
id|buf
comma
id|temp_buf
comma
id|len
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
op_star
id|pos
op_add_assign
id|len
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|leds_dev_write
r_static
id|ssize_t
id|leds_dev_write
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|len
comma
id|loff_t
op_star
id|pos
)paren
(brace
r_char
id|temp_buf
(braket
id|LED_NUM_DIGITS
)braket
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
(paren
id|temp_buf
comma
id|buf
comma
id|min_t
c_func
(paren
r_int
comma
id|len
comma
id|LED_NUM_DIGITS
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|len
op_assign
id|write_leds
(paren
op_star
id|pos
comma
id|temp_buf
comma
id|len
)paren
suffix:semicolon
op_star
id|pos
op_add_assign
id|len
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|leds_dev_lseek
r_static
id|loff_t
id|leds_dev_lseek
(paren
r_struct
id|file
op_star
id|file
comma
id|loff_t
id|offs
comma
r_int
id|whence
)paren
(brace
r_if
c_cond
(paren
id|whence
op_eq
l_int|1
)paren
id|offs
op_add_assign
id|file-&gt;f_pos
suffix:semicolon
multiline_comment|/* relative */
r_else
r_if
c_cond
(paren
id|whence
op_eq
l_int|2
)paren
id|offs
op_add_assign
id|LED_NUM_DIGITS
suffix:semicolon
multiline_comment|/* end-relative */
r_if
c_cond
(paren
id|offs
template_param
id|LED_NUM_DIGITS
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|file-&gt;f_pos
op_assign
id|offs
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|leds_fops
r_static
r_struct
id|file_operations
id|leds_fops
op_assign
(brace
dot
id|read
op_assign
id|leds_dev_read
comma
dot
id|write
op_assign
id|leds_dev_write
comma
dot
id|llseek
op_assign
id|leds_dev_lseek
)brace
suffix:semicolon
DECL|variable|leds_miscdev
r_static
r_struct
id|miscdevice
id|leds_miscdev
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;leds&quot;
comma
dot
id|minor
op_assign
id|LEDS_MINOR
comma
dot
id|fops
op_assign
op_amp
id|leds_fops
)brace
suffix:semicolon
DECL|function|leds_dev_init
r_int
id|__init
id|leds_dev_init
(paren
r_void
)paren
(brace
r_return
id|misc_register
(paren
op_amp
id|leds_miscdev
)paren
suffix:semicolon
)brace
DECL|variable|leds_dev_init
id|__initcall
(paren
id|leds_dev_init
)paren
suffix:semicolon
eof
