multiline_comment|/*&n; * arch/v850/kernel/sim.c -- Machine-specific stuff for GDB v850e simulator&n; *&n; *  Copyright (C) 2001,02  NEC Corporation&n; *  Copyright (C) 2001,02  Miles Bader &lt;miles@gnu.org&gt;&n; *&n; * This file is subject to the terms and conditions of the GNU General&n; * Public License.  See the file COPYING in the main directory of this&n; * archive for more details.&n; *&n; * Written by Miles Bader &lt;miles@gnu.org&gt;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/swap.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/simsyscall.h&gt;
macro_line|#include &quot;mach.h&quot;
multiline_comment|/* The name of a file containing the root filesystem.  */
DECL|macro|ROOT_FS
mdefine_line|#define ROOT_FS &quot;rootfs.image&quot;
r_extern
r_void
id|simcons_setup
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|simcons_poll_ttys
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|set_mem_root
(paren
r_void
op_star
id|addr
comma
r_int
id|len
comma
r_char
op_star
id|cmd_line
)paren
suffix:semicolon
r_static
r_int
id|read_file
(paren
r_const
r_char
op_star
id|name
comma
r_int
r_int
op_star
id|addr
comma
r_int
r_int
op_star
id|len
comma
r_const
r_char
op_star
op_star
id|err
)paren
suffix:semicolon
DECL|function|mach_setup
r_void
id|__init
id|mach_setup
(paren
r_char
op_star
op_star
id|cmdline
)paren
(brace
r_const
r_char
op_star
id|err
suffix:semicolon
r_int
r_int
id|root_dev_addr
comma
id|root_dev_len
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;CPU: NEC V850E (GDB simulator)&bslash;n&quot;
)paren
suffix:semicolon
id|simcons_setup
(paren
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;Reading root filesystem: %s&quot;
comma
id|ROOT_FS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_file
(paren
id|ROOT_FS
comma
op_amp
id|root_dev_addr
comma
op_amp
id|root_dev_len
comma
op_amp
id|err
)paren
)paren
(brace
id|printk
(paren
l_string|&quot; (size %luK)&bslash;n&quot;
comma
id|root_dev_len
op_div
l_int|1024
)paren
suffix:semicolon
id|set_mem_root
(paren
(paren
r_void
op_star
)paren
id|root_dev_addr
comma
(paren
r_int
)paren
id|root_dev_len
comma
op_star
id|cmdline
)paren
suffix:semicolon
)brace
r_else
id|printk
(paren
l_string|&quot;...%s failed!&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
)brace
DECL|function|mach_get_physical_ram
r_void
id|mach_get_physical_ram
(paren
r_int
r_int
op_star
id|ram_start
comma
r_int
r_int
op_star
id|ram_len
)paren
(brace
op_star
id|ram_start
op_assign
id|RAM_ADDR
suffix:semicolon
op_star
id|ram_len
op_assign
id|RAM_SIZE
suffix:semicolon
)brace
DECL|function|mach_sched_init
r_void
id|__init
id|mach_sched_init
(paren
r_struct
id|irqaction
op_star
id|timer_action
)paren
(brace
multiline_comment|/* ...do magic timer initialization?...  */
id|mach_tick
op_assign
id|simcons_poll_ttys
suffix:semicolon
id|setup_irq
(paren
l_int|0
comma
id|timer_action
)paren
suffix:semicolon
)brace
"&f;"
DECL|function|irq_nop
r_static
r_void
id|irq_nop
(paren
r_int
id|irq
)paren
(brace
)brace
DECL|function|irq_zero
r_static
r_int
id|irq_zero
(paren
r_int
id|irq
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sim_irq_type
r_static
r_struct
id|hw_interrupt_type
id|sim_irq_type
op_assign
(brace
l_string|&quot;IRQ&quot;
comma
id|irq_zero
comma
multiline_comment|/* startup */
id|irq_nop
comma
multiline_comment|/* shutdown */
id|irq_nop
comma
multiline_comment|/* enable */
id|irq_nop
comma
multiline_comment|/* disable */
id|irq_nop
comma
multiline_comment|/* ack */
id|irq_nop
comma
multiline_comment|/* end */
)brace
suffix:semicolon
DECL|function|mach_init_irqs
r_void
id|__init
id|mach_init_irqs
(paren
r_void
)paren
(brace
id|init_irq_handlers
(paren
l_int|0
comma
id|NUM_MACH_IRQS
comma
l_int|1
comma
op_amp
id|sim_irq_type
)paren
suffix:semicolon
)brace
"&f;"
DECL|function|mach_gettimeofday
r_void
id|mach_gettimeofday
(paren
r_struct
id|timespec
op_star
id|tv
)paren
(brace
r_int
id|timeval
(braket
l_int|2
)braket
comma
id|timezone
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|rval
op_assign
id|V850_SIM_SYSCALL
(paren
id|gettimeofday
comma
id|timeval
comma
id|timezone
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_eq
l_int|0
)paren
(brace
id|tv-&gt;tv_sec
op_assign
id|timeval
(braket
l_int|0
)braket
suffix:semicolon
id|tv-&gt;tv_nsec
op_assign
id|timeval
(braket
l_int|1
)braket
op_star
l_int|1000
suffix:semicolon
)brace
)brace
DECL|function|machine_restart
r_void
id|machine_restart
(paren
r_char
op_star
id|__unused
)paren
(brace
id|V850_SIM_SYSCALL
(paren
id|write
comma
l_int|1
comma
l_string|&quot;RESTART&bslash;n&quot;
comma
l_int|8
)paren
suffix:semicolon
id|V850_SIM_SYSCALL
(paren
m_exit
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|machine_halt
r_void
id|machine_halt
(paren
r_void
)paren
(brace
id|V850_SIM_SYSCALL
(paren
id|write
comma
l_int|1
comma
l_string|&quot;HALT&bslash;n&quot;
comma
l_int|5
)paren
suffix:semicolon
id|V850_SIM_SYSCALL
(paren
m_exit
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|machine_power_off
r_void
id|machine_power_off
(paren
r_void
)paren
(brace
id|V850_SIM_SYSCALL
(paren
id|write
comma
l_int|1
comma
l_string|&quot;POWER OFF&bslash;n&quot;
comma
l_int|10
)paren
suffix:semicolon
id|V850_SIM_SYSCALL
(paren
m_exit
comma
l_int|0
)paren
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Load data from a file called NAME into ram.  The address and length&n;   of the data image are returned in ADDR and LEN.  */
r_static
r_int
id|__init
DECL|function|read_file
id|read_file
(paren
r_const
r_char
op_star
id|name
comma
r_int
r_int
op_star
id|addr
comma
r_int
r_int
op_star
id|len
comma
r_const
r_char
op_star
op_star
id|err
)paren
(brace
r_int
id|rval
comma
id|fd
suffix:semicolon
r_int
r_int
id|cur
comma
id|left
suffix:semicolon
multiline_comment|/* Note this is not a normal stat buffer, it&squot;s an ad-hoc&n;&t;   structure defined by the simulator.  */
r_int
r_int
id|stat_buf
(braket
l_int|10
)braket
suffix:semicolon
multiline_comment|/* Stat the file to find out the length.  */
id|rval
op_assign
id|V850_SIM_SYSCALL
(paren
id|stat
comma
id|name
comma
id|stat_buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|err
)paren
op_star
id|err
op_assign
l_string|&quot;stat&quot;
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|len
op_assign
id|stat_buf
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* Open the file; `0&squot; is O_RDONLY.  */
id|fd
op_assign
id|V850_SIM_SYSCALL
(paren
id|open
comma
id|name
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|err
)paren
op_star
id|err
op_assign
l_string|&quot;open&quot;
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|addr
op_assign
(paren
r_int
r_int
)paren
id|alloc_bootmem
c_func
(paren
op_star
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|addr
)paren
(brace
id|V850_SIM_SYSCALL
(paren
id|close
comma
id|fd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
op_star
id|err
op_assign
l_string|&quot;alloc_bootmem&quot;
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|cur
op_assign
op_star
id|addr
suffix:semicolon
id|left
op_assign
op_star
id|len
suffix:semicolon
r_while
c_loop
(paren
id|left
OG
l_int|0
)paren
(brace
r_int
id|chunk
op_assign
id|V850_SIM_SYSCALL
(paren
id|read
comma
id|fd
comma
id|cur
comma
id|left
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chunk
op_le
l_int|0
)paren
r_break
suffix:semicolon
id|cur
op_add_assign
id|chunk
suffix:semicolon
id|left
op_sub_assign
id|chunk
suffix:semicolon
)brace
id|V850_SIM_SYSCALL
(paren
id|close
comma
id|fd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|left
OG
l_int|0
)paren
(brace
multiline_comment|/* Some read failed.  */
id|free_bootmem
(paren
op_star
id|addr
comma
op_star
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
op_star
id|err
op_assign
l_string|&quot;read&quot;
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
eof
