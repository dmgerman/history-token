multiline_comment|/*&n; * arch/v850/kernel/v850e2_cache.c -- Cache control for V850E2 cache&n; * &t;memories&n; *&n; *  Copyright (C) 2003  NEC Electronics Corporation&n; *  Copyright (C) 2003  Miles Bader &lt;miles@gnu.org&gt;&n; *&n; * This file is subject to the terms and conditions of the GNU General&n; * Public License.  See the file COPYING in the main directory of this&n; * archive for more details.&n; *&n; * Written by Miles Bader &lt;miles@gnu.org&gt;&n; */
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/v850e2_cache.h&gt;
multiline_comment|/* Cache operations we can do.  The encoding corresponds directly to the&n;   value we need to write into the COPR register.  */
DECL|enum|cache_op
r_enum
id|cache_op
(brace
DECL|enumerator|OP_SYNC_IF_DIRTY
id|OP_SYNC_IF_DIRTY
op_assign
id|V850E2_CACHE_COPR_CFC
c_func
(paren
l_int|0
)paren
comma
multiline_comment|/* 000 */
DECL|enumerator|OP_SYNC_IF_VALID
id|OP_SYNC_IF_VALID
op_assign
id|V850E2_CACHE_COPR_CFC
c_func
(paren
l_int|1
)paren
comma
multiline_comment|/* 001 */
DECL|enumerator|OP_SYNC_IF_VALID_AND_CLEAR
id|OP_SYNC_IF_VALID_AND_CLEAR
op_assign
id|V850E2_CACHE_COPR_CFC
c_func
(paren
l_int|3
)paren
comma
multiline_comment|/* 011 */
DECL|enumerator|OP_WAY_CLEAR
id|OP_WAY_CLEAR
op_assign
id|V850E2_CACHE_COPR_CFC
c_func
(paren
l_int|4
)paren
comma
multiline_comment|/* 100 */
DECL|enumerator|OP_FILL
id|OP_FILL
op_assign
id|V850E2_CACHE_COPR_CFC
c_func
(paren
l_int|5
)paren
comma
multiline_comment|/* 101 */
DECL|enumerator|OP_CLEAR
id|OP_CLEAR
op_assign
id|V850E2_CACHE_COPR_CFC
c_func
(paren
l_int|6
)paren
comma
multiline_comment|/* 110 */
DECL|enumerator|OP_CREATE_DIRTY
id|OP_CREATE_DIRTY
op_assign
id|V850E2_CACHE_COPR_CFC
c_func
(paren
l_int|7
)paren
multiline_comment|/* 111 */
)brace
suffix:semicolon
multiline_comment|/* Which cache to use.  This encoding also corresponds directly to the&n;   value we need to write into the COPR register. */
DECL|enum|cache
r_enum
id|cache
(brace
DECL|enumerator|ICACHE
id|ICACHE
op_assign
l_int|0
comma
DECL|enumerator|DCACHE
id|DCACHE
op_assign
id|V850E2_CACHE_COPR_LBSL
)brace
suffix:semicolon
multiline_comment|/* Returns ADDR rounded down to the beginning of its cache-line.  */
DECL|macro|CACHE_LINE_ADDR
mdefine_line|#define CACHE_LINE_ADDR(addr)  &bslash;&n;   ((addr) &amp; ~(V850E2_CACHE_LINE_SIZE - 1))
multiline_comment|/* Returns END_ADDR rounded up to the `limit&squot; of its cache-line.  */
DECL|macro|CACHE_LINE_END_ADDR
mdefine_line|#define CACHE_LINE_END_ADDR(end_addr)  &bslash;&n;   CACHE_LINE_ADDR(end_addr + (V850E2_CACHE_LINE_SIZE - 1))
"&f;"
multiline_comment|/* Low-level cache ops.  */
multiline_comment|/* Apply cache-op OP to all entries in CACHE.  */
DECL|function|cache_op_all
r_static
r_inline
r_void
id|cache_op_all
(paren
r_enum
id|cache_op
id|op
comma
r_enum
id|cache
id|cache
)paren
(brace
r_int
id|cmd
op_assign
id|op
op_or
id|cache
op_or
id|V850E2_CACHE_COPR_WSLE
op_or
id|V850E2_CACHE_COPR_STRT
suffix:semicolon
r_if
c_cond
(paren
id|op
op_ne
id|OP_WAY_CLEAR
)paren
(brace
multiline_comment|/* The WAY_CLEAR operation does the whole way, but other&n;&t;&t;   ops take begin-index and count params; we just indicate&n;&t;&t;   the entire cache.  */
id|V850E2_CACHE_CADL
op_assign
l_int|0
suffix:semicolon
id|V850E2_CACHE_CADH
op_assign
l_int|0
suffix:semicolon
id|V850E2_CACHE_CCNT
op_assign
id|V850E2_CACHE_WAY_SIZE
op_minus
l_int|1
suffix:semicolon
)brace
id|V850E2_CACHE_COPR
op_assign
id|cmd
op_or
id|V850E2_CACHE_COPR_WSL
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* way 0 */
id|V850E2_CACHE_COPR
op_assign
id|cmd
op_or
id|V850E2_CACHE_COPR_WSL
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* way 1 */
id|V850E2_CACHE_COPR
op_assign
id|cmd
op_or
id|V850E2_CACHE_COPR_WSL
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* way 2 */
id|V850E2_CACHE_COPR
op_assign
id|cmd
op_or
id|V850E2_CACHE_COPR_WSL
c_func
(paren
l_int|3
)paren
suffix:semicolon
multiline_comment|/* way 3 */
)brace
multiline_comment|/* Apply cache-op OP to all entries in CACHE covering addresses ADDR&n;   through ADDR+LEN.  */
DECL|function|cache_op_range
r_static
r_inline
r_void
id|cache_op_range
(paren
r_enum
id|cache_op
id|op
comma
id|u32
id|addr
comma
id|u32
id|len
comma
r_enum
id|cache
id|cache
)paren
(brace
id|u32
id|start
op_assign
id|CACHE_LINE_ADDR
(paren
id|addr
)paren
suffix:semicolon
id|u32
id|end
op_assign
id|CACHE_LINE_END_ADDR
(paren
id|addr
op_plus
id|len
)paren
suffix:semicolon
id|u32
id|num_lines
op_assign
(paren
id|end
op_minus
id|start
)paren
op_rshift
id|V850E2_CACHE_LINE_SIZE_BITS
suffix:semicolon
id|V850E2_CACHE_CADL
op_assign
id|start
op_amp
l_int|0xFFFF
suffix:semicolon
id|V850E2_CACHE_CADH
op_assign
id|start
op_rshift
l_int|16
suffix:semicolon
id|V850E2_CACHE_CCNT
op_assign
id|num_lines
op_minus
l_int|1
suffix:semicolon
id|V850E2_CACHE_COPR
op_assign
id|op
op_or
id|cache
op_or
id|V850E2_CACHE_COPR_STRT
suffix:semicolon
)brace
"&f;"
multiline_comment|/* High-level ops.  */
DECL|function|cache_exec_after_store_all
r_static
r_void
id|cache_exec_after_store_all
(paren
r_void
)paren
(brace
id|cache_op_all
(paren
id|OP_SYNC_IF_DIRTY
comma
id|DCACHE
)paren
suffix:semicolon
id|cache_op_all
(paren
id|OP_WAY_CLEAR
comma
id|ICACHE
)paren
suffix:semicolon
)brace
DECL|function|cache_exec_after_store_range
r_static
r_void
id|cache_exec_after_store_range
(paren
id|u32
id|start
comma
id|u32
id|len
)paren
(brace
id|cache_op_range
(paren
id|OP_SYNC_IF_DIRTY
comma
id|start
comma
id|len
comma
id|DCACHE
)paren
suffix:semicolon
id|cache_op_range
(paren
id|OP_CLEAR
comma
id|start
comma
id|len
comma
id|ICACHE
)paren
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Exported functions.  */
DECL|function|flush_icache
r_void
id|flush_icache
(paren
r_void
)paren
(brace
id|cache_exec_after_store_all
(paren
)paren
suffix:semicolon
)brace
DECL|function|flush_icache_range
r_void
id|flush_icache_range
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
id|cache_exec_after_store_range
(paren
id|start
comma
id|end
op_minus
id|start
)paren
suffix:semicolon
)brace
DECL|function|flush_icache_page
r_void
id|flush_icache_page
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_struct
id|page
op_star
id|page
)paren
(brace
id|cache_exec_after_store_range
(paren
id|page_to_virt
(paren
id|page
)paren
comma
id|PAGE_SIZE
)paren
suffix:semicolon
)brace
DECL|function|flush_icache_user_range
r_void
id|flush_icache_user_range
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_struct
id|page
op_star
id|page
comma
r_int
r_int
id|addr
comma
r_int
id|len
)paren
(brace
id|cache_exec_after_store_range
(paren
id|addr
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|flush_cache_sigtramp
r_void
id|flush_cache_sigtramp
(paren
r_int
r_int
id|addr
)paren
(brace
multiline_comment|/* For the exact size, see signal.c, but 16 bytes should be enough.  */
id|cache_exec_after_store_range
(paren
id|addr
comma
l_int|16
)paren
suffix:semicolon
)brace
eof
