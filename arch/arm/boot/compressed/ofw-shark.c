multiline_comment|/*&n; * linux/arch/arm/boot/compressed/ofw-shark.c&n; *&n; * by Alexander Schulz &lt;aschulz@netwinder.org&gt;&n; *&n; * This file is used to get some basic information&n; * about the memory layout of the shark we are running&n; * on. Memory is usually divided in blocks a 8 MB.&n; * And bootargs are copied from OpenFirmware.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;asm/setup.h&gt;
macro_line|#include &lt;asm/page.h&gt;
id|asmlinkage
r_void
DECL|function|create_params
id|create_params
(paren
r_int
r_int
op_star
id|buffer
)paren
(brace
multiline_comment|/* Is there a better address? Also change in mach-shark/arch.c */
r_struct
id|param_struct
op_star
id|params
op_assign
(paren
r_struct
id|param_struct
op_star
)paren
l_int|0x08003000
suffix:semicolon
r_int
id|j
comma
id|i
comma
id|m
comma
id|k
comma
id|nr_banks
comma
id|size
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|256
suffix:semicolon
id|j
op_increment
)paren
id|params-&gt;u1.unused
(braket
id|j
)braket
op_assign
l_int|0
suffix:semicolon
id|size
op_assign
l_int|0
suffix:semicolon
id|nr_banks
op_assign
(paren
r_int
r_int
)paren
id|buffer
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|nr_banks
OG
id|NR_BANKS
)paren
id|nr_banks
op_assign
id|NR_BANKS
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|nr_banks
suffix:semicolon
id|j
op_increment
)paren
(brace
multiline_comment|/* search the lowest address and put it into the next entry   */
multiline_comment|/* not a fast sort algorithm, but there are at most 8 entries */
multiline_comment|/* and this is used only once anyway                          */
id|m
op_assign
l_int|0xffffffff
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_int
r_int
)paren
id|buffer
(braket
l_int|0
)braket
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|buffer
(braket
l_int|2
op_star
id|i
op_plus
l_int|1
)braket
OL
id|m
)paren
(brace
id|m
op_assign
id|buffer
(braket
l_int|2
op_star
id|i
op_plus
l_int|1
)braket
suffix:semicolon
id|k
op_assign
id|i
suffix:semicolon
)brace
)brace
multiline_comment|/* using pages_in_bank for startaddress and size               */
multiline_comment|/* start is in bytes, size in pages and not bigger than 0x2000 */
multiline_comment|/* This is decoded in fixup_shark in arch/arm/kernel/arch.c    */
id|params-&gt;u1.s.pages_in_bank
(braket
id|j
)braket
op_assign
id|buffer
(braket
l_int|2
op_star
id|k
op_plus
l_int|1
)braket
op_or
(paren
id|buffer
(braket
l_int|2
op_star
id|k
op_plus
l_int|2
)braket
op_div
id|PAGE_SIZE
)paren
suffix:semicolon
id|size
op_add_assign
id|buffer
(braket
l_int|2
op_star
id|k
op_plus
l_int|2
)braket
suffix:semicolon
id|buffer
(braket
l_int|2
op_star
id|k
op_plus
l_int|1
)braket
op_assign
l_int|0xffffffff
suffix:semicolon
multiline_comment|/* mark as copied             */
)brace
id|params-&gt;u1.s.page_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|params-&gt;u1.s.nr_pages
op_assign
id|size
op_div
id|PAGE_SIZE
suffix:semicolon
id|params-&gt;u1.s.flags
op_assign
id|FLAG_READONLY
suffix:semicolon
multiline_comment|/* Copy over the bootargs */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|128
op_div
l_int|4
suffix:semicolon
id|j
op_increment
)paren
(brace
(paren
(paren
r_int
r_int
op_star
)paren
id|params-&gt;commandline
)paren
(braket
id|j
)braket
op_assign
id|buffer
(braket
l_int|33
op_plus
id|j
)braket
suffix:semicolon
)brace
)brace
DECL|typedef|ofw_handle_t
r_typedef
r_int
(paren
op_star
id|ofw_handle_t
)paren
(paren
r_void
op_star
)paren
suffix:semicolon
multiline_comment|/* Everything below is called with a wrong MMU setting.&n; * This means: no string constants, no initialization of&n; * arrays, no global variables! This is ugly but I didn&squot;t&n; * want to write this in assembler :-)&n; */
r_int
DECL|function|of_decode_int
id|of_decode_int
c_func
(paren
r_const
r_int
r_char
op_star
id|p
)paren
(brace
r_int
r_int
id|i
op_assign
op_star
id|p
op_increment
op_lshift
l_int|8
suffix:semicolon
id|i
op_assign
(paren
id|i
op_plus
op_star
id|p
op_increment
)paren
op_lshift
l_int|8
suffix:semicolon
id|i
op_assign
(paren
id|i
op_plus
op_star
id|p
op_increment
)paren
op_lshift
l_int|8
suffix:semicolon
r_return
(paren
id|i
op_plus
op_star
id|p
)paren
suffix:semicolon
)brace
r_int
DECL|function|OF_finddevice
id|OF_finddevice
c_func
(paren
id|ofw_handle_t
id|openfirmware
comma
r_char
op_star
id|name
)paren
(brace
r_int
r_int
id|args
(braket
l_int|8
)braket
suffix:semicolon
r_char
id|service
(braket
l_int|12
)braket
suffix:semicolon
id|service
(braket
l_int|0
)braket
op_assign
l_char|&squot;f&squot;
suffix:semicolon
id|service
(braket
l_int|1
)braket
op_assign
l_char|&squot;i&squot;
suffix:semicolon
id|service
(braket
l_int|2
)braket
op_assign
l_char|&squot;n&squot;
suffix:semicolon
id|service
(braket
l_int|3
)braket
op_assign
l_char|&squot;d&squot;
suffix:semicolon
id|service
(braket
l_int|4
)braket
op_assign
l_char|&squot;d&squot;
suffix:semicolon
id|service
(braket
l_int|5
)braket
op_assign
l_char|&squot;e&squot;
suffix:semicolon
id|service
(braket
l_int|6
)braket
op_assign
l_char|&squot;v&squot;
suffix:semicolon
id|service
(braket
l_int|7
)braket
op_assign
l_char|&squot;i&squot;
suffix:semicolon
id|service
(braket
l_int|8
)braket
op_assign
l_char|&squot;c&squot;
suffix:semicolon
id|service
(braket
l_int|9
)braket
op_assign
l_char|&squot;e&squot;
suffix:semicolon
id|service
(braket
l_int|10
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|args
(braket
l_int|0
)braket
op_assign
(paren
r_int
r_int
)paren
id|service
suffix:semicolon
id|args
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
id|args
(braket
l_int|2
)braket
op_assign
l_int|1
suffix:semicolon
id|args
(braket
l_int|3
)braket
op_assign
(paren
r_int
r_int
)paren
id|name
suffix:semicolon
r_if
c_cond
(paren
id|openfirmware
c_func
(paren
id|args
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
id|args
(braket
l_int|4
)braket
suffix:semicolon
)brace
r_int
DECL|function|OF_getproplen
id|OF_getproplen
c_func
(paren
id|ofw_handle_t
id|openfirmware
comma
r_int
id|handle
comma
r_char
op_star
id|prop
)paren
(brace
r_int
r_int
id|args
(braket
l_int|8
)braket
suffix:semicolon
r_char
id|service
(braket
l_int|12
)braket
suffix:semicolon
id|service
(braket
l_int|0
)braket
op_assign
l_char|&squot;g&squot;
suffix:semicolon
id|service
(braket
l_int|1
)braket
op_assign
l_char|&squot;e&squot;
suffix:semicolon
id|service
(braket
l_int|2
)braket
op_assign
l_char|&squot;t&squot;
suffix:semicolon
id|service
(braket
l_int|3
)braket
op_assign
l_char|&squot;p&squot;
suffix:semicolon
id|service
(braket
l_int|4
)braket
op_assign
l_char|&squot;r&squot;
suffix:semicolon
id|service
(braket
l_int|5
)braket
op_assign
l_char|&squot;o&squot;
suffix:semicolon
id|service
(braket
l_int|6
)braket
op_assign
l_char|&squot;p&squot;
suffix:semicolon
id|service
(braket
l_int|7
)braket
op_assign
l_char|&squot;l&squot;
suffix:semicolon
id|service
(braket
l_int|8
)braket
op_assign
l_char|&squot;e&squot;
suffix:semicolon
id|service
(braket
l_int|9
)braket
op_assign
l_char|&squot;n&squot;
suffix:semicolon
id|service
(braket
l_int|10
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|args
(braket
l_int|0
)braket
op_assign
(paren
r_int
r_int
)paren
id|service
suffix:semicolon
id|args
(braket
l_int|1
)braket
op_assign
l_int|2
suffix:semicolon
id|args
(braket
l_int|2
)braket
op_assign
l_int|1
suffix:semicolon
id|args
(braket
l_int|3
)braket
op_assign
(paren
r_int
r_int
)paren
id|handle
suffix:semicolon
id|args
(braket
l_int|4
)braket
op_assign
(paren
r_int
r_int
)paren
id|prop
suffix:semicolon
r_if
c_cond
(paren
id|openfirmware
c_func
(paren
id|args
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
id|args
(braket
l_int|5
)braket
suffix:semicolon
)brace
r_int
DECL|function|OF_getprop
id|OF_getprop
c_func
(paren
id|ofw_handle_t
id|openfirmware
comma
r_int
id|handle
comma
r_char
op_star
id|prop
comma
r_void
op_star
id|buf
comma
r_int
r_int
id|buflen
)paren
(brace
r_int
r_int
id|args
(braket
l_int|8
)braket
suffix:semicolon
r_char
id|service
(braket
l_int|8
)braket
suffix:semicolon
id|service
(braket
l_int|0
)braket
op_assign
l_char|&squot;g&squot;
suffix:semicolon
id|service
(braket
l_int|1
)braket
op_assign
l_char|&squot;e&squot;
suffix:semicolon
id|service
(braket
l_int|2
)braket
op_assign
l_char|&squot;t&squot;
suffix:semicolon
id|service
(braket
l_int|3
)braket
op_assign
l_char|&squot;p&squot;
suffix:semicolon
id|service
(braket
l_int|4
)braket
op_assign
l_char|&squot;r&squot;
suffix:semicolon
id|service
(braket
l_int|5
)braket
op_assign
l_char|&squot;o&squot;
suffix:semicolon
id|service
(braket
l_int|6
)braket
op_assign
l_char|&squot;p&squot;
suffix:semicolon
id|service
(braket
l_int|7
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|args
(braket
l_int|0
)braket
op_assign
(paren
r_int
r_int
)paren
id|service
suffix:semicolon
id|args
(braket
l_int|1
)braket
op_assign
l_int|4
suffix:semicolon
id|args
(braket
l_int|2
)braket
op_assign
l_int|1
suffix:semicolon
id|args
(braket
l_int|3
)braket
op_assign
(paren
r_int
r_int
)paren
id|handle
suffix:semicolon
id|args
(braket
l_int|4
)braket
op_assign
(paren
r_int
r_int
)paren
id|prop
suffix:semicolon
id|args
(braket
l_int|5
)braket
op_assign
(paren
r_int
r_int
)paren
id|buf
suffix:semicolon
id|args
(braket
l_int|6
)braket
op_assign
id|buflen
suffix:semicolon
r_if
c_cond
(paren
id|openfirmware
c_func
(paren
id|args
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
id|args
(braket
l_int|7
)braket
suffix:semicolon
)brace
DECL|function|ofw_init
id|asmlinkage
r_void
id|ofw_init
c_func
(paren
id|ofw_handle_t
id|o
comma
r_int
op_star
id|nomr
comma
r_int
op_star
id|pointer
)paren
(brace
r_int
id|phandle
comma
id|i
comma
id|mem_len
comma
id|buffer
(braket
l_int|32
)braket
suffix:semicolon
r_char
id|temp
(braket
l_int|12
)braket
suffix:semicolon
id|temp
(braket
l_int|0
)braket
op_assign
l_char|&squot;/&squot;
suffix:semicolon
id|temp
(braket
l_int|1
)braket
op_assign
l_char|&squot;m&squot;
suffix:semicolon
id|temp
(braket
l_int|2
)braket
op_assign
l_char|&squot;e&squot;
suffix:semicolon
id|temp
(braket
l_int|3
)braket
op_assign
l_char|&squot;m&squot;
suffix:semicolon
id|temp
(braket
l_int|4
)braket
op_assign
l_char|&squot;o&squot;
suffix:semicolon
id|temp
(braket
l_int|5
)braket
op_assign
l_char|&squot;r&squot;
suffix:semicolon
id|temp
(braket
l_int|6
)braket
op_assign
l_char|&squot;y&squot;
suffix:semicolon
id|temp
(braket
l_int|7
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|phandle
op_assign
id|OF_finddevice
c_func
(paren
id|o
comma
id|temp
)paren
suffix:semicolon
id|temp
(braket
l_int|0
)braket
op_assign
l_char|&squot;r&squot;
suffix:semicolon
id|temp
(braket
l_int|1
)braket
op_assign
l_char|&squot;e&squot;
suffix:semicolon
id|temp
(braket
l_int|2
)braket
op_assign
l_char|&squot;g&squot;
suffix:semicolon
id|temp
(braket
l_int|3
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|mem_len
op_assign
id|OF_getproplen
c_func
(paren
id|o
comma
id|phandle
comma
id|temp
)paren
suffix:semicolon
id|OF_getprop
c_func
(paren
id|o
comma
id|phandle
comma
id|temp
comma
id|buffer
comma
id|mem_len
)paren
suffix:semicolon
op_star
id|nomr
op_assign
id|mem_len
op_rshift
l_int|3
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|mem_len
op_div
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|pointer
(braket
id|i
)braket
op_assign
id|of_decode_int
c_func
(paren
(paren
r_const
r_int
r_char
op_star
)paren
op_amp
id|buffer
(braket
id|i
)braket
)paren
suffix:semicolon
id|temp
(braket
l_int|0
)braket
op_assign
l_char|&squot;/&squot;
suffix:semicolon
id|temp
(braket
l_int|1
)braket
op_assign
l_char|&squot;c&squot;
suffix:semicolon
id|temp
(braket
l_int|2
)braket
op_assign
l_char|&squot;h&squot;
suffix:semicolon
id|temp
(braket
l_int|3
)braket
op_assign
l_char|&squot;o&squot;
suffix:semicolon
id|temp
(braket
l_int|4
)braket
op_assign
l_char|&squot;s&squot;
suffix:semicolon
id|temp
(braket
l_int|5
)braket
op_assign
l_char|&squot;e&squot;
suffix:semicolon
id|temp
(braket
l_int|6
)braket
op_assign
l_char|&squot;n&squot;
suffix:semicolon
id|temp
(braket
l_int|7
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|phandle
op_assign
id|OF_finddevice
c_func
(paren
id|o
comma
id|temp
)paren
suffix:semicolon
id|temp
(braket
l_int|0
)braket
op_assign
l_char|&squot;b&squot;
suffix:semicolon
id|temp
(braket
l_int|1
)braket
op_assign
l_char|&squot;o&squot;
suffix:semicolon
id|temp
(braket
l_int|2
)braket
op_assign
l_char|&squot;o&squot;
suffix:semicolon
id|temp
(braket
l_int|3
)braket
op_assign
l_char|&squot;t&squot;
suffix:semicolon
id|temp
(braket
l_int|4
)braket
op_assign
l_char|&squot;a&squot;
suffix:semicolon
id|temp
(braket
l_int|5
)braket
op_assign
l_char|&squot;r&squot;
suffix:semicolon
id|temp
(braket
l_int|6
)braket
op_assign
l_char|&squot;g&squot;
suffix:semicolon
id|temp
(braket
l_int|7
)braket
op_assign
l_char|&squot;s&squot;
suffix:semicolon
id|temp
(braket
l_int|8
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|mem_len
op_assign
id|OF_getproplen
c_func
(paren
id|o
comma
id|phandle
comma
id|temp
)paren
suffix:semicolon
id|OF_getprop
c_func
(paren
id|o
comma
id|phandle
comma
id|temp
comma
id|buffer
comma
id|mem_len
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|mem_len
op_div
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|pointer
(braket
id|i
op_plus
l_int|32
)braket
op_assign
id|buffer
(braket
id|i
)braket
suffix:semicolon
)brace
eof
