multiline_comment|/*&n; * arch/arm/mach-ixp2000/pci.c&n; *&n; * PCI routines for IXDP2400/IXDP2800 boards&n; *&n; * Original Author: Naeem Afzal &lt;naeem.m.afzal@intel.com&gt;&n; * Maintained by: Deepak Saxena &lt;dsaxena@plexity.net&gt;&n; *&n; * Copyright 2002 Intel Corp.&n; * Copyright (C) 2003-2004 MontaVista Software, Inc.&n; *&n; *  This program is free software; you can redistribute  it and/or modify it&n; *  under  the terms of  the GNU General  Public License as published by the&n; *  Free Software Foundation;  either version 2 of the  License, or (at your&n; *  option) any later version.&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/mach-types.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/mach/pci.h&gt;
DECL|variable|pci_master_aborts
r_static
r_int
id|pci_master_aborts
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|clear_master_aborts
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
id|u32
op_star
DECL|function|ixp2000_pci_config_addr
id|ixp2000_pci_config_addr
c_func
(paren
r_int
r_int
id|bus_nr
comma
r_int
r_int
id|devfn
comma
r_int
id|where
)paren
(brace
id|u32
op_star
id|paddress
suffix:semicolon
r_if
c_cond
(paren
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
OG
l_int|7
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Must be dword aligned */
id|where
op_and_assign
op_complement
l_int|3
suffix:semicolon
multiline_comment|/*&n;&t; * For top bus, generate type 0, else type 1&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|bus_nr
)paren
(brace
multiline_comment|/* only bits[23:16] are used for IDSEL */
id|paddress
op_assign
(paren
id|u32
op_star
)paren
(paren
id|IXP2000_PCI_CFG0_VIRT_BASE
op_or
(paren
l_int|1
op_lshift
(paren
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
op_plus
l_int|16
)paren
)paren
op_or
(paren
id|PCI_FUNC
c_func
(paren
id|devfn
)paren
op_lshift
l_int|8
)paren
op_or
id|where
)paren
suffix:semicolon
)brace
r_else
(brace
id|paddress
op_assign
(paren
id|u32
op_star
)paren
(paren
id|IXP2000_PCI_CFG1_VIRT_BASE
op_or
(paren
id|bus_nr
op_lshift
l_int|16
)paren
op_or
(paren
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
op_lshift
l_int|11
)paren
op_or
(paren
id|PCI_FUNC
c_func
(paren
id|devfn
)paren
op_lshift
l_int|8
)paren
op_or
id|where
)paren
suffix:semicolon
)brace
r_return
id|paddress
suffix:semicolon
)brace
multiline_comment|/*&n; * Mask table, bits to mask for quantity of size 1, 2 or 4 bytes.&n; * 0 and 3 are not valid indexes...&n; */
DECL|variable|bytemask
r_static
id|u32
id|bytemask
(braket
)braket
op_assign
(brace
multiline_comment|/*0*/
l_int|0
comma
multiline_comment|/*1*/
l_int|0xff
comma
multiline_comment|/*2*/
l_int|0xffff
comma
multiline_comment|/*3*/
l_int|0
comma
multiline_comment|/*4*/
l_int|0xffffffff
comma
)brace
suffix:semicolon
DECL|function|ixp2000_pci_read_config
r_int
id|ixp2000_pci_read_config
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
op_star
id|value
)paren
(brace
id|u32
id|n
suffix:semicolon
id|u32
op_star
id|addr
suffix:semicolon
id|n
op_assign
id|where
op_mod
l_int|4
suffix:semicolon
id|addr
op_assign
id|ixp2000_pci_config_addr
c_func
(paren
id|bus-&gt;number
comma
id|devfn
comma
id|where
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|pci_master_aborts
op_assign
l_int|0
suffix:semicolon
op_star
id|value
op_assign
(paren
op_star
id|addr
op_rshift
(paren
l_int|8
op_star
id|n
)paren
)paren
op_amp
id|bytemask
(braket
id|size
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pci_master_aborts
)paren
(brace
id|pci_master_aborts
op_assign
l_int|0
suffix:semicolon
op_star
id|value
op_assign
l_int|0xffffffff
suffix:semicolon
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
)brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
multiline_comment|/*&n; * We don&squot;t do error checks by callling clear_master_aborts() b/c the&n; * assumption is that the caller did a read first to make sure a device&n; * exists.&n; */
DECL|function|ixp2000_pci_write_config
r_int
id|ixp2000_pci_write_config
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
id|value
)paren
(brace
id|u32
id|mask
suffix:semicolon
id|u32
op_star
id|addr
suffix:semicolon
id|u32
id|temp
suffix:semicolon
id|mask
op_assign
op_complement
(paren
id|bytemask
(braket
id|size
)braket
op_lshift
(paren
(paren
id|where
op_mod
l_int|0x4
)paren
op_star
l_int|8
)paren
)paren
suffix:semicolon
id|addr
op_assign
id|ixp2000_pci_config_addr
c_func
(paren
id|bus-&gt;number
comma
id|devfn
comma
id|where
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
id|temp
op_assign
(paren
id|u32
)paren
(paren
id|value
)paren
op_lshift
(paren
(paren
id|where
op_mod
l_int|0x4
)paren
op_star
l_int|8
)paren
suffix:semicolon
op_star
id|addr
op_assign
(paren
op_star
id|addr
op_amp
id|mask
)paren
op_or
id|temp
suffix:semicolon
id|clear_master_aborts
c_func
(paren
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|variable|ixp2000_pci_ops
r_static
r_struct
id|pci_ops
id|ixp2000_pci_ops
op_assign
(brace
dot
id|read
op_assign
id|ixp2000_pci_read_config
comma
dot
id|write
op_assign
id|ixp2000_pci_write_config
)brace
suffix:semicolon
DECL|function|ixp2000_pci_scan_bus
r_struct
id|pci_bus
op_star
id|ixp2000_pci_scan_bus
c_func
(paren
r_int
id|nr
comma
r_struct
id|pci_sys_data
op_star
id|sysdata
)paren
(brace
r_return
id|pci_scan_bus
c_func
(paren
id|sysdata-&gt;busnr
comma
op_amp
id|ixp2000_pci_ops
comma
id|sysdata
)paren
suffix:semicolon
)brace
DECL|function|ixp2000_pci_abort_handler
r_int
id|ixp2000_pci_abort_handler
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|fsr
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_volatile
id|u32
id|temp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|pci_master_aborts
op_assign
l_int|1
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|temp
op_assign
op_star
(paren
id|IXP2000_PCI_CONTROL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
(paren
(paren
l_int|1
op_lshift
l_int|8
)paren
op_or
(paren
l_int|1
op_lshift
l_int|5
)paren
)paren
)paren
(brace
id|ixp2000_reg_write
c_func
(paren
id|IXP2000_PCI_CONTROL
comma
id|temp
)paren
suffix:semicolon
)brace
id|temp
op_assign
op_star
(paren
id|IXP2000_PCI_CMDSTAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
(paren
l_int|1
op_lshift
l_int|29
)paren
)paren
(brace
r_while
c_loop
(paren
id|temp
op_amp
(paren
l_int|1
op_lshift
l_int|29
)paren
)paren
(brace
id|ixp2000_reg_write
c_func
(paren
id|IXP2000_PCI_CMDSTAT
comma
id|temp
)paren
suffix:semicolon
id|temp
op_assign
op_star
(paren
id|IXP2000_PCI_CMDSTAT
)paren
suffix:semicolon
)brace
)brace
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If it was an imprecise abort, then we need to correct the&n;&t; * return address to be _after_ the instruction.&n;&t; */
r_if
c_cond
(paren
id|fsr
op_amp
(paren
l_int|1
op_lshift
l_int|10
)paren
)paren
id|regs-&gt;ARM_pc
op_add_assign
l_int|4
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|clear_master_aborts
id|clear_master_aborts
c_func
(paren
r_void
)paren
(brace
r_volatile
id|u32
id|temp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|temp
op_assign
op_star
(paren
id|IXP2000_PCI_CONTROL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
(paren
(paren
l_int|1
op_lshift
l_int|8
)paren
op_or
(paren
l_int|1
op_lshift
l_int|5
)paren
)paren
)paren
(brace
id|ixp2000_reg_write
c_func
(paren
id|IXP2000_PCI_CONTROL
comma
id|temp
)paren
suffix:semicolon
)brace
id|temp
op_assign
op_star
(paren
id|IXP2000_PCI_CMDSTAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
(paren
l_int|1
op_lshift
l_int|29
)paren
)paren
(brace
r_while
c_loop
(paren
id|temp
op_amp
(paren
l_int|1
op_lshift
l_int|29
)paren
)paren
(brace
id|ixp2000_reg_write
c_func
(paren
id|IXP2000_PCI_CMDSTAT
comma
id|temp
)paren
suffix:semicolon
id|temp
op_assign
op_star
(paren
id|IXP2000_PCI_CMDSTAT
)paren
suffix:semicolon
)brace
)brace
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
id|__init
DECL|function|ixp2000_pci_preinit
id|ixp2000_pci_preinit
c_func
(paren
r_void
)paren
(brace
id|hook_fault_code
c_func
(paren
l_int|16
op_plus
l_int|6
comma
id|ixp2000_pci_abort_handler
comma
id|SIGBUS
comma
l_string|&quot;PCI config cycle to non-existent device&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * IXP2000 systems often have large resource requirements, so we just&n; * use our own resource space.&n; */
DECL|variable|ixp2000_pci_mem_space
r_static
r_struct
id|resource
id|ixp2000_pci_mem_space
op_assign
(brace
dot
id|start
op_assign
l_int|0x00000000
comma
dot
id|end
op_assign
l_int|0xffffffff
comma
dot
id|flags
op_assign
id|IORESOURCE_MEM
comma
dot
id|name
op_assign
l_string|&quot;PCI Mem Space&quot;
)brace
suffix:semicolon
DECL|variable|ixp2000_pci_io_space
r_static
r_struct
id|resource
id|ixp2000_pci_io_space
op_assign
(brace
dot
id|start
op_assign
l_int|0x00000000
comma
dot
id|end
op_assign
l_int|0xffffffff
comma
dot
id|flags
op_assign
id|IORESOURCE_IO
comma
dot
id|name
op_assign
l_string|&quot;PCI I/O Space&quot;
)brace
suffix:semicolon
DECL|function|ixp2000_pci_setup
r_int
id|ixp2000_pci_setup
c_func
(paren
r_int
id|nr
comma
r_struct
id|pci_sys_data
op_star
id|sys
)paren
(brace
r_if
c_cond
(paren
id|nr
op_ge
l_int|1
)paren
r_return
l_int|0
suffix:semicolon
id|sys-&gt;resource
(braket
l_int|0
)braket
op_assign
op_amp
id|ixp2000_pci_io_space
suffix:semicolon
id|sys-&gt;resource
(braket
l_int|1
)braket
op_assign
op_amp
id|ixp2000_pci_mem_space
suffix:semicolon
id|sys-&gt;resource
(braket
l_int|2
)braket
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
eof
