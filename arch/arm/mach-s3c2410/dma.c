multiline_comment|/* linux/arch/arm/mach-bast/dma.c&n; *&n; * (c) 2003,2004 Simtec Electronics&n; *&t;Ben Dooks &lt;ben@simtec.co.uk&gt;&n; *&n; * S3C2410 DMA core&n; *&n; * http://www.simtec.co.uk/products/EB2410ITX/&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; * Changelog:&n; *  18-Nov-2004 BJD  Removed error for loading onto stopped channel&n; *  10-Nov-2004 BJD  Ensure all external symbols exported for modules&n; *  10-Nov-2004 BJD  Use sys_device and sysdev_class for power management&n; *  08-Aug-2004 BJD  Apply rmk&squot;s suggestions&n; *  21-Jul-2004 BJD  Ported to linux 2.6&n; *  12-Jul-2004 BJD  Finished re-write and change of API&n; *  06-Jul-2004 BJD  Rewrote dma code to try and cope with various problems&n; *  23-May-2003 BJD  Created file&n; *  19-Aug-2003 BJD  Cleanup, header fix, added URL&n; *&n; * This file is based on the Sangwook Lee/Samsung patches, re-written due&n; * to various ommisions from the code (such as flexible dma configuration)&n; * for use with the BAST system board.&n; *&n; * The re-write is pretty much complete, and should be good enough for any&n; * possible DMA function&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#ifdef CONFIG_S3C2410_DMA_DEBUG
DECL|macro|DEBUG
mdefine_line|#define DEBUG
macro_line|#endif
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/sysdev.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/mach/dma.h&gt;
macro_line|#include &lt;asm/arch/map.h&gt;
multiline_comment|/* io map for dma */
DECL|variable|dma_base
r_static
r_void
id|__iomem
op_star
id|dma_base
suffix:semicolon
multiline_comment|/* dma channel state information */
DECL|variable|s3c2410_chans
id|s3c2410_dma_chan_t
id|s3c2410_chans
(braket
id|S3C2410_DMA_CHANNELS
)braket
suffix:semicolon
multiline_comment|/* debugging functions */
DECL|macro|BUF_MAGIC
mdefine_line|#define BUF_MAGIC (0xcafebabe)
DECL|macro|dmawarn
mdefine_line|#define dmawarn(fmt...) printk(KERN_DEBUG fmt)
DECL|macro|dma_regaddr
mdefine_line|#define dma_regaddr(chan, reg) ((chan)-&gt;regs + (reg))
macro_line|#if 1
DECL|macro|dma_wrreg
mdefine_line|#define dma_wrreg(chan, reg, val) writel((val), (chan)-&gt;regs + (reg))
macro_line|#else
r_static
r_inline
r_void
DECL|function|dma_wrreg
id|dma_wrreg
c_func
(paren
id|s3c2410_dma_chan_t
op_star
id|chan
comma
r_int
id|reg
comma
r_int
r_int
id|val
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;writing %08x to register %08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|val
comma
id|reg
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|dma_regaddr
c_func
(paren
id|chan
comma
id|reg
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|macro|dma_rdreg
mdefine_line|#define dma_rdreg(chan, reg) readl((chan)-&gt;regs + (reg))
multiline_comment|/* captured register state for debug */
DECL|struct|s3c2410_dma_regstate
r_struct
id|s3c2410_dma_regstate
(brace
DECL|member|dcsrc
r_int
r_int
id|dcsrc
suffix:semicolon
DECL|member|disrc
r_int
r_int
id|disrc
suffix:semicolon
DECL|member|dstat
r_int
r_int
id|dstat
suffix:semicolon
DECL|member|dcon
r_int
r_int
id|dcon
suffix:semicolon
DECL|member|dmsktrig
r_int
r_int
id|dmsktrig
suffix:semicolon
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_S3C2410_DMA_DEBUG
multiline_comment|/* dmadbg_showregs&n; *&n; * simple debug routine to print the current state of the dma registers&n;*/
r_static
r_void
DECL|function|dmadbg_capture
id|dmadbg_capture
c_func
(paren
id|s3c2410_dma_chan_t
op_star
id|chan
comma
r_struct
id|s3c2410_dma_regstate
op_star
id|regs
)paren
(brace
id|regs-&gt;dcsrc
op_assign
id|dma_rdreg
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DCSRC
)paren
suffix:semicolon
id|regs-&gt;disrc
op_assign
id|dma_rdreg
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DISRC
)paren
suffix:semicolon
id|regs-&gt;dstat
op_assign
id|dma_rdreg
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DSTAT
)paren
suffix:semicolon
id|regs-&gt;dcon
op_assign
id|dma_rdreg
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DCON
)paren
suffix:semicolon
id|regs-&gt;dmsktrig
op_assign
id|dma_rdreg
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DMASKTRIG
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|dmadbg_showregs
id|dmadbg_showregs
c_func
(paren
r_const
r_char
op_star
id|fname
comma
r_int
id|line
comma
id|s3c2410_dma_chan_t
op_star
id|chan
comma
r_struct
id|s3c2410_dma_regstate
op_star
id|regs
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;dma%d: %s:%d: DCSRC=%08lx, DISRC=%08lx, DSTAT=%08lx DMT=%02lx, DCON=%08lx&bslash;n&quot;
comma
id|chan-&gt;number
comma
id|fname
comma
id|line
comma
id|regs-&gt;dcsrc
comma
id|regs-&gt;disrc
comma
id|regs-&gt;dstat
comma
id|regs-&gt;dmsktrig
comma
id|regs-&gt;dcon
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|dmadbg_showchan
id|dmadbg_showchan
c_func
(paren
r_const
r_char
op_star
id|fname
comma
r_int
id|line
comma
id|s3c2410_dma_chan_t
op_star
id|chan
)paren
(brace
r_struct
id|s3c2410_dma_regstate
id|state
suffix:semicolon
id|dmadbg_capture
c_func
(paren
id|chan
comma
op_amp
id|state
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;dma%d: %s:%d: ls=%d, cur=%p, %p %p&bslash;n&quot;
comma
id|chan-&gt;number
comma
id|fname
comma
id|line
comma
id|chan-&gt;load_state
comma
id|chan-&gt;curr
comma
id|chan-&gt;next
comma
id|chan-&gt;end
)paren
suffix:semicolon
id|dmadbg_showregs
c_func
(paren
id|fname
comma
id|line
comma
id|chan
comma
op_amp
id|state
)paren
suffix:semicolon
)brace
DECL|macro|dbg_showregs
mdefine_line|#define dbg_showregs(chan) dmadbg_showregs(__FUNCTION__, __LINE__, (chan))
DECL|macro|dbg_showchan
mdefine_line|#define dbg_showchan(chan) dmadbg_showchan(__FUNCTION__, __LINE__, (chan))
macro_line|#else
DECL|macro|dbg_showregs
mdefine_line|#define dbg_showregs(chan) do { } while(0)
DECL|macro|dbg_showchan
mdefine_line|#define dbg_showchan(chan) do { } while(0)
macro_line|#endif /* CONFIG_S3C2410_DMA_DEBUG */
DECL|macro|check_channel
mdefine_line|#define check_channel(chan) &bslash;&n;  do { if ((chan) &gt;= S3C2410_DMA_CHANNELS) { &bslash;&n;    printk(KERN_ERR &quot;%s: invalid channel %d&bslash;n&quot;, __FUNCTION__, (chan)); &bslash;&n;    return -EINVAL; &bslash;&n;  } } while(0)
multiline_comment|/* s3c2410_dma_stats_timeout&n; *&n; * Update DMA stats from timeout info&n;*/
r_static
r_void
DECL|function|s3c2410_dma_stats_timeout
id|s3c2410_dma_stats_timeout
c_func
(paren
id|s3c2410_dma_stats_t
op_star
id|stats
comma
r_int
id|val
)paren
(brace
r_if
c_cond
(paren
id|stats
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|val
OG
id|stats-&gt;timeout_longest
)paren
id|stats-&gt;timeout_longest
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
id|val
OL
id|stats-&gt;timeout_shortest
)paren
id|stats-&gt;timeout_shortest
op_assign
id|val
suffix:semicolon
id|stats-&gt;timeout_avg
op_add_assign
id|val
suffix:semicolon
)brace
multiline_comment|/* s3c2410_dma_waitforload&n; *&n; * wait for the DMA engine to load a buffer, and update the state accordingly&n;*/
r_static
r_int
DECL|function|s3c2410_dma_waitforload
id|s3c2410_dma_waitforload
c_func
(paren
id|s3c2410_dma_chan_t
op_star
id|chan
comma
r_int
id|line
)paren
(brace
r_int
id|timeout
op_assign
id|chan-&gt;load_timeout
suffix:semicolon
r_int
id|took
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;load_state
op_ne
id|S3C2410_DMALOAD_1LOADED
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma%d: s3c2410_dma_waitforload() called in loadstate %d from line %d&bslash;n&quot;
comma
id|chan-&gt;number
comma
id|chan-&gt;load_state
comma
id|line
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chan-&gt;stats
op_ne
l_int|NULL
)paren
id|chan-&gt;stats-&gt;loads
op_increment
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|timeout
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|dma_rdreg
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DSTAT
)paren
op_lshift
(paren
l_int|32
op_minus
l_int|20
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|took
op_assign
id|chan-&gt;load_timeout
op_minus
id|timeout
suffix:semicolon
id|s3c2410_dma_stats_timeout
c_func
(paren
id|chan-&gt;stats
comma
id|took
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|chan-&gt;load_state
)paren
(brace
r_case
id|S3C2410_DMALOAD_1LOADED
suffix:colon
id|chan-&gt;load_state
op_assign
id|S3C2410_DMALOAD_1RUNNING
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma%d: unknown load_state in s3c2410_dma_waitforload() %d&bslash;n&quot;
comma
id|chan-&gt;number
comma
id|chan-&gt;load_state
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|chan-&gt;stats
op_ne
l_int|NULL
)paren
(brace
id|chan-&gt;stats-&gt;timeout_failed
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* s3c2410_dma_loadbuffer&n; *&n; * load a buffer, and update the channel state&n;*/
r_static
r_inline
r_int
DECL|function|s3c2410_dma_loadbuffer
id|s3c2410_dma_loadbuffer
c_func
(paren
id|s3c2410_dma_chan_t
op_star
id|chan
comma
id|s3c2410_dma_buf_t
op_star
id|buf
)paren
(brace
r_int
r_int
id|reload
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;s3c2410_chan_loadbuffer: loading buff %p (0x%08lx,0x%06x)&bslash;n&quot;
comma
id|buf
comma
(paren
r_int
r_int
)paren
id|buf-&gt;data
comma
id|buf-&gt;size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
op_eq
l_int|NULL
)paren
(brace
id|dmawarn
c_func
(paren
l_string|&quot;buffer is NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* check the state of the channel before we do anything */
r_if
c_cond
(paren
id|chan-&gt;load_state
op_eq
id|S3C2410_DMALOAD_1LOADED
)paren
(brace
id|dmawarn
c_func
(paren
l_string|&quot;load_state is S3C2410_DMALOAD_1LOADED&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chan-&gt;load_state
op_eq
id|S3C2410_DMALOAD_1LOADED_1RUNNING
)paren
(brace
id|dmawarn
c_func
(paren
l_string|&quot;state is S3C2410_DMALOAD_1LOADED_1RUNNING&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* it would seem sensible if we are the last buffer to not bother&n;&t; * with the auto-reload bit, so that the DMA engine will not try&n;&t; * and load another transfer after this one has finished...&n;&t; */
r_if
c_cond
(paren
id|chan-&gt;load_state
op_eq
id|S3C2410_DMALOAD_NONE
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;load_state is none, checking for noreload (next=%p)&bslash;n&quot;
comma
id|buf-&gt;next
)paren
suffix:semicolon
id|reload
op_assign
(paren
id|buf-&gt;next
op_eq
l_int|NULL
)paren
ques
c_cond
id|S3C2410_DCON_NORELOAD
suffix:colon
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|pr_debug
c_func
(paren
l_string|&quot;load_state is %d =&gt; autoreload&bslash;n&quot;
comma
id|chan-&gt;load_state
)paren
suffix:semicolon
id|reload
op_assign
id|S3C2410_DCON_AUTORELOAD
suffix:semicolon
)brace
id|writel
c_func
(paren
id|buf-&gt;data
comma
id|chan-&gt;addr_reg
)paren
suffix:semicolon
id|dma_wrreg
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DCON
comma
id|chan-&gt;dcon
op_or
id|reload
op_or
(paren
id|buf-&gt;size
op_div
id|chan-&gt;xfer_unit
)paren
)paren
suffix:semicolon
id|chan-&gt;next
op_assign
id|buf-&gt;next
suffix:semicolon
multiline_comment|/* update the state of the channel */
r_switch
c_cond
(paren
id|chan-&gt;load_state
)paren
(brace
r_case
id|S3C2410_DMALOAD_NONE
suffix:colon
id|chan-&gt;load_state
op_assign
id|S3C2410_DMALOAD_1LOADED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|S3C2410_DMALOAD_1RUNNING
suffix:colon
id|chan-&gt;load_state
op_assign
id|S3C2410_DMALOAD_1LOADED_1RUNNING
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dmawarn
c_func
(paren
l_string|&quot;dmaload: unknown state %d in loadbuffer&bslash;n&quot;
comma
id|chan-&gt;load_state
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* s3c2410_dma_call_op&n; *&n; * small routine to call the op routine with the given op if it has been&n; * registered&n;*/
r_static
r_void
DECL|function|s3c2410_dma_call_op
id|s3c2410_dma_call_op
c_func
(paren
id|s3c2410_dma_chan_t
op_star
id|chan
comma
id|s3c2410_chan_op_t
id|op
)paren
(brace
r_if
c_cond
(paren
id|chan-&gt;op_fn
op_ne
l_int|NULL
)paren
(brace
(paren
id|chan-&gt;op_fn
)paren
(paren
id|chan
comma
id|op
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* s3c2410_dma_buffdone&n; *&n; * small wrapper to check if callback routine needs to be called, and&n; * if so, call it&n;*/
r_static
r_inline
r_void
DECL|function|s3c2410_dma_buffdone
id|s3c2410_dma_buffdone
c_func
(paren
id|s3c2410_dma_chan_t
op_star
id|chan
comma
id|s3c2410_dma_buf_t
op_star
id|buf
comma
id|s3c2410_dma_buffresult_t
id|result
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;callback_fn=%p, buf=%p, id=%p, size=%d, result=%d&bslash;n&quot;
comma
id|chan-&gt;callback_fn
comma
id|buf
comma
id|buf-&gt;id
comma
id|buf-&gt;size
comma
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;callback_fn
op_ne
l_int|NULL
)paren
(brace
(paren
id|chan-&gt;callback_fn
)paren
(paren
id|chan
comma
id|buf-&gt;id
comma
id|buf-&gt;size
comma
id|result
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* s3c2410_dma_start&n; *&n; * start a dma channel going&n;*/
DECL|function|s3c2410_dma_start
r_static
r_int
id|s3c2410_dma_start
c_func
(paren
id|s3c2410_dma_chan_t
op_star
id|chan
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;s3c2410_start_dma: channel=%d&bslash;n&quot;
comma
id|chan-&gt;number
)paren
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;state
op_eq
id|S3C2410_DMA_RUNNING
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;s3c2410_start_dma: already running (%d)&bslash;n&quot;
comma
id|chan-&gt;state
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|chan-&gt;state
op_assign
id|S3C2410_DMA_RUNNING
suffix:semicolon
multiline_comment|/* check wether there is anything to load, and if not, see&n;&t; * if we can find anything to load&n;&t; */
r_if
c_cond
(paren
id|chan-&gt;load_state
op_eq
id|S3C2410_DMALOAD_NONE
)paren
(brace
r_if
c_cond
(paren
id|chan-&gt;next
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma%d: channel has nothing loaded&bslash;n&quot;
comma
id|chan-&gt;number
)paren
suffix:semicolon
id|chan-&gt;state
op_assign
id|S3C2410_DMA_IDLE
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|s3c2410_dma_loadbuffer
c_func
(paren
id|chan
comma
id|chan-&gt;next
)paren
suffix:semicolon
)brace
id|dbg_showchan
c_func
(paren
id|chan
)paren
suffix:semicolon
multiline_comment|/* enable the channel */
r_if
c_cond
(paren
op_logical_neg
id|chan-&gt;irq_enabled
)paren
(brace
id|enable_irq
c_func
(paren
id|chan-&gt;irq
)paren
suffix:semicolon
id|chan-&gt;irq_enabled
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* start the channel going */
id|tmp
op_assign
id|dma_rdreg
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DMASKTRIG
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
id|S3C2410_DMASKTRIG_STOP
suffix:semicolon
id|tmp
op_or_assign
id|S3C2410_DMASKTRIG_ON
suffix:semicolon
id|dma_wrreg
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DMASKTRIG
comma
id|tmp
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;wrote %08lx to DMASKTRIG&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* the dma buffer loads should take care of clearing the AUTO&n;&t; * reloading feature */
id|tmp
op_assign
id|dma_rdreg
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DCON
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
id|S3C2410_DCON_NORELOAD
suffix:semicolon
id|dma_wrreg
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DCON
comma
id|tmp
)paren
suffix:semicolon
macro_line|#endif
id|s3c2410_dma_call_op
c_func
(paren
id|chan
comma
id|S3C2410_DMAOP_START
)paren
suffix:semicolon
id|dbg_showchan
c_func
(paren
id|chan
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* s3c2410_dma_canload&n; *&n; * work out if we can queue another buffer into the DMA engine&n;*/
r_static
r_int
DECL|function|s3c2410_dma_canload
id|s3c2410_dma_canload
c_func
(paren
id|s3c2410_dma_chan_t
op_star
id|chan
)paren
(brace
r_if
c_cond
(paren
id|chan-&gt;load_state
op_eq
id|S3C2410_DMALOAD_NONE
op_logical_or
id|chan-&gt;load_state
op_eq
id|S3C2410_DMALOAD_1RUNNING
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* s3c2410_dma_enqueue&n; *&n; * queue an given buffer for dma transfer.&n; *&n; * id         the device driver&squot;s id information for this buffer&n; * data       the physical address of the buffer data&n; * size       the size of the buffer in bytes&n; *&n; * If the channel is not running, then the flag S3C2410_DMAF_AUTOSTART&n; * is checked, and if set, the channel is started. If this flag isn&squot;t set,&n; * then an error will be returned.&n; *&n; * It is possible to queue more than one DMA buffer onto a channel at&n; * once, and the code will deal with the re-loading of the next buffer&n; * when necessary.&n;*/
DECL|function|s3c2410_dma_enqueue
r_int
id|s3c2410_dma_enqueue
c_func
(paren
r_int
r_int
id|channel
comma
r_void
op_star
id|id
comma
id|dma_addr_t
id|data
comma
r_int
id|size
)paren
(brace
id|s3c2410_dma_chan_t
op_star
id|chan
op_assign
op_amp
id|s3c2410_chans
(braket
id|channel
)braket
suffix:semicolon
id|s3c2410_dma_buf_t
op_star
id|buf
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|check_channel
c_func
(paren
id|channel
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: id=%p, data=%08x, size=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|id
comma
(paren
r_int
r_int
)paren
id|data
comma
id|size
)paren
suffix:semicolon
id|buf
op_assign
(paren
id|s3c2410_dma_buf_t
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|buf
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
op_eq
l_int|NULL
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;%s: out of memory (%d alloc)&bslash;n&quot;
comma
id|__FUNCTION__
comma
r_sizeof
(paren
op_star
id|buf
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|pr_debug
c_func
(paren
l_string|&quot;%s: new buffer %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|buf
)paren
suffix:semicolon
singleline_comment|//dbg_showchan(chan);
id|buf-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|buf-&gt;data
op_assign
id|buf-&gt;ptr
op_assign
id|data
suffix:semicolon
id|buf-&gt;size
op_assign
id|size
suffix:semicolon
id|buf-&gt;id
op_assign
id|id
suffix:semicolon
id|buf-&gt;magic
op_assign
id|BUF_MAGIC
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;curr
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* we&squot;ve got nothing loaded... */
id|pr_debug
c_func
(paren
l_string|&quot;%s: buffer %p queued onto empty channel&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|buf
)paren
suffix:semicolon
id|chan-&gt;curr
op_assign
id|buf
suffix:semicolon
id|chan-&gt;end
op_assign
id|buf
suffix:semicolon
id|chan-&gt;next
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|pr_debug
c_func
(paren
l_string|&quot;dma%d: %s: buffer %p queued onto non-empty channel&bslash;n&quot;
comma
id|chan-&gt;number
comma
id|__FUNCTION__
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;end
op_eq
l_int|NULL
)paren
id|pr_debug
c_func
(paren
l_string|&quot;dma%d: %s: %p not empty, and chan-&gt;end==NULL?&bslash;n&quot;
comma
id|chan-&gt;number
comma
id|__FUNCTION__
comma
id|chan
)paren
suffix:semicolon
id|chan-&gt;end-&gt;next
op_assign
id|buf
suffix:semicolon
id|chan-&gt;end
op_assign
id|buf
suffix:semicolon
)brace
multiline_comment|/* if necessary, update the next buffer field */
r_if
c_cond
(paren
id|chan-&gt;next
op_eq
l_int|NULL
)paren
id|chan-&gt;next
op_assign
id|buf
suffix:semicolon
multiline_comment|/* check to see if we can load a buffer */
r_if
c_cond
(paren
id|chan-&gt;state
op_eq
id|S3C2410_DMA_RUNNING
)paren
(brace
r_if
c_cond
(paren
id|chan-&gt;load_state
op_eq
id|S3C2410_DMALOAD_1LOADED
op_logical_and
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|s3c2410_dma_waitforload
c_func
(paren
id|chan
comma
id|__LINE__
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma%d: loadbuffer:&quot;
l_string|&quot;timeout loading buffer&bslash;n&quot;
comma
id|chan-&gt;number
)paren
suffix:semicolon
id|dbg_showchan
c_func
(paren
id|chan
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|s3c2410_dma_canload
c_func
(paren
id|chan
)paren
op_logical_and
id|chan-&gt;next
op_ne
l_int|NULL
)paren
(brace
id|s3c2410_dma_loadbuffer
c_func
(paren
id|chan
comma
id|chan-&gt;next
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|chan-&gt;state
op_eq
id|S3C2410_DMA_IDLE
)paren
(brace
r_if
c_cond
(paren
id|chan-&gt;flags
op_amp
id|S3C2410_DMAF_AUTOSTART
)paren
(brace
id|s3c2410_dma_ctrl
c_func
(paren
id|chan-&gt;number
comma
id|S3C2410_DMAOP_START
)paren
suffix:semicolon
)brace
)brace
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|s3c2410_dma_enqueue
id|EXPORT_SYMBOL
c_func
(paren
id|s3c2410_dma_enqueue
)paren
suffix:semicolon
r_static
r_inline
r_void
DECL|function|s3c2410_dma_freebuf
id|s3c2410_dma_freebuf
c_func
(paren
id|s3c2410_dma_buf_t
op_star
id|buf
)paren
(brace
r_int
id|magicok
op_assign
(paren
id|buf-&gt;magic
op_eq
id|BUF_MAGIC
)paren
suffix:semicolon
id|buf-&gt;magic
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|magicok
)paren
(brace
id|kfree
c_func
(paren
id|buf
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;s3c2410_dma_freebuf: buff %p with bad magic&bslash;n&quot;
comma
id|buf
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* s3c2410_dma_lastxfer&n; *&n; * called when the system is out of buffers, to ensure that the channel&n; * is prepared for shutdown.&n;*/
r_static
r_inline
r_void
DECL|function|s3c2410_dma_lastxfer
id|s3c2410_dma_lastxfer
c_func
(paren
id|s3c2410_dma_chan_t
op_star
id|chan
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;dma%d: s3c2410_dma_lastxfer: load_state %d&bslash;n&quot;
comma
id|chan-&gt;number
comma
id|chan-&gt;load_state
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|chan-&gt;load_state
)paren
(brace
r_case
id|S3C2410_DMALOAD_NONE
suffix:colon
r_break
suffix:semicolon
r_case
id|S3C2410_DMALOAD_1LOADED
suffix:colon
r_if
c_cond
(paren
id|s3c2410_dma_waitforload
c_func
(paren
id|chan
comma
id|__LINE__
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* flag error? */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma%d: timeout waiting for load&bslash;n&quot;
comma
id|chan-&gt;number
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|pr_debug
c_func
(paren
l_string|&quot;dma%d: lastxfer: unhandled load_state %d with no next&quot;
comma
id|chan-&gt;number
comma
id|chan-&gt;load_state
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* hopefully this&squot;ll shut the damned thing up after the transfer... */
id|dma_wrreg
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DCON
comma
id|chan-&gt;dcon
op_or
id|S3C2410_DCON_NORELOAD
)paren
suffix:semicolon
)brace
DECL|macro|dmadbg2
mdefine_line|#define dmadbg2(x...)
r_static
id|irqreturn_t
DECL|function|s3c2410_dma_irq
id|s3c2410_dma_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|devpw
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|s3c2410_dma_chan_t
op_star
id|chan
op_assign
(paren
id|s3c2410_dma_chan_t
op_star
)paren
id|devpw
suffix:semicolon
id|s3c2410_dma_buf_t
op_star
id|buf
suffix:semicolon
id|buf
op_assign
id|chan-&gt;curr
suffix:semicolon
id|dbg_showchan
c_func
(paren
id|chan
)paren
suffix:semicolon
multiline_comment|/* modify the channel state */
r_switch
c_cond
(paren
id|chan-&gt;load_state
)paren
(brace
r_case
id|S3C2410_DMALOAD_1RUNNING
suffix:colon
multiline_comment|/* TODO - if we are running only one buffer, we probably&n;&t;&t; * want to reload here, and then worry about the buffer&n;&t;&t; * callback */
id|chan-&gt;load_state
op_assign
id|S3C2410_DMALOAD_NONE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|S3C2410_DMALOAD_1LOADED
suffix:colon
multiline_comment|/* iirc, we should go back to NONE loaded here, we&n;&t;&t; * had a buffer, and it was never verified as being&n;&t;&t; * loaded.&n;&t;&t; */
id|chan-&gt;load_state
op_assign
id|S3C2410_DMALOAD_NONE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|S3C2410_DMALOAD_1LOADED_1RUNNING
suffix:colon
multiline_comment|/* we&squot;ll worry about checking to see if another buffer is&n;&t;&t; * ready after we&squot;ve called back the owner. This should&n;&t;&t; * ensure we do not wait around too long for the DMA&n;&t;&t; * engine to start the next transfer&n;&t;&t; */
id|chan-&gt;load_state
op_assign
id|S3C2410_DMALOAD_1LOADED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|S3C2410_DMALOAD_NONE
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma%d: IRQ with no loaded buffer?&bslash;n&quot;
comma
id|chan-&gt;number
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma%d: IRQ in invalid load_state %d&bslash;n&quot;
comma
id|chan-&gt;number
comma
id|chan-&gt;load_state
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|buf
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* update the chain to make sure that if we load any more&n;&t;&t; * buffers when we call the callback function, things should&n;&t;&t; * work properly */
id|chan-&gt;curr
op_assign
id|buf-&gt;next
suffix:semicolon
id|buf-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;magic
op_ne
id|BUF_MAGIC
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma%d: %s: buf %p incorrect magic&bslash;n&quot;
comma
id|chan-&gt;number
comma
id|__FUNCTION__
comma
id|buf
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
id|s3c2410_dma_buffdone
c_func
(paren
id|chan
comma
id|buf
comma
id|S3C2410_RES_OK
)paren
suffix:semicolon
multiline_comment|/* free resouces */
id|s3c2410_dma_freebuf
c_func
(paren
id|buf
)paren
suffix:semicolon
)brace
r_else
(brace
)brace
r_if
c_cond
(paren
id|chan-&gt;next
op_ne
l_int|NULL
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_switch
c_cond
(paren
id|chan-&gt;load_state
)paren
(brace
r_case
id|S3C2410_DMALOAD_1RUNNING
suffix:colon
multiline_comment|/* don&squot;t need to do anything for this state */
r_break
suffix:semicolon
r_case
id|S3C2410_DMALOAD_NONE
suffix:colon
multiline_comment|/* can load buffer immediately */
r_break
suffix:semicolon
r_case
id|S3C2410_DMALOAD_1LOADED
suffix:colon
r_if
c_cond
(paren
id|s3c2410_dma_waitforload
c_func
(paren
id|chan
comma
id|__LINE__
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* flag error? */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma%d: timeout waiting for load&bslash;n&quot;
comma
id|chan-&gt;number
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|S3C2410_DMALOAD_1LOADED_1RUNNING
suffix:colon
r_goto
id|no_load
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma%d: unknown load_state in irq, %d&bslash;n&quot;
comma
id|chan-&gt;number
comma
id|chan-&gt;load_state
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|s3c2410_dma_loadbuffer
c_func
(paren
id|chan
comma
id|chan-&gt;next
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|s3c2410_dma_lastxfer
c_func
(paren
id|chan
)paren
suffix:semicolon
multiline_comment|/* see if we can stop this channel.. */
r_if
c_cond
(paren
id|chan-&gt;load_state
op_eq
id|S3C2410_DMALOAD_NONE
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;dma%d: end of transfer, stopping channel (%ld)&bslash;n&quot;
comma
id|chan-&gt;number
comma
id|jiffies
)paren
suffix:semicolon
id|s3c2410_dma_ctrl
c_func
(paren
id|chan-&gt;number
comma
id|S3C2410_DMAOP_STOP
)paren
suffix:semicolon
)brace
)brace
id|no_load
suffix:colon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* s3c2410_request_dma&n; *&n; * get control of an dma channel&n;*/
DECL|function|s3c2410_dma_request
r_int
id|s3c2410_dma_request
c_func
(paren
r_int
r_int
id|channel
comma
id|s3c2410_dma_client_t
op_star
id|client
comma
r_void
op_star
id|dev
)paren
(brace
id|s3c2410_dma_chan_t
op_star
id|chan
op_assign
op_amp
id|s3c2410_chans
(braket
id|channel
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|err
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;dma%d: s3c2410_request_dma: client=%s, dev=%p&bslash;n&quot;
comma
id|channel
comma
id|client-&gt;name
comma
id|dev
)paren
suffix:semicolon
id|check_channel
c_func
(paren
id|channel
)paren
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|dbg_showchan
c_func
(paren
id|chan
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;in_use
)paren
(brace
r_if
c_cond
(paren
id|client
op_ne
id|chan-&gt;client
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma%d: already in use&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma%d: client already has channel&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
)brace
)brace
id|chan-&gt;client
op_assign
id|client
suffix:semicolon
id|chan-&gt;in_use
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chan-&gt;irq_claimed
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;dma%d: %s : requesting irq %d&bslash;n&quot;
comma
id|channel
comma
id|__FUNCTION__
comma
id|chan-&gt;irq
)paren
suffix:semicolon
id|err
op_assign
id|request_irq
c_func
(paren
id|chan-&gt;irq
comma
id|s3c2410_dma_irq
comma
id|SA_INTERRUPT
comma
id|client-&gt;name
comma
(paren
r_void
op_star
)paren
id|chan
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|chan-&gt;in_use
op_assign
l_int|0
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: cannot get IRQ %d for DMA %d&bslash;n&quot;
comma
id|client-&gt;name
comma
id|chan-&gt;irq
comma
id|chan-&gt;number
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|chan-&gt;irq_claimed
op_assign
l_int|1
suffix:semicolon
id|chan-&gt;irq_enabled
op_assign
l_int|1
suffix:semicolon
)brace
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* need to setup */
id|pr_debug
c_func
(paren
l_string|&quot;%s: channel initialised, %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|chan
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|s3c2410_dma_request
id|EXPORT_SYMBOL
c_func
(paren
id|s3c2410_dma_request
)paren
suffix:semicolon
multiline_comment|/* s3c2410_dma_free&n; *&n; * release the given channel back to the system, will stop and flush&n; * any outstanding transfers, and ensure the channel is ready for the&n; * next claimant.&n; *&n; * Note, although a warning is currently printed if the freeing client&n; * info is not the same as the registrant&squot;s client info, the free is still&n; * allowed to go through.&n;*/
DECL|function|s3c2410_dma_free
r_int
id|s3c2410_dma_free
c_func
(paren
id|dmach_t
id|channel
comma
id|s3c2410_dma_client_t
op_star
id|client
)paren
(brace
id|s3c2410_dma_chan_t
op_star
id|chan
op_assign
op_amp
id|s3c2410_chans
(braket
id|channel
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|check_channel
c_func
(paren
id|channel
)paren
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;client
op_ne
id|client
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;dma%d: possible free from different client (channel %p, passed %p)&bslash;n&quot;
comma
id|channel
comma
id|chan-&gt;client
comma
id|client
)paren
suffix:semicolon
)brace
multiline_comment|/* sort out stopping and freeing the channel */
r_if
c_cond
(paren
id|chan-&gt;state
op_ne
id|S3C2410_DMA_IDLE
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;%s: need to stop dma channel %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|chan
)paren
suffix:semicolon
multiline_comment|/* possibly flush the channel */
id|s3c2410_dma_ctrl
c_func
(paren
id|channel
comma
id|S3C2410_DMAOP_STOP
)paren
suffix:semicolon
)brace
id|chan-&gt;client
op_assign
l_int|NULL
suffix:semicolon
id|chan-&gt;in_use
op_assign
l_int|0
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|s3c2410_dma_free
id|EXPORT_SYMBOL
c_func
(paren
id|s3c2410_dma_free
)paren
suffix:semicolon
DECL|function|s3c2410_dma_dostop
r_static
r_int
id|s3c2410_dma_dostop
c_func
(paren
id|s3c2410_dma_chan_t
op_star
id|chan
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s:&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|dbg_showchan
c_func
(paren
id|chan
)paren
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|s3c2410_dma_call_op
c_func
(paren
id|chan
comma
id|S3C2410_DMAOP_STOP
)paren
suffix:semicolon
id|tmp
op_assign
id|dma_rdreg
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DMASKTRIG
)paren
suffix:semicolon
id|tmp
op_or_assign
id|S3C2410_DMASKTRIG_STOP
suffix:semicolon
id|dma_wrreg
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DMASKTRIG
comma
id|tmp
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* should also clear interrupts, according to WinCE BSP */
id|tmp
op_assign
id|dma_rdreg
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DCON
)paren
suffix:semicolon
id|tmp
op_or_assign
id|S3C2410_DCON_NORELOAD
suffix:semicolon
id|dma_wrreg
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DCON
comma
id|tmp
)paren
suffix:semicolon
macro_line|#endif
id|chan-&gt;state
op_assign
id|S3C2410_DMA_IDLE
suffix:semicolon
id|chan-&gt;load_state
op_assign
id|S3C2410_DMALOAD_NONE
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* s3c2410_dma_flush&n; *&n; * stop the channel, and remove all current and pending transfers&n;*/
DECL|function|s3c2410_dma_flush
r_static
r_int
id|s3c2410_dma_flush
c_func
(paren
id|s3c2410_dma_chan_t
op_star
id|chan
)paren
(brace
id|s3c2410_dma_buf_t
op_star
id|buf
comma
op_star
id|next
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s:&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;state
op_ne
id|S3C2410_DMA_IDLE
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;%s: stopping channel...&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|s3c2410_dma_ctrl
c_func
(paren
id|chan-&gt;number
comma
id|S3C2410_DMAOP_STOP
)paren
suffix:semicolon
)brace
id|buf
op_assign
id|chan-&gt;curr
suffix:semicolon
r_if
c_cond
(paren
id|buf
op_eq
l_int|NULL
)paren
id|buf
op_assign
id|chan-&gt;next
suffix:semicolon
id|chan-&gt;curr
op_assign
id|chan-&gt;next
op_assign
id|chan-&gt;end
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|buf
op_ne
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
id|buf
op_ne
l_int|NULL
suffix:semicolon
id|buf
op_assign
id|next
)paren
(brace
id|next
op_assign
id|buf-&gt;next
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: free buffer %p, next %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|buf
comma
id|buf-&gt;next
)paren
suffix:semicolon
id|s3c2410_dma_buffdone
c_func
(paren
id|chan
comma
id|buf
comma
id|S3C2410_RES_ABORT
)paren
suffix:semicolon
id|s3c2410_dma_freebuf
c_func
(paren
id|buf
)paren
suffix:semicolon
)brace
)brace
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|s3c2410_dma_ctrl
id|s3c2410_dma_ctrl
c_func
(paren
id|dmach_t
id|channel
comma
id|s3c2410_chan_op_t
id|op
)paren
(brace
id|s3c2410_dma_chan_t
op_star
id|chan
op_assign
op_amp
id|s3c2410_chans
(braket
id|channel
)braket
suffix:semicolon
id|check_channel
c_func
(paren
id|channel
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|op
)paren
(brace
r_case
id|S3C2410_DMAOP_START
suffix:colon
r_return
id|s3c2410_dma_start
c_func
(paren
id|chan
)paren
suffix:semicolon
r_case
id|S3C2410_DMAOP_STOP
suffix:colon
r_return
id|s3c2410_dma_dostop
c_func
(paren
id|chan
)paren
suffix:semicolon
r_case
id|S3C2410_DMAOP_PAUSE
suffix:colon
r_return
op_minus
id|ENOENT
suffix:semicolon
r_case
id|S3C2410_DMAOP_RESUME
suffix:colon
r_return
op_minus
id|ENOENT
suffix:semicolon
r_case
id|S3C2410_DMAOP_FLUSH
suffix:colon
r_return
id|s3c2410_dma_flush
c_func
(paren
id|chan
)paren
suffix:semicolon
r_case
id|S3C2410_DMAOP_TIMEOUT
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENOENT
suffix:semicolon
multiline_comment|/* unknown, don&squot;t bother */
)brace
DECL|variable|s3c2410_dma_ctrl
id|EXPORT_SYMBOL
c_func
(paren
id|s3c2410_dma_ctrl
)paren
suffix:semicolon
multiline_comment|/* DMA configuration for each channel&n; *&n; * DISRCC -&gt; source of the DMA (AHB,APB)&n; * DISRC  -&gt; source address of the DMA&n; * DIDSTC -&gt; destination of the DMA (AHB,APD)&n; * DIDST  -&gt; destination address of the DMA&n;*/
multiline_comment|/* s3c2410_dma_config&n; *&n; * xfersize:     size of unit in bytes (1,2,4)&n; * dcon:         base value of the DCONx register&n;*/
DECL|function|s3c2410_dma_config
r_int
id|s3c2410_dma_config
c_func
(paren
id|dmach_t
id|channel
comma
r_int
id|xferunit
comma
r_int
id|dcon
)paren
(brace
id|s3c2410_dma_chan_t
op_star
id|chan
op_assign
op_amp
id|s3c2410_chans
(braket
id|channel
)braket
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: chan=%d, xfer_unit=%d, dcon=%08x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|channel
comma
id|xferunit
comma
id|dcon
)paren
suffix:semicolon
id|check_channel
c_func
(paren
id|channel
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|xferunit
)paren
(brace
r_case
l_int|1
suffix:colon
id|dcon
op_or_assign
id|S3C2410_DCON_BYTE
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|dcon
op_or_assign
id|S3C2410_DCON_HALFWORD
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|dcon
op_or_assign
id|S3C2410_DCON_WORD
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|pr_debug
c_func
(paren
l_string|&quot;%s: bad transfer size %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|xferunit
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|dcon
op_or_assign
id|S3C2410_DCON_HWTRIG
suffix:semicolon
id|dcon
op_or_assign
id|S3C2410_DCON_INTREQ
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: dcon now %08x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dcon
)paren
suffix:semicolon
id|chan-&gt;dcon
op_assign
id|dcon
suffix:semicolon
id|chan-&gt;xfer_unit
op_assign
id|xferunit
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|s3c2410_dma_config
id|EXPORT_SYMBOL
c_func
(paren
id|s3c2410_dma_config
)paren
suffix:semicolon
DECL|function|s3c2410_dma_setflags
r_int
id|s3c2410_dma_setflags
c_func
(paren
id|dmach_t
id|channel
comma
r_int
r_int
id|flags
)paren
(brace
id|s3c2410_dma_chan_t
op_star
id|chan
op_assign
op_amp
id|s3c2410_chans
(braket
id|channel
)braket
suffix:semicolon
id|check_channel
c_func
(paren
id|channel
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: chan=%p, flags=%08x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|chan
comma
id|flags
)paren
suffix:semicolon
id|chan-&gt;flags
op_assign
id|flags
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|s3c2410_dma_setflags
id|EXPORT_SYMBOL
c_func
(paren
id|s3c2410_dma_setflags
)paren
suffix:semicolon
multiline_comment|/* do we need to protect the settings of the fields from&n; * irq?&n;*/
DECL|function|s3c2410_dma_set_opfn
r_int
id|s3c2410_dma_set_opfn
c_func
(paren
id|dmach_t
id|channel
comma
id|s3c2410_dma_opfn_t
id|rtn
)paren
(brace
id|s3c2410_dma_chan_t
op_star
id|chan
op_assign
op_amp
id|s3c2410_chans
(braket
id|channel
)braket
suffix:semicolon
id|check_channel
c_func
(paren
id|channel
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: chan=%p, op rtn=%p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|chan
comma
id|rtn
)paren
suffix:semicolon
id|chan-&gt;op_fn
op_assign
id|rtn
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|s3c2410_dma_set_opfn
id|EXPORT_SYMBOL
c_func
(paren
id|s3c2410_dma_set_opfn
)paren
suffix:semicolon
DECL|function|s3c2410_dma_set_buffdone_fn
r_int
id|s3c2410_dma_set_buffdone_fn
c_func
(paren
id|dmach_t
id|channel
comma
id|s3c2410_dma_cbfn_t
id|rtn
)paren
(brace
id|s3c2410_dma_chan_t
op_star
id|chan
op_assign
op_amp
id|s3c2410_chans
(braket
id|channel
)braket
suffix:semicolon
id|check_channel
c_func
(paren
id|channel
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: chan=%p, callback rtn=%p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|chan
comma
id|rtn
)paren
suffix:semicolon
id|chan-&gt;callback_fn
op_assign
id|rtn
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|s3c2410_dma_set_buffdone_fn
id|EXPORT_SYMBOL
c_func
(paren
id|s3c2410_dma_set_buffdone_fn
)paren
suffix:semicolon
multiline_comment|/* s3c2410_dma_devconfig&n; *&n; * configure the dma source/destination hardware type and address&n; *&n; * source:    S3C2410_DMASRC_HW: source is hardware&n; *            S3C2410_DMASRC_MEM: source is memory&n; *&n; * hwcfg:     the value for xxxSTCn register,&n; *            bit 0: 0=increment pointer, 1=leave pointer&n; *            bit 1: 0=soucre is AHB, 1=soucre is APB&n; *&n; * devaddr:   physical address of the source&n;*/
DECL|function|s3c2410_dma_devconfig
r_int
id|s3c2410_dma_devconfig
c_func
(paren
r_int
id|channel
comma
id|s3c2410_dmasrc_t
id|source
comma
r_int
id|hwcfg
comma
r_int
r_int
id|devaddr
)paren
(brace
id|s3c2410_dma_chan_t
op_star
id|chan
op_assign
op_amp
id|s3c2410_chans
(braket
id|channel
)braket
suffix:semicolon
id|check_channel
c_func
(paren
id|channel
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: source=%d, hwcfg=%08x, devaddr=%08lx&bslash;n&quot;
comma
id|__FUNCTION__
comma
(paren
r_int
)paren
id|source
comma
id|hwcfg
comma
id|devaddr
)paren
suffix:semicolon
id|chan-&gt;source
op_assign
id|source
suffix:semicolon
id|chan-&gt;dev_addr
op_assign
id|devaddr
suffix:semicolon
r_switch
c_cond
(paren
id|source
)paren
(brace
r_case
id|S3C2410_DMASRC_HW
suffix:colon
multiline_comment|/* source is hardware */
id|pr_debug
c_func
(paren
l_string|&quot;%s: hw source, devaddr=%08lx, hwcfg=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|devaddr
comma
id|hwcfg
)paren
suffix:semicolon
id|dma_wrreg
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DISRCC
comma
id|hwcfg
op_amp
l_int|3
)paren
suffix:semicolon
id|dma_wrreg
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DISRC
comma
id|devaddr
)paren
suffix:semicolon
id|dma_wrreg
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DIDSTC
comma
(paren
l_int|0
op_lshift
l_int|1
)paren
op_or
(paren
l_int|0
op_lshift
l_int|0
)paren
)paren
suffix:semicolon
id|chan-&gt;addr_reg
op_assign
id|dma_regaddr
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DIDST
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|S3C2410_DMASRC_MEM
suffix:colon
multiline_comment|/* source is memory */
id|pr_debug
c_func
(paren
l_string|&quot;%s: mem source, devaddr=%08lx, hwcfg=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|devaddr
comma
id|hwcfg
)paren
suffix:semicolon
id|dma_wrreg
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DISRCC
comma
(paren
l_int|0
op_lshift
l_int|1
)paren
op_or
(paren
l_int|0
op_lshift
l_int|0
)paren
)paren
suffix:semicolon
id|dma_wrreg
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DIDST
comma
id|devaddr
)paren
suffix:semicolon
id|dma_wrreg
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DIDSTC
comma
id|hwcfg
op_amp
l_int|3
)paren
suffix:semicolon
id|chan-&gt;addr_reg
op_assign
id|dma_regaddr
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DISRC
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma%d: invalid source type (%d)&bslash;n&quot;
comma
id|channel
comma
id|source
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|variable|s3c2410_dma_devconfig
id|EXPORT_SYMBOL
c_func
(paren
id|s3c2410_dma_devconfig
)paren
suffix:semicolon
multiline_comment|/* s3c2410_dma_getposition&n; *&n; * returns the current transfer points for the dma source and destination&n;*/
DECL|function|s3c2410_dma_getposition
r_int
id|s3c2410_dma_getposition
c_func
(paren
id|dmach_t
id|channel
comma
id|dma_addr_t
op_star
id|src
comma
id|dma_addr_t
op_star
id|dst
)paren
(brace
id|s3c2410_dma_chan_t
op_star
id|chan
op_assign
op_amp
id|s3c2410_chans
(braket
id|channel
)braket
suffix:semicolon
id|check_channel
c_func
(paren
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|src
op_ne
l_int|NULL
)paren
op_star
id|src
op_assign
id|dma_rdreg
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DCSRC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dst
op_ne
l_int|NULL
)paren
op_star
id|dst
op_assign
id|dma_rdreg
c_func
(paren
id|chan
comma
id|S3C2410_DMA_DCDST
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|s3c2410_dma_getposition
id|EXPORT_SYMBOL
c_func
(paren
id|s3c2410_dma_getposition
)paren
suffix:semicolon
multiline_comment|/* system device class */
macro_line|#ifdef CONFIG_PM
DECL|function|s3c2410_dma_suspend
r_static
r_int
id|s3c2410_dma_suspend
c_func
(paren
r_struct
id|sys_device
op_star
id|dev
comma
id|u32
id|state
)paren
(brace
id|s3c2410_dma_chan_t
op_star
id|cp
op_assign
id|container_of
c_func
(paren
id|dev
comma
id|s3c2410_dma_chan_t
comma
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;suspending dma channel %d&bslash;n&quot;
comma
id|cp-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_rdreg
c_func
(paren
id|cp
comma
id|S3C2410_DMA_DMASKTRIG
)paren
op_amp
id|S3C2410_DMASKTRIG_ON
)paren
(brace
multiline_comment|/* the dma channel is still working, which is probably&n;&t;&t; * a bad thing to do over suspend/resume. We stop the&n;&t;&t; * channel and assume that the client is either going to&n;&t;&t; * retry after resume, or that it is broken.&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;dma: stopping channel %d due to suspend&bslash;n&quot;
comma
id|cp-&gt;number
)paren
suffix:semicolon
id|s3c2410_dma_dostop
c_func
(paren
id|cp
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|s3c2410_dma_resume
r_static
r_int
id|s3c2410_dma_resume
c_func
(paren
r_struct
id|sys_device
op_star
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#else
DECL|macro|s3c2410_dma_suspend
mdefine_line|#define s3c2410_dma_suspend NULL
DECL|macro|s3c2410_dma_resume
mdefine_line|#define s3c2410_dma_resume  NULL
macro_line|#endif /* CONFIG_PM */
DECL|variable|dma_sysclass
r_static
r_struct
id|sysdev_class
id|dma_sysclass
op_assign
(brace
id|set_kset_name
c_func
(paren
l_string|&quot;s3c24xx-dma&quot;
)paren
comma
dot
id|suspend
op_assign
id|s3c2410_dma_suspend
comma
dot
id|resume
op_assign
id|s3c2410_dma_resume
comma
)brace
suffix:semicolon
multiline_comment|/* initialisation code */
DECL|function|s3c2410_init_dma
r_static
r_int
id|__init
id|s3c2410_init_dma
c_func
(paren
r_void
)paren
(brace
id|s3c2410_dma_chan_t
op_star
id|cp
suffix:semicolon
r_int
id|channel
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;S3C2410 DMA Driver, (c) 2003-2004 Simtec Electronics&bslash;n&quot;
)paren
suffix:semicolon
id|dma_base
op_assign
id|ioremap
c_func
(paren
id|S3C2410_PA_DMA
comma
l_int|0x200
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_base
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma failed to remap register block&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ret
op_assign
id|sysdev_class_register
c_func
(paren
op_amp
id|dma_sysclass
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dma sysclass registration failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
r_for
c_loop
(paren
id|channel
op_assign
l_int|0
suffix:semicolon
id|channel
OL
id|S3C2410_DMA_CHANNELS
suffix:semicolon
id|channel
op_increment
)paren
(brace
id|cp
op_assign
op_amp
id|s3c2410_chans
(braket
id|channel
)braket
suffix:semicolon
id|memset
c_func
(paren
id|cp
comma
l_int|0
comma
r_sizeof
(paren
id|s3c2410_dma_chan_t
)paren
)paren
suffix:semicolon
multiline_comment|/* dma channel irqs are in order.. */
id|cp-&gt;number
op_assign
id|channel
suffix:semicolon
id|cp-&gt;irq
op_assign
id|channel
op_plus
id|IRQ_DMA0
suffix:semicolon
id|cp-&gt;regs
op_assign
id|dma_base
op_plus
(paren
id|channel
op_star
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* point current stats somewhere */
id|cp-&gt;stats
op_assign
op_amp
id|cp-&gt;stats_store
suffix:semicolon
id|cp-&gt;stats_store.timeout_shortest
op_assign
id|LONG_MAX
suffix:semicolon
multiline_comment|/* basic channel configuration */
id|cp-&gt;load_timeout
op_assign
l_int|1
op_lshift
l_int|18
suffix:semicolon
multiline_comment|/* register system device */
id|cp-&gt;dev.cls
op_assign
op_amp
id|dma_sysclass
suffix:semicolon
id|cp-&gt;dev.id
op_assign
id|channel
suffix:semicolon
id|ret
op_assign
id|sysdev_register
c_func
(paren
op_amp
id|cp-&gt;dev
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;DMA channel %d at %p, irq %d&bslash;n&quot;
comma
id|cp-&gt;number
comma
id|cp-&gt;regs
comma
id|cp-&gt;irq
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|err
suffix:colon
id|iounmap
c_func
(paren
id|dma_base
)paren
suffix:semicolon
id|dma_base
op_assign
l_int|NULL
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|s3c2410_init_dma
id|__initcall
c_func
(paren
id|s3c2410_init_dma
)paren
suffix:semicolon
eof
