multiline_comment|/*&n; *  linux/arch/arm/mach-pxa/ssp.c&n; *&n; *  based on linux/arch/arm/mach-sa1100/ssp.c by Russell King&n; *&n; *  Copyright (C) 2003 Russell King.&n; *  Copyright (C) 2003 Wolfson Microelectronics PLC&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; *  PXA2xx SSP driver.  This provides the generic core for simple&n; *  IO-based SSP applications and allows easy port setup for DMA access.&n; *&n; *  Author: Liam Girdwood &lt;liam.girdwood@wolfsonmicro.com&gt;&n; *&n; *  Revision history:&n; *   22nd Aug 2003 Initial version.&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/arch/ssp.h&gt;
macro_line|#include &lt;asm/arch/pxa-regs.h&gt;
DECL|function|ssp_interrupt
r_static
id|irqreturn_t
id|ssp_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|ssp_dev
op_star
id|dev
op_assign
(paren
r_struct
id|ssp_dev
op_star
)paren
id|dev_id
suffix:semicolon
r_int
r_int
id|status
op_assign
id|SSSR_P
c_func
(paren
id|dev-&gt;port
)paren
suffix:semicolon
id|SSSR_P
c_func
(paren
id|dev-&gt;port
)paren
op_assign
id|status
suffix:semicolon
multiline_comment|/* clear status bits */
r_if
c_cond
(paren
id|status
op_amp
id|SSSR_ROR
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;SSP(%d): receiver overrun&bslash;n&quot;
comma
id|dev-&gt;port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SSSR_TUR
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;SSP(%d): transmitter underrun&bslash;n&quot;
comma
id|dev-&gt;port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SSSR_BCE
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;SSP(%d): bit count error&bslash;n&quot;
comma
id|dev-&gt;port
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/**&n; * ssp_write_word - write a word to the SSP port&n; * @data: 32-bit, MSB justified data to write.&n; *&n; * Wait for a free entry in the SSP transmit FIFO, and write a data&n; * word to the SSP port.&n; *&n; * The caller is expected to perform the necessary locking.&n; *&n; * Returns:&n; *   %-ETIMEDOUT&t;timeout occurred (for future)&n; *   0&t;&t;&t;success&n; */
DECL|function|ssp_write_word
r_int
id|ssp_write_word
c_func
(paren
r_struct
id|ssp_dev
op_star
id|dev
comma
id|u32
id|data
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|SSSR_P
c_func
(paren
id|dev-&gt;port
)paren
op_amp
id|SSSR_TNF
)paren
)paren
id|cpu_relax
c_func
(paren
)paren
suffix:semicolon
id|SSDR_P
c_func
(paren
id|dev-&gt;port
)paren
op_assign
id|data
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * ssp_read_word - read a word from the SSP port&n; *&n; * Wait for a data word in the SSP receive FIFO, and return the&n; * received data.  Data is LSB justified.&n; *&n; * Note: Currently, if data is not expected to be received, this&n; * function will wait for ever.&n; *&n; * The caller is expected to perform the necessary locking.&n; *&n; * Returns:&n; *   %-ETIMEDOUT&t;timeout occurred (for future)&n; *   32-bit data&t;success&n; */
DECL|function|ssp_read_word
r_int
id|ssp_read_word
c_func
(paren
r_struct
id|ssp_dev
op_star
id|dev
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|SSSR_P
c_func
(paren
id|dev-&gt;port
)paren
op_amp
id|SSSR_RNE
)paren
)paren
id|cpu_relax
c_func
(paren
)paren
suffix:semicolon
r_return
id|SSDR_P
c_func
(paren
id|dev-&gt;port
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ssp_flush - flush the transmit and receive FIFOs&n; *&n; * Wait for the SSP to idle, and ensure that the receive FIFO&n; * is empty.&n; *&n; * The caller is expected to perform the necessary locking.&n; */
DECL|function|ssp_flush
r_void
id|ssp_flush
c_func
(paren
r_struct
id|ssp_dev
op_star
id|dev
)paren
(brace
r_do
(brace
r_while
c_loop
(paren
id|SSSR_P
c_func
(paren
id|dev-&gt;port
)paren
op_amp
id|SSSR_RNE
)paren
(brace
(paren
r_void
)paren
id|SSDR_P
c_func
(paren
id|dev-&gt;port
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|SSSR_P
c_func
(paren
id|dev-&gt;port
)paren
op_amp
id|SSSR_BSY
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ssp_enable - enable the SSP port&n; *&n; * Turn on the SSP port.&n; */
DECL|function|ssp_enable
r_void
id|ssp_enable
c_func
(paren
r_struct
id|ssp_dev
op_star
id|dev
)paren
(brace
id|SSCR0_P
c_func
(paren
id|dev-&gt;port
)paren
op_or_assign
id|SSCR0_SSE
suffix:semicolon
)brace
multiline_comment|/**&n; * ssp_disable - shut down the SSP port&n; *&n; * Turn off the SSP port, optionally powering it down.&n; */
DECL|function|ssp_disable
r_void
id|ssp_disable
c_func
(paren
r_struct
id|ssp_dev
op_star
id|dev
)paren
(brace
id|SSCR0_P
c_func
(paren
id|dev-&gt;port
)paren
op_and_assign
op_complement
id|SSCR0_SSE
suffix:semicolon
)brace
multiline_comment|/**&n; * ssp_save_state - save the SSP configuration&n; * @ssp: pointer to structure to save SSP configuration&n; *&n; * Save the configured SSP state for suspend.&n; */
DECL|function|ssp_save_state
r_void
id|ssp_save_state
c_func
(paren
r_struct
id|ssp_dev
op_star
id|dev
comma
r_struct
id|ssp_state
op_star
id|ssp
)paren
(brace
id|ssp-&gt;cr0
op_assign
id|SSCR0_P
c_func
(paren
id|dev-&gt;port
)paren
suffix:semicolon
id|ssp-&gt;cr1
op_assign
id|SSCR1_P
c_func
(paren
id|dev-&gt;port
)paren
suffix:semicolon
id|ssp-&gt;to
op_assign
id|SSTO_P
c_func
(paren
id|dev-&gt;port
)paren
suffix:semicolon
id|ssp-&gt;psp
op_assign
id|SSPSP_P
c_func
(paren
id|dev-&gt;port
)paren
suffix:semicolon
id|SSCR0_P
c_func
(paren
id|dev-&gt;port
)paren
op_and_assign
op_complement
id|SSCR0_SSE
suffix:semicolon
)brace
multiline_comment|/**&n; * ssp_restore_state - restore a previously saved SSP configuration&n; * @ssp: pointer to configuration saved by ssp_save_state&n; *&n; * Restore the SSP configuration saved previously by ssp_save_state.&n; */
DECL|function|ssp_restore_state
r_void
id|ssp_restore_state
c_func
(paren
r_struct
id|ssp_dev
op_star
id|dev
comma
r_struct
id|ssp_state
op_star
id|ssp
)paren
(brace
id|SSSR_P
c_func
(paren
id|dev-&gt;port
)paren
op_assign
id|SSSR_ROR
op_or
id|SSSR_TUR
op_or
id|SSSR_BCE
suffix:semicolon
id|SSCR0_P
c_func
(paren
id|dev-&gt;port
)paren
op_assign
id|ssp-&gt;cr0
op_amp
op_complement
id|SSCR0_SSE
suffix:semicolon
id|SSCR1_P
c_func
(paren
id|dev-&gt;port
)paren
op_assign
id|ssp-&gt;cr1
suffix:semicolon
id|SSTO_P
c_func
(paren
id|dev-&gt;port
)paren
op_assign
id|ssp-&gt;to
suffix:semicolon
id|SSPSP_P
c_func
(paren
id|dev-&gt;port
)paren
op_assign
id|ssp-&gt;psp
suffix:semicolon
id|SSCR0_P
c_func
(paren
id|dev-&gt;port
)paren
op_assign
id|ssp-&gt;cr0
suffix:semicolon
)brace
multiline_comment|/**&n; * ssp_init - setup the SSP port&n; *&n; * initialise and claim resources for the SSP port.&n; *&n; * Returns:&n; *   %-ENODEV&t;if the SSP port is unavailable&n; *   %-EBUSY&t;if the resources are already in use&n; *   %0&t;&t;on success&n; */
DECL|function|ssp_init
r_int
id|ssp_init
c_func
(paren
r_struct
id|ssp_dev
op_star
id|dev
comma
id|u32
id|port
comma
id|u32
id|mode
comma
id|u32
id|flags
comma
id|u32
id|psp_flags
comma
id|u32
id|speed
)paren
(brace
r_int
id|ret
comma
id|irq
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|__PREG
c_func
(paren
id|SSCR0_P
c_func
(paren
id|dev-&gt;port
)paren
)paren
comma
l_int|0x2c
comma
l_string|&quot;SSP&quot;
)paren
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|port
)paren
(brace
r_case
l_int|1
suffix:colon
id|irq
op_assign
id|IRQ_SSP
suffix:semicolon
r_break
suffix:semicolon
macro_line|#if defined (CONFIG_PXA27x)
r_case
l_int|2
suffix:colon
id|irq
op_assign
id|IRQ_SSP2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|irq
op_assign
id|IRQ_SSP3
suffix:semicolon
r_break
suffix:semicolon
macro_line|#else
r_case
l_int|2
suffix:colon
id|irq
op_assign
id|IRQ_NSSP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|irq
op_assign
id|IRQ_ASSP
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dev-&gt;port
op_assign
id|port
suffix:semicolon
id|dev-&gt;mode
op_assign
id|mode
suffix:semicolon
id|dev-&gt;flags
op_assign
id|flags
suffix:semicolon
id|dev-&gt;psp_flags
op_assign
id|psp_flags
suffix:semicolon
id|dev-&gt;speed
op_assign
id|speed
suffix:semicolon
multiline_comment|/* set up port type, speed, port settings */
id|SSCR0_P
c_func
(paren
id|dev-&gt;port
)paren
op_assign
(paren
id|dev-&gt;speed
op_or
id|dev-&gt;mode
)paren
suffix:semicolon
id|SSCR1_P
c_func
(paren
id|dev-&gt;port
)paren
op_assign
id|dev-&gt;flags
suffix:semicolon
id|SSPSP_P
c_func
(paren
id|dev-&gt;port
)paren
op_assign
id|dev-&gt;psp_flags
suffix:semicolon
id|ret
op_assign
id|request_irq
c_func
(paren
id|irq
comma
id|ssp_interrupt
comma
l_int|0
comma
l_string|&quot;SSP&quot;
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|out_region
suffix:semicolon
multiline_comment|/* turn on SSP port clock */
r_switch
c_cond
(paren
id|dev-&gt;port
)paren
(brace
macro_line|#if defined (CONFIG_PXA27x)
r_case
l_int|1
suffix:colon
id|pxa_set_cken
c_func
(paren
id|CKEN23_SSP1
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|pxa_set_cken
c_func
(paren
id|CKEN3_SSP2
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|pxa_set_cken
c_func
(paren
id|CKEN4_SSP3
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#else
r_case
l_int|1
suffix:colon
id|pxa_set_cken
c_func
(paren
id|CKEN3_SSP
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|pxa_set_cken
c_func
(paren
id|CKEN9_NSSP
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|pxa_set_cken
c_func
(paren
id|CKEN10_ASSP
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
)brace
r_return
l_int|0
suffix:semicolon
id|out_region
suffix:colon
id|release_mem_region
c_func
(paren
id|__PREG
c_func
(paren
id|SSCR0_P
c_func
(paren
id|dev-&gt;port
)paren
)paren
comma
l_int|0x2c
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; * ssp_exit - undo the effects of ssp_init&n; *&n; * release and free resources for the SSP port.&n; */
DECL|function|ssp_exit
r_void
id|ssp_exit
c_func
(paren
r_struct
id|ssp_dev
op_star
id|dev
)paren
(brace
r_int
id|irq
suffix:semicolon
id|SSCR0_P
c_func
(paren
id|dev-&gt;port
)paren
op_and_assign
op_complement
id|SSCR0_SSE
suffix:semicolon
multiline_comment|/* find irq, save power and turn off SSP port clock */
r_switch
c_cond
(paren
id|dev-&gt;port
)paren
(brace
macro_line|#if defined (CONFIG_PXA27x)
r_case
l_int|1
suffix:colon
id|irq
op_assign
id|IRQ_SSP
suffix:semicolon
id|pxa_set_cken
c_func
(paren
id|CKEN23_SSP1
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|irq
op_assign
id|IRQ_SSP2
suffix:semicolon
id|pxa_set_cken
c_func
(paren
id|CKEN3_SSP2
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|irq
op_assign
id|IRQ_SSP3
suffix:semicolon
id|pxa_set_cken
c_func
(paren
id|CKEN4_SSP3
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#else
r_case
l_int|1
suffix:colon
id|irq
op_assign
id|IRQ_SSP
suffix:semicolon
id|pxa_set_cken
c_func
(paren
id|CKEN3_SSP
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|irq
op_assign
id|IRQ_NSSP
suffix:semicolon
id|pxa_set_cken
c_func
(paren
id|CKEN9_NSSP
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|irq
op_assign
id|IRQ_ASSP
suffix:semicolon
id|pxa_set_cken
c_func
(paren
id|CKEN10_ASSP
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;SSP: tried to close invalid port&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|free_irq
c_func
(paren
id|irq
comma
id|dev
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|__PREG
c_func
(paren
id|SSCR0_P
c_func
(paren
id|dev-&gt;port
)paren
)paren
comma
l_int|0x2c
)paren
suffix:semicolon
)brace
DECL|variable|ssp_write_word
id|EXPORT_SYMBOL
c_func
(paren
id|ssp_write_word
)paren
suffix:semicolon
DECL|variable|ssp_read_word
id|EXPORT_SYMBOL
c_func
(paren
id|ssp_read_word
)paren
suffix:semicolon
DECL|variable|ssp_flush
id|EXPORT_SYMBOL
c_func
(paren
id|ssp_flush
)paren
suffix:semicolon
DECL|variable|ssp_enable
id|EXPORT_SYMBOL
c_func
(paren
id|ssp_enable
)paren
suffix:semicolon
DECL|variable|ssp_disable
id|EXPORT_SYMBOL
c_func
(paren
id|ssp_disable
)paren
suffix:semicolon
DECL|variable|ssp_save_state
id|EXPORT_SYMBOL
c_func
(paren
id|ssp_save_state
)paren
suffix:semicolon
DECL|variable|ssp_restore_state
id|EXPORT_SYMBOL
c_func
(paren
id|ssp_restore_state
)paren
suffix:semicolon
DECL|variable|ssp_init
id|EXPORT_SYMBOL
c_func
(paren
id|ssp_init
)paren
suffix:semicolon
DECL|variable|ssp_exit
id|EXPORT_SYMBOL
c_func
(paren
id|ssp_exit
)paren
suffix:semicolon
eof
