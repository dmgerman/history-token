multiline_comment|/*&n; *  SSP control code for Sharp Corgi devices&n; *&n; *  Copyright (c) 2004 Richard Purdie&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License version 2 as&n; *  published by the Free Software Foundation.&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/arch/ssp.h&gt;
macro_line|#include &lt;asm/arch/corgi.h&gt;
macro_line|#include &lt;asm/arch/pxa-regs.h&gt;
DECL|variable|corgi_ssp_lock
r_static
id|spinlock_t
id|corgi_ssp_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|corgi_ssp_dev
r_static
r_struct
id|ssp_dev
id|corgi_ssp_dev
suffix:semicolon
DECL|variable|corgi_ssp_state
r_static
r_struct
id|ssp_state
id|corgi_ssp_state
suffix:semicolon
multiline_comment|/*&n; * There are three devices connected to the SSP interface:&n; *   1. A touchscreen controller (TI ADS7846 compatible)&n; *   2. An LCD contoller (with some Backlight functionality)&n; *   3. A battery moinitoring IC (Maxim MAX1111)&n; *&n; * Each device uses a different speed/mode of communication.&n; *&n; * The touchscreen is very sensitive and the most frequently used&n; * so the port is left configured for this.&n; *&n; * Devices are selected using Chip Selects on GPIOs.&n; */
multiline_comment|/*&n; *  ADS7846 Routines&n; */
DECL|function|corgi_ssp_ads7846_putget
r_int
r_int
id|corgi_ssp_ads7846_putget
c_func
(paren
id|ulong
id|data
)paren
(brace
r_int
r_int
id|ret
comma
id|flag
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|corgi_ssp_lock
comma
id|flag
)paren
suffix:semicolon
id|GPCR0
op_assign
id|GPIO_bit
c_func
(paren
id|CORGI_GPIO_ADS7846_CS
)paren
suffix:semicolon
id|ssp_write_word
c_func
(paren
op_amp
id|corgi_ssp_dev
comma
id|data
)paren
suffix:semicolon
id|ret
op_assign
id|ssp_read_word
c_func
(paren
op_amp
id|corgi_ssp_dev
)paren
suffix:semicolon
id|GPSR0
op_assign
id|GPIO_bit
c_func
(paren
id|CORGI_GPIO_ADS7846_CS
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|corgi_ssp_lock
comma
id|flag
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * NOTE: These functions should always be called in interrupt context&n; * and use the _lock and _unlock functions. They are very time sensitive.&n; */
DECL|function|corgi_ssp_ads7846_lock
r_void
id|corgi_ssp_ads7846_lock
c_func
(paren
r_void
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|corgi_ssp_lock
)paren
suffix:semicolon
id|GPCR0
op_assign
id|GPIO_bit
c_func
(paren
id|CORGI_GPIO_ADS7846_CS
)paren
suffix:semicolon
)brace
DECL|function|corgi_ssp_ads7846_unlock
r_void
id|corgi_ssp_ads7846_unlock
c_func
(paren
r_void
)paren
(brace
id|GPSR0
op_assign
id|GPIO_bit
c_func
(paren
id|CORGI_GPIO_ADS7846_CS
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|corgi_ssp_lock
)paren
suffix:semicolon
)brace
DECL|function|corgi_ssp_ads7846_put
r_void
id|corgi_ssp_ads7846_put
c_func
(paren
id|ulong
id|data
)paren
(brace
id|ssp_write_word
c_func
(paren
op_amp
id|corgi_ssp_dev
comma
id|data
)paren
suffix:semicolon
)brace
DECL|function|corgi_ssp_ads7846_get
r_int
r_int
id|corgi_ssp_ads7846_get
c_func
(paren
r_void
)paren
(brace
r_return
id|ssp_read_word
c_func
(paren
op_amp
id|corgi_ssp_dev
)paren
suffix:semicolon
)brace
DECL|variable|corgi_ssp_ads7846_putget
id|EXPORT_SYMBOL
c_func
(paren
id|corgi_ssp_ads7846_putget
)paren
suffix:semicolon
DECL|variable|corgi_ssp_ads7846_lock
id|EXPORT_SYMBOL
c_func
(paren
id|corgi_ssp_ads7846_lock
)paren
suffix:semicolon
DECL|variable|corgi_ssp_ads7846_unlock
id|EXPORT_SYMBOL
c_func
(paren
id|corgi_ssp_ads7846_unlock
)paren
suffix:semicolon
DECL|variable|corgi_ssp_ads7846_put
id|EXPORT_SYMBOL
c_func
(paren
id|corgi_ssp_ads7846_put
)paren
suffix:semicolon
DECL|variable|corgi_ssp_ads7846_get
id|EXPORT_SYMBOL
c_func
(paren
id|corgi_ssp_ads7846_get
)paren
suffix:semicolon
multiline_comment|/*&n; *  LCD/Backlight Routines&n; */
DECL|function|corgi_ssp_dac_put
r_int
r_int
id|corgi_ssp_dac_put
c_func
(paren
id|ulong
id|data
)paren
(brace
r_int
r_int
id|flag
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|corgi_ssp_lock
comma
id|flag
)paren
suffix:semicolon
id|GPCR0
op_assign
id|GPIO_bit
c_func
(paren
id|CORGI_GPIO_LCDCON_CS
)paren
suffix:semicolon
id|ssp_disable
c_func
(paren
op_amp
id|corgi_ssp_dev
)paren
suffix:semicolon
id|ssp_config
c_func
(paren
op_amp
id|corgi_ssp_dev
comma
(paren
id|SSCR0_Motorola
op_or
(paren
id|SSCR0_DSS
op_amp
l_int|0x07
)paren
)paren
comma
id|SSCR1_SPH
comma
l_int|0
comma
id|SSCR0_SerClkDiv
c_func
(paren
l_int|76
)paren
)paren
suffix:semicolon
id|ssp_enable
c_func
(paren
op_amp
id|corgi_ssp_dev
)paren
suffix:semicolon
id|ssp_write_word
c_func
(paren
op_amp
id|corgi_ssp_dev
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* Read null data back from device to prevent SSP overflow */
id|ssp_read_word
c_func
(paren
op_amp
id|corgi_ssp_dev
)paren
suffix:semicolon
id|ssp_disable
c_func
(paren
op_amp
id|corgi_ssp_dev
)paren
suffix:semicolon
id|ssp_config
c_func
(paren
op_amp
id|corgi_ssp_dev
comma
(paren
id|SSCR0_National
op_or
(paren
id|SSCR0_DSS
op_amp
l_int|0x0b
)paren
)paren
comma
l_int|0
comma
l_int|0
comma
id|SSCR0_SerClkDiv
c_func
(paren
l_int|2
)paren
)paren
suffix:semicolon
id|ssp_enable
c_func
(paren
op_amp
id|corgi_ssp_dev
)paren
suffix:semicolon
id|GPSR0
op_assign
id|GPIO_bit
c_func
(paren
id|CORGI_GPIO_LCDCON_CS
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|corgi_ssp_lock
comma
id|flag
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|corgi_ssp_lcdtg_send
r_void
id|corgi_ssp_lcdtg_send
c_func
(paren
id|u8
id|adrs
comma
id|u8
id|data
)paren
(brace
id|corgi_ssp_dac_put
c_func
(paren
(paren
(paren
id|adrs
op_amp
l_int|0x07
)paren
op_lshift
l_int|5
)paren
op_or
(paren
id|data
op_amp
l_int|0x1f
)paren
)paren
suffix:semicolon
)brace
DECL|function|corgi_ssp_blduty_set
r_void
id|corgi_ssp_blduty_set
c_func
(paren
r_int
id|duty
)paren
(brace
id|corgi_ssp_lcdtg_send
c_func
(paren
l_int|0x02
comma
id|duty
)paren
suffix:semicolon
)brace
DECL|variable|corgi_ssp_lcdtg_send
id|EXPORT_SYMBOL
c_func
(paren
id|corgi_ssp_lcdtg_send
)paren
suffix:semicolon
DECL|variable|corgi_ssp_blduty_set
id|EXPORT_SYMBOL
c_func
(paren
id|corgi_ssp_blduty_set
)paren
suffix:semicolon
multiline_comment|/*&n; *  Max1111 Routines&n; */
DECL|function|corgi_ssp_max1111_get
r_int
id|corgi_ssp_max1111_get
c_func
(paren
id|ulong
id|data
)paren
(brace
r_int
r_int
id|flag
suffix:semicolon
r_int
id|voltage
comma
id|voltage1
comma
id|voltage2
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|corgi_ssp_lock
comma
id|flag
)paren
suffix:semicolon
id|GPCR0
op_assign
id|GPIO_bit
c_func
(paren
id|CORGI_GPIO_MAX1111_CS
)paren
suffix:semicolon
id|ssp_disable
c_func
(paren
op_amp
id|corgi_ssp_dev
)paren
suffix:semicolon
id|ssp_config
c_func
(paren
op_amp
id|corgi_ssp_dev
comma
(paren
id|SSCR0_Motorola
op_or
(paren
id|SSCR0_DSS
op_amp
l_int|0x07
)paren
)paren
comma
l_int|0
comma
l_int|0
comma
id|SSCR0_SerClkDiv
c_func
(paren
l_int|8
)paren
)paren
suffix:semicolon
id|ssp_enable
c_func
(paren
op_amp
id|corgi_ssp_dev
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* TB1/RB1 */
id|ssp_write_word
c_func
(paren
op_amp
id|corgi_ssp_dev
comma
id|data
)paren
suffix:semicolon
id|ssp_read_word
c_func
(paren
op_amp
id|corgi_ssp_dev
)paren
suffix:semicolon
multiline_comment|/* null read */
multiline_comment|/* TB12/RB2 */
id|ssp_write_word
c_func
(paren
op_amp
id|corgi_ssp_dev
comma
l_int|0
)paren
suffix:semicolon
id|voltage1
op_assign
id|ssp_read_word
c_func
(paren
op_amp
id|corgi_ssp_dev
)paren
suffix:semicolon
multiline_comment|/* TB13/RB3*/
id|ssp_write_word
c_func
(paren
op_amp
id|corgi_ssp_dev
comma
l_int|0
)paren
suffix:semicolon
id|voltage2
op_assign
id|ssp_read_word
c_func
(paren
op_amp
id|corgi_ssp_dev
)paren
suffix:semicolon
id|ssp_disable
c_func
(paren
op_amp
id|corgi_ssp_dev
)paren
suffix:semicolon
id|ssp_config
c_func
(paren
op_amp
id|corgi_ssp_dev
comma
(paren
id|SSCR0_National
op_or
(paren
id|SSCR0_DSS
op_amp
l_int|0x0b
)paren
)paren
comma
l_int|0
comma
l_int|0
comma
id|SSCR0_SerClkDiv
c_func
(paren
l_int|2
)paren
)paren
suffix:semicolon
id|ssp_enable
c_func
(paren
op_amp
id|corgi_ssp_dev
)paren
suffix:semicolon
id|GPSR0
op_assign
id|GPIO_bit
c_func
(paren
id|CORGI_GPIO_MAX1111_CS
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|corgi_ssp_lock
comma
id|flag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|voltage1
op_amp
l_int|0xc0
op_logical_or
id|voltage2
op_amp
l_int|0x3f
)paren
id|voltage
op_assign
op_minus
l_int|1
suffix:semicolon
r_else
id|voltage
op_assign
(paren
(paren
id|voltage1
op_lshift
l_int|2
)paren
op_amp
l_int|0xfc
)paren
op_or
(paren
(paren
id|voltage2
op_rshift
l_int|6
)paren
op_amp
l_int|0x03
)paren
suffix:semicolon
r_return
id|voltage
suffix:semicolon
)brace
DECL|variable|corgi_ssp_max1111_get
id|EXPORT_SYMBOL
c_func
(paren
id|corgi_ssp_max1111_get
)paren
suffix:semicolon
multiline_comment|/*&n; *  Support Routines&n; */
DECL|function|corgi_ssp_probe
r_int
id|__init
id|corgi_ssp_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|ret
suffix:semicolon
multiline_comment|/* Chip Select - Disable All */
id|GPDR0
op_or_assign
id|GPIO_bit
c_func
(paren
id|CORGI_GPIO_LCDCON_CS
)paren
suffix:semicolon
multiline_comment|/* output */
id|GPSR0
op_assign
id|GPIO_bit
c_func
(paren
id|CORGI_GPIO_LCDCON_CS
)paren
suffix:semicolon
multiline_comment|/* High - Disable LCD Control/Timing Gen */
id|GPDR0
op_or_assign
id|GPIO_bit
c_func
(paren
id|CORGI_GPIO_MAX1111_CS
)paren
suffix:semicolon
multiline_comment|/* output */
id|GPSR0
op_assign
id|GPIO_bit
c_func
(paren
id|CORGI_GPIO_MAX1111_CS
)paren
suffix:semicolon
multiline_comment|/* High - Disable MAX1111*/
id|GPDR0
op_or_assign
id|GPIO_bit
c_func
(paren
id|CORGI_GPIO_ADS7846_CS
)paren
suffix:semicolon
multiline_comment|/* output */
id|GPSR0
op_assign
id|GPIO_bit
c_func
(paren
id|CORGI_GPIO_ADS7846_CS
)paren
suffix:semicolon
multiline_comment|/* High - Disable ADS7846*/
id|ret
op_assign
id|ssp_init
c_func
(paren
op_amp
id|corgi_ssp_dev
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Unable to register SSP handler!&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
id|ssp_disable
c_func
(paren
op_amp
id|corgi_ssp_dev
)paren
suffix:semicolon
id|ssp_config
c_func
(paren
op_amp
id|corgi_ssp_dev
comma
(paren
id|SSCR0_National
op_or
(paren
id|SSCR0_DSS
op_amp
l_int|0x0b
)paren
)paren
comma
l_int|0
comma
l_int|0
comma
id|SSCR0_SerClkDiv
c_func
(paren
l_int|2
)paren
)paren
suffix:semicolon
id|ssp_enable
c_func
(paren
op_amp
id|corgi_ssp_dev
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|corgi_ssp_remove
r_static
r_int
id|corgi_ssp_remove
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|ssp_exit
c_func
(paren
op_amp
id|corgi_ssp_dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|corgi_ssp_suspend
r_static
r_int
id|corgi_ssp_suspend
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|state
comma
id|u32
id|level
)paren
(brace
r_if
c_cond
(paren
id|level
op_eq
id|SUSPEND_POWER_DOWN
)paren
(brace
id|ssp_flush
c_func
(paren
op_amp
id|corgi_ssp_dev
)paren
suffix:semicolon
id|ssp_save_state
c_func
(paren
op_amp
id|corgi_ssp_dev
comma
op_amp
id|corgi_ssp_state
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|corgi_ssp_resume
r_static
r_int
id|corgi_ssp_resume
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|level
)paren
(brace
r_if
c_cond
(paren
id|level
op_eq
id|RESUME_POWER_ON
)paren
(brace
id|GPSR0
op_assign
id|GPIO_bit
c_func
(paren
id|CORGI_GPIO_LCDCON_CS
)paren
suffix:semicolon
multiline_comment|/* High - Disable LCD Control/Timing Gen */
id|GPSR0
op_assign
id|GPIO_bit
c_func
(paren
id|CORGI_GPIO_MAX1111_CS
)paren
suffix:semicolon
multiline_comment|/* High - Disable MAX1111*/
id|GPSR0
op_assign
id|GPIO_bit
c_func
(paren
id|CORGI_GPIO_ADS7846_CS
)paren
suffix:semicolon
multiline_comment|/* High - Disable ADS7846*/
id|ssp_restore_state
c_func
(paren
op_amp
id|corgi_ssp_dev
comma
op_amp
id|corgi_ssp_state
)paren
suffix:semicolon
id|ssp_enable
c_func
(paren
op_amp
id|corgi_ssp_dev
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|corgissp_driver
r_static
r_struct
id|device_driver
id|corgissp_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;corgi-ssp&quot;
comma
dot
id|bus
op_assign
op_amp
id|platform_bus_type
comma
dot
id|probe
op_assign
id|corgi_ssp_probe
comma
dot
id|remove
op_assign
id|corgi_ssp_remove
comma
dot
id|suspend
op_assign
id|corgi_ssp_suspend
comma
dot
id|resume
op_assign
id|corgi_ssp_resume
comma
)brace
suffix:semicolon
DECL|function|corgi_ssp_init
r_int
id|__init
id|corgi_ssp_init
c_func
(paren
r_void
)paren
(brace
r_return
id|driver_register
c_func
(paren
op_amp
id|corgissp_driver
)paren
suffix:semicolon
)brace
DECL|variable|corgi_ssp_init
id|arch_initcall
c_func
(paren
id|corgi_ssp_init
)paren
suffix:semicolon
eof
