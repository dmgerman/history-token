multiline_comment|/*&n; *  linux/arch/arm/mach-integrator/time.c&n; *&n; *  Copyright (C) 2000-2001 Deep Blue Solutions Ltd.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/mc146818rtc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;asm/hardware/amba.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/rtc.h&gt;
macro_line|#include &lt;asm/mach/time.h&gt;
DECL|macro|RTC_DR
mdefine_line|#define RTC_DR&t;&t;(0)
DECL|macro|RTC_MR
mdefine_line|#define RTC_MR&t;&t;(4)
DECL|macro|RTC_STAT
mdefine_line|#define RTC_STAT&t;(8)
DECL|macro|RTC_EOI
mdefine_line|#define RTC_EOI&t;&t;(8)
DECL|macro|RTC_LR
mdefine_line|#define RTC_LR&t;&t;(12)
DECL|macro|RTC_CR
mdefine_line|#define RTC_CR&t;&t;(16)
DECL|macro|RTC_CR_MIE
mdefine_line|#define RTC_CR_MIE&t;(1 &lt;&lt; 0)
r_extern
r_int
(paren
op_star
id|set_rtc
)paren
(paren
r_void
)paren
suffix:semicolon
DECL|variable|rtc_base
r_static
r_void
op_star
id|rtc_base
suffix:semicolon
DECL|function|integrator_set_rtc
r_static
r_int
id|integrator_set_rtc
c_func
(paren
r_void
)paren
(brace
id|__raw_writel
c_func
(paren
id|xtime.tv_sec
comma
id|rtc_base
op_plus
id|RTC_LR
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|rtc_read_alarm
r_static
r_void
id|rtc_read_alarm
c_func
(paren
r_struct
id|rtc_wkalrm
op_star
id|alrm
)paren
(brace
id|rtc_time_to_tm
c_func
(paren
id|readl
c_func
(paren
id|rtc_base
op_plus
id|RTC_MR
)paren
comma
op_amp
id|alrm-&gt;time
)paren
suffix:semicolon
)brace
DECL|function|rtc_set_alarm
r_static
r_int
id|rtc_set_alarm
c_func
(paren
r_struct
id|rtc_wkalrm
op_star
id|alrm
)paren
(brace
r_int
r_int
id|time
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|rtc_tm_to_time
c_func
(paren
op_amp
id|alrm-&gt;time
comma
op_amp
id|time
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
id|writel
c_func
(paren
id|time
comma
id|rtc_base
op_plus
id|RTC_MR
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|rtc_read_time
r_static
r_void
id|rtc_read_time
c_func
(paren
r_struct
id|rtc_time
op_star
id|tm
)paren
(brace
id|rtc_time_to_tm
c_func
(paren
id|readl
c_func
(paren
id|rtc_base
op_plus
id|RTC_DR
)paren
comma
id|tm
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Set the RTC time.  Unfortunately, we can&squot;t accurately set&n; * the point at which the counter updates.&n; *&n; * Also, since RTC_LR is transferred to RTC_CR on next rising&n; * edge of the 1Hz clock, we must write the time one second&n; * in advance.&n; */
DECL|function|rtc_set_time
r_static
r_int
id|rtc_set_time
c_func
(paren
r_struct
id|rtc_time
op_star
id|tm
)paren
(brace
r_int
r_int
id|time
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|rtc_tm_to_time
c_func
(paren
id|tm
comma
op_amp
id|time
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
id|writel
c_func
(paren
id|time
op_plus
l_int|1
comma
id|rtc_base
op_plus
id|RTC_LR
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|rtc_ops
r_static
r_struct
id|rtc_ops
id|rtc_ops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|read_time
op_assign
id|rtc_read_time
comma
dot
id|set_time
op_assign
id|rtc_set_time
comma
dot
id|read_alarm
op_assign
id|rtc_read_alarm
comma
dot
id|set_alarm
op_assign
id|rtc_set_alarm
comma
)brace
suffix:semicolon
DECL|function|rtc_interrupt
r_static
id|irqreturn_t
id|rtc_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|writel
c_func
(paren
l_int|0
comma
id|rtc_base
op_plus
id|RTC_EOI
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|rtc_probe
r_static
r_int
id|rtc_probe
c_func
(paren
r_struct
id|amba_device
op_star
id|dev
comma
r_void
op_star
id|id
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|rtc_base
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|ret
op_assign
id|amba_request_regions
c_func
(paren
id|dev
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|out
suffix:semicolon
id|rtc_base
op_assign
id|ioremap
c_func
(paren
id|dev-&gt;res.start
comma
id|SZ_4K
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rtc_base
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|res_out
suffix:semicolon
)brace
id|__raw_writel
c_func
(paren
l_int|0
comma
id|rtc_base
op_plus
id|RTC_CR
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
l_int|0
comma
id|rtc_base
op_plus
id|RTC_EOI
)paren
suffix:semicolon
id|xtime.tv_sec
op_assign
id|__raw_readl
c_func
(paren
id|rtc_base
op_plus
id|RTC_DR
)paren
suffix:semicolon
id|ret
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
(braket
l_int|0
)braket
comma
id|rtc_interrupt
comma
id|SA_INTERRUPT
comma
l_string|&quot;rtc-pl030&quot;
comma
id|rtc_base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|map_out
suffix:semicolon
id|ret
op_assign
id|register_rtc
c_func
(paren
op_amp
id|rtc_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|irq_out
suffix:semicolon
id|set_rtc
op_assign
id|integrator_set_rtc
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|irq_out
suffix:colon
id|free_irq
c_func
(paren
id|dev-&gt;irq
(braket
l_int|0
)braket
comma
id|rtc_base
)paren
suffix:semicolon
id|map_out
suffix:colon
id|iounmap
c_func
(paren
id|rtc_base
)paren
suffix:semicolon
id|rtc_base
op_assign
l_int|NULL
suffix:semicolon
id|res_out
suffix:colon
id|amba_release_regions
c_func
(paren
id|dev
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|rtc_remove
r_static
r_int
id|rtc_remove
c_func
(paren
r_struct
id|amba_device
op_star
id|dev
)paren
(brace
id|set_rtc
op_assign
l_int|NULL
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|rtc_base
op_plus
id|RTC_CR
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
(braket
l_int|0
)braket
comma
id|rtc_base
)paren
suffix:semicolon
id|unregister_rtc
c_func
(paren
op_amp
id|rtc_ops
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|rtc_base
)paren
suffix:semicolon
id|rtc_base
op_assign
l_int|NULL
suffix:semicolon
id|amba_release_regions
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|rtc_delta
r_static
r_struct
id|timespec
id|rtc_delta
suffix:semicolon
DECL|function|rtc_suspend
r_static
r_int
id|rtc_suspend
c_func
(paren
r_struct
id|amba_device
op_star
id|dev
comma
id|u32
id|state
)paren
(brace
r_struct
id|timespec
id|rtc
suffix:semicolon
id|rtc.tv_sec
op_assign
id|readl
c_func
(paren
id|rtc_base
op_plus
id|RTC_DR
)paren
suffix:semicolon
id|rtc.tv_nsec
op_assign
l_int|0
suffix:semicolon
id|save_time_delta
c_func
(paren
op_amp
id|rtc_delta
comma
op_amp
id|rtc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rtc_resume
r_static
r_int
id|rtc_resume
c_func
(paren
r_struct
id|amba_device
op_star
id|dev
)paren
(brace
r_struct
id|timespec
id|rtc
suffix:semicolon
id|rtc.tv_sec
op_assign
id|readl
c_func
(paren
id|rtc_base
op_plus
id|RTC_DR
)paren
suffix:semicolon
id|rtc.tv_nsec
op_assign
l_int|0
suffix:semicolon
id|restore_time_delta
c_func
(paren
op_amp
id|rtc_delta
comma
op_amp
id|rtc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|rtc_ids
r_static
r_struct
id|amba_id
id|rtc_ids
(braket
)braket
op_assign
(brace
(brace
dot
id|id
op_assign
l_int|0x00041030
comma
dot
id|mask
op_assign
l_int|0x000fffff
comma
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
)brace
suffix:semicolon
DECL|variable|rtc_driver
r_static
r_struct
id|amba_driver
id|rtc_driver
op_assign
(brace
dot
id|drv
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;rtc-pl030&quot;
comma
)brace
comma
dot
id|probe
op_assign
id|rtc_probe
comma
dot
id|remove
op_assign
id|rtc_remove
comma
dot
id|suspend
op_assign
id|rtc_suspend
comma
dot
id|resume
op_assign
id|rtc_resume
comma
dot
id|id_table
op_assign
id|rtc_ids
comma
)brace
suffix:semicolon
DECL|function|integrator_rtc_init
r_static
r_int
id|__init
id|integrator_rtc_init
c_func
(paren
r_void
)paren
(brace
r_return
id|amba_driver_register
c_func
(paren
op_amp
id|rtc_driver
)paren
suffix:semicolon
)brace
DECL|function|integrator_rtc_exit
r_static
r_void
id|__exit
id|integrator_rtc_exit
c_func
(paren
r_void
)paren
(brace
id|amba_driver_unregister
c_func
(paren
op_amp
id|rtc_driver
)paren
suffix:semicolon
)brace
DECL|variable|integrator_rtc_init
id|module_init
c_func
(paren
id|integrator_rtc_init
)paren
suffix:semicolon
DECL|variable|integrator_rtc_exit
id|module_exit
c_func
(paren
id|integrator_rtc_exit
)paren
suffix:semicolon
eof
