multiline_comment|/*&n; *  linux/arch/arm/common/amba.c&n; *&n; *  Copyright (C) 2003 Deep Blue Solutions Ltd, All Rights Reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/hardware/amba.h&gt;
macro_line|#include &lt;asm/sizes.h&gt;
DECL|macro|to_amba_device
mdefine_line|#define to_amba_device(d)&t;container_of(d, struct amba_device, dev)
DECL|macro|to_amba_driver
mdefine_line|#define to_amba_driver(d)&t;container_of(d, struct amba_driver, drv)
r_static
r_struct
id|amba_id
op_star
DECL|function|amba_lookup
id|amba_lookup
c_func
(paren
r_struct
id|amba_id
op_star
id|table
comma
r_struct
id|amba_device
op_star
id|dev
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|table-&gt;mask
)paren
(brace
id|ret
op_assign
(paren
id|dev-&gt;periphid
op_amp
id|table-&gt;mask
)paren
op_eq
id|table-&gt;id
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_break
suffix:semicolon
id|table
op_increment
suffix:semicolon
)brace
r_return
id|ret
ques
c_cond
id|table
suffix:colon
l_int|NULL
suffix:semicolon
)brace
DECL|function|amba_match
r_static
r_int
id|amba_match
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|device_driver
op_star
id|drv
)paren
(brace
r_struct
id|amba_device
op_star
id|pcdev
op_assign
id|to_amba_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|amba_driver
op_star
id|pcdrv
op_assign
id|to_amba_driver
c_func
(paren
id|drv
)paren
suffix:semicolon
r_return
id|amba_lookup
c_func
(paren
id|pcdrv-&gt;id_table
comma
id|pcdev
)paren
op_ne
l_int|NULL
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_HOTPLUG
DECL|function|amba_hotplug
r_static
r_int
id|amba_hotplug
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
op_star
id|envp
comma
r_int
id|nr_env
comma
r_char
op_star
id|buf
comma
r_int
id|bufsz
)paren
(brace
r_struct
id|amba_device
op_star
id|pcdev
op_assign
id|to_amba_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nr_env
OL
l_int|2
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|snprintf
c_func
(paren
id|buf
comma
id|bufsz
comma
l_string|&quot;AMBA_ID=%08x&quot;
comma
id|pcdev-&gt;periphid
)paren
suffix:semicolon
op_star
id|envp
op_increment
op_assign
id|buf
suffix:semicolon
op_star
id|envp
op_increment
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#else
DECL|macro|amba_hotplug
mdefine_line|#define amba_hotplug NULL
macro_line|#endif
DECL|function|amba_suspend
r_static
r_int
id|amba_suspend
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|state
)paren
(brace
r_struct
id|amba_driver
op_star
id|drv
op_assign
id|to_amba_driver
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;driver
op_logical_and
id|drv-&gt;suspend
)paren
id|ret
op_assign
id|drv
op_member_access_from_pointer
id|suspend
c_func
(paren
id|to_amba_device
c_func
(paren
id|dev
)paren
comma
id|state
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|amba_resume
r_static
r_int
id|amba_resume
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|amba_driver
op_star
id|drv
op_assign
id|to_amba_driver
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;driver
op_logical_and
id|drv-&gt;resume
)paren
id|ret
op_assign
id|drv
op_member_access_from_pointer
id|resume
c_func
(paren
id|to_amba_device
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Primecells are part of the Advanced Microcontroller Bus Architecture,&n; * so we call the bus &quot;amba&quot;.&n; */
DECL|variable|amba_bustype
r_static
r_struct
id|bus_type
id|amba_bustype
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;amba&quot;
comma
dot
id|match
op_assign
id|amba_match
comma
dot
id|hotplug
op_assign
id|amba_hotplug
comma
dot
id|suspend
op_assign
id|amba_suspend
comma
dot
id|resume
op_assign
id|amba_resume
comma
)brace
suffix:semicolon
DECL|function|amba_init
r_static
r_int
id|__init
id|amba_init
c_func
(paren
r_void
)paren
(brace
r_return
id|bus_register
c_func
(paren
op_amp
id|amba_bustype
)paren
suffix:semicolon
)brace
DECL|variable|amba_init
id|postcore_initcall
c_func
(paren
id|amba_init
)paren
suffix:semicolon
multiline_comment|/*&n; * These are the device model conversion veneers; they convert the&n; * device model structures to our more specific structures.&n; */
DECL|function|amba_probe
r_static
r_int
id|amba_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|amba_device
op_star
id|pcdev
op_assign
id|to_amba_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|amba_driver
op_star
id|pcdrv
op_assign
id|to_amba_driver
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
r_struct
id|amba_id
op_star
id|id
suffix:semicolon
id|id
op_assign
id|amba_lookup
c_func
(paren
id|pcdrv-&gt;id_table
comma
id|pcdev
)paren
suffix:semicolon
r_return
id|pcdrv
op_member_access_from_pointer
id|probe
c_func
(paren
id|pcdev
comma
id|id
)paren
suffix:semicolon
)brace
DECL|function|amba_remove
r_static
r_int
id|amba_remove
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|amba_driver
op_star
id|drv
op_assign
id|to_amba_driver
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
r_return
id|drv
op_member_access_from_pointer
id|remove
c_func
(paren
id|to_amba_device
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
)brace
DECL|function|amba_shutdown
r_static
r_void
id|amba_shutdown
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|amba_driver
op_star
id|drv
op_assign
id|to_amba_driver
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
id|drv
op_member_access_from_pointer
id|shutdown
c_func
(paren
id|to_amba_device
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;amba_driver_register - register an AMBA device driver&n; *&t;@drv: amba device driver structure&n; *&n; *&t;Register an AMBA device driver with the Linux device model&n; *&t;core.  If devices pre-exist, the drivers probe function will&n; *&t;be called.&n; */
DECL|function|amba_driver_register
r_int
id|amba_driver_register
c_func
(paren
r_struct
id|amba_driver
op_star
id|drv
)paren
(brace
id|drv-&gt;drv.bus
op_assign
op_amp
id|amba_bustype
suffix:semicolon
DECL|macro|SETFN
mdefine_line|#define SETFN(fn)&t;if (drv-&gt;fn) drv-&gt;drv.fn = amba_##fn
id|SETFN
c_func
(paren
id|probe
)paren
suffix:semicolon
id|SETFN
c_func
(paren
id|remove
)paren
suffix:semicolon
id|SETFN
c_func
(paren
id|shutdown
)paren
suffix:semicolon
r_return
id|driver_register
c_func
(paren
op_amp
id|drv-&gt;drv
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;amba_driver_unregister - remove an AMBA device driver&n; *&t;@drv: AMBA device driver structure to remove&n; *&n; *&t;Unregister an AMBA device driver from the Linux device&n; *&t;model.  The device model will call the drivers remove function&n; *&t;for each device the device driver is currently handling.&n; */
DECL|function|amba_driver_unregister
r_void
id|amba_driver_unregister
c_func
(paren
r_struct
id|amba_driver
op_star
id|drv
)paren
(brace
id|driver_unregister
c_func
(paren
op_amp
id|drv-&gt;drv
)paren
suffix:semicolon
)brace
DECL|function|amba_device_release
r_static
r_void
id|amba_device_release
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|amba_device
op_star
id|d
op_assign
id|to_amba_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;res.parent
)paren
id|release_resource
c_func
(paren
op_amp
id|d-&gt;res
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|d
)paren
suffix:semicolon
)brace
DECL|macro|amba_attr
mdefine_line|#define amba_attr(name,fmt,arg...)&t;&t;&t;&t;&bslash;&n;static ssize_t show_##name(struct device *_dev, char *buf)&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;struct amba_device *dev = to_amba_device(_dev);&t;&t;&bslash;&n;&t;return sprintf(buf, fmt, arg);&t;&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static DEVICE_ATTR(name, S_IRUGO, show_##name, NULL)
id|amba_attr
c_func
(paren
id|id
comma
l_string|&quot;%08x&bslash;n&quot;
comma
id|dev-&gt;periphid
)paren
suffix:semicolon
id|amba_attr
c_func
(paren
id|irq0
comma
l_string|&quot;%u&bslash;n&quot;
comma
id|dev-&gt;irq
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|amba_attr
c_func
(paren
id|irq1
comma
l_string|&quot;%u&bslash;n&quot;
comma
id|dev-&gt;irq
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|amba_attr
c_func
(paren
id|resource
comma
l_string|&quot;&bslash;t%08lx&bslash;t%08lx&bslash;t%08lx&bslash;n&quot;
comma
id|dev-&gt;res.start
comma
id|dev-&gt;res.end
comma
id|dev-&gt;res.flags
)paren
suffix:semicolon
multiline_comment|/**&n; *&t;amba_device_register - register an AMBA device&n; *&t;@dev: AMBA device to register&n; *&t;@parent: parent memory resource&n; *&n; *&t;Setup the AMBA device, reading the cell ID if present.&n; *&t;Claim the resource, and register the AMBA device with&n; *&t;the Linux device manager.&n; */
DECL|function|amba_device_register
r_int
id|amba_device_register
c_func
(paren
r_struct
id|amba_device
op_star
id|dev
comma
r_struct
id|resource
op_star
id|parent
)paren
(brace
id|u32
id|pid
comma
id|cid
suffix:semicolon
r_void
op_star
id|tmp
suffix:semicolon
r_int
id|i
comma
id|ret
suffix:semicolon
id|dev-&gt;dev.release
op_assign
id|amba_device_release
suffix:semicolon
id|dev-&gt;dev.bus
op_assign
op_amp
id|amba_bustype
suffix:semicolon
id|dev-&gt;dev.dma_mask
op_assign
op_amp
id|dev-&gt;dma_mask
suffix:semicolon
id|dev-&gt;res.name
op_assign
id|dev-&gt;dev.bus_id
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;dev.coherent_dma_mask
op_logical_and
id|dev-&gt;dma_mask
)paren
id|dev_warn
c_func
(paren
op_amp
id|dev-&gt;dev
comma
l_string|&quot;coherent dma mask is unset&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|request_resource
c_func
(paren
id|parent
comma
op_amp
id|dev-&gt;res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
id|tmp
op_assign
id|ioremap
c_func
(paren
id|dev-&gt;res.start
comma
id|SZ_4K
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmp
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_for
c_loop
(paren
id|pid
op_assign
l_int|0
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|pid
op_or_assign
(paren
id|readl
c_func
(paren
id|tmp
op_plus
l_int|0xfe0
op_plus
l_int|4
op_star
id|i
)paren
op_amp
l_int|255
)paren
op_lshift
(paren
id|i
op_star
l_int|8
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cid
op_assign
l_int|0
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|cid
op_or_assign
(paren
id|readl
c_func
(paren
id|tmp
op_plus
l_int|0xff0
op_plus
l_int|4
op_star
id|i
)paren
op_amp
l_int|255
)paren
op_lshift
(paren
id|i
op_star
l_int|8
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cid
op_eq
l_int|0xb105f00d
)paren
id|dev-&gt;periphid
op_assign
id|pid
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;periphid
)paren
id|ret
op_assign
id|device_register
c_func
(paren
op_amp
id|dev-&gt;dev
)paren
suffix:semicolon
r_else
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
id|device_create_file
c_func
(paren
op_amp
id|dev-&gt;dev
comma
op_amp
id|dev_attr_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;irq
(braket
l_int|0
)braket
op_ne
id|NO_IRQ
)paren
id|device_create_file
c_func
(paren
op_amp
id|dev-&gt;dev
comma
op_amp
id|dev_attr_irq0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;irq
(braket
l_int|1
)braket
op_ne
id|NO_IRQ
)paren
id|device_create_file
c_func
(paren
op_amp
id|dev-&gt;dev
comma
op_amp
id|dev_attr_irq1
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|dev-&gt;dev
comma
op_amp
id|dev_attr_resource
)paren
suffix:semicolon
)brace
r_else
(brace
id|out
suffix:colon
id|release_resource
c_func
(paren
op_amp
id|dev-&gt;res
)paren
suffix:semicolon
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;amba_device_unregister - unregister an AMBA device&n; *&t;@dev: AMBA device to remove&n; *&n; *&t;Remove the specified AMBA device from the Linux device&n; *&t;manager.  All files associated with this object will be&n; *&t;destroyed, and device drivers notified that the device has&n; *&t;been removed.  The AMBA device&squot;s resources including&n; *&t;the amba_device structure will be freed once all&n; *&t;references to it have been dropped.&n; */
DECL|function|amba_device_unregister
r_void
id|amba_device_unregister
c_func
(paren
r_struct
id|amba_device
op_star
id|dev
)paren
(brace
id|device_unregister
c_func
(paren
op_amp
id|dev-&gt;dev
)paren
suffix:semicolon
)brace
DECL|struct|find_data
r_struct
id|find_data
(brace
DECL|member|dev
r_struct
id|amba_device
op_star
id|dev
suffix:semicolon
DECL|member|parent
r_struct
id|device
op_star
id|parent
suffix:semicolon
DECL|member|busid
r_const
r_char
op_star
id|busid
suffix:semicolon
DECL|member|id
r_int
r_int
id|id
suffix:semicolon
DECL|member|mask
r_int
r_int
id|mask
suffix:semicolon
)brace
suffix:semicolon
DECL|function|amba_find_match
r_static
r_int
id|amba_find_match
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|find_data
op_star
id|d
op_assign
id|data
suffix:semicolon
r_struct
id|amba_device
op_star
id|pcdev
op_assign
id|to_amba_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|r
suffix:semicolon
id|r
op_assign
(paren
id|pcdev-&gt;periphid
op_amp
id|d-&gt;mask
)paren
op_eq
id|d-&gt;id
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;parent
)paren
id|r
op_and_assign
id|d-&gt;parent
op_eq
id|dev-&gt;parent
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;busid
)paren
id|r
op_and_assign
id|strcmp
c_func
(paren
id|dev-&gt;bus_id
comma
id|d-&gt;busid
)paren
op_eq
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
(brace
id|get_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|d-&gt;dev
op_assign
id|pcdev
suffix:semicolon
)brace
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;amba_find_device - locate an AMBA device given a bus id&n; *&t;@busid: bus id for device (or NULL)&n; *&t;@parent: parent device (or NULL)&n; *&t;@id: peripheral ID (or 0)&n; *&t;@mask: peripheral ID mask (or 0)&n; *&n; *&t;Return the AMBA device corresponding to the supplied parameters.&n; *&t;If no device matches, returns NULL.&n; *&n; *&t;NOTE: When a valid device is found, its refcount is&n; *&t;incremented, and must be decremented before the returned&n; *&t;reference.&n; */
r_struct
id|amba_device
op_star
DECL|function|amba_find_device
id|amba_find_device
c_func
(paren
r_const
r_char
op_star
id|busid
comma
r_struct
id|device
op_star
id|parent
comma
r_int
r_int
id|id
comma
r_int
r_int
id|mask
)paren
(brace
r_struct
id|find_data
id|data
suffix:semicolon
id|data.dev
op_assign
l_int|NULL
suffix:semicolon
id|data.parent
op_assign
id|parent
suffix:semicolon
id|data.busid
op_assign
id|busid
suffix:semicolon
id|data.id
op_assign
id|id
suffix:semicolon
id|data.mask
op_assign
id|mask
suffix:semicolon
id|bus_for_each_dev
c_func
(paren
op_amp
id|amba_bustype
comma
l_int|NULL
comma
op_amp
id|data
comma
id|amba_find_match
)paren
suffix:semicolon
r_return
id|data.dev
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;amba_request_regions - request all mem regions associated with device&n; *&t;@dev: amba_device structure for device&n; *&t;@name: name, or NULL to use driver name&n; */
DECL|function|amba_request_regions
r_int
id|amba_request_regions
c_func
(paren
r_struct
id|amba_device
op_star
id|dev
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|name
)paren
id|name
op_assign
id|dev-&gt;dev.driver-&gt;name
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|dev-&gt;res.start
comma
id|SZ_4K
comma
id|name
)paren
)paren
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;amba_release_regions - release mem regions assoicated with device&n; *&t;@dev: amba_device structure for device&n; *&n; *&t;Release regions claimed by a successful call to amba_request_regions.&n; */
DECL|function|amba_release_regions
r_void
id|amba_release_regions
c_func
(paren
r_struct
id|amba_device
op_star
id|dev
)paren
(brace
id|release_mem_region
c_func
(paren
id|dev-&gt;res.start
comma
id|SZ_4K
)paren
suffix:semicolon
)brace
DECL|variable|amba_driver_register
id|EXPORT_SYMBOL
c_func
(paren
id|amba_driver_register
)paren
suffix:semicolon
DECL|variable|amba_driver_unregister
id|EXPORT_SYMBOL
c_func
(paren
id|amba_driver_unregister
)paren
suffix:semicolon
DECL|variable|amba_device_register
id|EXPORT_SYMBOL
c_func
(paren
id|amba_device_register
)paren
suffix:semicolon
DECL|variable|amba_device_unregister
id|EXPORT_SYMBOL
c_func
(paren
id|amba_device_unregister
)paren
suffix:semicolon
DECL|variable|amba_find_device
id|EXPORT_SYMBOL
c_func
(paren
id|amba_find_device
)paren
suffix:semicolon
DECL|variable|amba_request_regions
id|EXPORT_SYMBOL
c_func
(paren
id|amba_request_regions
)paren
suffix:semicolon
DECL|variable|amba_release_regions
id|EXPORT_SYMBOL
c_func
(paren
id|amba_release_regions
)paren
suffix:semicolon
eof
