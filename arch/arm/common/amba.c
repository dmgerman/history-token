multiline_comment|/*&n; *  linux/arch/arm/common/amba.c&n; *&n; *  Copyright (C) 2003 Deep Blue Solutions Ltd, All Rights Reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/hardware/amba.h&gt;
macro_line|#include &lt;asm/sizes.h&gt;
DECL|macro|to_amba_device
mdefine_line|#define to_amba_device(d)&t;container_of(d, struct amba_device, dev)
DECL|macro|to_amba_driver
mdefine_line|#define to_amba_driver(d)&t;container_of(d, struct amba_driver, drv)
r_static
r_struct
id|amba_id
op_star
DECL|function|amba_lookup
id|amba_lookup
c_func
(paren
r_struct
id|amba_id
op_star
id|table
comma
r_struct
id|amba_device
op_star
id|dev
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|table-&gt;mask
)paren
(brace
id|ret
op_assign
(paren
id|dev-&gt;periphid
op_amp
id|table-&gt;mask
)paren
op_eq
id|table-&gt;id
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_break
suffix:semicolon
id|table
op_increment
suffix:semicolon
)brace
r_return
id|ret
ques
c_cond
id|table
suffix:colon
l_int|NULL
suffix:semicolon
)brace
DECL|function|amba_match
r_static
r_int
id|amba_match
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|device_driver
op_star
id|drv
)paren
(brace
r_struct
id|amba_device
op_star
id|pcdev
op_assign
id|to_amba_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|amba_driver
op_star
id|pcdrv
op_assign
id|to_amba_driver
c_func
(paren
id|drv
)paren
suffix:semicolon
r_return
id|amba_lookup
c_func
(paren
id|pcdrv-&gt;id_table
comma
id|pcdev
)paren
op_ne
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Primecells are part of the Advanced Microcontroller Bus Architecture,&n; * so we call the bus &quot;amba&quot;.&n; */
DECL|variable|amba_bustype
r_struct
id|bus_type
id|amba_bustype
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;amba&quot;
comma
dot
id|match
op_assign
id|amba_match
comma
)brace
suffix:semicolon
DECL|function|amba_init
r_static
r_int
id|__init
id|amba_init
c_func
(paren
r_void
)paren
(brace
r_return
id|bus_register
c_func
(paren
op_amp
id|amba_bustype
)paren
suffix:semicolon
)brace
DECL|variable|amba_init
id|postcore_initcall
c_func
(paren
id|amba_init
)paren
suffix:semicolon
multiline_comment|/*&n; * These are the device model conversion veneers; they convert the&n; * device model structures to our more specific structures.&n; */
DECL|function|amba_probe
r_static
r_int
id|amba_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|amba_device
op_star
id|pcdev
op_assign
id|to_amba_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|amba_driver
op_star
id|pcdrv
op_assign
id|to_amba_driver
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
r_struct
id|amba_id
op_star
id|id
suffix:semicolon
id|id
op_assign
id|amba_lookup
c_func
(paren
id|pcdrv-&gt;id_table
comma
id|pcdev
)paren
suffix:semicolon
r_return
id|pcdrv
op_member_access_from_pointer
id|probe
c_func
(paren
id|pcdev
comma
id|id
)paren
suffix:semicolon
)brace
DECL|function|amba_remove
r_static
r_int
id|amba_remove
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|amba_driver
op_star
id|drv
op_assign
id|to_amba_driver
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
r_return
id|drv
op_member_access_from_pointer
id|remove
c_func
(paren
id|to_amba_device
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
)brace
DECL|function|amba_shutdown
r_static
r_void
id|amba_shutdown
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|amba_driver
op_star
id|drv
op_assign
id|to_amba_driver
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
id|drv
op_member_access_from_pointer
id|shutdown
c_func
(paren
id|to_amba_device
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
)brace
DECL|function|amba_suspend
r_static
r_int
id|amba_suspend
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|state
comma
id|u32
id|level
)paren
(brace
r_struct
id|amba_driver
op_star
id|drv
op_assign
id|to_amba_driver
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
r_return
id|drv
op_member_access_from_pointer
id|suspend
c_func
(paren
id|to_amba_device
c_func
(paren
id|dev
)paren
comma
id|state
comma
id|level
)paren
suffix:semicolon
)brace
DECL|function|amba_resume
r_static
r_int
id|amba_resume
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|level
)paren
(brace
r_struct
id|amba_driver
op_star
id|drv
op_assign
id|to_amba_driver
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
r_return
id|drv
op_member_access_from_pointer
id|resume
c_func
(paren
id|to_amba_device
c_func
(paren
id|dev
)paren
comma
id|level
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;amba_driver_register - register an AMBA device driver&n; *&t;@drv: amba device driver structure&n; *&n; *&t;Register an AMBA device driver with the Linux device model&n; *&t;core.  If devices pre-exist, the drivers probe function will&n; *&t;be called.&n; */
DECL|function|amba_driver_register
r_int
id|amba_driver_register
c_func
(paren
r_struct
id|amba_driver
op_star
id|drv
)paren
(brace
id|drv-&gt;drv.bus
op_assign
op_amp
id|amba_bustype
suffix:semicolon
DECL|macro|SETFN
mdefine_line|#define SETFN(fn)&t;if (drv-&gt;fn) drv-&gt;drv.fn = amba_##fn
id|SETFN
c_func
(paren
id|probe
)paren
suffix:semicolon
id|SETFN
c_func
(paren
id|remove
)paren
suffix:semicolon
id|SETFN
c_func
(paren
id|shutdown
)paren
suffix:semicolon
id|SETFN
c_func
(paren
id|suspend
)paren
suffix:semicolon
id|SETFN
c_func
(paren
id|resume
)paren
suffix:semicolon
r_return
id|driver_register
c_func
(paren
op_amp
id|drv-&gt;drv
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;amba_driver_unregister - remove an AMBA device driver&n; *&t;@drv: AMBA device driver structure to remove&n; *&n; *&t;Unregister an AMBA device driver from the Linux device&n; *&t;model.  The device model will call the drivers remove function&n; *&t;for each device the device driver is currently handling.&n; */
DECL|function|amba_driver_unregister
r_void
id|amba_driver_unregister
c_func
(paren
r_struct
id|amba_driver
op_star
id|drv
)paren
(brace
id|driver_unregister
c_func
(paren
op_amp
id|drv-&gt;drv
)paren
suffix:semicolon
)brace
DECL|function|amba_device_release
r_static
r_void
id|amba_device_release
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|amba_device
op_star
id|d
op_assign
id|to_amba_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;res.parent
)paren
id|release_resource
c_func
(paren
op_amp
id|d-&gt;res
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|d
)paren
suffix:semicolon
)brace
DECL|function|show_id
r_static
id|ssize_t
id|show_id
c_func
(paren
r_struct
id|device
op_star
id|_dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|amba_device
op_star
id|dev
op_assign
id|to_amba_device
c_func
(paren
id|_dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%08x&bslash;n&quot;
comma
id|dev-&gt;periphid
)paren
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|id
comma
id|S_IRUGO
comma
id|show_id
comma
l_int|NULL
)paren
suffix:semicolon
DECL|function|show_irq
r_static
id|ssize_t
id|show_irq
c_func
(paren
r_struct
id|device
op_star
id|_dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|amba_device
op_star
id|dev
op_assign
id|to_amba_device
c_func
(paren
id|_dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%u&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|irq
comma
id|S_IRUGO
comma
id|show_irq
comma
l_int|NULL
)paren
suffix:semicolon
DECL|function|show_res
r_static
id|ssize_t
id|show_res
c_func
(paren
r_struct
id|device
op_star
id|_dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|amba_device
op_star
id|dev
op_assign
id|to_amba_device
c_func
(paren
id|_dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;&bslash;t%08lx&bslash;t%08lx&bslash;t%08lx&bslash;n&quot;
comma
id|dev-&gt;res.start
comma
id|dev-&gt;res.end
comma
id|dev-&gt;res.flags
)paren
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|resource
comma
id|S_IRUGO
comma
id|show_res
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/**&n; *&t;amba_device_register - register an AMBA device&n; *&t;@dev: AMBA device to register&n; *&t;@parent: parent memory resource&n; *&n; *&t;Setup the AMBA device, reading the cell ID if present.&n; *&t;Claim the resource, and register the AMBA device with&n; *&t;the Linux device manager.&n; */
DECL|function|amba_device_register
r_int
id|amba_device_register
c_func
(paren
r_struct
id|amba_device
op_star
id|dev
comma
r_struct
id|resource
op_star
id|parent
)paren
(brace
id|u32
id|pid
comma
id|cid
suffix:semicolon
r_void
op_star
id|tmp
suffix:semicolon
r_int
id|i
comma
id|ret
suffix:semicolon
id|dev-&gt;dev.release
op_assign
id|amba_device_release
suffix:semicolon
id|dev-&gt;dev.bus
op_assign
op_amp
id|amba_bustype
suffix:semicolon
id|dev-&gt;res.name
op_assign
id|dev-&gt;dev.name
suffix:semicolon
id|ret
op_assign
id|request_resource
c_func
(paren
id|parent
comma
op_amp
id|dev-&gt;res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
id|tmp
op_assign
id|ioremap
c_func
(paren
id|dev-&gt;res.start
comma
id|SZ_4K
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmp
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_for
c_loop
(paren
id|pid
op_assign
l_int|0
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|pid
op_or_assign
(paren
id|readl
c_func
(paren
id|tmp
op_plus
l_int|0xfe0
op_plus
l_int|4
op_star
id|i
)paren
op_amp
l_int|255
)paren
op_lshift
(paren
id|i
op_star
l_int|8
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cid
op_assign
l_int|0
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|cid
op_or_assign
(paren
id|readl
c_func
(paren
id|tmp
op_plus
l_int|0xff0
op_plus
l_int|4
op_star
id|i
)paren
op_amp
l_int|255
)paren
op_lshift
(paren
id|i
op_star
l_int|8
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cid
op_eq
l_int|0xb105f00d
)paren
id|dev-&gt;periphid
op_assign
id|pid
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;periphid
)paren
id|snprintf
c_func
(paren
id|dev-&gt;dev.name
comma
r_sizeof
(paren
id|dev-&gt;dev.name
)paren
comma
l_string|&quot;AMBA PL%03X&quot;
comma
id|dev-&gt;periphid
op_amp
l_int|0xfff
)paren
suffix:semicolon
r_else
id|strlcpy
c_func
(paren
id|dev-&gt;dev.name
comma
l_string|&quot;AMBA unknown&quot;
comma
r_sizeof
(paren
id|dev-&gt;dev.name
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|device_register
c_func
(paren
op_amp
id|dev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
id|device_create_file
c_func
(paren
op_amp
id|dev-&gt;dev
comma
op_amp
id|dev_attr_id
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|dev-&gt;dev
comma
op_amp
id|dev_attr_irq
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|dev-&gt;dev
comma
op_amp
id|dev_attr_resource
)paren
suffix:semicolon
)brace
r_else
(brace
id|out
suffix:colon
id|release_resource
c_func
(paren
op_amp
id|dev-&gt;res
)paren
suffix:semicolon
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;amba_device_unregister - unregister an AMBA device&n; *&t;@dev: AMBA device to remove&n; *&n; *&t;Remove the specified AMBA device from the Linux device&n; *&t;manager.  All files associated with this object will be&n; *&t;destroyed, and device drivers notified that the device has&n; *&t;been removed.  The AMBA device&squot;s resources including&n; *&t;the amba_device structure will be freed once all&n; *&t;references to it have been dropped.&n; */
DECL|function|amba_device_unregister
r_void
id|amba_device_unregister
c_func
(paren
r_struct
id|amba_device
op_star
id|dev
)paren
(brace
id|device_unregister
c_func
(paren
op_amp
id|dev-&gt;dev
)paren
suffix:semicolon
)brace
DECL|variable|amba_driver_register
id|EXPORT_SYMBOL
c_func
(paren
id|amba_driver_register
)paren
suffix:semicolon
DECL|variable|amba_driver_unregister
id|EXPORT_SYMBOL
c_func
(paren
id|amba_driver_unregister
)paren
suffix:semicolon
DECL|variable|amba_device_register
id|EXPORT_SYMBOL
c_func
(paren
id|amba_device_register
)paren
suffix:semicolon
DECL|variable|amba_device_unregister
id|EXPORT_SYMBOL
c_func
(paren
id|amba_device_unregister
)paren
suffix:semicolon
eof
