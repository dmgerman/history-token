multiline_comment|/*&n; * linux/arch/arm/common/locomo.c&n; *&n; * Sharp LoCoMo support&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; * This file contains all generic LoCoMo support.&n; *&n; * All initialization functions provided here are intended to be called&n; * from machine specific code with proper arguments when required.&n; *&n; * Based on sa1111.c&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/mach-types.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/mach/irq.h&gt;
macro_line|#include &lt;asm/hardware/locomo.h&gt;
multiline_comment|/* the following is the overall data for the locomo chip */
DECL|struct|locomo
r_struct
id|locomo
(brace
DECL|member|dev
r_struct
id|device
op_star
id|dev
suffix:semicolon
DECL|member|phys
r_int
r_int
id|phys
suffix:semicolon
DECL|member|irq
r_int
r_int
id|irq
suffix:semicolon
DECL|member|base
r_void
op_star
id|base
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|locomo_dev_info
r_struct
id|locomo_dev_info
(brace
DECL|member|offset
r_int
r_int
id|offset
suffix:semicolon
DECL|member|length
r_int
r_int
id|length
suffix:semicolon
DECL|member|devid
r_int
r_int
id|devid
suffix:semicolon
DECL|member|irq
r_int
r_int
id|irq
(braket
l_int|1
)braket
suffix:semicolon
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|locomo_devices
r_static
r_struct
id|locomo_dev_info
id|locomo_devices
(braket
)braket
op_assign
(brace
)brace
suffix:semicolon
multiline_comment|/** LoCoMo interrupt handling stuff.&n; * NOTE: LoCoMo has a 1 to many mapping on all of its IRQs.&n; * that is, there is only one real hardware interrupt&n; * we determine which interrupt it is by reading some IO memory.&n; * We have two levels of expansion, first in the handler for the&n; * hardware interrupt we generate an interrupt&n; * IRQ_LOCOMO_*_BASE and those handlers generate more interrupts&n; *&n; * hardware irq reads LOCOMO_ICR &amp; 0x0f00&n; *   IRQ_LOCOMO_KEY_BASE&n; *   IRQ_LOCOMO_GPIO_BASE&n; *   IRQ_LOCOMO_LT_BASE&n; *   IRQ_LOCOMO_SPI_BASE&n; * IRQ_LOCOMO_KEY_BASE reads LOCOMO_KIC &amp; 0x0001&n; *   IRQ_LOCOMO_KEY&n; * IRQ_LOCOMO_GPIO_BASE reads LOCOMO_GIR &amp; LOCOMO_GPD &amp; 0xffff&n; *   IRQ_LOCOMO_GPIO[0-15]&n; * IRQ_LOCOMO_LT_BASE reads LOCOMO_LTINT &amp; 0x0001&n; *   IRQ_LOCOMO_LT&n; * IRQ_LOCOMO_SPI_BASE reads LOCOMO_SPIIR &amp; 0x000F&n; *   IRQ_LOCOMO_SPI_RFR&n; *   IRQ_LOCOMO_SPI_RFW&n; *   IRQ_LOCOMO_SPI_OVRN&n; *   IRQ_LOCOMO_SPI_TEND&n; */
DECL|macro|LOCOMO_IRQ_START
mdefine_line|#define LOCOMO_IRQ_START&t;(IRQ_LOCOMO_KEY_BASE)
DECL|macro|LOCOMO_IRQ_KEY_START
mdefine_line|#define LOCOMO_IRQ_KEY_START&t;(IRQ_LOCOMO_KEY)
DECL|macro|LOCOMO_IRQ_GPIO_START
mdefine_line|#define&t;LOCOMO_IRQ_GPIO_START&t;(IRQ_LOCOMO_GPIO0)
DECL|macro|LOCOMO_IRQ_LT_START
mdefine_line|#define&t;LOCOMO_IRQ_LT_START&t;(IRQ_LOCOMO_LT)
DECL|macro|LOCOMO_IRQ_SPI_START
mdefine_line|#define&t;LOCOMO_IRQ_SPI_START&t;(IRQ_LOCOMO_SPI_RFR)
DECL|function|locomo_handler
r_static
r_void
id|locomo_handler
c_func
(paren
r_int
r_int
id|irq
comma
r_struct
id|irqdesc
op_star
id|desc
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|req
comma
id|i
suffix:semicolon
r_struct
id|irqdesc
op_star
id|d
suffix:semicolon
r_void
op_star
id|mapbase
op_assign
id|get_irq_chipdata
c_func
(paren
id|irq
)paren
suffix:semicolon
multiline_comment|/* Acknowledge the parent IRQ */
id|desc-&gt;chip
op_member_access_from_pointer
id|ack
c_func
(paren
id|irq
)paren
suffix:semicolon
multiline_comment|/* check why this interrupt was generated */
id|req
op_assign
id|locomo_readl
c_func
(paren
id|mapbase
op_plus
id|LOCOMO_ICR
)paren
op_amp
l_int|0x0f00
suffix:semicolon
r_if
c_cond
(paren
id|req
)paren
(brace
multiline_comment|/* generate the next interrupt(s) */
id|irq
op_assign
id|LOCOMO_IRQ_START
suffix:semicolon
id|d
op_assign
id|irq_desc
op_plus
id|irq
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|3
suffix:semicolon
id|i
op_increment
comma
id|d
op_increment
comma
id|irq
op_increment
)paren
(brace
r_if
c_cond
(paren
id|req
op_amp
(paren
l_int|0x0100
op_lshift
id|i
)paren
)paren
(brace
id|d
op_member_access_from_pointer
id|handle
c_func
(paren
id|irq
comma
id|d
comma
id|regs
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|function|locomo_ack_irq
r_static
r_void
id|locomo_ack_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
)brace
DECL|function|locomo_mask_irq
r_static
r_void
id|locomo_mask_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_void
op_star
id|mapbase
op_assign
id|get_irq_chipdata
c_func
(paren
id|irq
)paren
suffix:semicolon
r_int
r_int
id|r
suffix:semicolon
id|r
op_assign
id|locomo_readl
c_func
(paren
id|mapbase
op_plus
id|LOCOMO_ICR
)paren
suffix:semicolon
id|r
op_and_assign
op_complement
(paren
l_int|0x0010
op_lshift
(paren
id|irq
op_minus
id|LOCOMO_IRQ_START
)paren
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
id|r
comma
id|mapbase
op_plus
id|LOCOMO_ICR
)paren
suffix:semicolon
)brace
DECL|function|locomo_unmask_irq
r_static
r_void
id|locomo_unmask_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_void
op_star
id|mapbase
op_assign
id|get_irq_chipdata
c_func
(paren
id|irq
)paren
suffix:semicolon
r_int
r_int
id|r
suffix:semicolon
id|r
op_assign
id|locomo_readl
c_func
(paren
id|mapbase
op_plus
id|LOCOMO_ICR
)paren
suffix:semicolon
id|r
op_or_assign
(paren
l_int|0x0010
op_lshift
(paren
id|irq
op_minus
id|LOCOMO_IRQ_START
)paren
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
id|r
comma
id|mapbase
op_plus
id|LOCOMO_ICR
)paren
suffix:semicolon
)brace
DECL|variable|locomo_chip
r_static
r_struct
id|irqchip
id|locomo_chip
op_assign
(brace
dot
id|ack
op_assign
id|locomo_ack_irq
comma
dot
id|mask
op_assign
id|locomo_mask_irq
comma
dot
id|unmask
op_assign
id|locomo_unmask_irq
comma
)brace
suffix:semicolon
DECL|function|locomo_key_handler
r_static
r_void
id|locomo_key_handler
c_func
(paren
r_int
r_int
id|irq
comma
r_struct
id|irqdesc
op_star
id|desc
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|irqdesc
op_star
id|d
suffix:semicolon
r_void
op_star
id|mapbase
op_assign
id|get_irq_chipdata
c_func
(paren
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|locomo_readl
c_func
(paren
id|mapbase
op_plus
id|LOCOMO_KIC
)paren
op_amp
l_int|0x0001
)paren
(brace
id|d
op_assign
id|irq_desc
op_plus
id|LOCOMO_IRQ_KEY_START
suffix:semicolon
id|d
op_member_access_from_pointer
id|handle
c_func
(paren
id|LOCOMO_IRQ_KEY_START
comma
id|d
comma
id|regs
)paren
suffix:semicolon
)brace
)brace
DECL|function|locomo_key_ack_irq
r_static
r_void
id|locomo_key_ack_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_void
op_star
id|mapbase
op_assign
id|get_irq_chipdata
c_func
(paren
id|irq
)paren
suffix:semicolon
r_int
r_int
id|r
suffix:semicolon
id|r
op_assign
id|locomo_readl
c_func
(paren
id|mapbase
op_plus
id|LOCOMO_KIC
)paren
suffix:semicolon
id|r
op_and_assign
op_complement
(paren
l_int|0x0100
op_lshift
(paren
id|irq
op_minus
id|LOCOMO_IRQ_KEY_START
)paren
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
id|r
comma
id|mapbase
op_plus
id|LOCOMO_KIC
)paren
suffix:semicolon
)brace
DECL|function|locomo_key_mask_irq
r_static
r_void
id|locomo_key_mask_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_void
op_star
id|mapbase
op_assign
id|get_irq_chipdata
c_func
(paren
id|irq
)paren
suffix:semicolon
r_int
r_int
id|r
suffix:semicolon
id|r
op_assign
id|locomo_readl
c_func
(paren
id|mapbase
op_plus
id|LOCOMO_KIC
)paren
suffix:semicolon
id|r
op_and_assign
op_complement
(paren
l_int|0x0010
op_lshift
(paren
id|irq
op_minus
id|LOCOMO_IRQ_KEY_START
)paren
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
id|r
comma
id|mapbase
op_plus
id|LOCOMO_KIC
)paren
suffix:semicolon
)brace
DECL|function|locomo_key_unmask_irq
r_static
r_void
id|locomo_key_unmask_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_void
op_star
id|mapbase
op_assign
id|get_irq_chipdata
c_func
(paren
id|irq
)paren
suffix:semicolon
r_int
r_int
id|r
suffix:semicolon
id|r
op_assign
id|locomo_readl
c_func
(paren
id|mapbase
op_plus
id|LOCOMO_KIC
)paren
suffix:semicolon
id|r
op_or_assign
(paren
l_int|0x0010
op_lshift
(paren
id|irq
op_minus
id|LOCOMO_IRQ_KEY_START
)paren
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
id|r
comma
id|mapbase
op_plus
id|LOCOMO_KIC
)paren
suffix:semicolon
)brace
DECL|variable|locomo_key_chip
r_static
r_struct
id|irqchip
id|locomo_key_chip
op_assign
(brace
dot
id|ack
op_assign
id|locomo_key_ack_irq
comma
dot
id|mask
op_assign
id|locomo_key_mask_irq
comma
dot
id|unmask
op_assign
id|locomo_key_unmask_irq
comma
)brace
suffix:semicolon
DECL|function|locomo_gpio_handler
r_static
r_void
id|locomo_gpio_handler
c_func
(paren
r_int
r_int
id|irq
comma
r_struct
id|irqdesc
op_star
id|desc
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|req
comma
id|i
suffix:semicolon
r_struct
id|irqdesc
op_star
id|d
suffix:semicolon
r_void
op_star
id|mapbase
op_assign
id|get_irq_chipdata
c_func
(paren
id|irq
)paren
suffix:semicolon
id|req
op_assign
id|locomo_readl
c_func
(paren
id|mapbase
op_plus
id|LOCOMO_GIR
)paren
op_amp
id|locomo_readl
c_func
(paren
id|mapbase
op_plus
id|LOCOMO_GPD
)paren
op_amp
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|req
)paren
(brace
id|irq
op_assign
id|LOCOMO_IRQ_GPIO_START
suffix:semicolon
id|d
op_assign
id|irq_desc
op_plus
id|LOCOMO_IRQ_GPIO_START
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|15
suffix:semicolon
id|i
op_increment
comma
id|irq
op_increment
comma
id|d
op_increment
)paren
(brace
r_if
c_cond
(paren
id|req
op_amp
(paren
l_int|0x0001
op_lshift
id|i
)paren
)paren
(brace
id|d
op_member_access_from_pointer
id|handle
c_func
(paren
id|irq
comma
id|d
comma
id|regs
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|function|locomo_gpio_ack_irq
r_static
r_void
id|locomo_gpio_ack_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_void
op_star
id|mapbase
op_assign
id|get_irq_chipdata
c_func
(paren
id|irq
)paren
suffix:semicolon
r_int
r_int
id|r
suffix:semicolon
id|r
op_assign
id|locomo_readl
c_func
(paren
id|mapbase
op_plus
id|LOCOMO_GWE
)paren
suffix:semicolon
id|r
op_or_assign
(paren
l_int|0x0001
op_lshift
(paren
id|irq
op_minus
id|LOCOMO_IRQ_GPIO_START
)paren
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
id|r
comma
id|mapbase
op_plus
id|LOCOMO_GWE
)paren
suffix:semicolon
id|r
op_assign
id|locomo_readl
c_func
(paren
id|mapbase
op_plus
id|LOCOMO_GIS
)paren
suffix:semicolon
id|r
op_and_assign
op_complement
(paren
l_int|0x0001
op_lshift
(paren
id|irq
op_minus
id|LOCOMO_IRQ_GPIO_START
)paren
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
id|r
comma
id|mapbase
op_plus
id|LOCOMO_GIS
)paren
suffix:semicolon
id|r
op_assign
id|locomo_readl
c_func
(paren
id|mapbase
op_plus
id|LOCOMO_GWE
)paren
suffix:semicolon
id|r
op_and_assign
op_complement
(paren
l_int|0x0001
op_lshift
(paren
id|irq
op_minus
id|LOCOMO_IRQ_GPIO_START
)paren
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
id|r
comma
id|mapbase
op_plus
id|LOCOMO_GWE
)paren
suffix:semicolon
)brace
DECL|function|locomo_gpio_mask_irq
r_static
r_void
id|locomo_gpio_mask_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_void
op_star
id|mapbase
op_assign
id|get_irq_chipdata
c_func
(paren
id|irq
)paren
suffix:semicolon
r_int
r_int
id|r
suffix:semicolon
id|r
op_assign
id|locomo_readl
c_func
(paren
id|mapbase
op_plus
id|LOCOMO_GIE
)paren
suffix:semicolon
id|r
op_and_assign
op_complement
(paren
l_int|0x0001
op_lshift
(paren
id|irq
op_minus
id|LOCOMO_IRQ_GPIO_START
)paren
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
id|r
comma
id|mapbase
op_plus
id|LOCOMO_GIE
)paren
suffix:semicolon
)brace
DECL|function|locomo_gpio_unmask_irq
r_static
r_void
id|locomo_gpio_unmask_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_void
op_star
id|mapbase
op_assign
id|get_irq_chipdata
c_func
(paren
id|irq
)paren
suffix:semicolon
r_int
r_int
id|r
suffix:semicolon
id|r
op_assign
id|locomo_readl
c_func
(paren
id|mapbase
op_plus
id|LOCOMO_GIE
)paren
suffix:semicolon
id|r
op_or_assign
(paren
l_int|0x0001
op_lshift
(paren
id|irq
op_minus
id|LOCOMO_IRQ_GPIO_START
)paren
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
id|r
comma
id|mapbase
op_plus
id|LOCOMO_GIE
)paren
suffix:semicolon
)brace
DECL|variable|locomo_gpio_chip
r_static
r_struct
id|irqchip
id|locomo_gpio_chip
op_assign
(brace
dot
id|ack
op_assign
id|locomo_gpio_ack_irq
comma
dot
id|mask
op_assign
id|locomo_gpio_mask_irq
comma
dot
id|unmask
op_assign
id|locomo_gpio_unmask_irq
comma
)brace
suffix:semicolon
DECL|function|locomo_lt_handler
r_static
r_void
id|locomo_lt_handler
c_func
(paren
r_int
r_int
id|irq
comma
r_struct
id|irqdesc
op_star
id|desc
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|irqdesc
op_star
id|d
suffix:semicolon
r_void
op_star
id|mapbase
op_assign
id|get_irq_chipdata
c_func
(paren
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|locomo_readl
c_func
(paren
id|mapbase
op_plus
id|LOCOMO_LTINT
)paren
op_amp
l_int|0x0001
)paren
(brace
id|d
op_assign
id|irq_desc
op_plus
id|LOCOMO_IRQ_LT_START
suffix:semicolon
id|d
op_member_access_from_pointer
id|handle
c_func
(paren
id|LOCOMO_IRQ_LT_START
comma
id|d
comma
id|regs
)paren
suffix:semicolon
)brace
)brace
DECL|function|locomo_lt_ack_irq
r_static
r_void
id|locomo_lt_ack_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_void
op_star
id|mapbase
op_assign
id|get_irq_chipdata
c_func
(paren
id|irq
)paren
suffix:semicolon
r_int
r_int
id|r
suffix:semicolon
id|r
op_assign
id|locomo_readl
c_func
(paren
id|mapbase
op_plus
id|LOCOMO_LTINT
)paren
suffix:semicolon
id|r
op_and_assign
op_complement
(paren
l_int|0x0100
op_lshift
(paren
id|irq
op_minus
id|LOCOMO_IRQ_LT_START
)paren
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
id|r
comma
id|mapbase
op_plus
id|LOCOMO_LTINT
)paren
suffix:semicolon
)brace
DECL|function|locomo_lt_mask_irq
r_static
r_void
id|locomo_lt_mask_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_void
op_star
id|mapbase
op_assign
id|get_irq_chipdata
c_func
(paren
id|irq
)paren
suffix:semicolon
r_int
r_int
id|r
suffix:semicolon
id|r
op_assign
id|locomo_readl
c_func
(paren
id|mapbase
op_plus
id|LOCOMO_LTINT
)paren
suffix:semicolon
id|r
op_and_assign
op_complement
(paren
l_int|0x0010
op_lshift
(paren
id|irq
op_minus
id|LOCOMO_IRQ_LT_START
)paren
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
id|r
comma
id|mapbase
op_plus
id|LOCOMO_LTINT
)paren
suffix:semicolon
)brace
DECL|function|locomo_lt_unmask_irq
r_static
r_void
id|locomo_lt_unmask_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_void
op_star
id|mapbase
op_assign
id|get_irq_chipdata
c_func
(paren
id|irq
)paren
suffix:semicolon
r_int
r_int
id|r
suffix:semicolon
id|r
op_assign
id|locomo_readl
c_func
(paren
id|mapbase
op_plus
id|LOCOMO_LTINT
)paren
suffix:semicolon
id|r
op_or_assign
(paren
l_int|0x0010
op_lshift
(paren
id|irq
op_minus
id|LOCOMO_IRQ_LT_START
)paren
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
id|r
comma
id|mapbase
op_plus
id|LOCOMO_LTINT
)paren
suffix:semicolon
)brace
DECL|variable|locomo_lt_chip
r_static
r_struct
id|irqchip
id|locomo_lt_chip
op_assign
(brace
dot
id|ack
op_assign
id|locomo_lt_ack_irq
comma
dot
id|mask
op_assign
id|locomo_lt_mask_irq
comma
dot
id|unmask
op_assign
id|locomo_lt_unmask_irq
comma
)brace
suffix:semicolon
DECL|function|locomo_spi_handler
r_static
r_void
id|locomo_spi_handler
c_func
(paren
r_int
r_int
id|irq
comma
r_struct
id|irqdesc
op_star
id|desc
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|req
comma
id|i
suffix:semicolon
r_struct
id|irqdesc
op_star
id|d
suffix:semicolon
r_void
op_star
id|mapbase
op_assign
id|get_irq_chipdata
c_func
(paren
id|irq
)paren
suffix:semicolon
id|req
op_assign
id|locomo_readl
c_func
(paren
id|mapbase
op_plus
id|LOCOMO_SPIIR
)paren
op_amp
l_int|0x000F
suffix:semicolon
r_if
c_cond
(paren
id|req
)paren
(brace
id|irq
op_assign
id|LOCOMO_IRQ_SPI_START
suffix:semicolon
id|d
op_assign
id|irq_desc
op_plus
id|irq
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|3
suffix:semicolon
id|i
op_increment
comma
id|irq
op_increment
comma
id|d
op_increment
)paren
(brace
r_if
c_cond
(paren
id|req
op_amp
(paren
l_int|0x0001
op_lshift
id|i
)paren
)paren
(brace
id|d
op_member_access_from_pointer
id|handle
c_func
(paren
id|irq
comma
id|d
comma
id|regs
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|function|locomo_spi_ack_irq
r_static
r_void
id|locomo_spi_ack_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_void
op_star
id|mapbase
op_assign
id|get_irq_chipdata
c_func
(paren
id|irq
)paren
suffix:semicolon
r_int
r_int
id|r
suffix:semicolon
id|r
op_assign
id|locomo_readl
c_func
(paren
id|mapbase
op_plus
id|LOCOMO_SPIWE
)paren
suffix:semicolon
id|r
op_or_assign
(paren
l_int|0x0001
op_lshift
(paren
id|irq
op_minus
id|LOCOMO_IRQ_SPI_START
)paren
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
id|r
comma
id|mapbase
op_plus
id|LOCOMO_SPIWE
)paren
suffix:semicolon
id|r
op_assign
id|locomo_readl
c_func
(paren
id|mapbase
op_plus
id|LOCOMO_SPIIS
)paren
suffix:semicolon
id|r
op_and_assign
op_complement
(paren
l_int|0x0001
op_lshift
(paren
id|irq
op_minus
id|LOCOMO_IRQ_SPI_START
)paren
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
id|r
comma
id|mapbase
op_plus
id|LOCOMO_SPIIS
)paren
suffix:semicolon
id|r
op_assign
id|locomo_readl
c_func
(paren
id|mapbase
op_plus
id|LOCOMO_SPIWE
)paren
suffix:semicolon
id|r
op_and_assign
op_complement
(paren
l_int|0x0001
op_lshift
(paren
id|irq
op_minus
id|LOCOMO_IRQ_SPI_START
)paren
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
id|r
comma
id|mapbase
op_plus
id|LOCOMO_SPIWE
)paren
suffix:semicolon
)brace
DECL|function|locomo_spi_mask_irq
r_static
r_void
id|locomo_spi_mask_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_void
op_star
id|mapbase
op_assign
id|get_irq_chipdata
c_func
(paren
id|irq
)paren
suffix:semicolon
r_int
r_int
id|r
suffix:semicolon
id|r
op_assign
id|locomo_readl
c_func
(paren
id|mapbase
op_plus
id|LOCOMO_SPIIE
)paren
suffix:semicolon
id|r
op_and_assign
op_complement
(paren
l_int|0x0001
op_lshift
(paren
id|irq
op_minus
id|LOCOMO_IRQ_SPI_START
)paren
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
id|r
comma
id|mapbase
op_plus
id|LOCOMO_SPIIE
)paren
suffix:semicolon
)brace
DECL|function|locomo_spi_unmask_irq
r_static
r_void
id|locomo_spi_unmask_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_void
op_star
id|mapbase
op_assign
id|get_irq_chipdata
c_func
(paren
id|irq
)paren
suffix:semicolon
r_int
r_int
id|r
suffix:semicolon
id|r
op_assign
id|locomo_readl
c_func
(paren
id|mapbase
op_plus
id|LOCOMO_SPIIE
)paren
suffix:semicolon
id|r
op_or_assign
(paren
l_int|0x0001
op_lshift
(paren
id|irq
op_minus
id|LOCOMO_IRQ_SPI_START
)paren
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
id|r
comma
id|mapbase
op_plus
id|LOCOMO_SPIIE
)paren
suffix:semicolon
)brace
DECL|variable|locomo_spi_chip
r_static
r_struct
id|irqchip
id|locomo_spi_chip
op_assign
(brace
dot
id|ack
op_assign
id|locomo_spi_ack_irq
comma
dot
id|mask
op_assign
id|locomo_spi_mask_irq
comma
dot
id|unmask
op_assign
id|locomo_spi_unmask_irq
comma
)brace
suffix:semicolon
DECL|function|locomo_setup_irq
r_static
r_void
id|locomo_setup_irq
c_func
(paren
r_struct
id|locomo
op_star
id|lchip
)paren
(brace
r_int
id|irq
suffix:semicolon
r_void
op_star
id|irqbase
op_assign
id|lchip-&gt;base
suffix:semicolon
multiline_comment|/*&n;&t; * Install handler for IRQ_LOCOMO_HW.&n;&t; */
id|set_irq_type
c_func
(paren
id|lchip-&gt;irq
comma
id|IRQT_FALLING
)paren
suffix:semicolon
id|set_irq_chipdata
c_func
(paren
id|lchip-&gt;irq
comma
id|irqbase
)paren
suffix:semicolon
id|set_irq_chained_handler
c_func
(paren
id|lchip-&gt;irq
comma
id|locomo_handler
)paren
suffix:semicolon
multiline_comment|/* Install handlers for IRQ_LOCOMO_*_BASE */
id|set_irq_chip
c_func
(paren
id|IRQ_LOCOMO_KEY_BASE
comma
op_amp
id|locomo_chip
)paren
suffix:semicolon
id|set_irq_chipdata
c_func
(paren
id|IRQ_LOCOMO_KEY_BASE
comma
id|irqbase
)paren
suffix:semicolon
id|set_irq_chained_handler
c_func
(paren
id|IRQ_LOCOMO_KEY_BASE
comma
id|locomo_key_handler
)paren
suffix:semicolon
id|set_irq_flags
c_func
(paren
id|IRQ_LOCOMO_KEY_BASE
comma
id|IRQF_VALID
op_or
id|IRQF_PROBE
)paren
suffix:semicolon
id|set_irq_chip
c_func
(paren
id|IRQ_LOCOMO_GPIO_BASE
comma
op_amp
id|locomo_chip
)paren
suffix:semicolon
id|set_irq_chipdata
c_func
(paren
id|IRQ_LOCOMO_GPIO_BASE
comma
id|irqbase
)paren
suffix:semicolon
id|set_irq_chained_handler
c_func
(paren
id|IRQ_LOCOMO_GPIO_BASE
comma
id|locomo_gpio_handler
)paren
suffix:semicolon
id|set_irq_flags
c_func
(paren
id|IRQ_LOCOMO_GPIO_BASE
comma
id|IRQF_VALID
op_or
id|IRQF_PROBE
)paren
suffix:semicolon
id|set_irq_chip
c_func
(paren
id|IRQ_LOCOMO_LT_BASE
comma
op_amp
id|locomo_chip
)paren
suffix:semicolon
id|set_irq_chipdata
c_func
(paren
id|IRQ_LOCOMO_LT_BASE
comma
id|irqbase
)paren
suffix:semicolon
id|set_irq_chained_handler
c_func
(paren
id|IRQ_LOCOMO_LT_BASE
comma
id|locomo_lt_handler
)paren
suffix:semicolon
id|set_irq_flags
c_func
(paren
id|IRQ_LOCOMO_LT_BASE
comma
id|IRQF_VALID
op_or
id|IRQF_PROBE
)paren
suffix:semicolon
id|set_irq_chip
c_func
(paren
id|IRQ_LOCOMO_SPI_BASE
comma
op_amp
id|locomo_chip
)paren
suffix:semicolon
id|set_irq_chipdata
c_func
(paren
id|IRQ_LOCOMO_SPI_BASE
comma
id|irqbase
)paren
suffix:semicolon
id|set_irq_chained_handler
c_func
(paren
id|IRQ_LOCOMO_SPI_BASE
comma
id|locomo_spi_handler
)paren
suffix:semicolon
id|set_irq_flags
c_func
(paren
id|IRQ_LOCOMO_SPI_BASE
comma
id|IRQF_VALID
op_or
id|IRQF_PROBE
)paren
suffix:semicolon
multiline_comment|/* install handlers for IRQ_LOCOMO_KEY_BASE generated interrupts */
id|set_irq_chip
c_func
(paren
id|LOCOMO_IRQ_KEY_START
comma
op_amp
id|locomo_key_chip
)paren
suffix:semicolon
id|set_irq_chipdata
c_func
(paren
id|LOCOMO_IRQ_KEY_START
comma
id|irqbase
)paren
suffix:semicolon
id|set_irq_handler
c_func
(paren
id|LOCOMO_IRQ_KEY_START
comma
id|do_edge_IRQ
)paren
suffix:semicolon
id|set_irq_flags
c_func
(paren
id|LOCOMO_IRQ_KEY_START
comma
id|IRQF_VALID
op_or
id|IRQF_PROBE
)paren
suffix:semicolon
multiline_comment|/* install handlers for IRQ_LOCOMO_GPIO_BASE generated interrupts */
r_for
c_loop
(paren
id|irq
op_assign
id|LOCOMO_IRQ_GPIO_START
suffix:semicolon
id|irq
OL
id|LOCOMO_IRQ_GPIO_START
op_plus
l_int|16
suffix:semicolon
id|irq
op_increment
)paren
(brace
id|set_irq_chip
c_func
(paren
id|irq
comma
op_amp
id|locomo_gpio_chip
)paren
suffix:semicolon
id|set_irq_chipdata
c_func
(paren
id|irq
comma
id|irqbase
)paren
suffix:semicolon
id|set_irq_handler
c_func
(paren
id|irq
comma
id|do_edge_IRQ
)paren
suffix:semicolon
id|set_irq_flags
c_func
(paren
id|irq
comma
id|IRQF_VALID
op_or
id|IRQF_PROBE
)paren
suffix:semicolon
)brace
multiline_comment|/* install handlers for IRQ_LOCOMO_LT_BASE generated interrupts */
id|set_irq_chip
c_func
(paren
id|LOCOMO_IRQ_LT_START
comma
op_amp
id|locomo_lt_chip
)paren
suffix:semicolon
id|set_irq_chipdata
c_func
(paren
id|LOCOMO_IRQ_LT_START
comma
id|irqbase
)paren
suffix:semicolon
id|set_irq_handler
c_func
(paren
id|LOCOMO_IRQ_LT_START
comma
id|do_edge_IRQ
)paren
suffix:semicolon
id|set_irq_flags
c_func
(paren
id|LOCOMO_IRQ_LT_START
comma
id|IRQF_VALID
op_or
id|IRQF_PROBE
)paren
suffix:semicolon
multiline_comment|/* install handlers for IRQ_LOCOMO_SPI_BASE generated interrupts */
r_for
c_loop
(paren
id|irq
op_assign
id|LOCOMO_IRQ_SPI_START
suffix:semicolon
id|irq
OL
id|LOCOMO_IRQ_SPI_START
op_plus
l_int|3
suffix:semicolon
id|irq
op_increment
)paren
(brace
id|set_irq_chip
c_func
(paren
id|irq
comma
op_amp
id|locomo_spi_chip
)paren
suffix:semicolon
id|set_irq_chipdata
c_func
(paren
id|irq
comma
id|irqbase
)paren
suffix:semicolon
id|set_irq_handler
c_func
(paren
id|irq
comma
id|do_edge_IRQ
)paren
suffix:semicolon
id|set_irq_flags
c_func
(paren
id|irq
comma
id|IRQF_VALID
op_or
id|IRQF_PROBE
)paren
suffix:semicolon
)brace
)brace
DECL|function|locomo_dev_release
r_static
r_void
id|locomo_dev_release
c_func
(paren
r_struct
id|device
op_star
id|_dev
)paren
(brace
r_struct
id|locomo_dev
op_star
id|dev
op_assign
id|LOCOMO_DEV
c_func
(paren
id|_dev
)paren
suffix:semicolon
id|release_resource
c_func
(paren
op_amp
id|dev-&gt;res
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|locomo_init_one_child
id|locomo_init_one_child
c_func
(paren
r_struct
id|locomo
op_star
id|lchip
comma
r_struct
id|resource
op_star
id|parent
comma
r_struct
id|locomo_dev_info
op_star
id|info
)paren
(brace
r_struct
id|locomo_dev
op_star
id|dev
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|locomo_dev
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|locomo_dev
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|dev-&gt;dev.bus_id
comma
id|info-&gt;name
comma
r_sizeof
(paren
id|dev-&gt;dev.bus_id
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If the parent device has a DMA mask associated with it,&n;&t; * propagate it down to the children.&n;&t; */
r_if
c_cond
(paren
id|lchip-&gt;dev-&gt;dma_mask
)paren
(brace
id|dev-&gt;dma_mask
op_assign
op_star
id|lchip-&gt;dev-&gt;dma_mask
suffix:semicolon
id|dev-&gt;dev.dma_mask
op_assign
op_amp
id|dev-&gt;dma_mask
suffix:semicolon
)brace
id|dev-&gt;devid
op_assign
id|info-&gt;devid
suffix:semicolon
id|dev-&gt;dev.parent
op_assign
id|lchip-&gt;dev
suffix:semicolon
id|dev-&gt;dev.bus
op_assign
op_amp
id|locomo_bus_type
suffix:semicolon
id|dev-&gt;dev.release
op_assign
id|locomo_dev_release
suffix:semicolon
id|dev-&gt;dev.coherent_dma_mask
op_assign
id|lchip-&gt;dev-&gt;coherent_dma_mask
suffix:semicolon
id|dev-&gt;res.start
op_assign
id|lchip-&gt;phys
op_plus
id|info-&gt;offset
suffix:semicolon
id|dev-&gt;res.end
op_assign
id|dev-&gt;res.start
op_plus
id|info-&gt;length
suffix:semicolon
id|dev-&gt;res.name
op_assign
id|dev-&gt;dev.bus_id
suffix:semicolon
id|dev-&gt;res.flags
op_assign
id|IORESOURCE_MEM
suffix:semicolon
id|dev-&gt;mapbase
op_assign
id|lchip-&gt;base
op_plus
id|info-&gt;offset
suffix:semicolon
id|memmove
c_func
(paren
id|dev-&gt;irq
comma
id|info-&gt;irq
comma
r_sizeof
(paren
id|dev-&gt;irq
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;length
)paren
(brace
id|ret
op_assign
id|request_resource
c_func
(paren
id|parent
comma
op_amp
id|dev-&gt;res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;LoCoMo: failed to allocate resource for %s&bslash;n&quot;
comma
id|dev-&gt;res.name
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|ret
op_assign
id|device_register
c_func
(paren
op_amp
id|dev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|release_resource
c_func
(paren
op_amp
id|dev-&gt;res
)paren
suffix:semicolon
id|out
suffix:colon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;locomo_probe - probe for a single LoCoMo chip.&n; *&t;@phys_addr: physical address of device.&n; *&n; *&t;Probe for a LoCoMo chip.  This must be called&n; *&t;before any other locomo-specific code.&n; *&n; *&t;Returns:&n; *&t;%-ENODEV&t;device not found.&n; *&t;%-EBUSY&t;&t;physical address already marked in-use.&n; *&t;%0&t;&t;successful.&n; */
r_static
r_int
DECL|function|__locomo_probe
id|__locomo_probe
c_func
(paren
r_struct
id|device
op_star
id|me
comma
r_struct
id|resource
op_star
id|mem
comma
r_int
id|irq
)paren
(brace
r_struct
id|locomo
op_star
id|lchip
suffix:semicolon
r_int
r_int
id|r
suffix:semicolon
r_int
id|i
comma
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|lchip
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|locomo
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lchip
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|lchip
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|locomo
)paren
)paren
suffix:semicolon
id|lchip-&gt;dev
op_assign
id|me
suffix:semicolon
id|dev_set_drvdata
c_func
(paren
id|lchip-&gt;dev
comma
id|lchip
)paren
suffix:semicolon
id|lchip-&gt;phys
op_assign
id|mem-&gt;start
suffix:semicolon
id|lchip-&gt;irq
op_assign
id|irq
suffix:semicolon
multiline_comment|/*&n;&t; * Map the whole region.  This also maps the&n;&t; * registers for our children.&n;&t; */
id|lchip-&gt;base
op_assign
id|ioremap
c_func
(paren
id|mem-&gt;start
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lchip-&gt;base
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* locomo initialize */
id|locomo_writel
c_func
(paren
l_int|0
comma
id|lchip-&gt;base
op_plus
id|LOCOMO_ICR
)paren
suffix:semicolon
multiline_comment|/* KEYBOARD */
id|locomo_writel
c_func
(paren
l_int|0
comma
id|lchip-&gt;base
op_plus
id|LOCOMO_KIC
)paren
suffix:semicolon
multiline_comment|/* GPIO */
id|locomo_writel
c_func
(paren
l_int|0
comma
id|lchip-&gt;base
op_plus
id|LOCOMO_GPO
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
(paren
id|LOCOMO_GPIO
c_func
(paren
l_int|2
)paren
op_or
id|LOCOMO_GPIO
c_func
(paren
l_int|3
)paren
op_or
id|LOCOMO_GPIO
c_func
(paren
l_int|13
)paren
op_or
id|LOCOMO_GPIO
c_func
(paren
l_int|14
)paren
)paren
comma
id|lchip-&gt;base
op_plus
id|LOCOMO_GPE
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
(paren
id|LOCOMO_GPIO
c_func
(paren
l_int|2
)paren
op_or
id|LOCOMO_GPIO
c_func
(paren
l_int|3
)paren
op_or
id|LOCOMO_GPIO
c_func
(paren
l_int|13
)paren
op_or
id|LOCOMO_GPIO
c_func
(paren
l_int|14
)paren
)paren
comma
id|lchip-&gt;base
op_plus
id|LOCOMO_GPD
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
l_int|0
comma
id|lchip-&gt;base
op_plus
id|LOCOMO_GIE
)paren
suffix:semicolon
multiline_comment|/* FrontLight */
id|locomo_writel
c_func
(paren
l_int|0
comma
id|lchip-&gt;base
op_plus
id|LOCOMO_ALS
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
l_int|0
comma
id|lchip-&gt;base
op_plus
id|LOCOMO_ALD
)paren
suffix:semicolon
multiline_comment|/* Longtime timer */
id|locomo_writel
c_func
(paren
l_int|0
comma
id|lchip-&gt;base
op_plus
id|LOCOMO_LTINT
)paren
suffix:semicolon
multiline_comment|/* SPI */
id|locomo_writel
c_func
(paren
l_int|0
comma
id|lchip-&gt;base
op_plus
id|LOCOMO_SPIIE
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
l_int|6
op_plus
l_int|8
op_plus
l_int|320
op_plus
l_int|30
op_minus
l_int|10
comma
id|lchip-&gt;base
op_plus
id|LOCOMO_ASD
)paren
suffix:semicolon
id|r
op_assign
id|locomo_readl
c_func
(paren
id|lchip-&gt;base
op_plus
id|LOCOMO_ASD
)paren
suffix:semicolon
id|r
op_or_assign
l_int|0x8000
suffix:semicolon
id|locomo_writel
c_func
(paren
id|r
comma
id|lchip-&gt;base
op_plus
id|LOCOMO_ASD
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
l_int|6
op_plus
l_int|8
op_plus
l_int|320
op_plus
l_int|30
op_minus
l_int|10
op_minus
l_int|128
op_plus
l_int|4
comma
id|lchip-&gt;base
op_plus
id|LOCOMO_HSD
)paren
suffix:semicolon
id|r
op_assign
id|locomo_readl
c_func
(paren
id|lchip-&gt;base
op_plus
id|LOCOMO_HSD
)paren
suffix:semicolon
id|r
op_or_assign
l_int|0x8000
suffix:semicolon
id|locomo_writel
c_func
(paren
id|r
comma
id|lchip-&gt;base
op_plus
id|LOCOMO_HSD
)paren
suffix:semicolon
id|locomo_writel
c_func
(paren
l_int|128
op_div
l_int|8
comma
id|lchip-&gt;base
op_plus
id|LOCOMO_HSC
)paren
suffix:semicolon
multiline_comment|/* XON */
id|locomo_writel
c_func
(paren
l_int|0x80
comma
id|lchip-&gt;base
op_plus
id|LOCOMO_TADC
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* CLK9MEN */
id|r
op_assign
id|locomo_readl
c_func
(paren
id|lchip-&gt;base
op_plus
id|LOCOMO_TADC
)paren
suffix:semicolon
id|r
op_or_assign
l_int|0x10
suffix:semicolon
id|locomo_writel
c_func
(paren
id|r
comma
id|lchip-&gt;base
op_plus
id|LOCOMO_TADC
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/* init DAC */
id|r
op_assign
id|locomo_readl
c_func
(paren
id|lchip-&gt;base
op_plus
id|LOCOMO_DAC
)paren
suffix:semicolon
id|r
op_or_assign
id|LOCOMO_DAC_SCLOEB
op_or
id|LOCOMO_DAC_SDAOEB
suffix:semicolon
id|locomo_writel
c_func
(paren
id|r
comma
id|lchip-&gt;base
op_plus
id|LOCOMO_DAC
)paren
suffix:semicolon
id|r
op_assign
id|locomo_readl
c_func
(paren
id|lchip-&gt;base
op_plus
id|LOCOMO_VER
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;LoCoMo Chip: %lu%lu&bslash;n&quot;
comma
(paren
id|r
op_rshift
l_int|8
)paren
comma
(paren
id|r
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * The interrupt controller must be initialised before any&n;&t; * other device to ensure that the interrupts are available.&n;&t; */
r_if
c_cond
(paren
id|lchip-&gt;irq
op_ne
id|NO_IRQ
)paren
id|locomo_setup_irq
c_func
(paren
id|lchip
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|locomo_devices
)paren
suffix:semicolon
id|i
op_increment
)paren
id|locomo_init_one_child
c_func
(paren
id|lchip
comma
id|mem
comma
op_amp
id|locomo_devices
(braket
id|i
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out
suffix:colon
id|kfree
c_func
(paren
id|lchip
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|__locomo_remove
r_static
r_void
id|__locomo_remove
c_func
(paren
r_struct
id|locomo
op_star
id|lchip
)paren
(brace
r_struct
id|list_head
op_star
id|l
comma
op_star
id|n
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|l
comma
id|n
comma
op_amp
id|lchip-&gt;dev-&gt;children
)paren
(brace
r_struct
id|device
op_star
id|d
op_assign
id|list_to_dev
c_func
(paren
id|l
)paren
suffix:semicolon
id|device_unregister
c_func
(paren
id|d
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lchip-&gt;irq
op_ne
id|NO_IRQ
)paren
(brace
id|set_irq_chained_handler
c_func
(paren
id|lchip-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
id|set_irq_data
c_func
(paren
id|lchip-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|iounmap
c_func
(paren
id|lchip-&gt;base
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|lchip
)paren
suffix:semicolon
)brace
DECL|function|locomo_probe
r_static
r_int
id|locomo_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|platform_device
op_star
id|pdev
op_assign
id|to_platform_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|resource
op_star
id|mem
suffix:semicolon
r_int
id|irq
suffix:semicolon
id|mem
op_assign
id|platform_get_resource
c_func
(paren
id|pdev
comma
id|IORESOURCE_MEM
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|irq
op_assign
id|platform_get_irq
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
r_return
id|__locomo_probe
c_func
(paren
id|dev
comma
id|mem
comma
id|irq
)paren
suffix:semicolon
)brace
DECL|function|locomo_remove
r_static
r_int
id|locomo_remove
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|locomo
op_star
id|lchip
op_assign
id|dev_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lchip
)paren
(brace
id|__locomo_remove
c_func
(paren
id|lchip
)paren
suffix:semicolon
id|dev_set_drvdata
c_func
(paren
id|dev
comma
l_int|NULL
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev-&gt;saved_state
)paren
suffix:semicolon
id|dev-&gt;saved_state
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Not sure if this should be on the system bus or not yet.&n; *&t;We really want some way to register a system device at&n; *&t;the per-machine level, and then have this driver pick&n; *&t;up the registered devices.&n; */
DECL|variable|locomo_device_driver
r_static
r_struct
id|device_driver
id|locomo_device_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;locomo&quot;
comma
dot
id|bus
op_assign
op_amp
id|platform_bus_type
comma
dot
id|probe
op_assign
id|locomo_probe
comma
dot
id|remove
op_assign
id|locomo_remove
comma
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Get the parent device driver (us) structure&n; *&t;from a child function device&n; */
DECL|function|locomo_chip_driver
r_static
r_inline
r_struct
id|locomo
op_star
id|locomo_chip_driver
c_func
(paren
r_struct
id|locomo_dev
op_star
id|ldev
)paren
(brace
r_return
(paren
r_struct
id|locomo
op_star
)paren
id|dev_get_drvdata
c_func
(paren
id|ldev-&gt;dev.parent
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;LoCoMo &quot;Register Access Bus.&quot;&n; *&n; *&t;We model this as a regular bus type, and hang devices directly&n; *&t;off this.&n; */
DECL|function|locomo_match
r_static
r_int
id|locomo_match
c_func
(paren
r_struct
id|device
op_star
id|_dev
comma
r_struct
id|device_driver
op_star
id|_drv
)paren
(brace
r_struct
id|locomo_dev
op_star
id|dev
op_assign
id|LOCOMO_DEV
c_func
(paren
id|_dev
)paren
suffix:semicolon
r_struct
id|locomo_driver
op_star
id|drv
op_assign
id|LOCOMO_DRV
c_func
(paren
id|_drv
)paren
suffix:semicolon
r_return
id|dev-&gt;devid
op_eq
id|drv-&gt;devid
suffix:semicolon
)brace
DECL|function|locomo_bus_suspend
r_static
r_int
id|locomo_bus_suspend
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|state
)paren
(brace
r_struct
id|locomo_dev
op_star
id|ldev
op_assign
id|LOCOMO_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|locomo_driver
op_star
id|drv
op_assign
id|LOCOMO_DRV
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|drv
op_logical_and
id|drv-&gt;suspend
)paren
id|ret
op_assign
id|drv
op_member_access_from_pointer
id|suspend
c_func
(paren
id|ldev
comma
id|state
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|locomo_bus_resume
r_static
r_int
id|locomo_bus_resume
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|locomo_dev
op_star
id|ldev
op_assign
id|LOCOMO_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|locomo_driver
op_star
id|drv
op_assign
id|LOCOMO_DRV
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|drv
op_logical_and
id|drv-&gt;resume
)paren
id|ret
op_assign
id|drv
op_member_access_from_pointer
id|resume
c_func
(paren
id|ldev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|locomo_bus_probe
r_static
r_int
id|locomo_bus_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|locomo_dev
op_star
id|ldev
op_assign
id|LOCOMO_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|locomo_driver
op_star
id|drv
op_assign
id|LOCOMO_DRV
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|drv-&gt;probe
)paren
id|ret
op_assign
id|drv
op_member_access_from_pointer
id|probe
c_func
(paren
id|ldev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|locomo_bus_remove
r_static
r_int
id|locomo_bus_remove
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|locomo_dev
op_star
id|ldev
op_assign
id|LOCOMO_DEV
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|locomo_driver
op_star
id|drv
op_assign
id|LOCOMO_DRV
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|drv-&gt;remove
)paren
id|ret
op_assign
id|drv
op_member_access_from_pointer
id|remove
c_func
(paren
id|ldev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|locomo_bus_type
r_struct
id|bus_type
id|locomo_bus_type
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;locomo-bus&quot;
comma
dot
id|match
op_assign
id|locomo_match
comma
dot
id|suspend
op_assign
id|locomo_bus_suspend
comma
dot
id|resume
op_assign
id|locomo_bus_resume
comma
)brace
suffix:semicolon
DECL|function|locomo_driver_register
r_int
id|locomo_driver_register
c_func
(paren
r_struct
id|locomo_driver
op_star
id|driver
)paren
(brace
id|driver-&gt;drv.probe
op_assign
id|locomo_bus_probe
suffix:semicolon
id|driver-&gt;drv.remove
op_assign
id|locomo_bus_remove
suffix:semicolon
id|driver-&gt;drv.bus
op_assign
op_amp
id|locomo_bus_type
suffix:semicolon
r_return
id|driver_register
c_func
(paren
op_amp
id|driver-&gt;drv
)paren
suffix:semicolon
)brace
DECL|function|locomo_driver_unregister
r_void
id|locomo_driver_unregister
c_func
(paren
r_struct
id|locomo_driver
op_star
id|driver
)paren
(brace
id|driver_unregister
c_func
(paren
op_amp
id|driver-&gt;drv
)paren
suffix:semicolon
)brace
DECL|function|locomo_init
r_static
r_int
id|__init
id|locomo_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
op_assign
id|bus_register
c_func
(paren
op_amp
id|locomo_bus_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
id|driver_register
c_func
(paren
op_amp
id|locomo_device_driver
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|locomo_exit
r_static
r_void
id|__exit
id|locomo_exit
c_func
(paren
r_void
)paren
(brace
id|driver_unregister
c_func
(paren
op_amp
id|locomo_device_driver
)paren
suffix:semicolon
id|bus_unregister
c_func
(paren
op_amp
id|locomo_bus_type
)paren
suffix:semicolon
)brace
DECL|variable|locomo_init
id|module_init
c_func
(paren
id|locomo_init
)paren
suffix:semicolon
DECL|variable|locomo_exit
id|module_exit
c_func
(paren
id|locomo_exit
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Sharp LoCoMo core driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;John Lenz &lt;lenz@cs.wisc.edu&gt;&quot;
)paren
suffix:semicolon
DECL|variable|locomo_driver_register
id|EXPORT_SYMBOL
c_func
(paren
id|locomo_driver_register
)paren
suffix:semicolon
DECL|variable|locomo_driver_unregister
id|EXPORT_SYMBOL
c_func
(paren
id|locomo_driver_unregister
)paren
suffix:semicolon
eof
