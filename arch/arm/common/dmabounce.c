multiline_comment|/*&n; *  arch/arm/common/dmabounce.c&n; *&n; *  Special dma_{map/unmap/dma_sync}_* routines for systems that have&n; *  limited DMA windows. These functions utilize bounce buffers to&n; *  copy data to/from buffers located outside the DMA region. This&n; *  only works for systems in which DMA memory is at the bottom of&n; *  RAM and the remainder of memory is at the top an the DMA memory&n; *  can be marked as ZONE_DMA. Anything beyond that such as discontigous&n; *  DMA windows will require custom implementations that reserve memory&n; *  areas at early bootup.&n; *&n; *  Original version by Brad Parker (brad@heeltoe.com)&n; *  Re-written by Christopher Hoover &lt;ch@murgatroid.com&gt;&n; *  Made generic by Deepak Saxena &lt;dsaxena@plexity.net&gt;&n; *&n; *  Copyright (C) 2002 Hewlett Packard Company.&n; *  Copyright (C) 2004 MontaVista Software, Inc.&n; *&n; *  This program is free software; you can redistribute it and/or&n; *  modify it under the terms of the GNU General Public License&n; *  version 2 as published by the Free Software Foundation.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &lt;linux/dmapool.h&gt;
macro_line|#include &lt;linux/list.h&gt;
DECL|macro|DEBUG
macro_line|#undef DEBUG
DECL|macro|STATS
macro_line|#undef STATS
macro_line|#ifdef STATS
DECL|macro|DO_STATS
mdefine_line|#define DO_STATS(X) do { X ; } while (0)
macro_line|#else
DECL|macro|DO_STATS
mdefine_line|#define DO_STATS(X) do { } while (0)
macro_line|#endif
multiline_comment|/* ************************************************** */
DECL|struct|safe_buffer
r_struct
id|safe_buffer
(brace
DECL|member|node
r_struct
id|list_head
id|node
suffix:semicolon
multiline_comment|/* original request */
DECL|member|ptr
r_void
op_star
id|ptr
suffix:semicolon
DECL|member|size
r_int
id|size
suffix:semicolon
DECL|member|direction
r_int
id|direction
suffix:semicolon
multiline_comment|/* safe buffer info */
DECL|member|pool
r_struct
id|dma_pool
op_star
id|pool
suffix:semicolon
DECL|member|safe
r_void
op_star
id|safe
suffix:semicolon
DECL|member|safe_dma_addr
id|dma_addr_t
id|safe_dma_addr
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|dmabounce_device_info
r_struct
id|dmabounce_device_info
(brace
DECL|member|node
r_struct
id|list_head
id|node
suffix:semicolon
DECL|member|dev
r_struct
id|device
op_star
id|dev
suffix:semicolon
DECL|member|small_buffer_pool
r_struct
id|dma_pool
op_star
id|small_buffer_pool
suffix:semicolon
DECL|member|large_buffer_pool
r_struct
id|dma_pool
op_star
id|large_buffer_pool
suffix:semicolon
DECL|member|safe_buffers
r_struct
id|list_head
id|safe_buffers
suffix:semicolon
DECL|member|small_buffer_size
DECL|member|large_buffer_size
r_int
r_int
id|small_buffer_size
comma
id|large_buffer_size
suffix:semicolon
macro_line|#ifdef STATS
DECL|member|sbp_allocs
r_int
r_int
id|sbp_allocs
suffix:semicolon
DECL|member|lbp_allocs
r_int
r_int
id|lbp_allocs
suffix:semicolon
DECL|member|total_allocs
r_int
r_int
id|total_allocs
suffix:semicolon
DECL|member|map_op_count
r_int
r_int
id|map_op_count
suffix:semicolon
DECL|member|bounce_count
r_int
r_int
id|bounce_count
suffix:semicolon
macro_line|#endif
)brace
suffix:semicolon
r_static
id|LIST_HEAD
c_func
(paren
id|dmabounce_devs
)paren
suffix:semicolon
macro_line|#ifdef STATS
DECL|function|print_alloc_stats
r_static
r_void
id|print_alloc_stats
c_func
(paren
r_struct
id|dmabounce_device_info
op_star
id|device_info
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: dmabounce: sbp: %lu, lbp: %lu, other: %lu, total: %lu&bslash;n&quot;
comma
id|device_info-&gt;dev-&gt;bus_id
comma
id|device_info-&gt;sbp_allocs
comma
id|device_info-&gt;lbp_allocs
comma
id|device_info-&gt;total_allocs
op_minus
id|device_info-&gt;sbp_allocs
op_minus
id|device_info-&gt;lbp_allocs
comma
id|device_info-&gt;total_allocs
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* find the given device in the dmabounce device list */
r_static
r_inline
r_struct
id|dmabounce_device_info
op_star
DECL|function|find_dmabounce_dev
id|find_dmabounce_dev
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|list_head
op_star
id|entry
suffix:semicolon
id|list_for_each
c_func
(paren
id|entry
comma
op_amp
id|dmabounce_devs
)paren
(brace
r_struct
id|dmabounce_device_info
op_star
id|d
op_assign
id|list_entry
c_func
(paren
id|entry
comma
r_struct
id|dmabounce_device_info
comma
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;dev
op_eq
id|dev
)paren
r_return
id|d
suffix:semicolon
)brace
)brace
multiline_comment|/* allocate a &squot;safe&squot; buffer and keep track of it */
r_static
r_inline
r_struct
id|safe_buffer
op_star
DECL|function|alloc_safe_buffer
id|alloc_safe_buffer
c_func
(paren
r_struct
id|dmabounce_device_info
op_star
id|device_info
comma
r_void
op_star
id|ptr
comma
r_int
id|size
comma
r_enum
id|dma_data_direction
id|dir
)paren
(brace
r_struct
id|safe_buffer
op_star
id|buf
suffix:semicolon
r_struct
id|dma_pool
op_star
id|pool
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
id|device_info-&gt;dev
suffix:semicolon
r_void
op_star
id|safe
suffix:semicolon
id|dma_addr_t
id|safe_dma_addr
suffix:semicolon
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;%s(ptr=%p, size=%d, dir=%d)&bslash;n&quot;
comma
id|__func__
comma
id|ptr
comma
id|size
comma
id|dir
)paren
suffix:semicolon
id|DO_STATS
(paren
id|device_info-&gt;total_allocs
op_increment
)paren
suffix:semicolon
id|buf
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|safe_buffer
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
op_eq
l_int|0
)paren
(brace
id|dev_warn
c_func
(paren
id|dev
comma
l_string|&quot;%s: kmalloc failed&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|size
op_le
id|device_info-&gt;small_buffer_size
)paren
(brace
id|pool
op_assign
id|device_info-&gt;small_buffer_pool
suffix:semicolon
id|safe
op_assign
id|dma_pool_alloc
c_func
(paren
id|pool
comma
id|GFP_ATOMIC
comma
op_amp
id|safe_dma_addr
)paren
suffix:semicolon
id|DO_STATS
(paren
id|device_info-&gt;sbp_allocs
op_increment
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|size
op_le
id|device_info-&gt;large_buffer_size
)paren
(brace
id|pool
op_assign
id|device_info-&gt;large_buffer_pool
suffix:semicolon
id|safe
op_assign
id|dma_pool_alloc
c_func
(paren
id|pool
comma
id|GFP_ATOMIC
comma
op_amp
id|safe_dma_addr
)paren
suffix:semicolon
id|DO_STATS
(paren
id|device_info-&gt;lbp_allocs
op_increment
)paren
suffix:semicolon
)brace
r_else
(brace
id|pool
op_assign
l_int|0
suffix:semicolon
id|safe
op_assign
id|dma_alloc_coherent
c_func
(paren
id|dev
comma
id|size
comma
op_amp
id|safe_dma_addr
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|safe
op_eq
l_int|0
)paren
(brace
id|dev_warn
c_func
(paren
id|device_info-&gt;dev
comma
l_string|&quot;%s: could not alloc dma memory (size=%d)&bslash;n&quot;
comma
id|__func__
comma
id|size
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|buf
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef STATS
r_if
c_cond
(paren
id|device_info-&gt;total_allocs
op_mod
l_int|1000
op_eq
l_int|0
)paren
id|print_alloc_stats
c_func
(paren
id|device_info
)paren
suffix:semicolon
macro_line|#endif
id|buf-&gt;ptr
op_assign
id|ptr
suffix:semicolon
id|buf-&gt;size
op_assign
id|size
suffix:semicolon
id|buf-&gt;direction
op_assign
id|dir
suffix:semicolon
id|buf-&gt;pool
op_assign
id|pool
suffix:semicolon
id|buf-&gt;safe
op_assign
id|safe
suffix:semicolon
id|buf-&gt;safe_dma_addr
op_assign
id|safe_dma_addr
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|buf-&gt;node
comma
op_amp
id|device_info-&gt;safe_buffers
)paren
suffix:semicolon
r_return
id|buf
suffix:semicolon
)brace
multiline_comment|/* determine if a buffer is from our &quot;safe&quot; pool */
r_static
r_inline
r_struct
id|safe_buffer
op_star
DECL|function|find_safe_buffer
id|find_safe_buffer
c_func
(paren
r_struct
id|dmabounce_device_info
op_star
id|device_info
comma
id|dma_addr_t
id|safe_dma_addr
)paren
(brace
r_struct
id|list_head
op_star
id|entry
suffix:semicolon
id|list_for_each
c_func
(paren
id|entry
comma
op_amp
id|device_info-&gt;safe_buffers
)paren
(brace
r_struct
id|safe_buffer
op_star
id|b
op_assign
id|list_entry
c_func
(paren
id|entry
comma
r_struct
id|safe_buffer
comma
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|b-&gt;safe_dma_addr
op_eq
id|safe_dma_addr
)paren
r_return
id|b
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|free_safe_buffer
id|free_safe_buffer
c_func
(paren
r_struct
id|dmabounce_device_info
op_star
id|device_info
comma
r_struct
id|safe_buffer
op_star
id|buf
)paren
(brace
id|dev_dbg
c_func
(paren
id|device_info-&gt;dev
comma
l_string|&quot;%s(buf=%p)&bslash;n&quot;
comma
id|__func__
comma
id|buf
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|buf-&gt;node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;pool
)paren
id|dma_pool_free
c_func
(paren
id|buf-&gt;pool
comma
id|buf-&gt;safe
comma
id|buf-&gt;safe_dma_addr
)paren
suffix:semicolon
r_else
id|dma_free_coherent
c_func
(paren
id|device_info-&gt;dev
comma
id|buf-&gt;size
comma
id|buf-&gt;safe
comma
id|buf-&gt;safe_dma_addr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|buf
)paren
suffix:semicolon
)brace
multiline_comment|/* ************************************************** */
macro_line|#ifdef STATS
DECL|function|print_map_stats
r_static
r_void
id|print_map_stats
c_func
(paren
r_struct
id|dmabounce_device_info
op_star
id|device_info
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: dmabounce: map_op_count=%lu, bounce_count=%lu&bslash;n&quot;
comma
id|device_info-&gt;dev-&gt;bus_id
comma
id|device_info-&gt;map_op_count
comma
id|device_info-&gt;bounce_count
)paren
suffix:semicolon
)brace
macro_line|#endif
r_static
r_inline
id|dma_addr_t
DECL|function|map_single
id|map_single
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_void
op_star
id|ptr
comma
r_int
id|size
comma
r_enum
id|dma_data_direction
id|dir
)paren
(brace
id|dma_addr_t
id|dma_addr
suffix:semicolon
r_struct
id|dmabounce_device_info
op_star
id|device_info
op_assign
id|find_dmabounce_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device_info
)paren
id|DO_STATS
(paren
id|device_info-&gt;map_op_count
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;dma_mask
)paren
(brace
r_int
r_int
id|limit
suffix:semicolon
id|limit
op_assign
(paren
op_star
id|dev-&gt;dma_mask
op_plus
l_int|1
)paren
op_amp
op_complement
(paren
op_star
id|dev-&gt;dma_mask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|limit
op_logical_and
(paren
id|size
OG
id|limit
)paren
)paren
(brace
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;DMA mapping too big &quot;
l_string|&quot;(requested %#x mask %#Lx)&bslash;n&quot;
comma
id|size
comma
op_star
id|dev-&gt;dma_mask
)paren
suffix:semicolon
r_return
op_complement
l_int|0
suffix:semicolon
)brace
)brace
id|dma_addr
op_assign
id|virt_to_bus
c_func
(paren
id|ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device_info
op_logical_and
id|dma_needs_bounce
c_func
(paren
id|dev
comma
id|dma_addr
comma
id|size
)paren
)paren
(brace
r_struct
id|safe_buffer
op_star
id|buf
suffix:semicolon
id|buf
op_assign
id|alloc_safe_buffer
c_func
(paren
id|device_info
comma
id|ptr
comma
id|size
comma
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
op_eq
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;%s: unable to map unsafe buffer %p!&bslash;n&quot;
comma
id|__func__
comma
id|ptr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;%s: unsafe buffer %p (phy=%p) mapped to %p (phy=%p)&bslash;n&quot;
comma
id|__func__
comma
id|buf-&gt;ptr
comma
(paren
r_void
op_star
)paren
id|virt_to_bus
c_func
(paren
id|buf-&gt;ptr
)paren
comma
id|buf-&gt;safe
comma
(paren
r_void
op_star
)paren
id|buf-&gt;safe_dma_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dir
op_eq
id|DMA_TO_DEVICE
)paren
op_logical_or
(paren
id|dir
op_eq
id|DMA_BIDIRECTIONAL
)paren
)paren
(brace
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;%s: copy unsafe %p to safe %p, size %d&bslash;n&quot;
comma
id|__func__
comma
id|ptr
comma
id|buf-&gt;safe
comma
id|size
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buf-&gt;safe
comma
id|ptr
comma
id|size
)paren
suffix:semicolon
)brace
id|consistent_sync
c_func
(paren
id|buf-&gt;safe
comma
id|size
comma
id|dir
)paren
suffix:semicolon
id|dma_addr
op_assign
id|buf-&gt;safe_dma_addr
suffix:semicolon
)brace
r_else
(brace
id|consistent_sync
c_func
(paren
id|ptr
comma
id|size
comma
id|dir
)paren
suffix:semicolon
)brace
r_return
id|dma_addr
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|unmap_single
id|unmap_single
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|dma_addr_t
id|dma_addr
comma
r_int
id|size
comma
r_enum
id|dma_data_direction
id|dir
)paren
(brace
r_struct
id|dmabounce_device_info
op_star
id|device_info
op_assign
id|find_dmabounce_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|safe_buffer
op_star
id|buf
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t; * Trying to unmap an invalid mapping&n;&t; */
r_if
c_cond
(paren
id|dma_addr
op_eq
op_complement
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;Trying to unmap invalid mapping&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|device_info
)paren
id|buf
op_assign
id|find_safe_buffer
c_func
(paren
id|device_info
comma
id|dma_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
)paren
(brace
id|BUG_ON
c_func
(paren
id|buf-&gt;size
op_ne
id|size
)paren
suffix:semicolon
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;%s: unsafe buffer %p (phy=%p) mapped to %p (phy=%p)&bslash;n&quot;
comma
id|__func__
comma
id|buf-&gt;ptr
comma
(paren
r_void
op_star
)paren
id|virt_to_bus
c_func
(paren
id|buf-&gt;ptr
)paren
comma
id|buf-&gt;safe
comma
(paren
r_void
op_star
)paren
id|buf-&gt;safe_dma_addr
)paren
suffix:semicolon
id|DO_STATS
(paren
id|device_info-&gt;bounce_count
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dir
op_eq
id|DMA_FROM_DEVICE
)paren
op_logical_or
(paren
id|dir
op_eq
id|DMA_BIDIRECTIONAL
)paren
)paren
(brace
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;%s: copy back safe %p to unsafe %p size %d&bslash;n&quot;
comma
id|__func__
comma
id|buf-&gt;safe
comma
id|buf-&gt;ptr
comma
id|size
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buf-&gt;ptr
comma
id|buf-&gt;safe
comma
id|size
)paren
suffix:semicolon
)brace
id|free_safe_buffer
c_func
(paren
id|device_info
comma
id|buf
)paren
suffix:semicolon
)brace
)brace
r_static
r_inline
r_void
DECL|function|sync_single
id|sync_single
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|dma_addr_t
id|dma_addr
comma
r_int
id|size
comma
r_enum
id|dma_data_direction
id|dir
)paren
(brace
r_struct
id|dmabounce_device_info
op_star
id|device_info
op_assign
id|find_dmabounce_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|safe_buffer
op_star
id|buf
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|device_info
)paren
id|buf
op_assign
id|find_safe_buffer
c_func
(paren
id|device_info
comma
id|dma_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
)paren
(brace
multiline_comment|/*&n;&t;&t; * Both of these checks from original code need to be&n;&t;&t; * commented out b/c some drivers rely on the following:&n;&t;&t; *&n;&t;&t; * 1) Drivers may map a large chunk of memory into DMA space&n;&t;&t; *    but only sync a small portion of it. Good example is&n;&t;&t; *    allocating a large buffer, mapping it, and then&n;&t;&t; *    breaking it up into small descriptors. No point&n;&t;&t; *    in syncing the whole buffer if you only have to&n;&t;&t; *    touch one descriptor.&n;&t;&t; *&n;&t;&t; * 2) Buffers that are mapped as DMA_BIDIRECTIONAL are&n;&t;&t; *    usually only synced in one dir at a time.&n;&t;&t; *&n;&t;&t; * See drivers/net/eepro100.c for examples of both cases.&n;&t;&t; *&n;&t;&t; * -ds&n;&t;&t; *&n;&t;&t; * BUG_ON(buf-&gt;size != size);&n;&t;&t; * BUG_ON(buf-&gt;direction != dir);&n;&t;&t; */
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;%s: unsafe buffer %p (phy=%p) mapped to %p (phy=%p)&bslash;n&quot;
comma
id|__func__
comma
id|buf-&gt;ptr
comma
(paren
r_void
op_star
)paren
id|virt_to_bus
c_func
(paren
id|buf-&gt;ptr
)paren
comma
id|buf-&gt;safe
comma
(paren
r_void
op_star
)paren
id|buf-&gt;safe_dma_addr
)paren
suffix:semicolon
id|DO_STATS
(paren
id|device_info-&gt;bounce_count
op_increment
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dir
)paren
(brace
r_case
id|DMA_FROM_DEVICE
suffix:colon
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;%s: copy back safe %p to unsafe %p size %d&bslash;n&quot;
comma
id|__func__
comma
id|buf-&gt;safe
comma
id|buf-&gt;ptr
comma
id|size
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buf-&gt;ptr
comma
id|buf-&gt;safe
comma
id|size
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMA_TO_DEVICE
suffix:colon
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;%s: copy out unsafe %p to safe %p, size %d&bslash;n&quot;
comma
id|__func__
comma
id|buf-&gt;ptr
comma
id|buf-&gt;safe
comma
id|size
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buf-&gt;safe
comma
id|buf-&gt;ptr
comma
id|size
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMA_BIDIRECTIONAL
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* is this allowed?  what does it mean? */
r_default
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|consistent_sync
c_func
(paren
id|buf-&gt;safe
comma
id|size
comma
id|dir
)paren
suffix:semicolon
)brace
r_else
(brace
id|consistent_sync
c_func
(paren
id|bus_to_virt
c_func
(paren
id|dma_addr
)paren
comma
id|size
comma
id|dir
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* ************************************************** */
multiline_comment|/*&n; * see if a buffer address is in an &squot;unsafe&squot; range.  if it is&n; * allocate a &squot;safe&squot; buffer and copy the unsafe buffer into it.&n; * substitute the safe buffer for the unsafe one.&n; * (basically move the buffer from an unsafe area to a safe one)&n; */
id|dma_addr_t
DECL|function|dma_map_single
id|dma_map_single
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_void
op_star
id|ptr
comma
r_int
id|size
comma
r_enum
id|dma_data_direction
id|dir
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|dma_addr_t
id|dma_addr
suffix:semicolon
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;%s(ptr=%p,size=%d,dir=%x)&bslash;n&quot;
comma
id|__func__
comma
id|ptr
comma
id|size
comma
id|dir
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|dir
op_eq
id|DMA_NONE
)paren
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|dma_addr
op_assign
id|map_single
c_func
(paren
id|dev
comma
id|ptr
comma
id|size
comma
id|dir
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|dma_addr
suffix:semicolon
)brace
multiline_comment|/*&n; * see if a mapped address was really a &quot;safe&quot; buffer and if so, copy&n; * the data from the safe buffer back to the unsafe buffer and free up&n; * the safe buffer.  (basically return things back to the way they&n; * should be)&n; */
r_void
DECL|function|dma_unmap_single
id|dma_unmap_single
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|dma_addr_t
id|dma_addr
comma
r_int
id|size
comma
r_enum
id|dma_data_direction
id|dir
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;%s(ptr=%p,size=%d,dir=%x)&bslash;n&quot;
comma
id|__func__
comma
(paren
r_void
op_star
)paren
id|dma_addr
comma
id|size
comma
id|dir
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|dir
op_eq
id|DMA_NONE
)paren
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|unmap_single
c_func
(paren
id|dev
comma
id|dma_addr
comma
id|size
comma
id|dir
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_int
DECL|function|dma_map_sg
id|dma_map_sg
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
id|nents
comma
r_enum
id|dma_data_direction
id|dir
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;%s(sg=%p,nents=%d,dir=%x)&bslash;n&quot;
comma
id|__func__
comma
id|sg
comma
id|nents
comma
id|dir
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|dir
op_eq
id|DMA_NONE
)paren
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nents
suffix:semicolon
id|i
op_increment
comma
id|sg
op_increment
)paren
(brace
r_struct
id|page
op_star
id|page
op_assign
id|sg-&gt;page
suffix:semicolon
r_int
r_int
id|offset
op_assign
id|sg-&gt;offset
suffix:semicolon
r_int
r_int
id|length
op_assign
id|sg-&gt;length
suffix:semicolon
r_void
op_star
id|ptr
op_assign
id|page_address
c_func
(paren
id|page
)paren
op_plus
id|offset
suffix:semicolon
id|sg-&gt;dma_address
op_assign
id|map_single
c_func
(paren
id|dev
comma
id|ptr
comma
id|length
comma
id|dir
)paren
suffix:semicolon
)brace
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|nents
suffix:semicolon
)brace
r_void
DECL|function|dma_unmap_sg
id|dma_unmap_sg
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
id|nents
comma
r_enum
id|dma_data_direction
id|dir
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;%s(sg=%p,nents=%d,dir=%x)&bslash;n&quot;
comma
id|__func__
comma
id|sg
comma
id|nents
comma
id|dir
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|dir
op_eq
id|DMA_NONE
)paren
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nents
suffix:semicolon
id|i
op_increment
comma
id|sg
op_increment
)paren
(brace
id|dma_addr_t
id|dma_addr
op_assign
id|sg-&gt;dma_address
suffix:semicolon
r_int
r_int
id|length
op_assign
id|sg-&gt;length
suffix:semicolon
id|unmap_single
c_func
(paren
id|dev
comma
id|dma_addr
comma
id|length
comma
id|dir
)paren
suffix:semicolon
)brace
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_void
DECL|function|dma_sync_single_for_cpu
id|dma_sync_single_for_cpu
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|dma_addr_t
id|dma_addr
comma
r_int
id|size
comma
r_enum
id|dma_data_direction
id|dir
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;%s(ptr=%p,size=%d,dir=%x)&bslash;n&quot;
comma
id|__func__
comma
(paren
r_void
op_star
)paren
id|dma_addr
comma
id|size
comma
id|dir
)paren
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|sync_single
c_func
(paren
id|dev
comma
id|dma_addr
comma
id|size
comma
id|dir
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_void
DECL|function|dma_sync_single_for_device
id|dma_sync_single_for_device
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|dma_addr_t
id|dma_addr
comma
r_int
id|size
comma
r_enum
id|dma_data_direction
id|dir
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;%s(ptr=%p,size=%d,dir=%x)&bslash;n&quot;
comma
id|__func__
comma
(paren
r_void
op_star
)paren
id|dma_addr
comma
id|size
comma
id|dir
)paren
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|sync_single
c_func
(paren
id|dev
comma
id|dma_addr
comma
id|size
comma
id|dir
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_void
DECL|function|dma_sync_sg_for_cpu
id|dma_sync_sg_for_cpu
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
id|nents
comma
r_enum
id|dma_data_direction
id|dir
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;%s(sg=%p,nents=%d,dir=%x)&bslash;n&quot;
comma
id|__func__
comma
id|sg
comma
id|nents
comma
id|dir
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|dir
op_eq
id|DMA_NONE
)paren
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nents
suffix:semicolon
id|i
op_increment
comma
id|sg
op_increment
)paren
(brace
id|dma_addr_t
id|dma_addr
op_assign
id|sg-&gt;dma_address
suffix:semicolon
r_int
r_int
id|length
op_assign
id|sg-&gt;length
suffix:semicolon
id|sync_single
c_func
(paren
id|dev
comma
id|dma_addr
comma
id|length
comma
id|dir
)paren
suffix:semicolon
)brace
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_void
DECL|function|dma_sync_sg_for_device
id|dma_sync_sg_for_device
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
id|nents
comma
r_enum
id|dma_data_direction
id|dir
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;%s(sg=%p,nents=%d,dir=%x)&bslash;n&quot;
comma
id|__func__
comma
id|sg
comma
id|nents
comma
id|dir
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|dir
op_eq
id|DMA_NONE
)paren
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nents
suffix:semicolon
id|i
op_increment
comma
id|sg
op_increment
)paren
(brace
id|dma_addr_t
id|dma_addr
op_assign
id|sg-&gt;dma_address
suffix:semicolon
r_int
r_int
id|length
op_assign
id|sg-&gt;length
suffix:semicolon
id|sync_single
c_func
(paren
id|dev
comma
id|dma_addr
comma
id|length
comma
id|dir
)paren
suffix:semicolon
)brace
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_int
DECL|function|dmabounce_register_dev
id|dmabounce_register_dev
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
r_int
id|small_buffer_size
comma
r_int
r_int
id|large_buffer_size
)paren
(brace
r_struct
id|dmabounce_device_info
op_star
id|device_info
suffix:semicolon
id|device_info
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dmabounce_device_info
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device_info
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Could not allocated dmabounce_device_info for %s&quot;
comma
id|dev-&gt;bus_id
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|device_info-&gt;small_buffer_pool
op_assign
id|dma_pool_create
c_func
(paren
l_string|&quot;small_dmabounce_pool&quot;
comma
id|dev
comma
id|small_buffer_size
comma
l_int|0
multiline_comment|/* byte alignment */
comma
l_int|0
multiline_comment|/* no page-crossing issues */
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device_info-&gt;small_buffer_pool
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dmabounce: could not allocate small DMA pool for %s&bslash;n&quot;
comma
id|dev-&gt;bus_id
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|device_info
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|large_buffer_size
)paren
(brace
id|device_info-&gt;large_buffer_pool
op_assign
id|dma_pool_create
c_func
(paren
l_string|&quot;large_dmabounce_pool&quot;
comma
id|dev
comma
id|large_buffer_size
comma
l_int|0
multiline_comment|/* byte alignment */
comma
l_int|0
multiline_comment|/* no page-crossing issues */
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device_info-&gt;large_buffer_pool
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dmabounce: could not allocate large DMA pool for %s&bslash;n&quot;
comma
id|dev-&gt;bus_id
)paren
suffix:semicolon
id|dma_pool_destroy
c_func
(paren
id|device_info-&gt;small_buffer_pool
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
id|device_info-&gt;dev
op_assign
id|dev
suffix:semicolon
id|device_info-&gt;small_buffer_size
op_assign
id|small_buffer_size
suffix:semicolon
id|device_info-&gt;large_buffer_size
op_assign
id|large_buffer_size
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|device_info-&gt;safe_buffers
)paren
suffix:semicolon
macro_line|#ifdef STATS
id|device_info-&gt;sbp_allocs
op_assign
l_int|0
suffix:semicolon
id|device_info-&gt;lbp_allocs
op_assign
l_int|0
suffix:semicolon
id|device_info-&gt;total_allocs
op_assign
l_int|0
suffix:semicolon
id|device_info-&gt;map_op_count
op_assign
l_int|0
suffix:semicolon
id|device_info-&gt;bounce_count
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|list_add
c_func
(paren
op_amp
id|device_info-&gt;node
comma
op_amp
id|dmabounce_devs
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;dmabounce: registered device %s on %s bus&bslash;n&quot;
comma
id|dev-&gt;bus_id
comma
id|dev-&gt;bus-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|dmabounce_unregister_dev
id|dmabounce_unregister_dev
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|dmabounce_device_info
op_star
id|device_info
op_assign
id|find_dmabounce_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device_info
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Never registered with dmabounce but attempting&quot;
"&bslash;"
l_string|&quot;to unregister!&bslash;n&quot;
comma
id|dev-&gt;bus_id
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|device_info-&gt;safe_buffers
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Removing from dmabounce with pending buffers!&bslash;n&quot;
comma
id|dev-&gt;bus_id
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|device_info-&gt;small_buffer_pool
)paren
id|dma_pool_destroy
c_func
(paren
id|device_info-&gt;small_buffer_pool
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device_info-&gt;large_buffer_pool
)paren
id|dma_pool_destroy
c_func
(paren
id|device_info-&gt;large_buffer_pool
)paren
suffix:semicolon
macro_line|#ifdef STATS
id|print_alloc_stats
c_func
(paren
id|device_info
)paren
suffix:semicolon
id|print_map_stats
c_func
(paren
id|device_info
)paren
suffix:semicolon
macro_line|#endif
id|list_del
c_func
(paren
op_amp
id|device_info-&gt;node
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|device_info
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;dmabounce: device %s on %s bus unregistered&bslash;n&quot;
comma
id|dev-&gt;bus_id
comma
id|dev-&gt;bus-&gt;name
)paren
suffix:semicolon
)brace
DECL|variable|dma_map_single
id|EXPORT_SYMBOL
c_func
(paren
id|dma_map_single
)paren
suffix:semicolon
DECL|variable|dma_unmap_single
id|EXPORT_SYMBOL
c_func
(paren
id|dma_unmap_single
)paren
suffix:semicolon
DECL|variable|dma_map_sg
id|EXPORT_SYMBOL
c_func
(paren
id|dma_map_sg
)paren
suffix:semicolon
DECL|variable|dma_unmap_sg
id|EXPORT_SYMBOL
c_func
(paren
id|dma_unmap_sg
)paren
suffix:semicolon
DECL|variable|dma_sync_single
id|EXPORT_SYMBOL
c_func
(paren
id|dma_sync_single
)paren
suffix:semicolon
DECL|variable|dma_sync_sg
id|EXPORT_SYMBOL
c_func
(paren
id|dma_sync_sg
)paren
suffix:semicolon
DECL|variable|dmabounce_register_dev
id|EXPORT_SYMBOL
c_func
(paren
id|dmabounce_register_dev
)paren
suffix:semicolon
DECL|variable|dmabounce_unregister_dev
id|EXPORT_SYMBOL
c_func
(paren
id|dmabounce_unregister_dev
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Christopher Hoover &lt;ch@hpl.hp.com&gt;, Deepak Saxena &lt;dsaxena@plexity.net&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Special dma_{map/unmap/dma_sync}_* routines for systems with limited DMA windows&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
