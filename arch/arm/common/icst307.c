multiline_comment|/*&n; *  linux/arch/arm/common/icst307.c&n; *&n; *  Copyright (C) 2003 Deep Blue Solutions, Ltd, All Rights Reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; *  Support functions for calculating clocks/divisors for the ICST307&n; *  clock generators.  See http://www.icst.com/ for more information&n; *  on these devices.&n; *&n; *  This is an almost identical implementation to the ICST525 clock generator.&n; *  The s2div and idx2s files are different&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/hardware/icst307.h&gt;
multiline_comment|/*&n; * Divisors for each OD setting.&n; */
DECL|variable|s2div
r_static
r_int
r_char
id|s2div
(braket
l_int|8
)braket
op_assign
(brace
l_int|10
comma
l_int|2
comma
l_int|8
comma
l_int|4
comma
l_int|5
comma
l_int|7
comma
l_int|3
comma
l_int|6
)brace
suffix:semicolon
DECL|function|icst307_khz
r_int
r_int
id|icst307_khz
c_func
(paren
r_const
r_struct
id|icst307_params
op_star
id|p
comma
r_struct
id|icst307_vco
id|vco
)paren
(brace
r_return
id|p-&gt;ref
op_star
l_int|2
op_star
(paren
id|vco.v
op_plus
l_int|8
)paren
op_div
(paren
(paren
id|vco.r
op_plus
l_int|2
)paren
op_star
id|s2div
(braket
id|vco.s
)braket
)paren
suffix:semicolon
)brace
DECL|variable|icst307_khz
id|EXPORT_SYMBOL
c_func
(paren
id|icst307_khz
)paren
suffix:semicolon
multiline_comment|/*&n; * Ascending divisor S values.&n; */
DECL|variable|idx2s
r_static
r_int
r_char
id|idx2s
(braket
l_int|8
)braket
op_assign
(brace
l_int|1
comma
l_int|6
comma
l_int|3
comma
l_int|4
comma
l_int|7
comma
l_int|5
comma
l_int|2
comma
l_int|0
)brace
suffix:semicolon
r_struct
id|icst307_vco
DECL|function|icst307_khz_to_vco
id|icst307_khz_to_vco
c_func
(paren
r_const
r_struct
id|icst307_params
op_star
id|p
comma
r_int
r_int
id|freq
)paren
(brace
r_struct
id|icst307_vco
id|vco
op_assign
(brace
dot
id|s
op_assign
l_int|1
comma
dot
id|v
op_assign
id|p-&gt;vd_max
comma
dot
id|r
op_assign
id|p-&gt;rd_max
)brace
suffix:semicolon
r_int
r_int
id|f
suffix:semicolon
r_int
r_int
id|i
op_assign
l_int|0
comma
id|rd
comma
id|best
op_assign
(paren
r_int
r_int
)paren
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * First, find the PLL output divisor such&n;&t; * that the PLL output is within spec.&n;&t; */
r_do
(brace
id|f
op_assign
id|freq
op_star
id|s2div
(braket
id|idx2s
(braket
id|i
)braket
)braket
suffix:semicolon
multiline_comment|/*&n;&t;&t; * f must be between 6MHz and 200MHz (3.3 or 5V)&n;&t;&t; */
r_if
c_cond
(paren
id|f
OG
l_int|6000
op_logical_and
id|f
op_le
id|p-&gt;vco_max
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|idx2s
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
id|ARRAY_SIZE
c_func
(paren
id|idx2s
)paren
)paren
r_return
id|vco
suffix:semicolon
id|vco.s
op_assign
id|idx2s
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/*&n;&t; * Now find the closest divisor combination&n;&t; * which gives a PLL output of &squot;f&squot;.&n;&t; */
r_for
c_loop
(paren
id|rd
op_assign
id|p-&gt;rd_min
suffix:semicolon
id|rd
op_le
id|p-&gt;rd_max
suffix:semicolon
id|rd
op_increment
)paren
(brace
r_int
r_int
id|fref_div
comma
id|f_pll
suffix:semicolon
r_int
r_int
id|vd
suffix:semicolon
r_int
id|f_diff
suffix:semicolon
id|fref_div
op_assign
(paren
l_int|2
op_star
id|p-&gt;ref
)paren
op_div
id|rd
suffix:semicolon
id|vd
op_assign
(paren
id|f
op_plus
id|fref_div
op_div
l_int|2
)paren
op_div
id|fref_div
suffix:semicolon
r_if
c_cond
(paren
id|vd
template_param
id|p-&gt;vd_max
)paren
r_continue
suffix:semicolon
id|f_pll
op_assign
id|fref_div
op_star
id|vd
suffix:semicolon
id|f_diff
op_assign
id|f_pll
op_minus
id|f
suffix:semicolon
r_if
c_cond
(paren
id|f_diff
OL
l_int|0
)paren
id|f_diff
op_assign
op_minus
id|f_diff
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|f_diff
OL
id|best
)paren
(brace
id|vco.v
op_assign
id|vd
op_minus
l_int|8
suffix:semicolon
id|vco.r
op_assign
id|rd
op_minus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|f_diff
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|best
op_assign
id|f_diff
suffix:semicolon
)brace
)brace
r_return
id|vco
suffix:semicolon
)brace
DECL|variable|icst307_khz_to_vco
id|EXPORT_SYMBOL
c_func
(paren
id|icst307_khz_to_vco
)paren
suffix:semicolon
r_struct
id|icst307_vco
DECL|function|icst307_ps_to_vco
id|icst307_ps_to_vco
c_func
(paren
r_const
r_struct
id|icst307_params
op_star
id|p
comma
r_int
r_int
id|period
)paren
(brace
r_struct
id|icst307_vco
id|vco
op_assign
(brace
dot
id|s
op_assign
l_int|1
comma
dot
id|v
op_assign
id|p-&gt;vd_max
comma
dot
id|r
op_assign
id|p-&gt;rd_max
)brace
suffix:semicolon
r_int
r_int
id|f
comma
id|ps
suffix:semicolon
r_int
r_int
id|i
op_assign
l_int|0
comma
id|rd
comma
id|best
op_assign
(paren
r_int
r_int
)paren
op_minus
l_int|1
suffix:semicolon
id|ps
op_assign
l_int|1000000000UL
op_div
id|p-&gt;vco_max
suffix:semicolon
multiline_comment|/*&n;&t; * First, find the PLL output divisor such&n;&t; * that the PLL output is within spec.&n;&t; */
r_do
(brace
id|f
op_assign
id|period
op_div
id|s2div
(braket
id|idx2s
(braket
id|i
)braket
)braket
suffix:semicolon
multiline_comment|/*&n;&t;&t; * f must be between 6MHz and 200MHz (3.3 or 5V)&n;&t;&t; */
r_if
c_cond
(paren
id|f
op_ge
id|ps
op_logical_and
id|f
OL
l_int|1000000000UL
op_div
l_int|6000
op_plus
l_int|1
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|idx2s
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
id|ARRAY_SIZE
c_func
(paren
id|idx2s
)paren
)paren
r_return
id|vco
suffix:semicolon
id|vco.s
op_assign
id|idx2s
(braket
id|i
)braket
suffix:semicolon
id|ps
op_assign
l_int|500000000UL
op_div
id|p-&gt;ref
suffix:semicolon
multiline_comment|/*&n;&t; * Now find the closest divisor combination&n;&t; * which gives a PLL output of &squot;f&squot;.&n;&t; */
r_for
c_loop
(paren
id|rd
op_assign
id|p-&gt;rd_min
suffix:semicolon
id|rd
op_le
id|p-&gt;rd_max
suffix:semicolon
id|rd
op_increment
)paren
(brace
r_int
r_int
id|f_in_div
comma
id|f_pll
suffix:semicolon
r_int
r_int
id|vd
suffix:semicolon
r_int
id|f_diff
suffix:semicolon
id|f_in_div
op_assign
id|ps
op_star
id|rd
suffix:semicolon
id|vd
op_assign
(paren
id|f_in_div
op_plus
id|f
op_div
l_int|2
)paren
op_div
id|f
suffix:semicolon
r_if
c_cond
(paren
id|vd
template_param
id|p-&gt;vd_max
)paren
r_continue
suffix:semicolon
id|f_pll
op_assign
(paren
id|f_in_div
op_plus
id|vd
op_div
l_int|2
)paren
op_div
id|vd
suffix:semicolon
id|f_diff
op_assign
id|f_pll
op_minus
id|f
suffix:semicolon
r_if
c_cond
(paren
id|f_diff
OL
l_int|0
)paren
id|f_diff
op_assign
op_minus
id|f_diff
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|f_diff
OL
id|best
)paren
(brace
id|vco.v
op_assign
id|vd
op_minus
l_int|8
suffix:semicolon
id|vco.r
op_assign
id|rd
op_minus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|f_diff
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|best
op_assign
id|f_diff
suffix:semicolon
)brace
)brace
r_return
id|vco
suffix:semicolon
)brace
DECL|variable|icst307_ps_to_vco
id|EXPORT_SYMBOL
c_func
(paren
id|icst307_ps_to_vco
)paren
suffix:semicolon
eof
