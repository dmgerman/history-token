multiline_comment|/*&n; * linux/arch/arm/mach-omap/leds-osk.c&n; *&n; * LED driver for OSK, and optionally Mistral QVGA, boards&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/workqueue.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/leds.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/arch/gpio.h&gt;
macro_line|#include &lt;asm/arch/tps65010.h&gt;
macro_line|#include &quot;leds.h&quot;
DECL|macro|LED_STATE_ENABLED
mdefine_line|#define LED_STATE_ENABLED&t;(1 &lt;&lt; 0)
DECL|macro|LED_STATE_CLAIMED
mdefine_line|#define LED_STATE_CLAIMED&t;(1 &lt;&lt; 1)
DECL|variable|led_state
r_static
id|u8
id|led_state
suffix:semicolon
DECL|macro|GREEN_LED
mdefine_line|#define&t;GREEN_LED&t;&t;(1 &lt;&lt; 0)&t;/* TPS65010 LED1 */
DECL|macro|AMBER_LED
mdefine_line|#define&t;AMBER_LED&t;&t;(1 &lt;&lt; 1)&t;/* TPS65010 LED2 */
DECL|macro|RED_LED
mdefine_line|#define&t;RED_LED&t;&t;&t;(1 &lt;&lt; 2)&t;/* TPS65010 GPIO2 */
DECL|macro|TIMER_LED
mdefine_line|#define&t;TIMER_LED&t;&t;(1 &lt;&lt; 3)&t;/* Mistral board */
DECL|macro|IDLE_LED
mdefine_line|#define&t;IDLE_LED&t;&t;(1 &lt;&lt; 4)&t;/* Mistral board */
DECL|variable|hw_led_state
r_static
id|u8
id|hw_led_state
suffix:semicolon
multiline_comment|/* TPS65010 leds are changed using i2c -- from a task context.&n; * Using one of these for the &quot;idle&quot; LED would be impractical...&n; */
DECL|macro|TPS_LEDS
mdefine_line|#define&t;TPS_LEDS&t;(GREEN_LED | RED_LED | AMBER_LED)
DECL|variable|tps_leds_change
r_static
id|u8
id|tps_leds_change
suffix:semicolon
DECL|function|tps_work
r_static
r_void
id|tps_work
c_func
(paren
r_void
op_star
id|unused
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|u8
id|leds
suffix:semicolon
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
id|leds
op_assign
id|tps_leds_change
suffix:semicolon
id|tps_leds_change
op_assign
l_int|0
suffix:semicolon
id|local_irq_enable
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|leds
)paren
r_break
suffix:semicolon
multiline_comment|/* careful:  the set_led() value is on/off/blink */
r_if
c_cond
(paren
id|leds
op_amp
id|GREEN_LED
)paren
id|tps65010_set_led
c_func
(paren
id|LED1
comma
op_logical_neg
op_logical_neg
(paren
id|hw_led_state
op_amp
id|GREEN_LED
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|leds
op_amp
id|AMBER_LED
)paren
id|tps65010_set_led
c_func
(paren
id|LED2
comma
op_logical_neg
op_logical_neg
(paren
id|hw_led_state
op_amp
id|AMBER_LED
)paren
)paren
suffix:semicolon
multiline_comment|/* the gpio led doesn&squot;t have that issue */
r_if
c_cond
(paren
id|leds
op_amp
id|RED_LED
)paren
id|tps65010_set_gpio_out_value
c_func
(paren
id|GPIO2
comma
op_logical_neg
(paren
id|hw_led_state
op_amp
id|RED_LED
)paren
)paren
suffix:semicolon
)brace
)brace
r_static
id|DECLARE_WORK
c_func
(paren
id|work
comma
id|tps_work
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#ifdef&t;CONFIG_FB_OMAP
multiline_comment|/* For now, all system indicators require the Mistral board, since that&n; * LED can be manipulated without a task context.  This LED is either red,&n; * or green, but not both; it can&squot;t give the full &quot;disco led&quot; effect.&n; */
DECL|macro|GPIO_LED_RED
mdefine_line|#define GPIO_LED_RED&t;&t;3
DECL|macro|GPIO_LED_GREEN
mdefine_line|#define GPIO_LED_GREEN&t;&t;OMAP_MPUIO(4)
DECL|function|mistral_setled
r_static
r_void
id|mistral_setled
c_func
(paren
r_void
)paren
(brace
r_int
id|red
op_assign
l_int|0
suffix:semicolon
r_int
id|green
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hw_led_state
op_amp
id|TIMER_LED
)paren
id|red
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hw_led_state
op_amp
id|IDLE_LED
)paren
id|green
op_assign
l_int|1
suffix:semicolon
singleline_comment|// else both sides are disabled
id|omap_set_gpio_dataout
c_func
(paren
id|GPIO_LED_GREEN
comma
id|green
)paren
suffix:semicolon
id|omap_set_gpio_dataout
c_func
(paren
id|GPIO_LED_RED
comma
id|red
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|osk_leds_event
r_void
id|osk_leds_event
c_func
(paren
id|led_event_t
id|evt
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|u16
id|leds
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|led_state
op_amp
id|LED_STATE_ENABLED
)paren
op_logical_and
id|evt
op_ne
id|led_start
)paren
r_goto
id|done
suffix:semicolon
id|leds
op_assign
id|hw_led_state
suffix:semicolon
r_switch
c_cond
(paren
id|evt
)paren
(brace
r_case
id|led_start
suffix:colon
id|led_state
op_or_assign
id|LED_STATE_ENABLED
suffix:semicolon
id|hw_led_state
op_assign
l_int|0
suffix:semicolon
id|leds
op_assign
op_complement
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|led_halted
suffix:colon
r_case
id|led_stop
suffix:colon
id|led_state
op_and_assign
op_complement
id|LED_STATE_ENABLED
suffix:semicolon
id|hw_led_state
op_assign
l_int|0
suffix:semicolon
singleline_comment|// NOTE:  work may still be pending!!
r_break
suffix:semicolon
r_case
id|led_claim
suffix:colon
id|led_state
op_or_assign
id|LED_STATE_CLAIMED
suffix:semicolon
id|hw_led_state
op_assign
l_int|0
suffix:semicolon
id|leds
op_assign
op_complement
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|led_release
suffix:colon
id|led_state
op_and_assign
op_complement
id|LED_STATE_CLAIMED
suffix:semicolon
id|hw_led_state
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef&t;CONFIG_FB_OMAP
macro_line|#ifdef CONFIG_LEDS_TIMER
r_case
id|led_timer
suffix:colon
id|hw_led_state
op_xor_assign
id|TIMER_LED
suffix:semicolon
id|mistral_setled
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_LEDS_CPU
r_case
id|led_idle_start
suffix:colon
id|hw_led_state
op_or_assign
id|IDLE_LED
suffix:semicolon
id|mistral_setled
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|led_idle_end
suffix:colon
id|hw_led_state
op_and_assign
op_complement
id|IDLE_LED
suffix:semicolon
id|mistral_setled
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#endif&t;/* CONFIG_FB_OMAP */
multiline_comment|/* &quot;green&quot; == tps LED1 (leftmost, normally power-good)&n;&t; * works only with DC adapter, not on battery power!&n;&t; */
r_case
id|led_green_on
suffix:colon
r_if
c_cond
(paren
id|led_state
op_amp
id|LED_STATE_CLAIMED
)paren
id|hw_led_state
op_or_assign
id|GREEN_LED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|led_green_off
suffix:colon
r_if
c_cond
(paren
id|led_state
op_amp
id|LED_STATE_CLAIMED
)paren
id|hw_led_state
op_and_assign
op_complement
id|GREEN_LED
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* &quot;amber&quot; == tps LED2 (middle) */
r_case
id|led_amber_on
suffix:colon
r_if
c_cond
(paren
id|led_state
op_amp
id|LED_STATE_CLAIMED
)paren
id|hw_led_state
op_or_assign
id|AMBER_LED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|led_amber_off
suffix:colon
r_if
c_cond
(paren
id|led_state
op_amp
id|LED_STATE_CLAIMED
)paren
id|hw_led_state
op_and_assign
op_complement
id|AMBER_LED
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* &quot;red&quot; == LED on tps gpio3 (rightmost) */
r_case
id|led_red_on
suffix:colon
r_if
c_cond
(paren
id|led_state
op_amp
id|LED_STATE_CLAIMED
)paren
id|hw_led_state
op_or_assign
id|RED_LED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|led_red_off
suffix:colon
r_if
c_cond
(paren
id|led_state
op_amp
id|LED_STATE_CLAIMED
)paren
id|hw_led_state
op_and_assign
op_complement
id|RED_LED
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|leds
op_xor_assign
id|hw_led_state
suffix:semicolon
id|leds
op_and_assign
id|TPS_LEDS
suffix:semicolon
r_if
c_cond
(paren
id|leds
op_logical_and
(paren
id|led_state
op_amp
id|LED_STATE_CLAIMED
)paren
)paren
(brace
id|tps_leds_change
op_or_assign
id|leds
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|work
)paren
suffix:semicolon
)brace
id|done
suffix:colon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
eof
