multiline_comment|/*&n; * linux/arch/arm/mach-omap/irq.c&n; *&n; * Interrupt handler for all OMAP boards&n; *&n; * Copyright (C) 2004 Nokia Corporation&n; * Written by Tony Lindgren &lt;tony@atomide.com&gt;&n; * Major cleanups by Juha Yrj&#xfffd;l&#xfffd; &lt;juha.yrjola@nokia.com&gt;&n; *&n; * Completely re-written to support various OMAP chips with bank specific&n; * interrupt handlers.&n; *&n; * Some snippets of the code taken from the older OMAP interrupt handler&n; * Copyright (C) 2001 RidgeRun, Inc. Greg Lonnon &lt;glonnon@ridgerun.com&gt;&n; *&n; * GPIO interrupt handler moved to gpio.c by Juha Yrjola&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the&n; * Free Software Foundation; either version 2 of the License, or (at your&n; * option) any later version.&n; *&n; * THIS SOFTWARE IS PROVIDED ``AS IS&squot;&squot; AND ANY EXPRESS OR IMPLIED&n; * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF&n; * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN&n; * NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,&n; * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT&n; * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF&n; * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON&n; * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT&n; * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF&n; * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n; *&n; * You should have received a copy of the  GNU General Public License along&n; * with this program; if not, write  to the Free Software Foundation, Inc.,&n; * 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/mach/irq.h&gt;
macro_line|#include &lt;asm/arch/gpio.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|macro|IRQ_BANK
mdefine_line|#define IRQ_BANK(irq) ((irq) &gt;&gt; 5)
DECL|macro|IRQ_BIT
mdefine_line|#define IRQ_BIT(irq)  ((irq) &amp; 0x1f)
DECL|struct|omap_irq_bank
r_struct
id|omap_irq_bank
(brace
DECL|member|base_reg
r_int
r_int
id|base_reg
suffix:semicolon
DECL|member|trigger_map
r_int
r_int
id|trigger_map
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|irq_bank_count
r_static
r_int
r_int
id|irq_bank_count
op_assign
l_int|0
suffix:semicolon
DECL|variable|irq_banks
r_static
r_struct
id|omap_irq_bank
op_star
id|irq_banks
suffix:semicolon
DECL|function|irq_bank_readl
r_static
r_inline
r_int
r_int
id|irq_bank_readl
c_func
(paren
r_int
id|bank
comma
r_int
id|offset
)paren
(brace
r_return
id|omap_readl
c_func
(paren
id|irq_banks
(braket
id|bank
)braket
dot
id|base_reg
op_plus
id|offset
)paren
suffix:semicolon
)brace
DECL|function|irq_bank_writel
r_static
r_inline
r_void
id|irq_bank_writel
c_func
(paren
r_int
r_int
id|value
comma
r_int
id|bank
comma
r_int
id|offset
)paren
(brace
id|omap_writel
c_func
(paren
id|value
comma
id|irq_banks
(braket
id|bank
)braket
dot
id|base_reg
op_plus
id|offset
)paren
suffix:semicolon
)brace
DECL|function|omap_ack_irq
r_static
r_void
id|omap_ack_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_if
c_cond
(paren
id|irq
OG
l_int|31
)paren
id|omap_writel
c_func
(paren
l_int|0x1
comma
id|OMAP_IH2_BASE
op_plus
id|IRQ_CONTROL_REG_OFFSET
)paren
suffix:semicolon
id|omap_writel
c_func
(paren
l_int|0x1
comma
id|OMAP_IH1_BASE
op_plus
id|IRQ_CONTROL_REG_OFFSET
)paren
suffix:semicolon
)brace
DECL|function|omap_mask_irq
r_static
r_void
id|omap_mask_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
id|bank
op_assign
id|IRQ_BANK
c_func
(paren
id|irq
)paren
suffix:semicolon
id|u32
id|l
suffix:semicolon
id|l
op_assign
id|omap_readl
c_func
(paren
id|irq_banks
(braket
id|bank
)braket
dot
id|base_reg
op_plus
id|IRQ_MIR_REG_OFFSET
)paren
suffix:semicolon
id|l
op_or_assign
l_int|1
op_lshift
id|IRQ_BIT
c_func
(paren
id|irq
)paren
suffix:semicolon
id|omap_writel
c_func
(paren
id|l
comma
id|irq_banks
(braket
id|bank
)braket
dot
id|base_reg
op_plus
id|IRQ_MIR_REG_OFFSET
)paren
suffix:semicolon
)brace
DECL|function|omap_unmask_irq
r_static
r_void
id|omap_unmask_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
id|bank
op_assign
id|IRQ_BANK
c_func
(paren
id|irq
)paren
suffix:semicolon
id|u32
id|l
suffix:semicolon
id|l
op_assign
id|omap_readl
c_func
(paren
id|irq_banks
(braket
id|bank
)braket
dot
id|base_reg
op_plus
id|IRQ_MIR_REG_OFFSET
)paren
suffix:semicolon
id|l
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|IRQ_BIT
c_func
(paren
id|irq
)paren
)paren
suffix:semicolon
id|omap_writel
c_func
(paren
id|l
comma
id|irq_banks
(braket
id|bank
)braket
dot
id|base_reg
op_plus
id|IRQ_MIR_REG_OFFSET
)paren
suffix:semicolon
)brace
DECL|function|omap_mask_ack_irq
r_static
r_void
id|omap_mask_ack_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|omap_mask_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
id|omap_ack_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Allows tuning the IRQ type and priority&n; *&n; * NOTE: There is currently no OMAP fiq handler for Linux. Read the&n; *&t; mailing list threads on FIQ handlers if you are planning to&n; *&t; add a FIQ handler for OMAP.&n; */
DECL|function|omap_irq_set_cfg
r_static
r_void
id|omap_irq_set_cfg
c_func
(paren
r_int
id|irq
comma
r_int
id|fiq
comma
r_int
id|priority
comma
r_int
id|trigger
)paren
(brace
r_int
r_int
id|bank
suffix:semicolon
r_int
r_int
id|val
comma
id|offset
suffix:semicolon
id|bank
op_assign
id|IRQ_BANK
c_func
(paren
id|irq
)paren
suffix:semicolon
multiline_comment|/* FIQ is only available on bank 0 interrupts */
id|fiq
op_assign
id|bank
ques
c_cond
l_int|0
suffix:colon
(paren
id|fiq
op_amp
l_int|0x1
)paren
suffix:semicolon
id|val
op_assign
id|fiq
op_or
(paren
(paren
id|priority
op_amp
l_int|0x1f
)paren
op_lshift
l_int|2
)paren
op_or
(paren
(paren
id|trigger
op_amp
l_int|0x1
)paren
op_lshift
l_int|1
)paren
suffix:semicolon
id|offset
op_assign
id|IRQ_ILR0_REG_OFFSET
op_plus
id|IRQ_BIT
c_func
(paren
id|irq
)paren
op_star
l_int|0x4
suffix:semicolon
id|irq_bank_writel
c_func
(paren
id|val
comma
id|bank
comma
id|offset
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ARCH_OMAP730
DECL|variable|omap730_irq_banks
r_static
r_struct
id|omap_irq_bank
id|omap730_irq_banks
(braket
)braket
op_assign
(brace
(brace
dot
id|base_reg
op_assign
id|OMAP_IH1_BASE
comma
dot
id|trigger_map
op_assign
l_int|0xb3f8e22f
)brace
comma
(brace
dot
id|base_reg
op_assign
id|OMAP_IH2_BASE
comma
dot
id|trigger_map
op_assign
l_int|0xfdb9c1f2
)brace
comma
(brace
dot
id|base_reg
op_assign
id|OMAP_IH2_BASE
op_plus
l_int|0x100
comma
dot
id|trigger_map
op_assign
l_int|0x800040f3
)brace
comma
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ARCH_OMAP1510
DECL|variable|omap1510_irq_banks
r_static
r_struct
id|omap_irq_bank
id|omap1510_irq_banks
(braket
)braket
op_assign
(brace
(brace
dot
id|base_reg
op_assign
id|OMAP_IH1_BASE
comma
dot
id|trigger_map
op_assign
l_int|0xb3febfff
)brace
comma
(brace
dot
id|base_reg
op_assign
id|OMAP_IH2_BASE
comma
dot
id|trigger_map
op_assign
l_int|0xffbfffed
)brace
comma
)brace
suffix:semicolon
macro_line|#endif
macro_line|#if defined(CONFIG_ARCH_OMAP16XX)
DECL|variable|omap1610_irq_banks
r_static
r_struct
id|omap_irq_bank
id|omap1610_irq_banks
(braket
)braket
op_assign
(brace
(brace
dot
id|base_reg
op_assign
id|OMAP_IH1_BASE
comma
dot
id|trigger_map
op_assign
l_int|0xb3fefe8f
)brace
comma
(brace
dot
id|base_reg
op_assign
id|OMAP_IH2_BASE
comma
dot
id|trigger_map
op_assign
l_int|0xfdb7c1fd
)brace
comma
(brace
dot
id|base_reg
op_assign
id|OMAP_IH2_BASE
op_plus
l_int|0x100
comma
dot
id|trigger_map
op_assign
l_int|0xfffff7ff
)brace
comma
(brace
dot
id|base_reg
op_assign
id|OMAP_IH2_BASE
op_plus
l_int|0x200
comma
dot
id|trigger_map
op_assign
l_int|0xffffffff
)brace
comma
)brace
suffix:semicolon
macro_line|#endif
DECL|variable|omap_irq_chip
r_static
r_struct
id|irqchip
id|omap_irq_chip
op_assign
(brace
dot
id|ack
op_assign
id|omap_mask_ack_irq
comma
dot
id|mask
op_assign
id|omap_mask_irq
comma
dot
id|unmask
op_assign
id|omap_unmask_irq
comma
)brace
suffix:semicolon
DECL|function|omap_init_irq
r_void
id|__init
id|omap_init_irq
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
macro_line|#ifdef CONFIG_ARCH_OMAP730
r_if
c_cond
(paren
id|cpu_is_omap730
c_func
(paren
)paren
)paren
(brace
id|irq_banks
op_assign
id|omap730_irq_banks
suffix:semicolon
id|irq_bank_count
op_assign
id|ARRAY_SIZE
c_func
(paren
id|omap730_irq_banks
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_ARCH_OMAP1510
r_if
c_cond
(paren
id|cpu_is_omap1510
c_func
(paren
)paren
)paren
(brace
id|irq_banks
op_assign
id|omap1510_irq_banks
suffix:semicolon
id|irq_bank_count
op_assign
id|ARRAY_SIZE
c_func
(paren
id|omap1510_irq_banks
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if defined(CONFIG_ARCH_OMAP16XX)
r_if
c_cond
(paren
id|cpu_is_omap16xx
c_func
(paren
)paren
)paren
(brace
id|irq_banks
op_assign
id|omap1610_irq_banks
suffix:semicolon
id|irq_bank_count
op_assign
id|ARRAY_SIZE
c_func
(paren
id|omap1610_irq_banks
)paren
suffix:semicolon
)brace
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;Total of %i interrupts in %i interrupt banks&bslash;n&quot;
comma
id|irq_bank_count
op_star
l_int|32
comma
id|irq_bank_count
)paren
suffix:semicolon
multiline_comment|/* Mask and clear all interrupts */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|irq_bank_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|irq_bank_writel
c_func
(paren
op_complement
l_int|0x0
comma
id|i
comma
id|IRQ_MIR_REG_OFFSET
)paren
suffix:semicolon
id|irq_bank_writel
c_func
(paren
l_int|0x0
comma
id|i
comma
id|IRQ_ITR_REG_OFFSET
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear any pending interrupts */
id|irq_bank_writel
c_func
(paren
l_int|0x03
comma
l_int|0
comma
id|IRQ_CONTROL_REG_OFFSET
)paren
suffix:semicolon
id|irq_bank_writel
c_func
(paren
l_int|0x03
comma
l_int|1
comma
id|IRQ_CONTROL_REG_OFFSET
)paren
suffix:semicolon
multiline_comment|/* Enable interrupts in global mask */
r_if
c_cond
(paren
id|cpu_is_omap730
c_func
(paren
)paren
)paren
(brace
id|irq_bank_writel
c_func
(paren
l_int|0x0
comma
l_int|0
comma
id|IRQ_GMR_REG_OFFSET
)paren
suffix:semicolon
)brace
multiline_comment|/* Install the interrupt handlers for each bank */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|irq_bank_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
id|i
op_star
l_int|32
suffix:semicolon
id|j
OL
(paren
id|i
op_plus
l_int|1
)paren
op_star
l_int|32
suffix:semicolon
id|j
op_increment
)paren
(brace
r_int
id|irq_trigger
suffix:semicolon
id|irq_trigger
op_assign
id|irq_banks
(braket
id|i
)braket
dot
id|trigger_map
op_rshift
id|IRQ_BIT
c_func
(paren
id|j
)paren
suffix:semicolon
id|omap_irq_set_cfg
c_func
(paren
id|j
comma
l_int|0
comma
l_int|0
comma
id|irq_trigger
)paren
suffix:semicolon
id|set_irq_chip
c_func
(paren
id|j
comma
op_amp
id|omap_irq_chip
)paren
suffix:semicolon
id|set_irq_handler
c_func
(paren
id|j
comma
id|do_level_IRQ
)paren
suffix:semicolon
id|set_irq_flags
c_func
(paren
id|j
comma
id|IRQF_VALID
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Unmask level 2 handler */
r_if
c_cond
(paren
id|cpu_is_omap730
c_func
(paren
)paren
)paren
(brace
id|omap_unmask_irq
c_func
(paren
id|INT_730_IH2_IRQ
)paren
suffix:semicolon
)brace
r_else
(brace
id|omap_unmask_irq
c_func
(paren
id|INT_IH2_IRQ
)paren
suffix:semicolon
)brace
)brace
eof
