multiline_comment|/*&n; * linux/arch/arm/mach-iop310/time-iq80310.c&n; *&n; * Timer functions for IQ80310 onboard timer&n; *&n; * Author:  Nicolas Pitre&n; * Copyright:   (C) 2001 MontaVista Software Inc.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;linux/timex.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/mach-types.h&gt;
DECL|function|iq80310_write_timer
r_static
r_void
id|iq80310_write_timer
(paren
id|u_long
id|val
)paren
(brace
r_volatile
id|u_char
op_star
id|la0
op_assign
(paren
r_volatile
id|u_char
op_star
)paren
id|IQ80310_TIMER_LA0
suffix:semicolon
r_volatile
id|u_char
op_star
id|la1
op_assign
(paren
r_volatile
id|u_char
op_star
)paren
id|IQ80310_TIMER_LA1
suffix:semicolon
r_volatile
id|u_char
op_star
id|la2
op_assign
(paren
r_volatile
id|u_char
op_star
)paren
id|IQ80310_TIMER_LA2
suffix:semicolon
op_star
id|la0
op_assign
id|val
suffix:semicolon
op_star
id|la1
op_assign
id|val
op_rshift
l_int|8
suffix:semicolon
op_star
id|la2
op_assign
(paren
id|val
op_rshift
l_int|16
)paren
op_amp
l_int|0x3f
suffix:semicolon
)brace
DECL|function|iq80310_read_timer
r_static
id|u_long
id|iq80310_read_timer
(paren
r_void
)paren
(brace
r_volatile
id|u_char
op_star
id|la0
op_assign
(paren
r_volatile
id|u_char
op_star
)paren
id|IQ80310_TIMER_LA0
suffix:semicolon
r_volatile
id|u_char
op_star
id|la1
op_assign
(paren
r_volatile
id|u_char
op_star
)paren
id|IQ80310_TIMER_LA1
suffix:semicolon
r_volatile
id|u_char
op_star
id|la2
op_assign
(paren
r_volatile
id|u_char
op_star
)paren
id|IQ80310_TIMER_LA2
suffix:semicolon
r_volatile
id|u_char
op_star
id|la3
op_assign
(paren
r_volatile
id|u_char
op_star
)paren
id|IQ80310_TIMER_LA3
suffix:semicolon
id|u_long
id|b0
comma
id|b1
comma
id|b2
comma
id|b3
comma
id|val
suffix:semicolon
id|b0
op_assign
op_star
id|la0
suffix:semicolon
id|b1
op_assign
op_star
id|la1
suffix:semicolon
id|b2
op_assign
op_star
id|la2
suffix:semicolon
id|b3
op_assign
op_star
id|la3
suffix:semicolon
id|b0
op_assign
(paren
(paren
(paren
id|b0
op_amp
l_int|0x20
)paren
op_rshift
l_int|1
)paren
op_or
(paren
id|b0
op_amp
l_int|0x1f
)paren
)paren
suffix:semicolon
id|b1
op_assign
(paren
(paren
(paren
id|b1
op_amp
l_int|0x20
)paren
op_rshift
l_int|1
)paren
op_or
(paren
id|b1
op_amp
l_int|0x1f
)paren
)paren
suffix:semicolon
id|b2
op_assign
(paren
(paren
(paren
id|b2
op_amp
l_int|0x20
)paren
op_rshift
l_int|1
)paren
op_or
(paren
id|b2
op_amp
l_int|0x1f
)paren
)paren
suffix:semicolon
id|b3
op_assign
(paren
id|b3
op_amp
l_int|0x0f
)paren
suffix:semicolon
id|val
op_assign
(paren
(paren
id|b0
op_lshift
l_int|0
)paren
op_or
(paren
id|b1
op_lshift
l_int|6
)paren
op_or
(paren
id|b2
op_lshift
l_int|12
)paren
op_or
(paren
id|b3
op_lshift
l_int|18
)paren
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
multiline_comment|/* IRQs are disabled before entering here from do_gettimeofday() */
DECL|function|iq80310_gettimeoffset
r_static
r_int
r_int
id|iq80310_gettimeoffset
(paren
r_void
)paren
(brace
r_int
r_int
id|elapsed
comma
id|usec
suffix:semicolon
multiline_comment|/* We need elapsed timer ticks since last interrupt */
id|elapsed
op_assign
id|iq80310_read_timer
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Now convert them to usec */
id|usec
op_assign
(paren
r_int
r_int
)paren
(paren
id|elapsed
op_star
id|tick
)paren
op_div
id|LATCH
suffix:semicolon
r_return
id|usec
suffix:semicolon
)brace
DECL|function|iq80310_timer_interrupt
r_static
r_void
id|iq80310_timer_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_volatile
id|u_char
op_star
id|timer_en
op_assign
(paren
r_volatile
id|u_char
op_star
)paren
id|IQ80310_TIMER_EN
suffix:semicolon
multiline_comment|/* clear timer interrupt */
op_star
id|timer_en
op_and_assign
op_complement
l_int|2
suffix:semicolon
op_star
id|timer_en
op_or_assign
l_int|2
suffix:semicolon
multiline_comment|/*&n;&t; * AHEM..HACK&n;&t; *&n;&t; * Since the timer interrupt is cascaded through the CPLD and&n;&t; * the 80312 and the demux code calls do_IRQ, the irq count is&n;&t; * going to be atleast 2 when we get here and this will cause the&n;&t; * kernel to increment the system tick counter even if we&squot;re&n;&t; * idle. This causes it to look like there&squot;s always 100% system&n;&t; * time, which is not the case.  To get around it, we just decrement&n;&t; * the IRQ count before calling do_timer. We increment it again&n;&t; * b/c otherwise it will go negative and than bad things happen.&n;&t; *&n;&t; * -DS&n;&t; */
id|irq_exit
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
id|irq
)paren
suffix:semicolon
id|do_timer
c_func
(paren
id|regs
)paren
suffix:semicolon
id|irq_enter
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
id|irq
)paren
suffix:semicolon
)brace
r_extern
r_int
r_int
(paren
op_star
id|gettimeoffset
)paren
(paren
r_void
)paren
suffix:semicolon
DECL|variable|timer_irq
r_static
r_struct
id|irqaction
id|timer_irq
op_assign
(brace
id|name
suffix:colon
l_string|&quot;timer&quot;
comma
id|handler
suffix:colon
id|iq80310_timer_interrupt
comma
)brace
suffix:semicolon
r_extern
r_int
id|setup_arm_irq
c_func
(paren
r_int
comma
r_struct
id|irqaction
op_star
)paren
suffix:semicolon
DECL|function|time_init
r_void
id|__init
id|time_init
c_func
(paren
r_void
)paren
(brace
r_volatile
id|u_char
op_star
id|timer_en
op_assign
(paren
r_volatile
id|u_char
op_star
)paren
id|IQ80310_TIMER_EN
suffix:semicolon
id|gettimeoffset
op_assign
id|iq80310_gettimeoffset
suffix:semicolon
id|setup_arm_irq
c_func
(paren
id|IRQ_IQ80310_TIMER
comma
op_amp
id|timer_irq
)paren
suffix:semicolon
op_star
id|timer_en
op_assign
l_int|0
suffix:semicolon
id|iq80310_write_timer
c_func
(paren
id|LATCH
)paren
suffix:semicolon
op_star
id|timer_en
op_or_assign
l_int|2
suffix:semicolon
op_star
id|timer_en
op_or_assign
l_int|1
suffix:semicolon
)brace
eof
