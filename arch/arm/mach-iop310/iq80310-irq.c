multiline_comment|/*&n; * linux/arch/arm/mach-iop310/iq80310-irq.c&n; *&n; * IRQ hadling/demuxing for IQ80310 board&n; *&n; * Author:  Nicolas Pitre&n; * Copyright:   (C) 2001 MontaVista Software Inc.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; * 2.4.7-rmk1-iop310.1&n; *     Moved demux from asm to C - DS&n; *     Fixes for various revision boards - DS&n; */
macro_line|#include &lt;linux/kernel_stat.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/mach/irq.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/mach-types.h&gt;
r_extern
r_void
id|iop310_init_irq
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|iop310_irq_demux
c_func
(paren
r_int
r_int
comma
r_struct
id|irqdesc
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
DECL|function|iq80310_irq_mask
r_static
r_void
id|iq80310_irq_mask
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
op_star
(paren
r_volatile
r_char
op_star
)paren
id|IQ80310_INT_MASK
op_or_assign
(paren
l_int|1
op_lshift
(paren
id|irq
op_minus
id|IQ80310_IRQ_OFS
)paren
)paren
suffix:semicolon
)brace
DECL|function|iq80310_irq_unmask
r_static
r_void
id|iq80310_irq_unmask
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
op_star
(paren
r_volatile
r_char
op_star
)paren
id|IQ80310_INT_MASK
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|irq
op_minus
id|IQ80310_IRQ_OFS
)paren
)paren
suffix:semicolon
)brace
DECL|variable|iq80310_irq_chip
r_static
r_struct
id|irqchip
id|iq80310_irq_chip
op_assign
(brace
id|ack
suffix:colon
id|iq80310_irq_mask
comma
id|mask
suffix:colon
id|iq80310_irq_mask
comma
id|unmask
suffix:colon
id|iq80310_irq_unmask
comma
)brace
suffix:semicolon
r_extern
r_struct
id|irqchip
id|ext_chip
suffix:semicolon
r_static
r_void
DECL|function|iq80310_cpld_irq_handler
id|iq80310_cpld_irq_handler
c_func
(paren
r_int
r_int
id|irq
comma
r_struct
id|irqdesc
op_star
id|desc
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|irq_stat
op_assign
op_star
(paren
r_volatile
id|u8
op_star
)paren
id|IQ80310_INT_STAT
suffix:semicolon
r_int
r_int
id|irq_mask
op_assign
op_star
(paren
r_volatile
id|u8
op_star
)paren
id|IQ80310_INT_MASK
suffix:semicolon
r_int
r_int
id|i
comma
id|handled
op_assign
l_int|0
suffix:semicolon
r_struct
id|irqdesc
op_star
id|d
suffix:semicolon
id|desc-&gt;chip
op_member_access_from_pointer
id|ack
c_func
(paren
id|irq
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Mask out the interrupts which aren&squot;t enabled.&n;&t; */
id|irq_stat
op_and_assign
l_int|0x1f
op_amp
op_complement
id|irq_mask
suffix:semicolon
multiline_comment|/*&n;&t; * Test each IQ80310 CPLD interrupt&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
id|IRQ_IQ80310_TIMER
comma
id|d
op_assign
id|irq_desc
op_plus
id|IRQ_IQ80310_TIMER
suffix:semicolon
id|irq_stat
suffix:semicolon
id|i
op_increment
comma
id|d
op_increment
comma
id|irq_stat
op_rshift_assign
l_int|1
)paren
r_if
c_cond
(paren
id|irq_stat
op_amp
l_int|1
)paren
(brace
id|d
op_member_access_from_pointer
id|handle
c_func
(paren
id|i
comma
id|d
comma
id|regs
)paren
suffix:semicolon
id|handled
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If running on a board later than REV D.1, we can&n;&t; * decode the PCI interrupt status.&n;&t; */
r_if
c_cond
(paren
id|system_rev
)paren
(brace
id|irq_stat
op_assign
op_star
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|IQ80310_PCI_INT_STAT
)paren
op_amp
l_int|7
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|IRQ_IQ80310_INTA
comma
id|d
op_assign
id|irq_desc
op_plus
id|IRQ_IQ80310_INTA
suffix:semicolon
id|irq_stat
suffix:semicolon
id|i
op_increment
comma
id|d
op_increment
comma
id|irq_stat
op_rshift_assign
l_int|1
)paren
r_if
c_cond
(paren
id|irq_stat
op_amp
l_int|0x1
)paren
(brace
id|d
op_member_access_from_pointer
id|handle
c_func
(paren
id|i
comma
id|d
comma
id|regs
)paren
suffix:semicolon
id|handled
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * If on a REV D.1 or lower board, we just assumed INTA&n;&t; * since PCI is not routed, and it may actually be an&n;&t; * on-chip interrupt.&n;&t; *&n;&t; * Note that we&squot;re giving on-chip interrupts slightly&n;&t; * higher priority than PCI by handling them first.&n;&t; *&n;&t; * On boards later than REV D.1, if we didn&squot;t read a&n;&t; * CPLD interrupt, we assume it&squot;s from a device on the&n;&t; * chipset itself.&n;&t; */
r_if
c_cond
(paren
id|system_rev
op_eq
l_int|0
op_logical_or
id|handled
op_eq
l_int|0
)paren
id|iop310_irq_demux
c_func
(paren
id|irq
comma
id|desc
comma
id|regs
)paren
suffix:semicolon
id|desc-&gt;chip
op_member_access_from_pointer
id|unmask
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|iq80310_init_irq
r_void
id|__init
id|iq80310_init_irq
c_func
(paren
r_void
)paren
(brace
r_volatile
r_char
op_star
id|mask
op_assign
(paren
r_volatile
r_char
op_star
)paren
id|IQ80310_INT_MASK
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
id|iop310_init_irq
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Setup PIRSR to route PCI interrupts into xs80200&n;&t; */
op_star
id|IOP310_PIRSR
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/*&n;&t; * Setup the IRQs in the FE820000/FE860000 registers&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
id|IQ80310_IRQ_OFS
suffix:semicolon
id|i
op_le
id|IRQ_IQ80310_INTD
suffix:semicolon
id|i
op_increment
)paren
(brace
id|set_irq_chip
c_func
(paren
id|i
comma
op_amp
id|iq80310_irq_chip
)paren
suffix:semicolon
id|set_irq_handler
c_func
(paren
id|i
comma
id|do_level_IRQ
)paren
suffix:semicolon
id|set_irq_flags
c_func
(paren
id|i
comma
id|IRQF_VALID
op_or
id|IRQF_PROBE
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Setup the PCI IRQs&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
id|IRQ_IQ80310_INTA
suffix:semicolon
id|i
OL
id|IRQ_IQ80310_INTC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|set_irq_chip
c_func
(paren
id|i
comma
op_amp
id|ext_chip
)paren
suffix:semicolon
id|set_irq_handler
c_func
(paren
id|i
comma
id|do_level_IRQ
)paren
suffix:semicolon
id|set_irq_flags
c_func
(paren
id|i
comma
id|IRQF_VALID
)paren
suffix:semicolon
)brace
op_star
id|mask
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* mask all sources */
id|set_irq_chained_handler
c_func
(paren
id|IRQ_XS80200_EXTIRQ
comma
op_amp
id|iq80310_cpld_irq_handler
)paren
suffix:semicolon
)brace
eof
