multiline_comment|/*&n; * linux/arch/arm/mach-iop310/iq80310-irq.c&n; *&n; * IRQ hadling/demuxing for IQ80310 board&n; *&n; * Author:  Nicolas Pitre&n; * Copyright:   (C) 2001 MontaVista Software Inc.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; * 2.4.7-rmk1-iop310.1&n; *     Moved demux from asm to C - DS&n; *     Fixes for various revision boards - DS&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel_stat.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/mach/irq.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/mach-types.h&gt;
r_extern
r_void
id|xs80200_irq_mask
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_extern
r_void
id|xs80200_irq_unmask
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_extern
r_void
id|xs80200_init_irq
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|do_IRQ
c_func
(paren
r_int
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_extern
id|u32
id|iop310_mask
suffix:semicolon
r_extern
r_void
id|iop310_irq_demux
c_func
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_extern
r_int
id|iop310_init_irq
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
DECL|function|iq80310_irq_mask
id|iq80310_irq_mask
(paren
r_int
r_int
id|irq
)paren
(brace
r_volatile
r_char
op_star
id|mask
op_assign
(paren
r_volatile
r_char
op_star
)paren
id|IQ80310_INT_MASK
suffix:semicolon
op_star
id|mask
op_or_assign
(paren
l_int|1
op_lshift
(paren
id|irq
op_minus
id|IQ80310_IRQ_OFS
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * There&squot;s no mask for PCI INT A-C, so we just mask out all&n;&t; * external interrupts on the CPU.&n;&t; *&n;&t; * We set a bit of the iop310 mask so that the iop310_irq_mask&n;&t; * function does not unmask EXTINT&n;&t; */
r_if
c_cond
(paren
id|irq
OG
id|IRQ_IQ80310_INTD
)paren
(brace
id|xs80200_irq_mask
c_func
(paren
id|IRQ_XS80200_EXTIRQ
)paren
suffix:semicolon
id|iop310_mask
op_or_assign
(paren
l_int|0x80000000
op_rshift
(paren
id|irq
op_minus
id|IRQ_IQ80310_INTD
)paren
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|iq80310_irq_unmask
id|iq80310_irq_unmask
(paren
r_int
r_int
id|irq
)paren
(brace
r_volatile
r_char
op_star
id|mask
op_assign
(paren
r_volatile
r_char
op_star
)paren
id|IQ80310_INT_MASK
suffix:semicolon
op_star
id|mask
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|irq
op_minus
id|IQ80310_IRQ_OFS
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * See comment above&n;&t; */
r_if
c_cond
(paren
id|irq
OG
id|IRQ_IQ80310_INTD
)paren
(brace
id|xs80200_irq_unmask
c_func
(paren
id|IRQ_XS80200_EXTIRQ
)paren
suffix:semicolon
id|iop310_mask
op_and_assign
op_complement
(paren
(paren
l_int|0x80000000
op_rshift
(paren
id|irq
op_minus
id|IRQ_IQ80310_INTD
)paren
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|iq80310_cpld_irq_demux
r_static
r_void
id|iq80310_cpld_irq_demux
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|u8
id|irq_stat
op_assign
op_star
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|IQ80310_INT_STAT
)paren
suffix:semicolon
id|u8
id|irq_mask
op_assign
op_star
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|IQ80310_INT_MASK
)paren
suffix:semicolon
r_int
r_int
id|irqno
op_assign
l_int|0xffffffff
suffix:semicolon
singleline_comment|// Needed? If IRQ is masked, it shouldn&squot;t get through...
id|irq_stat
op_and_assign
op_complement
id|irq_mask
suffix:semicolon
r_if
c_cond
(paren
id|irq_stat
op_amp
l_int|0x01
)paren
(brace
id|irqno
op_assign
id|IRQ_IQ80310_TIMER
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|irq_stat
op_amp
l_int|0x02
)paren
(brace
id|irqno
op_assign
id|IRQ_IQ80310_I82559
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|irq_stat
op_amp
l_int|0x04
)paren
(brace
id|irqno
op_assign
id|IRQ_IQ80310_UART1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|irq_stat
op_amp
l_int|0x08
)paren
(brace
id|irqno
op_assign
id|IRQ_IQ80310_UART2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|irq_stat
op_amp
l_int|0x10
)paren
(brace
id|irqno
op_assign
id|IRQ_IQ80310_INTD
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|system_rev
)paren
(brace
id|irq_stat
op_assign
op_star
(paren
(paren
r_volatile
id|u8
op_star
)paren
id|IQ80310_PCI_INT_STAT
)paren
op_amp
l_int|0xf
suffix:semicolon
r_if
c_cond
(paren
id|irq_stat
op_amp
l_int|0x1
)paren
(brace
id|irqno
op_assign
id|IRQ_IQ80310_INTA
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|irq_stat
op_amp
l_int|0x2
)paren
(brace
id|irqno
op_assign
id|IRQ_IQ80310_INTB
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|irq_stat
op_amp
l_int|0x4
)paren
(brace
id|irqno
op_assign
id|IRQ_IQ80310_INTC
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* Running on a REV D.1 or older, assume PCI INTA */
id|irqno
op_assign
id|IRQ_IQ80310_INTA
suffix:semicolon
multiline_comment|/*&n;&t; * If we didn&squot;t read a CPLD interrupt, we assume it&squot;s from&n;&t; * a device on the chipset itself.&n;&t; */
r_if
c_cond
(paren
id|irqno
op_eq
l_int|0xffffffff
)paren
(brace
id|iop310_irq_demux
c_func
(paren
id|irq
comma
id|dev_id
comma
id|regs
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If on a REV D.1 or lower board, we just assumed INTA since&n;&t; * PCI is not routed, and it may actually be an on-chip interrupt.&n;&t; *&n;&t; * Note that we&squot;re giving on-chip interrupts slightly higher&n;&t; * priority than PCI by handling them first.&n;&t; */
r_if
c_cond
(paren
id|irqno
op_eq
id|IRQ_IQ80310_INTA
op_logical_and
op_logical_neg
id|system_rev
)paren
(brace
id|iop310_irq_demux
c_func
(paren
id|irq
comma
id|dev_id
comma
id|regs
)paren
suffix:semicolon
)brace
id|do_IRQ
c_func
(paren
id|irqno
comma
id|regs
)paren
suffix:semicolon
)brace
DECL|variable|iq80310_cpld_irq
r_static
r_struct
id|irqaction
id|iq80310_cpld_irq
op_assign
(brace
id|name
suffix:colon
l_string|&quot;CPLD_IRQ&quot;
comma
id|handler
suffix:colon
id|iq80310_cpld_irq_demux
comma
id|flags
suffix:colon
id|SA_INTERRUPT
)brace
suffix:semicolon
r_extern
r_int
id|setup_arm_irq
c_func
(paren
r_int
comma
r_struct
id|irqaction
op_star
)paren
suffix:semicolon
DECL|function|iq80310_init_irq
r_void
id|__init
id|iq80310_init_irq
c_func
(paren
r_void
)paren
(brace
r_volatile
r_char
op_star
id|mask
op_assign
(paren
r_volatile
r_char
op_star
)paren
id|IQ80310_INT_MASK
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
id|iop310_init_irq
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Setup PIRSR to route PCI interrupts into xs80200&n;&t; */
op_star
id|IOP310_PIRSR
op_assign
l_int|0xff
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|IQ80310_IRQ_OFS
suffix:semicolon
id|i
OL
id|NR_IRQS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|irq_desc
(braket
id|i
)braket
dot
id|valid
op_assign
l_int|1
suffix:semicolon
id|irq_desc
(braket
id|i
)braket
dot
id|probe_ok
op_assign
l_int|1
suffix:semicolon
id|irq_desc
(braket
id|i
)braket
dot
id|mask_ack
op_assign
id|iq80310_irq_mask
suffix:semicolon
id|irq_desc
(braket
id|i
)braket
dot
id|mask
op_assign
id|iq80310_irq_mask
suffix:semicolon
id|irq_desc
(braket
id|i
)braket
dot
id|unmask
op_assign
id|iq80310_irq_unmask
suffix:semicolon
)brace
op_star
id|mask
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* mask all sources */
id|setup_arm_irq
c_func
(paren
id|IRQ_XS80200_EXTIRQ
comma
op_amp
id|iq80310_cpld_irq
)paren
suffix:semicolon
multiline_comment|/* enable only external IRQ in the INTCTL for now */
id|asm
(paren
l_string|&quot;mcr p13, 0, %0, c0, c0, 0&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
l_int|1
op_lshift
l_int|1
)paren
)paren
suffix:semicolon
)brace
eof
