multiline_comment|/*&n; *  linux/arch/arm/mach-versatile/core.c&n; *&n; *  Copyright (C) 1999 - 2003 ARM Limited&n; *  Copyright (C) 2000 Deep Blue Solutions Ltd&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &lt;linux/sysdev.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/leds.h&gt;
macro_line|#include &lt;asm/mach-types.h&gt;
macro_line|#include &lt;asm/hardware/amba.h&gt;
macro_line|#include &lt;asm/hardware/amba_clcd.h&gt;
macro_line|#include &lt;asm/hardware/icst307.h&gt;
macro_line|#include &lt;asm/mach/arch.h&gt;
macro_line|#include &lt;asm/mach/flash.h&gt;
macro_line|#include &lt;asm/mach/irq.h&gt;
macro_line|#include &lt;asm/mach/time.h&gt;
macro_line|#include &lt;asm/mach/map.h&gt;
macro_line|#include &lt;asm/mach/mmc.h&gt;
macro_line|#include &quot;core.h&quot;
macro_line|#include &quot;clock.h&quot;
multiline_comment|/*&n; * All IO addresses are mapped onto VA 0xFFFx.xxxx, where x.xxxx&n; * is the (PA &gt;&gt; 12).&n; *&n; * Setup a VA for the Versatile Vectored Interrupt Controller.&n; */
DECL|macro|VA_VIC_BASE
mdefine_line|#define VA_VIC_BASE&t;&t; IO_ADDRESS(VERSATILE_VIC_BASE)
DECL|macro|VA_SIC_BASE
mdefine_line|#define VA_SIC_BASE&t;&t; IO_ADDRESS(VERSATILE_SIC_BASE)
DECL|function|vic_mask_irq
r_static
r_void
id|vic_mask_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|irq
op_sub_assign
id|IRQ_VIC_START
suffix:semicolon
id|writel
c_func
(paren
l_int|1
op_lshift
id|irq
comma
id|VA_VIC_BASE
op_plus
id|VIC_IRQ_ENABLE_CLEAR
)paren
suffix:semicolon
)brace
DECL|function|vic_unmask_irq
r_static
r_void
id|vic_unmask_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|irq
op_sub_assign
id|IRQ_VIC_START
suffix:semicolon
id|writel
c_func
(paren
l_int|1
op_lshift
id|irq
comma
id|VA_VIC_BASE
op_plus
id|VIC_IRQ_ENABLE
)paren
suffix:semicolon
)brace
DECL|variable|vic_chip
r_static
r_struct
id|irqchip
id|vic_chip
op_assign
(brace
dot
id|ack
op_assign
id|vic_mask_irq
comma
dot
id|mask
op_assign
id|vic_mask_irq
comma
dot
id|unmask
op_assign
id|vic_unmask_irq
comma
)brace
suffix:semicolon
DECL|function|sic_mask_irq
r_static
r_void
id|sic_mask_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|irq
op_sub_assign
id|IRQ_SIC_START
suffix:semicolon
id|writel
c_func
(paren
l_int|1
op_lshift
id|irq
comma
id|VA_SIC_BASE
op_plus
id|SIC_IRQ_ENABLE_CLEAR
)paren
suffix:semicolon
)brace
DECL|function|sic_unmask_irq
r_static
r_void
id|sic_unmask_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|irq
op_sub_assign
id|IRQ_SIC_START
suffix:semicolon
id|writel
c_func
(paren
l_int|1
op_lshift
id|irq
comma
id|VA_SIC_BASE
op_plus
id|SIC_IRQ_ENABLE_SET
)paren
suffix:semicolon
)brace
DECL|variable|sic_chip
r_static
r_struct
id|irqchip
id|sic_chip
op_assign
(brace
dot
id|ack
op_assign
id|sic_mask_irq
comma
dot
id|mask
op_assign
id|sic_mask_irq
comma
dot
id|unmask
op_assign
id|sic_unmask_irq
comma
)brace
suffix:semicolon
r_static
r_void
DECL|function|sic_handle_irq
id|sic_handle_irq
c_func
(paren
r_int
r_int
id|irq
comma
r_struct
id|irqdesc
op_star
id|desc
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|status
op_assign
id|readl
c_func
(paren
id|VA_SIC_BASE
op_plus
id|SIC_IRQ_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
(brace
id|do_bad_IRQ
c_func
(paren
id|irq
comma
id|desc
comma
id|regs
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_do
(brace
id|irq
op_assign
id|ffs
c_func
(paren
id|status
)paren
op_minus
l_int|1
suffix:semicolon
id|status
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|irq
)paren
suffix:semicolon
id|irq
op_add_assign
id|IRQ_SIC_START
suffix:semicolon
id|desc
op_assign
id|irq_desc
op_plus
id|irq
suffix:semicolon
id|desc
op_member_access_from_pointer
id|handle
c_func
(paren
id|irq
comma
id|desc
comma
id|regs
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|status
)paren
suffix:semicolon
)brace
macro_line|#if 1
DECL|macro|IRQ_MMCI0A
mdefine_line|#define IRQ_MMCI0A&t;IRQ_VICSOURCE22
DECL|macro|IRQ_AACI
mdefine_line|#define IRQ_AACI&t;IRQ_VICSOURCE24
DECL|macro|IRQ_ETH
mdefine_line|#define IRQ_ETH&t;&t;IRQ_VICSOURCE25
DECL|macro|PIC_MASK
mdefine_line|#define PIC_MASK&t;0xFFD00000
macro_line|#else
DECL|macro|IRQ_MMCI0A
mdefine_line|#define IRQ_MMCI0A&t;IRQ_SIC_MMCI0A
DECL|macro|IRQ_AACI
mdefine_line|#define IRQ_AACI&t;IRQ_SIC_AACI
DECL|macro|IRQ_ETH
mdefine_line|#define IRQ_ETH&t;&t;IRQ_SIC_ETH
DECL|macro|PIC_MASK
mdefine_line|#define PIC_MASK&t;0
macro_line|#endif
DECL|function|versatile_init_irq
r_void
id|__init
id|versatile_init_irq
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|i
comma
id|value
suffix:semicolon
multiline_comment|/* Disable all interrupts initially. */
id|writel
c_func
(paren
l_int|0
comma
id|VA_VIC_BASE
op_plus
id|VIC_INT_SELECT
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|VA_VIC_BASE
op_plus
id|VIC_IRQ_ENABLE
)paren
suffix:semicolon
id|writel
c_func
(paren
op_complement
l_int|0
comma
id|VA_VIC_BASE
op_plus
id|VIC_IRQ_ENABLE_CLEAR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|VA_VIC_BASE
op_plus
id|VIC_IRQ_STATUS
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|VA_VIC_BASE
op_plus
id|VIC_ITCR
)paren
suffix:semicolon
id|writel
c_func
(paren
op_complement
l_int|0
comma
id|VA_VIC_BASE
op_plus
id|VIC_IRQ_SOFT_CLEAR
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Make sure we clear all existing interrupts&n;&t; */
id|writel
c_func
(paren
l_int|0
comma
id|VA_VIC_BASE
op_plus
id|VIC_VECT_ADDR
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|19
suffix:semicolon
id|i
op_increment
)paren
(brace
id|value
op_assign
id|readl
c_func
(paren
id|VA_VIC_BASE
op_plus
id|VIC_VECT_ADDR
)paren
suffix:semicolon
id|writel
c_func
(paren
id|value
comma
id|VA_VIC_BASE
op_plus
id|VIC_VECT_ADDR
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|value
op_assign
id|readl
c_func
(paren
id|VA_VIC_BASE
op_plus
id|VIC_VECT_CNTL0
op_plus
(paren
id|i
op_star
l_int|4
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|value
op_or
id|VICVectCntl_Enable
op_or
id|i
comma
id|VA_VIC_BASE
op_plus
id|VIC_VECT_CNTL0
op_plus
(paren
id|i
op_star
l_int|4
)paren
)paren
suffix:semicolon
)brace
id|writel
c_func
(paren
l_int|32
comma
id|VA_VIC_BASE
op_plus
id|VIC_DEF_VECT_ADDR
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|IRQ_VIC_START
suffix:semicolon
id|i
op_le
id|IRQ_VIC_END
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_ne
id|IRQ_VICSOURCE31
)paren
(brace
id|set_irq_chip
c_func
(paren
id|i
comma
op_amp
id|vic_chip
)paren
suffix:semicolon
id|set_irq_handler
c_func
(paren
id|i
comma
id|do_level_IRQ
)paren
suffix:semicolon
id|set_irq_flags
c_func
(paren
id|i
comma
id|IRQF_VALID
op_or
id|IRQF_PROBE
)paren
suffix:semicolon
)brace
)brace
id|set_irq_handler
c_func
(paren
id|IRQ_VICSOURCE31
comma
id|sic_handle_irq
)paren
suffix:semicolon
id|vic_unmask_irq
c_func
(paren
id|IRQ_VICSOURCE31
)paren
suffix:semicolon
multiline_comment|/* Do second interrupt controller */
id|writel
c_func
(paren
op_complement
l_int|0
comma
id|VA_SIC_BASE
op_plus
id|SIC_IRQ_ENABLE_CLEAR
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|IRQ_SIC_START
suffix:semicolon
id|i
op_le
id|IRQ_SIC_END
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|PIC_MASK
op_amp
(paren
l_int|1
op_lshift
(paren
id|i
op_minus
id|IRQ_SIC_START
)paren
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|set_irq_chip
c_func
(paren
id|i
comma
op_amp
id|sic_chip
)paren
suffix:semicolon
id|set_irq_handler
c_func
(paren
id|i
comma
id|do_level_IRQ
)paren
suffix:semicolon
id|set_irq_flags
c_func
(paren
id|i
comma
id|IRQF_VALID
op_or
id|IRQF_PROBE
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Interrupts on secondary controller from 0 to 8 are routed to&n;&t; * source 31 on PIC.&n;&t; * Interrupts from 21 to 31 are routed directly to the VIC on&n;&t; * the corresponding number on primary controller. This is controlled&n;&t; * by setting PIC_ENABLEx.&n;&t; */
id|writel
c_func
(paren
id|PIC_MASK
comma
id|VA_SIC_BASE
op_plus
id|SIC_INT_PIC_ENABLE
)paren
suffix:semicolon
)brace
DECL|variable|__initdata
r_static
r_struct
id|map_desc
id|versatile_io_desc
(braket
)braket
id|__initdata
op_assign
(brace
(brace
id|IO_ADDRESS
c_func
(paren
id|VERSATILE_SYS_BASE
)paren
comma
id|VERSATILE_SYS_BASE
comma
id|SZ_4K
comma
id|MT_DEVICE
)brace
comma
(brace
id|IO_ADDRESS
c_func
(paren
id|VERSATILE_SIC_BASE
)paren
comma
id|VERSATILE_SIC_BASE
comma
id|SZ_4K
comma
id|MT_DEVICE
)brace
comma
(brace
id|IO_ADDRESS
c_func
(paren
id|VERSATILE_VIC_BASE
)paren
comma
id|VERSATILE_VIC_BASE
comma
id|SZ_4K
comma
id|MT_DEVICE
)brace
comma
(brace
id|IO_ADDRESS
c_func
(paren
id|VERSATILE_SCTL_BASE
)paren
comma
id|VERSATILE_SCTL_BASE
comma
id|SZ_4K
op_star
l_int|9
comma
id|MT_DEVICE
)brace
comma
macro_line|#ifdef CONFIG_MACH_VERSATILE_AB
(brace
id|IO_ADDRESS
c_func
(paren
id|VERSATILE_GPIO0_BASE
)paren
comma
id|VERSATILE_GPIO0_BASE
comma
id|SZ_4K
comma
id|MT_DEVICE
)brace
comma
(brace
id|IO_ADDRESS
c_func
(paren
id|VERSATILE_IB2_BASE
)paren
comma
id|VERSATILE_IB2_BASE
comma
id|SZ_64M
comma
id|MT_DEVICE
)brace
comma
macro_line|#endif
macro_line|#ifdef CONFIG_DEBUG_LL
(brace
id|IO_ADDRESS
c_func
(paren
id|VERSATILE_UART0_BASE
)paren
comma
id|VERSATILE_UART0_BASE
comma
id|SZ_4K
comma
id|MT_DEVICE
)brace
comma
macro_line|#endif
macro_line|#ifdef FIXME
(brace
id|PCI_MEMORY_VADDR
comma
id|PHYS_PCI_MEM_BASE
comma
id|SZ_16M
comma
id|MT_DEVICE
)brace
comma
(brace
id|PCI_CONFIG_VADDR
comma
id|PHYS_PCI_CONFIG_BASE
comma
id|SZ_16M
comma
id|MT_DEVICE
)brace
comma
(brace
id|PCI_V3_VADDR
comma
id|PHYS_PCI_V3_BASE
comma
id|SZ_512K
comma
id|MT_DEVICE
)brace
comma
(brace
id|PCI_IO_VADDR
comma
id|PHYS_PCI_IO_BASE
comma
id|SZ_64K
comma
id|MT_DEVICE
)brace
comma
macro_line|#endif
)brace
suffix:semicolon
DECL|function|versatile_map_io
r_void
id|__init
id|versatile_map_io
c_func
(paren
r_void
)paren
(brace
id|iotable_init
c_func
(paren
id|versatile_io_desc
comma
id|ARRAY_SIZE
c_func
(paren
id|versatile_io_desc
)paren
)paren
suffix:semicolon
)brace
DECL|macro|VERSATILE_REFCOUNTER
mdefine_line|#define VERSATILE_REFCOUNTER&t;(IO_ADDRESS(VERSATILE_SYS_BASE) + VERSATILE_SYS_24MHz_OFFSET)
multiline_comment|/*&n; * This is the Versatile sched_clock implementation.  This has&n; * a resolution of 41.7ns, and a maximum value of about 179s.&n; */
DECL|function|sched_clock
r_int
r_int
r_int
id|sched_clock
c_func
(paren
r_void
)paren
(brace
r_int
r_int
r_int
id|v
suffix:semicolon
id|v
op_assign
(paren
r_int
r_int
r_int
)paren
id|readl
c_func
(paren
id|VERSATILE_REFCOUNTER
)paren
op_star
l_int|125
suffix:semicolon
id|do_div
c_func
(paren
id|v
comma
l_int|3
)paren
suffix:semicolon
r_return
id|v
suffix:semicolon
)brace
DECL|macro|VERSATILE_FLASHCTRL
mdefine_line|#define VERSATILE_FLASHCTRL    (IO_ADDRESS(VERSATILE_SYS_BASE) + VERSATILE_SYS_FLASH_OFFSET)
DECL|function|versatile_flash_init
r_static
r_int
id|versatile_flash_init
c_func
(paren
r_void
)paren
(brace
id|u32
id|val
suffix:semicolon
id|val
op_assign
id|__raw_readl
c_func
(paren
id|VERSATILE_FLASHCTRL
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
id|VERSATILE_FLASHPROG_FLVPPEN
suffix:semicolon
id|__raw_writel
c_func
(paren
id|val
comma
id|VERSATILE_FLASHCTRL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|versatile_flash_exit
r_static
r_void
id|versatile_flash_exit
c_func
(paren
r_void
)paren
(brace
id|u32
id|val
suffix:semicolon
id|val
op_assign
id|__raw_readl
c_func
(paren
id|VERSATILE_FLASHCTRL
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
id|VERSATILE_FLASHPROG_FLVPPEN
suffix:semicolon
id|__raw_writel
c_func
(paren
id|val
comma
id|VERSATILE_FLASHCTRL
)paren
suffix:semicolon
)brace
DECL|function|versatile_flash_set_vpp
r_static
r_void
id|versatile_flash_set_vpp
c_func
(paren
r_int
id|on
)paren
(brace
id|u32
id|val
suffix:semicolon
id|val
op_assign
id|__raw_readl
c_func
(paren
id|VERSATILE_FLASHCTRL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|on
)paren
id|val
op_or_assign
id|VERSATILE_FLASHPROG_FLVPPEN
suffix:semicolon
r_else
id|val
op_and_assign
op_complement
id|VERSATILE_FLASHPROG_FLVPPEN
suffix:semicolon
id|__raw_writel
c_func
(paren
id|val
comma
id|VERSATILE_FLASHCTRL
)paren
suffix:semicolon
)brace
DECL|variable|versatile_flash_data
r_static
r_struct
id|flash_platform_data
id|versatile_flash_data
op_assign
(brace
dot
id|map_name
op_assign
l_string|&quot;cfi_probe&quot;
comma
dot
id|width
op_assign
l_int|4
comma
dot
id|init
op_assign
id|versatile_flash_init
comma
dot
m_exit
op_assign
id|versatile_flash_exit
comma
dot
id|set_vpp
op_assign
id|versatile_flash_set_vpp
comma
)brace
suffix:semicolon
DECL|variable|versatile_flash_resource
r_static
r_struct
id|resource
id|versatile_flash_resource
op_assign
(brace
dot
id|start
op_assign
id|VERSATILE_FLASH_BASE
comma
dot
id|end
op_assign
id|VERSATILE_FLASH_BASE
op_plus
id|VERSATILE_FLASH_SIZE
comma
dot
id|flags
op_assign
id|IORESOURCE_MEM
comma
)brace
suffix:semicolon
DECL|variable|versatile_flash_device
r_static
r_struct
id|platform_device
id|versatile_flash_device
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;armflash&quot;
comma
dot
id|id
op_assign
l_int|0
comma
dot
id|dev
op_assign
(brace
dot
id|platform_data
op_assign
op_amp
id|versatile_flash_data
comma
)brace
comma
dot
id|num_resources
op_assign
l_int|1
comma
dot
id|resource
op_assign
op_amp
id|versatile_flash_resource
comma
)brace
suffix:semicolon
DECL|variable|smc91x_resources
r_static
r_struct
id|resource
id|smc91x_resources
(braket
)braket
op_assign
(brace
(braket
l_int|0
)braket
op_assign
(brace
dot
id|start
op_assign
id|VERSATILE_ETH_BASE
comma
dot
id|end
op_assign
id|VERSATILE_ETH_BASE
op_plus
id|SZ_64K
op_minus
l_int|1
comma
dot
id|flags
op_assign
id|IORESOURCE_MEM
comma
)brace
comma
(braket
l_int|1
)braket
op_assign
(brace
dot
id|start
op_assign
id|IRQ_ETH
comma
dot
id|end
op_assign
id|IRQ_ETH
comma
dot
id|flags
op_assign
id|IORESOURCE_IRQ
comma
)brace
comma
)brace
suffix:semicolon
DECL|variable|smc91x_device
r_static
r_struct
id|platform_device
id|smc91x_device
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;smc91x&quot;
comma
dot
id|id
op_assign
l_int|0
comma
dot
id|num_resources
op_assign
id|ARRAY_SIZE
c_func
(paren
id|smc91x_resources
)paren
comma
dot
id|resource
op_assign
id|smc91x_resources
comma
)brace
suffix:semicolon
DECL|macro|VERSATILE_SYSMCI
mdefine_line|#define VERSATILE_SYSMCI&t;(IO_ADDRESS(VERSATILE_SYS_BASE) + VERSATILE_SYS_MCI_OFFSET)
DECL|function|mmc_status
r_int
r_int
id|mmc_status
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|amba_device
op_star
id|adev
op_assign
id|container_of
c_func
(paren
id|dev
comma
r_struct
id|amba_device
comma
id|dev
)paren
suffix:semicolon
id|u32
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|adev-&gt;res.start
op_eq
id|VERSATILE_MMCI0_BASE
)paren
id|mask
op_assign
l_int|1
suffix:semicolon
r_else
id|mask
op_assign
l_int|2
suffix:semicolon
r_return
id|readl
c_func
(paren
id|VERSATILE_SYSMCI
)paren
op_amp
id|mask
suffix:semicolon
)brace
DECL|variable|mmc0_plat_data
r_static
r_struct
id|mmc_platform_data
id|mmc0_plat_data
op_assign
(brace
dot
id|ocr_mask
op_assign
id|MMC_VDD_32_33
op_or
id|MMC_VDD_33_34
comma
dot
id|status
op_assign
id|mmc_status
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Clock handling&n; */
DECL|variable|versatile_oscvco_params
r_static
r_const
r_struct
id|icst307_params
id|versatile_oscvco_params
op_assign
(brace
dot
id|ref
op_assign
l_int|24000
comma
dot
id|vco_max
op_assign
l_int|200000
comma
dot
id|vd_min
op_assign
l_int|4
op_plus
l_int|8
comma
dot
id|vd_max
op_assign
l_int|511
op_plus
l_int|8
comma
dot
id|rd_min
op_assign
l_int|1
op_plus
l_int|2
comma
dot
id|rd_max
op_assign
l_int|127
op_plus
l_int|2
comma
)brace
suffix:semicolon
DECL|function|versatile_oscvco_set
r_static
r_void
id|versatile_oscvco_set
c_func
(paren
r_struct
id|clk
op_star
id|clk
comma
r_struct
id|icst307_vco
id|vco
)paren
(brace
r_int
r_int
id|sys_lock
op_assign
id|IO_ADDRESS
c_func
(paren
id|VERSATILE_SYS_BASE
)paren
op_plus
id|VERSATILE_SYS_LOCK_OFFSET
suffix:semicolon
macro_line|#if defined(CONFIG_ARCH_VERSATILE_PB)
r_int
r_int
id|sys_osc
op_assign
id|IO_ADDRESS
c_func
(paren
id|VERSATILE_SYS_BASE
)paren
op_plus
id|VERSATILE_SYS_OSC4_OFFSET
suffix:semicolon
macro_line|#elif defined(CONFIG_MACH_VERSATILE_AB)
r_int
r_int
id|sys_osc
op_assign
id|IO_ADDRESS
c_func
(paren
id|VERSATILE_SYS_BASE
)paren
op_plus
id|VERSATILE_SYS_OSC1_OFFSET
suffix:semicolon
macro_line|#endif
id|u32
id|val
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|sys_osc
)paren
op_amp
op_complement
l_int|0x7ffff
suffix:semicolon
id|val
op_or_assign
id|vco.v
op_or
(paren
id|vco.r
op_lshift
l_int|9
)paren
op_or
(paren
id|vco.s
op_lshift
l_int|16
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xa05f
comma
id|sys_lock
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|sys_osc
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|sys_lock
)paren
suffix:semicolon
)brace
DECL|variable|versatile_clcd_clk
r_static
r_struct
id|clk
id|versatile_clcd_clk
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;CLCDCLK&quot;
comma
dot
id|params
op_assign
op_amp
id|versatile_oscvco_params
comma
dot
id|setvco
op_assign
id|versatile_oscvco_set
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * CLCD support.&n; */
DECL|macro|SYS_CLCD_MODE_MASK
mdefine_line|#define SYS_CLCD_MODE_MASK&t;(3 &lt;&lt; 0)
DECL|macro|SYS_CLCD_MODE_888
mdefine_line|#define SYS_CLCD_MODE_888&t;(0 &lt;&lt; 0)
DECL|macro|SYS_CLCD_MODE_5551
mdefine_line|#define SYS_CLCD_MODE_5551&t;(1 &lt;&lt; 0)
DECL|macro|SYS_CLCD_MODE_565_RLSB
mdefine_line|#define SYS_CLCD_MODE_565_RLSB&t;(2 &lt;&lt; 0)
DECL|macro|SYS_CLCD_MODE_565_BLSB
mdefine_line|#define SYS_CLCD_MODE_565_BLSB&t;(3 &lt;&lt; 0)
DECL|macro|SYS_CLCD_NLCDIOON
mdefine_line|#define SYS_CLCD_NLCDIOON&t;(1 &lt;&lt; 2)
DECL|macro|SYS_CLCD_VDDPOSSWITCH
mdefine_line|#define SYS_CLCD_VDDPOSSWITCH&t;(1 &lt;&lt; 3)
DECL|macro|SYS_CLCD_PWR3V5SWITCH
mdefine_line|#define SYS_CLCD_PWR3V5SWITCH&t;(1 &lt;&lt; 4)
DECL|macro|SYS_CLCD_ID_MASK
mdefine_line|#define SYS_CLCD_ID_MASK&t;(0x1f &lt;&lt; 8)
DECL|macro|SYS_CLCD_ID_SANYO_3_8
mdefine_line|#define SYS_CLCD_ID_SANYO_3_8&t;(0x00 &lt;&lt; 8)
DECL|macro|SYS_CLCD_ID_UNKNOWN_8_4
mdefine_line|#define SYS_CLCD_ID_UNKNOWN_8_4&t;(0x01 &lt;&lt; 8)
DECL|macro|SYS_CLCD_ID_EPSON_2_2
mdefine_line|#define SYS_CLCD_ID_EPSON_2_2&t;(0x02 &lt;&lt; 8)
DECL|macro|SYS_CLCD_ID_SANYO_2_5
mdefine_line|#define SYS_CLCD_ID_SANYO_2_5&t;(0x07 &lt;&lt; 8)
DECL|macro|SYS_CLCD_ID_VGA
mdefine_line|#define SYS_CLCD_ID_VGA&t;&t;(0x1f &lt;&lt; 8)
DECL|variable|vga
r_static
r_struct
id|clcd_panel
id|vga
op_assign
(brace
dot
id|mode
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;VGA&quot;
comma
dot
id|refresh
op_assign
l_int|60
comma
dot
id|xres
op_assign
l_int|640
comma
dot
id|yres
op_assign
l_int|480
comma
dot
id|pixclock
op_assign
l_int|39721
comma
dot
id|left_margin
op_assign
l_int|40
comma
dot
id|right_margin
op_assign
l_int|24
comma
dot
id|upper_margin
op_assign
l_int|32
comma
dot
id|lower_margin
op_assign
l_int|11
comma
dot
id|hsync_len
op_assign
l_int|96
comma
dot
id|vsync_len
op_assign
l_int|2
comma
dot
id|sync
op_assign
l_int|0
comma
dot
id|vmode
op_assign
id|FB_VMODE_NONINTERLACED
comma
)brace
comma
dot
id|width
op_assign
op_minus
l_int|1
comma
dot
id|height
op_assign
op_minus
l_int|1
comma
dot
id|tim2
op_assign
id|TIM2_BCD
op_or
id|TIM2_IPC
comma
dot
id|cntl
op_assign
id|CNTL_LCDTFT
op_or
id|CNTL_LCDVCOMP
c_func
(paren
l_int|1
)paren
comma
dot
id|bpp
op_assign
l_int|16
comma
)brace
suffix:semicolon
DECL|variable|sanyo_3_8_in
r_static
r_struct
id|clcd_panel
id|sanyo_3_8_in
op_assign
(brace
dot
id|mode
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;Sanyo QVGA&quot;
comma
dot
id|refresh
op_assign
l_int|116
comma
dot
id|xres
op_assign
l_int|320
comma
dot
id|yres
op_assign
l_int|240
comma
dot
id|pixclock
op_assign
l_int|100000
comma
dot
id|left_margin
op_assign
l_int|6
comma
dot
id|right_margin
op_assign
l_int|6
comma
dot
id|upper_margin
op_assign
l_int|5
comma
dot
id|lower_margin
op_assign
l_int|5
comma
dot
id|hsync_len
op_assign
l_int|6
comma
dot
id|vsync_len
op_assign
l_int|6
comma
dot
id|sync
op_assign
l_int|0
comma
dot
id|vmode
op_assign
id|FB_VMODE_NONINTERLACED
comma
)brace
comma
dot
id|width
op_assign
op_minus
l_int|1
comma
dot
id|height
op_assign
op_minus
l_int|1
comma
dot
id|tim2
op_assign
id|TIM2_BCD
comma
dot
id|cntl
op_assign
id|CNTL_LCDTFT
op_or
id|CNTL_LCDVCOMP
c_func
(paren
l_int|1
)paren
comma
dot
id|bpp
op_assign
l_int|16
comma
)brace
suffix:semicolon
DECL|variable|sanyo_2_5_in
r_static
r_struct
id|clcd_panel
id|sanyo_2_5_in
op_assign
(brace
dot
id|mode
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;Sanyo QVGA Portrait&quot;
comma
dot
id|refresh
op_assign
l_int|116
comma
dot
id|xres
op_assign
l_int|240
comma
dot
id|yres
op_assign
l_int|320
comma
dot
id|pixclock
op_assign
l_int|100000
comma
dot
id|left_margin
op_assign
l_int|20
comma
dot
id|right_margin
op_assign
l_int|10
comma
dot
id|upper_margin
op_assign
l_int|2
comma
dot
id|lower_margin
op_assign
l_int|2
comma
dot
id|hsync_len
op_assign
l_int|10
comma
dot
id|vsync_len
op_assign
l_int|2
comma
dot
id|sync
op_assign
id|FB_SYNC_HOR_HIGH_ACT
op_or
id|FB_SYNC_VERT_HIGH_ACT
comma
dot
id|vmode
op_assign
id|FB_VMODE_NONINTERLACED
comma
)brace
comma
dot
id|width
op_assign
op_minus
l_int|1
comma
dot
id|height
op_assign
op_minus
l_int|1
comma
dot
id|tim2
op_assign
id|TIM2_IVS
op_or
id|TIM2_IHS
op_or
id|TIM2_IPC
comma
dot
id|cntl
op_assign
id|CNTL_LCDTFT
op_or
id|CNTL_LCDVCOMP
c_func
(paren
l_int|1
)paren
comma
dot
id|bpp
op_assign
l_int|16
comma
)brace
suffix:semicolon
DECL|variable|epson_2_2_in
r_static
r_struct
id|clcd_panel
id|epson_2_2_in
op_assign
(brace
dot
id|mode
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;Epson QCIF&quot;
comma
dot
id|refresh
op_assign
l_int|390
comma
dot
id|xres
op_assign
l_int|176
comma
dot
id|yres
op_assign
l_int|220
comma
dot
id|pixclock
op_assign
l_int|62500
comma
dot
id|left_margin
op_assign
l_int|3
comma
dot
id|right_margin
op_assign
l_int|2
comma
dot
id|upper_margin
op_assign
l_int|1
comma
dot
id|lower_margin
op_assign
l_int|0
comma
dot
id|hsync_len
op_assign
l_int|3
comma
dot
id|vsync_len
op_assign
l_int|2
comma
dot
id|sync
op_assign
l_int|0
comma
dot
id|vmode
op_assign
id|FB_VMODE_NONINTERLACED
comma
)brace
comma
dot
id|width
op_assign
op_minus
l_int|1
comma
dot
id|height
op_assign
op_minus
l_int|1
comma
dot
id|tim2
op_assign
id|TIM2_BCD
op_or
id|TIM2_IPC
comma
dot
id|cntl
op_assign
id|CNTL_LCDTFT
op_or
id|CNTL_LCDVCOMP
c_func
(paren
l_int|1
)paren
comma
dot
id|bpp
op_assign
l_int|16
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Detect which LCD panel is connected, and return the appropriate&n; * clcd_panel structure.  Note: we do not have any information on&n; * the required timings for the 8.4in panel, so we presently assume&n; * VGA timings.&n; */
DECL|function|versatile_clcd_panel
r_static
r_struct
id|clcd_panel
op_star
id|versatile_clcd_panel
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|sys_clcd
op_assign
id|IO_ADDRESS
c_func
(paren
id|VERSATILE_SYS_BASE
)paren
op_plus
id|VERSATILE_SYS_CLCD_OFFSET
suffix:semicolon
r_struct
id|clcd_panel
op_star
id|panel
op_assign
op_amp
id|vga
suffix:semicolon
id|u32
id|val
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|sys_clcd
)paren
op_amp
id|SYS_CLCD_ID_MASK
suffix:semicolon
r_if
c_cond
(paren
id|val
op_eq
id|SYS_CLCD_ID_SANYO_3_8
)paren
id|panel
op_assign
op_amp
id|sanyo_3_8_in
suffix:semicolon
r_else
r_if
c_cond
(paren
id|val
op_eq
id|SYS_CLCD_ID_SANYO_2_5
)paren
id|panel
op_assign
op_amp
id|sanyo_2_5_in
suffix:semicolon
r_else
r_if
c_cond
(paren
id|val
op_eq
id|SYS_CLCD_ID_EPSON_2_2
)paren
id|panel
op_assign
op_amp
id|epson_2_2_in
suffix:semicolon
r_else
r_if
c_cond
(paren
id|val
op_eq
id|SYS_CLCD_ID_VGA
)paren
id|panel
op_assign
op_amp
id|vga
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;CLCD: unknown LCD panel ID 0x%08x, using VGA&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
id|panel
op_assign
op_amp
id|vga
suffix:semicolon
)brace
r_return
id|panel
suffix:semicolon
)brace
multiline_comment|/*&n; * Disable all display connectors on the interface module.&n; */
DECL|function|versatile_clcd_disable
r_static
r_void
id|versatile_clcd_disable
c_func
(paren
r_struct
id|clcd_fb
op_star
id|fb
)paren
(brace
r_int
r_int
id|sys_clcd
op_assign
id|IO_ADDRESS
c_func
(paren
id|VERSATILE_SYS_BASE
)paren
op_plus
id|VERSATILE_SYS_CLCD_OFFSET
suffix:semicolon
id|u32
id|val
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|sys_clcd
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
id|SYS_CLCD_NLCDIOON
op_or
id|SYS_CLCD_PWR3V5SWITCH
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|sys_clcd
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_MACH_VERSATILE_AB
multiline_comment|/*&n;&t; * If the LCD is Sanyo 2x5 in on the IB2 board, turn the back-light off&n;&t; */
r_if
c_cond
(paren
id|fb-&gt;panel
op_eq
op_amp
id|sanyo_2_5_in
)paren
(brace
r_int
r_int
id|versatile_ib2_ctrl
op_assign
id|IO_ADDRESS
c_func
(paren
id|VERSATILE_IB2_CTRL
)paren
suffix:semicolon
r_int
r_int
id|ctrl
suffix:semicolon
id|ctrl
op_assign
id|readl
c_func
(paren
id|versatile_ib2_ctrl
)paren
suffix:semicolon
id|ctrl
op_and_assign
op_complement
l_int|0x01
suffix:semicolon
id|writel
c_func
(paren
id|ctrl
comma
id|versatile_ib2_ctrl
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/*&n; * Enable the relevant connector on the interface module.&n; */
DECL|function|versatile_clcd_enable
r_static
r_void
id|versatile_clcd_enable
c_func
(paren
r_struct
id|clcd_fb
op_star
id|fb
)paren
(brace
r_int
r_int
id|sys_clcd
op_assign
id|IO_ADDRESS
c_func
(paren
id|VERSATILE_SYS_BASE
)paren
op_plus
id|VERSATILE_SYS_CLCD_OFFSET
suffix:semicolon
id|u32
id|val
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|sys_clcd
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
id|SYS_CLCD_MODE_MASK
suffix:semicolon
r_switch
c_cond
(paren
id|fb-&gt;fb.var.green.length
)paren
(brace
r_case
l_int|5
suffix:colon
id|val
op_or_assign
id|SYS_CLCD_MODE_5551
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|val
op_or_assign
id|SYS_CLCD_MODE_565_BLSB
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|val
op_or_assign
id|SYS_CLCD_MODE_888
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Set the MUX&n;&t; */
id|writel
c_func
(paren
id|val
comma
id|sys_clcd
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * And now enable the PSUs&n;&t; */
id|val
op_or_assign
id|SYS_CLCD_NLCDIOON
op_or
id|SYS_CLCD_PWR3V5SWITCH
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|sys_clcd
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_MACH_VERSATILE_AB
multiline_comment|/*&n;&t; * If the LCD is Sanyo 2x5 in on the IB2 board, turn the back-light on&n;&t; */
r_if
c_cond
(paren
id|fb-&gt;panel
op_eq
op_amp
id|sanyo_2_5_in
)paren
(brace
r_int
r_int
id|versatile_ib2_ctrl
op_assign
id|IO_ADDRESS
c_func
(paren
id|VERSATILE_IB2_CTRL
)paren
suffix:semicolon
r_int
r_int
id|ctrl
suffix:semicolon
id|ctrl
op_assign
id|readl
c_func
(paren
id|versatile_ib2_ctrl
)paren
suffix:semicolon
id|ctrl
op_or_assign
l_int|0x01
suffix:semicolon
id|writel
c_func
(paren
id|ctrl
comma
id|versatile_ib2_ctrl
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
DECL|variable|framesize
r_static
r_int
r_int
id|framesize
op_assign
id|SZ_1M
suffix:semicolon
DECL|function|versatile_clcd_setup
r_static
r_int
id|versatile_clcd_setup
c_func
(paren
r_struct
id|clcd_fb
op_star
id|fb
)paren
(brace
id|dma_addr_t
id|dma
suffix:semicolon
id|fb-&gt;panel
op_assign
id|versatile_clcd_panel
c_func
(paren
)paren
suffix:semicolon
id|fb-&gt;fb.screen_base
op_assign
id|dma_alloc_writecombine
c_func
(paren
op_amp
id|fb-&gt;dev-&gt;dev
comma
id|framesize
comma
op_amp
id|dma
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fb-&gt;fb.screen_base
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;CLCD: unable to map framebuffer&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|fb-&gt;fb.fix.smem_start
op_assign
id|dma
suffix:semicolon
id|fb-&gt;fb.fix.smem_len
op_assign
id|framesize
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|versatile_clcd_remove
r_static
r_void
id|versatile_clcd_remove
c_func
(paren
r_struct
id|clcd_fb
op_star
id|fb
)paren
(brace
id|dma_free_writecombine
c_func
(paren
op_amp
id|fb-&gt;dev-&gt;dev
comma
id|fb-&gt;fb.fix.smem_len
comma
id|fb-&gt;fb.screen_base
comma
id|fb-&gt;fb.fix.smem_start
)paren
suffix:semicolon
)brace
DECL|variable|clcd_plat_data
r_static
r_struct
id|clcd_board
id|clcd_plat_data
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;Versatile&quot;
comma
dot
id|check
op_assign
id|clcdfb_check
comma
dot
id|decode
op_assign
id|clcdfb_decode
comma
dot
id|disable
op_assign
id|versatile_clcd_disable
comma
dot
id|enable
op_assign
id|versatile_clcd_enable
comma
dot
id|setup
op_assign
id|versatile_clcd_setup
comma
dot
id|remove
op_assign
id|versatile_clcd_remove
comma
)brace
suffix:semicolon
DECL|macro|AACI_IRQ
mdefine_line|#define AACI_IRQ&t;{ IRQ_AACI, NO_IRQ }
DECL|macro|AACI_DMA
mdefine_line|#define AACI_DMA&t;{ 0x80, 0x81 }
DECL|macro|MMCI0_IRQ
mdefine_line|#define MMCI0_IRQ&t;{ IRQ_MMCI0A,IRQ_SIC_MMCI0B }
DECL|macro|MMCI0_DMA
mdefine_line|#define MMCI0_DMA&t;{ 0x84, 0 }
DECL|macro|KMI0_IRQ
mdefine_line|#define KMI0_IRQ&t;{ IRQ_SIC_KMI0, NO_IRQ }
DECL|macro|KMI0_DMA
mdefine_line|#define KMI0_DMA&t;{ 0, 0 }
DECL|macro|KMI1_IRQ
mdefine_line|#define KMI1_IRQ&t;{ IRQ_SIC_KMI1, NO_IRQ }
DECL|macro|KMI1_DMA
mdefine_line|#define KMI1_DMA&t;{ 0, 0 }
multiline_comment|/*&n; * These devices are connected directly to the multi-layer AHB switch&n; */
DECL|macro|SMC_IRQ
mdefine_line|#define SMC_IRQ&t;&t;{ NO_IRQ, NO_IRQ }
DECL|macro|SMC_DMA
mdefine_line|#define SMC_DMA&t;&t;{ 0, 0 }
DECL|macro|MPMC_IRQ
mdefine_line|#define MPMC_IRQ&t;{ NO_IRQ, NO_IRQ }
DECL|macro|MPMC_DMA
mdefine_line|#define MPMC_DMA&t;{ 0, 0 }
DECL|macro|CLCD_IRQ
mdefine_line|#define CLCD_IRQ&t;{ IRQ_CLCDINT, NO_IRQ }
DECL|macro|CLCD_DMA
mdefine_line|#define CLCD_DMA&t;{ 0, 0 }
DECL|macro|DMAC_IRQ
mdefine_line|#define DMAC_IRQ&t;{ IRQ_DMAINT, NO_IRQ }
DECL|macro|DMAC_DMA
mdefine_line|#define DMAC_DMA&t;{ 0, 0 }
multiline_comment|/*&n; * These devices are connected via the core APB bridge&n; */
DECL|macro|SCTL_IRQ
mdefine_line|#define SCTL_IRQ&t;{ NO_IRQ, NO_IRQ }
DECL|macro|SCTL_DMA
mdefine_line|#define SCTL_DMA&t;{ 0, 0 }
DECL|macro|WATCHDOG_IRQ
mdefine_line|#define WATCHDOG_IRQ&t;{ IRQ_WDOGINT, NO_IRQ }
DECL|macro|WATCHDOG_DMA
mdefine_line|#define WATCHDOG_DMA&t;{ 0, 0 }
DECL|macro|GPIO0_IRQ
mdefine_line|#define GPIO0_IRQ&t;{ IRQ_GPIOINT0, NO_IRQ }
DECL|macro|GPIO0_DMA
mdefine_line|#define GPIO0_DMA&t;{ 0, 0 }
DECL|macro|GPIO1_IRQ
mdefine_line|#define GPIO1_IRQ&t;{ IRQ_GPIOINT1, NO_IRQ }
DECL|macro|GPIO1_DMA
mdefine_line|#define GPIO1_DMA&t;{ 0, 0 }
DECL|macro|RTC_IRQ
mdefine_line|#define RTC_IRQ&t;&t;{ IRQ_RTCINT, NO_IRQ }
DECL|macro|RTC_DMA
mdefine_line|#define RTC_DMA&t;&t;{ 0, 0 }
multiline_comment|/*&n; * These devices are connected via the DMA APB bridge&n; */
DECL|macro|SCI_IRQ
mdefine_line|#define SCI_IRQ&t;&t;{ IRQ_SCIINT, NO_IRQ }
DECL|macro|SCI_DMA
mdefine_line|#define SCI_DMA&t;&t;{ 7, 6 }
DECL|macro|UART0_IRQ
mdefine_line|#define UART0_IRQ&t;{ IRQ_UARTINT0, NO_IRQ }
DECL|macro|UART0_DMA
mdefine_line|#define UART0_DMA&t;{ 15, 14 }
DECL|macro|UART1_IRQ
mdefine_line|#define UART1_IRQ&t;{ IRQ_UARTINT1, NO_IRQ }
DECL|macro|UART1_DMA
mdefine_line|#define UART1_DMA&t;{ 13, 12 }
DECL|macro|UART2_IRQ
mdefine_line|#define UART2_IRQ&t;{ IRQ_UARTINT2, NO_IRQ }
DECL|macro|UART2_DMA
mdefine_line|#define UART2_DMA&t;{ 11, 10 }
DECL|macro|SSP_IRQ
mdefine_line|#define SSP_IRQ&t;&t;{ IRQ_SSPINT, NO_IRQ }
DECL|macro|SSP_DMA
mdefine_line|#define SSP_DMA&t;&t;{ 9, 8 }
multiline_comment|/* FPGA Primecells */
id|AMBA_DEVICE
c_func
(paren
id|aaci
comma
l_string|&quot;fpga:04&quot;
comma
id|AACI
comma
l_int|NULL
)paren
suffix:semicolon
id|AMBA_DEVICE
c_func
(paren
id|mmc0
comma
l_string|&quot;fpga:05&quot;
comma
id|MMCI0
comma
op_amp
id|mmc0_plat_data
)paren
suffix:semicolon
id|AMBA_DEVICE
c_func
(paren
id|kmi0
comma
l_string|&quot;fpga:06&quot;
comma
id|KMI0
comma
l_int|NULL
)paren
suffix:semicolon
id|AMBA_DEVICE
c_func
(paren
id|kmi1
comma
l_string|&quot;fpga:07&quot;
comma
id|KMI1
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* DevChip Primecells */
id|AMBA_DEVICE
c_func
(paren
id|smc
comma
l_string|&quot;dev:00&quot;
comma
id|SMC
comma
l_int|NULL
)paren
suffix:semicolon
id|AMBA_DEVICE
c_func
(paren
id|mpmc
comma
l_string|&quot;dev:10&quot;
comma
id|MPMC
comma
l_int|NULL
)paren
suffix:semicolon
id|AMBA_DEVICE
c_func
(paren
id|clcd
comma
l_string|&quot;dev:20&quot;
comma
id|CLCD
comma
op_amp
id|clcd_plat_data
)paren
suffix:semicolon
id|AMBA_DEVICE
c_func
(paren
id|dmac
comma
l_string|&quot;dev:30&quot;
comma
id|DMAC
comma
l_int|NULL
)paren
suffix:semicolon
id|AMBA_DEVICE
c_func
(paren
id|sctl
comma
l_string|&quot;dev:e0&quot;
comma
id|SCTL
comma
l_int|NULL
)paren
suffix:semicolon
id|AMBA_DEVICE
c_func
(paren
id|wdog
comma
l_string|&quot;dev:e1&quot;
comma
id|WATCHDOG
comma
l_int|NULL
)paren
suffix:semicolon
id|AMBA_DEVICE
c_func
(paren
id|gpio0
comma
l_string|&quot;dev:e4&quot;
comma
id|GPIO0
comma
l_int|NULL
)paren
suffix:semicolon
id|AMBA_DEVICE
c_func
(paren
id|gpio1
comma
l_string|&quot;dev:e5&quot;
comma
id|GPIO1
comma
l_int|NULL
)paren
suffix:semicolon
id|AMBA_DEVICE
c_func
(paren
id|rtc
comma
l_string|&quot;dev:e8&quot;
comma
id|RTC
comma
l_int|NULL
)paren
suffix:semicolon
id|AMBA_DEVICE
c_func
(paren
id|sci0
comma
l_string|&quot;dev:f0&quot;
comma
id|SCI
comma
l_int|NULL
)paren
suffix:semicolon
id|AMBA_DEVICE
c_func
(paren
id|uart0
comma
l_string|&quot;dev:f1&quot;
comma
id|UART0
comma
l_int|NULL
)paren
suffix:semicolon
id|AMBA_DEVICE
c_func
(paren
id|uart1
comma
l_string|&quot;dev:f2&quot;
comma
id|UART1
comma
l_int|NULL
)paren
suffix:semicolon
id|AMBA_DEVICE
c_func
(paren
id|uart2
comma
l_string|&quot;dev:f3&quot;
comma
id|UART2
comma
l_int|NULL
)paren
suffix:semicolon
id|AMBA_DEVICE
c_func
(paren
id|ssp0
comma
l_string|&quot;dev:f4&quot;
comma
id|SSP
comma
l_int|NULL
)paren
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|amba_device
op_star
id|amba_devs
(braket
)braket
id|__initdata
op_assign
(brace
op_amp
id|dmac_device
comma
op_amp
id|uart0_device
comma
op_amp
id|uart1_device
comma
op_amp
id|uart2_device
comma
op_amp
id|smc_device
comma
op_amp
id|mpmc_device
comma
op_amp
id|clcd_device
comma
op_amp
id|sctl_device
comma
op_amp
id|wdog_device
comma
op_amp
id|gpio0_device
comma
op_amp
id|gpio1_device
comma
op_amp
id|rtc_device
comma
op_amp
id|sci0_device
comma
op_amp
id|ssp0_device
comma
op_amp
id|aaci_device
comma
op_amp
id|mmc0_device
comma
op_amp
id|kmi0_device
comma
op_amp
id|kmi1_device
comma
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_LEDS
DECL|macro|VA_LEDS_BASE
mdefine_line|#define VA_LEDS_BASE (IO_ADDRESS(VERSATILE_SYS_BASE) + VERSATILE_SYS_LED_OFFSET)
DECL|function|versatile_leds_event
r_static
r_void
id|versatile_leds_event
c_func
(paren
id|led_event_t
id|ledevt
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|val
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|VA_LEDS_BASE
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ledevt
)paren
(brace
r_case
id|led_idle_start
suffix:colon
id|val
op_assign
id|val
op_amp
op_complement
id|VERSATILE_SYS_LED0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|led_idle_end
suffix:colon
id|val
op_assign
id|val
op_or
id|VERSATILE_SYS_LED0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|led_timer
suffix:colon
id|val
op_assign
id|val
op_xor
id|VERSATILE_SYS_LED1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|led_halted
suffix:colon
id|val
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|writel
c_func
(paren
id|val
comma
id|VA_LEDS_BASE
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif&t;/* CONFIG_LEDS */
DECL|function|versatile_init
r_void
id|__init
id|versatile_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|clk_register
c_func
(paren
op_amp
id|versatile_clcd_clk
)paren
suffix:semicolon
id|platform_device_register
c_func
(paren
op_amp
id|versatile_flash_device
)paren
suffix:semicolon
id|platform_device_register
c_func
(paren
op_amp
id|smc91x_device
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|amba_devs
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|amba_device
op_star
id|d
op_assign
id|amba_devs
(braket
id|i
)braket
suffix:semicolon
id|amba_device_register
c_func
(paren
id|d
comma
op_amp
id|iomem_resource
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_LEDS
id|leds_event
op_assign
id|versatile_leds_event
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * Where is the timer (VA)?&n; */
DECL|macro|TIMER0_VA_BASE
mdefine_line|#define TIMER0_VA_BASE&t;&t; IO_ADDRESS(VERSATILE_TIMER0_1_BASE)
DECL|macro|TIMER1_VA_BASE
mdefine_line|#define TIMER1_VA_BASE&t;&t;(IO_ADDRESS(VERSATILE_TIMER0_1_BASE) + 0x20)
DECL|macro|TIMER2_VA_BASE
mdefine_line|#define TIMER2_VA_BASE&t;&t; IO_ADDRESS(VERSATILE_TIMER2_3_BASE)
DECL|macro|TIMER3_VA_BASE
mdefine_line|#define TIMER3_VA_BASE&t;&t;(IO_ADDRESS(VERSATILE_TIMER2_3_BASE) + 0x20)
DECL|macro|VA_IC_BASE
mdefine_line|#define VA_IC_BASE&t;&t; IO_ADDRESS(VERSATILE_VIC_BASE) 
multiline_comment|/*&n; * How long is the timer interval?&n; */
DECL|macro|TIMER_INTERVAL
mdefine_line|#define TIMER_INTERVAL&t;(TICKS_PER_uSEC * mSEC_10)
macro_line|#if TIMER_INTERVAL &gt;= 0x100000
DECL|macro|TIMER_RELOAD
mdefine_line|#define TIMER_RELOAD&t;(TIMER_INTERVAL &gt;&gt; 8)&t;&t;/* Divide by 256 */
DECL|macro|TIMER_CTRL
mdefine_line|#define TIMER_CTRL&t;0x88&t;&t;&t;&t;/* Enable, Clock / 256 */
DECL|macro|TICKS2USECS
mdefine_line|#define TICKS2USECS(x)&t;(256 * (x) / TICKS_PER_uSEC)
macro_line|#elif TIMER_INTERVAL &gt;= 0x10000
DECL|macro|TIMER_RELOAD
mdefine_line|#define TIMER_RELOAD&t;(TIMER_INTERVAL &gt;&gt; 4)&t;&t;/* Divide by 16 */
DECL|macro|TIMER_CTRL
mdefine_line|#define TIMER_CTRL&t;0x84&t;&t;&t;&t;/* Enable, Clock / 16 */
DECL|macro|TICKS2USECS
mdefine_line|#define TICKS2USECS(x)&t;(16 * (x) / TICKS_PER_uSEC)
macro_line|#else
DECL|macro|TIMER_RELOAD
mdefine_line|#define TIMER_RELOAD&t;(TIMER_INTERVAL)
DECL|macro|TIMER_CTRL
mdefine_line|#define TIMER_CTRL&t;0x80&t;&t;&t;&t;/* Enable */
DECL|macro|TICKS2USECS
mdefine_line|#define TICKS2USECS(x)&t;((x) / TICKS_PER_uSEC)
macro_line|#endif
DECL|macro|TIMER_CTRL_IE
mdefine_line|#define TIMER_CTRL_IE&t;(1 &lt;&lt; 5)&t;/* Interrupt Enable */
multiline_comment|/*&n; * What does it look like?&n; */
DECL|struct|TimerStruct
r_typedef
r_struct
id|TimerStruct
(brace
DECL|member|TimerLoad
r_int
r_int
id|TimerLoad
suffix:semicolon
DECL|member|TimerValue
r_int
r_int
id|TimerValue
suffix:semicolon
DECL|member|TimerControl
r_int
r_int
id|TimerControl
suffix:semicolon
DECL|member|TimerClear
r_int
r_int
id|TimerClear
suffix:semicolon
DECL|typedef|TimerStruct_t
)brace
id|TimerStruct_t
suffix:semicolon
multiline_comment|/*&n; * Returns number of ms since last clock interrupt.  Note that interrupts&n; * will have been disabled by do_gettimeoffset()&n; */
DECL|function|versatile_gettimeoffset
r_static
r_int
r_int
id|versatile_gettimeoffset
c_func
(paren
r_void
)paren
(brace
r_volatile
id|TimerStruct_t
op_star
id|timer0
op_assign
(paren
id|TimerStruct_t
op_star
)paren
id|TIMER0_VA_BASE
suffix:semicolon
r_int
r_int
id|ticks1
comma
id|ticks2
comma
id|status
suffix:semicolon
multiline_comment|/*&n;&t; * Get the current number of ticks.  Note that there is a race&n;&t; * condition between us reading the timer and checking for&n;&t; * an interrupt.  We get around this by ensuring that the&n;&t; * counter has not reloaded between our two reads.&n;&t; */
id|ticks2
op_assign
id|timer0-&gt;TimerValue
op_amp
l_int|0xffff
suffix:semicolon
r_do
(brace
id|ticks1
op_assign
id|ticks2
suffix:semicolon
id|status
op_assign
id|__raw_readl
c_func
(paren
id|VA_IC_BASE
op_plus
id|VIC_IRQ_RAW_STATUS
)paren
suffix:semicolon
id|ticks2
op_assign
id|timer0-&gt;TimerValue
op_amp
l_int|0xffff
suffix:semicolon
)brace
r_while
c_loop
(paren
id|ticks2
OG
id|ticks1
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Number of ticks since last interrupt.&n;&t; */
id|ticks1
op_assign
id|TIMER_RELOAD
op_minus
id|ticks2
suffix:semicolon
multiline_comment|/*&n;&t; * Interrupt pending?  If so, we&squot;ve reloaded once already.&n;&t; *&n;&t; * FIXME: Need to check this is effectively timer 0 that expires&n;&t; */
r_if
c_cond
(paren
id|status
op_amp
id|IRQMASK_TIMERINT0_1
)paren
id|ticks1
op_add_assign
id|TIMER_RELOAD
suffix:semicolon
multiline_comment|/*&n;&t; * Convert the ticks to usecs&n;&t; */
r_return
id|TICKS2USECS
c_func
(paren
id|ticks1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * IRQ handler for the timer&n; */
DECL|function|versatile_timer_interrupt
r_static
id|irqreturn_t
id|versatile_timer_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_volatile
id|TimerStruct_t
op_star
id|timer0
op_assign
(paren
r_volatile
id|TimerStruct_t
op_star
)paren
id|TIMER0_VA_BASE
suffix:semicolon
id|write_seqlock
c_func
(paren
op_amp
id|xtime_lock
)paren
suffix:semicolon
singleline_comment|// ...clear the interrupt
id|timer0-&gt;TimerClear
op_assign
l_int|1
suffix:semicolon
id|timer_tick
c_func
(paren
id|regs
)paren
suffix:semicolon
id|write_sequnlock
c_func
(paren
op_amp
id|xtime_lock
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|variable|versatile_timer_irq
r_static
r_struct
id|irqaction
id|versatile_timer_irq
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;Versatile Timer Tick&quot;
comma
dot
id|flags
op_assign
id|SA_INTERRUPT
comma
dot
id|handler
op_assign
id|versatile_timer_interrupt
)brace
suffix:semicolon
multiline_comment|/*&n; * Set up timer interrupt, and return the current time in seconds.&n; */
DECL|function|versatile_timer_init
r_static
r_void
id|__init
id|versatile_timer_init
c_func
(paren
r_void
)paren
(brace
r_volatile
id|TimerStruct_t
op_star
id|timer0
op_assign
(paren
r_volatile
id|TimerStruct_t
op_star
)paren
id|TIMER0_VA_BASE
suffix:semicolon
r_volatile
id|TimerStruct_t
op_star
id|timer1
op_assign
(paren
r_volatile
id|TimerStruct_t
op_star
)paren
id|TIMER1_VA_BASE
suffix:semicolon
r_volatile
id|TimerStruct_t
op_star
id|timer2
op_assign
(paren
r_volatile
id|TimerStruct_t
op_star
)paren
id|TIMER2_VA_BASE
suffix:semicolon
r_volatile
id|TimerStruct_t
op_star
id|timer3
op_assign
(paren
r_volatile
id|TimerStruct_t
op_star
)paren
id|TIMER3_VA_BASE
suffix:semicolon
multiline_comment|/* &n;&t; * set clock frequency: &n;&t; *&t;VERSATILE_REFCLK is 32KHz&n;&t; *&t;VERSATILE_TIMCLK is 1MHz&n;&t; */
op_star
(paren
r_volatile
r_int
r_int
op_star
)paren
id|IO_ADDRESS
c_func
(paren
id|VERSATILE_SCTL_BASE
)paren
op_or_assign
(paren
(paren
id|VERSATILE_TIMCLK
op_lshift
id|VERSATILE_TIMER1_EnSel
)paren
op_or
(paren
id|VERSATILE_TIMCLK
op_lshift
id|VERSATILE_TIMER2_EnSel
)paren
op_or
(paren
id|VERSATILE_TIMCLK
op_lshift
id|VERSATILE_TIMER3_EnSel
)paren
op_or
(paren
id|VERSATILE_TIMCLK
op_lshift
id|VERSATILE_TIMER4_EnSel
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Initialise to a known state (all timers off)&n;&t; */
id|timer0-&gt;TimerControl
op_assign
l_int|0
suffix:semicolon
id|timer1-&gt;TimerControl
op_assign
l_int|0
suffix:semicolon
id|timer2-&gt;TimerControl
op_assign
l_int|0
suffix:semicolon
id|timer3-&gt;TimerControl
op_assign
l_int|0
suffix:semicolon
id|timer0-&gt;TimerLoad
op_assign
id|TIMER_RELOAD
suffix:semicolon
id|timer0-&gt;TimerValue
op_assign
id|TIMER_RELOAD
suffix:semicolon
id|timer0-&gt;TimerControl
op_assign
id|TIMER_CTRL
op_or
l_int|0x40
op_or
id|TIMER_CTRL_IE
suffix:semicolon
multiline_comment|/* periodic + IE */
multiline_comment|/* &n;&t; * Make irqs happen for the system timer&n;&t; */
id|setup_irq
c_func
(paren
id|IRQ_TIMERINT0_1
comma
op_amp
id|versatile_timer_irq
)paren
suffix:semicolon
)brace
DECL|variable|versatile_timer
r_struct
id|sys_timer
id|versatile_timer
op_assign
(brace
dot
id|init
op_assign
id|versatile_timer_init
comma
dot
id|offset
op_assign
id|versatile_gettimeoffset
comma
)brace
suffix:semicolon
eof
