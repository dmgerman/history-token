multiline_comment|/*&n; * arch/arm/mach-iop3xx/iop321-pci.c&n; *&n; * PCI support for the Intel IOP321 chipset&n; *&n; * Author: Rory Bolt &lt;rorybolt@pacbell.net&gt;&n; * Copyright (C) 2002 Rory Bolt&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/mach/pci.h&gt;
macro_line|#include &lt;asm/arch/iop321.h&gt;
singleline_comment|// #define DEBUG
macro_line|#ifdef DEBUG
DECL|macro|DBG
mdefine_line|#define  DBG(x...) printk(x)
macro_line|#else
DECL|macro|DBG
mdefine_line|#define  DBG(x...) do { } while (0)
macro_line|#endif
multiline_comment|/*&n; * This routine builds either a type0 or type1 configuration command.  If the&n; * bus is on the 80321 then a type0 made, else a type1 is created.&n; */
DECL|function|iop321_cfg_address
r_static
id|u32
id|iop321_cfg_address
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
id|devfn
comma
r_int
id|where
)paren
(brace
r_struct
id|pci_sys_data
op_star
id|sys
op_assign
id|bus-&gt;sysdata
suffix:semicolon
id|u32
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|sys-&gt;busnr
op_eq
id|bus-&gt;number
)paren
id|addr
op_assign
l_int|1
op_lshift
(paren
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
op_plus
l_int|16
)paren
suffix:semicolon
r_else
id|addr
op_assign
id|bus-&gt;number
op_lshift
l_int|16
op_or
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
op_lshift
l_int|11
op_or
l_int|1
suffix:semicolon
id|addr
op_or_assign
id|PCI_FUNC
c_func
(paren
id|devfn
)paren
op_lshift
l_int|8
op_or
(paren
id|where
op_amp
op_complement
l_int|3
)paren
suffix:semicolon
r_return
id|addr
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine checks the status of the last configuration cycle.  If an error&n; * was detected it returns a 1, else it returns a 0.  The errors being checked&n; * are parity, master abort, target abort (master and target).  These types of&n; * errors occure during a config cycle where there is no device, like during&n; * the discovery stage.&n; */
DECL|function|iop321_pci_status
r_static
r_int
id|iop321_pci_status
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|status
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Check the status registers.&n;&t; */
id|status
op_assign
op_star
id|IOP321_ATUSR
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0xf900
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;&bslash;t&bslash;t&bslash;tPCI: P0 - status = 0x%08x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
op_star
id|IOP321_ATUSR
op_assign
id|status
op_amp
l_int|0xf900
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
id|status
op_assign
op_star
id|IOP321_ATUISR
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x679f
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;&bslash;t&bslash;t&bslash;tPCI: P1 - status = 0x%08x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
op_star
id|IOP321_ATUISR
op_assign
id|status
op_amp
l_int|0x679f
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Simply write the address register and read the configuration&n; * data.  Note that the 4 nop&squot;s ensure that we are able to handle&n; * a delayed abort (in theory.)&n; */
DECL|function|iop321_read
r_static
r_inline
id|u32
id|iop321_read
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
id|u32
id|val
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;str&t;%1, [%2]&bslash;n&bslash;t&quot;
l_string|&quot;ldr&t;%0, [%3]&bslash;n&bslash;t&quot;
l_string|&quot;nop&bslash;n&bslash;t&quot;
l_string|&quot;nop&bslash;n&bslash;t&quot;
l_string|&quot;nop&bslash;n&bslash;t&quot;
l_string|&quot;nop&bslash;n&bslash;t&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|val
)paren
suffix:colon
l_string|&quot;r&quot;
(paren
id|addr
)paren
comma
l_string|&quot;r&quot;
(paren
id|IOP321_OCCAR
)paren
comma
l_string|&quot;r&quot;
(paren
id|IOP321_OCCDR
)paren
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
multiline_comment|/*&n; * The read routines must check the error status of the last configuration&n; * cycle.  If there was an error, the routine returns all hex f&squot;s.&n; */
r_static
r_int
DECL|function|iop321_read_config
id|iop321_read_config
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
op_star
id|value
)paren
(brace
r_int
r_int
id|addr
op_assign
id|iop321_cfg_address
c_func
(paren
id|bus
comma
id|devfn
comma
id|where
)paren
suffix:semicolon
id|u32
id|val
op_assign
id|iop321_read
c_func
(paren
id|addr
)paren
op_rshift
(paren
(paren
id|where
op_amp
l_int|3
)paren
op_star
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iop321_pci_status
c_func
(paren
)paren
)paren
(brace
id|val
op_assign
l_int|0xffffffff
suffix:semicolon
)brace
op_star
id|value
op_assign
id|val
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
r_static
r_int
DECL|function|iop321_write_config
id|iop321_write_config
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
id|value
)paren
(brace
r_int
r_int
id|addr
op_assign
id|iop321_cfg_address
c_func
(paren
id|bus
comma
id|devfn
comma
id|where
)paren
suffix:semicolon
id|u32
id|val
suffix:semicolon
r_if
c_cond
(paren
id|size
op_ne
l_int|4
)paren
(brace
id|val
op_assign
id|iop321_read
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iop321_pci_status
c_func
(paren
)paren
op_eq
l_int|0
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
id|where
op_assign
(paren
id|where
op_amp
l_int|3
)paren
op_star
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|size
op_eq
l_int|1
)paren
id|val
op_and_assign
op_complement
(paren
l_int|0xff
op_lshift
id|where
)paren
suffix:semicolon
r_else
id|val
op_and_assign
op_complement
(paren
l_int|0xffff
op_lshift
id|where
)paren
suffix:semicolon
op_star
id|IOP321_OCCDR
op_assign
id|val
op_or
id|value
op_lshift
id|where
suffix:semicolon
)brace
r_else
(brace
id|asm
r_volatile
(paren
l_string|&quot;str&t;%1, [%2]&bslash;n&bslash;t&quot;
l_string|&quot;str&t;%0, [%3]&bslash;n&bslash;t&quot;
l_string|&quot;nop&bslash;n&bslash;t&quot;
l_string|&quot;nop&bslash;n&bslash;t&quot;
l_string|&quot;nop&bslash;n&bslash;t&quot;
l_string|&quot;nop&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|value
)paren
comma
l_string|&quot;r&quot;
(paren
id|addr
)paren
comma
l_string|&quot;r&quot;
(paren
id|IOP321_OCCAR
)paren
comma
l_string|&quot;r&quot;
(paren
id|IOP321_OCCDR
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|variable|iop321_ops
r_static
r_struct
id|pci_ops
id|iop321_ops
op_assign
(brace
dot
id|read
op_assign
id|iop321_read_config
comma
dot
id|write
op_assign
id|iop321_write_config
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * When a PCI device does not exist during config cycles, the 80200 gets a&n; * bus error instead of returning 0xffffffff. This handler simply returns.&n; */
r_int
DECL|function|iop321_pci_abort
id|iop321_pci_abort
c_func
(paren
r_int
r_int
id|addr
comma
r_int
r_int
id|fsr
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;PCI abort: address = 0x%08lx fsr = 0x%03x PC = 0x%08lx LR = 0x%08lx&bslash;n&quot;
comma
id|addr
comma
id|fsr
comma
id|regs-&gt;ARM_pc
comma
id|regs-&gt;ARM_lr
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If it was an imprecise abort, then we need to correct the&n;&t; * return address to be _after_ the instruction.&n;&t; */
r_if
c_cond
(paren
id|fsr
op_amp
(paren
l_int|1
op_lshift
l_int|10
)paren
)paren
id|regs-&gt;ARM_pc
op_add_assign
l_int|4
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Scan an IOP321 PCI bus.  sys-&gt;bus defines which bus we scan.&n; */
DECL|function|iop321_scan_bus
r_struct
id|pci_bus
op_star
id|iop321_scan_bus
c_func
(paren
r_int
id|nr
comma
r_struct
id|pci_sys_data
op_star
id|sys
)paren
(brace
r_return
id|pci_scan_bus
c_func
(paren
id|sys-&gt;busnr
comma
op_amp
id|iop321_ops
comma
id|sys
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Setup the system data for controller &squot;nr&squot;.   Return 0 if none found,&n; * 1 if found, or negative error.&n; */
DECL|function|iop321_setup
r_int
id|iop321_setup
c_func
(paren
r_int
id|nr
comma
r_struct
id|pci_sys_data
op_star
id|sys
)paren
(brace
r_struct
id|resource
op_star
id|res
suffix:semicolon
r_if
c_cond
(paren
id|nr
op_ge
l_int|1
)paren
r_return
l_int|0
suffix:semicolon
id|res
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|resource
)paren
op_star
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
id|panic
c_func
(paren
l_string|&quot;PCI: unable to alloc resources&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
id|res
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|resource
)paren
op_star
l_int|2
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|nr
)paren
(brace
r_case
l_int|0
suffix:colon
id|res
(braket
l_int|0
)braket
dot
id|start
op_assign
id|IOP321_PCI_LOWER_IO
op_plus
l_int|0x6e000000
suffix:semicolon
id|res
(braket
l_int|0
)braket
dot
id|end
op_assign
id|IOP321_PCI_LOWER_IO
op_plus
l_int|0x6e00ffff
suffix:semicolon
id|res
(braket
l_int|0
)braket
dot
id|name
op_assign
l_string|&quot;PCI IO Primary&quot;
suffix:semicolon
id|res
(braket
l_int|0
)braket
dot
id|flags
op_assign
id|IORESOURCE_IO
suffix:semicolon
id|res
(braket
l_int|1
)braket
dot
id|start
op_assign
id|IOP321_PCI_LOWER_MEM
suffix:semicolon
id|res
(braket
l_int|1
)braket
dot
id|end
op_assign
id|IOP321_PCI_LOWER_MEM
op_plus
id|IOP321_PCI_WINDOW_SIZE
suffix:semicolon
id|res
(braket
l_int|1
)braket
dot
id|name
op_assign
l_string|&quot;PCI Memory Primary&quot;
suffix:semicolon
id|res
(braket
l_int|1
)braket
dot
id|flags
op_assign
id|IORESOURCE_MEM
suffix:semicolon
r_break
suffix:semicolon
)brace
id|request_resource
c_func
(paren
op_amp
id|ioport_resource
comma
op_amp
id|res
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|request_resource
c_func
(paren
op_amp
id|iomem_resource
comma
op_amp
id|res
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|sys-&gt;resource
(braket
l_int|0
)braket
op_assign
op_amp
id|res
(braket
l_int|0
)braket
suffix:semicolon
id|sys-&gt;resource
(braket
l_int|1
)braket
op_assign
op_amp
id|res
(braket
l_int|1
)braket
suffix:semicolon
id|sys-&gt;resource
(braket
l_int|2
)braket
op_assign
l_int|NULL
suffix:semicolon
id|sys-&gt;io_offset
op_assign
l_int|0x6e000000
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|iop321_init
r_void
id|iop321_init
c_func
(paren
r_void
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;PCI:  Intel 80321 PCI init code.&bslash;n&quot;
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;&bslash;tATU: IOP321_ATUCMD=0x%04x&bslash;n&quot;
comma
op_star
id|IOP321_ATUCMD
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;&bslash;tATU: IOP321_OMWTVR0=0x%04x, IOP321_OIOWTVR=0x%04x&bslash;n&quot;
comma
op_star
id|IOP321_OMWTVR0
comma
op_star
id|IOP321_OIOWTVR
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;&bslash;tATU: IOP321_ATUCR=0x%08x&bslash;n&quot;
comma
op_star
id|IOP321_ATUCR
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;&bslash;tATU: IOP321_IABAR0=0x%08x IOP321_IALR0=0x%08x IOP321_IATVR0=%08x&bslash;n&quot;
comma
op_star
id|IOP321_IABAR0
comma
op_star
id|IOP321_IALR0
comma
op_star
id|IOP321_IATVR0
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;&bslash;tATU: IOP321_ERBAR=0x%08x IOP321_ERLR=0x%08x IOP321_ERTVR=%08x&bslash;n&quot;
comma
op_star
id|IOP321_ERBAR
comma
op_star
id|IOP321_ERLR
comma
op_star
id|IOP321_ERTVR
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;&bslash;tATU: IOP321_IABAR2=0x%08x IOP321_IALR2=0x%08x IOP321_IATVR2=%08x&bslash;n&quot;
comma
op_star
id|IOP321_IABAR2
comma
op_star
id|IOP321_IALR2
comma
op_star
id|IOP321_IATVR2
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;&bslash;tATU: IOP321_IABAR3=0x%08x IOP321_IALR3=0x%08x IOP321_IATVR3=%08x&bslash;n&quot;
comma
op_star
id|IOP321_IABAR3
comma
op_star
id|IOP321_IALR3
comma
op_star
id|IOP321_IATVR3
)paren
suffix:semicolon
id|hook_fault_code
c_func
(paren
l_int|16
op_plus
l_int|6
comma
id|iop321_pci_abort
comma
id|SIGBUS
comma
l_string|&quot;imprecise external abort&quot;
)paren
suffix:semicolon
)brace
eof
