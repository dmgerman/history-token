multiline_comment|/*&n; * linux/arch/arm/mach-iop3xx/iop331-irq.c&n; *&n; * Generic IOP331 IRQ handling functionality&n; *&n; * Author: Dave Jiang &lt;dave.jiang@intel.com&gt;&n; * Copyright (C) 2003 Intel Corp.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; *&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;asm/mach/irq.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/mach-types.h&gt;
DECL|variable|iop331_mask0
r_static
id|u32
id|iop331_mask0
op_assign
l_int|0
suffix:semicolon
DECL|variable|iop331_mask1
r_static
id|u32
id|iop331_mask1
op_assign
l_int|0
suffix:semicolon
DECL|function|intctl_write0
r_static
r_inline
r_void
id|intctl_write0
c_func
(paren
id|u32
id|val
)paren
(brace
singleline_comment|// INTCTL0
id|asm
r_volatile
(paren
l_string|&quot;mcr p6,0,%0,c0,c0,0&quot;
op_scope_resolution
l_string|&quot;r&quot;
(paren
id|val
)paren
)paren
suffix:semicolon
)brace
DECL|function|intctl_write1
r_static
r_inline
r_void
id|intctl_write1
c_func
(paren
id|u32
id|val
)paren
(brace
singleline_comment|// INTCTL1
id|asm
r_volatile
(paren
l_string|&quot;mcr p6,0,%0,c1,c0,0&quot;
op_scope_resolution
l_string|&quot;r&quot;
(paren
id|val
)paren
)paren
suffix:semicolon
)brace
DECL|function|intstr_write0
r_static
r_inline
r_void
id|intstr_write0
c_func
(paren
id|u32
id|val
)paren
(brace
singleline_comment|// INTSTR0
id|asm
r_volatile
(paren
l_string|&quot;mcr p6,0,%0,c2,c0,0&quot;
op_scope_resolution
l_string|&quot;r&quot;
(paren
id|val
)paren
)paren
suffix:semicolon
)brace
DECL|function|intstr_write1
r_static
r_inline
r_void
id|intstr_write1
c_func
(paren
id|u32
id|val
)paren
(brace
singleline_comment|// INTSTR1
id|asm
r_volatile
(paren
l_string|&quot;mcr p6,0,%0,c3,c0,0&quot;
op_scope_resolution
l_string|&quot;r&quot;
(paren
id|val
)paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|iop331_irq_mask1
id|iop331_irq_mask1
(paren
r_int
r_int
id|irq
)paren
(brace
id|iop331_mask0
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|irq
op_minus
id|IOP331_IRQ_OFS
)paren
)paren
suffix:semicolon
id|intctl_write0
c_func
(paren
id|iop331_mask0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|iop331_irq_mask2
id|iop331_irq_mask2
(paren
r_int
r_int
id|irq
)paren
(brace
id|iop331_mask1
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|irq
op_minus
id|IOP331_IRQ_OFS
op_minus
l_int|32
)paren
)paren
suffix:semicolon
id|intctl_write1
c_func
(paren
id|iop331_mask1
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|iop331_irq_unmask1
id|iop331_irq_unmask1
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|iop331_mask0
op_or_assign
(paren
l_int|1
op_lshift
(paren
id|irq
op_minus
id|IOP331_IRQ_OFS
)paren
)paren
suffix:semicolon
id|intctl_write0
c_func
(paren
id|iop331_mask0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|iop331_irq_unmask2
id|iop331_irq_unmask2
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|iop331_mask1
op_or_assign
(paren
l_int|1
op_lshift
(paren
id|irq
op_minus
id|IOP331_IRQ_OFS
op_minus
l_int|32
)paren
)paren
suffix:semicolon
id|intctl_write1
c_func
(paren
id|iop331_mask1
)paren
suffix:semicolon
)brace
DECL|variable|iop331_irqchip1
r_struct
id|irqchip
id|iop331_irqchip1
op_assign
(brace
dot
id|ack
op_assign
id|iop331_irq_mask1
comma
dot
id|mask
op_assign
id|iop331_irq_mask1
comma
dot
id|unmask
op_assign
id|iop331_irq_unmask1
comma
)brace
suffix:semicolon
DECL|variable|iop331_irqchip2
r_struct
id|irqchip
id|iop331_irqchip2
op_assign
(brace
dot
id|ack
op_assign
id|iop331_irq_mask2
comma
dot
id|mask
op_assign
id|iop331_irq_mask2
comma
dot
id|unmask
op_assign
id|iop331_irq_unmask2
comma
)brace
suffix:semicolon
DECL|function|iop331_init_irq
r_void
id|__init
id|iop331_init_irq
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|i
comma
id|tmp
suffix:semicolon
multiline_comment|/* Enable access to coprocessor 6 for dealing with IRQs.&n;&t; * From RMK:&n;&t; * Basically, the Intel documentation here is poor.  It appears that&n;&t; * you need to set the bit to be able to access the coprocessor from&n;&t; * SVC mode.  Whether that allows access from user space or not is&n;&t; * unclear.&n;&t; */
id|asm
r_volatile
(paren
l_string|&quot;mrc p15, 0, %0, c15, c1, 0&bslash;n&bslash;t&quot;
l_string|&quot;orr %0, %0, %1&bslash;n&bslash;t&quot;
l_string|&quot;mcr p15, 0, %0, c15, c1, 0&bslash;n&bslash;t&quot;
multiline_comment|/* The action is delayed, so we have to do this: */
l_string|&quot;mrc p15, 0, %0, c15, c1, 0&bslash;n&bslash;t&quot;
l_string|&quot;mov %0, %0&bslash;n&bslash;t&quot;
l_string|&quot;sub pc, pc, #4&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|tmp
)paren
suffix:colon
l_string|&quot;i&quot;
(paren
l_int|1
op_lshift
l_int|6
)paren
)paren
suffix:semicolon
id|intctl_write0
c_func
(paren
l_int|0
)paren
suffix:semicolon
singleline_comment|// disable all interrupts
id|intctl_write1
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|intstr_write0
c_func
(paren
l_int|0
)paren
suffix:semicolon
singleline_comment|// treat all as IRQ
id|intstr_write1
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|machine_is_iq80331
c_func
(paren
)paren
)paren
(brace
singleline_comment|// all interrupts are inputs to chip
op_star
id|IOP331_PCIIRSR
op_assign
l_int|0x0f
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|IOP331_IRQ_OFS
suffix:semicolon
id|i
OL
id|NR_IOP331_IRQS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|set_irq_chip
c_func
(paren
id|i
comma
(paren
id|i
OL
l_int|32
)paren
ques
c_cond
op_amp
id|iop331_irqchip1
suffix:colon
op_amp
id|iop331_irqchip2
)paren
suffix:semicolon
id|set_irq_handler
c_func
(paren
id|i
comma
id|do_level_IRQ
)paren
suffix:semicolon
id|set_irq_flags
c_func
(paren
id|i
comma
id|IRQF_VALID
op_or
id|IRQF_PROBE
)paren
suffix:semicolon
)brace
)brace
eof
