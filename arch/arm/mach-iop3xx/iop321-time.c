multiline_comment|/*&n; * arch/arm/mach-iop3xx/iop321-time.c&n; *&n; * Timer code for IOP321 based systems&n; *&n; * Author: Deepak Saxena &lt;dsaxena@mvista.com&gt;&n; *&n; * Copyright 2002-2003 MontaVista Software Inc.&n; *&n; *  This program is free software; you can redistribute  it and/or modify it&n; *  under  the terms of  the GNU General  Public License as published by the&n; *  Free Software Foundation;  either version 2 of the  License, or (at your&n; *  option) any later version.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/timex.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/mach-types.h&gt;
macro_line|#include &lt;asm/mach/irq.h&gt;
macro_line|#include &lt;asm/mach/time.h&gt;
DECL|macro|IOP321_TIME_SYNC
mdefine_line|#define IOP321_TIME_SYNC 0
DECL|variable|iop321_latch
r_static
r_int
r_int
id|iop321_latch
suffix:semicolon
DECL|function|get_elapsed
r_static
r_inline
r_int
r_int
id|get_elapsed
c_func
(paren
r_void
)paren
(brace
r_return
id|iop321_latch
op_minus
op_star
id|IOP321_TU_TCR0
suffix:semicolon
)brace
DECL|function|iop321_gettimeoffset
r_static
r_int
r_int
id|iop321_gettimeoffset
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|elapsed
comma
id|usec
suffix:semicolon
id|u32
id|tisr1
comma
id|tisr2
suffix:semicolon
multiline_comment|/*&n;&t; * If an interrupt was pending before we read the timer,&n;&t; * we&squot;ve already wrapped.  Factor this into the time.&n;&t; * If an interrupt was pending after we read the timer,&n;&t; * it may have wrapped between checking the interrupt&n;&t; * status and reading the timer.  Re-read the timer to&n;&t; * be sure its value is after the wrap.&n;&t; */
id|asm
r_volatile
(paren
l_string|&quot;mrc p6, 0, %0, c6, c1, 0&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|tisr1
)paren
)paren
suffix:semicolon
id|elapsed
op_assign
id|get_elapsed
c_func
(paren
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;mrc p6, 0, %0, c6, c1, 0&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|tisr2
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tisr1
op_amp
l_int|1
)paren
(brace
id|elapsed
op_add_assign
id|iop321_latch
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tisr2
op_amp
l_int|1
)paren
id|elapsed
op_assign
id|iop321_latch
op_plus
id|get_elapsed
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Now convert them to usec.&n;&t; */
id|usec
op_assign
(paren
r_int
r_int
)paren
(paren
id|elapsed
op_star
(paren
id|tick_nsec
op_div
l_int|1000
)paren
)paren
op_div
id|iop321_latch
suffix:semicolon
r_return
id|usec
suffix:semicolon
)brace
r_static
id|irqreturn_t
DECL|function|iop321_timer_interrupt
id|iop321_timer_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|u32
id|tisr
suffix:semicolon
macro_line|#ifdef IOP321_TIME_SYNC
id|u32
id|passed
suffix:semicolon
DECL|macro|TM_THRESH
mdefine_line|#define TM_THRESH (iop321_latch*2)
macro_line|#endif
id|asm
r_volatile
(paren
l_string|&quot;mrc p6, 0, %0, c6, c1, 0&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|tisr
)paren
)paren
suffix:semicolon
id|tisr
op_or_assign
l_int|1
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;mcr p6, 0, %0, c6, c1, 0&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|tisr
)paren
)paren
suffix:semicolon
macro_line|#ifdef IOP321_TIME_SYNC
id|passed
op_assign
l_int|0xffffffff
op_minus
op_star
id|IOP321_TU_TCR1
suffix:semicolon
r_do
(brace
id|do_timer
c_func
(paren
id|regs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|passed
OL
id|TM_THRESH
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|passed
OG
id|iop321_latch
)paren
(brace
id|passed
op_sub_assign
id|iop321_latch
suffix:semicolon
)brace
r_else
id|passed
op_assign
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
(brace
suffix:semicolon
)brace
id|asm
r_volatile
(paren
l_string|&quot;mcr p6, 0, %0, c3, c1, 0&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
l_int|0xffffffff
)paren
)paren
suffix:semicolon
macro_line|#else
id|do_timer
c_func
(paren
id|regs
)paren
suffix:semicolon
macro_line|#endif
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|variable|iop321_timer_irq
r_static
r_struct
id|irqaction
id|iop321_timer_irq
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;IOP321 Timer Tick&quot;
comma
dot
id|handler
op_assign
id|iop321_timer_interrupt
comma
dot
id|flags
op_assign
id|SA_INTERRUPT
)brace
suffix:semicolon
DECL|function|iop321_timer_init
r_static
r_void
id|__init
id|iop321_timer_init
c_func
(paren
r_void
)paren
(brace
id|u32
id|timer_ctl
suffix:semicolon
id|iop321_latch
op_assign
(paren
id|CLOCK_TICK_RATE
op_plus
id|HZ
op_div
l_int|2
)paren
op_div
id|HZ
suffix:semicolon
id|setup_irq
c_func
(paren
id|IRQ_IOP321_TIMER0
comma
op_amp
id|iop321_timer_irq
)paren
suffix:semicolon
id|timer_ctl
op_assign
id|IOP321_TMR_EN
op_or
id|IOP321_TMR_PRIVILEGED
op_or
id|IOP321_TMR_RELOAD
op_or
id|IOP321_TMR_RATIO_1_1
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;mcr p6, 0, %0, c4, c1, 0&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|iop321_latch
)paren
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;mcr p6, 0, %0, c0, c1, 0&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|timer_ctl
)paren
)paren
suffix:semicolon
macro_line|#ifdef IOP321_TIME_SYNC
multiline_comment|/* Setup second timer */
multiline_comment|/* setup counter */
id|timer_ctl
op_assign
id|IOP321_TMR_EN
op_or
id|IOP321_TMR_PRIVILEGED
op_or
id|IOP321_TMR_RATIO_1_1
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;mcr p6, 0, %0, c3, c1, 0&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
l_int|0xffffffff
)paren
)paren
suffix:semicolon
multiline_comment|/* setup control */
id|asm
r_volatile
(paren
l_string|&quot;mcr p6, 0, %0, c1, c1, 0&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|timer_ctl
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|variable|iop321_timer
r_struct
id|sys_timer
id|iop321_timer
op_assign
(brace
dot
id|init
op_assign
op_amp
id|iop321_timer_init
comma
dot
id|offset
op_assign
id|iop321_gettimeoffset
comma
)brace
suffix:semicolon
eof
