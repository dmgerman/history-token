multiline_comment|/*&n; * linux/arch/arm/mach-iop3xx/iop321-irq.c&n; *&n; * Generic IOP321 IRQ handling functionality&n; *&n; * Author: Rory Bolt &lt;rorybolt@pacbell.net&gt;&n; * Copyright (C) 2002 Rory Bolt&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; * Added IOP3XX chipset and IQ80321 board masking code.&n; *&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;asm/mach/irq.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/mach-types.h&gt;
DECL|variable|iop321_mask
r_static
id|u32
id|iop321_mask
multiline_comment|/* = 0 */
suffix:semicolon
DECL|function|intctl_write
r_static
r_inline
r_void
id|intctl_write
c_func
(paren
id|u32
id|val
)paren
(brace
id|asm
r_volatile
(paren
l_string|&quot;mcr p6,0,%0,c0,c0,0&quot;
op_scope_resolution
l_string|&quot;r&quot;
(paren
id|val
)paren
)paren
suffix:semicolon
)brace
DECL|function|intstr_write
r_static
r_inline
r_void
id|intstr_write
c_func
(paren
id|u32
id|val
)paren
(brace
id|asm
r_volatile
(paren
l_string|&quot;mcr p6,0,%0,c4,c0,0&quot;
op_scope_resolution
l_string|&quot;r&quot;
(paren
id|val
)paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|iop321_irq_mask
id|iop321_irq_mask
(paren
r_int
r_int
id|irq
)paren
(brace
id|iop321_mask
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|irq
op_minus
id|IOP321_IRQ_OFS
)paren
)paren
suffix:semicolon
id|intctl_write
c_func
(paren
id|iop321_mask
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|iop321_irq_unmask
id|iop321_irq_unmask
(paren
r_int
r_int
id|irq
)paren
(brace
id|iop321_mask
op_or_assign
(paren
l_int|1
op_lshift
(paren
id|irq
op_minus
id|IOP321_IRQ_OFS
)paren
)paren
suffix:semicolon
id|intctl_write
c_func
(paren
id|iop321_mask
)paren
suffix:semicolon
)brace
DECL|variable|ext_chip
r_struct
id|irqchip
id|ext_chip
op_assign
(brace
dot
id|ack
op_assign
id|iop321_irq_mask
comma
dot
id|mask
op_assign
id|iop321_irq_mask
comma
dot
id|unmask
op_assign
id|iop321_irq_unmask
comma
)brace
suffix:semicolon
DECL|function|iop321_init_irq
r_void
id|__init
id|iop321_init_irq
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|i
comma
id|tmp
suffix:semicolon
multiline_comment|/* Enable access to coprocessor 6 for dealing with IRQs.&n;&t; * From RMK:&n;&t; * Basically, the Intel documentation here is poor.  It appears that&n;&t; * you need to set the bit to be able to access the coprocessor from&n;&t; * SVC mode.  Whether that allows access from user space or not is&n;&t; * unclear.&n;&t; */
id|asm
r_volatile
(paren
l_string|&quot;mrc p15, 0, %0, c15, c1, 0&bslash;n&bslash;t&quot;
l_string|&quot;orr %0, %0, %1&bslash;n&bslash;t&quot;
l_string|&quot;mcr p15, 0, %0, c15, c1, 0&bslash;n&bslash;t&quot;
multiline_comment|/* The action is delayed, so we have to do this: */
l_string|&quot;mrc p15, 0, %0, c15, c1, 0&bslash;n&bslash;t&quot;
l_string|&quot;mov %0, %0&bslash;n&bslash;t&quot;
l_string|&quot;sub pc, pc, #4&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|tmp
)paren
suffix:colon
l_string|&quot;i&quot;
(paren
l_int|1
op_lshift
l_int|6
)paren
)paren
suffix:semicolon
id|intctl_write
c_func
(paren
l_int|0
)paren
suffix:semicolon
singleline_comment|// disable all interrupts
id|intstr_write
c_func
(paren
l_int|0
)paren
suffix:semicolon
singleline_comment|// treat all as IRQ
r_if
c_cond
(paren
id|machine_is_iq80321
c_func
(paren
)paren
)paren
(brace
singleline_comment|// all interrupts are inputs to chip
op_star
id|IOP321_PCIIRSR
op_assign
l_int|0x0f
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|IOP321_IRQ_OFS
suffix:semicolon
id|i
OL
id|NR_IOP321_IRQS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|set_irq_chip
c_func
(paren
id|i
comma
op_amp
id|ext_chip
)paren
suffix:semicolon
id|set_irq_handler
c_func
(paren
id|i
comma
id|do_level_IRQ
)paren
suffix:semicolon
id|set_irq_flags
c_func
(paren
id|i
comma
id|IRQF_VALID
op_or
id|IRQF_PROBE
)paren
suffix:semicolon
)brace
)brace
eof
