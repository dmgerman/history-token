multiline_comment|/*&n; *  linux/arch/arm/mach-ebsa110/isamem.c&n; *&n; *  Copyright (C) 2001 Russell King&n; *&n; * Perform &quot;ISA&quot; memory and IO accesses.  The EBSA110 has some &quot;peculiarities&quot;&n; * in the way it handles accesses to odd IO ports on 16-bit devices.  These&n; * devices have their D0-D15 lines connected to the processors D0-D15 lines.&n; * Since they expect all byte IO operations to be performed on D0-D7, and the&n; * StrongARM expects to transfer the byte to these odd addresses on D8-D15,&n; * we must use a trick to get the required behaviour.&n; *&n; * The trick employed here is to use long word stores to odd address -1.  The&n; * glue logic picks this up as a &quot;trick&quot; access, and asserts the LSB of the&n; * peripherals address bus, thereby accessing the odd IO port.  Meanwhile, the&n; * StrongARM transfers its data on D0-D7 as expected.&n; *&n; * Things get more interesting on the pass-1 EBSA110 - the PCMCIA controller&n; * wiring was screwed in such a way that it had limited memory space access.&n; * Luckily, the work-around for this is not too horrible.  See&n; * __isamem_convert_addr for the details.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/page.h&gt;
DECL|function|__isamem_convert_addr
r_static
id|u32
id|__isamem_convert_addr
c_func
(paren
r_void
op_star
id|addr
)paren
(brace
id|u32
id|ret
comma
id|a
op_assign
(paren
id|u32
)paren
id|addr
suffix:semicolon
multiline_comment|/*&n;&t; * The PCMCIA controller is wired up as follows:&n;&t; *        +---------+---------+---------+---------+---------+---------+&n;&t; * PCMCIA | 2 2 2 2 | 1 1 1 1 | 1 1 1 1 | 1 1     |         |         |&n;&t; *        | 3 2 1 0 | 9 8 7 6 | 5 4 3 2 | 1 0 9 8 | 7 6 5 4 | 3 2 1 0 |&n;&t; *        +---------+---------+---------+---------+---------+---------+&n;&t; *  CPU   | 2 2 2 2 | 2 1 1 1 | 1 1 1 1 | 1 1 1   |         |         |&n;&t; *        | 4 3 2 1 | 0 9 9 8 | 7 6 5 4 | 3 2 0 9 | 8 7 6 5 | 4 3 2 x |&n;&t; *        +---------+---------+---------+---------+---------+---------+&n;&t; *&n;&t; * This means that we can access PCMCIA regions as follows:&n;&t; *&t;0x*10000 -&gt; 0x*1ffff&n;&t; *&t;0x*70000 -&gt; 0x*7ffff&n;&t; *&t;0x*90000 -&gt; 0x*9ffff&n;&t; *&t;0x*f0000 -&gt; 0x*fffff&n;&t; */
id|ret
op_assign
(paren
id|a
op_amp
l_int|0xf803fe
)paren
op_lshift
l_int|1
suffix:semicolon
id|ret
op_or_assign
(paren
id|a
op_amp
l_int|0x03fc00
)paren
op_lshift
l_int|2
suffix:semicolon
id|ret
op_add_assign
l_int|0xe8000000
suffix:semicolon
r_if
c_cond
(paren
(paren
id|a
op_amp
l_int|0x20000
)paren
op_eq
(paren
id|a
op_amp
l_int|0x40000
)paren
op_rshift
l_int|1
)paren
r_return
id|ret
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * read[bwl] and write[bwl]&n; */
DECL|function|__readb
id|u8
id|__readb
c_func
(paren
r_void
op_star
id|addr
)paren
(brace
id|u32
id|ret
comma
id|a
op_assign
id|__isamem_convert_addr
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|addr
op_amp
l_int|1
)paren
id|ret
op_assign
id|__arch_getl
c_func
(paren
id|a
)paren
suffix:semicolon
r_else
id|ret
op_assign
id|__arch_getb
c_func
(paren
id|a
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|__readw
id|u16
id|__readw
c_func
(paren
r_void
op_star
id|addr
)paren
(brace
id|u32
id|a
op_assign
id|__isamem_convert_addr
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|addr
op_amp
l_int|1
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
id|__arch_getw
c_func
(paren
id|a
)paren
suffix:semicolon
)brace
DECL|function|__readl
id|u32
id|__readl
c_func
(paren
r_void
op_star
id|addr
)paren
(brace
id|u32
id|ret
comma
id|a
op_assign
id|__isamem_convert_addr
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|addr
op_amp
l_int|3
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|ret
op_assign
id|__arch_getw
c_func
(paren
id|a
)paren
suffix:semicolon
id|ret
op_or_assign
id|__arch_getw
c_func
(paren
id|a
op_plus
l_int|4
)paren
op_lshift
l_int|16
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|__readb
id|EXPORT_SYMBOL
c_func
(paren
id|__readb
)paren
suffix:semicolon
DECL|variable|__readw
id|EXPORT_SYMBOL
c_func
(paren
id|__readw
)paren
suffix:semicolon
DECL|variable|__readl
id|EXPORT_SYMBOL
c_func
(paren
id|__readl
)paren
suffix:semicolon
DECL|function|__writeb
r_void
id|__writeb
c_func
(paren
id|u8
id|val
comma
r_void
op_star
id|addr
)paren
(brace
id|u32
id|a
op_assign
id|__isamem_convert_addr
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|addr
op_amp
l_int|1
)paren
id|__arch_putl
c_func
(paren
id|val
comma
id|a
)paren
suffix:semicolon
r_else
id|__arch_putb
c_func
(paren
id|val
comma
id|a
)paren
suffix:semicolon
)brace
DECL|function|__writew
r_void
id|__writew
c_func
(paren
id|u16
id|val
comma
r_void
op_star
id|addr
)paren
(brace
id|u32
id|a
op_assign
id|__isamem_convert_addr
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|addr
op_amp
l_int|1
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|__arch_putw
c_func
(paren
id|val
comma
id|a
)paren
suffix:semicolon
)brace
DECL|function|__writel
r_void
id|__writel
c_func
(paren
id|u32
id|val
comma
r_void
op_star
id|addr
)paren
(brace
id|u32
id|a
op_assign
id|__isamem_convert_addr
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|addr
op_amp
l_int|3
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|__arch_putw
c_func
(paren
id|val
comma
id|a
)paren
suffix:semicolon
id|__arch_putw
c_func
(paren
id|val
op_rshift
l_int|16
comma
id|a
op_plus
l_int|4
)paren
suffix:semicolon
)brace
DECL|variable|__writeb
id|EXPORT_SYMBOL
c_func
(paren
id|__writeb
)paren
suffix:semicolon
DECL|variable|__writew
id|EXPORT_SYMBOL
c_func
(paren
id|__writew
)paren
suffix:semicolon
DECL|variable|__writel
id|EXPORT_SYMBOL
c_func
(paren
id|__writel
)paren
suffix:semicolon
DECL|macro|SUPERIO_PORT
mdefine_line|#define SUPERIO_PORT(p) &bslash;&n;&t;(((p) &gt;&gt; 3) == (0x3f8 &gt;&gt; 3) || &bslash;&n;&t; ((p) &gt;&gt; 3) == (0x2f8 &gt;&gt; 3) || &bslash;&n;&t; ((p) &gt;&gt; 3) == (0x378 &gt;&gt; 3))
DECL|function|__inb
id|u8
id|__inb
c_func
(paren
r_int
id|port
)paren
(brace
id|u32
id|ret
suffix:semicolon
multiline_comment|/*&n;&t; * The SuperIO registers use sane addressing techniques...&n;&t; */
r_if
c_cond
(paren
id|SUPERIO_PORT
c_func
(paren
id|port
)paren
)paren
id|ret
op_assign
id|__arch_getb
c_func
(paren
id|ISAIO_BASE
op_plus
(paren
id|port
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
r_else
(brace
id|u32
id|a
op_assign
id|ISAIO_BASE
op_plus
(paren
(paren
id|port
op_amp
op_complement
l_int|1
)paren
op_lshift
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Shame nothing else does&n;&t;&t; */
r_if
c_cond
(paren
id|port
op_amp
l_int|1
)paren
id|ret
op_assign
id|__arch_getl
c_func
(paren
id|a
)paren
suffix:semicolon
r_else
id|ret
op_assign
id|__arch_getb
c_func
(paren
id|a
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|__inw
id|u16
id|__inw
c_func
(paren
r_int
id|port
)paren
(brace
id|u32
id|ret
suffix:semicolon
multiline_comment|/*&n;&t; * The SuperIO registers use sane addressing techniques...&n;&t; */
r_if
c_cond
(paren
id|SUPERIO_PORT
c_func
(paren
id|port
)paren
)paren
id|ret
op_assign
id|__arch_getw
c_func
(paren
id|ISAIO_BASE
op_plus
(paren
id|port
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
r_else
(brace
id|u32
id|a
op_assign
id|ISAIO_BASE
op_plus
(paren
(paren
id|port
op_amp
op_complement
l_int|1
)paren
op_lshift
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Shame nothing else does&n;&t;&t; */
r_if
c_cond
(paren
id|port
op_amp
l_int|1
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|ret
op_assign
id|__arch_getw
c_func
(paren
id|a
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|__inl
id|u32
id|__inl
c_func
(paren
r_int
id|port
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|__inb
id|EXPORT_SYMBOL
c_func
(paren
id|__inb
)paren
suffix:semicolon
DECL|variable|__inw
id|EXPORT_SYMBOL
c_func
(paren
id|__inw
)paren
suffix:semicolon
DECL|variable|__inl
id|EXPORT_SYMBOL
c_func
(paren
id|__inl
)paren
suffix:semicolon
DECL|function|__outb
r_void
id|__outb
c_func
(paren
id|u8
id|val
comma
r_int
id|port
)paren
(brace
multiline_comment|/*&n;&t; * The SuperIO registers use sane addressing techniques...&n;&t; */
r_if
c_cond
(paren
id|SUPERIO_PORT
c_func
(paren
id|port
)paren
)paren
id|__arch_putb
c_func
(paren
id|val
comma
id|ISAIO_BASE
op_plus
(paren
id|port
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
r_else
(brace
id|u32
id|a
op_assign
id|ISAIO_BASE
op_plus
(paren
(paren
id|port
op_amp
op_complement
l_int|1
)paren
op_lshift
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Shame nothing else does&n;&t;&t; */
r_if
c_cond
(paren
id|port
op_amp
l_int|1
)paren
id|__arch_putl
c_func
(paren
id|val
comma
id|a
)paren
suffix:semicolon
r_else
id|__arch_putb
c_func
(paren
id|val
comma
id|a
)paren
suffix:semicolon
)brace
)brace
DECL|function|__outw
r_void
id|__outw
c_func
(paren
id|u16
id|val
comma
r_int
id|port
)paren
(brace
id|u32
id|off
suffix:semicolon
multiline_comment|/*&n;&t; * The SuperIO registers use sane addressing techniques...&n;&t; */
r_if
c_cond
(paren
id|SUPERIO_PORT
c_func
(paren
id|port
)paren
)paren
id|off
op_assign
id|port
op_lshift
l_int|2
suffix:semicolon
r_else
(brace
id|off
op_assign
(paren
id|port
op_amp
op_complement
l_int|1
)paren
op_lshift
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|port
op_amp
l_int|1
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|__arch_putw
c_func
(paren
id|val
comma
id|ISAIO_BASE
op_plus
id|off
)paren
suffix:semicolon
)brace
DECL|function|__outl
r_void
id|__outl
c_func
(paren
id|u32
id|val
comma
r_int
id|port
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|variable|__outb
id|EXPORT_SYMBOL
c_func
(paren
id|__outb
)paren
suffix:semicolon
DECL|variable|__outw
id|EXPORT_SYMBOL
c_func
(paren
id|__outw
)paren
suffix:semicolon
DECL|variable|__outl
id|EXPORT_SYMBOL
c_func
(paren
id|__outl
)paren
suffix:semicolon
r_extern
r_void
id|__arch_writesb
c_func
(paren
r_int
r_int
id|virt
comma
r_const
r_void
op_star
id|from
comma
r_int
id|len
)paren
suffix:semicolon
r_extern
r_void
id|__arch_writesw
c_func
(paren
r_int
r_int
id|virt
comma
r_const
r_void
op_star
id|from
comma
r_int
id|len
)paren
suffix:semicolon
r_extern
r_void
id|__arch_writesl
c_func
(paren
r_int
r_int
id|virt
comma
r_const
r_void
op_star
id|from
comma
r_int
id|len
)paren
suffix:semicolon
r_extern
r_void
id|__arch_readsb
c_func
(paren
r_int
r_int
id|virt
comma
r_void
op_star
id|from
comma
r_int
id|len
)paren
suffix:semicolon
r_extern
r_void
id|__arch_readsw
c_func
(paren
r_int
r_int
id|virt
comma
r_void
op_star
id|from
comma
r_int
id|len
)paren
suffix:semicolon
r_extern
r_void
id|__arch_readsl
c_func
(paren
r_int
r_int
id|virt
comma
r_void
op_star
id|from
comma
r_int
id|len
)paren
suffix:semicolon
DECL|function|outsb
r_void
id|outsb
c_func
(paren
r_int
r_int
id|port
comma
r_const
r_void
op_star
id|from
comma
r_int
id|len
)paren
(brace
id|u32
id|off
suffix:semicolon
r_if
c_cond
(paren
id|SUPERIO_PORT
c_func
(paren
id|port
)paren
)paren
id|off
op_assign
id|port
op_lshift
l_int|2
suffix:semicolon
r_else
(brace
id|off
op_assign
(paren
id|port
op_amp
op_complement
l_int|1
)paren
op_lshift
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|port
op_amp
l_int|1
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|__raw_writesb
c_func
(paren
id|ISAIO_BASE
op_plus
id|off
comma
id|from
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|insb
r_void
id|insb
c_func
(paren
r_int
r_int
id|port
comma
r_void
op_star
id|from
comma
r_int
id|len
)paren
(brace
id|u32
id|off
suffix:semicolon
r_if
c_cond
(paren
id|SUPERIO_PORT
c_func
(paren
id|port
)paren
)paren
id|off
op_assign
id|port
op_lshift
l_int|2
suffix:semicolon
r_else
(brace
id|off
op_assign
(paren
id|port
op_amp
op_complement
l_int|1
)paren
op_lshift
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|port
op_amp
l_int|1
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|__raw_readsb
c_func
(paren
id|ISAIO_BASE
op_plus
id|off
comma
id|from
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|outsw
r_void
id|outsw
c_func
(paren
r_int
r_int
id|port
comma
r_const
r_void
op_star
id|from
comma
r_int
id|len
)paren
(brace
id|u32
id|off
suffix:semicolon
r_if
c_cond
(paren
id|SUPERIO_PORT
c_func
(paren
id|port
)paren
)paren
id|off
op_assign
id|port
op_lshift
l_int|2
suffix:semicolon
r_else
(brace
id|off
op_assign
(paren
id|port
op_amp
op_complement
l_int|1
)paren
op_lshift
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|port
op_amp
l_int|1
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|__raw_writesw
c_func
(paren
id|ISAIO_BASE
op_plus
id|off
comma
id|from
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|insw
r_void
id|insw
c_func
(paren
r_int
r_int
id|port
comma
r_void
op_star
id|from
comma
r_int
id|len
)paren
(brace
id|u32
id|off
suffix:semicolon
r_if
c_cond
(paren
id|SUPERIO_PORT
c_func
(paren
id|port
)paren
)paren
id|off
op_assign
id|port
op_lshift
l_int|2
suffix:semicolon
r_else
(brace
id|off
op_assign
(paren
id|port
op_amp
op_complement
l_int|1
)paren
op_lshift
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|port
op_amp
l_int|1
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|__raw_readsw
c_func
(paren
id|ISAIO_BASE
op_plus
id|off
comma
id|from
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|outsl
r_void
id|outsl
c_func
(paren
r_int
r_int
id|port
comma
r_const
r_void
op_star
id|from
comma
r_int
id|len
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;outsl not supported on this architecture&quot;
)paren
suffix:semicolon
)brace
DECL|function|insl
r_void
id|insl
c_func
(paren
r_int
r_int
id|port
comma
r_void
op_star
id|from
comma
r_int
id|len
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;insl not supported on this architecture&quot;
)paren
suffix:semicolon
)brace
eof
