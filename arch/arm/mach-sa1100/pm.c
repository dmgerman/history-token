multiline_comment|/*&n; * SA1100 Power Management Routines&n; *&n; * Copyright (c) 2001 Cliff Brake &lt;cbrake@accelent.com&gt;&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License.&n; *&n; * History:&n; *&n; * 2001-02-06:&t;Cliff Brake         Initial code&n; *&n; * 2001-02-25:&t;Sukjae Cho &lt;sjcho@east.isi.edu&gt; &amp;&n; * &t;&t;Chester Kuo &lt;chester@linux.org.tw&gt;&n; * &t;&t;&t;Save more value for the resume function! Support&n; * &t;&t;&t;Bitsy/Assabet/Freebird board&n; *&n; * 2001-08-29:&t;Nicolas Pitre &lt;nico@cam.org&gt;&n; * &t;&t;&t;Cleaned up, pushed platform dependent stuff&n; * &t;&t;&t;in the platform specific files.&n; *&n; * 2002-05-27:&t;Nicolas Pitre&t;Killed sleep.h and the kmalloced save array.&n; * &t;&t;&t;&t;Storage is local on the stack now.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/sysctl.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/cpufreq.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/memory.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/leds.h&gt;
multiline_comment|/*&n; * Debug macros&n; */
DECL|macro|DEBUG
macro_line|#undef DEBUG
r_extern
r_void
id|sa1100_cpu_suspend
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|sa1100_cpu_resume
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|macro|SAVE
mdefine_line|#define SAVE(x)&t;&t;sleep_save[SLEEP_SAVE_##x] = x
DECL|macro|RESTORE
mdefine_line|#define RESTORE(x)&t;x = sleep_save[SLEEP_SAVE_##x]
multiline_comment|/*&n; * List of global SA11x0 peripheral registers to preserve.&n; * More ones like CP and general purpose register values are preserved&n; * on the stack and then the stack pointer is stored last in sleep.S.&n; */
DECL|enumerator|SLEEP_SAVE_SP
r_enum
(brace
id|SLEEP_SAVE_SP
op_assign
l_int|0
comma
DECL|enumerator|SLEEP_SAVE_OSCR
DECL|enumerator|SLEEP_SAVE_OIER
id|SLEEP_SAVE_OSCR
comma
id|SLEEP_SAVE_OIER
comma
DECL|enumerator|SLEEP_SAVE_OSMR0
DECL|enumerator|SLEEP_SAVE_OSMR1
DECL|enumerator|SLEEP_SAVE_OSMR2
DECL|enumerator|SLEEP_SAVE_OSMR3
id|SLEEP_SAVE_OSMR0
comma
id|SLEEP_SAVE_OSMR1
comma
id|SLEEP_SAVE_OSMR2
comma
id|SLEEP_SAVE_OSMR3
comma
DECL|enumerator|SLEEP_SAVE_GPDR
DECL|enumerator|SLEEP_SAVE_GRER
DECL|enumerator|SLEEP_SAVE_GFER
DECL|enumerator|SLEEP_SAVE_GAFR
id|SLEEP_SAVE_GPDR
comma
id|SLEEP_SAVE_GRER
comma
id|SLEEP_SAVE_GFER
comma
id|SLEEP_SAVE_GAFR
comma
DECL|enumerator|SLEEP_SAVE_PPDR
DECL|enumerator|SLEEP_SAVE_PPSR
DECL|enumerator|SLEEP_SAVE_PPAR
DECL|enumerator|SLEEP_SAVE_PSDR
id|SLEEP_SAVE_PPDR
comma
id|SLEEP_SAVE_PPSR
comma
id|SLEEP_SAVE_PPAR
comma
id|SLEEP_SAVE_PSDR
comma
DECL|enumerator|SLEEP_SAVE_ICMR
id|SLEEP_SAVE_ICMR
comma
DECL|enumerator|SLEEP_SAVE_Ser1SDCR0
id|SLEEP_SAVE_Ser1SDCR0
comma
DECL|enumerator|SLEEP_SAVE_SIZE
id|SLEEP_SAVE_SIZE
)brace
suffix:semicolon
DECL|function|pm_do_suspend
r_int
id|pm_do_suspend
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|sleep_save
(braket
id|SLEEP_SAVE_SIZE
)braket
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|leds_event
c_func
(paren
id|led_stop
)paren
suffix:semicolon
multiline_comment|/* preserve current time */
id|RCNR
op_assign
id|xtime.tv_sec
suffix:semicolon
multiline_comment|/* save vital registers */
id|SAVE
c_func
(paren
id|OSCR
)paren
suffix:semicolon
id|SAVE
c_func
(paren
id|OSMR0
)paren
suffix:semicolon
id|SAVE
c_func
(paren
id|OSMR1
)paren
suffix:semicolon
id|SAVE
c_func
(paren
id|OSMR2
)paren
suffix:semicolon
id|SAVE
c_func
(paren
id|OSMR3
)paren
suffix:semicolon
id|SAVE
c_func
(paren
id|OIER
)paren
suffix:semicolon
id|SAVE
c_func
(paren
id|GPDR
)paren
suffix:semicolon
id|SAVE
c_func
(paren
id|GRER
)paren
suffix:semicolon
id|SAVE
c_func
(paren
id|GFER
)paren
suffix:semicolon
id|SAVE
c_func
(paren
id|GAFR
)paren
suffix:semicolon
id|SAVE
c_func
(paren
id|PPDR
)paren
suffix:semicolon
id|SAVE
c_func
(paren
id|PPSR
)paren
suffix:semicolon
id|SAVE
c_func
(paren
id|PPAR
)paren
suffix:semicolon
id|SAVE
c_func
(paren
id|PSDR
)paren
suffix:semicolon
id|SAVE
c_func
(paren
id|Ser1SDCR0
)paren
suffix:semicolon
id|SAVE
c_func
(paren
id|ICMR
)paren
suffix:semicolon
multiline_comment|/* ... maybe a global variable initialized by arch code to set this? */
id|GRER
op_assign
id|PWER
suffix:semicolon
id|GFER
op_assign
l_int|0
suffix:semicolon
id|GEDR
op_assign
id|GEDR
suffix:semicolon
multiline_comment|/* Clear previous reset status */
id|RCSR
op_assign
id|RCSR_HWR
op_or
id|RCSR_SWR
op_or
id|RCSR_WDR
op_or
id|RCSR_SMR
suffix:semicolon
multiline_comment|/* set resume return address */
id|PSPR
op_assign
id|virt_to_phys
c_func
(paren
id|sa1100_cpu_resume
)paren
suffix:semicolon
multiline_comment|/* go zzz */
id|sa1100_cpu_suspend
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* ensure not to come back here if it wasn&squot;t intended */
id|PSPR
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;*** made it back from resume&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* restore registers */
id|RESTORE
c_func
(paren
id|GPDR
)paren
suffix:semicolon
id|RESTORE
c_func
(paren
id|GRER
)paren
suffix:semicolon
id|RESTORE
c_func
(paren
id|GFER
)paren
suffix:semicolon
id|RESTORE
c_func
(paren
id|GAFR
)paren
suffix:semicolon
multiline_comment|/* clear any edge detect bit */
id|GEDR
op_assign
id|GEDR
suffix:semicolon
id|RESTORE
c_func
(paren
id|PPDR
)paren
suffix:semicolon
id|RESTORE
c_func
(paren
id|PPSR
)paren
suffix:semicolon
id|RESTORE
c_func
(paren
id|PPAR
)paren
suffix:semicolon
id|RESTORE
c_func
(paren
id|PSDR
)paren
suffix:semicolon
id|RESTORE
c_func
(paren
id|Ser1SDCR0
)paren
suffix:semicolon
id|PSSR
op_assign
id|PSSR_PH
suffix:semicolon
id|RESTORE
c_func
(paren
id|OSMR0
)paren
suffix:semicolon
id|RESTORE
c_func
(paren
id|OSMR1
)paren
suffix:semicolon
id|RESTORE
c_func
(paren
id|OSMR2
)paren
suffix:semicolon
id|RESTORE
c_func
(paren
id|OSMR3
)paren
suffix:semicolon
id|RESTORE
c_func
(paren
id|OSCR
)paren
suffix:semicolon
id|RESTORE
c_func
(paren
id|OIER
)paren
suffix:semicolon
id|ICLR
op_assign
l_int|0
suffix:semicolon
id|ICCR
op_assign
l_int|1
suffix:semicolon
id|RESTORE
c_func
(paren
id|ICMR
)paren
suffix:semicolon
multiline_comment|/* restore current time */
id|xtime.tv_sec
op_assign
id|RCNR
suffix:semicolon
id|leds_event
c_func
(paren
id|led_start
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Restore the CPU frequency settings.&n;&t; */
macro_line|#ifdef CONFIG_CPU_FREQ
id|cpufreq_restore
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sleep_phys_sp
r_int
r_int
id|sleep_phys_sp
c_func
(paren
r_void
op_star
id|sp
)paren
(brace
r_return
id|virt_to_phys
c_func
(paren
id|sp
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SYSCTL
multiline_comment|/*&n; * ARGH!  ACPI people defined CTL_ACPI in linux/acpi.h rather than&n; * linux/sysctl.h.&n; *&n; * This means our interface here won&squot;t survive long - it needs a new&n; * interface.  Quick hack to get this working - use sysctl id 9999.&n; */
macro_line|#warning ACPI broke the kernel, this interface needs to be fixed up.
DECL|macro|CTL_ACPI
mdefine_line|#define CTL_ACPI 9999
DECL|macro|ACPI_S1_SLP_TYP
mdefine_line|#define ACPI_S1_SLP_TYP 19
multiline_comment|/*&n; * Send us to sleep.&n; */
DECL|function|sysctl_pm_do_suspend
r_static
r_int
id|sysctl_pm_do_suspend
c_func
(paren
r_void
)paren
(brace
r_int
id|retval
suffix:semicolon
id|retval
op_assign
id|pm_send_all
c_func
(paren
id|PM_SUSPEND
comma
(paren
r_void
op_star
)paren
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_eq
l_int|0
)paren
(brace
id|retval
op_assign
id|pm_do_suspend
c_func
(paren
)paren
suffix:semicolon
id|pm_send_all
c_func
(paren
id|PM_RESUME
comma
(paren
r_void
op_star
)paren
l_int|0
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
DECL|variable|pm_table
r_static
r_struct
id|ctl_table
id|pm_table
(braket
)braket
op_assign
(brace
(brace
id|ACPI_S1_SLP_TYP
comma
l_string|&quot;suspend&quot;
comma
l_int|NULL
comma
l_int|0
comma
l_int|0600
comma
l_int|NULL
comma
(paren
id|proc_handler
op_star
)paren
op_amp
id|sysctl_pm_do_suspend
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|pm_dir_table
r_static
r_struct
id|ctl_table
id|pm_dir_table
(braket
)braket
op_assign
(brace
(brace
id|CTL_ACPI
comma
l_string|&quot;pm&quot;
comma
l_int|NULL
comma
l_int|0
comma
l_int|0555
comma
id|pm_table
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; * Initialize power interface&n; */
DECL|function|pm_init
r_static
r_int
id|__init
id|pm_init
c_func
(paren
r_void
)paren
(brace
id|register_sysctl_table
c_func
(paren
id|pm_dir_table
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|pm_init
id|__initcall
c_func
(paren
id|pm_init
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|pm_do_suspend
id|EXPORT_SYMBOL
c_func
(paren
id|pm_do_suspend
)paren
suffix:semicolon
eof
