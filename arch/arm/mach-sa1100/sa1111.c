multiline_comment|/*&n; * linux/arch/arm/mach-sa1100/sa1111.c&n; *&n; * SA1111 support&n; *&n; * Original code by John Dorsey&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; * This file contains all generic SA1111 support, except for DMA which is&n; * provided separately in dma-sa1111.c.&n; *&n; * All initialization functions provided here are intended to be called&n; * from machine specific code with proper arguments when required.&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/mach/irq.h&gt;
macro_line|#include &lt;asm/arch/irq.h&gt;
macro_line|#include &quot;sa1111.h&quot;
r_static
r_int
id|sa1111_ohci_hcd_init
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/*&n; * SA1111 initialization&n; */
DECL|function|sa1111_init
r_int
id|__init
id|sa1111_init
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|id
op_assign
id|SKID
suffix:semicolon
r_if
c_cond
(paren
(paren
id|id
op_amp
id|SKID_ID_MASK
)paren
op_eq
id|SKID_SA1111_ID
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;SA-1111 Microprocessor Companion Chip: &quot;
l_string|&quot;silicon revision %lx, metal revision %lx&bslash;n&quot;
comma
(paren
id|id
op_amp
id|SKID_SIREV_MASK
)paren
op_rshift
l_int|4
comma
(paren
id|id
op_amp
id|SKID_MTREV_MASK
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Could not detect SA-1111!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * First, set up the 3.6864MHz clock on GPIO 27 for the SA-1111:&n;&t; * (SA-1110 Developer&squot;s Manual, section 9.1.2.1)&n;&t; */
id|GAFR
op_or_assign
id|GPIO_32_768kHz
suffix:semicolon
id|GPDR
op_or_assign
id|GPIO_32_768kHz
suffix:semicolon
id|TUCR
op_assign
id|TUCR_3_6864MHz
suffix:semicolon
multiline_comment|/* Now, set up the PLL and RCLK in the SA-1111: */
id|SKCR
op_assign
id|SKCR_PLL_BYPASS
op_or
id|SKCR_RDYEN
op_or
id|SKCR_OE_EN
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|SKCR
op_assign
id|SKCR_PLL_BYPASS
op_or
id|SKCR_RCLKEN
op_or
id|SKCR_RDYEN
op_or
id|SKCR_OE_EN
suffix:semicolon
multiline_comment|/*&n;&t; * SA-1111 Register Access Bus should now be available. Clocks for&n;&t; * any other SA-1111 functional blocks must be enabled separately&n;&t; * using the SKPCR.&n;&t; */
multiline_comment|/*&n;&t; * If the system is going to use the SA-1111 DMA engines, set up&n;&t; * the memory bus request/grant pins. Also configure the shared&n;&t; * memory controller on the SA-1111 (SA-1111 Developer&squot;s Manual,&n;&t; * section 3.2.3) and power up the DMA bus clock:&n;&t; */
id|GAFR
op_or_assign
(paren
id|GPIO_MBGNT
op_or
id|GPIO_MBREQ
)paren
suffix:semicolon
id|GPDR
op_or_assign
id|GPIO_MBGNT
suffix:semicolon
id|GPDR
op_and_assign
op_complement
id|GPIO_MBREQ
suffix:semicolon
id|TUCR
op_or_assign
id|TUCR_MR
suffix:semicolon
macro_line|#ifdef CONFIG_USB_OHCI
multiline_comment|/* setup up sa1111 usb host controller h/w */
id|sa1111_ohci_hcd_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * SA1111  Interrupt support&n; */
DECL|function|sa1111_IRQ_demux
r_void
id|sa1111_IRQ_demux
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|stat0
comma
id|stat1
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|stat0
op_assign
id|INTSTATCLR0
comma
id|stat1
op_assign
id|INTSTATCLR1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stat0
op_logical_and
op_logical_neg
id|stat1
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stat0
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|stat0
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
id|do_IRQ
c_func
(paren
id|SA1111_IRQ
c_func
(paren
id|i
)paren
comma
id|regs
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stat1
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|32
suffix:semicolon
id|i
OL
l_int|55
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|stat1
op_amp
(paren
l_int|1
op_lshift
(paren
id|i
op_minus
l_int|32
)paren
)paren
)paren
(brace
id|do_IRQ
c_func
(paren
id|SA1111_IRQ
c_func
(paren
id|i
)paren
comma
id|regs
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|variable|sa1111_irq
r_static
r_struct
id|irqaction
id|sa1111_irq
op_assign
(brace
id|name
suffix:colon
l_string|&quot;SA1111&quot;
comma
id|handler
suffix:colon
id|sa1111_IRQ_demux
comma
id|flags
suffix:colon
id|SA_INTERRUPT
)brace
suffix:semicolon
DECL|function|sa1111_mask_and_ack_lowirq
r_static
r_void
id|sa1111_mask_and_ack_lowirq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|1
op_lshift
(paren
id|irq
op_minus
id|SA1111_IRQ
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
singleline_comment|// broken hardware: interrupt events are lost if they occur
singleline_comment|// while the interrupts are disabled.
singleline_comment|//INTEN0 &amp;= ~mask;
id|INTSTATCLR0
op_assign
id|mask
suffix:semicolon
)brace
DECL|function|sa1111_mask_and_ack_highirq
r_static
r_void
id|sa1111_mask_and_ack_highirq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|1
op_lshift
(paren
id|irq
op_minus
id|SA1111_IRQ
c_func
(paren
l_int|32
)paren
)paren
suffix:semicolon
singleline_comment|//INTEN1 &amp;= ~mask;
id|INTSTATCLR1
op_assign
id|mask
suffix:semicolon
)brace
DECL|function|sa1111_mask_lowirq
r_static
r_void
id|sa1111_mask_lowirq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
singleline_comment|//INTEN0 &amp;= ~(1 &lt;&lt; (irq - SA1111_IRQ(0)));
)brace
DECL|function|sa1111_mask_highirq
r_static
r_void
id|sa1111_mask_highirq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
singleline_comment|//INTEN1 &amp;= ~(1 &lt;&lt; (irq - SA1111_IRQ(32)));
)brace
DECL|function|sa1111_unmask_lowirq
r_static
r_void
id|sa1111_unmask_lowirq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|INTEN0
op_or_assign
l_int|1
op_lshift
(paren
id|irq
op_minus
id|SA1111_IRQ
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
)brace
DECL|function|sa1111_unmask_highirq
r_static
r_void
id|sa1111_unmask_highirq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|INTEN1
op_or_assign
l_int|1
op_lshift
(paren
(paren
id|irq
op_minus
id|SA1111_IRQ
c_func
(paren
l_int|32
)paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|sa1111_init_irq
r_void
id|__init
id|sa1111_init_irq
c_func
(paren
r_int
id|gpio_nr
)paren
(brace
r_int
id|irq
suffix:semicolon
multiline_comment|/* disable all IRQs */
id|INTEN0
op_assign
l_int|0
suffix:semicolon
id|INTEN1
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * detect on rising edge.  Note: Feb 2001 Errata for SA1111&n;&t; * specifies that S0ReadyInt and S1ReadyInt should be &squot;1&squot;.&n;&t; */
id|INTPOL0
op_assign
l_int|0
suffix:semicolon
id|INTPOL1
op_assign
l_int|1
op_lshift
(paren
id|S0_READY_NINT
op_minus
id|SA1111_IRQ
c_func
(paren
l_int|32
)paren
)paren
op_or
l_int|1
op_lshift
(paren
id|S1_READY_NINT
op_minus
id|SA1111_IRQ
c_func
(paren
l_int|32
)paren
)paren
suffix:semicolon
multiline_comment|/* clear all IRQs */
id|INTSTATCLR0
op_assign
op_minus
l_int|1
suffix:semicolon
id|INTSTATCLR1
op_assign
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|irq
op_assign
id|SA1111_IRQ
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|irq
op_le
id|SA1111_IRQ
c_func
(paren
l_int|26
)paren
suffix:semicolon
id|irq
op_increment
)paren
(brace
id|irq_desc
(braket
id|irq
)braket
dot
id|valid
op_assign
l_int|1
suffix:semicolon
id|irq_desc
(braket
id|irq
)braket
dot
id|probe_ok
op_assign
l_int|1
suffix:semicolon
id|irq_desc
(braket
id|irq
)braket
dot
id|mask_ack
op_assign
id|sa1111_mask_and_ack_lowirq
suffix:semicolon
id|irq_desc
(braket
id|irq
)braket
dot
id|mask
op_assign
id|sa1111_mask_lowirq
suffix:semicolon
id|irq_desc
(braket
id|irq
)braket
dot
id|unmask
op_assign
id|sa1111_unmask_lowirq
suffix:semicolon
)brace
r_for
c_loop
(paren
id|irq
op_assign
id|SA1111_IRQ
c_func
(paren
l_int|32
)paren
suffix:semicolon
id|irq
op_le
id|SA1111_IRQ
c_func
(paren
l_int|54
)paren
suffix:semicolon
id|irq
op_increment
)paren
(brace
id|irq_desc
(braket
id|irq
)braket
dot
id|valid
op_assign
l_int|1
suffix:semicolon
id|irq_desc
(braket
id|irq
)braket
dot
id|probe_ok
op_assign
l_int|1
suffix:semicolon
id|irq_desc
(braket
id|irq
)braket
dot
id|mask_ack
op_assign
id|sa1111_mask_and_ack_highirq
suffix:semicolon
id|irq_desc
(braket
id|irq
)braket
dot
id|mask
op_assign
id|sa1111_mask_highirq
suffix:semicolon
id|irq_desc
(braket
id|irq
)braket
dot
id|unmask
op_assign
id|sa1111_unmask_highirq
suffix:semicolon
)brace
multiline_comment|/* Not every machines has the SA1111 interrupt routed to a GPIO */
r_if
c_cond
(paren
id|gpio_nr
op_ge
l_int|0
)paren
(brace
id|set_GPIO_IRQ_edge
(paren
id|GPIO_GPIO
c_func
(paren
id|gpio_nr
)paren
comma
id|GPIO_RISING_EDGE
)paren
suffix:semicolon
id|setup_arm_irq
(paren
id|SA1100_GPIO_TO_IRQ
c_func
(paren
id|gpio_nr
)paren
comma
op_amp
id|sa1111_irq
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* ----------------- */
macro_line|#ifdef CONFIG_USB_OHCI
macro_line|#if defined(CONFIG_SA1100_XP860) || defined(CONFIG_ASSABET_NEPONSET) || defined(CONFIG_SA1100_PFS168)
DECL|macro|PwrSensePolLow
mdefine_line|#define PwrSensePolLow  1
DECL|macro|PwrCtrlPolLow
mdefine_line|#define PwrCtrlPolLow   1
macro_line|#else
DECL|macro|PwrSensePolLow
mdefine_line|#define PwrSensePolLow  0
DECL|macro|PwrCtrlPolLow
mdefine_line|#define PwrCtrlPolLow   0
macro_line|#endif
multiline_comment|/*&n; * The SA-1111 errata says that the DMA hardware needs to be exercised&n; * before the clocks are turned on to work properly.  This code does&n; * a tiny dma transfer to prime to hardware.&n; */
DECL|function|sa1111_dma_setup
r_static
r_void
id|__init
id|sa1111_dma_setup
c_func
(paren
r_void
)paren
(brace
id|dma_addr_t
id|vbuf
suffix:semicolon
r_void
op_star
id|pbuf
suffix:semicolon
multiline_comment|/* DMA init &amp; setup */
multiline_comment|/* WARNING: The SA-1111 L3 function is used as part of this&n;&t; * SA-1111 DMA errata workaround.&n;&t; *&n;&t; * N.B., When the L3 function is enabled, it uses GPIO_B&lt;4:5&gt;&n;&t; * and takes precedence over the PS/2 mouse and GPIO_B&n;&t; * functions. Refer to &quot;Intel StrongARM SA-1111 Microprocessor&n;&t; * Companion Chip, Sect 10.2&quot; for details.  So this &quot;fix&quot; may&n;&t; * &quot;break&quot; support of either PS/2 mouse or GPIO_B if&n;&t; * precautions are not taken to avoid collisions in&n;&t; * configuration and use of these pins. AFAIK, no precautions&n;&t; * are taken at this time. So it is likely that the action&n;&t; * taken here may cause problems in PS/2 mouse and/or GPIO_B&n;&t; * pin use elsewhere.&n;&t; *&n;&t; * But wait, there&squot;s more... What we&squot;re doing here is&n;&t; * obviously altogether a bad idea. We&squot;re indiscrimanately bit&n;&t; * flipping config for a few different functions here which&n;&t; * are &quot;owned&quot; by other drivers. This needs to be handled&n;&t; * better than it is being done here at this time.  */
multiline_comment|/* prime the dma engine with a tiny dma */
id|SKPCR
op_or_assign
id|SKPCR_I2SCLKEN
suffix:semicolon
id|SKAUD
op_or_assign
id|SKPCR_L3CLKEN
op_or
id|SKPCR_SCLKEN
suffix:semicolon
id|SACR0
op_or_assign
l_int|0x00003305
suffix:semicolon
id|SACR1
op_assign
l_int|0x00000000
suffix:semicolon
multiline_comment|/* we need memory below 1mb */
id|pbuf
op_assign
id|consistent_alloc
c_func
(paren
id|GFP_KERNEL
op_or
id|GFP_DMA
comma
l_int|4
comma
op_amp
id|vbuf
)paren
suffix:semicolon
id|SADTSA
op_assign
(paren
r_int
r_int
)paren
id|pbuf
suffix:semicolon
id|SADTCA
op_assign
l_int|4
suffix:semicolon
id|SADTCS
op_or_assign
l_int|0x00000011
suffix:semicolon
id|SKPCR
op_or_assign
id|SKPCR_DCLKEN
suffix:semicolon
multiline_comment|/* wait */
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|SACR0
op_and_assign
op_complement
(paren
l_int|0x00000002
)paren
suffix:semicolon
id|SACR0
op_and_assign
op_complement
(paren
l_int|0x00000001
)paren
suffix:semicolon
multiline_comment|/* */
id|SACR0
op_or_assign
l_int|0x00000004
suffix:semicolon
id|SACR0
op_and_assign
op_complement
(paren
l_int|0x00000004
)paren
suffix:semicolon
id|SKAUD
op_and_assign
op_complement
(paren
id|SKPCR_L3CLKEN
op_or
id|SKPCR_SCLKEN
)paren
suffix:semicolon
id|SKPCR
op_and_assign
op_complement
id|SKPCR_I2SCLKEN
suffix:semicolon
id|consistent_free
c_func
(paren
id|pbuf
comma
l_int|4
comma
id|vbuf
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_USB_OHCI
multiline_comment|/*&n; * reset the SA-1111 usb controller and turn on it&squot;s clocks&n; */
DECL|function|sa1111_ohci_hcd_init
r_static
r_int
id|__init
id|sa1111_ohci_hcd_init
c_func
(paren
r_void
)paren
(brace
r_volatile
r_int
r_int
op_star
id|Reset
op_assign
(paren
r_void
op_star
)paren
id|SA1111_p2v
c_func
(paren
id|_SA1111
c_func
(paren
l_int|0x051c
)paren
)paren
suffix:semicolon
r_volatile
r_int
r_int
op_star
id|Status
op_assign
(paren
r_void
op_star
)paren
id|SA1111_p2v
c_func
(paren
id|_SA1111
c_func
(paren
l_int|0x0518
)paren
)paren
suffix:semicolon
multiline_comment|/* turn on clocks */
id|SKPCR
op_or_assign
id|SKPCR_UCLKEN
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/* force a reset */
op_star
id|Reset
op_assign
l_int|0x01
suffix:semicolon
op_star
id|Reset
op_or_assign
l_int|0x02
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
op_star
id|Reset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* take out of reset */
multiline_comment|/* set power sense and control lines (this from the diags code) */
op_star
id|Reset
op_assign
(paren
id|PwrSensePolLow
op_lshift
l_int|6
)paren
op_or
(paren
id|PwrCtrlPolLow
op_lshift
l_int|7
)paren
suffix:semicolon
op_star
id|Status
op_assign
l_int|0
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* compensate for dma bug */
id|sa1111_dma_setup
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sa1111_ohci_hcd_cleanup
r_void
id|sa1111_ohci_hcd_cleanup
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* turn the USB clock off */
id|SKPCR
op_and_assign
op_complement
id|SKPCR_UCLKEN
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif /* CONFIG_USB_OHCI */
eof
