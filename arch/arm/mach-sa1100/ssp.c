multiline_comment|/*&n; *  linux/arch/arm/mach-sa1100/ssp.c&n; *&n; *  Copyright (C) 2003 Russell King.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; *  Generic SSP driver.  This provides the generic core for simple&n; *  IO-based SSP applications.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/hardware/ssp.h&gt;
DECL|function|ssp_interrupt
r_static
r_void
id|ssp_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|status
op_assign
id|Ser4SSSR
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SSSR_ROR
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;SSP: receiver overrun&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|Ser4SSSR
op_assign
id|SSSR_ROR
suffix:semicolon
)brace
multiline_comment|/**&n; * ssp_write_word - write a word to the SSP port&n; * @data: 16-bit, MSB justified data to write.&n; *&n; * Wait for a free entry in the SSP transmit FIFO, and write a data&n; * word to the SSP port.  Wait for the SSP port to start sending&n; * the data.&n; *&n; * The caller is expected to perform the necessary locking.&n; *&n; * Returns:&n; *   %-ETIMEDOUT&t;timeout occurred (for future)&n; *   0&t;&t;&t;success&n; */
DECL|function|ssp_write_word
r_int
id|ssp_write_word
c_func
(paren
id|u16
id|data
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|Ser4SSSR
op_amp
id|SSSR_TNF
)paren
)paren
id|cpu_relax
c_func
(paren
)paren
suffix:semicolon
id|Ser4SSDR
op_assign
id|data
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|Ser4SSSR
op_amp
id|SSSR_BSY
)paren
)paren
id|cpu_relax
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * ssp_read_word - read a word from the SSP port&n; *&n; * Wait for a data word in the SSP receive FIFO, and return the&n; * received data.  Data is LSB justified.&n; *&n; * Note: Currently, if data is not expected to be received, this&n; * function will wait for ever.&n; *&n; * The caller is expected to perform the necessary locking.&n; *&n; * Returns:&n; *   %-ETIMEDOUT&t;timeout occurred (for future)&n; *   16-bit data&t;success&n; */
DECL|function|ssp_read_word
r_int
id|ssp_read_word
c_func
(paren
r_void
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|Ser4SSSR
op_amp
id|SSSR_RNE
)paren
)paren
id|cpu_relax
c_func
(paren
)paren
suffix:semicolon
r_return
id|Ser4SSDR
suffix:semicolon
)brace
multiline_comment|/**&n; * ssp_flush - flush the transmit and receive FIFOs&n; *&n; * Wait for the SSP to idle, and ensure that the receive FIFO&n; * is empty.&n; *&n; * The caller is expected to perform the necessary locking.&n; */
DECL|function|ssp_flush
r_void
id|ssp_flush
c_func
(paren
r_void
)paren
(brace
r_do
(brace
r_while
c_loop
(paren
id|Ser4SSSR
op_amp
id|SSSR_RNE
)paren
(brace
(paren
r_void
)paren
id|Ser4SSDR
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|Ser4SSSR
op_amp
id|SSSR_BSY
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ssp_enable - enable the SSP port&n; *&n; * Turn on the SSP port.&n; */
DECL|function|ssp_enable
r_void
id|ssp_enable
c_func
(paren
r_void
)paren
(brace
id|Ser4SSCR0
op_or_assign
id|SSCR0_SSE
suffix:semicolon
)brace
multiline_comment|/**&n; * ssp_disable - shut down the SSP port&n; *&n; * Turn off the SSP port, optionally powering it down.&n; */
DECL|function|ssp_disable
r_void
id|ssp_disable
c_func
(paren
r_void
)paren
(brace
id|Ser4SSCR0
op_and_assign
op_complement
id|SSCR0_SSE
suffix:semicolon
)brace
multiline_comment|/**&n; * ssp_save_state - save the SSP configuration&n; * @ssp: pointer to structure to save SSP configuration&n; *&n; * Save the configured SSP state for suspend.&n; */
DECL|function|ssp_save_state
r_void
id|ssp_save_state
c_func
(paren
r_struct
id|ssp_state
op_star
id|ssp
)paren
(brace
id|ssp-&gt;cr0
op_assign
id|Ser4SSCR0
suffix:semicolon
id|ssp-&gt;cr1
op_assign
id|Ser4SSCR1
suffix:semicolon
id|Ser4SSCR0
op_and_assign
op_complement
id|SSCR0_SSE
suffix:semicolon
)brace
multiline_comment|/**&n; * ssp_restore_state - restore a previously saved SSP configuration&n; * @ssp: pointer to configuration saved by ssp_save_state&n; *&n; * Restore the SSP configuration saved previously by ssp_save_state.&n; */
DECL|function|ssp_restore_state
r_void
id|ssp_restore_state
c_func
(paren
r_struct
id|ssp_state
op_star
id|ssp
)paren
(brace
id|Ser4SSSR
op_assign
id|SSSR_ROR
suffix:semicolon
id|Ser4SSCR0
op_assign
id|ssp-&gt;cr0
op_amp
op_complement
id|SSCR0_SSE
suffix:semicolon
id|Ser4SSCR1
op_assign
id|ssp-&gt;cr1
suffix:semicolon
id|Ser4SSCR0
op_assign
id|ssp-&gt;cr0
suffix:semicolon
)brace
multiline_comment|/**&n; * ssp_init - setup the SSP port&n; *&n; * initialise and claim resources for the SSP port.&n; *&n; * Returns:&n; *   %-ENODEV&t;if the SSP port is unavailable&n; *   %-EBUSY&t;if the resources are already in use&n; *   %0&t;&t;on success&n; */
DECL|function|ssp_init
r_int
id|ssp_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|PPAR
op_amp
id|PPAR_SPR
)paren
op_logical_and
(paren
id|Ser4MCCR0
op_amp
id|MCCR0_MCE
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|__PREG
c_func
(paren
id|Ser4SSCR0
)paren
comma
l_int|0x18
comma
l_string|&quot;SSP&quot;
)paren
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|Ser4SSSR
op_assign
id|SSSR_ROR
suffix:semicolon
id|ret
op_assign
id|request_irq
c_func
(paren
id|IRQ_Ser4SSP
comma
id|ssp_interrupt
comma
l_int|0
comma
l_string|&quot;SSP&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|out_region
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_region
suffix:colon
id|release_mem_region
c_func
(paren
id|__PREG
c_func
(paren
id|Ser4SSCR0
)paren
comma
l_int|0x18
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; * ssp_exit - undo the effects of ssp_init&n; *&n; * release and free resources for the SSP port.&n; */
DECL|function|ssp_exit
r_void
id|ssp_exit
c_func
(paren
r_void
)paren
(brace
id|Ser4SSCR0
op_and_assign
op_complement
id|SSCR0_SSE
suffix:semicolon
id|free_irq
c_func
(paren
id|IRQ_Ser4SSP
comma
l_int|NULL
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|__PREG
c_func
(paren
id|Ser4SSCR0
)paren
comma
l_int|0x18
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Russell King&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;SA11x0 SSP PIO driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|ssp_write_word
id|EXPORT_SYMBOL
c_func
(paren
id|ssp_write_word
)paren
suffix:semicolon
DECL|variable|ssp_read_word
id|EXPORT_SYMBOL
c_func
(paren
id|ssp_read_word
)paren
suffix:semicolon
DECL|variable|ssp_flush
id|EXPORT_SYMBOL
c_func
(paren
id|ssp_flush
)paren
suffix:semicolon
DECL|variable|ssp_enable
id|EXPORT_SYMBOL
c_func
(paren
id|ssp_enable
)paren
suffix:semicolon
DECL|variable|ssp_disable
id|EXPORT_SYMBOL
c_func
(paren
id|ssp_disable
)paren
suffix:semicolon
DECL|variable|ssp_save_state
id|EXPORT_SYMBOL
c_func
(paren
id|ssp_save_state
)paren
suffix:semicolon
DECL|variable|ssp_restore_state
id|EXPORT_SYMBOL
c_func
(paren
id|ssp_restore_state
)paren
suffix:semicolon
DECL|variable|ssp_init
id|EXPORT_SYMBOL
c_func
(paren
id|ssp_init
)paren
suffix:semicolon
DECL|variable|ssp_exit
id|EXPORT_SYMBOL
c_func
(paren
id|ssp_exit
)paren
suffix:semicolon
eof
