multiline_comment|/*&n; * cpu-sa1100.c: clock scaling for the SA1100&n; *&n; * Copyright (C) 2000 2001, The Delft University of Technology&n; *&n; * Authors: &n; * - Johan Pouwelse (J.A.Pouwelse@its.tudelft.nl): initial version&n; * - Erik Mouw (J.A.K.Mouw@its.tudelft.nl):&n; *   - major rewrite for linux-2.3.99&n; *   - rewritten for the more generic power management scheme in &n; *     linux-2.4.5-rmk1&n; *&n; * This software has been developed while working on the LART&n; * computing board (http://www.lart.tudelft.nl/), which is&n; * sponsored by the Mobile Multi-media Communications&n; * (http://www.mmc.tudelft.nl/) and Ubiquitous Communications &n; * (http://www.ubicom.tudelft.nl/) projects.&n; *&n; * The authors can be reached at:&n; *&n; *  Erik Mouw&n; *  Information and Communication Theory Group&n; *  Faculty of Information Technology and Systems&n; *  Delft University of Technology&n; *  P.O. Box 5031&n; *  2600 GA Delft&n; *  The Netherlands&n; *&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; * &n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; *&n; *&n; * Theory of operations&n; * ====================&n; * &n; * Clock scaling can be used to lower the power consumption of the CPU&n; * core. This will give you a somewhat longer running time.&n; *&n; * The SA-1100 has a single register to change the core clock speed:&n; *&n; *   PPCR      0x90020014    PLL config&n; *&n; * However, the DRAM timings are closely related to the core clock&n; * speed, so we need to change these, too. The used registers are:&n; *&n; *   MDCNFG    0xA0000000    DRAM config&n; *   MDCAS0    0xA0000004    Access waveform&n; *   MDCAS1    0xA0000008    Access waveform&n; *   MDCAS2    0xA000000C    Access waveform &n; *&n; * Care must be taken to change the DRAM parameters the correct way,&n; * because otherwise the DRAM becomes unusable and the kernel will&n; * crash. &n; *&n; * The simple solution to avoid a kernel crash is to put the actual&n; * clock change in ROM and jump to that code from the kernel. The main&n; * disadvantage is that the ROM has to be modified, which is not&n; * possible on all SA-1100 platforms. Another disadvantage is that&n; * jumping to ROM makes clock switching unecessary complicated.&n; *&n; * The idea behind this driver is that the memory configuration can be&n; * changed while running from DRAM (even with interrupts turned on!)&n; * as long as all re-configuration steps yield a valid DRAM&n; * configuration. The advantages are clear: it will run on all SA-1100&n; * platforms, and the code is very simple.&n; * &n; * If you really want to understand what is going on in&n; * sa1100_update_dram_timings(), you&squot;ll have to read sections 8.2,&n; * 9.5.7.3, and 10.2 from the &quot;Intel StrongARM SA-1100 Microprocessor&n; * Developers Manual&quot; (available for free from Intel).&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/cpufreq.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
r_extern
r_int
r_int
id|sa11x0_freq_to_ppcr
c_func
(paren
r_int
r_int
id|khz
)paren
suffix:semicolon
r_extern
r_int
r_int
id|sa11x0_validatespeed
c_func
(paren
r_int
r_int
id|cpu
comma
r_int
r_int
id|khz
)paren
suffix:semicolon
r_extern
r_int
r_int
id|sa11x0_getspeed
c_func
(paren
r_void
)paren
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|speed
r_int
id|speed
suffix:semicolon
DECL|member|mdcnfg
id|u32
id|mdcnfg
suffix:semicolon
DECL|member|mdcas0
id|u32
id|mdcas0
suffix:semicolon
DECL|member|mdcas1
id|u32
id|mdcas1
suffix:semicolon
DECL|member|mdcas2
id|u32
id|mdcas2
suffix:semicolon
DECL|typedef|sa1100_dram_regs_t
)brace
id|sa1100_dram_regs_t
suffix:semicolon
DECL|variable|sa1100_dram_settings
r_static
id|sa1100_dram_regs_t
id|sa1100_dram_settings
(braket
)braket
op_assign
(brace
multiline_comment|/* { mdcnfg, mdcas0, mdcas1, mdcas2 } */
multiline_comment|/* clock frequency */
(brace
l_int|59000
comma
l_int|0x00dc88a3
comma
l_int|0xcccccccf
comma
l_int|0xfffffffc
comma
l_int|0xffffffff
)brace
comma
multiline_comment|/*  59.0 MHz */
(brace
l_int|73700
comma
l_int|0x011490a3
comma
l_int|0xcccccccf
comma
l_int|0xfffffffc
comma
l_int|0xffffffff
)brace
comma
multiline_comment|/*  73.7 MHz */
(brace
l_int|88500
comma
l_int|0x014e90a3
comma
l_int|0xcccccccf
comma
l_int|0xfffffffc
comma
l_int|0xffffffff
)brace
comma
multiline_comment|/*  88.5 MHz */
(brace
l_int|103200
comma
l_int|0x01889923
comma
l_int|0xcccccccf
comma
l_int|0xfffffffc
comma
l_int|0xffffffff
)brace
comma
multiline_comment|/* 103.2 MHz */
(brace
l_int|118000
comma
l_int|0x01c29923
comma
l_int|0x9999998f
comma
l_int|0xfffffff9
comma
l_int|0xffffffff
)brace
comma
multiline_comment|/* 118.0 MHz */
(brace
l_int|132700
comma
l_int|0x01fb2123
comma
l_int|0x9999998f
comma
l_int|0xfffffff9
comma
l_int|0xffffffff
)brace
comma
multiline_comment|/* 132.7 MHz */
(brace
l_int|147500
comma
l_int|0x02352123
comma
l_int|0x3333330f
comma
l_int|0xfffffff3
comma
l_int|0xffffffff
)brace
comma
multiline_comment|/* 147.5 MHz */
(brace
l_int|162200
comma
l_int|0x026b29a3
comma
l_int|0x38e38e1f
comma
l_int|0xfff8e38e
comma
l_int|0xffffffff
)brace
comma
multiline_comment|/* 162.2 MHz */
(brace
l_int|176900
comma
l_int|0x02a329a3
comma
l_int|0x71c71c1f
comma
l_int|0xfff1c71c
comma
l_int|0xffffffff
)brace
comma
multiline_comment|/* 176.9 MHz */
(brace
l_int|191700
comma
l_int|0x02dd31a3
comma
l_int|0xe38e383f
comma
l_int|0xffe38e38
comma
l_int|0xffffffff
)brace
comma
multiline_comment|/* 191.7 MHz */
(brace
l_int|206400
comma
l_int|0x03153223
comma
l_int|0xc71c703f
comma
l_int|0xffc71c71
comma
l_int|0xffffffff
)brace
comma
multiline_comment|/* 206.4 MHz */
(brace
l_int|221200
comma
l_int|0x034fba23
comma
l_int|0xc71c703f
comma
l_int|0xffc71c71
comma
l_int|0xffffffff
)brace
comma
multiline_comment|/* 221.2 MHz */
(brace
l_int|235900
comma
l_int|0x03853a23
comma
l_int|0xe1e1e07f
comma
l_int|0xe1e1e1e1
comma
l_int|0xffffffe1
)brace
comma
multiline_comment|/* 235.9 MHz */
(brace
l_int|250700
comma
l_int|0x03bf3aa3
comma
l_int|0xc3c3c07f
comma
l_int|0xc3c3c3c3
comma
l_int|0xffffffc3
)brace
comma
multiline_comment|/* 250.7 MHz */
(brace
l_int|265400
comma
l_int|0x03f7c2a3
comma
l_int|0xc3c3c07f
comma
l_int|0xc3c3c3c3
comma
l_int|0xffffffc3
)brace
comma
multiline_comment|/* 265.4 MHz */
(brace
l_int|280200
comma
l_int|0x0431c2a3
comma
l_int|0x878780ff
comma
l_int|0x87878787
comma
l_int|0xffffff87
)brace
comma
multiline_comment|/* 280.2 MHz */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
multiline_comment|/* last entry */
)brace
suffix:semicolon
DECL|function|sa1100_update_dram_timings
r_static
r_void
id|sa1100_update_dram_timings
c_func
(paren
r_int
id|current_speed
comma
r_int
id|new_speed
)paren
(brace
id|sa1100_dram_regs_t
op_star
id|settings
op_assign
id|sa1100_dram_settings
suffix:semicolon
multiline_comment|/* find speed */
r_while
c_loop
(paren
id|settings-&gt;speed
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|new_speed
op_eq
id|settings-&gt;speed
)paren
(brace
r_break
suffix:semicolon
)brace
id|settings
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|settings-&gt;speed
op_eq
l_int|0
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;%s: couldn&squot;t find dram setting for speed %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|new_speed
)paren
suffix:semicolon
)brace
multiline_comment|/* No risk, no fun: run with interrupts on! */
r_if
c_cond
(paren
id|new_speed
OG
id|current_speed
)paren
(brace
multiline_comment|/* We&squot;re going FASTER, so first relax the memory&n;&t;&t; * timings before changing the core frequency &n;&t;&t; */
multiline_comment|/* Half the memory access clock */
id|MDCNFG
op_or_assign
id|MDCNFG_CDB2
suffix:semicolon
multiline_comment|/* The order of these statements IS important, keep 8&n;&t;&t; * pulses!!&n;&t;&t; */
id|MDCAS2
op_assign
id|settings-&gt;mdcas2
suffix:semicolon
id|MDCAS1
op_assign
id|settings-&gt;mdcas1
suffix:semicolon
id|MDCAS0
op_assign
id|settings-&gt;mdcas0
suffix:semicolon
id|MDCNFG
op_assign
id|settings-&gt;mdcnfg
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* We&squot;re going SLOWER: first decrease the core&n;&t;&t; * frequency and then tighten the memory settings.&n;&t;&t; */
multiline_comment|/* Half the memory access clock */
id|MDCNFG
op_or_assign
id|MDCNFG_CDB2
suffix:semicolon
multiline_comment|/* The order of these statements IS important, keep 8&n;&t;&t; * pulses!!&n;&t;&t; */
id|MDCAS0
op_assign
id|settings-&gt;mdcas0
suffix:semicolon
id|MDCAS1
op_assign
id|settings-&gt;mdcas1
suffix:semicolon
id|MDCAS2
op_assign
id|settings-&gt;mdcas2
suffix:semicolon
id|MDCNFG
op_assign
id|settings-&gt;mdcnfg
suffix:semicolon
)brace
)brace
DECL|function|sa1100_dram_notifier
r_static
r_int
id|sa1100_dram_notifier
c_func
(paren
r_struct
id|notifier_block
op_star
id|nb
comma
r_int
r_int
id|val
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|cpufreq_freqs
op_star
id|ci
op_assign
id|data
suffix:semicolon
r_switch
c_cond
(paren
id|val
)paren
(brace
r_case
id|CPUFREQ_MINMAX
suffix:colon
id|cpufreq_updateminmax
c_func
(paren
id|data
comma
id|sa1100_dram_settings-&gt;speed
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPUFREQ_PRECHANGE
suffix:colon
r_if
c_cond
(paren
id|ci
op_member_access_from_pointer
r_new
OG
id|ci-&gt;cur
)paren
(brace
id|sa1100_update_dram_timings
c_func
(paren
id|ci-&gt;cur
comma
id|ci
op_member_access_from_pointer
r_new
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CPUFREQ_POSTCHANGE
suffix:colon
r_if
c_cond
(paren
id|ci
op_member_access_from_pointer
r_new
OL
id|ci-&gt;cur
)paren
(brace
id|sa1100_update_dram_timings
c_func
(paren
id|ci-&gt;cur
comma
id|ci
op_member_access_from_pointer
r_new
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ignoring unknown notifier type (%ld)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|val
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sa1100_dram_block
r_static
r_struct
id|notifier_block
id|sa1100_dram_block
op_assign
(brace
id|notifier_call
suffix:colon
id|sa1100_dram_notifier
comma
)brace
suffix:semicolon
DECL|function|sa1100_setspeed
r_static
r_void
id|sa1100_setspeed
c_func
(paren
r_int
r_int
id|cpu
comma
r_int
r_int
id|khz
)paren
(brace
id|PPCR
op_assign
id|sa11x0_freq_to_ppcr
c_func
(paren
id|khz
)paren
suffix:semicolon
)brace
DECL|variable|sa1100_freqs
r_static
r_struct
id|cpufreq_freqs
id|sa1100_freqs
op_assign
(brace
dot
id|min
op_assign
l_int|59000
comma
dot
id|max
op_assign
l_int|287000
comma
)brace
suffix:semicolon
DECL|variable|sa1100_driver
r_static
r_struct
id|cpufreq_driver
id|sa1100_driver
op_assign
(brace
dot
id|freq
op_assign
op_amp
id|sa1100_freqs
comma
dot
id|validate
op_assign
id|sa11x0_validatespeed
comma
dot
id|setspeed
op_assign
id|sa1100_setspeed
comma
dot
id|sync
op_assign
l_int|1
comma
)brace
suffix:semicolon
DECL|function|sa1100_dram_init
r_static
r_int
id|__init
id|sa1100_dram_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|processor_id
op_amp
id|CPU_SA1100_MASK
)paren
op_eq
id|CPU_SA1100_ID
)paren
(brace
id|ret
op_assign
id|cpufreq_register_notifier
c_func
(paren
op_amp
id|sa1100_dram_block
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
id|sa1100_freqs.cur
op_assign
id|sa11x0_getspeed
c_func
(paren
)paren
suffix:semicolon
id|ret
op_assign
id|cpufreq_register
c_func
(paren
op_amp
id|sa1100_driver
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|sa1100_dram_init
id|__initcall
c_func
(paren
id|sa1100_dram_init
)paren
suffix:semicolon
eof
