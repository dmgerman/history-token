multiline_comment|/*&n; * arch/arm/kernel/hw-sa1100.c&n; *&n; * SA1100-dependent machine specifics&n; *&n; * Copyright (C) 2000 Nicolas Pitre &lt;nico@cam.org&gt;&n; *&n; * This will certainly contain more stuff with time... like power management,&n; * special hardware autodetection, etc.&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/mach-types.h&gt;
multiline_comment|/*&n; * SA1100 GPIO edge detection for IRQs:&n; * IRQs are generated on Falling-Edge, Rising-Edge, or both.&n; * This must be called *before* the appropriate IRQ is registered.&n; * Use this instead of directly setting GRER/GFER.&n; */
DECL|variable|GPIO_IRQ_rising_edge
r_int
id|GPIO_IRQ_rising_edge
suffix:semicolon
DECL|variable|GPIO_IRQ_falling_edge
r_int
id|GPIO_IRQ_falling_edge
suffix:semicolon
DECL|function|set_GPIO_IRQ_edge
r_void
id|set_GPIO_IRQ_edge
c_func
(paren
r_int
id|gpio_mask
comma
r_int
id|edge
)paren
(brace
r_if
c_cond
(paren
id|edge
op_amp
id|GPIO_FALLING_EDGE
)paren
(brace
id|GPIO_IRQ_falling_edge
op_or_assign
id|gpio_mask
suffix:semicolon
)brace
r_else
id|GPIO_IRQ_falling_edge
op_and_assign
op_complement
id|gpio_mask
suffix:semicolon
r_if
c_cond
(paren
id|edge
op_amp
id|GPIO_RISING_EDGE
)paren
(brace
id|GPIO_IRQ_rising_edge
op_or_assign
id|gpio_mask
suffix:semicolon
)brace
r_else
id|GPIO_IRQ_rising_edge
op_and_assign
op_complement
id|gpio_mask
suffix:semicolon
)brace
DECL|variable|set_GPIO_IRQ_edge
id|EXPORT_SYMBOL
c_func
(paren
id|set_GPIO_IRQ_edge
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SA1100_ASSABET
DECL|variable|BCR_value
r_int
r_int
id|BCR_value
op_assign
id|BCR_DB1110
suffix:semicolon
DECL|variable|SCR_value
r_int
r_int
id|SCR_value
op_assign
id|SCR_INIT
suffix:semicolon
DECL|variable|BCR_value
id|EXPORT_SYMBOL
c_func
(paren
id|BCR_value
)paren
suffix:semicolon
DECL|variable|SCR_value
id|EXPORT_SYMBOL
c_func
(paren
id|SCR_value
)paren
suffix:semicolon
multiline_comment|/*&n; * Read System Configuration &quot;Register&quot;&n; * (taken from &quot;Intel StrongARM SA-1110 Microprocessor Development Board&n; * User&squot;s Guide&quot;, section 4.4.1)&n; *&n; * This same scan is performed in arch/arm/boot/compressed/head-sa1100.S&n; * to set up the serial port for decompression status messages. We &n; * repeat it here because the kernel may not be loaded as a zImage, and&n; * also because it&squot;s a hassle to communicate the SCR value to the kernel&n; * from the decompressor.&n; */
DECL|function|get_assabet_scr
r_void
id|__init
id|get_assabet_scr
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
comma
id|scr
comma
id|i
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|GPDR
op_or_assign
l_int|0x3fc
suffix:semicolon
multiline_comment|/* Configure GPIO 9:2 as outputs */
id|GPSR
op_assign
l_int|0x3fc
suffix:semicolon
multiline_comment|/* Write 0xFF to GPIO 9:2 */
id|GPDR
op_and_assign
op_complement
(paren
l_int|0x3fc
)paren
suffix:semicolon
multiline_comment|/* Configure GPIO 9:2 as inputs */
r_for
c_loop
(paren
id|i
op_assign
l_int|100
suffix:semicolon
id|i
op_decrement
suffix:semicolon
id|scr
op_assign
id|GPLR
)paren
(brace
suffix:semicolon
)brace
multiline_comment|/* Read GPIO 9:2 */
id|GPDR
op_or_assign
l_int|0x3fc
suffix:semicolon
multiline_comment|/*  restore correct pin direction */
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
id|scr
op_and_assign
l_int|0x3fc
suffix:semicolon
multiline_comment|/* save as system configuration byte. */
id|SCR_value
op_assign
id|scr
suffix:semicolon
)brace
macro_line|#endif  /* CONFIG_SA1100_ASSABET */
macro_line|#if defined(CONFIG_SA1100_BITSY)
multiline_comment|/*&n; * Bitsy has extended, write-only memory-mapped GPIO&squot;s&n; */
DECL|variable|bitsy_egpio
r_static
r_int
id|bitsy_egpio
op_assign
id|EGPIO_BITSY_RS232_ON
suffix:semicolon
DECL|function|clr_bitsy_egpio
r_void
id|clr_bitsy_egpio
c_func
(paren
r_int
r_int
id|x
)paren
(brace
id|bitsy_egpio
op_and_assign
op_complement
id|x
suffix:semicolon
id|BITSY_EGPIO
op_assign
id|bitsy_egpio
suffix:semicolon
)brace
DECL|function|set_bitsy_egpio
r_void
id|set_bitsy_egpio
c_func
(paren
r_int
r_int
id|x
)paren
(brace
id|bitsy_egpio
op_or_assign
id|x
suffix:semicolon
id|BITSY_EGPIO
op_assign
id|bitsy_egpio
suffix:semicolon
)brace
DECL|variable|clr_bitsy_egpio
id|EXPORT_SYMBOL
c_func
(paren
id|clr_bitsy_egpio
)paren
suffix:semicolon
DECL|variable|set_bitsy_egpio
id|EXPORT_SYMBOL
c_func
(paren
id|set_bitsy_egpio
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_SA1111
DECL|function|sa1111_init
r_static
r_void
id|__init
(def_block
id|sa1111_init
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|id
op_assign
id|SKID
suffix:semicolon
r_if
c_cond
(paren
(paren
id|id
op_amp
id|SKID_ID_MASK
)paren
op_eq
id|SKID_SA1111_ID
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;SA-1111 Microprocessor Companion Chip: &quot;
l_string|&quot;silicon revision %x, metal revision %x&bslash;n&quot;
comma
(paren
id|id
op_amp
id|SKID_SIREV_MASK
)paren
op_rshift
l_int|4
comma
(paren
id|id
op_amp
id|SKID_MTREV_MASK
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Could not detect SA-1111!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* First, set up the 3.6864MHz clock on GPIO 27 for the SA-1111:&n;   * (SA-1110 Developer&squot;s Manual, section 9.1.2.1)&n;   */
id|GAFR
op_or_assign
id|GPIO_32_768kHz
suffix:semicolon
id|GPDR
op_or_assign
id|GPIO_32_768kHz
suffix:semicolon
id|TUCR
op_assign
id|TUCR_3_6864MHz
suffix:semicolon
multiline_comment|/* Now, set up the PLL and RCLK in the SA-1111: */
id|SKCR
op_assign
id|SKCR_PLL_BYPASS
op_or
id|SKCR_RDYEN
op_or
id|SKCR_OE_EN
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|SKCR
op_assign
id|SKCR_PLL_BYPASS
op_or
id|SKCR_RCLKEN
op_or
id|SKCR_RDYEN
op_or
id|SKCR_OE_EN
suffix:semicolon
multiline_comment|/* SA-1111 Register Access Bus should now be available. Clocks for&n;   * any other SA-1111 functional blocks must be enabled separately&n;   * using the SKPCR.&n;   */
multiline_comment|/* If the system is going to use the SA-1111 DMA engines, set up&n;   * the memory bus request/grant pins. Also configure the shared&n;   * memory controller on the SA-1111 (SA-1111 Developer&squot;s Manual,&n;   * section 3.2.3) and power up the DMA bus clock:&n;   */
r_if
c_cond
(paren
id|machine_is_assabet
c_func
(paren
)paren
)paren
(brace
id|GAFR
op_or_assign
(paren
id|GPIO_MBGNT
op_or
id|GPIO_MBREQ
)paren
suffix:semicolon
id|GPDR
op_or_assign
id|GPIO_MBGNT
suffix:semicolon
id|GPDR
op_and_assign
op_complement
id|GPIO_MBREQ
suffix:semicolon
id|TUCR
op_or_assign
id|TUCR_MR
suffix:semicolon
multiline_comment|/* Assabet is populated by default with two Samsung KM416S8030T-G8&n;     * 128Mb SDRAMs, which are organized as 12-bit (row addr) x 9-bit&n;     * (column addr), according to the data sheet. Apparently, the &n;     * bank selects factor into the row address, as Angel sets up the&n;     * SA-1110 to use 14x9 addresses. The SDRAM datasheet specifies&n;     * that when running at 100-125MHz, the CAS latency for -8 parts&n;     * is 3 cycles, which is consistent with Angel.&n;     */
id|SMCR
op_assign
(paren
id|SMCR_DTIM
op_or
id|SMCR_MBGE
op_or
id|FInsrt
c_func
(paren
id|FExtr
c_func
(paren
id|MDCNFG
comma
id|MDCNFG_SA1110_DRAC0
)paren
comma
id|SMCR_DRAC
)paren
op_or
(paren
(paren
id|FExtr
c_func
(paren
id|MDCNFG
comma
id|MDCNFG_SA1110_TDL0
)paren
op_eq
l_int|3
)paren
ques
c_cond
id|SMCR_CLAT
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|SKPCR
op_or_assign
id|SKPCR_DCLKEN
suffix:semicolon
)brace
)brace
)def_block
macro_line|#else
DECL|macro|sa1111_init
mdefine_line|#define sa1111_init()  printk( &quot;Warning: missing SA1111 support&bslash;n&quot; )
macro_line|#endif
DECL|function|hw_sa1100_init
r_static
r_int
id|__init
id|hw_sa1100_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|machine_is_assabet
c_func
(paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|machine_has_neponset
c_func
(paren
)paren
)paren
(brace
macro_line|#ifdef CONFIG_ASSABET_NEPONSET
id|LEDS
op_assign
id|WHOAMI
suffix:semicolon
id|sa1111_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
l_string|&quot;Warning: Neponset detected but full support &quot;
l_string|&quot;hasn&squot;t been configured in the kernel&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_else
r_if
c_cond
(paren
id|machine_is_xp860
c_func
(paren
)paren
)paren
(brace
id|sa1111_init
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|hw_sa1100_init
id|module_init
c_func
(paren
id|hw_sa1100_init
)paren
suffix:semicolon
eof
