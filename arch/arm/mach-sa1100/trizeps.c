multiline_comment|/*&n; * linux/arch/arm/mach-sa1100/trizeps.c&n; *&n; * Authors:&n; * Andreas Hofer &lt;ho@dsa-ac.de&gt;,&n; * Peter Lueg &lt;pl@dsa-ac.de&gt;,&n; * Guennadi Liakhovetski &lt;gl@dsa-ac.de&gt;&n; *&n; * This file contains all Trizeps-specific tweaks.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
macro_line|#include &lt;linux/serial_8250.h&gt;
macro_line|#include &lt;asm/mach-types.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/arch/trizeps.h&gt;
macro_line|#include &lt;asm/setup.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/mach/arch.h&gt;
macro_line|#include &lt;asm/mach/map.h&gt;
macro_line|#include &lt;asm/mach/irq.h&gt;
macro_line|#include &lt;asm/mach/serial_sa1100.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/arch/irqs.h&gt;
macro_line|#include &quot;generic.h&quot;
DECL|macro|DEBUG_TRIZEPS
macro_line|#undef DEBUG_TRIZEPS
macro_line|#ifdef DEBUG_TRIZEPS
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(fmt, args...) printk(&quot;%s: &quot; fmt, __FUNCTION__ , ## args)
macro_line|#else
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK( x... )
macro_line|#endif
DECL|variable|tri_uart_cts_data
r_static
r_struct
id|tri_uart_cts_data_t
id|tri_uart_cts_data
(braket
)braket
op_assign
(brace
(brace
id|TRIZEPS_GPIO_UART1_CTS
comma
l_int|0
comma
l_int|NULL
comma
l_int|NULL
comma
l_string|&quot;int. UART1 cts&quot;
)brace
comma
(brace
id|TRIZEPS_GPIO_UART2_CTS
comma
l_int|0
comma
l_int|NULL
comma
l_int|NULL
comma
l_string|&quot;int. UART2 cts&quot;
)brace
comma
(brace
id|TRIZEPS_GPIO_UART3_CTS
comma
l_int|0
comma
l_int|NULL
comma
l_int|NULL
comma
l_string|&quot;int. UART3 cts&quot;
)brace
)brace
suffix:semicolon
DECL|function|trizeps_cts_intr
r_static
r_void
id|trizeps_cts_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|tri_uart_cts_data_t
op_star
id|uart_data
op_assign
(paren
r_struct
id|tri_uart_cts_data_t
op_star
)paren
id|dev_id
suffix:semicolon
r_int
id|cts
op_assign
(paren
op_logical_neg
(paren
id|GPLR
op_amp
id|uart_data-&gt;cts_gpio
)paren
)paren
suffix:semicolon
multiline_comment|/* NOTE: I suppose that we will not get any interrupts&n;&t;   if the GPIO is not changed, so maybe&n;&t;   the cts_prev_state can be removed ... */
r_if
c_cond
(paren
id|cts
op_ne
id|uart_data-&gt;cts_prev_state
)paren
(brace
id|uart_data-&gt;cts_prev_state
op_assign
id|cts
suffix:semicolon
id|uart_handle_cts_change
c_func
(paren
id|uart_data-&gt;port
comma
id|cts
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;(IRQ %d) changed (cts=%d) stop=%d&bslash;n&quot;
comma
id|irq
comma
id|cts
comma
id|uart_data-&gt;info-&gt;tty-&gt;hw_stopped
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|trizeps_register_cts_intr
id|trizeps_register_cts_intr
c_func
(paren
r_int
id|gpio
comma
r_int
id|irq
comma
r_struct
id|tri_uart_cts_data_t
op_star
id|uart_data
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_ne
id|NO_IRQ
)paren
(brace
id|set_irq_type
c_func
(paren
id|irq
comma
id|IRQT_BOTHEDGE
)paren
suffix:semicolon
id|ret
op_assign
id|request_irq
c_func
(paren
id|irq
comma
id|trizeps_cts_intr
comma
id|SA_INTERRUPT
comma
id|uart_data-&gt;name
comma
id|uart_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;uart_open: failed to register CTS irq (%d)&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|trizeps_set_mctrl
r_static
r_void
id|trizeps_set_mctrl
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
id|u_int
id|mctrl
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;mapbase
op_eq
id|_Ser1UTCR0
)paren
(brace
multiline_comment|/**** ttySA1  ****/
r_if
c_cond
(paren
id|mctrl
op_amp
id|TIOCM_RTS
)paren
id|GPCR
op_or_assign
id|TRIZEPS_GPIO_UART1_RTS
suffix:semicolon
r_else
id|GPSR
op_or_assign
id|TRIZEPS_GPIO_UART1_RTS
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;2 ttySA%d Set RTS %s&bslash;n&quot;
comma
id|port-&gt;line
comma
id|mctrl
op_amp
id|TIOCM_RTS
ques
c_cond
l_string|&quot;low&quot;
suffix:colon
l_string|&quot;high&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|port-&gt;mapbase
op_eq
id|_Ser3UTCR0
)paren
(brace
multiline_comment|/**** ttySA0  ****/
)brace
r_else
(brace
multiline_comment|/**** ttySA2  ****/
)brace
)brace
DECL|function|trizeps_get_mctrl
r_static
id|u_int
id|trizeps_get_mctrl
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_int
id|result
op_assign
id|TIOCM_CD
op_or
id|TIOCM_DSR
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;mapbase
op_eq
id|_Ser1UTCR0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|GPLR
op_amp
id|TRIZEPS_GPIO_UART1_CTS
)paren
)paren
id|result
op_or_assign
id|TIOCM_CTS
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|port-&gt;mapbase
op_eq
id|_Ser2UTCR0
)paren
(brace
id|result
op_or_assign
id|TIOCM_CTS
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|port-&gt;mapbase
op_eq
id|_Ser3UTCR0
)paren
(brace
id|result
op_or_assign
id|TIOCM_CTS
suffix:semicolon
)brace
r_else
(brace
id|result
op_assign
id|TIOCM_CTS
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot; ttySA%d %s%s%s&bslash;n&quot;
comma
id|port-&gt;line
comma
id|result
op_amp
id|TIOCM_CD
ques
c_cond
l_string|&quot;CD &quot;
suffix:colon
l_string|&quot;&quot;
comma
id|result
op_amp
id|TIOCM_CTS
ques
c_cond
l_string|&quot;CTS &quot;
suffix:colon
l_string|&quot;&quot;
comma
id|result
op_amp
id|TIOCM_DSR
ques
c_cond
l_string|&quot;DSR &quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|variable|__initdata
r_static
r_struct
id|sa1100_port_fns
id|trizeps_port_fns
id|__initdata
op_assign
(brace
dot
id|set_mctrl
op_assign
id|trizeps_set_mctrl
comma
dot
id|get_mctrl
op_assign
id|trizeps_get_mctrl
comma
)brace
suffix:semicolon
DECL|function|trizeps_power_off
r_static
r_void
id|trizeps_power_off
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;trizeps power off&bslash;n&quot;
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* disable internal oscillator, float CS lines */
id|PCFR
op_assign
(paren
id|PCFR_OPDE
op_or
id|PCFR_FP
op_or
id|PCFR_FS
)paren
suffix:semicolon
multiline_comment|/* enable wake-up on GPIO0 (Assabet...) */
id|PWER
op_assign
id|GFER
op_assign
id|GRER
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * set scratchpad to zero, just in case it is used as a&n;&t; * restart address by the bootloader.&n;&t; */
id|PSPR
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; *  Power off&n;&t; *  -&gt; disconnect AKku&n;&t; */
id|TRIZEPS_BCR_set
c_func
(paren
id|TRIZEPS_BCR0
comma
id|TRIZEPS_MFT_OFF
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * if power supply no Akku&n;&t; * -&gt; enter sleep mode&n;&t; */
id|PMCR
op_assign
id|PMCR_SF
suffix:semicolon
)brace
DECL|variable|serial_platform_data
r_static
r_struct
id|plat_serial8250_port
id|serial_platform_data
(braket
)braket
op_assign
(brace
(brace
dot
id|mapbase
op_assign
id|TRIZEPS_UART5
comma
dot
id|irq
op_assign
id|IRQ_GPIO16
comma
dot
id|uartclk
op_assign
l_int|24000000
comma
dot
id|regshift
op_assign
l_int|0
comma
dot
id|iotype
op_assign
id|UPIO_PORT
comma
dot
id|flags
op_assign
id|UPF_BOOT_AUTOCONF
op_or
id|UPF_SKIP_TEST
comma
)brace
comma
(brace
dot
id|mapbase
op_assign
id|TRIZEPS_UART6
comma
dot
id|irq
op_assign
id|IRQ_GPIO17
comma
dot
id|uartclk
op_assign
l_int|24000000
comma
dot
id|regshift
op_assign
l_int|0
comma
dot
id|iotype
op_assign
id|UPIO_PORT
comma
dot
id|flags
op_assign
id|UPF_BOOT_AUTOCONF
op_or
id|UPF_SKIP_TEST
comma
)brace
comma
(brace
)brace
comma
)brace
suffix:semicolon
DECL|variable|serial_device
r_static
r_struct
id|platform_device
id|serial_device
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;serial8250&quot;
comma
dot
id|id
op_assign
l_int|0
comma
dot
id|dev
op_assign
(brace
dot
id|platform_data
op_assign
id|serial_platform_data
comma
)brace
comma
)brace
suffix:semicolon
DECL|function|trizeps_init
r_static
r_int
id|__init
id|trizeps_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|machine_is_trizeps
c_func
(paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot; &bslash;n&quot;
)paren
suffix:semicolon
id|pm_power_off
op_assign
id|trizeps_power_off
suffix:semicolon
singleline_comment|// Init UART2 for IrDA
singleline_comment|//&t;PPDR |= PPC_TXD2;           // Set TXD2 as output
id|Ser2UTCR4
op_assign
id|UTCR4_HSE
suffix:semicolon
singleline_comment|// enable HSE
id|Ser2HSCR0
op_assign
l_int|0
suffix:semicolon
id|Ser2HSSR0
op_assign
id|HSSR0_EIF
op_or
id|HSSR0_TUR
op_or
id|HSSR0_RAB
op_or
id|HSSR0_FRE
suffix:semicolon
multiline_comment|/* Init MECR */
id|MECR
op_assign
l_int|0x00060006
suffix:semicolon
multiline_comment|/* Set up external serial IRQs */
id|GAFR
op_and_assign
op_complement
(paren
id|GPIO_GPIO16
op_or
id|GPIO_GPIO17
)paren
suffix:semicolon
singleline_comment|// no alternate function
id|GPDR
op_and_assign
op_complement
(paren
id|GPIO_GPIO16
op_or
id|GPIO_GPIO17
)paren
suffix:semicolon
singleline_comment|// Set to Input
id|set_irq_type
c_func
(paren
id|IRQ_GPIO16
comma
id|IRQT_RISING
)paren
suffix:semicolon
id|set_irq_type
c_func
(paren
id|IRQ_GPIO17
comma
id|IRQT_RISING
)paren
suffix:semicolon
id|platform_device_register
c_func
(paren
op_amp
id|serial_device
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|trizeps_init
id|__initcall
c_func
(paren
id|trizeps_init
)paren
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|map_desc
id|trizeps_io_desc
(braket
)braket
id|__initdata
op_assign
(brace
multiline_comment|/* virtual&t;physical&t;length&t;type */
(brace
l_int|0xF0000000l
comma
l_int|0x30000000l
comma
l_int|0x00800000l
comma
id|MT_DEVICE
)brace
comma
(brace
l_int|0xF2000000l
comma
l_int|0x38000000l
comma
l_int|0x00800000l
comma
id|MT_DEVICE
)brace
comma
)brace
suffix:semicolon
DECL|function|trizeps_map_io
r_static
r_void
id|__init
id|trizeps_map_io
c_func
(paren
r_void
)paren
(brace
id|sa1100_map_io
c_func
(paren
)paren
suffix:semicolon
id|iotable_init
c_func
(paren
id|trizeps_io_desc
comma
id|ARRAY_SIZE
c_func
(paren
id|trizeps_io_desc
)paren
)paren
suffix:semicolon
id|sa1100_register_uart_fns
c_func
(paren
op_amp
id|trizeps_port_fns
)paren
suffix:semicolon
id|sa1100_register_uart
c_func
(paren
l_int|0
comma
l_int|3
)paren
suffix:semicolon
id|sa1100_register_uart
c_func
(paren
l_int|1
comma
l_int|1
)paren
suffix:semicolon
id|sa1100_register_uart
c_func
(paren
l_int|2
comma
l_int|2
)paren
suffix:semicolon
)brace
id|MACHINE_START
c_func
(paren
id|TRIZEPS
comma
l_string|&quot;TRIZEPS&quot;
)paren
id|MAINTAINER
c_func
(paren
l_string|&quot;DSA&quot;
)paren
id|BOOT_MEM
c_func
(paren
l_int|0xc0000000
comma
l_int|0x80000000
comma
l_int|0xf8000000
)paren
id|MAPIO
c_func
(paren
id|trizeps_map_io
)paren
id|INITIRQ
c_func
(paren
id|sa1100_init_irq
)paren
dot
id|timer
op_assign
op_amp
id|sa1100_timer
comma
id|MACHINE_END
eof
