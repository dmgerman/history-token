multiline_comment|/*&n; *  linux/arch/arm/kernel/compat.c&n; *&n; *  Copyright (C) 2001 Russell King&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; * We keep the old params compatibility cruft in one place (here)&n; * so we don&squot;t end up with lots of mess around other places.&n; *&n; * NOTE:&n; *  The old struct param_struct is deprecated, but it will be kept in&n; *  the kernel for 5 years from now (2001). This will allow boot loaders&n; *  to convert to the new struct tag way.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/setup.h&gt;
macro_line|#include &lt;asm/mach-types.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/mach/arch.h&gt;
multiline_comment|/*&n; * Usage:&n; *  - do not go blindly adding fields, add them at the end&n; *  - when adding fields, don&squot;t rely on the address until&n; *    a patch from me has been released&n; *  - unused fields should be zero (for future expansion)&n; *  - this structure is relatively short-lived - only&n; *    guaranteed to contain useful data in setup_arch()&n; *&n; * This is the old deprecated way to pass parameters to the kernel&n; */
DECL|struct|param_struct
r_struct
id|param_struct
(brace
r_union
(brace
r_struct
(brace
DECL|member|page_size
r_int
r_int
id|page_size
suffix:semicolon
multiline_comment|/*  0 */
DECL|member|nr_pages
r_int
r_int
id|nr_pages
suffix:semicolon
multiline_comment|/*  4 */
DECL|member|ramdisk_size
r_int
r_int
id|ramdisk_size
suffix:semicolon
multiline_comment|/*  8 */
DECL|member|flags
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* 12 */
DECL|macro|FLAG_READONLY
mdefine_line|#define FLAG_READONLY&t;1
DECL|macro|FLAG_RDLOAD
mdefine_line|#define FLAG_RDLOAD&t;4
DECL|macro|FLAG_RDPROMPT
mdefine_line|#define FLAG_RDPROMPT&t;8
DECL|member|rootdev
r_int
r_int
id|rootdev
suffix:semicolon
multiline_comment|/* 16 */
DECL|member|video_num_cols
r_int
r_int
id|video_num_cols
suffix:semicolon
multiline_comment|/* 20 */
DECL|member|video_num_rows
r_int
r_int
id|video_num_rows
suffix:semicolon
multiline_comment|/* 24 */
DECL|member|video_x
r_int
r_int
id|video_x
suffix:semicolon
multiline_comment|/* 28 */
DECL|member|video_y
r_int
r_int
id|video_y
suffix:semicolon
multiline_comment|/* 32 */
DECL|member|memc_control_reg
r_int
r_int
id|memc_control_reg
suffix:semicolon
multiline_comment|/* 36 */
DECL|member|sounddefault
r_int
r_char
id|sounddefault
suffix:semicolon
multiline_comment|/* 40 */
DECL|member|adfsdrives
r_int
r_char
id|adfsdrives
suffix:semicolon
multiline_comment|/* 41 */
DECL|member|bytes_per_char_h
r_int
r_char
id|bytes_per_char_h
suffix:semicolon
multiline_comment|/* 42 */
DECL|member|bytes_per_char_v
r_int
r_char
id|bytes_per_char_v
suffix:semicolon
multiline_comment|/* 43 */
DECL|member|pages_in_bank
r_int
r_int
id|pages_in_bank
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* 44 */
DECL|member|pages_in_vram
r_int
r_int
id|pages_in_vram
suffix:semicolon
multiline_comment|/* 60 */
DECL|member|initrd_start
r_int
r_int
id|initrd_start
suffix:semicolon
multiline_comment|/* 64 */
DECL|member|initrd_size
r_int
r_int
id|initrd_size
suffix:semicolon
multiline_comment|/* 68 */
DECL|member|rd_start
r_int
r_int
id|rd_start
suffix:semicolon
multiline_comment|/* 72 */
DECL|member|system_rev
r_int
r_int
id|system_rev
suffix:semicolon
multiline_comment|/* 76 */
DECL|member|system_serial_low
r_int
r_int
id|system_serial_low
suffix:semicolon
multiline_comment|/* 80 */
DECL|member|system_serial_high
r_int
r_int
id|system_serial_high
suffix:semicolon
multiline_comment|/* 84 */
DECL|member|mem_fclk_21285
r_int
r_int
id|mem_fclk_21285
suffix:semicolon
multiline_comment|/* 88 */
DECL|member|s
)brace
id|s
suffix:semicolon
DECL|member|unused
r_char
id|unused
(braket
l_int|256
)braket
suffix:semicolon
DECL|member|u1
)brace
id|u1
suffix:semicolon
r_union
(brace
DECL|member|paths
r_char
id|paths
(braket
l_int|8
)braket
(braket
l_int|128
)braket
suffix:semicolon
r_struct
(brace
DECL|member|magic
r_int
r_int
id|magic
suffix:semicolon
DECL|member|n
r_char
id|n
(braket
l_int|1024
op_minus
r_sizeof
(paren
r_int
r_int
)paren
)braket
suffix:semicolon
DECL|member|s
)brace
id|s
suffix:semicolon
DECL|member|u2
)brace
id|u2
suffix:semicolon
DECL|member|commandline
r_char
id|commandline
(braket
id|COMMAND_LINE_SIZE
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|function|memtag
r_static
r_struct
id|tag
op_star
id|__init
id|memtag
c_func
(paren
r_struct
id|tag
op_star
id|tag
comma
r_int
r_int
id|start
comma
r_int
r_int
id|size
)paren
(brace
id|tag
op_assign
id|tag_next
c_func
(paren
id|tag
)paren
suffix:semicolon
id|tag-&gt;hdr.tag
op_assign
id|ATAG_MEM
suffix:semicolon
id|tag-&gt;hdr.size
op_assign
id|tag_size
c_func
(paren
id|tag_mem32
)paren
suffix:semicolon
id|tag-&gt;u.mem.size
op_assign
id|size
suffix:semicolon
id|tag-&gt;u.mem.start
op_assign
id|start
suffix:semicolon
r_return
id|tag
suffix:semicolon
)brace
DECL|function|build_tag_list
r_static
r_void
id|__init
id|build_tag_list
c_func
(paren
r_struct
id|param_struct
op_star
id|params
comma
r_void
op_star
id|taglist
)paren
(brace
r_struct
id|tag
op_star
id|tag
op_assign
id|taglist
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;u1.s.page_size
op_ne
id|PAGE_SIZE
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Warning: bad configuration page, &quot;
l_string|&quot;trying to continue&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Converting old-style param struct to taglist&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ARCH_NETWINDER
r_if
c_cond
(paren
id|params-&gt;u1.s.nr_pages
op_ne
l_int|0x02000
op_logical_and
id|params-&gt;u1.s.nr_pages
op_ne
l_int|0x04000
op_logical_and
id|params-&gt;u1.s.nr_pages
op_ne
l_int|0x08000
op_logical_and
id|params-&gt;u1.s.nr_pages
op_ne
l_int|0x10000
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Warning: bad NeTTrom parameters &quot;
l_string|&quot;detected, using defaults&bslash;n&quot;
)paren
suffix:semicolon
id|params-&gt;u1.s.nr_pages
op_assign
l_int|0x1000
suffix:semicolon
multiline_comment|/* 16MB */
id|params-&gt;u1.s.ramdisk_size
op_assign
l_int|0
suffix:semicolon
id|params-&gt;u1.s.flags
op_assign
id|FLAG_READONLY
suffix:semicolon
id|params-&gt;u1.s.initrd_start
op_assign
l_int|0
suffix:semicolon
id|params-&gt;u1.s.initrd_size
op_assign
l_int|0
suffix:semicolon
id|params-&gt;u1.s.rd_start
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
id|tag-&gt;hdr.tag
op_assign
id|ATAG_CORE
suffix:semicolon
id|tag-&gt;hdr.size
op_assign
id|tag_size
c_func
(paren
id|tag_core
)paren
suffix:semicolon
id|tag-&gt;u.core.flags
op_assign
id|params-&gt;u1.s.flags
op_amp
id|FLAG_READONLY
suffix:semicolon
id|tag-&gt;u.core.pagesize
op_assign
id|params-&gt;u1.s.page_size
suffix:semicolon
id|tag-&gt;u.core.rootdev
op_assign
id|params-&gt;u1.s.rootdev
suffix:semicolon
id|tag
op_assign
id|tag_next
c_func
(paren
id|tag
)paren
suffix:semicolon
id|tag-&gt;hdr.tag
op_assign
id|ATAG_RAMDISK
suffix:semicolon
id|tag-&gt;hdr.size
op_assign
id|tag_size
c_func
(paren
id|tag_ramdisk
)paren
suffix:semicolon
id|tag-&gt;u.ramdisk.flags
op_assign
(paren
id|params-&gt;u1.s.flags
op_amp
id|FLAG_RDLOAD
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
op_or
(paren
id|params-&gt;u1.s.flags
op_amp
id|FLAG_RDPROMPT
ques
c_cond
l_int|2
suffix:colon
l_int|0
)paren
suffix:semicolon
id|tag-&gt;u.ramdisk.size
op_assign
id|params-&gt;u1.s.ramdisk_size
suffix:semicolon
id|tag-&gt;u.ramdisk.start
op_assign
id|params-&gt;u1.s.rd_start
suffix:semicolon
id|tag
op_assign
id|tag_next
c_func
(paren
id|tag
)paren
suffix:semicolon
id|tag-&gt;hdr.tag
op_assign
id|ATAG_INITRD
suffix:semicolon
id|tag-&gt;hdr.size
op_assign
id|tag_size
c_func
(paren
id|tag_initrd
)paren
suffix:semicolon
id|tag-&gt;u.initrd.start
op_assign
id|params-&gt;u1.s.initrd_start
suffix:semicolon
id|tag-&gt;u.initrd.size
op_assign
id|params-&gt;u1.s.initrd_size
suffix:semicolon
id|tag
op_assign
id|tag_next
c_func
(paren
id|tag
)paren
suffix:semicolon
id|tag-&gt;hdr.tag
op_assign
id|ATAG_SERIAL
suffix:semicolon
id|tag-&gt;hdr.size
op_assign
id|tag_size
c_func
(paren
id|tag_serialnr
)paren
suffix:semicolon
id|tag-&gt;u.serialnr.low
op_assign
id|params-&gt;u1.s.system_serial_low
suffix:semicolon
id|tag-&gt;u.serialnr.high
op_assign
id|params-&gt;u1.s.system_serial_high
suffix:semicolon
id|tag
op_assign
id|tag_next
c_func
(paren
id|tag
)paren
suffix:semicolon
id|tag-&gt;hdr.tag
op_assign
id|ATAG_REVISION
suffix:semicolon
id|tag-&gt;hdr.size
op_assign
id|tag_size
c_func
(paren
id|tag_revision
)paren
suffix:semicolon
id|tag-&gt;u.revision.rev
op_assign
id|params-&gt;u1.s.system_rev
suffix:semicolon
macro_line|#ifdef CONFIG_ARCH_ACORN
r_if
c_cond
(paren
id|machine_is_riscpc
c_func
(paren
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|tag
op_assign
id|memtag
c_func
(paren
id|tag
comma
id|PHYS_OFFSET
op_plus
(paren
id|i
op_lshift
l_int|26
)paren
comma
id|params-&gt;u1.s.pages_in_bank
(braket
id|i
)braket
op_star
id|PAGE_SIZE
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
id|tag
op_assign
id|memtag
c_func
(paren
id|tag
comma
id|PHYS_OFFSET
comma
id|params-&gt;u1.s.nr_pages
op_star
id|PAGE_SIZE
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_FOOTBRIDGE
r_if
c_cond
(paren
id|params-&gt;u1.s.mem_fclk_21285
)paren
(brace
id|tag
op_assign
id|tag_next
c_func
(paren
id|tag
)paren
suffix:semicolon
id|tag-&gt;hdr.tag
op_assign
id|ATAG_MEMCLK
suffix:semicolon
id|tag-&gt;hdr.size
op_assign
id|tag_size
c_func
(paren
id|tag_memclk
)paren
suffix:semicolon
id|tag-&gt;u.memclk.fmemclk
op_assign
id|params-&gt;u1.s.mem_fclk_21285
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_ARCH_EBSA285
r_if
c_cond
(paren
id|machine_is_ebsa285
c_func
(paren
)paren
)paren
(brace
id|tag
op_assign
id|tag_next
c_func
(paren
id|tag
)paren
suffix:semicolon
id|tag-&gt;hdr.tag
op_assign
id|ATAG_VIDEOTEXT
suffix:semicolon
id|tag-&gt;hdr.size
op_assign
id|tag_size
c_func
(paren
id|tag_videotext
)paren
suffix:semicolon
id|tag-&gt;u.videotext.x
op_assign
id|params-&gt;u1.s.video_x
suffix:semicolon
id|tag-&gt;u.videotext.y
op_assign
id|params-&gt;u1.s.video_y
suffix:semicolon
id|tag-&gt;u.videotext.video_page
op_assign
l_int|0
suffix:semicolon
id|tag-&gt;u.videotext.video_mode
op_assign
l_int|0
suffix:semicolon
id|tag-&gt;u.videotext.video_cols
op_assign
id|params-&gt;u1.s.video_num_cols
suffix:semicolon
id|tag-&gt;u.videotext.video_ega_bx
op_assign
l_int|0
suffix:semicolon
id|tag-&gt;u.videotext.video_lines
op_assign
id|params-&gt;u1.s.video_num_rows
suffix:semicolon
id|tag-&gt;u.videotext.video_isvga
op_assign
l_int|1
suffix:semicolon
id|tag-&gt;u.videotext.video_points
op_assign
l_int|8
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_ARCH_ACORN
id|tag
op_assign
id|tag_next
c_func
(paren
id|tag
)paren
suffix:semicolon
id|tag-&gt;hdr.tag
op_assign
id|ATAG_ACORN
suffix:semicolon
id|tag-&gt;hdr.size
op_assign
id|tag_size
c_func
(paren
id|tag_acorn
)paren
suffix:semicolon
id|tag-&gt;u.acorn.memc_control_reg
op_assign
id|params-&gt;u1.s.memc_control_reg
suffix:semicolon
id|tag-&gt;u.acorn.vram_pages
op_assign
id|params-&gt;u1.s.pages_in_vram
suffix:semicolon
id|tag-&gt;u.acorn.sounddefault
op_assign
id|params-&gt;u1.s.sounddefault
suffix:semicolon
id|tag-&gt;u.acorn.adfsdrives
op_assign
id|params-&gt;u1.s.adfsdrives
suffix:semicolon
macro_line|#endif
id|tag
op_assign
id|tag_next
c_func
(paren
id|tag
)paren
suffix:semicolon
id|tag-&gt;hdr.tag
op_assign
id|ATAG_CMDLINE
suffix:semicolon
id|tag-&gt;hdr.size
op_assign
(paren
id|strlen
c_func
(paren
id|params-&gt;commandline
)paren
op_plus
l_int|3
op_plus
r_sizeof
(paren
r_struct
id|tag_header
)paren
)paren
op_rshift
l_int|2
suffix:semicolon
id|strcpy
c_func
(paren
id|tag-&gt;u.cmdline.cmdline
comma
id|params-&gt;commandline
)paren
suffix:semicolon
id|tag
op_assign
id|tag_next
c_func
(paren
id|tag
)paren
suffix:semicolon
id|tag-&gt;hdr.tag
op_assign
id|ATAG_NONE
suffix:semicolon
id|tag-&gt;hdr.size
op_assign
l_int|0
suffix:semicolon
id|memmove
c_func
(paren
id|params
comma
id|taglist
comma
(paren
(paren
r_int
)paren
id|tag
)paren
op_minus
(paren
(paren
r_int
)paren
id|taglist
)paren
op_plus
r_sizeof
(paren
r_struct
id|tag_header
)paren
)paren
suffix:semicolon
)brace
DECL|function|convert_to_tag_list
r_void
id|__init
id|convert_to_tag_list
c_func
(paren
r_struct
id|tag
op_star
id|tags
)paren
(brace
r_struct
id|param_struct
op_star
id|params
op_assign
(paren
r_struct
id|param_struct
op_star
)paren
id|tags
suffix:semicolon
id|build_tag_list
c_func
(paren
id|params
comma
op_amp
id|params-&gt;u2
)paren
suffix:semicolon
)brace
DECL|function|squash_mem_tags
r_void
id|__init
id|squash_mem_tags
c_func
(paren
r_struct
id|tag
op_star
id|tag
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
id|tag-&gt;hdr.size
suffix:semicolon
id|tag
op_assign
id|tag_next
c_func
(paren
id|tag
)paren
)paren
r_if
c_cond
(paren
id|tag-&gt;hdr.tag
op_eq
id|ATAG_MEM
)paren
id|tag-&gt;hdr.tag
op_assign
id|ATAG_NONE
suffix:semicolon
)brace
eof
