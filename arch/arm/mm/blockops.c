macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/memory.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/cacheflush.h&gt;
macro_line|#include &lt;asm/traps.h&gt;
r_extern
r_struct
id|cpu_cache_fns
id|blk_cache_fns
suffix:semicolon
DECL|macro|HARVARD_CACHE
mdefine_line|#define HARVARD_CACHE
multiline_comment|/*&n; *&t;blk_flush_kern_dcache_page(kaddr)&n; *&n; *&t;Ensure that the data held in the page kaddr is written back&n; *&t;to the page in question.&n; *&n; *&t;- kaddr   - kernel address (guaranteed to be page aligned)&n; */
r_static
r_void
id|__attribute__
c_func
(paren
(paren
id|naked
)paren
)paren
DECL|function|blk_flush_kern_dcache_page
id|blk_flush_kern_dcache_page
c_func
(paren
r_void
op_star
id|kaddr
)paren
(brace
id|asm
c_func
(paren
l_string|&quot;add&t;r1, r0, %0&t;&t;&t;&t;&t;&t;&t;&bslash;n&bslash;&n;1:&t;.word&t;0xec401f0e&t;@ mcrr&t;p15, 0, r0, r1, c14, 0&t;@ blocking&t;&bslash;n&bslash;&n;&t;mov&t;r0, #0&t;&t;&t;&t;&t;&t;&t;&t;&bslash;n&bslash;&n;&t;mcr&t;p15, 0, r0, c7, c5, 0&t;&t;&t;&t;&t;&t;&bslash;n&bslash;&n;&t;mcr&t;p15, 0, r0, c7, c10, 4&t;&t;&t;&t;&t;&t;&bslash;n&bslash;&n;&t;mov&t;pc, lr&quot;
suffix:colon
suffix:colon
l_string|&quot;I&quot;
(paren
id|PAGE_SIZE
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;blk_dma_inv_range(start,end)&n; *&n; *&t;Invalidate the data cache within the specified region; we will&n; *&t;be performing a DMA operation in this region and we want to&n; *&t;purge old data in the cache.&n; *&n; *&t;- start   - virtual start address of region&n; *&t;- end     - virtual end address of region&n; */
r_static
r_void
id|__attribute__
c_func
(paren
(paren
id|naked
)paren
)paren
DECL|function|blk_dma_inv_range_unified
id|blk_dma_inv_range_unified
c_func
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
id|asm
c_func
(paren
l_string|&quot;tst&t;r0, %0&t;&t;&t;&t;&t;&t;&t;&t;&bslash;n&bslash;&n;&t;mcrne&t;p15, 0, r0, c7, c11, 1&t;&t;@ clean unified line&t;&t;&bslash;n&bslash;&n;&t;tst&t;r1, %0&t;&t;&t;&t;&t;&t;&t;&t;&bslash;n&bslash;&n;&t;mcrne&t;p15, 0, r1, c7, c15, 1&t;&t;@ clean &amp; invalidate unified line&bslash;n&bslash;&n;&t;.word&t;0xec401f06&t;@ mcrr&t;p15, 0, r1, r0, c6, 0&t;@ blocking&t;&bslash;n&bslash;&n;&t;mov&t;r0, #0&t;&t;&t;&t;&t;&t;&t;&t;&bslash;n&bslash;&n;&t;mcr&t;p15, 0, r0, c7, c10, 4&t;&t;@ drain write buffer&t;&t;&bslash;n&bslash;&n;&t;mov&t;pc, lr&quot;
suffix:colon
suffix:colon
l_string|&quot;I&quot;
(paren
id|L1_CACHE_BYTES
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
r_static
r_void
id|__attribute__
c_func
(paren
(paren
id|naked
)paren
)paren
DECL|function|blk_dma_inv_range_harvard
id|blk_dma_inv_range_harvard
c_func
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
id|asm
c_func
(paren
l_string|&quot;tst&t;r0, %0&t;&t;&t;&t;&t;&t;&t;&t;&bslash;n&bslash;&n;&t;mcrne&t;p15, 0, r0, c7, c10, 1&t;&t;@ clean D line&t;&t;&t;&bslash;n&bslash;&n;&t;tst&t;r1, %0&t;&t;&t;&t;&t;&t;&t;&t;&bslash;n&bslash;&n;&t;mcrne&t;p15, 0, r1, c7, c14, 1&t;&t;@ clean &amp; invalidate D line&t;&bslash;n&bslash;&n;&t;.word&t;0xec401f06&t;@ mcrr&t;p15, 0, r1, r0, c6, 0&t;@ blocking&t;&bslash;n&bslash;&n;&t;mov&t;r0, #0&t;&t;&t;&t;&t;&t;&t;&t;&bslash;n&bslash;&n;&t;mcr&t;p15, 0, r0, c7, c10, 4&t;&t;@ drain write buffer&t;&t;&bslash;n&bslash;&n;&t;mov&t;pc, lr&quot;
suffix:colon
suffix:colon
l_string|&quot;I&quot;
(paren
id|L1_CACHE_BYTES
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;blk_dma_clean_range(start,end)&n; *&t;- start   - virtual start address of region&n; *&t;- end     - virtual end address of region&n; */
r_static
r_void
id|__attribute__
c_func
(paren
(paren
id|naked
)paren
)paren
DECL|function|blk_dma_clean_range
id|blk_dma_clean_range
c_func
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
id|asm
c_func
(paren
l_string|&quot;.word&t;0xec401f0c&t;@ mcrr&t;p15, 0, r1, r0, c12, 0&t;@ blocking&t;&bslash;n&bslash;&n;&t;mov&t;r0, #0&t;&t;&t;&t;&t;&t;&t;&t;&bslash;n&bslash;&n;&t;mcr&t;p15, 0, r0, c7, c10, 4&t;&t;@ drain write buffer&t;&t;&bslash;n&bslash;&n;&t;mov&t;pc, lr&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;blk_dma_flush_range(start,end)&n; *&t;- start   - virtual start address of region&n; *&t;- end     - virtual end address of region&n; */
r_static
r_void
id|__attribute__
c_func
(paren
(paren
id|naked
)paren
)paren
DECL|function|blk_dma_flush_range
id|blk_dma_flush_range
c_func
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
id|asm
c_func
(paren
l_string|&quot;.word&t;0xec401f0e&t;@ mcrr&t;p15, 0, r1, r0, c14, 0&t;@ blocking&t;&bslash;n&bslash;&n;&t;mov&t;pc, lr&quot;
)paren
suffix:semicolon
)brace
DECL|function|blockops_trap
r_static
r_int
id|blockops_trap
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
r_int
id|instr
)paren
(brace
id|regs-&gt;ARM_r4
op_or_assign
id|regs-&gt;ARM_r2
suffix:semicolon
id|regs-&gt;ARM_pc
op_add_assign
l_int|4
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|func
r_static
r_char
op_star
id|func
(braket
)braket
op_assign
(brace
l_string|&quot;Prefetch data range&quot;
comma
l_string|&quot;Clean+Invalidate data range&quot;
comma
l_string|&quot;Clean data range&quot;
comma
l_string|&quot;Invalidate data range&quot;
comma
l_string|&quot;Invalidate instr range&quot;
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|undef_hook
id|blockops_hook
id|__initdata
op_assign
(brace
dot
id|instr_mask
op_assign
l_int|0x0fffffd0
comma
dot
id|instr_val
op_assign
l_int|0x0c401f00
comma
dot
id|cpsr_mask
op_assign
id|PSR_T_BIT
comma
dot
id|cpsr_val
op_assign
l_int|0
comma
dot
id|fn
op_assign
id|blockops_trap
comma
)brace
suffix:semicolon
DECL|function|blockops_check
r_static
r_int
id|__init
id|blockops_check
c_func
(paren
r_void
)paren
(brace
r_register
r_int
r_int
id|err
id|asm
c_func
(paren
l_string|&quot;r4&quot;
)paren
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|cache_type
suffix:semicolon
r_int
id|i
suffix:semicolon
id|asm
c_func
(paren
l_string|&quot;mrc p15, 0, %0, c0, c0, 1&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|cache_type
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Checking V6 block cache operations:&bslash;n&quot;
)paren
suffix:semicolon
id|register_undef_hook
c_func
(paren
op_amp
id|blockops_hook
)paren
suffix:semicolon
id|__asm__
(paren
l_string|&quot;mov&t;r0, %0&bslash;n&bslash;t&quot;
l_string|&quot;mov&t;r1, %1&bslash;n&bslash;t&quot;
l_string|&quot;mov&t;r2, #1&bslash;n&bslash;t&quot;
l_string|&quot;.word&t;0xec401f2c @ mcrr p15, 0, r1, r0, c12, 2&bslash;n&bslash;t&quot;
l_string|&quot;mov&t;r2, #2&bslash;n&bslash;t&quot;
l_string|&quot;.word&t;0xec401f0e @ mcrr p15, 0, r1, r0, c14, 0&bslash;n&bslash;t&quot;
l_string|&quot;mov&t;r2, #4&bslash;n&bslash;t&quot;
l_string|&quot;.word&t;0xec401f0c @ mcrr p15, 0, r1, r0, c12, 0&bslash;n&bslash;t&quot;
l_string|&quot;mov&t;r2, #8&bslash;n&bslash;t&quot;
l_string|&quot;.word&t;0xec401f06 @ mcrr p15, 0, r1, r0, c6, 0&bslash;n&bslash;t&quot;
l_string|&quot;mov&t;r2, #16&bslash;n&bslash;t&quot;
l_string|&quot;.word&t;0xec401f05 @ mcrr p15, 0, r1, r0, c5, 0&bslash;n&bslash;t&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|PAGE_OFFSET
)paren
comma
l_string|&quot;r&quot;
(paren
id|PAGE_OFFSET
op_plus
l_int|128
)paren
suffix:colon
l_string|&quot;r0&quot;
comma
l_string|&quot;r1&quot;
comma
l_string|&quot;r2&quot;
)paren
suffix:semicolon
id|unregister_undef_hook
c_func
(paren
op_amp
id|blockops_hook
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|func
)paren
suffix:semicolon
id|i
op_increment
comma
id|err
op_rshift_assign
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%30s: %ssupported&bslash;n&quot;
comma
id|func
(braket
id|i
)braket
comma
id|err
op_amp
l_int|1
ques
c_cond
l_string|&quot;not &quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_amp
l_int|8
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; --&gt; Using %s block cache invalidate&bslash;n&quot;
comma
id|cache_type
op_amp
(paren
l_int|1
op_lshift
l_int|24
)paren
ques
c_cond
l_string|&quot;harvard&quot;
suffix:colon
l_string|&quot;unified&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cache_type
op_amp
(paren
l_int|1
op_lshift
l_int|24
)paren
)paren
id|cpu_cache.dma_inv_range
op_assign
id|blk_dma_inv_range_harvard
suffix:semicolon
r_else
id|cpu_cache.dma_inv_range
op_assign
id|blk_dma_inv_range_unified
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_amp
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; --&gt; Using block cache clean&bslash;n&quot;
)paren
suffix:semicolon
id|cpu_cache.dma_clean_range
op_assign
id|blk_dma_clean_range
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_amp
l_int|2
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; --&gt; Using block cache clean+invalidate&bslash;n&quot;
)paren
suffix:semicolon
id|cpu_cache.dma_flush_range
op_assign
id|blk_dma_flush_range
suffix:semicolon
id|cpu_cache.flush_kern_dcache_page
op_assign
id|blk_flush_kern_dcache_page
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|blockops_check
id|__initcall
c_func
(paren
id|blockops_check
)paren
suffix:semicolon
eof
