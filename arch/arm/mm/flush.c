multiline_comment|/*&n; *  linux/arch/arm/mm/flush.c&n; *&n; *  Copyright (C) 1995-2002 Russell King&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;asm/cacheflush.h&gt;
macro_line|#include &lt;asm/system.h&gt;
DECL|function|__flush_dcache_page
r_static
r_void
id|__flush_dcache_page
c_func
(paren
r_struct
id|address_space
op_star
id|mapping
comma
r_struct
id|page
op_star
id|page
)paren
(brace
r_struct
id|mm_struct
op_star
id|mm
op_assign
id|current-&gt;active_mm
suffix:semicolon
r_struct
id|vm_area_struct
op_star
id|mpnt
suffix:semicolon
r_struct
id|prio_tree_iter
id|iter
suffix:semicolon
id|pgoff_t
id|pgoff
suffix:semicolon
multiline_comment|/*&n;&t; * Writeback any data associated with the kernel mapping of this&n;&t; * page.  This ensures that data in the physical page is mutually&n;&t; * coherent with the kernels mapping.&n;&t; */
id|__cpuc_flush_dcache_page
c_func
(paren
id|page_address
c_func
(paren
id|page
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If there&squot;s no mapping pointer here, then this page isn&squot;t&n;&t; * visible to userspace yet, so there are no cache lines&n;&t; * associated with any other aliases.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|mapping
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * There are possible user space mappings of this page:&n;&t; * - VIVT cache: we need to also write back and invalidate all user&n;&t; *   data in the current VM view associated with this page.&n;&t; * - aliasing VIPT: we only need to find one mapping of this page.&n;&t; */
id|pgoff
op_assign
id|page-&gt;index
op_lshift
(paren
id|PAGE_CACHE_SHIFT
op_minus
id|PAGE_SHIFT
)paren
suffix:semicolon
id|flush_dcache_mmap_lock
c_func
(paren
id|mapping
)paren
suffix:semicolon
id|vma_prio_tree_foreach
c_func
(paren
id|mpnt
comma
op_amp
id|iter
comma
op_amp
id|mapping-&gt;i_mmap
comma
id|pgoff
comma
id|pgoff
)paren
(brace
r_int
r_int
id|offset
suffix:semicolon
multiline_comment|/*&n;&t;&t; * If this VMA is not in our MM, we can ignore it.&n;&t;&t; */
r_if
c_cond
(paren
id|mpnt-&gt;vm_mm
op_ne
id|mm
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mpnt-&gt;vm_flags
op_amp
id|VM_MAYSHARE
)paren
)paren
r_continue
suffix:semicolon
id|offset
op_assign
(paren
id|pgoff
op_minus
id|mpnt-&gt;vm_pgoff
)paren
op_lshift
id|PAGE_SHIFT
suffix:semicolon
id|flush_cache_page
c_func
(paren
id|mpnt
comma
id|mpnt-&gt;vm_start
op_plus
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cache_is_vipt
c_func
(paren
)paren
)paren
r_break
suffix:semicolon
)brace
id|flush_dcache_mmap_unlock
c_func
(paren
id|mapping
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Ensure cache coherency between kernel mapping and userspace mapping&n; * of this page.&n; *&n; * We have three cases to consider:&n; *  - VIPT non-aliasing cache: fully coherent so nothing required.&n; *  - VIVT: fully aliasing, so we need to handle every alias in our&n; *          current VM view.&n; *  - VIPT aliasing: need to handle one alias in our current VM view.&n; *&n; * If we need to handle aliasing:&n; *  If the page only exists in the page cache and there are no user&n; *  space mappings, we can be lazy and remember that we may have dirty&n; *  kernel cache lines for later.  Otherwise, we assume we have&n; *  aliasing mappings.&n; */
DECL|function|flush_dcache_page
r_void
id|flush_dcache_page
c_func
(paren
r_struct
id|page
op_star
id|page
)paren
(brace
r_struct
id|address_space
op_star
id|mapping
op_assign
id|page_mapping
c_func
(paren
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cache_is_vipt_nonaliasing
c_func
(paren
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|mapping
op_logical_and
op_logical_neg
id|mapping_mapped
c_func
(paren
id|mapping
)paren
)paren
id|set_bit
c_func
(paren
id|PG_dcache_dirty
comma
op_amp
id|page-&gt;flags
)paren
suffix:semicolon
r_else
id|__flush_dcache_page
c_func
(paren
id|mapping
comma
id|page
)paren
suffix:semicolon
)brace
DECL|variable|flush_dcache_page
id|EXPORT_SYMBOL
c_func
(paren
id|flush_dcache_page
)paren
suffix:semicolon
eof
