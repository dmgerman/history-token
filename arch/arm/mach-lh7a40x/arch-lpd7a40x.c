multiline_comment|/* arch/arm/mach-lh7a40x/arch-lpd7a40x.c&n; *&n; *  Copyright (C) 2004 Logic Product Development&n; *&n; *  This program is free software; you can redistribute it and/or&n; *  modify it under the terms of the GNU General Public License&n; *  version 2 as published by the Free Software Foundation.&n; *&n; */
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/setup.h&gt;
macro_line|#include &lt;asm/mach-types.h&gt;
macro_line|#include &lt;asm/mach/arch.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/mach/irq.h&gt;
macro_line|#include &lt;asm/mach/map.h&gt;
macro_line|#include &quot;common.h&quot;
DECL|variable|smc91x_resources
r_static
r_struct
id|resource
id|smc91x_resources
(braket
)braket
op_assign
(brace
(braket
l_int|0
)braket
op_assign
(brace
dot
id|start
op_assign
id|CPLD00_PHYS
comma
dot
id|end
op_assign
id|CPLD00_PHYS
op_plus
id|CPLD00_SIZE
op_minus
l_int|1
comma
multiline_comment|/* Only needs 16B */
dot
id|flags
op_assign
id|IORESOURCE_MEM
comma
)brace
comma
(braket
l_int|1
)braket
op_assign
(brace
dot
id|start
op_assign
id|IRQ_LPD7A40X_ETH_INT
comma
dot
id|end
op_assign
id|IRQ_LPD7A40X_ETH_INT
comma
dot
id|flags
op_assign
id|IORESOURCE_IRQ
comma
)brace
comma
)brace
suffix:semicolon
DECL|variable|smc91x_device
r_static
r_struct
id|platform_device
id|smc91x_device
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;smc91x&quot;
comma
dot
id|id
op_assign
l_int|0
comma
dot
id|num_resources
op_assign
id|ARRAY_SIZE
c_func
(paren
id|smc91x_resources
)paren
comma
dot
id|resource
op_assign
id|smc91x_resources
comma
)brace
suffix:semicolon
DECL|variable|lh7a40x_usbclient_resources
r_static
r_struct
id|resource
id|lh7a40x_usbclient_resources
(braket
)braket
op_assign
(brace
(braket
l_int|0
)braket
op_assign
(brace
dot
id|start
op_assign
id|USB_PHYS
comma
dot
id|end
op_assign
(paren
id|USB_PHYS
op_plus
l_int|0xFF
)paren
comma
dot
id|flags
op_assign
id|IORESOURCE_MEM
comma
)brace
comma
(braket
l_int|1
)braket
op_assign
(brace
dot
id|start
op_assign
id|IRQ_USBINTR
comma
dot
id|end
op_assign
id|IRQ_USBINTR
comma
dot
id|flags
op_assign
id|IORESOURCE_IRQ
comma
)brace
comma
)brace
suffix:semicolon
DECL|variable|lh7a40x_usbclient_dma_mask
r_static
id|u64
id|lh7a40x_usbclient_dma_mask
op_assign
l_int|0xffffffffUL
suffix:semicolon
DECL|variable|lh7a40x_usbclient_device
r_static
r_struct
id|platform_device
id|lh7a40x_usbclient_device
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;lh7a40x_udc&quot;
comma
dot
id|id
op_assign
l_int|0
comma
dot
id|dev
op_assign
(brace
dot
id|dma_mask
op_assign
op_amp
id|lh7a40x_usbclient_dma_mask
comma
dot
id|coherent_dma_mask
op_assign
l_int|0xffffffffUL
comma
)brace
comma
dot
id|num_resources
op_assign
id|ARRAY_SIZE
(paren
id|lh7a40x_usbclient_resources
)paren
comma
dot
id|resource
op_assign
id|lh7a40x_usbclient_resources
comma
)brace
suffix:semicolon
macro_line|#if defined (CONFIG_ARCH_LH7A404)
DECL|variable|lh7a404_usbhost_resources
r_static
r_struct
id|resource
id|lh7a404_usbhost_resources
(braket
)braket
op_assign
(brace
(braket
l_int|0
)braket
op_assign
(brace
dot
id|start
op_assign
id|USBH_PHYS
comma
dot
id|end
op_assign
(paren
id|USBH_PHYS
op_plus
l_int|0xFF
)paren
comma
dot
id|flags
op_assign
id|IORESOURCE_MEM
comma
)brace
comma
(braket
l_int|1
)braket
op_assign
(brace
dot
id|start
op_assign
id|IRQ_USHINTR
comma
dot
id|end
op_assign
id|IRQ_USHINTR
comma
dot
id|flags
op_assign
id|IORESOURCE_IRQ
comma
)brace
comma
)brace
suffix:semicolon
DECL|variable|lh7a404_usbhost_dma_mask
r_static
id|u64
id|lh7a404_usbhost_dma_mask
op_assign
l_int|0xffffffffUL
suffix:semicolon
DECL|variable|lh7a404_usbhost_device
r_static
r_struct
id|platform_device
id|lh7a404_usbhost_device
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;lh7a404-ohci&quot;
comma
dot
id|id
op_assign
l_int|0
comma
dot
id|dev
op_assign
(brace
dot
id|dma_mask
op_assign
op_amp
id|lh7a404_usbhost_dma_mask
comma
dot
id|coherent_dma_mask
op_assign
l_int|0xffffffffUL
comma
)brace
comma
dot
id|num_resources
op_assign
id|ARRAY_SIZE
(paren
id|lh7a404_usbhost_resources
)paren
comma
dot
id|resource
op_assign
id|lh7a404_usbhost_resources
comma
)brace
suffix:semicolon
macro_line|#endif
DECL|variable|__initdata
r_static
r_struct
id|platform_device
op_star
id|lpd7a40x_devs
(braket
)braket
id|__initdata
op_assign
(brace
op_amp
id|smc91x_device
comma
op_amp
id|lh7a40x_usbclient_device
comma
macro_line|#if defined (CONFIG_ARCH_LH7A404)
op_amp
id|lh7a404_usbhost_device
comma
macro_line|#endif
)brace
suffix:semicolon
r_extern
r_void
id|lpd7a400_map_io
(paren
r_void
)paren
suffix:semicolon
DECL|function|lpd7a40x_init
r_static
r_void
id|__init
id|lpd7a40x_init
(paren
r_void
)paren
(brace
id|CPLD_CONTROL
op_or_assign
(paren
l_int|1
op_lshift
l_int|6
)paren
suffix:semicolon
multiline_comment|/* Mask USB1 connection IRQ */
id|CPLD_CONTROL
op_and_assign
op_complement
(paren
l_int|0
op_or
(paren
l_int|1
op_lshift
l_int|1
)paren
multiline_comment|/* Disable LCD */
op_or
(paren
l_int|1
op_lshift
l_int|0
)paren
multiline_comment|/* Enable WLAN */
)paren
suffix:semicolon
id|platform_add_devices
(paren
id|lpd7a40x_devs
comma
id|ARRAY_SIZE
(paren
id|lpd7a40x_devs
)paren
)paren
suffix:semicolon
)brace
DECL|function|lh7a40x_ack_cpld_irq
r_static
r_void
id|lh7a40x_ack_cpld_irq
(paren
id|u32
id|irq
)paren
(brace
multiline_comment|/* CPLD doesn&squot;t have ack capability */
)brace
DECL|function|lh7a40x_mask_cpld_irq
r_static
r_void
id|lh7a40x_mask_cpld_irq
(paren
id|u32
id|irq
)paren
(brace
r_switch
c_cond
(paren
id|irq
)paren
(brace
r_case
id|IRQ_LPD7A40X_ETH_INT
suffix:colon
id|CPLD_INTERRUPTS
op_assign
id|CPLD_INTERRUPTS
op_or
l_int|0x4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRQ_LPD7A400_TS
suffix:colon
id|CPLD_INTERRUPTS
op_assign
id|CPLD_INTERRUPTS
op_or
l_int|0x8
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|lh7a40x_unmask_cpld_irq
r_static
r_void
id|lh7a40x_unmask_cpld_irq
(paren
id|u32
id|irq
)paren
(brace
r_switch
c_cond
(paren
id|irq
)paren
(brace
r_case
id|IRQ_LPD7A40X_ETH_INT
suffix:colon
id|CPLD_INTERRUPTS
op_assign
id|CPLD_INTERRUPTS
op_amp
op_complement
l_int|0x4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IRQ_LPD7A400_TS
suffix:colon
id|CPLD_INTERRUPTS
op_assign
id|CPLD_INTERRUPTS
op_amp
op_complement
l_int|0x8
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|variable|lpd7a40x_cpld_chip
r_static
r_struct
id|irqchip
id|lpd7a40x_cpld_chip
op_assign
(brace
dot
id|ack
op_assign
id|lh7a40x_ack_cpld_irq
comma
dot
id|mask
op_assign
id|lh7a40x_mask_cpld_irq
comma
dot
id|unmask
op_assign
id|lh7a40x_unmask_cpld_irq
comma
)brace
suffix:semicolon
DECL|macro|IRQ_DISPATCH
mdefine_line|#define IRQ_DISPATCH(irq) irq_desc[irq].handle ((irq), &amp;irq_desc[irq], regs)
DECL|function|lpd7a40x_cpld_handler
r_static
r_void
id|lpd7a40x_cpld_handler
(paren
r_int
r_int
id|irq
comma
r_struct
id|irqdesc
op_star
id|desc
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|mask
op_assign
id|CPLD_INTERRUPTS
suffix:semicolon
id|desc-&gt;chip-&gt;ack
(paren
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mask
op_amp
l_int|0x1
)paren
op_eq
l_int|0
)paren
multiline_comment|/* WLAN */
id|IRQ_DISPATCH
(paren
id|IRQ_LPD7A40X_ETH_INT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mask
op_amp
l_int|0x2
)paren
op_eq
l_int|0
)paren
multiline_comment|/* Touch */
id|IRQ_DISPATCH
(paren
id|IRQ_LPD7A400_TS
)paren
suffix:semicolon
id|desc-&gt;chip-&gt;unmask
(paren
id|irq
)paren
suffix:semicolon
multiline_comment|/* Level-triggered need this */
)brace
DECL|function|lh7a40x_init_board_irq
r_void
id|__init
id|lh7a40x_init_board_irq
(paren
r_void
)paren
(brace
r_int
id|irq
suffix:semicolon
multiline_comment|/* Rev A (v2.8): PF0, PF1, PF2, and PF3 are available IRQs.&n;&t;&t;                 PF7 supports the CPLD.&n;&t;&t;   Rev B (v3.4): PF0, PF1, and PF2 are available IRQs.&n;&t;&t;                 PF3 supports the CPLD.&n;&t;&t;   (Some) LPD7A404 prerelease boards report a version&n;&t;&t;   number of 0x16, but we force an override since the&n;&t;&t;   hardware is of the newer variety.&n;&t;&t;*/
r_int
r_char
id|cpld_version
op_assign
id|CPLD_REVISION
suffix:semicolon
r_int
id|pinCPLD
op_assign
(paren
id|cpld_version
op_eq
l_int|0x28
)paren
ques
c_cond
l_int|7
suffix:colon
l_int|3
suffix:semicolon
macro_line|#if defined CONFIG_MACH_LPD7A404
id|cpld_version
op_assign
l_int|0x34
suffix:semicolon
multiline_comment|/* Coerce LPD7A404 to RevB */
macro_line|#endif
multiline_comment|/* First, configure user controlled GPIOF interrupts  */
id|GPIO_PFDD
op_and_assign
op_complement
l_int|0x0f
suffix:semicolon
multiline_comment|/* PF0-3 are inputs */
id|GPIO_INTTYPE1
op_and_assign
op_complement
l_int|0x0f
suffix:semicolon
multiline_comment|/* PF0-3 are level triggered */
id|GPIO_INTTYPE2
op_and_assign
op_complement
l_int|0x0f
suffix:semicolon
multiline_comment|/* PF0-3 are active low */
id|barrier
(paren
)paren
suffix:semicolon
id|GPIO_GPIOFINTEN
op_or_assign
l_int|0x0f
suffix:semicolon
multiline_comment|/* Enable PF0, PF1, PF2, and PF3 IRQs */
multiline_comment|/* Then, configure CPLD interrupt */
id|CPLD_INTERRUPTS
op_assign
l_int|0x9c
suffix:semicolon
multiline_comment|/* Disable all CPLD interrupts */
id|GPIO_PFDD
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|pinCPLD
)paren
suffix:semicolon
multiline_comment|/* Make input */
id|GPIO_INTTYPE1
op_or_assign
(paren
l_int|1
op_lshift
id|pinCPLD
)paren
suffix:semicolon
multiline_comment|/* Edge triggered */
id|GPIO_INTTYPE2
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|pinCPLD
)paren
suffix:semicolon
multiline_comment|/* Active low */
id|barrier
(paren
)paren
suffix:semicolon
id|GPIO_GPIOFINTEN
op_or_assign
(paren
l_int|1
op_lshift
id|pinCPLD
)paren
suffix:semicolon
multiline_comment|/* Enable */
multiline_comment|/* Cascade CPLD interrupts */
r_for
c_loop
(paren
id|irq
op_assign
id|IRQ_BOARD_START
suffix:semicolon
id|irq
OL
id|IRQ_BOARD_START
op_plus
id|NR_IRQ_BOARD
suffix:semicolon
op_increment
id|irq
)paren
(brace
id|set_irq_chip
(paren
id|irq
comma
op_amp
id|lpd7a40x_cpld_chip
)paren
suffix:semicolon
id|set_irq_handler
(paren
id|irq
comma
id|do_edge_IRQ
)paren
suffix:semicolon
id|set_irq_flags
(paren
id|irq
comma
id|IRQF_VALID
)paren
suffix:semicolon
)brace
id|set_irq_chained_handler
(paren
(paren
id|cpld_version
op_eq
l_int|0x28
)paren
ques
c_cond
id|IRQ_CPLD_V28
suffix:colon
id|IRQ_CPLD_V34
comma
id|lpd7a40x_cpld_handler
)paren
suffix:semicolon
)brace
DECL|variable|__initdata
r_static
r_struct
id|map_desc
id|lpd7a400_io_desc
(braket
)braket
id|__initdata
op_assign
(brace
(brace
id|IO_VIRT
comma
id|IO_PHYS
comma
id|IO_SIZE
comma
id|MT_DEVICE
)brace
comma
multiline_comment|/* Mapping added to work around chip select problems */
(brace
id|IOBARRIER_VIRT
comma
id|IOBARRIER_PHYS
comma
id|IOBARRIER_SIZE
comma
id|MT_DEVICE
)brace
comma
(brace
id|CF_VIRT
comma
id|CF_PHYS
comma
id|CF_SIZE
comma
id|MT_DEVICE
)brace
comma
multiline_comment|/* This mapping is redundant since the smc driver performs another. */
multiline_comment|/*&t;{ CPLD00_VIRT,  CPLD00_PHYS,&t;CPLD00_SIZE,&t;MT_DEVICE }, */
(brace
id|CPLD02_VIRT
comma
id|CPLD02_PHYS
comma
id|CPLD02_SIZE
comma
id|MT_DEVICE
)brace
comma
(brace
id|CPLD06_VIRT
comma
id|CPLD06_PHYS
comma
id|CPLD06_SIZE
comma
id|MT_DEVICE
)brace
comma
(brace
id|CPLD08_VIRT
comma
id|CPLD08_PHYS
comma
id|CPLD08_SIZE
comma
id|MT_DEVICE
)brace
comma
(brace
id|CPLD0C_VIRT
comma
id|CPLD0C_PHYS
comma
id|CPLD0C_SIZE
comma
id|MT_DEVICE
)brace
comma
(brace
id|CPLD0E_VIRT
comma
id|CPLD0E_PHYS
comma
id|CPLD0E_SIZE
comma
id|MT_DEVICE
)brace
comma
(brace
id|CPLD10_VIRT
comma
id|CPLD10_PHYS
comma
id|CPLD10_SIZE
comma
id|MT_DEVICE
)brace
comma
(brace
id|CPLD12_VIRT
comma
id|CPLD12_PHYS
comma
id|CPLD12_SIZE
comma
id|MT_DEVICE
)brace
comma
(brace
id|CPLD14_VIRT
comma
id|CPLD14_PHYS
comma
id|CPLD14_SIZE
comma
id|MT_DEVICE
)brace
comma
(brace
id|CPLD16_VIRT
comma
id|CPLD16_PHYS
comma
id|CPLD16_SIZE
comma
id|MT_DEVICE
)brace
comma
(brace
id|CPLD18_VIRT
comma
id|CPLD18_PHYS
comma
id|CPLD18_SIZE
comma
id|MT_DEVICE
)brace
comma
(brace
id|CPLD1A_VIRT
comma
id|CPLD1A_PHYS
comma
id|CPLD1A_SIZE
comma
id|MT_DEVICE
)brace
comma
)brace
suffix:semicolon
r_void
id|__init
DECL|function|lpd7a400_map_io
id|lpd7a400_map_io
c_func
(paren
r_void
)paren
(brace
id|iotable_init
(paren
id|lpd7a400_io_desc
comma
id|ARRAY_SIZE
(paren
id|lpd7a400_io_desc
)paren
)paren
suffix:semicolon
multiline_comment|/* Fixup (improve) Static Memory Controller settings */
id|SMC_BCR0
op_assign
l_int|0x200039af
suffix:semicolon
multiline_comment|/* Boot Flash */
id|SMC_BCR6
op_assign
l_int|0x1000fbe0
suffix:semicolon
multiline_comment|/* CPLD */
id|SMC_BCR7
op_assign
l_int|0x1000b2c2
suffix:semicolon
multiline_comment|/* Compact Flash */
)brace
macro_line|#ifdef CONFIG_MACH_LPD7A400
id|MACHINE_START
(paren
id|LPD7A400
comma
l_string|&quot;Logic Product Development LPD7A400-10&quot;
)paren
id|MAINTAINER
(paren
l_string|&quot;Marc Singer&quot;
)paren
id|BOOT_MEM
(paren
l_int|0xc0000000
comma
l_int|0x80000000
comma
id|io_p2v
(paren
l_int|0x80000000
)paren
)paren
id|BOOT_PARAMS
(paren
l_int|0xc0000100
)paren
id|MAPIO
(paren
id|lpd7a400_map_io
)paren
id|INITIRQ
(paren
id|lh7a400_init_irq
)paren
dot
id|timer
op_assign
op_amp
id|lpd7a40x_timer
comma
id|INIT_MACHINE
(paren
id|lpd7a40x_init
)paren
id|MACHINE_END
macro_line|#endif
macro_line|#ifdef CONFIG_MACH_LPD7A404
id|MACHINE_START
(paren
id|LPD7A404
comma
l_string|&quot;Logic Product Development LPD7A404-10&quot;
)paren
id|MAINTAINER
(paren
l_string|&quot;Marc Singer&quot;
)paren
id|BOOT_MEM
(paren
l_int|0xc0000000
comma
l_int|0x80000000
comma
id|io_p2v
(paren
l_int|0x80000000
)paren
)paren
id|BOOT_PARAMS
(paren
l_int|0xc0000100
)paren
id|MAPIO
(paren
id|lpd7a400_map_io
)paren
id|INITIRQ
(paren
id|lh7a404_init_irq
)paren
dot
id|timer
op_assign
op_amp
id|lpd7a40x_timer
comma
id|INIT_MACHINE
(paren
id|lpd7a40x_init
)paren
id|MACHINE_END
macro_line|#endif
eof
