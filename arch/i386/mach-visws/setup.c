multiline_comment|/*&n; *  Unmaintained SGI Visual Workstation support.&n; *  Split out from setup.c by davej@suse.de&n; */
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/fixmap.h&gt;
macro_line|#include &lt;asm/arch_hooks.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;cobalt.h&quot;
macro_line|#include &quot;piix4.h&quot;
DECL|variable|visws_board_type
r_char
id|visws_board_type
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|visws_board_rev
r_char
id|visws_board_rev
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|function|visws_get_board_type_and_rev
r_void
id|__init
id|visws_get_board_type_and_rev
c_func
(paren
r_void
)paren
(brace
r_int
id|raw
suffix:semicolon
id|visws_board_type
op_assign
(paren
r_char
)paren
(paren
id|inb_p
c_func
(paren
id|PIIX_GPI_BD_REG
)paren
op_amp
id|PIIX_GPI_BD_REG
)paren
op_rshift
id|PIIX_GPI_BD_SHIFT
suffix:semicolon
multiline_comment|/*&n;&t; * Get Board rev.&n;&t; * First, we have to initialize the 307 part to allow us access&n;&t; * to the GPIO registers.  Let&squot;s map them at 0x0fc0 which is right&n;&t; * after the PIIX4 PM section.&n;&t; */
id|outb_p
c_func
(paren
id|SIO_DEV_SEL
comma
id|SIO_INDEX
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|SIO_GP_DEV
comma
id|SIO_DATA
)paren
suffix:semicolon
multiline_comment|/* Talk to GPIO regs. */
id|outb_p
c_func
(paren
id|SIO_DEV_MSB
comma
id|SIO_INDEX
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|SIO_GP_MSB
comma
id|SIO_DATA
)paren
suffix:semicolon
multiline_comment|/* MSB of GPIO base address */
id|outb_p
c_func
(paren
id|SIO_DEV_LSB
comma
id|SIO_INDEX
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|SIO_GP_LSB
comma
id|SIO_DATA
)paren
suffix:semicolon
multiline_comment|/* LSB of GPIO base address */
id|outb_p
c_func
(paren
id|SIO_DEV_ENB
comma
id|SIO_INDEX
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|1
comma
id|SIO_DATA
)paren
suffix:semicolon
multiline_comment|/* Enable GPIO registers. */
multiline_comment|/*&n;&t; * Now, we have to map the power management section to write&n;&t; * a bit which enables access to the GPIO registers.&n;&t; * What lunatic came up with this shit?&n;&t; */
id|outb_p
c_func
(paren
id|SIO_DEV_SEL
comma
id|SIO_INDEX
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|SIO_PM_DEV
comma
id|SIO_DATA
)paren
suffix:semicolon
multiline_comment|/* Talk to GPIO regs. */
id|outb_p
c_func
(paren
id|SIO_DEV_MSB
comma
id|SIO_INDEX
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|SIO_PM_MSB
comma
id|SIO_DATA
)paren
suffix:semicolon
multiline_comment|/* MSB of PM base address */
id|outb_p
c_func
(paren
id|SIO_DEV_LSB
comma
id|SIO_INDEX
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|SIO_PM_LSB
comma
id|SIO_DATA
)paren
suffix:semicolon
multiline_comment|/* LSB of PM base address */
id|outb_p
c_func
(paren
id|SIO_DEV_ENB
comma
id|SIO_INDEX
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|1
comma
id|SIO_DATA
)paren
suffix:semicolon
multiline_comment|/* Enable PM registers. */
multiline_comment|/*&n;&t; * Now, write the PM register which enables the GPIO registers.&n;&t; */
id|outb_p
c_func
(paren
id|SIO_PM_FER2
comma
id|SIO_PM_INDEX
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|SIO_PM_GP_EN
comma
id|SIO_PM_DATA
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Now, initialize the GPIO registers.&n;&t; * We want them all to be inputs which is the&n;&t; * power on default, so let&squot;s leave them alone.&n;&t; * So, let&squot;s just read the board rev!&n;&t; */
id|raw
op_assign
id|inb_p
c_func
(paren
id|SIO_GP_DATA1
)paren
suffix:semicolon
id|raw
op_and_assign
l_int|0x7f
suffix:semicolon
multiline_comment|/* 7 bits of valid board revision ID. */
r_if
c_cond
(paren
id|visws_board_type
op_eq
id|VISWS_320
)paren
(brace
r_if
c_cond
(paren
id|raw
OL
l_int|0x6
)paren
(brace
id|visws_board_rev
op_assign
l_int|4
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|raw
OL
l_int|0xc
)paren
(brace
id|visws_board_rev
op_assign
l_int|5
suffix:semicolon
)brace
r_else
(brace
id|visws_board_rev
op_assign
l_int|6
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|visws_board_type
op_eq
id|VISWS_540
)paren
(brace
id|visws_board_rev
op_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|visws_board_rev
op_assign
id|raw
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Silicon Graphics Visual Workstation %s (rev %d) detected&bslash;n&quot;
comma
(paren
id|visws_board_type
op_eq
id|VISWS_320
ques
c_cond
l_string|&quot;320&quot;
suffix:colon
(paren
id|visws_board_type
op_eq
id|VISWS_540
ques
c_cond
l_string|&quot;540&quot;
suffix:colon
l_string|&quot;unknown&quot;
)paren
)paren
comma
id|visws_board_rev
)paren
suffix:semicolon
)brace
DECL|function|pre_intr_init_hook
r_void
id|__init
id|pre_intr_init_hook
c_func
(paren
r_void
)paren
(brace
id|init_VISWS_APIC_irqs
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|intr_init_hook
r_void
id|__init
id|intr_init_hook
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_X86_LOCAL_APIC
id|apic_intr_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|pre_setup_arch_hook
r_void
id|__init
id|pre_setup_arch_hook
c_func
(paren
)paren
(brace
id|visws_get_board_type_and_rev
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|variable|irq0
r_static
r_struct
id|irqaction
id|irq0
op_assign
(brace
dot
id|handler
op_assign
id|timer_interrupt
comma
dot
id|flags
op_assign
id|SA_INTERRUPT
comma
dot
id|name
op_assign
l_string|&quot;timer&quot;
comma
)brace
suffix:semicolon
DECL|function|time_init_hook
r_void
id|__init
id|time_init_hook
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Starting Cobalt Timer system clock&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Set the countdown value */
id|co_cpu_write
c_func
(paren
id|CO_CPU_TIMEVAL
comma
id|CO_TIME_HZ
op_div
id|HZ
)paren
suffix:semicolon
multiline_comment|/* Start the timer */
id|co_cpu_write
c_func
(paren
id|CO_CPU_CTRL
comma
id|co_cpu_read
c_func
(paren
id|CO_CPU_CTRL
)paren
op_or
id|CO_CTRL_TIMERUN
)paren
suffix:semicolon
multiline_comment|/* Enable (unmask) the timer interrupt */
id|co_cpu_write
c_func
(paren
id|CO_CPU_CTRL
comma
id|co_cpu_read
c_func
(paren
id|CO_CPU_CTRL
)paren
op_amp
op_complement
id|CO_CTRL_TIMEMASK
)paren
suffix:semicolon
multiline_comment|/* Wire cpu IDT entry to s/w handler (and Cobalt APIC to IDT) */
id|setup_irq
c_func
(paren
l_int|0
comma
op_amp
id|irq0
)paren
suffix:semicolon
)brace
eof
