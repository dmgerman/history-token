macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;asm/smp.h&gt;
macro_line|#include &lt;asm/apic.h&gt;
macro_line|#include &lt;asm/mpspec.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;cobalt.h&quot;
macro_line|#include &quot;mach_apic.h&quot;
multiline_comment|/* Have we found an MP table */
DECL|variable|smp_found_config
r_int
id|smp_found_config
suffix:semicolon
multiline_comment|/*&n; * Various Linux-internal data structures created from the&n; * MP-table.&n; */
DECL|variable|apic_version
r_int
id|apic_version
(braket
id|MAX_APICS
)braket
suffix:semicolon
DECL|variable|mp_bus_id_to_type
r_int
id|mp_bus_id_to_type
(braket
id|MAX_MP_BUSSES
)braket
suffix:semicolon
DECL|variable|mp_bus_id_to_node
r_int
id|mp_bus_id_to_node
(braket
id|MAX_MP_BUSSES
)braket
suffix:semicolon
DECL|variable|mp_bus_id_to_pci_bus
r_int
id|mp_bus_id_to_pci_bus
(braket
id|MAX_MP_BUSSES
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
id|MAX_MP_BUSSES
op_minus
l_int|1
)braket
op_assign
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|mp_current_pci_id
r_int
id|mp_current_pci_id
suffix:semicolon
multiline_comment|/* I/O APIC entries */
DECL|variable|mp_ioapics
r_struct
id|mpc_config_ioapic
id|mp_ioapics
(braket
id|MAX_IO_APICS
)braket
suffix:semicolon
multiline_comment|/* # of MP IRQ source entries */
DECL|variable|mp_irqs
r_struct
id|mpc_config_intsrc
id|mp_irqs
(braket
id|MAX_IRQ_SOURCES
)braket
suffix:semicolon
multiline_comment|/* MP IRQ source entries */
DECL|variable|mp_irq_entries
r_int
id|mp_irq_entries
suffix:semicolon
DECL|variable|nr_ioapics
r_int
id|nr_ioapics
suffix:semicolon
DECL|variable|pic_mode
r_int
id|pic_mode
suffix:semicolon
DECL|variable|mp_lapic_addr
r_int
r_int
id|mp_lapic_addr
suffix:semicolon
multiline_comment|/* Processor that is doing the boot up */
DECL|variable|boot_cpu_physical_apicid
r_int
r_int
id|boot_cpu_physical_apicid
op_assign
op_minus
l_int|1U
suffix:semicolon
DECL|variable|boot_cpu_logical_apicid
r_int
r_int
id|boot_cpu_logical_apicid
op_assign
op_minus
l_int|1U
suffix:semicolon
multiline_comment|/* Internal processor count */
DECL|variable|num_processors
r_static
r_int
r_int
id|num_processors
suffix:semicolon
multiline_comment|/* Bitmask of physically existing CPUs */
DECL|variable|phys_cpu_present_map
r_int
r_int
id|phys_cpu_present_map
suffix:semicolon
DECL|variable|raw_phys_apicid
id|u8
id|raw_phys_apicid
(braket
id|NR_CPUS
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
id|NR_CPUS
op_minus
l_int|1
)braket
op_assign
id|BAD_APICID
)brace
suffix:semicolon
multiline_comment|/*&n; * The Visual Workstation is Intel MP compliant in the hardware&n; * sense, but it doesn&squot;t have a BIOS(-configuration table).&n; * No problem for Linux.&n; */
DECL|function|MP_processor_info
r_void
id|__init
id|MP_processor_info
(paren
r_struct
id|mpc_config_processor
op_star
id|m
)paren
(brace
r_int
id|ver
comma
id|logical_apicid
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|m-&gt;mpc_cpuflag
op_amp
id|CPU_ENABLED
)paren
)paren
r_return
suffix:semicolon
id|logical_apicid
op_assign
id|m-&gt;mpc_apicid
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%sCPU #%d %ld:%ld APIC version %d&bslash;n&quot;
comma
id|m-&gt;mpc_cpuflag
op_amp
id|CPU_BOOTPROCESSOR
ques
c_cond
l_string|&quot;Bootup &quot;
suffix:colon
l_string|&quot;&quot;
comma
id|m-&gt;mpc_apicid
comma
(paren
id|m-&gt;mpc_cpufeature
op_amp
id|CPU_FAMILY_MASK
)paren
op_rshift
l_int|8
comma
(paren
id|m-&gt;mpc_cpufeature
op_amp
id|CPU_MODEL_MASK
)paren
op_rshift
l_int|4
comma
id|m-&gt;mpc_apicver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m-&gt;mpc_cpuflag
op_amp
id|CPU_BOOTPROCESSOR
)paren
(brace
id|boot_cpu_physical_apicid
op_assign
id|m-&gt;mpc_apicid
suffix:semicolon
id|boot_cpu_logical_apicid
op_assign
id|logical_apicid
suffix:semicolon
)brace
id|num_processors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|m-&gt;mpc_apicid
OG
id|MAX_APICS
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Processor #%d INVALID. (Max ID: %d).&bslash;n&quot;
comma
id|m-&gt;mpc_apicid
comma
id|MAX_APICS
)paren
suffix:semicolon
op_decrement
id|num_processors
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ver
op_assign
id|m-&gt;mpc_apicver
suffix:semicolon
id|phys_cpu_present_map
op_or_assign
id|apicid_to_cpu_present
c_func
(paren
id|m-&gt;mpc_apicid
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Validate version&n;&t; */
r_if
c_cond
(paren
id|ver
op_eq
l_int|0x0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;BIOS bug, APIC version is 0 for CPU#%d! &quot;
l_string|&quot;fixing up to 0x10. (tell your hw vendor)&bslash;n&quot;
comma
id|m-&gt;mpc_apicid
)paren
suffix:semicolon
id|ver
op_assign
l_int|0x10
suffix:semicolon
)brace
id|apic_version
(braket
id|m-&gt;mpc_apicid
)braket
op_assign
id|ver
suffix:semicolon
id|raw_phys_apicid
(braket
id|num_processors
op_minus
l_int|1
)braket
op_assign
id|m-&gt;mpc_apicid
suffix:semicolon
)brace
DECL|function|find_smp_config
r_void
id|__init
id|find_smp_config
c_func
(paren
r_void
)paren
(brace
r_struct
id|mpc_config_processor
op_star
id|mp
op_assign
id|phys_to_virt
c_func
(paren
id|CO_CPU_TAB_PHYS
)paren
suffix:semicolon
r_int
r_int
id|ncpus
op_assign
id|readw
c_func
(paren
id|phys_to_virt
c_func
(paren
id|CO_CPU_NUM_PHYS
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ncpus
OG
id|CO_CPU_MAX
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;find_visws_smp: got cpu count of %d at %p&bslash;n&quot;
comma
id|ncpus
comma
id|mp
)paren
suffix:semicolon
id|ncpus
op_assign
id|CO_CPU_MAX
suffix:semicolon
)brace
id|smp_found_config
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|ncpus
op_decrement
)paren
id|MP_processor_info
c_func
(paren
id|mp
op_increment
)paren
suffix:semicolon
id|mp_lapic_addr
op_assign
id|APIC_DEFAULT_PHYS_BASE
suffix:semicolon
)brace
DECL|function|get_smp_config
r_void
id|__init
id|get_smp_config
(paren
r_void
)paren
(brace
)brace
eof
