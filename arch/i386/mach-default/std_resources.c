multiline_comment|/*&n; *  Machine specific resource allocation for generic.&n; */
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/std_resources.h&gt;
DECL|macro|romsignature
mdefine_line|#define romsignature(x) (*(unsigned short *)(x) == 0xaa55)
DECL|variable|system_rom_resource
r_static
r_struct
id|resource
id|system_rom_resource
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;System ROM&quot;
comma
dot
id|start
op_assign
l_int|0xf0000
comma
dot
id|end
op_assign
l_int|0xfffff
comma
dot
id|flags
op_assign
id|IORESOURCE_BUSY
op_or
id|IORESOURCE_READONLY
op_or
id|IORESOURCE_MEM
)brace
suffix:semicolon
DECL|variable|extension_rom_resource
r_static
r_struct
id|resource
id|extension_rom_resource
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;Extension ROM&quot;
comma
dot
id|start
op_assign
l_int|0xe0000
comma
dot
id|end
op_assign
l_int|0xeffff
comma
dot
id|flags
op_assign
id|IORESOURCE_BUSY
op_or
id|IORESOURCE_READONLY
op_or
id|IORESOURCE_MEM
)brace
suffix:semicolon
DECL|variable|adapter_rom_resources
r_static
r_struct
id|resource
id|adapter_rom_resources
(braket
)braket
op_assign
(brace
(brace
dot
id|name
op_assign
l_string|&quot;Adapter ROM&quot;
comma
dot
id|start
op_assign
l_int|0xc8000
comma
dot
id|end
op_assign
l_int|0
comma
dot
id|flags
op_assign
id|IORESOURCE_BUSY
op_or
id|IORESOURCE_READONLY
op_or
id|IORESOURCE_MEM
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;Adapter ROM&quot;
comma
dot
id|start
op_assign
l_int|0
comma
dot
id|end
op_assign
l_int|0
comma
dot
id|flags
op_assign
id|IORESOURCE_BUSY
op_or
id|IORESOURCE_READONLY
op_or
id|IORESOURCE_MEM
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;Adapter ROM&quot;
comma
dot
id|start
op_assign
l_int|0
comma
dot
id|end
op_assign
l_int|0
comma
dot
id|flags
op_assign
id|IORESOURCE_BUSY
op_or
id|IORESOURCE_READONLY
op_or
id|IORESOURCE_MEM
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;Adapter ROM&quot;
comma
dot
id|start
op_assign
l_int|0
comma
dot
id|end
op_assign
l_int|0
comma
dot
id|flags
op_assign
id|IORESOURCE_BUSY
op_or
id|IORESOURCE_READONLY
op_or
id|IORESOURCE_MEM
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;Adapter ROM&quot;
comma
dot
id|start
op_assign
l_int|0
comma
dot
id|end
op_assign
l_int|0
comma
dot
id|flags
op_assign
id|IORESOURCE_BUSY
op_or
id|IORESOURCE_READONLY
op_or
id|IORESOURCE_MEM
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;Adapter ROM&quot;
comma
dot
id|start
op_assign
l_int|0
comma
dot
id|end
op_assign
l_int|0
comma
dot
id|flags
op_assign
id|IORESOURCE_BUSY
op_or
id|IORESOURCE_READONLY
op_or
id|IORESOURCE_MEM
)brace
)brace
suffix:semicolon
DECL|macro|ADAPTER_ROM_RESOURCES
mdefine_line|#define ADAPTER_ROM_RESOURCES &bslash;&n;&t;(sizeof adapter_rom_resources / sizeof adapter_rom_resources[0])
DECL|variable|video_rom_resource
r_static
r_struct
id|resource
id|video_rom_resource
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;Video ROM&quot;
comma
dot
id|start
op_assign
l_int|0xc0000
comma
dot
id|end
op_assign
l_int|0xc7fff
comma
dot
id|flags
op_assign
id|IORESOURCE_BUSY
op_or
id|IORESOURCE_READONLY
op_or
id|IORESOURCE_MEM
)brace
suffix:semicolon
DECL|variable|vram_resource
r_static
r_struct
id|resource
id|vram_resource
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;Video RAM area&quot;
comma
dot
id|start
op_assign
l_int|0xa0000
comma
dot
id|end
op_assign
l_int|0xbffff
comma
dot
id|flags
op_assign
id|IORESOURCE_BUSY
op_or
id|IORESOURCE_MEM
)brace
suffix:semicolon
DECL|variable|standard_io_resources
r_static
r_struct
id|resource
id|standard_io_resources
(braket
)braket
op_assign
(brace
(brace
dot
id|name
op_assign
l_string|&quot;dma1&quot;
comma
dot
id|start
op_assign
l_int|0x0000
comma
dot
id|end
op_assign
l_int|0x001f
comma
dot
id|flags
op_assign
id|IORESOURCE_BUSY
op_or
id|IORESOURCE_IO
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;pic1&quot;
comma
dot
id|start
op_assign
l_int|0x0020
comma
dot
id|end
op_assign
l_int|0x0021
comma
dot
id|flags
op_assign
id|IORESOURCE_BUSY
op_or
id|IORESOURCE_IO
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;timer&quot;
comma
dot
id|start
op_assign
l_int|0x0040
comma
dot
id|end
op_assign
l_int|0x005f
comma
dot
id|flags
op_assign
id|IORESOURCE_BUSY
op_or
id|IORESOURCE_IO
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;keyboard&quot;
comma
dot
id|start
op_assign
l_int|0x0060
comma
dot
id|end
op_assign
l_int|0x006f
comma
dot
id|flags
op_assign
id|IORESOURCE_BUSY
op_or
id|IORESOURCE_IO
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;dma page reg&quot;
comma
dot
id|start
op_assign
l_int|0x0080
comma
dot
id|end
op_assign
l_int|0x008f
comma
dot
id|flags
op_assign
id|IORESOURCE_BUSY
op_or
id|IORESOURCE_IO
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;pic2&quot;
comma
dot
id|start
op_assign
l_int|0x00a0
comma
dot
id|end
op_assign
l_int|0x00a1
comma
dot
id|flags
op_assign
id|IORESOURCE_BUSY
op_or
id|IORESOURCE_IO
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;dma2&quot;
comma
dot
id|start
op_assign
l_int|0x00c0
comma
dot
id|end
op_assign
l_int|0x00df
comma
dot
id|flags
op_assign
id|IORESOURCE_BUSY
op_or
id|IORESOURCE_IO
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;fpu&quot;
comma
dot
id|start
op_assign
l_int|0x00f0
comma
dot
id|end
op_assign
l_int|0x00ff
comma
dot
id|flags
op_assign
id|IORESOURCE_BUSY
op_or
id|IORESOURCE_IO
)brace
)brace
suffix:semicolon
DECL|macro|STANDARD_IO_RESOURCES
mdefine_line|#define STANDARD_IO_RESOURCES &bslash;&n;&t;(sizeof standard_io_resources / sizeof standard_io_resources[0])
DECL|function|checksum
r_static
r_int
id|__init
id|checksum
c_func
(paren
r_int
r_char
op_star
id|rom
comma
r_int
r_int
id|length
)paren
(brace
r_int
r_char
op_star
id|p
comma
id|sum
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|rom
suffix:semicolon
id|p
OL
id|rom
op_plus
id|length
suffix:semicolon
id|p
op_increment
)paren
id|sum
op_add_assign
op_star
id|p
suffix:semicolon
r_return
id|sum
op_eq
l_int|0
suffix:semicolon
)brace
DECL|function|probe_roms
r_void
id|__init
id|probe_roms
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|start
comma
id|length
comma
id|upper
suffix:semicolon
r_int
r_char
op_star
id|rom
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* video rom */
id|upper
op_assign
id|adapter_rom_resources
(braket
l_int|0
)braket
dot
id|start
suffix:semicolon
r_for
c_loop
(paren
id|start
op_assign
id|video_rom_resource.start
suffix:semicolon
id|start
OL
id|upper
suffix:semicolon
id|start
op_add_assign
l_int|2048
)paren
(brace
id|rom
op_assign
id|isa_bus_to_virt
c_func
(paren
id|start
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|romsignature
c_func
(paren
id|rom
)paren
)paren
r_continue
suffix:semicolon
id|video_rom_resource.start
op_assign
id|start
suffix:semicolon
multiline_comment|/* 0 &lt; length &lt;= 0x7f * 512, historically */
id|length
op_assign
id|rom
(braket
l_int|2
)braket
op_star
l_int|512
suffix:semicolon
multiline_comment|/* if checksum okay, trust length byte */
r_if
c_cond
(paren
id|length
op_logical_and
id|checksum
c_func
(paren
id|rom
comma
id|length
)paren
)paren
id|video_rom_resource.end
op_assign
id|start
op_plus
id|length
op_minus
l_int|1
suffix:semicolon
id|request_resource
c_func
(paren
op_amp
id|iomem_resource
comma
op_amp
id|video_rom_resource
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|start
op_assign
(paren
id|video_rom_resource.end
op_plus
l_int|1
op_plus
l_int|2047
)paren
op_amp
op_complement
l_int|2047UL
suffix:semicolon
r_if
c_cond
(paren
id|start
OL
id|upper
)paren
id|start
op_assign
id|upper
suffix:semicolon
multiline_comment|/* system rom */
id|request_resource
c_func
(paren
op_amp
id|iomem_resource
comma
op_amp
id|system_rom_resource
)paren
suffix:semicolon
id|upper
op_assign
id|system_rom_resource.start
suffix:semicolon
multiline_comment|/* check for extension rom (ignore length byte!) */
id|rom
op_assign
id|isa_bus_to_virt
c_func
(paren
id|extension_rom_resource.start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|romsignature
c_func
(paren
id|rom
)paren
)paren
(brace
id|length
op_assign
id|extension_rom_resource.end
op_minus
id|extension_rom_resource.start
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|checksum
c_func
(paren
id|rom
comma
id|length
)paren
)paren
(brace
id|request_resource
c_func
(paren
op_amp
id|iomem_resource
comma
op_amp
id|extension_rom_resource
)paren
suffix:semicolon
id|upper
op_assign
id|extension_rom_resource.start
suffix:semicolon
)brace
)brace
multiline_comment|/* check for adapter roms on 2k boundaries */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ADAPTER_ROM_RESOURCES
op_logical_and
id|start
OL
id|upper
suffix:semicolon
id|start
op_add_assign
l_int|2048
)paren
(brace
id|rom
op_assign
id|isa_bus_to_virt
c_func
(paren
id|start
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|romsignature
c_func
(paren
id|rom
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* 0 &lt; length &lt;= 0x7f * 512, historically */
id|length
op_assign
id|rom
(braket
l_int|2
)braket
op_star
l_int|512
suffix:semicolon
multiline_comment|/* but accept any length that fits if checksum okay */
r_if
c_cond
(paren
op_logical_neg
id|length
op_logical_or
id|start
op_plus
id|length
OG
id|upper
op_logical_or
op_logical_neg
id|checksum
c_func
(paren
id|rom
comma
id|length
)paren
)paren
r_continue
suffix:semicolon
id|adapter_rom_resources
(braket
id|i
)braket
dot
id|start
op_assign
id|start
suffix:semicolon
id|adapter_rom_resources
(braket
id|i
)braket
dot
id|end
op_assign
id|start
op_plus
id|length
op_minus
l_int|1
suffix:semicolon
id|request_resource
c_func
(paren
op_amp
id|iomem_resource
comma
op_amp
id|adapter_rom_resources
(braket
id|i
)braket
)paren
suffix:semicolon
id|start
op_assign
id|adapter_rom_resources
(braket
id|i
op_increment
)braket
dot
id|end
op_amp
op_complement
l_int|2047UL
suffix:semicolon
)brace
)brace
DECL|function|request_graphics_resource
r_void
id|__init
id|request_graphics_resource
c_func
(paren
r_void
)paren
(brace
id|request_resource
c_func
(paren
op_amp
id|iomem_resource
comma
op_amp
id|vram_resource
)paren
suffix:semicolon
)brace
DECL|function|request_standard_io_resources
r_void
id|__init
id|request_standard_io_resources
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|STANDARD_IO_RESOURCES
suffix:semicolon
id|i
op_increment
)paren
id|request_resource
c_func
(paren
op_amp
id|ioport_resource
comma
op_amp
id|standard_io_resources
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
eof
