multiline_comment|/*&n; * Exceptions for specific devices. Usually work-arounds for fatal design flaws.&n; */
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &quot;pci.h&quot;
DECL|function|pci_fixup_i450nx
r_static
r_void
id|__devinit
id|pci_fixup_i450nx
c_func
(paren
r_struct
id|pci_dev
op_star
id|d
)paren
(brace
multiline_comment|/*&n;&t; * i450NX -- Find and scan all secondary buses on all PXB&squot;s.&n;&t; */
r_int
id|pxb
comma
id|reg
suffix:semicolon
id|u8
id|busno
comma
id|suba
comma
id|subb
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PCI: Searching for i450NX host bridges on %s&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|d
)paren
)paren
suffix:semicolon
id|reg
op_assign
l_int|0xd0
suffix:semicolon
r_for
c_loop
(paren
id|pxb
op_assign
l_int|0
suffix:semicolon
id|pxb
OL
l_int|2
suffix:semicolon
id|pxb
op_increment
)paren
(brace
id|pci_read_config_byte
c_func
(paren
id|d
comma
id|reg
op_increment
comma
op_amp
id|busno
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|d
comma
id|reg
op_increment
comma
op_amp
id|suba
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|d
comma
id|reg
op_increment
comma
op_amp
id|subb
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;i450NX PXB %d: %02x/%02x/%02x&bslash;n&quot;
comma
id|pxb
comma
id|busno
comma
id|suba
comma
id|subb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|busno
)paren
id|pci_scan_bus
c_func
(paren
id|busno
comma
op_amp
id|pci_root_ops
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Bus A */
r_if
c_cond
(paren
id|suba
OL
id|subb
)paren
id|pci_scan_bus
c_func
(paren
id|suba
op_plus
l_int|1
comma
op_amp
id|pci_root_ops
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Bus B */
)brace
id|pcibios_last_bus
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|DECLARE_PCI_FIXUP_HEADER
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82451NX
comma
id|pci_fixup_i450nx
)paren
suffix:semicolon
DECL|function|pci_fixup_i450gx
r_static
r_void
id|__devinit
id|pci_fixup_i450gx
c_func
(paren
r_struct
id|pci_dev
op_star
id|d
)paren
(brace
multiline_comment|/*&n;&t; * i450GX and i450KX -- Find and scan all secondary buses.&n;&t; * (called separately for each PCI bridge found)&n;&t; */
id|u8
id|busno
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|d
comma
l_int|0x4a
comma
op_amp
id|busno
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PCI: i440KX/GX host bridge %s: secondary bus %02x&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|d
)paren
comma
id|busno
)paren
suffix:semicolon
id|pci_scan_bus
c_func
(paren
id|busno
comma
op_amp
id|pci_root_ops
comma
l_int|NULL
)paren
suffix:semicolon
id|pcibios_last_bus
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|DECLARE_PCI_FIXUP_HEADER
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82454GX
comma
id|pci_fixup_i450gx
)paren
suffix:semicolon
DECL|function|pci_fixup_umc_ide
r_static
r_void
id|__devinit
id|pci_fixup_umc_ide
c_func
(paren
r_struct
id|pci_dev
op_star
id|d
)paren
(brace
multiline_comment|/*&n;&t; * UM8886BF IDE controller sets region type bits incorrectly,&n;&t; * therefore they look like memory despite of them being I/O.&n;&t; */
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PCI: Fixing base address flags for device %s&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|d
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|d-&gt;resource
(braket
id|i
)braket
dot
id|flags
op_or_assign
id|PCI_BASE_ADDRESS_SPACE_IO
suffix:semicolon
)brace
)brace
id|DECLARE_PCI_FIXUP_HEADER
c_func
(paren
id|PCI_VENDOR_ID_UMC
comma
id|PCI_DEVICE_ID_UMC_UM8886BF
comma
id|pci_fixup_umc_ide
)paren
suffix:semicolon
DECL|function|pci_fixup_ncr53c810
r_static
r_void
id|__devinit
id|pci_fixup_ncr53c810
c_func
(paren
r_struct
id|pci_dev
op_star
id|d
)paren
(brace
multiline_comment|/*&n;&t; * NCR 53C810 returns class code 0 (at least on some systems).&n;&t; * Fix class to be PCI_CLASS_STORAGE_SCSI&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|d
op_member_access_from_pointer
r_class
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PCI: fixing NCR 53C810 class code for %s&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|d
)paren
)paren
suffix:semicolon
id|d
op_member_access_from_pointer
r_class
op_assign
id|PCI_CLASS_STORAGE_SCSI
op_lshift
l_int|8
suffix:semicolon
)brace
)brace
id|DECLARE_PCI_FIXUP_HEADER
c_func
(paren
id|PCI_VENDOR_ID_NCR
comma
id|PCI_DEVICE_ID_NCR_53C810
comma
id|pci_fixup_ncr53c810
)paren
suffix:semicolon
DECL|function|pci_fixup_ide_bases
r_static
r_void
id|__devinit
id|pci_fixup_ide_bases
c_func
(paren
r_struct
id|pci_dev
op_star
id|d
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * PCI IDE controllers use non-standard I/O port decoding, respect it.&n;&t; */
r_if
c_cond
(paren
(paren
id|d
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_ne
id|PCI_CLASS_STORAGE_IDE
)paren
r_return
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;PCI: IDE base address fixup for %s&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|d
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|resource
op_star
id|r
op_assign
op_amp
id|d-&gt;resource
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r-&gt;start
op_amp
op_complement
l_int|0x80
)paren
op_eq
l_int|0x374
)paren
(brace
id|r-&gt;start
op_or_assign
l_int|2
suffix:semicolon
id|r-&gt;end
op_assign
id|r-&gt;start
suffix:semicolon
)brace
)brace
)brace
id|DECLARE_PCI_FIXUP_HEADER
c_func
(paren
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|pci_fixup_ide_bases
)paren
suffix:semicolon
DECL|function|pci_fixup_ide_trash
r_static
r_void
id|__devinit
id|pci_fixup_ide_trash
c_func
(paren
r_struct
id|pci_dev
op_star
id|d
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * Runs the fixup only for the first IDE controller&n;&t; * (Shai Fultheim - shai@ftcon.com)&n;&t; */
r_static
r_int
id|called
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|called
)paren
r_return
suffix:semicolon
id|called
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * There exist PCI IDE controllers which have utter garbage&n;&t; * in first four base registers. Ignore that.&n;&t; */
id|DBG
c_func
(paren
l_string|&quot;PCI: IDE base address trash cleared for %s&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|d
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|d-&gt;resource
(braket
id|i
)braket
dot
id|start
op_assign
id|d-&gt;resource
(braket
id|i
)braket
dot
id|end
op_assign
id|d-&gt;resource
(braket
id|i
)braket
dot
id|flags
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|DECLARE_PCI_FIXUP_HEADER
c_func
(paren
id|PCI_VENDOR_ID_SI
comma
id|PCI_DEVICE_ID_SI_5513
comma
id|pci_fixup_ide_trash
)paren
suffix:semicolon
id|DECLARE_PCI_FIXUP_HEADER
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82801CA_10
comma
id|pci_fixup_ide_trash
)paren
suffix:semicolon
id|DECLARE_PCI_FIXUP_HEADER
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82801CA_11
comma
id|pci_fixup_ide_trash
)paren
suffix:semicolon
id|DECLARE_PCI_FIXUP_HEADER
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82801DB_9
comma
id|pci_fixup_ide_trash
)paren
suffix:semicolon
DECL|function|pci_fixup_latency
r_static
r_void
id|__devinit
id|pci_fixup_latency
c_func
(paren
r_struct
id|pci_dev
op_star
id|d
)paren
(brace
multiline_comment|/*&n;&t; *  SiS 5597 and 5598 chipsets require latency timer set to&n;&t; *  at most 32 to avoid lockups.&n;&t; */
id|DBG
c_func
(paren
l_string|&quot;PCI: Setting max latency to 32&bslash;n&quot;
)paren
suffix:semicolon
id|pcibios_max_latency
op_assign
l_int|32
suffix:semicolon
)brace
id|DECLARE_PCI_FIXUP_HEADER
c_func
(paren
id|PCI_VENDOR_ID_SI
comma
id|PCI_DEVICE_ID_SI_5597
comma
id|pci_fixup_latency
)paren
suffix:semicolon
id|DECLARE_PCI_FIXUP_HEADER
c_func
(paren
id|PCI_VENDOR_ID_SI
comma
id|PCI_DEVICE_ID_SI_5598
comma
id|pci_fixup_latency
)paren
suffix:semicolon
DECL|function|pci_fixup_piix4_acpi
r_static
r_void
id|__devinit
id|pci_fixup_piix4_acpi
c_func
(paren
r_struct
id|pci_dev
op_star
id|d
)paren
(brace
multiline_comment|/*&n;&t; * PIIX4 ACPI device: hardwired IRQ9&n;&t; */
id|d-&gt;irq
op_assign
l_int|9
suffix:semicolon
)brace
id|DECLARE_PCI_FIXUP_HEADER
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82371AB_3
comma
id|pci_fixup_piix4_acpi
)paren
suffix:semicolon
multiline_comment|/*&n; * Addresses issues with problems in the memory write queue timer in&n; * certain VIA Northbridges.  This bugfix is per VIA&squot;s specifications,&n; * except for the KL133/KM133: clearing bit 5 on those Northbridges seems&n; * to trigger a bug in its integrated ProSavage video card, which&n; * causes screen corruption.  We only clear bits 6 and 7 for that chipset,&n; * until VIA can provide us with definitive information on why screen&n; * corruption occurs, and what exactly those bits do.&n; *&n; * VIA 8363,8622,8361 Northbridges:&n; *  - bits  5, 6, 7 at offset 0x55 need to be turned off&n; * VIA 8367 (KT266x) Northbridges:&n; *  - bits  5, 6, 7 at offset 0x95 need to be turned off&n; * VIA 8363 rev 0x81/0x84 (KL133/KM133) Northbridges:&n; *  - bits     6, 7 at offset 0x55 need to be turned off&n; */
DECL|macro|VIA_8363_KL133_REVISION_ID
mdefine_line|#define VIA_8363_KL133_REVISION_ID 0x81
DECL|macro|VIA_8363_KM133_REVISION_ID
mdefine_line|#define VIA_8363_KM133_REVISION_ID 0x84
DECL|function|pci_fixup_via_northbridge_bug
r_static
r_void
id|__devinit
id|pci_fixup_via_northbridge_bug
c_func
(paren
r_struct
id|pci_dev
op_star
id|d
)paren
(brace
id|u8
id|v
suffix:semicolon
id|u8
id|revision
suffix:semicolon
r_int
id|where
op_assign
l_int|0x55
suffix:semicolon
r_int
id|mask
op_assign
l_int|0x1f
suffix:semicolon
multiline_comment|/* clear bits 5, 6, 7 by default */
id|pci_read_config_byte
c_func
(paren
id|d
comma
id|PCI_REVISION_ID
comma
op_amp
id|revision
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;device
op_eq
id|PCI_DEVICE_ID_VIA_8367_0
)paren
(brace
multiline_comment|/* fix pci bus latency issues resulted by NB bios error&n;&t;&t;   it appears on bug free^Wreduced kt266x&squot;s bios forces&n;&t;&t;   NB latency to zero */
id|pci_write_config_byte
c_func
(paren
id|d
comma
id|PCI_LATENCY_TIMER
comma
l_int|0
)paren
suffix:semicolon
id|where
op_assign
l_int|0x95
suffix:semicolon
multiline_comment|/* the memory write queue timer register is &n;&t;&t;&t;&t;different for the KT266x&squot;s: 0x95 not 0x55 */
)brace
r_else
r_if
c_cond
(paren
id|d-&gt;device
op_eq
id|PCI_DEVICE_ID_VIA_8363_0
op_logical_and
(paren
id|revision
op_eq
id|VIA_8363_KL133_REVISION_ID
op_logical_or
id|revision
op_eq
id|VIA_8363_KM133_REVISION_ID
)paren
)paren
(brace
id|mask
op_assign
l_int|0x3f
suffix:semicolon
multiline_comment|/* clear only bits 6 and 7; clearing bit 5&n;&t;&t;&t;&t;&t;causes screen corruption on the KL133/KM133 */
)brace
id|pci_read_config_byte
c_func
(paren
id|d
comma
id|where
comma
op_amp
id|v
)paren
suffix:semicolon
r_if
c_cond
(paren
id|v
op_amp
op_complement
id|mask
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Disabling VIA memory write queue (PCI ID %04x, rev %02x): [%02x] %02x &amp; %02x -&gt; %02x&bslash;n&quot;
comma
"&bslash;"
id|d-&gt;device
comma
id|revision
comma
id|where
comma
id|v
comma
id|mask
comma
id|v
op_amp
id|mask
)paren
suffix:semicolon
id|v
op_and_assign
id|mask
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|d
comma
id|where
comma
id|v
)paren
suffix:semicolon
)brace
)brace
id|DECLARE_PCI_FIXUP_HEADER
c_func
(paren
id|PCI_VENDOR_ID_VIA
comma
id|PCI_DEVICE_ID_VIA_8363_0
comma
id|pci_fixup_via_northbridge_bug
)paren
suffix:semicolon
id|DECLARE_PCI_FIXUP_HEADER
c_func
(paren
id|PCI_VENDOR_ID_VIA
comma
id|PCI_DEVICE_ID_VIA_8622
comma
id|pci_fixup_via_northbridge_bug
)paren
suffix:semicolon
id|DECLARE_PCI_FIXUP_HEADER
c_func
(paren
id|PCI_VENDOR_ID_VIA
comma
id|PCI_DEVICE_ID_VIA_8361
comma
id|pci_fixup_via_northbridge_bug
)paren
suffix:semicolon
id|DECLARE_PCI_FIXUP_HEADER
c_func
(paren
id|PCI_VENDOR_ID_VIA
comma
id|PCI_DEVICE_ID_VIA_8367_0
comma
id|pci_fixup_via_northbridge_bug
)paren
suffix:semicolon
multiline_comment|/*&n; * For some reasons Intel decided that certain parts of their&n; * 815, 845 and some other chipsets must look like PCI-to-PCI bridges&n; * while they are obviously not. The 82801 family (AA, AB, BAM/CAM,&n; * BA/CA/DB and E) PCI bridges are actually HUB-to-PCI ones, according&n; * to Intel terminology. These devices do forward all addresses from&n; * system to PCI bus no matter what are their window settings, so they are&n; * &quot;transparent&quot; (or subtractive decoding) from programmers point of view.&n; */
DECL|function|pci_fixup_transparent_bridge
r_static
r_void
id|__devinit
id|pci_fixup_transparent_bridge
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
(paren
id|dev
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_eq
id|PCI_CLASS_BRIDGE_PCI
op_logical_and
(paren
id|dev-&gt;device
op_amp
l_int|0xff00
)paren
op_eq
l_int|0x2400
)paren
id|dev-&gt;transparent
op_assign
l_int|1
suffix:semicolon
)brace
id|DECLARE_PCI_FIXUP_HEADER
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_ANY_ID
comma
id|pci_fixup_transparent_bridge
)paren
suffix:semicolon
multiline_comment|/*&n; * Fixup for C1 Halt Disconnect problem on nForce2 systems.&n; *&n; * From information provided by &quot;Allen Martin&quot; &lt;AMartin@nvidia.com&gt;:&n; *&n; * A hang is caused when the CPU generates a very fast CONNECT/HALT cycle&n; * sequence.  Workaround is to set the SYSTEM_IDLE_TIMEOUT to 80 ns.&n; * This allows the state-machine and timer to return to a proper state within&n; * 80 ns of the CONNECT and probe appearing together.  Since the CPU will not&n; * issue another HALT within 80 ns of the initial HALT, the failure condition&n; * is avoided.&n; */
DECL|function|pci_fixup_nforce2
r_static
r_void
id|__init
id|pci_fixup_nforce2
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|u32
id|val
suffix:semicolon
multiline_comment|/*&n;&t; * Chip  Old value   New value&n;&t; * C17   0x1F0FFF01  0x1F01FF01&n;&t; * C18D  0x9F0FFF01  0x9F01FF01&n;&t; *&n;&t; * Northbridge chip version may be determined by&n;&t; * reading the PCI revision ID (0xC1 or greater is C18D).&n;&t; */
id|pci_read_config_dword
c_func
(paren
id|dev
comma
l_int|0x6c
comma
op_amp
id|val
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Apply fixup if needed, but don&squot;t touch disconnect state&n;&t; */
r_if
c_cond
(paren
(paren
id|val
op_amp
l_int|0x00FF0000
)paren
op_ne
l_int|0x00010000
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PCI: nForce2 C1 Halt Disconnect fixup&bslash;n&quot;
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|dev
comma
l_int|0x6c
comma
(paren
id|val
op_amp
l_int|0xFF00FFFF
)paren
op_or
l_int|0x00010000
)paren
suffix:semicolon
)brace
)brace
id|DECLARE_PCI_FIXUP_HEADER
c_func
(paren
id|PCI_VENDOR_ID_NVIDIA
comma
id|PCI_DEVICE_ID_NVIDIA_NFORCE2
comma
id|pci_fixup_nforce2
)paren
suffix:semicolon
multiline_comment|/* Max PCI Express root ports */
DECL|macro|MAX_PCIEROOT
mdefine_line|#define MAX_PCIEROOT&t;6
DECL|variable|quirk_aspm_offset
r_static
r_int
id|quirk_aspm_offset
(braket
id|MAX_PCIEROOT
op_lshift
l_int|3
)braket
suffix:semicolon
DECL|macro|GET_INDEX
mdefine_line|#define GET_INDEX(a, b) (((a - PCI_DEVICE_ID_INTEL_MCH_PA) &lt;&lt; 3) + b)
DECL|function|quirk_pcie_aspm_read
r_static
r_int
id|quirk_pcie_aspm_read
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
op_star
id|value
)paren
(brace
r_return
id|raw_pci_ops
op_member_access_from_pointer
id|read
c_func
(paren
l_int|0
comma
id|bus-&gt;number
comma
id|devfn
comma
id|where
comma
id|size
comma
id|value
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Replace the original pci bus ops for write with a new one that will filter&n; * the request to insure ASPM cannot be enabled.&n; */
DECL|function|quirk_pcie_aspm_write
r_static
r_int
id|quirk_pcie_aspm_write
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
id|value
)paren
(brace
id|u8
id|offset
suffix:semicolon
id|offset
op_assign
id|quirk_aspm_offset
(braket
id|GET_INDEX
c_func
(paren
id|bus-&gt;self-&gt;device
comma
id|devfn
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|offset
)paren
op_logical_and
(paren
id|where
op_eq
id|offset
)paren
)paren
id|value
op_assign
id|value
op_amp
l_int|0xfffffffc
suffix:semicolon
r_return
id|raw_pci_ops
op_member_access_from_pointer
id|write
c_func
(paren
l_int|0
comma
id|bus-&gt;number
comma
id|devfn
comma
id|where
comma
id|size
comma
id|value
)paren
suffix:semicolon
)brace
DECL|variable|quirk_pcie_aspm_ops
r_static
r_struct
id|pci_ops
id|quirk_pcie_aspm_ops
op_assign
(brace
dot
id|read
op_assign
id|quirk_pcie_aspm_read
comma
dot
id|write
op_assign
id|quirk_pcie_aspm_write
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Prevents PCI Express ASPM (Active State Power Management) being enabled.&n; *&n; * Save the register offset, where the ASPM control bits are located,&n; * for each PCI Express device that is in the device list of&n; * the root port in an array for fast indexing. Replace the bus ops&n; * with the modified one.&n; */
DECL|function|pcie_rootport_aspm_quirk
r_static
r_void
id|pcie_rootport_aspm_quirk
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_int
id|cap_base
comma
id|i
suffix:semicolon
r_struct
id|pci_bus
op_star
id|pbus
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pbus
op_assign
id|pdev-&gt;subordinate
)paren
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * Check if the DID of pdev matches one of the six root ports. This&n;&t; * check is needed in the case this function is called directly by the&n;&t; * hot-plug driver.&n;&t; */
r_if
c_cond
(paren
(paren
id|pdev-&gt;device
OL
id|PCI_DEVICE_ID_INTEL_MCH_PA
)paren
op_logical_or
(paren
id|pdev-&gt;device
OG
id|PCI_DEVICE_ID_INTEL_MCH_PC1
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|pbus-&gt;devices
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * If no device is attached to the root port at power-up or&n;&t;&t; * after hot-remove, the pbus-&gt;devices is empty and this code&n;&t;&t; * will set the offsets to zero and the bus ops to parent&squot;s bus&n;&t;&t; * ops, which is unmodified.&n;&t; &t; */
r_for
c_loop
(paren
id|i
op_assign
id|GET_INDEX
c_func
(paren
id|pdev-&gt;device
comma
l_int|0
)paren
suffix:semicolon
id|i
op_le
id|GET_INDEX
c_func
(paren
id|pdev-&gt;device
comma
l_int|7
)paren
suffix:semicolon
op_increment
id|i
)paren
id|quirk_aspm_offset
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|pbus-&gt;ops
op_assign
id|pbus-&gt;parent-&gt;ops
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * If devices are attached to the root port at power-up or&n;&t;&t; * after hot-add, the code loops through the device list of&n;&t;&t; * each root port to save the register offsets and replace the&n;&t;&t; * bus ops.&n;&t;&t; */
id|list_for_each_entry
c_func
(paren
id|dev
comma
op_amp
id|pbus-&gt;devices
comma
id|bus_list
)paren
(brace
multiline_comment|/* There are 0 to 8 devices attached to this bus */
id|cap_base
op_assign
id|pci_find_capability
c_func
(paren
id|dev
comma
id|PCI_CAP_ID_EXP
)paren
suffix:semicolon
id|quirk_aspm_offset
(braket
id|GET_INDEX
c_func
(paren
id|pdev-&gt;device
comma
id|dev-&gt;devfn
)paren
)braket
op_assign
id|cap_base
op_plus
l_int|0x10
suffix:semicolon
)brace
id|pbus-&gt;ops
op_assign
op_amp
id|quirk_pcie_aspm_ops
suffix:semicolon
)brace
)brace
id|DECLARE_PCI_FIXUP_FINAL
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_MCH_PA
comma
id|pcie_rootport_aspm_quirk
)paren
suffix:semicolon
id|DECLARE_PCI_FIXUP_FINAL
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_MCH_PA1
comma
id|pcie_rootport_aspm_quirk
)paren
suffix:semicolon
id|DECLARE_PCI_FIXUP_FINAL
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_MCH_PB
comma
id|pcie_rootport_aspm_quirk
)paren
suffix:semicolon
id|DECLARE_PCI_FIXUP_FINAL
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_MCH_PB1
comma
id|pcie_rootport_aspm_quirk
)paren
suffix:semicolon
id|DECLARE_PCI_FIXUP_FINAL
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_MCH_PC
comma
id|pcie_rootport_aspm_quirk
)paren
suffix:semicolon
id|DECLARE_PCI_FIXUP_FINAL
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_MCH_PC1
comma
id|pcie_rootport_aspm_quirk
)paren
suffix:semicolon
multiline_comment|/*&n; * Fixup to mark boot BIOS video selected by BIOS before it changes&n; *&n; * From information provided by &quot;Jon Smirl&quot; &lt;jonsmirl@gmail.com&gt;&n; *&n; * The standard boot ROM sequence for an x86 machine uses the BIOS&n; * to select an initial video card for boot display. This boot video &n; * card will have it&squot;s BIOS copied to C0000 in system RAM. &n; * IORESOURCE_ROM_SHADOW is used to associate the boot video&n; * card with this copy. On laptops this copy has to be used since&n; * the main ROM may be compressed or combined with another image.&n; * See pci_map_rom() for use of this flag. IORESOURCE_ROM_SHADOW&n; * is marked here since the boot video device will be the only enabled&n; * video device at this point.&n; */
DECL|function|pci_fixup_video
r_static
r_void
id|__devinit
id|pci_fixup_video
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|pci_dev
op_star
id|bridge
suffix:semicolon
r_struct
id|pci_bus
op_star
id|bus
suffix:semicolon
id|u16
id|config
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pdev
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_ne
id|PCI_CLASS_DISPLAY_VGA
)paren
r_return
suffix:semicolon
multiline_comment|/* Is VGA routed to us? */
id|bus
op_assign
id|pdev-&gt;bus
suffix:semicolon
r_while
c_loop
(paren
id|bus
)paren
(brace
id|bridge
op_assign
id|bus-&gt;self
suffix:semicolon
r_if
c_cond
(paren
id|bridge
)paren
(brace
id|pci_read_config_word
c_func
(paren
id|bridge
comma
id|PCI_BRIDGE_CONTROL
comma
op_amp
id|config
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|config
op_amp
id|PCI_BRIDGE_CTL_VGA
)paren
)paren
r_return
suffix:semicolon
)brace
id|bus
op_assign
id|bus-&gt;parent
suffix:semicolon
)brace
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_COMMAND
comma
op_amp
id|config
)paren
suffix:semicolon
r_if
c_cond
(paren
id|config
op_amp
(paren
id|PCI_COMMAND_IO
op_or
id|PCI_COMMAND_MEMORY
)paren
)paren
(brace
id|pdev-&gt;resource
(braket
id|PCI_ROM_RESOURCE
)braket
dot
id|flags
op_or_assign
id|IORESOURCE_ROM_SHADOW
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Boot video device is %s&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
)brace
)brace
id|DECLARE_PCI_FIXUP_HEADER
c_func
(paren
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|pci_fixup_video
)paren
suffix:semicolon
eof
