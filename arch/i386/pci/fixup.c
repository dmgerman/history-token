multiline_comment|/*&n; * Exceptions for specific devices. Usually work-arounds for fatal design flaws.&n; */
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &quot;pci.h&quot;
DECL|function|pci_fixup_i450nx
r_static
r_void
id|__devinit
id|pci_fixup_i450nx
c_func
(paren
r_struct
id|pci_dev
op_star
id|d
)paren
(brace
multiline_comment|/*&n;&t; * i450NX -- Find and scan all secondary buses on all PXB&squot;s.&n;&t; */
r_int
id|pxb
comma
id|reg
suffix:semicolon
id|u8
id|busno
comma
id|suba
comma
id|subb
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PCI: Searching for i450NX host bridges on %s&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|d
)paren
)paren
suffix:semicolon
id|reg
op_assign
l_int|0xd0
suffix:semicolon
r_for
c_loop
(paren
id|pxb
op_assign
l_int|0
suffix:semicolon
id|pxb
OL
l_int|2
suffix:semicolon
id|pxb
op_increment
)paren
(brace
id|pci_read_config_byte
c_func
(paren
id|d
comma
id|reg
op_increment
comma
op_amp
id|busno
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|d
comma
id|reg
op_increment
comma
op_amp
id|suba
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|d
comma
id|reg
op_increment
comma
op_amp
id|subb
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;i450NX PXB %d: %02x/%02x/%02x&bslash;n&quot;
comma
id|pxb
comma
id|busno
comma
id|suba
comma
id|subb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|busno
)paren
id|pci_scan_bus
c_func
(paren
id|busno
comma
op_amp
id|pci_root_ops
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Bus A */
r_if
c_cond
(paren
id|suba
OL
id|subb
)paren
id|pci_scan_bus
c_func
(paren
id|suba
op_plus
l_int|1
comma
op_amp
id|pci_root_ops
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Bus B */
)brace
id|pcibios_last_bus
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|pci_fixup_i450gx
r_static
r_void
id|__devinit
id|pci_fixup_i450gx
c_func
(paren
r_struct
id|pci_dev
op_star
id|d
)paren
(brace
multiline_comment|/*&n;&t; * i450GX and i450KX -- Find and scan all secondary buses.&n;&t; * (called separately for each PCI bridge found)&n;&t; */
id|u8
id|busno
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|d
comma
l_int|0x4a
comma
op_amp
id|busno
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PCI: i440KX/GX host bridge %s: secondary bus %02x&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|d
)paren
comma
id|busno
)paren
suffix:semicolon
id|pci_scan_bus
c_func
(paren
id|busno
comma
op_amp
id|pci_root_ops
comma
l_int|NULL
)paren
suffix:semicolon
id|pcibios_last_bus
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|pci_fixup_umc_ide
r_static
r_void
id|__devinit
id|pci_fixup_umc_ide
c_func
(paren
r_struct
id|pci_dev
op_star
id|d
)paren
(brace
multiline_comment|/*&n;&t; * UM8886BF IDE controller sets region type bits incorrectly,&n;&t; * therefore they look like memory despite of them being I/O.&n;&t; */
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PCI: Fixing base address flags for device %s&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|d
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|d-&gt;resource
(braket
id|i
)braket
dot
id|flags
op_or_assign
id|PCI_BASE_ADDRESS_SPACE_IO
suffix:semicolon
)brace
)brace
DECL|function|pci_fixup_ncr53c810
r_static
r_void
id|__devinit
id|pci_fixup_ncr53c810
c_func
(paren
r_struct
id|pci_dev
op_star
id|d
)paren
(brace
multiline_comment|/*&n;&t; * NCR 53C810 returns class code 0 (at least on some systems).&n;&t; * Fix class to be PCI_CLASS_STORAGE_SCSI&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|d
op_member_access_from_pointer
r_class
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PCI: fixing NCR 53C810 class code for %s&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|d
)paren
)paren
suffix:semicolon
id|d
op_member_access_from_pointer
r_class
op_assign
id|PCI_CLASS_STORAGE_SCSI
op_lshift
l_int|8
suffix:semicolon
)brace
)brace
DECL|function|pci_fixup_ide_bases
r_static
r_void
id|__devinit
id|pci_fixup_ide_bases
c_func
(paren
r_struct
id|pci_dev
op_star
id|d
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * PCI IDE controllers use non-standard I/O port decoding, respect it.&n;&t; */
r_if
c_cond
(paren
(paren
id|d
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_ne
id|PCI_CLASS_STORAGE_IDE
)paren
r_return
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;PCI: IDE base address fixup for %s&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|d
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|resource
op_star
id|r
op_assign
op_amp
id|d-&gt;resource
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r-&gt;start
op_amp
op_complement
l_int|0x80
)paren
op_eq
l_int|0x374
)paren
(brace
id|r-&gt;start
op_or_assign
l_int|2
suffix:semicolon
id|r-&gt;end
op_assign
id|r-&gt;start
suffix:semicolon
)brace
)brace
)brace
DECL|function|pci_fixup_ide_trash
r_static
r_void
id|__devinit
id|pci_fixup_ide_trash
c_func
(paren
r_struct
id|pci_dev
op_star
id|d
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * There exist PCI IDE controllers which have utter garbage&n;&t; * in first four base registers. Ignore that.&n;&t; */
id|DBG
c_func
(paren
l_string|&quot;PCI: IDE base address trash cleared for %s&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|d
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|d-&gt;resource
(braket
id|i
)braket
dot
id|start
op_assign
id|d-&gt;resource
(braket
id|i
)braket
dot
id|end
op_assign
id|d-&gt;resource
(braket
id|i
)braket
dot
id|flags
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|pci_fixup_latency
r_static
r_void
id|__devinit
id|pci_fixup_latency
c_func
(paren
r_struct
id|pci_dev
op_star
id|d
)paren
(brace
multiline_comment|/*&n;&t; *  SiS 5597 and 5598 chipsets require latency timer set to&n;&t; *  at most 32 to avoid lockups.&n;&t; */
id|DBG
c_func
(paren
l_string|&quot;PCI: Setting max latency to 32&bslash;n&quot;
)paren
suffix:semicolon
id|pcibios_max_latency
op_assign
l_int|32
suffix:semicolon
)brace
DECL|function|pci_fixup_piix4_acpi
r_static
r_void
id|__devinit
id|pci_fixup_piix4_acpi
c_func
(paren
r_struct
id|pci_dev
op_star
id|d
)paren
(brace
multiline_comment|/*&n;&t; * PIIX4 ACPI device: hardwired IRQ9&n;&t; */
id|d-&gt;irq
op_assign
l_int|9
suffix:semicolon
)brace
multiline_comment|/*&n; * Addresses issues with problems in the memory write queue timer in&n; * certain VIA Northbridges.  This bugfix is per VIA&squot;s specifications,&n; * except for the KL133/KM133: clearing bit 5 on those Northbridges seems&n; * to trigger a bug in its integrated ProSavage video card, which&n; * causes screen corruption.  We only clear bits 6 and 7 for that chipset,&n; * until VIA can provide us with definitive information on why screen&n; * corruption occurs, and what exactly those bits do.&n; *&n; * VIA 8363,8622,8361 Northbridges:&n; *  - bits  5, 6, 7 at offset 0x55 need to be turned off&n; * VIA 8367 (KT266x) Northbridges:&n; *  - bits  5, 6, 7 at offset 0x95 need to be turned off&n; * VIA 8363 rev 0x81/0x84 (KL133/KM133) Northbridges:&n; *  - bits     6, 7 at offset 0x55 need to be turned off&n; */
DECL|macro|VIA_8363_KL133_REVISION_ID
mdefine_line|#define VIA_8363_KL133_REVISION_ID 0x81
DECL|macro|VIA_8363_KM133_REVISION_ID
mdefine_line|#define VIA_8363_KM133_REVISION_ID 0x84
DECL|function|pci_fixup_via_northbridge_bug
r_static
r_void
id|__devinit
id|pci_fixup_via_northbridge_bug
c_func
(paren
r_struct
id|pci_dev
op_star
id|d
)paren
(brace
id|u8
id|v
suffix:semicolon
id|u8
id|revision
suffix:semicolon
r_int
id|where
op_assign
l_int|0x55
suffix:semicolon
r_int
id|mask
op_assign
l_int|0x1f
suffix:semicolon
multiline_comment|/* clear bits 5, 6, 7 by default */
id|pci_read_config_byte
c_func
(paren
id|d
comma
id|PCI_REVISION_ID
comma
op_amp
id|revision
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;device
op_eq
id|PCI_DEVICE_ID_VIA_8367_0
)paren
(brace
multiline_comment|/* fix pci bus latency issues resulted by NB bios error&n;&t;&t;   it appears on bug free^Wreduced kt266x&squot;s bios forces&n;&t;&t;   NB latency to zero */
id|pci_write_config_byte
c_func
(paren
id|d
comma
id|PCI_LATENCY_TIMER
comma
l_int|0
)paren
suffix:semicolon
id|where
op_assign
l_int|0x95
suffix:semicolon
multiline_comment|/* the memory write queue timer register is &n;&t;&t;&t;&t;different for the KT266x&squot;s: 0x95 not 0x55 */
)brace
r_else
r_if
c_cond
(paren
id|d-&gt;device
op_eq
id|PCI_DEVICE_ID_VIA_8363_0
op_logical_and
(paren
id|revision
op_eq
id|VIA_8363_KL133_REVISION_ID
op_logical_or
id|revision
op_eq
id|VIA_8363_KM133_REVISION_ID
)paren
)paren
(brace
id|mask
op_assign
l_int|0x3f
suffix:semicolon
multiline_comment|/* clear only bits 6 and 7; clearing bit 5&n;&t;&t;&t;&t;&t;causes screen corruption on the KL133/KM133 */
)brace
id|pci_read_config_byte
c_func
(paren
id|d
comma
id|where
comma
op_amp
id|v
)paren
suffix:semicolon
r_if
c_cond
(paren
id|v
op_amp
op_complement
id|mask
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Disabling VIA memory write queue (PCI ID %04x, rev %02x): [%02x] %02x &amp; %02x -&gt; %02x&bslash;n&quot;
comma
"&bslash;"
id|d-&gt;device
comma
id|revision
comma
id|where
comma
id|v
comma
id|mask
comma
id|v
op_amp
id|mask
)paren
suffix:semicolon
id|v
op_and_assign
id|mask
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|d
comma
id|where
comma
id|v
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * For some reasons Intel decided that certain parts of their&n; * 815, 845 and some other chipsets must look like PCI-to-PCI bridges&n; * while they are obviously not. The 82801 family (AA, AB, BAM/CAM,&n; * BA/CA/DB and E) PCI bridges are actually HUB-to-PCI ones, according&n; * to Intel terminology. These devices do forward all addresses from&n; * system to PCI bus no matter what are their window settings, so they are&n; * &quot;transparent&quot; (or subtractive decoding) from programmers point of view.&n; */
DECL|function|pci_fixup_transparent_bridge
r_static
r_void
id|__devinit
id|pci_fixup_transparent_bridge
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
(paren
id|dev
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_eq
id|PCI_CLASS_BRIDGE_PCI
op_logical_and
(paren
id|dev-&gt;device
op_amp
l_int|0xff00
)paren
op_eq
l_int|0x2400
)paren
id|dev-&gt;transparent
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Fixup for C1 Halt Disconnect problem on nForce2 systems.&n; *&n; * From information provided by &quot;Allen Martin&quot; &lt;AMartin@nvidia.com&gt;:&n; *&n; * A hang is caused when the CPU generates a very fast CONNECT/HALT cycle&n; * sequence.  Workaround is to set the SYSTEM_IDLE_TIMEOUT to 80 ns.&n; * This allows the state-machine and timer to return to a proper state within&n; * 80 ns of the CONNECT and probe appearing together.  Since the CPU will not&n; * issue another HALT within 80 ns of the initial HALT, the failure condition&n; * is avoided.&n; */
DECL|function|pci_fixup_nforce2
r_static
r_void
id|__init
id|pci_fixup_nforce2
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|u32
id|val
comma
id|fixed_val
suffix:semicolon
id|u8
id|rev
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|PCI_REVISION_ID
comma
op_amp
id|rev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Chip  Old value   New value&n;&t; * C17   0x1F0FFF01  0x1F01FF01&n;&t; * C18D  0x9F0FFF01  0x9F01FF01&n;&t; *&n;&t; * Northbridge chip version may be determined by&n;&t; * reading the PCI revision ID (0xC1 or greater is C18D).&n;&t; */
id|fixed_val
op_assign
id|rev
OL
l_int|0xC1
ques
c_cond
l_int|0x1F01FF01
suffix:colon
l_int|0x9F01FF01
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|dev
comma
l_int|0x6c
comma
op_amp
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
id|fixed_val
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PCI: nForce2 C1 Halt Disconnect fixup&bslash;n&quot;
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|dev
comma
l_int|0x6c
comma
id|fixed_val
)paren
suffix:semicolon
)brace
)brace
DECL|variable|pcibios_fixups
r_struct
id|pci_fixup
id|pcibios_fixups
(braket
)braket
op_assign
(brace
(brace
dot
id|pass
op_assign
id|PCI_FIXUP_HEADER
comma
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_INTEL
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_INTEL_82451NX
comma
dot
id|hook
op_assign
id|pci_fixup_i450nx
)brace
comma
(brace
dot
id|pass
op_assign
id|PCI_FIXUP_HEADER
comma
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_INTEL
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_INTEL_82454GX
comma
dot
id|hook
op_assign
id|pci_fixup_i450gx
)brace
comma
(brace
dot
id|pass
op_assign
id|PCI_FIXUP_HEADER
comma
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_UMC
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_UMC_UM8886BF
comma
dot
id|hook
op_assign
id|pci_fixup_umc_ide
)brace
comma
(brace
dot
id|pass
op_assign
id|PCI_FIXUP_HEADER
comma
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_SI
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_SI_5513
comma
dot
id|hook
op_assign
id|pci_fixup_ide_trash
)brace
comma
(brace
dot
id|pass
op_assign
id|PCI_FIXUP_HEADER
comma
dot
id|vendor
op_assign
id|PCI_ANY_ID
comma
dot
id|device
op_assign
id|PCI_ANY_ID
comma
dot
id|hook
op_assign
id|pci_fixup_ide_bases
)brace
comma
(brace
dot
id|pass
op_assign
id|PCI_FIXUP_HEADER
comma
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_SI
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_SI_5597
comma
dot
id|hook
op_assign
id|pci_fixup_latency
)brace
comma
(brace
dot
id|pass
op_assign
id|PCI_FIXUP_HEADER
comma
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_SI
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_SI_5598
comma
dot
id|hook
op_assign
id|pci_fixup_latency
)brace
comma
(brace
dot
id|pass
op_assign
id|PCI_FIXUP_HEADER
comma
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_INTEL
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_INTEL_82371AB_3
comma
dot
id|hook
op_assign
id|pci_fixup_piix4_acpi
)brace
comma
(brace
dot
id|pass
op_assign
id|PCI_FIXUP_HEADER
comma
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_INTEL
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_INTEL_82801CA_10
comma
dot
id|hook
op_assign
id|pci_fixup_ide_trash
)brace
comma
(brace
dot
id|pass
op_assign
id|PCI_FIXUP_HEADER
comma
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_INTEL
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_INTEL_82801CA_11
comma
dot
id|hook
op_assign
id|pci_fixup_ide_trash
)brace
comma
(brace
dot
id|pass
op_assign
id|PCI_FIXUP_HEADER
comma
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_INTEL
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_INTEL_82801DB_9
comma
dot
id|hook
op_assign
id|pci_fixup_ide_trash
)brace
comma
(brace
dot
id|pass
op_assign
id|PCI_FIXUP_HEADER
comma
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_VIA
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_VIA_8363_0
comma
dot
id|hook
op_assign
id|pci_fixup_via_northbridge_bug
)brace
comma
(brace
dot
id|pass
op_assign
id|PCI_FIXUP_HEADER
comma
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_VIA
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_VIA_8622
comma
dot
id|hook
op_assign
id|pci_fixup_via_northbridge_bug
)brace
comma
(brace
dot
id|pass
op_assign
id|PCI_FIXUP_HEADER
comma
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_VIA
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_VIA_8361
comma
dot
id|hook
op_assign
id|pci_fixup_via_northbridge_bug
)brace
comma
(brace
dot
id|pass
op_assign
id|PCI_FIXUP_HEADER
comma
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_VIA
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_VIA_8367_0
comma
dot
id|hook
op_assign
id|pci_fixup_via_northbridge_bug
)brace
comma
(brace
dot
id|pass
op_assign
id|PCI_FIXUP_HEADER
comma
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_NCR
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_NCR_53C810
comma
dot
id|hook
op_assign
id|pci_fixup_ncr53c810
)brace
comma
(brace
dot
id|pass
op_assign
id|PCI_FIXUP_HEADER
comma
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_INTEL
comma
dot
id|device
op_assign
id|PCI_ANY_ID
comma
dot
id|hook
op_assign
id|pci_fixup_transparent_bridge
)brace
comma
(brace
dot
id|pass
op_assign
id|PCI_FIXUP_HEADER
comma
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_NVIDIA
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_NVIDIA_NFORCE2
comma
dot
id|hook
op_assign
id|pci_fixup_nforce2
)brace
comma
(brace
dot
id|pass
op_assign
l_int|0
)brace
)brace
suffix:semicolon
eof
