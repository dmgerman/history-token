multiline_comment|/*&n; *&t;Low-Level PCI Support for PC -- Routing of Interrupts&n; *&n; *&t;(c) 1999--2000 Martin Mares &lt;mj@ucw.cz&gt;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/dmi.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/smp.h&gt;
macro_line|#include &lt;asm/io_apic.h&gt;
macro_line|#include &lt;asm/hw_irq.h&gt;
macro_line|#include &lt;linux/acpi.h&gt;
macro_line|#include &quot;pci.h&quot;
DECL|macro|PIRQ_SIGNATURE
mdefine_line|#define PIRQ_SIGNATURE&t;((&squot;$&squot; &lt;&lt; 0) + (&squot;P&squot; &lt;&lt; 8) + (&squot;I&squot; &lt;&lt; 16) + (&squot;R&squot; &lt;&lt; 24))
DECL|macro|PIRQ_VERSION
mdefine_line|#define PIRQ_VERSION 0x0100
DECL|variable|broken_hp_bios_irq9
r_static
r_int
id|broken_hp_bios_irq9
suffix:semicolon
DECL|variable|acer_tm360_irqrouting
r_static
r_int
id|acer_tm360_irqrouting
suffix:semicolon
DECL|variable|pirq_table
r_static
r_struct
id|irq_routing_table
op_star
id|pirq_table
suffix:semicolon
multiline_comment|/*&n; * Never use: 0, 1, 2 (timer, keyboard, and cascade)&n; * Avoid using: 13, 14 and 15 (FP error and IDE).&n; * Penalize: 3, 4, 6, 7, 12 (known ISA uses: serial, floppy, parallel and mouse)&n; */
DECL|variable|pcibios_irq_mask
r_int
r_int
id|pcibios_irq_mask
op_assign
l_int|0xfff8
suffix:semicolon
DECL|variable|pirq_penalty
r_static
r_int
id|pirq_penalty
(braket
l_int|16
)braket
op_assign
(brace
l_int|1000000
comma
l_int|1000000
comma
l_int|1000000
comma
l_int|1000
comma
l_int|1000
comma
l_int|0
comma
l_int|1000
comma
l_int|1000
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|1000
comma
l_int|100000
comma
l_int|100000
comma
l_int|100000
)brace
suffix:semicolon
DECL|struct|irq_router
r_struct
id|irq_router
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|vendor
DECL|member|device
id|u16
id|vendor
comma
id|device
suffix:semicolon
DECL|member|get
r_int
(paren
op_star
id|get
)paren
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pirq
)paren
suffix:semicolon
DECL|member|set
r_int
(paren
op_star
id|set
)paren
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pirq
comma
r_int
r_new
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|irq_router_handler
r_struct
id|irq_router_handler
(brace
DECL|member|vendor
id|u16
id|vendor
suffix:semicolon
DECL|member|probe
r_int
(paren
op_star
id|probe
)paren
(paren
r_struct
id|irq_router
op_star
id|r
comma
r_struct
id|pci_dev
op_star
id|router
comma
id|u16
id|device
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|pcibios_enable_irq
r_int
(paren
op_star
id|pcibios_enable_irq
)paren
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n; *  Search 0xf0000 -- 0xfffff for the PCI IRQ Routing Table.&n; */
DECL|function|pirq_find_routing_table
r_static
r_struct
id|irq_routing_table
op_star
id|__init
id|pirq_find_routing_table
c_func
(paren
r_void
)paren
(brace
id|u8
op_star
id|addr
suffix:semicolon
r_struct
id|irq_routing_table
op_star
id|rt
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u8
id|sum
suffix:semicolon
r_for
c_loop
(paren
id|addr
op_assign
(paren
id|u8
op_star
)paren
id|__va
c_func
(paren
l_int|0xf0000
)paren
suffix:semicolon
id|addr
OL
(paren
id|u8
op_star
)paren
id|__va
c_func
(paren
l_int|0x100000
)paren
suffix:semicolon
id|addr
op_add_assign
l_int|16
)paren
(brace
id|rt
op_assign
(paren
r_struct
id|irq_routing_table
op_star
)paren
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|rt-&gt;signature
op_ne
id|PIRQ_SIGNATURE
op_logical_or
id|rt-&gt;version
op_ne
id|PIRQ_VERSION
op_logical_or
id|rt-&gt;size
op_mod
l_int|16
op_logical_or
id|rt-&gt;size
OL
r_sizeof
(paren
r_struct
id|irq_routing_table
)paren
)paren
r_continue
suffix:semicolon
id|sum
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|rt-&gt;size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sum
op_add_assign
id|addr
(braket
id|i
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|sum
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;PCI: Interrupt Routing Table found at 0x%p&bslash;n&quot;
comma
id|rt
)paren
suffix:semicolon
r_return
id|rt
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *  If we have a IRQ routing table, use it to search for peer host&n; *  bridges.  It&squot;s a gross hack, but since there are no other known&n; *  ways how to get a list of buses, we have to go this way.&n; */
DECL|function|pirq_peer_trick
r_static
r_void
id|__init
id|pirq_peer_trick
c_func
(paren
r_void
)paren
(brace
r_struct
id|irq_routing_table
op_star
id|rt
op_assign
id|pirq_table
suffix:semicolon
id|u8
id|busmap
(braket
l_int|256
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|irq_info
op_star
id|e
suffix:semicolon
id|memset
c_func
(paren
id|busmap
comma
l_int|0
comma
r_sizeof
(paren
id|busmap
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|rt-&gt;size
op_minus
r_sizeof
(paren
r_struct
id|irq_routing_table
)paren
)paren
op_div
r_sizeof
(paren
r_struct
id|irq_info
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|e
op_assign
op_amp
id|rt-&gt;slots
(braket
id|i
)braket
suffix:semicolon
macro_line|#ifdef DEBUG
(brace
r_int
id|j
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%02x:%02x slot=%02x&quot;
comma
id|e-&gt;bus
comma
id|e-&gt;devfn
op_div
l_int|8
comma
id|e-&gt;slot
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|4
suffix:semicolon
id|j
op_increment
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot; %d:%02x/%04x&quot;
comma
id|j
comma
id|e-&gt;irq
(braket
id|j
)braket
dot
id|link
comma
id|e-&gt;irq
(braket
id|j
)braket
dot
id|bitmap
)paren
suffix:semicolon
)brace
id|DBG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|busmap
(braket
id|e-&gt;bus
)braket
op_assign
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|busmap
(braket
id|i
)braket
op_logical_or
id|pci_find_bus
c_func
(paren
l_int|0
comma
id|i
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|pci_scan_bus
c_func
(paren
id|i
comma
op_amp
id|pci_root_ops
comma
l_int|NULL
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PCI: Discovered primary peer bus %02x [IRQ]&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
id|pcibios_last_bus
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *  Code for querying and setting of IRQ routes on various interrupt routers.&n; */
DECL|function|eisa_set_level_irq
r_void
id|eisa_set_level_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_char
id|mask
op_assign
l_int|1
op_lshift
(paren
id|irq
op_amp
l_int|7
)paren
suffix:semicolon
r_int
r_int
id|port
op_assign
l_int|0x4d0
op_plus
(paren
id|irq
op_rshift
l_int|3
)paren
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
r_static
id|u16
id|eisa_irq_mask
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_ge
l_int|16
op_logical_or
(paren
l_int|1
op_lshift
id|irq
)paren
op_amp
id|eisa_irq_mask
)paren
r_return
suffix:semicolon
id|eisa_irq_mask
op_or_assign
(paren
l_int|1
op_lshift
id|irq
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI: setting IRQ %u as level-triggered&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
id|val
op_assign
id|inb
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|val
op_amp
id|mask
)paren
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot; -&gt; edge&quot;
)paren
suffix:semicolon
id|outb
c_func
(paren
id|val
op_or
id|mask
comma
id|port
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Common IRQ routing practice: nybbles in config space,&n; * offset by some magic constant.&n; */
DECL|function|read_config_nybble
r_static
r_int
r_int
id|read_config_nybble
c_func
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_int
id|offset
comma
r_int
id|nr
)paren
(brace
id|u8
id|x
suffix:semicolon
r_int
id|reg
op_assign
id|offset
op_plus
(paren
id|nr
op_rshift
l_int|1
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|router
comma
id|reg
comma
op_amp
id|x
)paren
suffix:semicolon
r_return
(paren
id|nr
op_amp
l_int|1
)paren
ques
c_cond
(paren
id|x
op_rshift
l_int|4
)paren
suffix:colon
(paren
id|x
op_amp
l_int|0xf
)paren
suffix:semicolon
)brace
DECL|function|write_config_nybble
r_static
r_void
id|write_config_nybble
c_func
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_int
id|offset
comma
r_int
id|nr
comma
r_int
r_int
id|val
)paren
(brace
id|u8
id|x
suffix:semicolon
r_int
id|reg
op_assign
id|offset
op_plus
(paren
id|nr
op_rshift
l_int|1
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|router
comma
id|reg
comma
op_amp
id|x
)paren
suffix:semicolon
id|x
op_assign
(paren
id|nr
op_amp
l_int|1
)paren
ques
c_cond
(paren
(paren
id|x
op_amp
l_int|0x0f
)paren
op_or
(paren
id|val
op_lshift
l_int|4
)paren
)paren
suffix:colon
(paren
(paren
id|x
op_amp
l_int|0xf0
)paren
op_or
id|val
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|router
comma
id|reg
comma
id|x
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * ALI pirq entries are damn ugly, and completely undocumented.&n; * This has been figured out from pirq tables, and it&squot;s not a pretty&n; * picture.&n; */
DECL|function|pirq_ali_get
r_static
r_int
id|pirq_ali_get
c_func
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pirq
)paren
(brace
r_static
r_int
r_char
id|irqmap
(braket
l_int|16
)braket
op_assign
(brace
l_int|0
comma
l_int|9
comma
l_int|3
comma
l_int|10
comma
l_int|4
comma
l_int|5
comma
l_int|7
comma
l_int|6
comma
l_int|1
comma
l_int|11
comma
l_int|0
comma
l_int|12
comma
l_int|0
comma
l_int|14
comma
l_int|0
comma
l_int|15
)brace
suffix:semicolon
r_return
id|irqmap
(braket
id|read_config_nybble
c_func
(paren
id|router
comma
l_int|0x48
comma
id|pirq
op_minus
l_int|1
)paren
)braket
suffix:semicolon
)brace
DECL|function|pirq_ali_set
r_static
r_int
id|pirq_ali_set
c_func
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pirq
comma
r_int
id|irq
)paren
(brace
r_static
r_int
r_char
id|irqmap
(braket
l_int|16
)braket
op_assign
(brace
l_int|0
comma
l_int|8
comma
l_int|0
comma
l_int|2
comma
l_int|4
comma
l_int|5
comma
l_int|7
comma
l_int|6
comma
l_int|0
comma
l_int|1
comma
l_int|3
comma
l_int|9
comma
l_int|11
comma
l_int|0
comma
l_int|13
comma
l_int|15
)brace
suffix:semicolon
r_int
r_int
id|val
op_assign
id|irqmap
(braket
id|irq
)braket
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
(brace
id|write_config_nybble
c_func
(paren
id|router
comma
l_int|0x48
comma
id|pirq
op_minus
l_int|1
comma
id|val
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * The Intel PIIX4 pirq rules are fairly simple: &quot;pirq&quot; is&n; * just a pointer to the config space.&n; */
DECL|function|pirq_piix_get
r_static
r_int
id|pirq_piix_get
c_func
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pirq
)paren
(brace
id|u8
id|x
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|router
comma
id|pirq
comma
op_amp
id|x
)paren
suffix:semicolon
r_return
(paren
id|x
OL
l_int|16
)paren
ques
c_cond
id|x
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|pirq_piix_set
r_static
r_int
id|pirq_piix_set
c_func
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pirq
comma
r_int
id|irq
)paren
(brace
id|pci_write_config_byte
c_func
(paren
id|router
comma
id|pirq
comma
id|irq
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * The VIA pirq rules are nibble-based, like ALI,&n; * but without the ugly irq number munging.&n; * However, PIRQD is in the upper instead of lower 4 bits.&n; */
DECL|function|pirq_via_get
r_static
r_int
id|pirq_via_get
c_func
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pirq
)paren
(brace
r_return
id|read_config_nybble
c_func
(paren
id|router
comma
l_int|0x55
comma
id|pirq
op_eq
l_int|4
ques
c_cond
l_int|5
suffix:colon
id|pirq
)paren
suffix:semicolon
)brace
DECL|function|pirq_via_set
r_static
r_int
id|pirq_via_set
c_func
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pirq
comma
r_int
id|irq
)paren
(brace
id|write_config_nybble
c_func
(paren
id|router
comma
l_int|0x55
comma
id|pirq
op_eq
l_int|4
ques
c_cond
l_int|5
suffix:colon
id|pirq
comma
id|irq
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * ITE 8330G pirq rules are nibble-based&n; * FIXME: pirqmap may be { 1, 0, 3, 2 },&n; * &t;  2+3 are both mapped to irq 9 on my system&n; */
DECL|function|pirq_ite_get
r_static
r_int
id|pirq_ite_get
c_func
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pirq
)paren
(brace
r_static
r_int
r_char
id|pirqmap
(braket
l_int|4
)braket
op_assign
(brace
l_int|1
comma
l_int|0
comma
l_int|2
comma
l_int|3
)brace
suffix:semicolon
r_return
id|read_config_nybble
c_func
(paren
id|router
comma
l_int|0x43
comma
id|pirqmap
(braket
id|pirq
op_minus
l_int|1
)braket
)paren
suffix:semicolon
)brace
DECL|function|pirq_ite_set
r_static
r_int
id|pirq_ite_set
c_func
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pirq
comma
r_int
id|irq
)paren
(brace
r_static
r_int
r_char
id|pirqmap
(braket
l_int|4
)braket
op_assign
(brace
l_int|1
comma
l_int|0
comma
l_int|2
comma
l_int|3
)brace
suffix:semicolon
id|write_config_nybble
c_func
(paren
id|router
comma
l_int|0x43
comma
id|pirqmap
(braket
id|pirq
op_minus
l_int|1
)braket
comma
id|irq
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * OPTI: high four bits are nibble pointer..&n; * I wonder what the low bits do?&n; */
DECL|function|pirq_opti_get
r_static
r_int
id|pirq_opti_get
c_func
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pirq
)paren
(brace
r_return
id|read_config_nybble
c_func
(paren
id|router
comma
l_int|0xb8
comma
id|pirq
op_rshift
l_int|4
)paren
suffix:semicolon
)brace
DECL|function|pirq_opti_set
r_static
r_int
id|pirq_opti_set
c_func
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pirq
comma
r_int
id|irq
)paren
(brace
id|write_config_nybble
c_func
(paren
id|router
comma
l_int|0xb8
comma
id|pirq
op_rshift
l_int|4
comma
id|irq
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Cyrix: nibble offset 0x5C&n; * 0x5C bits 7:4 is INTB bits 3:0 is INTA &n; * 0x5D bits 7:4 is INTD bits 3:0 is INTC&n; */
DECL|function|pirq_cyrix_get
r_static
r_int
id|pirq_cyrix_get
c_func
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pirq
)paren
(brace
r_return
id|read_config_nybble
c_func
(paren
id|router
comma
l_int|0x5C
comma
(paren
id|pirq
op_minus
l_int|1
)paren
op_xor
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|pirq_cyrix_set
r_static
r_int
id|pirq_cyrix_set
c_func
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pirq
comma
r_int
id|irq
)paren
(brace
id|write_config_nybble
c_func
(paren
id|router
comma
l_int|0x5C
comma
(paren
id|pirq
op_minus
l_int|1
)paren
op_xor
l_int|1
comma
id|irq
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;PIRQ routing for SiS 85C503 router used in several SiS chipsets.&n; *&t;We have to deal with the following issues here:&n; *&t;- vendors have different ideas about the meaning of link values&n; *&t;- some onboard devices (integrated in the chipset) have special&n; *&t;  links and are thus routed differently (i.e. not via PCI INTA-INTD)&n; *&t;- different revision of the router have a different layout for&n; *&t;  the routing registers, particularly for the onchip devices&n; *&n; *&t;For all routing registers the common thing is we have one byte&n; *&t;per routeable link which is defined as:&n; *&t;&t; bit 7      IRQ mapping enabled (0) or disabled (1)&n; *&t;&t; bits [6:4] reserved (sometimes used for onchip devices)&n; *&t;&t; bits [3:0] IRQ to map to&n; *&t;&t;     allowed: 3-7, 9-12, 14-15&n; *&t;&t;     reserved: 0, 1, 2, 8, 13&n; *&n; *&t;The config-space registers located at 0x41/0x42/0x43/0x44 are&n; *&t;always used to route the normal PCI INT A/B/C/D respectively.&n; *&t;Apparently there are systems implementing PCI routing table using&n; *&t;link values 0x01-0x04 and others using 0x41-0x44 for PCI INTA..D.&n; *&t;We try our best to handle both link mappings.&n; *&t;&n; *&t;Currently (2003-05-21) it appears most SiS chipsets follow the&n; *&t;definition of routing registers from the SiS-5595 southbridge.&n; *&t;According to the SiS 5595 datasheets the revision id&squot;s of the&n; *&t;router (ISA-bridge) should be 0x01 or 0xb0.&n; *&n; *&t;Furthermore we&squot;ve also seen lspci dumps with revision 0x00 and 0xb1.&n; *&t;Looks like these are used in a number of SiS 5xx/6xx/7xx chipsets.&n; *&t;They seem to work with the current routing code. However there is&n; *&t;some concern because of the two USB-OHCI HCs (original SiS 5595&n; *&t;had only one). YMMV.&n; *&n; *&t;Onchip routing for router rev-id 0x01/0xb0 and probably 0x00/0xb1:&n; *&n; *&t;0x61:&t;IDEIRQ:&n; *&t;&t;bits [6:5] must be written 01&n; *&t;&t;bit 4 channel-select primary (0), secondary (1)&n; *&n; *&t;0x62:&t;USBIRQ:&n; *&t;&t;bit 6 OHCI function disabled (0), enabled (1)&n; *&t;&n; *&t;0x6a:&t;ACPI/SCI IRQ: bits 4-6 reserved&n; *&n; *&t;0x7e:&t;Data Acq. Module IRQ - bits 4-6 reserved&n; *&n; *&t;We support USBIRQ (in addition to INTA-INTD) and keep the&n; *&t;IDE, ACPI and DAQ routing untouched as set by the BIOS.&n; *&n; *&t;Currently the only reported exception is the new SiS 65x chipset&n; *&t;which includes the SiS 69x southbridge. Here we have the 85C503&n; *&t;router revision 0x04 and there are changes in the register layout&n; *&t;mostly related to the different USB HCs with USB 2.0 support.&n; *&n; *&t;Onchip routing for router rev-id 0x04 (try-and-error observation)&n; *&n; *&t;0x60/0x61/0x62/0x63:&t;1xEHCI and 3xOHCI (companion) USB-HCs&n; *&t;&t;&t;&t;bit 6-4 are probably unused, not like 5595&n; */
DECL|macro|PIRQ_SIS_IRQ_MASK
mdefine_line|#define PIRQ_SIS_IRQ_MASK&t;0x0f
DECL|macro|PIRQ_SIS_IRQ_DISABLE
mdefine_line|#define PIRQ_SIS_IRQ_DISABLE&t;0x80
DECL|macro|PIRQ_SIS_USB_ENABLE
mdefine_line|#define PIRQ_SIS_USB_ENABLE&t;0x40
DECL|function|pirq_sis_get
r_static
r_int
id|pirq_sis_get
c_func
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pirq
)paren
(brace
id|u8
id|x
suffix:semicolon
r_int
id|reg
suffix:semicolon
id|reg
op_assign
id|pirq
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_ge
l_int|0x01
op_logical_and
id|reg
op_le
l_int|0x04
)paren
id|reg
op_add_assign
l_int|0x40
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|router
comma
id|reg
comma
op_amp
id|x
)paren
suffix:semicolon
r_return
(paren
id|x
op_amp
id|PIRQ_SIS_IRQ_DISABLE
)paren
ques
c_cond
l_int|0
suffix:colon
(paren
id|x
op_amp
id|PIRQ_SIS_IRQ_MASK
)paren
suffix:semicolon
)brace
DECL|function|pirq_sis_set
r_static
r_int
id|pirq_sis_set
c_func
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pirq
comma
r_int
id|irq
)paren
(brace
id|u8
id|x
suffix:semicolon
r_int
id|reg
suffix:semicolon
id|reg
op_assign
id|pirq
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_ge
l_int|0x01
op_logical_and
id|reg
op_le
l_int|0x04
)paren
id|reg
op_add_assign
l_int|0x40
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|router
comma
id|reg
comma
op_amp
id|x
)paren
suffix:semicolon
id|x
op_and_assign
op_complement
(paren
id|PIRQ_SIS_IRQ_MASK
op_or
id|PIRQ_SIS_IRQ_DISABLE
)paren
suffix:semicolon
id|x
op_or_assign
id|irq
ques
c_cond
id|irq
suffix:colon
id|PIRQ_SIS_IRQ_DISABLE
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|router
comma
id|reg
comma
id|x
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * VLSI: nibble offset 0x74 - educated guess due to routing table and&n; *       config space of VLSI 82C534 PCI-bridge/router (1004:0102)&n; *       Tested on HP OmniBook 800 covering PIRQ 1, 2, 4, 8 for onboard&n; *       devices, PIRQ 3 for non-pci(!) soundchip and (untested) PIRQ 6&n; *       for the busbridge to the docking station.&n; */
DECL|function|pirq_vlsi_get
r_static
r_int
id|pirq_vlsi_get
c_func
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pirq
)paren
(brace
r_if
c_cond
(paren
id|pirq
OG
l_int|8
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;VLSI router pirq escape (%d)&bslash;n&quot;
comma
id|pirq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|read_config_nybble
c_func
(paren
id|router
comma
l_int|0x74
comma
id|pirq
op_minus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|pirq_vlsi_set
r_static
r_int
id|pirq_vlsi_set
c_func
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pirq
comma
r_int
id|irq
)paren
(brace
r_if
c_cond
(paren
id|pirq
OG
l_int|8
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;VLSI router pirq escape (%d)&bslash;n&quot;
comma
id|pirq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|write_config_nybble
c_func
(paren
id|router
comma
l_int|0x74
comma
id|pirq
op_minus
l_int|1
comma
id|irq
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * ServerWorks: PCI interrupts mapped to system IRQ lines through Index&n; * and Redirect I/O registers (0x0c00 and 0x0c01).  The Index register&n; * format is (PCIIRQ## | 0x10), e.g.: PCIIRQ10=0x1a.  The Redirect&n; * register is a straight binary coding of desired PIC IRQ (low nibble).&n; *&n; * The &squot;link&squot; value in the PIRQ table is already in the correct format&n; * for the Index register.  There are some special index values:&n; * 0x00 for ACPI (SCI), 0x01 for USB, 0x02 for IDE0, 0x04 for IDE1,&n; * and 0x03 for SMBus.&n; */
DECL|function|pirq_serverworks_get
r_static
r_int
id|pirq_serverworks_get
c_func
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pirq
)paren
(brace
id|outb_p
c_func
(paren
id|pirq
comma
l_int|0xc00
)paren
suffix:semicolon
r_return
id|inb
c_func
(paren
l_int|0xc01
)paren
op_amp
l_int|0xf
suffix:semicolon
)brace
DECL|function|pirq_serverworks_set
r_static
r_int
id|pirq_serverworks_set
c_func
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pirq
comma
r_int
id|irq
)paren
(brace
id|outb_p
c_func
(paren
id|pirq
comma
l_int|0xc00
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|irq
comma
l_int|0xc01
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Support for AMD756 PCI IRQ Routing&n; * Jhon H. Caicedo &lt;jhcaiced@osso.org.co&gt;&n; * Jun/21/2001 0.2.0 Release, fixed to use &quot;nybble&quot; functions... (jhcaiced)&n; * Jun/19/2001 Alpha Release 0.1.0 (jhcaiced)&n; * The AMD756 pirq rules are nibble-based&n; * offset 0x56 0-3 PIRQA  4-7  PIRQB&n; * offset 0x57 0-3 PIRQC  4-7  PIRQD&n; */
DECL|function|pirq_amd756_get
r_static
r_int
id|pirq_amd756_get
c_func
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pirq
)paren
(brace
id|u8
id|irq
suffix:semicolon
id|irq
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pirq
op_le
l_int|4
)paren
(brace
id|irq
op_assign
id|read_config_nybble
c_func
(paren
id|router
comma
l_int|0x56
comma
id|pirq
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;AMD756: dev %04x:%04x, router pirq : %d get irq : %2d&bslash;n&quot;
comma
id|dev-&gt;vendor
comma
id|dev-&gt;device
comma
id|pirq
comma
id|irq
)paren
suffix:semicolon
r_return
id|irq
suffix:semicolon
)brace
DECL|function|pirq_amd756_set
r_static
r_int
id|pirq_amd756_set
c_func
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pirq
comma
r_int
id|irq
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;AMD756: dev %04x:%04x, router pirq : %d SET irq : %2d&bslash;n&quot;
comma
id|dev-&gt;vendor
comma
id|dev-&gt;device
comma
id|pirq
comma
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pirq
op_le
l_int|4
)paren
(brace
id|write_config_nybble
c_func
(paren
id|router
comma
l_int|0x56
comma
id|pirq
op_minus
l_int|1
comma
id|irq
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PCI_BIOS
DECL|function|pirq_bios_set
r_static
r_int
id|pirq_bios_set
c_func
(paren
r_struct
id|pci_dev
op_star
id|router
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pirq
comma
r_int
id|irq
)paren
(brace
r_struct
id|pci_dev
op_star
id|bridge
suffix:semicolon
r_int
id|pin
op_assign
id|pci_get_interrupt_pin
c_func
(paren
id|dev
comma
op_amp
id|bridge
)paren
suffix:semicolon
r_return
id|pcibios_set_irq_routing
c_func
(paren
id|bridge
comma
id|pin
comma
id|irq
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|intel_router_probe
r_static
id|__init
r_int
id|intel_router_probe
c_func
(paren
r_struct
id|irq_router
op_star
id|r
comma
r_struct
id|pci_dev
op_star
id|router
comma
id|u16
id|device
)paren
(brace
r_static
r_struct
id|pci_device_id
id|pirq_440gx
(braket
)braket
op_assign
(brace
(brace
id|PCI_DEVICE
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82443GX_0
)paren
)brace
comma
(brace
id|PCI_DEVICE
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82443GX_2
)paren
)brace
comma
(brace
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* 440GX has a proprietary PIRQ router -- don&squot;t use it */
r_if
c_cond
(paren
id|pci_dev_present
c_func
(paren
id|pirq_440gx
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|device
)paren
(brace
r_case
id|PCI_DEVICE_ID_INTEL_82371FB_0
suffix:colon
r_case
id|PCI_DEVICE_ID_INTEL_82371SB_0
suffix:colon
r_case
id|PCI_DEVICE_ID_INTEL_82371AB_0
suffix:colon
r_case
id|PCI_DEVICE_ID_INTEL_82371MX
suffix:colon
r_case
id|PCI_DEVICE_ID_INTEL_82443MX_0
suffix:colon
r_case
id|PCI_DEVICE_ID_INTEL_82801AA_0
suffix:colon
r_case
id|PCI_DEVICE_ID_INTEL_82801AB_0
suffix:colon
r_case
id|PCI_DEVICE_ID_INTEL_82801BA_0
suffix:colon
r_case
id|PCI_DEVICE_ID_INTEL_82801BA_10
suffix:colon
r_case
id|PCI_DEVICE_ID_INTEL_82801CA_0
suffix:colon
r_case
id|PCI_DEVICE_ID_INTEL_82801CA_12
suffix:colon
r_case
id|PCI_DEVICE_ID_INTEL_82801DB_0
suffix:colon
r_case
id|PCI_DEVICE_ID_INTEL_82801E_0
suffix:colon
r_case
id|PCI_DEVICE_ID_INTEL_82801EB_0
suffix:colon
r_case
id|PCI_DEVICE_ID_INTEL_ESB_1
suffix:colon
r_case
id|PCI_DEVICE_ID_INTEL_ICH6_0
suffix:colon
r_case
id|PCI_DEVICE_ID_INTEL_ICH6_1
suffix:colon
id|r-&gt;name
op_assign
l_string|&quot;PIIX/ICH&quot;
suffix:semicolon
id|r-&gt;get
op_assign
id|pirq_piix_get
suffix:semicolon
id|r-&gt;set
op_assign
id|pirq_piix_set
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|via_router_probe
r_static
id|__init
r_int
id|via_router_probe
c_func
(paren
r_struct
id|irq_router
op_star
id|r
comma
r_struct
id|pci_dev
op_star
id|router
comma
id|u16
id|device
)paren
(brace
multiline_comment|/* FIXME: We should move some of the quirk fixup stuff here */
r_switch
c_cond
(paren
id|device
)paren
(brace
r_case
id|PCI_DEVICE_ID_VIA_82C586_0
suffix:colon
r_case
id|PCI_DEVICE_ID_VIA_82C596
suffix:colon
r_case
id|PCI_DEVICE_ID_VIA_82C686
suffix:colon
r_case
id|PCI_DEVICE_ID_VIA_8231
suffix:colon
multiline_comment|/* FIXME: add new ones for 8233/5 */
id|r-&gt;name
op_assign
l_string|&quot;VIA&quot;
suffix:semicolon
id|r-&gt;get
op_assign
id|pirq_via_get
suffix:semicolon
id|r-&gt;set
op_assign
id|pirq_via_set
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vlsi_router_probe
r_static
id|__init
r_int
id|vlsi_router_probe
c_func
(paren
r_struct
id|irq_router
op_star
id|r
comma
r_struct
id|pci_dev
op_star
id|router
comma
id|u16
id|device
)paren
(brace
r_switch
c_cond
(paren
id|device
)paren
(brace
r_case
id|PCI_DEVICE_ID_VLSI_82C534
suffix:colon
id|r-&gt;name
op_assign
l_string|&quot;VLSI 82C534&quot;
suffix:semicolon
id|r-&gt;get
op_assign
id|pirq_vlsi_get
suffix:semicolon
id|r-&gt;set
op_assign
id|pirq_vlsi_set
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|serverworks_router_probe
r_static
id|__init
r_int
id|serverworks_router_probe
c_func
(paren
r_struct
id|irq_router
op_star
id|r
comma
r_struct
id|pci_dev
op_star
id|router
comma
id|u16
id|device
)paren
(brace
r_switch
c_cond
(paren
id|device
)paren
(brace
r_case
id|PCI_DEVICE_ID_SERVERWORKS_OSB4
suffix:colon
r_case
id|PCI_DEVICE_ID_SERVERWORKS_CSB5
suffix:colon
id|r-&gt;name
op_assign
l_string|&quot;ServerWorks&quot;
suffix:semicolon
id|r-&gt;get
op_assign
id|pirq_serverworks_get
suffix:semicolon
id|r-&gt;set
op_assign
id|pirq_serverworks_set
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sis_router_probe
r_static
id|__init
r_int
id|sis_router_probe
c_func
(paren
r_struct
id|irq_router
op_star
id|r
comma
r_struct
id|pci_dev
op_star
id|router
comma
id|u16
id|device
)paren
(brace
r_if
c_cond
(paren
id|device
op_ne
id|PCI_DEVICE_ID_SI_503
)paren
r_return
l_int|0
suffix:semicolon
id|r-&gt;name
op_assign
l_string|&quot;SIS&quot;
suffix:semicolon
id|r-&gt;get
op_assign
id|pirq_sis_get
suffix:semicolon
id|r-&gt;set
op_assign
id|pirq_sis_set
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|cyrix_router_probe
r_static
id|__init
r_int
id|cyrix_router_probe
c_func
(paren
r_struct
id|irq_router
op_star
id|r
comma
r_struct
id|pci_dev
op_star
id|router
comma
id|u16
id|device
)paren
(brace
r_switch
c_cond
(paren
id|device
)paren
(brace
r_case
id|PCI_DEVICE_ID_CYRIX_5520
suffix:colon
id|r-&gt;name
op_assign
l_string|&quot;NatSemi&quot;
suffix:semicolon
id|r-&gt;get
op_assign
id|pirq_cyrix_get
suffix:semicolon
id|r-&gt;set
op_assign
id|pirq_cyrix_set
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|opti_router_probe
r_static
id|__init
r_int
id|opti_router_probe
c_func
(paren
r_struct
id|irq_router
op_star
id|r
comma
r_struct
id|pci_dev
op_star
id|router
comma
id|u16
id|device
)paren
(brace
r_switch
c_cond
(paren
id|device
)paren
(brace
r_case
id|PCI_DEVICE_ID_OPTI_82C700
suffix:colon
id|r-&gt;name
op_assign
l_string|&quot;OPTI&quot;
suffix:semicolon
id|r-&gt;get
op_assign
id|pirq_opti_get
suffix:semicolon
id|r-&gt;set
op_assign
id|pirq_opti_set
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ite_router_probe
r_static
id|__init
r_int
id|ite_router_probe
c_func
(paren
r_struct
id|irq_router
op_star
id|r
comma
r_struct
id|pci_dev
op_star
id|router
comma
id|u16
id|device
)paren
(brace
r_switch
c_cond
(paren
id|device
)paren
(brace
r_case
id|PCI_DEVICE_ID_ITE_IT8330G_0
suffix:colon
id|r-&gt;name
op_assign
l_string|&quot;ITE&quot;
suffix:semicolon
id|r-&gt;get
op_assign
id|pirq_ite_get
suffix:semicolon
id|r-&gt;set
op_assign
id|pirq_ite_set
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ali_router_probe
r_static
id|__init
r_int
id|ali_router_probe
c_func
(paren
r_struct
id|irq_router
op_star
id|r
comma
r_struct
id|pci_dev
op_star
id|router
comma
id|u16
id|device
)paren
(brace
r_switch
c_cond
(paren
id|device
)paren
(brace
r_case
id|PCI_DEVICE_ID_AL_M1533
suffix:colon
r_case
id|PCI_DEVICE_ID_AL_M1563
suffix:colon
id|printk
c_func
(paren
l_string|&quot;PCI: Using ALI IRQ Router&bslash;n&quot;
)paren
suffix:semicolon
id|r-&gt;name
op_assign
l_string|&quot;ALI&quot;
suffix:semicolon
id|r-&gt;get
op_assign
id|pirq_ali_get
suffix:semicolon
id|r-&gt;set
op_assign
id|pirq_ali_set
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|amd_router_probe
r_static
id|__init
r_int
id|amd_router_probe
c_func
(paren
r_struct
id|irq_router
op_star
id|r
comma
r_struct
id|pci_dev
op_star
id|router
comma
id|u16
id|device
)paren
(brace
r_switch
c_cond
(paren
id|device
)paren
(brace
r_case
id|PCI_DEVICE_ID_AMD_VIPER_740B
suffix:colon
id|r-&gt;name
op_assign
l_string|&quot;AMD756&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_AMD_VIPER_7413
suffix:colon
id|r-&gt;name
op_assign
l_string|&quot;AMD766&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_AMD_VIPER_7443
suffix:colon
id|r-&gt;name
op_assign
l_string|&quot;AMD768&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
id|r-&gt;get
op_assign
id|pirq_amd756_get
suffix:semicolon
id|r-&gt;set
op_assign
id|pirq_amd756_set
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|variable|pirq_routers
r_static
id|__initdata
r_struct
id|irq_router_handler
id|pirq_routers
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_INTEL
comma
id|intel_router_probe
)brace
comma
(brace
id|PCI_VENDOR_ID_AL
comma
id|ali_router_probe
)brace
comma
(brace
id|PCI_VENDOR_ID_ITE
comma
id|ite_router_probe
)brace
comma
(brace
id|PCI_VENDOR_ID_VIA
comma
id|via_router_probe
)brace
comma
(brace
id|PCI_VENDOR_ID_OPTI
comma
id|opti_router_probe
)brace
comma
(brace
id|PCI_VENDOR_ID_SI
comma
id|sis_router_probe
)brace
comma
(brace
id|PCI_VENDOR_ID_CYRIX
comma
id|cyrix_router_probe
)brace
comma
(brace
id|PCI_VENDOR_ID_VLSI
comma
id|vlsi_router_probe
)brace
comma
(brace
id|PCI_VENDOR_ID_SERVERWORKS
comma
id|serverworks_router_probe
)brace
comma
(brace
id|PCI_VENDOR_ID_AMD
comma
id|amd_router_probe
)brace
comma
multiline_comment|/* Someone with docs needs to add the ATI Radeon IGP */
(brace
l_int|0
comma
l_int|NULL
)brace
)brace
suffix:semicolon
DECL|variable|pirq_router
r_static
r_struct
id|irq_router
id|pirq_router
suffix:semicolon
DECL|variable|pirq_router_dev
r_static
r_struct
id|pci_dev
op_star
id|pirq_router_dev
suffix:semicolon
multiline_comment|/*&n; *&t;FIXME: should we have an option to say &quot;generic for&n; *&t;chipset&quot; ?&n; */
DECL|function|pirq_find_router
r_static
r_void
id|__init
id|pirq_find_router
c_func
(paren
r_struct
id|irq_router
op_star
id|r
)paren
(brace
r_struct
id|irq_routing_table
op_star
id|rt
op_assign
id|pirq_table
suffix:semicolon
r_struct
id|irq_router_handler
op_star
id|h
suffix:semicolon
macro_line|#ifdef CONFIG_PCI_BIOS
r_if
c_cond
(paren
op_logical_neg
id|rt-&gt;signature
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PCI: Using BIOS for IRQ routing&bslash;n&quot;
)paren
suffix:semicolon
id|r-&gt;set
op_assign
id|pirq_bios_set
suffix:semicolon
id|r-&gt;name
op_assign
l_string|&quot;BIOS&quot;
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Default unless a driver reloads it */
id|r-&gt;name
op_assign
l_string|&quot;default&quot;
suffix:semicolon
id|r-&gt;get
op_assign
l_int|NULL
suffix:semicolon
id|r-&gt;set
op_assign
l_int|NULL
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;PCI: Attempting to find IRQ router for %04x:%04x&bslash;n&quot;
comma
id|rt-&gt;rtr_vendor
comma
id|rt-&gt;rtr_device
)paren
suffix:semicolon
id|pirq_router_dev
op_assign
id|pci_find_slot
c_func
(paren
id|rt-&gt;rtr_bus
comma
id|rt-&gt;rtr_devfn
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pirq_router_dev
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;PCI: Interrupt router not found at %02x:%02x&bslash;n&quot;
comma
id|rt-&gt;rtr_bus
comma
id|rt-&gt;rtr_devfn
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|h
op_assign
id|pirq_routers
suffix:semicolon
id|h-&gt;vendor
suffix:semicolon
id|h
op_increment
)paren
(brace
multiline_comment|/* First look for a router match */
r_if
c_cond
(paren
id|rt-&gt;rtr_vendor
op_eq
id|h-&gt;vendor
op_logical_and
id|h
op_member_access_from_pointer
id|probe
c_func
(paren
id|r
comma
id|pirq_router_dev
comma
id|rt-&gt;rtr_device
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* Fall back to a device match */
r_if
c_cond
(paren
id|pirq_router_dev-&gt;vendor
op_eq
id|h-&gt;vendor
op_logical_and
id|h
op_member_access_from_pointer
id|probe
c_func
(paren
id|r
comma
id|pirq_router_dev
comma
id|pirq_router_dev-&gt;device
)paren
)paren
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PCI: Using IRQ router %s [%04x/%04x] at %s&bslash;n&quot;
comma
id|pirq_router.name
comma
id|pirq_router_dev-&gt;vendor
comma
id|pirq_router_dev-&gt;device
comma
id|pci_name
c_func
(paren
id|pirq_router_dev
)paren
)paren
suffix:semicolon
)brace
DECL|function|pirq_get_info
r_static
r_struct
id|irq_info
op_star
id|pirq_get_info
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_struct
id|irq_routing_table
op_star
id|rt
op_assign
id|pirq_table
suffix:semicolon
r_int
id|entries
op_assign
(paren
id|rt-&gt;size
op_minus
r_sizeof
(paren
r_struct
id|irq_routing_table
)paren
)paren
op_div
r_sizeof
(paren
r_struct
id|irq_info
)paren
suffix:semicolon
r_struct
id|irq_info
op_star
id|info
suffix:semicolon
r_for
c_loop
(paren
id|info
op_assign
id|rt-&gt;slots
suffix:semicolon
id|entries
op_decrement
suffix:semicolon
id|info
op_increment
)paren
r_if
c_cond
(paren
id|info-&gt;bus
op_eq
id|dev-&gt;bus-&gt;number
op_logical_and
id|PCI_SLOT
c_func
(paren
id|info-&gt;devfn
)paren
op_eq
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
)paren
r_return
id|info
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|pcibios_lookup_irq
r_static
r_int
id|pcibios_lookup_irq
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|assign
)paren
(brace
id|u8
id|pin
suffix:semicolon
r_struct
id|irq_info
op_star
id|info
suffix:semicolon
r_int
id|i
comma
id|pirq
comma
id|newirq
suffix:semicolon
r_int
id|irq
op_assign
l_int|0
suffix:semicolon
id|u32
id|mask
suffix:semicolon
r_struct
id|irq_router
op_star
id|r
op_assign
op_amp
id|pirq_router
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev2
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|msg
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Find IRQ pin */
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|PCI_INTERRUPT_PIN
comma
op_amp
id|pin
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pin
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot; -&gt; no interrupt pin&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|pin
op_assign
id|pin
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Find IRQ routing entry */
r_if
c_cond
(paren
op_logical_neg
id|pirq_table
)paren
r_return
l_int|0
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;IRQ for %s:%d&quot;
comma
id|pci_name
c_func
(paren
id|dev
)paren
comma
id|pin
)paren
suffix:semicolon
id|info
op_assign
id|pirq_get_info
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot; -&gt; not found in routing table&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|pirq
op_assign
id|info-&gt;irq
(braket
id|pin
)braket
dot
id|link
suffix:semicolon
id|mask
op_assign
id|info-&gt;irq
(braket
id|pin
)braket
dot
id|bitmap
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pirq
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot; -&gt; not routed&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|DBG
c_func
(paren
l_string|&quot; -&gt; PIRQ %02x, mask %04x, excl %04x&quot;
comma
id|pirq
comma
id|mask
comma
id|pirq_table-&gt;exclusive_irqs
)paren
suffix:semicolon
id|mask
op_and_assign
id|pcibios_irq_mask
suffix:semicolon
multiline_comment|/* Work around broken HP Pavilion Notebooks which assign USB to&n;&t;   IRQ 9 even though it is actually wired to IRQ 11 */
r_if
c_cond
(paren
id|broken_hp_bios_irq9
op_logical_and
id|pirq
op_eq
l_int|0x59
op_logical_and
id|dev-&gt;irq
op_eq
l_int|9
)paren
(brace
id|dev-&gt;irq
op_assign
l_int|11
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|PCI_INTERRUPT_LINE
comma
l_int|11
)paren
suffix:semicolon
id|r
op_member_access_from_pointer
id|set
c_func
(paren
id|pirq_router_dev
comma
id|dev
comma
id|pirq
comma
l_int|11
)paren
suffix:semicolon
)brace
multiline_comment|/* same for Acer Travelmate 360, but with CB and irq 11 -&gt; 10 */
r_if
c_cond
(paren
id|acer_tm360_irqrouting
op_logical_and
id|dev-&gt;irq
op_eq
l_int|11
op_logical_and
id|dev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_O2
)paren
(brace
id|pirq
op_assign
l_int|0x68
suffix:semicolon
id|mask
op_assign
l_int|0x400
suffix:semicolon
id|dev-&gt;irq
op_assign
id|r
op_member_access_from_pointer
id|get
c_func
(paren
id|pirq_router_dev
comma
id|dev
comma
id|pirq
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|PCI_INTERRUPT_LINE
comma
id|dev-&gt;irq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Find the best IRQ to assign: use the one&n;&t; * reported by the device if possible.&n;&t; */
id|newirq
op_assign
id|dev-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
l_int|1
op_lshift
id|newirq
)paren
op_amp
id|mask
)paren
)paren
(brace
r_if
c_cond
(paren
id|pci_probe
op_amp
id|PCI_USE_PIRQ_MASK
)paren
id|newirq
op_assign
l_int|0
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PCI: IRQ %i for device %s doesn&squot;t match PIRQ mask - try pci=usepirqmask&bslash;n&quot;
comma
id|newirq
comma
id|pci_name
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|newirq
op_logical_and
id|assign
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|mask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|pirq_penalty
(braket
id|i
)braket
OL
id|pirq_penalty
(braket
id|newirq
)braket
op_logical_and
id|can_request_irq
c_func
(paren
id|i
comma
id|SA_SHIRQ
)paren
)paren
id|newirq
op_assign
id|i
suffix:semicolon
)brace
)brace
id|DBG
c_func
(paren
l_string|&quot; -&gt; newirq=%d&quot;
comma
id|newirq
)paren
suffix:semicolon
multiline_comment|/* Check if it is hardcoded */
r_if
c_cond
(paren
(paren
id|pirq
op_amp
l_int|0xf0
)paren
op_eq
l_int|0xf0
)paren
(brace
id|irq
op_assign
id|pirq
op_amp
l_int|0xf
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot; -&gt; hardcoded IRQ %d&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
id|msg
op_assign
l_string|&quot;Hardcoded&quot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|r-&gt;get
op_logical_and
(paren
id|irq
op_assign
id|r
op_member_access_from_pointer
id|get
c_func
(paren
id|pirq_router_dev
comma
id|dev
comma
id|pirq
)paren
)paren
op_logical_and
"&bslash;"
(paren
(paren
op_logical_neg
(paren
id|pci_probe
op_amp
id|PCI_USE_PIRQ_MASK
)paren
)paren
op_logical_or
(paren
(paren
l_int|1
op_lshift
id|irq
)paren
op_amp
id|mask
)paren
)paren
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot; -&gt; got IRQ %d&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
id|msg
op_assign
l_string|&quot;Found&quot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|newirq
op_logical_and
id|r-&gt;set
op_logical_and
(paren
id|dev
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_ne
id|PCI_CLASS_DISPLAY_VGA
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot; -&gt; assigning IRQ %d&quot;
comma
id|newirq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
op_member_access_from_pointer
id|set
c_func
(paren
id|pirq_router_dev
comma
id|dev
comma
id|pirq
comma
id|newirq
)paren
)paren
(brace
id|eisa_set_level_irq
c_func
(paren
id|newirq
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot; ... OK&bslash;n&quot;
)paren
suffix:semicolon
id|msg
op_assign
l_string|&quot;Assigned&quot;
suffix:semicolon
id|irq
op_assign
id|newirq
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|irq
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot; ... failed&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|newirq
op_logical_and
id|mask
op_eq
(paren
l_int|1
op_lshift
id|newirq
)paren
)paren
(brace
id|msg
op_assign
l_string|&quot;Guessed&quot;
suffix:semicolon
id|irq
op_assign
id|newirq
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PCI: %s IRQ %d for device %s&bslash;n&quot;
comma
id|msg
comma
id|irq
comma
id|pci_name
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
multiline_comment|/* Update IRQ for all devices with the same pirq value */
r_while
c_loop
(paren
(paren
id|dev2
op_assign
id|pci_get_device
c_func
(paren
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|dev2
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|pci_read_config_byte
c_func
(paren
id|dev2
comma
id|PCI_INTERRUPT_PIN
comma
op_amp
id|pin
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pin
)paren
r_continue
suffix:semicolon
id|pin
op_decrement
suffix:semicolon
id|info
op_assign
id|pirq_get_info
c_func
(paren
id|dev2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;irq
(braket
id|pin
)braket
dot
id|link
op_eq
id|pirq
)paren
(brace
multiline_comment|/* We refuse to override the dev-&gt;irq information. Give a warning! */
r_if
c_cond
(paren
id|dev2-&gt;irq
op_logical_and
id|dev2-&gt;irq
op_ne
id|irq
op_logical_and
"&bslash;"
(paren
op_logical_neg
(paren
id|pci_probe
op_amp
id|PCI_USE_PIRQ_MASK
)paren
op_logical_or
"&bslash;"
(paren
(paren
l_int|1
op_lshift
id|dev2-&gt;irq
)paren
op_amp
id|mask
)paren
)paren
)paren
(brace
macro_line|#ifndef CONFIG_PCI_MSI
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;IRQ routing conflict for %s, have irq %d, want irq %d&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|dev2
)paren
comma
id|dev2-&gt;irq
comma
id|irq
)paren
suffix:semicolon
macro_line|#endif
r_continue
suffix:semicolon
)brace
id|dev2-&gt;irq
op_assign
id|irq
suffix:semicolon
id|pirq_penalty
(braket
id|irq
)braket
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ne
id|dev2
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PCI: Sharing IRQ %d with %s&bslash;n&quot;
comma
id|irq
comma
id|pci_name
c_func
(paren
id|dev2
)paren
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|pcibios_fixup_irqs
r_static
r_void
id|__init
id|pcibios_fixup_irqs
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
id|u8
id|pin
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;PCI: IRQ fixup&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|dev
op_assign
id|pci_get_device
c_func
(paren
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|dev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/*&n;&t;&t; * If the BIOS has set an out of range IRQ number, just ignore it.&n;&t;&t; * Also keep track of which IRQ&squot;s are already in use.&n;&t;&t; */
r_if
c_cond
(paren
id|dev-&gt;irq
op_ge
l_int|16
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;%s: ignoring bogus IRQ %d&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|dev
)paren
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* If the IRQ is already assigned to a PCI device, ignore its ISA use penalty */
r_if
c_cond
(paren
id|pirq_penalty
(braket
id|dev-&gt;irq
)braket
op_ge
l_int|100
op_logical_and
id|pirq_penalty
(braket
id|dev-&gt;irq
)braket
OL
l_int|100000
)paren
id|pirq_penalty
(braket
id|dev-&gt;irq
)braket
op_assign
l_int|0
suffix:semicolon
id|pirq_penalty
(braket
id|dev-&gt;irq
)braket
op_increment
suffix:semicolon
)brace
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
(paren
id|dev
op_assign
id|pci_get_device
c_func
(paren
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|dev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|PCI_INTERRUPT_PIN
comma
op_amp
id|pin
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_X86_IO_APIC
multiline_comment|/*&n;&t;&t; * Recalculate IRQ numbers if we use the I/O APIC.&n;&t;&t; */
r_if
c_cond
(paren
id|io_apic_assign_pci_irqs
)paren
(brace
r_int
id|irq
suffix:semicolon
r_if
c_cond
(paren
id|pin
)paren
(brace
id|pin
op_decrement
suffix:semicolon
multiline_comment|/* interrupt pins are numbered starting from 1 */
id|irq
op_assign
id|IO_APIC_get_PCI_irq_vector
c_func
(paren
id|dev-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
comma
id|pin
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Busses behind bridges are typically not listed in the MP-table.&n;&t; * In this case we have to look up the IRQ based on the parent bus,&n;&t; * parent slot, and pin number. The SMP code detects such bridged&n;&t; * busses itself so we should get into this branch reliably.&n;&t; */
r_if
c_cond
(paren
id|irq
OL
l_int|0
op_logical_and
id|dev-&gt;bus-&gt;parent
)paren
(brace
multiline_comment|/* go back to the bridge */
r_struct
id|pci_dev
op_star
id|bridge
op_assign
id|dev-&gt;bus-&gt;self
suffix:semicolon
id|pin
op_assign
(paren
id|pin
op_plus
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
)paren
op_mod
l_int|4
suffix:semicolon
id|irq
op_assign
id|IO_APIC_get_PCI_irq_vector
c_func
(paren
id|bridge-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|bridge-&gt;devfn
)paren
comma
id|pin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_ge
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PCI: using PPB(B%d,I%d,P%d) to get irq %d&bslash;n&quot;
comma
id|bridge-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|bridge-&gt;devfn
)paren
comma
id|pin
comma
id|irq
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irq
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|use_pci_vector
c_func
(paren
)paren
op_logical_and
op_logical_neg
id|platform_legacy_irq
c_func
(paren
id|irq
)paren
)paren
id|irq
op_assign
id|IO_APIC_VECTOR
c_func
(paren
id|irq
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PCI-&gt;APIC IRQ transform: (B%d,I%d,P%d) -&gt; %d&bslash;n&quot;
comma
id|dev-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
comma
id|pin
comma
id|irq
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
multiline_comment|/*&n;&t;&t; * Still no IRQ? Try to lookup one...&n;&t;&t; */
r_if
c_cond
(paren
id|pin
op_logical_and
op_logical_neg
id|dev-&gt;irq
)paren
id|pcibios_lookup_irq
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Work around broken HP Pavilion Notebooks which assign USB to&n; * IRQ 9 even though it is actually wired to IRQ 11&n; */
DECL|function|fix_broken_hp_bios_irq9
r_static
r_int
id|__init
id|fix_broken_hp_bios_irq9
c_func
(paren
r_struct
id|dmi_system_id
op_star
id|d
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|broken_hp_bios_irq9
)paren
(brace
id|broken_hp_bios_irq9
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s detected - fixing broken IRQ routing&bslash;n&quot;
comma
id|d-&gt;ident
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Work around broken Acer TravelMate 360 Notebooks which assign&n; * Cardbus to IRQ 11 even though it is actually wired to IRQ 10&n; */
DECL|function|fix_acer_tm360_irqrouting
r_static
r_int
id|__init
id|fix_acer_tm360_irqrouting
c_func
(paren
r_struct
id|dmi_system_id
op_star
id|d
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|acer_tm360_irqrouting
)paren
(brace
id|acer_tm360_irqrouting
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s detected - fixing broken IRQ routing&bslash;n&quot;
comma
id|d-&gt;ident
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|pciirq_dmi_table
r_static
r_struct
id|dmi_system_id
id|__initdata
id|pciirq_dmi_table
(braket
)braket
op_assign
(brace
(brace
dot
id|callback
op_assign
id|fix_broken_hp_bios_irq9
comma
dot
id|ident
op_assign
l_string|&quot;HP Pavilion N5400 Series Laptop&quot;
comma
dot
id|matches
op_assign
(brace
id|DMI_MATCH
c_func
(paren
id|DMI_SYS_VENDOR
comma
l_string|&quot;Hewlett-Packard&quot;
)paren
comma
id|DMI_MATCH
c_func
(paren
id|DMI_BIOS_VERSION
comma
l_string|&quot;GE.M1.03&quot;
)paren
comma
id|DMI_MATCH
c_func
(paren
id|DMI_PRODUCT_VERSION
comma
l_string|&quot;HP Pavilion Notebook Model GE&quot;
)paren
comma
id|DMI_MATCH
c_func
(paren
id|DMI_BOARD_VERSION
comma
l_string|&quot;OmniBook N32N-736&quot;
)paren
comma
)brace
comma
)brace
comma
(brace
dot
id|callback
op_assign
id|fix_acer_tm360_irqrouting
comma
dot
id|ident
op_assign
l_string|&quot;Acer TravelMate 36x Laptop&quot;
comma
dot
id|matches
op_assign
(brace
id|DMI_MATCH
c_func
(paren
id|DMI_SYS_VENDOR
comma
l_string|&quot;Acer&quot;
)paren
comma
id|DMI_MATCH
c_func
(paren
id|DMI_PRODUCT_NAME
comma
l_string|&quot;TravelMate 360&quot;
)paren
comma
)brace
comma
)brace
comma
(brace
)brace
)brace
suffix:semicolon
DECL|function|pcibios_irq_init
r_static
r_int
id|__init
id|pcibios_irq_init
c_func
(paren
r_void
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;PCI: IRQ init&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcibios_enable_irq
op_logical_or
id|raw_pci_ops
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|dmi_check_system
c_func
(paren
id|pciirq_dmi_table
)paren
suffix:semicolon
id|pirq_table
op_assign
id|pirq_find_routing_table
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PCI_BIOS
r_if
c_cond
(paren
op_logical_neg
id|pirq_table
op_logical_and
(paren
id|pci_probe
op_amp
id|PCI_BIOS_IRQ_SCAN
)paren
)paren
id|pirq_table
op_assign
id|pcibios_get_irq_routing_table
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pirq_table
)paren
(brace
id|pirq_peer_trick
c_func
(paren
)paren
suffix:semicolon
id|pirq_find_router
c_func
(paren
op_amp
id|pirq_router
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pirq_table-&gt;exclusive_irqs
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|pirq_table-&gt;exclusive_irqs
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
)paren
id|pirq_penalty
(braket
id|i
)braket
op_add_assign
l_int|100
suffix:semicolon
)brace
multiline_comment|/* If we&squot;re using the I/O APIC, avoid using the PCI IRQ routing table */
r_if
c_cond
(paren
id|io_apic_assign_pci_irqs
)paren
id|pirq_table
op_assign
l_int|NULL
suffix:semicolon
)brace
id|pcibios_enable_irq
op_assign
id|pirq_enable_irq
suffix:semicolon
id|pcibios_fixup_irqs
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|pcibios_irq_init
id|subsys_initcall
c_func
(paren
id|pcibios_irq_init
)paren
suffix:semicolon
DECL|function|pirq_penalize_isa_irq
r_static
r_void
id|pirq_penalize_isa_irq
c_func
(paren
r_int
id|irq
)paren
(brace
multiline_comment|/*&n;&t; *  If any ISAPnP device reports an IRQ in its list of possible&n;&t; *  IRQ&squot;s, we try to avoid assigning it to PCI devices.&n;&t; */
r_if
c_cond
(paren
id|irq
OL
l_int|16
)paren
id|pirq_penalty
(braket
id|irq
)braket
op_add_assign
l_int|100
suffix:semicolon
)brace
DECL|function|pcibios_penalize_isa_irq
r_void
id|pcibios_penalize_isa_irq
c_func
(paren
r_int
id|irq
)paren
(brace
macro_line|#ifdef CONFIG_ACPI_PCI
r_if
c_cond
(paren
op_logical_neg
id|acpi_noirq
)paren
id|acpi_penalize_isa_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
r_else
macro_line|#endif
id|pirq_penalize_isa_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|pirq_enable_irq
r_int
id|pirq_enable_irq
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|u8
id|pin
suffix:semicolon
r_extern
r_int
id|interrupt_line_quirk
suffix:semicolon
r_struct
id|pci_dev
op_star
id|temp_dev
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|PCI_INTERRUPT_PIN
comma
op_amp
id|pin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pin
op_logical_and
op_logical_neg
id|pcibios_lookup_irq
c_func
(paren
id|dev
comma
l_int|1
)paren
op_logical_and
op_logical_neg
id|dev-&gt;irq
)paren
(brace
r_char
op_star
id|msg
suffix:semicolon
id|msg
op_assign
l_string|&quot;&quot;
suffix:semicolon
r_if
c_cond
(paren
id|io_apic_assign_pci_irqs
)paren
(brace
r_int
id|irq
suffix:semicolon
r_if
c_cond
(paren
id|pin
)paren
(brace
id|pin
op_decrement
suffix:semicolon
multiline_comment|/* interrupt pins are numbered starting from 1 */
id|irq
op_assign
id|IO_APIC_get_PCI_irq_vector
c_func
(paren
id|dev-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
comma
id|pin
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Busses behind bridges are typically not listed in the MP-table.&n;&t;&t;&t;&t; * In this case we have to look up the IRQ based on the parent bus,&n;&t;&t;&t;&t; * parent slot, and pin number. The SMP code detects such bridged&n;&t;&t;&t;&t; * busses itself so we should get into this branch reliably.&n;&t;&t;&t;&t; */
id|temp_dev
op_assign
id|dev
suffix:semicolon
r_while
c_loop
(paren
id|irq
OL
l_int|0
op_logical_and
id|dev-&gt;bus-&gt;parent
)paren
(brace
multiline_comment|/* go back to the bridge */
r_struct
id|pci_dev
op_star
id|bridge
op_assign
id|dev-&gt;bus-&gt;self
suffix:semicolon
id|pin
op_assign
(paren
id|pin
op_plus
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
)paren
op_mod
l_int|4
suffix:semicolon
id|irq
op_assign
id|IO_APIC_get_PCI_irq_vector
c_func
(paren
id|bridge-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|bridge-&gt;devfn
)paren
comma
id|pin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_ge
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PCI: using PPB(B%d,I%d,P%d) to get irq %d&bslash;n&quot;
comma
id|bridge-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|bridge-&gt;devfn
)paren
comma
id|pin
comma
id|irq
)paren
suffix:semicolon
id|dev
op_assign
id|bridge
suffix:semicolon
)brace
id|dev
op_assign
id|temp_dev
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_ge
l_int|0
)paren
(brace
macro_line|#ifdef CONFIG_PCI_MSI
r_if
c_cond
(paren
op_logical_neg
id|platform_legacy_irq
c_func
(paren
id|irq
)paren
)paren
id|irq
op_assign
id|IO_APIC_VECTOR
c_func
(paren
id|irq
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PCI-&gt;APIC IRQ transform: (B%d,I%d,P%d) -&gt; %d&bslash;n&quot;
comma
id|dev-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
comma
id|pin
comma
id|irq
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|msg
op_assign
l_string|&quot; Probably buggy MP table.&quot;
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|pci_probe
op_amp
id|PCI_BIOS_IRQ_SCAN
)paren
id|msg
op_assign
l_string|&quot;&quot;
suffix:semicolon
r_else
id|msg
op_assign
l_string|&quot; Please try using pci=biosirq.&quot;
suffix:semicolon
multiline_comment|/* With IDE legacy devices the IRQ lookup failure is not a problem.. */
r_if
c_cond
(paren
id|dev
op_member_access_from_pointer
r_class
op_rshift
l_int|8
op_eq
id|PCI_CLASS_STORAGE_IDE
op_logical_and
op_logical_neg
(paren
id|dev
op_member_access_from_pointer
r_class
op_amp
l_int|0x5
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PCI: No IRQ known for interrupt pin %c of device %s.%s&bslash;n&quot;
comma
l_char|&squot;A&squot;
op_plus
id|pin
op_minus
l_int|1
comma
id|pci_name
c_func
(paren
id|dev
)paren
comma
id|msg
)paren
suffix:semicolon
)brace
multiline_comment|/* VIA bridges use interrupt line for apic/pci steering across&n;&t;   the V-Link */
r_else
r_if
c_cond
(paren
id|interrupt_line_quirk
)paren
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|PCI_INTERRUPT_LINE
comma
id|dev-&gt;irq
op_amp
l_int|15
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pci_vector_resources
r_int
id|pci_vector_resources
c_func
(paren
r_int
id|last
comma
r_int
id|nr_released
)paren
(brace
r_int
id|count
op_assign
id|nr_released
suffix:semicolon
r_int
id|next
op_assign
id|last
suffix:semicolon
r_int
id|offset
op_assign
(paren
id|last
op_mod
l_int|8
)paren
suffix:semicolon
r_while
c_loop
(paren
id|next
OL
id|FIRST_SYSTEM_VECTOR
)paren
(brace
id|next
op_add_assign
l_int|8
suffix:semicolon
macro_line|#ifdef CONFIG_X86_64
r_if
c_cond
(paren
id|next
op_eq
id|IA32_SYSCALL_VECTOR
)paren
r_continue
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|next
op_eq
id|SYSCALL_VECTOR
)paren
r_continue
suffix:semicolon
macro_line|#endif
id|count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|next
op_ge
id|FIRST_SYSTEM_VECTOR
)paren
(brace
r_if
c_cond
(paren
id|offset
op_mod
l_int|8
)paren
(brace
id|next
op_assign
id|FIRST_DEVICE_VECTOR
op_plus
id|offset
suffix:semicolon
id|offset
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|count
op_decrement
suffix:semicolon
)brace
)brace
r_return
id|count
suffix:semicolon
)brace
eof
