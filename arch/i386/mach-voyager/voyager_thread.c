multiline_comment|/* -*- mode: c; c-basic-offset: 8 -*- */
multiline_comment|/* Copyright (C) 2001&n; *&n; * Author: J.E.J.Bottomley@HansenPartnership.com&n; *&n; * linux/arch/i386/kernel/voyager_thread.c&n; *&n; * This module provides the machine status monitor thread for the&n; * voyager architecture.  This allows us to monitor the machine&n; * environment (temp, voltage, fan function) and the front panel and&n; * internal UPS.  If a fault is detected, this thread takes corrective&n; * action (usually just informing init)&n; * */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/kernel_stat.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/mc146818rtc.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;linux/kmod.h&gt;
macro_line|#include &lt;linux/completion.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/desc.h&gt;
macro_line|#include &lt;asm/voyager.h&gt;
macro_line|#include &lt;asm/vic.h&gt;
macro_line|#include &lt;asm/pgalloc.h&gt;
macro_line|#include &lt;asm/mtrr.h&gt;
macro_line|#include &lt;asm/msr.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
DECL|macro|THREAD_NAME
mdefine_line|#define THREAD_NAME &quot;kvoyagerd&quot;
multiline_comment|/* external variables */
DECL|variable|kvoyagerd_running
r_int
id|kvoyagerd_running
op_assign
l_int|0
suffix:semicolon
DECL|variable|kvoyagerd_sem
id|DECLARE_MUTEX_LOCKED
c_func
(paren
id|kvoyagerd_sem
)paren
suffix:semicolon
r_static
r_int
id|thread
c_func
(paren
r_void
op_star
)paren
suffix:semicolon
DECL|variable|set_timeout
r_static
id|__u8
id|set_timeout
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Start the machine monitor thread.  Return 1 if OK, 0 if fail */
r_static
r_int
id|__init
DECL|function|voyager_thread_start
id|voyager_thread_start
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|kernel_thread
c_func
(paren
id|thread
comma
l_int|NULL
comma
id|CLONE_KERNEL
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* This is serious, but not fatal */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Voyager: Failed to create system monitor thread!!!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|execute
id|execute
c_func
(paren
r_const
r_char
op_star
id|string
)paren
(brace
r_int
id|ret
suffix:semicolon
r_char
op_star
id|envp
(braket
)braket
op_assign
(brace
l_string|&quot;HOME=/&quot;
comma
l_string|&quot;TERM=linux&quot;
comma
l_string|&quot;PATH=/sbin:/usr/sbin:/bin:/usr/bin&quot;
comma
l_int|NULL
comma
)brace
suffix:semicolon
r_char
op_star
id|argv
(braket
)braket
op_assign
(brace
l_string|&quot;/bin/bash&quot;
comma
l_string|&quot;-c&quot;
comma
(paren
r_char
op_star
)paren
id|string
comma
l_int|NULL
comma
)brace
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|call_usermodehelper
c_func
(paren
id|argv
(braket
l_int|0
)braket
comma
id|argv
comma
id|envp
comma
l_int|1
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Voyager failed to run &bslash;&quot;%s&bslash;&quot;: %i&bslash;n&quot;
comma
id|string
comma
id|ret
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
r_static
r_void
DECL|function|check_from_kernel
id|check_from_kernel
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|voyager_status.switch_off
)paren
(brace
multiline_comment|/* FIXME: This should be configureable via proc */
id|execute
c_func
(paren
l_string|&quot;umask 600; echo 0 &gt; /etc/initrunlvl; kill -HUP 1&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|voyager_status.power_fail
)paren
(brace
id|VDEBUG
c_func
(paren
(paren
l_string|&quot;Voyager daemon detected AC power failure&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* FIXME: This should be configureable via proc */
id|execute
c_func
(paren
l_string|&quot;umask 600; echo F &gt; /etc/powerstatus; kill -PWR 1&quot;
)paren
suffix:semicolon
id|set_timeout
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|check_continuing_condition
id|check_continuing_condition
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|voyager_status.power_fail
)paren
(brace
id|__u8
id|data
suffix:semicolon
id|voyager_cat_psi
c_func
(paren
id|VOYAGER_PSI_SUBREAD
comma
id|VOYAGER_PSI_AC_FAIL_REG
comma
op_amp
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data
op_amp
l_int|0x1f
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* all power restored */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;VOYAGER AC power restored, cancelling shutdown&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* FIXME: should be user configureable */
id|execute
c_func
(paren
l_string|&quot;umask 600; echo O &gt; /etc/powerstatus; kill -PWR 1&quot;
)paren
suffix:semicolon
id|set_timeout
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_static
r_void
DECL|function|wakeup
id|wakeup
c_func
(paren
r_int
r_int
id|unused
)paren
(brace
id|up
c_func
(paren
op_amp
id|kvoyagerd_sem
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|thread
id|thread
c_func
(paren
r_void
op_star
id|unused
)paren
(brace
r_struct
id|timer_list
id|wakeup_timer
suffix:semicolon
id|kvoyagerd_running
op_assign
l_int|1
suffix:semicolon
id|reparent_to_init
c_func
(paren
)paren
suffix:semicolon
id|daemonize
c_func
(paren
id|THREAD_NAME
)paren
suffix:semicolon
id|set_timeout
op_assign
l_int|0
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|wakeup_timer
)paren
suffix:semicolon
id|sigfillset
c_func
(paren
op_amp
id|current-&gt;blocked
)paren
suffix:semicolon
id|current-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* get rid of controlling tty */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Voyager starting monitor thread&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|down_interruptible
c_func
(paren
op_amp
id|kvoyagerd_sem
)paren
suffix:semicolon
id|VDEBUG
c_func
(paren
(paren
l_string|&quot;Voyager Daemon awoken&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|voyager_status.request_from_kernel
op_eq
l_int|0
)paren
(brace
multiline_comment|/* probably awoken from timeout */
id|check_continuing_condition
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|check_from_kernel
c_func
(paren
)paren
suffix:semicolon
id|voyager_status.request_from_kernel
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|set_timeout
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|wakeup_timer
)paren
suffix:semicolon
id|wakeup_timer.expires
op_assign
id|HZ
op_plus
id|jiffies
suffix:semicolon
id|wakeup_timer.function
op_assign
id|wakeup
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|wakeup_timer
)paren
suffix:semicolon
)brace
)brace
)brace
r_static
r_void
id|__exit
DECL|function|voyager_thread_stop
id|voyager_thread_stop
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* FIXME: do nothing at the moment */
)brace
DECL|variable|voyager_thread_start
id|module_init
c_func
(paren
id|voyager_thread_start
)paren
suffix:semicolon
singleline_comment|//module_exit(voyager_thread_stop);
eof
