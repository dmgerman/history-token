multiline_comment|/* -*- mode: c; c-basic-offset: 8 -*- */
multiline_comment|/* Copyright (C) 1999,2001&n; *&n; * Author: J.E.J.Bottomley@HansenPartnership.com&n; *&n; * linux/arch/i386/kernel/voyager_cat.c&n; *&n; * This file contains all the logic for manipulating the CAT bus&n; * in a level 5 machine.&n; *&n; * The CAT bus is a serial configuration and test bus.  Its primary&n; * uses are to probe the initial configuration of the system and to&n; * diagnose error conditions when a system interrupt occurs.  The low&n; * level interface is fairly primitive, so most of this file consists&n; * of bit shift manipulations to send and receive packets on the&n; * serial bus */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/completion.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/voyager.h&gt;
macro_line|#include &lt;asm/vic.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#ifdef VOYAGER_CAT_DEBUG
DECL|macro|CDEBUG
mdefine_line|#define CDEBUG(x)&t;printk x
macro_line|#else
DECL|macro|CDEBUG
mdefine_line|#define CDEBUG(x)
macro_line|#endif
multiline_comment|/* the CAT command port */
DECL|macro|CAT_CMD
mdefine_line|#define CAT_CMD&t;&t;(sspb + 0xe)
multiline_comment|/* the CAT data port */
DECL|macro|CAT_DATA
mdefine_line|#define CAT_DATA&t;(sspb + 0xd)
multiline_comment|/* the internal cat functions */
r_static
r_void
id|cat_pack
c_func
(paren
id|__u8
op_star
id|msg
comma
id|__u16
id|start_bit
comma
id|__u8
op_star
id|data
comma
id|__u16
id|num_bits
)paren
suffix:semicolon
r_static
r_void
id|cat_unpack
c_func
(paren
id|__u8
op_star
id|msg
comma
id|__u16
id|start_bit
comma
id|__u8
op_star
id|data
comma
id|__u16
id|num_bits
)paren
suffix:semicolon
r_static
r_void
id|cat_build_header
c_func
(paren
id|__u8
op_star
id|header
comma
r_const
id|__u16
id|len
comma
r_const
id|__u16
id|smallest_reg_bits
comma
r_const
id|__u16
id|longest_reg_bits
)paren
suffix:semicolon
r_static
r_int
id|cat_sendinst
c_func
(paren
id|voyager_module_t
op_star
id|modp
comma
id|voyager_asic_t
op_star
id|asicp
comma
id|__u8
id|reg
comma
id|__u8
id|op
)paren
suffix:semicolon
r_static
r_int
id|cat_getdata
c_func
(paren
id|voyager_module_t
op_star
id|modp
comma
id|voyager_asic_t
op_star
id|asicp
comma
id|__u8
id|reg
comma
id|__u8
op_star
id|value
)paren
suffix:semicolon
r_static
r_int
id|cat_shiftout
c_func
(paren
id|__u8
op_star
id|data
comma
id|__u16
id|data_bytes
comma
id|__u16
id|header_bytes
comma
id|__u8
id|pad_bits
)paren
suffix:semicolon
r_static
r_int
id|cat_write
c_func
(paren
id|voyager_module_t
op_star
id|modp
comma
id|voyager_asic_t
op_star
id|asicp
comma
id|__u8
id|reg
comma
id|__u8
id|value
)paren
suffix:semicolon
r_static
r_int
id|cat_read
c_func
(paren
id|voyager_module_t
op_star
id|modp
comma
id|voyager_asic_t
op_star
id|asicp
comma
id|__u8
id|reg
comma
id|__u8
op_star
id|value
)paren
suffix:semicolon
r_static
r_int
id|cat_subread
c_func
(paren
id|voyager_module_t
op_star
id|modp
comma
id|voyager_asic_t
op_star
id|asicp
comma
id|__u16
id|offset
comma
id|__u16
id|len
comma
r_void
op_star
id|buf
)paren
suffix:semicolon
r_static
r_int
id|cat_senddata
c_func
(paren
id|voyager_module_t
op_star
id|modp
comma
id|voyager_asic_t
op_star
id|asicp
comma
id|__u8
id|reg
comma
id|__u8
id|value
)paren
suffix:semicolon
r_static
r_int
id|cat_disconnect
c_func
(paren
id|voyager_module_t
op_star
id|modp
comma
id|voyager_asic_t
op_star
id|asicp
)paren
suffix:semicolon
r_static
r_int
id|cat_connect
c_func
(paren
id|voyager_module_t
op_star
id|modp
comma
id|voyager_asic_t
op_star
id|asicp
)paren
suffix:semicolon
r_static
r_inline
r_const
r_char
op_star
DECL|function|cat_module_name
id|cat_module_name
c_func
(paren
r_int
id|module_id
)paren
(brace
r_switch
c_cond
(paren
id|module_id
)paren
(brace
r_case
l_int|0x10
suffix:colon
r_return
l_string|&quot;Processor Slot 0&quot;
suffix:semicolon
r_case
l_int|0x11
suffix:colon
r_return
l_string|&quot;Processor Slot 1&quot;
suffix:semicolon
r_case
l_int|0x12
suffix:colon
r_return
l_string|&quot;Processor Slot 2&quot;
suffix:semicolon
r_case
l_int|0x13
suffix:colon
r_return
l_string|&quot;Processor Slot 4&quot;
suffix:semicolon
r_case
l_int|0x14
suffix:colon
r_return
l_string|&quot;Memory Slot 0&quot;
suffix:semicolon
r_case
l_int|0x15
suffix:colon
r_return
l_string|&quot;Memory Slot 1&quot;
suffix:semicolon
r_case
l_int|0x18
suffix:colon
r_return
l_string|&quot;Primary Microchannel&quot;
suffix:semicolon
r_case
l_int|0x19
suffix:colon
r_return
l_string|&quot;Secondary Microchannel&quot;
suffix:semicolon
r_case
l_int|0x1a
suffix:colon
r_return
l_string|&quot;Power Supply Interface&quot;
suffix:semicolon
r_case
l_int|0x1c
suffix:colon
r_return
l_string|&quot;Processor Slot 5&quot;
suffix:semicolon
r_case
l_int|0x1d
suffix:colon
r_return
l_string|&quot;Processor Slot 6&quot;
suffix:semicolon
r_case
l_int|0x1e
suffix:colon
r_return
l_string|&quot;Processor Slot 7&quot;
suffix:semicolon
r_case
l_int|0x1f
suffix:colon
r_return
l_string|&quot;Processor Slot 8&quot;
suffix:semicolon
r_default
suffix:colon
r_return
l_string|&quot;Unknown Module&quot;
suffix:semicolon
)brace
)brace
DECL|variable|sspb
r_static
r_int
id|sspb
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* stores the super port location */
DECL|variable|voyager_8slot
r_int
id|voyager_8slot
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set to true if a 51xx monster */
DECL|variable|voyager_cat_list
id|voyager_module_t
op_star
id|voyager_cat_list
suffix:semicolon
multiline_comment|/* the I/O port assignments for the VIC and QIC */
DECL|variable|vic_res
r_static
r_struct
id|resource
id|vic_res
op_assign
(brace
l_string|&quot;Voyager Interrupt Controller&quot;
comma
l_int|0xFC00
comma
l_int|0xFC6F
)brace
suffix:semicolon
DECL|variable|qic_res
r_static
r_struct
id|resource
id|qic_res
op_assign
(brace
l_string|&quot;Quad Interrupt Controller&quot;
comma
l_int|0xFC70
comma
l_int|0xFCFF
)brace
suffix:semicolon
multiline_comment|/* This function is used to pack a data bit stream inside a message.&n; * It writes num_bits of the data buffer in msg starting at start_bit.&n; * Note: This function assumes that any unused bit in the data stream&n; * is set to zero so that the ors will work correctly */
DECL|macro|BITS_PER_BYTE
mdefine_line|#define BITS_PER_BYTE 8
r_static
r_void
DECL|function|cat_pack
id|cat_pack
c_func
(paren
id|__u8
op_star
id|msg
comma
r_const
id|__u16
id|start_bit
comma
id|__u8
op_star
id|data
comma
r_const
id|__u16
id|num_bits
)paren
(brace
multiline_comment|/* compute initial shift needed */
r_const
id|__u16
id|offset
op_assign
id|start_bit
op_mod
id|BITS_PER_BYTE
suffix:semicolon
id|__u16
id|len
op_assign
id|num_bits
op_div
id|BITS_PER_BYTE
suffix:semicolon
id|__u16
id|byte
op_assign
id|start_bit
op_div
id|BITS_PER_BYTE
suffix:semicolon
id|__u16
id|residue
op_assign
(paren
id|num_bits
op_mod
id|BITS_PER_BYTE
)paren
op_plus
id|offset
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* adjust if we have more than a byte of residue */
r_if
c_cond
(paren
id|residue
op_ge
id|BITS_PER_BYTE
)paren
(brace
id|residue
op_sub_assign
id|BITS_PER_BYTE
suffix:semicolon
id|len
op_increment
suffix:semicolon
)brace
multiline_comment|/* clear out the bits.  We assume here that if len==0 then&n;&t; * residue &gt;= offset.  This is always true for the catbus&n;&t; * operations */
id|msg
(braket
id|byte
)braket
op_and_assign
l_int|0xff
op_lshift
(paren
id|BITS_PER_BYTE
op_minus
id|offset
)paren
suffix:semicolon
id|msg
(braket
id|byte
op_increment
)braket
op_or_assign
id|data
(braket
l_int|0
)braket
op_rshift
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|msg
(braket
id|byte
op_increment
)braket
op_assign
(paren
id|data
(braket
id|i
op_minus
l_int|1
)braket
op_lshift
(paren
id|BITS_PER_BYTE
op_minus
id|offset
)paren
)paren
op_or
(paren
id|data
(braket
id|i
)braket
op_rshift
id|offset
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|residue
op_ne
l_int|0
)paren
(brace
id|__u8
id|mask
op_assign
l_int|0xff
op_rshift
id|residue
suffix:semicolon
id|__u8
id|last_byte
op_assign
id|data
(braket
id|i
op_minus
l_int|1
)braket
op_lshift
(paren
id|BITS_PER_BYTE
op_minus
id|offset
)paren
op_or
(paren
id|data
(braket
id|i
)braket
op_rshift
id|offset
)paren
suffix:semicolon
id|last_byte
op_and_assign
op_complement
id|mask
suffix:semicolon
id|msg
(braket
id|byte
)braket
op_and_assign
id|mask
suffix:semicolon
id|msg
(braket
id|byte
)braket
op_or_assign
id|last_byte
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* unpack the data again (same arguments as cat_pack()). data buffer&n; * must be zero populated.&n; *&n; * Function: given a message string move to start_bit and copy num_bits into&n; * data (starting at bit 0 in data).&n; */
r_static
r_void
DECL|function|cat_unpack
id|cat_unpack
c_func
(paren
id|__u8
op_star
id|msg
comma
r_const
id|__u16
id|start_bit
comma
id|__u8
op_star
id|data
comma
r_const
id|__u16
id|num_bits
)paren
(brace
multiline_comment|/* compute initial shift needed */
r_const
id|__u16
id|offset
op_assign
id|start_bit
op_mod
id|BITS_PER_BYTE
suffix:semicolon
id|__u16
id|len
op_assign
id|num_bits
op_div
id|BITS_PER_BYTE
suffix:semicolon
r_const
id|__u8
id|last_bits
op_assign
id|num_bits
op_mod
id|BITS_PER_BYTE
suffix:semicolon
id|__u16
id|byte
op_assign
id|start_bit
op_div
id|BITS_PER_BYTE
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|last_bits
op_ne
l_int|0
)paren
(brace
id|len
op_increment
suffix:semicolon
)brace
multiline_comment|/* special case: want &lt; 8 bits from msg and we can get it from&n;&t; * a single byte of the msg */
r_if
c_cond
(paren
id|len
op_eq
l_int|0
op_logical_and
id|BITS_PER_BYTE
op_minus
id|offset
op_ge
id|num_bits
)paren
(brace
id|data
(braket
l_int|0
)braket
op_assign
id|msg
(braket
id|byte
)braket
op_lshift
id|offset
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_and_assign
l_int|0xff
op_rshift
(paren
id|BITS_PER_BYTE
op_minus
id|num_bits
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* this annoying if has to be done just in case a read of&n;&t;&t; * msg one beyond the array causes a panic */
r_if
c_cond
(paren
id|offset
op_ne
l_int|0
)paren
(brace
id|data
(braket
id|i
)braket
op_assign
id|msg
(braket
id|byte
op_increment
)braket
op_lshift
id|offset
suffix:semicolon
id|data
(braket
id|i
)braket
op_or_assign
id|msg
(braket
id|byte
)braket
op_rshift
(paren
id|BITS_PER_BYTE
op_minus
id|offset
)paren
suffix:semicolon
)brace
r_else
(brace
id|data
(braket
id|i
)braket
op_assign
id|msg
(braket
id|byte
op_increment
)braket
suffix:semicolon
)brace
)brace
multiline_comment|/* do we need to truncate the final byte */
r_if
c_cond
(paren
id|last_bits
op_ne
l_int|0
)paren
(brace
id|data
(braket
id|i
op_minus
l_int|1
)braket
op_and_assign
l_int|0xff
op_lshift
(paren
id|BITS_PER_BYTE
op_minus
id|last_bits
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_static
r_void
DECL|function|cat_build_header
id|cat_build_header
c_func
(paren
id|__u8
op_star
id|header
comma
r_const
id|__u16
id|len
comma
r_const
id|__u16
id|smallest_reg_bits
comma
r_const
id|__u16
id|longest_reg_bits
)paren
(brace
r_int
id|i
suffix:semicolon
id|__u16
id|start_bit
op_assign
(paren
id|smallest_reg_bits
op_minus
l_int|1
)paren
op_mod
id|BITS_PER_BYTE
suffix:semicolon
id|__u8
op_star
id|last_byte
op_assign
op_amp
id|header
(braket
id|len
op_minus
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|start_bit
op_eq
l_int|0
)paren
(brace
id|start_bit
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* must have at least one bit in the hdr */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|header
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|start_bit
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
op_star
id|last_byte
op_assign
(paren
(paren
op_star
id|last_byte
)paren
op_lshift
l_int|1
)paren
op_plus
l_int|1
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|cat_sendinst
id|cat_sendinst
c_func
(paren
id|voyager_module_t
op_star
id|modp
comma
id|voyager_asic_t
op_star
id|asicp
comma
id|__u8
id|reg
comma
id|__u8
id|op
)paren
(brace
id|__u8
id|parity
comma
id|inst
comma
id|inst_buf
(braket
l_int|4
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
id|__u8
id|iseq
(braket
id|VOYAGER_MAX_SCAN_PATH
)braket
comma
id|hseq
(braket
id|VOYAGER_MAX_REG_SIZE
)braket
suffix:semicolon
id|__u16
id|ibytes
comma
id|hbytes
comma
id|padbits
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* &n;&t; * Parity is the parity of the register number + 1 (READ_REGISTER&n;&t; * and WRITE_REGISTER always add &squot;1&squot; to the number of bits == 1)&n;&t; */
id|parity
op_assign
(paren
id|__u8
)paren
(paren
l_int|1
op_plus
(paren
id|reg
op_amp
l_int|0x01
)paren
op_plus
(paren
(paren
id|__u8
)paren
(paren
id|reg
op_amp
l_int|0x02
)paren
op_rshift
l_int|1
)paren
op_plus
(paren
(paren
id|__u8
)paren
(paren
id|reg
op_amp
l_int|0x04
)paren
op_rshift
l_int|2
)paren
op_plus
(paren
(paren
id|__u8
)paren
(paren
id|reg
op_amp
l_int|0x08
)paren
op_rshift
l_int|3
)paren
)paren
op_mod
l_int|2
suffix:semicolon
id|inst
op_assign
(paren
(paren
id|parity
op_lshift
l_int|7
)paren
op_or
(paren
id|reg
op_lshift
l_int|2
)paren
op_or
id|op
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_IRCYC
comma
id|CAT_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|modp-&gt;scan_path_connected
)paren
(brace
r_if
c_cond
(paren
id|asicp-&gt;asic_id
op_ne
id|VOYAGER_CAT_ID
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;**WARNING***: cat_sendinst has disconnected scan path not to CAT asic&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|outb
c_func
(paren
id|VOYAGER_CAT_HEADER
comma
id|CAT_DATA
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inst
comma
id|CAT_DATA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|CAT_DATA
)paren
op_ne
id|VOYAGER_CAT_HEADER
)paren
(brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;VOYAGER CAT: cat_sendinst failed to get CAT_HEADER&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
id|ibytes
op_assign
id|modp-&gt;inst_bits
op_div
id|BITS_PER_BYTE
suffix:semicolon
r_if
c_cond
(paren
(paren
id|padbits
op_assign
id|modp-&gt;inst_bits
op_mod
id|BITS_PER_BYTE
)paren
op_ne
l_int|0
)paren
(brace
id|padbits
op_assign
id|BITS_PER_BYTE
op_minus
id|padbits
suffix:semicolon
id|ibytes
op_increment
suffix:semicolon
)brace
id|hbytes
op_assign
id|modp-&gt;largest_reg
op_div
id|BITS_PER_BYTE
suffix:semicolon
r_if
c_cond
(paren
id|modp-&gt;largest_reg
op_mod
id|BITS_PER_BYTE
)paren
(brace
id|hbytes
op_increment
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_sendinst: ibytes=%d, hbytes=%d&bslash;n&quot;
comma
id|ibytes
comma
id|hbytes
)paren
)paren
suffix:semicolon
multiline_comment|/* initialise the instruction sequence to 0xff */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ibytes
op_plus
id|hbytes
suffix:semicolon
id|i
op_increment
)paren
(brace
id|iseq
(braket
id|i
)braket
op_assign
l_int|0xff
suffix:semicolon
)brace
id|cat_build_header
c_func
(paren
id|hseq
comma
id|hbytes
comma
id|modp-&gt;smallest_reg
comma
id|modp-&gt;largest_reg
)paren
suffix:semicolon
id|cat_pack
c_func
(paren
id|iseq
comma
id|modp-&gt;inst_bits
comma
id|hseq
comma
id|hbytes
op_star
id|BITS_PER_BYTE
)paren
suffix:semicolon
id|inst_buf
(braket
l_int|0
)braket
op_assign
id|inst
suffix:semicolon
id|inst_buf
(braket
l_int|1
)braket
op_assign
l_int|0xFF
op_rshift
(paren
id|modp-&gt;largest_reg
op_mod
id|BITS_PER_BYTE
)paren
suffix:semicolon
id|cat_pack
c_func
(paren
id|iseq
comma
id|asicp-&gt;bit_location
comma
id|inst_buf
comma
id|asicp-&gt;ireg_length
)paren
suffix:semicolon
macro_line|#ifdef VOYAGER_CAT_DEBUG
id|printk
c_func
(paren
l_string|&quot;ins = 0x%x, iseq: &quot;
comma
id|inst
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ibytes
op_plus
id|hbytes
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;0x%x &quot;
comma
id|iseq
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|cat_shiftout
c_func
(paren
id|iseq
comma
id|ibytes
comma
id|hbytes
comma
id|padbits
)paren
)paren
(brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;VOYAGER CAT: cat_sendinst: cat_shiftout failed&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;CAT SHIFTOUT DONE&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|cat_getdata
id|cat_getdata
c_func
(paren
id|voyager_module_t
op_star
id|modp
comma
id|voyager_asic_t
op_star
id|asicp
comma
id|__u8
id|reg
comma
id|__u8
op_star
id|value
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|modp-&gt;scan_path_connected
)paren
(brace
r_if
c_cond
(paren
id|asicp-&gt;asic_id
op_ne
id|VOYAGER_CAT_ID
)paren
(brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;VOYAGER CAT: ERROR: cat_getdata to CAT asic with scan path connected&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reg
OG
id|VOYAGER_SUBADDRHI
)paren
(brace
id|outb
c_func
(paren
id|VOYAGER_CAT_RUN
comma
id|CAT_CMD
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
id|VOYAGER_CAT_DRCYC
comma
id|CAT_CMD
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_HEADER
comma
id|CAT_DATA
)paren
suffix:semicolon
op_star
id|value
op_assign
id|inb
c_func
(paren
id|CAT_DATA
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xAA
comma
id|CAT_DATA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|CAT_DATA
)paren
op_ne
id|VOYAGER_CAT_HEADER
)paren
(brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_getdata: failed to get VOYAGER_CAT_HEADER&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|__u16
id|sbits
op_assign
id|modp-&gt;num_asics
op_minus
l_int|1
op_plus
id|asicp-&gt;ireg_length
suffix:semicolon
id|__u16
id|sbytes
op_assign
id|sbits
op_div
id|BITS_PER_BYTE
suffix:semicolon
id|__u16
id|tbytes
suffix:semicolon
id|__u8
id|string
(braket
id|VOYAGER_MAX_SCAN_PATH
)braket
comma
id|trailer
(braket
id|VOYAGER_MAX_REG_SIZE
)braket
suffix:semicolon
id|__u8
id|padbits
suffix:semicolon
r_int
id|i
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_DRCYC
comma
id|CAT_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|padbits
op_assign
id|sbits
op_mod
id|BITS_PER_BYTE
)paren
op_ne
l_int|0
)paren
(brace
id|padbits
op_assign
id|BITS_PER_BYTE
op_minus
id|padbits
suffix:semicolon
id|sbytes
op_increment
suffix:semicolon
)brace
id|tbytes
op_assign
id|asicp-&gt;ireg_length
op_div
id|BITS_PER_BYTE
suffix:semicolon
r_if
c_cond
(paren
id|asicp-&gt;ireg_length
op_mod
id|BITS_PER_BYTE
)paren
(brace
id|tbytes
op_increment
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_getdata: tbytes = %d, sbytes = %d, padbits = %d&bslash;n&quot;
comma
id|tbytes
comma
id|sbytes
comma
id|padbits
)paren
)paren
suffix:semicolon
id|cat_build_header
c_func
(paren
id|trailer
comma
id|tbytes
comma
l_int|1
comma
id|asicp-&gt;ireg_length
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|tbytes
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outb
c_func
(paren
id|trailer
(braket
id|i
)braket
comma
id|CAT_DATA
)paren
suffix:semicolon
id|string
(braket
id|sbytes
op_plus
id|i
)braket
op_assign
id|inb
c_func
(paren
id|CAT_DATA
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|sbytes
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outb
c_func
(paren
l_int|0xaa
comma
id|CAT_DATA
)paren
suffix:semicolon
id|string
(braket
id|i
)braket
op_assign
id|inb
c_func
(paren
id|CAT_DATA
)paren
suffix:semicolon
)brace
op_star
id|value
op_assign
l_int|0
suffix:semicolon
id|cat_unpack
c_func
(paren
id|string
comma
id|padbits
op_plus
(paren
id|tbytes
op_star
id|BITS_PER_BYTE
)paren
op_plus
id|asicp-&gt;asic_location
comma
id|value
comma
id|asicp-&gt;ireg_length
)paren
suffix:semicolon
macro_line|#ifdef VOYAGER_CAT_DEBUG
id|printk
c_func
(paren
l_string|&quot;value=0x%x, string: &quot;
comma
op_star
id|value
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|tbytes
op_plus
id|sbytes
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;0x%x &quot;
comma
id|string
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* sanity check the rest of the return */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|tbytes
suffix:semicolon
id|i
op_increment
)paren
(brace
id|__u8
id|input
op_assign
l_int|0
suffix:semicolon
id|cat_unpack
c_func
(paren
id|string
comma
id|padbits
op_plus
(paren
id|i
op_star
id|BITS_PER_BYTE
)paren
comma
op_amp
id|input
comma
id|BITS_PER_BYTE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|trailer
(braket
id|i
)braket
op_ne
id|input
)paren
(brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_getdata: failed to sanity check rest of ret(%d) 0x%x != 0x%x&bslash;n&quot;
comma
id|i
comma
id|input
comma
id|trailer
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_getdata DONE&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|cat_shiftout
id|cat_shiftout
c_func
(paren
id|__u8
op_star
id|data
comma
id|__u16
id|data_bytes
comma
id|__u16
id|header_bytes
comma
id|__u8
id|pad_bits
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|data_bytes
op_plus
id|header_bytes
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
id|header_bytes
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outb
c_func
(paren
id|data
(braket
id|i
)braket
comma
id|CAT_DATA
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|header_bytes
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|__u8
id|header
op_assign
l_int|0
suffix:semicolon
id|__u8
id|input
suffix:semicolon
id|outb
c_func
(paren
id|data
(braket
id|i
)braket
comma
id|CAT_DATA
)paren
suffix:semicolon
id|input
op_assign
id|inb
c_func
(paren
id|CAT_DATA
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_shiftout: returned 0x%x&bslash;n&quot;
comma
id|input
)paren
)paren
suffix:semicolon
id|cat_unpack
c_func
(paren
id|data
comma
(paren
(paren
id|data_bytes
op_plus
id|i
)paren
op_star
id|BITS_PER_BYTE
)paren
op_minus
id|pad_bits
comma
op_amp
id|header
comma
id|BITS_PER_BYTE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|input
op_ne
id|header
)paren
(brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;VOYAGER CAT: cat_shiftout failed to return header 0x%x != 0x%x&bslash;n&quot;
comma
id|input
comma
id|header
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|cat_senddata
id|cat_senddata
c_func
(paren
id|voyager_module_t
op_star
id|modp
comma
id|voyager_asic_t
op_star
id|asicp
comma
id|__u8
id|reg
comma
id|__u8
id|value
)paren
(brace
id|outb
c_func
(paren
id|VOYAGER_CAT_DRCYC
comma
id|CAT_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|modp-&gt;scan_path_connected
)paren
(brace
r_if
c_cond
(paren
id|asicp-&gt;asic_id
op_ne
id|VOYAGER_CAT_ID
)paren
(brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;VOYAGER CAT: ERROR: scan path disconnected when asic != CAT&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|outb
c_func
(paren
id|VOYAGER_CAT_HEADER
comma
id|CAT_DATA
)paren
suffix:semicolon
id|outb
c_func
(paren
id|value
comma
id|CAT_DATA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|CAT_DATA
)paren
op_ne
id|VOYAGER_CAT_HEADER
)paren
(brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_senddata: failed to get correct header response to sent data&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reg
OG
id|VOYAGER_SUBADDRHI
)paren
(brace
id|outb
c_func
(paren
id|VOYAGER_CAT_RUN
comma
id|CAT_CMD
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_RUN
comma
id|CAT_CMD
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|__u16
id|hbytes
op_assign
id|asicp-&gt;ireg_length
op_div
id|BITS_PER_BYTE
suffix:semicolon
id|__u16
id|dbytes
op_assign
(paren
id|modp-&gt;num_asics
op_minus
l_int|1
op_plus
id|asicp-&gt;ireg_length
)paren
op_div
id|BITS_PER_BYTE
suffix:semicolon
id|__u8
id|padbits
comma
id|dseq
(braket
id|VOYAGER_MAX_SCAN_PATH
)braket
comma
id|hseq
(braket
id|VOYAGER_MAX_REG_SIZE
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|padbits
op_assign
(paren
id|modp-&gt;num_asics
op_minus
l_int|1
op_plus
id|asicp-&gt;ireg_length
)paren
op_mod
id|BITS_PER_BYTE
)paren
op_ne
l_int|0
)paren
(brace
id|padbits
op_assign
id|BITS_PER_BYTE
op_minus
id|padbits
suffix:semicolon
id|dbytes
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|asicp-&gt;ireg_length
op_mod
id|BITS_PER_BYTE
)paren
(brace
id|hbytes
op_increment
suffix:semicolon
)brace
id|cat_build_header
c_func
(paren
id|hseq
comma
id|hbytes
comma
l_int|1
comma
id|asicp-&gt;ireg_length
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dbytes
op_plus
id|hbytes
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dseq
(braket
id|i
)braket
op_assign
l_int|0xff
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_senddata: dbytes=%d, hbytes=%d, padbits=%d&bslash;n&quot;
comma
id|dbytes
comma
id|hbytes
comma
id|padbits
)paren
)paren
suffix:semicolon
id|cat_pack
c_func
(paren
id|dseq
comma
id|modp-&gt;num_asics
op_minus
l_int|1
op_plus
id|asicp-&gt;ireg_length
comma
id|hseq
comma
id|hbytes
op_star
id|BITS_PER_BYTE
)paren
suffix:semicolon
id|cat_pack
c_func
(paren
id|dseq
comma
id|asicp-&gt;asic_location
comma
op_amp
id|value
comma
id|asicp-&gt;ireg_length
)paren
suffix:semicolon
macro_line|#ifdef VOYAGER_CAT_DEBUG
id|printk
c_func
(paren
l_string|&quot;dseq &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hbytes
op_plus
id|dbytes
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;0x%x &quot;
comma
id|dseq
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|cat_shiftout
c_func
(paren
id|dseq
comma
id|dbytes
comma
id|hbytes
comma
id|padbits
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|cat_write
id|cat_write
c_func
(paren
id|voyager_module_t
op_star
id|modp
comma
id|voyager_asic_t
op_star
id|asicp
comma
id|__u8
id|reg
comma
id|__u8
id|value
)paren
(brace
r_if
c_cond
(paren
id|cat_sendinst
c_func
(paren
id|modp
comma
id|asicp
comma
id|reg
comma
id|VOYAGER_WRITE_CONFIG
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_return
id|cat_senddata
c_func
(paren
id|modp
comma
id|asicp
comma
id|reg
comma
id|value
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|cat_read
id|cat_read
c_func
(paren
id|voyager_module_t
op_star
id|modp
comma
id|voyager_asic_t
op_star
id|asicp
comma
id|__u8
id|reg
comma
id|__u8
op_star
id|value
)paren
(brace
r_if
c_cond
(paren
id|cat_sendinst
c_func
(paren
id|modp
comma
id|asicp
comma
id|reg
comma
id|VOYAGER_READ_CONFIG
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_return
id|cat_getdata
c_func
(paren
id|modp
comma
id|asicp
comma
id|reg
comma
id|value
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|cat_subaddrsetup
id|cat_subaddrsetup
c_func
(paren
id|voyager_module_t
op_star
id|modp
comma
id|voyager_asic_t
op_star
id|asicp
comma
id|__u16
id|offset
comma
id|__u16
id|len
)paren
(brace
id|__u8
id|val
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|1
)paren
(brace
multiline_comment|/* set auto increment */
id|__u8
id|newval
suffix:semicolon
r_if
c_cond
(paren
id|cat_read
c_func
(paren
id|modp
comma
id|asicp
comma
id|VOYAGER_AUTO_INC_REG
comma
op_amp
id|val
)paren
)paren
(brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_subaddrsetup: read of VOYAGER_AUTO_INC_REG failed&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_subaddrsetup: VOYAGER_AUTO_INC_REG = 0x%x&bslash;n&quot;
comma
id|val
)paren
)paren
suffix:semicolon
id|newval
op_assign
id|val
op_or
id|VOYAGER_AUTO_INC
suffix:semicolon
r_if
c_cond
(paren
id|newval
op_ne
id|val
)paren
(brace
r_if
c_cond
(paren
id|cat_write
c_func
(paren
id|modp
comma
id|asicp
comma
id|VOYAGER_AUTO_INC_REG
comma
id|val
)paren
)paren
(brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_subaddrsetup: write to VOYAGER_AUTO_INC_REG failed&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|cat_write
c_func
(paren
id|modp
comma
id|asicp
comma
id|VOYAGER_SUBADDRLO
comma
(paren
id|__u8
)paren
(paren
id|offset
op_amp
l_int|0xff
)paren
)paren
)paren
(brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_subaddrsetup: write to SUBADDRLO failed&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|asicp-&gt;subaddr
OG
id|VOYAGER_SUBADDR_LO
)paren
(brace
r_if
c_cond
(paren
id|cat_write
c_func
(paren
id|modp
comma
id|asicp
comma
id|VOYAGER_SUBADDRHI
comma
(paren
id|__u8
)paren
(paren
id|offset
op_rshift
l_int|8
)paren
)paren
)paren
(brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_subaddrsetup: write to SUBADDRHI failed&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|cat_read
c_func
(paren
id|modp
comma
id|asicp
comma
id|VOYAGER_SUBADDRHI
comma
op_amp
id|val
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_subaddrsetup: offset = %d, hi = %d&bslash;n&quot;
comma
id|offset
comma
id|val
)paren
)paren
suffix:semicolon
)brace
id|cat_read
c_func
(paren
id|modp
comma
id|asicp
comma
id|VOYAGER_SUBADDRLO
comma
op_amp
id|val
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_subaddrsetup: offset = %d, lo = %d&bslash;n&quot;
comma
id|offset
comma
id|val
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|cat_subwrite
id|cat_subwrite
c_func
(paren
id|voyager_module_t
op_star
id|modp
comma
id|voyager_asic_t
op_star
id|asicp
comma
id|__u16
id|offset
comma
id|__u16
id|len
comma
r_void
op_star
id|buf
)paren
(brace
r_int
id|i
comma
id|retval
suffix:semicolon
multiline_comment|/* FIXME: need special actions for VOYAGER_CAT_ID here */
r_if
c_cond
(paren
id|asicp-&gt;asic_id
op_eq
id|VOYAGER_CAT_ID
)paren
(brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_subwrite: ATTEMPT TO WRITE TO CAT ASIC&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* FIXME -- This is supposed to be handled better&n;&t;&t; * There is a problem writing to the cat asic in the&n;&t;&t; * PSI.  The 30us delay seems to work, though */
id|udelay
c_func
(paren
l_int|30
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|cat_subaddrsetup
c_func
(paren
id|modp
comma
id|asicp
comma
id|offset
comma
id|len
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cat_subwrite: cat_subaddrsetup FAILED&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cat_sendinst
c_func
(paren
id|modp
comma
id|asicp
comma
id|VOYAGER_SUBADDRDATA
comma
id|VOYAGER_WRITE_CONFIG
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cat_subwrite: cat_sendinst FAILED&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cat_senddata
c_func
(paren
id|modp
comma
id|asicp
comma
l_int|0xFF
comma
(paren
(paren
id|__u8
op_star
)paren
id|buf
)paren
(braket
id|i
)braket
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cat_subwrite: cat_sendata element at %d FAILED&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|cat_subread
id|cat_subread
c_func
(paren
id|voyager_module_t
op_star
id|modp
comma
id|voyager_asic_t
op_star
id|asicp
comma
id|__u16
id|offset
comma
id|__u16
id|len
comma
r_void
op_star
id|buf
)paren
(brace
r_int
id|i
comma
id|retval
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|cat_subaddrsetup
c_func
(paren
id|modp
comma
id|asicp
comma
id|offset
comma
id|len
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_subread: cat_subaddrsetup FAILED&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cat_sendinst
c_func
(paren
id|modp
comma
id|asicp
comma
id|VOYAGER_SUBADDRDATA
comma
id|VOYAGER_READ_CONFIG
)paren
)paren
(brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_subread: cat_sendinst failed&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cat_getdata
c_func
(paren
id|modp
comma
id|asicp
comma
l_int|0xFF
comma
op_amp
(paren
(paren
id|__u8
op_star
)paren
id|buf
)paren
(braket
id|i
)braket
)paren
)paren
(brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_subread: cat_getdata element %d failed&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* buffer for storing EPROM data read in during initialisation */
DECL|variable|eprom_buf
r_static
id|__initdata
id|__u8
id|eprom_buf
(braket
l_int|0xFFFF
)braket
suffix:semicolon
DECL|variable|voyager_initial_module
r_static
id|voyager_module_t
op_star
id|voyager_initial_module
suffix:semicolon
multiline_comment|/* Initialise the cat bus components.  We assume this is called by the&n; * boot cpu *after* all memory initialisation has been done (so we can&n; * use kmalloc) but before smp initialisation, so we can probe the SMP&n; * configuration and pick up necessary information.  */
r_void
DECL|function|voyager_cat_init
id|voyager_cat_init
c_func
(paren
r_void
)paren
(brace
id|voyager_module_t
op_star
op_star
id|modpp
op_assign
op_amp
id|voyager_initial_module
suffix:semicolon
id|voyager_asic_t
op_star
op_star
id|asicpp
suffix:semicolon
id|voyager_asic_t
op_star
id|qabc_asic
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_int
r_int
id|qic_addr
op_assign
l_int|0
suffix:semicolon
id|__u8
id|qabc_data
(braket
l_int|0x20
)braket
suffix:semicolon
id|__u8
id|num_submodules
comma
id|val
suffix:semicolon
id|voyager_eprom_hdr_t
op_star
id|eprom_hdr
op_assign
(paren
id|voyager_eprom_hdr_t
op_star
)paren
op_amp
id|eprom_buf
(braket
l_int|0
)braket
suffix:semicolon
id|__u8
id|cmos
(braket
l_int|4
)braket
suffix:semicolon
r_int
r_int
id|addr
suffix:semicolon
multiline_comment|/* initiallise the SUS mailbox */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|cmos
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cmos
(braket
id|i
)braket
op_assign
id|voyager_extended_cmos_read
c_func
(paren
id|VOYAGER_DUMP_LOCATION
op_plus
id|i
)paren
suffix:semicolon
)brace
id|addr
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
id|cmos
suffix:semicolon
r_if
c_cond
(paren
(paren
id|addr
op_amp
l_int|0xff000000
)paren
op_ne
l_int|0xff000000
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Voyager failed to get SUS mailbox (addr = 0x%lx&bslash;n&quot;
comma
id|addr
)paren
suffix:semicolon
)brace
r_else
(brace
r_static
r_struct
id|resource
id|res
suffix:semicolon
id|res.name
op_assign
l_string|&quot;voyager SUS&quot;
suffix:semicolon
id|res.start
op_assign
id|addr
suffix:semicolon
id|res.end
op_assign
id|addr
op_plus
l_int|0x3ff
suffix:semicolon
id|request_resource
c_func
(paren
op_amp
id|iomem_resource
comma
op_amp
id|res
)paren
suffix:semicolon
id|voyager_SUS
op_assign
(paren
r_struct
id|voyager_SUS
op_star
)paren
id|ioremap
c_func
(paren
id|addr
comma
l_int|0x400
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Voyager SUS mailbox version 0x%x&bslash;n&quot;
comma
id|voyager_SUS-&gt;SUS_version
)paren
suffix:semicolon
id|voyager_SUS-&gt;kernel_version
op_assign
id|VOYAGER_MAILBOX_VERSION
suffix:semicolon
id|voyager_SUS-&gt;kernel_flags
op_assign
id|VOYAGER_OS_HAS_SYSINT
suffix:semicolon
)brace
multiline_comment|/* clear the processor counts */
id|voyager_extended_vic_processors
op_assign
l_int|0
suffix:semicolon
id|voyager_quad_processors
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;VOYAGER: beginning CAT bus probe&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* set up the SuperSet Port Block which tells us where the&n;&t; * CAT communication port is */
id|sspb
op_assign
id|inb
c_func
(paren
id|VOYAGER_SSPB_RELOCATION_PORT
)paren
op_star
l_int|0x100
suffix:semicolon
id|VDEBUG
c_func
(paren
(paren
l_string|&quot;VOYAGER DEBUG: sspb = 0x%x&bslash;n&quot;
comma
id|sspb
)paren
)paren
suffix:semicolon
multiline_comment|/* now find out if were 8 slot or normal */
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|VIC_PROC_WHO_AM_I
)paren
op_amp
id|EIGHT_SLOT_IDENTIFIER
)paren
op_eq
id|EIGHT_SLOT_IDENTIFIER
)paren
(brace
id|voyager_8slot
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Voyager: Eight slot 51xx configuration detected&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|VOYAGER_MIN_MODULE
suffix:semicolon
id|i
op_le
id|VOYAGER_MAX_MODULE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|__u8
id|input
suffix:semicolon
r_int
id|asic
suffix:semicolon
id|__u16
id|eprom_size
suffix:semicolon
id|__u16
id|sp_offset
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_DESELECT
comma
id|VOYAGER_CAT_CONFIG_PORT
)paren
suffix:semicolon
id|outb
c_func
(paren
id|i
comma
id|VOYAGER_CAT_CONFIG_PORT
)paren
suffix:semicolon
multiline_comment|/* check the presence of the module */
id|outb
c_func
(paren
id|VOYAGER_CAT_RUN
comma
id|CAT_CMD
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_IRCYC
comma
id|CAT_CMD
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_HEADER
comma
id|CAT_DATA
)paren
suffix:semicolon
multiline_comment|/* stream series of alternating 1&squot;s and 0&squot;s to stimulate&n;&t;&t; * response */
id|outb
c_func
(paren
l_int|0xAA
comma
id|CAT_DATA
)paren
suffix:semicolon
id|input
op_assign
id|inb
c_func
(paren
id|CAT_DATA
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|input
op_ne
id|VOYAGER_CAT_HEADER
)paren
(brace
r_continue
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;VOYAGER DEBUG: found module id 0x%x, %s&bslash;n&quot;
comma
id|i
comma
id|cat_module_name
c_func
(paren
id|i
)paren
)paren
)paren
suffix:semicolon
op_star
id|modpp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|voyager_module_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
multiline_comment|/*&amp;voyager_module_storage[cat_count++];*/
r_if
c_cond
(paren
op_star
id|modpp
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;**WARNING** kmalloc failure in cat_init&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|memset
c_func
(paren
op_star
id|modpp
comma
l_int|0
comma
r_sizeof
(paren
id|voyager_module_t
)paren
)paren
suffix:semicolon
multiline_comment|/* need temporary asic for cat_subread.  It will be&n;&t;&t; * filled in correctly later */
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|asic
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|voyager_asic_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
multiline_comment|/*&amp;voyager_asic_storage[asic_count];*/
r_if
c_cond
(paren
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|asic
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;**WARNING** kmalloc failure in cat_init&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|asic
comma
l_int|0
comma
r_sizeof
(paren
id|voyager_asic_t
)paren
)paren
suffix:semicolon
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|asic-&gt;asic_id
op_assign
id|VOYAGER_CAT_ID
suffix:semicolon
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|asic-&gt;subaddr
op_assign
id|VOYAGER_SUBADDR_HI
suffix:semicolon
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|module_addr
op_assign
id|i
suffix:semicolon
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|scan_path_connected
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|VOYAGER_PSI
)paren
(brace
multiline_comment|/* Exception leg for modules with no EEPROM */
id|printk
c_func
(paren
l_string|&quot;Module &bslash;&quot;%s&bslash;&quot;&bslash;n&quot;
comma
id|cat_module_name
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_init: Reading eeprom for module 0x%x at offset %d&bslash;n&quot;
comma
id|i
comma
id|VOYAGER_XSUM_END_OFFSET
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_RUN
comma
id|CAT_CMD
)paren
suffix:semicolon
id|cat_disconnect
c_func
(paren
op_star
id|modpp
comma
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|asic
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cat_subread
c_func
(paren
op_star
id|modpp
comma
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|asic
comma
id|VOYAGER_XSUM_END_OFFSET
comma
r_sizeof
(paren
id|eprom_size
)paren
comma
op_amp
id|eprom_size
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;**WARNING**: Voyager couldn&squot;t read EPROM size for module 0x%x&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|eprom_size
OG
r_sizeof
(paren
id|eprom_buf
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;**WARNING**: Voyager insufficient size to read EPROM data, module 0x%x.  Need %d&bslash;n&quot;
comma
id|i
comma
id|eprom_size
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_RUN
comma
id|CAT_CMD
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_init: module 0x%x, eeprom_size %d&bslash;n&quot;
comma
id|i
comma
id|eprom_size
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cat_subread
c_func
(paren
op_star
id|modpp
comma
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|asic
comma
l_int|0
comma
id|eprom_size
comma
id|eprom_buf
)paren
)paren
(brace
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Module &bslash;&quot;%s&bslash;&quot;, version 0x%x, tracer 0x%x, asics %d&bslash;n&quot;
comma
id|cat_module_name
c_func
(paren
id|i
)paren
comma
id|eprom_hdr-&gt;version_id
comma
op_star
(paren
(paren
id|__u32
op_star
)paren
id|eprom_hdr-&gt;tracer
)paren
comma
id|eprom_hdr-&gt;num_asics
)paren
suffix:semicolon
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|ee_size
op_assign
id|eprom_hdr-&gt;ee_size
suffix:semicolon
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|num_asics
op_assign
id|eprom_hdr-&gt;num_asics
suffix:semicolon
id|asicpp
op_assign
op_amp
(paren
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|asic
)paren
suffix:semicolon
id|sp_offset
op_assign
id|eprom_hdr-&gt;scan_path_offset
suffix:semicolon
multiline_comment|/* All we really care about are the Quad cards.  We&n;                 * identify them because they are in a processor slot&n;                 * and have only four asics */
r_if
c_cond
(paren
(paren
id|i
template_param
l_int|0x1f
)paren
)paren
(brace
id|modpp
op_assign
op_amp
(paren
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Now we know it&squot;s in a processor slot, does it have&n;&t;&t; * a quad baseboard submodule */
id|outb
c_func
(paren
id|VOYAGER_CAT_RUN
comma
id|CAT_CMD
)paren
suffix:semicolon
id|cat_read
c_func
(paren
op_star
id|modpp
comma
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|asic
comma
id|VOYAGER_SUBMODPRESENT
comma
op_amp
id|num_submodules
)paren
suffix:semicolon
multiline_comment|/* lowest two bits, active low */
id|num_submodules
op_assign
op_complement
(paren
l_int|0xfc
op_or
id|num_submodules
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;VOYAGER CAT: %d submodules present&bslash;n&quot;
comma
id|num_submodules
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_submodules
op_eq
l_int|0
)paren
(brace
multiline_comment|/* fill in the dyadic extended processors */
id|__u8
id|cpu
op_assign
id|i
op_amp
l_int|0x07
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Module &bslash;&quot;%s&bslash;&quot;: Dyadic Processor Card&bslash;n&quot;
comma
id|cat_module_name
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
id|voyager_extended_vic_processors
op_or_assign
(paren
l_int|1
op_lshift
id|cpu
)paren
suffix:semicolon
id|cpu
op_add_assign
l_int|4
suffix:semicolon
id|voyager_extended_vic_processors
op_or_assign
(paren
l_int|1
op_lshift
id|cpu
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* now we want to read the asics on the first submodule,&n;&t;&t; * which should be the quad base board */
id|cat_read
c_func
(paren
op_star
id|modpp
comma
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|asic
comma
id|VOYAGER_SUBMODSELECT
comma
op_amp
id|val
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_init: SUBMODSELECT value = 0x%x&bslash;n&quot;
comma
id|val
)paren
)paren
suffix:semicolon
id|val
op_assign
(paren
id|val
op_amp
l_int|0x7c
)paren
op_or
id|VOYAGER_QUAD_BASEBOARD
suffix:semicolon
id|cat_write
c_func
(paren
op_star
id|modpp
comma
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|asic
comma
id|VOYAGER_SUBMODSELECT
comma
id|val
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_init: Reading eeprom for module 0x%x at offset %d&bslash;n&quot;
comma
id|i
comma
id|VOYAGER_XSUM_END_OFFSET
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_RUN
comma
id|CAT_CMD
)paren
suffix:semicolon
id|cat_disconnect
c_func
(paren
op_star
id|modpp
comma
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|asic
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cat_subread
c_func
(paren
op_star
id|modpp
comma
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|asic
comma
id|VOYAGER_XSUM_END_OFFSET
comma
r_sizeof
(paren
id|eprom_size
)paren
comma
op_amp
id|eprom_size
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;**WARNING**: Voyager couldn&squot;t read EPROM size for module 0x%x&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|eprom_size
OG
r_sizeof
(paren
id|eprom_buf
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;**WARNING**: Voyager insufficient size to read EPROM data, module 0x%x.  Need %d&bslash;n&quot;
comma
id|i
comma
id|eprom_size
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_RUN
comma
id|CAT_CMD
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_init: module 0x%x, eeprom_size %d&bslash;n&quot;
comma
id|i
comma
id|eprom_size
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cat_subread
c_func
(paren
op_star
id|modpp
comma
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|asic
comma
l_int|0
comma
id|eprom_size
comma
id|eprom_buf
)paren
)paren
(brace
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
multiline_comment|/* Now do everything for the QBB submodule 1 */
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|ee_size
op_assign
id|eprom_hdr-&gt;ee_size
suffix:semicolon
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|num_asics
op_assign
id|eprom_hdr-&gt;num_asics
suffix:semicolon
id|asicpp
op_assign
op_amp
(paren
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|asic
)paren
suffix:semicolon
id|sp_offset
op_assign
id|eprom_hdr-&gt;scan_path_offset
suffix:semicolon
multiline_comment|/* get rid of the dummy CAT asic and read the real one */
id|kfree
c_func
(paren
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|asic
)paren
suffix:semicolon
r_for
c_loop
(paren
id|asic
op_assign
l_int|0
suffix:semicolon
id|asic
OL
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|num_asics
suffix:semicolon
id|asic
op_increment
)paren
(brace
r_int
id|j
suffix:semicolon
id|voyager_asic_t
op_star
id|asicp
op_assign
op_star
id|asicpp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|voyager_asic_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
multiline_comment|/*&amp;voyager_asic_storage[asic_count++];*/
id|voyager_sp_table_t
op_star
id|sp_table
suffix:semicolon
id|voyager_at_t
op_star
id|asic_table
suffix:semicolon
id|voyager_jtt_t
op_star
id|jtag_table
suffix:semicolon
r_if
c_cond
(paren
id|asicp
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;**WARNING** kmalloc failure in cat_init&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|memset
c_func
(paren
id|asicp
comma
l_int|0
comma
r_sizeof
(paren
id|voyager_asic_t
)paren
)paren
suffix:semicolon
id|asicpp
op_assign
op_amp
(paren
id|asicp-&gt;next
)paren
suffix:semicolon
id|asicp-&gt;asic_location
op_assign
id|asic
suffix:semicolon
id|sp_table
op_assign
(paren
id|voyager_sp_table_t
op_star
)paren
(paren
id|eprom_buf
op_plus
id|sp_offset
)paren
suffix:semicolon
id|asicp-&gt;asic_id
op_assign
id|sp_table-&gt;asic_id
suffix:semicolon
id|asic_table
op_assign
(paren
id|voyager_at_t
op_star
)paren
(paren
id|eprom_buf
op_plus
id|sp_table-&gt;asic_data_offset
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|4
suffix:semicolon
id|j
op_increment
)paren
(brace
id|asicp-&gt;jtag_id
(braket
id|j
)braket
op_assign
id|asic_table-&gt;jtag_id
(braket
id|j
)braket
suffix:semicolon
)brace
id|jtag_table
op_assign
(paren
id|voyager_jtt_t
op_star
)paren
(paren
id|eprom_buf
op_plus
id|asic_table-&gt;jtag_offset
)paren
suffix:semicolon
id|asicp-&gt;ireg_length
op_assign
id|jtag_table-&gt;ireg_len
suffix:semicolon
id|asicp-&gt;bit_location
op_assign
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|inst_bits
suffix:semicolon
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|inst_bits
op_add_assign
id|asicp-&gt;ireg_length
suffix:semicolon
r_if
c_cond
(paren
id|asicp-&gt;ireg_length
OG
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|largest_reg
)paren
(brace
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|largest_reg
op_assign
id|asicp-&gt;ireg_length
suffix:semicolon
)brace
r_if
c_cond
(paren
id|asicp-&gt;ireg_length
OL
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|smallest_reg
op_logical_or
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|smallest_reg
op_eq
l_int|0
)paren
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|smallest_reg
op_assign
id|asicp-&gt;ireg_length
suffix:semicolon
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;asic 0x%x, ireg_length=%d, bit_location=%d&bslash;n&quot;
comma
id|asicp-&gt;asic_id
comma
id|asicp-&gt;ireg_length
comma
id|asicp-&gt;bit_location
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|asicp-&gt;asic_id
op_eq
id|VOYAGER_QUAD_QABC
)paren
(brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;VOYAGER CAT: QABC ASIC found&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|qabc_asic
op_assign
id|asicp
suffix:semicolon
)brace
id|sp_offset
op_add_assign
r_sizeof
(paren
id|voyager_sp_table_t
)paren
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;Module inst_bits = %d, largest_reg = %d, smallest_reg=%d&bslash;n&quot;
comma
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|inst_bits
comma
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|largest_reg
comma
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|smallest_reg
)paren
)paren
suffix:semicolon
multiline_comment|/* OK, now we have the QUAD ASICs set up, use them.&n;&t;&t; * we need to:&n;&t;&t; *&n;&t;&t; * 1. Find the Memory area for the Quad CPIs.&n;&t;&t; * 2. Find the Extended VIC processor&n;&t;&t; * 3. Configure a second extended VIC processor (This&n;&t;&t; *    cannot be done for the 51xx.&n;&t;&t; * */
id|outb
c_func
(paren
id|VOYAGER_CAT_RUN
comma
id|CAT_CMD
)paren
suffix:semicolon
id|cat_connect
c_func
(paren
op_star
id|modpp
comma
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|asic
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;CAT CONNECTED!!&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|cat_subread
c_func
(paren
op_star
id|modpp
comma
id|qabc_asic
comma
l_int|0
comma
r_sizeof
(paren
id|qabc_data
)paren
comma
id|qabc_data
)paren
suffix:semicolon
id|qic_addr
op_assign
id|qabc_data
(braket
l_int|5
)braket
op_lshift
l_int|8
suffix:semicolon
id|qic_addr
op_assign
(paren
id|qic_addr
op_or
id|qabc_data
(braket
l_int|6
)braket
)paren
op_lshift
l_int|8
suffix:semicolon
id|qic_addr
op_assign
(paren
id|qic_addr
op_or
id|qabc_data
(braket
l_int|7
)braket
)paren
op_lshift
l_int|8
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Module &bslash;&quot;%s&bslash;&quot;: Quad Processor Card; CPI 0x%lx, SET=0x%x&bslash;n&quot;
comma
id|cat_module_name
c_func
(paren
id|i
)paren
comma
id|qic_addr
comma
id|qabc_data
(braket
l_int|8
)braket
)paren
suffix:semicolon
macro_line|#if 0&t;&t;&t;&t;/* plumbing fails---FIXME */
r_if
c_cond
(paren
(paren
id|qabc_data
(braket
l_int|8
)braket
op_amp
l_int|0xf0
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* FIXME: 32 way 8 CPU slot monster cannot be&n;&t;&t;&t; * plumbed this way---need to check for it */
id|printk
c_func
(paren
l_string|&quot;Plumbing second Extended Quad Processor&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* second VIC line hardwired to Quad CPU 1 */
id|qabc_data
(braket
l_int|8
)braket
op_or_assign
l_int|0x20
suffix:semicolon
id|cat_subwrite
c_func
(paren
op_star
id|modpp
comma
id|qabc_asic
comma
l_int|8
comma
l_int|1
comma
op_amp
id|qabc_data
(braket
l_int|8
)braket
)paren
suffix:semicolon
macro_line|#ifdef VOYAGER_CAT_DEBUG
multiline_comment|/* verify plumbing */
id|cat_subread
c_func
(paren
op_star
id|modpp
comma
id|qabc_asic
comma
l_int|8
comma
l_int|1
comma
op_amp
id|qabc_data
(braket
l_int|8
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|qabc_data
(braket
l_int|8
)braket
op_amp
l_int|0xf0
)paren
op_eq
l_int|0
)paren
(brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;PLUMBING FAILED: 0x%x&bslash;n&quot;
comma
id|qabc_data
(braket
l_int|8
)braket
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
macro_line|#endif
(brace
r_struct
id|resource
op_star
id|res
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|resource
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|memset
c_func
(paren
id|res
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|resource
)paren
)paren
suffix:semicolon
id|res-&gt;name
op_assign
id|kmalloc
c_func
(paren
l_int|128
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|sprintf
c_func
(paren
(paren
r_char
op_star
)paren
id|res-&gt;name
comma
l_string|&quot;Voyager %s Quad CPI&quot;
comma
id|cat_module_name
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
id|res-&gt;start
op_assign
id|qic_addr
suffix:semicolon
id|res-&gt;end
op_assign
id|qic_addr
op_plus
l_int|0x3ff
suffix:semicolon
id|request_resource
c_func
(paren
op_amp
id|iomem_resource
comma
id|res
)paren
suffix:semicolon
)brace
id|qic_addr
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|qic_addr
comma
l_int|0x400
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|4
suffix:semicolon
id|j
op_increment
)paren
(brace
id|__u8
id|cpu
suffix:semicolon
r_if
c_cond
(paren
id|voyager_8slot
)paren
(brace
multiline_comment|/* 8 slot has a different mapping,&n;&t;&t;&t;&t; * each slot has only one vic line, so&n;&t;&t;&t;&t; * 1 cpu in each slot must be &lt; 8 */
id|cpu
op_assign
(paren
id|i
op_amp
l_int|0x07
)paren
op_plus
id|j
op_star
l_int|8
suffix:semicolon
)brace
r_else
(brace
id|cpu
op_assign
(paren
id|i
op_amp
l_int|0x03
)paren
op_plus
id|j
op_star
l_int|4
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|qabc_data
(braket
l_int|8
)braket
op_amp
(paren
l_int|1
op_lshift
id|j
)paren
)paren
)paren
(brace
id|voyager_extended_vic_processors
op_or_assign
(paren
l_int|1
op_lshift
id|cpu
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qabc_data
(braket
l_int|8
)braket
op_amp
(paren
l_int|1
op_lshift
(paren
id|j
op_plus
l_int|4
)paren
)paren
)paren
(brace
multiline_comment|/* Second SET register plumbed: Quad&n;&t;&t;&t;&t; * card has two VIC connected CPUs.&n;&t;&t;&t;&t; * Secondary cannot be booted as a VIC&n;&t;&t;&t;&t; * CPU */
id|voyager_extended_vic_processors
op_or_assign
(paren
l_int|1
op_lshift
id|cpu
)paren
suffix:semicolon
id|voyager_allowed_boot_processors
op_and_assign
(paren
op_complement
(paren
l_int|1
op_lshift
id|cpu
)paren
)paren
suffix:semicolon
)brace
id|voyager_quad_processors
op_or_assign
(paren
l_int|1
op_lshift
id|cpu
)paren
suffix:semicolon
id|voyager_quad_cpi_addr
(braket
id|cpu
)braket
op_assign
(paren
r_struct
id|voyager_qic_cpi
op_star
)paren
(paren
id|qic_addr
op_plus
(paren
id|j
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;CPU%d: CPI address 0x%lx&bslash;n&quot;
comma
id|cpu
comma
(paren
r_int
r_int
)paren
id|voyager_quad_cpi_addr
(braket
id|cpu
)braket
)paren
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
op_star
id|asicpp
op_assign
l_int|NULL
suffix:semicolon
id|modpp
op_assign
op_amp
(paren
(paren
op_star
id|modpp
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
)brace
op_star
id|modpp
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;CAT Bus Initialisation finished: extended procs 0x%x, quad procs 0x%x, allowed vic boot = 0x%x&bslash;n&quot;
comma
id|voyager_extended_vic_processors
comma
id|voyager_quad_processors
comma
id|voyager_allowed_boot_processors
)paren
suffix:semicolon
id|request_resource
c_func
(paren
op_amp
id|ioport_resource
comma
op_amp
id|vic_res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|voyager_quad_processors
)paren
(brace
id|request_resource
c_func
(paren
op_amp
id|ioport_resource
comma
op_amp
id|qic_res
)paren
suffix:semicolon
)brace
multiline_comment|/* set up the front power switch */
)brace
r_int
DECL|function|voyager_cat_readb
id|voyager_cat_readb
c_func
(paren
id|__u8
id|module
comma
id|__u8
id|asic
comma
r_int
id|reg
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|cat_disconnect
id|cat_disconnect
c_func
(paren
id|voyager_module_t
op_star
id|modp
comma
id|voyager_asic_t
op_star
id|asicp
)paren
(brace
id|__u8
id|val
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|modp-&gt;scan_path_connected
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|asicp-&gt;asic_id
op_ne
id|VOYAGER_CAT_ID
)paren
(brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_disconnect: ASIC is not CAT&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|err
op_assign
id|cat_read
c_func
(paren
id|modp
comma
id|asicp
comma
id|VOYAGER_SCANPATH
comma
op_amp
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_disconnect: failed to read SCANPATH&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|val
op_and_assign
id|VOYAGER_DISCONNECT_ASIC
suffix:semicolon
id|err
op_assign
id|cat_write
c_func
(paren
id|modp
comma
id|asicp
comma
id|VOYAGER_SCANPATH
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_disconnect: failed to write SCANPATH&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_RUN
comma
id|CAT_CMD
)paren
suffix:semicolon
id|modp-&gt;scan_path_connected
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|cat_connect
id|cat_connect
c_func
(paren
id|voyager_module_t
op_star
id|modp
comma
id|voyager_asic_t
op_star
id|asicp
)paren
(brace
id|__u8
id|val
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|modp-&gt;scan_path_connected
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|asicp-&gt;asic_id
op_ne
id|VOYAGER_CAT_ID
)paren
(brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_connect: ASIC is not CAT&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|err
op_assign
id|cat_read
c_func
(paren
id|modp
comma
id|asicp
comma
id|VOYAGER_SCANPATH
comma
op_amp
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_connect: failed to read SCANPATH&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|val
op_or_assign
id|VOYAGER_CONNECT_ASIC
suffix:semicolon
id|err
op_assign
id|cat_write
c_func
(paren
id|modp
comma
id|asicp
comma
id|VOYAGER_SCANPATH
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;cat_connect: failed to write SCANPATH&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_RUN
comma
id|CAT_CMD
)paren
suffix:semicolon
id|modp-&gt;scan_path_connected
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|voyager_cat_power_off
id|voyager_cat_power_off
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Power the machine off by writing to the PSI over the CAT&n;         * bus */
id|__u8
id|data
suffix:semicolon
id|voyager_module_t
id|psi
op_assign
(brace
l_int|0
)brace
suffix:semicolon
id|voyager_asic_t
id|psi_asic
op_assign
(brace
l_int|0
)brace
suffix:semicolon
id|psi.asic
op_assign
op_amp
id|psi_asic
suffix:semicolon
id|psi.asic-&gt;asic_id
op_assign
id|VOYAGER_CAT_ID
suffix:semicolon
id|psi.asic-&gt;subaddr
op_assign
id|VOYAGER_SUBADDR_HI
suffix:semicolon
id|psi.module_addr
op_assign
id|VOYAGER_PSI
suffix:semicolon
id|psi.scan_path_connected
op_assign
l_int|0
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
multiline_comment|/* Connect the PSI to the CAT Bus */
id|outb
c_func
(paren
id|VOYAGER_CAT_DESELECT
comma
id|VOYAGER_CAT_CONFIG_PORT
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_PSI
comma
id|VOYAGER_CAT_CONFIG_PORT
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_RUN
comma
id|CAT_CMD
)paren
suffix:semicolon
id|cat_disconnect
c_func
(paren
op_amp
id|psi
comma
op_amp
id|psi_asic
)paren
suffix:semicolon
multiline_comment|/* Read the status */
id|cat_subread
c_func
(paren
op_amp
id|psi
comma
op_amp
id|psi_asic
comma
id|VOYAGER_PSI_GENERAL_REG
comma
l_int|1
comma
op_amp
id|data
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
(paren
l_string|&quot;PSI STATUS 0x%x&bslash;n&quot;
comma
id|data
)paren
)paren
suffix:semicolon
multiline_comment|/* These two writes are power off prep and perform */
id|data
op_assign
id|PSI_CLEAR
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_RUN
comma
id|CAT_CMD
)paren
suffix:semicolon
id|cat_subwrite
c_func
(paren
op_amp
id|psi
comma
op_amp
id|psi_asic
comma
id|VOYAGER_PSI_GENERAL_REG
comma
l_int|1
comma
op_amp
id|data
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
id|data
op_assign
id|PSI_POWER_DOWN
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_RUN
comma
id|CAT_CMD
)paren
suffix:semicolon
id|cat_subwrite
c_func
(paren
op_amp
id|psi
comma
op_amp
id|psi_asic
comma
id|VOYAGER_PSI_GENERAL_REG
comma
l_int|1
comma
op_amp
id|data
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
)brace
DECL|variable|voyager_status
r_struct
id|voyager_status
id|voyager_status
op_assign
(brace
l_int|0
)brace
suffix:semicolon
r_void
DECL|function|voyager_cat_psi
id|voyager_cat_psi
c_func
(paren
id|__u8
id|cmd
comma
id|__u16
id|reg
comma
id|__u8
op_star
id|data
)paren
(brace
id|voyager_module_t
id|psi
op_assign
(brace
l_int|0
)brace
suffix:semicolon
id|voyager_asic_t
id|psi_asic
op_assign
(brace
l_int|0
)brace
suffix:semicolon
id|psi.asic
op_assign
op_amp
id|psi_asic
suffix:semicolon
id|psi.asic-&gt;asic_id
op_assign
id|VOYAGER_CAT_ID
suffix:semicolon
id|psi.asic-&gt;subaddr
op_assign
id|VOYAGER_SUBADDR_HI
suffix:semicolon
id|psi.module_addr
op_assign
id|VOYAGER_PSI
suffix:semicolon
id|psi.scan_path_connected
op_assign
l_int|0
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
multiline_comment|/* Connect the PSI to the CAT Bus */
id|outb
c_func
(paren
id|VOYAGER_CAT_DESELECT
comma
id|VOYAGER_CAT_CONFIG_PORT
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_PSI
comma
id|VOYAGER_CAT_CONFIG_PORT
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_RUN
comma
id|CAT_CMD
)paren
suffix:semicolon
id|cat_disconnect
c_func
(paren
op_amp
id|psi
comma
op_amp
id|psi_asic
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|VOYAGER_PSI_READ
suffix:colon
id|cat_read
c_func
(paren
op_amp
id|psi
comma
op_amp
id|psi_asic
comma
id|reg
comma
id|data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VOYAGER_PSI_WRITE
suffix:colon
id|cat_write
c_func
(paren
op_amp
id|psi
comma
op_amp
id|psi_asic
comma
id|reg
comma
op_star
id|data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VOYAGER_PSI_SUBREAD
suffix:colon
id|cat_subread
c_func
(paren
op_amp
id|psi
comma
op_amp
id|psi_asic
comma
id|reg
comma
l_int|1
comma
id|data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VOYAGER_PSI_SUBWRITE
suffix:colon
id|cat_subwrite
c_func
(paren
op_amp
id|psi
comma
op_amp
id|psi_asic
comma
id|reg
comma
l_int|1
comma
id|data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Voyager PSI, unrecognised command %d&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
)brace
r_void
DECL|function|voyager_cat_do_common_interrupt
id|voyager_cat_do_common_interrupt
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* This is caused either by a memory parity error or something&n;&t; * in the PSI */
id|__u8
id|data
suffix:semicolon
id|voyager_module_t
id|psi
op_assign
(brace
l_int|0
)brace
suffix:semicolon
id|voyager_asic_t
id|psi_asic
op_assign
(brace
l_int|0
)brace
suffix:semicolon
r_struct
id|voyager_psi
id|psi_reg
suffix:semicolon
r_int
id|i
suffix:semicolon
id|re_read
suffix:colon
id|psi.asic
op_assign
op_amp
id|psi_asic
suffix:semicolon
id|psi.asic-&gt;asic_id
op_assign
id|VOYAGER_CAT_ID
suffix:semicolon
id|psi.asic-&gt;subaddr
op_assign
id|VOYAGER_SUBADDR_HI
suffix:semicolon
id|psi.module_addr
op_assign
id|VOYAGER_PSI
suffix:semicolon
id|psi.scan_path_connected
op_assign
l_int|0
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
multiline_comment|/* Connect the PSI to the CAT Bus */
id|outb
c_func
(paren
id|VOYAGER_CAT_DESELECT
comma
id|VOYAGER_CAT_CONFIG_PORT
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_PSI
comma
id|VOYAGER_CAT_CONFIG_PORT
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_RUN
comma
id|CAT_CMD
)paren
suffix:semicolon
id|cat_disconnect
c_func
(paren
op_amp
id|psi
comma
op_amp
id|psi_asic
)paren
suffix:semicolon
multiline_comment|/* Read the status.  NOTE: Need to read *all* the PSI regs here&n;&t; * otherwise the cmn int will be reasserted */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|psi_reg.regs
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cat_read
c_func
(paren
op_amp
id|psi
comma
op_amp
id|psi_asic
comma
id|i
comma
op_amp
(paren
(paren
id|__u8
op_star
)paren
op_amp
id|psi_reg.regs
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|psi_reg.regs.checkbit
op_amp
l_int|0x02
)paren
op_eq
l_int|0
)paren
(brace
id|psi_reg.regs.checkbit
op_or_assign
l_int|0x02
suffix:semicolon
id|cat_write
c_func
(paren
op_amp
id|psi
comma
op_amp
id|psi_asic
comma
l_int|5
comma
id|psi_reg.regs.checkbit
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;VOYAGER RE-READ PSI&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|re_read
suffix:semicolon
)brace
id|outb
c_func
(paren
id|VOYAGER_CAT_RUN
comma
id|CAT_CMD
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|psi_reg.subregs
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* This looks strange, but the PSI doesn&squot;t do auto increment&n;&t;&t; * correctly */
id|cat_subread
c_func
(paren
op_amp
id|psi
comma
op_amp
id|psi_asic
comma
id|VOYAGER_PSI_SUPPLY_REG
op_plus
id|i
comma
l_int|1
comma
op_amp
(paren
(paren
id|__u8
op_star
)paren
op_amp
id|psi_reg.subregs
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
macro_line|#ifdef VOYAGER_CAT_DEBUG
id|printk
c_func
(paren
l_string|&quot;VOYAGER PSI: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|psi_reg.regs
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
(paren
(paren
id|__u8
op_star
)paren
op_amp
id|psi_reg.regs
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n           &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|psi_reg.subregs
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
(paren
(paren
id|__u8
op_star
)paren
op_amp
id|psi_reg.subregs
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|psi_reg.regs.intstatus
op_amp
id|PSI_MON
)paren
(brace
multiline_comment|/* switch off or power fail */
r_if
c_cond
(paren
id|psi_reg.subregs.supply
op_amp
id|PSI_SWITCH_OFF
)paren
(brace
r_if
c_cond
(paren
id|voyager_status.switch_off
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Voyager front panel switch turned off again---Immediate power off!&bslash;n&quot;
)paren
suffix:semicolon
id|voyager_cat_power_off
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* not reached */
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Voyager front panel switch turned off&bslash;n&quot;
)paren
suffix:semicolon
id|voyager_status.switch_off
op_assign
l_int|1
suffix:semicolon
id|voyager_status.request_from_kernel
op_assign
l_int|1
suffix:semicolon
id|up
c_func
(paren
op_amp
id|kvoyagerd_sem
)paren
suffix:semicolon
)brace
multiline_comment|/* Tell the hardware we&squot;re taking care of the&n;&t;&t;&t; * shutdown, otherwise it will power the box off&n;&t;&t;&t; * within 3 seconds of the switch being pressed and,&n;&t;&t;&t; * which is much more important to us, continue to &n;&t;&t;&t; * assert the common interrupt */
id|data
op_assign
id|PSI_CLR_SWITCH_OFF
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_RUN
comma
id|CAT_CMD
)paren
suffix:semicolon
id|cat_subwrite
c_func
(paren
op_amp
id|psi
comma
op_amp
id|psi_asic
comma
id|VOYAGER_PSI_SUPPLY_REG
comma
l_int|1
comma
op_amp
id|data
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
)brace
r_else
(brace
id|VDEBUG
c_func
(paren
(paren
l_string|&quot;Voyager ac fail reg 0x%x&bslash;n&quot;
comma
id|psi_reg.subregs.ACfail
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|psi_reg.subregs.ACfail
op_amp
id|AC_FAIL_STAT_CHANGE
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* No further update */
r_return
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* Don&squot;t bother trying to find out who failed.&n;&t;&t;&t; * FIXME: This probably makes the code incorrect on&n;&t;&t;&t; * anything other than a 345x */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|psi_reg.subregs.ACfail
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;AC FAIL IN SUPPLY %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* DON&squot;T do this: it shuts down the AC PSI &n;&t;&t;&t;outb(VOYAGER_CAT_RUN, CAT_CMD);&n;&t;&t;&t;data = PSI_MASK_MASK | i;&n;&t;&t;&t;cat_subwrite(&amp;psi, &amp;psi_asic, VOYAGER_PSI_MASK,&n;&t;&t;&t;&t;     1, &amp;data);&n;&t;&t;&t;outb(VOYAGER_CAT_END, CAT_CMD);&n;&t;&t;&t;*/
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Voyager AC power failure&bslash;n&quot;
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_RUN
comma
id|CAT_CMD
)paren
suffix:semicolon
id|data
op_assign
id|PSI_COLD_START
suffix:semicolon
id|cat_subwrite
c_func
(paren
op_amp
id|psi
comma
op_amp
id|psi_asic
comma
id|VOYAGER_PSI_GENERAL_REG
comma
l_int|1
comma
op_amp
id|data
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
id|voyager_status.power_fail
op_assign
l_int|1
suffix:semicolon
id|voyager_status.request_from_kernel
op_assign
l_int|1
suffix:semicolon
id|up
c_func
(paren
op_amp
id|kvoyagerd_sem
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|psi_reg.regs.intstatus
op_amp
id|PSI_FAULT
)paren
(brace
multiline_comment|/* Major fault! */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Voyager PSI Detected major fault, immediate power off!&bslash;n&quot;
)paren
suffix:semicolon
id|voyager_cat_power_off
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* not reached */
)brace
r_else
r_if
c_cond
(paren
id|psi_reg.regs.intstatus
op_amp
(paren
id|PSI_DC_FAIL
op_or
id|PSI_ALARM
op_or
id|PSI_CURRENT
op_or
id|PSI_DVM
op_or
id|PSI_PSCFAULT
op_or
id|PSI_STAT_CHG
)paren
)paren
(brace
multiline_comment|/* other psi fault */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Voyager PSI status 0x%x&bslash;n&quot;
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* clear the PSI fault */
id|outb
c_func
(paren
id|VOYAGER_CAT_RUN
comma
id|CAT_CMD
)paren
suffix:semicolon
id|cat_write
c_func
(paren
op_amp
id|psi
comma
op_amp
id|psi_asic
comma
id|VOYAGER_PSI_STATUS_REG
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|VOYAGER_CAT_END
comma
id|CAT_CMD
)paren
suffix:semicolon
)brace
)brace
eof
