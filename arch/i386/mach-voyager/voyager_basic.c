multiline_comment|/* Copyright (C) 1999,2001 &n; *&n; * Author: J.E.J.Bottomley@HansenPartnership.com&n; *&n; * linux/arch/i386/kernel/voyager.c&n; *&n; * This file contains all the voyager specific routines for getting&n; * initialisation of the architecture to function.  For additional&n; * features see:&n; *&n; *&t;voyager_cat.c - Voyager CAT bus interface&n; *&t;voyager_smp.c - Voyager SMP hal (emulates linux smp.c)&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/reboot.h&gt;
macro_line|#include &lt;linux/sysrq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/voyager.h&gt;
macro_line|#include &lt;asm/vic.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;asm/tlbflush.h&gt;
macro_line|#include &lt;asm/arch_hooks.h&gt;
multiline_comment|/*&n; * Power off function, if any&n; */
DECL|variable|pm_power_off
r_void
(paren
op_star
id|pm_power_off
)paren
(paren
r_void
)paren
suffix:semicolon
DECL|variable|reboot_thru_bios
r_int
id|reboot_thru_bios
suffix:semicolon
DECL|variable|voyager_level
r_int
id|voyager_level
op_assign
l_int|0
suffix:semicolon
DECL|variable|voyager_SUS
r_struct
id|voyager_SUS
op_star
id|voyager_SUS
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
r_static
r_void
DECL|function|voyager_dump
id|voyager_dump
c_func
(paren
r_int
id|dummy1
comma
r_struct
id|pt_regs
op_star
id|dummy2
comma
r_struct
id|tty_struct
op_star
id|dummy3
)paren
(brace
multiline_comment|/* get here via a sysrq */
id|voyager_smp_dump
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|variable|sysrq_voyager_dump_op
r_static
r_struct
id|sysrq_key_op
id|sysrq_voyager_dump_op
op_assign
(brace
dot
id|handler
op_assign
id|voyager_dump
comma
dot
id|help_msg
op_assign
l_string|&quot;Voyager&quot;
comma
dot
id|action_msg
op_assign
l_string|&quot;Dump Voyager Status&bslash;n&quot;
comma
)brace
suffix:semicolon
macro_line|#endif
r_void
DECL|function|voyager_detect
id|voyager_detect
c_func
(paren
r_struct
id|voyager_bios_info
op_star
id|bios
)paren
(brace
r_if
c_cond
(paren
id|bios-&gt;len
op_ne
l_int|0xff
)paren
(brace
r_int
r_class
op_assign
(paren
id|bios-&gt;class_1
op_lshift
l_int|8
)paren
op_or
(paren
id|bios-&gt;class_2
op_amp
l_int|0xff
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Voyager System detected.&bslash;n&quot;
l_string|&quot;        Class %x, Revision %d.%d&bslash;n&quot;
comma
r_class
comma
id|bios-&gt;major
comma
id|bios-&gt;minor
)paren
suffix:semicolon
r_if
c_cond
(paren
r_class
op_eq
id|VOYAGER_LEVEL4
)paren
(brace
id|voyager_level
op_assign
l_int|4
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
r_class
OL
id|VOYAGER_LEVEL5_AND_ABOVE
)paren
(brace
id|voyager_level
op_assign
l_int|3
suffix:semicolon
)brace
r_else
id|voyager_level
op_assign
l_int|5
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;        Architecture Level %d&bslash;n&quot;
comma
id|voyager_level
)paren
suffix:semicolon
r_if
c_cond
(paren
id|voyager_level
OL
l_int|4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n**WARNING**: Voyager HAL only supports Levels 4 and 5 Architectures at the moment&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* install the power off handler */
id|pm_power_off
op_assign
id|voyager_power_off
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
id|register_sysrq_key
c_func
(paren
l_char|&squot;v&squot;
comma
op_amp
id|sysrq_voyager_dump_op
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&bslash;n**WARNING**: No Voyager Subsystem Found&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|voyager_system_interrupt
id|voyager_system_interrupt
c_func
(paren
r_int
id|cpl
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Voyager: detected system interrupt&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Routine to read information from the extended CMOS area */
id|__u8
DECL|function|voyager_extended_cmos_read
id|voyager_extended_cmos_read
c_func
(paren
id|__u16
id|addr
)paren
(brace
id|outb
c_func
(paren
id|addr
op_amp
l_int|0xff
comma
l_int|0x74
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|addr
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
l_int|0x75
)paren
suffix:semicolon
r_return
id|inb
c_func
(paren
l_int|0x76
)paren
suffix:semicolon
)brace
multiline_comment|/* internal definitions for the SUS Click Map of memory */
DECL|macro|CLICK_ENTRIES
mdefine_line|#define CLICK_ENTRIES&t;16
DECL|macro|CLICK_SIZE
mdefine_line|#define CLICK_SIZE&t;4096&t;/* click to byte conversion for Length */
DECL|struct|ClickMap
r_typedef
r_struct
id|ClickMap
(brace
DECL|struct|Entry
r_struct
id|Entry
(brace
DECL|member|Address
id|__u32
id|Address
suffix:semicolon
DECL|member|Length
id|__u32
id|Length
suffix:semicolon
DECL|member|Entry
)brace
id|Entry
(braket
id|CLICK_ENTRIES
)braket
suffix:semicolon
DECL|typedef|ClickMap_t
)brace
id|ClickMap_t
suffix:semicolon
multiline_comment|/* This routine is pretty much an awful hack to read the bios clickmap by&n; * mapping it into page 0.  There are usually three regions in the map:&n; * &t;Base Memory&n; * &t;Extended Memory&n; *&t;zero length marker for end of map&n; *&n; * Returns are 0 for failure and 1 for success on extracting region.&n; */
r_int
id|__init
DECL|function|voyager_memory_detect
id|voyager_memory_detect
c_func
(paren
r_int
id|region
comma
id|__u32
op_star
id|start
comma
id|__u32
op_star
id|length
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|__u8
id|cmos
(braket
l_int|4
)braket
suffix:semicolon
id|ClickMap_t
op_star
id|map
suffix:semicolon
r_int
r_int
id|map_addr
suffix:semicolon
r_int
r_int
id|old
suffix:semicolon
r_if
c_cond
(paren
id|region
op_ge
id|CLICK_ENTRIES
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Voyager: Illegal ClickMap region %d&bslash;n&quot;
comma
id|region
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|cmos
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cmos
(braket
id|i
)braket
op_assign
id|voyager_extended_cmos_read
c_func
(paren
id|VOYAGER_MEMORY_CLICKMAP
op_plus
id|i
)paren
suffix:semicolon
)brace
id|map_addr
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
id|cmos
suffix:semicolon
multiline_comment|/* steal page 0 for this */
id|old
op_assign
id|pg0
(braket
l_int|0
)braket
suffix:semicolon
id|pg0
(braket
l_int|0
)braket
op_assign
(paren
(paren
id|map_addr
op_amp
id|PAGE_MASK
)paren
op_or
id|_PAGE_RW
op_or
id|_PAGE_PRESENT
)paren
suffix:semicolon
id|local_flush_tlb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* now clear everything out but page 0 */
id|map
op_assign
(paren
id|ClickMap_t
op_star
)paren
(paren
id|map_addr
op_amp
(paren
op_complement
id|PAGE_MASK
)paren
)paren
suffix:semicolon
multiline_comment|/* zero length is the end of the clickmap */
r_if
c_cond
(paren
id|map-&gt;Entry
(braket
id|region
)braket
dot
id|Length
op_ne
l_int|0
)paren
(brace
op_star
id|length
op_assign
id|map-&gt;Entry
(braket
id|region
)braket
dot
id|Length
op_star
id|CLICK_SIZE
suffix:semicolon
op_star
id|start
op_assign
id|map-&gt;Entry
(braket
id|region
)braket
dot
id|Address
suffix:semicolon
id|retval
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* replace the mapping */
id|pg0
(braket
l_int|0
)braket
op_assign
id|old
suffix:semicolon
id|local_flush_tlb
c_func
(paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* voyager specific handling code for timer interrupts.  Used to hand&n; * off the timer tick to the SMP code, since the VIC doesn&squot;t have an&n; * internal timer (The QIC does, but that&squot;s another story). */
r_void
DECL|function|voyager_timer_interrupt
id|voyager_timer_interrupt
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_if
c_cond
(paren
(paren
id|jiffies
op_amp
l_int|0x3ff
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* There seems to be something flaky in either&n;&t;&t; * hardware or software that is resetting the timer 0&n;&t;&t; * count to something much higher than it should be&n;&t;&t; * This seems to occur in the boot sequence, just&n;&t;&t; * before root is mounted.  Therefore, every 10&n;&t;&t; * seconds or so, we sanity check the timer zero count&n;&t;&t; * and kick it back to where it should be.&n;&t;&t; *&n;&t;&t; * FIXME: This is the most awful hack yet seen.  I&n;&t;&t; * should work out exactly what is interfering with&n;&t;&t; * the timer count settings early in the boot sequence&n;&t;&t; * and swiftly introduce it to something sharp and&n;&t;&t; * pointy.  */
id|__u16
id|val
suffix:semicolon
r_extern
id|spinlock_t
id|i8253_lock
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|i8253_lock
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x00
comma
l_int|0x43
)paren
suffix:semicolon
id|val
op_assign
id|inb_p
c_func
(paren
l_int|0x40
)paren
suffix:semicolon
id|val
op_or_assign
id|inb
c_func
(paren
l_int|0x40
)paren
op_lshift
l_int|8
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|i8253_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
OG
id|LATCH
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;nVOYAGER: countdown timer value too high (%d), resetting&bslash;n&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|i8253_lock
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x34
comma
l_int|0x43
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|LATCH
op_amp
l_int|0xff
comma
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* LSB */
id|outb
c_func
(paren
id|LATCH
op_rshift
l_int|8
comma
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* MSB */
id|spin_unlock
c_func
(paren
op_amp
id|i8253_lock
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_SMP
id|smp_vic_timer_interrupt
c_func
(paren
id|regs
)paren
suffix:semicolon
macro_line|#endif
)brace
r_void
DECL|function|voyager_power_off
id|voyager_power_off
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;VOYAGER Power Off&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|voyager_level
op_eq
l_int|5
)paren
(brace
id|voyager_cat_power_off
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|voyager_level
op_eq
l_int|4
)paren
(brace
multiline_comment|/* This doesn&squot;t apparently work on most L4 machines,&n;&t;&t; * but the specs say to do this to get automatic power&n;&t;&t; * off.  Unfortunately, if it doesn&squot;t power off the&n;&t;&t; * machine, it ends up doing a cold restart, which&n;&t;&t; * isn&squot;t really intended, so comment out the code */
macro_line|#if 0
r_int
id|port
suffix:semicolon
multiline_comment|/* enable the voyager Configuration Space */
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|VOYAGER_MC_SETUP
)paren
op_amp
l_int|0xf0
)paren
op_or
l_int|0x8
comma
id|VOYAGER_MC_SETUP
)paren
suffix:semicolon
multiline_comment|/* the port for the power off flag is an offset from the&n;&t;&t;   floating base */
id|port
op_assign
(paren
id|inb
c_func
(paren
id|VOYAGER_SSPB_RELOCATION_PORT
)paren
op_lshift
l_int|8
)paren
op_plus
l_int|0x21
suffix:semicolon
multiline_comment|/* set the power off flag */
id|outb
c_func
(paren
id|inb
c_func
(paren
id|port
)paren
op_or
l_int|0x1
comma
id|port
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* and wait for it to happen */
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|__asm
c_func
(paren
l_string|&quot;cli&quot;
)paren
suffix:semicolon
id|__asm
c_func
(paren
l_string|&quot;hlt&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* copied from process.c */
r_static
r_inline
r_void
DECL|function|kb_wait
id|kb_wait
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x10000
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|inb_p
c_func
(paren
l_int|0x64
)paren
op_amp
l_int|0x02
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_void
DECL|function|machine_restart
id|machine_restart
c_func
(paren
r_char
op_star
id|cmd
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Voyager Warm Restart&bslash;n&quot;
)paren
suffix:semicolon
id|kb_wait
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|voyager_level
op_eq
l_int|5
)paren
(brace
multiline_comment|/* write magic values to the RTC to inform system that&n;&t;&t; * shutdown is beginning */
id|outb
c_func
(paren
l_int|0x8f
comma
l_int|0x70
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x5
comma
l_int|0x71
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xfe
comma
l_int|0x64
)paren
suffix:semicolon
multiline_comment|/* pull reset low */
)brace
r_else
r_if
c_cond
(paren
id|voyager_level
op_eq
l_int|4
)paren
(brace
id|__u16
id|catbase
op_assign
id|inb
c_func
(paren
id|VOYAGER_SSPB_RELOCATION_PORT
)paren
op_lshift
l_int|8
suffix:semicolon
id|__u8
id|basebd
op_assign
id|inb
c_func
(paren
id|VOYAGER_MC_SETUP
)paren
suffix:semicolon
id|outb
c_func
(paren
id|basebd
op_or
l_int|0x08
comma
id|VOYAGER_MC_SETUP
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x02
comma
id|catbase
op_plus
l_int|0x21
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|asm
c_func
(paren
l_string|&quot;cli&quot;
)paren
suffix:semicolon
id|asm
c_func
(paren
l_string|&quot;hlt&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|variable|machine_restart
id|EXPORT_SYMBOL
c_func
(paren
id|machine_restart
)paren
suffix:semicolon
r_void
DECL|function|mca_nmi_hook
id|mca_nmi_hook
c_func
(paren
r_void
)paren
(brace
id|__u8
id|dumpval
id|__attribute__
c_func
(paren
(paren
id|unused
)paren
)paren
op_assign
id|inb
c_func
(paren
l_int|0xf823
)paren
suffix:semicolon
id|__u8
id|swnmi
id|__attribute__
c_func
(paren
(paren
id|unused
)paren
)paren
op_assign
id|inb
c_func
(paren
l_int|0xf813
)paren
suffix:semicolon
multiline_comment|/* FIXME: assume dump switch pressed */
multiline_comment|/* check to see if the dump switch was pressed */
id|VDEBUG
c_func
(paren
(paren
l_string|&quot;VOYAGER: dumpval = 0x%x, swnmi = 0x%x&bslash;n&quot;
comma
id|dumpval
comma
id|swnmi
)paren
)paren
suffix:semicolon
multiline_comment|/* clear swnmi */
id|outb
c_func
(paren
l_int|0xff
comma
l_int|0xf813
)paren
suffix:semicolon
multiline_comment|/* tell SUS to ignore dump */
r_if
c_cond
(paren
id|voyager_level
op_eq
l_int|5
op_logical_and
id|voyager_SUS
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|voyager_SUS-&gt;SUS_mbox
op_eq
id|VOYAGER_DUMP_BUTTON_NMI
)paren
(brace
id|voyager_SUS-&gt;kernel_mbox
op_assign
id|VOYAGER_NO_COMMAND
suffix:semicolon
id|voyager_SUS-&gt;kernel_flags
op_or_assign
id|VOYAGER_OS_IN_PROGRESS
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|voyager_SUS-&gt;kernel_mbox
op_assign
id|VOYAGER_IGNORE_DUMP
suffix:semicolon
id|voyager_SUS-&gt;kernel_flags
op_and_assign
op_complement
id|VOYAGER_OS_IN_PROGRESS
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;VOYAGER: Dump switch pressed, printing CPU%d tracebacks&bslash;n&quot;
comma
id|smp_processor_id
c_func
(paren
)paren
)paren
suffix:semicolon
id|show_stack
c_func
(paren
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
id|show_state
c_func
(paren
)paren
suffix:semicolon
)brace
r_void
DECL|function|machine_halt
id|machine_halt
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* treat a halt like a power off */
id|machine_power_off
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|variable|machine_halt
id|EXPORT_SYMBOL
c_func
(paren
id|machine_halt
)paren
suffix:semicolon
DECL|function|machine_power_off
r_void
id|machine_power_off
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|pm_power_off
)paren
id|pm_power_off
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|variable|machine_power_off
id|EXPORT_SYMBOL
c_func
(paren
id|machine_power_off
)paren
suffix:semicolon
eof
