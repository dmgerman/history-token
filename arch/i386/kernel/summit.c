multiline_comment|/*&n; * arch/i386/kernel/summit.c - IBM Summit-Specific Code&n; *&n; * Written By: Matthew Dobson, IBM Corporation&n; *&n; * Copyright (c) 2003 IBM Corp.&n; *&n; * All rights reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or (at&n; * your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or&n; * NON INFRINGEMENT.  See the GNU General Public License for more&n; * details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * Send feedback to &lt;colpatch@us.ibm.com&gt;&n; *&n; */
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/mach-summit/mach_mpparse.h&gt;
DECL|variable|__initdata
r_static
r_struct
id|rio_table_hdr
op_star
id|rio_table_hdr
id|__initdata
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|scal_detail
op_star
id|scal_devs
(braket
id|MAX_NUMNODES
)braket
id|__initdata
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|rio_detail
op_star
id|rio_devs
(braket
id|MAX_NUMNODES
op_star
l_int|4
)braket
id|__initdata
suffix:semicolon
DECL|function|setup_pci_node_map_for_wpeg
r_static
r_int
id|__init
id|setup_pci_node_map_for_wpeg
c_func
(paren
r_int
id|wpeg_num
comma
r_int
id|last_bus
)paren
(brace
r_int
id|twister
op_assign
l_int|0
comma
id|node
op_assign
l_int|0
suffix:semicolon
r_int
id|i
comma
id|bus
comma
id|num_buses
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|rio_table_hdr-&gt;num_rio_dev
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|rio_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|node_id
op_eq
id|rio_devs
(braket
id|wpeg_num
)braket
op_member_access_from_pointer
id|owner_id
)paren
(brace
id|twister
op_assign
id|rio_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|owner_id
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
op_eq
id|rio_table_hdr-&gt;num_rio_dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Couldn&squot;t find owner Cyclone for Winnipeg!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|last_bus
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|rio_table_hdr-&gt;num_scal_dev
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|scal_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|node_id
op_eq
id|twister
)paren
(brace
id|node
op_assign
id|scal_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|node_id
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
op_eq
id|rio_table_hdr-&gt;num_scal_dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Couldn&squot;t find owner Twister for Cyclone!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|last_bus
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|rio_devs
(braket
id|wpeg_num
)braket
op_member_access_from_pointer
id|type
)paren
(brace
r_case
id|CompatWPEG
suffix:colon
multiline_comment|/* The Compatability Winnipeg controls the 2 legacy buses,&n;&t;&t; * the 66MHz PCI bus [2 slots] and the 2 &quot;extra&quot; buses in case&n;&t;&t; * a PCI-PCI bridge card is used in either slot: total 5 buses.&n;&t;&t; */
id|num_buses
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AltWPEG
suffix:colon
multiline_comment|/* The Alternate Winnipeg controls the 2 133MHz buses [1 slot&n;&t;&t; * each], their 2 &quot;extra&quot; buses, the 100MHz bus [2 slots] and&n;&t;&t; * the &quot;extra&quot; buses for each of those slots: total 7 buses.&n;&t;&t; */
id|num_buses
op_assign
l_int|7
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LookOutAWPEG
suffix:colon
r_case
id|LookOutBWPEG
suffix:colon
multiline_comment|/* A Lookout Winnipeg controls 3 100MHz buses [2 slots each]&n;&t;&t; * &amp; the &quot;extra&quot; buses for each of those slots: total 9 buses.&n;&t;&t; */
id|num_buses
op_assign
l_int|9
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unsupported Winnipeg type!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|last_bus
suffix:semicolon
)brace
r_for
c_loop
(paren
id|bus
op_assign
id|last_bus
suffix:semicolon
id|bus
OL
id|last_bus
op_plus
id|num_buses
suffix:semicolon
id|bus
op_increment
)paren
(brace
id|mp_bus_id_to_node
(braket
id|bus
)braket
op_assign
id|node
suffix:semicolon
)brace
r_return
id|bus
suffix:semicolon
)brace
DECL|function|build_detail_arrays
r_static
r_int
id|__init
id|build_detail_arrays
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|ptr
suffix:semicolon
r_int
id|i
comma
id|scal_detail_size
comma
id|rio_detail_size
suffix:semicolon
r_if
c_cond
(paren
id|rio_table_hdr-&gt;num_scal_dev
OG
id|MAX_NUMNODES
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: MAX_NUMNODES too low!  Defined as %d, but system has %d nodes.&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|MAX_NUMNODES
comma
id|rio_table_hdr-&gt;num_scal_dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|rio_table_hdr-&gt;version
)paren
(brace
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Invalid Rio Grande Table Version: %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rio_table_hdr-&gt;version
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
l_int|2
suffix:colon
id|scal_detail_size
op_assign
l_int|11
suffix:semicolon
id|rio_detail_size
op_assign
l_int|13
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|scal_detail_size
op_assign
l_int|12
suffix:semicolon
id|rio_detail_size
op_assign
l_int|15
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ptr
op_assign
(paren
r_int
r_int
)paren
id|rio_table_hdr
op_plus
l_int|3
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|rio_table_hdr-&gt;num_scal_dev
suffix:semicolon
id|i
op_increment
comma
id|ptr
op_add_assign
id|scal_detail_size
)paren
(brace
id|scal_devs
(braket
id|i
)braket
op_assign
(paren
r_struct
id|scal_detail
op_star
)paren
id|ptr
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|rio_table_hdr-&gt;num_rio_dev
suffix:semicolon
id|i
op_increment
comma
id|ptr
op_add_assign
id|rio_detail_size
)paren
(brace
id|rio_devs
(braket
id|i
)braket
op_assign
(paren
r_struct
id|rio_detail
op_star
)paren
id|ptr
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|setup_summit
r_void
id|__init
id|setup_summit
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|ptr
suffix:semicolon
r_int
r_int
id|offset
suffix:semicolon
r_int
id|i
comma
id|next_wpeg
comma
id|next_bus
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* The pointer to the EBDA is stored in the word @ phys 0x40E(40:0E) */
id|ptr
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
id|phys_to_virt
c_func
(paren
l_int|0x40Eul
)paren
suffix:semicolon
id|ptr
op_assign
(paren
r_int
r_int
)paren
id|phys_to_virt
c_func
(paren
id|ptr
op_lshift
l_int|4
)paren
suffix:semicolon
id|rio_table_hdr
op_assign
l_int|NULL
suffix:semicolon
id|offset
op_assign
l_int|0x180
suffix:semicolon
r_while
c_loop
(paren
id|offset
)paren
(brace
multiline_comment|/* The block id is stored in the 2nd word */
r_if
c_cond
(paren
op_star
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|ptr
op_plus
id|offset
op_plus
l_int|2
)paren
)paren
op_eq
l_int|0x4752
)paren
(brace
multiline_comment|/* set the pointer past the offset &amp; block id */
id|rio_table_hdr
op_assign
(paren
r_struct
id|rio_table_hdr
op_star
)paren
(paren
id|ptr
op_plus
id|offset
op_plus
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* The next offset is stored in the 1st word.  0 means no more */
id|offset
op_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|ptr
op_plus
id|offset
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|rio_table_hdr
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Unable to locate Rio Grande Table in EBDA - bailing!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|build_detail_arrays
c_func
(paren
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* The first Winnipeg we&squot;re looking for has an index of 0 */
id|next_wpeg
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|rio_table_hdr-&gt;num_rio_dev
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|is_WPEG
c_func
(paren
id|rio_devs
(braket
id|i
)braket
)paren
op_logical_and
id|rio_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|WP_index
op_eq
id|next_wpeg
)paren
(brace
multiline_comment|/* It&squot;s the Winnipeg we&squot;re looking for! */
id|next_bus
op_assign
id|setup_pci_node_map_for_wpeg
c_func
(paren
id|i
comma
id|next_bus
)paren
suffix:semicolon
id|next_wpeg
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t; * If we go through all Rio devices and don&squot;t find one with&n;&t;&t; * the next index, it means we&squot;ve found all the Winnipegs,&n;&t;&t; * and thus all the PCI buses.&n;&t;&t; */
r_if
c_cond
(paren
id|i
op_eq
id|rio_table_hdr-&gt;num_rio_dev
)paren
id|next_wpeg
op_assign
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
id|next_wpeg
op_ne
l_int|0
)paren
suffix:semicolon
)brace
eof
