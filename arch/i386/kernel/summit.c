multiline_comment|/*&n; * arch/i386/kernel/summit.c - IBM Summit-Specific Code&n; *&n; * Written By: Matthew Dobson, IBM Corporation&n; *&n; * Copyright (c) 2003 IBM Corp.&n; *&n; * All rights reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or (at&n; * your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or&n; * NON INFRINGEMENT.  See the GNU General Public License for more&n; * details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * Send feedback to &lt;colpatch@us.ibm.com&gt;&n; *&n; */
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;mach_mpparse.h&gt;
DECL|function|setup_pci_node_map_for_wpeg
r_static
r_void
id|__init
(def_block
id|setup_pci_node_map_for_wpeg
c_func
(paren
r_int
id|wpeg_num
comma
r_struct
id|rio_table_hdr
op_star
id|rth
comma
r_struct
id|scal_detail
op_star
op_star
id|scal_nodes
comma
r_struct
id|rio_detail
op_star
op_star
id|rio_nodes
)paren
(brace
r_int
id|twst_num
op_assign
l_int|0
comma
id|node
op_assign
l_int|0
comma
id|first_bus
op_assign
l_int|0
suffix:semicolon
r_int
id|i
comma
id|bus
comma
id|num_busses
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|rth-&gt;num_rio_dev
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|rio_nodes
(braket
id|i
)braket
op_member_access_from_pointer
id|node_id
op_eq
id|rio_nodes
(braket
id|wpeg_num
)braket
op_member_access_from_pointer
id|owner_id
)paren
(brace
id|twst_num
op_assign
id|rio_nodes
(braket
id|i
)braket
op_member_access_from_pointer
id|owner_id
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
op_eq
id|rth-&gt;num_rio_dev
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Couldn&squot;t find owner Cyclone for Winnipeg!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|rth-&gt;num_scal_dev
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|scal_nodes
(braket
id|i
)braket
op_member_access_from_pointer
id|node_id
op_eq
id|twst_num
)paren
(brace
id|node
op_assign
id|scal_nodes
(braket
id|i
)braket
op_member_access_from_pointer
id|node_id
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
op_eq
id|rth-&gt;num_scal_dev
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Couldn&squot;t find owner Twister for Cyclone!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|rio_nodes
(braket
id|wpeg_num
)braket
op_member_access_from_pointer
id|type
)paren
(brace
r_case
id|CompatWPEG
suffix:colon
multiline_comment|/* The Compatability Winnipeg controls the legacy busses&n;&t;&t;   (busses 0 &amp; 1), the 66MHz PCI bus [2 slots] (bus 2), &n;&t;&t;   and the &quot;extra&quot; busses in case a PCI-PCI bridge card is &n;&t;&t;   used in either slot (busses 3 &amp; 4): total 5 busses. */
id|num_busses
op_assign
l_int|5
suffix:semicolon
multiline_comment|/* The BIOS numbers the busses starting at 1, and in a &n;&t;&t;   slightly wierd manner.  You&squot;ll have to trust that &n;&t;&t;   the math used below to determine the number of the &n;&t;&t;   first bus works. */
id|first_bus
op_assign
(paren
id|rio_nodes
(braket
id|wpeg_num
)braket
op_member_access_from_pointer
id|first_slot
op_minus
l_int|1
)paren
op_star
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AltWPEG
suffix:colon
multiline_comment|/* The Alternate/Secondary Winnipeg controls the 1st 133MHz &n;&t;&t;   bus [1 slot] &amp; its &quot;extra&quot; bus (busses 0 &amp; 1), the 2nd &n;&t;&t;   133MHz bus [1 slot] &amp; its &quot;extra&quot; bus (busses 2 &amp; 3), the &n;&t;&t;   100MHz bus [2 slots] (bus 4), and the &quot;extra&quot; busses for &n;&t;&t;   the 2 100MHz slots (busses 5 &amp; 6): total 7 busses. */
id|num_busses
op_assign
l_int|7
suffix:semicolon
id|first_bus
op_assign
(paren
id|rio_nodes
(braket
id|wpeg_num
)braket
op_member_access_from_pointer
id|first_slot
op_star
l_int|2
)paren
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LookOutAWPEG
suffix:colon
r_case
id|LookOutBWPEG
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: LookOut Winnipegs not supported yet!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Unsupported Winnipeg type!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|bus
op_assign
id|first_bus
suffix:semicolon
id|bus
OL
id|first_bus
op_plus
id|num_busses
suffix:semicolon
id|bus
op_increment
)paren
(brace
id|mp_bus_id_to_node
(braket
id|bus
)braket
op_assign
id|node
suffix:semicolon
)brace
)brace
)def_block
DECL|function|build_detail_arrays
r_static
r_void
id|__init
(def_block
id|build_detail_arrays
c_func
(paren
r_struct
id|rio_table_hdr
op_star
id|rth
comma
r_struct
id|scal_detail
op_star
op_star
id|sd
comma
r_struct
id|rio_detail
op_star
op_star
id|rd
)paren
(brace
r_int
r_int
id|ptr
suffix:semicolon
r_int
id|i
comma
id|scal_detail_size
comma
id|rio_detail_size
suffix:semicolon
r_switch
c_cond
(paren
id|rth-&gt;version
)paren
(brace
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Bad Rio Grande Table Version: %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rth-&gt;version
)paren
suffix:semicolon
multiline_comment|/* Fall through to default to version 2 spec */
r_case
l_int|2
suffix:colon
id|scal_detail_size
op_assign
l_int|11
suffix:semicolon
id|rio_detail_size
op_assign
l_int|13
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|scal_detail_size
op_assign
l_int|12
suffix:semicolon
id|rio_detail_size
op_assign
l_int|15
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ptr
op_assign
(paren
r_int
r_int
)paren
id|rth
op_plus
l_int|3
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|rth-&gt;num_scal_dev
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sd
(braket
id|i
)braket
op_assign
(paren
r_struct
id|scal_detail
op_star
)paren
(paren
id|ptr
op_plus
(paren
id|scal_detail_size
op_star
id|i
)paren
)paren
suffix:semicolon
)brace
id|ptr
op_add_assign
id|scal_detail_size
op_star
id|rth-&gt;num_scal_dev
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|rth-&gt;num_rio_dev
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rd
(braket
id|i
)braket
op_assign
(paren
r_struct
id|rio_detail
op_star
)paren
(paren
id|ptr
op_plus
(paren
id|rio_detail_size
op_star
id|i
)paren
)paren
suffix:semicolon
)brace
)brace
)def_block
DECL|function|setup_summit
r_void
id|__init
id|setup_summit
c_func
(paren
r_void
)paren
(brace
r_struct
id|rio_table_hdr
op_star
id|rio_table_hdr
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|scal_detail
op_star
id|scal_devs
(braket
id|MAX_NUMNODES
)braket
suffix:semicolon
r_struct
id|rio_detail
op_star
id|rio_devs
(braket
id|MAX_NUMNODES
op_star
l_int|2
)braket
suffix:semicolon
r_int
r_int
id|ptr
suffix:semicolon
r_int
r_int
id|offset
suffix:semicolon
r_int
id|i
suffix:semicolon
id|memset
c_func
(paren
id|mp_bus_id_to_node
comma
op_minus
l_int|1
comma
r_sizeof
(paren
id|mp_bus_id_to_node
)paren
)paren
suffix:semicolon
multiline_comment|/* The pointer to the EBDA is stored in the word @ phys 0x40E(40:0E) */
id|ptr
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
id|phys_to_virt
c_func
(paren
l_int|0x40Eul
)paren
suffix:semicolon
id|ptr
op_assign
(paren
r_int
r_int
)paren
id|phys_to_virt
c_func
(paren
id|ptr
op_lshift
l_int|4
)paren
suffix:semicolon
id|offset
op_assign
l_int|0x180
suffix:semicolon
r_while
c_loop
(paren
id|offset
)paren
(brace
multiline_comment|/* The block id is stored in the 2nd word */
r_if
c_cond
(paren
op_star
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|ptr
op_plus
id|offset
op_plus
l_int|2
)paren
)paren
op_eq
l_int|0x4752
)paren
(brace
multiline_comment|/* set the pointer past the offset &amp; block id */
id|rio_table_hdr
op_assign
(paren
r_struct
id|rio_table_hdr
op_star
)paren
(paren
id|ptr
op_plus
id|offset
op_plus
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* The next offset is stored in the 1st word.  0 means no more */
id|offset
op_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|ptr
op_plus
id|offset
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|rio_table_hdr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Unable to locate Rio Grande Table in EBDA - bailing!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Deal with the ugly version 2/3 pointer arithmetic */
id|build_detail_arrays
c_func
(paren
id|rio_table_hdr
comma
id|scal_devs
comma
id|rio_devs
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|rio_table_hdr-&gt;num_rio_dev
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|is_WPEG
c_func
(paren
id|rio_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|type
)paren
)paren
multiline_comment|/* It&squot;s a Winnipeg, it&squot;s got PCI Busses */
id|setup_pci_node_map_for_wpeg
c_func
(paren
id|i
comma
id|rio_table_hdr
comma
id|scal_devs
comma
id|rio_devs
)paren
suffix:semicolon
)brace
eof
