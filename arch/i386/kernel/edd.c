multiline_comment|/*&n; * linux/arch/i386/kernel/edd.c&n; *  Copyright (C) 2002 Dell Computer Corporation&n; *  by Matt Domsch &lt;Matt_Domsch@dell.com&gt;&n; *&n; * BIOS Enhanced Disk Drive Services (EDD)&n; * conformant to T13 Committee www.t13.org&n; *   projects 1572D, 1484D, 1386D, 1226DT&n; *&n; * This code takes information provided by BIOS EDD calls&n; * fn41 - Check Extensions Present and&n; * fn48 - Get Device Parametes with EDD extensions&n; * made in setup.S, copied to safe structures in setup.c,&n; * and presents it in driverfs.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License v2.0 as published by&n; * the Free Software Foundation&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; */
multiline_comment|/*&n; * Known issues:&n; * - refcounting of struct device objects could be improved.&n; *&n; * TODO:&n; * - Add IDE and USB disk device support&n; * - Get symlink creator helper functions exported from&n; *   drivers/base instead of duplicating them here.&n; * - move edd.[ch] to better locations if/when one is decided&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/err.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/limits.h&gt;
macro_line|#include &lt;linux/driverfs_fs.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/edd.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
multiline_comment|/* FIXME - this really belongs in include/scsi/scsi.h */
macro_line|#include &lt;../drivers/scsi/scsi.h&gt;
macro_line|#include &lt;../drivers/scsi/hosts.h&gt;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Matt Domsch &lt;Matt_Domsch@Dell.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;driverfs interface to BIOS EDD information&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|macro|EDD_VERSION
mdefine_line|#define EDD_VERSION &quot;0.07 2002-Oct-24&quot;
DECL|macro|EDD_DEVICE_NAME_SIZE
mdefine_line|#define EDD_DEVICE_NAME_SIZE 16
DECL|macro|REPORT_URL
mdefine_line|#define REPORT_URL &quot;http:
singleline_comment|//domsch.com/linux/edd30/results.html&quot;
DECL|macro|left
mdefine_line|#define left (count - (p - buf) - 1)
multiline_comment|/*&n; * bios_dir may go away completely,&n; * and it definitely won&squot;t be at the root&n; * of driverfs forever.&n; */
DECL|variable|bios_dir
r_static
r_struct
id|driver_dir_entry
id|bios_dir
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;bios&quot;
comma
dot
id|mode
op_assign
(paren
id|S_IFDIR
op_or
id|S_IRWXU
op_or
id|S_IRUGO
op_or
id|S_IXUGO
)paren
comma
)brace
suffix:semicolon
DECL|struct|edd_device
r_struct
id|edd_device
(brace
DECL|member|name
r_char
id|name
(braket
id|EDD_DEVICE_NAME_SIZE
)braket
suffix:semicolon
DECL|member|info
r_struct
id|edd_info
op_star
id|info
suffix:semicolon
DECL|member|dir
r_struct
id|driver_dir_entry
id|dir
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|edd_attribute
r_struct
id|edd_attribute
(brace
DECL|member|attr
r_struct
id|attribute
id|attr
suffix:semicolon
DECL|member|show
id|ssize_t
c_func
(paren
op_star
id|show
)paren
(paren
r_struct
id|edd_device
op_star
id|edev
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
id|off
)paren
suffix:semicolon
DECL|member|test
r_int
(paren
op_star
id|test
)paren
(paren
r_struct
id|edd_device
op_star
id|edev
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* forward declarations */
r_static
r_int
id|edd_dev_is_type
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
comma
r_const
r_char
op_star
id|type
)paren
suffix:semicolon
r_static
r_struct
id|pci_dev
op_star
id|edd_get_pci_dev
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
)paren
suffix:semicolon
r_static
r_struct
id|scsi_device
op_star
id|edd_find_matching_scsi_device
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
)paren
suffix:semicolon
DECL|variable|edd_devices
r_static
r_struct
id|edd_device
op_star
id|edd_devices
(braket
id|EDDMAXNR
)braket
suffix:semicolon
DECL|macro|EDD_DEVICE_ATTR
mdefine_line|#define EDD_DEVICE_ATTR(_name,_mode,_show,_test) &bslash;&n;struct edd_attribute edd_attr_##_name = { &t;&bslash;&n;&t;.attr = {.name = __stringify(_name), .mode = _mode },&t;&bslash;&n;&t;.show&t;= _show,&t;&t;&t;&t;&bslash;&n;&t;.test&t;= _test,&t;&t;&t;&t;&bslash;&n;};
r_static
r_inline
r_struct
id|edd_info
op_star
DECL|function|edd_dev_get_info
id|edd_dev_get_info
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
)paren
(brace
r_return
id|edev-&gt;info
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|edd_dev_set_info
id|edd_dev_set_info
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
comma
r_struct
id|edd_info
op_star
id|info
)paren
(brace
id|edev-&gt;info
op_assign
id|info
suffix:semicolon
)brace
DECL|macro|to_edd_attr
mdefine_line|#define to_edd_attr(_attr) container_of(_attr,struct edd_attribute,attr)
DECL|macro|to_edd_device
mdefine_line|#define to_edd_device(_dir) container_of(_dir,struct edd_device,dir)
r_static
id|ssize_t
DECL|function|edd_attr_show
id|edd_attr_show
c_func
(paren
r_struct
id|driver_dir_entry
op_star
id|dir
comma
r_struct
id|attribute
op_star
id|attr
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
id|off
)paren
(brace
r_struct
id|edd_device
op_star
id|dev
op_assign
id|to_edd_device
c_func
(paren
id|dir
)paren
suffix:semicolon
r_struct
id|edd_attribute
op_star
id|edd_attr
op_assign
id|to_edd_attr
c_func
(paren
id|attr
)paren
suffix:semicolon
id|ssize_t
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|edd_attr-&gt;show
)paren
id|ret
op_assign
id|edd_attr
op_member_access_from_pointer
id|show
c_func
(paren
id|dev
comma
id|buf
comma
id|count
comma
id|off
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|edd_attr_ops
r_static
r_struct
id|driverfs_ops
id|edd_attr_ops
op_assign
(brace
dot
id|show
op_assign
id|edd_attr_show
comma
)brace
suffix:semicolon
r_static
r_int
DECL|function|edd_dump_raw_data
id|edd_dump_raw_data
c_func
(paren
r_char
op_star
id|b
comma
r_int
id|count
comma
r_void
op_star
id|data
comma
r_int
id|length
)paren
(brace
r_char
op_star
id|orig_b
op_assign
id|b
suffix:semicolon
r_char
id|hexbuf
(braket
l_int|80
)braket
comma
id|ascbuf
(braket
l_int|20
)braket
comma
op_star
id|h
comma
op_star
id|a
comma
id|c
suffix:semicolon
r_int
r_char
op_star
id|p
op_assign
id|data
suffix:semicolon
r_int
r_int
id|column
op_assign
l_int|0
suffix:semicolon
r_int
id|length_printed
op_assign
l_int|0
comma
id|d
suffix:semicolon
r_const
r_char
id|maxcolumn
op_assign
l_int|16
suffix:semicolon
r_while
c_loop
(paren
id|length_printed
template_param
l_int|0
)paren
(brace
id|h
op_assign
id|hexbuf
suffix:semicolon
id|a
op_assign
id|ascbuf
suffix:semicolon
r_for
c_loop
(paren
id|column
op_assign
l_int|0
suffix:semicolon
id|column
OL
id|maxcolumn
op_logical_and
id|length_printed
OL
id|length
suffix:semicolon
id|column
op_increment
)paren
(brace
id|h
op_add_assign
id|sprintf
c_func
(paren
id|h
comma
l_string|&quot;%02x &quot;
comma
(paren
r_int
r_char
)paren
op_star
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|isprint
c_func
(paren
op_star
id|p
)paren
)paren
id|c
op_assign
l_char|&squot;.&squot;
suffix:semicolon
r_else
id|c
op_assign
op_star
id|p
suffix:semicolon
id|a
op_add_assign
id|sprintf
c_func
(paren
id|a
comma
l_string|&quot;%c&quot;
comma
id|c
)paren
suffix:semicolon
id|p
op_increment
suffix:semicolon
id|length_printed
op_increment
suffix:semicolon
)brace
multiline_comment|/* pad out the line */
r_for
c_loop
(paren
suffix:semicolon
id|column
OL
id|maxcolumn
suffix:semicolon
id|column
op_increment
)paren
(brace
id|h
op_add_assign
id|sprintf
c_func
(paren
id|h
comma
l_string|&quot;   &quot;
)paren
suffix:semicolon
id|a
op_add_assign
id|sprintf
c_func
(paren
id|a
comma
l_string|&quot; &quot;
)paren
suffix:semicolon
)brace
id|d
op_assign
id|snprintf
c_func
(paren
id|b
comma
id|count
comma
l_string|&quot;%s&bslash;t%s&bslash;n&quot;
comma
id|hexbuf
comma
id|ascbuf
)paren
suffix:semicolon
id|b
op_add_assign
id|d
suffix:semicolon
id|count
op_sub_assign
id|d
suffix:semicolon
)brace
r_return
(paren
id|b
op_minus
id|orig_b
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|edd_show_host_bus
id|edd_show_host_bus
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
id|off
)paren
(brace
r_struct
id|edd_info
op_star
id|info
op_assign
id|edd_dev_get_info
c_func
(paren
id|edev
)paren
suffix:semicolon
r_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edev
op_logical_or
op_logical_neg
id|info
op_logical_or
op_logical_neg
id|buf
op_logical_or
id|off
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|isprint
c_func
(paren
id|info-&gt;params.host_bus_type
(braket
id|i
)braket
)paren
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;%c&quot;
comma
id|info-&gt;params.host_bus_type
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot; &quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|info-&gt;params.host_bus_type
comma
l_string|&quot;ISA&quot;
comma
l_int|3
)paren
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;&bslash;tbase_address: %x&bslash;n&quot;
comma
id|info-&gt;params.interface_path.isa.base_address
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|info-&gt;params.host_bus_type
comma
l_string|&quot;PCIX&quot;
comma
l_int|4
)paren
op_logical_or
op_logical_neg
id|strncmp
c_func
(paren
id|info-&gt;params.host_bus_type
comma
l_string|&quot;PCI&quot;
comma
l_int|3
)paren
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;&bslash;t%02x:%02x.%d  channel: %u&bslash;n&quot;
comma
id|info-&gt;params.interface_path.pci.bus
comma
id|info-&gt;params.interface_path.pci.slot
comma
id|info-&gt;params.interface_path.pci.function
comma
id|info-&gt;params.interface_path.pci.channel
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|info-&gt;params.host_bus_type
comma
l_string|&quot;IBND&quot;
comma
l_int|4
)paren
op_logical_or
op_logical_neg
id|strncmp
c_func
(paren
id|info-&gt;params.host_bus_type
comma
l_string|&quot;XPRS&quot;
comma
l_int|4
)paren
op_logical_or
op_logical_neg
id|strncmp
c_func
(paren
id|info-&gt;params.host_bus_type
comma
l_string|&quot;HTPT&quot;
comma
l_int|4
)paren
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;&bslash;tTBD: %llx&bslash;n&quot;
comma
id|info-&gt;params.interface_path.ibnd.reserved
)paren
suffix:semicolon
)brace
r_else
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;&bslash;tunknown: %llx&bslash;n&quot;
comma
id|info-&gt;params.interface_path.unknown.reserved
)paren
suffix:semicolon
)brace
r_return
(paren
id|p
op_minus
id|buf
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|edd_show_interface
id|edd_show_interface
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
id|off
)paren
(brace
r_struct
id|edd_info
op_star
id|info
op_assign
id|edd_dev_get_info
c_func
(paren
id|edev
)paren
suffix:semicolon
r_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edev
op_logical_or
op_logical_neg
id|info
op_logical_or
op_logical_neg
id|buf
op_logical_or
id|off
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|isprint
c_func
(paren
id|info-&gt;params.interface_type
(braket
id|i
)braket
)paren
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;%c&quot;
comma
id|info-&gt;params.interface_type
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot; &quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|info-&gt;params.interface_type
comma
l_string|&quot;ATAPI&quot;
comma
l_int|5
)paren
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;&bslash;tdevice: %u  lun: %u&bslash;n&quot;
comma
id|info-&gt;params.device_path.atapi.device
comma
id|info-&gt;params.device_path.atapi.lun
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|info-&gt;params.interface_type
comma
l_string|&quot;ATA&quot;
comma
l_int|3
)paren
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;&bslash;tdevice: %u&bslash;n&quot;
comma
id|info-&gt;params.device_path.ata.device
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|info-&gt;params.interface_type
comma
l_string|&quot;SCSI&quot;
comma
l_int|4
)paren
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;&bslash;tid: %u  lun: %llu&bslash;n&quot;
comma
id|info-&gt;params.device_path.scsi.id
comma
id|info-&gt;params.device_path.scsi.lun
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|info-&gt;params.interface_type
comma
l_string|&quot;USB&quot;
comma
l_int|3
)paren
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;&bslash;tserial_number: %llx&bslash;n&quot;
comma
id|info-&gt;params.device_path.usb.serial_number
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|info-&gt;params.interface_type
comma
l_string|&quot;1394&quot;
comma
l_int|4
)paren
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;&bslash;teui: %llx&bslash;n&quot;
comma
id|info-&gt;params.device_path.i1394.eui
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|info-&gt;params.interface_type
comma
l_string|&quot;FIBRE&quot;
comma
l_int|5
)paren
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;&bslash;twwid: %llx lun: %llx&bslash;n&quot;
comma
id|info-&gt;params.device_path.fibre.wwid
comma
id|info-&gt;params.device_path.fibre.lun
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|info-&gt;params.interface_type
comma
l_string|&quot;I2O&quot;
comma
l_int|3
)paren
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;&bslash;tidentity_tag: %llx&bslash;n&quot;
comma
id|info-&gt;params.device_path.i2o.identity_tag
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|info-&gt;params.interface_type
comma
l_string|&quot;RAID&quot;
comma
l_int|4
)paren
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;&bslash;tidentity_tag: %x&bslash;n&quot;
comma
id|info-&gt;params.device_path.raid.array_number
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|info-&gt;params.interface_type
comma
l_string|&quot;SATA&quot;
comma
l_int|4
)paren
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;&bslash;tdevice: %u&bslash;n&quot;
comma
id|info-&gt;params.device_path.sata.device
)paren
suffix:semicolon
)brace
r_else
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;&bslash;tunknown: %llx %llx&bslash;n&quot;
comma
id|info-&gt;params.device_path.unknown.reserved1
comma
id|info-&gt;params.device_path.unknown.reserved2
)paren
suffix:semicolon
)brace
r_return
(paren
id|p
op_minus
id|buf
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * edd_show_raw_data() - unparses EDD information, returned to user-space&n; *&n; * Returns: number of bytes written, or 0 on failure&n; */
r_static
id|ssize_t
DECL|function|edd_show_raw_data
id|edd_show_raw_data
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
id|off
)paren
(brace
r_struct
id|edd_info
op_star
id|info
op_assign
id|edd_dev_get_info
c_func
(paren
id|edev
)paren
suffix:semicolon
r_int
id|i
comma
id|rc
comma
id|warn_padding
op_assign
l_int|0
comma
id|email
op_assign
l_int|0
comma
id|nonzero_path
op_assign
l_int|0
comma
id|len
op_assign
r_sizeof
(paren
op_star
id|edd
)paren
op_minus
l_int|4
comma
id|found_pci
op_assign
l_int|0
suffix:semicolon
r_uint8
id|checksum
op_assign
l_int|0
comma
id|c
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pci_dev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|scsi_device
op_star
id|sd
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edev
op_logical_or
op_logical_neg
id|info
op_logical_or
op_logical_neg
id|buf
op_logical_or
id|off
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;params.key
op_eq
l_int|0xBEDD
op_logical_or
id|info-&gt;params.key
op_eq
l_int|0xDDBE
)paren
)paren
id|len
op_assign
id|info-&gt;params.length
suffix:semicolon
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;int13 fn48 returned data:&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|edd_dump_raw_data
c_func
(paren
id|p
comma
id|left
comma
(paren
(paren
r_char
op_star
)paren
id|edd
)paren
op_plus
l_int|4
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Spec violation.  Adaptec AIC7899 returns 0xDDBE&n;&t;   here, when it should be 0xBEDD.&n;&t; */
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.key
op_eq
l_int|0xDDBE
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;Warning: Spec violation.  Key should be 0xBEDD, is 0xDDBE&bslash;n&quot;
)paren
suffix:semicolon
id|email
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;params.key
op_eq
l_int|0xBEDD
op_logical_or
id|info-&gt;params.key
op_eq
l_int|0xDDBE
)paren
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|30
suffix:semicolon
id|i
op_le
l_int|73
suffix:semicolon
id|i
op_increment
)paren
(brace
id|c
op_assign
op_star
(paren
(paren
(paren
r_uint8
op_star
)paren
id|edd
)paren
op_plus
id|i
op_plus
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
)paren
id|nonzero_path
op_increment
suffix:semicolon
id|checksum
op_add_assign
id|c
suffix:semicolon
)brace
r_if
c_cond
(paren
id|checksum
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;Warning: Spec violation.  Device Path checksum invalid.&bslash;n&quot;
)paren
suffix:semicolon
id|email
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|nonzero_path
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;Error: Spec violation.  Empty device path.&bslash;n&quot;
)paren
suffix:semicolon
id|email
op_increment
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|isprint
c_func
(paren
id|info-&gt;params.host_bus_type
(braket
id|i
)braket
)paren
)paren
(brace
id|warn_padding
op_increment
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|isprint
c_func
(paren
id|info-&gt;params.interface_type
(braket
id|i
)braket
)paren
)paren
(brace
id|warn_padding
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|warn_padding
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;Warning: Spec violation.  Padding should be 0x20.&bslash;n&quot;
)paren
suffix:semicolon
id|email
op_increment
suffix:semicolon
)brace
id|rc
op_assign
id|edd_dev_is_type
c_func
(paren
id|edev
comma
l_string|&quot;PCI&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
id|pci_dev
op_assign
id|pci_find_slot
c_func
(paren
id|info-&gt;params.interface_path.pci.bus
comma
id|PCI_DEVFN
c_func
(paren
id|info-&gt;params.interface_path
dot
id|pci.slot
comma
id|info-&gt;params.interface_path
dot
id|pci.function
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_dev
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;Error: BIOS says this is a PCI device, but the OS doesn&squot;t know&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;  about a PCI device at %02x:%02x.%d&bslash;n&quot;
comma
id|info-&gt;params.interface_path.pci.bus
comma
id|info-&gt;params.interface_path.pci.slot
comma
id|info-&gt;params.interface_path.pci.function
)paren
suffix:semicolon
id|email
op_increment
suffix:semicolon
)brace
r_else
(brace
id|found_pci
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|found_pci
op_logical_and
op_logical_neg
id|edd_dev_is_type
c_func
(paren
id|edev
comma
l_string|&quot;SCSI&quot;
)paren
)paren
(brace
id|sd
op_assign
id|edd_find_matching_scsi_device
c_func
(paren
id|edev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sd
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;Error: BIOS says this is a SCSI device, but&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;  the OS doesn&squot;t know about this SCSI device.&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;  Do you have it&squot;s driver module loaded?&bslash;n&quot;
)paren
suffix:semicolon
id|email
op_increment
suffix:semicolon
)brace
)brace
id|out
suffix:colon
r_if
c_cond
(paren
id|email
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;&bslash;nPlease check %s&bslash;n&quot;
comma
id|REPORT_URL
)paren
suffix:semicolon
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;to see if this has been reported.  If not,&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;please send the information requested there.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
(paren
id|p
op_minus
id|buf
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|edd_show_version
id|edd_show_version
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
id|off
)paren
(brace
r_struct
id|edd_info
op_star
id|info
op_assign
id|edd_dev_get_info
c_func
(paren
id|edev
)paren
suffix:semicolon
r_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edev
op_logical_or
op_logical_neg
id|info
op_logical_or
op_logical_neg
id|buf
op_logical_or
id|off
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;0x%02x&bslash;n&quot;
comma
id|info-&gt;version
)paren
suffix:semicolon
r_return
(paren
id|p
op_minus
id|buf
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|edd_show_extensions
id|edd_show_extensions
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
id|off
)paren
(brace
r_struct
id|edd_info
op_star
id|info
op_assign
id|edd_dev_get_info
c_func
(paren
id|edev
)paren
suffix:semicolon
r_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edev
op_logical_or
op_logical_neg
id|info
op_logical_or
op_logical_neg
id|buf
op_logical_or
id|off
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;interface_support
op_amp
id|EDD_EXT_FIXED_DISK_ACCESS
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;Fixed disk access&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;interface_support
op_amp
id|EDD_EXT_DEVICE_LOCKING_AND_EJECTING
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;Device locking and ejecting&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;interface_support
op_amp
id|EDD_EXT_ENHANCED_DISK_DRIVE_SUPPORT
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;Enhanced Disk Drive support&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;interface_support
op_amp
id|EDD_EXT_64BIT_EXTENSIONS
)paren
(brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;64-bit extensions&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
(paren
id|p
op_minus
id|buf
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|edd_show_info_flags
id|edd_show_info_flags
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
id|off
)paren
(brace
r_struct
id|edd_info
op_star
id|info
op_assign
id|edd_dev_get_info
c_func
(paren
id|edev
)paren
suffix:semicolon
r_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edev
op_logical_or
op_logical_neg
id|info
op_logical_or
op_logical_neg
id|buf
op_logical_or
id|off
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;params.info_flags
op_amp
id|EDD_INFO_DMA_BOUNDRY_ERROR_TRANSPARENT
)paren
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;DMA boundry error transparent&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.info_flags
op_amp
id|EDD_INFO_GEOMETRY_VALID
)paren
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;geometry valid&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.info_flags
op_amp
id|EDD_INFO_REMOVABLE
)paren
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;removable&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.info_flags
op_amp
id|EDD_INFO_WRITE_VERIFY
)paren
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;write verify&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.info_flags
op_amp
id|EDD_INFO_MEDIA_CHANGE_NOTIFICATION
)paren
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;media change notification&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.info_flags
op_amp
id|EDD_INFO_LOCKABLE
)paren
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;lockable&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.info_flags
op_amp
id|EDD_INFO_NO_MEDIA_PRESENT
)paren
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;no media present&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.info_flags
op_amp
id|EDD_INFO_USE_INT13_FN50
)paren
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;use int13 fn50&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|p
op_minus
id|buf
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|edd_show_default_cylinders
id|edd_show_default_cylinders
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
id|off
)paren
(brace
r_struct
id|edd_info
op_star
id|info
op_assign
id|edd_dev_get_info
c_func
(paren
id|edev
)paren
suffix:semicolon
r_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edev
op_logical_or
op_logical_neg
id|info
op_logical_or
op_logical_neg
id|buf
op_logical_or
id|off
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;0x%x&bslash;n&quot;
comma
id|info-&gt;params.num_default_cylinders
)paren
suffix:semicolon
r_return
(paren
id|p
op_minus
id|buf
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|edd_show_default_heads
id|edd_show_default_heads
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
id|off
)paren
(brace
r_struct
id|edd_info
op_star
id|info
op_assign
id|edd_dev_get_info
c_func
(paren
id|edev
)paren
suffix:semicolon
r_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edev
op_logical_or
op_logical_neg
id|info
op_logical_or
op_logical_neg
id|buf
op_logical_or
id|off
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;0x%x&bslash;n&quot;
comma
id|info-&gt;params.num_default_heads
)paren
suffix:semicolon
r_return
(paren
id|p
op_minus
id|buf
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|edd_show_default_sectors_per_track
id|edd_show_default_sectors_per_track
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
id|off
)paren
(brace
r_struct
id|edd_info
op_star
id|info
op_assign
id|edd_dev_get_info
c_func
(paren
id|edev
)paren
suffix:semicolon
r_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edev
op_logical_or
op_logical_neg
id|info
op_logical_or
op_logical_neg
id|buf
op_logical_or
id|off
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;0x%x&bslash;n&quot;
comma
id|info-&gt;params.sectors_per_track
)paren
suffix:semicolon
r_return
(paren
id|p
op_minus
id|buf
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|edd_show_sectors
id|edd_show_sectors
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
id|off
)paren
(brace
r_struct
id|edd_info
op_star
id|info
op_assign
id|edd_dev_get_info
c_func
(paren
id|edev
)paren
suffix:semicolon
r_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edev
op_logical_or
op_logical_neg
id|info
op_logical_or
op_logical_neg
id|buf
op_logical_or
id|off
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|p
op_add_assign
id|snprintf
c_func
(paren
id|p
comma
id|left
comma
l_string|&quot;0x%llx&bslash;n&quot;
comma
id|info-&gt;params.number_of_sectors
)paren
suffix:semicolon
r_return
(paren
id|p
op_minus
id|buf
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Some device instances may not have all the above attributes,&n; * or the attribute values may be meaningless (i.e. if&n; * the device is &lt; EDD 3.0, it won&squot;t have host_bus and interface&n; * information), so don&squot;t bother making files for them.  Likewise&n; * if the default_{cylinders,heads,sectors_per_track} values&n; * are zero, the BIOS doesn&squot;t provide sane values, don&squot;t bother&n; * creating files for them either.&n; */
r_static
r_int
DECL|function|edd_has_default_cylinders
id|edd_has_default_cylinders
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
)paren
(brace
r_struct
id|edd_info
op_star
id|info
op_assign
id|edd_dev_get_info
c_func
(paren
id|edev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edev
op_logical_or
op_logical_neg
id|info
)paren
r_return
l_int|1
suffix:semicolon
r_return
op_logical_neg
id|info-&gt;params.num_default_cylinders
suffix:semicolon
)brace
r_static
r_int
DECL|function|edd_has_default_heads
id|edd_has_default_heads
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
)paren
(brace
r_struct
id|edd_info
op_star
id|info
op_assign
id|edd_dev_get_info
c_func
(paren
id|edev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edev
op_logical_or
op_logical_neg
id|info
)paren
r_return
l_int|1
suffix:semicolon
r_return
op_logical_neg
id|info-&gt;params.num_default_heads
suffix:semicolon
)brace
r_static
r_int
DECL|function|edd_has_default_sectors_per_track
id|edd_has_default_sectors_per_track
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
)paren
(brace
r_struct
id|edd_info
op_star
id|info
op_assign
id|edd_dev_get_info
c_func
(paren
id|edev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edev
op_logical_or
op_logical_neg
id|info
)paren
r_return
l_int|1
suffix:semicolon
r_return
op_logical_neg
id|info-&gt;params.sectors_per_track
suffix:semicolon
)brace
r_static
r_int
DECL|function|edd_has_edd30
id|edd_has_edd30
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
)paren
(brace
r_struct
id|edd_info
op_star
id|info
op_assign
id|edd_dev_get_info
c_func
(paren
id|edev
)paren
suffix:semicolon
r_int
id|i
comma
id|nonzero_path
op_assign
l_int|0
suffix:semicolon
r_char
id|c
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edev
op_logical_or
op_logical_neg
id|info
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;params.key
op_eq
l_int|0xBEDD
op_logical_or
id|info-&gt;params.key
op_eq
l_int|0xDDBE
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|30
suffix:semicolon
id|i
op_le
l_int|73
suffix:semicolon
id|i
op_increment
)paren
(brace
id|c
op_assign
op_star
(paren
(paren
(paren
r_uint8
op_star
)paren
id|edd
)paren
op_plus
id|i
op_plus
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
)paren
(brace
id|nonzero_path
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|nonzero_path
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
id|EDD_DEVICE_ATTR
c_func
(paren
id|raw_data
comma
l_int|0444
comma
id|edd_show_raw_data
comma
l_int|NULL
)paren
suffix:semicolon
r_static
id|EDD_DEVICE_ATTR
c_func
(paren
id|version
comma
l_int|0444
comma
id|edd_show_version
comma
l_int|NULL
)paren
suffix:semicolon
r_static
id|EDD_DEVICE_ATTR
c_func
(paren
id|extensions
comma
l_int|0444
comma
id|edd_show_extensions
comma
l_int|NULL
)paren
suffix:semicolon
r_static
id|EDD_DEVICE_ATTR
c_func
(paren
id|info_flags
comma
l_int|0444
comma
id|edd_show_info_flags
comma
l_int|NULL
)paren
suffix:semicolon
r_static
id|EDD_DEVICE_ATTR
c_func
(paren
id|sectors
comma
l_int|0444
comma
id|edd_show_sectors
comma
l_int|NULL
)paren
suffix:semicolon
r_static
id|EDD_DEVICE_ATTR
c_func
(paren
id|default_cylinders
comma
l_int|0444
comma
id|edd_show_default_cylinders
comma
id|edd_has_default_cylinders
)paren
suffix:semicolon
r_static
id|EDD_DEVICE_ATTR
c_func
(paren
id|default_heads
comma
l_int|0444
comma
id|edd_show_default_heads
comma
id|edd_has_default_heads
)paren
suffix:semicolon
r_static
id|EDD_DEVICE_ATTR
c_func
(paren
id|default_sectors_per_track
comma
l_int|0444
comma
id|edd_show_default_sectors_per_track
comma
id|edd_has_default_sectors_per_track
)paren
suffix:semicolon
r_static
id|EDD_DEVICE_ATTR
c_func
(paren
id|interface
comma
l_int|0444
comma
id|edd_show_interface
comma
id|edd_has_edd30
)paren
suffix:semicolon
r_static
id|EDD_DEVICE_ATTR
c_func
(paren
id|host_bus
comma
l_int|0444
comma
id|edd_show_host_bus
comma
id|edd_has_edd30
)paren
suffix:semicolon
DECL|variable|def_attrs
r_static
r_struct
id|edd_attribute
op_star
id|def_attrs
(braket
)braket
op_assign
(brace
op_amp
id|edd_attr_raw_data
comma
op_amp
id|edd_attr_version
comma
op_amp
id|edd_attr_extensions
comma
op_amp
id|edd_attr_info_flags
comma
op_amp
id|edd_attr_sectors
comma
op_amp
id|edd_attr_default_cylinders
comma
op_amp
id|edd_attr_default_heads
comma
op_amp
id|edd_attr_default_sectors_per_track
comma
op_amp
id|edd_attr_interface
comma
op_amp
id|edd_attr_host_bus
comma
l_int|NULL
comma
)brace
suffix:semicolon
multiline_comment|/* edd_get_devpath_length(), edd_fill_devpath(), and edd_device_link()&n;   were taken from linux/drivers/base/fs/device.c.  When these&n;   or similar are exported to generic code, remove these.&n;*/
r_static
r_int
DECL|function|edd_get_devpath_length
id|edd_get_devpath_length
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|length
op_assign
l_int|1
suffix:semicolon
r_struct
id|device
op_star
id|parent
op_assign
id|dev
suffix:semicolon
multiline_comment|/* walk up the ancestors until we hit the root.&n;&t; * Add 1 to strlen for leading &squot;/&squot; of each level.&n;&t; */
r_do
(brace
id|length
op_add_assign
id|strlen
c_func
(paren
id|parent-&gt;bus_id
)paren
op_plus
l_int|1
suffix:semicolon
id|parent
op_assign
id|parent-&gt;parent
suffix:semicolon
)brace
r_while
c_loop
(paren
id|parent
)paren
suffix:semicolon
r_return
id|length
suffix:semicolon
)brace
r_static
r_void
DECL|function|edd_fill_devpath
id|edd_fill_devpath
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|path
comma
r_int
id|length
)paren
(brace
r_struct
id|device
op_star
id|parent
suffix:semicolon
op_decrement
id|length
suffix:semicolon
r_for
c_loop
(paren
id|parent
op_assign
id|dev
suffix:semicolon
id|parent
suffix:semicolon
id|parent
op_assign
id|parent-&gt;parent
)paren
(brace
r_int
id|cur
op_assign
id|strlen
c_func
(paren
id|parent-&gt;bus_id
)paren
suffix:semicolon
multiline_comment|/* back up enough to print this bus id with &squot;/&squot; */
id|length
op_sub_assign
id|cur
suffix:semicolon
id|strncpy
c_func
(paren
id|path
op_plus
id|length
comma
id|parent-&gt;bus_id
comma
id|cur
)paren
suffix:semicolon
op_star
(paren
id|path
op_plus
op_decrement
id|length
)paren
op_assign
l_char|&squot;/&squot;
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|edd_device_symlink
id|edd_device_symlink
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
comma
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|name
)paren
(brace
r_char
op_star
id|path
suffix:semicolon
r_int
id|length
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;bus
op_logical_or
op_logical_neg
id|name
)paren
r_return
l_int|0
suffix:semicolon
id|length
op_assign
id|edd_get_devpath_length
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* now add the path from the edd_device directory&n;&t; * It should be &squot;../..&squot; (one to get to the &squot;bios&squot; directory,&n;&t; * and one to get to the root of the fs.)&n;&t; */
id|length
op_add_assign
id|strlen
c_func
(paren
l_string|&quot;../../root&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
id|PATH_MAX
)paren
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|path
op_assign
id|kmalloc
c_func
(paren
id|length
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|path
comma
l_int|0
comma
id|length
)paren
suffix:semicolon
multiline_comment|/* our relative position */
id|strcpy
c_func
(paren
id|path
comma
l_string|&quot;../../root&quot;
)paren
suffix:semicolon
id|edd_fill_devpath
c_func
(paren
id|dev
comma
id|path
comma
id|length
)paren
suffix:semicolon
id|error
op_assign
id|driverfs_create_symlink
c_func
(paren
op_amp
id|edev-&gt;dir
comma
id|name
comma
id|path
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|path
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/**&n; * edd_dev_is_type() - is this EDD device a &squot;type&squot; device?&n; * @edev&n; * @type - a host bus or interface identifier string per the EDD spec&n; *&n; * Returns 0 if it is a &squot;type&squot; device, nonzero otherwise.&n; */
r_static
r_int
DECL|function|edd_dev_is_type
id|edd_dev_is_type
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
comma
r_const
r_char
op_star
id|type
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|edd_info
op_star
id|info
op_assign
id|edd_dev_get_info
c_func
(paren
id|edev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edev
op_logical_or
op_logical_neg
id|info
)paren
r_return
l_int|1
suffix:semicolon
id|rc
op_assign
id|strncmp
c_func
(paren
id|info-&gt;params.host_bus_type
comma
id|type
comma
id|strlen
c_func
(paren
id|type
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|strncmp
c_func
(paren
id|info-&gt;params.interface_type
comma
id|type
comma
id|strlen
c_func
(paren
id|type
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * edd_get_pci_dev() - finds pci_dev that matches edev&n; * @edev - edd_device&n; *&n; * Returns pci_dev if found, or NULL&n; */
r_static
r_struct
id|pci_dev
op_star
DECL|function|edd_get_pci_dev
id|edd_get_pci_dev
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
)paren
(brace
r_struct
id|edd_info
op_star
id|info
op_assign
id|edd_dev_get_info
c_func
(paren
id|edev
)paren
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|edd_dev_is_type
c_func
(paren
id|edev
comma
l_string|&quot;PCI&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
l_int|NULL
suffix:semicolon
r_return
id|pci_find_slot
c_func
(paren
id|info-&gt;params.interface_path.pci.bus
comma
id|PCI_DEVFN
c_func
(paren
id|info-&gt;params.interface_path.pci.slot
comma
id|info-&gt;params.interface_path.pci
dot
id|function
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|edd_create_symlink_to_pcidev
id|edd_create_symlink_to_pcidev
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
)paren
(brace
r_struct
id|pci_dev
op_star
id|pci_dev
op_assign
id|edd_get_pci_dev
c_func
(paren
id|edev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_dev
)paren
r_return
l_int|1
suffix:semicolon
r_return
id|edd_device_symlink
c_func
(paren
id|edev
comma
op_amp
id|pci_dev-&gt;dev
comma
l_string|&quot;pci_dev&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * edd_match_scsidev()&n; * @edev - EDD device is a known SCSI device&n; * @sd - scsi_device with host who&squot;s parent is a PCI controller&n; * &n; * returns 0 on success, 1 on failure&n; */
r_static
r_int
DECL|function|edd_match_scsidev
id|edd_match_scsidev
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
comma
r_struct
id|scsi_device
op_star
id|sd
)paren
(brace
r_struct
id|edd_info
op_star
id|info
op_assign
id|edd_dev_get_info
c_func
(paren
id|edev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edev
op_logical_or
op_logical_neg
id|sd
op_logical_or
op_logical_neg
id|info
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sd-&gt;channel
op_eq
id|info-&gt;params.interface_path.pci.channel
)paren
op_logical_and
(paren
id|sd-&gt;id
op_eq
id|info-&gt;params.device_path.scsi.id
)paren
op_logical_and
(paren
id|sd-&gt;lun
op_eq
id|info-&gt;params.device_path.scsi.lun
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/**&n; * edd_find_matching_device()&n; * @edev - edd_device to match&n; *&n; * Returns struct scsi_device * on success,&n; * or NULL on failure.&n; * This assumes that all children of the PCI controller&n; * are scsi_hosts, and that all children of scsi_hosts&n; * are scsi_devices.&n; * The reference counting probably isn&squot;t the best it could be.&n; */
DECL|macro|to_scsi_host
mdefine_line|#define&t;to_scsi_host(d)&t;&bslash;&n;&t;container_of(d, struct Scsi_Host, host_driverfs_dev)
DECL|macro|children_to_dev
mdefine_line|#define children_to_dev(n) container_of(n,struct device,node)
r_static
r_struct
id|scsi_device
op_star
DECL|function|edd_find_matching_scsi_device
id|edd_find_matching_scsi_device
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
)paren
(brace
r_struct
id|list_head
op_star
id|shost_node
comma
op_star
id|sdev_node
suffix:semicolon
r_int
id|rc
op_assign
l_int|1
suffix:semicolon
r_struct
id|scsi_device
op_star
id|sd
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|device
op_star
id|shost_dev
comma
op_star
id|sdev_dev
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pci_dev
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|sh
suffix:semicolon
id|rc
op_assign
id|edd_dev_is_type
c_func
(paren
id|edev
comma
l_string|&quot;SCSI&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
l_int|NULL
suffix:semicolon
id|pci_dev
op_assign
id|edd_get_pci_dev
c_func
(paren
id|edev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_dev
)paren
r_return
l_int|NULL
suffix:semicolon
id|get_device
c_func
(paren
op_amp
id|pci_dev-&gt;dev
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|shost_node
comma
op_amp
id|pci_dev-&gt;dev.children
)paren
(brace
id|shost_dev
op_assign
id|children_to_dev
c_func
(paren
id|shost_node
)paren
suffix:semicolon
id|get_device
c_func
(paren
id|shost_dev
)paren
suffix:semicolon
id|sh
op_assign
id|to_scsi_host
c_func
(paren
id|shost_dev
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|sdev_node
comma
op_amp
id|shost_dev-&gt;children
)paren
(brace
id|sdev_dev
op_assign
id|children_to_dev
c_func
(paren
id|sdev_node
)paren
suffix:semicolon
id|get_device
c_func
(paren
id|sdev_dev
)paren
suffix:semicolon
id|sd
op_assign
id|to_scsi_device
c_func
(paren
id|sdev_dev
)paren
suffix:semicolon
id|rc
op_assign
id|edd_match_scsidev
c_func
(paren
id|edev
comma
id|sd
)paren
suffix:semicolon
id|put_device
c_func
(paren
id|sdev_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
r_break
suffix:semicolon
)brace
id|put_device
c_func
(paren
id|shost_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
r_break
suffix:semicolon
)brace
id|put_device
c_func
(paren
op_amp
id|pci_dev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
r_return
id|sd
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_int
DECL|function|edd_create_symlink_to_scsidev
id|edd_create_symlink_to_scsidev
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
)paren
(brace
r_struct
id|scsi_device
op_star
id|sdev
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pci_dev
suffix:semicolon
r_struct
id|edd_info
op_star
id|info
op_assign
id|edd_dev_get_info
c_func
(paren
id|edev
)paren
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|edd_dev_is_type
c_func
(paren
id|edev
comma
l_string|&quot;PCI&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pci_dev
op_assign
id|pci_find_slot
c_func
(paren
id|info-&gt;params.interface_path.pci.bus
comma
id|PCI_DEVFN
c_func
(paren
id|info-&gt;params.interface_path.pci.slot
comma
id|info-&gt;params.interface_path.pci
dot
id|function
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_dev
)paren
r_return
l_int|1
suffix:semicolon
id|sdev
op_assign
id|edd_find_matching_scsi_device
c_func
(paren
id|edev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sdev
)paren
r_return
l_int|1
suffix:semicolon
id|get_device
c_func
(paren
op_amp
id|sdev-&gt;sdev_driverfs_dev
)paren
suffix:semicolon
id|rc
op_assign
id|edd_device_symlink
c_func
(paren
id|edev
comma
op_amp
id|sdev-&gt;sdev_driverfs_dev
comma
l_string|&quot;disc&quot;
)paren
suffix:semicolon
id|put_device
c_func
(paren
op_amp
id|sdev-&gt;sdev_driverfs_dev
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|edd_create_file
id|edd_create_file
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
comma
r_struct
id|edd_attribute
op_star
id|attr
)paren
(brace
r_return
id|driverfs_create_file
c_func
(paren
op_amp
id|attr-&gt;attr
comma
op_amp
id|edev-&gt;dir
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|edd_device_unregister
id|edd_device_unregister
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
)paren
(brace
id|driverfs_remove_dir
c_func
(paren
op_amp
id|edev-&gt;dir
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|edd_populate_dir
id|edd_populate_dir
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
)paren
(brace
r_struct
id|edd_attribute
op_star
id|attr
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|attr
op_assign
id|def_attrs
(braket
id|i
)braket
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|attr-&gt;test
op_logical_or
(paren
id|attr-&gt;test
op_logical_and
op_logical_neg
id|attr
op_member_access_from_pointer
id|test
c_func
(paren
id|edev
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|error
op_assign
id|edd_create_file
c_func
(paren
id|edev
comma
id|attr
)paren
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|edd_create_symlink_to_pcidev
c_func
(paren
id|edev
)paren
suffix:semicolon
id|edd_create_symlink_to_scsidev
c_func
(paren
id|edev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|edd_make_dir
id|edd_make_dir
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
)paren
(brace
r_int
id|error
suffix:semicolon
id|edev-&gt;dir.name
op_assign
id|edev-&gt;name
suffix:semicolon
id|edev-&gt;dir.mode
op_assign
(paren
id|S_IFDIR
op_or
id|S_IRWXU
op_or
id|S_IRUGO
op_or
id|S_IXUGO
)paren
suffix:semicolon
id|edev-&gt;dir.ops
op_assign
op_amp
id|edd_attr_ops
suffix:semicolon
id|error
op_assign
id|driverfs_create_dir
c_func
(paren
op_amp
id|edev-&gt;dir
comma
op_amp
id|bios_dir
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
id|error
op_assign
id|edd_populate_dir
c_func
(paren
id|edev
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_static
r_int
DECL|function|edd_device_register
id|edd_device_register
c_func
(paren
r_struct
id|edd_device
op_star
id|edev
comma
r_int
id|i
)paren
(brace
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edev
)paren
r_return
l_int|1
suffix:semicolon
id|memset
c_func
(paren
id|edev
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|edev
)paren
)paren
suffix:semicolon
id|edd_dev_set_info
c_func
(paren
id|edev
comma
op_amp
id|edd
(braket
id|i
)braket
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|edev-&gt;name
comma
id|EDD_DEVICE_NAME_SIZE
comma
l_string|&quot;int13_dev%02x&quot;
comma
id|edd
(braket
id|i
)braket
dot
id|device
)paren
suffix:semicolon
id|error
op_assign
id|edd_make_dir
c_func
(paren
id|edev
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/**&n; * edd_init() - creates driverfs tree of EDD data&n; *&n; * This assumes that eddnr and edd were&n; * assigned in setup.c already.&n; */
r_static
r_int
id|__init
DECL|function|edd_init
id|edd_init
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|edd_device
op_star
id|edev
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;BIOS EDD facility v%s, %d devices found&bslash;n&quot;
comma
id|EDD_VERSION
comma
id|eddnr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|eddnr
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;EDD information not available.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|rc
op_assign
id|driverfs_create_dir
c_func
(paren
op_amp
id|bios_dir
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|eddnr
op_logical_and
id|i
OL
id|EDDMAXNR
op_logical_and
op_logical_neg
id|rc
suffix:semicolon
id|i
op_increment
)paren
(brace
id|edev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|edev
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|rc
op_assign
id|edd_device_register
c_func
(paren
id|edev
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|kfree
c_func
(paren
id|edev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|edd_devices
(braket
id|i
)braket
op_assign
id|edev
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
)paren
(brace
id|driverfs_remove_dir
c_func
(paren
op_amp
id|bios_dir
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|edd_exit
id|edd_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|edd_device
op_star
id|edev
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|eddnr
op_logical_and
id|i
OL
id|EDDMAXNR
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|edev
op_assign
id|edd_devices
(braket
id|i
)braket
)paren
)paren
(brace
id|edd_device_unregister
c_func
(paren
id|edev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|edev
)paren
suffix:semicolon
)brace
)brace
id|driverfs_remove_dir
c_func
(paren
op_amp
id|bios_dir
)paren
suffix:semicolon
)brace
DECL|variable|edd_init
id|late_initcall
c_func
(paren
id|edd_init
)paren
suffix:semicolon
DECL|variable|edd_exit
id|module_exit
c_func
(paren
id|edd_exit
)paren
suffix:semicolon
eof
