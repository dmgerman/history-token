multiline_comment|/*&n; *  linux/arch/i386/kernel/mca.c&n; *  Written by Martin Kolinek, February 1996&n; *&n; * Changes:&n; *&n; *&t;Chris Beauregard July 28th, 1996&n; *&t;- Fixed up integrated SCSI detection&n; *&n; *&t;Chris Beauregard August 3rd, 1996&n; *&t;- Made mca_info local&n; *&t;- Made integrated registers accessible through standard function calls&n; *&t;- Added name field&n; *&t;- More sanity checking&n; *&n; *&t;Chris Beauregard August 9th, 1996&n; *&t;- Rewrote /proc/mca&n; *&n; *&t;Chris Beauregard January 7th, 1997&n; *&t;- Added basic NMI-processing&n; *&t;- Added more information to mca_info structure&n; *&n; *&t;David Weinehall October 12th, 1998&n; *&t;- Made a lot of cleaning up in the source&n; *&t;- Added use of save_flags / restore_flags&n; *&t;- Added the &squot;driver_loaded&squot; flag in MCA_adapter&n; *&t;- Added an alternative implemention of ZP Gu&squot;s mca_find_unused_adapter&n; *&n; *&t;David Weinehall March 24th, 1999&n; *&t;- Fixed the output of &squot;Driver Installed&squot; in /proc/mca/pos&n; *&t;- Made the Integrated Video &amp; SCSI show up even if they have id 0000&n; *&n; *&t;Alexander Viro November 9th, 1999&n; *&t;- Switched to regular procfs methods&n; *&n; *&t;Alfred Arnold &amp; David Weinehall August 23rd, 2000&n; *&t;- Added support for Planar POS-registers&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mca.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/mman.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/arch_hooks.h&gt;
DECL|variable|which_scsi
r_static
r_int
r_char
id|which_scsi
op_assign
l_int|0
suffix:semicolon
DECL|variable|MCA_bus
r_int
id|MCA_bus
op_assign
l_int|0
suffix:semicolon
DECL|variable|MCA_bus
id|EXPORT_SYMBOL
c_func
(paren
id|MCA_bus
)paren
suffix:semicolon
multiline_comment|/*&n; * Motherboard register spinlock. Untested on SMP at the moment, but&n; * are there any MCA SMP boxes?&n; *&n; * Yes - Alan&n; */
r_static
id|DEFINE_SPINLOCK
c_func
(paren
id|mca_lock
)paren
suffix:semicolon
multiline_comment|/* Build the status info for the adapter */
DECL|function|mca_configure_adapter_status
r_static
r_void
id|mca_configure_adapter_status
c_func
(paren
r_struct
id|mca_device
op_star
id|mca_dev
)paren
(brace
id|mca_dev-&gt;status
op_assign
id|MCA_ADAPTER_NONE
suffix:semicolon
id|mca_dev-&gt;pos_id
op_assign
id|mca_dev-&gt;pos
(braket
l_int|0
)braket
op_plus
(paren
id|mca_dev-&gt;pos
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mca_dev-&gt;pos_id
op_logical_and
id|mca_dev-&gt;slot
OL
id|MCA_MAX_SLOT_NR
)paren
(brace
multiline_comment|/* id = 0x0000 usually indicates hardware failure,&n;&t;&t; * however, ZP Gu (zpg@castle.net&gt; reports that his 9556&n;&t;&t; * has 0x0000 as id and everything still works. There&n;&t;&t; * also seem to be an adapter with id = 0x0000; the&n;&t;&t; * NCR Parallel Bus Memory Card. Until this is confirmed,&n;&t;&t; * however, this code will stay.&n;&t;&t; */
id|mca_dev-&gt;status
op_assign
id|MCA_ADAPTER_ERROR
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mca_dev-&gt;pos_id
op_ne
l_int|0xffff
)paren
(brace
multiline_comment|/* 0xffff usually indicates that there&squot;s no adapter,&n;&t;&t; * however, some integrated adapters may have 0xffff as&n;&t;&t; * their id and still be valid. Examples are on-board&n;&t;&t; * VGA of the 55sx, the integrated SCSI of the 56 &amp; 57,&n;&t;&t; * and possibly also the 95 ULTIMEDIA.&n;&t;&t; */
id|mca_dev-&gt;status
op_assign
id|MCA_ADAPTER_NORMAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|mca_dev-&gt;pos_id
op_eq
l_int|0xffff
op_logical_or
id|mca_dev-&gt;pos_id
op_eq
l_int|0x0000
)paren
op_logical_and
id|mca_dev-&gt;slot
op_ge
id|MCA_MAX_SLOT_NR
)paren
(brace
r_int
id|j
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|2
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|mca_dev-&gt;pos
(braket
id|j
)braket
op_ne
l_int|0xff
)paren
(brace
id|mca_dev-&gt;status
op_assign
id|MCA_ADAPTER_NORMAL
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|mca_dev-&gt;pos
(braket
l_int|2
)braket
op_amp
id|MCA_ENABLED
)paren
)paren
(brace
multiline_comment|/* enabled bit is in POS 2 */
id|mca_dev-&gt;status
op_assign
id|MCA_ADAPTER_DISABLED
suffix:semicolon
)brace
)brace
multiline_comment|/* mca_configure_adapter_status */
multiline_comment|/*--------------------------------------------------------------------*/
DECL|variable|mca_standard_resources
r_static
r_struct
id|resource
id|mca_standard_resources
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;system control port B (MCA)&quot;
comma
l_int|0x60
comma
l_int|0x60
)brace
comma
(brace
l_string|&quot;arbitration (MCA)&quot;
comma
l_int|0x90
comma
l_int|0x90
)brace
comma
(brace
l_string|&quot;card Select Feedback (MCA)&quot;
comma
l_int|0x91
comma
l_int|0x91
)brace
comma
(brace
l_string|&quot;system Control port A (MCA)&quot;
comma
l_int|0x92
comma
l_int|0x92
)brace
comma
(brace
l_string|&quot;system board setup (MCA)&quot;
comma
l_int|0x94
comma
l_int|0x94
)brace
comma
(brace
l_string|&quot;POS (MCA)&quot;
comma
l_int|0x96
comma
l_int|0x97
)brace
comma
(brace
l_string|&quot;POS (MCA)&quot;
comma
l_int|0x100
comma
l_int|0x107
)brace
)brace
suffix:semicolon
DECL|macro|MCA_STANDARD_RESOURCES
mdefine_line|#define MCA_STANDARD_RESOURCES&t;(sizeof(mca_standard_resources)/sizeof(struct resource))
multiline_comment|/**&n; *&t;mca_read_and_store_pos - read the POS registers into a memory buffer&n; *      @pos: a char pointer to 8 bytes, contains the POS register value on&n; *            successful return&n; *&n; *&t;Returns 1 if a card actually exists (i.e. the pos isn&squot;t&n; *&t;all 0xff) or 0 otherwise&n; */
DECL|function|mca_read_and_store_pos
r_static
r_int
id|mca_read_and_store_pos
c_func
(paren
r_int
r_char
op_star
id|pos
)paren
(brace
r_int
id|j
suffix:semicolon
r_int
id|found
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|pos
(braket
id|j
)braket
op_assign
id|inb_p
c_func
(paren
id|MCA_POS_REG
c_func
(paren
id|j
)paren
)paren
)paren
op_ne
l_int|0xff
)paren
(brace
multiline_comment|/* 0xff all across means no device. 0x00 means&n;&t;&t;&t; * something&squot;s broken, but a device is&n;&t;&t;&t; * probably there.  However, if you get 0x00&n;&t;&t;&t; * from a motherboard register it won&squot;t matter&n;&t;&t;&t; * what we find.  For the record, on the&n;&t;&t;&t; * 57SLC, the integrated SCSI adapter has&n;&t;&t;&t; * 0xffff for the adapter ID, but nonzero for&n;&t;&t;&t; * other registers.  */
id|found
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_return
id|found
suffix:semicolon
)brace
DECL|function|mca_pc_read_pos
r_static
r_int
r_char
id|mca_pc_read_pos
c_func
(paren
r_struct
id|mca_device
op_star
id|mca_dev
comma
r_int
id|reg
)paren
(brace
r_int
r_char
id|byte
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|reg
OL
l_int|0
op_logical_or
id|reg
op_ge
l_int|8
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mca_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mca_dev-&gt;pos_register
)paren
(brace
multiline_comment|/* Disable adapter setup, enable motherboard setup */
id|outb_p
c_func
(paren
l_int|0
comma
id|MCA_ADAPTER_SETUP_REG
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|mca_dev-&gt;pos_register
comma
id|MCA_MOTHERBOARD_SETUP_REG
)paren
suffix:semicolon
id|byte
op_assign
id|inb_p
c_func
(paren
id|MCA_POS_REG
c_func
(paren
id|reg
)paren
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0xff
comma
id|MCA_MOTHERBOARD_SETUP_REG
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Make sure motherboard setup is off */
id|outb_p
c_func
(paren
l_int|0xff
comma
id|MCA_MOTHERBOARD_SETUP_REG
)paren
suffix:semicolon
multiline_comment|/* Read the appropriate register */
id|outb_p
c_func
(paren
l_int|0x8
op_or
(paren
id|mca_dev-&gt;slot
op_amp
l_int|0xf
)paren
comma
id|MCA_ADAPTER_SETUP_REG
)paren
suffix:semicolon
id|byte
op_assign
id|inb_p
c_func
(paren
id|MCA_POS_REG
c_func
(paren
id|reg
)paren
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0
comma
id|MCA_ADAPTER_SETUP_REG
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mca_lock
comma
id|flags
)paren
suffix:semicolon
id|mca_dev-&gt;pos
(braket
id|reg
)braket
op_assign
id|byte
suffix:semicolon
r_return
id|byte
suffix:semicolon
)brace
DECL|function|mca_pc_write_pos
r_static
r_void
id|mca_pc_write_pos
c_func
(paren
r_struct
id|mca_device
op_star
id|mca_dev
comma
r_int
id|reg
comma
r_int
r_char
id|byte
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|reg
OL
l_int|0
op_logical_or
id|reg
op_ge
l_int|8
)paren
(brace
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mca_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Make sure motherboard setup is off */
id|outb_p
c_func
(paren
l_int|0xff
comma
id|MCA_MOTHERBOARD_SETUP_REG
)paren
suffix:semicolon
multiline_comment|/* Read in the appropriate register */
id|outb_p
c_func
(paren
l_int|0x8
op_or
(paren
id|mca_dev-&gt;slot
op_amp
l_int|0xf
)paren
comma
id|MCA_ADAPTER_SETUP_REG
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|byte
comma
id|MCA_POS_REG
c_func
(paren
id|reg
)paren
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0
comma
id|MCA_ADAPTER_SETUP_REG
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mca_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Update the global register list, while we have the byte */
id|mca_dev-&gt;pos
(braket
id|reg
)braket
op_assign
id|byte
suffix:semicolon
)brace
multiline_comment|/* for the primary MCA bus, we have identity transforms */
DECL|function|mca_dummy_transform_irq
r_static
r_int
id|mca_dummy_transform_irq
c_func
(paren
r_struct
id|mca_device
op_star
id|mca_dev
comma
r_int
id|irq
)paren
(brace
r_return
id|irq
suffix:semicolon
)brace
DECL|function|mca_dummy_transform_ioport
r_static
r_int
id|mca_dummy_transform_ioport
c_func
(paren
r_struct
id|mca_device
op_star
id|mca_dev
comma
r_int
id|port
)paren
(brace
r_return
id|port
suffix:semicolon
)brace
DECL|function|mca_dummy_transform_memory
r_static
r_void
op_star
id|mca_dummy_transform_memory
c_func
(paren
r_struct
id|mca_device
op_star
id|mca_dev
comma
r_void
op_star
id|mem
)paren
(brace
r_return
id|mem
suffix:semicolon
)brace
DECL|function|mca_init
r_static
r_int
id|__init
id|mca_init
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|i
comma
id|j
suffix:semicolon
r_struct
id|mca_device
op_star
id|mca_dev
suffix:semicolon
r_int
r_char
id|pos
(braket
l_int|8
)braket
suffix:semicolon
r_int
id|mca_builtin_scsi_ports
(braket
)braket
op_assign
(brace
l_int|0xf7
comma
l_int|0xfd
comma
l_int|0x00
)brace
suffix:semicolon
r_struct
id|mca_bus
op_star
id|bus
suffix:semicolon
multiline_comment|/* WARNING: Be careful when making changes here. Putting an adapter&n;&t; * and the motherboard simultaneously into setup mode may result in&n;&t; * damage to chips (according to The Indispensible PC Hardware Book&n;&t; * by Hans-Peter Messmer). Also, we disable system interrupts (so&n;&t; * that we are not disturbed in the middle of this).&n;&t; */
multiline_comment|/* Make sure the MCA bus is present */
r_if
c_cond
(paren
id|mca_system_init
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MCA bus system initialisation failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|MCA_bus
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Micro Channel bus detected.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* All MCA systems have at least a primary bus */
id|bus
op_assign
id|mca_attach_bus
c_func
(paren
id|MCA_PRIMARY_BUS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bus
)paren
r_goto
id|out_nomem
suffix:semicolon
id|bus-&gt;default_dma_mask
op_assign
l_int|0xffffffffLL
suffix:semicolon
id|bus-&gt;f.mca_write_pos
op_assign
id|mca_pc_write_pos
suffix:semicolon
id|bus-&gt;f.mca_read_pos
op_assign
id|mca_pc_read_pos
suffix:semicolon
id|bus-&gt;f.mca_transform_irq
op_assign
id|mca_dummy_transform_irq
suffix:semicolon
id|bus-&gt;f.mca_transform_ioport
op_assign
id|mca_dummy_transform_ioport
suffix:semicolon
id|bus-&gt;f.mca_transform_memory
op_assign
id|mca_dummy_transform_memory
suffix:semicolon
multiline_comment|/* get the motherboard device */
id|mca_dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|mca_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|mca_dev
)paren
)paren
(brace
r_goto
id|out_nomem
suffix:semicolon
)brace
id|memset
c_func
(paren
id|mca_dev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|mca_device
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We do not expect many MCA interrupts during initialization,&n;&t; * but let us be safe:&n;&t; */
id|spin_lock_irq
c_func
(paren
op_amp
id|mca_lock
)paren
suffix:semicolon
multiline_comment|/* Make sure adapter setup is off */
id|outb_p
c_func
(paren
l_int|0
comma
id|MCA_ADAPTER_SETUP_REG
)paren
suffix:semicolon
multiline_comment|/* Read motherboard POS registers */
id|mca_dev-&gt;pos_register
op_assign
l_int|0x7f
suffix:semicolon
id|outb_p
c_func
(paren
id|mca_dev-&gt;pos_register
comma
id|MCA_MOTHERBOARD_SETUP_REG
)paren
suffix:semicolon
id|mca_dev-&gt;name
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|mca_read_and_store_pos
c_func
(paren
id|mca_dev-&gt;pos
)paren
suffix:semicolon
id|mca_configure_adapter_status
c_func
(paren
id|mca_dev
)paren
suffix:semicolon
multiline_comment|/* fake POS and slot for a motherboard */
id|mca_dev-&gt;pos_id
op_assign
id|MCA_MOTHERBOARD_POS
suffix:semicolon
id|mca_dev-&gt;slot
op_assign
id|MCA_MOTHERBOARD
suffix:semicolon
id|mca_register_device
c_func
(paren
id|MCA_PRIMARY_BUS
comma
id|mca_dev
)paren
suffix:semicolon
id|mca_dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|mca_device
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|mca_dev
)paren
)paren
(brace
r_goto
id|out_unlock_nomem
suffix:semicolon
)brace
id|memset
c_func
(paren
id|mca_dev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|mca_device
)paren
)paren
suffix:semicolon
multiline_comment|/* Put motherboard into video setup mode, read integrated video&n;&t; * POS registers, and turn motherboard setup off.&n;&t; */
id|mca_dev-&gt;pos_register
op_assign
l_int|0xdf
suffix:semicolon
id|outb_p
c_func
(paren
id|mca_dev-&gt;pos_register
comma
id|MCA_MOTHERBOARD_SETUP_REG
)paren
suffix:semicolon
id|mca_dev-&gt;name
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|mca_read_and_store_pos
c_func
(paren
id|mca_dev-&gt;pos
)paren
suffix:semicolon
id|mca_configure_adapter_status
c_func
(paren
id|mca_dev
)paren
suffix:semicolon
multiline_comment|/* fake POS and slot for the integrated video */
id|mca_dev-&gt;pos_id
op_assign
id|MCA_INTEGVIDEO_POS
suffix:semicolon
id|mca_dev-&gt;slot
op_assign
id|MCA_INTEGVIDEO
suffix:semicolon
id|mca_register_device
c_func
(paren
id|MCA_PRIMARY_BUS
comma
id|mca_dev
)paren
suffix:semicolon
multiline_comment|/* Put motherboard into scsi setup mode, read integrated scsi&n;&t; * POS registers, and turn motherboard setup off.&n;&t; *&n;&t; * It seems there are two possible SCSI registers. Martin says that&n;&t; * for the 56,57, 0xf7 is the one, but fails on the 76.&n;&t; * Alfredo (apena@vnet.ibm.com) says&n;&t; * 0xfd works on his machine. We&squot;ll try both of them. I figure it&squot;s&n;&t; * a good bet that only one could be valid at a time. This could&n;&t; * screw up though if one is used for something else on the other&n;&t; * machine.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|which_scsi
op_assign
id|mca_builtin_scsi_ports
(braket
id|i
)braket
)paren
op_ne
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb_p
c_func
(paren
id|which_scsi
comma
id|MCA_MOTHERBOARD_SETUP_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mca_read_and_store_pos
c_func
(paren
id|pos
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|which_scsi
)paren
(brace
multiline_comment|/* found a scsi card */
id|mca_dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|mca_device
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|mca_dev
)paren
)paren
(brace
r_goto
id|out_unlock_nomem
suffix:semicolon
)brace
id|memset
c_func
(paren
id|mca_dev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|mca_device
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
(brace
id|mca_dev-&gt;pos
(braket
id|j
)braket
op_assign
id|pos
(braket
id|j
)braket
suffix:semicolon
)brace
id|mca_configure_adapter_status
c_func
(paren
id|mca_dev
)paren
suffix:semicolon
multiline_comment|/* fake POS and slot for integrated SCSI controller */
id|mca_dev-&gt;pos_id
op_assign
id|MCA_INTEGSCSI_POS
suffix:semicolon
id|mca_dev-&gt;slot
op_assign
id|MCA_INTEGSCSI
suffix:semicolon
id|mca_dev-&gt;pos_register
op_assign
id|which_scsi
suffix:semicolon
id|mca_register_device
c_func
(paren
id|MCA_PRIMARY_BUS
comma
id|mca_dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Turn off motherboard setup */
id|outb_p
c_func
(paren
l_int|0xff
comma
id|MCA_MOTHERBOARD_SETUP_REG
)paren
suffix:semicolon
multiline_comment|/* Now loop over MCA slots: put each adapter into setup mode, and&n;&t; * read its POS registers. Then put adapter setup off.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MCA_MAX_SLOT_NR
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb_p
c_func
(paren
l_int|0x8
op_or
(paren
id|i
op_amp
l_int|0xf
)paren
comma
id|MCA_ADAPTER_SETUP_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mca_read_and_store_pos
c_func
(paren
id|pos
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
id|mca_dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|mca_device
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|mca_dev
)paren
)paren
(brace
r_goto
id|out_unlock_nomem
suffix:semicolon
)brace
id|memset
c_func
(paren
id|mca_dev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|mca_device
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
(brace
id|mca_dev-&gt;pos
(braket
id|j
)braket
op_assign
id|pos
(braket
id|j
)braket
suffix:semicolon
)brace
id|mca_dev-&gt;driver_loaded
op_assign
l_int|0
suffix:semicolon
id|mca_dev-&gt;slot
op_assign
id|i
suffix:semicolon
id|mca_dev-&gt;pos_register
op_assign
l_int|0
suffix:semicolon
id|mca_configure_adapter_status
c_func
(paren
id|mca_dev
)paren
suffix:semicolon
id|mca_register_device
c_func
(paren
id|MCA_PRIMARY_BUS
comma
id|mca_dev
)paren
suffix:semicolon
)brace
id|outb_p
c_func
(paren
l_int|0
comma
id|MCA_ADAPTER_SETUP_REG
)paren
suffix:semicolon
multiline_comment|/* Enable interrupts and return memory start */
id|spin_unlock_irq
c_func
(paren
op_amp
id|mca_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MCA_STANDARD_RESOURCES
suffix:semicolon
id|i
op_increment
)paren
id|request_resource
c_func
(paren
op_amp
id|ioport_resource
comma
id|mca_standard_resources
op_plus
id|i
)paren
suffix:semicolon
id|mca_do_proc_init
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_unlock_nomem
suffix:colon
id|spin_unlock_irq
c_func
(paren
op_amp
id|mca_lock
)paren
suffix:semicolon
id|out_nomem
suffix:colon
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;Failed memory allocation in MCA setup!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
DECL|variable|mca_init
id|subsys_initcall
c_func
(paren
id|mca_init
)paren
suffix:semicolon
multiline_comment|/*--------------------------------------------------------------------*/
DECL|function|mca_handle_nmi_device
r_static
r_void
id|mca_handle_nmi_device
c_func
(paren
r_struct
id|mca_device
op_star
id|mca_dev
comma
r_int
id|check_flag
)paren
(brace
r_int
id|slot
op_assign
id|mca_dev-&gt;slot
suffix:semicolon
r_if
c_cond
(paren
id|slot
op_eq
id|MCA_INTEGSCSI
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;NMI: caused by MCA integrated SCSI adapter (%s)&bslash;n&quot;
comma
id|mca_dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|slot
op_eq
id|MCA_INTEGVIDEO
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;NMI: caused by MCA integrated video adapter (%s)&bslash;n&quot;
comma
id|mca_dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|slot
op_eq
id|MCA_MOTHERBOARD
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;NMI: caused by motherboard (%s)&bslash;n&quot;
comma
id|mca_dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* More info available in POS 6 and 7? */
r_if
c_cond
(paren
id|check_flag
)paren
(brace
r_int
r_char
id|pos6
comma
id|pos7
suffix:semicolon
id|pos6
op_assign
id|mca_device_read_pos
c_func
(paren
id|mca_dev
comma
l_int|6
)paren
suffix:semicolon
id|pos7
op_assign
id|mca_device_read_pos
c_func
(paren
id|mca_dev
comma
l_int|7
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;NMI: POS 6 = 0x%x, POS 7 = 0x%x&bslash;n&quot;
comma
id|pos6
comma
id|pos7
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* mca_handle_nmi_slot */
multiline_comment|/*--------------------------------------------------------------------*/
DECL|function|mca_handle_nmi_callback
r_static
r_int
id|mca_handle_nmi_callback
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|mca_device
op_star
id|mca_dev
op_assign
id|to_mca_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_char
id|pos5
suffix:semicolon
id|pos5
op_assign
id|mca_device_read_pos
c_func
(paren
id|mca_dev
comma
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pos5
op_amp
l_int|0x80
)paren
)paren
(brace
multiline_comment|/* Bit 7 of POS 5 is reset when this adapter has a hardware&n;&t;&t; * error. Bit 7 it reset if there&squot;s error information&n;&t;&t; * available in POS 6 and 7.&n;&t;&t; */
id|mca_handle_nmi_device
c_func
(paren
id|mca_dev
comma
op_logical_neg
(paren
id|pos5
op_amp
l_int|0x40
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mca_handle_nmi
r_void
id|mca_handle_nmi
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* First try - scan the various adapters and see if a specific&n;&t; * adapter was responsible for the error.&n;&t; */
id|bus_for_each_dev
c_func
(paren
op_amp
id|mca_bus_type
comma
l_int|NULL
comma
l_int|NULL
comma
id|mca_handle_nmi_callback
)paren
suffix:semicolon
id|mca_nmi_hook
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* mca_handle_nmi */
eof
