multiline_comment|/*&n; *&t;Intel CPU Microcode Update Driver for Linux&n; *&n; *&t;Copyright (C) 2000-2004 Tigran Aivazian&n; *&n; *&t;This driver allows to upgrade microcode on Intel processors&n; *&t;belonging to IA-32 family - PentiumPro, Pentium II, &n; *&t;Pentium III, Xeon, Pentium 4, etc.&n; *&n; *&t;Reference: Section 8.10 of Volume III, Intel Pentium 4 Manual, &n; *&t;Order Number 245472 or free download from:&n; *&t;&t;&n; *&t;http://developer.intel.com/design/pentium4/manuals/245472.htm&n; *&n; *&t;For more information, go to http://www.urbanmyth.org/microcode&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; *&n; *&t;1.0&t;16 Feb 2000, Tigran Aivazian &lt;tigran@sco.com&gt;&n; *&t;&t;Initial release.&n; *&t;1.01&t;18 Feb 2000, Tigran Aivazian &lt;tigran@sco.com&gt;&n; *&t;&t;Added read() support + cleanups.&n; *&t;1.02&t;21 Feb 2000, Tigran Aivazian &lt;tigran@sco.com&gt;&n; *&t;&t;Added &squot;device trimming&squot; support. open(O_WRONLY) zeroes&n; *&t;&t;and frees the saved copy of applied microcode.&n; *&t;1.03&t;29 Feb 2000, Tigran Aivazian &lt;tigran@sco.com&gt;&n; *&t;&t;Made to use devfs (/dev/cpu/microcode) + cleanups.&n; *&t;1.04&t;06 Jun 2000, Simon Trimmer &lt;simon@veritas.com&gt;&n; *&t;&t;Added misc device support (now uses both devfs and misc).&n; *&t;&t;Added MICROCODE_IOCFREE ioctl to clear memory.&n; *&t;1.05&t;09 Jun 2000, Simon Trimmer &lt;simon@veritas.com&gt;&n; *&t;&t;Messages for error cases (non Intel &amp; no suitable microcode).&n; *&t;1.06&t;03 Aug 2000, Tigran Aivazian &lt;tigran@veritas.com&gt;&n; *&t;&t;Removed -&gt;release(). Removed exclusive open and status bitmap.&n; *&t;&t;Added microcode_rwsem to serialize read()/write()/ioctl().&n; *&t;&t;Removed global kernel lock usage.&n; *&t;1.07&t;07 Sep 2000, Tigran Aivazian &lt;tigran@veritas.com&gt;&n; *&t;&t;Write 0 to 0x8B msr and then cpuid before reading revision,&n; *&t;&t;so that it works even if there were no update done by the&n; *&t;&t;BIOS. Otherwise, reading from 0x8B gives junk (which happened&n; *&t;&t;to be 0 on my machine which is why it worked even when I&n; *&t;&t;disabled update by the BIOS)&n; *&t;&t;Thanks to Eric W. Biederman &lt;ebiederman@lnxi.com&gt; for the fix.&n; *&t;1.08&t;11 Dec 2000, Richard Schaal &lt;richard.schaal@intel.com&gt; and&n; *&t;&t;&t;     Tigran Aivazian &lt;tigran@veritas.com&gt;&n; *&t;&t;Intel Pentium 4 processor support and bugfixes.&n; *&t;1.09&t;30 Oct 2001, Tigran Aivazian &lt;tigran@veritas.com&gt;&n; *&t;&t;Bugfix for HT (Hyper-Threading) enabled processors&n; *&t;&t;whereby processor resources are shared by all logical processors&n; *&t;&t;in a single CPU package.&n; *&t;1.10&t;28 Feb 2002 Asit K Mallick &lt;asit.k.mallick@intel.com&gt; and&n; *&t;&t;Tigran Aivazian &lt;tigran@veritas.com&gt;,&n; *&t;&t;Serialize updates as required on HT processors due to speculative&n; *&t;&t;nature of implementation.&n; *&t;1.11&t;22 Mar 2002 Tigran Aivazian &lt;tigran@veritas.com&gt;&n; *&t;&t;Fix the panic when writing zero-length microcode chunk.&n; *&t;1.12&t;29 Sep 2003 Nitin Kamble &lt;nitin.a.kamble@intel.com&gt;, &n; *&t;&t;Jun Nakajima &lt;jun.nakajima@intel.com&gt;&n; *&t;&t;Support for the microcode updates in the new format.&n; *&t;1.13&t;10 Oct 2003 Tigran Aivazian &lt;tigran@veritas.com&gt;&n; *&t;&t;Removed -&gt;read() method and obsoleted MICROCODE_IOCFREE ioctl&n; *&t;&t;because we no longer hold a copy of applied microcode &n; *&t;&t;in kernel memory.&n; *&t;1.14&t;25 Jun 2004 Tigran Aivazian &lt;tigran@veritas.com&gt;&n; *&t;&t;Fix sigmatch() macro to handle old CPUs with pf == 0.&n; *&t;&t;Thanks to Stuart Swales for pointing out this bug.&n; */
singleline_comment|//#define DEBUG /* pr_debug */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/msr.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Intel CPU (IA-32) Microcode Update Driver&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Tigran Aivazian &lt;tigran@veritas.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|macro|MICROCODE_VERSION
mdefine_line|#define MICROCODE_VERSION &t;&quot;1.14&quot;
DECL|macro|DEFAULT_UCODE_DATASIZE
mdefine_line|#define DEFAULT_UCODE_DATASIZE &t;(2000) &t;  /* 2000 bytes */
DECL|macro|MC_HEADER_SIZE
mdefine_line|#define MC_HEADER_SIZE&t;&t;(sizeof (microcode_header_t))  &t;  /* 48 bytes */
DECL|macro|DEFAULT_UCODE_TOTALSIZE
mdefine_line|#define DEFAULT_UCODE_TOTALSIZE (DEFAULT_UCODE_DATASIZE + MC_HEADER_SIZE) /* 2048 bytes */
DECL|macro|EXT_HEADER_SIZE
mdefine_line|#define EXT_HEADER_SIZE&t;&t;(sizeof (struct extended_sigtable)) /* 20 bytes */
DECL|macro|EXT_SIGNATURE_SIZE
mdefine_line|#define EXT_SIGNATURE_SIZE&t;(sizeof (struct extended_signature)) /* 12 bytes */
DECL|macro|DWSIZE
mdefine_line|#define DWSIZE&t;&t;&t;(sizeof (u32))
DECL|macro|get_totalsize
mdefine_line|#define get_totalsize(mc) &bslash;&n;&t;(((microcode_t *)mc)-&gt;hdr.totalsize ? &bslash;&n;&t; ((microcode_t *)mc)-&gt;hdr.totalsize : DEFAULT_UCODE_TOTALSIZE)
DECL|macro|get_datasize
mdefine_line|#define get_datasize(mc) &bslash;&n;&t;(((microcode_t *)mc)-&gt;hdr.datasize ? &bslash;&n;&t; ((microcode_t *)mc)-&gt;hdr.datasize : DEFAULT_UCODE_DATASIZE)
DECL|macro|sigmatch
mdefine_line|#define sigmatch(s1, s2, p1, p2) &bslash;&n;&t;(((s1) == (s2)) &amp;&amp; (((p1) &amp; (p2)) || (((p1) == 0) &amp;&amp; ((p2) == 0))))
DECL|macro|exttable_size
mdefine_line|#define exttable_size(et) ((et)-&gt;count * EXT_SIGNATURE_SIZE + EXT_HEADER_SIZE)
multiline_comment|/* serialize access to the physical write to MSR 0x79 */
DECL|variable|microcode_update_lock
r_static
id|spinlock_t
id|microcode_update_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* no concurrent -&gt;write()s are allowed on /dev/cpu/microcode */
r_static
id|DECLARE_MUTEX
c_func
(paren
id|microcode_sem
)paren
suffix:semicolon
DECL|variable|user_buffer
r_static
r_void
id|__user
op_star
id|user_buffer
suffix:semicolon
multiline_comment|/* user area microcode data buffer */
DECL|variable|user_buffer_size
r_static
r_int
r_int
id|user_buffer_size
suffix:semicolon
multiline_comment|/* it&squot;s size */
DECL|enum|mc_error_code
r_typedef
r_enum
id|mc_error_code
(brace
DECL|enumerator|MC_SUCCESS
id|MC_SUCCESS
op_assign
l_int|0
comma
DECL|enumerator|MC_NOTFOUND
id|MC_NOTFOUND
op_assign
l_int|1
comma
DECL|enumerator|MC_MARKED
id|MC_MARKED
op_assign
l_int|2
comma
DECL|enumerator|MC_ALLOCATED
id|MC_ALLOCATED
op_assign
l_int|3
comma
DECL|typedef|mc_error_code_t
)brace
id|mc_error_code_t
suffix:semicolon
DECL|struct|ucode_cpu_info
r_static
r_struct
id|ucode_cpu_info
(brace
DECL|member|sig
r_int
r_int
id|sig
suffix:semicolon
DECL|member|pf
r_int
r_int
id|pf
suffix:semicolon
DECL|member|rev
r_int
r_int
id|rev
suffix:semicolon
DECL|member|cksum
r_int
r_int
id|cksum
suffix:semicolon
DECL|member|err
id|mc_error_code_t
id|err
suffix:semicolon
DECL|member|mc
id|microcode_t
op_star
id|mc
suffix:semicolon
DECL|variable|ucode_cpu_info
)brace
id|ucode_cpu_info
(braket
id|NR_CPUS
)braket
suffix:semicolon
DECL|function|microcode_open
r_static
r_int
id|microcode_open
(paren
r_struct
id|inode
op_star
id|unused1
comma
r_struct
id|file
op_star
id|unused2
)paren
(brace
r_return
id|capable
c_func
(paren
id|CAP_SYS_RAWIO
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EPERM
suffix:semicolon
)brace
DECL|function|collect_cpu_info
r_static
r_void
id|collect_cpu_info
(paren
r_void
op_star
id|unused
)paren
(brace
r_int
id|cpu_num
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_struct
id|cpuinfo_x86
op_star
id|c
op_assign
id|cpu_data
op_plus
id|cpu_num
suffix:semicolon
r_struct
id|ucode_cpu_info
op_star
id|uci
op_assign
id|ucode_cpu_info
op_plus
id|cpu_num
suffix:semicolon
r_int
r_int
id|val
(braket
l_int|2
)braket
suffix:semicolon
id|uci-&gt;sig
op_assign
id|uci-&gt;pf
op_assign
id|uci-&gt;rev
op_assign
id|uci-&gt;cksum
op_assign
l_int|0
suffix:semicolon
id|uci-&gt;err
op_assign
id|MC_NOTFOUND
suffix:semicolon
id|uci-&gt;mc
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;x86_vendor
op_ne
id|X86_VENDOR_INTEL
op_logical_or
id|c-&gt;x86
OL
l_int|6
op_logical_or
id|cpu_has
c_func
(paren
id|c
comma
id|X86_FEATURE_IA64
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;microcode: CPU%d not a capable Intel processor&bslash;n&quot;
comma
id|cpu_num
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
id|uci-&gt;sig
op_assign
id|cpuid_eax
c_func
(paren
l_int|0x00000001
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c-&gt;x86_model
op_ge
l_int|5
)paren
op_logical_or
(paren
id|c-&gt;x86
OG
l_int|6
)paren
)paren
(brace
multiline_comment|/* get processor flags from MSR 0x17 */
id|rdmsr
c_func
(paren
id|MSR_IA32_PLATFORM_ID
comma
id|val
(braket
l_int|0
)braket
comma
id|val
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|uci-&gt;pf
op_assign
l_int|1
op_lshift
(paren
(paren
id|val
(braket
l_int|1
)braket
op_rshift
l_int|18
)paren
op_amp
l_int|7
)paren
suffix:semicolon
)brace
)brace
id|wrmsr
c_func
(paren
id|MSR_IA32_UCODE_REV
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|__asm__
id|__volatile__
(paren
l_string|&quot;cpuid&quot;
suffix:colon
suffix:colon
suffix:colon
l_string|&quot;ax&quot;
comma
l_string|&quot;bx&quot;
comma
l_string|&quot;cx&quot;
comma
l_string|&quot;dx&quot;
)paren
suffix:semicolon
multiline_comment|/* get the current revision from MSR 0x8B */
id|rdmsr
c_func
(paren
id|MSR_IA32_UCODE_REV
comma
id|val
(braket
l_int|0
)braket
comma
id|uci-&gt;rev
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;microcode: collect_cpu_info : sig=0x%x, pf=0x%x, rev=0x%x&bslash;n&quot;
comma
id|uci-&gt;sig
comma
id|uci-&gt;pf
comma
id|uci-&gt;rev
)paren
suffix:semicolon
)brace
DECL|function|mark_microcode_update
r_static
r_inline
r_void
id|mark_microcode_update
(paren
r_int
id|cpu_num
comma
id|microcode_header_t
op_star
id|mc_header
comma
r_int
id|sig
comma
r_int
id|pf
comma
r_int
id|cksum
)paren
(brace
r_struct
id|ucode_cpu_info
op_star
id|uci
op_assign
id|ucode_cpu_info
op_plus
id|cpu_num
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;Microcode Found.&bslash;n&quot;
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;   Header Revision 0x%x&bslash;n&quot;
comma
id|mc_header-&gt;hdrver
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;   Loader Revision 0x%x&bslash;n&quot;
comma
id|mc_header-&gt;ldrver
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;   Revision 0x%x &bslash;n&quot;
comma
id|mc_header-&gt;rev
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;   Date %x/%x/%x&bslash;n&quot;
comma
(paren
(paren
id|mc_header-&gt;date
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
)paren
comma
(paren
(paren
id|mc_header-&gt;date
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
)paren
comma
(paren
id|mc_header-&gt;date
op_amp
l_int|0xFFFF
)paren
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;   Signature 0x%x&bslash;n&quot;
comma
id|sig
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;   Type 0x%x Family 0x%x Model 0x%x Stepping 0x%x&bslash;n&quot;
comma
(paren
(paren
id|sig
op_rshift
l_int|12
)paren
op_amp
l_int|0x3
)paren
comma
(paren
(paren
id|sig
op_rshift
l_int|8
)paren
op_amp
l_int|0xf
)paren
comma
(paren
(paren
id|sig
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
)paren
comma
(paren
(paren
id|sig
op_amp
l_int|0xf
)paren
)paren
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;   Processor Flags 0x%x&bslash;n&quot;
comma
id|pf
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;   Checksum 0x%x&bslash;n&quot;
comma
id|cksum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mc_header-&gt;rev
OL
id|uci-&gt;rev
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;microcode: CPU%d not &squot;upgrading&squot; to earlier revision&quot;
l_string|&quot; 0x%x (current=0x%x)&bslash;n&quot;
comma
id|cpu_num
comma
id|mc_header-&gt;rev
comma
id|uci-&gt;rev
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mc_header-&gt;rev
op_eq
id|uci-&gt;rev
)paren
(brace
multiline_comment|/* notify the caller of success on this cpu */
id|uci-&gt;err
op_assign
id|MC_SUCCESS
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;microcode: CPU%d already at revision&quot;
l_string|&quot; 0x%x (current=0x%x)&bslash;n&quot;
comma
id|cpu_num
comma
id|mc_header-&gt;rev
comma
id|uci-&gt;rev
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|pr_debug
c_func
(paren
l_string|&quot;microcode: CPU%d found a matching microcode update with &quot;
l_string|&quot; revision 0x%x (current=0x%x)&bslash;n&quot;
comma
id|cpu_num
comma
id|mc_header-&gt;rev
comma
id|uci-&gt;rev
)paren
suffix:semicolon
id|uci-&gt;cksum
op_assign
id|cksum
suffix:semicolon
id|uci-&gt;pf
op_assign
id|pf
suffix:semicolon
multiline_comment|/* keep the original mc pf for cksum calculation */
id|uci-&gt;err
op_assign
id|MC_MARKED
suffix:semicolon
multiline_comment|/* found the match */
id|out
suffix:colon
r_return
suffix:semicolon
)brace
DECL|function|find_matching_ucodes
r_static
r_int
id|find_matching_ucodes
(paren
r_void
)paren
(brace
r_int
id|cursor
op_assign
l_int|0
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|cursor
op_plus
id|MC_HEADER_SIZE
OL
id|user_buffer_size
)paren
(brace
id|microcode_header_t
id|mc_header
suffix:semicolon
r_void
op_star
id|newmc
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
comma
id|sum
comma
id|cpu_num
comma
id|allocated_flag
comma
id|total_size
comma
id|data_size
comma
id|ext_table_size
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|mc_header
comma
id|user_buffer
op_plus
id|cursor
comma
id|MC_HEADER_SIZE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;microcode: error! Can not read user data&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|total_size
op_assign
id|get_totalsize
c_func
(paren
op_amp
id|mc_header
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cursor
op_plus
id|total_size
OG
id|user_buffer_size
)paren
op_logical_or
(paren
id|total_size
OL
id|DEFAULT_UCODE_TOTALSIZE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;microcode: error! Bad data in microcode data file&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|data_size
op_assign
id|get_datasize
c_func
(paren
op_amp
id|mc_header
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data_size
op_plus
id|MC_HEADER_SIZE
OG
id|total_size
)paren
op_logical_or
(paren
id|data_size
OL
id|DEFAULT_UCODE_DATASIZE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;microcode: error! Bad data in microcode data file&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mc_header.ldrver
op_ne
l_int|1
op_logical_or
id|mc_header.hdrver
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;microcode: error! Unknown microcode update format&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_for
c_loop
(paren
id|cpu_num
op_assign
l_int|0
suffix:semicolon
id|cpu_num
OL
id|num_online_cpus
c_func
(paren
)paren
suffix:semicolon
id|cpu_num
op_increment
)paren
(brace
r_struct
id|ucode_cpu_info
op_star
id|uci
op_assign
id|ucode_cpu_info
op_plus
id|cpu_num
suffix:semicolon
r_if
c_cond
(paren
id|uci-&gt;err
op_ne
id|MC_NOTFOUND
)paren
multiline_comment|/* already found a match or not an online cpu*/
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|sigmatch
c_func
(paren
id|mc_header.sig
comma
id|uci-&gt;sig
comma
id|mc_header.pf
comma
id|uci-&gt;pf
)paren
)paren
id|mark_microcode_update
c_func
(paren
id|cpu_num
comma
op_amp
id|mc_header
comma
id|mc_header.sig
comma
id|mc_header.pf
comma
id|mc_header.cksum
)paren
suffix:semicolon
)brace
id|ext_table_size
op_assign
id|total_size
op_minus
(paren
id|MC_HEADER_SIZE
op_plus
id|data_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ext_table_size
)paren
(brace
r_struct
id|extended_sigtable
id|ext_header
suffix:semicolon
r_struct
id|extended_signature
id|ext_sig
suffix:semicolon
r_int
id|ext_sigcount
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ext_table_size
OL
id|EXT_HEADER_SIZE
)paren
op_logical_or
(paren
(paren
id|ext_table_size
op_minus
id|EXT_HEADER_SIZE
)paren
op_mod
id|EXT_SIGNATURE_SIZE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;microcode: error! Bad data in microcode data file&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ext_header
comma
id|user_buffer
op_plus
id|cursor
op_plus
id|MC_HEADER_SIZE
op_plus
id|data_size
comma
id|EXT_HEADER_SIZE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;microcode: error! Can not read user data&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ext_table_size
op_ne
id|exttable_size
c_func
(paren
op_amp
id|ext_header
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;microcode: error! Bad data in microcode data file&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ext_sigcount
op_assign
id|ext_header.count
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ext_sigcount
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ext_sig
comma
id|user_buffer
op_plus
id|cursor
op_plus
id|MC_HEADER_SIZE
op_plus
id|data_size
op_plus
id|EXT_HEADER_SIZE
op_plus
id|EXT_SIGNATURE_SIZE
op_star
id|i
comma
id|EXT_SIGNATURE_SIZE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;microcode: error! Can not read user data&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_for
c_loop
(paren
id|cpu_num
op_assign
l_int|0
suffix:semicolon
id|cpu_num
OL
id|num_online_cpus
c_func
(paren
)paren
suffix:semicolon
id|cpu_num
op_increment
)paren
(brace
r_struct
id|ucode_cpu_info
op_star
id|uci
op_assign
id|ucode_cpu_info
op_plus
id|cpu_num
suffix:semicolon
r_if
c_cond
(paren
id|uci-&gt;err
op_ne
id|MC_NOTFOUND
)paren
multiline_comment|/* already found a match or not an online cpu*/
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|sigmatch
c_func
(paren
id|ext_sig.sig
comma
id|uci-&gt;sig
comma
id|ext_sig.pf
comma
id|uci-&gt;pf
)paren
)paren
(brace
id|mark_microcode_update
c_func
(paren
id|cpu_num
comma
op_amp
id|mc_header
comma
id|ext_sig.sig
comma
id|ext_sig.pf
comma
id|ext_sig.cksum
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* now check if any cpu has matched */
r_for
c_loop
(paren
id|cpu_num
op_assign
l_int|0
comma
id|allocated_flag
op_assign
l_int|0
comma
id|sum
op_assign
l_int|0
suffix:semicolon
id|cpu_num
OL
id|num_online_cpus
c_func
(paren
)paren
suffix:semicolon
id|cpu_num
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ucode_cpu_info
(braket
id|cpu_num
)braket
dot
id|err
op_eq
id|MC_MARKED
)paren
(brace
r_struct
id|ucode_cpu_info
op_star
id|uci
op_assign
id|ucode_cpu_info
op_plus
id|cpu_num
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|allocated_flag
)paren
(brace
id|allocated_flag
op_assign
l_int|1
suffix:semicolon
id|newmc
op_assign
id|vmalloc
c_func
(paren
id|total_size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|newmc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;microcode: error! Can not allocate memory&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|newmc
op_plus
id|MC_HEADER_SIZE
comma
id|user_buffer
op_plus
id|cursor
op_plus
id|MC_HEADER_SIZE
comma
id|total_size
op_minus
id|MC_HEADER_SIZE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;microcode: error! Can not read user data&bslash;n&quot;
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|newmc
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|newmc
comma
op_amp
id|mc_header
comma
id|MC_HEADER_SIZE
)paren
suffix:semicolon
multiline_comment|/* check extended table checksum */
r_if
c_cond
(paren
id|ext_table_size
)paren
(brace
r_int
id|ext_table_sum
op_assign
l_int|0
suffix:semicolon
r_int
op_star
id|ext_tablep
op_assign
(paren
(paren
(paren
r_void
op_star
)paren
id|newmc
)paren
op_plus
id|MC_HEADER_SIZE
op_plus
id|data_size
)paren
suffix:semicolon
id|i
op_assign
id|ext_table_size
op_div
id|DWSIZE
suffix:semicolon
r_while
c_loop
(paren
id|i
op_decrement
)paren
id|ext_table_sum
op_add_assign
id|ext_tablep
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ext_table_sum
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;microcode: aborting, bad extended signature table checksum&bslash;n&quot;
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|newmc
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
multiline_comment|/* calculate the checksum */
id|i
op_assign
(paren
id|MC_HEADER_SIZE
op_plus
id|data_size
)paren
op_div
id|DWSIZE
suffix:semicolon
r_while
c_loop
(paren
id|i
op_decrement
)paren
id|sum
op_add_assign
(paren
(paren
r_int
op_star
)paren
id|newmc
)paren
(braket
id|i
)braket
suffix:semicolon
id|sum
op_sub_assign
(paren
id|mc_header.sig
op_plus
id|mc_header.pf
op_plus
id|mc_header.cksum
)paren
suffix:semicolon
)brace
id|ucode_cpu_info
(braket
id|cpu_num
)braket
dot
id|mc
op_assign
id|newmc
suffix:semicolon
id|ucode_cpu_info
(braket
id|cpu_num
)braket
dot
id|err
op_assign
id|MC_ALLOCATED
suffix:semicolon
multiline_comment|/* mc updated */
r_if
c_cond
(paren
id|sum
op_plus
id|uci-&gt;sig
op_plus
id|uci-&gt;pf
op_plus
id|uci-&gt;cksum
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;microcode: CPU%d aborting, bad checksum&bslash;n&quot;
comma
id|cpu_num
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
)brace
id|cursor
op_add_assign
id|total_size
suffix:semicolon
multiline_comment|/* goto the next update patch */
)brace
multiline_comment|/* end of while */
id|out
suffix:colon
r_return
id|error
suffix:semicolon
)brace
DECL|function|do_update_one
r_static
r_void
id|do_update_one
(paren
r_void
op_star
id|unused
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|val
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|cpu_num
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_struct
id|ucode_cpu_info
op_star
id|uci
op_assign
id|ucode_cpu_info
op_plus
id|cpu_num
suffix:semicolon
r_if
c_cond
(paren
id|uci-&gt;mc
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;microcode: No suitable data for CPU%d&bslash;n&quot;
comma
id|cpu_num
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* serialize access to the physical write to MSR 0x79 */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|microcode_update_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* write microcode via MSR 0x79 */
id|wrmsr
c_func
(paren
id|MSR_IA32_UCODE_WRITE
comma
(paren
r_int
r_int
)paren
id|uci-&gt;mc-&gt;bits
comma
(paren
r_int
r_int
)paren
id|uci-&gt;mc-&gt;bits
op_rshift
l_int|16
op_rshift
l_int|16
)paren
suffix:semicolon
id|wrmsr
c_func
(paren
id|MSR_IA32_UCODE_REV
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|__asm__
id|__volatile__
(paren
l_string|&quot;cpuid&quot;
suffix:colon
suffix:colon
suffix:colon
l_string|&quot;ax&quot;
comma
l_string|&quot;bx&quot;
comma
l_string|&quot;cx&quot;
comma
l_string|&quot;dx&quot;
)paren
suffix:semicolon
multiline_comment|/* get the current revision from MSR 0x8B */
id|rdmsr
c_func
(paren
id|MSR_IA32_UCODE_REV
comma
id|val
(braket
l_int|0
)braket
comma
id|val
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* notify the caller of success on this cpu */
id|uci-&gt;err
op_assign
id|MC_SUCCESS
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|microcode_update_lock
comma
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;microcode: CPU%d updated from revision &quot;
l_string|&quot;0x%x to 0x%x, date = %08x &bslash;n&quot;
comma
id|cpu_num
comma
id|uci-&gt;rev
comma
id|val
(braket
l_int|1
)braket
comma
id|uci-&gt;mc-&gt;hdr.date
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|do_microcode_update
r_static
r_int
id|do_microcode_update
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|error
suffix:semicolon
r_if
c_cond
(paren
id|on_each_cpu
c_func
(paren
id|collect_cpu_info
comma
l_int|NULL
comma
l_int|1
comma
l_int|1
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;microcode: Error! Could not run on all processors&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|error
op_assign
id|find_matching_ucodes
c_func
(paren
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;microcode: Error in the microcode data&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
r_if
c_cond
(paren
id|on_each_cpu
c_func
(paren
id|do_update_one
comma
l_int|NULL
comma
l_int|1
comma
l_int|1
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;microcode: Error! Could not run on all processors&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
id|out_free
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_online_cpus
c_func
(paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ucode_cpu_info
(braket
id|i
)braket
dot
id|mc
)paren
(brace
r_int
id|j
suffix:semicolon
r_void
op_star
id|tmp
op_assign
id|ucode_cpu_info
(braket
id|i
)braket
dot
id|mc
suffix:semicolon
id|vfree
c_func
(paren
id|tmp
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
id|i
suffix:semicolon
id|j
OL
id|num_online_cpus
c_func
(paren
)paren
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ucode_cpu_info
(braket
id|j
)braket
dot
id|mc
op_eq
id|tmp
)paren
id|ucode_cpu_info
(braket
id|j
)braket
dot
id|mc
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
id|out
suffix:colon
r_return
id|error
suffix:semicolon
)brace
DECL|function|microcode_write
r_static
id|ssize_t
id|microcode_write
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|len
comma
id|loff_t
op_star
id|ppos
)paren
(brace
id|ssize_t
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|DEFAULT_UCODE_TOTALSIZE
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;microcode: not enough data&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|len
op_rshift
id|PAGE_SHIFT
)paren
OG
id|num_physpages
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;microcode: too much data (max %ld pages)&bslash;n&quot;
comma
id|num_physpages
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|microcode_sem
)paren
suffix:semicolon
id|user_buffer
op_assign
(paren
r_void
id|__user
op_star
)paren
id|buf
suffix:semicolon
id|user_buffer_size
op_assign
(paren
r_int
)paren
id|len
suffix:semicolon
id|ret
op_assign
id|do_microcode_update
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
(paren
id|ssize_t
)paren
id|len
suffix:semicolon
id|up
c_func
(paren
op_amp
id|microcode_sem
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|microcode_ioctl
r_static
r_int
id|microcode_ioctl
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
multiline_comment|/* &n;&t;&t; *  XXX: will be removed after microcode_ctl &n;&t;&t; *  is updated to ignore failure of this ioctl()&n;&t;&t; */
r_case
id|MICROCODE_IOCFREE
suffix:colon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|variable|microcode_fops
r_static
r_struct
id|file_operations
id|microcode_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|write
op_assign
id|microcode_write
comma
dot
id|ioctl
op_assign
id|microcode_ioctl
comma
dot
id|open
op_assign
id|microcode_open
comma
)brace
suffix:semicolon
DECL|variable|microcode_dev
r_static
r_struct
id|miscdevice
id|microcode_dev
op_assign
(brace
dot
id|minor
op_assign
id|MICROCODE_MINOR
comma
dot
id|name
op_assign
l_string|&quot;microcode&quot;
comma
dot
id|devfs_name
op_assign
l_string|&quot;cpu/microcode&quot;
comma
dot
id|fops
op_assign
op_amp
id|microcode_fops
comma
)brace
suffix:semicolon
DECL|function|microcode_init
r_static
r_int
id|__init
id|microcode_init
(paren
r_void
)paren
(brace
r_int
id|error
suffix:semicolon
id|error
op_assign
id|misc_register
c_func
(paren
op_amp
id|microcode_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;microcode: can&squot;t misc_register on minor=%d&bslash;n&quot;
comma
id|MICROCODE_MINOR
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;IA-32 Microcode Update Driver: v&quot;
id|MICROCODE_VERSION
l_string|&quot; &lt;tigran@veritas.com&gt;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|microcode_exit
r_static
r_void
id|__exit
id|microcode_exit
(paren
r_void
)paren
(brace
id|misc_deregister
c_func
(paren
op_amp
id|microcode_dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;IA-32 Microcode Update Driver v&quot;
id|MICROCODE_VERSION
l_string|&quot; unregistered&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|module_init
c_func
(paren
id|microcode_init
)paren
id|module_exit
c_func
(paren
id|microcode_exit
)paren
id|MODULE_ALIAS_MISCDEV
c_func
(paren
id|MICROCODE_MINOR
)paren
suffix:semicolon
eof
