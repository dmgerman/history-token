multiline_comment|/*&n; *  Unmaintained SGI Visual Workstation support.&n; *  Split out from setup.c by davej@suse.de&n; */
DECL|variable|visws_board_type
r_char
id|visws_board_type
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|visws_board_rev
r_char
id|visws_board_rev
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|macro|PIIX_PM_START
mdefine_line|#define&t;PIIX_PM_START&t;&t;0x0F80
DECL|macro|SIO_GPIO_START
mdefine_line|#define&t;SIO_GPIO_START&t;&t;0x0FC0
DECL|macro|SIO_PM_START
mdefine_line|#define&t;SIO_PM_START&t;&t;0x0FC8
DECL|macro|PMBASE
mdefine_line|#define&t;PMBASE&t;&t;&t;PIIX_PM_START
DECL|macro|GPIREG0
mdefine_line|#define&t;GPIREG0&t;&t;&t;(PMBASE+0x30)
DECL|macro|GPIREG
mdefine_line|#define&t;GPIREG(x)&t;&t;(GPIREG0+((x)/8))
DECL|macro|PIIX_GPI_BD_ID1
mdefine_line|#define&t;PIIX_GPI_BD_ID1&t;&t;18
DECL|macro|PIIX_GPI_BD_REG
mdefine_line|#define&t;PIIX_GPI_BD_REG&t;&t;GPIREG(PIIX_GPI_BD_ID1)
DECL|macro|PIIX_GPI_BD_SHIFT
mdefine_line|#define&t;PIIX_GPI_BD_SHIFT&t;(PIIX_GPI_BD_ID1 % 8)
DECL|macro|SIO_INDEX
mdefine_line|#define&t;SIO_INDEX&t;0x2e
DECL|macro|SIO_DATA
mdefine_line|#define&t;SIO_DATA&t;0x2f
DECL|macro|SIO_DEV_SEL
mdefine_line|#define&t;SIO_DEV_SEL&t;0x7
DECL|macro|SIO_DEV_ENB
mdefine_line|#define&t;SIO_DEV_ENB&t;0x30
DECL|macro|SIO_DEV_MSB
mdefine_line|#define&t;SIO_DEV_MSB&t;0x60
DECL|macro|SIO_DEV_LSB
mdefine_line|#define&t;SIO_DEV_LSB&t;0x61
DECL|macro|SIO_GP_DEV
mdefine_line|#define&t;SIO_GP_DEV&t;0x7
DECL|macro|SIO_GP_BASE
mdefine_line|#define&t;SIO_GP_BASE&t;SIO_GPIO_START
DECL|macro|SIO_GP_MSB
mdefine_line|#define&t;SIO_GP_MSB&t;(SIO_GP_BASE&gt;&gt;8)
DECL|macro|SIO_GP_LSB
mdefine_line|#define&t;SIO_GP_LSB&t;(SIO_GP_BASE&amp;0xff)
DECL|macro|SIO_GP_DATA1
mdefine_line|#define&t;SIO_GP_DATA1&t;(SIO_GP_BASE+0)
DECL|macro|SIO_PM_DEV
mdefine_line|#define&t;SIO_PM_DEV&t;0x8
DECL|macro|SIO_PM_BASE
mdefine_line|#define&t;SIO_PM_BASE&t;SIO_PM_START
DECL|macro|SIO_PM_MSB
mdefine_line|#define&t;SIO_PM_MSB&t;(SIO_PM_BASE&gt;&gt;8)
DECL|macro|SIO_PM_LSB
mdefine_line|#define&t;SIO_PM_LSB&t;(SIO_PM_BASE&amp;0xff)
DECL|macro|SIO_PM_INDEX
mdefine_line|#define&t;SIO_PM_INDEX&t;(SIO_PM_BASE+0)
DECL|macro|SIO_PM_DATA
mdefine_line|#define&t;SIO_PM_DATA&t;(SIO_PM_BASE+1)
DECL|macro|SIO_PM_FER2
mdefine_line|#define&t;SIO_PM_FER2&t;0x1
DECL|macro|SIO_PM_GP_EN
mdefine_line|#define&t;SIO_PM_GP_EN&t;0x80
DECL|function|visws_get_board_type_and_rev
r_void
id|__init
id|visws_get_board_type_and_rev
c_func
(paren
r_void
)paren
(brace
r_int
id|raw
suffix:semicolon
id|visws_board_type
op_assign
(paren
r_char
)paren
(paren
id|inb_p
c_func
(paren
id|PIIX_GPI_BD_REG
)paren
op_amp
id|PIIX_GPI_BD_REG
)paren
op_rshift
id|PIIX_GPI_BD_SHIFT
suffix:semicolon
multiline_comment|/*&n; * Get Board rev.&n; * First, we have to initialize the 307 part to allow us access&n; * to the GPIO registers.  Let&squot;s map them at 0x0fc0 which is right&n; * after the PIIX4 PM section.&n; */
id|outb_p
c_func
(paren
id|SIO_DEV_SEL
comma
id|SIO_INDEX
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|SIO_GP_DEV
comma
id|SIO_DATA
)paren
suffix:semicolon
multiline_comment|/* Talk to GPIO regs. */
id|outb_p
c_func
(paren
id|SIO_DEV_MSB
comma
id|SIO_INDEX
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|SIO_GP_MSB
comma
id|SIO_DATA
)paren
suffix:semicolon
multiline_comment|/* MSB of GPIO base address */
id|outb_p
c_func
(paren
id|SIO_DEV_LSB
comma
id|SIO_INDEX
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|SIO_GP_LSB
comma
id|SIO_DATA
)paren
suffix:semicolon
multiline_comment|/* LSB of GPIO base address */
id|outb_p
c_func
(paren
id|SIO_DEV_ENB
comma
id|SIO_INDEX
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|1
comma
id|SIO_DATA
)paren
suffix:semicolon
multiline_comment|/* Enable GPIO registers. */
multiline_comment|/*&n; * Now, we have to map the power management section to write&n; * a bit which enables access to the GPIO registers.&n; * What lunatic came up with this shit?&n; */
id|outb_p
c_func
(paren
id|SIO_DEV_SEL
comma
id|SIO_INDEX
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|SIO_PM_DEV
comma
id|SIO_DATA
)paren
suffix:semicolon
multiline_comment|/* Talk to GPIO regs. */
id|outb_p
c_func
(paren
id|SIO_DEV_MSB
comma
id|SIO_INDEX
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|SIO_PM_MSB
comma
id|SIO_DATA
)paren
suffix:semicolon
multiline_comment|/* MSB of PM base address */
id|outb_p
c_func
(paren
id|SIO_DEV_LSB
comma
id|SIO_INDEX
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|SIO_PM_LSB
comma
id|SIO_DATA
)paren
suffix:semicolon
multiline_comment|/* LSB of PM base address */
id|outb_p
c_func
(paren
id|SIO_DEV_ENB
comma
id|SIO_INDEX
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|1
comma
id|SIO_DATA
)paren
suffix:semicolon
multiline_comment|/* Enable PM registers. */
multiline_comment|/*&n; * Now, write the PM register which enables the GPIO registers.&n; */
id|outb_p
c_func
(paren
id|SIO_PM_FER2
comma
id|SIO_PM_INDEX
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|SIO_PM_GP_EN
comma
id|SIO_PM_DATA
)paren
suffix:semicolon
multiline_comment|/*&n; * Now, initialize the GPIO registers.&n; * We want them all to be inputs which is the&n; * power on default, so let&squot;s leave them alone.&n; * So, let&squot;s just read the board rev!&n; */
id|raw
op_assign
id|inb_p
c_func
(paren
id|SIO_GP_DATA1
)paren
suffix:semicolon
id|raw
op_and_assign
l_int|0x7f
suffix:semicolon
multiline_comment|/* 7 bits of valid board revision ID. */
r_if
c_cond
(paren
id|visws_board_type
op_eq
id|VISWS_320
)paren
(brace
r_if
c_cond
(paren
id|raw
OL
l_int|0x6
)paren
(brace
id|visws_board_rev
op_assign
l_int|4
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|raw
OL
l_int|0xc
)paren
(brace
id|visws_board_rev
op_assign
l_int|5
suffix:semicolon
)brace
r_else
(brace
id|visws_board_rev
op_assign
l_int|6
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|visws_board_type
op_eq
id|VISWS_540
)paren
(brace
id|visws_board_rev
op_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|visws_board_rev
op_assign
id|raw
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Silicon Graphics %s (rev %d)&bslash;n&quot;
comma
id|visws_board_type
op_eq
id|VISWS_320
ques
c_cond
l_string|&quot;320&quot;
suffix:colon
(paren
id|visws_board_type
op_eq
id|VISWS_540
ques
c_cond
l_string|&quot;540&quot;
suffix:colon
l_string|&quot;unknown&quot;
)paren
comma
id|visws_board_rev
)paren
suffix:semicolon
)brace
)brace
eof
