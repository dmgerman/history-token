multiline_comment|/*&n; *  acpi.c - Architecture-Specific Low-Level ACPI Support&n; *&n; *  Copyright (C) 2001 Paul Diefenbaugh &lt;paul.s.diefenbaugh@intel.com&gt;&n; *  Copyright (C) 2001 Jun Nakajima &lt;jun.nakajima@intel.com&gt;&n; *  Copyright (C) 2001 Patrick Mochel &lt;mochel@osdl.org&gt;&n; *&n; * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; *&n; * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/acpi.h&gt;
macro_line|#include &lt;asm/mpspec.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/apic.h&gt;
macro_line|#include &lt;asm/apicdef.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/pgalloc.h&gt;
macro_line|#include &lt;asm/io_apic.h&gt;
macro_line|#include &lt;asm/tlbflush.h&gt;
DECL|macro|PREFIX
mdefine_line|#define PREFIX&t;&t;&t;&quot;ACPI: &quot;
r_extern
r_struct
id|acpi_boot_flags
id|acpi_boot
suffix:semicolon
DECL|variable|acpi_mp_config
r_int
id|acpi_mp_config
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------------&n;                              Boot-time Configuration&n;   -------------------------------------------------------------------------- */
macro_line|#ifdef CONFIG_ACPI_BOOT
multiline_comment|/*&n; * Use reserved fixmap pages for physical-to-virtual mappings of ACPI tables.&n; * Note that the same range is used for each table, so tables that need to&n; * persist should be memcpy&squot;d.&n; */
r_char
op_star
DECL|function|__acpi_map_table
id|__acpi_map_table
(paren
r_int
r_int
id|phys_addr
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|base
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|mapped_phys
op_assign
id|phys_addr
suffix:semicolon
r_int
r_int
id|offset
op_assign
id|phys_addr
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
r_int
r_int
id|mapped_size
op_assign
id|PAGE_SIZE
op_minus
id|offset
suffix:semicolon
r_int
r_int
id|avail_size
op_assign
id|mapped_size
op_plus
(paren
id|PAGE_SIZE
op_star
id|FIX_ACPI_PAGES
)paren
suffix:semicolon
r_int
id|idx
op_assign
id|FIX_ACPI_BEGIN
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|phys_addr
op_logical_or
op_logical_neg
id|size
)paren
r_return
l_int|NULL
suffix:semicolon
id|base
op_assign
id|fix_to_virt
c_func
(paren
id|FIX_ACPI_BEGIN
)paren
suffix:semicolon
id|set_fixmap
c_func
(paren
id|idx
comma
id|mapped_phys
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|avail_size
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* If the table doesn&squot;t map completely into the fist page... */
r_if
c_cond
(paren
id|size
OG
id|mapped_size
)paren
(brace
r_do
(brace
multiline_comment|/* Make sure we don&squot;t go past our range */
r_if
c_cond
(paren
id|idx
op_increment
op_eq
id|FIX_ACPI_END
)paren
r_return
l_int|NULL
suffix:semicolon
id|mapped_phys
op_assign
id|mapped_phys
op_plus
id|PAGE_SIZE
suffix:semicolon
id|set_fixmap
c_func
(paren
id|idx
comma
id|mapped_phys
)paren
suffix:semicolon
id|mapped_size
op_assign
id|mapped_size
op_plus
id|PAGE_SIZE
suffix:semicolon
)brace
r_while
c_loop
(paren
id|mapped_size
OL
id|size
)paren
suffix:semicolon
)brace
r_return
(paren
(paren
r_int
r_char
op_star
)paren
id|base
op_plus
id|offset
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_X86_LOCAL_APIC
DECL|variable|__initdata
r_static
r_int
id|total_cpus
id|__initdata
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* From mpparse.c */
r_extern
r_void
id|__init
id|MP_processor_info
c_func
(paren
r_struct
id|mpc_config_processor
op_star
)paren
suffix:semicolon
r_extern
r_void
id|__init
id|MP_ioapic_info
(paren
r_struct
id|mpc_config_ioapic
op_star
)paren
suffix:semicolon
r_extern
r_void
id|__init
id|MP_lintsrc_info
c_func
(paren
r_struct
id|mpc_config_lintsrc
op_star
)paren
suffix:semicolon
r_int
id|__init
DECL|function|acpi_parse_lapic
id|acpi_parse_lapic
(paren
id|acpi_table_entry_header
op_star
id|header
)paren
(brace
r_struct
id|acpi_table_lapic
op_star
id|cpu
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|mpc_config_processor
id|processor
suffix:semicolon
id|cpu
op_assign
(paren
r_struct
id|acpi_table_lapic
op_star
)paren
id|header
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpu
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|acpi_table_print_madt_entry
c_func
(paren
id|header
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpu-&gt;flags.enabled
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Processor #%d disabled&bslash;n&quot;
comma
id|cpu-&gt;id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cpu-&gt;id
op_ge
id|MAX_APICS
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Processor #%d invalid (max %d)&bslash;n&quot;
comma
id|cpu-&gt;id
comma
id|MAX_APICS
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Fill in the info we want to save.  Not concerned about&n;&t; * the processor ID.  Processor features aren&squot;t present in&n;&t; * the table.&n;&t; */
id|processor.mpc_type
op_assign
id|MP_PROCESSOR
suffix:semicolon
id|processor.mpc_apicid
op_assign
id|cpu-&gt;id
suffix:semicolon
id|processor.mpc_cpuflag
op_assign
id|CPU_ENABLED
suffix:semicolon
r_if
c_cond
(paren
id|cpu-&gt;id
op_eq
id|boot_cpu_physical_apicid
)paren
(brace
multiline_comment|/* TBD: Circular reference trying to establish BSP */
id|processor.mpc_cpuflag
op_or_assign
id|CPU_BOOTPROCESSOR
suffix:semicolon
)brace
id|processor.mpc_cpufeature
op_assign
(paren
id|boot_cpu_data.x86
op_lshift
l_int|8
)paren
op_or
(paren
id|boot_cpu_data.x86_model
op_lshift
l_int|4
)paren
op_or
id|boot_cpu_data.x86_mask
suffix:semicolon
id|processor.mpc_featureflag
op_assign
id|boot_cpu_data.x86_capability
(braket
l_int|0
)braket
suffix:semicolon
id|processor.mpc_reserved
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|processor.mpc_reserved
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|processor.mpc_apicver
op_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* Integrated APIC */
id|MP_processor_info
c_func
(paren
op_amp
id|processor
)paren
suffix:semicolon
id|total_cpus
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
id|__init
DECL|function|acpi_parse_lapic_addr_ovr
id|acpi_parse_lapic_addr_ovr
(paren
id|acpi_table_entry_header
op_star
id|header
)paren
(brace
r_struct
id|acpi_table_lapic_addr_ovr
op_star
id|lapic_addr_ovr
op_assign
l_int|NULL
suffix:semicolon
id|lapic_addr_ovr
op_assign
(paren
r_struct
id|acpi_table_lapic_addr_ovr
op_star
)paren
id|header
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lapic_addr_ovr
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* TBD: Support local APIC address override entries */
r_return
l_int|0
suffix:semicolon
)brace
r_int
id|__init
DECL|function|acpi_parse_lapic_nmi
id|acpi_parse_lapic_nmi
(paren
id|acpi_table_entry_header
op_star
id|header
)paren
(brace
r_struct
id|acpi_table_lapic_nmi
op_star
id|lacpi_nmi
op_assign
l_int|NULL
suffix:semicolon
id|lacpi_nmi
op_assign
(paren
r_struct
id|acpi_table_lapic_nmi
op_star
)paren
id|header
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lacpi_nmi
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|acpi_table_print_madt_entry
c_func
(paren
id|header
)paren
suffix:semicolon
multiline_comment|/* TBD: Support lapic_nmi entries */
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /*CONFIG_X86_LOCAL_APIC*/
macro_line|#ifdef CONFIG_X86_IO_APIC
r_int
id|__init
DECL|function|acpi_parse_ioapic
id|acpi_parse_ioapic
(paren
id|acpi_table_entry_header
op_star
id|header
)paren
(brace
r_struct
id|acpi_table_ioapic
op_star
id|ioapic
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t;struct mpc_config_ioapic mp_ioapic;&n;&t;struct IO_APIC_reg_01&t;reg_01;&n;&t;*/
id|ioapic
op_assign
(paren
r_struct
id|acpi_table_ioapic
op_star
)paren
id|header
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioapic
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|acpi_table_print_madt_entry
c_func
(paren
id|header
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Cobble up an entry for the IOAPIC (just as we do for LAPIC entries).&n;&t; * Note that we aren&squot;t doing anything with ioapic-&gt;vector, and &n;&t; * mpc_apicver gets read directly from ioapic.&n;&t; */
multiline_comment|/*&n;&t; * TBD: Complete I/O APIC support.&n;&t; *&n;&t;mp_ioapic.mpc_type = MP_IOAPIC;&n;&t;mp_ioapic.mpc_apicid = ioapic-&gt;id;&n;&t;mp_ioapic.mpc_flags = MPC_APIC_USABLE;&n;&t;mp_ioapic.mpc_apicaddr = ioapic-&gt;address;&n;&t;set_fixmap_nocache(nr_ioapics + FIX_IO_APIC_BASE_0,&n;&t;&t;mp_ioapic.mpc_apicaddr);&n;&n;&t;printk(&quot;mapped IOAPIC to %08lx (%08lx)&bslash;n&quot;,&n;&t;&t;__fix_to_virt(nr_ioapics), mp_ioapic.mpc_apicaddr);&n;&n;&t;*(int *)&amp;reg_01 = io_apic_read(nr_ioapics, 1);&n;&t;mp_ioapic.mpc_apicver = reg_01.version;&n;&t;MP_ioapic_info(&amp;mp_ioapic);&n;&t; */
r_return
l_int|0
suffix:semicolon
)brace
r_int
id|__init
DECL|function|acpi_parse_int_src_ovr
id|acpi_parse_int_src_ovr
(paren
id|acpi_table_entry_header
op_star
id|header
)paren
(brace
r_struct
id|acpi_table_int_src_ovr
op_star
id|int_src_ovr
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t;struct mpc_config_intsrc my_intsrc;&n;&t;int&t;&t;&t;i = 0;&n;&t;*/
id|int_src_ovr
op_assign
(paren
r_struct
id|acpi_table_int_src_ovr
op_star
)paren
id|header
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|int_src_ovr
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|acpi_table_print_madt_entry
c_func
(paren
id|header
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * TBD: Complete I/O APIC support.&n;&t; *&n;&t;my_intsrc.mpc_type = MP_INTSRC;&n;&t;my_intsrc.mpc_irqtype = mp_INT;&n;&t;my_intsrc.mpc_irqflag = *(unsigned short*)(&amp;(int_src_ovr-&gt;flags));&n;&t;my_intsrc.mpc_srcbus = int_src_ovr-&gt;bus;&n;&t;my_intsrc.mpc_srcbusirq = int_src_ovr-&gt;bus_irq;&n;&t;my_intsrc.mpc_dstapic = 0;&n;&t;my_intsrc.mpc_dstirq = int_src_ovr-&gt;global_irq;&n;&n;&t;for (i = 0; i &lt; mp_irq_entries; i++) {&n;&t;&t;if (mp_irqs[i].mpc_srcbusirq == my_intsrc.mpc_srcbusirq) {&n;&t;&t;&t;mp_irqs[i] = my_intsrc;&n;&t;&t;&t;break;&n;&t;&t;}&n;&t;}&n;&t; */
r_return
l_int|0
suffix:semicolon
)brace
r_int
id|__init
DECL|function|acpi_parse_nmi_src
id|acpi_parse_nmi_src
(paren
id|acpi_table_entry_header
op_star
id|header
)paren
(brace
r_struct
id|acpi_table_nmi_src
op_star
id|nmi_src
op_assign
l_int|NULL
suffix:semicolon
id|nmi_src
op_assign
(paren
r_struct
id|acpi_table_nmi_src
op_star
)paren
id|header
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nmi_src
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|acpi_table_print_madt_entry
c_func
(paren
id|header
)paren
suffix:semicolon
multiline_comment|/* TBD: Support nimsrc entries */
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /*CONFIG_X86_IO_APIC*/
r_int
id|__init
DECL|function|acpi_parse_madt
id|acpi_parse_madt
(paren
r_int
r_int
id|phys_addr
comma
r_int
r_int
id|size
)paren
(brace
r_struct
id|acpi_table_madt
op_star
id|madt
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|phys_addr
op_logical_or
op_logical_neg
id|size
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|madt
op_assign
(paren
r_struct
id|acpi_table_madt
op_star
)paren
id|__acpi_map_table
c_func
(paren
id|phys_addr
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|madt
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;Unable to map MADT&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_X86_LOCAL_APIC
r_if
c_cond
(paren
id|madt-&gt;lapic_address
)paren
id|mp_lapic_addr
op_assign
id|madt-&gt;lapic_address
suffix:semicolon
r_else
id|mp_lapic_addr
op_assign
id|APIC_DEFAULT_PHYS_BASE
suffix:semicolon
macro_line|#endif /*CONFIG_X86_LOCAL_APIC*/
id|printk
c_func
(paren
id|KERN_INFO
id|PREFIX
l_string|&quot;Local APIC address 0x%08x&bslash;n&quot;
comma
id|madt-&gt;lapic_address
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
r_int
id|__init
DECL|function|acpi_scan_rsdp
id|acpi_scan_rsdp
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|length
)paren
(brace
r_int
r_int
id|offset
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|sig_len
op_assign
r_sizeof
(paren
l_string|&quot;RSD PTR &quot;
)paren
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Scan all 16-byte boundaries of the physical memory region for the&n;&t; * RSDP signature.&n;&t; */
r_for
c_loop
(paren
id|offset
op_assign
l_int|0
suffix:semicolon
id|offset
OL
id|length
suffix:semicolon
id|offset
op_add_assign
l_int|16
)paren
(brace
r_if
c_cond
(paren
l_int|0
op_ne
id|strncmp
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|start
op_plus
id|offset
)paren
comma
l_string|&quot;RSD PTR &quot;
comma
id|sig_len
)paren
)paren
r_continue
suffix:semicolon
r_return
(paren
id|start
op_plus
id|offset
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_int
id|__init
DECL|function|acpi_find_rsdp
id|acpi_find_rsdp
(paren
r_int
r_int
op_star
id|rsdp_phys
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|rsdp_phys
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;&t; * Scan memory looking for the RSDP signature. First search EBDA (low&n;&t; * memory) paragraphs and then search upper memory (E0000-FFFFF).&n;&t; */
(paren
op_star
id|rsdp_phys
)paren
op_assign
id|acpi_scan_rsdp
(paren
l_int|0
comma
l_int|0x400
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|rsdp_phys
)paren
)paren
(paren
op_star
id|rsdp_phys
)paren
op_assign
id|acpi_scan_rsdp
(paren
l_int|0xE0000
comma
l_int|0xFFFFF
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|rsdp_phys
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
id|__init
DECL|function|acpi_boot_init
id|acpi_boot_init
(paren
r_char
op_star
id|cmdline
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Initialize the ACPI boot-time table parser */
id|result
op_assign
id|acpi_table_init
c_func
(paren
id|cmdline
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|result
)paren
r_return
id|result
suffix:semicolon
macro_line|#ifdef CONFIG_X86_LOCAL_APIC
macro_line|#ifdef CONFIG_X86_IO_APIC
multiline_comment|/* &n;&t; * MADT&n;&t; * ----&n;&t; * Parse the Multiple APIC Description Table (MADT), if exists.&n;&t; * Note that this table provides platform SMP configuration &n;&t; * information -- the successor to MPS tables.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|acpi_boot.madt
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|PREFIX
l_string|&quot;MADT parsing disabled via command-line&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|result
op_assign
id|acpi_table_parse
c_func
(paren
id|ACPI_APIC
comma
id|acpi_parse_madt
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|result
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;MADT not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
l_int|0
OG
id|result
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PREFIX
l_string|&quot;Error parsing MADT&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
l_int|1
OL
id|result
)paren
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;Multiple MADT tables exist&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Local APIC */
id|result
op_assign
id|acpi_table_parse_madt
c_func
(paren
id|ACPI_MADT_LAPIC_ADDR_OVR
comma
id|acpi_parse_lapic_addr_ovr
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
OG
id|result
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PREFIX
l_string|&quot;Error parsing LAPIC address override entry&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|result
op_assign
id|acpi_table_parse_madt
c_func
(paren
id|ACPI_MADT_LAPIC
comma
id|acpi_parse_lapic
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|1
OG
id|result
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PREFIX
l_string|&quot;Error parsing MADT - no LAPIC entries!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|result
op_assign
id|acpi_table_parse_madt
c_func
(paren
id|ACPI_MADT_LAPIC_NMI
comma
id|acpi_parse_lapic_nmi
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
OG
id|result
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PREFIX
l_string|&quot;Error parsing LAPIC NMI entry&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* I/O APIC */
id|result
op_assign
id|acpi_table_parse_madt
c_func
(paren
id|ACPI_MADT_IOAPIC
comma
id|acpi_parse_ioapic
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|1
OG
id|result
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PREFIX
l_string|&quot;Error parsing MADT - no IOAPIC entries!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|acpi_mp_config
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * TBD: Complete I/O APIC support.&n;&t; *&n;&t;construct_default_ACPI_table();&n;&t; */
id|result
op_assign
id|acpi_table_parse_madt
c_func
(paren
id|ACPI_MADT_INT_SRC_OVR
comma
id|acpi_parse_int_src_ovr
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
OG
id|result
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PREFIX
l_string|&quot;Error parsing interrupt source overrides entry&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|result
op_assign
id|acpi_table_parse_madt
c_func
(paren
id|ACPI_MADT_NMI_SRC
comma
id|acpi_parse_nmi_src
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
OG
id|result
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PREFIX
l_string|&quot;Error parsing NMI SRC entry&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Make boot-up look pretty */
id|printk
c_func
(paren
l_string|&quot;%d CPUs total&bslash;n&quot;
comma
id|total_cpus
)paren
suffix:semicolon
macro_line|#endif /*CONFIG_X86_IO_APIC*/
macro_line|#endif /*CONFIG_X86_LOCAL_APIC*/
macro_line|#ifdef CONFIG_SERIAL_ACPI
multiline_comment|/*&n;&t; * TBD: Need phased approach to table parsing (only do those absolutely&n;&t; *      required during boot-up).  Recommend expanding concept of fix-&n;&t; *      feature devices (ACPI Bus driver) to include table-based devices &n;&t; *      such as serial ports, EC, SMBus, etc.&n;&t; */
multiline_comment|/* acpi_table_parse(ACPI_SPCR, acpi_parse_spcr);*/
macro_line|#endif /*CONFIG_SERIAL_ACPI*/
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /*CONFIG_ACPI_BOOT*/
r_int
id|__init
DECL|function|acpi_get_interrupt_model
id|acpi_get_interrupt_model
(paren
r_int
op_star
id|type
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|type
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#ifdef CONFIG_X86_IO_APIC
op_star
id|type
op_assign
id|ACPI_INT_MODEL_IOAPIC
suffix:semicolon
macro_line|#else
op_star
id|type
op_assign
id|ACPI_INT_MODEL_PIC
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;                              Low-Level Sleep Support&n;   -------------------------------------------------------------------------- */
macro_line|#ifdef CONFIG_ACPI_SLEEP
DECL|macro|DEBUG
mdefine_line|#define DEBUG
macro_line|#ifdef DEBUG
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#endif
multiline_comment|/* address in low memory of the wakeup routine. */
DECL|variable|acpi_wakeup_address
r_int
r_int
id|acpi_wakeup_address
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* new page directory that we will be using */
DECL|variable|pmd
r_static
id|pmd_t
op_star
id|pmd
suffix:semicolon
multiline_comment|/* saved page directory */
DECL|variable|saved_pmd
r_static
id|pmd_t
id|saved_pmd
suffix:semicolon
multiline_comment|/* page which we&squot;ll use for the new page directory */
DECL|variable|ptep
r_static
id|pte_t
op_star
id|ptep
suffix:semicolon
r_extern
r_int
r_int
id|FASTCALL
c_func
(paren
id|acpi_copy_wakeup_routine
c_func
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
multiline_comment|/*&n; * acpi_create_identity_pmd&n; *&n; * Create a new, identity mapped pmd.&n; *&n; * Do this by creating new page directory, and marking all the pages as R/W&n; * Then set it as the new Page Middle Directory.&n; * And, of course, flush the TLB so it takes effect.&n; *&n; * We save the address of the old one, for later restoration.&n; */
DECL|function|acpi_create_identity_pmd
r_static
r_void
id|acpi_create_identity_pmd
(paren
r_void
)paren
(brace
id|pgd_t
op_star
id|pgd
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ptep
op_assign
(paren
id|pte_t
op_star
)paren
id|__get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
multiline_comment|/* fill page with low mapping */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PTRS_PER_PTE
suffix:semicolon
id|i
op_increment
)paren
id|set_pte
c_func
(paren
id|ptep
op_plus
id|i
comma
id|mk_pte_phys
c_func
(paren
id|i
op_lshift
id|PAGE_SHIFT
comma
id|PAGE_SHARED
)paren
)paren
suffix:semicolon
id|pgd
op_assign
id|pgd_offset
c_func
(paren
id|current-&gt;active_mm
comma
l_int|0
)paren
suffix:semicolon
id|pmd
op_assign
id|pmd_alloc
c_func
(paren
id|current-&gt;mm
comma
id|pgd
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* save the old pmd */
id|saved_pmd
op_assign
op_star
id|pmd
suffix:semicolon
multiline_comment|/* set the new one */
id|set_pmd
c_func
(paren
id|pmd
comma
id|__pmd
c_func
(paren
id|_PAGE_TABLE
op_plus
id|__pa
c_func
(paren
id|ptep
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* flush the TLB */
id|local_flush_tlb
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * acpi_restore_pmd&n; *&n; * Restore the old pmd saved by acpi_create_identity_pmd and&n; * free the page that said function alloc&squot;d&n; */
DECL|function|acpi_restore_pmd
r_static
r_void
id|acpi_restore_pmd
(paren
r_void
)paren
(brace
id|set_pmd
c_func
(paren
id|pmd
comma
id|saved_pmd
)paren
suffix:semicolon
id|local_flush_tlb
c_func
(paren
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|ptep
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * acpi_save_state_mem - save kernel state&n; *&n; * Create an identity mapped page table and copy the wakeup routine to&n; * low memory.&n; */
DECL|function|acpi_save_state_mem
r_int
id|acpi_save_state_mem
(paren
r_void
)paren
(brace
id|acpi_create_identity_pmd
c_func
(paren
)paren
suffix:semicolon
id|acpi_copy_wakeup_routine
c_func
(paren
id|acpi_wakeup_address
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * acpi_save_state_disk - save kernel state to disk&n; *&n; */
DECL|function|acpi_save_state_disk
r_int
id|acpi_save_state_disk
(paren
r_void
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * acpi_restore_state&n; */
DECL|function|acpi_restore_state_mem
r_void
id|acpi_restore_state_mem
(paren
r_void
)paren
(brace
id|acpi_restore_pmd
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * acpi_reserve_bootmem - do _very_ early ACPI initialisation&n; *&n; * We allocate a page in low memory for the wakeup&n; * routine for when we come back from a sleep state. The&n; * runtime allocator allows specification of &lt;16M pages, but not&n; * &lt;1M pages.&n; */
DECL|function|acpi_reserve_bootmem
r_void
id|__init
id|acpi_reserve_bootmem
c_func
(paren
r_void
)paren
(brace
id|acpi_wakeup_address
op_assign
(paren
r_int
r_int
)paren
id|alloc_bootmem_low
c_func
(paren
id|PAGE_SIZE
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ACPI: have wakeup address 0x%8.8lx&bslash;n&quot;
comma
id|acpi_wakeup_address
)paren
suffix:semicolon
)brace
macro_line|#endif /*CONFIG_ACPI_SLEEP*/
eof
