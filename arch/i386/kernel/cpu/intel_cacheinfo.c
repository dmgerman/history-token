multiline_comment|/*&n; *      Routines to indentify caches on Intel CPU.&n; *&n; *      Changes:&n; *      Venkatesh Pallipadi&t;: Adding cache identification through cpuid(4)&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/compiler.h&gt;
macro_line|#include &lt;linux/cpu.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/smp.h&gt;
DECL|macro|LVL_1_INST
mdefine_line|#define LVL_1_INST&t;1
DECL|macro|LVL_1_DATA
mdefine_line|#define LVL_1_DATA&t;2
DECL|macro|LVL_2
mdefine_line|#define LVL_2&t;&t;3
DECL|macro|LVL_3
mdefine_line|#define LVL_3&t;&t;4
DECL|macro|LVL_TRACE
mdefine_line|#define LVL_TRACE&t;5
DECL|struct|_cache_table
r_struct
id|_cache_table
(brace
DECL|member|descriptor
r_int
r_char
id|descriptor
suffix:semicolon
DECL|member|cache_type
r_char
id|cache_type
suffix:semicolon
DECL|member|size
r_int
id|size
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* all the cache descriptor types we care about (no TLB or trace cache entries) */
DECL|variable|__initdata
r_static
r_struct
id|_cache_table
id|cache_table
(braket
)braket
id|__initdata
op_assign
(brace
(brace
l_int|0x06
comma
id|LVL_1_INST
comma
l_int|8
)brace
comma
multiline_comment|/* 4-way set assoc, 32 byte line size */
(brace
l_int|0x08
comma
id|LVL_1_INST
comma
l_int|16
)brace
comma
multiline_comment|/* 4-way set assoc, 32 byte line size */
(brace
l_int|0x0a
comma
id|LVL_1_DATA
comma
l_int|8
)brace
comma
multiline_comment|/* 2 way set assoc, 32 byte line size */
(brace
l_int|0x0c
comma
id|LVL_1_DATA
comma
l_int|16
)brace
comma
multiline_comment|/* 4-way set assoc, 32 byte line size */
(brace
l_int|0x22
comma
id|LVL_3
comma
l_int|512
)brace
comma
multiline_comment|/* 4-way set assoc, sectored cache, 64 byte line size */
(brace
l_int|0x23
comma
id|LVL_3
comma
l_int|1024
)brace
comma
multiline_comment|/* 8-way set assoc, sectored cache, 64 byte line size */
(brace
l_int|0x25
comma
id|LVL_3
comma
l_int|2048
)brace
comma
multiline_comment|/* 8-way set assoc, sectored cache, 64 byte line size */
(brace
l_int|0x29
comma
id|LVL_3
comma
l_int|4096
)brace
comma
multiline_comment|/* 8-way set assoc, sectored cache, 64 byte line size */
(brace
l_int|0x2c
comma
id|LVL_1_DATA
comma
l_int|32
)brace
comma
multiline_comment|/* 8-way set assoc, 64 byte line size */
(brace
l_int|0x30
comma
id|LVL_1_INST
comma
l_int|32
)brace
comma
multiline_comment|/* 8-way set assoc, 64 byte line size */
(brace
l_int|0x39
comma
id|LVL_2
comma
l_int|128
)brace
comma
multiline_comment|/* 4-way set assoc, sectored cache, 64 byte line size */
(brace
l_int|0x3b
comma
id|LVL_2
comma
l_int|128
)brace
comma
multiline_comment|/* 2-way set assoc, sectored cache, 64 byte line size */
(brace
l_int|0x3c
comma
id|LVL_2
comma
l_int|256
)brace
comma
multiline_comment|/* 4-way set assoc, sectored cache, 64 byte line size */
(brace
l_int|0x41
comma
id|LVL_2
comma
l_int|128
)brace
comma
multiline_comment|/* 4-way set assoc, 32 byte line size */
(brace
l_int|0x42
comma
id|LVL_2
comma
l_int|256
)brace
comma
multiline_comment|/* 4-way set assoc, 32 byte line size */
(brace
l_int|0x43
comma
id|LVL_2
comma
l_int|512
)brace
comma
multiline_comment|/* 4-way set assoc, 32 byte line size */
(brace
l_int|0x44
comma
id|LVL_2
comma
l_int|1024
)brace
comma
multiline_comment|/* 4-way set assoc, 32 byte line size */
(brace
l_int|0x45
comma
id|LVL_2
comma
l_int|2048
)brace
comma
multiline_comment|/* 4-way set assoc, 32 byte line size */
(brace
l_int|0x60
comma
id|LVL_1_DATA
comma
l_int|16
)brace
comma
multiline_comment|/* 8-way set assoc, sectored cache, 64 byte line size */
(brace
l_int|0x66
comma
id|LVL_1_DATA
comma
l_int|8
)brace
comma
multiline_comment|/* 4-way set assoc, sectored cache, 64 byte line size */
(brace
l_int|0x67
comma
id|LVL_1_DATA
comma
l_int|16
)brace
comma
multiline_comment|/* 4-way set assoc, sectored cache, 64 byte line size */
(brace
l_int|0x68
comma
id|LVL_1_DATA
comma
l_int|32
)brace
comma
multiline_comment|/* 4-way set assoc, sectored cache, 64 byte line size */
(brace
l_int|0x70
comma
id|LVL_TRACE
comma
l_int|12
)brace
comma
multiline_comment|/* 8-way set assoc */
(brace
l_int|0x71
comma
id|LVL_TRACE
comma
l_int|16
)brace
comma
multiline_comment|/* 8-way set assoc */
(brace
l_int|0x72
comma
id|LVL_TRACE
comma
l_int|32
)brace
comma
multiline_comment|/* 8-way set assoc */
(brace
l_int|0x78
comma
id|LVL_2
comma
l_int|1024
)brace
comma
multiline_comment|/* 4-way set assoc, 64 byte line size */
(brace
l_int|0x79
comma
id|LVL_2
comma
l_int|128
)brace
comma
multiline_comment|/* 8-way set assoc, sectored cache, 64 byte line size */
(brace
l_int|0x7a
comma
id|LVL_2
comma
l_int|256
)brace
comma
multiline_comment|/* 8-way set assoc, sectored cache, 64 byte line size */
(brace
l_int|0x7b
comma
id|LVL_2
comma
l_int|512
)brace
comma
multiline_comment|/* 8-way set assoc, sectored cache, 64 byte line size */
(brace
l_int|0x7c
comma
id|LVL_2
comma
l_int|1024
)brace
comma
multiline_comment|/* 8-way set assoc, sectored cache, 64 byte line size */
(brace
l_int|0x7d
comma
id|LVL_2
comma
l_int|2048
)brace
comma
multiline_comment|/* 8-way set assoc, 64 byte line size */
(brace
l_int|0x7f
comma
id|LVL_2
comma
l_int|512
)brace
comma
multiline_comment|/* 2-way set assoc, 64 byte line size */
(brace
l_int|0x82
comma
id|LVL_2
comma
l_int|256
)brace
comma
multiline_comment|/* 8-way set assoc, 32 byte line size */
(brace
l_int|0x83
comma
id|LVL_2
comma
l_int|512
)brace
comma
multiline_comment|/* 8-way set assoc, 32 byte line size */
(brace
l_int|0x84
comma
id|LVL_2
comma
l_int|1024
)brace
comma
multiline_comment|/* 8-way set assoc, 32 byte line size */
(brace
l_int|0x85
comma
id|LVL_2
comma
l_int|2048
)brace
comma
multiline_comment|/* 8-way set assoc, 32 byte line size */
(brace
l_int|0x86
comma
id|LVL_2
comma
l_int|512
)brace
comma
multiline_comment|/* 4-way set assoc, 64 byte line size */
(brace
l_int|0x87
comma
id|LVL_2
comma
l_int|1024
)brace
comma
multiline_comment|/* 8-way set assoc, 64 byte line size */
(brace
l_int|0x00
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|enum|_cache_type
r_enum
id|_cache_type
(brace
DECL|enumerator|CACHE_TYPE_NULL
id|CACHE_TYPE_NULL
op_assign
l_int|0
comma
DECL|enumerator|CACHE_TYPE_DATA
id|CACHE_TYPE_DATA
op_assign
l_int|1
comma
DECL|enumerator|CACHE_TYPE_INST
id|CACHE_TYPE_INST
op_assign
l_int|2
comma
DECL|enumerator|CACHE_TYPE_UNIFIED
id|CACHE_TYPE_UNIFIED
op_assign
l_int|3
)brace
suffix:semicolon
DECL|union|_cpuid4_leaf_eax
r_union
id|_cpuid4_leaf_eax
(brace
r_struct
(brace
DECL|member|type
r_enum
id|_cache_type
id|type
suffix:colon
l_int|5
suffix:semicolon
DECL|member|level
r_int
r_int
id|level
suffix:colon
l_int|3
suffix:semicolon
DECL|member|is_self_initializing
r_int
r_int
id|is_self_initializing
suffix:colon
l_int|1
suffix:semicolon
DECL|member|is_fully_associative
r_int
r_int
id|is_fully_associative
suffix:colon
l_int|1
suffix:semicolon
DECL|member|reserved
r_int
r_int
id|reserved
suffix:colon
l_int|4
suffix:semicolon
DECL|member|num_threads_sharing
r_int
r_int
id|num_threads_sharing
suffix:colon
l_int|12
suffix:semicolon
DECL|member|num_cores_on_die
r_int
r_int
id|num_cores_on_die
suffix:colon
l_int|6
suffix:semicolon
DECL|member|split
)brace
id|split
suffix:semicolon
DECL|member|full
id|u32
id|full
suffix:semicolon
)brace
suffix:semicolon
DECL|union|_cpuid4_leaf_ebx
r_union
id|_cpuid4_leaf_ebx
(brace
r_struct
(brace
DECL|member|coherency_line_size
r_int
r_int
id|coherency_line_size
suffix:colon
l_int|12
suffix:semicolon
DECL|member|physical_line_partition
r_int
r_int
id|physical_line_partition
suffix:colon
l_int|10
suffix:semicolon
DECL|member|ways_of_associativity
r_int
r_int
id|ways_of_associativity
suffix:colon
l_int|10
suffix:semicolon
DECL|member|split
)brace
id|split
suffix:semicolon
DECL|member|full
id|u32
id|full
suffix:semicolon
)brace
suffix:semicolon
DECL|union|_cpuid4_leaf_ecx
r_union
id|_cpuid4_leaf_ecx
(brace
r_struct
(brace
DECL|member|number_of_sets
r_int
r_int
id|number_of_sets
suffix:colon
l_int|32
suffix:semicolon
DECL|member|split
)brace
id|split
suffix:semicolon
DECL|member|full
id|u32
id|full
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|_cpuid4_info
r_struct
id|_cpuid4_info
(brace
DECL|member|eax
r_union
id|_cpuid4_leaf_eax
id|eax
suffix:semicolon
DECL|member|ebx
r_union
id|_cpuid4_leaf_ebx
id|ebx
suffix:semicolon
DECL|member|ecx
r_union
id|_cpuid4_leaf_ecx
id|ecx
suffix:semicolon
DECL|member|size
r_int
r_int
id|size
suffix:semicolon
DECL|member|shared_cpu_map
id|cpumask_t
id|shared_cpu_map
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|MAX_CACHE_LEAVES
mdefine_line|#define MAX_CACHE_LEAVES&t;&t;4
DECL|variable|num_cache_leaves
r_static
r_int
r_int
id|__devinitdata
id|num_cache_leaves
suffix:semicolon
DECL|function|cpuid4_cache_lookup
r_static
r_int
id|__devinit
id|cpuid4_cache_lookup
c_func
(paren
r_int
id|index
comma
r_struct
id|_cpuid4_info
op_star
id|this_leaf
)paren
(brace
r_int
r_int
id|eax
comma
id|ebx
comma
id|ecx
comma
id|edx
suffix:semicolon
r_union
id|_cpuid4_leaf_eax
id|cache_eax
suffix:semicolon
id|cpuid_count
c_func
(paren
l_int|4
comma
id|index
comma
op_amp
id|eax
comma
op_amp
id|ebx
comma
op_amp
id|ecx
comma
op_amp
id|edx
)paren
suffix:semicolon
id|cache_eax.full
op_assign
id|eax
suffix:semicolon
r_if
c_cond
(paren
id|cache_eax.split.type
op_eq
id|CACHE_TYPE_NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|this_leaf-&gt;eax.full
op_assign
id|eax
suffix:semicolon
id|this_leaf-&gt;ebx.full
op_assign
id|ebx
suffix:semicolon
id|this_leaf-&gt;ecx.full
op_assign
id|ecx
suffix:semicolon
id|this_leaf-&gt;size
op_assign
(paren
id|this_leaf-&gt;ecx.split.number_of_sets
op_plus
l_int|1
)paren
op_star
(paren
id|this_leaf-&gt;ebx.split.coherency_line_size
op_plus
l_int|1
)paren
op_star
(paren
id|this_leaf-&gt;ebx.split.physical_line_partition
op_plus
l_int|1
)paren
op_star
(paren
id|this_leaf-&gt;ebx.split.ways_of_associativity
op_plus
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|find_num_cache_leaves
r_static
r_int
id|__init
id|find_num_cache_leaves
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|eax
comma
id|ebx
comma
id|ecx
comma
id|edx
suffix:semicolon
r_union
id|_cpuid4_leaf_eax
id|cache_eax
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|retval
op_assign
id|MAX_CACHE_LEAVES
suffix:semicolon
multiline_comment|/* Do cpuid(4) loop to find out num_cache_leaves */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_CACHE_LEAVES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cpuid_count
c_func
(paren
l_int|4
comma
id|i
comma
op_amp
id|eax
comma
op_amp
id|ebx
comma
op_amp
id|ecx
comma
op_amp
id|edx
)paren
suffix:semicolon
id|cache_eax.full
op_assign
id|eax
suffix:semicolon
r_if
c_cond
(paren
id|cache_eax.split.type
op_eq
id|CACHE_TYPE_NULL
)paren
(brace
id|retval
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|retval
suffix:semicolon
)brace
DECL|function|init_intel_cacheinfo
r_int
r_int
id|__init
id|init_intel_cacheinfo
c_func
(paren
r_struct
id|cpuinfo_x86
op_star
id|c
)paren
(brace
r_int
r_int
id|trace
op_assign
l_int|0
comma
id|l1i
op_assign
l_int|0
comma
id|l1d
op_assign
l_int|0
comma
id|l2
op_assign
l_int|0
comma
id|l3
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Cache sizes */
r_int
r_int
id|new_l1d
op_assign
l_int|0
comma
id|new_l1i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Cache sizes from cpuid(4) */
r_int
r_int
id|new_l2
op_assign
l_int|0
comma
id|new_l3
op_assign
l_int|0
comma
id|i
suffix:semicolon
multiline_comment|/* Cache sizes from cpuid(4) */
r_if
c_cond
(paren
id|c-&gt;cpuid_level
OG
l_int|4
)paren
(brace
r_static
r_int
id|is_initialized
suffix:semicolon
r_if
c_cond
(paren
id|is_initialized
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Init num_cache_leaves from boot CPU */
id|num_cache_leaves
op_assign
id|find_num_cache_leaves
c_func
(paren
)paren
suffix:semicolon
id|is_initialized
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Whenever possible use cpuid(4), deterministic cache&n;&t;&t; * parameters cpuid leaf to find the cache details&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_cache_leaves
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|_cpuid4_info
id|this_leaf
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|retval
op_assign
id|cpuid4_cache_lookup
c_func
(paren
id|i
comma
op_amp
id|this_leaf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ge
l_int|0
)paren
(brace
r_switch
c_cond
(paren
id|this_leaf.eax.split.level
)paren
(brace
r_case
l_int|1
suffix:colon
r_if
c_cond
(paren
id|this_leaf.eax.split.type
op_eq
id|CACHE_TYPE_DATA
)paren
id|new_l1d
op_assign
id|this_leaf.size
op_div
l_int|1024
suffix:semicolon
r_else
r_if
c_cond
(paren
id|this_leaf.eax.split.type
op_eq
id|CACHE_TYPE_INST
)paren
id|new_l1i
op_assign
id|this_leaf.size
op_div
l_int|1024
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|new_l2
op_assign
id|this_leaf.size
op_div
l_int|1024
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|new_l3
op_assign
id|this_leaf.size
op_div
l_int|1024
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
id|c-&gt;cpuid_level
OG
l_int|1
)paren
(brace
multiline_comment|/* supports eax=2  call */
r_int
id|i
comma
id|j
comma
id|n
suffix:semicolon
r_int
id|regs
(braket
l_int|4
)braket
suffix:semicolon
r_int
r_char
op_star
id|dp
op_assign
(paren
r_int
r_char
op_star
)paren
id|regs
suffix:semicolon
multiline_comment|/* Number of times to iterate */
id|n
op_assign
id|cpuid_eax
c_func
(paren
l_int|2
)paren
op_amp
l_int|0xFF
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cpuid
c_func
(paren
l_int|2
comma
op_amp
id|regs
(braket
l_int|0
)braket
comma
op_amp
id|regs
(braket
l_int|1
)braket
comma
op_amp
id|regs
(braket
l_int|2
)braket
comma
op_amp
id|regs
(braket
l_int|3
)braket
)paren
suffix:semicolon
multiline_comment|/* If bit 31 is set, this is an unknown format */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|3
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|regs
(braket
id|j
)braket
OL
l_int|0
)paren
id|regs
(braket
id|j
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Byte 0 is level count, not a descriptor */
r_for
c_loop
(paren
id|j
op_assign
l_int|1
suffix:semicolon
id|j
OL
l_int|16
suffix:semicolon
id|j
op_increment
)paren
(brace
r_int
r_char
id|des
op_assign
id|dp
(braket
id|j
)braket
suffix:semicolon
r_int
r_char
id|k
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* look up this descriptor in the table */
r_while
c_loop
(paren
id|cache_table
(braket
id|k
)braket
dot
id|descriptor
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|cache_table
(braket
id|k
)braket
dot
id|descriptor
op_eq
id|des
)paren
(brace
r_switch
c_cond
(paren
id|cache_table
(braket
id|k
)braket
dot
id|cache_type
)paren
(brace
r_case
id|LVL_1_INST
suffix:colon
id|l1i
op_add_assign
id|cache_table
(braket
id|k
)braket
dot
id|size
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LVL_1_DATA
suffix:colon
id|l1d
op_add_assign
id|cache_table
(braket
id|k
)braket
dot
id|size
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LVL_2
suffix:colon
id|l2
op_add_assign
id|cache_table
(braket
id|k
)braket
dot
id|size
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LVL_3
suffix:colon
id|l3
op_add_assign
id|cache_table
(braket
id|k
)braket
dot
id|size
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LVL_TRACE
suffix:colon
id|trace
op_add_assign
id|cache_table
(braket
id|k
)braket
dot
id|size
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|k
op_increment
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|new_l1d
)paren
id|l1d
op_assign
id|new_l1d
suffix:semicolon
r_if
c_cond
(paren
id|new_l1i
)paren
id|l1i
op_assign
id|new_l1i
suffix:semicolon
r_if
c_cond
(paren
id|new_l2
)paren
id|l2
op_assign
id|new_l2
suffix:semicolon
r_if
c_cond
(paren
id|new_l3
)paren
id|l3
op_assign
id|new_l3
suffix:semicolon
r_if
c_cond
(paren
id|trace
)paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;CPU: Trace cache: %dK uops&quot;
comma
id|trace
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|l1i
)paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;CPU: L1 I cache: %dK&quot;
comma
id|l1i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|l1d
)paren
id|printk
c_func
(paren
l_string|&quot;, L1 D cache: %dK&bslash;n&quot;
comma
id|l1d
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|l2
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;CPU: L2 cache: %dK&bslash;n&quot;
comma
id|l2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|l3
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;CPU: L3 cache: %dK&bslash;n&quot;
comma
id|l3
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * This assumes the L3 cache is shared; it typically lives in&n;&t;&t; * the northbridge.  The L1 caches are included by the L2&n;&t;&t; * cache, and so should not be included for the purpose of&n;&t;&t; * SMP switching weights.&n;&t;&t; */
id|c-&gt;x86_cache_size
op_assign
id|l2
ques
c_cond
id|l2
suffix:colon
(paren
id|l1i
op_plus
id|l1d
)paren
suffix:semicolon
)brace
r_return
id|l2
suffix:semicolon
)brace
multiline_comment|/* pointer to _cpuid4_info array (for each cache leaf) */
DECL|variable|cpuid4_info
r_static
r_struct
id|_cpuid4_info
op_star
id|cpuid4_info
(braket
id|NR_CPUS
)braket
suffix:semicolon
DECL|macro|CPUID4_INFO_IDX
mdefine_line|#define CPUID4_INFO_IDX(x,y)    (&amp;((cpuid4_info[x])[y]))
macro_line|#ifdef CONFIG_SMP
DECL|function|cache_shared_cpu_map_setup
r_static
r_void
id|__devinit
id|cache_shared_cpu_map_setup
c_func
(paren
r_int
r_int
id|cpu
comma
r_int
id|index
)paren
(brace
r_struct
id|_cpuid4_info
op_star
id|this_leaf
suffix:semicolon
r_int
r_int
id|num_threads_sharing
suffix:semicolon
id|this_leaf
op_assign
id|CPUID4_INFO_IDX
c_func
(paren
id|cpu
comma
id|index
)paren
suffix:semicolon
id|num_threads_sharing
op_assign
l_int|1
op_plus
id|this_leaf-&gt;eax.split.num_threads_sharing
suffix:semicolon
r_if
c_cond
(paren
id|num_threads_sharing
op_eq
l_int|1
)paren
id|cpu_set
c_func
(paren
id|cpu
comma
id|this_leaf-&gt;shared_cpu_map
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_X86_HT
r_else
r_if
c_cond
(paren
id|num_threads_sharing
op_eq
id|smp_num_siblings
)paren
id|this_leaf-&gt;shared_cpu_map
op_assign
id|cpu_sibling_map
(braket
id|cpu
)braket
suffix:semicolon
macro_line|#endif
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Number of CPUs sharing cache didn&squot;t match &quot;
l_string|&quot;any known set of CPUs&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|function|cache_shared_cpu_map_setup
r_static
r_void
id|__init
id|cache_shared_cpu_map_setup
c_func
(paren
r_int
r_int
id|cpu
comma
r_int
id|index
)paren
(brace
)brace
macro_line|#endif
DECL|function|free_cache_attributes
r_static
r_void
id|free_cache_attributes
c_func
(paren
r_int
r_int
id|cpu
)paren
(brace
id|kfree
c_func
(paren
id|cpuid4_info
(braket
id|cpu
)braket
)paren
suffix:semicolon
id|cpuid4_info
(braket
id|cpu
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|detect_cache_attributes
r_static
r_int
id|__devinit
id|detect_cache_attributes
c_func
(paren
r_int
r_int
id|cpu
)paren
(brace
r_struct
id|_cpuid4_info
op_star
id|this_leaf
suffix:semicolon
r_int
r_int
id|j
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
id|num_cache_leaves
op_eq
l_int|0
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
id|cpuid4_info
(braket
id|cpu
)braket
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|_cpuid4_info
)paren
op_star
id|num_cache_leaves
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|cpuid4_info
(braket
id|cpu
)braket
op_eq
l_int|NULL
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|cpuid4_info
(braket
id|cpu
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|_cpuid4_info
)paren
op_star
id|num_cache_leaves
)paren
suffix:semicolon
multiline_comment|/* Do cpuid and store the results */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|num_cache_leaves
suffix:semicolon
id|j
op_increment
)paren
(brace
id|this_leaf
op_assign
id|CPUID4_INFO_IDX
c_func
(paren
id|cpu
comma
id|j
)paren
suffix:semicolon
id|retval
op_assign
id|cpuid4_cache_lookup
c_func
(paren
id|j
comma
id|this_leaf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|retval
OL
l_int|0
)paren
)paren
r_goto
id|err_out
suffix:semicolon
id|cache_shared_cpu_map_setup
c_func
(paren
id|cpu
comma
id|j
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|err_out
suffix:colon
id|free_cache_attributes
c_func
(paren
id|cpu
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SYSFS
macro_line|#include &lt;linux/kobject.h&gt;
macro_line|#include &lt;linux/sysfs.h&gt;
r_extern
r_struct
id|sysdev_class
id|cpu_sysdev_class
suffix:semicolon
multiline_comment|/* from drivers/base/cpu.c */
multiline_comment|/* pointer to kobject for cpuX/cache */
DECL|variable|cache_kobject
r_static
r_struct
id|kobject
op_star
id|cache_kobject
(braket
id|NR_CPUS
)braket
suffix:semicolon
DECL|struct|_index_kobject
r_struct
id|_index_kobject
(brace
DECL|member|kobj
r_struct
id|kobject
id|kobj
suffix:semicolon
DECL|member|cpu
r_int
r_int
id|cpu
suffix:semicolon
DECL|member|index
r_int
r_int
id|index
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* pointer to array of kobjects for cpuX/cache/indexY */
DECL|variable|index_kobject
r_static
r_struct
id|_index_kobject
op_star
id|index_kobject
(braket
id|NR_CPUS
)braket
suffix:semicolon
DECL|macro|INDEX_KOBJECT_PTR
mdefine_line|#define INDEX_KOBJECT_PTR(x,y)    (&amp;((index_kobject[x])[y]))
DECL|macro|show_one_plus
mdefine_line|#define show_one_plus(file_name, object, val)&t;&t;&t;&t;&bslash;&n;static ssize_t show_##file_name&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;(struct _cpuid4_info *this_leaf, char *buf)&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return sprintf (buf, &quot;%lu&bslash;n&quot;, (unsigned long)this_leaf-&gt;object + val); &bslash;&n;}
id|show_one_plus
c_func
(paren
id|level
comma
id|eax.split.level
comma
l_int|0
)paren
suffix:semicolon
id|show_one_plus
c_func
(paren
id|coherency_line_size
comma
id|ebx.split.coherency_line_size
comma
l_int|1
)paren
suffix:semicolon
id|show_one_plus
c_func
(paren
id|physical_line_partition
comma
id|ebx.split.physical_line_partition
comma
l_int|1
)paren
suffix:semicolon
id|show_one_plus
c_func
(paren
id|ways_of_associativity
comma
id|ebx.split.ways_of_associativity
comma
l_int|1
)paren
suffix:semicolon
id|show_one_plus
c_func
(paren
id|number_of_sets
comma
id|ecx.split.number_of_sets
comma
l_int|1
)paren
suffix:semicolon
DECL|function|show_size
r_static
id|ssize_t
id|show_size
c_func
(paren
r_struct
id|_cpuid4_info
op_star
id|this_leaf
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|sprintf
(paren
id|buf
comma
l_string|&quot;%luK&bslash;n&quot;
comma
id|this_leaf-&gt;size
op_div
l_int|1024
)paren
suffix:semicolon
)brace
DECL|function|show_shared_cpu_map
r_static
id|ssize_t
id|show_shared_cpu_map
c_func
(paren
r_struct
id|_cpuid4_info
op_star
id|this_leaf
comma
r_char
op_star
id|buf
)paren
(brace
r_char
id|mask_str
(braket
id|NR_CPUS
)braket
suffix:semicolon
id|cpumask_scnprintf
c_func
(paren
id|mask_str
comma
id|NR_CPUS
comma
id|this_leaf-&gt;shared_cpu_map
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|mask_str
)paren
suffix:semicolon
)brace
DECL|function|show_type
r_static
id|ssize_t
id|show_type
c_func
(paren
r_struct
id|_cpuid4_info
op_star
id|this_leaf
comma
r_char
op_star
id|buf
)paren
(brace
r_switch
c_cond
(paren
id|this_leaf-&gt;eax.split.type
)paren
(brace
r_case
id|CACHE_TYPE_DATA
suffix:colon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;Data&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CACHE_TYPE_INST
suffix:colon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;Instruction&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CACHE_TYPE_UNIFIED
suffix:colon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;Unified&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;Unknown&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|struct|_cache_attr
r_struct
id|_cache_attr
(brace
DECL|member|attr
r_struct
id|attribute
id|attr
suffix:semicolon
DECL|member|show
id|ssize_t
(paren
op_star
id|show
)paren
(paren
r_struct
id|_cpuid4_info
op_star
comma
r_char
op_star
)paren
suffix:semicolon
DECL|member|store
id|ssize_t
(paren
op_star
id|store
)paren
(paren
r_struct
id|_cpuid4_info
op_star
comma
r_const
r_char
op_star
comma
r_int
id|count
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|define_one_ro
mdefine_line|#define define_one_ro(_name) &bslash;&n;static struct _cache_attr _name = &bslash;&n;&t;__ATTR(_name, 0444, show_##_name, NULL)
DECL|variable|level
id|define_one_ro
c_func
(paren
id|level
)paren
suffix:semicolon
DECL|variable|type
id|define_one_ro
c_func
(paren
id|type
)paren
suffix:semicolon
DECL|variable|coherency_line_size
id|define_one_ro
c_func
(paren
id|coherency_line_size
)paren
suffix:semicolon
DECL|variable|physical_line_partition
id|define_one_ro
c_func
(paren
id|physical_line_partition
)paren
suffix:semicolon
DECL|variable|ways_of_associativity
id|define_one_ro
c_func
(paren
id|ways_of_associativity
)paren
suffix:semicolon
DECL|variable|number_of_sets
id|define_one_ro
c_func
(paren
id|number_of_sets
)paren
suffix:semicolon
DECL|variable|size
id|define_one_ro
c_func
(paren
id|size
)paren
suffix:semicolon
DECL|variable|shared_cpu_map
id|define_one_ro
c_func
(paren
id|shared_cpu_map
)paren
suffix:semicolon
DECL|variable|default_attrs
r_static
r_struct
id|attribute
op_star
id|default_attrs
(braket
)braket
op_assign
(brace
op_amp
id|type.attr
comma
op_amp
id|level.attr
comma
op_amp
id|coherency_line_size.attr
comma
op_amp
id|physical_line_partition.attr
comma
op_amp
id|ways_of_associativity.attr
comma
op_amp
id|number_of_sets.attr
comma
op_amp
id|size.attr
comma
op_amp
id|shared_cpu_map.attr
comma
l_int|NULL
)brace
suffix:semicolon
DECL|macro|to_object
mdefine_line|#define to_object(k) container_of(k, struct _index_kobject, kobj)
DECL|macro|to_attr
mdefine_line|#define to_attr(a) container_of(a, struct _cache_attr, attr)
DECL|function|show
r_static
id|ssize_t
id|show
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
comma
r_struct
id|attribute
op_star
id|attr
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|_cache_attr
op_star
id|fattr
op_assign
id|to_attr
c_func
(paren
id|attr
)paren
suffix:semicolon
r_struct
id|_index_kobject
op_star
id|this_leaf
op_assign
id|to_object
c_func
(paren
id|kobj
)paren
suffix:semicolon
id|ssize_t
id|ret
suffix:semicolon
id|ret
op_assign
id|fattr-&gt;show
ques
c_cond
id|fattr
op_member_access_from_pointer
id|show
c_func
(paren
id|CPUID4_INFO_IDX
c_func
(paren
id|this_leaf-&gt;cpu
comma
id|this_leaf-&gt;index
)paren
comma
id|buf
)paren
suffix:colon
l_int|0
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|store
r_static
id|ssize_t
id|store
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
comma
r_struct
id|attribute
op_star
id|attr
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sysfs_ops
r_static
r_struct
id|sysfs_ops
id|sysfs_ops
op_assign
(brace
dot
id|show
op_assign
id|show
comma
dot
id|store
op_assign
id|store
comma
)brace
suffix:semicolon
DECL|variable|ktype_cache
r_static
r_struct
id|kobj_type
id|ktype_cache
op_assign
(brace
dot
id|sysfs_ops
op_assign
op_amp
id|sysfs_ops
comma
dot
id|default_attrs
op_assign
id|default_attrs
comma
)brace
suffix:semicolon
DECL|variable|ktype_percpu_entry
r_static
r_struct
id|kobj_type
id|ktype_percpu_entry
op_assign
(brace
dot
id|sysfs_ops
op_assign
op_amp
id|sysfs_ops
comma
)brace
suffix:semicolon
DECL|function|cpuid4_cache_sysfs_exit
r_static
r_void
id|cpuid4_cache_sysfs_exit
c_func
(paren
r_int
r_int
id|cpu
)paren
(brace
id|kfree
c_func
(paren
id|cache_kobject
(braket
id|cpu
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|index_kobject
(braket
id|cpu
)braket
)paren
suffix:semicolon
id|cache_kobject
(braket
id|cpu
)braket
op_assign
l_int|NULL
suffix:semicolon
id|index_kobject
(braket
id|cpu
)braket
op_assign
l_int|NULL
suffix:semicolon
id|free_cache_attributes
c_func
(paren
id|cpu
)paren
suffix:semicolon
)brace
DECL|function|cpuid4_cache_sysfs_init
r_static
r_int
id|__devinit
id|cpuid4_cache_sysfs_init
c_func
(paren
r_int
r_int
id|cpu
)paren
(brace
r_if
c_cond
(paren
id|num_cache_leaves
op_eq
l_int|0
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
id|detect_cache_attributes
c_func
(paren
id|cpu
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpuid4_info
(braket
id|cpu
)braket
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
multiline_comment|/* Allocate all required memory */
id|cache_kobject
(braket
id|cpu
)braket
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|kobject
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|cache_kobject
(braket
id|cpu
)braket
op_eq
l_int|NULL
)paren
)paren
r_goto
id|err_out
suffix:semicolon
id|memset
c_func
(paren
id|cache_kobject
(braket
id|cpu
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|kobject
)paren
)paren
suffix:semicolon
id|index_kobject
(braket
id|cpu
)braket
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|_index_kobject
)paren
op_star
id|num_cache_leaves
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|index_kobject
(braket
id|cpu
)braket
op_eq
l_int|NULL
)paren
)paren
r_goto
id|err_out
suffix:semicolon
id|memset
c_func
(paren
id|index_kobject
(braket
id|cpu
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|_index_kobject
)paren
op_star
id|num_cache_leaves
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out
suffix:colon
id|cpuid4_cache_sysfs_exit
c_func
(paren
id|cpu
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Add/Remove cache interface for CPU device */
DECL|function|cache_add_dev
r_static
r_int
id|__devinit
id|cache_add_dev
c_func
(paren
r_struct
id|sys_device
op_star
id|sys_dev
)paren
(brace
r_int
r_int
id|cpu
op_assign
id|sys_dev-&gt;id
suffix:semicolon
r_int
r_int
id|i
comma
id|j
suffix:semicolon
r_struct
id|_index_kobject
op_star
id|this_object
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|retval
op_assign
id|cpuid4_cache_sysfs_init
c_func
(paren
id|cpu
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|retval
OL
l_int|0
)paren
)paren
r_return
id|retval
suffix:semicolon
id|cache_kobject
(braket
id|cpu
)braket
op_member_access_from_pointer
id|parent
op_assign
op_amp
id|sys_dev-&gt;kobj
suffix:semicolon
id|kobject_set_name
c_func
(paren
id|cache_kobject
(braket
id|cpu
)braket
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;cache&quot;
)paren
suffix:semicolon
id|cache_kobject
(braket
id|cpu
)braket
op_member_access_from_pointer
id|ktype
op_assign
op_amp
id|ktype_percpu_entry
suffix:semicolon
id|retval
op_assign
id|kobject_register
c_func
(paren
id|cache_kobject
(braket
id|cpu
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_cache_leaves
suffix:semicolon
id|i
op_increment
)paren
(brace
id|this_object
op_assign
id|INDEX_KOBJECT_PTR
c_func
(paren
id|cpu
comma
id|i
)paren
suffix:semicolon
id|this_object-&gt;cpu
op_assign
id|cpu
suffix:semicolon
id|this_object-&gt;index
op_assign
id|i
suffix:semicolon
id|this_object-&gt;kobj.parent
op_assign
id|cache_kobject
(braket
id|cpu
)braket
suffix:semicolon
id|kobject_set_name
c_func
(paren
op_amp
(paren
id|this_object-&gt;kobj
)paren
comma
l_string|&quot;index%1lu&quot;
comma
id|i
)paren
suffix:semicolon
id|this_object-&gt;kobj.ktype
op_assign
op_amp
id|ktype_cache
suffix:semicolon
id|retval
op_assign
id|kobject_register
c_func
(paren
op_amp
(paren
id|this_object-&gt;kobj
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|retval
)paren
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|i
suffix:semicolon
id|j
op_increment
)paren
(brace
id|kobject_unregister
c_func
(paren
op_amp
(paren
id|INDEX_KOBJECT_PTR
c_func
(paren
id|cpu
comma
id|j
)paren
op_member_access_from_pointer
id|kobj
)paren
)paren
suffix:semicolon
)brace
id|kobject_unregister
c_func
(paren
id|cache_kobject
(braket
id|cpu
)braket
)paren
suffix:semicolon
id|cpuid4_cache_sysfs_exit
c_func
(paren
id|cpu
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|retval
suffix:semicolon
)brace
DECL|function|cache_remove_dev
r_static
r_int
id|__devexit
id|cache_remove_dev
c_func
(paren
r_struct
id|sys_device
op_star
id|sys_dev
)paren
(brace
r_int
r_int
id|cpu
op_assign
id|sys_dev-&gt;id
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_cache_leaves
suffix:semicolon
id|i
op_increment
)paren
id|kobject_unregister
c_func
(paren
op_amp
(paren
id|INDEX_KOBJECT_PTR
c_func
(paren
id|cpu
comma
id|i
)paren
op_member_access_from_pointer
id|kobj
)paren
)paren
suffix:semicolon
id|kobject_unregister
c_func
(paren
id|cache_kobject
(braket
id|cpu
)braket
)paren
suffix:semicolon
id|cpuid4_cache_sysfs_exit
c_func
(paren
id|cpu
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|cache_sysdev_driver
r_static
r_struct
id|sysdev_driver
id|cache_sysdev_driver
op_assign
(brace
dot
id|add
op_assign
id|cache_add_dev
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|cache_remove_dev
)paren
comma
)brace
suffix:semicolon
multiline_comment|/* Register/Unregister the cpu_cache driver */
DECL|function|cache_register_driver
r_static
r_int
id|__devinit
id|cache_register_driver
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|num_cache_leaves
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|sysdev_driver_register
c_func
(paren
op_amp
id|cpu_sysdev_class
comma
op_amp
id|cache_sysdev_driver
)paren
suffix:semicolon
)brace
DECL|variable|cache_register_driver
id|device_initcall
c_func
(paren
id|cache_register_driver
)paren
suffix:semicolon
macro_line|#endif
eof
