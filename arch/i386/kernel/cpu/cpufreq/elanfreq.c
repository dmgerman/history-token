multiline_comment|/*&n; * &t;elanfreq: &t;cpufreq driver for the AMD ELAN family&n; *&n; *&t;(c) Copyright 2002 Robert Schwebel &lt;r.schwebel@pengutronix.de&gt;&n; *&n; *&t;Parts of this code are (c) Sven Geggus &lt;sven@geggus.net&gt; &n; *&n; *      All Rights Reserved. &n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version. &n; *&n; *&t;2002-02-13: - initial revision for 2.4.18-pre9 by Robert Schwebel&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/cpufreq.h&gt;
macro_line|#include &lt;asm/msr.h&gt;
macro_line|#include &lt;asm/timex.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|macro|REG_CSCIR
mdefine_line|#define REG_CSCIR 0x22 &t;&t;/* Chip Setup and Control Index Register    */
DECL|macro|REG_CSCDR
mdefine_line|#define REG_CSCDR 0x23&t;&t;/* Chip Setup and Control Data  Register    */
multiline_comment|/* Module parameter */
DECL|variable|max_freq
r_static
r_int
id|max_freq
suffix:semicolon
DECL|struct|s_elan_multiplier
r_struct
id|s_elan_multiplier
(brace
DECL|member|clock
r_int
id|clock
suffix:semicolon
multiline_comment|/* frequency in kHz                         */
DECL|member|val40h
r_int
id|val40h
suffix:semicolon
multiline_comment|/* PMU Force Mode register                  */
DECL|member|val80h
r_int
id|val80h
suffix:semicolon
multiline_comment|/* CPU Clock Speed Register                 */
)brace
suffix:semicolon
multiline_comment|/*&n; * It is important that the frequencies &n; * are listed in ascending order here!&n; */
DECL|variable|elan_multiplier
r_struct
id|s_elan_multiplier
id|elan_multiplier
(braket
)braket
op_assign
(brace
(brace
l_int|1000
comma
l_int|0x02
comma
l_int|0x18
)brace
comma
(brace
l_int|2000
comma
l_int|0x02
comma
l_int|0x10
)brace
comma
(brace
l_int|4000
comma
l_int|0x02
comma
l_int|0x08
)brace
comma
(brace
l_int|8000
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
(brace
l_int|16000
comma
l_int|0x00
comma
l_int|0x02
)brace
comma
(brace
l_int|33000
comma
l_int|0x00
comma
l_int|0x04
)brace
comma
(brace
l_int|66000
comma
l_int|0x01
comma
l_int|0x04
)brace
comma
(brace
l_int|99000
comma
l_int|0x01
comma
l_int|0x05
)brace
)brace
suffix:semicolon
DECL|variable|elanfreq_table
r_static
r_struct
id|cpufreq_frequency_table
id|elanfreq_table
(braket
)braket
op_assign
(brace
(brace
l_int|0
comma
l_int|1000
)brace
comma
(brace
l_int|1
comma
l_int|2000
)brace
comma
(brace
l_int|2
comma
l_int|4000
)brace
comma
(brace
l_int|3
comma
l_int|8000
)brace
comma
(brace
l_int|4
comma
l_int|16000
)brace
comma
(brace
l_int|5
comma
l_int|33000
)brace
comma
(brace
l_int|6
comma
l_int|66000
)brace
comma
(brace
l_int|7
comma
l_int|99000
)brace
comma
(brace
l_int|0
comma
id|CPUFREQ_TABLE_END
)brace
comma
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;elanfreq_get_cpu_frequency: determine current cpu speed&n; *&n; *&t;Finds out at which frequency the CPU of the Elan SOC runs&n; *&t;at the moment. Frequencies from 1 to 33 MHz are generated &n; *&t;the normal way, 66 and 99 MHz are called &quot;Hyperspeed Mode&quot;&n; *&t;and have the rest of the chip running with 33 MHz. &n; */
DECL|function|elanfreq_get_cpu_frequency
r_static
r_int
r_int
id|elanfreq_get_cpu_frequency
c_func
(paren
r_int
r_int
id|cpu
)paren
(brace
id|u8
id|clockspeed_reg
suffix:semicolon
multiline_comment|/* Clock Speed Register */
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x80
comma
id|REG_CSCIR
)paren
suffix:semicolon
id|clockspeed_reg
op_assign
id|inb_p
c_func
(paren
id|REG_CSCDR
)paren
suffix:semicolon
id|local_irq_enable
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|clockspeed_reg
op_amp
l_int|0xE0
)paren
op_eq
l_int|0xE0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Are we in CPU clock multiplied mode (66/99 MHz)? */
r_if
c_cond
(paren
(paren
id|clockspeed_reg
op_amp
l_int|0xE0
)paren
op_eq
l_int|0xC0
)paren
(brace
r_if
c_cond
(paren
(paren
id|clockspeed_reg
op_amp
l_int|0x01
)paren
op_eq
l_int|0
)paren
(brace
r_return
l_int|66000
suffix:semicolon
)brace
r_else
(brace
r_return
l_int|99000
suffix:semicolon
)brace
)brace
multiline_comment|/* 33 MHz is not 32 MHz... */
r_if
c_cond
(paren
(paren
id|clockspeed_reg
op_amp
l_int|0xE0
)paren
op_eq
l_int|0xA0
)paren
r_return
l_int|33000
suffix:semicolon
r_return
(paren
(paren
l_int|1
op_lshift
(paren
(paren
id|clockspeed_reg
op_amp
l_int|0xE0
)paren
op_rshift
l_int|5
)paren
)paren
op_star
l_int|1000
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *      elanfreq_set_cpu_frequency: Change the CPU core frequency&n; * &t;@cpu: cpu number&n; *&t;@freq: frequency in kHz&n; *&n; *      This function takes a frequency value and changes the CPU frequency &n; *&t;according to this. Note that the frequency has to be checked by&n; *&t;elanfreq_validatespeed() for correctness!&n; *&t;&n; *&t;There is no return value. &n; */
DECL|function|elanfreq_set_cpu_state
r_static
r_void
id|elanfreq_set_cpu_state
(paren
r_int
r_int
id|state
)paren
(brace
r_struct
id|cpufreq_freqs
id|freqs
suffix:semicolon
id|freqs.old
op_assign
id|elanfreq_get_cpu_frequency
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|freqs
dot
r_new
op_assign
id|elan_multiplier
(braket
id|state
)braket
dot
id|clock
suffix:semicolon
id|freqs.cpu
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* elanfreq.c is UP only driver */
id|cpufreq_notify_transition
c_func
(paren
op_amp
id|freqs
comma
id|CPUFREQ_PRECHANGE
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;elanfreq: attempting to set frequency to %i kHz&bslash;n&quot;
comma
id|elan_multiplier
(braket
id|state
)braket
dot
id|clock
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Access to the Elan&squot;s internal registers is indexed via    &n;&t; * 0x22: Chip Setup &amp; Control Register Index Register (CSCI) &n;&t; * 0x23: Chip Setup &amp; Control Register Data  Register (CSCD) &n;&t; *&n;&t; */
multiline_comment|/* &n;&t; * 0x40 is the Power Management Unit&squot;s Force Mode Register. &n;&t; * Bit 6 enables Hyperspeed Mode (66/100 MHz core frequency)&n;&t; */
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x40
comma
id|REG_CSCIR
)paren
suffix:semicolon
multiline_comment|/* Disable hyperspeed mode          */
id|outb_p
c_func
(paren
l_int|0x00
comma
id|REG_CSCDR
)paren
suffix:semicolon
id|local_irq_enable
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* wait till internal pipelines and */
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* buffers have cleaned up          */
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* now, set the CPU clock speed register (0x80) */
id|outb_p
c_func
(paren
l_int|0x80
comma
id|REG_CSCIR
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|elan_multiplier
(braket
id|state
)braket
dot
id|val80h
comma
id|REG_CSCDR
)paren
suffix:semicolon
multiline_comment|/* now, the hyperspeed bit in PMU Force Mode Register (0x40) */
id|outb_p
c_func
(paren
l_int|0x40
comma
id|REG_CSCIR
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|elan_multiplier
(braket
id|state
)braket
dot
id|val40h
comma
id|REG_CSCDR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10000
)paren
suffix:semicolon
id|local_irq_enable
c_func
(paren
)paren
suffix:semicolon
id|cpufreq_notify_transition
c_func
(paren
op_amp
id|freqs
comma
id|CPUFREQ_POSTCHANGE
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;elanfreq_validatespeed: test if frequency range is valid&n; *      @policy: the policy to validate&n; *&n; *&t;This function checks if a given frequency range in kHz is valid &n; *      for the hardware supported by the driver. &n; */
DECL|function|elanfreq_verify
r_static
r_int
id|elanfreq_verify
(paren
r_struct
id|cpufreq_policy
op_star
id|policy
)paren
(brace
r_return
id|cpufreq_frequency_table_verify
c_func
(paren
id|policy
comma
op_amp
id|elanfreq_table
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
DECL|function|elanfreq_target
r_static
r_int
id|elanfreq_target
(paren
r_struct
id|cpufreq_policy
op_star
id|policy
comma
r_int
r_int
id|target_freq
comma
r_int
r_int
id|relation
)paren
(brace
r_int
r_int
id|newstate
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cpufreq_frequency_table_target
c_func
(paren
id|policy
comma
op_amp
id|elanfreq_table
(braket
l_int|0
)braket
comma
id|target_freq
comma
id|relation
comma
op_amp
id|newstate
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|elanfreq_set_cpu_state
c_func
(paren
id|newstate
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Module init and exit code&n; */
DECL|function|elanfreq_cpu_init
r_static
r_int
id|elanfreq_cpu_init
c_func
(paren
r_struct
id|cpufreq_policy
op_star
id|policy
)paren
(brace
r_struct
id|cpuinfo_x86
op_star
id|c
op_assign
id|cpu_data
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_int
id|result
suffix:semicolon
multiline_comment|/* capability check */
r_if
c_cond
(paren
(paren
id|c-&gt;x86_vendor
op_ne
id|X86_VENDOR_AMD
)paren
op_logical_or
(paren
id|c-&gt;x86
op_ne
l_int|4
)paren
op_logical_or
(paren
id|c-&gt;x86_model
op_ne
l_int|10
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* max freq */
r_if
c_cond
(paren
op_logical_neg
id|max_freq
)paren
id|max_freq
op_assign
id|elanfreq_get_cpu_frequency
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* table init */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|elanfreq_table
(braket
id|i
)braket
dot
id|frequency
op_ne
id|CPUFREQ_TABLE_END
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|elanfreq_table
(braket
id|i
)braket
dot
id|frequency
OG
id|max_freq
)paren
id|elanfreq_table
(braket
id|i
)braket
dot
id|frequency
op_assign
id|CPUFREQ_ENTRY_INVALID
suffix:semicolon
)brace
multiline_comment|/* cpuinfo and default policy values */
id|policy-&gt;governor
op_assign
id|CPUFREQ_DEFAULT_GOVERNOR
suffix:semicolon
id|policy-&gt;cpuinfo.transition_latency
op_assign
id|CPUFREQ_ETERNAL
suffix:semicolon
id|policy-&gt;cur
op_assign
id|elanfreq_get_cpu_frequency
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|result
op_assign
id|cpufreq_frequency_table_cpuinfo
c_func
(paren
id|policy
comma
id|elanfreq_table
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
(paren
id|result
)paren
suffix:semicolon
id|cpufreq_frequency_table_get_attr
c_func
(paren
id|elanfreq_table
comma
id|policy-&gt;cpu
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|elanfreq_cpu_exit
r_static
r_int
id|elanfreq_cpu_exit
c_func
(paren
r_struct
id|cpufreq_policy
op_star
id|policy
)paren
(brace
id|cpufreq_frequency_table_put_attr
c_func
(paren
id|policy-&gt;cpu
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifndef MODULE
multiline_comment|/**&n; * elanfreq_setup - elanfreq command line parameter parsing&n; *&n; * elanfreq command line parameter.  Use:&n; *  elanfreq=66000&n; * to set the maximum CPU frequency to 66 MHz. Note that in&n; * case you do not give this boot parameter, the maximum&n; * frequency will fall back to _current_ CPU frequency which&n; * might be lower. If you build this as a module, use the&n; * max_freq module parameter instead.&n; */
DECL|function|elanfreq_setup
r_static
r_int
id|__init
id|elanfreq_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
id|max_freq
op_assign
id|simple_strtoul
c_func
(paren
id|str
comma
op_amp
id|str
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;elanfreq=&quot;
comma
id|elanfreq_setup
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|elanfreq_attr
r_static
r_struct
id|freq_attr
op_star
id|elanfreq_attr
(braket
)braket
op_assign
(brace
op_amp
id|cpufreq_freq_attr_scaling_available_freqs
comma
l_int|NULL
comma
)brace
suffix:semicolon
DECL|variable|elanfreq_driver
r_static
r_struct
id|cpufreq_driver
id|elanfreq_driver
op_assign
(brace
dot
id|get
op_assign
id|elanfreq_get_cpu_frequency
comma
dot
id|verify
op_assign
id|elanfreq_verify
comma
dot
id|target
op_assign
id|elanfreq_target
comma
dot
id|init
op_assign
id|elanfreq_cpu_init
comma
dot
m_exit
op_assign
id|elanfreq_cpu_exit
comma
dot
id|name
op_assign
l_string|&quot;elanfreq&quot;
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|attr
op_assign
id|elanfreq_attr
comma
)brace
suffix:semicolon
DECL|function|elanfreq_init
r_static
r_int
id|__init
id|elanfreq_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|cpuinfo_x86
op_star
id|c
op_assign
id|cpu_data
suffix:semicolon
multiline_comment|/* Test if we have the right hardware */
r_if
c_cond
(paren
(paren
id|c-&gt;x86_vendor
op_ne
id|X86_VENDOR_AMD
)paren
op_logical_or
(paren
id|c-&gt;x86
op_ne
l_int|4
)paren
op_logical_or
(paren
id|c-&gt;x86_model
op_ne
l_int|10
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;elanfreq: error: no Elan processor found!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
id|cpufreq_register_driver
c_func
(paren
op_amp
id|elanfreq_driver
)paren
suffix:semicolon
)brace
DECL|function|elanfreq_exit
r_static
r_void
id|__exit
id|elanfreq_exit
c_func
(paren
r_void
)paren
(brace
id|cpufreq_unregister_driver
c_func
(paren
op_amp
id|elanfreq_driver
)paren
suffix:semicolon
)brace
id|MODULE_PARM
(paren
id|max_freq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Robert Schwebel &lt;r.schwebel@pengutronix.de&gt;, Sven Geggus &lt;sven@geggus.net&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;cpufreq driver for AMD&squot;s Elan CPUs&quot;
)paren
suffix:semicolon
DECL|variable|elanfreq_init
id|module_init
c_func
(paren
id|elanfreq_init
)paren
suffix:semicolon
DECL|variable|elanfreq_exit
id|module_exit
c_func
(paren
id|elanfreq_exit
)paren
suffix:semicolon
eof
