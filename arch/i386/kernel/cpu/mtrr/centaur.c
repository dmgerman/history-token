macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/mtrr.h&gt;
macro_line|#include &lt;asm/msr.h&gt;
macro_line|#include &quot;mtrr.h&quot;
r_static
r_struct
(brace
DECL|member|high
r_int
r_int
id|high
suffix:semicolon
DECL|member|low
r_int
r_int
id|low
suffix:semicolon
DECL|variable|centaur_mcr
)brace
id|centaur_mcr
(braket
l_int|8
)braket
suffix:semicolon
DECL|variable|centaur_mcr_reserved
r_static
id|u8
id|centaur_mcr_reserved
suffix:semicolon
DECL|variable|centaur_mcr_type
r_static
id|u8
id|centaur_mcr_type
suffix:semicolon
multiline_comment|/* 0 for winchip, 1 for winchip2 */
multiline_comment|/*&n; *&t;Report boot time MCR setups &n; */
r_static
r_int
DECL|function|centaur_get_free_region
id|centaur_get_free_region
c_func
(paren
r_int
r_int
id|base
comma
r_int
r_int
id|size
)paren
multiline_comment|/*  [SUMMARY] Get a free MTRR.&n;    &lt;base&gt; The starting (base) address of the region.&n;    &lt;size&gt; The size (in bytes) of the region.&n;    [RETURNS] The index of the region on success, else -1 on error.&n;*/
(brace
r_int
id|i
comma
id|max
suffix:semicolon
id|mtrr_type
id|ltype
suffix:semicolon
r_int
r_int
id|lbase
comma
id|lsize
suffix:semicolon
id|max
op_assign
id|num_var_ranges
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|max
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|centaur_mcr_reserved
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
r_continue
suffix:semicolon
id|mtrr_if
op_member_access_from_pointer
id|get
c_func
(paren
id|i
comma
op_amp
id|lbase
comma
op_amp
id|lsize
comma
op_amp
id|ltype
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lsize
op_eq
l_int|0
)paren
r_return
id|i
suffix:semicolon
)brace
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
r_void
DECL|function|mtrr_centaur_report_mcr
id|mtrr_centaur_report_mcr
c_func
(paren
r_int
id|mcr
comma
id|u32
id|lo
comma
id|u32
id|hi
)paren
(brace
id|centaur_mcr
(braket
id|mcr
)braket
dot
id|low
op_assign
id|lo
suffix:semicolon
id|centaur_mcr
(braket
id|mcr
)braket
dot
id|high
op_assign
id|hi
suffix:semicolon
)brace
r_static
r_void
DECL|function|centaur_get_mcr
id|centaur_get_mcr
c_func
(paren
r_int
r_int
id|reg
comma
r_int
r_int
op_star
id|base
comma
r_int
r_int
op_star
id|size
comma
id|mtrr_type
op_star
id|type
)paren
(brace
op_star
id|base
op_assign
id|centaur_mcr
(braket
id|reg
)braket
dot
id|high
op_rshift
id|PAGE_SHIFT
suffix:semicolon
op_star
id|size
op_assign
op_minus
(paren
id|centaur_mcr
(braket
id|reg
)braket
dot
id|low
op_amp
l_int|0xfffff000
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
op_star
id|type
op_assign
id|MTRR_TYPE_WRCOMB
suffix:semicolon
multiline_comment|/*  If it is there, it is write-combining  */
r_if
c_cond
(paren
id|centaur_mcr_type
op_eq
l_int|1
op_logical_and
(paren
(paren
id|centaur_mcr
(braket
id|reg
)braket
dot
id|low
op_amp
l_int|31
)paren
op_amp
l_int|2
)paren
)paren
op_star
id|type
op_assign
id|MTRR_TYPE_UNCACHABLE
suffix:semicolon
r_if
c_cond
(paren
id|centaur_mcr_type
op_eq
l_int|1
op_logical_and
(paren
id|centaur_mcr
(braket
id|reg
)braket
dot
id|low
op_amp
l_int|31
)paren
op_eq
l_int|25
)paren
op_star
id|type
op_assign
id|MTRR_TYPE_WRBACK
suffix:semicolon
r_if
c_cond
(paren
id|centaur_mcr_type
op_eq
l_int|0
op_logical_and
(paren
id|centaur_mcr
(braket
id|reg
)braket
dot
id|low
op_amp
l_int|31
)paren
op_eq
l_int|31
)paren
op_star
id|type
op_assign
id|MTRR_TYPE_WRBACK
suffix:semicolon
)brace
DECL|function|centaur_set_mcr
r_static
r_void
id|centaur_set_mcr
c_func
(paren
r_int
r_int
id|reg
comma
r_int
r_int
id|base
comma
r_int
r_int
id|size
comma
id|mtrr_type
id|type
)paren
(brace
r_int
r_int
id|low
comma
id|high
suffix:semicolon
r_if
c_cond
(paren
id|size
op_eq
l_int|0
)paren
(brace
multiline_comment|/*  Disable  */
id|high
op_assign
id|low
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|high
op_assign
id|base
op_lshift
id|PAGE_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|centaur_mcr_type
op_eq
l_int|0
)paren
id|low
op_assign
op_minus
id|size
op_lshift
id|PAGE_SHIFT
op_or
l_int|0x1f
suffix:semicolon
multiline_comment|/* only support write-combining... */
r_else
(brace
r_if
c_cond
(paren
id|type
op_eq
id|MTRR_TYPE_UNCACHABLE
)paren
id|low
op_assign
op_minus
id|size
op_lshift
id|PAGE_SHIFT
op_or
l_int|0x02
suffix:semicolon
multiline_comment|/* NC */
r_else
id|low
op_assign
op_minus
id|size
op_lshift
id|PAGE_SHIFT
op_or
l_int|0x09
suffix:semicolon
multiline_comment|/* WWO,WC */
)brace
)brace
id|centaur_mcr
(braket
id|reg
)braket
dot
id|high
op_assign
id|high
suffix:semicolon
id|centaur_mcr
(braket
id|reg
)braket
dot
id|low
op_assign
id|low
suffix:semicolon
id|wrmsr
c_func
(paren
id|MSR_IDT_MCR0
op_plus
id|reg
comma
id|low
comma
id|high
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Initialise the later (saner) Winchip MCR variant. In this version&n; *&t;the BIOS can pass us the registers it has used (but not their values)&n; *&t;and the control register is read/write&n; */
r_static
r_void
id|__init
DECL|function|centaur_mcr1_init
id|centaur_mcr1_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|u32
id|lo
comma
id|hi
suffix:semicolon
multiline_comment|/* Unfortunately, MCR&squot;s are read-only, so there is no way to&n;&t; * find out what the bios might have done.&n;&t; */
id|rdmsr
c_func
(paren
id|MSR_IDT_MCR_CTRL
comma
id|lo
comma
id|hi
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|lo
op_rshift
l_int|17
)paren
op_amp
l_int|7
)paren
op_eq
l_int|1
)paren
(brace
multiline_comment|/* Type 1 Winchip2 MCR */
id|lo
op_and_assign
op_complement
l_int|0x1C0
suffix:semicolon
multiline_comment|/* clear key */
id|lo
op_or_assign
l_int|0x040
suffix:semicolon
multiline_comment|/* set key to 1 */
id|wrmsr
c_func
(paren
id|MSR_IDT_MCR_CTRL
comma
id|lo
comma
id|hi
)paren
suffix:semicolon
multiline_comment|/* unlock MCR */
)brace
id|centaur_mcr_type
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; *  Clear any unconfigured MCR&squot;s.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|centaur_mcr
(braket
id|i
)braket
dot
id|high
op_eq
l_int|0
op_logical_and
id|centaur_mcr
(braket
id|i
)braket
dot
id|low
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|lo
op_amp
(paren
l_int|1
op_lshift
(paren
l_int|9
op_plus
id|i
)paren
)paren
)paren
)paren
id|wrmsr
c_func
(paren
id|MSR_IDT_MCR0
op_plus
id|i
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_else
multiline_comment|/*&n;&t;&t;&t;&t; *      If the BIOS set up an MCR we cannot see it&n;&t;&t;&t;&t; *      but we don&squot;t wish to obliterate it&n;&t;&t;&t;&t; */
id|centaur_mcr_reserved
op_or_assign
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*  &n;&t; *  Throw the main write-combining switch... &n;&t; *  However if OOSTORE is enabled then people have already done far&n;&t; *  cleverer things and we should behave. &n;&t; */
id|lo
op_or_assign
l_int|15
suffix:semicolon
multiline_comment|/* Write combine enables */
id|wrmsr
c_func
(paren
id|MSR_IDT_MCR_CTRL
comma
id|lo
comma
id|hi
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Initialise the original winchip with read only MCR registers&n; *&t;no used bitmask for the BIOS to pass on and write only control&n; */
r_static
r_void
id|__init
DECL|function|centaur_mcr0_init
id|centaur_mcr0_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Unfortunately, MCR&squot;s are read-only, so there is no way to&n;&t; * find out what the bios might have done.&n;&t; */
multiline_comment|/* Clear any unconfigured MCR&squot;s.&n;&t; * This way we are sure that the centaur_mcr array contains the actual&n;&t; * values. The disadvantage is that any BIOS tweaks are thus undone.&n;&t; *&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|centaur_mcr
(braket
id|i
)braket
dot
id|high
op_eq
l_int|0
op_logical_and
id|centaur_mcr
(braket
id|i
)braket
dot
id|low
op_eq
l_int|0
)paren
id|wrmsr
c_func
(paren
id|MSR_IDT_MCR0
op_plus
id|i
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
id|wrmsr
c_func
(paren
id|MSR_IDT_MCR_CTRL
comma
l_int|0x01F0001F
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Write only */
)brace
multiline_comment|/*&n; *&t;Initialise Winchip series MCR registers&n; */
r_static
r_void
id|__init
DECL|function|centaur_mcr_init
id|centaur_mcr_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|set_mtrr_context
id|ctxt
suffix:semicolon
id|set_mtrr_prepare_save
c_func
(paren
op_amp
id|ctxt
)paren
suffix:semicolon
id|set_mtrr_cache_disable
c_func
(paren
op_amp
id|ctxt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|boot_cpu_data.x86_model
op_eq
l_int|4
)paren
id|centaur_mcr0_init
c_func
(paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|boot_cpu_data.x86_model
op_eq
l_int|8
op_logical_or
id|boot_cpu_data.x86_model
op_eq
l_int|9
)paren
id|centaur_mcr1_init
c_func
(paren
)paren
suffix:semicolon
id|set_mtrr_done
c_func
(paren
op_amp
id|ctxt
)paren
suffix:semicolon
)brace
DECL|function|centaur_validate_add_page
r_static
r_int
id|centaur_validate_add_page
c_func
(paren
r_int
r_int
id|base
comma
r_int
r_int
id|size
comma
r_int
r_int
id|type
)paren
(brace
multiline_comment|/*&n;&t; *  FIXME: Winchip2 supports uncached&n;&t; */
r_if
c_cond
(paren
id|type
op_ne
id|MTRR_TYPE_WRCOMB
op_logical_and
(paren
id|centaur_mcr_type
op_eq
l_int|0
op_logical_or
id|type
op_ne
id|MTRR_TYPE_UNCACHABLE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;mtrr: only write-combining%s supported&bslash;n&quot;
comma
id|centaur_mcr_type
ques
c_cond
l_string|&quot; and uncacheable are&quot;
suffix:colon
l_string|&quot; is&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|centaur_mtrr_ops
r_static
r_struct
id|mtrr_ops
id|centaur_mtrr_ops
op_assign
(brace
dot
id|vendor
op_assign
id|X86_VENDOR_CENTAUR
comma
dot
id|init
op_assign
id|centaur_mcr_init
comma
dot
id|set
op_assign
id|centaur_set_mcr
comma
dot
id|get
op_assign
id|centaur_get_mcr
comma
dot
id|get_free_region
op_assign
id|centaur_get_free_region
comma
dot
id|validate_add_page
op_assign
id|centaur_validate_add_page
comma
dot
id|have_wrcomb
op_assign
id|positive_have_wrcomb
comma
)brace
suffix:semicolon
DECL|function|centaur_init_mtrr
r_int
id|__init
id|centaur_init_mtrr
c_func
(paren
r_void
)paren
(brace
id|set_mtrr_ops
c_func
(paren
op_amp
id|centaur_mtrr_ops
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|//arch_initcall(centaur_init_mtrr);
eof
