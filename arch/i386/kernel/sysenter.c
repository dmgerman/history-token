multiline_comment|/*&n; * linux/arch/i386/kernel/sysenter.c&n; *&n; * (C) Copyright 2002 Linus Torvalds&n; *&n; * This file contains the needed initializations to support sysenter.&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/thread_info.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/gfp.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/cpufeature.h&gt;
macro_line|#include &lt;asm/msr.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
r_extern
id|asmlinkage
r_void
id|sysenter_entry
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/*&n; * Create a per-cpu fake &quot;SEP thread&quot; stack, so that we can&n; * enter the kernel without having to worry about things like&n; * &quot;current&quot; etc not working (debug traps and NMI&squot;s can happen&n; * before we can switch over to the &quot;real&quot; thread).&n; *&n; * Return the resulting fake stack pointer.&n; */
DECL|struct|fake_sep_struct
r_struct
id|fake_sep_struct
(brace
DECL|member|thread
r_struct
id|thread_info
id|thread
suffix:semicolon
DECL|member|task
r_struct
id|task_struct
id|task
suffix:semicolon
DECL|member|trampoline
r_int
r_char
id|trampoline
(braket
l_int|32
)braket
id|__attribute__
c_func
(paren
(paren
id|aligned
c_func
(paren
l_int|1024
)paren
)paren
)paren
suffix:semicolon
DECL|member|stack
r_int
r_char
id|stack
(braket
l_int|0
)braket
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|aligned
c_func
(paren
l_int|8192
)paren
)paren
)paren
suffix:semicolon
DECL|function|alloc_sep_thread
r_static
r_struct
id|fake_sep_struct
op_star
id|alloc_sep_thread
c_func
(paren
r_int
id|cpu
)paren
(brace
r_struct
id|fake_sep_struct
op_star
id|entry
suffix:semicolon
id|entry
op_assign
(paren
r_struct
id|fake_sep_struct
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_ATOMIC
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|entry
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|entry
comma
l_int|0
comma
id|PAGE_SIZE
op_lshift
l_int|1
)paren
suffix:semicolon
id|entry-&gt;thread.task
op_assign
op_amp
id|entry-&gt;task
suffix:semicolon
id|entry-&gt;task.thread_info
op_assign
op_amp
id|entry-&gt;thread
suffix:semicolon
id|entry-&gt;thread.preempt_count
op_assign
l_int|1
suffix:semicolon
id|entry-&gt;thread.cpu
op_assign
id|cpu
suffix:semicolon
r_return
id|entry
suffix:semicolon
)brace
DECL|function|enable_sep_cpu
r_static
r_void
id|__init
id|enable_sep_cpu
c_func
(paren
r_void
op_star
id|info
)paren
(brace
r_int
id|cpu
op_assign
id|get_cpu
c_func
(paren
)paren
suffix:semicolon
r_struct
id|fake_sep_struct
op_star
id|sep
op_assign
id|alloc_sep_thread
c_func
(paren
id|cpu
)paren
suffix:semicolon
r_int
r_int
op_star
id|esp0_ptr
op_assign
op_amp
(paren
id|init_tss
op_plus
id|cpu
)paren
op_member_access_from_pointer
id|esp0
suffix:semicolon
r_int
r_int
id|rel32
suffix:semicolon
id|rel32
op_assign
(paren
r_int
r_int
)paren
id|sysenter_entry
op_minus
(paren
r_int
r_int
)paren
(paren
id|sep-&gt;trampoline
op_plus
l_int|11
)paren
suffix:semicolon
op_star
(paren
r_int
op_star
)paren
(paren
id|sep-&gt;trampoline
op_plus
l_int|0
)paren
op_assign
l_int|0x258b
suffix:semicolon
multiline_comment|/* movl xxxxx,%esp */
op_star
(paren
r_int
op_star
op_star
)paren
(paren
id|sep-&gt;trampoline
op_plus
l_int|2
)paren
op_assign
id|esp0_ptr
suffix:semicolon
op_star
(paren
r_char
op_star
)paren
(paren
id|sep-&gt;trampoline
op_plus
l_int|6
)paren
op_assign
l_int|0xe9
suffix:semicolon
multiline_comment|/* jmp rl32 */
op_star
(paren
r_int
op_star
)paren
(paren
id|sep-&gt;trampoline
op_plus
l_int|7
)paren
op_assign
id|rel32
suffix:semicolon
id|wrmsr
c_func
(paren
l_int|0x174
comma
id|__KERNEL_CS
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* SYSENTER_CS_MSR */
id|wrmsr
c_func
(paren
l_int|0x175
comma
id|PAGE_SIZE
op_star
l_int|2
op_plus
(paren
r_int
r_int
)paren
id|sep
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* SYSENTER_ESP_MSR */
id|wrmsr
c_func
(paren
l_int|0x176
comma
(paren
r_int
r_int
)paren
op_amp
id|sep-&gt;trampoline
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* SYSENTER_EIP_MSR */
id|printk
c_func
(paren
l_string|&quot;Enabling SEP on CPU %d&bslash;n&quot;
comma
id|cpu
)paren
suffix:semicolon
id|put_cpu
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|sysenter_setup
r_static
r_int
id|__init
id|sysenter_setup
c_func
(paren
r_void
)paren
(brace
r_static
r_const
r_char
id|int80
(braket
)braket
op_assign
(brace
l_int|0xcd
comma
l_int|0x80
comma
multiline_comment|/* int $0x80 */
l_int|0xc3
multiline_comment|/* ret */
)brace
suffix:semicolon
r_static
r_const
r_char
id|sysent
(braket
)braket
op_assign
(brace
l_int|0x9c
comma
multiline_comment|/* pushf */
l_int|0x51
comma
multiline_comment|/* push %ecx */
l_int|0x52
comma
multiline_comment|/* push %edx */
l_int|0x55
comma
multiline_comment|/* push %ebp */
l_int|0x89
comma
l_int|0xe5
comma
multiline_comment|/* movl %esp,%ebp */
l_int|0x0f
comma
l_int|0x34
comma
multiline_comment|/* sysenter */
multiline_comment|/* System call restart point is here! (SYSENTER_RETURN - 2) */
l_int|0xeb
comma
l_int|0xfa
comma
multiline_comment|/* jmp to &quot;movl %esp,%ebp&quot; */
multiline_comment|/* System call normal return point is here! (SYSENTER_RETURN in entry.S) */
l_int|0x5d
comma
multiline_comment|/* pop %ebp */
l_int|0x5a
comma
multiline_comment|/* pop %edx */
l_int|0x59
comma
multiline_comment|/* pop %ecx */
l_int|0x9d
comma
multiline_comment|/* popf - restore TF */
l_int|0xc3
multiline_comment|/* ret */
)brace
suffix:semicolon
r_int
r_int
id|page
op_assign
id|get_zeroed_page
c_func
(paren
id|GFP_ATOMIC
)paren
suffix:semicolon
id|__set_fixmap
c_func
(paren
id|FIX_VSYSCALL
comma
id|__pa
c_func
(paren
id|page
)paren
comma
id|PAGE_READONLY
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|page
comma
id|int80
comma
r_sizeof
(paren
id|int80
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|boot_cpu_has
c_func
(paren
id|X86_FEATURE_SEP
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|page
comma
id|sysent
comma
r_sizeof
(paren
id|sysent
)paren
)paren
suffix:semicolon
id|enable_sep_cpu
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
id|smp_call_function
c_func
(paren
id|enable_sep_cpu
comma
l_int|NULL
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sysenter_setup
id|__initcall
c_func
(paren
id|sysenter_setup
)paren
suffix:semicolon
eof
