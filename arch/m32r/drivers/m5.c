multiline_comment|/*&n; * Flash Memory Driver for M32700UT-CPU&n; *&n; * [support chips]&n; *  &t;- M5M29GT320VP&n; *&n; * Copyright (C) 2003   Takeo Takahashi&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; *&n; * 2003-02-01: Takeo Takahashi, support M5M29GT320VP page program.&n; *&n; */
macro_line|#ifndef __KERNEL__
DECL|macro|__KERNEL__
macro_line|#  define __KERNEL__
macro_line|#endif
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ioctl.h&gt;
macro_line|#include &lt;linux/blkpg.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;asm/m32r.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;m5.h&quot;
DECL|variable|version
r_static
r_const
r_char
id|version
(braket
)braket
op_assign
l_string|&quot;M5 Flash Driver&quot;
suffix:semicolon
DECL|variable|date
r_static
r_const
r_char
id|date
(braket
)braket
op_assign
id|__DATE__
suffix:semicolon
DECL|variable|time
r_static
r_const
r_char
id|time
(braket
)braket
op_assign
id|__TIME__
suffix:semicolon
multiline_comment|/*&n; * Special function&n; */
DECL|macro|M5_SUPPORT_PROBE
mdefine_line|#define M5_SUPPORT_PROBE&t;1
DECL|macro|M5_MAX_ERROR
mdefine_line|#define M5_MAX_ERROR&t;&t;5
multiline_comment|/*&n; * flash memory start address:&n; */
singleline_comment|//#define M5_BASE_ADDR         (0x00000000 + NONCACHE_OFFSET)
DECL|macro|M5_BASE_ADDR
mdefine_line|#define M5_BASE_ADDR         (0x00000000 + PAGE_OFFSET)
DECL|macro|M5_IDENT_ADDR
mdefine_line|#define M5_IDENT_ADDR        (M5_BASE_ADDR + 0)
multiline_comment|/*&n; * This driver does not have a real partition block, but&n; * it can support simulation of partition in single chip.&n; */
DECL|macro|M5_PARTITIONS
mdefine_line|#define M5_PARTITIONS        (3)
DECL|variable|m5_len
r_static
r_int
id|m5_len
(braket
id|M5_PARTITIONS
)braket
op_assign
(brace
l_int|192
op_star
l_int|1024
comma
multiline_comment|/* 192kB:&t;0x00000000 - 0x0002ffff */
l_int|1088
op_star
l_int|1024
comma
multiline_comment|/* 1088kB:&t;0x00030000 - 0x0013ffff */
l_int|2816
op_star
l_int|1024
multiline_comment|/* 2816kB:&t;0x00140000 - 0x003fffff */
)brace
suffix:semicolon
DECL|variable|major
r_static
r_int
id|major
op_assign
l_int|240
suffix:semicolon
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|2
suffix:semicolon
DECL|variable|led
r_static
r_int
id|led
op_assign
l_int|0
suffix:semicolon
DECL|variable|m5_addr
r_static
r_int
id|m5_addr
(braket
id|M5_PARTITIONS
)braket
suffix:semicolon
DECL|variable|m5_blk_size
r_static
r_int
id|m5_blk_size
(braket
id|M5_PARTITIONS
)braket
suffix:semicolon
DECL|variable|m5_blksize_size
r_static
r_int
id|m5_blksize_size
(braket
id|M5_PARTITIONS
)braket
suffix:semicolon
DECL|variable|m5_hardsect_size
r_static
r_int
id|m5_hardsect_size
(braket
id|M5_PARTITIONS
)braket
suffix:semicolon
DECL|variable|m5_read_ahead
r_static
r_int
id|m5_read_ahead
op_assign
l_int|1
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|major
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
singleline_comment|//MODULE_PARM_DESC(major, &quot;major number&quot;);
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
singleline_comment|//MODULE_PARM_DESC(debug, &quot;debug flag&quot;);
id|MODULE_PARM
c_func
(paren
id|led
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
singleline_comment|//MODULE_PARM_DESC(led, &quot;LED2 support&quot;);
DECL|variable|devfs_handle
r_static
id|devfs_handle_t
id|devfs_handle
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
DECL|variable|proc_m5
r_static
r_struct
id|proc_dir_entry
op_star
id|proc_m5
suffix:semicolon
macro_line|#endif
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR&t;&t;major
DECL|macro|DEVICE_NAME
mdefine_line|#define DEVICE_NAME &t;&t;&quot;m5&quot;
DECL|macro|DEVICE_NR
mdefine_line|#define DEVICE_NR(device) &t;MINOR(device)
DECL|macro|DEVICE_NO_RANDOM
mdefine_line|#define DEVICE_NO_RANDOM
DECL|macro|DEVICE_OFF
mdefine_line|#define DEVICE_OFF(device)
DECL|macro|DEVICE_ON
mdefine_line|#define DEVICE_ON(device)
DECL|macro|DEVICE_REQUEST
mdefine_line|#define DEVICE_REQUEST &t;&t;m5_request
macro_line|#include &lt;linux/blk.h&gt;
DECL|macro|WAIT_TIME
mdefine_line|#define WAIT_TIME&t;10&t;&t;&t;/* 10 usec */
DECL|macro|WAIT_COUNT
mdefine_line|#define WAIT_COUNT&t;(50000/WAIT_TIME)&t;/* 50ms = 10us*5000times */
DECL|macro|SUCCESS
mdefine_line|#define SUCCESS 0
DECL|macro|FAILED
mdefine_line|#define FAILED  (-1)
multiline_comment|/*&n; * definitions for cache&n; */
DECL|struct|cache
r_static
r_struct
id|cache
(brace
DECL|member|blk
r_int
id|blk
suffix:semicolon
multiline_comment|/* block number, -1:invalid */
DECL|member|status
r_int
id|status
suffix:semicolon
multiline_comment|/* cache status */
DECL|macro|B_CLEAN
mdefine_line|#define B_CLEAN&t;0
DECL|macro|B_DIRTY
mdefine_line|#define B_DIRTY&t;1
DECL|member|addr
id|m5_t
op_star
id|addr
suffix:semicolon
multiline_comment|/* block base address */
DECL|member|cache
id|m5_t
id|cache
(braket
id|M5_BLOCK_SIZE64
)braket
suffix:semicolon
DECL|variable|m5_cache
)brace
id|m5_cache
suffix:semicolon
DECL|macro|M5_BLK_NOCACHED
mdefine_line|#define M5_BLK_NOCACHED()&t;&t;(m5_cache.blk == -1)
DECL|macro|M5_BLK_CACHED
mdefine_line|#define M5_BLK_CACHED(blk)&t;&t;(m5_cache.blk == (blk))
DECL|macro|M5_STATE_DIRTY
mdefine_line|#define M5_STATE_DIRTY()&t;&t;(m5_cache.status == B_DIRTY)
DECL|macro|M5_STATE_CLEAN
mdefine_line|#define M5_STATE_CLEAN()&t;&t;(m5_cache.status == B_CLEAN)
DECL|macro|M5_MARK_DIRTY
mdefine_line|#define M5_MARK_DIRTY()&t;&t;&t;(m5_cache.status = B_DIRTY)
DECL|macro|M5_MARK_CLEAN
mdefine_line|#define M5_MARK_CLEAN()&t;&t;&t;(m5_cache.status = B_CLEAN)
DECL|macro|M5_MARK_NOCACHED
mdefine_line|#define M5_MARK_NOCACHED()&t;&t;(m5_cache.blk = -1)
DECL|macro|M5_MARK_CACHED
mdefine_line|#define M5_MARK_CACHED(blk, addr)&t;(m5_cache.blk = (blk), &bslash;&n;&t;&t;&t;&t;&t; m5_cache.addr = (addr))
DECL|macro|M5_CACHED_BLK
mdefine_line|#define M5_CACHED_BLK&t;&t;&t;m5_cache.blk
DECL|macro|M5_CACHED_ADDR
mdefine_line|#define M5_CACHED_ADDR&t;&t;&t;m5_cache.addr
DECL|macro|M5_CACHED_BASE
mdefine_line|#define M5_CACHED_BASE&t;&t;&t;m5_cache.cache
multiline_comment|/*&n; * Prototype declarations&n; */
r_static
r_int
id|m5_erase_blk
c_func
(paren
id|m5_t
op_star
id|reg
)paren
suffix:semicolon
r_static
r_void
id|m5_led_toggle
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|m5_led_on
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|m5_led_off
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
id|m5_t
id|m5_in
c_func
(paren
id|m5_t
op_star
id|addr
)paren
suffix:semicolon
r_static
r_void
id|m5_out
c_func
(paren
id|m5_t
id|val
comma
id|m5_t
op_star
id|addr
)paren
suffix:semicolon
r_static
r_int
id|m5_probe
c_func
(paren
id|m5_t
op_star
id|addr
)paren
suffix:semicolon
r_static
r_int
id|m5_get_blk_num
c_func
(paren
id|m5_t
op_star
id|addr
)paren
suffix:semicolon
r_static
r_int
id|m5_get_blk_offset
c_func
(paren
r_int
id|blk
comma
id|m5_t
op_star
id|addr
)paren
suffix:semicolon
r_static
r_int
id|m5_get_blk_size
c_func
(paren
r_int
id|blk
)paren
suffix:semicolon
r_static
r_int
id|m5_read_blk_cache
c_func
(paren
id|m5_t
op_star
id|addr
)paren
suffix:semicolon
r_static
r_int
id|m5_write_blk_cache
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|m5_full_status_check
c_func
(paren
id|m5_t
id|status
comma
id|m5_t
op_star
id|reg
)paren
suffix:semicolon
r_static
r_void
id|m5_clear_status
c_func
(paren
id|m5_t
op_star
id|reg
)paren
suffix:semicolon
macro_line|#if 0
r_static
r_int
id|m5_status_check
c_func
(paren
id|m5_t
op_star
id|reg
)paren
suffix:semicolon
macro_line|#endif
r_static
r_int
id|m5_wait_for_ready
c_func
(paren
id|m5_t
op_star
id|reg
)paren
suffix:semicolon
r_static
r_int
id|m5_write_page
c_func
(paren
id|m5_t
op_star
id|addr
comma
r_const
id|m5_t
op_star
id|buf
)paren
suffix:semicolon
r_static
r_int
id|m5_write
c_func
(paren
r_const
id|m5_t
op_star
id|buf
comma
r_int
id|offset
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_int
id|m5_read_page
c_func
(paren
id|m5_t
op_star
id|buf
comma
id|m5_t
op_star
id|addr
)paren
suffix:semicolon
r_static
r_int
id|m5_read
c_func
(paren
id|m5_t
op_star
id|buf
comma
r_int
id|offset
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_int
id|m5_erase_blk
c_func
(paren
id|m5_t
op_star
id|addr
)paren
suffix:semicolon
r_static
r_void
id|m5_request
c_func
(paren
id|request_queue_t
op_star
id|req
)paren
suffix:semicolon
r_static
r_int
id|m5_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|fp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|m5_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|fp
)paren
suffix:semicolon
r_static
r_int
id|m5_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|fp
)paren
suffix:semicolon
r_static
r_int
id|proc_m5_read
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|len
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|unused
)paren
suffix:semicolon
r_static
r_int
id|__init
id|m5_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|__init
id|m5_init_module
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|__exit
id|m5_cleanup_module
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/*&n; * special function&n; */
DECL|function|m5_led_toggle
r_static
r_inline
r_void
id|m5_led_toggle
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|status
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|led
)paren
r_return
suffix:semicolon
id|status
op_assign
id|inw
c_func
(paren
(paren
r_int
r_int
)paren
id|PLD_IOLEDCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|PLD_IOLED_2_ON
)paren
id|status
op_and_assign
op_complement
id|PLD_IOLED_2_ON
suffix:semicolon
r_else
id|status
op_or_assign
id|PLD_IOLED_2_ON
suffix:semicolon
id|outw
c_func
(paren
id|status
comma
(paren
r_int
r_int
)paren
id|PLD_IOLEDCR
)paren
suffix:semicolon
)brace
DECL|function|m5_led_on
r_static
r_inline
r_void
id|m5_led_on
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|status
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|led
)paren
r_return
suffix:semicolon
id|status
op_assign
id|inw
c_func
(paren
(paren
r_int
r_int
)paren
id|PLD_IOLEDCR
)paren
suffix:semicolon
id|status
op_or_assign
id|PLD_IOLED_2_ON
suffix:semicolon
id|outw
c_func
(paren
id|status
comma
(paren
r_int
r_int
)paren
id|PLD_IOLEDCR
)paren
suffix:semicolon
)brace
DECL|function|m5_led_off
r_static
r_inline
r_void
id|m5_led_off
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|status
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|led
)paren
r_return
suffix:semicolon
id|status
op_assign
id|inw
c_func
(paren
(paren
r_int
r_int
)paren
id|PLD_IOLEDCR
)paren
suffix:semicolon
id|status
op_and_assign
op_complement
id|PLD_IOLED_2_ON
suffix:semicolon
id|outw
c_func
(paren
id|status
comma
(paren
r_int
r_int
)paren
id|PLD_IOLEDCR
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * I/O function&n; */
DECL|function|m5_in
r_static
r_inline
id|m5_t
id|m5_in
c_func
(paren
id|m5_t
op_star
id|addr
)paren
(brace
r_return
op_star
id|addr
suffix:semicolon
)brace
DECL|function|m5_out
r_static
r_inline
r_void
id|m5_out
c_func
(paren
id|m5_t
id|val
comma
id|m5_t
op_star
id|addr
)paren
(brace
op_star
id|addr
op_assign
id|val
suffix:semicolon
)brace
macro_line|#if M5_SUPPORT_PROBE
multiline_comment|/*&n; * int m5_probe()&n; *&t;m5_t *addr:&t;probed address&n; * &t;int SUCCESS: &t;supported device&n; *&t;int FAILED: &t;unsupported device&n; */
DECL|function|m5_probe
r_static
r_int
id|m5_probe
c_func
(paren
id|m5_t
op_star
id|addr
)paren
(brace
macro_line|#if 1
multiline_comment|/*&n;&t; * FIXME: cannot read maker &amp; device codes.&n;&t; */
id|m5_t
id|val
suffix:semicolon
id|m5_out
c_func
(paren
id|M5_CMD_DEVICE_IDENT
comma
id|addr
)paren
suffix:semicolon
id|val
op_assign
id|m5_in
c_func
(paren
(paren
id|m5_t
op_star
)paren
id|M5_IDENT_ADDR
)paren
suffix:semicolon
id|val
op_and_assign
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|val
op_eq
id|M5_MAKER
)paren
id|printk
c_func
(paren
l_string|&quot;m5: detected M5M29GT320VP&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;m5: unknown maker(0x%02x)&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
id|m5_out
c_func
(paren
id|M5_CMD_READ_ARRAY
comma
id|addr
)paren
suffix:semicolon
multiline_comment|/* array mode */
multiline_comment|/* always success */
r_return
id|SUCCESS
suffix:semicolon
macro_line|#else
r_int
id|result
suffix:semicolon
id|m5_t
id|val
suffix:semicolon
r_int
r_char
id|maker
comma
id|device
suffix:semicolon
id|result
op_assign
id|SUCCESS
suffix:semicolon
id|m5_out
c_func
(paren
id|M5_CMD_DEVICE_IDENT
comma
id|addr
)paren
suffix:semicolon
id|val
op_assign
id|m5_in
c_func
(paren
(paren
id|m5_t
op_star
)paren
id|M5_IDENT_ADDR
)paren
suffix:semicolon
id|maker
op_assign
(paren
id|val
op_rshift
l_int|16
)paren
suffix:semicolon
id|device
op_assign
(paren
id|val
op_amp
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|maker
op_ne
id|M5_MAKER
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;m5: unknown maker(0x%02x)&bslash;n&quot;
comma
id|maker
)paren
suffix:semicolon
singleline_comment|// result = FAILED;
singleline_comment|// ignore error
)brace
r_if
c_cond
(paren
id|device
op_ne
id|M5_M5M29GT320VP
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;m5: unknown device(0x%02x)&bslash;n&quot;
comma
id|device
)paren
suffix:semicolon
singleline_comment|// result = FAILED;
singleline_comment|// ignore error
)brace
r_if
c_cond
(paren
id|result
op_ne
id|FAILED
)paren
id|printk
c_func
(paren
l_string|&quot;m5: detected M5M29GT320VP&bslash;n&quot;
)paren
suffix:semicolon
id|m5_out
c_func
(paren
id|M5_CMD_READ_ARRAY
comma
id|addr
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
macro_line|#endif
)brace
macro_line|#endif&t;/* M5_SUPPORT_PROBE */
multiline_comment|/*&n; * int m5_get_blk_num()&n; *&t;m5_t *addr:&n; *&t;blk:&t;OK, return block number&n; *&t;-1:&t;NG&n; */
DECL|function|m5_get_blk_num
r_static
r_int
id|m5_get_blk_num
c_func
(paren
id|m5_t
op_star
id|addr
)paren
(brace
r_int
id|blk
suffix:semicolon
id|blk
op_assign
(paren
(paren
(paren
r_int
)paren
id|addr
op_amp
l_int|0x0fff0000
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blk
OG
l_int|0x3f
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;m5: out of block address (0x%08x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|addr
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|blk
op_eq
l_int|0x3f
)paren
id|blk
op_add_assign
(paren
r_int
)paren
(paren
(paren
(paren
r_int
)paren
id|addr
op_amp
l_int|0x0000e000
)paren
op_rshift
l_int|13
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blk
OG
id|MAX_BLOCK_NUM
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;m5: out of block address (addr=0x%08x, blk=%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|addr
comma
id|blk
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
id|blk
suffix:semicolon
)brace
multiline_comment|/*&n; * m5_t *m5_get_blk_base()&n; *&t;return block base address&n; */
DECL|function|m5_get_blk_base
r_static
r_inline
id|m5_t
op_star
id|m5_get_blk_base
c_func
(paren
r_int
id|blk
comma
id|m5_t
op_star
id|addr
)paren
(brace
r_if
c_cond
(paren
id|blk
OL
l_int|0x3f
)paren
r_return
(paren
id|m5_t
op_star
)paren
(paren
(paren
r_int
)paren
id|addr
op_amp
l_int|0xffff0000
)paren
suffix:semicolon
r_return
(paren
id|m5_t
op_star
)paren
(paren
(paren
r_int
)paren
id|addr
op_amp
l_int|0xffffe000
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * int m5_get_blk_offset()&n; *&t;return offset of specified address in blk&n; */
DECL|function|m5_get_blk_offset
r_static
r_inline
r_int
id|m5_get_blk_offset
c_func
(paren
r_int
id|blk
comma
id|m5_t
op_star
id|addr
)paren
(brace
r_if
c_cond
(paren
id|blk
OL
l_int|0x3f
)paren
r_return
(paren
(paren
r_int
)paren
id|addr
op_amp
l_int|0xffff
)paren
suffix:semicolon
r_return
(paren
(paren
r_int
)paren
id|addr
op_amp
l_int|0x1fff
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * int m5_get_blk_size()&n; *&t;return block size in byte&n; */
DECL|function|m5_get_blk_size
r_static
r_inline
r_int
id|m5_get_blk_size
c_func
(paren
r_int
id|blk
)paren
(brace
r_if
c_cond
(paren
id|blk
op_ge
l_int|63
)paren
r_return
id|M5_BLOCK_SIZE8
suffix:semicolon
r_return
id|M5_BLOCK_SIZE64
suffix:semicolon
)brace
multiline_comment|/*&n; * cache operations&n; */
DECL|function|m5_read_blk_cache
r_static
r_int
id|m5_read_blk_cache
c_func
(paren
id|m5_t
op_star
id|addr
)paren
(brace
r_int
id|blk
suffix:semicolon
r_int
id|size
suffix:semicolon
r_int
id|result
suffix:semicolon
id|result
op_assign
id|SUCCESS
suffix:semicolon
id|blk
op_assign
id|m5_get_blk_num
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blk
OL
l_int|0
)paren
r_return
id|FAILED
suffix:semicolon
r_if
c_cond
(paren
id|M5_BLK_CACHED
c_func
(paren
id|blk
)paren
)paren
r_return
id|result
suffix:semicolon
r_if
c_cond
(paren
id|M5_STATE_DIRTY
c_func
(paren
)paren
)paren
(brace
multiline_comment|/* cached other block */
id|result
op_assign
id|m5_write_blk_cache
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|SUCCESS
)paren
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* ok, we can use cache */
id|size
op_assign
id|m5_get_blk_size
c_func
(paren
id|blk
)paren
suffix:semicolon
id|addr
op_assign
id|m5_get_blk_base
c_func
(paren
id|blk
comma
id|addr
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|M5_CACHED_BASE
comma
(paren
r_void
op_star
)paren
id|addr
comma
id|size
)paren
suffix:semicolon
id|M5_MARK_CACHED
c_func
(paren
id|blk
comma
id|addr
)paren
suffix:semicolon
id|M5_MARK_CLEAN
c_func
(paren
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|m5_write_blk_cache
r_static
r_int
id|m5_write_blk_cache
c_func
(paren
r_void
)paren
(brace
r_int
id|size
suffix:semicolon
r_int
id|pages
suffix:semicolon
r_int
id|i
suffix:semicolon
id|m5_t
op_star
id|reg
comma
op_star
id|addr
comma
op_star
id|buf
suffix:semicolon
r_int
id|result
suffix:semicolon
id|result
op_assign
id|SUCCESS
suffix:semicolon
r_if
c_cond
(paren
id|M5_BLK_NOCACHED
c_func
(paren
)paren
)paren
r_return
id|result
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|M5_STATE_DIRTY
c_func
(paren
)paren
)paren
r_return
id|result
suffix:semicolon
multiline_comment|/* we have to write cache */
id|m5_led_on
c_func
(paren
)paren
suffix:semicolon
id|size
op_assign
id|m5_get_blk_size
c_func
(paren
id|M5_CACHED_BLK
)paren
suffix:semicolon
id|addr
op_assign
id|M5_CACHED_ADDR
suffix:semicolon
id|buf
op_assign
id|M5_CACHED_BASE
suffix:semicolon
id|reg
op_assign
id|addr
suffix:semicolon
id|result
op_assign
id|m5_erase_blk
c_func
(paren
id|reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|SUCCESS
)paren
r_return
id|result
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;m5: wrting addr=0x%08x, buf=0x%08x, size=%d&bslash;n&quot;
comma
"&bslash;"
(paren
r_int
)paren
id|addr
comma
(paren
r_int
)paren
id|buf
comma
id|size
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pages
op_assign
l_int|0
suffix:semicolon
id|pages
OL
(paren
id|size
op_div
id|M5_PAGE_SIZE
)paren
suffix:semicolon
id|pages
op_increment
)paren
(brace
id|m5_out
c_func
(paren
id|M5_CMD_PROGRAM_PAGE
comma
id|reg
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|M5_PAGE_SIZE
op_div
r_sizeof
(paren
id|m5_t
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
op_star
id|addr
op_increment
op_assign
op_star
id|buf
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|m5_wait_for_ready
c_func
(paren
id|reg
)paren
op_ne
id|SUCCESS
)paren
id|result
op_assign
id|FAILED
suffix:semicolon
id|reg
op_assign
id|addr
suffix:semicolon
)brace
id|m5_out
c_func
(paren
id|M5_CMD_READ_ARRAY
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* array mode */
r_if
c_cond
(paren
id|result
op_eq
id|SUCCESS
)paren
id|M5_MARK_CLEAN
c_func
(paren
)paren
suffix:semicolon
id|m5_led_off
c_func
(paren
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
multiline_comment|/* SUCCESS or FAILED */
)brace
multiline_comment|/*&n; * int m5_full_status_check()&n; *&t;m5_t status:&t;status&n; *&t;m5_t *reg:&t;bank address&n; *&t;SUCCESS:&t;no error&n; *&t;FAILED:&t;&t;error happen&n; */
DECL|function|m5_full_status_check
r_static
r_inline
r_int
id|m5_full_status_check
c_func
(paren
id|m5_t
id|status
comma
id|m5_t
op_star
id|reg
)paren
(brace
r_if
c_cond
(paren
(paren
id|status
op_amp
id|M5_STATUS_PROGRAM
)paren
op_logical_and
(paren
id|status
op_amp
id|M5_STATUS_ERASE
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;m5: command sequence error (addr=0x%08x, sts=0x%02x).&bslash;n&quot;
comma
(paren
r_int
)paren
id|reg
comma
id|status
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|M5_STATUS_ERASE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;m5: erase error (addr=0x%08x, sts=0x%02x).&bslash;n&quot;
comma
(paren
r_int
)paren
id|reg
comma
id|status
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|M5_STATUS_PROGRAM
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;m5: program write error (addr=0x%08x, sts=0x%02x).&bslash;n&quot;
comma
(paren
r_int
)paren
id|reg
comma
id|status
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|M5_STATUS_BLOCK
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;m5: block write error (addr=0x%08x, sts=0x%02x).&bslash;n&quot;
comma
(paren
r_int
)paren
id|reg
comma
id|status
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
multiline_comment|/* passed */
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/*&n; * void m5_clear_status()&n; *&t;m5_t *reg:&t;address of status register&n; */
DECL|function|m5_clear_status
r_static
r_inline
r_void
id|m5_clear_status
c_func
(paren
id|m5_t
op_star
id|reg
)paren
(brace
id|m5_out
c_func
(paren
id|M5_CMD_CLEAR_STATUS
comma
id|reg
)paren
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/*&n; * int m5_status_check()&n; *&t;m5_t *reg:&t;address of command register&n; *&t;SUCCESS:&t;ready now&n; *&t;FAILED:&t;&t;error happen while waiting&n; */
r_static
r_int
id|m5_status_check
c_func
(paren
id|m5_t
op_star
id|reg
)paren
(brace
id|m5_t
id|status
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
id|n
suffix:semicolon
r_static
r_int
id|error_count
op_assign
l_int|0
suffix:semicolon
id|m5_out
c_func
(paren
id|M5_CMD_READ_STATUS
comma
id|reg
)paren
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
id|WAIT_COUNT
suffix:semicolon
id|n
OG
l_int|0
suffix:semicolon
id|n
op_decrement
)paren
(brace
id|status
op_assign
id|m5_in
c_func
(paren
id|reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|M5_STATUS_READY
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
id|WAIT_TIME
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n
op_le
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|error_count
op_increment
OL
id|M5_MAX_ERROR
)paren
id|printk
c_func
(paren
l_string|&quot;m5: time out (sts=0x%02x).&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|m5_clear_status
c_func
(paren
id|reg
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|result
op_assign
id|m5_full_status_check
c_func
(paren
id|status
comma
id|reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|SUCCESS
)paren
(brace
id|m5_clear_status
c_func
(paren
id|reg
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|m5_clear_status
c_func
(paren
id|reg
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * int m5_wait_for_ready()&n; *&t;m5_t *reg:&t;address of command register&n; *&t;SUCCESS:&t;ready now&n; *&t;FAILED:&t;&t;error happen while waiting&n; */
DECL|function|m5_wait_for_ready
r_static
r_int
id|m5_wait_for_ready
c_func
(paren
id|m5_t
op_star
id|reg
)paren
(brace
id|m5_t
id|status
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
id|n
suffix:semicolon
r_static
r_int
id|error_count
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
id|WAIT_COUNT
suffix:semicolon
id|n
OG
l_int|0
suffix:semicolon
id|n
op_decrement
)paren
(brace
id|status
op_assign
id|m5_in
c_func
(paren
id|reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|M5_STATUS_READY
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
id|WAIT_TIME
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n
op_le
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|error_count
op_increment
OL
id|M5_MAX_ERROR
)paren
id|printk
c_func
(paren
l_string|&quot;m5: time out (sts=0x%02x).&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|m5_clear_status
c_func
(paren
id|reg
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|result
op_assign
id|m5_full_status_check
c_func
(paren
id|status
comma
id|reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|SUCCESS
)paren
(brace
id|m5_clear_status
c_func
(paren
id|reg
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/*&n; * int m5_write_page(m5_t *addr, const m5_t *buf)&n; *&t;m5_t *addr:&t;sector address&n; *&t;m5_t *buf:&t;buffer address&n; *&t;SUCCESS:&t;ok&n; *&t;FAILED:&t;&t;error&n; */
DECL|function|m5_write_page
r_static
r_int
id|m5_write_page
c_func
(paren
id|m5_t
op_star
id|addr
comma
r_const
id|m5_t
op_star
id|buf
)paren
(brace
r_int
id|blk
suffix:semicolon
r_int
id|offset
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
)paren
id|addr
op_mod
id|M5_PAGE_SIZE
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;m5: invalid sector addres (0x%08x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m5_read_blk_cache
c_func
(paren
id|addr
)paren
op_ne
id|SUCCESS
)paren
r_return
id|FAILED
suffix:semicolon
r_if
c_cond
(paren
(paren
id|blk
op_assign
id|m5_get_blk_num
c_func
(paren
id|addr
)paren
)paren
OL
l_int|0
)paren
r_return
id|FAILED
suffix:semicolon
id|offset
op_assign
id|m5_get_blk_offset
c_func
(paren
id|blk
comma
id|addr
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|M5_CACHED_BASE
op_plus
id|offset
comma
(paren
r_void
op_star
)paren
id|buf
comma
id|M5_PAGE_SIZE
)paren
suffix:semicolon
id|M5_MARK_DIRTY
c_func
(paren
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/*&n; * int m5_write(const m5_t *buf, int offset, int len)&n; *&t;m5_t *buf:&t;write buffer address&n; *&t;int offset:&t;offset from flash base address&n; *&t;int len:&t;write length&n; *&t;SUCCESS:&t;ok&n; *&t;FAILE:&t;&t;error&n; */
DECL|function|m5_write
r_static
r_int
id|m5_write
c_func
(paren
r_const
id|m5_t
op_star
id|buf
comma
r_int
id|offset
comma
r_int
id|len
)paren
(brace
id|m5_t
op_star
id|addr
suffix:semicolon
r_int
id|result
suffix:semicolon
r_if
c_cond
(paren
id|len
op_mod
id|M5_PAGE_SIZE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;m5: invalid write size (%d).&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|addr
op_assign
(paren
id|m5_t
op_star
)paren
(paren
id|m5_addr
(braket
id|MINOR
c_func
(paren
id|CURRENT_DEV
)paren
)braket
op_plus
id|offset
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;m5: writing 0x%08x - 0x%08x&bslash;n&quot;
comma
"&bslash;"
(paren
r_int
)paren
id|addr
comma
(paren
r_int
)paren
id|addr
op_plus
id|len
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|len
OG
l_int|0
suffix:semicolon
id|len
op_sub_assign
id|M5_PAGE_SIZE
)paren
(brace
id|result
op_assign
id|m5_write_page
c_func
(paren
id|addr
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|SUCCESS
)paren
r_return
id|result
suffix:semicolon
id|addr
op_assign
(paren
id|m5_t
op_star
)paren
(paren
(paren
r_int
)paren
id|addr
op_plus
id|M5_PAGE_SIZE
)paren
suffix:semicolon
id|buf
op_assign
(paren
id|m5_t
op_star
)paren
(paren
(paren
r_int
)paren
id|buf
op_plus
id|M5_PAGE_SIZE
)paren
suffix:semicolon
)brace
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/*&n; * int m5_read_page()&n; *&t;m5_t *buf:&t;read buffer address&n; *&t;m5_t *addr:&t;page address&n; *&t;SUCCESS:&t;ok&n; *&t;FAILED:&t;&t;error&n; */
DECL|function|m5_read_page
r_static
r_int
id|m5_read_page
c_func
(paren
id|m5_t
op_star
id|buf
comma
id|m5_t
op_star
id|addr
)paren
(brace
r_int
id|blk
suffix:semicolon
r_int
id|offset
suffix:semicolon
r_if
c_cond
(paren
(paren
id|blk
op_assign
id|m5_get_blk_num
c_func
(paren
id|addr
)paren
)paren
OL
l_int|0
)paren
r_return
id|FAILED
suffix:semicolon
r_if
c_cond
(paren
id|M5_BLK_CACHED
c_func
(paren
id|blk
)paren
)paren
(brace
id|offset
op_assign
id|m5_get_blk_offset
c_func
(paren
id|blk
comma
id|addr
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|buf
comma
(paren
r_void
op_star
)paren
id|M5_CACHED_BASE
op_plus
id|offset
comma
id|M5_PAGE_SIZE
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* read from flash memory directory */
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|buf
comma
(paren
r_void
op_star
)paren
id|addr
comma
id|M5_PAGE_SIZE
)paren
suffix:semicolon
)brace
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/*&n; * int m5_read()&n; *&t;m5_t *buf:&t;&t;read buffer address&n; *&t;int offset:&t;&t;offset from flash base address&n; *&t;int len:&t;&t;read length&n; *&t;SUCCESS:&t;&t;ok&n; *&t;FAILED:&t;&t;&t;error&n; */
DECL|function|m5_read
r_static
r_int
id|m5_read
c_func
(paren
id|m5_t
op_star
id|buf
comma
r_int
id|offset
comma
r_int
id|len
)paren
(brace
id|m5_t
op_star
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|len
op_mod
id|M5_PAGE_SIZE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;m5: invalid read size (%d).&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|addr
op_assign
(paren
id|m5_t
op_star
)paren
(paren
id|m5_addr
(braket
id|MINOR
c_func
(paren
id|CURRENT_DEV
)paren
)braket
op_plus
id|offset
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;m5: reading 0x%08x - 0x%08x&bslash;n&quot;
comma
"&bslash;"
(paren
r_int
)paren
id|addr
comma
(paren
r_int
)paren
id|addr
op_plus
id|len
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|len
OG
l_int|0
suffix:semicolon
id|len
op_sub_assign
id|M5_PAGE_SIZE
)paren
(brace
r_if
c_cond
(paren
id|m5_read_page
c_func
(paren
id|buf
comma
id|addr
)paren
op_ne
id|SUCCESS
)paren
r_return
id|FAILED
suffix:semicolon
id|buf
op_assign
(paren
id|m5_t
op_star
)paren
(paren
(paren
r_int
)paren
id|buf
op_plus
id|M5_PAGE_SIZE
)paren
suffix:semicolon
id|addr
op_assign
(paren
id|m5_t
op_star
)paren
(paren
(paren
r_int
)paren
id|addr
op_plus
id|M5_PAGE_SIZE
)paren
suffix:semicolon
)brace
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/*&n; * int m5_erase_blk()&n; *&t;m5_t *addr:&n; */
DECL|function|m5_erase_blk
r_static
r_int
id|m5_erase_blk
c_func
(paren
id|m5_t
op_star
id|addr
)paren
(brace
r_int
id|result
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;m5: erasing addr=0x%08x&bslash;n&quot;
comma
(paren
r_int
)paren
id|addr
)paren
suffix:semicolon
id|m5_out
c_func
(paren
id|M5_CMD_BLOCK_ERASE
comma
id|addr
)paren
suffix:semicolon
id|m5_out
c_func
(paren
id|M5_CMD_CONFIRM
comma
id|addr
)paren
suffix:semicolon
id|result
op_assign
id|m5_wait_for_ready
c_func
(paren
id|addr
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * void m5_request()&n; *&t;request_queue_t *req:&t;I/O request&n; *&t;end_request(0):&t;error (-EIO)&n; *&t;end_request(1): ok&n; */
DECL|function|m5_request
r_static
r_void
id|m5_request
c_func
(paren
id|request_queue_t
op_star
id|req
)paren
(brace
r_int
r_int
id|minor
suffix:semicolon
r_int
id|offset
suffix:semicolon
r_int
id|len
suffix:semicolon
r_static
r_int
id|error_count
op_assign
l_int|0
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|INIT_REQUEST
suffix:semicolon
id|minor
op_assign
id|MINOR
c_func
(paren
id|CURRENT_DEV
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minor
op_ge
id|M5_PARTITIONS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;m5: out of partition (%d)&bslash;n&quot;
comma
id|minor
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|offset
op_assign
id|CURRENT-&gt;sector
op_star
id|m5_hardsect_size
(braket
id|minor
)braket
suffix:semicolon
id|len
op_assign
(paren
id|CURRENT-&gt;current_nr_sectors
op_star
id|m5_hardsect_size
(braket
id|minor
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|offset
op_plus
id|len
)paren
OG
id|m5_len
(braket
id|minor
)braket
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;m5: out of sector (sector=%d, nr=%d)&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|CURRENT-&gt;sector
)paren
comma
(paren
r_int
)paren
(paren
id|CURRENT-&gt;current_nr_sectors
)paren
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|CURRENT-&gt;cmd
)paren
(brace
r_case
id|READ
suffix:colon
r_if
c_cond
(paren
id|m5_read
c_func
(paren
(paren
id|m5_t
op_star
)paren
id|CURRENT-&gt;buffer
comma
id|offset
comma
id|len
)paren
op_ne
id|SUCCESS
)paren
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_else
id|end_request
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WRITE
suffix:colon
r_if
c_cond
(paren
id|m5_write
c_func
(paren
(paren
id|m5_t
op_star
)paren
(paren
id|CURRENT-&gt;buffer
)paren
comma
id|offset
comma
id|len
)paren
op_ne
id|SUCCESS
)paren
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_else
id|end_request
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|error_count
op_increment
OL
id|M5_MAX_ERROR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;m5: invalid I/O request(%d)&bslash;n&quot;
comma
id|CURRENT-&gt;cmd
)paren
suffix:semicolon
)brace
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * int m5_ioctl()&n; *&t;struct inode *inode:&n; *&t;struct file *file:&n; *&t;unsigned int cmd:&n; *&t;unsigned long arg:&n; */
DECL|function|m5_ioctl
r_static
r_int
id|m5_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|fp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|size
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;m5_ioctl()&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|BLKGETSIZE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|size
op_assign
(paren
l_int|1024
op_star
id|m5_blk_size
(braket
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
)braket
op_div
id|m5_hardsect_size
(braket
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
)braket
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|size
comma
(paren
r_int
id|__user
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|BLKFLSBUF
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|fsync_dev
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
id|invalidate_buffers
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|BLKRRPART
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|BLKRAGET
suffix:colon
r_case
id|BLKRASET
suffix:colon
r_case
id|BLKGETSIZE64
suffix:colon
r_case
id|BLKROSET
suffix:colon
r_case
id|BLKROGET
suffix:colon
r_case
id|BLKSSZGET
suffix:colon
r_return
id|blk_ioctl
c_func
(paren
id|inode-&gt;i_rdev
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;m5: unsupported ioctl(0x%08x)&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * int m5_open()&n; *&t;struct inode *inode:&n; *&t;struct file *fp:&n; */
DECL|function|m5_open
r_static
r_int
id|m5_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|fp
)paren
(brace
r_if
c_cond
(paren
id|DEVICE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
op_ge
id|M5_PARTITIONS
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * int m5_release()&n; *&t;struct inode *inode:&n; *&t;struct file *fp:&n; */
DECL|function|m5_release
r_static
r_int
id|m5_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|fp
)paren
(brace
id|sync_dev
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
multiline_comment|/*&n; * int proc_m5_read()&n; *&t;char *buf:&n; *&t;char **start:&n; *&t;off_t offset:&n; *&t;int len:&n; *&t;int *eof:&n; *&t;void *unused:&n; */
DECL|function|proc_m5_read
r_static
r_int
id|proc_m5_read
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|len
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|unused
)paren
(brace
id|len
op_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;partition: %d&bslash;n&quot;
comma
id|M5_PARTITIONS
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
macro_line|#endif
DECL|variable|m5_fops
r_static
r_struct
id|block_device_operations
id|m5_fops
op_assign
(brace
id|open
suffix:colon
id|m5_open
comma
id|release
suffix:colon
id|m5_release
comma
id|ioctl
suffix:colon
id|m5_ioctl
comma
multiline_comment|/* check_media_change: */
multiline_comment|/* revalidate: */
id|owner
suffix:colon
id|THIS_MODULE
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * int m5_init()&n; */
DECL|function|m5_init
r_static
r_int
id|__init
id|m5_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|result
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s (%s %s)&bslash;n&quot;
comma
id|version
comma
id|date
comma
id|time
)paren
suffix:semicolon
macro_line|#if M5_SUPPORT_PROBE
r_if
c_cond
(paren
id|m5_probe
c_func
(paren
(paren
id|m5_t
op_star
)paren
id|M5_BASE_ADDR
)paren
op_ne
id|SUCCESS
)paren
r_return
id|result
suffix:semicolon
macro_line|#endif&t;/* M5_SUPPORT_PROBE */
r_if
c_cond
(paren
id|register_blkdev
c_func
(paren
id|major
comma
id|DEVICE_NAME
comma
op_amp
id|m5_fops
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;m5: can not not get major %d&quot;
comma
id|major
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devfs_register_blkdev
c_func
(paren
id|major
comma
id|DEVICE_NAME
comma
op_amp
id|m5_fops
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;m5: can not not get major %d&quot;
comma
id|major
)paren
suffix:semicolon
r_goto
id|fail_devfs
suffix:semicolon
)brace
id|devfs_handle
op_assign
id|devfs_mk_dir
c_func
(paren
l_int|NULL
comma
l_string|&quot;m5&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|devfs_register_series
c_func
(paren
id|devfs_handle
comma
l_string|&quot;%u&quot;
comma
id|M5_PARTITIONS
comma
id|DEVFS_FL_DEFAULT
comma
id|major
comma
l_int|0
comma
id|S_IFBLK
op_or
id|S_IRUSR
op_or
id|S_IWUSR
comma
op_amp
id|m5_fops
comma
l_int|NULL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|M5_PARTITIONS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
)paren
(brace
id|m5_addr
(braket
id|i
)braket
op_assign
id|m5_addr
(braket
id|i
op_minus
l_int|1
)braket
op_plus
id|m5_len
(braket
id|i
op_minus
l_int|1
)braket
suffix:semicolon
)brace
r_else
(brace
id|m5_addr
(braket
id|i
)braket
op_assign
id|M5_BASE_ADDR
suffix:semicolon
)brace
id|m5_blk_size
(braket
id|i
)braket
op_assign
id|m5_len
(braket
id|i
)braket
op_div
l_int|1024
suffix:semicolon
multiline_comment|/* KB order */
id|m5_blksize_size
(braket
id|i
)braket
op_assign
id|BLOCK_SIZE
suffix:semicolon
multiline_comment|/* 1024 byte */
id|m5_hardsect_size
(braket
id|i
)braket
op_assign
id|BLOCK_SIZE
op_div
l_int|2
suffix:semicolon
multiline_comment|/* 512 byte */
)brace
multiline_comment|/* defined in ll_rw_blk.c */
id|blk_size
(braket
id|major
)braket
op_assign
id|m5_blk_size
suffix:semicolon
id|blksize_size
(braket
id|major
)braket
op_assign
id|m5_blksize_size
suffix:semicolon
id|hardsect_size
(braket
id|major
)braket
op_assign
id|m5_hardsect_size
suffix:semicolon
id|read_ahead
(braket
id|major
)braket
op_assign
id|m5_read_ahead
suffix:semicolon
id|blk_init_queue
c_func
(paren
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|major
)paren
comma
op_amp
id|m5_request
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|M5_PARTITIONS
suffix:semicolon
id|i
op_increment
)paren
id|register_disk
c_func
(paren
l_int|NULL
comma
id|MKDEV
c_func
(paren
id|major
comma
id|i
)paren
comma
l_int|1
comma
op_amp
id|m5_fops
comma
id|m5_len
(braket
id|i
)braket
op_rshift
l_int|9
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
macro_line|#if&t;1
id|proc_m5
op_assign
id|proc_mkdir
c_func
(paren
l_string|&quot;m5&quot;
comma
id|proc_root_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|proc_m5
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;m5: unable to register driver/m5&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|fail_proc
suffix:semicolon
)brace
id|create_proc_read_entry
c_func
(paren
l_string|&quot;0&quot;
comma
l_int|0
comma
id|proc_m5
comma
id|proc_m5_read
comma
l_int|0
)paren
suffix:semicolon
id|create_proc_read_entry
c_func
(paren
l_string|&quot;1&quot;
comma
l_int|0
comma
id|proc_m5
comma
id|proc_m5_read
comma
l_int|0
)paren
suffix:semicolon
id|create_proc_read_entry
c_func
(paren
l_string|&quot;2&quot;
comma
l_int|0
comma
id|proc_m5
comma
id|proc_m5_read
comma
l_int|0
)paren
suffix:semicolon
macro_line|#else
id|proc_m5
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;driver/m5&quot;
comma
l_int|666
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|proc_m5
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;m5: unable to register driver/m5&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|fail_proc
suffix:semicolon
)brace
id|proc_m5-&gt;read_proc
op_assign
id|proc_m5_read
suffix:semicolon
macro_line|#endif
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;m5: Major=%d Partitions=%d&bslash;n&quot;
comma
id|major
comma
id|M5_PARTITIONS
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|M5_PARTITIONS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;  %d: 0x%08x-0x%08x (all=%dKB,blk=%dB,sect=%dB,ahead=%d)&bslash;n&quot;
comma
id|i
comma
id|m5_addr
(braket
id|i
)braket
comma
id|m5_addr
(braket
id|i
)braket
op_plus
id|m5_len
(braket
id|i
)braket
comma
id|m5_blk_size
(braket
id|i
)braket
comma
id|m5_blksize_size
(braket
id|i
)braket
comma
id|m5_hardsect_size
(braket
id|i
)braket
comma
id|m5_read_ahead
)paren
suffix:semicolon
)brace
multiline_comment|/* clear cache */
id|M5_MARK_CLEAN
c_func
(paren
)paren
suffix:semicolon
id|M5_MARK_NOCACHED
c_func
(paren
)paren
suffix:semicolon
id|m5_led_off
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail_proc
suffix:colon
id|devfs_unregister
c_func
(paren
id|devfs_handle
)paren
suffix:semicolon
id|fail_devfs
suffix:colon
id|unregister_blkdev
c_func
(paren
id|major
comma
id|DEVICE_NAME
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|m5_init_module
r_static
r_int
id|__init
id|m5_init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|m5_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|m5_cleanup_module
r_static
r_void
id|__exit
id|m5_cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|M5_PARTITIONS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|fsync_dev
c_func
(paren
id|MKDEV
c_func
(paren
id|major
comma
id|i
)paren
)paren
suffix:semicolon
multiline_comment|/* flush buffer */
id|destroy_buffers
c_func
(paren
id|MKDEV
c_func
(paren
id|major
comma
id|i
)paren
)paren
suffix:semicolon
)brace
id|m5_write_blk_cache
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* flush m5 cache */
id|devfs_unregister
c_func
(paren
id|devfs_handle
)paren
suffix:semicolon
id|unregister_blkdev
c_func
(paren
id|major
comma
id|DEVICE_NAME
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|remove_proc_entry
c_func
(paren
l_string|&quot;0&quot;
comma
id|proc_m5
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
l_string|&quot;1&quot;
comma
id|proc_m5
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
l_string|&quot;2&quot;
comma
id|proc_m5
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
l_string|&quot;m5&quot;
comma
id|proc_root_driver
)paren
suffix:semicolon
macro_line|#endif
id|blk_cleanup_queue
c_func
(paren
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|major
)paren
)paren
suffix:semicolon
id|blk_size
(braket
id|major
)braket
op_assign
l_int|NULL
suffix:semicolon
id|blksize_size
(braket
id|major
)braket
op_assign
l_int|NULL
suffix:semicolon
id|hardsect_size
(braket
id|major
)braket
op_assign
l_int|NULL
suffix:semicolon
id|read_ahead
(braket
id|major
)braket
op_assign
l_int|0
suffix:semicolon
)brace
DECL|variable|m5_init_module
id|module_init
c_func
(paren
id|m5_init_module
)paren
suffix:semicolon
DECL|variable|m5_cleanup_module
id|module_exit
c_func
(paren
id|m5_cleanup_module
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Takeo Takahashi&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;M5 Flash Driver for M32700UT-CPU&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|EXPORT_NO_SYMBOLS
suffix:semicolon
eof
