multiline_comment|/*&n; * Flash memory access on M32R based devices&n; *&n; * Copyright (C) 2003&t;Takeo Takahashi&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; *&n; * $Id$&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mtd/mtd.h&gt;
macro_line|#include &lt;linux/mtd/map.h&gt;
macro_line|#include &lt;linux/mtd/partitions.h&gt;
macro_line|#include &lt;asm/m32r.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|macro|WINDOW_ADDR
mdefine_line|#define WINDOW_ADDR (0xa0000000)&t;/* start of flash memory */
DECL|function|m32r_read8
r_static
id|__u8
id|m32r_read8
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|ofs
)paren
(brace
r_return
id|readb
c_func
(paren
id|map-&gt;map_priv_1
op_plus
id|ofs
)paren
suffix:semicolon
)brace
DECL|function|m32r_read16
r_static
id|__u16
id|m32r_read16
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|ofs
)paren
(brace
r_return
id|readw
c_func
(paren
id|map-&gt;map_priv_1
op_plus
id|ofs
)paren
suffix:semicolon
)brace
DECL|function|m32r_read32
r_static
id|__u32
id|m32r_read32
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|ofs
)paren
(brace
r_return
id|readl
c_func
(paren
id|map-&gt;map_priv_1
op_plus
id|ofs
)paren
suffix:semicolon
)brace
DECL|function|m32r_copy_from
r_static
r_void
id|m32r_copy_from
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_void
op_star
id|to
comma
r_int
r_int
id|from
comma
id|ssize_t
id|len
)paren
(brace
id|memcpy
c_func
(paren
id|to
comma
(paren
r_void
op_star
)paren
(paren
id|map-&gt;map_priv_1
op_plus
id|from
)paren
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|m32r_write8
r_static
r_void
id|m32r_write8
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
id|__u8
id|d
comma
r_int
r_int
id|adr
)paren
(brace
id|writeb
c_func
(paren
id|d
comma
id|map-&gt;map_priv_1
op_plus
id|adr
)paren
suffix:semicolon
)brace
DECL|function|m32r_write16
r_static
r_void
id|m32r_write16
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
id|__u16
id|d
comma
r_int
r_int
id|adr
)paren
(brace
id|writew
c_func
(paren
id|d
comma
id|map-&gt;map_priv_1
op_plus
id|adr
)paren
suffix:semicolon
)brace
DECL|function|m32r_write32
r_static
r_void
id|m32r_write32
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
id|__u32
id|d
comma
r_int
r_int
id|adr
)paren
(brace
id|writel
c_func
(paren
id|d
comma
id|map-&gt;map_priv_1
op_plus
id|adr
)paren
suffix:semicolon
)brace
DECL|function|m32r_copy_to
r_static
r_void
id|m32r_copy_to
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|to
comma
r_const
r_void
op_star
id|from
comma
id|ssize_t
id|len
)paren
(brace
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|map-&gt;map_priv_1
op_plus
id|to
)paren
comma
id|from
comma
id|len
)paren
suffix:semicolon
)brace
DECL|variable|m32r_map
r_static
r_struct
id|map_info
id|m32r_map
op_assign
(brace
id|name
suffix:colon
l_string|&quot;M32R flash&quot;
comma
id|read8
suffix:colon
id|m32r_read8
comma
id|read16
suffix:colon
id|m32r_read16
comma
id|read32
suffix:colon
id|m32r_read32
comma
id|copy_from
suffix:colon
id|m32r_copy_from
comma
id|write8
suffix:colon
id|m32r_write8
comma
id|write16
suffix:colon
id|m32r_write16
comma
id|write32
suffix:colon
id|m32r_write32
comma
id|copy_to
suffix:colon
id|m32r_copy_to
comma
id|map_priv_1
suffix:colon
id|WINDOW_ADDR
comma
id|map_priv_2
suffix:colon
op_minus
l_int|1
comma
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_PLAT_M32700UT
DECL|macro|M32700UT_FLASH_SIZE
mdefine_line|#define M32700UT_FLASH_SIZE&t;&t;0x00400000
DECL|variable|m32700ut_partitions
r_static
r_struct
id|mtd_partition
id|m32700ut_partitions
(braket
)braket
op_assign
(brace
(brace
id|name
suffix:colon
l_string|&quot;M32700UT boot firmware&quot;
comma
id|size
suffix:colon
l_int|0x30000
comma
multiline_comment|/* 192KB */
id|offset
suffix:colon
l_int|0
comma
id|mask_flags
suffix:colon
id|MTD_WRITEABLE
comma
multiline_comment|/* force read-only */
)brace
comma
(brace
id|name
suffix:colon
l_string|&quot;M32700UT kernel&quot;
comma
id|size
suffix:colon
l_int|0xd0000
comma
multiline_comment|/* 832KB */
id|offset
suffix:colon
id|MTDPART_OFS_APPEND
comma
)brace
comma
(brace
id|name
suffix:colon
l_string|&quot;M32700UT root&quot;
comma
id|size
suffix:colon
l_int|0x2f0000
comma
multiline_comment|/* 3008KB */
id|offset
suffix:colon
id|MTDPART_OFS_APPEND
comma
)brace
comma
(brace
id|name
suffix:colon
l_string|&quot;M32700UT params&quot;
comma
id|size
suffix:colon
id|MTDPART_SIZ_FULL
comma
multiline_comment|/* 64KB */
id|offset
suffix:colon
id|MTDPART_OFS_APPEND
comma
)brace
)brace
suffix:semicolon
macro_line|#endif
r_extern
r_int
id|parse_redboot_partitions
c_func
(paren
r_struct
id|mtd_info
op_star
id|master
comma
r_struct
id|mtd_partition
op_star
op_star
id|pparts
)paren
suffix:semicolon
r_extern
r_int
id|parse_bootldr_partitions
c_func
(paren
r_struct
id|mtd_info
op_star
id|master
comma
r_struct
id|mtd_partition
op_star
op_star
id|pparts
)paren
suffix:semicolon
DECL|variable|parsed_parts
r_static
r_struct
id|mtd_partition
op_star
id|parsed_parts
suffix:semicolon
DECL|variable|mymtd
r_static
r_struct
id|mtd_info
op_star
id|mymtd
suffix:semicolon
DECL|function|m32r_mtd_init
r_int
id|__init
id|m32r_mtd_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|mtd_partition
op_star
id|parts
suffix:semicolon
r_int
id|nb_parts
op_assign
l_int|0
comma
id|ret
suffix:semicolon
r_int
id|parsed_nr_parts
op_assign
l_int|0
suffix:semicolon
r_const
r_char
op_star
id|part_type
suffix:semicolon
r_int
r_int
id|base
op_assign
op_minus
l_int|1UL
suffix:semicolon
multiline_comment|/* Default flash buswidth */
id|m32r_map.buswidth
op_assign
l_int|2
suffix:semicolon
multiline_comment|/*&n;&t; * Static partition definition selection&n;&t; */
id|part_type
op_assign
l_string|&quot;static&quot;
suffix:semicolon
macro_line|#ifdef CONFIG_PLAT_M32700UT
id|parts
op_assign
id|m32700ut_partitions
suffix:semicolon
id|nb_parts
op_assign
id|ARRAY_SIZE
c_func
(paren
id|m32700ut_partitions
)paren
suffix:semicolon
id|m32r_map.size
op_assign
id|M32700UT_FLASH_SIZE
suffix:semicolon
id|m32r_map.buswidth
op_assign
l_int|2
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * For simple flash devices, use ioremap to map the flash.&n;&t; */
r_if
c_cond
(paren
id|base
op_ne
(paren
r_int
r_int
)paren
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|base
comma
id|m32r_map.size
comma
l_string|&quot;flash&quot;
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|m32r_map.map_priv_2
op_assign
id|base
suffix:semicolon
id|m32r_map.map_priv_1
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|base
comma
id|m32r_map.size
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|m32r_map.map_priv_1
)paren
r_goto
id|out_err
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Now let&squot;s probe for the actual flash.  Do it here since&n;&t; * specific machine settings might have been set above.&n;&t; */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;M32R flash: probing %d-bit flash bus&bslash;n&quot;
comma
id|m32r_map.buswidth
op_star
l_int|8
)paren
suffix:semicolon
id|mymtd
op_assign
id|do_map_probe
c_func
(paren
l_string|&quot;m5drv&quot;
comma
op_amp
id|m32r_map
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mymtd
)paren
r_goto
id|out_err
suffix:semicolon
id|mymtd-&gt;module
op_assign
id|THIS_MODULE
suffix:semicolon
multiline_comment|/*&n;&t; * Dynamic partition selection stuff (might override the static ones)&n;&t; */
macro_line|#ifdef CONFIG_MTD_REDBOOT_PARTS
r_if
c_cond
(paren
id|parsed_nr_parts
op_eq
l_int|0
)paren
(brace
id|ret
op_assign
id|parse_redboot_partitions
c_func
(paren
id|mymtd
comma
op_amp
id|parsed_parts
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OG
l_int|0
)paren
(brace
id|part_type
op_assign
l_string|&quot;RedBoot&quot;
suffix:semicolon
id|parsed_nr_parts
op_assign
id|ret
suffix:semicolon
)brace
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_MTD_BOOTLDR_PARTS
r_if
c_cond
(paren
id|parsed_nr_parts
op_eq
l_int|0
)paren
(brace
id|ret
op_assign
id|parse_bootldr_partitions
c_func
(paren
id|mymtd
comma
op_amp
id|parsed_parts
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OG
l_int|0
)paren
(brace
id|part_type
op_assign
l_string|&quot;Compaq bootldr&quot;
suffix:semicolon
id|parsed_nr_parts
op_assign
id|ret
suffix:semicolon
)brace
)brace
macro_line|#endif
r_if
c_cond
(paren
id|parsed_nr_parts
OG
l_int|0
)paren
(brace
id|parts
op_assign
id|parsed_parts
suffix:semicolon
id|nb_parts
op_assign
id|parsed_nr_parts
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nb_parts
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;M32R flash: no partition info available, registering whole flash at once&bslash;n&quot;
)paren
suffix:semicolon
id|add_mtd_device
c_func
(paren
id|mymtd
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Using %s partition definition&bslash;n&quot;
comma
id|part_type
)paren
suffix:semicolon
id|add_mtd_partitions
c_func
(paren
id|mymtd
comma
id|parts
comma
id|nb_parts
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|out_err
suffix:colon
r_if
c_cond
(paren
id|m32r_map.map_priv_2
op_ne
op_minus
l_int|1
)paren
(brace
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|m32r_map.map_priv_1
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|m32r_map.map_priv_2
comma
id|m32r_map.size
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|m32r_mtd_cleanup
r_static
r_void
id|__exit
id|m32r_mtd_cleanup
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|mymtd
)paren
(brace
id|del_mtd_partitions
c_func
(paren
id|mymtd
)paren
suffix:semicolon
id|map_destroy
c_func
(paren
id|mymtd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parsed_parts
)paren
id|kfree
c_func
(paren
id|parsed_parts
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|m32r_map.map_priv_2
op_ne
op_minus
l_int|1
)paren
(brace
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|m32r_map.map_priv_1
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|m32r_map.map_priv_2
comma
id|m32r_map.size
)paren
suffix:semicolon
)brace
)brace
DECL|variable|m32r_mtd_init
id|module_init
c_func
(paren
id|m32r_mtd_init
)paren
suffix:semicolon
DECL|variable|m32r_mtd_cleanup
id|module_exit
c_func
(paren
id|m32r_mtd_cleanup
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Takeo Takahashi&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;M32R Flash map driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
