multiline_comment|/*&n; *  linux/arch/m32r/kernel/smp.c&n; *&n; *  M32R SMP support routines.&n; *&n; *  Copyright (c) 2001, 2002  Hitoshi Yamamoto&n; *&n; *  Taken from i386 version.&n; *    (c) 1995 Alan Cox, Building #3 &lt;alan@redhat.com&gt;&n; *    (c) 1998-99, 2000 Ingo Molnar &lt;mingo@redhat.com&gt;&n; *&n; *  This code is released under the GNU General Public License version 2 or&n; *  later.&n; */
DECL|macro|DEBUG_SMP
macro_line|#undef DEBUG_SMP
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/profile.h&gt;
macro_line|#include &lt;linux/cpu.h&gt;
macro_line|#include &lt;asm/cacheflush.h&gt;
macro_line|#include &lt;asm/pgalloc.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/mmu_context.h&gt;
macro_line|#include &lt;asm/m32r.h&gt;
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
multiline_comment|/* Data structures and variables                                             */
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
multiline_comment|/*&n; * Structure and data for smp_call_function(). This is designed to minimise&n; * static memory requirements. It also looks cleaner.&n; */
r_static
id|DEFINE_SPINLOCK
c_func
(paren
id|call_lock
)paren
suffix:semicolon
DECL|struct|call_data_struct
r_struct
id|call_data_struct
(brace
DECL|member|func
r_void
(paren
op_star
id|func
)paren
(paren
r_void
op_star
id|info
)paren
suffix:semicolon
DECL|member|info
r_void
op_star
id|info
suffix:semicolon
DECL|member|started
id|atomic_t
id|started
suffix:semicolon
DECL|member|finished
id|atomic_t
id|finished
suffix:semicolon
DECL|member|wait
r_int
id|wait
suffix:semicolon
)brace
id|__attribute__
(paren
(paren
id|__aligned__
c_func
(paren
id|SMP_CACHE_BYTES
)paren
)paren
)paren
suffix:semicolon
DECL|variable|call_data
r_static
r_struct
id|call_data_struct
op_star
id|call_data
suffix:semicolon
multiline_comment|/*&n; * For flush_cache_all()&n; */
r_static
id|DEFINE_SPINLOCK
c_func
(paren
id|flushcache_lock
)paren
suffix:semicolon
DECL|variable|flushcache_cpumask
r_static
r_volatile
r_int
r_int
id|flushcache_cpumask
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * For flush_tlb_others()&n; */
DECL|variable|flush_cpumask
r_static
r_volatile
id|cpumask_t
id|flush_cpumask
suffix:semicolon
DECL|variable|flush_mm
r_static
r_struct
id|mm_struct
op_star
id|flush_mm
suffix:semicolon
DECL|variable|flush_vma
r_static
r_struct
id|vm_area_struct
op_star
id|flush_vma
suffix:semicolon
DECL|variable|flush_va
r_static
r_volatile
r_int
r_int
id|flush_va
suffix:semicolon
r_static
id|DEFINE_SPINLOCK
c_func
(paren
id|tlbstate_lock
)paren
suffix:semicolon
DECL|macro|FLUSH_ALL
mdefine_line|#define FLUSH_ALL 0xffffffff
id|DECLARE_PER_CPU
c_func
(paren
r_int
comma
id|prof_multiplier
)paren
suffix:semicolon
id|DECLARE_PER_CPU
c_func
(paren
r_int
comma
id|prof_old_multiplier
)paren
suffix:semicolon
id|DECLARE_PER_CPU
c_func
(paren
r_int
comma
id|prof_counter
)paren
suffix:semicolon
r_extern
id|spinlock_t
id|ipi_lock
(braket
)braket
suffix:semicolon
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
multiline_comment|/* Function Prototypes                                                       */
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
r_void
id|smp_send_reschedule
c_func
(paren
r_int
)paren
suffix:semicolon
r_void
id|smp_reschedule_interrupt
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|smp_flush_cache_all
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|smp_flush_cache_all_interrupt
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|smp_flush_tlb_all
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|flush_tlb_all_ipi
c_func
(paren
r_void
op_star
)paren
suffix:semicolon
r_void
id|smp_flush_tlb_mm
c_func
(paren
r_struct
id|mm_struct
op_star
)paren
suffix:semicolon
r_void
id|smp_flush_tlb_range
c_func
(paren
r_struct
id|vm_area_struct
op_star
comma
r_int
r_int
comma
"&bslash;"
r_int
r_int
)paren
suffix:semicolon
r_void
id|smp_flush_tlb_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
comma
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|flush_tlb_others
c_func
(paren
id|cpumask_t
comma
r_struct
id|mm_struct
op_star
comma
r_struct
id|vm_area_struct
op_star
comma
r_int
r_int
)paren
suffix:semicolon
r_void
id|smp_invalidate_interrupt
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|smp_send_stop
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|stop_this_cpu
c_func
(paren
r_void
op_star
)paren
suffix:semicolon
r_int
id|smp_call_function
c_func
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
)paren
comma
r_void
op_star
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_void
id|smp_call_function_interrupt
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|smp_send_timer
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|smp_ipi_timer_interrupt
c_func
(paren
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_void
id|smp_local_timer_interrupt
c_func
(paren
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_void
id|send_IPI_allbutself
c_func
(paren
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|send_IPI_mask
c_func
(paren
id|cpumask_t
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_int
r_int
id|send_IPI_mask_phys
c_func
(paren
id|cpumask_t
comma
r_int
comma
r_int
)paren
suffix:semicolon
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
multiline_comment|/* Rescheduling request Routines                                             */
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
multiline_comment|/*==========================================================================*&n; * Name:         smp_send_reschedule&n; *&n; * Description:  This routine requests other CPU to execute rescheduling.&n; *               1.Send &squot;RESCHEDULE_IPI&squot; to other CPU.&n; *                 Request other CPU to execute &squot;smp_reschedule_interrupt()&squot;.&n; *&n; * Born on Date: 2002.02.05&n; *&n; * Arguments:    cpu_id - Target CPU ID&n; *&n; * Returns:      void (cannot fail)&n; *&n; * Modification log:&n; * Date       Who Description&n; * ---------- --- --------------------------------------------------------&n; *&n; *==========================================================================*/
DECL|function|smp_send_reschedule
r_void
id|smp_send_reschedule
c_func
(paren
r_int
id|cpu_id
)paren
(brace
id|WARN_ON
c_func
(paren
id|cpu_is_offline
c_func
(paren
id|cpu_id
)paren
)paren
suffix:semicolon
id|send_IPI_mask
c_func
(paren
id|cpumask_of_cpu
c_func
(paren
id|cpu_id
)paren
comma
id|RESCHEDULE_IPI
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*&n; * Name:         smp_reschedule_interrupt&n; *&n; * Description:  This routine executes on CPU which received&n; *               &squot;RESCHEDULE_IPI&squot;.&n; *               Rescheduling is processed at the exit of interrupt&n; *               operation.&n; *&n; * Born on Date: 2002.02.05&n; *&n; * Arguments:    NONE&n; *&n; * Returns:      void (cannot fail)&n; *&n; * Modification log:&n; * Date       Who Description&n; * ---------- --- --------------------------------------------------------&n; *&n; *==========================================================================*/
DECL|function|smp_reschedule_interrupt
r_void
id|smp_reschedule_interrupt
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* nothing to do */
)brace
multiline_comment|/*==========================================================================*&n; * Name:         smp_flush_cache_all&n; *&n; * Description:  This routine sends a &squot;INVALIDATE_CACHE_IPI&squot; to all other&n; *               CPUs in the system.&n; *&n; * Born on Date: 2003-05-28&n; *&n; * Arguments:    NONE&n; *&n; * Returns:      void (cannot fail)&n; *&n; * Modification log:&n; * Date       Who Description&n; * ---------- --- --------------------------------------------------------&n; *&n; *==========================================================================*/
DECL|function|smp_flush_cache_all
r_void
id|smp_flush_cache_all
c_func
(paren
r_void
)paren
(brace
id|cpumask_t
id|cpumask
suffix:semicolon
r_int
r_int
op_star
id|mask
suffix:semicolon
id|preempt_disable
c_func
(paren
)paren
suffix:semicolon
id|cpumask
op_assign
id|cpu_online_map
suffix:semicolon
id|cpu_clear
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
id|cpumask
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|flushcache_lock
)paren
suffix:semicolon
id|mask
op_assign
id|cpus_addr
c_func
(paren
id|cpumask
)paren
suffix:semicolon
id|atomic_set_mask
c_func
(paren
op_star
id|mask
comma
(paren
id|atomic_t
op_star
)paren
op_amp
id|flushcache_cpumask
)paren
suffix:semicolon
id|send_IPI_mask
c_func
(paren
id|cpumask
comma
id|INVALIDATE_CACHE_IPI
comma
l_int|0
)paren
suffix:semicolon
id|_flush_cache_copyback_all
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|flushcache_cpumask
)paren
id|mb
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|flushcache_lock
)paren
suffix:semicolon
id|preempt_enable
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|smp_flush_cache_all_interrupt
r_void
id|smp_flush_cache_all_interrupt
c_func
(paren
r_void
)paren
(brace
id|_flush_cache_copyback_all
c_func
(paren
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
op_amp
id|flushcache_cpumask
)paren
suffix:semicolon
)brace
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
multiline_comment|/* TLB flush request Routins                                                 */
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
multiline_comment|/*==========================================================================*&n; * Name:         smp_flush_tlb_all&n; *&n; * Description:  This routine flushes all processes TLBs.&n; *               1.Request other CPU to execute &squot;flush_tlb_all_ipi()&squot;.&n; *               2.Execute &squot;do_flush_tlb_all_local()&squot;.&n; *&n; * Born on Date: 2002.02.05&n; *&n; * Arguments:    NONE&n; *&n; * Returns:      void (cannot fail)&n; *&n; * Modification log:&n; * Date       Who Description&n; * ---------- --- --------------------------------------------------------&n; *&n; *==========================================================================*/
DECL|function|smp_flush_tlb_all
r_void
id|smp_flush_tlb_all
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|preempt_disable
c_func
(paren
)paren
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|__flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
id|smp_call_function
c_func
(paren
id|flush_tlb_all_ipi
comma
l_int|0
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
id|preempt_enable
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*&n; * Name:         flush_tlb_all_ipi&n; *&n; * Description:  This routine flushes all local TLBs.&n; *               1.Execute &squot;do_flush_tlb_all_local()&squot;.&n; *&n; * Born on Date: 2002.02.05&n; *&n; * Arguments:    *info - not used&n; *&n; * Returns:      void (cannot fail)&n; *&n; * Modification log:&n; * Date       Who Description&n; * ---------- --- --------------------------------------------------------&n; *&n; *==========================================================================*/
DECL|function|flush_tlb_all_ipi
r_static
r_void
id|flush_tlb_all_ipi
c_func
(paren
r_void
op_star
id|info
)paren
(brace
id|__flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*&n; * Name:         smp_flush_tlb_mm&n; *&n; * Description:  This routine flushes the specified mm context TLB&squot;s.&n; *&n; * Born on Date: 2002.02.05&n; *&n; * Arguments:    *mm - a pointer to the mm struct for flush TLB&n; *&n; * Returns:      void (cannot fail)&n; *&n; * Modification log:&n; * Date       Who Description&n; * ---------- --- --------------------------------------------------------&n; *&n; *==========================================================================*/
DECL|function|smp_flush_tlb_mm
r_void
id|smp_flush_tlb_mm
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
r_int
id|cpu_id
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
id|cpumask_t
id|cpu_mask
suffix:semicolon
r_int
r_int
op_star
id|mmc
op_assign
op_amp
id|mm-&gt;context
(braket
id|cpu_id
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|preempt_disable
c_func
(paren
)paren
suffix:semicolon
id|cpu_mask
op_assign
id|mm-&gt;cpu_vm_mask
suffix:semicolon
id|cpu_clear
c_func
(paren
id|cpu_id
comma
id|cpu_mask
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|mmc
op_ne
id|NO_CONTEXT
)paren
(brace
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
op_star
id|mmc
op_assign
id|NO_CONTEXT
suffix:semicolon
r_if
c_cond
(paren
id|mm
op_eq
id|current-&gt;mm
)paren
id|activate_context
c_func
(paren
id|mm
)paren
suffix:semicolon
r_else
id|cpu_clear
c_func
(paren
id|cpu_id
comma
id|mm-&gt;cpu_vm_mask
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|cpus_empty
c_func
(paren
id|cpu_mask
)paren
)paren
id|flush_tlb_others
c_func
(paren
id|cpu_mask
comma
id|mm
comma
l_int|NULL
comma
id|FLUSH_ALL
)paren
suffix:semicolon
id|preempt_enable
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*&n; * Name:         smp_flush_tlb_range&n; *&n; * Description:  This routine flushes a range of pages.&n; *&n; * Born on Date: 2002.02.05&n; *&n; * Arguments:    *mm - a pointer to the mm struct for flush TLB&n; *               start - not used&n; *               end - not used&n; *&n; * Returns:      void (cannot fail)&n; *&n; * Modification log:&n; * Date       Who Description&n; * ---------- --- --------------------------------------------------------&n; *&n; *==========================================================================*/
DECL|function|smp_flush_tlb_range
r_void
id|smp_flush_tlb_range
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
id|smp_flush_tlb_mm
c_func
(paren
id|vma-&gt;vm_mm
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*&n; * Name:         smp_flush_tlb_page&n; *&n; * Description:  This routine flushes one page.&n; *&n; * Born on Date: 2002.02.05&n; *&n; * Arguments:    *vma - a pointer to the vma struct include va&n; *               va - virtual address for flush TLB&n; *&n; * Returns:      void (cannot fail)&n; *&n; * Modification log:&n; * Date       Who Description&n; * ---------- --- --------------------------------------------------------&n; *&n; *==========================================================================*/
DECL|function|smp_flush_tlb_page
r_void
id|smp_flush_tlb_page
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|va
)paren
(brace
r_struct
id|mm_struct
op_star
id|mm
op_assign
id|vma-&gt;vm_mm
suffix:semicolon
r_int
id|cpu_id
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
id|cpumask_t
id|cpu_mask
suffix:semicolon
r_int
r_int
op_star
id|mmc
op_assign
op_amp
id|mm-&gt;context
(braket
id|cpu_id
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|preempt_disable
c_func
(paren
)paren
suffix:semicolon
id|cpu_mask
op_assign
id|mm-&gt;cpu_vm_mask
suffix:semicolon
id|cpu_clear
c_func
(paren
id|cpu_id
comma
id|cpu_mask
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_SMP
r_if
c_cond
(paren
op_logical_neg
id|mm
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_star
id|mmc
op_ne
id|NO_CONTEXT
)paren
(brace
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|va
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|va
op_or_assign
(paren
op_star
id|mmc
op_amp
id|MMU_CONTEXT_ASID_MASK
)paren
suffix:semicolon
id|__flush_tlb_page
c_func
(paren
id|va
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|cpus_empty
c_func
(paren
id|cpu_mask
)paren
)paren
id|flush_tlb_others
c_func
(paren
id|cpu_mask
comma
id|mm
comma
id|vma
comma
id|va
)paren
suffix:semicolon
id|preempt_enable
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*&n; * Name:         flush_tlb_others&n; *&n; * Description:  This routine requests other CPU to execute flush TLB.&n; *               1.Setup parmeters.&n; *               2.Send &squot;INVALIDATE_TLB_IPI&squot; to other CPU.&n; *                 Request other CPU to execute &squot;smp_invalidate_interrupt()&squot;.&n; *               3.Wait for other CPUs operation finished.&n; *&n; * Born on Date: 2002.02.05&n; *&n; * Arguments:    cpumask - bitmap of target CPUs&n; *               *mm -  a pointer to the mm struct for flush TLB&n; *               *vma -  a pointer to the vma struct include va&n; *               va - virtual address for flush TLB&n; *&n; * Returns:      void (cannot fail)&n; *&n; * Modification log:&n; * Date       Who Description&n; * ---------- --- --------------------------------------------------------&n; *&n; *==========================================================================*/
DECL|function|flush_tlb_others
r_static
r_void
id|flush_tlb_others
c_func
(paren
id|cpumask_t
id|cpumask
comma
r_struct
id|mm_struct
op_star
id|mm
comma
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|va
)paren
(brace
r_int
r_int
op_star
id|mask
suffix:semicolon
macro_line|#ifdef DEBUG_SMP
r_int
r_int
id|flags
suffix:semicolon
id|__save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
l_int|0x0040
)paren
)paren
multiline_comment|/* Interrupt Disable NONONO */
id|BUG
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif /* DEBUG_SMP */
multiline_comment|/*&n;&t; * A couple of (to be removed) sanity checks:&n;&t; *&n;&t; * - we do not send IPIs to not-yet booted CPUs.&n;&t; * - current CPU must not be in mask&n;&t; * - mask must exist :)&n;&t; */
id|BUG_ON
c_func
(paren
id|cpus_empty
c_func
(paren
id|cpumask
)paren
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|cpu_isset
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
id|cpumask
)paren
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
id|mm
)paren
suffix:semicolon
multiline_comment|/* If a CPU which we ran on has gone down, OK. */
id|cpus_and
c_func
(paren
id|cpumask
comma
id|cpumask
comma
id|cpu_online_map
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpus_empty
c_func
(paren
id|cpumask
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * i&squot;m not happy about this global shared spinlock in the&n;&t; * MM hot path, but we&squot;ll see how contended it is.&n;&t; * Temporarily this turns IRQs off, so that lockups are&n;&t; * detected by the NMI watchdog.&n;&t; */
id|spin_lock
c_func
(paren
op_amp
id|tlbstate_lock
)paren
suffix:semicolon
id|flush_mm
op_assign
id|mm
suffix:semicolon
id|flush_vma
op_assign
id|vma
suffix:semicolon
id|flush_va
op_assign
id|va
suffix:semicolon
id|mask
op_assign
id|cpus_addr
c_func
(paren
id|cpumask
)paren
suffix:semicolon
id|atomic_set_mask
c_func
(paren
op_star
id|mask
comma
(paren
id|atomic_t
op_star
)paren
op_amp
id|flush_cpumask
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We have to send the IPI only to&n;&t; * CPUs affected.&n;&t; */
id|send_IPI_mask
c_func
(paren
id|cpumask
comma
id|INVALIDATE_TLB_IPI
comma
l_int|0
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|cpus_empty
c_func
(paren
id|flush_cpumask
)paren
)paren
(brace
multiline_comment|/* nothing. lockup detection does not belong here */
id|mb
c_func
(paren
)paren
suffix:semicolon
)brace
id|flush_mm
op_assign
l_int|NULL
suffix:semicolon
id|flush_vma
op_assign
l_int|NULL
suffix:semicolon
id|flush_va
op_assign
l_int|0
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|tlbstate_lock
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*&n; * Name:         smp_invalidate_interrupt&n; *&n; * Description:  This routine executes on CPU which received&n; *               &squot;INVALIDATE_TLB_IPI&squot;.&n; *               1.Flush local TLB.&n; *               2.Report flush TLB process was finished.&n; *&n; * Born on Date: 2002.02.05&n; *&n; * Arguments:    NONE&n; *&n; * Returns:      void (cannot fail)&n; *&n; * Modification log:&n; * Date       Who Description&n; * ---------- --- --------------------------------------------------------&n; *&n; *==========================================================================*/
DECL|function|smp_invalidate_interrupt
r_void
id|smp_invalidate_interrupt
c_func
(paren
r_void
)paren
(brace
r_int
id|cpu_id
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_int
r_int
op_star
id|mmc
op_assign
op_amp
id|flush_mm-&gt;context
(braket
id|cpu_id
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpu_isset
c_func
(paren
id|cpu_id
comma
id|flush_cpumask
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|flush_va
op_eq
id|FLUSH_ALL
)paren
(brace
op_star
id|mmc
op_assign
id|NO_CONTEXT
suffix:semicolon
r_if
c_cond
(paren
id|flush_mm
op_eq
id|current-&gt;active_mm
)paren
id|activate_context
c_func
(paren
id|flush_mm
)paren
suffix:semicolon
r_else
id|cpu_clear
c_func
(paren
id|cpu_id
comma
id|flush_mm-&gt;cpu_vm_mask
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|va
op_assign
id|flush_va
suffix:semicolon
r_if
c_cond
(paren
op_star
id|mmc
op_ne
id|NO_CONTEXT
)paren
(brace
id|va
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|va
op_or_assign
(paren
op_star
id|mmc
op_amp
id|MMU_CONTEXT_ASID_MASK
)paren
suffix:semicolon
id|__flush_tlb_page
c_func
(paren
id|va
)paren
suffix:semicolon
)brace
)brace
id|cpu_clear
c_func
(paren
id|cpu_id
comma
id|flush_cpumask
)paren
suffix:semicolon
)brace
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
multiline_comment|/* Stop CPU request Routins                                                 */
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
multiline_comment|/*==========================================================================*&n; * Name:         smp_send_stop&n; *&n; * Description:  This routine requests stop all CPUs.&n; *               1.Request other CPU to execute &squot;stop_this_cpu()&squot;.&n; *&n; * Born on Date: 2002.02.05&n; *&n; * Arguments:    NONE&n; *&n; * Returns:      void (cannot fail)&n; *&n; * Modification log:&n; * Date       Who Description&n; * ---------- --- --------------------------------------------------------&n; *&n; *==========================================================================*/
DECL|function|smp_send_stop
r_void
id|smp_send_stop
c_func
(paren
r_void
)paren
(brace
id|smp_call_function
c_func
(paren
id|stop_this_cpu
comma
l_int|NULL
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*&n; * Name:         stop_this_cpu&n; *&n; * Description:  This routine halt CPU.&n; *&n; * Born on Date: 2002.02.05&n; *&n; * Arguments:    NONE&n; *&n; * Returns:      void (cannot fail)&n; *&n; * Modification log:&n; * Date       Who Description&n; * ---------- --- --------------------------------------------------------&n; *&n; *==========================================================================*/
DECL|function|stop_this_cpu
r_static
r_void
id|stop_this_cpu
c_func
(paren
r_void
op_star
id|dummy
)paren
(brace
r_int
id|cpu_id
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Remove this CPU:&n;&t; */
id|cpu_clear
c_func
(paren
id|cpu_id
comma
id|cpu_online_map
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * PSW IE = 1;&n;&t; * IMASK = 0;&n;&t; * goto SLEEP&n;&t; */
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0
comma
id|M32R_ICU_IMASK_PORTL
)paren
suffix:semicolon
id|inl
c_func
(paren
id|M32R_ICU_IMASK_PORTL
)paren
suffix:semicolon
multiline_comment|/* dummy read */
id|local_irq_enable
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
suffix:semicolon
)brace
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
multiline_comment|/* Call function Routins                                                     */
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
multiline_comment|/*==========================================================================*&n; * Name:         smp_call_function&n; *&n; * Description:  This routine sends a &squot;CALL_FUNCTION_IPI&squot; to all other CPUs&n; *               in the system.&n; *&n; * Born on Date: 2002.02.05&n; *&n; * Arguments:    *func - The function to run. This must be fast and&n; *                       non-blocking.&n; *               *info - An arbitrary pointer to pass to the function.&n; *               nonatomic - currently unused.&n; *               wait - If true, wait (atomically) until function has&n; *                      completed on other CPUs.&n; *&n; * Returns:      0 on success, else a negative status code. Does not return&n; *               until remote CPUs are nearly ready to execute &lt;&lt;func&gt;&gt; or&n; *               are or have executed.&n; *&n; * Cautions:     You must not call this function with disabled interrupts or&n; *               from a hardware interrupt handler, you may call it from a&n; *               bottom half handler.&n; *&n; * Modification log:&n; * Date       Who Description&n; * ---------- --- --------------------------------------------------------&n; *&n; *==========================================================================*/
DECL|function|smp_call_function
r_int
id|smp_call_function
c_func
(paren
r_void
(paren
op_star
id|func
)paren
(paren
r_void
op_star
id|info
)paren
comma
r_void
op_star
id|info
comma
r_int
id|nonatomic
comma
r_int
id|wait
)paren
(brace
r_struct
id|call_data_struct
id|data
suffix:semicolon
r_int
id|cpus
suffix:semicolon
macro_line|#ifdef DEBUG_SMP
r_int
r_int
id|flags
suffix:semicolon
id|__save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
l_int|0x0040
)paren
)paren
multiline_comment|/* Interrupt Disable NONONO */
id|BUG
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif /* DEBUG_SMP */
multiline_comment|/* Holding any lock stops cpus from going down. */
id|spin_lock
c_func
(paren
op_amp
id|call_lock
)paren
suffix:semicolon
id|cpus
op_assign
id|num_online_cpus
c_func
(paren
)paren
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpus
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|call_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Can deadlock when called with interrupts disabled */
id|WARN_ON
c_func
(paren
id|irqs_disabled
c_func
(paren
)paren
)paren
suffix:semicolon
id|data.func
op_assign
id|func
suffix:semicolon
id|data.info
op_assign
id|info
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|data.started
comma
l_int|0
)paren
suffix:semicolon
id|data.wait
op_assign
id|wait
suffix:semicolon
r_if
c_cond
(paren
id|wait
)paren
id|atomic_set
c_func
(paren
op_amp
id|data.finished
comma
l_int|0
)paren
suffix:semicolon
id|call_data
op_assign
op_amp
id|data
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Send a message to all other CPUs and wait for them to respond */
id|send_IPI_allbutself
c_func
(paren
id|CALL_FUNCTION_IPI
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Wait for response */
r_while
c_loop
(paren
id|atomic_read
c_func
(paren
op_amp
id|data.started
)paren
op_ne
id|cpus
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait
)paren
r_while
c_loop
(paren
id|atomic_read
c_func
(paren
op_amp
id|data.finished
)paren
op_ne
id|cpus
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|call_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*&n; * Name:         smp_call_function_interrupt&n; *&n; * Description:  This routine executes on CPU which received&n; *               &squot;CALL_FUNCTION_IPI&squot;.&n; *&n; * Born on Date: 2002.02.05&n; *&n; * Arguments:    NONE&n; *&n; * Returns:      void (cannot fail)&n; *&n; * Modification log:&n; * Date       Who Description&n; * ---------- --- --------------------------------------------------------&n; *&n; *==========================================================================*/
DECL|function|smp_call_function_interrupt
r_void
id|smp_call_function_interrupt
c_func
(paren
r_void
)paren
(brace
r_void
(paren
op_star
id|func
)paren
(paren
r_void
op_star
id|info
)paren
op_assign
id|call_data-&gt;func
suffix:semicolon
r_void
op_star
id|info
op_assign
id|call_data-&gt;info
suffix:semicolon
r_int
id|wait
op_assign
id|call_data-&gt;wait
suffix:semicolon
multiline_comment|/*&n;&t; * Notify initiating CPU that I&squot;ve grabbed the data and am&n;&t; * about to execute the function&n;&t; */
id|mb
c_func
(paren
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|call_data-&gt;started
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * At this point the info structure may be out of scope unless wait==1&n;&t; */
id|irq_enter
c_func
(paren
)paren
suffix:semicolon
(paren
op_star
id|func
)paren
(paren
id|info
)paren
suffix:semicolon
id|irq_exit
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait
)paren
(brace
id|mb
c_func
(paren
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|call_data-&gt;finished
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
multiline_comment|/* Timer Routins                                                             */
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
multiline_comment|/*==========================================================================*&n; * Name:         smp_send_timer&n; *&n; * Description:  This routine sends a &squot;LOCAL_TIMER_IPI&squot; to all other CPUs&n; *               in the system.&n; *&n; * Born on Date: 2002.02.05&n; *&n; * Arguments:    NONE&n; *&n; * Returns:      void (cannot fail)&n; *&n; * Modification log:&n; * Date       Who Description&n; * ---------- --- --------------------------------------------------------&n; *&n; *==========================================================================*/
DECL|function|smp_send_timer
r_void
id|smp_send_timer
c_func
(paren
r_void
)paren
(brace
id|send_IPI_allbutself
c_func
(paren
id|LOCAL_TIMER_IPI
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*&n; * Name:         smp_send_timer&n; *&n; * Description:  This routine executes on CPU which received&n; *               &squot;LOCAL_TIMER_IPI&squot;.&n; *&n; * Born on Date: 2002.02.05&n; *&n; * Arguments:    *regs - a pointer to the saved regster info&n; *&n; * Returns:      void (cannot fail)&n; *&n; * Modification log:&n; * Date       Who Description&n; * ---------- --- --------------------------------------------------------&n; *&n; *==========================================================================*/
DECL|function|smp_ipi_timer_interrupt
r_void
id|smp_ipi_timer_interrupt
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|irq_enter
c_func
(paren
)paren
suffix:semicolon
id|smp_local_timer_interrupt
c_func
(paren
id|regs
)paren
suffix:semicolon
id|irq_exit
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*&n; * Name:         smp_local_timer_interrupt&n; *&n; * Description:  Local timer interrupt handler. It does both profiling and&n; *               process statistics/rescheduling.&n; *               We do profiling in every local tick, statistics/rescheduling&n; *               happen only every &squot;profiling multiplier&squot; ticks. The default&n; *               multiplier is 1 and it can be changed by writing the new&n; *               multiplier value into /proc/profile.&n; *&n; * Born on Date: 2002.02.05&n; *&n; * Arguments:    *regs - a pointer to the saved regster info&n; *&n; * Returns:      void (cannot fail)&n; *&n; * Original:     arch/i386/kernel/apic.c&n; *&n; * Modification log:&n; * Date       Who Description&n; * ---------- --- --------------------------------------------------------&n; * 2003-06-24 hy  use per_cpu structure.&n; *==========================================================================*/
DECL|function|smp_local_timer_interrupt
r_void
id|smp_local_timer_interrupt
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|user
op_assign
id|user_mode
c_func
(paren
id|regs
)paren
suffix:semicolon
r_int
id|cpu_id
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * The profiling function is SMP safe. (nothing can mess&n;&t; * around with &quot;current&quot;, and the profiling counters are&n;&t; * updated with atomic operations). This is especially&n;&t; * useful with a profiling multiplier != 1&n;&t; */
id|profile_tick
c_func
(paren
id|CPU_PROFILING
comma
id|regs
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|per_cpu
c_func
(paren
id|prof_counter
comma
id|cpu_id
)paren
op_le
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t; * The multiplier may have changed since the last time we got&n;&t;&t; * to this point as a result of the user writing to&n;&t;&t; * /proc/profile. In this case we need to adjust the APIC&n;&t;&t; * timer accordingly.&n;&t;&t; *&n;&t;&t; * Interrupts are already masked off at this point.&n;&t;&t; */
id|per_cpu
c_func
(paren
id|prof_counter
comma
id|cpu_id
)paren
op_assign
id|per_cpu
c_func
(paren
id|prof_multiplier
comma
id|cpu_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|per_cpu
c_func
(paren
id|prof_counter
comma
id|cpu_id
)paren
op_ne
id|per_cpu
c_func
(paren
id|prof_old_multiplier
comma
id|cpu_id
)paren
)paren
(brace
id|per_cpu
c_func
(paren
id|prof_old_multiplier
comma
id|cpu_id
)paren
op_assign
id|per_cpu
c_func
(paren
id|prof_counter
comma
id|cpu_id
)paren
suffix:semicolon
)brace
id|update_process_times
c_func
(paren
id|user
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
multiline_comment|/* Send IPI Routins                                                          */
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
multiline_comment|/*==========================================================================*&n; * Name:         send_IPI_allbutself&n; *&n; * Description:  This routine sends a IPI to all other CPUs in the system.&n; *&n; * Born on Date: 2002.02.05&n; *&n; * Arguments:    ipi_num - Number of IPI&n; *               try -  0 : Send IPI certainly.&n; *                     !0 : The following IPI is not sended when Target CPU&n; *                          has not received the before IPI.&n; *&n; * Returns:      void (cannot fail)&n; *&n; * Modification log:&n; * Date       Who Description&n; * ---------- --- --------------------------------------------------------&n; *&n; *==========================================================================*/
DECL|function|send_IPI_allbutself
r_void
id|send_IPI_allbutself
c_func
(paren
r_int
id|ipi_num
comma
r_int
r_try
)paren
(brace
id|cpumask_t
id|cpumask
suffix:semicolon
id|cpumask
op_assign
id|cpu_online_map
suffix:semicolon
id|cpu_clear
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
id|cpumask
)paren
suffix:semicolon
id|send_IPI_mask
c_func
(paren
id|cpumask
comma
id|ipi_num
comma
r_try
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*&n; * Name:         send_IPI_mask&n; *&n; * Description:  This routine sends a IPI to CPUs in the system.&n; *&n; * Born on Date: 2002.02.05&n; *&n; * Arguments:    cpu_mask - Bitmap of target CPUs logical ID&n; *               ipi_num - Number of IPI&n; *               try -  0 : Send IPI certainly.&n; *                     !0 : The following IPI is not sended when Target CPU&n; *                          has not received the before IPI.&n; *&n; * Returns:      void (cannot fail)&n; *&n; * Modification log:&n; * Date       Who Description&n; * ---------- --- --------------------------------------------------------&n; *&n; *==========================================================================*/
DECL|function|send_IPI_mask
r_static
r_void
id|send_IPI_mask
c_func
(paren
id|cpumask_t
id|cpumask
comma
r_int
id|ipi_num
comma
r_int
r_try
)paren
(brace
id|cpumask_t
id|physid_mask
comma
id|tmp
suffix:semicolon
r_int
id|cpu_id
comma
id|phys_id
suffix:semicolon
r_int
id|num_cpus
op_assign
id|num_online_cpus
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_cpus
op_le
l_int|1
)paren
multiline_comment|/* NO MP */
r_return
suffix:semicolon
id|cpus_and
c_func
(paren
id|tmp
comma
id|cpumask
comma
id|cpu_online_map
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
id|cpus_equal
c_func
(paren
id|cpumask
comma
id|tmp
)paren
)paren
suffix:semicolon
id|physid_mask
op_assign
id|CPU_MASK_NONE
suffix:semicolon
(def_block
id|for_each_cpu_mask
c_func
(paren
id|cpu_id
comma
id|cpumask
)paren
(brace
r_if
c_cond
(paren
(paren
id|phys_id
op_assign
id|cpu_to_physid
c_func
(paren
id|cpu_id
)paren
)paren
op_ne
op_minus
l_int|1
)paren
id|cpu_set
c_func
(paren
id|phys_id
comma
id|physid_mask
)paren
suffix:semicolon
)brace
)def_block
id|send_IPI_mask_phys
c_func
(paren
id|physid_mask
comma
id|ipi_num
comma
r_try
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*&n; * Name:         send_IPI_mask_phys&n; *&n; * Description:  This routine sends a IPI to other CPUs in the system.&n; *&n; * Born on Date: 2002.02.05&n; *&n; * Arguments:    cpu_mask - Bitmap of target CPUs physical ID&n; *               ipi_num - Number of IPI&n; *               try -  0 : Send IPI certainly.&n; *                     !0 : The following IPI is not sended when Target CPU&n; *                          has not received the before IPI.&n; *&n; * Returns:      IPICRi regster value.&n; *&n; * Modification log:&n; * Date       Who Description&n; * ---------- --- --------------------------------------------------------&n; *&n; *==========================================================================*/
DECL|function|send_IPI_mask_phys
r_int
r_int
id|send_IPI_mask_phys
c_func
(paren
id|cpumask_t
id|physid_mask
comma
r_int
id|ipi_num
comma
r_int
r_try
)paren
(brace
id|spinlock_t
op_star
id|ipilock
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
r_volatile
r_int
r_int
op_star
id|ipicr_addr
suffix:semicolon
r_int
r_int
id|ipicr_val
suffix:semicolon
r_int
r_int
id|my_physid_mask
suffix:semicolon
r_int
r_int
id|mask
op_assign
id|cpus_addr
c_func
(paren
id|physid_mask
)paren
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_amp
op_complement
id|physids_coerce
c_func
(paren
id|phys_cpu_present_map
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ipi_num
op_ge
id|NR_IPIS
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|mask
op_lshift_assign
id|IPI_SHIFT
suffix:semicolon
id|ipilock
op_assign
op_amp
id|ipi_lock
(braket
id|ipi_num
)braket
suffix:semicolon
id|ipicr_addr
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
(paren
id|M32R_ICU_IPICR_ADDR
op_plus
(paren
id|ipi_num
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
id|my_physid_mask
op_assign
op_complement
(paren
l_int|1
op_lshift
id|smp_processor_id
c_func
(paren
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * lock ipi_lock[i]&n;&t; * check IPICRi == 0&n;&t; * write IPICRi (send IPIi)&n;&t; * unlock ipi_lock[i]&n;&t; */
id|__asm__
id|__volatile__
(paren
l_string|&quot;;; LOCK ipi_lock[i]&t;&t;&bslash;n&bslash;t&quot;
l_string|&quot;.fillinsn&t;&t;&t;&bslash;n&quot;
l_string|&quot;1:&t;&t;&t;&t;&bslash;n&bslash;t&quot;
l_string|&quot;mvfc&t;%1, psw &t;&t;&bslash;n&bslash;t&quot;
l_string|&quot;clrpsw&t;#0x40 -&gt; nop&t;&t;&bslash;n&bslash;t&quot;
id|DCACHE_CLEAR
c_func
(paren
l_string|&quot;r4&quot;
comma
l_string|&quot;r5&quot;
comma
l_string|&quot;%2&quot;
)paren
l_string|&quot;lock&t;r4, @%2&t;&t;&t;&bslash;n&bslash;t&quot;
l_string|&quot;addi&t;r4, #-1&t;&t;&t;&bslash;n&bslash;t&quot;
l_string|&quot;unlock&t;r4, @%2&t;&t;&t;&bslash;n&bslash;t&quot;
l_string|&quot;mvtc&t;%1, psw&t;&t;&t;&bslash;n&bslash;t&quot;
l_string|&quot;bnez&t;r4, 2f&t;&t;&t;&bslash;n&bslash;t&quot;
id|LOCK_SECTION_START
c_func
(paren
l_string|&quot;.balign 4 &bslash;n&bslash;t&quot;
)paren
l_string|&quot;.fillinsn&t;&t;&t;&bslash;n&quot;
l_string|&quot;2:&t;&t;&t;&t;&bslash;n&bslash;t&quot;
l_string|&quot;ld&t;r4, @%2&t;&t;&t;&bslash;n&bslash;t&quot;
l_string|&quot;blez&t;r4, 2b&t;&t;&t;&bslash;n&bslash;t&quot;
l_string|&quot;bra&t;1b&t;&t;&t;&bslash;n&bslash;t&quot;
id|LOCK_SECTION_END
l_string|&quot;;; CHECK IPICRi == 0&t;&t;&bslash;n&bslash;t&quot;
l_string|&quot;.fillinsn&t;&t;&t;&bslash;n&quot;
l_string|&quot;3:&t;&t;&t;&t;&bslash;n&bslash;t&quot;
l_string|&quot;ld&t;%0, @%3&t;&t;&t;&bslash;n&bslash;t&quot;
l_string|&quot;and&t;%0, %6&t;&t;&t;&bslash;n&bslash;t&quot;
l_string|&quot;beqz&t;%0, 4f&t;&t;&t;&bslash;n&bslash;t&quot;
l_string|&quot;bnez&t;%5, 5f&t;&t;&t;&bslash;n&bslash;t&quot;
l_string|&quot;bra&t;3b&t;&t;&t;&bslash;n&bslash;t&quot;
l_string|&quot;;; WRITE IPICRi (send IPIi)&t;&bslash;n&bslash;t&quot;
l_string|&quot;.fillinsn&t;&t;&t;&bslash;n&quot;
l_string|&quot;4:&t;&t;&t;&t;&bslash;n&bslash;t&quot;
l_string|&quot;st&t;%4, @%3&t;&t;&t;&bslash;n&bslash;t&quot;
l_string|&quot;;; UNLOCK ipi_lock[i]&t;&t;&bslash;n&bslash;t&quot;
l_string|&quot;.fillinsn&t;&t;&t;&bslash;n&quot;
l_string|&quot;5:&t;&t;&t;&t;&bslash;n&bslash;t&quot;
l_string|&quot;ldi&t;r4, #1&t;&t;&t;&bslash;n&bslash;t&quot;
l_string|&quot;st&t;r4, @%2&t;&t;&t;&bslash;n&bslash;t&quot;
suffix:colon
l_string|&quot;=&amp;r&quot;
(paren
id|ipicr_val
)paren
suffix:colon
l_string|&quot;r&quot;
(paren
id|flags
)paren
comma
l_string|&quot;r&quot;
(paren
op_amp
id|ipilock-&gt;slock
)paren
comma
l_string|&quot;r&quot;
(paren
id|ipicr_addr
)paren
comma
l_string|&quot;r&quot;
(paren
id|mask
)paren
comma
l_string|&quot;r&quot;
(paren
r_try
)paren
comma
l_string|&quot;r&quot;
(paren
id|my_physid_mask
)paren
suffix:colon
l_string|&quot;memory&quot;
comma
l_string|&quot;r4&quot;
macro_line|#ifdef CONFIG_CHIP_M32700_TS1
comma
l_string|&quot;r5&quot;
macro_line|#endif&t;/* CONFIG_CHIP_M32700_TS1 */
)paren
suffix:semicolon
r_return
id|ipicr_val
suffix:semicolon
)brace
eof
