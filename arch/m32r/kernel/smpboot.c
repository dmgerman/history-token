multiline_comment|/*&n; *  linux/arch/m32r/kernel/smpboot.c&n; *    orig : i386 2.4.10&n; *&n; *  M32R SMP booting functions&n; *&n; *  Copyright (c) 2001, 2002, 2003  Hitoshi Yamamoto&n; *&n; *  Taken from i386 version.&n; *&t;  (c) 1995 Alan Cox, Building #3 &lt;alan@redhat.com&gt;&n; *&t;  (c) 1998, 1999, 2000 Ingo Molnar &lt;mingo@redhat.com&gt;&n; *&n; *&t;Much of the core SMP work is based on previous work by Thomas Radke, to&n; *&t;whom a great many thanks are extended.&n; *&n; *&t;Thanks to Intel for making available several different Pentium,&n; *&t;Pentium Pro and Pentium-II/Xeon MP machines.&n; *&t;Original development of Linux SMP code supported by Caldera.&n; *&n; *&t;This code is released under the GNU General Public License version 2 or&n; *&t;later.&n; *&n; *&t;Fixes&n; *&t;&t;Felix Koop&t;:&t;NR_CPUS used properly&n; *&t;&t;Jose Renau&t;:&t;Handle single CPU case.&n; *&t;&t;Alan Cox&t;:&t;By repeated request&n; *&t;&t;&t;&t;&t;8) - Total BogoMIP report.&n; *&t;&t;Greg Wright&t;:&t;Fix for kernel stacks panic.&n; *&t;&t;Erich Boleyn&t;:&t;MP v1.4 and additional changes.&n; *&t;Matthias Sattler&t;:&t;Changes for 2.1 kernel map.&n; *&t;Michel Lespinasse&t;:&t;Changes for 2.1 kernel map.&n; *&t;Michael Chastain&t;:&t;Change trampoline.S to gnu as.&n; *&t;&t;Alan Cox&t;:&t;Dumb bug: &squot;B&squot; step PPro&squot;s are fine&n; *&t;&t;Ingo Molnar&t;:&t;Added APIC timers, based on code&n; *&t;&t;&t;&t;&t;from Jose Renau&n; *&t;&t;Ingo Molnar&t;:&t;various cleanups and rewrites&n; *&t;&t;Tigran Aivazian&t;:&t;fixed &quot;0.00 in /proc/uptime on SMP&quot; bug.&n; *&t;Maciej W. Rozycki&t;:&t;Bits for genuine 82489DX APICs&n; *&t;&t;Martin J. Bligh&t;: &t;Added support for multi-quad systems&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgalloc.h&gt;
macro_line|#include &lt;asm/tlbflush.h&gt;
DECL|macro|DEBUG_SMP
mdefine_line|#define DEBUG_SMP
macro_line|#ifdef DEBUG_SMP
DECL|macro|Dprintk
mdefine_line|#define Dprintk(x...) printk(x)
macro_line|#else
DECL|macro|Dprintk
mdefine_line|#define Dprintk(x...)
macro_line|#endif
r_extern
id|cpumask_t
id|cpu_initialized
suffix:semicolon
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
multiline_comment|/* Data structures and variables                                             */
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
multiline_comment|/* Processor that is doing the boot up */
DECL|variable|bsp_phys_id
r_static
r_int
r_int
id|bsp_phys_id
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Bitmask of physically existing CPUs */
DECL|variable|phys_cpu_present_map
id|physid_mask_t
id|phys_cpu_present_map
suffix:semicolon
multiline_comment|/* Bitmask of currently online CPUs */
DECL|variable|cpu_online_map
id|cpumask_t
id|cpu_online_map
suffix:semicolon
DECL|variable|cpu_bootout_map
id|cpumask_t
id|cpu_bootout_map
suffix:semicolon
DECL|variable|cpu_bootin_map
id|cpumask_t
id|cpu_bootin_map
suffix:semicolon
DECL|variable|cpu_callout_map
id|cpumask_t
id|cpu_callout_map
suffix:semicolon
DECL|variable|cpu_callin_map
r_static
id|cpumask_t
id|cpu_callin_map
suffix:semicolon
multiline_comment|/* Per CPU bogomips and other parameters */
DECL|variable|__cacheline_aligned
r_struct
id|cpuinfo_m32r
id|cpu_data
(braket
id|NR_CPUS
)braket
id|__cacheline_aligned
suffix:semicolon
DECL|variable|cpucount
r_static
r_int
id|cpucount
suffix:semicolon
DECL|variable|smp_commenced_mask
r_static
id|cpumask_t
id|smp_commenced_mask
suffix:semicolon
r_extern
r_struct
(brace
DECL|member|spi
r_void
op_star
id|spi
suffix:semicolon
DECL|member|ss
r_int
r_int
id|ss
suffix:semicolon
)brace
id|stack_start
suffix:semicolon
multiline_comment|/* which physical physical ID maps to which logical CPU number */
DECL|variable|physid_2_cpu
r_static
r_volatile
r_int
id|physid_2_cpu
(braket
id|NR_CPUS
)braket
suffix:semicolon
multiline_comment|/* which logical CPU number maps to which physical ID */
DECL|variable|cpu_2_physid
r_volatile
r_int
id|cpu_2_physid
(braket
id|NR_CPUS
)braket
suffix:semicolon
id|DEFINE_PER_CPU
c_func
(paren
r_int
comma
id|prof_multiplier
)paren
op_assign
l_int|1
suffix:semicolon
id|DEFINE_PER_CPU
c_func
(paren
r_int
comma
id|prof_old_multiplier
)paren
op_assign
l_int|1
suffix:semicolon
id|DEFINE_PER_CPU
c_func
(paren
r_int
comma
id|prof_counter
)paren
op_assign
l_int|1
suffix:semicolon
DECL|variable|ipi_lock
id|spinlock_t
id|ipi_lock
(braket
id|NR_IPIS
)braket
suffix:semicolon
DECL|variable|calibration_result
r_static
r_int
r_int
id|calibration_result
suffix:semicolon
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
multiline_comment|/* Function Prototypes                                                       */
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
r_void
id|smp_prepare_boot_cpu
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|smp_prepare_cpus
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|smp_tune_scheduling
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|init_ipi_lock
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|do_boot_cpu
c_func
(paren
r_int
)paren
suffix:semicolon
r_int
id|__cpu_up
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_void
id|smp_cpus_done
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_int
id|start_secondary
c_func
(paren
r_void
op_star
)paren
suffix:semicolon
r_static
r_void
id|smp_callin
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|smp_online
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|show_mp_info
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_void
id|smp_store_cpu_info
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_void
id|show_cpu_info
c_func
(paren
r_int
)paren
suffix:semicolon
r_int
id|setup_profiling_timer
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|init_cpu_to_physid
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|map_cpu_to_physid
c_func
(paren
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|unmap_cpu_to_physid
c_func
(paren
r_int
comma
r_int
)paren
suffix:semicolon
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
multiline_comment|/* Boot up APs Routins : BSP                                                 */
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
DECL|function|smp_prepare_boot_cpu
r_void
id|__devinit
id|smp_prepare_boot_cpu
c_func
(paren
r_void
)paren
(brace
id|bsp_phys_id
op_assign
id|hard_smp_processor_id
c_func
(paren
)paren
suffix:semicolon
id|physid_set
c_func
(paren
id|bsp_phys_id
comma
id|phys_cpu_present_map
)paren
suffix:semicolon
id|cpu_set
c_func
(paren
l_int|0
comma
id|cpu_online_map
)paren
suffix:semicolon
multiline_comment|/* BSP&squot;s cpu_id == 0 */
id|cpu_set
c_func
(paren
l_int|0
comma
id|cpu_callout_map
)paren
suffix:semicolon
id|cpu_set
c_func
(paren
l_int|0
comma
id|cpu_callin_map
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Initialize the logical to physical CPU number mapping&n;&t; */
id|init_cpu_to_physid
c_func
(paren
)paren
suffix:semicolon
id|map_cpu_to_physid
c_func
(paren
l_int|0
comma
id|bsp_phys_id
)paren
suffix:semicolon
id|current_thread_info
c_func
(paren
)paren
op_member_access_from_pointer
id|cpu
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*&n; * Name:         smp_prepare_cpus (old smp_boot_cpus)&n; *&n; * Description:  This routine boot up APs.&n; *&n; * Born on Date: 2002.02.05&n; *&n; * Arguments:    NONE&n; *&n; * Returns:      void (cannot fail)&n; *&n; * Modification log:&n; * Date       Who Description&n; * ---------- --- --------------------------------------------------------&n; * 2003-06-24 hy  modify for linux-2.5.69&n; *&n; *==========================================================================*/
DECL|function|smp_prepare_cpus
r_void
id|__init
id|smp_prepare_cpus
c_func
(paren
r_int
r_int
id|max_cpus
)paren
(brace
r_int
id|phys_id
suffix:semicolon
r_int
r_int
id|nr_cpu
suffix:semicolon
id|nr_cpu
op_assign
id|inl
c_func
(paren
id|M32R_FPGA_NUM_OF_CPUS_PORTL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nr_cpu
OG
id|NR_CPUS
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;NUM_OF_CPUS reg. value [%ld] &gt; NR_CPU [%d]&quot;
comma
id|nr_cpu
comma
id|NR_CPUS
)paren
suffix:semicolon
r_goto
id|smp_done
suffix:semicolon
)brace
r_for
c_loop
(paren
id|phys_id
op_assign
l_int|0
suffix:semicolon
id|phys_id
OL
id|nr_cpu
suffix:semicolon
id|phys_id
op_increment
)paren
id|physid_set
c_func
(paren
id|phys_id
comma
id|phys_cpu_present_map
)paren
suffix:semicolon
id|show_mp_info
c_func
(paren
id|nr_cpu
)paren
suffix:semicolon
id|init_ipi_lock
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Setup boot CPU information&n;&t; */
id|smp_store_cpu_info
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Final full version of the data */
id|smp_tune_scheduling
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If SMP should be disabled, then really disable it!&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|max_cpus
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;SMP mode deactivated by commandline.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|smp_done
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Now scan the CPU present map and fire up the other CPUs.&n;&t; */
id|Dprintk
c_func
(paren
l_string|&quot;CPU present map : %lx&bslash;n&quot;
comma
id|physids_coerce
c_func
(paren
id|phys_cpu_present_map
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|phys_id
op_assign
l_int|0
suffix:semicolon
id|phys_id
OL
id|NR_CPUS
suffix:semicolon
id|phys_id
op_increment
)paren
(brace
multiline_comment|/*&n;&t;&t; * Don&squot;t even attempt to start the boot CPU!&n;&t;&t; */
r_if
c_cond
(paren
id|phys_id
op_eq
id|bsp_phys_id
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|physid_isset
c_func
(paren
id|phys_id
comma
id|phys_cpu_present_map
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|max_cpus
op_ge
l_int|0
)paren
op_logical_and
(paren
id|max_cpus
op_le
id|cpucount
op_plus
l_int|1
)paren
)paren
r_continue
suffix:semicolon
id|do_boot_cpu
c_func
(paren
id|phys_id
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Make sure we unmap all failed CPUs&n;&t;&t; */
r_if
c_cond
(paren
id|physid_to_cpu
c_func
(paren
id|phys_id
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|physid_clear
c_func
(paren
id|phys_id
comma
id|phys_cpu_present_map
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;phys CPU#%d not responding - &quot;
"&bslash;"
l_string|&quot;cannot use it.&bslash;n&quot;
comma
id|phys_id
)paren
suffix:semicolon
)brace
)brace
id|smp_done
suffix:colon
id|Dprintk
c_func
(paren
l_string|&quot;Boot done.&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|smp_tune_scheduling
r_static
r_void
id|__init
id|smp_tune_scheduling
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Nothing to do. */
)brace
multiline_comment|/*&n; * init_ipi_lock : Initialize IPI locks.&n; */
DECL|function|init_ipi_lock
r_static
r_void
id|__init
id|init_ipi_lock
c_func
(paren
r_void
)paren
(brace
r_int
id|ipi
suffix:semicolon
r_for
c_loop
(paren
id|ipi
op_assign
l_int|0
suffix:semicolon
id|ipi
OL
id|NR_IPIS
suffix:semicolon
id|ipi
op_increment
)paren
id|spin_lock_init
c_func
(paren
op_amp
id|ipi_lock
(braket
id|ipi
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*&n; * Name:         do_boot_cpu&n; *&n; * Description:  This routine boot up one AP.&n; *&n; * Born on Date: 2002.02.05&n; *&n; * Arguments:    phys_id - Target CPU physical ID&n; *&n; * Returns:      void (cannot fail)&n; *&n; * Modification log:&n; * Date       Who Description&n; * ---------- --- --------------------------------------------------------&n; * 2003-06-24 hy  modify for linux-2.5.69&n; *&n; *==========================================================================*/
DECL|function|do_boot_cpu
r_static
r_void
id|__init
id|do_boot_cpu
c_func
(paren
r_int
id|phys_id
)paren
(brace
r_struct
id|task_struct
op_star
id|idle
suffix:semicolon
r_int
r_int
id|send_status
comma
id|boot_status
suffix:semicolon
r_int
id|timeout
comma
id|cpu_id
suffix:semicolon
id|cpu_id
op_assign
op_increment
id|cpucount
suffix:semicolon
multiline_comment|/*&n;&t; * We can&squot;t use kernel_thread since we must avoid to&n;&t; * reschedule the child.&n;&t; */
id|idle
op_assign
id|fork_idle
c_func
(paren
id|cpu_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|idle
)paren
)paren
id|panic
c_func
(paren
l_string|&quot;failed fork for CPU#%d.&quot;
comma
id|cpu_id
)paren
suffix:semicolon
id|idle-&gt;thread.lr
op_assign
(paren
r_int
r_int
)paren
id|start_secondary
suffix:semicolon
id|map_cpu_to_physid
c_func
(paren
id|cpu_id
comma
id|phys_id
)paren
suffix:semicolon
multiline_comment|/* So we see what&squot;s up   */
id|printk
c_func
(paren
l_string|&quot;Booting processor %d/%d&bslash;n&quot;
comma
id|phys_id
comma
id|cpu_id
)paren
suffix:semicolon
id|stack_start.spi
op_assign
(paren
r_void
op_star
)paren
id|idle-&gt;thread.sp
suffix:semicolon
id|idle-&gt;thread_info-&gt;cpu
op_assign
id|cpu_id
suffix:semicolon
multiline_comment|/*&n;&t; * Send Startup IPI&n;&t; *   1.IPI received by CPU#(phys_id).&n;&t; *   2.CPU#(phys_id) enter startup_AP (arch/m32r/kernel/head.S)&n;&t; *   3.CPU#(phys_id) enter start_secondary()&n;&t; */
id|send_status
op_assign
l_int|0
suffix:semicolon
id|boot_status
op_assign
l_int|0
suffix:semicolon
id|cpu_set
c_func
(paren
id|phys_id
comma
id|cpu_bootout_map
)paren
suffix:semicolon
multiline_comment|/* Send Startup IPI */
id|send_IPI_mask_phys
c_func
(paren
id|cpumask_of_cpu
c_func
(paren
id|phys_id
)paren
comma
id|CPU_BOOT_IPI
comma
l_int|0
)paren
suffix:semicolon
id|Dprintk
c_func
(paren
l_string|&quot;Waiting for send to finish...&bslash;n&quot;
)paren
suffix:semicolon
id|timeout
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Wait 100[ms] */
r_do
(brace
id|Dprintk
c_func
(paren
l_string|&quot;+&quot;
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|send_status
op_assign
op_logical_neg
id|cpu_isset
c_func
(paren
id|phys_id
comma
id|cpu_bootin_map
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|send_status
op_logical_and
(paren
id|timeout
op_increment
OL
l_int|100
)paren
)paren
suffix:semicolon
id|Dprintk
c_func
(paren
l_string|&quot;After Startup.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_status
)paren
(brace
multiline_comment|/*&n;&t;&t; * allow APs to start initializing.&n;&t;&t; */
id|Dprintk
c_func
(paren
l_string|&quot;Before Callout %d.&bslash;n&quot;
comma
id|cpu_id
)paren
suffix:semicolon
id|cpu_set
c_func
(paren
id|cpu_id
comma
id|cpu_callout_map
)paren
suffix:semicolon
id|Dprintk
c_func
(paren
l_string|&quot;After Callout %d.&bslash;n&quot;
comma
id|cpu_id
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Wait 5s total for a response&n;&t;&t; */
r_for
c_loop
(paren
id|timeout
op_assign
l_int|0
suffix:semicolon
id|timeout
OL
l_int|5000
suffix:semicolon
id|timeout
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cpu_isset
c_func
(paren
id|cpu_id
comma
id|cpu_callin_map
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* It has booted */
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cpu_isset
c_func
(paren
id|cpu_id
comma
id|cpu_callin_map
)paren
)paren
(brace
multiline_comment|/* number CPUs logically, starting from 1 (BSP is 0) */
id|Dprintk
c_func
(paren
l_string|&quot;OK.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|boot_status
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Not responding.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;IPI never delivered???&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|send_status
op_logical_or
id|boot_status
)paren
(brace
id|unmap_cpu_to_physid
c_func
(paren
id|cpu_id
comma
id|phys_id
)paren
suffix:semicolon
id|cpu_clear
c_func
(paren
id|cpu_id
comma
id|cpu_callout_map
)paren
suffix:semicolon
id|cpu_clear
c_func
(paren
id|cpu_id
comma
id|cpu_callin_map
)paren
suffix:semicolon
id|cpu_clear
c_func
(paren
id|cpu_id
comma
id|cpu_initialized
)paren
suffix:semicolon
id|cpucount
op_decrement
suffix:semicolon
)brace
)brace
DECL|function|__cpu_up
r_int
id|__devinit
id|__cpu_up
c_func
(paren
r_int
r_int
id|cpu_id
)paren
(brace
r_int
id|timeout
suffix:semicolon
id|cpu_set
c_func
(paren
id|cpu_id
comma
id|smp_commenced_mask
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Wait 5s total for a response&n;&t; */
r_for
c_loop
(paren
id|timeout
op_assign
l_int|0
suffix:semicolon
id|timeout
OL
l_int|5000
suffix:semicolon
id|timeout
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cpu_isset
c_func
(paren
id|cpu_id
comma
id|cpu_online_map
)paren
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|cpu_isset
c_func
(paren
id|cpu_id
comma
id|cpu_online_map
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|smp_cpus_done
r_void
id|__init
id|smp_cpus_done
c_func
(paren
r_int
r_int
id|max_cpus
)paren
(brace
r_int
id|cpu_id
comma
id|timeout
suffix:semicolon
r_int
r_int
id|bogosum
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|timeout
op_assign
l_int|0
suffix:semicolon
id|timeout
OL
l_int|5000
suffix:semicolon
id|timeout
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cpus_equal
c_func
(paren
id|cpu_callin_map
comma
id|cpu_online_map
)paren
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|cpus_equal
c_func
(paren
id|cpu_callin_map
comma
id|cpu_online_map
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cpu_id
op_assign
l_int|0
suffix:semicolon
id|cpu_id
OL
id|num_online_cpus
c_func
(paren
)paren
suffix:semicolon
id|cpu_id
op_increment
)paren
id|show_cpu_info
c_func
(paren
id|cpu_id
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Allow the user to impress friends.&n;&t; */
id|Dprintk
c_func
(paren
l_string|&quot;Before bogomips.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpucount
)paren
(brace
id|for_each_cpu_mask
c_func
(paren
id|cpu_id
comma
id|cpu_online_map
)paren
id|bogosum
op_add_assign
id|cpu_data
(braket
id|cpu_id
)braket
dot
id|loops_per_jiffy
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Total of %d processors activated &quot;
"&bslash;"
l_string|&quot;(%lu.%02lu BogoMIPS).&bslash;n&quot;
comma
id|cpucount
op_plus
l_int|1
comma
id|bogosum
op_div
(paren
l_int|500000
op_div
id|HZ
)paren
comma
(paren
id|bogosum
op_div
(paren
l_int|5000
op_div
id|HZ
)paren
)paren
op_mod
l_int|100
)paren
suffix:semicolon
id|Dprintk
c_func
(paren
l_string|&quot;Before bogocount - setting activated=1.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
multiline_comment|/* Activate a secondary processor Routins                                    */
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
multiline_comment|/*==========================================================================*&n; * Name:         start_secondary&n; *&n; * Description:  This routine activate a secondary processor.&n; *&n; * Born on Date: 2002.02.05&n; *&n; * Arguments:    *unused - currently unused.&n; *&n; * Returns:      void (cannot fail)&n; *&n; * Modification log:&n; * Date       Who Description&n; * ---------- --- --------------------------------------------------------&n; * 2003-06-24 hy  modify for linux-2.5.69&n; *&n; *==========================================================================*/
DECL|function|start_secondary
r_int
id|__init
id|start_secondary
c_func
(paren
r_void
op_star
id|unused
)paren
(brace
id|cpu_init
c_func
(paren
)paren
suffix:semicolon
id|smp_callin
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|cpu_isset
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
id|smp_commenced_mask
)paren
)paren
id|cpu_relax
c_func
(paren
)paren
suffix:semicolon
id|smp_online
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * low-memory mappings have been cleared, flush them from&n;&t; * the local TLBs too.&n;&t; */
id|local_flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
id|cpu_idle
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*&n; * Name:         smp_callin&n; *&n; * Description:  This routine activate a secondary processor.&n; *&n; * Born on Date: 2002.02.05&n; *&n; * Arguments:    NONE&n; *&n; * Returns:      void (cannot fail)&n; *&n; * Modification log:&n; * Date       Who Description&n; * ---------- --- --------------------------------------------------------&n; * 2003-06-24 hy  modify for linux-2.5.69&n; *&n; *==========================================================================*/
DECL|function|smp_callin
r_static
r_void
id|__init
id|smp_callin
c_func
(paren
r_void
)paren
(brace
r_int
id|phys_id
op_assign
id|hard_smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_int
id|cpu_id
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
r_if
c_cond
(paren
id|cpu_isset
c_func
(paren
id|cpu_id
comma
id|cpu_callin_map
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;huh, phys CPU#%d, CPU#%d already present??&bslash;n&quot;
comma
id|phys_id
comma
id|cpu_id
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|Dprintk
c_func
(paren
l_string|&quot;CPU#%d (phys ID: %d) waiting for CALLOUT&bslash;n&quot;
comma
id|cpu_id
comma
id|phys_id
)paren
suffix:semicolon
multiline_comment|/* Waiting 2s total for startup (udelay is not yet working) */
id|timeout
op_assign
id|jiffies
op_plus
(paren
l_int|2
op_star
id|HZ
)paren
suffix:semicolon
r_while
c_loop
(paren
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
multiline_comment|/* Has the boot CPU finished it&squot;s STARTUP sequence ? */
r_if
c_cond
(paren
id|cpu_isset
c_func
(paren
id|cpu_id
comma
id|cpu_callout_map
)paren
)paren
r_break
suffix:semicolon
id|cpu_relax
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;BUG: CPU#%d started up but did not get a callout!&bslash;n&quot;
comma
id|cpu_id
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Allow the master to continue. */
id|cpu_set
c_func
(paren
id|cpu_id
comma
id|cpu_callin_map
)paren
suffix:semicolon
)brace
DECL|function|smp_online
r_static
r_void
id|__init
id|smp_online
c_func
(paren
r_void
)paren
(brace
r_int
id|cpu_id
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
id|local_irq_enable
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Get our bogomips. */
id|calibrate_delay
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Save our processor parameters */
id|smp_store_cpu_info
c_func
(paren
id|cpu_id
)paren
suffix:semicolon
id|cpu_set
c_func
(paren
id|cpu_id
comma
id|cpu_online_map
)paren
suffix:semicolon
)brace
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
multiline_comment|/* Boot up CPUs common Routins                                               */
multiline_comment|/*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*/
DECL|function|show_mp_info
r_static
r_void
id|__init
id|show_mp_info
c_func
(paren
r_int
id|nr_cpu
)paren
(brace
r_int
id|i
suffix:semicolon
r_char
id|cpu_model0
(braket
l_int|17
)braket
comma
id|cpu_model1
(braket
l_int|17
)braket
comma
id|cpu_ver
(braket
l_int|9
)braket
suffix:semicolon
id|strncpy
c_func
(paren
id|cpu_model0
comma
(paren
r_char
op_star
)paren
id|M32R_FPGA_CPU_NAME_ADDR
comma
l_int|16
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|cpu_model1
comma
(paren
r_char
op_star
)paren
id|M32R_FPGA_MODEL_ID_ADDR
comma
l_int|16
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|cpu_ver
comma
(paren
r_char
op_star
)paren
id|M32R_FPGA_VERSION_ADDR
comma
l_int|8
)paren
suffix:semicolon
id|cpu_model0
(braket
l_int|16
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|15
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|cpu_model0
(braket
id|i
)braket
op_ne
l_char|&squot; &squot;
)paren
r_break
suffix:semicolon
id|cpu_model0
(braket
id|i
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
id|cpu_model1
(braket
l_int|16
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|15
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|cpu_model1
(braket
id|i
)braket
op_ne
l_char|&squot; &squot;
)paren
r_break
suffix:semicolon
id|cpu_model1
(braket
id|i
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
id|cpu_ver
(braket
l_int|8
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|7
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|cpu_ver
(braket
id|i
)braket
op_ne
l_char|&squot; &squot;
)paren
r_break
suffix:semicolon
id|cpu_ver
(braket
id|i
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;M32R-mp information&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  On-chip CPUs : %d&bslash;n&quot;
comma
id|nr_cpu
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  CPU model : %s/%s(%s)&bslash;n&quot;
comma
id|cpu_model0
comma
id|cpu_model1
comma
id|cpu_ver
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * The bootstrap kernel entry code has set these up. Save them for&n; * a given CPU&n; */
DECL|function|smp_store_cpu_info
r_static
r_void
id|__init
id|smp_store_cpu_info
c_func
(paren
r_int
id|cpu_id
)paren
(brace
r_struct
id|cpuinfo_m32r
op_star
id|ci
op_assign
id|cpu_data
op_plus
id|cpu_id
suffix:semicolon
op_star
id|ci
op_assign
id|boot_cpu_data
suffix:semicolon
id|ci-&gt;loops_per_jiffy
op_assign
id|loops_per_jiffy
suffix:semicolon
)brace
DECL|function|show_cpu_info
r_static
r_void
id|__init
id|show_cpu_info
c_func
(paren
r_int
id|cpu_id
)paren
(brace
r_struct
id|cpuinfo_m32r
op_star
id|ci
op_assign
op_amp
id|cpu_data
(braket
id|cpu_id
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;CPU#%d : &quot;
comma
id|cpu_id
)paren
suffix:semicolon
DECL|macro|PRINT_CLOCK
mdefine_line|#define PRINT_CLOCK(name, value) &bslash;&n;&t;printk(name &quot; clock %d.%02dMHz&quot;, &bslash;&n;&t;&t;((value) / 1000000), ((value) % 1000000) / 10000)
id|PRINT_CLOCK
c_func
(paren
l_string|&quot;CPU&quot;
comma
(paren
r_int
)paren
id|ci-&gt;cpu_clock
)paren
suffix:semicolon
id|PRINT_CLOCK
c_func
(paren
l_string|&quot;, Bus&quot;
comma
(paren
r_int
)paren
id|ci-&gt;bus_clock
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, loops_per_jiffy[%ld]&bslash;n&quot;
comma
id|ci-&gt;loops_per_jiffy
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * the frequency of the profiling timer can be changed&n; * by writing a multiplier value into /proc/profile.&n; */
DECL|function|setup_profiling_timer
r_int
id|setup_profiling_timer
c_func
(paren
r_int
r_int
id|multiplier
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * Sanity check. [at least 500 APIC cycles should be&n;&t; * between APIC interrupts as a rule of thumb, to avoid&n;&t; * irqs flooding us]&n;&t; */
r_if
c_cond
(paren
(paren
op_logical_neg
id|multiplier
)paren
op_logical_or
(paren
id|calibration_result
op_div
id|multiplier
OL
l_int|500
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;&t; * Set the new multiplier for each CPU. CPUs don&squot;t start using the&n;&t; * new values until the next timer interrupt in which they do process&n;&t; * accounting. At that time they also adjust their APIC timers&n;&t; * accordingly.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_CPUS
suffix:semicolon
op_increment
id|i
)paren
id|per_cpu
c_func
(paren
id|prof_multiplier
comma
id|i
)paren
op_assign
id|multiplier
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Initialize all maps between cpu number and apicids */
DECL|function|init_cpu_to_physid
r_static
r_void
id|__init
id|init_cpu_to_physid
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_CPUS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cpu_2_physid
(braket
id|i
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
id|physid_2_cpu
(braket
id|i
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * set up a mapping between cpu and apicid. Uses logical apicids for multiquad,&n; * else physical apic ids&n; */
DECL|function|map_cpu_to_physid
r_static
r_void
id|__init
id|map_cpu_to_physid
c_func
(paren
r_int
id|cpu_id
comma
r_int
id|phys_id
)paren
(brace
id|physid_2_cpu
(braket
id|phys_id
)braket
op_assign
id|cpu_id
suffix:semicolon
id|cpu_2_physid
(braket
id|cpu_id
)braket
op_assign
id|phys_id
suffix:semicolon
)brace
multiline_comment|/*&n; * undo a mapping between cpu and apicid. Uses logical apicids for multiquad,&n; * else physical apic ids&n; */
DECL|function|unmap_cpu_to_physid
r_static
r_void
id|__init
id|unmap_cpu_to_physid
c_func
(paren
r_int
id|cpu_id
comma
r_int
id|phys_id
)paren
(brace
id|physid_2_cpu
(braket
id|phys_id
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
id|cpu_2_physid
(braket
id|cpu_id
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
eof
