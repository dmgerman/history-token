multiline_comment|/* sysctl.c: implementation of /proc/sys files relating to FRV specifically&n; *&n; * Copyright (C) 2004 Red Hat, Inc. All Rights Reserved.&n; * Written by David Howells (dhowells@redhat.com)&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/sysctl.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|variable|frv_cache_wback
r_static
r_const
r_char
id|frv_cache_wback
(braket
)braket
op_assign
l_string|&quot;wback&quot;
suffix:semicolon
DECL|variable|frv_cache_wthru
r_static
r_const
r_char
id|frv_cache_wthru
(braket
)braket
op_assign
l_string|&quot;wthru&quot;
suffix:semicolon
DECL|function|frv_change_dcache_mode
r_static
r_void
id|frv_change_dcache_mode
c_func
(paren
r_int
r_int
id|newmode
)paren
(brace
r_int
r_int
id|flags
comma
id|hsr0
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|hsr0
op_assign
id|__get_HSR
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|hsr0
op_and_assign
op_complement
id|HSR0_DCE
suffix:semicolon
id|__set_HSR
c_func
(paren
l_int|0
comma
id|hsr0
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;&t;dcef&t;@(gr0,gr0),#1&t;&bslash;n&quot;
l_string|&quot;&t;membar&t;&t;&t;&bslash;n&quot;
suffix:colon
suffix:colon
suffix:colon
l_string|&quot;memory&quot;
)paren
suffix:semicolon
id|hsr0
op_assign
(paren
id|hsr0
op_amp
op_complement
id|HSR0_CBM
)paren
op_or
id|newmode
suffix:semicolon
id|__set_HSR
c_func
(paren
l_int|0
comma
id|hsr0
)paren
suffix:semicolon
id|hsr0
op_or_assign
id|HSR0_DCE
suffix:semicolon
id|__set_HSR
c_func
(paren
l_int|0
comma
id|hsr0
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
singleline_comment|//printk(&quot;HSR0 now %08lx&bslash;n&quot;, hsr0);
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * handle requests to dynamically switch the write caching mode delivered by /proc&n; */
DECL|function|procctl_frv_cachemode
r_static
r_int
id|procctl_frv_cachemode
c_func
(paren
id|ctl_table
op_star
id|table
comma
r_int
id|write
comma
r_struct
id|file
op_star
id|filp
comma
r_void
op_star
id|buffer
comma
r_int
op_star
id|lenp
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
r_int
id|hsr0
suffix:semicolon
r_char
id|buff
(braket
l_int|8
)braket
suffix:semicolon
r_int
id|len
suffix:semicolon
id|len
op_assign
op_star
id|lenp
suffix:semicolon
r_if
c_cond
(paren
id|write
)paren
(brace
multiline_comment|/* potential state change */
r_if
c_cond
(paren
id|len
op_le
l_int|1
op_logical_or
id|len
OG
r_sizeof
(paren
id|buff
)paren
op_minus
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|buff
comma
id|buffer
comma
id|len
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|buff
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot;&bslash;n&squot;
)paren
id|buff
(braket
id|len
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_else
id|buff
(braket
id|len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|buff
comma
id|frv_cache_wback
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* switch dcache into write-back mode */
id|frv_change_dcache_mode
c_func
(paren
id|HSR0_CBM_COPY_BACK
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|buff
comma
id|frv_cache_wthru
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* switch dcache into write-through mode */
id|frv_change_dcache_mode
c_func
(paren
id|HSR0_CBM_WRITE_THRU
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* read the state */
r_if
c_cond
(paren
id|filp-&gt;f_pos
OG
l_int|0
)paren
(brace
op_star
id|lenp
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|hsr0
op_assign
id|__get_HSR
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|hsr0
op_amp
id|HSR0_CBM
)paren
(brace
r_case
id|HSR0_CBM_WRITE_THRU
suffix:colon
id|memcpy
c_func
(paren
id|buff
comma
id|frv_cache_wthru
comma
r_sizeof
(paren
id|frv_cache_wthru
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|buff
(braket
r_sizeof
(paren
id|frv_cache_wthru
)paren
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
id|len
op_assign
r_sizeof
(paren
id|frv_cache_wthru
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|memcpy
c_func
(paren
id|buff
comma
id|frv_cache_wback
comma
r_sizeof
(paren
id|frv_cache_wback
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|buff
(braket
r_sizeof
(paren
id|frv_cache_wback
)paren
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
id|len
op_assign
r_sizeof
(paren
id|frv_cache_wback
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
op_star
id|lenp
)paren
id|len
op_assign
op_star
id|lenp
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buffer
comma
id|buff
comma
id|len
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
op_star
id|lenp
op_assign
id|len
suffix:semicolon
id|filp-&gt;f_pos
op_assign
id|len
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* end procctl_frv_cachemode() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * permit the mm_struct the nominated process is using have its MMU context ID pinned&n; */
macro_line|#ifdef CONFIG_MMU
DECL|function|procctl_frv_pin_cxnr
r_static
r_int
id|procctl_frv_pin_cxnr
c_func
(paren
id|ctl_table
op_star
id|table
comma
r_int
id|write
comma
r_struct
id|file
op_star
id|filp
comma
r_void
op_star
id|buffer
comma
r_int
op_star
id|lenp
comma
id|loff_t
op_star
id|ppos
)paren
(brace
id|pid_t
id|pid
suffix:semicolon
r_char
id|buff
(braket
l_int|16
)braket
comma
op_star
id|p
suffix:semicolon
r_int
id|len
suffix:semicolon
id|len
op_assign
op_star
id|lenp
suffix:semicolon
r_if
c_cond
(paren
id|write
)paren
(brace
multiline_comment|/* potential state change */
r_if
c_cond
(paren
id|len
op_le
l_int|1
op_logical_or
id|len
OG
r_sizeof
(paren
id|buff
)paren
op_minus
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|buff
comma
id|buffer
comma
id|len
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|buff
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot;&bslash;n&squot;
)paren
id|buff
(braket
id|len
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_else
id|buff
(braket
id|len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|pid
op_assign
id|simple_strtoul
c_func
(paren
id|buff
comma
op_amp
id|p
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
id|cxn_pin_by_pid
c_func
(paren
id|pid
)paren
suffix:semicolon
)brace
multiline_comment|/* read the currently pinned CXN */
r_if
c_cond
(paren
id|filp-&gt;f_pos
OG
l_int|0
)paren
(brace
op_star
id|lenp
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|len
op_assign
id|snprintf
c_func
(paren
id|buff
comma
r_sizeof
(paren
id|buff
)paren
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|cxn_pinned
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
op_star
id|lenp
)paren
id|len
op_assign
op_star
id|lenp
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buffer
comma
id|buff
comma
id|len
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
op_star
id|lenp
op_assign
id|len
suffix:semicolon
id|filp-&gt;f_pos
op_assign
id|len
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* end procctl_frv_pin_cxnr() */
macro_line|#endif
multiline_comment|/*&n; * FR-V specific sysctls&n; */
DECL|variable|frv_table
r_static
r_struct
id|ctl_table
id|frv_table
(braket
)braket
op_assign
(brace
(brace
l_int|1
comma
l_string|&quot;cache-mode&quot;
comma
l_int|NULL
comma
l_int|0
comma
l_int|0644
comma
l_int|NULL
comma
op_amp
id|procctl_frv_cachemode
)brace
comma
macro_line|#ifdef CONFIG_MMU
(brace
l_int|2
comma
l_string|&quot;pin-cxnr&quot;
comma
l_int|NULL
comma
l_int|0
comma
l_int|0644
comma
l_int|NULL
comma
op_amp
id|procctl_frv_pin_cxnr
)brace
comma
macro_line|#endif
(brace
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; * Use a temporary sysctl number. Horrid, but will be cleaned up in 2.6&n; * when all the PM interfaces exist nicely.&n; */
DECL|macro|CTL_FRV
mdefine_line|#define CTL_FRV 9898
DECL|variable|frv_dir_table
r_static
r_struct
id|ctl_table
id|frv_dir_table
(braket
)braket
op_assign
(brace
(brace
id|CTL_FRV
comma
l_string|&quot;frv&quot;
comma
l_int|NULL
comma
l_int|0
comma
l_int|0555
comma
id|frv_table
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; * Initialize power interface&n; */
DECL|function|frv_sysctl_init
r_static
r_int
id|__init
id|frv_sysctl_init
c_func
(paren
r_void
)paren
(brace
id|register_sysctl_table
c_func
(paren
id|frv_dir_table
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|frv_sysctl_init
id|__initcall
c_func
(paren
id|frv_sysctl_init
)paren
suffix:semicolon
eof
