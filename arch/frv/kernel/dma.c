multiline_comment|/* dma.c: DMA controller management on FR401 and the like&n; *&n; * Copyright (C) 2004 Red Hat, Inc. All Rights Reserved.&n; * Written by David Howells (dhowells@redhat.com)&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/gpio-regs.h&gt;
macro_line|#include &lt;asm/irc-regs.h&gt;
macro_line|#include &lt;asm/cpu-irqs.h&gt;
DECL|struct|frv_dma_channel
r_struct
id|frv_dma_channel
(brace
DECL|member|flags
r_uint8
id|flags
suffix:semicolon
DECL|macro|FRV_DMA_FLAGS_RESERVED
mdefine_line|#define FRV_DMA_FLAGS_RESERVED&t;0x01
DECL|macro|FRV_DMA_FLAGS_INUSE
mdefine_line|#define FRV_DMA_FLAGS_INUSE&t;0x02
DECL|macro|FRV_DMA_FLAGS_PAUSED
mdefine_line|#define FRV_DMA_FLAGS_PAUSED&t;0x04
DECL|member|cap
r_uint8
id|cap
suffix:semicolon
multiline_comment|/* capabilities available */
DECL|member|irq
r_int
id|irq
suffix:semicolon
multiline_comment|/* completion IRQ */
DECL|member|dreqbit
r_uint32
id|dreqbit
suffix:semicolon
DECL|member|dackbit
r_uint32
id|dackbit
suffix:semicolon
DECL|member|donebit
r_uint32
id|donebit
suffix:semicolon
DECL|member|ioaddr
r_const
r_int
r_int
id|ioaddr
suffix:semicolon
multiline_comment|/* DMA controller regs addr */
DECL|member|devname
r_const
r_char
op_star
id|devname
suffix:semicolon
DECL|member|handler
id|dma_irq_handler_t
id|handler
suffix:semicolon
DECL|member|data
r_void
op_star
id|data
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|__get_DMAC
mdefine_line|#define __get_DMAC(IO,X)&t;({ *(volatile unsigned long *)((IO) + DMAC_##X##x); })
DECL|macro|__set_DMAC
mdefine_line|#define __set_DMAC(IO,X,V)&t;&t;&t;&t;&t;&bslash;&n;do {&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;*(volatile unsigned long *)((IO) + DMAC_##X##x) = (V);&t;&bslash;&n;&t;mb();&t;&t;&t;&t;&t;&t;&t;&bslash;&n;} while(0)
DECL|macro|___set_DMAC
mdefine_line|#define ___set_DMAC(IO,X,V)&t;&t;&t;&t;&t;&bslash;&n;do {&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;*(volatile unsigned long *)((IO) + DMAC_##X##x) = (V);&t;&bslash;&n;} while(0)
DECL|variable|frv_dma_channels
r_static
r_struct
id|frv_dma_channel
id|frv_dma_channels
(braket
id|FRV_DMA_NCHANS
)braket
op_assign
(brace
(braket
l_int|0
)braket
op_assign
(brace
dot
id|cap
op_assign
id|FRV_DMA_CAP_DREQ
op_or
id|FRV_DMA_CAP_DACK
op_or
id|FRV_DMA_CAP_DONE
comma
dot
id|irq
op_assign
id|IRQ_CPU_DMA0
comma
dot
id|dreqbit
op_assign
id|SIR_DREQ0_INPUT
comma
dot
id|dackbit
op_assign
id|SOR_DACK0_OUTPUT
comma
dot
id|donebit
op_assign
id|SOR_DONE0_OUTPUT
comma
dot
id|ioaddr
op_assign
l_int|0xfe000900
comma
)brace
comma
(braket
l_int|1
)braket
op_assign
(brace
dot
id|cap
op_assign
id|FRV_DMA_CAP_DREQ
op_or
id|FRV_DMA_CAP_DACK
op_or
id|FRV_DMA_CAP_DONE
comma
dot
id|irq
op_assign
id|IRQ_CPU_DMA1
comma
dot
id|dreqbit
op_assign
id|SIR_DREQ1_INPUT
comma
dot
id|dackbit
op_assign
id|SOR_DACK1_OUTPUT
comma
dot
id|donebit
op_assign
id|SOR_DONE1_OUTPUT
comma
dot
id|ioaddr
op_assign
l_int|0xfe000980
comma
)brace
comma
(braket
l_int|2
)braket
op_assign
(brace
dot
id|cap
op_assign
id|FRV_DMA_CAP_DREQ
op_or
id|FRV_DMA_CAP_DACK
comma
dot
id|irq
op_assign
id|IRQ_CPU_DMA2
comma
dot
id|dreqbit
op_assign
id|SIR_DREQ2_INPUT
comma
dot
id|dackbit
op_assign
id|SOR_DACK2_OUTPUT
comma
dot
id|ioaddr
op_assign
l_int|0xfe000a00
comma
)brace
comma
(braket
l_int|3
)braket
op_assign
(brace
dot
id|cap
op_assign
id|FRV_DMA_CAP_DREQ
op_or
id|FRV_DMA_CAP_DACK
comma
dot
id|irq
op_assign
id|IRQ_CPU_DMA3
comma
dot
id|dreqbit
op_assign
id|SIR_DREQ3_INPUT
comma
dot
id|dackbit
op_assign
id|SOR_DACK3_OUTPUT
comma
dot
id|ioaddr
op_assign
l_int|0xfe000a80
comma
)brace
comma
(braket
l_int|4
)braket
op_assign
(brace
dot
id|cap
op_assign
id|FRV_DMA_CAP_DREQ
comma
dot
id|irq
op_assign
id|IRQ_CPU_DMA4
comma
dot
id|dreqbit
op_assign
id|SIR_DREQ4_INPUT
comma
dot
id|ioaddr
op_assign
l_int|0xfe001000
comma
)brace
comma
(braket
l_int|5
)braket
op_assign
(brace
dot
id|cap
op_assign
id|FRV_DMA_CAP_DREQ
comma
dot
id|irq
op_assign
id|IRQ_CPU_DMA5
comma
dot
id|dreqbit
op_assign
id|SIR_DREQ5_INPUT
comma
dot
id|ioaddr
op_assign
l_int|0xfe001080
comma
)brace
comma
(braket
l_int|6
)braket
op_assign
(brace
dot
id|cap
op_assign
id|FRV_DMA_CAP_DREQ
comma
dot
id|irq
op_assign
id|IRQ_CPU_DMA6
comma
dot
id|dreqbit
op_assign
id|SIR_DREQ6_INPUT
comma
dot
id|ioaddr
op_assign
l_int|0xfe001100
comma
)brace
comma
(braket
l_int|7
)braket
op_assign
(brace
dot
id|cap
op_assign
id|FRV_DMA_CAP_DREQ
comma
dot
id|irq
op_assign
id|IRQ_CPU_DMA7
comma
dot
id|dreqbit
op_assign
id|SIR_DREQ7_INPUT
comma
dot
id|ioaddr
op_assign
l_int|0xfe001180
comma
)brace
comma
)brace
suffix:semicolon
r_static
id|DEFINE_RWLOCK
c_func
(paren
id|frv_dma_channels_lock
)paren
suffix:semicolon
DECL|variable|frv_dma_inprogress
r_int
r_int
id|frv_dma_inprogress
suffix:semicolon
DECL|macro|frv_clear_dma_inprogress
mdefine_line|#define frv_clear_dma_inprogress(channel) &bslash;&n;&t;atomic_clear_mask(1 &lt;&lt; (channel), &amp;frv_dma_inprogress);
DECL|macro|frv_set_dma_inprogress
mdefine_line|#define frv_set_dma_inprogress(channel) &bslash;&n;&t;atomic_set_mask(1 &lt;&lt; (channel), &amp;frv_dma_inprogress);
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * DMA irq handler - determine channel involved, grab status and call real handler&n; */
DECL|function|dma_irq_handler
r_static
id|irqreturn_t
id|dma_irq_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|_channel
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|frv_dma_channel
op_star
id|channel
op_assign
id|_channel
suffix:semicolon
id|frv_clear_dma_inprogress
c_func
(paren
id|channel
op_minus
id|frv_dma_channels
)paren
suffix:semicolon
r_return
id|channel
op_member_access_from_pointer
id|handler
c_func
(paren
id|channel
op_minus
id|frv_dma_channels
comma
id|__get_DMAC
c_func
(paren
id|channel-&gt;ioaddr
comma
id|CSTR
)paren
comma
id|channel-&gt;data
comma
id|regs
)paren
suffix:semicolon
)brace
multiline_comment|/* end dma_irq_handler() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * Determine which DMA controllers are present on this CPU&n; */
DECL|function|frv_dma_init
r_void
id|__init
id|frv_dma_init
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|psr
op_assign
id|__get_PSR
c_func
(paren
)paren
suffix:semicolon
r_int
id|num_dma
comma
id|i
suffix:semicolon
multiline_comment|/* First, determine how many DMA channels are available */
r_switch
c_cond
(paren
id|PSR_IMPLE
c_func
(paren
id|psr
)paren
)paren
(brace
r_case
id|PSR_IMPLE_FR405
suffix:colon
r_case
id|PSR_IMPLE_FR451
suffix:colon
r_case
id|PSR_IMPLE_FR501
suffix:colon
r_case
id|PSR_IMPLE_FR551
suffix:colon
id|num_dma
op_assign
id|FRV_DMA_8CHANS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PSR_IMPLE_FR401
suffix:colon
r_default
suffix:colon
id|num_dma
op_assign
id|FRV_DMA_4CHANS
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Now mark all of the non-existent channels as reserved */
r_for
c_loop
(paren
id|i
op_assign
id|num_dma
suffix:semicolon
id|i
OL
id|FRV_DMA_NCHANS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|frv_dma_channels
(braket
id|i
)braket
dot
id|flags
op_assign
id|FRV_DMA_FLAGS_RESERVED
suffix:semicolon
)brace
)brace
multiline_comment|/* end frv_dma_init() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * allocate a DMA controller channel and the IRQ associated with it&n; */
DECL|function|frv_dma_open
r_int
id|frv_dma_open
c_func
(paren
r_const
r_char
op_star
id|devname
comma
r_int
r_int
id|dmamask
comma
r_int
id|dmacap
comma
id|dma_irq_handler_t
id|handler
comma
r_int
r_int
id|irq_flags
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|frv_dma_channel
op_star
id|channel
suffix:semicolon
r_int
id|dma
comma
id|ret
suffix:semicolon
r_uint32
id|val
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|frv_dma_channels_lock
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOSPC
suffix:semicolon
r_for
c_loop
(paren
id|dma
op_assign
id|FRV_DMA_NCHANS
op_minus
l_int|1
suffix:semicolon
id|dma
op_ge
l_int|0
suffix:semicolon
id|dma
op_decrement
)paren
(brace
id|channel
op_assign
op_amp
id|frv_dma_channels
(braket
id|dma
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|dma
comma
op_amp
id|dmamask
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|channel-&gt;cap
op_amp
id|dmacap
)paren
op_ne
id|dmacap
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|frv_dma_channels
(braket
id|dma
)braket
dot
id|flags
)paren
r_goto
id|found
suffix:semicolon
)brace
r_goto
id|out
suffix:semicolon
id|found
suffix:colon
id|ret
op_assign
id|request_irq
c_func
(paren
id|channel-&gt;irq
comma
id|dma_irq_handler
comma
id|irq_flags
comma
id|devname
comma
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* okay, we&squot;ve allocated all the resources */
id|channel
op_assign
op_amp
id|frv_dma_channels
(braket
id|dma
)braket
suffix:semicolon
id|channel-&gt;flags
op_or_assign
id|FRV_DMA_FLAGS_INUSE
suffix:semicolon
id|channel-&gt;devname
op_assign
id|devname
suffix:semicolon
id|channel-&gt;handler
op_assign
id|handler
suffix:semicolon
id|channel-&gt;data
op_assign
id|data
suffix:semicolon
multiline_comment|/* Now make sure we are set up for DMA and not GPIO */
multiline_comment|/* SIR bit must be set for DMA to work */
id|__set_SIR
c_func
(paren
id|channel-&gt;dreqbit
op_or
id|__get_SIR
c_func
(paren
)paren
)paren
suffix:semicolon
multiline_comment|/* SOR bits depend on what the caller requests */
id|val
op_assign
id|__get_SOR
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmacap
op_amp
id|FRV_DMA_CAP_DACK
)paren
(brace
id|val
op_or_assign
id|channel-&gt;dackbit
suffix:semicolon
)brace
r_else
id|val
op_and_assign
op_complement
id|channel-&gt;dackbit
suffix:semicolon
r_if
c_cond
(paren
id|dmacap
op_amp
id|FRV_DMA_CAP_DONE
)paren
(brace
id|val
op_or_assign
id|channel-&gt;donebit
suffix:semicolon
)brace
r_else
id|val
op_and_assign
op_complement
id|channel-&gt;donebit
suffix:semicolon
id|__set_SOR
c_func
(paren
id|val
)paren
suffix:semicolon
id|ret
op_assign
id|dma
suffix:semicolon
id|out
suffix:colon
id|write_unlock
c_func
(paren
op_amp
id|frv_dma_channels_lock
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* end frv_dma_open() */
DECL|variable|frv_dma_open
id|EXPORT_SYMBOL
c_func
(paren
id|frv_dma_open
)paren
suffix:semicolon
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * close a DMA channel and its associated interrupt&n; */
DECL|function|frv_dma_close
r_void
id|frv_dma_close
c_func
(paren
r_int
id|dma
)paren
(brace
r_struct
id|frv_dma_channel
op_star
id|channel
op_assign
op_amp
id|frv_dma_channels
(braket
id|dma
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|frv_dma_channels_lock
comma
id|flags
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|channel-&gt;irq
comma
id|channel
)paren
suffix:semicolon
id|frv_dma_stop
c_func
(paren
id|dma
)paren
suffix:semicolon
id|channel-&gt;flags
op_and_assign
op_complement
id|FRV_DMA_FLAGS_INUSE
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|frv_dma_channels_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* end frv_dma_close() */
DECL|variable|frv_dma_close
id|EXPORT_SYMBOL
c_func
(paren
id|frv_dma_close
)paren
suffix:semicolon
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * set static configuration on a DMA channel&n; */
DECL|function|frv_dma_config
r_void
id|frv_dma_config
c_func
(paren
r_int
id|dma
comma
r_int
r_int
id|ccfr
comma
r_int
r_int
id|cctr
comma
r_int
r_int
id|apr
)paren
(brace
r_int
r_int
id|ioaddr
op_assign
id|frv_dma_channels
(braket
id|dma
)braket
dot
id|ioaddr
suffix:semicolon
id|___set_DMAC
c_func
(paren
id|ioaddr
comma
id|CCFR
comma
id|ccfr
)paren
suffix:semicolon
id|___set_DMAC
c_func
(paren
id|ioaddr
comma
id|CCTR
comma
id|cctr
)paren
suffix:semicolon
id|___set_DMAC
c_func
(paren
id|ioaddr
comma
id|APR
comma
id|apr
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* end frv_dma_config() */
DECL|variable|frv_dma_config
id|EXPORT_SYMBOL
c_func
(paren
id|frv_dma_config
)paren
suffix:semicolon
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * start a DMA channel&n; */
DECL|function|frv_dma_start
r_void
id|frv_dma_start
c_func
(paren
r_int
id|dma
comma
r_int
r_int
id|sba
comma
r_int
r_int
id|dba
comma
r_int
r_int
id|pix
comma
r_int
r_int
id|six
comma
r_int
r_int
id|bcl
)paren
(brace
r_int
r_int
id|ioaddr
op_assign
id|frv_dma_channels
(braket
id|dma
)braket
dot
id|ioaddr
suffix:semicolon
id|___set_DMAC
c_func
(paren
id|ioaddr
comma
id|SBA
comma
id|sba
)paren
suffix:semicolon
id|___set_DMAC
c_func
(paren
id|ioaddr
comma
id|DBA
comma
id|dba
)paren
suffix:semicolon
id|___set_DMAC
c_func
(paren
id|ioaddr
comma
id|PIX
comma
id|pix
)paren
suffix:semicolon
id|___set_DMAC
c_func
(paren
id|ioaddr
comma
id|SIX
comma
id|six
)paren
suffix:semicolon
id|___set_DMAC
c_func
(paren
id|ioaddr
comma
id|BCL
comma
id|bcl
)paren
suffix:semicolon
id|___set_DMAC
c_func
(paren
id|ioaddr
comma
id|CSTR
comma
l_int|0
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|__set_DMAC
c_func
(paren
id|ioaddr
comma
id|CCTR
comma
id|__get_DMAC
c_func
(paren
id|ioaddr
comma
id|CCTR
)paren
op_or
id|DMAC_CCTRx_ACT
)paren
suffix:semicolon
id|frv_set_dma_inprogress
c_func
(paren
id|dma
)paren
suffix:semicolon
)brace
multiline_comment|/* end frv_dma_start() */
DECL|variable|frv_dma_start
id|EXPORT_SYMBOL
c_func
(paren
id|frv_dma_start
)paren
suffix:semicolon
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * restart a DMA channel that&squot;s been stopped in circular addressing mode by comparison-end&n; */
DECL|function|frv_dma_restart_circular
r_void
id|frv_dma_restart_circular
c_func
(paren
r_int
id|dma
comma
r_int
r_int
id|six
)paren
(brace
r_int
r_int
id|ioaddr
op_assign
id|frv_dma_channels
(braket
id|dma
)braket
dot
id|ioaddr
suffix:semicolon
id|___set_DMAC
c_func
(paren
id|ioaddr
comma
id|SIX
comma
id|six
)paren
suffix:semicolon
id|___set_DMAC
c_func
(paren
id|ioaddr
comma
id|CSTR
comma
id|__get_DMAC
c_func
(paren
id|ioaddr
comma
id|CSTR
)paren
op_amp
op_complement
id|DMAC_CSTRx_CE
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|__set_DMAC
c_func
(paren
id|ioaddr
comma
id|CCTR
comma
id|__get_DMAC
c_func
(paren
id|ioaddr
comma
id|CCTR
)paren
op_or
id|DMAC_CCTRx_ACT
)paren
suffix:semicolon
id|frv_set_dma_inprogress
c_func
(paren
id|dma
)paren
suffix:semicolon
)brace
multiline_comment|/* end frv_dma_restart_circular() */
DECL|variable|frv_dma_restart_circular
id|EXPORT_SYMBOL
c_func
(paren
id|frv_dma_restart_circular
)paren
suffix:semicolon
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * stop a DMA channel&n; */
DECL|function|frv_dma_stop
r_void
id|frv_dma_stop
c_func
(paren
r_int
id|dma
)paren
(brace
r_int
r_int
id|ioaddr
op_assign
id|frv_dma_channels
(braket
id|dma
)braket
dot
id|ioaddr
suffix:semicolon
r_uint32
id|cctr
suffix:semicolon
id|___set_DMAC
c_func
(paren
id|ioaddr
comma
id|CSTR
comma
l_int|0
)paren
suffix:semicolon
id|cctr
op_assign
id|__get_DMAC
c_func
(paren
id|ioaddr
comma
id|CCTR
)paren
suffix:semicolon
id|cctr
op_and_assign
op_complement
(paren
id|DMAC_CCTRx_IE
op_or
id|DMAC_CCTRx_ACT
)paren
suffix:semicolon
id|cctr
op_or_assign
id|DMAC_CCTRx_FC
suffix:semicolon
multiline_comment|/* fifo clear */
id|__set_DMAC
c_func
(paren
id|ioaddr
comma
id|CCTR
comma
id|cctr
)paren
suffix:semicolon
id|__set_DMAC
c_func
(paren
id|ioaddr
comma
id|BCL
comma
l_int|0
)paren
suffix:semicolon
id|frv_clear_dma_inprogress
c_func
(paren
id|dma
)paren
suffix:semicolon
)brace
multiline_comment|/* end frv_dma_stop() */
DECL|variable|frv_dma_stop
id|EXPORT_SYMBOL
c_func
(paren
id|frv_dma_stop
)paren
suffix:semicolon
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * test interrupt status of DMA channel&n; */
DECL|function|is_frv_dma_interrupting
r_int
id|is_frv_dma_interrupting
c_func
(paren
r_int
id|dma
)paren
(brace
r_int
r_int
id|ioaddr
op_assign
id|frv_dma_channels
(braket
id|dma
)braket
dot
id|ioaddr
suffix:semicolon
r_return
id|__get_DMAC
c_func
(paren
id|ioaddr
comma
id|CSTR
)paren
op_amp
(paren
l_int|1
op_lshift
l_int|23
)paren
suffix:semicolon
)brace
multiline_comment|/* end is_frv_dma_interrupting() */
DECL|variable|is_frv_dma_interrupting
id|EXPORT_SYMBOL
c_func
(paren
id|is_frv_dma_interrupting
)paren
suffix:semicolon
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * dump data about a DMA channel&n; */
DECL|function|frv_dma_dump
r_void
id|frv_dma_dump
c_func
(paren
r_int
id|dma
)paren
(brace
r_int
r_int
id|ioaddr
op_assign
id|frv_dma_channels
(braket
id|dma
)braket
dot
id|ioaddr
suffix:semicolon
r_int
r_int
id|cstr
comma
id|pix
comma
id|six
comma
id|bcl
suffix:semicolon
id|cstr
op_assign
id|__get_DMAC
c_func
(paren
id|ioaddr
comma
id|CSTR
)paren
suffix:semicolon
id|pix
op_assign
id|__get_DMAC
c_func
(paren
id|ioaddr
comma
id|PIX
)paren
suffix:semicolon
id|six
op_assign
id|__get_DMAC
c_func
(paren
id|ioaddr
comma
id|SIX
)paren
suffix:semicolon
id|bcl
op_assign
id|__get_DMAC
c_func
(paren
id|ioaddr
comma
id|BCL
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;DMA[%d] cstr=%lx pix=%lx six=%lx bcl=%lx&bslash;n&quot;
comma
id|dma
comma
id|cstr
comma
id|pix
comma
id|six
comma
id|bcl
)paren
suffix:semicolon
)brace
multiline_comment|/* end frv_dma_dump() */
DECL|variable|frv_dma_dump
id|EXPORT_SYMBOL
c_func
(paren
id|frv_dma_dump
)paren
suffix:semicolon
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * pause all DMA controllers&n; * - called by clock mangling routines&n; * - caller must be holding interrupts disabled&n; */
DECL|function|frv_dma_pause_all
r_void
id|frv_dma_pause_all
c_func
(paren
r_void
)paren
(brace
r_struct
id|frv_dma_channel
op_star
id|channel
suffix:semicolon
r_int
r_int
id|ioaddr
suffix:semicolon
r_int
r_int
id|cstr
comma
id|cctr
suffix:semicolon
r_int
id|dma
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|frv_dma_channels_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|dma
op_assign
id|FRV_DMA_NCHANS
op_minus
l_int|1
suffix:semicolon
id|dma
op_ge
l_int|0
suffix:semicolon
id|dma
op_decrement
)paren
(brace
id|channel
op_assign
op_amp
id|frv_dma_channels
(braket
id|dma
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|channel-&gt;flags
op_amp
id|FRV_DMA_FLAGS_INUSE
)paren
)paren
r_continue
suffix:semicolon
id|ioaddr
op_assign
id|channel-&gt;ioaddr
suffix:semicolon
id|cctr
op_assign
id|__get_DMAC
c_func
(paren
id|ioaddr
comma
id|CCTR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cctr
op_amp
id|DMAC_CCTRx_ACT
)paren
(brace
id|cctr
op_and_assign
op_complement
id|DMAC_CCTRx_ACT
suffix:semicolon
id|__set_DMAC
c_func
(paren
id|ioaddr
comma
id|CCTR
comma
id|cctr
)paren
suffix:semicolon
r_do
(brace
id|cstr
op_assign
id|__get_DMAC
c_func
(paren
id|ioaddr
comma
id|CSTR
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|cstr
op_amp
id|DMAC_CSTRx_BUSY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cstr
op_amp
id|DMAC_CSTRx_FED
)paren
id|channel-&gt;flags
op_or_assign
id|FRV_DMA_FLAGS_PAUSED
suffix:semicolon
id|frv_clear_dma_inprogress
c_func
(paren
id|dma
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* end frv_dma_pause_all() */
DECL|variable|frv_dma_pause_all
id|EXPORT_SYMBOL
c_func
(paren
id|frv_dma_pause_all
)paren
suffix:semicolon
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * resume paused DMA controllers&n; * - called by clock mangling routines&n; * - caller must be holding interrupts disabled&n; */
DECL|function|frv_dma_resume_all
r_void
id|frv_dma_resume_all
c_func
(paren
r_void
)paren
(brace
r_struct
id|frv_dma_channel
op_star
id|channel
suffix:semicolon
r_int
r_int
id|ioaddr
suffix:semicolon
r_int
r_int
id|cstr
comma
id|cctr
suffix:semicolon
r_int
id|dma
suffix:semicolon
r_for
c_loop
(paren
id|dma
op_assign
id|FRV_DMA_NCHANS
op_minus
l_int|1
suffix:semicolon
id|dma
op_ge
l_int|0
suffix:semicolon
id|dma
op_decrement
)paren
(brace
id|channel
op_assign
op_amp
id|frv_dma_channels
(braket
id|dma
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|channel-&gt;flags
op_amp
id|FRV_DMA_FLAGS_PAUSED
)paren
)paren
r_continue
suffix:semicolon
id|ioaddr
op_assign
id|channel-&gt;ioaddr
suffix:semicolon
id|cstr
op_assign
id|__get_DMAC
c_func
(paren
id|ioaddr
comma
id|CSTR
)paren
suffix:semicolon
id|cstr
op_and_assign
op_complement
(paren
id|DMAC_CSTRx_FED
op_or
id|DMAC_CSTRx_INT
)paren
suffix:semicolon
id|__set_DMAC
c_func
(paren
id|ioaddr
comma
id|CSTR
comma
id|cstr
)paren
suffix:semicolon
id|cctr
op_assign
id|__get_DMAC
c_func
(paren
id|ioaddr
comma
id|CCTR
)paren
suffix:semicolon
id|cctr
op_or_assign
id|DMAC_CCTRx_ACT
suffix:semicolon
id|__set_DMAC
c_func
(paren
id|ioaddr
comma
id|CCTR
comma
id|cctr
)paren
suffix:semicolon
id|channel-&gt;flags
op_and_assign
op_complement
id|FRV_DMA_FLAGS_PAUSED
suffix:semicolon
id|frv_set_dma_inprogress
c_func
(paren
id|dma
)paren
suffix:semicolon
)brace
id|write_unlock
c_func
(paren
op_amp
id|frv_dma_channels_lock
)paren
suffix:semicolon
)brace
multiline_comment|/* end frv_dma_resume_all() */
DECL|variable|frv_dma_resume_all
id|EXPORT_SYMBOL
c_func
(paren
id|frv_dma_resume_all
)paren
suffix:semicolon
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * dma status clear&n; */
DECL|function|frv_dma_status_clear
r_void
id|frv_dma_status_clear
c_func
(paren
r_int
id|dma
)paren
(brace
r_int
r_int
id|ioaddr
op_assign
id|frv_dma_channels
(braket
id|dma
)braket
dot
id|ioaddr
suffix:semicolon
r_uint32
id|cctr
suffix:semicolon
id|___set_DMAC
c_func
(paren
id|ioaddr
comma
id|CSTR
comma
l_int|0
)paren
suffix:semicolon
id|cctr
op_assign
id|__get_DMAC
c_func
(paren
id|ioaddr
comma
id|CCTR
)paren
suffix:semicolon
)brace
multiline_comment|/* end frv_dma_status_clear() */
DECL|variable|frv_dma_status_clear
id|EXPORT_SYMBOL
c_func
(paren
id|frv_dma_status_clear
)paren
suffix:semicolon
eof
