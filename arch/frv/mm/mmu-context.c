multiline_comment|/* mmu-context.c: MMU context allocation and management&n; *&n; * Copyright (C) 2004 Red Hat, Inc. All Rights Reserved.&n; * Written by David Howells (dhowells@redhat.com)&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/tlbflush.h&gt;
DECL|macro|NR_CXN
mdefine_line|#define NR_CXN&t;4096
DECL|variable|cxn_bitmap
r_static
r_int
r_int
id|cxn_bitmap
(braket
id|NR_CXN
op_div
(paren
r_sizeof
(paren
r_int
r_int
)paren
op_star
l_int|8
)paren
)braket
suffix:semicolon
r_static
id|LIST_HEAD
c_func
(paren
id|cxn_owners_lru
)paren
suffix:semicolon
DECL|variable|cxn_owners_lock
r_static
id|spinlock_t
id|cxn_owners_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|cxn_pinned
r_int
id|__nongpreldata
id|cxn_pinned
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * initialise a new context&n; */
DECL|function|init_new_context
r_int
id|init_new_context
c_func
(paren
r_struct
id|task_struct
op_star
id|tsk
comma
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
id|memset
c_func
(paren
op_amp
id|mm-&gt;context
comma
l_int|0
comma
r_sizeof
(paren
id|mm-&gt;context
)paren
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|mm-&gt;context.id_link
)paren
suffix:semicolon
id|mm-&gt;context.itlb_cached_pge
op_assign
l_int|0xffffffffUL
suffix:semicolon
id|mm-&gt;context.dtlb_cached_pge
op_assign
l_int|0xffffffffUL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* end init_new_context() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * make sure a kernel MMU context has a CPU context number&n; * - call with cxn_owners_lock held&n; */
DECL|function|get_cxn
r_static
r_int
id|get_cxn
c_func
(paren
id|mm_context_t
op_star
id|ctx
)paren
(brace
r_struct
id|list_head
op_star
id|_p
suffix:semicolon
id|mm_context_t
op_star
id|p
suffix:semicolon
r_int
id|cxn
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ctx-&gt;id_link
)paren
)paren
(brace
id|list_move_tail
c_func
(paren
op_amp
id|ctx-&gt;id_link
comma
op_amp
id|cxn_owners_lru
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* find the first unallocated context number&n;&t;&t; * - 0 is reserved for the kernel&n;&t;&t; */
id|cxn
op_assign
id|find_next_zero_bit
c_func
(paren
op_amp
id|cxn_bitmap
comma
id|NR_CXN
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cxn
OL
id|NR_CXN
)paren
(brace
id|set_bit
c_func
(paren
id|cxn
comma
op_amp
id|cxn_bitmap
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* none remaining - need to steal someone else&squot;s cxn */
id|p
op_assign
l_int|NULL
suffix:semicolon
id|list_for_each
c_func
(paren
id|_p
comma
op_amp
id|cxn_owners_lru
)paren
(brace
id|p
op_assign
id|list_entry
c_func
(paren
id|_p
comma
id|mm_context_t
comma
id|id_link
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;id_busy
op_logical_and
id|p-&gt;id
op_ne
id|cxn_pinned
)paren
r_break
suffix:semicolon
)brace
id|BUG_ON
c_func
(paren
id|_p
op_eq
op_amp
id|cxn_owners_lru
)paren
suffix:semicolon
id|cxn
op_assign
id|p-&gt;id
suffix:semicolon
id|p-&gt;id
op_assign
l_int|0
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|p-&gt;id_link
)paren
suffix:semicolon
id|__flush_tlb_mm
c_func
(paren
id|cxn
)paren
suffix:semicolon
)brace
id|ctx-&gt;id
op_assign
id|cxn
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ctx-&gt;id_link
comma
op_amp
id|cxn_owners_lru
)paren
suffix:semicolon
)brace
r_return
id|ctx-&gt;id
suffix:semicolon
)brace
multiline_comment|/* end get_cxn() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * restore the current TLB miss handler mapped page tables into the MMU context and set up a&n; * mapping for the page directory&n; */
DECL|function|change_mm_context
r_void
id|change_mm_context
c_func
(paren
id|mm_context_t
op_star
id|old
comma
id|mm_context_t
op_star
id|ctx
comma
id|pgd_t
op_star
id|pgd
)paren
(brace
r_int
r_int
id|_pgd
suffix:semicolon
id|_pgd
op_assign
id|virt_to_phys
c_func
(paren
id|pgd
)paren
suffix:semicolon
multiline_comment|/* save the state of the outgoing MMU context */
id|old-&gt;id_busy
op_assign
l_int|0
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;movsg scr0,%0&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|old-&gt;itlb_cached_pge
)paren
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;movsg dampr4,%0&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|old-&gt;itlb_ptd_mapping
)paren
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;movsg scr1,%0&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|old-&gt;dtlb_cached_pge
)paren
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;movsg dampr5,%0&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|old-&gt;dtlb_ptd_mapping
)paren
)paren
suffix:semicolon
multiline_comment|/* select an MMU context number */
id|spin_lock
c_func
(paren
op_amp
id|cxn_owners_lock
)paren
suffix:semicolon
id|get_cxn
c_func
(paren
id|ctx
)paren
suffix:semicolon
id|ctx-&gt;id_busy
op_assign
l_int|1
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|cxn_owners_lock
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;movgs %0,cxnr&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|ctx-&gt;id
)paren
)paren
suffix:semicolon
multiline_comment|/* restore the state of the incoming MMU context */
id|asm
r_volatile
(paren
l_string|&quot;movgs %0,scr0&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|ctx-&gt;itlb_cached_pge
)paren
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;movgs %0,dampr4&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|ctx-&gt;itlb_ptd_mapping
)paren
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;movgs %0,scr1&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|ctx-&gt;dtlb_cached_pge
)paren
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;movgs %0,dampr5&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|ctx-&gt;dtlb_ptd_mapping
)paren
)paren
suffix:semicolon
multiline_comment|/* map the PGD into uncached virtual memory */
id|asm
r_volatile
(paren
l_string|&quot;movgs %0,ttbr&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|_pgd
)paren
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;movgs %0,dampr3&quot;
op_scope_resolution
l_string|&quot;r&quot;
(paren
id|_pgd
op_or
id|xAMPRx_L
op_or
id|xAMPRx_M
op_or
id|xAMPRx_SS_16Kb
op_or
id|xAMPRx_S
op_or
id|xAMPRx_C
op_or
id|xAMPRx_V
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* end change_mm_context() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * finished with an MMU context number&n; */
DECL|function|destroy_context
r_void
id|destroy_context
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
)paren
(brace
id|mm_context_t
op_star
id|ctx
op_assign
op_amp
id|mm-&gt;context
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|cxn_owners_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ctx-&gt;id_link
)paren
)paren
(brace
r_if
c_cond
(paren
id|ctx-&gt;id
op_eq
id|cxn_pinned
)paren
id|cxn_pinned
op_assign
op_minus
l_int|1
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|ctx-&gt;id_link
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|ctx-&gt;id
comma
op_amp
id|cxn_bitmap
)paren
suffix:semicolon
id|__flush_tlb_mm
c_func
(paren
id|ctx-&gt;id
)paren
suffix:semicolon
id|ctx-&gt;id
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|cxn_owners_lock
)paren
suffix:semicolon
)brace
multiline_comment|/* end destroy_context() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * display the MMU context currently a process is currently using&n; */
macro_line|#ifdef CONFIG_PROC_FS
DECL|function|proc_pid_status_frv_cxnr
r_char
op_star
id|proc_pid_status_frv_cxnr
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_char
op_star
id|buffer
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|cxn_owners_lock
)paren
suffix:semicolon
id|buffer
op_add_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;CXNR: %u&bslash;n&quot;
comma
id|mm-&gt;context.id
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|cxn_owners_lock
)paren
suffix:semicolon
r_return
id|buffer
suffix:semicolon
)brace
multiline_comment|/* end proc_pid_status_frv_cxnr() */
macro_line|#endif
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * (un)pin a process&squot;s mm_struct&squot;s MMU context ID&n; */
DECL|function|cxn_pin_by_pid
r_int
id|cxn_pin_by_pid
c_func
(paren
id|pid_t
id|pid
)paren
(brace
r_struct
id|task_struct
op_star
id|tsk
suffix:semicolon
r_struct
id|mm_struct
op_star
id|mm
op_assign
l_int|NULL
suffix:semicolon
r_int
id|ret
suffix:semicolon
multiline_comment|/* unpin if pid is zero */
r_if
c_cond
(paren
id|pid
op_eq
l_int|0
)paren
(brace
id|cxn_pinned
op_assign
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|ret
op_assign
op_minus
id|ESRCH
suffix:semicolon
multiline_comment|/* get a handle on the mm_struct */
id|read_lock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
id|tsk
op_assign
id|find_task_by_pid
c_func
(paren
id|pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tsk
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|task_lock
c_func
(paren
id|tsk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tsk-&gt;mm
)paren
(brace
id|mm
op_assign
id|tsk-&gt;mm
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|mm-&gt;mm_users
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
id|task_unlock
c_func
(paren
id|tsk
)paren
suffix:semicolon
)brace
id|read_unlock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
multiline_comment|/* make sure it has a CXN and pin it */
id|spin_lock
c_func
(paren
op_amp
id|cxn_owners_lock
)paren
suffix:semicolon
id|cxn_pinned
op_assign
id|get_cxn
c_func
(paren
op_amp
id|mm-&gt;context
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|cxn_owners_lock
)paren
suffix:semicolon
id|mmput
c_func
(paren
id|mm
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* end cxn_pin_by_pid() */
eof
