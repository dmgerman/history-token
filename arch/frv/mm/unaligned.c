multiline_comment|/* unaligned.c: unalignment fixup handler for CPUs on which it is supported (FR451 only)&n; *&n; * Copyright (C) 2004 Red Hat, Inc. All Rights Reserved.&n; * Written by David Howells (dhowells@redhat.com)&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/user.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/linkage.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/setup.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#if 0
mdefine_line|#define kdebug(fmt, ...) printk(&quot;FDPIC &quot;fmt&quot;&bslash;n&quot; ,##__VA_ARGS__ )
macro_line|#else
DECL|macro|kdebug
mdefine_line|#define kdebug(fmt, ...) do {} while(0)
macro_line|#endif
DECL|macro|_MA_SIGNED
mdefine_line|#define _MA_SIGNED&t;0x01
DECL|macro|_MA_HALF
mdefine_line|#define _MA_HALF&t;0x02
DECL|macro|_MA_WORD
mdefine_line|#define _MA_WORD&t;0x04
DECL|macro|_MA_DWORD
mdefine_line|#define _MA_DWORD&t;0x08
DECL|macro|_MA_SZ_MASK
mdefine_line|#define _MA_SZ_MASK&t;0x0e
DECL|macro|_MA_LOAD
mdefine_line|#define _MA_LOAD&t;0x10
DECL|macro|_MA_STORE
mdefine_line|#define _MA_STORE&t;0x20
DECL|macro|_MA_UPDATE
mdefine_line|#define _MA_UPDATE&t;0x40
DECL|macro|_MA_IMM
mdefine_line|#define _MA_IMM&t;&t;0x80
DECL|macro|_MA_LDxU
mdefine_line|#define _MA_LDxU&t;_MA_LOAD | _MA_UPDATE
DECL|macro|_MA_LDxI
mdefine_line|#define _MA_LDxI&t;_MA_LOAD | _MA_IMM
DECL|macro|_MA_STxU
mdefine_line|#define _MA_STxU&t;_MA_STORE | _MA_UPDATE
DECL|macro|_MA_STxI
mdefine_line|#define _MA_STxI&t;_MA_STORE | _MA_IMM
DECL|variable|tbl_LDGRk_reg
r_static
r_const
r_uint8
id|tbl_LDGRk_reg
(braket
l_int|0x40
)braket
op_assign
(brace
(braket
l_int|0x02
)braket
op_assign
id|_MA_LOAD
op_or
id|_MA_HALF
op_or
id|_MA_SIGNED
comma
multiline_comment|/* LDSH  @(GRi,GRj),GRk */
(braket
l_int|0x03
)braket
op_assign
id|_MA_LOAD
op_or
id|_MA_HALF
comma
multiline_comment|/* LDUH  @(GRi,GRj),GRk */
(braket
l_int|0x04
)braket
op_assign
id|_MA_LOAD
op_or
id|_MA_WORD
comma
multiline_comment|/* LD&t; @(GRi,GRj),GRk */
(braket
l_int|0x05
)braket
op_assign
id|_MA_LOAD
op_or
id|_MA_DWORD
comma
multiline_comment|/* LDD&t; @(GRi,GRj),GRk */
(braket
l_int|0x12
)braket
op_assign
id|_MA_LDxU
op_or
id|_MA_HALF
op_or
id|_MA_SIGNED
comma
multiline_comment|/* LDSHU @(GRi,GRj),GRk */
(braket
l_int|0x13
)braket
op_assign
id|_MA_LDxU
op_or
id|_MA_HALF
comma
multiline_comment|/* LDUHU @(GRi,GRj),GRk */
(braket
l_int|0x14
)braket
op_assign
id|_MA_LDxU
op_or
id|_MA_WORD
comma
multiline_comment|/* LDU&t; @(GRi,GRj),GRk */
(braket
l_int|0x15
)braket
op_assign
id|_MA_LDxU
op_or
id|_MA_DWORD
comma
multiline_comment|/* LDDU&t; @(GRi,GRj),GRk */
)brace
suffix:semicolon
DECL|variable|tbl_STGRk_reg
r_static
r_const
r_uint8
id|tbl_STGRk_reg
(braket
l_int|0x40
)braket
op_assign
(brace
(braket
l_int|0x01
)braket
op_assign
id|_MA_STORE
op_or
id|_MA_HALF
comma
multiline_comment|/* STH   @(GRi,GRj),GRk */
(braket
l_int|0x02
)braket
op_assign
id|_MA_STORE
op_or
id|_MA_WORD
comma
multiline_comment|/* ST&t; @(GRi,GRj),GRk */
(braket
l_int|0x03
)braket
op_assign
id|_MA_STORE
op_or
id|_MA_DWORD
comma
multiline_comment|/* STD&t; @(GRi,GRj),GRk */
(braket
l_int|0x11
)braket
op_assign
id|_MA_STxU
op_or
id|_MA_HALF
comma
multiline_comment|/* STHU  @(GRi,GRj),GRk */
(braket
l_int|0x12
)braket
op_assign
id|_MA_STxU
op_or
id|_MA_WORD
comma
multiline_comment|/* STU&t; @(GRi,GRj),GRk */
(braket
l_int|0x13
)braket
op_assign
id|_MA_STxU
op_or
id|_MA_DWORD
comma
multiline_comment|/* STDU&t; @(GRi,GRj),GRk */
)brace
suffix:semicolon
DECL|variable|tbl_LDSTGRk_imm
r_static
r_const
r_uint8
id|tbl_LDSTGRk_imm
(braket
l_int|0x80
)braket
op_assign
(brace
(braket
l_int|0x31
)braket
op_assign
id|_MA_LDxI
op_or
id|_MA_HALF
op_or
id|_MA_SIGNED
comma
multiline_comment|/* LDSHI @(GRi,d12),GRk */
(braket
l_int|0x32
)braket
op_assign
id|_MA_LDxI
op_or
id|_MA_WORD
comma
multiline_comment|/* LDI   @(GRi,d12),GRk */
(braket
l_int|0x33
)braket
op_assign
id|_MA_LDxI
op_or
id|_MA_DWORD
comma
multiline_comment|/* LDDI  @(GRi,d12),GRk */
(braket
l_int|0x36
)braket
op_assign
id|_MA_LDxI
op_or
id|_MA_HALF
comma
multiline_comment|/* LDUHI @(GRi,d12),GRk */
(braket
l_int|0x51
)braket
op_assign
id|_MA_STxI
op_or
id|_MA_HALF
comma
multiline_comment|/* STHI  @(GRi,d12),GRk */
(braket
l_int|0x52
)braket
op_assign
id|_MA_STxI
op_or
id|_MA_WORD
comma
multiline_comment|/* STI   @(GRi,d12),GRk */
(braket
l_int|0x53
)braket
op_assign
id|_MA_STxI
op_or
id|_MA_DWORD
comma
multiline_comment|/* STDI  @(GRi,d12),GRk */
)brace
suffix:semicolon
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * see if we can handle the exception by fixing up a misaligned memory access&n; */
DECL|function|handle_misalignment
r_int
id|handle_misalignment
c_func
(paren
r_int
r_int
id|esr0
comma
r_int
r_int
id|ear0
comma
r_int
r_int
id|epcr0
)paren
(brace
r_int
r_int
id|insn
comma
id|addr
comma
op_star
id|greg
suffix:semicolon
r_int
id|GRi
comma
id|GRj
comma
id|GRk
comma
id|D12
comma
id|op
suffix:semicolon
r_union
(brace
r_uint64
id|_64
suffix:semicolon
r_uint32
id|_32
(braket
l_int|2
)braket
suffix:semicolon
r_uint16
id|_16
suffix:semicolon
r_uint8
id|_8
(braket
l_int|8
)braket
suffix:semicolon
)brace
id|x
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|esr0
op_amp
id|ESR0_EAV
)paren
op_logical_or
op_logical_neg
(paren
id|epcr0
op_amp
id|EPCR0_V
)paren
op_logical_or
op_logical_neg
(paren
id|ear0
op_amp
l_int|7
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|epcr0
op_and_assign
id|EPCR0_PC
suffix:semicolon
r_if
c_cond
(paren
id|__frame-&gt;pc
op_ne
id|epcr0
)paren
(brace
id|kdebug
c_func
(paren
l_string|&quot;MISALIGN: Execution not halted on excepting instruction&bslash;n&quot;
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|__get_user
c_func
(paren
id|insn
comma
(paren
r_int
r_int
op_star
)paren
id|epcr0
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* determine the instruction type first */
r_switch
c_cond
(paren
(paren
id|insn
op_rshift
l_int|18
)paren
op_amp
l_int|0x7f
)paren
(brace
r_case
l_int|0x2
suffix:colon
multiline_comment|/* LDx @(GRi,GRj),GRk */
id|op
op_assign
id|tbl_LDGRk_reg
(braket
(paren
id|insn
op_rshift
l_int|6
)paren
op_amp
l_int|0x3f
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x3
suffix:colon
multiline_comment|/* STx GRk,@(GRi,GRj) */
id|op
op_assign
id|tbl_STGRk_reg
(braket
(paren
id|insn
op_rshift
l_int|6
)paren
op_amp
l_int|0x3f
)braket
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|op
op_assign
id|tbl_LDSTGRk_imm
(braket
(paren
id|insn
op_rshift
l_int|18
)paren
op_amp
l_int|0x7f
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|op
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|kdebug
c_func
(paren
l_string|&quot;MISALIGN: pc=%08lx insn=%08lx ad=%08lx op=%02x&bslash;n&quot;
comma
id|epcr0
comma
id|insn
comma
id|ear0
comma
id|op
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|x
comma
l_int|0xba
comma
l_int|8
)paren
suffix:semicolon
multiline_comment|/* validate the instruction parameters */
id|greg
op_assign
(paren
r_int
r_int
op_star
)paren
op_amp
id|__frame-&gt;tbr
suffix:semicolon
id|GRi
op_assign
(paren
id|insn
op_rshift
l_int|12
)paren
op_amp
l_int|0x3f
suffix:semicolon
id|GRk
op_assign
(paren
id|insn
op_rshift
l_int|25
)paren
op_amp
l_int|0x3f
suffix:semicolon
r_if
c_cond
(paren
id|GRi
OG
l_int|31
op_logical_or
id|GRk
OG
l_int|31
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
id|op
op_amp
id|_MA_DWORD
op_logical_and
id|GRk
op_amp
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|op
op_amp
id|_MA_IMM
)paren
(brace
id|D12
op_assign
id|insn
op_amp
l_int|0xfff
suffix:semicolon
id|asm
(paren
l_string|&quot;slli %0,#20,%0 ! srai %0,#20,%0&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|D12
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|D12
)paren
)paren
suffix:semicolon
multiline_comment|/* sign extend */
id|addr
op_assign
(paren
id|GRi
ques
c_cond
id|greg
(braket
id|GRi
)braket
suffix:colon
l_int|0
)paren
op_plus
id|D12
suffix:semicolon
)brace
r_else
(brace
id|GRj
op_assign
(paren
id|insn
op_rshift
l_int|0
)paren
op_amp
l_int|0x3f
suffix:semicolon
r_if
c_cond
(paren
id|GRj
OG
l_int|31
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
id|addr
op_assign
(paren
id|GRi
ques
c_cond
id|greg
(braket
id|GRi
)braket
suffix:colon
l_int|0
)paren
op_plus
(paren
id|GRj
ques
c_cond
id|greg
(braket
id|GRj
)braket
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|addr
op_ne
id|ear0
)paren
(brace
id|kdebug
c_func
(paren
l_string|&quot;MISALIGN: Calculated addr (%08lx) does not match EAR0 (%08lx)&bslash;n&quot;
comma
id|addr
comma
id|ear0
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* check the address is okay */
r_if
c_cond
(paren
id|user_mode
c_func
(paren
id|__frame
)paren
op_logical_and
id|___range_ok
c_func
(paren
id|ear0
comma
l_int|8
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* perform the memory op */
r_if
c_cond
(paren
id|op
op_amp
id|_MA_STORE
)paren
(brace
multiline_comment|/* perform a store */
id|x._32
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|GRk
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|op
op_amp
id|_MA_HALF
)paren
(brace
id|x._16
op_assign
id|greg
(braket
id|GRk
)braket
suffix:semicolon
)brace
r_else
(brace
id|x._32
(braket
l_int|0
)braket
op_assign
id|greg
(braket
id|GRk
)braket
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|op
op_amp
id|_MA_DWORD
)paren
id|x._32
(braket
l_int|1
)braket
op_assign
id|greg
(braket
id|GRk
op_plus
l_int|1
)braket
suffix:semicolon
id|kdebug
c_func
(paren
l_string|&quot;MISALIGN: Store GR%d { %08x:%08x } -&gt; %08lx (%dB)&bslash;n&quot;
comma
id|GRk
comma
id|x._32
(braket
l_int|1
)braket
comma
id|x._32
(braket
l_int|0
)braket
comma
id|addr
comma
id|op
op_amp
id|_MA_SZ_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|__memcpy_user
c_func
(paren
(paren
r_void
op_star
)paren
id|addr
comma
op_amp
id|x
comma
id|op
op_amp
id|_MA_SZ_MASK
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* perform a load */
r_if
c_cond
(paren
id|__memcpy_user
c_func
(paren
op_amp
id|x
comma
(paren
r_void
op_star
)paren
id|addr
comma
id|op
op_amp
id|_MA_SZ_MASK
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|op
op_amp
id|_MA_HALF
)paren
(brace
r_if
c_cond
(paren
id|op
op_amp
id|_MA_SIGNED
)paren
id|asm
(paren
l_string|&quot;slli %0,#16,%0 ! srai %0,#16,%0&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|x._32
(braket
l_int|0
)braket
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|x._16
)paren
)paren
suffix:semicolon
r_else
id|asm
(paren
l_string|&quot;sethi #0,%0&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|x._32
(braket
l_int|0
)braket
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|x._16
)paren
)paren
suffix:semicolon
)brace
id|kdebug
c_func
(paren
l_string|&quot;MISALIGN: Load %08lx (%dB) -&gt; GR%d, { %08x:%08x }&bslash;n&quot;
comma
id|addr
comma
id|op
op_amp
id|_MA_SZ_MASK
comma
id|GRk
comma
id|x._32
(braket
l_int|1
)braket
comma
id|x._32
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|GRk
op_ne
l_int|0
)paren
id|greg
(braket
id|GRk
)braket
op_assign
id|x._32
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|op
op_amp
id|_MA_DWORD
)paren
id|greg
(braket
id|GRk
op_plus
l_int|1
)braket
op_assign
id|x._32
(braket
l_int|1
)braket
suffix:semicolon
)brace
multiline_comment|/* update the base pointer if required */
r_if
c_cond
(paren
id|op
op_amp
id|_MA_UPDATE
)paren
id|greg
(braket
id|GRi
)braket
op_assign
id|addr
suffix:semicolon
multiline_comment|/* well... we&squot;ve done that insn */
id|__frame-&gt;pc
op_assign
id|__frame-&gt;pc
op_plus
l_int|4
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* end handle_misalignment() */
eof
