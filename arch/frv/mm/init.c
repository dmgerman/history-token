multiline_comment|/* init.c: memory initialisation for FRV&n; *&n; * Copyright (C) 2004 Red Hat, Inc. All Rights Reserved.&n; * Written by David Howells (dhowells@redhat.com)&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; *&n; * Derived from:&n; *  - linux/arch/m68knommu/mm/init.c&n; *    - Copyright (C) 1998  D. Jeff Dionne &lt;jeff@lineo.ca&gt;, Kenneth Albanowski &lt;kjahds@kjahds.com&gt;,&n; *    - Copyright (C) 2000  Lineo, Inc.  (www.lineo.com)&n; *  - linux/arch/m68k/mm/init.c&n; *    - Copyright (C) 1995  Hamish Macdonald&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;linux/swap.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;linux/highmem.h&gt;
macro_line|#include &lt;asm/setup.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/mmu_context.h&gt;
macro_line|#include &lt;asm/virtconvert.h&gt;
macro_line|#include &lt;asm/sections.h&gt;
macro_line|#include &lt;asm/tlb.h&gt;
DECL|macro|DEBUG
macro_line|#undef DEBUG
id|DEFINE_PER_CPU
c_func
(paren
r_struct
id|mmu_gather
comma
id|mmu_gathers
)paren
suffix:semicolon
multiline_comment|/*&n; * BAD_PAGE is the page that is used for page faults when linux&n; * is out-of-memory. Older versions of linux just did a&n; * do_exit(), but using this instead means there is less risk&n; * for a process dying in kernel mode, possibly leaving a inode&n; * unused etc..&n; *&n; * BAD_PAGETABLE is the accompanying page-table: it is initialized&n; * to point to BAD_PAGE entries.&n; *&n; * ZERO_PAGE is a special page that is used for zero-initialized&n; * data and COW.&n; */
DECL|variable|empty_bad_page_table
r_static
r_int
r_int
id|empty_bad_page_table
suffix:semicolon
DECL|variable|empty_bad_page
r_static
r_int
r_int
id|empty_bad_page
suffix:semicolon
DECL|variable|empty_zero_page
r_int
r_int
id|empty_zero_page
suffix:semicolon
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&n; */
DECL|function|show_mem
r_void
id|show_mem
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
r_int
id|free
op_assign
l_int|0
comma
id|total
op_assign
l_int|0
comma
id|reserved
op_assign
l_int|0
comma
id|shared
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;nMem-info:&bslash;n&quot;
)paren
suffix:semicolon
id|show_free_areas
c_func
(paren
)paren
suffix:semicolon
id|i
op_assign
id|max_mapnr
suffix:semicolon
r_while
c_loop
(paren
id|i
op_decrement
OG
l_int|0
)paren
(brace
r_struct
id|page
op_star
id|page
op_assign
op_amp
id|mem_map
(braket
id|i
)braket
suffix:semicolon
id|total
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|PageReserved
c_func
(paren
id|page
)paren
)paren
id|reserved
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|page_count
c_func
(paren
id|page
)paren
)paren
id|free
op_increment
suffix:semicolon
r_else
id|shared
op_add_assign
id|page_count
c_func
(paren
id|page
)paren
op_minus
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%d pages of RAM&bslash;n&quot;
comma
id|total
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%d free pages&bslash;n&quot;
comma
id|free
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%d reserved pages&bslash;n&quot;
comma
id|reserved
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%d pages shared&bslash;n&quot;
comma
id|shared
)paren
suffix:semicolon
)brace
multiline_comment|/* end show_mem() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * paging_init() continues the virtual memory environment setup which&n; * was begun by the code in arch/head.S.&n; * The parameters are pointers to where to stick the starting and ending&n; * addresses  of available kernel virtual memory.&n; */
DECL|function|paging_init
r_void
id|__init
id|paging_init
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|zones_size
(braket
id|MAX_NR_ZONES
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/* allocate some pages for kernel housekeeping tasks */
id|empty_bad_page_table
op_assign
(paren
r_int
r_int
)paren
id|alloc_bootmem_pages
c_func
(paren
id|PAGE_SIZE
)paren
suffix:semicolon
id|empty_bad_page
op_assign
(paren
r_int
r_int
)paren
id|alloc_bootmem_pages
c_func
(paren
id|PAGE_SIZE
)paren
suffix:semicolon
id|empty_zero_page
op_assign
(paren
r_int
r_int
)paren
id|alloc_bootmem_pages
c_func
(paren
id|PAGE_SIZE
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|empty_zero_page
comma
l_int|0
comma
id|PAGE_SIZE
)paren
suffix:semicolon
macro_line|#if CONFIG_HIGHMEM
r_if
c_cond
(paren
id|num_physpages
op_minus
id|num_mappedpages
)paren
(brace
id|pgd_t
op_star
id|pge
suffix:semicolon
id|pmd_t
op_star
id|pme
suffix:semicolon
id|pkmap_page_table
op_assign
id|alloc_bootmem_pages
c_func
(paren
id|PAGE_SIZE
)paren
suffix:semicolon
id|memset
c_func
(paren
id|pkmap_page_table
comma
l_int|0
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|pge
op_assign
id|swapper_pg_dir
op_plus
id|pgd_index_k
c_func
(paren
id|PKMAP_BASE
)paren
suffix:semicolon
id|pme
op_assign
id|pmd_offset
c_func
(paren
id|pge
comma
id|PKMAP_BASE
)paren
suffix:semicolon
id|__set_pmd
c_func
(paren
id|pme
comma
id|virt_to_phys
c_func
(paren
id|pkmap_page_table
)paren
op_or
id|_PAGE_TABLE
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* distribute the allocatable pages across the various zones and pass them to the allocator&n;&t; */
id|zones_size
(braket
id|ZONE_DMA
)braket
op_assign
id|max_low_pfn
op_minus
id|min_low_pfn
suffix:semicolon
id|zones_size
(braket
id|ZONE_NORMAL
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_HIGHMEM
id|zones_size
(braket
id|ZONE_HIGHMEM
)braket
op_assign
id|num_physpages
op_minus
id|num_mappedpages
suffix:semicolon
macro_line|#endif
id|free_area_init
c_func
(paren
id|zones_size
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_MMU
multiline_comment|/* high memory (if present) starts after the last mapped page&n;&t; * - this is used by kmap()&n;&t; */
id|highmem_start_page
op_assign
id|mem_map
op_plus
id|num_mappedpages
suffix:semicolon
multiline_comment|/* initialise init&squot;s MMU context */
id|init_new_context
c_func
(paren
op_amp
id|init_task
comma
op_amp
id|init_mm
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* end paging_init() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *&n; */
DECL|function|mem_init
r_void
id|__init
id|mem_init
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|npages
op_assign
(paren
id|memory_end
op_minus
id|memory_start
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
r_int
r_int
id|tmp
suffix:semicolon
macro_line|#ifdef CONFIG_MMU
r_int
r_int
id|loop
comma
id|pfn
suffix:semicolon
r_int
id|datapages
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_int
id|codek
op_assign
l_int|0
comma
id|datak
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* this will put all memory onto the freelists */
id|totalram_pages
op_assign
id|free_all_bootmem
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_MMU
r_for
c_loop
(paren
id|loop
op_assign
l_int|0
suffix:semicolon
id|loop
OL
id|npages
suffix:semicolon
id|loop
op_increment
)paren
r_if
c_cond
(paren
id|PageReserved
c_func
(paren
op_amp
id|mem_map
(braket
id|loop
)braket
)paren
)paren
id|datapages
op_increment
suffix:semicolon
macro_line|#ifdef CONFIG_HIGHMEM
r_for
c_loop
(paren
id|pfn
op_assign
id|num_physpages
op_minus
l_int|1
suffix:semicolon
id|pfn
op_ge
id|num_mappedpages
suffix:semicolon
id|pfn
op_decrement
)paren
(brace
r_struct
id|page
op_star
id|page
op_assign
op_amp
id|mem_map
(braket
id|pfn
)braket
suffix:semicolon
id|ClearPageReserved
c_func
(paren
id|page
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|PG_highmem
comma
op_amp
id|page-&gt;flags
)paren
suffix:semicolon
id|set_page_count
c_func
(paren
id|page
comma
l_int|1
)paren
suffix:semicolon
id|__free_page
c_func
(paren
id|page
)paren
suffix:semicolon
id|totalram_pages
op_increment
suffix:semicolon
)brace
macro_line|#endif
id|codek
op_assign
(paren
(paren
r_int
r_int
)paren
op_amp
id|_etext
op_minus
(paren
r_int
r_int
)paren
op_amp
id|_stext
)paren
op_rshift
l_int|10
suffix:semicolon
id|datak
op_assign
id|datapages
op_lshift
(paren
id|PAGE_SHIFT
op_minus
l_int|10
)paren
suffix:semicolon
macro_line|#else
id|codek
op_assign
(paren
id|_etext
op_minus
id|_stext
)paren
op_rshift
l_int|10
suffix:semicolon
id|datak
op_assign
l_int|0
suffix:semicolon
singleline_comment|//(_ebss - _sdata) &gt;&gt; 10;
macro_line|#endif
id|tmp
op_assign
id|nr_free_pages
c_func
(paren
)paren
op_lshift
id|PAGE_SHIFT
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Memory available: %luKiB/%luKiB RAM, %luKiB/%luKiB ROM (%dKiB kernel code, %dKiB data)&bslash;n&quot;
comma
id|tmp
op_rshift
l_int|10
comma
id|npages
op_lshift
(paren
id|PAGE_SHIFT
op_minus
l_int|10
)paren
comma
(paren
id|rom_length
OG
l_int|0
)paren
ques
c_cond
(paren
(paren
id|rom_length
op_rshift
l_int|10
)paren
op_minus
id|codek
)paren
suffix:colon
l_int|0
comma
id|rom_length
op_rshift
l_int|10
comma
id|codek
comma
id|datak
)paren
suffix:semicolon
)brace
multiline_comment|/* end mem_init() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * free the memory that was only required for initialisation&n; */
DECL|function|free_initmem
r_void
id|__init
id|free_initmem
c_func
(paren
r_void
)paren
(brace
macro_line|#if defined(CONFIG_RAMKERNEL) &amp;&amp; !defined(CONFIG_PROTECT_KERNEL)
r_int
r_int
id|start
comma
id|end
comma
id|addr
suffix:semicolon
id|start
op_assign
id|PAGE_ALIGN
c_func
(paren
(paren
r_int
r_int
)paren
op_amp
id|__init_begin
)paren
suffix:semicolon
multiline_comment|/* round up */
id|end
op_assign
(paren
(paren
r_int
r_int
)paren
op_amp
id|__init_end
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
multiline_comment|/* round down */
multiline_comment|/* next to check that the page we free is not a partial page */
r_for
c_loop
(paren
id|addr
op_assign
id|start
suffix:semicolon
id|addr
OL
id|end
suffix:semicolon
id|addr
op_add_assign
id|PAGE_SIZE
)paren
(brace
id|ClearPageReserved
c_func
(paren
id|virt_to_page
c_func
(paren
id|addr
)paren
)paren
suffix:semicolon
id|set_page_count
c_func
(paren
id|virt_to_page
c_func
(paren
id|addr
)paren
comma
l_int|1
)paren
suffix:semicolon
id|free_page
c_func
(paren
id|addr
)paren
suffix:semicolon
id|totalram_pages
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;Freeing unused kernel memory: %ldKiB freed (0x%lx - 0x%lx)&bslash;n&quot;
comma
(paren
id|end
op_minus
id|start
)paren
op_rshift
l_int|10
comma
id|start
comma
id|end
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* end free_initmem() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * free the initial ramdisk memory&n; */
macro_line|#ifdef CONFIG_BLK_DEV_INITRD
DECL|function|free_initrd_mem
r_void
id|__init
id|free_initrd_mem
c_func
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
r_int
id|pages
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|start
OL
id|end
suffix:semicolon
id|start
op_add_assign
id|PAGE_SIZE
)paren
(brace
id|ClearPageReserved
c_func
(paren
id|virt_to_page
c_func
(paren
id|start
)paren
)paren
suffix:semicolon
id|set_page_count
c_func
(paren
id|virt_to_page
c_func
(paren
id|start
)paren
comma
l_int|1
)paren
suffix:semicolon
id|free_page
c_func
(paren
id|start
)paren
suffix:semicolon
id|totalram_pages
op_increment
suffix:semicolon
id|pages
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;Freeing initrd memory: %dKiB freed&bslash;n&quot;
comma
(paren
id|pages
op_star
id|PAGE_SIZE
)paren
op_rshift
l_int|10
)paren
suffix:semicolon
)brace
multiline_comment|/* end free_initrd_mem() */
macro_line|#endif
eof
