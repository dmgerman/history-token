multiline_comment|/*&n; * arch/s390/appldata/appldata_os.c&n; *&n; * Data gathering module for Linux-VM Monitor Stream, Stage 1.&n; * Collects misc. OS related data (CPU utilization, running processes).&n; *&n; * Copyright (C) 2003 IBM Corporation, IBM Deutschland Entwicklung GmbH.&n; *&n; * Author: Gerald Schaefer &lt;geraldsc@de.ibm.com&gt;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel_stat.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/smp.h&gt;
macro_line|#include &quot;appldata.h&quot;
DECL|macro|MY_PRINT_NAME
mdefine_line|#define MY_PRINT_NAME&t;&quot;appldata_os&quot;&t;&t;/* for debug messages, etc. */
DECL|macro|LOAD_INT
mdefine_line|#define LOAD_INT(x) ((x) &gt;&gt; FSHIFT)
DECL|macro|LOAD_FRAC
mdefine_line|#define LOAD_FRAC(x) LOAD_INT(((x) &amp; (FIXED_1-1)) * 100)
multiline_comment|/*&n; * OS data&n; *&n; * This is accessed as binary data by z/VM. If changes to it can&squot;t be avoided,&n; * the structure version (product ID, see appldata_base.c) needs to be changed&n; * as well and all documentation and z/VM applications using it must be&n; * updated.&n; *&n; * The record layout is documented in the Linux for zSeries Device Drivers&n; * book:&n; * http://oss.software.ibm.com/developerworks/opensource/linux390/index.shtml&n; */
DECL|struct|appldata_os_per_cpu
r_struct
id|appldata_os_per_cpu
(brace
DECL|member|per_cpu_user
id|u32
id|per_cpu_user
suffix:semicolon
multiline_comment|/* timer ticks spent in user mode   */
DECL|member|per_cpu_nice
id|u32
id|per_cpu_nice
suffix:semicolon
multiline_comment|/* ... spent with modified priority */
DECL|member|per_cpu_system
id|u32
id|per_cpu_system
suffix:semicolon
multiline_comment|/* ... spent in kernel mode         */
DECL|member|per_cpu_idle
id|u32
id|per_cpu_idle
suffix:semicolon
multiline_comment|/* ... spent in idle mode           */
singleline_comment|// New in 2.6 --&gt;
DECL|member|per_cpu_irq
id|u32
id|per_cpu_irq
suffix:semicolon
multiline_comment|/* ... spent in interrupts          */
DECL|member|per_cpu_softirq
id|u32
id|per_cpu_softirq
suffix:semicolon
multiline_comment|/* ... spent in softirqs            */
DECL|member|per_cpu_iowait
id|u32
id|per_cpu_iowait
suffix:semicolon
multiline_comment|/* ... spent while waiting for I/O  */
singleline_comment|// &lt;-- New in 2.6
)brace
suffix:semicolon
DECL|struct|appldata_os_data
r_struct
id|appldata_os_data
(brace
DECL|member|timestamp
id|u64
id|timestamp
suffix:semicolon
DECL|member|sync_count_1
id|u32
id|sync_count_1
suffix:semicolon
multiline_comment|/* after VM collected the record data, */
DECL|member|sync_count_2
id|u32
id|sync_count_2
suffix:semicolon
multiline_comment|/* sync_count_1 and sync_count_2 should be the&n;&t;&t;&t;&t;   same. If not, the record has been updated on&n;&t;&t;&t;&t;   the Linux side while VM was collecting the&n;&t;&t;&t;&t;   (possibly corrupt) data */
DECL|member|nr_cpus
id|u32
id|nr_cpus
suffix:semicolon
multiline_comment|/* number of (virtual) CPUs        */
DECL|member|per_cpu_size
id|u32
id|per_cpu_size
suffix:semicolon
multiline_comment|/* size of the per-cpu data struct */
DECL|member|cpu_offset
id|u32
id|cpu_offset
suffix:semicolon
multiline_comment|/* offset of the first per-cpu data struct */
DECL|member|nr_running
id|u32
id|nr_running
suffix:semicolon
multiline_comment|/* number of runnable threads      */
DECL|member|nr_threads
id|u32
id|nr_threads
suffix:semicolon
multiline_comment|/* number of threads               */
DECL|member|avenrun
id|u32
id|avenrun
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* average nr. of running processes during */
multiline_comment|/* the last 1, 5 and 15 minutes */
singleline_comment|// New in 2.6 --&gt;
DECL|member|nr_iowait
id|u32
id|nr_iowait
suffix:semicolon
multiline_comment|/* number of blocked threads&n;&t;&t;&t;&t;   (waiting for I/O)               */
singleline_comment|// &lt;-- New in 2.6
multiline_comment|/* per cpu data */
DECL|member|os_cpu
r_struct
id|appldata_os_per_cpu
id|os_cpu
(braket
l_int|0
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|appldata_os_data
r_static
r_struct
id|appldata_os_data
op_star
id|appldata_os_data
suffix:semicolon
DECL|function|appldata_print_debug
r_static
r_inline
r_void
id|appldata_print_debug
c_func
(paren
r_struct
id|appldata_os_data
op_star
id|os_data
)paren
(brace
r_int
id|a0
comma
id|a1
comma
id|a2
comma
id|i
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;--- OS - RECORD ---&bslash;n&quot;
)paren
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;nr_threads   = %u&bslash;n&quot;
comma
id|os_data-&gt;nr_threads
)paren
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;nr_running   = %u&bslash;n&quot;
comma
id|os_data-&gt;nr_running
)paren
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;nr_iowait    = %u&bslash;n&quot;
comma
id|os_data-&gt;nr_iowait
)paren
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;avenrun(int) = %8x / %8x / %8x&bslash;n&quot;
comma
id|os_data-&gt;avenrun
(braket
l_int|0
)braket
comma
id|os_data-&gt;avenrun
(braket
l_int|1
)braket
comma
id|os_data-&gt;avenrun
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|a0
op_assign
id|os_data-&gt;avenrun
(braket
l_int|0
)braket
suffix:semicolon
id|a1
op_assign
id|os_data-&gt;avenrun
(braket
l_int|1
)braket
suffix:semicolon
id|a2
op_assign
id|os_data-&gt;avenrun
(braket
l_int|2
)braket
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;avenrun(float) = %d.%02d / %d.%02d / %d.%02d&bslash;n&quot;
comma
id|LOAD_INT
c_func
(paren
id|a0
)paren
comma
id|LOAD_FRAC
c_func
(paren
id|a0
)paren
comma
id|LOAD_INT
c_func
(paren
id|a1
)paren
comma
id|LOAD_FRAC
c_func
(paren
id|a1
)paren
comma
id|LOAD_INT
c_func
(paren
id|a2
)paren
comma
id|LOAD_FRAC
c_func
(paren
id|a2
)paren
)paren
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;nr_cpus = %u&bslash;n&quot;
comma
id|os_data-&gt;nr_cpus
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|os_data-&gt;nr_cpus
suffix:semicolon
id|i
op_increment
)paren
(brace
id|P_DEBUG
c_func
(paren
l_string|&quot;cpu%u : user = %u, nice = %u, system = %u, &quot;
l_string|&quot;idle = %u, irq = %u, softirq = %u, iowait = %u&bslash;n&quot;
comma
id|i
comma
id|os_data-&gt;os_cpu
(braket
id|i
)braket
dot
id|per_cpu_user
comma
id|os_data-&gt;os_cpu
(braket
id|i
)braket
dot
id|per_cpu_nice
comma
id|os_data-&gt;os_cpu
(braket
id|i
)braket
dot
id|per_cpu_system
comma
id|os_data-&gt;os_cpu
(braket
id|i
)braket
dot
id|per_cpu_idle
comma
id|os_data-&gt;os_cpu
(braket
id|i
)braket
dot
id|per_cpu_irq
comma
id|os_data-&gt;os_cpu
(braket
id|i
)braket
dot
id|per_cpu_softirq
comma
id|os_data-&gt;os_cpu
(braket
id|i
)braket
dot
id|per_cpu_iowait
)paren
suffix:semicolon
)brace
id|P_DEBUG
c_func
(paren
l_string|&quot;sync_count_1 = %u&bslash;n&quot;
comma
id|os_data-&gt;sync_count_1
)paren
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;sync_count_2 = %u&bslash;n&quot;
comma
id|os_data-&gt;sync_count_2
)paren
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;timestamp    = %lX&bslash;n&quot;
comma
id|os_data-&gt;timestamp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * appldata_get_os_data()&n; *&n; * gather OS data&n; */
DECL|function|appldata_get_os_data
r_static
r_void
id|appldata_get_os_data
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_struct
id|appldata_os_data
op_star
id|os_data
suffix:semicolon
id|os_data
op_assign
id|data
suffix:semicolon
id|os_data-&gt;sync_count_1
op_increment
suffix:semicolon
id|os_data-&gt;nr_cpus
op_assign
id|num_online_cpus
c_func
(paren
)paren
suffix:semicolon
id|os_data-&gt;nr_threads
op_assign
id|nr_threads
suffix:semicolon
id|os_data-&gt;nr_running
op_assign
id|nr_running
c_func
(paren
)paren
suffix:semicolon
id|os_data-&gt;nr_iowait
op_assign
id|nr_iowait
c_func
(paren
)paren
suffix:semicolon
id|os_data-&gt;avenrun
(braket
l_int|0
)braket
op_assign
id|avenrun
(braket
l_int|0
)braket
op_plus
(paren
id|FIXED_1
op_div
l_int|200
)paren
suffix:semicolon
id|os_data-&gt;avenrun
(braket
l_int|1
)braket
op_assign
id|avenrun
(braket
l_int|1
)braket
op_plus
(paren
id|FIXED_1
op_div
l_int|200
)paren
suffix:semicolon
id|os_data-&gt;avenrun
(braket
l_int|2
)braket
op_assign
id|avenrun
(braket
l_int|2
)braket
op_plus
(paren
id|FIXED_1
op_div
l_int|200
)paren
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
id|for_each_online_cpu
c_func
(paren
id|i
)paren
(brace
id|os_data-&gt;os_cpu
(braket
id|j
)braket
dot
id|per_cpu_user
op_assign
id|kstat_cpu
c_func
(paren
id|i
)paren
dot
id|cpustat.user
suffix:semicolon
id|os_data-&gt;os_cpu
(braket
id|j
)braket
dot
id|per_cpu_nice
op_assign
id|kstat_cpu
c_func
(paren
id|i
)paren
dot
id|cpustat.nice
suffix:semicolon
id|os_data-&gt;os_cpu
(braket
id|j
)braket
dot
id|per_cpu_system
op_assign
id|kstat_cpu
c_func
(paren
id|i
)paren
dot
id|cpustat.system
suffix:semicolon
id|os_data-&gt;os_cpu
(braket
id|j
)braket
dot
id|per_cpu_idle
op_assign
id|kstat_cpu
c_func
(paren
id|i
)paren
dot
id|cpustat.idle
suffix:semicolon
id|os_data-&gt;os_cpu
(braket
id|j
)braket
dot
id|per_cpu_irq
op_assign
id|kstat_cpu
c_func
(paren
id|i
)paren
dot
id|cpustat.irq
suffix:semicolon
id|os_data-&gt;os_cpu
(braket
id|j
)braket
dot
id|per_cpu_softirq
op_assign
id|kstat_cpu
c_func
(paren
id|i
)paren
dot
id|cpustat.softirq
suffix:semicolon
id|os_data-&gt;os_cpu
(braket
id|j
)braket
dot
id|per_cpu_iowait
op_assign
id|kstat_cpu
c_func
(paren
id|i
)paren
dot
id|cpustat.iowait
suffix:semicolon
id|j
op_increment
suffix:semicolon
)brace
id|os_data-&gt;timestamp
op_assign
id|get_clock
c_func
(paren
)paren
suffix:semicolon
id|os_data-&gt;sync_count_2
op_increment
suffix:semicolon
macro_line|#ifdef APPLDATA_DEBUG
id|appldata_print_debug
c_func
(paren
id|os_data
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|variable|ops
r_static
r_struct
id|appldata_ops
id|ops
op_assign
(brace
dot
id|ctl_nr
op_assign
id|CTL_APPLDATA_OS
comma
dot
id|name
op_assign
l_string|&quot;os&quot;
comma
dot
id|record_nr
op_assign
id|APPLDATA_RECORD_OS_ID
comma
dot
id|callback
op_assign
op_amp
id|appldata_get_os_data
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * appldata_os_init()&n; *&n; * init data, register ops&n; */
DECL|function|appldata_os_init
r_static
r_int
id|__init
id|appldata_os_init
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
comma
id|size
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
r_struct
id|appldata_os_data
)paren
op_plus
(paren
id|NR_CPUS
op_star
r_sizeof
(paren
r_struct
id|appldata_os_per_cpu
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|APPLDATA_MAX_REC_SIZE
)paren
(brace
id|P_ERROR
c_func
(paren
l_string|&quot;Size of record = %i, bigger than maximum (%i)!&bslash;n&quot;
comma
id|size
comma
id|APPLDATA_MAX_REC_SIZE
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|P_DEBUG
c_func
(paren
l_string|&quot;sizeof(os) = %i, sizeof(os_cpu) = %lu&bslash;n&quot;
comma
id|size
comma
r_sizeof
(paren
r_struct
id|appldata_os_per_cpu
)paren
)paren
suffix:semicolon
id|appldata_os_data
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|appldata_os_data
op_eq
l_int|NULL
)paren
(brace
id|P_ERROR
c_func
(paren
l_string|&quot;No memory for %s!&bslash;n&quot;
comma
id|ops.name
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memset
c_func
(paren
id|appldata_os_data
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
id|appldata_os_data-&gt;per_cpu_size
op_assign
r_sizeof
(paren
r_struct
id|appldata_os_per_cpu
)paren
suffix:semicolon
id|appldata_os_data-&gt;cpu_offset
op_assign
m_offsetof
(paren
r_struct
id|appldata_os_data
comma
id|os_cpu
)paren
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;cpu offset = %u&bslash;n&quot;
comma
id|appldata_os_data-&gt;cpu_offset
)paren
suffix:semicolon
id|ops.data
op_assign
id|appldata_os_data
suffix:semicolon
id|ops.size
op_assign
id|size
suffix:semicolon
id|rc
op_assign
id|appldata_register_ops
c_func
(paren
op_amp
id|ops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|P_ERROR
c_func
(paren
l_string|&quot;Error registering ops, rc = %i&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|appldata_os_data
)paren
suffix:semicolon
)brace
r_else
(brace
id|P_DEBUG
c_func
(paren
l_string|&quot;%s-ops registered!&bslash;n&quot;
comma
id|ops.name
)paren
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * appldata_os_exit()&n; *&n; * unregister ops&n; */
DECL|function|appldata_os_exit
r_static
r_void
id|__exit
id|appldata_os_exit
c_func
(paren
r_void
)paren
(brace
id|appldata_unregister_ops
c_func
(paren
op_amp
id|ops
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|appldata_os_data
)paren
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;%s-ops unregistered!&bslash;n&quot;
comma
id|ops.name
)paren
suffix:semicolon
)brace
DECL|variable|appldata_os_init
id|module_init
c_func
(paren
id|appldata_os_init
)paren
suffix:semicolon
DECL|variable|appldata_os_exit
id|module_exit
c_func
(paren
id|appldata_os_exit
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Gerald Schaefer&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Linux-VM Monitor Stream, OS statistics&quot;
)paren
suffix:semicolon
eof
