multiline_comment|/*&n; * arch/s390/appldata/appldata_net_sum.c&n; *&n; * Data gathering module for Linux-VM Monitor Stream, Stage 1.&n; * Collects accumulated network statistics (Packets received/transmitted,&n; * dropped, errors, ...).&n; *&n; * Copyright (C) 2003 IBM Corporation, IBM Deutschland Entwicklung GmbH.&n; *&n; * Author: Gerald Schaefer &lt;geraldsc@de.ibm.com&gt;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel_stat.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &quot;appldata.h&quot;
DECL|macro|MY_PRINT_NAME
mdefine_line|#define MY_PRINT_NAME&t;&quot;appldata_net_sum&quot;&t;/* for debug messages, etc. */
multiline_comment|/*&n; * Network data&n; *&n; * This is accessed as binary data by z/VM. If changes to it can&squot;t be avoided,&n; * the structure version (product ID, see appldata_base.c) needs to be changed&n; * as well and all documentation and z/VM applications using it must be updated.&n; *&n; * The record layout is documented in the Linux for zSeries Device Drivers&n; * book:&n; * http://oss.software.ibm.com/developerworks/opensource/linux390/index.shtml&n; */
DECL|struct|appldata_net_sum_data
r_struct
id|appldata_net_sum_data
(brace
DECL|member|timestamp
id|u64
id|timestamp
suffix:semicolon
DECL|member|sync_count_1
id|u32
id|sync_count_1
suffix:semicolon
multiline_comment|/* after VM collected the record data, */
DECL|member|sync_count_2
id|u32
id|sync_count_2
suffix:semicolon
multiline_comment|/* sync_count_1 and sync_count_2 should be the&n;&t;&t;&t;&t;   same. If not, the record has been updated on&n;&t;&t;&t;&t;   the Linux side while VM was collecting the&n;&t;&t;&t;&t;   (possibly corrupt) data */
DECL|member|nr_interfaces
id|u32
id|nr_interfaces
suffix:semicolon
multiline_comment|/* nr. of network interfaces being monitored */
DECL|member|padding
id|u32
id|padding
suffix:semicolon
multiline_comment|/* next value is 64-bit aligned, so these */
multiline_comment|/* 4 byte would be padded out by compiler */
DECL|member|rx_packets
id|u64
id|rx_packets
suffix:semicolon
multiline_comment|/* total packets received        */
DECL|member|tx_packets
id|u64
id|tx_packets
suffix:semicolon
multiline_comment|/* total packets transmitted     */
DECL|member|rx_bytes
id|u64
id|rx_bytes
suffix:semicolon
multiline_comment|/* total bytes received          */
DECL|member|tx_bytes
id|u64
id|tx_bytes
suffix:semicolon
multiline_comment|/* total bytes transmitted       */
DECL|member|rx_errors
id|u64
id|rx_errors
suffix:semicolon
multiline_comment|/* bad packets received          */
DECL|member|tx_errors
id|u64
id|tx_errors
suffix:semicolon
multiline_comment|/* packet transmit problems      */
DECL|member|rx_dropped
id|u64
id|rx_dropped
suffix:semicolon
multiline_comment|/* no space in linux buffers     */
DECL|member|tx_dropped
id|u64
id|tx_dropped
suffix:semicolon
multiline_comment|/* no space available in linux   */
DECL|member|collisions
id|u64
id|collisions
suffix:semicolon
multiline_comment|/* collisions while transmitting */
DECL|variable|appldata_net_sum_data
)brace
id|appldata_net_sum_data
suffix:semicolon
DECL|function|appldata_print_debug
r_static
r_inline
r_void
id|appldata_print_debug
c_func
(paren
r_struct
id|appldata_net_sum_data
op_star
id|net_data
)paren
(brace
id|P_DEBUG
c_func
(paren
l_string|&quot;--- NET - RECORD ---&bslash;n&quot;
)paren
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;nr_interfaces = %u&bslash;n&quot;
comma
id|net_data-&gt;nr_interfaces
)paren
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;rx_packets    = %8lu&bslash;n&quot;
comma
id|net_data-&gt;rx_packets
)paren
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;tx_packets    = %8lu&bslash;n&quot;
comma
id|net_data-&gt;tx_packets
)paren
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;rx_bytes      = %8lu&bslash;n&quot;
comma
id|net_data-&gt;rx_bytes
)paren
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;tx_bytes      = %8lu&bslash;n&quot;
comma
id|net_data-&gt;tx_bytes
)paren
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;rx_errors     = %8lu&bslash;n&quot;
comma
id|net_data-&gt;rx_errors
)paren
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;tx_errors     = %8lu&bslash;n&quot;
comma
id|net_data-&gt;tx_errors
)paren
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;rx_dropped    = %8lu&bslash;n&quot;
comma
id|net_data-&gt;rx_dropped
)paren
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;tx_dropped    = %8lu&bslash;n&quot;
comma
id|net_data-&gt;tx_dropped
)paren
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;collisions    = %8lu&bslash;n&quot;
comma
id|net_data-&gt;collisions
)paren
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;sync_count_1 = %u&bslash;n&quot;
comma
id|net_data-&gt;sync_count_1
)paren
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;sync_count_2 = %u&bslash;n&quot;
comma
id|net_data-&gt;sync_count_2
)paren
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;timestamp    = %lX&bslash;n&quot;
comma
id|net_data-&gt;timestamp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * appldata_get_net_sum_data()&n; *&n; * gather accumulated network statistics&n; */
DECL|function|appldata_get_net_sum_data
r_static
r_void
id|appldata_get_net_sum_data
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|appldata_net_sum_data
op_star
id|net_data
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
suffix:semicolon
r_int
r_int
id|rx_packets
comma
id|tx_packets
comma
id|rx_bytes
comma
id|tx_bytes
comma
id|rx_errors
comma
id|tx_errors
comma
id|rx_dropped
comma
id|tx_dropped
comma
id|collisions
suffix:semicolon
id|net_data
op_assign
id|data
suffix:semicolon
id|net_data-&gt;sync_count_1
op_increment
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
id|rx_packets
op_assign
l_int|0
suffix:semicolon
id|tx_packets
op_assign
l_int|0
suffix:semicolon
id|rx_bytes
op_assign
l_int|0
suffix:semicolon
id|tx_bytes
op_assign
l_int|0
suffix:semicolon
id|rx_errors
op_assign
l_int|0
suffix:semicolon
id|tx_errors
op_assign
l_int|0
suffix:semicolon
id|rx_dropped
op_assign
l_int|0
suffix:semicolon
id|tx_dropped
op_assign
l_int|0
suffix:semicolon
id|collisions
op_assign
l_int|0
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|dev_base_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
id|dev_base
suffix:semicolon
id|dev
op_ne
l_int|NULL
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;get_stats
op_eq
l_int|NULL
)paren
(brace
r_continue
suffix:semicolon
)brace
id|stats
op_assign
id|dev
op_member_access_from_pointer
id|get_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
id|rx_packets
op_add_assign
id|stats-&gt;rx_packets
suffix:semicolon
id|tx_packets
op_add_assign
id|stats-&gt;tx_packets
suffix:semicolon
id|rx_bytes
op_add_assign
id|stats-&gt;rx_bytes
suffix:semicolon
id|tx_bytes
op_add_assign
id|stats-&gt;tx_bytes
suffix:semicolon
id|rx_errors
op_add_assign
id|stats-&gt;rx_errors
suffix:semicolon
id|tx_errors
op_add_assign
id|stats-&gt;tx_errors
suffix:semicolon
id|rx_dropped
op_add_assign
id|stats-&gt;rx_dropped
suffix:semicolon
id|tx_dropped
op_add_assign
id|stats-&gt;tx_dropped
suffix:semicolon
id|collisions
op_add_assign
id|stats-&gt;collisions
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
id|read_unlock
c_func
(paren
op_amp
id|dev_base_lock
)paren
suffix:semicolon
id|net_data-&gt;nr_interfaces
op_assign
id|i
suffix:semicolon
id|net_data-&gt;rx_packets
op_assign
id|rx_packets
suffix:semicolon
id|net_data-&gt;tx_packets
op_assign
id|tx_packets
suffix:semicolon
id|net_data-&gt;rx_bytes
op_assign
id|rx_bytes
suffix:semicolon
id|net_data-&gt;tx_bytes
op_assign
id|tx_bytes
suffix:semicolon
id|net_data-&gt;rx_errors
op_assign
id|rx_errors
suffix:semicolon
id|net_data-&gt;tx_errors
op_assign
id|tx_errors
suffix:semicolon
id|net_data-&gt;rx_dropped
op_assign
id|rx_dropped
suffix:semicolon
id|net_data-&gt;tx_dropped
op_assign
id|tx_dropped
suffix:semicolon
id|net_data-&gt;collisions
op_assign
id|collisions
suffix:semicolon
id|net_data-&gt;timestamp
op_assign
id|get_clock
c_func
(paren
)paren
suffix:semicolon
id|net_data-&gt;sync_count_2
op_increment
suffix:semicolon
macro_line|#ifdef APPLDATA_DEBUG
id|appldata_print_debug
c_func
(paren
id|net_data
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|variable|ops
r_static
r_struct
id|appldata_ops
id|ops
op_assign
(brace
dot
id|ctl_nr
op_assign
id|CTL_APPLDATA_NET_SUM
comma
dot
id|name
op_assign
l_string|&quot;net_sum&quot;
comma
dot
id|record_nr
op_assign
id|APPLDATA_RECORD_NET_SUM_ID
comma
dot
id|size
op_assign
r_sizeof
(paren
r_struct
id|appldata_net_sum_data
)paren
comma
dot
id|callback
op_assign
op_amp
id|appldata_get_net_sum_data
comma
dot
id|data
op_assign
op_amp
id|appldata_net_sum_data
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * appldata_net_init()&n; *&n; * init data, register ops&n; */
DECL|function|appldata_net_init
r_static
r_int
id|__init
id|appldata_net_init
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;sizeof(net) = %lu&bslash;n&quot;
comma
r_sizeof
(paren
r_struct
id|appldata_net_sum_data
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|appldata_register_ops
c_func
(paren
op_amp
id|ops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|P_ERROR
c_func
(paren
l_string|&quot;Error registering ops, rc = %i&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
)brace
r_else
(brace
id|P_DEBUG
c_func
(paren
l_string|&quot;%s-ops registered!&bslash;n&quot;
comma
id|ops.name
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * appldata_net_exit()&n; *&n; * unregister ops&n; */
DECL|function|appldata_net_exit
r_static
r_void
id|__exit
id|appldata_net_exit
c_func
(paren
r_void
)paren
(brace
id|appldata_unregister_ops
c_func
(paren
op_amp
id|ops
)paren
suffix:semicolon
id|P_DEBUG
c_func
(paren
l_string|&quot;%s-ops unregistered!&bslash;n&quot;
comma
id|ops.name
)paren
suffix:semicolon
)brace
DECL|variable|appldata_net_init
id|module_init
c_func
(paren
id|appldata_net_init
)paren
suffix:semicolon
DECL|variable|appldata_net_exit
id|module_exit
c_func
(paren
id|appldata_net_exit
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Gerald Schaefer&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Linux-VM Monitor Stream, accumulated network statistics&quot;
)paren
suffix:semicolon
eof
