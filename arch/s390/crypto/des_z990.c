multiline_comment|/*&n; * Cryptographic API.&n; *&n; * z990 implementation of the DES Cipher Algorithm.&n; *&n; * Copyright (c) 2003 IBM Deutschland Entwicklung GmbH, IBM Corporation&n; * Author(s): Thomas Spatzier (tspat@de.ibm.com)&n; *&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/scatterlist.h&gt;
macro_line|#include &lt;linux/crypto.h&gt;
macro_line|#include &quot;crypt_z990.h&quot;
macro_line|#include &quot;crypto_des.h&quot;
DECL|macro|DES_BLOCK_SIZE
mdefine_line|#define DES_BLOCK_SIZE 8
DECL|macro|DES_KEY_SIZE
mdefine_line|#define DES_KEY_SIZE 8
DECL|macro|DES3_128_KEY_SIZE
mdefine_line|#define DES3_128_KEY_SIZE&t;(2 * DES_KEY_SIZE)
DECL|macro|DES3_128_BLOCK_SIZE
mdefine_line|#define DES3_128_BLOCK_SIZE&t;DES_BLOCK_SIZE
DECL|macro|DES3_192_KEY_SIZE
mdefine_line|#define DES3_192_KEY_SIZE&t;(3 * DES_KEY_SIZE)
DECL|macro|DES3_192_BLOCK_SIZE
mdefine_line|#define DES3_192_BLOCK_SIZE&t;DES_BLOCK_SIZE
DECL|struct|crypt_z990_des_ctx
r_struct
id|crypt_z990_des_ctx
(brace
DECL|member|iv
id|u8
id|iv
(braket
id|DES_BLOCK_SIZE
)braket
suffix:semicolon
DECL|member|key
id|u8
id|key
(braket
id|DES_KEY_SIZE
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|crypt_z990_des3_128_ctx
r_struct
id|crypt_z990_des3_128_ctx
(brace
DECL|member|iv
id|u8
id|iv
(braket
id|DES_BLOCK_SIZE
)braket
suffix:semicolon
DECL|member|key
id|u8
id|key
(braket
id|DES3_128_KEY_SIZE
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|crypt_z990_des3_192_ctx
r_struct
id|crypt_z990_des3_192_ctx
(brace
DECL|member|iv
id|u8
id|iv
(braket
id|DES_BLOCK_SIZE
)braket
suffix:semicolon
DECL|member|key
id|u8
id|key
(braket
id|DES3_192_KEY_SIZE
)braket
suffix:semicolon
)brace
suffix:semicolon
r_static
r_int
DECL|function|des_setkey
id|des_setkey
c_func
(paren
r_void
op_star
id|ctx
comma
r_const
id|u8
op_star
id|key
comma
r_int
r_int
id|keylen
comma
id|u32
op_star
id|flags
)paren
(brace
r_struct
id|crypt_z990_des_ctx
op_star
id|dctx
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|dctx
op_assign
id|ctx
suffix:semicolon
singleline_comment|//test if key is valid (not a weak key)
id|ret
op_assign
id|crypto_des_check_key
c_func
(paren
id|key
comma
id|keylen
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
id|dctx-&gt;key
comma
id|key
comma
id|keylen
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
r_static
r_void
DECL|function|des_encrypt
id|des_encrypt
c_func
(paren
r_void
op_star
id|ctx
comma
id|u8
op_star
id|dst
comma
r_const
id|u8
op_star
id|src
)paren
(brace
r_struct
id|crypt_z990_des_ctx
op_star
id|dctx
suffix:semicolon
id|dctx
op_assign
id|ctx
suffix:semicolon
id|crypt_z990_km
c_func
(paren
id|KM_DEA_ENCRYPT
comma
id|dctx-&gt;key
comma
id|dst
comma
id|src
comma
id|DES_BLOCK_SIZE
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|des_decrypt
id|des_decrypt
c_func
(paren
r_void
op_star
id|ctx
comma
id|u8
op_star
id|dst
comma
r_const
id|u8
op_star
id|src
)paren
(brace
r_struct
id|crypt_z990_des_ctx
op_star
id|dctx
suffix:semicolon
id|dctx
op_assign
id|ctx
suffix:semicolon
id|crypt_z990_km
c_func
(paren
id|KM_DEA_DECRYPT
comma
id|dctx-&gt;key
comma
id|dst
comma
id|src
comma
id|DES_BLOCK_SIZE
)paren
suffix:semicolon
)brace
DECL|variable|des_alg
r_static
r_struct
id|crypto_alg
id|des_alg
op_assign
(brace
dot
id|cra_name
op_assign
l_string|&quot;des&quot;
comma
dot
id|cra_flags
op_assign
id|CRYPTO_ALG_TYPE_CIPHER
comma
dot
id|cra_blocksize
op_assign
id|DES_BLOCK_SIZE
comma
dot
id|cra_ctxsize
op_assign
r_sizeof
(paren
r_struct
id|crypt_z990_des_ctx
)paren
comma
dot
id|cra_module
op_assign
id|THIS_MODULE
comma
dot
id|cra_list
op_assign
id|LIST_HEAD_INIT
c_func
(paren
id|des_alg.cra_list
)paren
comma
dot
id|cra_u
op_assign
(brace
dot
id|cipher
op_assign
(brace
dot
id|cia_min_keysize
op_assign
id|DES_KEY_SIZE
comma
dot
id|cia_max_keysize
op_assign
id|DES_KEY_SIZE
comma
dot
id|cia_setkey
op_assign
id|des_setkey
comma
dot
id|cia_encrypt
op_assign
id|des_encrypt
comma
dot
id|cia_decrypt
op_assign
id|des_decrypt
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; * RFC2451:&n; *&n; *   For DES-EDE3, there is no known need to reject weak or&n; *   complementation keys.  Any weakness is obviated by the use of&n; *   multiple keys.&n; *&n; *   However, if the two  independent 64-bit keys are equal,&n; *   then the DES3 operation is simply the same as DES.&n; *   Implementers MUST reject keys that exhibit this property.&n; *&n; */
r_static
r_int
DECL|function|des3_128_setkey
id|des3_128_setkey
c_func
(paren
r_void
op_star
id|ctx
comma
r_const
id|u8
op_star
id|key
comma
r_int
r_int
id|keylen
comma
id|u32
op_star
id|flags
)paren
(brace
r_int
id|i
comma
id|ret
suffix:semicolon
r_struct
id|crypt_z990_des3_128_ctx
op_star
id|dctx
suffix:semicolon
r_const
id|u8
op_star
id|temp_key
op_assign
id|key
suffix:semicolon
id|dctx
op_assign
id|ctx
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|memcmp
c_func
(paren
id|key
comma
op_amp
id|key
(braket
id|DES_KEY_SIZE
)braket
comma
id|DES_KEY_SIZE
)paren
)paren
)paren
(brace
op_star
id|flags
op_or_assign
id|CRYPTO_TFM_RES_BAD_KEY_SCHED
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
comma
id|temp_key
op_add_assign
id|DES_KEY_SIZE
)paren
(brace
id|ret
op_assign
id|crypto_des_check_key
c_func
(paren
id|temp_key
comma
id|DES_KEY_SIZE
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|dctx-&gt;key
comma
id|key
comma
id|keylen
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|des3_128_encrypt
id|des3_128_encrypt
c_func
(paren
r_void
op_star
id|ctx
comma
id|u8
op_star
id|dst
comma
r_const
id|u8
op_star
id|src
)paren
(brace
r_struct
id|crypt_z990_des3_128_ctx
op_star
id|dctx
suffix:semicolon
id|dctx
op_assign
id|ctx
suffix:semicolon
id|crypt_z990_km
c_func
(paren
id|KM_TDEA_128_ENCRYPT
comma
id|dctx-&gt;key
comma
id|dst
comma
(paren
r_void
op_star
)paren
id|src
comma
id|DES3_128_BLOCK_SIZE
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|des3_128_decrypt
id|des3_128_decrypt
c_func
(paren
r_void
op_star
id|ctx
comma
id|u8
op_star
id|dst
comma
r_const
id|u8
op_star
id|src
)paren
(brace
r_struct
id|crypt_z990_des3_128_ctx
op_star
id|dctx
suffix:semicolon
id|dctx
op_assign
id|ctx
suffix:semicolon
id|crypt_z990_km
c_func
(paren
id|KM_TDEA_128_DECRYPT
comma
id|dctx-&gt;key
comma
id|dst
comma
(paren
r_void
op_star
)paren
id|src
comma
id|DES3_128_BLOCK_SIZE
)paren
suffix:semicolon
)brace
DECL|variable|des3_128_alg
r_static
r_struct
id|crypto_alg
id|des3_128_alg
op_assign
(brace
dot
id|cra_name
op_assign
l_string|&quot;des3_ede128&quot;
comma
dot
id|cra_flags
op_assign
id|CRYPTO_ALG_TYPE_CIPHER
comma
dot
id|cra_blocksize
op_assign
id|DES3_128_BLOCK_SIZE
comma
dot
id|cra_ctxsize
op_assign
r_sizeof
(paren
r_struct
id|crypt_z990_des3_128_ctx
)paren
comma
dot
id|cra_module
op_assign
id|THIS_MODULE
comma
dot
id|cra_list
op_assign
id|LIST_HEAD_INIT
c_func
(paren
id|des3_128_alg.cra_list
)paren
comma
dot
id|cra_u
op_assign
(brace
dot
id|cipher
op_assign
(brace
dot
id|cia_min_keysize
op_assign
id|DES3_128_KEY_SIZE
comma
dot
id|cia_max_keysize
op_assign
id|DES3_128_KEY_SIZE
comma
dot
id|cia_setkey
op_assign
id|des3_128_setkey
comma
dot
id|cia_encrypt
op_assign
id|des3_128_encrypt
comma
dot
id|cia_decrypt
op_assign
id|des3_128_decrypt
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; * RFC2451:&n; *&n; *   For DES-EDE3, there is no known need to reject weak or&n; *   complementation keys.  Any weakness is obviated by the use of&n; *   multiple keys.&n; *&n; *   However, if the first two or last two independent 64-bit keys are&n; *   equal (k1 == k2 or k2 == k3), then the DES3 operation is simply the&n; *   same as DES.  Implementers MUST reject keys that exhibit this&n; *   property.&n; *&n; */
r_static
r_int
DECL|function|des3_192_setkey
id|des3_192_setkey
c_func
(paren
r_void
op_star
id|ctx
comma
r_const
id|u8
op_star
id|key
comma
r_int
r_int
id|keylen
comma
id|u32
op_star
id|flags
)paren
(brace
r_int
id|i
comma
id|ret
suffix:semicolon
r_struct
id|crypt_z990_des3_192_ctx
op_star
id|dctx
suffix:semicolon
r_const
id|u8
op_star
id|temp_key
suffix:semicolon
id|dctx
op_assign
id|ctx
suffix:semicolon
id|temp_key
op_assign
id|key
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|memcmp
c_func
(paren
id|key
comma
op_amp
id|key
(braket
id|DES_KEY_SIZE
)braket
comma
id|DES_KEY_SIZE
)paren
op_logical_and
id|memcmp
c_func
(paren
op_amp
id|key
(braket
id|DES_KEY_SIZE
)braket
comma
op_amp
id|key
(braket
id|DES_KEY_SIZE
op_star
l_int|2
)braket
comma
id|DES_KEY_SIZE
)paren
)paren
)paren
(brace
op_star
id|flags
op_or_assign
id|CRYPTO_TFM_RES_BAD_KEY_SCHED
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
comma
id|temp_key
op_add_assign
id|DES_KEY_SIZE
)paren
(brace
id|ret
op_assign
id|crypto_des_check_key
c_func
(paren
id|temp_key
comma
id|DES_KEY_SIZE
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
)brace
id|memcpy
c_func
(paren
id|dctx-&gt;key
comma
id|key
comma
id|keylen
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|des3_192_encrypt
id|des3_192_encrypt
c_func
(paren
r_void
op_star
id|ctx
comma
id|u8
op_star
id|dst
comma
r_const
id|u8
op_star
id|src
)paren
(brace
r_struct
id|crypt_z990_des3_192_ctx
op_star
id|dctx
suffix:semicolon
id|dctx
op_assign
id|ctx
suffix:semicolon
id|crypt_z990_km
c_func
(paren
id|KM_TDEA_192_ENCRYPT
comma
id|dctx-&gt;key
comma
id|dst
comma
(paren
r_void
op_star
)paren
id|src
comma
id|DES3_192_BLOCK_SIZE
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|des3_192_decrypt
id|des3_192_decrypt
c_func
(paren
r_void
op_star
id|ctx
comma
id|u8
op_star
id|dst
comma
r_const
id|u8
op_star
id|src
)paren
(brace
r_struct
id|crypt_z990_des3_192_ctx
op_star
id|dctx
suffix:semicolon
id|dctx
op_assign
id|ctx
suffix:semicolon
id|crypt_z990_km
c_func
(paren
id|KM_TDEA_192_DECRYPT
comma
id|dctx-&gt;key
comma
id|dst
comma
(paren
r_void
op_star
)paren
id|src
comma
id|DES3_192_BLOCK_SIZE
)paren
suffix:semicolon
)brace
DECL|variable|des3_192_alg
r_static
r_struct
id|crypto_alg
id|des3_192_alg
op_assign
(brace
dot
id|cra_name
op_assign
l_string|&quot;des3_ede&quot;
comma
dot
id|cra_flags
op_assign
id|CRYPTO_ALG_TYPE_CIPHER
comma
dot
id|cra_blocksize
op_assign
id|DES3_192_BLOCK_SIZE
comma
dot
id|cra_ctxsize
op_assign
r_sizeof
(paren
r_struct
id|crypt_z990_des3_192_ctx
)paren
comma
dot
id|cra_module
op_assign
id|THIS_MODULE
comma
dot
id|cra_list
op_assign
id|LIST_HEAD_INIT
c_func
(paren
id|des3_192_alg.cra_list
)paren
comma
dot
id|cra_u
op_assign
(brace
dot
id|cipher
op_assign
(brace
dot
id|cia_min_keysize
op_assign
id|DES3_192_KEY_SIZE
comma
dot
id|cia_max_keysize
op_assign
id|DES3_192_KEY_SIZE
comma
dot
id|cia_setkey
op_assign
id|des3_192_setkey
comma
dot
id|cia_encrypt
op_assign
id|des3_192_encrypt
comma
dot
id|cia_decrypt
op_assign
id|des3_192_decrypt
)brace
)brace
)brace
suffix:semicolon
r_static
r_int
DECL|function|init
id|init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|crypt_z990_func_available
c_func
(paren
id|KM_DEA_ENCRYPT
)paren
op_logical_or
op_logical_neg
id|crypt_z990_func_available
c_func
(paren
id|KM_TDEA_128_ENCRYPT
)paren
op_logical_or
op_logical_neg
id|crypt_z990_func_available
c_func
(paren
id|KM_TDEA_192_ENCRYPT
)paren
)paren
(brace
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
id|ret
op_assign
l_int|0
suffix:semicolon
id|ret
op_or_assign
(paren
id|crypto_register_alg
c_func
(paren
op_amp
id|des_alg
)paren
op_eq
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
id|ret
op_or_assign
(paren
id|crypto_register_alg
c_func
(paren
op_amp
id|des3_128_alg
)paren
op_eq
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|2
suffix:semicolon
id|ret
op_or_assign
(paren
id|crypto_register_alg
c_func
(paren
op_amp
id|des3_192_alg
)paren
op_eq
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|crypto_unregister_alg
c_func
(paren
op_amp
id|des3_192_alg
)paren
suffix:semicolon
id|crypto_unregister_alg
c_func
(paren
op_amp
id|des3_128_alg
)paren
suffix:semicolon
id|crypto_unregister_alg
c_func
(paren
op_amp
id|des_alg
)paren
suffix:semicolon
r_return
op_minus
id|EEXIST
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;crypt_z990: des_z990 loaded.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|fini
id|fini
c_func
(paren
r_void
)paren
(brace
id|crypto_unregister_alg
c_func
(paren
op_amp
id|des3_192_alg
)paren
suffix:semicolon
id|crypto_unregister_alg
c_func
(paren
op_amp
id|des3_128_alg
)paren
suffix:semicolon
id|crypto_unregister_alg
c_func
(paren
op_amp
id|des_alg
)paren
suffix:semicolon
)brace
DECL|variable|init
id|module_init
c_func
(paren
id|init
)paren
suffix:semicolon
DECL|variable|fini
id|module_exit
c_func
(paren
id|fini
)paren
suffix:semicolon
id|MODULE_ALIAS
c_func
(paren
l_string|&quot;des&quot;
)paren
suffix:semicolon
id|MODULE_ALIAS
c_func
(paren
l_string|&quot;des3_ede&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;DES &amp; Triple DES EDE Cipher Algorithms&quot;
)paren
suffix:semicolon
eof
