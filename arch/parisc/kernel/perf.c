multiline_comment|/*&n; *  Parisc performance counters&n; *  Copyright (C) 2001 Randolph Chung &lt;tausq@debian.org&gt;&n; *&n; *  This code is derived, with permission, from HP/UX sources.&n; *&n; *    This program is free software; you can redistribute it and/or modify&n; *    it under the terms of the GNU General Public License as published by&n; *    the Free Software Foundation; either version 2, or (at your option)&n; *    any later version.&n; *&n; *    This program is distributed in the hope that it will be useful,&n; *    but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *    GNU General Public License for more details.&n; *&n; *    You should have received a copy of the GNU General Public License&n; *    along with this program; if not, write to the Free Software&n; *    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
multiline_comment|/*&n; *  Edited comment from original sources:&n; *&n; *  This driver programs the PCX-U/PCX-W performance counters&n; *  on the PA-RISC 2.0 chips.  The driver keeps all images now&n; *  internally to the kernel to hopefully eliminate the possiblity&n; *  of a bad image halting the CPU.  Also, there are different&n; *  images for the PCX-W and later chips vs the PCX-U chips.&n; *&n; *  Only 1 process is allowed to access the driver at any time,&n; *  so the only protection that is needed is at open and close.&n; *  A variable &quot;perf_enabled&quot; is used to hold the state of the&n; *  driver.  The spinlock &quot;perf_lock&quot; is used to protect the&n; *  modification of the state during open/close operations so&n; *  multiple processes don&squot;t get into the driver simultaneously.&n; *&n; *  This driver accesses the processor directly vs going through&n; *  the PDC INTRIGUE calls.  This is done to eliminate bugs introduced&n; *  in various PDC revisions.  The code is much more maintainable&n; *  and reliable this way vs having to debug on every version of PDC&n; *  on every box. &n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/gsc.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/perf.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/runway.h&gt;
macro_line|#include &quot;perf_images.h&quot;
DECL|macro|MAX_RDR_WORDS
mdefine_line|#define MAX_RDR_WORDS&t;24
DECL|macro|PERF_VERSION
mdefine_line|#define PERF_VERSION&t;2&t;/* derived from hpux&squot;s PI v2 interface */
multiline_comment|/* definition of RDR regs */
DECL|struct|rdr_tbl_ent
r_struct
id|rdr_tbl_ent
(brace
DECL|member|width
r_uint16
id|width
suffix:semicolon
DECL|member|num_words
r_uint8
id|num_words
suffix:semicolon
DECL|member|write_control
r_uint8
id|write_control
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|perf_processor_interface
r_static
r_int
id|perf_processor_interface
op_assign
id|UNKNOWN_INTF
suffix:semicolon
DECL|variable|perf_enabled
r_static
r_int
id|perf_enabled
op_assign
l_int|0
suffix:semicolon
DECL|variable|perf_lock
r_static
id|spinlock_t
id|perf_lock
suffix:semicolon
DECL|variable|cpu_device
r_struct
id|parisc_device
op_star
id|cpu_device
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* RDRs to write for PCX-W */
DECL|variable|perf_rdrs_W
r_static
r_int
id|perf_rdrs_W
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|1
comma
l_int|4
comma
l_int|5
comma
l_int|6
comma
l_int|15
comma
l_int|16
comma
l_int|17
comma
l_int|18
comma
l_int|20
comma
l_int|21
comma
l_int|22
comma
l_int|23
comma
l_int|24
comma
l_int|25
comma
op_minus
l_int|1
)brace
suffix:semicolon
multiline_comment|/* RDRs to write for PCX-U */
DECL|variable|perf_rdrs_U
r_static
r_int
id|perf_rdrs_U
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|1
comma
l_int|4
comma
l_int|5
comma
l_int|6
comma
l_int|7
comma
l_int|16
comma
l_int|17
comma
l_int|18
comma
l_int|20
comma
l_int|21
comma
l_int|22
comma
l_int|23
comma
l_int|24
comma
l_int|25
comma
op_minus
l_int|1
)brace
suffix:semicolon
multiline_comment|/* RDR register descriptions for PCX-W */
DECL|variable|perf_rdr_tbl_W
r_static
r_struct
id|rdr_tbl_ent
id|perf_rdr_tbl_W
(braket
)braket
op_assign
(brace
(brace
l_int|19
comma
l_int|1
comma
l_int|8
)brace
comma
multiline_comment|/* RDR 0 */
(brace
l_int|16
comma
l_int|1
comma
l_int|16
)brace
comma
multiline_comment|/* RDR 1 */
(brace
l_int|72
comma
l_int|2
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 2 */
(brace
l_int|81
comma
l_int|2
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 3 */
(brace
l_int|328
comma
l_int|6
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 4 */
(brace
l_int|160
comma
l_int|3
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 5 */
(brace
l_int|336
comma
l_int|6
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 6 */
(brace
l_int|164
comma
l_int|3
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 7 */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 8 */
(brace
l_int|35
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 9 */
(brace
l_int|6
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 10 */
(brace
l_int|18
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 11 */
(brace
l_int|13
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 12 */
(brace
l_int|8
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 13 */
(brace
l_int|8
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 14 */
(brace
l_int|8
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 15 */
(brace
l_int|1530
comma
l_int|24
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 16 */
(brace
l_int|16
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 17 */
(brace
l_int|4
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 18 */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 19 */
(brace
l_int|152
comma
l_int|3
comma
l_int|24
)brace
comma
multiline_comment|/* RDR 20 */
(brace
l_int|152
comma
l_int|3
comma
l_int|24
)brace
comma
multiline_comment|/* RDR 21 */
(brace
l_int|233
comma
l_int|4
comma
l_int|48
)brace
comma
multiline_comment|/* RDR 22 */
(brace
l_int|233
comma
l_int|4
comma
l_int|48
)brace
comma
multiline_comment|/* RDR 23 */
(brace
l_int|71
comma
l_int|2
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 24 */
(brace
l_int|71
comma
l_int|2
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 25 */
(brace
l_int|11
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 26 */
(brace
l_int|18
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 27 */
(brace
l_int|128
comma
l_int|2
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 28 */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 29 */
(brace
l_int|16
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 30 */
(brace
l_int|16
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 31 */
)brace
suffix:semicolon
multiline_comment|/* RDR register descriptions for PCX-U */
DECL|variable|perf_rdr_tbl_U
r_static
r_struct
id|rdr_tbl_ent
id|perf_rdr_tbl_U
(braket
)braket
op_assign
(brace
(brace
l_int|19
comma
l_int|1
comma
l_int|8
)brace
comma
multiline_comment|/* RDR 0 */
(brace
l_int|32
comma
l_int|1
comma
l_int|16
)brace
comma
multiline_comment|/* RDR 1 */
(brace
l_int|20
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 2 */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 3 */
(brace
l_int|344
comma
l_int|6
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 4 */
(brace
l_int|176
comma
l_int|3
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 5 */
(brace
l_int|336
comma
l_int|6
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 6 */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 7 */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 8 */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 9 */
(brace
l_int|28
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 10 */
(brace
l_int|33
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 11 */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 12 */
(brace
l_int|230
comma
l_int|4
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 13 */
(brace
l_int|32
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 14 */
(brace
l_int|128
comma
l_int|2
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 15 */
(brace
l_int|1494
comma
l_int|24
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 16 */
(brace
l_int|18
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 17 */
(brace
l_int|4
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 18 */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 19 */
(brace
l_int|158
comma
l_int|3
comma
l_int|24
)brace
comma
multiline_comment|/* RDR 20 */
(brace
l_int|158
comma
l_int|3
comma
l_int|24
)brace
comma
multiline_comment|/* RDR 21 */
(brace
l_int|194
comma
l_int|4
comma
l_int|48
)brace
comma
multiline_comment|/* RDR 22 */
(brace
l_int|194
comma
l_int|4
comma
l_int|48
)brace
comma
multiline_comment|/* RDR 23 */
(brace
l_int|71
comma
l_int|2
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 24 */
(brace
l_int|71
comma
l_int|2
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 25 */
(brace
l_int|28
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 26 */
(brace
l_int|33
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 27 */
(brace
l_int|88
comma
l_int|2
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 28 */
(brace
l_int|32
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 29 */
(brace
l_int|24
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 30 */
(brace
l_int|16
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* RDR 31 */
)brace
suffix:semicolon
multiline_comment|/*&n; * A non-zero write_control in the above tables is a byte offset into&n; * this array.&n; */
DECL|variable|perf_bitmasks
r_static
r_uint64
id|perf_bitmasks
(braket
)braket
op_assign
(brace
l_int|0x0000000000000000
comma
multiline_comment|/* first dbl word must be zero */
l_int|0xfdffe00000000000
comma
multiline_comment|/* RDR0 bitmask */
l_int|0x003f000000000000
comma
multiline_comment|/* RDR1 bitmask */
l_int|0x00ffffffffffffff
comma
multiline_comment|/* RDR20-RDR21 bitmask (152 bits) */
l_int|0xffffffffffffffff
comma
l_int|0xfffffffc00000000
comma
l_int|0xffffffffffffffff
comma
multiline_comment|/* RDR22-RDR23 bitmask (233 bits) */
l_int|0xffffffffffffffff
comma
l_int|0xfffffffffffffffc
comma
l_int|0xff00000000000000
)brace
suffix:semicolon
multiline_comment|/*&n; * Write control bitmasks for Pa-8700 processor given&n; * somethings have changed slightly.&n; */
DECL|variable|perf_bitmasks_piranha
r_static
r_uint64
id|perf_bitmasks_piranha
(braket
)braket
op_assign
(brace
l_int|0x0000000000000000
comma
multiline_comment|/* first dbl word must be zero */
l_int|0xfdffe00000000000
comma
multiline_comment|/* RDR0 bitmask */
l_int|0x003f000000000000
comma
multiline_comment|/* RDR1 bitmask */
l_int|0x00ffffffffffffff
comma
multiline_comment|/* RDR20-RDR21 bitmask (158 bits) */
l_int|0xffffffffffffffff
comma
l_int|0xfffffffc00000000
comma
l_int|0xffffffffffffffff
comma
multiline_comment|/* RDR22-RDR23 bitmask (210 bits) */
l_int|0xffffffffffffffff
comma
l_int|0xffffffffffffffff
comma
l_int|0xfffc000000000000
)brace
suffix:semicolon
DECL|variable|bitmask_array
r_static
r_uint64
op_star
id|bitmask_array
suffix:semicolon
multiline_comment|/* array of bitmasks to use */
multiline_comment|/******************************************************************************&n; * Function Prototypes&n; *****************************************************************************/
r_static
r_int
id|perf_config
c_func
(paren
r_uint32
op_star
id|image_ptr
)paren
suffix:semicolon
r_static
r_int
id|perf_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|perf_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
id|ssize_t
id|perf_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|cnt
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
r_static
id|ssize_t
id|perf_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
r_static
r_int
id|perf_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_void
id|perf_start_counters
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|perf_stop_counters
c_func
(paren
r_uint32
op_star
id|raddr
)paren
suffix:semicolon
r_static
r_struct
id|rdr_tbl_ent
op_star
id|perf_rdr_get_entry
c_func
(paren
r_uint32
id|rdr_num
)paren
suffix:semicolon
r_static
r_int
id|perf_rdr_read_ubuf
c_func
(paren
r_uint32
id|rdr_num
comma
r_uint64
op_star
id|buffer
)paren
suffix:semicolon
r_static
r_int
id|perf_rdr_clear
c_func
(paren
r_uint32
id|rdr_num
)paren
suffix:semicolon
r_static
r_int
id|perf_write_image
c_func
(paren
r_uint64
op_star
id|memaddr
)paren
suffix:semicolon
r_static
r_void
id|perf_rdr_write
c_func
(paren
r_uint32
id|rdr_num
comma
r_uint64
op_star
id|buffer
)paren
suffix:semicolon
multiline_comment|/* External Assembly Routines */
r_extern
r_uint64
id|perf_rdr_shift_in_W
(paren
r_uint32
id|rdr_num
comma
r_uint16
id|width
)paren
suffix:semicolon
r_extern
r_uint64
id|perf_rdr_shift_in_U
(paren
r_uint32
id|rdr_num
comma
r_uint16
id|width
)paren
suffix:semicolon
r_extern
r_void
id|perf_rdr_shift_out_W
(paren
r_uint32
id|rdr_num
comma
r_uint64
id|buffer
)paren
suffix:semicolon
r_extern
r_void
id|perf_rdr_shift_out_U
(paren
r_uint32
id|rdr_num
comma
r_uint64
id|buffer
)paren
suffix:semicolon
r_extern
r_void
id|perf_intrigue_enable_perf_counters
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|perf_intrigue_disable_perf_counters
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/******************************************************************************&n; * Function Definitions&n; *****************************************************************************/
multiline_comment|/*&n; * configure:&n; *&n; * Configure the cpu with a given data image.  First turn off the counters, &n; * then download the image, then turn the counters back on.&n; */
DECL|function|perf_config
r_static
r_int
id|perf_config
c_func
(paren
r_uint32
op_star
id|image_ptr
)paren
(brace
r_int
id|error
suffix:semicolon
r_uint32
id|raddr
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* Stop the counters*/
id|error
op_assign
id|perf_stop_counters
c_func
(paren
id|raddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;perf_config: perf_stop_counters = %ld&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;Preparing to write image&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Write the image to the chip */
id|error
op_assign
id|perf_write_image
c_func
(paren
(paren
r_uint64
op_star
)paren
id|image_ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;perf_config: DOWNLOAD = %ld&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;Preparing to start counters&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Start the counters */
id|perf_start_counters
c_func
(paren
)paren
suffix:semicolon
r_return
r_sizeof
(paren
r_uint32
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Open the device and initialize all of it&squot;s memory.  The device is only &n; * opened once, but can be &quot;queried&quot; by multiple processes that know its&n; * file descriptor.&n; */
DECL|function|perf_open
r_static
r_int
id|perf_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|perf_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|perf_enabled
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|perf_lock
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|perf_enabled
op_assign
l_int|1
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|perf_lock
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Close the device.&n; */
DECL|function|perf_release
r_static
r_int
id|perf_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|perf_lock
)paren
suffix:semicolon
id|perf_enabled
op_assign
l_int|0
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|perf_lock
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Read does nothing for this driver&n; */
DECL|function|perf_read
r_static
id|ssize_t
id|perf_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|cnt
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * write:&n; *&n; * This routine downloads the image to the chip.  It must be&n; * called on the processor that the download should happen&n; * on.&n; */
DECL|function|perf_write
r_static
id|ssize_t
id|perf_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
id|err
suffix:semicolon
r_int
id|image_size
suffix:semicolon
r_uint32
id|image_type
suffix:semicolon
r_uint32
id|interface_type
suffix:semicolon
r_uint32
id|test
suffix:semicolon
r_if
c_cond
(paren
id|perf_processor_interface
op_eq
id|ONYX_INTF
)paren
id|image_size
op_assign
id|PCXU_IMAGE_SIZE
suffix:semicolon
r_else
r_if
c_cond
(paren
id|perf_processor_interface
op_eq
id|CUDA_INTF
)paren
id|image_size
op_assign
id|PCXW_IMAGE_SIZE
suffix:semicolon
r_else
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
id|count
op_ne
r_sizeof
(paren
r_uint32
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|image_type
comma
id|buf
comma
r_sizeof
(paren
r_uint32
)paren
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* Get the interface type and test type */
id|interface_type
op_assign
(paren
id|image_type
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|test
op_assign
(paren
id|image_type
op_amp
l_int|0xffff
)paren
suffix:semicolon
multiline_comment|/* Make sure everything makes sense */
multiline_comment|/* First check the machine type is correct for&n;&t;   the requested image */
r_if
c_cond
(paren
(paren
(paren
id|perf_processor_interface
op_eq
id|CUDA_INTF
)paren
op_logical_and
(paren
id|interface_type
op_ne
id|CUDA_INTF
)paren
)paren
op_logical_or
(paren
(paren
id|perf_processor_interface
op_eq
id|ONYX_INTF
)paren
op_logical_and
(paren
id|interface_type
op_ne
id|ONYX_INTF
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Next check to make sure the requested image&n;&t;   is valid */
r_if
c_cond
(paren
(paren
(paren
id|interface_type
op_eq
id|CUDA_INTF
)paren
op_logical_and
(paren
id|test
op_ge
id|MAX_CUDA_IMAGES
)paren
)paren
op_logical_or
(paren
(paren
id|interface_type
op_eq
id|ONYX_INTF
)paren
op_logical_and
(paren
id|test
op_ge
id|MAX_ONYX_IMAGES
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Copy the image into the processor */
r_if
c_cond
(paren
id|interface_type
op_eq
id|CUDA_INTF
)paren
r_return
id|perf_config
c_func
(paren
id|cuda_images
(braket
id|test
)braket
)paren
suffix:semicolon
r_else
r_return
id|perf_config
c_func
(paren
id|onyx_images
(braket
id|test
)braket
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*&n; * Patch the images that need to know the IVA addresses.&n; */
DECL|function|perf_patch_images
r_static
r_void
id|perf_patch_images
c_func
(paren
r_void
)paren
(brace
macro_line|#if 0 /* FIXME!! */
multiline_comment|/* &n; * NOTE:  this routine is VERY specific to the current TLB image.&n; * If the image is changed, this routine might also need to be changed.&n; */
r_extern
r_void
"$"
id|i_itlb_miss_2_0
c_func
(paren
)paren
suffix:semicolon
r_extern
r_void
"$"
id|i_dtlb_miss_2_0
c_func
(paren
)paren
suffix:semicolon
r_extern
r_void
id|PA2_0_iva
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * We can only use the lower 32-bits, the upper 32-bits should be 0&n;&t; * anyway given this is in the kernel &n;&t; */
r_uint32
id|itlb_addr
op_assign
(paren
r_uint32
)paren
op_amp
(paren
"$"
id|i_itlb_miss_2_0
)paren
suffix:semicolon
r_uint32
id|dtlb_addr
op_assign
(paren
r_uint32
)paren
op_amp
(paren
"$"
id|i_dtlb_miss_2_0
)paren
suffix:semicolon
r_uint32
id|IVAaddress
op_assign
(paren
r_uint32
)paren
op_amp
id|PA2_0_iva
suffix:semicolon
r_if
c_cond
(paren
id|perf_processor_interface
op_eq
id|ONYX_INTF
)paren
(brace
multiline_comment|/* clear last 2 bytes */
id|onyx_images
(braket
id|TLBMISS
)braket
(braket
l_int|15
)braket
op_and_assign
l_int|0xffffff00
suffix:semicolon
multiline_comment|/* set 2 bytes */
id|onyx_images
(braket
id|TLBMISS
)braket
(braket
l_int|15
)braket
op_or_assign
(paren
l_int|0x000000ff
op_amp
(paren
(paren
id|dtlb_addr
)paren
op_rshift
l_int|24
)paren
)paren
suffix:semicolon
id|onyx_images
(braket
id|TLBMISS
)braket
(braket
l_int|16
)braket
op_assign
(paren
id|dtlb_addr
op_lshift
l_int|8
)paren
op_amp
l_int|0xffffff00
suffix:semicolon
id|onyx_images
(braket
id|TLBMISS
)braket
(braket
l_int|17
)braket
op_assign
id|itlb_addr
suffix:semicolon
multiline_comment|/* clear last 2 bytes */
id|onyx_images
(braket
id|TLBHANDMISS
)braket
(braket
l_int|15
)braket
op_and_assign
l_int|0xffffff00
suffix:semicolon
multiline_comment|/* set 2 bytes */
id|onyx_images
(braket
id|TLBHANDMISS
)braket
(braket
l_int|15
)braket
op_or_assign
(paren
l_int|0x000000ff
op_amp
(paren
(paren
id|dtlb_addr
)paren
op_rshift
l_int|24
)paren
)paren
suffix:semicolon
id|onyx_images
(braket
id|TLBHANDMISS
)braket
(braket
l_int|16
)braket
op_assign
(paren
id|dtlb_addr
op_lshift
l_int|8
)paren
op_amp
l_int|0xffffff00
suffix:semicolon
id|onyx_images
(braket
id|TLBHANDMISS
)braket
(braket
l_int|17
)braket
op_assign
id|itlb_addr
suffix:semicolon
multiline_comment|/* clear last 2 bytes */
id|onyx_images
(braket
id|BIG_CPI
)braket
(braket
l_int|15
)braket
op_and_assign
l_int|0xffffff00
suffix:semicolon
multiline_comment|/* set 2 bytes */
id|onyx_images
(braket
id|BIG_CPI
)braket
(braket
l_int|15
)braket
op_or_assign
(paren
l_int|0x000000ff
op_amp
(paren
(paren
id|dtlb_addr
)paren
op_rshift
l_int|24
)paren
)paren
suffix:semicolon
id|onyx_images
(braket
id|BIG_CPI
)braket
(braket
l_int|16
)braket
op_assign
(paren
id|dtlb_addr
op_lshift
l_int|8
)paren
op_amp
l_int|0xffffff00
suffix:semicolon
id|onyx_images
(braket
id|BIG_CPI
)braket
(braket
l_int|17
)braket
op_assign
id|itlb_addr
suffix:semicolon
id|onyx_images
(braket
id|PANIC
)braket
(braket
l_int|15
)braket
op_and_assign
l_int|0xffffff00
suffix:semicolon
multiline_comment|/* clear last 2 bytes */
id|onyx_images
(braket
id|PANIC
)braket
(braket
l_int|15
)braket
op_or_assign
(paren
l_int|0x000000ff
op_amp
(paren
(paren
id|IVAaddress
)paren
op_rshift
l_int|24
)paren
)paren
suffix:semicolon
multiline_comment|/* set 2 bytes */
id|onyx_images
(braket
id|PANIC
)braket
(braket
l_int|16
)braket
op_assign
(paren
id|IVAaddress
op_lshift
l_int|8
)paren
op_amp
l_int|0xffffff00
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|perf_processor_interface
op_eq
id|CUDA_INTF
)paren
(brace
multiline_comment|/* Cuda interface */
id|cuda_images
(braket
id|TLBMISS
)braket
(braket
l_int|16
)braket
op_assign
(paren
id|cuda_images
(braket
id|TLBMISS
)braket
(braket
l_int|16
)braket
op_amp
l_int|0xffff0000
)paren
op_or
(paren
(paren
id|dtlb_addr
op_rshift
l_int|8
)paren
op_amp
l_int|0x0000ffff
)paren
suffix:semicolon
id|cuda_images
(braket
id|TLBMISS
)braket
(braket
l_int|17
)braket
op_assign
(paren
(paren
id|dtlb_addr
op_lshift
l_int|24
)paren
op_amp
l_int|0xff000000
)paren
op_or
(paren
(paren
id|itlb_addr
op_rshift
l_int|16
)paren
op_amp
l_int|0x000000ff
)paren
suffix:semicolon
id|cuda_images
(braket
id|TLBMISS
)braket
(braket
l_int|18
)braket
op_assign
(paren
id|itlb_addr
op_lshift
l_int|16
)paren
op_amp
l_int|0xffff0000
suffix:semicolon
id|cuda_images
(braket
id|TLBHANDMISS
)braket
(braket
l_int|16
)braket
op_assign
(paren
id|cuda_images
(braket
id|TLBHANDMISS
)braket
(braket
l_int|16
)braket
op_amp
l_int|0xffff0000
)paren
op_or
(paren
(paren
id|dtlb_addr
op_rshift
l_int|8
)paren
op_amp
l_int|0x0000ffff
)paren
suffix:semicolon
id|cuda_images
(braket
id|TLBHANDMISS
)braket
(braket
l_int|17
)braket
op_assign
(paren
(paren
id|dtlb_addr
op_lshift
l_int|24
)paren
op_amp
l_int|0xff000000
)paren
op_or
(paren
(paren
id|itlb_addr
op_rshift
l_int|16
)paren
op_amp
l_int|0x000000ff
)paren
suffix:semicolon
id|cuda_images
(braket
id|TLBHANDMISS
)braket
(braket
l_int|18
)braket
op_assign
(paren
id|itlb_addr
op_lshift
l_int|16
)paren
op_amp
l_int|0xffff0000
suffix:semicolon
id|cuda_images
(braket
id|BIG_CPI
)braket
(braket
l_int|16
)braket
op_assign
(paren
id|cuda_images
(braket
id|BIG_CPI
)braket
(braket
l_int|16
)braket
op_amp
l_int|0xffff0000
)paren
op_or
(paren
(paren
id|dtlb_addr
op_rshift
l_int|8
)paren
op_amp
l_int|0x0000ffff
)paren
suffix:semicolon
id|cuda_images
(braket
id|BIG_CPI
)braket
(braket
l_int|17
)braket
op_assign
(paren
(paren
id|dtlb_addr
op_lshift
l_int|24
)paren
op_amp
l_int|0xff000000
)paren
op_or
(paren
(paren
id|itlb_addr
op_rshift
l_int|16
)paren
op_amp
l_int|0x000000ff
)paren
suffix:semicolon
id|cuda_images
(braket
id|BIG_CPI
)braket
(braket
l_int|18
)braket
op_assign
(paren
id|itlb_addr
op_lshift
l_int|16
)paren
op_amp
l_int|0xffff0000
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Unknown type */
)brace
macro_line|#endif
)brace
multiline_comment|/*&n; * ioctl routine&n; * All routines effect the processor that they are executed on.  Thus you &n; * must be running on the processor that you wish to change.&n; */
DECL|function|perf_ioctl
r_static
r_int
id|perf_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|error_start
suffix:semicolon
r_uint32
id|raddr
(braket
l_int|4
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|PA_PERF_ON
suffix:colon
multiline_comment|/* Start the counters */
id|perf_start_counters
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|PA_PERF_OFF
suffix:colon
id|error_start
op_assign
id|perf_stop_counters
c_func
(paren
id|raddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error_start
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;perf_off: perf_stop_counters = %ld&bslash;n&quot;
comma
id|error_start
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* copy out the Counters */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
id|raddr
comma
r_sizeof
(paren
id|raddr
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|PA_PERF_VERSION
suffix:colon
multiline_comment|/* Return the version # */
r_return
id|put_user
c_func
(paren
id|PERF_VERSION
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
op_minus
id|ENOTTY
suffix:semicolon
)brace
DECL|variable|perf_fops
r_static
r_struct
id|file_operations
id|perf_fops
op_assign
(brace
id|llseek
suffix:colon
id|no_llseek
comma
id|read
suffix:colon
id|perf_read
comma
id|write
suffix:colon
id|perf_write
comma
id|ioctl
suffix:colon
id|perf_ioctl
comma
id|open
suffix:colon
id|perf_open
comma
id|release
suffix:colon
id|perf_release
)brace
suffix:semicolon
DECL|variable|perf_dev
r_static
r_struct
id|miscdevice
id|perf_dev
op_assign
(brace
id|MISC_DYNAMIC_MINOR
comma
id|PA_PERF_DEV
comma
op_amp
id|perf_fops
)brace
suffix:semicolon
multiline_comment|/*&n; * Initialize the module&n; */
DECL|function|perf_init
r_static
r_int
id|__init
id|perf_init
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Determine correct processor interface to use */
id|bitmask_array
op_assign
id|perf_bitmasks
suffix:semicolon
r_if
c_cond
(paren
id|boot_cpu_data.cpu_type
op_eq
id|pcxu
op_logical_or
id|boot_cpu_data.cpu_type
op_eq
id|pcxu_
)paren
(brace
id|perf_processor_interface
op_assign
id|ONYX_INTF
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|boot_cpu_data.cpu_type
op_eq
id|pcxw
op_logical_or
id|boot_cpu_data.cpu_type
op_eq
id|pcxw_
op_logical_or
id|boot_cpu_data.cpu_type
op_eq
id|pcxw2
)paren
(brace
id|perf_processor_interface
op_assign
id|CUDA_INTF
suffix:semicolon
r_if
c_cond
(paren
id|boot_cpu_data.cpu_type
op_eq
id|pcxw2
)paren
id|bitmask_array
op_assign
id|perf_bitmasks_piranha
suffix:semicolon
)brace
r_else
(brace
id|perf_processor_interface
op_assign
id|UNKNOWN_INTF
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Performance monitoring counters not supported on this processor&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Patch the images to match the system */
id|perf_patch_images
c_func
(paren
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|perf_lock
)paren
suffix:semicolon
id|misc_register
c_func
(paren
op_amp
id|perf_dev
)paren
suffix:semicolon
multiline_comment|/* TODO: this only lets us access the first cpu.. what to do for SMP? */
id|cpu_device
op_assign
id|cpu_data
(braket
l_int|0
)braket
dot
id|dev
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Performance monitoring counters enabled for %s&bslash;n&quot;
comma
id|cpu_data
(braket
l_int|0
)braket
dot
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * perf_start_counters(void)&n; *&n; * Start the counters.&n; */
DECL|function|perf_start_counters
r_static
r_void
id|perf_start_counters
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Enable performance monitor counters */
id|perf_intrigue_enable_perf_counters
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * perf_stop_counters&n; *&n; * Stop the performance counters and save counts&n; * in a per_processor array.&n; */
DECL|function|perf_stop_counters
r_static
r_int
id|perf_stop_counters
c_func
(paren
r_uint32
op_star
id|raddr
)paren
(brace
r_uint64
id|userbuf
(braket
id|MAX_RDR_WORDS
)braket
suffix:semicolon
multiline_comment|/* Disable performance counters */
id|perf_intrigue_disable_perf_counters
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|perf_processor_interface
op_eq
id|ONYX_INTF
)paren
(brace
r_uint64
id|tmp64
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Read the counters&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|perf_rdr_read_ubuf
c_func
(paren
l_int|16
comma
id|userbuf
)paren
)paren
r_return
op_minus
l_int|13
suffix:semicolon
multiline_comment|/* Counter0 is bits 1398 thru 1429 */
id|tmp64
op_assign
(paren
id|userbuf
(braket
l_int|21
)braket
op_lshift
l_int|22
)paren
op_amp
l_int|0x00000000ffc00000
suffix:semicolon
id|tmp64
op_or_assign
(paren
id|userbuf
(braket
l_int|22
)braket
op_rshift
l_int|42
)paren
op_amp
l_int|0x00000000003fffff
suffix:semicolon
multiline_comment|/* OR sticky0 (bit 1430) to counter0 bit 32 */
id|tmp64
op_or_assign
(paren
id|userbuf
(braket
l_int|22
)braket
op_rshift
l_int|10
)paren
op_amp
l_int|0x0000000080000000
suffix:semicolon
id|raddr
(braket
l_int|0
)braket
op_assign
(paren
r_uint32
)paren
id|tmp64
suffix:semicolon
multiline_comment|/* Counter1 is bits 1431 thru 1462 */
id|tmp64
op_assign
(paren
id|userbuf
(braket
l_int|22
)braket
op_rshift
l_int|9
)paren
op_amp
l_int|0x00000000ffffffff
suffix:semicolon
multiline_comment|/* OR sticky1 (bit 1463) to counter1 bit 32 */
id|tmp64
op_or_assign
(paren
id|userbuf
(braket
l_int|22
)braket
op_lshift
l_int|23
)paren
op_amp
l_int|0x0000000080000000
suffix:semicolon
id|raddr
(braket
l_int|1
)braket
op_assign
(paren
r_uint32
)paren
id|tmp64
suffix:semicolon
multiline_comment|/* Counter2 is bits 1464 thru 1495 */
id|tmp64
op_assign
(paren
id|userbuf
(braket
l_int|22
)braket
op_lshift
l_int|24
)paren
op_amp
l_int|0x00000000ff000000
suffix:semicolon
id|tmp64
op_or_assign
(paren
id|userbuf
(braket
l_int|23
)braket
op_rshift
l_int|40
)paren
op_amp
l_int|0x0000000000ffffff
suffix:semicolon
multiline_comment|/* OR sticky2 (bit 1496) to counter2 bit 32 */
id|tmp64
op_or_assign
(paren
id|userbuf
(braket
l_int|23
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|0x0000000080000000
suffix:semicolon
id|raddr
(braket
l_int|2
)braket
op_assign
(paren
r_uint32
)paren
id|tmp64
suffix:semicolon
multiline_comment|/* Counter3 is bits 1497 thru 1528 */
id|tmp64
op_assign
(paren
id|userbuf
(braket
l_int|23
)braket
op_rshift
l_int|7
)paren
op_amp
l_int|0x00000000ffffffff
suffix:semicolon
multiline_comment|/* OR sticky3 (bit 1529) to counter3 bit 32 */
id|tmp64
op_or_assign
(paren
id|userbuf
(braket
l_int|23
)braket
op_lshift
l_int|25
)paren
op_amp
l_int|0x0000000080000000
suffix:semicolon
id|raddr
(braket
l_int|3
)braket
op_assign
(paren
r_uint32
)paren
id|tmp64
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Zero out the counters&n;&t;&t; */
multiline_comment|/*&n;&t;&t; * The counters and sticky-bits comprise the last 132 bits&n;&t;&t; * (1398 - 1529) of RDR16 on a U chip.  We&squot;ll zero these&n;&t;&t; * out the easy way: zero out last 10 bits of dword 21,&n;&t;&t; * all of dword 22 and 58 bits (plus 6 don&squot;t care bits) of&n;&t;&t; * dword 23.&n;&t;&t; */
id|userbuf
(braket
l_int|21
)braket
op_and_assign
l_int|0xfffffffffffffc00
suffix:semicolon
multiline_comment|/* 0 to last 10 bits */
id|userbuf
(braket
l_int|22
)braket
op_assign
l_int|0
suffix:semicolon
id|userbuf
(braket
l_int|23
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* &n;&t;&t; * Write back the zero&squot;ed bytes + the image given&n;&t;&t; * the read was destructive.&n;&t;&t; */
id|perf_rdr_write
c_func
(paren
l_int|16
comma
id|userbuf
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Read RDR-15 which contains the counters and sticky bits &n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|perf_rdr_read_ubuf
c_func
(paren
l_int|15
comma
id|userbuf
)paren
)paren
(brace
r_return
op_minus
l_int|13
suffix:semicolon
)brace
multiline_comment|/* &n;&t;&t; * Clear out the counters&n;&t;&t; */
id|perf_rdr_clear
c_func
(paren
l_int|15
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Copy the counters &n;&t;&t; */
id|raddr
(braket
l_int|0
)braket
op_assign
(paren
r_uint32
)paren
(paren
(paren
id|userbuf
(braket
l_int|0
)braket
op_rshift
l_int|32
)paren
op_amp
l_int|0x00000000ffffffffUL
)paren
suffix:semicolon
id|raddr
(braket
l_int|1
)braket
op_assign
(paren
r_uint32
)paren
(paren
id|userbuf
(braket
l_int|0
)braket
op_amp
l_int|0x00000000ffffffffUL
)paren
suffix:semicolon
id|raddr
(braket
l_int|2
)braket
op_assign
(paren
r_uint32
)paren
(paren
(paren
id|userbuf
(braket
l_int|1
)braket
op_rshift
l_int|32
)paren
op_amp
l_int|0x00000000ffffffffUL
)paren
suffix:semicolon
id|raddr
(braket
l_int|3
)braket
op_assign
(paren
r_uint32
)paren
(paren
id|userbuf
(braket
l_int|1
)braket
op_amp
l_int|0x00000000ffffffffUL
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * perf_rdr_get_entry&n; *&n; * Retrieve a pointer to the description of what this&n; * RDR contains.&n; */
DECL|function|perf_rdr_get_entry
r_static
r_struct
id|rdr_tbl_ent
op_star
id|perf_rdr_get_entry
c_func
(paren
r_uint32
id|rdr_num
)paren
(brace
r_if
c_cond
(paren
id|perf_processor_interface
op_eq
id|ONYX_INTF
)paren
(brace
r_return
op_amp
id|perf_rdr_tbl_U
(braket
id|rdr_num
)braket
suffix:semicolon
)brace
r_else
(brace
r_return
op_amp
id|perf_rdr_tbl_W
(braket
id|rdr_num
)braket
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * perf_rdr_read_ubuf&n; *&n; * Read the RDR value into the buffer specified.&n; */
DECL|function|perf_rdr_read_ubuf
r_static
r_int
id|perf_rdr_read_ubuf
c_func
(paren
r_uint32
id|rdr_num
comma
r_uint64
op_star
id|buffer
)paren
(brace
r_uint64
id|data
comma
id|data_mask
op_assign
l_int|0
suffix:semicolon
r_uint32
id|width
comma
id|xbits
comma
id|i
suffix:semicolon
r_struct
id|rdr_tbl_ent
op_star
id|tentry
suffix:semicolon
id|tentry
op_assign
id|perf_rdr_get_entry
c_func
(paren
id|rdr_num
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|width
op_assign
id|tentry-&gt;width
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Clear out buffer */
id|i
op_assign
id|tentry-&gt;num_words
suffix:semicolon
r_while
c_loop
(paren
id|i
op_decrement
)paren
(brace
id|buffer
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Check for bits an even number of 64 */
r_if
c_cond
(paren
(paren
id|xbits
op_assign
id|width
op_amp
l_int|0x03f
)paren
op_ne
l_int|0
)paren
(brace
id|data_mask
op_assign
l_int|1
suffix:semicolon
id|data_mask
op_lshift_assign
(paren
l_int|64
op_minus
id|xbits
)paren
suffix:semicolon
id|data_mask
op_decrement
suffix:semicolon
)brace
multiline_comment|/* Grab all of the data */
id|i
op_assign
id|tentry-&gt;num_words
suffix:semicolon
r_while
c_loop
(paren
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|perf_processor_interface
op_eq
id|ONYX_INTF
)paren
(brace
id|data
op_assign
id|perf_rdr_shift_in_U
c_func
(paren
id|rdr_num
comma
id|width
)paren
suffix:semicolon
)brace
r_else
(brace
id|data
op_assign
id|perf_rdr_shift_in_W
c_func
(paren
id|rdr_num
comma
id|width
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|xbits
)paren
(brace
id|buffer
(braket
id|i
)braket
op_or_assign
(paren
id|data
op_lshift
(paren
l_int|64
op_minus
id|xbits
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
id|buffer
(braket
id|i
op_minus
l_int|1
)braket
op_or_assign
(paren
(paren
id|data
op_rshift
id|xbits
)paren
op_amp
id|data_mask
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|buffer
(braket
id|i
)braket
op_assign
id|data
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * perf_rdr_clear&n; *&n; * Zero out the given RDR register&n; */
DECL|function|perf_rdr_clear
r_static
r_int
id|perf_rdr_clear
c_func
(paren
r_uint32
id|rdr_num
)paren
(brace
r_struct
id|rdr_tbl_ent
op_star
id|tentry
suffix:semicolon
r_int32
id|i
suffix:semicolon
id|tentry
op_assign
id|perf_rdr_get_entry
c_func
(paren
id|rdr_num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tentry-&gt;width
op_eq
l_int|0
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|i
op_assign
id|tentry-&gt;num_words
suffix:semicolon
r_while
c_loop
(paren
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|perf_processor_interface
op_eq
id|ONYX_INTF
)paren
(brace
id|perf_rdr_shift_out_U
c_func
(paren
id|rdr_num
comma
l_int|0UL
)paren
suffix:semicolon
)brace
r_else
(brace
id|perf_rdr_shift_out_W
c_func
(paren
id|rdr_num
comma
l_int|0UL
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * perf_write_image&n; *&n; * Write the given image out to the processor&n; */
DECL|function|perf_write_image
r_static
r_int
id|perf_write_image
c_func
(paren
r_uint64
op_star
id|memaddr
)paren
(brace
r_uint64
id|buffer
(braket
id|MAX_RDR_WORDS
)braket
suffix:semicolon
r_uint64
op_star
id|bptr
suffix:semicolon
r_uint32
id|dwords
suffix:semicolon
r_uint32
op_star
id|intrigue_rdr
suffix:semicolon
r_uint64
op_star
id|intrigue_bitmask
comma
id|tmp64
comma
id|proc_hpa
suffix:semicolon
r_struct
id|rdr_tbl_ent
op_star
id|tentry
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Clear out counters */
r_if
c_cond
(paren
id|perf_processor_interface
op_eq
id|ONYX_INTF
)paren
(brace
id|perf_rdr_clear
c_func
(paren
l_int|16
)paren
suffix:semicolon
multiline_comment|/* Toggle performance monitor */
id|perf_intrigue_enable_perf_counters
c_func
(paren
)paren
suffix:semicolon
id|perf_intrigue_disable_perf_counters
c_func
(paren
)paren
suffix:semicolon
id|intrigue_rdr
op_assign
id|perf_rdrs_U
suffix:semicolon
)brace
r_else
(brace
id|perf_rdr_clear
c_func
(paren
l_int|15
)paren
suffix:semicolon
id|intrigue_rdr
op_assign
id|perf_rdrs_W
suffix:semicolon
)brace
multiline_comment|/* Write all RDRs */
r_while
c_loop
(paren
op_star
id|intrigue_rdr
op_ne
op_minus
l_int|1
)paren
(brace
id|tentry
op_assign
id|perf_rdr_get_entry
c_func
(paren
op_star
id|intrigue_rdr
)paren
suffix:semicolon
id|perf_rdr_read_ubuf
c_func
(paren
op_star
id|intrigue_rdr
comma
id|buffer
)paren
suffix:semicolon
id|bptr
op_assign
op_amp
id|buffer
(braket
l_int|0
)braket
suffix:semicolon
id|dwords
op_assign
id|tentry-&gt;num_words
suffix:semicolon
r_if
c_cond
(paren
id|tentry-&gt;write_control
)paren
(brace
id|intrigue_bitmask
op_assign
op_amp
id|bitmask_array
(braket
id|tentry-&gt;write_control
op_rshift
l_int|3
)braket
suffix:semicolon
r_while
c_loop
(paren
id|dwords
op_decrement
)paren
(brace
id|tmp64
op_assign
op_star
id|intrigue_bitmask
op_amp
op_star
id|memaddr
op_increment
suffix:semicolon
id|tmp64
op_or_assign
(paren
op_complement
(paren
op_star
id|intrigue_bitmask
op_increment
)paren
)paren
op_amp
op_star
id|bptr
suffix:semicolon
op_star
id|bptr
op_increment
op_assign
id|tmp64
suffix:semicolon
)brace
)brace
r_else
(brace
r_while
c_loop
(paren
id|dwords
op_decrement
)paren
(brace
op_star
id|bptr
op_increment
op_assign
op_star
id|memaddr
op_increment
suffix:semicolon
)brace
)brace
id|perf_rdr_write
c_func
(paren
op_star
id|intrigue_rdr
comma
id|buffer
)paren
suffix:semicolon
id|intrigue_rdr
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Now copy out the Runway stuff which is not in RDRs&n;&t; */
r_if
c_cond
(paren
id|cpu_device
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;write_image: cpu_device not yet initialized!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|proc_hpa
op_assign
id|cpu_device-&gt;hpa
suffix:semicolon
multiline_comment|/* Merge intrigue bits into Runway STATUS 0 */
id|tmp64
op_assign
id|__raw_readq
c_func
(paren
id|proc_hpa
op_plus
id|RUNWAY_STATUS
)paren
op_amp
l_int|0xffecffffffffffff
suffix:semicolon
id|__raw_writeq
c_func
(paren
id|tmp64
op_or
(paren
op_star
id|memaddr
op_increment
op_amp
l_int|0x0013000000000000
)paren
comma
id|proc_hpa
op_plus
id|RUNWAY_STATUS
)paren
suffix:semicolon
multiline_comment|/* Write RUNWAY DEBUG registers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|__raw_writeq
c_func
(paren
op_star
id|memaddr
op_increment
comma
id|proc_hpa
op_plus
id|RUNWAY_DEBUG
op_plus
id|i
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * perf_rdr_write&n; *&n; * Write the given RDR register with the contents&n; * of the given buffer.&n; */
DECL|function|perf_rdr_write
r_static
r_void
id|perf_rdr_write
c_func
(paren
r_uint32
id|rdr_num
comma
r_uint64
op_star
id|buffer
)paren
(brace
r_struct
id|rdr_tbl_ent
op_star
id|tentry
suffix:semicolon
r_int32
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;perf_rdr_write&bslash;n&quot;
)paren
suffix:semicolon
id|tentry
op_assign
id|perf_rdr_get_entry
c_func
(paren
id|rdr_num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tentry-&gt;width
op_eq
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
id|i
op_assign
id|tentry-&gt;num_words
suffix:semicolon
r_while
c_loop
(paren
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|perf_processor_interface
op_eq
id|ONYX_INTF
)paren
(brace
id|perf_rdr_shift_out_U
c_func
(paren
id|rdr_num
comma
id|buffer
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|perf_rdr_shift_out_W
c_func
(paren
id|rdr_num
comma
id|buffer
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;perf_rdr_write done&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|variable|perf_init
id|module_init
c_func
(paren
id|perf_init
)paren
suffix:semicolon
eof
