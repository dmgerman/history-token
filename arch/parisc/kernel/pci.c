multiline_comment|/* $Id: pci.c,v 1.6 2000/01/29 00:12:05 grundler Exp $&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Copyright (C) 1997, 1998 Ralf Baechle&n; * Copyright (C) 1999 SuSE GmbH&n; * Copyright (C) 1999-2001 Hewlett-Packard Company&n; * Copyright (C) 1999-2001 Grant Grundler&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/cache.h&gt;&t;&t;/* for L1_CACHE_BYTES */
DECL|macro|DEBUG_RESOURCES
mdefine_line|#define DEBUG_RESOURCES 0
DECL|macro|DEBUG_CONFIG
mdefine_line|#define DEBUG_CONFIG 0
macro_line|#if DEBUG_CONFIG
DECL|macro|DBGC
macro_line|# define DBGC(x...)&t;printk(KERN_DEBUG x)
macro_line|#else
DECL|macro|DBGC
macro_line|# define DBGC(x...)
macro_line|#endif
macro_line|#if DEBUG_RESOURCES
DECL|macro|DBG_RES
mdefine_line|#define DBG_RES(x...)&t;printk(KERN_DEBUG x)
macro_line|#else
DECL|macro|DBG_RES
mdefine_line|#define DBG_RES(x...)
macro_line|#endif
multiline_comment|/* To be used as: mdelay(pci_post_reset_delay);&n; *&n; * post_reset is the time the kernel should stall to prevent anyone from&n; * accessing the PCI bus once #RESET is de-asserted. &n; * PCI spec somewhere says 1 second but with multi-PCI bus systems,&n; * this makes the boot time much longer than necessary.&n; * 20ms seems to work for all the HP PCI implementations to date.&n; *&n; * XXX: turn into a #defined constant in &lt;asm/pci.h&gt; ?&n; */
DECL|variable|pci_post_reset_delay
r_int
id|pci_post_reset_delay
op_assign
l_int|50
suffix:semicolon
DECL|variable|pci_port
r_struct
id|pci_port_ops
op_star
id|pci_port
suffix:semicolon
DECL|variable|pci_bios
r_struct
id|pci_bios_ops
op_star
id|pci_bios
suffix:semicolon
DECL|variable|pci_hba_count
r_int
id|pci_hba_count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* parisc_pci_hba used by pci_port-&gt;in/out() ops to lookup bus data.  */
DECL|macro|PCI_HBA_MAX
mdefine_line|#define PCI_HBA_MAX 32
DECL|variable|parisc_pci_hba
r_struct
id|pci_hba_data
op_star
id|parisc_pci_hba
(braket
id|PCI_HBA_MAX
)braket
suffix:semicolon
multiline_comment|/********************************************************************&n;**&n;** I/O port space support&n;**&n;*********************************************************************/
multiline_comment|/* EISA port numbers and PCI port numbers share the same interface.  Some&n; * machines have both EISA and PCI adapters installed.  Rather than turn&n; * pci_port into an array, we reserve bus 0 for EISA and call the EISA&n; * routines if the access is to a port on bus 0.  We don&squot;t want to fix&n; * EISA and ISA drivers which assume port space is &lt;= 0xffff.&n; */
macro_line|#ifdef CONFIG_EISA
DECL|macro|EISA_IN
mdefine_line|#define EISA_IN(size) if (EISA_bus &amp;&amp; (b == 0)) return eisa_in##size(addr)
DECL|macro|EISA_OUT
mdefine_line|#define EISA_OUT(size) if (EISA_bus &amp;&amp; (b == 0)) return eisa_out##size(d, addr)
macro_line|#else
DECL|macro|EISA_IN
mdefine_line|#define EISA_IN(size)
DECL|macro|EISA_OUT
mdefine_line|#define EISA_OUT(size)
macro_line|#endif
DECL|macro|PCI_PORT_IN
mdefine_line|#define PCI_PORT_IN(type, size) &bslash;&n;u##size in##type (int addr) &bslash;&n;{ &bslash;&n;&t;int b = PCI_PORT_HBA(addr); &bslash;&n;&t;EISA_IN(size); &bslash;&n;&t;if (!parisc_pci_hba[b]) return (u##size) -1; &bslash;&n;&t;return pci_port-&gt;in##type(parisc_pci_hba[b], PCI_PORT_ADDR(addr)); &bslash;&n;}
id|PCI_PORT_IN
c_func
(paren
id|b
comma
l_int|8
)paren
id|PCI_PORT_IN
c_func
(paren
id|w
comma
l_int|16
)paren
id|PCI_PORT_IN
c_func
(paren
id|l
comma
l_int|32
)paren
DECL|macro|PCI_PORT_OUT
mdefine_line|#define PCI_PORT_OUT(type, size) &bslash;&n;void out##type (u##size d, int addr) &bslash;&n;{ &bslash;&n;&t;int b = PCI_PORT_HBA(addr); &bslash;&n;&t;EISA_OUT(size); &bslash;&n;&t;if (!parisc_pci_hba[b]) return; &bslash;&n;&t;pci_port-&gt;out##type(parisc_pci_hba[b], PCI_PORT_ADDR(addr), d); &bslash;&n;}
id|PCI_PORT_OUT
c_func
(paren
id|b
comma
l_int|8
)paren
id|PCI_PORT_OUT
c_func
(paren
id|w
comma
l_int|16
)paren
id|PCI_PORT_OUT
c_func
(paren
id|l
comma
l_int|32
)paren
multiline_comment|/*&n; * BIOS32 replacement.&n; */
DECL|function|pcibios_init
r_static
r_int
id|__init
id|pcibios_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pci_bios
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pci_bios-&gt;init
)paren
(brace
id|pci_bios
op_member_access_from_pointer
id|init
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;pci_bios != NULL but init() is!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Called from pci_do_scan_bus() *after* walking a bus but before walking PPBs. */
DECL|function|pcibios_fixup_bus
r_void
id|pcibios_fixup_bus
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
)paren
(brace
r_if
c_cond
(paren
id|pci_bios-&gt;fixup_bus
)paren
(brace
id|pci_bios
op_member_access_from_pointer
id|fixup_bus
c_func
(paren
id|bus
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;pci_bios != NULL but fixup_bus() is!&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|pcibios_setup
r_char
op_star
id|pcibios_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_return
id|str
suffix:semicolon
)brace
multiline_comment|/* Used in drivers/pci/quirks.c */
DECL|variable|pcibios_fixups
r_struct
id|pci_fixup
id|pcibios_fixups
(braket
)braket
op_assign
(brace
(brace
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; * Called by pci_set_master() - a driver interface.&n; *&n; * Legacy PDC guarantees to set:&n; *&t;Map Memory BAR&squot;s into PA IO space.&n; *&t;Map Expansion ROM BAR into one common PA IO space per bus.&n; *&t;Map IO BAR&squot;s into PCI IO space.&n; *&t;Command (see below)&n; *&t;Cache Line Size&n; *&t;Latency Timer&n; *&t;Interrupt Line&n; *&t;PPB: secondary latency timer, io/mmio base/limit,&n; *&t;&t;bus numbers, bridge control&n; *&n; */
DECL|function|pcibios_set_master
r_void
id|pcibios_set_master
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|u8
id|lat
suffix:semicolon
multiline_comment|/* If someone already mucked with this, don&squot;t touch it. */
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|PCI_LATENCY_TIMER
comma
op_amp
id|lat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lat
op_ge
l_int|16
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t;** HP generally has fewer devices on the bus than other architectures.&n;&t;** upper byte is PCI_LATENCY_TIMER.&n;&t;*/
id|pci_write_config_word
c_func
(paren
id|dev
comma
id|PCI_CACHE_LINE_SIZE
comma
(paren
l_int|0x80
op_lshift
l_int|8
)paren
op_or
(paren
id|L1_CACHE_BYTES
op_div
r_sizeof
(paren
id|u32
)paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|pcibios_init_bus
r_void
id|__init
id|pcibios_init_bus
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
op_assign
id|bus-&gt;self
suffix:semicolon
r_int
r_int
id|bridge_ctl
suffix:semicolon
multiline_comment|/* We deal only with pci controllers and pci-pci bridges. */
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
(paren
id|dev
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_ne
id|PCI_CLASS_BRIDGE_PCI
)paren
r_return
suffix:semicolon
multiline_comment|/* PCI-PCI bridge - set the cache line and default latency&n;&t;   (32) for primary and secondary buses. */
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|PCI_SEC_LATENCY_TIMER
comma
l_int|32
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|dev
comma
id|PCI_BRIDGE_CONTROL
comma
op_amp
id|bridge_ctl
)paren
suffix:semicolon
id|bridge_ctl
op_or_assign
id|PCI_BRIDGE_CTL_PARITY
op_or
id|PCI_BRIDGE_CTL_SERR
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|dev
comma
id|PCI_BRIDGE_CONTROL
comma
id|bridge_ctl
)paren
suffix:semicolon
)brace
multiline_comment|/* KLUGE: Link the child and parent resources - generic PCI didn&squot;t */
r_static
r_void
DECL|function|pcibios_link_hba_resources
id|pcibios_link_hba_resources
c_func
(paren
r_struct
id|resource
op_star
id|hba_res
comma
r_struct
id|resource
op_star
id|r
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|r-&gt;parent
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;PCI: Tell willy he&squot;s wrong&bslash;n&quot;
)paren
suffix:semicolon
id|r-&gt;parent
op_assign
id|hba_res
suffix:semicolon
multiline_comment|/* reverse link is harder *sigh*  */
r_if
c_cond
(paren
id|r-&gt;parent-&gt;child
)paren
(brace
r_if
c_cond
(paren
id|r-&gt;parent-&gt;sibling
)paren
(brace
r_struct
id|resource
op_star
id|next
op_assign
id|r-&gt;parent-&gt;sibling
suffix:semicolon
r_while
c_loop
(paren
id|next-&gt;sibling
)paren
id|next
op_assign
id|next-&gt;sibling
suffix:semicolon
id|next-&gt;sibling
op_assign
id|r
suffix:semicolon
)brace
r_else
(brace
id|r-&gt;parent-&gt;sibling
op_assign
id|r
suffix:semicolon
)brace
)brace
r_else
id|r-&gt;parent-&gt;child
op_assign
id|r
suffix:semicolon
)brace
)brace
multiline_comment|/* called by drivers/pci/setup-bus.c:pci_setup_bridge().  */
DECL|function|pcibios_resource_to_bus
r_void
id|__devinit
id|pcibios_resource_to_bus
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_struct
id|pci_bus_region
op_star
id|region
comma
r_struct
id|resource
op_star
id|res
)paren
(brace
r_struct
id|pci_bus
op_star
id|bus
op_assign
id|dev-&gt;bus
suffix:semicolon
r_struct
id|pci_hba_data
op_star
id|hba
op_assign
id|HBA_DATA
c_func
(paren
id|bus-&gt;dev-&gt;platform_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res-&gt;flags
op_amp
id|IORESOURCE_IO
)paren
(brace
multiline_comment|/*&n;&t;&t;** I/O space may see busnumbers here. Something&n;&t;&t;** in the form of 0xbbxxxx where bb is the bus num&n;&t;&t;** and xxxx is the I/O port space address.&n;&t;&t;** Remaining address translation are done in the&n;&t;&t;** PCI Host adapter specific code - ie dino_out8.&n;&t;&t;*/
id|region-&gt;start
op_assign
id|PCI_PORT_ADDR
c_func
(paren
id|res-&gt;start
)paren
suffix:semicolon
id|region-&gt;end
op_assign
id|PCI_PORT_ADDR
c_func
(paren
id|res-&gt;end
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|res-&gt;flags
op_amp
id|IORESOURCE_MEM
)paren
(brace
multiline_comment|/* Convert MMIO addr to PCI addr (undo global virtualization) */
id|region-&gt;start
op_assign
id|PCI_BUS_ADDR
c_func
(paren
id|hba
comma
id|res-&gt;start
)paren
suffix:semicolon
id|region-&gt;end
op_assign
id|PCI_BUS_ADDR
c_func
(paren
id|hba
comma
id|res-&gt;end
)paren
suffix:semicolon
)brace
id|DBG_RES
c_func
(paren
l_string|&quot;pcibios_resource_to_bus(%02x %s [%lx,%lx])&bslash;n&quot;
comma
id|bus-&gt;number
comma
id|res-&gt;flags
op_amp
id|IORESOURCE_IO
ques
c_cond
l_string|&quot;IO&quot;
suffix:colon
l_string|&quot;MEM&quot;
comma
id|region-&gt;start
comma
id|region-&gt;end
)paren
suffix:semicolon
multiline_comment|/* KLUGE ALERT&n;&t;** if this resource isn&squot;t linked to a &quot;parent&quot;, then it seems&n;&t;** to be a child of the HBA - lets link it in.&n;&t;*/
id|pcibios_link_hba_resources
c_func
(paren
op_amp
id|hba-&gt;io_space
comma
id|bus-&gt;resource
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|pcibios_link_hba_resources
c_func
(paren
op_amp
id|hba-&gt;lmmio_space
comma
id|bus-&gt;resource
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_HOTPLUG
DECL|variable|pcibios_resource_to_bus
id|EXPORT_SYMBOL
c_func
(paren
id|pcibios_resource_to_bus
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * pcibios align resources() is called every time generic PCI code&n; * wants to generate a new address. The process of looking for&n; * an available address, each candidate is first &quot;aligned&quot; and&n; * then checked if the resource is available until a match is found.&n; *&n; * Since we are just checking candidates, don&squot;t use any fields other&n; * than res-&gt;start.&n; */
DECL|function|pcibios_align_resource
r_void
id|pcibios_align_resource
c_func
(paren
r_void
op_star
id|data
comma
r_struct
id|resource
op_star
id|res
comma
r_int
r_int
id|size
comma
r_int
r_int
id|alignment
)paren
(brace
r_int
r_int
id|mask
comma
id|align
suffix:semicolon
id|DBG_RES
c_func
(paren
l_string|&quot;pcibios_align_resource(%s, (%p) [%lx,%lx]/%x, 0x%lx, 0x%lx)&bslash;n&quot;
comma
id|pci_name
c_func
(paren
(paren
(paren
r_struct
id|pci_dev
op_star
)paren
id|data
)paren
)paren
comma
id|res-&gt;parent
comma
id|res-&gt;start
comma
id|res-&gt;end
comma
(paren
r_int
)paren
id|res-&gt;flags
comma
id|size
comma
id|alignment
)paren
suffix:semicolon
multiline_comment|/* If it&squot;s not IO, then it&squot;s gotta be MEM */
id|align
op_assign
(paren
id|res-&gt;flags
op_amp
id|IORESOURCE_IO
)paren
ques
c_cond
id|PCIBIOS_MIN_IO
suffix:colon
id|PCIBIOS_MIN_MEM
suffix:semicolon
multiline_comment|/* Align to largest of MIN or input size */
id|mask
op_assign
id|max
c_func
(paren
id|alignment
comma
id|align
)paren
op_minus
l_int|1
suffix:semicolon
id|res-&gt;start
op_add_assign
id|mask
suffix:semicolon
id|res-&gt;start
op_and_assign
op_complement
id|mask
suffix:semicolon
multiline_comment|/* The caller updates the end field, we don&squot;t.  */
)brace
multiline_comment|/*&n; * A driver is enabling the device.  We make sure that all the appropriate&n; * bits are set to allow the device to operate as the driver is expecting.&n; * We enable the port IO and memory IO bits if the device has any BARs of&n; * that type, and we enable the PERR and SERR bits unconditionally.&n; * Drivers that do not need parity (eg graphics and possibly networking)&n; * can clear these bits if they want.&n; */
DECL|function|pcibios_enable_device
r_int
id|pcibios_enable_device
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|mask
)paren
(brace
id|u16
id|cmd
suffix:semicolon
r_int
id|idx
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|DEVICE_COUNT_RESOURCE
suffix:semicolon
id|idx
op_increment
)paren
(brace
r_struct
id|resource
op_star
id|r
op_assign
op_amp
id|dev-&gt;resource
(braket
id|idx
)braket
suffix:semicolon
multiline_comment|/* only setup requested resources */
r_if
c_cond
(paren
op_logical_neg
(paren
id|mask
op_amp
(paren
l_int|1
op_lshift
id|idx
)paren
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|r-&gt;flags
op_amp
id|IORESOURCE_IO
)paren
id|cmd
op_or_assign
id|PCI_COMMAND_IO
suffix:semicolon
r_if
c_cond
(paren
id|r-&gt;flags
op_amp
id|IORESOURCE_MEM
)paren
id|cmd
op_or_assign
id|PCI_COMMAND_MEMORY
suffix:semicolon
)brace
id|cmd
op_or_assign
(paren
id|PCI_COMMAND_SERR
op_or
id|PCI_COMMAND_PARITY
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* If bridge/bus controller has FBB enabled, child must too. */
r_if
c_cond
(paren
id|dev-&gt;bus-&gt;bridge_ctl
op_amp
id|PCI_BRIDGE_CTL_FAST_BACK
)paren
id|cmd
op_or_assign
id|PCI_COMMAND_FAST_BACK
suffix:semicolon
macro_line|#endif
id|DBGC
c_func
(paren
l_string|&quot;PCIBIOS: Enabling device %s cmd 0x%04x&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|dev
)paren
comma
id|cmd
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
id|cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* PA-RISC specific */
DECL|function|pcibios_register_hba
r_void
id|pcibios_register_hba
c_func
(paren
r_struct
id|pci_hba_data
op_star
id|hba
)paren
(brace
r_if
c_cond
(paren
id|pci_hba_count
op_ge
id|PCI_HBA_MAX
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PCI: Too many Host Bus Adapters&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|parisc_pci_hba
(braket
id|pci_hba_count
)braket
op_assign
id|hba
suffix:semicolon
id|hba-&gt;hba_num
op_assign
id|pci_hba_count
op_increment
suffix:semicolon
)brace
DECL|variable|pcibios_init
id|subsys_initcall
c_func
(paren
id|pcibios_init
)paren
suffix:semicolon
eof
