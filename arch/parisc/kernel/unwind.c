multiline_comment|/*&n; * Kernel unwinding support&n; *&n; * (c) 2002-2004 Randolph Chung &lt;tausq@debian.org&gt;&n; *&n; * Derived partially from the IA64 implementation. The PA-RISC&n; * Runtime Architecture Document is also a useful reference to&n; * understand what is happening here&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/unwind.h&gt;
multiline_comment|/* #define DEBUG 1 */
macro_line|#ifdef DEBUG
DECL|macro|dbg
mdefine_line|#define dbg(x...) printk(x)
macro_line|#else
DECL|macro|dbg
mdefine_line|#define dbg(x...)
macro_line|#endif
r_extern
r_struct
id|unwind_table_entry
id|__start___unwind
(braket
)braket
suffix:semicolon
r_extern
r_struct
id|unwind_table_entry
id|__stop___unwind
(braket
)braket
suffix:semicolon
DECL|variable|unwind_lock
r_static
id|spinlock_t
id|unwind_lock
suffix:semicolon
multiline_comment|/*&n; * the kernel unwind block is not dynamically allocated so that&n; * we can call unwind_init as early in the bootup process as &n; * possible (before the slab allocator is initialized)&n; */
DECL|variable|kernel_unwind_table
r_static
r_struct
id|unwind_table
id|kernel_unwind_table
suffix:semicolon
DECL|variable|unwind_tables
DECL|variable|unwind_tables_end
r_static
r_struct
id|unwind_table
op_star
id|unwind_tables
comma
op_star
id|unwind_tables_end
suffix:semicolon
r_static
r_inline
r_const
r_struct
id|unwind_table_entry
op_star
DECL|function|find_unwind_entry_in_table
id|find_unwind_entry_in_table
c_func
(paren
r_const
r_struct
id|unwind_table
op_star
id|table
comma
r_int
r_int
id|addr
)paren
(brace
r_const
r_struct
id|unwind_table_entry
op_star
id|e
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|lo
comma
id|hi
comma
id|mid
suffix:semicolon
r_for
c_loop
(paren
id|lo
op_assign
l_int|0
comma
id|hi
op_assign
id|table-&gt;length
suffix:semicolon
id|lo
OL
id|hi
suffix:semicolon
)paren
(brace
id|mid
op_assign
(paren
id|lo
op_plus
id|hi
)paren
op_div
l_int|2
suffix:semicolon
id|e
op_assign
op_amp
id|table-&gt;table
(braket
id|mid
)braket
suffix:semicolon
r_if
c_cond
(paren
id|addr
OL
id|e-&gt;region_start
)paren
id|hi
op_assign
id|mid
suffix:semicolon
r_else
r_if
c_cond
(paren
id|addr
OG
id|e-&gt;region_end
)paren
id|lo
op_assign
id|mid
op_plus
l_int|1
suffix:semicolon
r_else
r_break
suffix:semicolon
)brace
r_return
id|e
suffix:semicolon
)brace
r_static
r_inline
r_const
r_struct
id|unwind_table_entry
op_star
DECL|function|find_unwind_entry
id|find_unwind_entry
c_func
(paren
r_int
r_int
id|addr
)paren
(brace
r_struct
id|unwind_table
op_star
id|table
op_assign
id|unwind_tables
suffix:semicolon
r_const
r_struct
id|unwind_table_entry
op_star
id|e
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_ge
id|kernel_unwind_table.start
op_logical_and
id|addr
op_le
id|kernel_unwind_table.end
)paren
id|e
op_assign
id|find_unwind_entry_in_table
c_func
(paren
op_amp
id|kernel_unwind_table
comma
id|addr
)paren
suffix:semicolon
r_else
r_for
c_loop
(paren
suffix:semicolon
id|table
suffix:semicolon
id|table
op_assign
id|table-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|addr
op_ge
id|table-&gt;start
op_logical_and
id|addr
op_le
id|table-&gt;end
)paren
id|e
op_assign
id|find_unwind_entry_in_table
c_func
(paren
id|table
comma
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|e
)paren
r_break
suffix:semicolon
)brace
r_return
id|e
suffix:semicolon
)brace
r_static
r_void
DECL|function|unwind_table_init
id|unwind_table_init
c_func
(paren
r_struct
id|unwind_table
op_star
id|table
comma
r_const
r_char
op_star
id|name
comma
r_int
r_int
id|base_addr
comma
r_int
r_int
id|gp
comma
r_void
op_star
id|table_start
comma
r_void
op_star
id|table_end
)paren
(brace
r_struct
id|unwind_table_entry
op_star
id|start
op_assign
id|table_start
suffix:semicolon
r_struct
id|unwind_table_entry
op_star
id|end
op_assign
(paren
r_struct
id|unwind_table_entry
op_star
)paren
id|table_end
op_minus
l_int|1
suffix:semicolon
id|table-&gt;name
op_assign
id|name
suffix:semicolon
id|table-&gt;base_addr
op_assign
id|base_addr
suffix:semicolon
id|table-&gt;gp
op_assign
id|gp
suffix:semicolon
id|table-&gt;start
op_assign
id|base_addr
op_plus
id|start-&gt;region_start
suffix:semicolon
id|table-&gt;end
op_assign
id|base_addr
op_plus
id|end-&gt;region_end
suffix:semicolon
id|table-&gt;table
op_assign
(paren
r_struct
id|unwind_table_entry
op_star
)paren
id|table_start
suffix:semicolon
id|table-&gt;length
op_assign
id|end
op_minus
id|start
op_plus
l_int|1
suffix:semicolon
id|table-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|start
op_le
id|end
suffix:semicolon
id|start
op_increment
)paren
(brace
id|start-&gt;region_start
op_add_assign
id|base_addr
suffix:semicolon
id|start-&gt;region_end
op_add_assign
id|base_addr
suffix:semicolon
)brace
)brace
r_void
op_star
DECL|function|unwind_table_add
id|unwind_table_add
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_int
r_int
id|base_addr
comma
r_int
r_int
id|gp
comma
r_void
op_star
id|start
comma
r_void
op_star
id|end
)paren
(brace
r_struct
id|unwind_table
op_star
id|table
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|table
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|unwind_table
)paren
comma
id|GFP_USER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|table
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|unwind_table_init
c_func
(paren
id|table
comma
id|name
comma
id|base_addr
comma
id|gp
comma
id|start
comma
id|end
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|unwind_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unwind_tables
)paren
(brace
id|unwind_tables_end-&gt;next
op_assign
id|table
suffix:semicolon
id|unwind_tables_end
op_assign
id|table
suffix:semicolon
)brace
r_else
(brace
id|unwind_tables
op_assign
id|unwind_tables_end
op_assign
id|table
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|unwind_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|table
suffix:semicolon
)brace
multiline_comment|/* Called from setup_arch to import the kernel unwind info */
DECL|function|unwind_init
r_static
r_int
id|unwind_init
c_func
(paren
r_void
)paren
(brace
r_int
id|start
comma
id|stop
suffix:semicolon
r_register
r_int
r_int
id|gp
id|__asm__
(paren
l_string|&quot;r27&quot;
)paren
suffix:semicolon
id|start
op_assign
(paren
r_int
)paren
op_amp
id|__start___unwind
(braket
l_int|0
)braket
suffix:semicolon
id|stop
op_assign
(paren
r_int
)paren
op_amp
id|__stop___unwind
(braket
l_int|0
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;unwind_init: start = 0x%lx, end = 0x%lx, entries = %lu&bslash;n&quot;
comma
id|start
comma
id|stop
comma
(paren
id|stop
op_minus
id|start
)paren
op_div
r_sizeof
(paren
r_struct
id|unwind_table_entry
)paren
)paren
suffix:semicolon
id|unwind_table_init
c_func
(paren
op_amp
id|kernel_unwind_table
comma
l_string|&quot;kernel&quot;
comma
id|KERNEL_START
comma
id|gp
comma
op_amp
id|__start___unwind
(braket
l_int|0
)braket
comma
op_amp
id|__stop___unwind
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#if 0
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;region 0x%x-0x%x&bslash;n&quot;
comma
id|__start___unwind
(braket
id|i
)braket
dot
id|region_start
comma
id|__start___unwind
(braket
id|i
)braket
dot
id|region_end
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unwind_frame_regs
r_static
r_void
id|unwind_frame_regs
c_func
(paren
r_struct
id|unwind_frame_info
op_star
id|info
)paren
(brace
r_const
r_struct
id|unwind_table_entry
op_star
id|e
suffix:semicolon
r_int
r_int
id|npc
suffix:semicolon
r_int
r_int
id|insn
suffix:semicolon
r_int
id|frame_size
op_assign
l_int|0
suffix:semicolon
r_int
id|looking_for_rp
comma
id|rpoffset
op_assign
l_int|0
suffix:semicolon
id|e
op_assign
id|find_unwind_entry
c_func
(paren
id|info-&gt;ip
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|e
)paren
(brace
r_int
r_int
id|sp
suffix:semicolon
r_extern
r_char
id|_stext
(braket
)braket
comma
id|_etext
(braket
)braket
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Cannot find unwind entry for 0x%lx; forced unwinding&bslash;n&quot;
comma
id|info-&gt;ip
)paren
suffix:semicolon
multiline_comment|/* Since we are doing the unwinding blind, we don&squot;t know if&n;&t;&t;   we are adjusting the stack correctly or extracting the rp&n;&t;&t;   correctly. The rp is checked to see if it belongs to the&n;&t;&t;   kernel text section, if not we assume we don&squot;t have a &n;&t;&t;   correct stack frame and we continue to unwind the stack.&n;&t;&t;   This is not quite correct, and will fail for loadable&n;&t;&t;   modules. */
id|sp
op_assign
id|info-&gt;sp
op_amp
op_complement
l_int|63
suffix:semicolon
r_do
(brace
id|info-&gt;prev_sp
op_assign
id|sp
op_minus
l_int|64
suffix:semicolon
multiline_comment|/* FIXME: what happens if we unwind too far so that &n;&t;&t;&t;   sp no longer falls in a mapped kernel page? */
macro_line|#ifndef __LP64__
id|info-&gt;prev_ip
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|info-&gt;prev_sp
op_minus
l_int|20
)paren
suffix:semicolon
macro_line|#else
id|info-&gt;prev_ip
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|info-&gt;prev_sp
op_minus
l_int|16
)paren
suffix:semicolon
macro_line|#endif
id|sp
op_assign
id|info-&gt;prev_sp
suffix:semicolon
)brace
r_while
c_loop
(paren
id|info-&gt;prev_ip
template_param
(paren
r_int
r_int
)paren
id|_etext
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;analyzing func @ %lx with no unwind info, setting prev_sp=%lx prev_ip=%lx&bslash;n&quot;
comma
id|info-&gt;ip
comma
id|info-&gt;prev_sp
comma
id|info-&gt;prev_ip
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbg
c_func
(paren
l_string|&quot;e-&gt;start = 0x%x, e-&gt;end = 0x%x, Save_SP = %d, Save_RP = %d size = %u&bslash;n&quot;
comma
id|e-&gt;region_start
comma
id|e-&gt;region_end
comma
id|e-&gt;Save_SP
comma
id|e-&gt;Save_RP
comma
id|e-&gt;Total_frame_size
)paren
suffix:semicolon
id|looking_for_rp
op_assign
id|e-&gt;Save_RP
suffix:semicolon
r_for
c_loop
(paren
id|npc
op_assign
id|e-&gt;region_start
suffix:semicolon
(paren
id|frame_size
OL
(paren
id|e-&gt;Total_frame_size
op_lshift
l_int|3
)paren
op_logical_or
id|looking_for_rp
)paren
op_logical_and
id|npc
OL
id|info-&gt;ip
suffix:semicolon
id|npc
op_add_assign
l_int|4
)paren
(brace
id|insn
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
id|npc
suffix:semicolon
r_if
c_cond
(paren
(paren
id|insn
op_amp
l_int|0xffffc000
)paren
op_eq
l_int|0x37de0000
op_logical_or
(paren
id|insn
op_amp
l_int|0xffe00000
)paren
op_eq
l_int|0x6fc00000
)paren
(brace
multiline_comment|/* ldo X(sp), sp, or stwm X,D(sp) */
id|frame_size
op_add_assign
(paren
id|insn
op_amp
l_int|0x1
ques
c_cond
op_minus
l_int|1
op_lshift
l_int|13
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|insn
op_amp
l_int|0x3fff
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;analyzing func @ %lx, insn=%08x @ %lx, frame_size = %ld&bslash;n&quot;
comma
id|info-&gt;ip
comma
id|insn
comma
id|npc
comma
id|frame_size
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|insn
op_amp
l_int|0xffe00008
)paren
op_eq
l_int|0x7ec00008
)paren
(brace
multiline_comment|/* std,ma X,D(sp) */
id|frame_size
op_add_assign
(paren
id|insn
op_amp
l_int|0x1
ques
c_cond
op_minus
l_int|1
op_lshift
l_int|13
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
(paren
id|insn
op_rshift
l_int|4
)paren
op_amp
l_int|0x3ff
)paren
op_lshift
l_int|3
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;analyzing func @ %lx, insn=%08x @ %lx, frame_size = %ld&bslash;n&quot;
comma
id|info-&gt;ip
comma
id|insn
comma
id|npc
comma
id|frame_size
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|insn
op_eq
l_int|0x6bc23fd9
)paren
(brace
multiline_comment|/* stw rp,-20(sp) */
id|rpoffset
op_assign
l_int|20
suffix:semicolon
id|looking_for_rp
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;analyzing func @ %lx, insn=stw rp,-20(sp) @ %lx&bslash;n&quot;
comma
id|info-&gt;ip
comma
id|npc
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|insn
op_eq
l_int|0x0fc212c1
)paren
(brace
multiline_comment|/* std rp,-16(sr0,sp) */
id|rpoffset
op_assign
l_int|16
suffix:semicolon
id|looking_for_rp
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;analyzing func @ %lx, insn=std rp,-16(sp) @ %lx&bslash;n&quot;
comma
id|info-&gt;ip
comma
id|npc
)paren
suffix:semicolon
)brace
)brace
id|info-&gt;prev_sp
op_assign
id|info-&gt;sp
op_minus
id|frame_size
suffix:semicolon
r_if
c_cond
(paren
id|rpoffset
)paren
id|info-&gt;rp
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|info-&gt;prev_sp
op_minus
id|rpoffset
)paren
suffix:semicolon
id|info-&gt;prev_ip
op_assign
id|info-&gt;rp
suffix:semicolon
id|info-&gt;rp
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;analyzing func @ %lx, setting prev_sp=%lx prev_ip=%lx&bslash;n&quot;
comma
id|info-&gt;ip
comma
id|info-&gt;prev_sp
comma
id|info-&gt;prev_ip
)paren
suffix:semicolon
)brace
)brace
DECL|function|unwind_frame_init
r_void
id|unwind_frame_init
c_func
(paren
r_struct
id|unwind_frame_info
op_star
id|info
comma
r_struct
id|task_struct
op_star
id|t
comma
r_int
r_int
id|sp
comma
r_int
r_int
id|ip
comma
r_int
r_int
id|rp
)paren
(brace
id|memset
c_func
(paren
id|info
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|unwind_frame_info
)paren
)paren
suffix:semicolon
id|info-&gt;t
op_assign
id|t
suffix:semicolon
id|info-&gt;sp
op_assign
id|sp
suffix:semicolon
id|info-&gt;ip
op_assign
id|ip
suffix:semicolon
id|info-&gt;rp
op_assign
id|rp
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;(%d) Start unwind from sp=%08lx ip=%08lx&bslash;n&quot;
comma
id|t
ques
c_cond
(paren
r_int
)paren
id|t-&gt;pid
suffix:colon
l_int|0
comma
id|info-&gt;sp
comma
id|info-&gt;ip
)paren
suffix:semicolon
)brace
DECL|function|unwind_frame_init_from_blocked_task
r_void
id|unwind_frame_init_from_blocked_task
c_func
(paren
r_struct
id|unwind_frame_info
op_star
id|info
comma
r_struct
id|task_struct
op_star
id|t
)paren
(brace
r_struct
id|pt_regs
op_star
id|regs
op_assign
op_amp
id|t-&gt;thread.regs
suffix:semicolon
id|unwind_frame_init
c_func
(paren
id|info
comma
id|t
comma
id|regs-&gt;ksp
comma
id|regs-&gt;kpc
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|unwind_frame_init_running
r_void
id|unwind_frame_init_running
c_func
(paren
r_struct
id|unwind_frame_info
op_star
id|info
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|unwind_frame_init
c_func
(paren
id|info
comma
id|current
comma
id|regs-&gt;gr
(braket
l_int|30
)braket
comma
id|regs-&gt;iaoq
(braket
l_int|0
)braket
comma
id|regs-&gt;gr
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
DECL|function|unwind_once
r_int
id|unwind_once
c_func
(paren
r_struct
id|unwind_frame_info
op_star
id|next_frame
)paren
(brace
id|unwind_frame_regs
c_func
(paren
id|next_frame
)paren
suffix:semicolon
r_if
c_cond
(paren
id|next_frame-&gt;prev_sp
op_eq
l_int|0
op_logical_or
id|next_frame-&gt;prev_ip
op_eq
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|next_frame-&gt;sp
op_assign
id|next_frame-&gt;prev_sp
suffix:semicolon
id|next_frame-&gt;ip
op_assign
id|next_frame-&gt;prev_ip
suffix:semicolon
id|next_frame-&gt;prev_sp
op_assign
l_int|0
suffix:semicolon
id|next_frame-&gt;prev_ip
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;(%d) Continue unwind to sp=%08lx ip=%08lx&bslash;n&quot;
comma
(paren
r_int
)paren
id|next_frame-&gt;t-&gt;pid
comma
id|next_frame-&gt;sp
comma
id|next_frame-&gt;ip
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unwind_to_user
r_int
id|unwind_to_user
c_func
(paren
r_struct
id|unwind_frame_info
op_star
id|info
)paren
(brace
r_int
id|ret
suffix:semicolon
r_do
(brace
id|ret
op_assign
id|unwind_once
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|ret
op_logical_and
op_logical_neg
(paren
id|info-&gt;ip
op_amp
l_int|3
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|unwind_init
id|module_init
c_func
(paren
id|unwind_init
)paren
suffix:semicolon
eof
