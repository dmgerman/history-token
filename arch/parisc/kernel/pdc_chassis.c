multiline_comment|/* &n; *    interfaces to log Chassis Codes via PDC (firmware)&n; *&n; *    Copyright (C) 2002 Laurent Canet &lt;canetl@esiee.fr&gt;&n; *    Copyright (C) 2002-2004 Thibaut VARENE &lt;varenet@esiee.fr&gt;&n; *&n; *    This program is free software; you can redistribute it and/or modify&n; *    it under the terms of the GNU General Public License as published by&n; *    the Free Software Foundation; either version 2 of the License, or&n; *    (at your option) any later version.&n; *&n; *    This program is distributed in the hope that it will be useful,&n; *    but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *    GNU General Public License for more details.&n; *&n; *    You should have received a copy of the GNU General Public License&n; *    along with this program; if not, write to the Free Software&n; *    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
DECL|macro|PDC_CHASSIS_DEBUG
macro_line|#undef PDC_CHASSIS_DEBUG
macro_line|#ifdef PDC_CHASSIS_DEBUG
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(fmt, args...)&t;printk(fmt, ## args)
macro_line|#else
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(fmt, args...)
macro_line|#endif
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/reboot.h&gt;
macro_line|#include &lt;linux/notifier.h&gt;
macro_line|#include &lt;asm/pdc_chassis.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/pdc.h&gt;
macro_line|#include &lt;asm/pdcpat.h&gt;
macro_line|#ifdef CONFIG_PDC_CHASSIS
DECL|variable|pdc_chassis_old
r_static
r_int
id|pdc_chassis_old
op_assign
l_int|0
suffix:semicolon
DECL|variable|pdc_chassis_enabled
r_static
r_int
r_int
id|pdc_chassis_enabled
op_assign
l_int|1
suffix:semicolon
multiline_comment|/**&n; * pdc_chassis_setup() - Enable/disable pdc_chassis code at boot time.&n; * @str configuration param: 0 to disable chassis log&n; * @return 1&n; */
DECL|function|pdc_chassis_setup
r_static
r_int
id|__init
id|pdc_chassis_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
multiline_comment|/*panic_timeout = simple_strtoul(str, NULL, 0);*/
id|get_option
c_func
(paren
op_amp
id|str
comma
op_amp
id|pdc_chassis_enabled
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;pdcchassis=&quot;
comma
id|pdc_chassis_setup
)paren
suffix:semicolon
multiline_comment|/** &n; * pdc_chassis_checkold() - Checks for old PDC_CHASSIS compatibility&n; * @pdc_chassis_old: 1 if old pdc chassis style&n; * &n; * Currently, only E class and A180 are known to work with this.&n; * Inspired by Christoph Plattner&n; */
DECL|function|pdc_chassis_checkold
r_static
r_void
id|__init
id|pdc_chassis_checkold
c_func
(paren
r_void
)paren
(brace
r_switch
c_cond
(paren
id|CPU_HVERSION
)paren
(brace
r_case
l_int|0x480
suffix:colon
multiline_comment|/* E25 */
r_case
l_int|0x481
suffix:colon
multiline_comment|/* E35 */
r_case
l_int|0x482
suffix:colon
multiline_comment|/* E45 */
r_case
l_int|0x483
suffix:colon
multiline_comment|/* E55 */
r_case
l_int|0x516
suffix:colon
multiline_comment|/* A180 */
id|pdc_chassis_old
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: pdc_chassis_checkold(); pdc_chassis_old = %d&bslash;n&quot;
comma
id|__FILE__
comma
id|pdc_chassis_old
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * pdc_chassis_panic_event() - Called by the panic handler.&n; *&n; * As soon as a panic occurs, we should inform the PDC.&n; */
DECL|function|pdc_chassis_panic_event
r_static
r_int
id|pdc_chassis_panic_event
c_func
(paren
r_struct
id|notifier_block
op_star
id|this
comma
r_int
r_int
id|event
comma
r_void
op_star
id|ptr
)paren
(brace
id|pdc_chassis_send_status
c_func
(paren
id|PDC_CHASSIS_DIRECT_PANIC
)paren
suffix:semicolon
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
DECL|variable|pdc_chassis_panic_block
r_static
r_struct
id|notifier_block
id|pdc_chassis_panic_block
op_assign
(brace
dot
id|notifier_call
op_assign
id|pdc_chassis_panic_event
comma
dot
id|priority
op_assign
id|INT_MAX
comma
)brace
suffix:semicolon
multiline_comment|/**&n; * parisc_reboot_event() - Called by the reboot handler.&n; *&n; * As soon as a reboot occurs, we should inform the PDC.&n; */
DECL|function|pdc_chassis_reboot_event
r_static
r_int
id|pdc_chassis_reboot_event
c_func
(paren
r_struct
id|notifier_block
op_star
id|this
comma
r_int
r_int
id|event
comma
r_void
op_star
id|ptr
)paren
(brace
id|pdc_chassis_send_status
c_func
(paren
id|PDC_CHASSIS_DIRECT_SHUTDOWN
)paren
suffix:semicolon
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
DECL|variable|pdc_chassis_reboot_block
r_static
r_struct
id|notifier_block
id|pdc_chassis_reboot_block
op_assign
(brace
dot
id|notifier_call
op_assign
id|pdc_chassis_reboot_event
comma
dot
id|priority
op_assign
id|INT_MAX
comma
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_PDC_CHASSIS */
multiline_comment|/**&n; * parisc_pdc_chassis_init() - Called at boot time.&n; */
DECL|function|parisc_pdc_chassis_init
r_void
id|__init
id|parisc_pdc_chassis_init
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_PDC_CHASSIS
r_int
id|handle
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pdc_chassis_enabled
)paren
(brace
id|DPRINTK
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: parisc_pdc_chassis_init()&bslash;n&quot;
comma
id|__FILE__
)paren
suffix:semicolon
multiline_comment|/* Let see if we have something to handle... */
multiline_comment|/* Check for PDC_PAT or old LED Panel */
id|pdc_chassis_checkold
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_pdc_pat
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Enabling PDC_PAT chassis codes support.&bslash;n&quot;
)paren
suffix:semicolon
id|handle
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pdc_chassis_old
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Enabling old style chassis LED panel support.&bslash;n&quot;
)paren
suffix:semicolon
id|handle
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|handle
)paren
(brace
multiline_comment|/* initialize panic notifier chain */
id|notifier_chain_register
c_func
(paren
op_amp
id|panic_notifier_list
comma
op_amp
id|pdc_chassis_panic_block
)paren
suffix:semicolon
multiline_comment|/* initialize reboot notifier chain */
id|register_reboot_notifier
c_func
(paren
op_amp
id|pdc_chassis_reboot_block
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_PDC_CHASSIS */
)brace
multiline_comment|/** &n; * pdc_chassis_send_status() - Sends a predefined message to the chassis,&n; * and changes the front panel LEDs according to the new system state&n; * @retval: PDC call return value.&n; *&n; * Only machines with 64 bits PDC PAT and those reported in&n; * pdc_chassis_checkold() are supported atm.&n; * &n; * returns 0 if no error, -1 if no supported PDC is present or invalid message,&n; * else returns the appropriate PDC error code.&n; * &n; * For a list of predefined messages, see asm-parisc/pdc_chassis.h&n; */
DECL|function|pdc_chassis_send_status
r_int
id|pdc_chassis_send_status
c_func
(paren
r_int
id|message
)paren
(brace
multiline_comment|/* Maybe we should do that in an other way ? */
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_PDC_CHASSIS
r_if
c_cond
(paren
id|pdc_chassis_enabled
)paren
(brace
id|DPRINTK
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: pdc_chassis_send_status(%d)&bslash;n&quot;
comma
id|__FILE__
comma
id|message
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PARISC64
r_if
c_cond
(paren
id|is_pdc_pat
c_func
(paren
)paren
)paren
(brace
r_switch
c_cond
(paren
id|message
)paren
(brace
r_case
id|PDC_CHASSIS_DIRECT_BSTART
suffix:colon
id|retval
op_assign
id|pdc_pat_chassis_send_log
c_func
(paren
id|PDC_CHASSIS_PMSG_BSTART
comma
id|PDC_CHASSIS_LSTATE_RUN_NORMAL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PDC_CHASSIS_DIRECT_BCOMPLETE
suffix:colon
id|retval
op_assign
id|pdc_pat_chassis_send_log
c_func
(paren
id|PDC_CHASSIS_PMSG_BCOMPLETE
comma
id|PDC_CHASSIS_LSTATE_RUN_NORMAL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PDC_CHASSIS_DIRECT_SHUTDOWN
suffix:colon
id|retval
op_assign
id|pdc_pat_chassis_send_log
c_func
(paren
id|PDC_CHASSIS_PMSG_SHUTDOWN
comma
id|PDC_CHASSIS_LSTATE_NONOS
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PDC_CHASSIS_DIRECT_PANIC
suffix:colon
id|retval
op_assign
id|pdc_pat_chassis_send_log
c_func
(paren
id|PDC_CHASSIS_PMSG_PANIC
comma
id|PDC_CHASSIS_LSTATE_RUN_CRASHREC
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PDC_CHASSIS_DIRECT_LPMC
suffix:colon
id|retval
op_assign
id|pdc_pat_chassis_send_log
c_func
(paren
id|PDC_CHASSIS_PMSG_LPMC
comma
id|PDC_CHASSIS_LSTATE_RUN_SYSINT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PDC_CHASSIS_DIRECT_HPMC
suffix:colon
id|retval
op_assign
id|pdc_pat_chassis_send_log
c_func
(paren
id|PDC_CHASSIS_PMSG_HPMC
comma
id|PDC_CHASSIS_LSTATE_RUN_NCRIT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_else
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|pdc_chassis_old
)paren
(brace
r_switch
c_cond
(paren
id|message
)paren
(brace
r_case
id|PDC_CHASSIS_DIRECT_BSTART
suffix:colon
r_case
id|PDC_CHASSIS_DIRECT_BCOMPLETE
suffix:colon
id|retval
op_assign
id|pdc_chassis_disp
c_func
(paren
id|PDC_CHASSIS_DISP_DATA
c_func
(paren
id|OSTAT_RUN
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PDC_CHASSIS_DIRECT_SHUTDOWN
suffix:colon
id|retval
op_assign
id|pdc_chassis_disp
c_func
(paren
id|PDC_CHASSIS_DISP_DATA
c_func
(paren
id|OSTAT_SHUT
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PDC_CHASSIS_DIRECT_HPMC
suffix:colon
r_case
id|PDC_CHASSIS_DIRECT_PANIC
suffix:colon
id|retval
op_assign
id|pdc_chassis_disp
c_func
(paren
id|PDC_CHASSIS_DISP_DATA
c_func
(paren
id|OSTAT_FLT
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PDC_CHASSIS_DIRECT_LPMC
suffix:colon
id|retval
op_assign
id|pdc_chassis_disp
c_func
(paren
id|PDC_CHASSIS_DISP_DATA
c_func
(paren
id|OSTAT_WARN
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_else
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#endif /* CONFIG_PARISC64 */
)brace
multiline_comment|/* if (pdc_chassis_enabled) */
macro_line|#endif /* CONFIG_PDC_CHASSIS */
r_return
id|retval
suffix:semicolon
)brace
eof
