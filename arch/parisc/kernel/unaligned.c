multiline_comment|/*&n; *    Unaligned memory access handler&n; *&n; *    Copyright (C) 2001 Randolph Chung &lt;tausq@debian.org&gt;&n; *    Significantly tweaked by LaMont Jones &lt;lamont@debian.org&gt;&n; *&n; *    This program is free software; you can redistribute it and/or modify&n; *    it under the terms of the GNU General Public License as published by&n; *    the Free Software Foundation; either version 2, or (at your option)&n; *    any later version.&n; *&n; *    This program is distributed in the hope that it will be useful,&n; *    but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *    GNU General Public License for more details.&n; *&n; *    You should have received a copy of the GNU General Public License&n; *    along with this program; if not, write to the Free Software&n; *    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;asm/smp.h&gt;
macro_line|#include &lt;asm/pdc.h&gt;
multiline_comment|/* #define DEBUG_UNALIGNED 1 */
macro_line|#ifdef DEBUG_UNALIGNED
DECL|macro|DPRINTF
mdefine_line|#define DPRINTF(fmt, args...) do { printk(KERN_DEBUG &quot;%s:%d:%s &quot;, __FILE__, __LINE__, __FUNCTION__ ); printk(KERN_DEBUG fmt, ##args ); } while (0)
macro_line|#else
DECL|macro|DPRINTF
mdefine_line|#define DPRINTF(fmt, args...)
macro_line|#endif
macro_line|#ifdef __LP64__
DECL|macro|RFMT
mdefine_line|#define RFMT &quot;%016lx&quot;
macro_line|#else
DECL|macro|RFMT
mdefine_line|#define RFMT &quot;%08lx&quot;
macro_line|#endif
multiline_comment|/* 1111 1100 0000 0000 0001 0011 1100 0000 */
DECL|macro|OPCODE1
mdefine_line|#define OPCODE1(a,b,c)&t;((a)&lt;&lt;26|(b)&lt;&lt;12|(c)&lt;&lt;6) 
DECL|macro|OPCODE2
mdefine_line|#define OPCODE2(a,b)&t;((a)&lt;&lt;26|(b)&lt;&lt;1)
DECL|macro|OPCODE3
mdefine_line|#define OPCODE3(a,b)&t;((a)&lt;&lt;26|(b)&lt;&lt;2)
DECL|macro|OPCODE4
mdefine_line|#define OPCODE4(a)&t;((a)&lt;&lt;26)
DECL|macro|OPCODE1_MASK
mdefine_line|#define OPCODE1_MASK&t;OPCODE1(0x3f,1,0xf)
DECL|macro|OPCODE2_MASK
mdefine_line|#define OPCODE2_MASK &t;OPCODE2(0x3f,1)
DECL|macro|OPCODE3_MASK
mdefine_line|#define OPCODE3_MASK&t;OPCODE3(0x3f,1)
DECL|macro|OPCODE4_MASK
mdefine_line|#define OPCODE4_MASK    OPCODE4(0x3f)
multiline_comment|/* skip LDB - never unaligned (index) */
DECL|macro|OPCODE_LDH_I
mdefine_line|#define OPCODE_LDH_I&t;OPCODE1(0x03,0,0x1)
DECL|macro|OPCODE_LDW_I
mdefine_line|#define OPCODE_LDW_I&t;OPCODE1(0x03,0,0x2)
DECL|macro|OPCODE_LDD_I
mdefine_line|#define OPCODE_LDD_I&t;OPCODE1(0x03,0,0x3)
DECL|macro|OPCODE_LDDA_I
mdefine_line|#define OPCODE_LDDA_I&t;OPCODE1(0x03,0,0x4)
DECL|macro|OPCODE_LDCD_I
mdefine_line|#define OPCODE_LDCD_I&t;OPCODE1(0x03,0,0x5)
DECL|macro|OPCODE_LDWA_I
mdefine_line|#define OPCODE_LDWA_I&t;OPCODE1(0x03,0,0x6)
DECL|macro|OPCODE_LDCW_I
mdefine_line|#define OPCODE_LDCW_I&t;OPCODE1(0x03,0,0x7)
multiline_comment|/* skip LDB - never unaligned (short) */
DECL|macro|OPCODE_LDH_S
mdefine_line|#define OPCODE_LDH_S&t;OPCODE1(0x03,1,0x1)
DECL|macro|OPCODE_LDW_S
mdefine_line|#define OPCODE_LDW_S&t;OPCODE1(0x03,1,0x2)
DECL|macro|OPCODE_LDD_S
mdefine_line|#define OPCODE_LDD_S&t;OPCODE1(0x03,1,0x3)
DECL|macro|OPCODE_LDDA_S
mdefine_line|#define OPCODE_LDDA_S&t;OPCODE1(0x03,1,0x4)
DECL|macro|OPCODE_LDCD_S
mdefine_line|#define OPCODE_LDCD_S&t;OPCODE1(0x03,1,0x5)
DECL|macro|OPCODE_LDWA_S
mdefine_line|#define OPCODE_LDWA_S&t;OPCODE1(0x03,1,0x6)
DECL|macro|OPCODE_LDCW_S
mdefine_line|#define OPCODE_LDCW_S&t;OPCODE1(0x03,1,0x7)
multiline_comment|/* skip STB - never unaligned */
DECL|macro|OPCODE_STH
mdefine_line|#define OPCODE_STH&t;OPCODE1(0x03,1,0x9)
DECL|macro|OPCODE_STW
mdefine_line|#define OPCODE_STW&t;OPCODE1(0x03,1,0xa)
DECL|macro|OPCODE_STD
mdefine_line|#define OPCODE_STD&t;OPCODE1(0x03,1,0xb)
multiline_comment|/* skip STBY - never unaligned */
multiline_comment|/* skip STDBY - never unaligned */
DECL|macro|OPCODE_STWA
mdefine_line|#define OPCODE_STWA&t;OPCODE1(0x03,1,0xe)
DECL|macro|OPCODE_STDA
mdefine_line|#define OPCODE_STDA&t;OPCODE1(0x03,1,0xf)
DECL|macro|OPCODE_LDD_L
mdefine_line|#define OPCODE_LDD_L&t;OPCODE2(0x14,0)
DECL|macro|OPCODE_FLDD_L
mdefine_line|#define OPCODE_FLDD_L&t;OPCODE2(0x14,1)
DECL|macro|OPCODE_STD_L
mdefine_line|#define OPCODE_STD_L&t;OPCODE2(0x1c,0)
DECL|macro|OPCODE_FSTD_L
mdefine_line|#define OPCODE_FSTD_L&t;OPCODE2(0x1c,1)
DECL|macro|OPCODE_LDW_M
mdefine_line|#define OPCODE_LDW_M&t;OPCODE3(0x17,1)
DECL|macro|OPCODE_FLDW_L
mdefine_line|#define OPCODE_FLDW_L&t;OPCODE3(0x17,0)
DECL|macro|OPCODE_FSTW_L
mdefine_line|#define OPCODE_FSTW_L&t;OPCODE3(0x1f,0)
DECL|macro|OPCODE_STW_M
mdefine_line|#define OPCODE_STW_M&t;OPCODE3(0x1f,1)
DECL|macro|OPCODE_LDH_L
mdefine_line|#define OPCODE_LDH_L    OPCODE4(0x11)
DECL|macro|OPCODE_LDW_L
mdefine_line|#define OPCODE_LDW_L    OPCODE4(0x12)
DECL|macro|OPCODE_LDWM
mdefine_line|#define OPCODE_LDWM     OPCODE4(0x13)
DECL|macro|OPCODE_STH_L
mdefine_line|#define OPCODE_STH_L    OPCODE4(0x19)
DECL|macro|OPCODE_STW_L
mdefine_line|#define OPCODE_STW_L    OPCODE4(0x1A)
DECL|macro|OPCODE_STWM
mdefine_line|#define OPCODE_STWM     OPCODE4(0x1B)
DECL|macro|MAJOR_OP
mdefine_line|#define MAJOR_OP(i) (((i)&gt;&gt;26)&amp;0x3f)
DECL|macro|R1
mdefine_line|#define R1(i) (((i)&gt;&gt;21)&amp;0x1f)
DECL|macro|R2
mdefine_line|#define R2(i) (((i)&gt;&gt;16)&amp;0x1f)
DECL|macro|R3
mdefine_line|#define R3(i) ((i)&amp;0x1f)
DECL|macro|IM
mdefine_line|#define IM(i,n) (((i)&gt;&gt;1&amp;((1&lt;&lt;(n-1))-1))|((i)&amp;1?((0-1L)&lt;&lt;(n-1)):0))
DECL|macro|IM5_2
mdefine_line|#define IM5_2(i) IM((i)&gt;&gt;16,5)
DECL|macro|IM5_3
mdefine_line|#define IM5_3(i) IM((i),5)
DECL|macro|IM14
mdefine_line|#define IM14(i) IM((i),14)
DECL|variable|unaligned_enabled
r_int
id|unaligned_enabled
op_assign
l_int|1
suffix:semicolon
r_void
id|die_if_kernel
(paren
r_char
op_star
id|str
comma
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|err
)paren
suffix:semicolon
DECL|function|emulate_ldh
r_static
r_int
id|emulate_ldh
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|toreg
)paren
(brace
r_int
r_int
id|saddr
op_assign
id|regs-&gt;ior
suffix:semicolon
r_int
r_int
id|val
op_assign
l_int|0
suffix:semicolon
id|DPRINTF
c_func
(paren
l_string|&quot;load &quot;
id|RFMT
l_string|&quot;:&quot;
id|RFMT
l_string|&quot; to r%d for 2 bytes&bslash;n&quot;
comma
id|regs-&gt;isr
comma
id|regs-&gt;ior
comma
id|toreg
)paren
suffix:semicolon
id|__asm__
id|__volatile__
(paren
l_string|&quot;&t;mtsp&t;%3, %%sr1&bslash;n&quot;
l_string|&quot;&t;ldbs&t;0(%%sr1,%2), %%r20&bslash;n&quot;
l_string|&quot;&t;ldbs&t;1(%%sr1,%2), %0&bslash;n&quot;
l_string|&quot;depw&t;%%r20, 23, 24, %0&bslash;n&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|val
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|val
)paren
comma
l_string|&quot;r&quot;
(paren
id|saddr
)paren
comma
l_string|&quot;r&quot;
(paren
id|regs-&gt;isr
)paren
suffix:colon
l_string|&quot;r20&quot;
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
l_string|&quot;val = 0x&quot;
id|RFMT
l_string|&quot;&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|toreg
)paren
id|regs-&gt;gr
(braket
id|toreg
)braket
op_assign
id|val
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|emulate_ldw
r_static
r_int
id|emulate_ldw
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|toreg
)paren
(brace
r_int
r_int
id|saddr
op_assign
id|regs-&gt;ior
suffix:semicolon
r_int
r_int
id|val
op_assign
l_int|0
suffix:semicolon
id|DPRINTF
c_func
(paren
l_string|&quot;load &quot;
id|RFMT
l_string|&quot;:&quot;
id|RFMT
l_string|&quot; to r%d for 4 bytes&bslash;n&quot;
comma
id|regs-&gt;isr
comma
id|regs-&gt;ior
comma
id|toreg
)paren
suffix:semicolon
id|__asm__
id|__volatile__
(paren
l_string|&quot;&t;zdep&t;%2,28,2,%%r19&bslash;n&quot;
multiline_comment|/* r19=(ofs&amp;3)*8 */
l_string|&quot;&t;mtsp&t;%3, %%sr1&bslash;n&quot;
l_string|&quot;&t;depw&t;%%r0,31,2,%2&bslash;n&quot;
l_string|&quot;&t;ldw&t;0(%%sr1,%2),%0&bslash;n&quot;
l_string|&quot;&t;ldw&t;4(%%sr1,%2),%%r20&bslash;n&quot;
l_string|&quot;&t;subi&t;32,%%r19,%%r19&bslash;n&quot;
l_string|&quot;&t;mtctl&t;%%r19,11&bslash;n&quot;
l_string|&quot;&t;vshd&t;%0,%%r20,%0&bslash;n&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|val
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|val
)paren
comma
l_string|&quot;r&quot;
(paren
id|saddr
)paren
comma
l_string|&quot;r&quot;
(paren
id|regs-&gt;isr
)paren
suffix:colon
l_string|&quot;r19&quot;
comma
l_string|&quot;r20&quot;
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
l_string|&quot;val = 0x&quot;
id|RFMT
l_string|&quot;&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|toreg
)paren
id|regs-&gt;gr
(braket
id|toreg
)braket
op_assign
id|val
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef __LP64__
DECL|function|emulate_ldd
r_static
r_int
id|emulate_ldd
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|toreg
)paren
(brace
r_int
r_int
id|saddr
op_assign
id|regs-&gt;ior
suffix:semicolon
r_int
r_int
id|val
op_assign
l_int|0
suffix:semicolon
id|DPRINTF
c_func
(paren
l_string|&quot;load &quot;
id|RFMT
l_string|&quot;:&quot;
id|RFMT
l_string|&quot; to r%d for 8 bytes&bslash;n&quot;
comma
id|regs-&gt;isr
comma
id|regs-&gt;ior
comma
id|toreg
)paren
suffix:semicolon
id|__asm__
id|__volatile__
(paren
l_string|&quot;&t;depd,z&t;%2,60,3,%%r19&bslash;n&quot;
multiline_comment|/* r19=(ofs&amp;7)*8 */
l_string|&quot;&t;mtsp&t;%3, %%sr1&bslash;n&quot;
l_string|&quot;&t;depd&t;%%r0,63,3,%2&bslash;n&quot;
l_string|&quot;&t;ldd&t;0(%%sr1,%2),%0&bslash;n&quot;
l_string|&quot;&t;ldd&t;8(%%sr1,%2),%%r20&bslash;n&quot;
l_string|&quot;&t;subi&t;64,%%r19,%%r19&bslash;n&quot;
l_string|&quot;&t;mtsar&t;%%r19&bslash;n&quot;
l_string|&quot;&t;shrpd&t;%0,%%r20,%%sar,%0&bslash;n&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|val
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
id|val
)paren
comma
l_string|&quot;r&quot;
(paren
id|saddr
)paren
comma
l_string|&quot;r&quot;
(paren
id|regs-&gt;isr
)paren
suffix:colon
l_string|&quot;r19&quot;
comma
l_string|&quot;r20&quot;
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
l_string|&quot;val = 0x&quot;
id|RFMT
l_string|&quot;&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|toreg
)paren
id|regs-&gt;gr
(braket
id|toreg
)braket
op_assign
id|val
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|emulate_sth
r_static
r_int
id|emulate_sth
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|frreg
)paren
(brace
r_int
r_int
id|val
op_assign
id|regs-&gt;gr
(braket
id|frreg
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|frreg
)paren
id|val
op_assign
l_int|0
suffix:semicolon
id|DPRINTF
c_func
(paren
l_string|&quot;store r%d (0x&quot;
id|RFMT
l_string|&quot;) to &quot;
id|RFMT
l_string|&quot;:&quot;
id|RFMT
l_string|&quot; for 2 bytes&bslash;n&quot;
comma
id|frreg
comma
id|regs-&gt;gr
(braket
id|frreg
)braket
comma
id|regs-&gt;isr
comma
id|regs-&gt;ior
)paren
suffix:semicolon
id|__asm__
id|__volatile__
(paren
l_string|&quot;&t;mtsp %2, %%sr1&bslash;n&quot;
l_string|&quot;&t;extrw,u %0, 23, 8, %%r19&bslash;n&quot;
l_string|&quot;&t;stb %0, 1(%%sr1, %1)&bslash;n&quot;
l_string|&quot;&t;stb %%r19, 0(%%sr1, %1)&bslash;n&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|val
)paren
comma
l_string|&quot;r&quot;
(paren
id|regs-&gt;ior
)paren
comma
l_string|&quot;r&quot;
(paren
id|regs-&gt;isr
)paren
suffix:colon
l_string|&quot;r19&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|emulate_stw
r_static
r_int
id|emulate_stw
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|frreg
)paren
(brace
r_int
r_int
id|val
op_assign
id|regs-&gt;gr
(braket
id|frreg
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|frreg
)paren
id|val
op_assign
l_int|0
suffix:semicolon
id|DPRINTF
c_func
(paren
l_string|&quot;store r%d (0x&quot;
id|RFMT
l_string|&quot;) to &quot;
id|RFMT
l_string|&quot;:&quot;
id|RFMT
l_string|&quot; for 4 bytes&bslash;n&quot;
comma
id|frreg
comma
id|regs-&gt;gr
(braket
id|frreg
)braket
comma
id|regs-&gt;isr
comma
id|regs-&gt;ior
)paren
suffix:semicolon
id|__asm__
id|__volatile__
(paren
l_string|&quot;&t;mtsp %2, %%sr1&bslash;n&quot;
l_string|&quot;&t;zdep&t;%1, 28, 2, %%r19&bslash;n&quot;
l_string|&quot;&t;dep&t;%%r0, 31, 2, %1&bslash;n&quot;
l_string|&quot;&t;mtsar&t;%%r19&bslash;n&quot;
l_string|&quot;&t;depwi,z&t;-2, %%sar, 32, %%r19&bslash;n&quot;
l_string|&quot;&t;ldw&t;0(%%sr1,%1),%%r20&bslash;n&quot;
l_string|&quot;&t;ldw&t;4(%%sr1,%1),%%r21&bslash;n&quot;
l_string|&quot;&t;vshd&t;%%r0, %0, %%r22&bslash;n&quot;
l_string|&quot;&t;vshd&t;%0, %%r0, %%r1&bslash;n&quot;
l_string|&quot;&t;and&t;%%r20, %%r19, %%r20&bslash;n&quot;
l_string|&quot;&t;andcm&t;%%r21, %%r19, %%r21&bslash;n&quot;
l_string|&quot;&t;or&t;%%r22, %%r20, %%r20&bslash;n&quot;
l_string|&quot;&t;or&t;%%r1, %%r21, %%r21&bslash;n&quot;
l_string|&quot;&t;stw&t;%%r20,0(%%sr1,%1)&bslash;n&quot;
l_string|&quot;&t;stw&t;%%r21,4(%%sr1,%1)&bslash;n&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|val
)paren
comma
l_string|&quot;r&quot;
(paren
id|regs-&gt;ior
)paren
comma
l_string|&quot;r&quot;
(paren
id|regs-&gt;isr
)paren
suffix:colon
l_string|&quot;r19&quot;
comma
l_string|&quot;r20&quot;
comma
l_string|&quot;r21&quot;
comma
l_string|&quot;r22&quot;
comma
l_string|&quot;r1&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef __LP64__
DECL|function|emulate_std
r_static
r_int
id|emulate_std
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|frreg
)paren
(brace
r_int
r_int
id|val
op_assign
id|regs-&gt;gr
(braket
id|frreg
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|frreg
)paren
id|val
op_assign
l_int|0
suffix:semicolon
id|DPRINTF
c_func
(paren
l_string|&quot;store r%d (0x&quot;
id|RFMT
l_string|&quot;) to &quot;
id|RFMT
l_string|&quot;:&quot;
id|RFMT
l_string|&quot; for 8 bytes&bslash;n&quot;
comma
id|frreg
comma
id|regs-&gt;gr
(braket
id|frreg
)braket
comma
id|regs-&gt;isr
comma
id|regs-&gt;ior
)paren
suffix:semicolon
id|__asm__
id|__volatile__
(paren
l_string|&quot;&t;mtsp %2, %%sr1&bslash;n&quot;
l_string|&quot;&t;depd,z&t;%1, 60, 3, %%r19&bslash;n&quot;
l_string|&quot;&t;depd&t;%%r0, 63, 3, %1&bslash;n&quot;
l_string|&quot;&t;mtsar&t;%%r19&bslash;n&quot;
l_string|&quot;&t;depdi,z&t;-2, %%sar, 64, %%r19&bslash;n&quot;
l_string|&quot;&t;ldd&t;0(%%sr1,%1),%%r20&bslash;n&quot;
l_string|&quot;&t;ldd&t;8(%%sr1,%1),%%r21&bslash;n&quot;
l_string|&quot;&t;shrpd&t;%%r0, %0, %%sar, %%r22&bslash;n&quot;
l_string|&quot;&t;shrpd&t;%0, %%r0, %%sar, %%r1&bslash;n&quot;
l_string|&quot;&t;and&t;%%r20, %%r19, %%r20&bslash;n&quot;
l_string|&quot;&t;andcm&t;%%r21, %%r19, %%r21&bslash;n&quot;
l_string|&quot;&t;or&t;%%r22, %%r20, %%r20&bslash;n&quot;
l_string|&quot;&t;or&t;%%r1, %%r21, %%r21&bslash;n&quot;
l_string|&quot;&t;std&t;%%r20,0(%%sr1,%1)&bslash;n&quot;
l_string|&quot;&t;std&t;%%r21,8(%%sr1,%1)&bslash;n&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|val
)paren
comma
l_string|&quot;r&quot;
(paren
id|regs-&gt;ior
)paren
comma
l_string|&quot;r&quot;
(paren
id|regs-&gt;isr
)paren
suffix:colon
l_string|&quot;r19&quot;
comma
l_string|&quot;r20&quot;
comma
l_string|&quot;r21&quot;
comma
l_string|&quot;r22&quot;
comma
l_string|&quot;r1&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|handle_unaligned
r_void
id|handle_unaligned
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|unaligned_count
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|last_time
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|newbase
op_assign
id|regs-&gt;gr
(braket
id|R1
c_func
(paren
id|regs-&gt;iir
)paren
)braket
suffix:semicolon
r_int
id|modify
op_assign
l_int|0
suffix:semicolon
r_int
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
r_struct
id|siginfo
id|si
suffix:semicolon
multiline_comment|/* if the unaligned access is inside the kernel:&n;&t; *   if the access is caused by a syscall, then we fault the calling&n;&t; *     user process&n;&t; *   otherwise we halt the kernel&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|user_mode
c_func
(paren
id|regs
)paren
)paren
(brace
r_const
r_struct
id|exception_table_entry
op_star
id|fix
suffix:semicolon
multiline_comment|/* see if the offending code have its own&n;&t;&t; * exception handler &n;&t;&t; */
id|fix
op_assign
id|search_exception_tables
c_func
(paren
id|regs-&gt;iaoq
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fix
)paren
(brace
multiline_comment|/* lower bits of fix-&gt;skip are flags&n;&t;&t;&t; * upper bits are the handler addr&n;&t;&t;&t; */
r_if
c_cond
(paren
id|fix-&gt;skip
op_amp
l_int|1
)paren
id|regs-&gt;gr
(braket
l_int|8
)braket
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|fix-&gt;skip
op_amp
l_int|2
)paren
id|regs-&gt;gr
(braket
l_int|9
)braket
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;iaoq
(braket
l_int|0
)braket
op_add_assign
(paren
(paren
id|fix-&gt;skip
)paren
op_amp
op_complement
l_int|3
)paren
suffix:semicolon
id|regs-&gt;iaoq
(braket
l_int|1
)braket
op_assign
id|regs-&gt;iaoq
(braket
l_int|0
)braket
op_plus
l_int|4
suffix:semicolon
id|regs-&gt;gr
(braket
l_int|0
)braket
op_and_assign
op_complement
id|PSW_B
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* log a message with pacing */
r_if
c_cond
(paren
id|user_mode
c_func
(paren
id|regs
)paren
)paren
(brace
r_if
c_cond
(paren
id|unaligned_count
OG
l_int|5
op_logical_and
id|jiffies
op_minus
id|last_time
OG
l_int|5
op_star
id|HZ
)paren
(brace
id|unaligned_count
op_assign
l_int|0
suffix:semicolon
id|last_time
op_assign
id|jiffies
suffix:semicolon
)brace
r_if
c_cond
(paren
op_increment
id|unaligned_count
OL
l_int|5
)paren
(brace
r_char
id|buf
(braket
l_int|256
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%s(%d): unaligned access to 0x&quot;
id|RFMT
l_string|&quot; at ip=0x&quot;
id|RFMT
l_string|&quot;&bslash;n&quot;
comma
id|current-&gt;comm
comma
id|current-&gt;pid
comma
id|regs-&gt;ior
comma
id|regs-&gt;iaoq
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s&quot;
comma
id|buf
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_UNALIGNED
id|show_regs
c_func
(paren
id|regs
)paren
suffix:semicolon
macro_line|#endif&t;&t;
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|unaligned_enabled
)paren
r_goto
id|force_sigbus
suffix:semicolon
multiline_comment|/* handle modification - OK, it&squot;s ugly, see the instruction manual */
r_switch
c_cond
(paren
id|MAJOR_OP
c_func
(paren
id|regs-&gt;iir
)paren
)paren
(brace
r_case
l_int|0x03
suffix:colon
r_case
l_int|0x09
suffix:colon
r_case
l_int|0x0b
suffix:colon
r_if
c_cond
(paren
id|regs-&gt;iir
op_amp
l_int|0x20
)paren
(brace
id|modify
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|regs-&gt;iir
op_amp
l_int|0x1000
)paren
multiline_comment|/* short loads */
r_if
c_cond
(paren
id|regs-&gt;iir
op_amp
l_int|0x200
)paren
id|newbase
op_add_assign
id|IM5_3
c_func
(paren
id|regs-&gt;iir
)paren
suffix:semicolon
r_else
id|newbase
op_add_assign
id|IM5_2
c_func
(paren
id|regs-&gt;iir
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|regs-&gt;iir
op_amp
l_int|0x2000
)paren
multiline_comment|/* scaled indexed */
(brace
r_int
id|shift
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|regs-&gt;iir
op_amp
id|OPCODE1_MASK
)paren
(brace
r_case
id|OPCODE_LDH_I
suffix:colon
id|shift
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPCODE_LDW_I
suffix:colon
id|shift
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPCODE_LDD_I
suffix:colon
r_case
id|OPCODE_LDDA_I
suffix:colon
id|shift
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
)brace
id|newbase
op_add_assign
id|regs-&gt;gr
(braket
id|R2
c_func
(paren
id|regs-&gt;iir
)paren
)braket
op_lshift
id|shift
suffix:semicolon
)brace
r_else
multiline_comment|/* simple indexed */
id|newbase
op_add_assign
id|regs-&gt;gr
(braket
id|R2
c_func
(paren
id|regs-&gt;iir
)paren
)braket
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x13
suffix:colon
r_case
l_int|0x1b
suffix:colon
id|modify
op_assign
l_int|1
suffix:semicolon
id|newbase
op_add_assign
id|IM14
c_func
(paren
id|regs-&gt;iir
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x14
suffix:colon
r_case
l_int|0x1c
suffix:colon
r_if
c_cond
(paren
id|regs-&gt;iir
op_amp
l_int|8
)paren
(brace
id|modify
op_assign
l_int|1
suffix:semicolon
id|newbase
op_add_assign
id|IM14
c_func
(paren
id|regs-&gt;iir
op_amp
op_complement
l_int|0xe
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x16
suffix:colon
r_case
l_int|0x1e
suffix:colon
id|modify
op_assign
l_int|1
suffix:semicolon
id|newbase
op_add_assign
id|IM14
c_func
(paren
id|regs-&gt;iir
op_amp
l_int|6
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x17
suffix:colon
r_case
l_int|0x1f
suffix:colon
r_if
c_cond
(paren
id|regs-&gt;iir
op_amp
l_int|4
)paren
(brace
id|modify
op_assign
l_int|1
suffix:semicolon
id|newbase
op_add_assign
id|IM14
c_func
(paren
id|regs-&gt;iir
op_amp
op_complement
l_int|4
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|regs-&gt;isr
op_ne
id|regs-&gt;sr
(braket
l_int|7
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;isr verification failed (isr: &quot;
id|RFMT
l_string|&quot;, sr7: &quot;
id|RFMT
l_string|&quot;&bslash;n&quot;
comma
id|regs-&gt;isr
comma
id|regs-&gt;sr
(braket
l_int|7
)braket
)paren
suffix:semicolon
multiline_comment|/* don&squot;t kill him though, since he has appropriate access to the page, or we&n;&t;&t; * would never have gotten here.&n;&t;&t; */
)brace
multiline_comment|/* TODO: make this cleaner... */
r_switch
c_cond
(paren
id|regs-&gt;iir
op_amp
id|OPCODE1_MASK
)paren
(brace
r_case
id|OPCODE_LDH_I
suffix:colon
r_case
id|OPCODE_LDH_S
suffix:colon
id|ret
op_assign
id|emulate_ldh
c_func
(paren
id|regs
comma
id|R3
c_func
(paren
id|regs-&gt;iir
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPCODE_LDW_I
suffix:colon
r_case
id|OPCODE_LDWA_I
suffix:colon
r_case
id|OPCODE_LDW_S
suffix:colon
r_case
id|OPCODE_LDWA_S
suffix:colon
id|ret
op_assign
id|emulate_ldw
c_func
(paren
id|regs
comma
id|R3
c_func
(paren
id|regs-&gt;iir
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPCODE_STH
suffix:colon
id|ret
op_assign
id|emulate_sth
c_func
(paren
id|regs
comma
id|R2
c_func
(paren
id|regs-&gt;iir
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPCODE_STW
suffix:colon
r_case
id|OPCODE_STWA
suffix:colon
id|ret
op_assign
id|emulate_stw
c_func
(paren
id|regs
comma
id|R2
c_func
(paren
id|regs-&gt;iir
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef __LP64__
r_case
id|OPCODE_LDD_I
suffix:colon
r_case
id|OPCODE_LDDA_I
suffix:colon
r_case
id|OPCODE_LDD_S
suffix:colon
r_case
id|OPCODE_LDDA_S
suffix:colon
id|ret
op_assign
id|emulate_ldd
c_func
(paren
id|regs
comma
id|R3
c_func
(paren
id|regs-&gt;iir
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPCODE_STD
suffix:colon
r_case
id|OPCODE_STDA
suffix:colon
id|ret
op_assign
id|emulate_std
c_func
(paren
id|regs
comma
id|R2
c_func
(paren
id|regs-&gt;iir
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|OPCODE_LDCD_I
suffix:colon
r_case
id|OPCODE_LDCW_I
suffix:colon
r_case
id|OPCODE_LDCD_S
suffix:colon
r_case
id|OPCODE_LDCW_S
suffix:colon
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* &quot;undefined&quot;, but lets kill them. */
r_break
suffix:semicolon
)brace
macro_line|#ifdef __LP64__
r_switch
c_cond
(paren
id|regs-&gt;iir
op_amp
id|OPCODE2_MASK
)paren
(brace
r_case
id|OPCODE_LDD_L
suffix:colon
r_case
id|OPCODE_FLDD_L
suffix:colon
id|ret
op_assign
id|emulate_ldd
c_func
(paren
id|regs
comma
id|R2
c_func
(paren
id|regs-&gt;iir
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPCODE_STD_L
suffix:colon
r_case
id|OPCODE_FSTD_L
suffix:colon
id|ret
op_assign
id|emulate_std
c_func
(paren
id|regs
comma
id|R2
c_func
(paren
id|regs-&gt;iir
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#endif
r_switch
c_cond
(paren
id|regs-&gt;iir
op_amp
id|OPCODE3_MASK
)paren
(brace
r_case
id|OPCODE_LDW_M
suffix:colon
r_case
id|OPCODE_FLDW_L
suffix:colon
id|ret
op_assign
id|emulate_ldw
c_func
(paren
id|regs
comma
id|R2
c_func
(paren
id|regs-&gt;iir
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPCODE_FSTW_L
suffix:colon
r_case
id|OPCODE_STW_M
suffix:colon
id|ret
op_assign
id|emulate_stw
c_func
(paren
id|regs
comma
id|R2
c_func
(paren
id|regs-&gt;iir
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|regs-&gt;iir
op_amp
id|OPCODE4_MASK
)paren
(brace
r_case
id|OPCODE_LDH_L
suffix:colon
id|ret
op_assign
id|emulate_ldh
c_func
(paren
id|regs
comma
id|R2
c_func
(paren
id|regs-&gt;iir
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPCODE_LDW_L
suffix:colon
r_case
id|OPCODE_LDWM
suffix:colon
id|ret
op_assign
id|emulate_ldw
c_func
(paren
id|regs
comma
id|R2
c_func
(paren
id|regs-&gt;iir
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPCODE_STH_L
suffix:colon
id|ret
op_assign
id|emulate_sth
c_func
(paren
id|regs
comma
id|R2
c_func
(paren
id|regs-&gt;iir
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPCODE_STW_L
suffix:colon
r_case
id|OPCODE_STWM
suffix:colon
id|ret
op_assign
id|emulate_stw
c_func
(paren
id|regs
comma
id|R2
c_func
(paren
id|regs-&gt;iir
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* XXX LJ - need to handle float load/store */
r_if
c_cond
(paren
id|modify
)paren
id|regs-&gt;gr
(braket
id|R1
c_func
(paren
id|regs-&gt;iir
)paren
)braket
op_assign
id|newbase
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;Not-handled unaligned insn 0x%08lx&bslash;n&quot;
comma
id|regs-&gt;iir
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
l_string|&quot;ret = %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;Unaligned handler failed, ret = %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
id|die_if_kernel
c_func
(paren
l_string|&quot;Unaligned data reference&quot;
comma
id|regs
comma
l_int|28
)paren
suffix:semicolon
id|force_sigbus
suffix:colon
multiline_comment|/* couldn&squot;t handle it ... */
id|si.si_signo
op_assign
id|SIGBUS
suffix:semicolon
id|si.si_errno
op_assign
l_int|0
suffix:semicolon
id|si.si_code
op_assign
id|BUS_ADRALN
suffix:semicolon
id|si.si_addr
op_assign
(paren
r_void
op_star
)paren
id|regs-&gt;ior
suffix:semicolon
id|force_sig_info
c_func
(paren
id|SIGBUS
comma
op_amp
id|si
comma
id|current
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* else we handled it, advance the PC.... */
id|regs-&gt;iaoq
(braket
l_int|0
)braket
op_assign
id|regs-&gt;iaoq
(braket
l_int|1
)braket
suffix:semicolon
id|regs-&gt;iaoq
(braket
l_int|1
)braket
op_assign
id|regs-&gt;iaoq
(braket
l_int|0
)braket
op_plus
l_int|4
suffix:semicolon
)brace
multiline_comment|/*&n; * NB: check_unaligned() is only used for PCXS processors right&n; * now, so we only check for PA1.1 encodings at this point.&n; */
r_int
DECL|function|check_unaligned
id|check_unaligned
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|align_mask
suffix:semicolon
multiline_comment|/* Get alignment mask */
id|align_mask
op_assign
l_int|0UL
suffix:semicolon
r_switch
c_cond
(paren
id|regs-&gt;iir
op_amp
id|OPCODE1_MASK
)paren
(brace
r_case
id|OPCODE_LDH_I
suffix:colon
r_case
id|OPCODE_LDH_S
suffix:colon
r_case
id|OPCODE_STH
suffix:colon
id|align_mask
op_assign
l_int|1UL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPCODE_LDW_I
suffix:colon
r_case
id|OPCODE_LDWA_I
suffix:colon
r_case
id|OPCODE_LDW_S
suffix:colon
r_case
id|OPCODE_LDWA_S
suffix:colon
r_case
id|OPCODE_STW
suffix:colon
r_case
id|OPCODE_STWA
suffix:colon
id|align_mask
op_assign
l_int|3UL
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_switch
c_cond
(paren
id|regs-&gt;iir
op_amp
id|OPCODE4_MASK
)paren
(brace
r_case
id|OPCODE_LDH_L
suffix:colon
r_case
id|OPCODE_STH_L
suffix:colon
id|align_mask
op_assign
l_int|1UL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPCODE_LDW_L
suffix:colon
r_case
id|OPCODE_LDWM
suffix:colon
r_case
id|OPCODE_STW_L
suffix:colon
r_case
id|OPCODE_STWM
suffix:colon
id|align_mask
op_assign
l_int|3UL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_return
(paren
r_int
)paren
(paren
id|regs-&gt;ior
op_amp
id|align_mask
)paren
suffix:semicolon
)brace
eof
