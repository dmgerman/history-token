multiline_comment|/*&n; *    Optimized memory copy routines.&n; *&n; *    Copyright (C) 2004 Randolph Chung &lt;tausq@debian.org&gt;&n; *&n; *    This program is free software; you can redistribute it and/or modify&n; *    it under the terms of the GNU General Public License as published by&n; *    the Free Software Foundation; either version 2, or (at your option)&n; *    any later version.&n; *&n; *    This program is distributed in the hope that it will be useful,&n; *    but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *    GNU General Public License for more details.&n; *&n; *    You should have received a copy of the GNU General Public License&n; *    along with this program; if not, write to the Free Software&n; *    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; *    Portions derived from the GNU C Library&n; *    Copyright (C) 1991, 1997, 2003 Free Software Foundation, Inc.&n; *&n; * Several strategies are tried to try to get the best performance for various&n; * conditions. In the optimal case, we copy 64-bytes in an unrolled loop using &n; * fp regs. This is followed by loops that copy 32- or 16-bytes at a time using&n; * general registers.  Unaligned copies are handled either by aligning the &n; * destination and then using shift-and-write method, or in a few cases by &n; * falling back to a byte-at-a-time copy.&n; *&n; * I chose to implement this in C because it is easier to maintain and debug,&n; * and in my experiments it appears that the C code generated by gcc (3.3/3.4&n; * at the time of writing) is fairly optimal. Unfortunately some of the &n; * semantics of the copy routine (exception handling) is difficult to express&n; * in C, so we have to play some tricks to get it to work.&n; *&n; * All the loads and stores are done via explicit asm() code in order to use&n; * the right space registers. &n; * &n; * Testing with various alignments and buffer sizes shows that this code is &n; * often &gt;10x faster than a simple byte-at-a-time copy, even for strangely&n; * aligned operands. It is interesting to note that the glibc version&n; * of memcpy (written in C) is actually quite fast already. This routine is &n; * able to beat it by 30-40% for aligned copies because of the loop unrolling, &n; * but in some cases the glibc version is still slightly faster. This lends &n; * more credibility that gcc can generate very good code as long as we are &n; * careful.&n; *&n; * TODO:&n; * - cache prefetching needs more experimentation to get optimal settings&n; * - try not to use the post-increment address modifiers; they create additional&n; *   interlocks&n; * - replace byte-copy loops with stybs sequences&n; */
macro_line|#ifdef __KERNEL__
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/compiler.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|macro|s_space
mdefine_line|#define s_space &quot;%%sr1&quot;
DECL|macro|d_space
mdefine_line|#define d_space &quot;%%sr2&quot;
macro_line|#else
macro_line|#include &quot;memcpy.h&quot;
DECL|macro|s_space
mdefine_line|#define s_space &quot;%%sr0&quot;
DECL|macro|d_space
mdefine_line|#define d_space &quot;%%sr0&quot;
DECL|macro|pa_memcpy
mdefine_line|#define pa_memcpy new2_copy
macro_line|#endif
id|DECLARE_PER_CPU
c_func
(paren
r_struct
id|exception_data
comma
id|exception_data
)paren
suffix:semicolon
DECL|macro|preserve_branch
mdefine_line|#define preserve_branch(label)&t;do {&t;&t;&t;&t;&t;&bslash;&n;&t;volatile int dummy;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;/* The following branch is never taken, it&squot;s just here to  */&t;&bslash;&n;&t;/* prevent gcc from optimizing away our exception code. */ &t;&bslash;&n;&t;if (unlikely(dummy != dummy))&t;&t;&t;&t;&t;&bslash;&n;&t;&t;goto label;&t;&t;&t;&t;&t;&t;&bslash;&n;} while (0)
DECL|macro|get_user_space
mdefine_line|#define get_user_space() (segment_eq(get_fs(), KERNEL_DS) ? 0 : mfsp(3))
DECL|macro|get_kernel_space
mdefine_line|#define get_kernel_space() (0)
DECL|macro|MERGE
mdefine_line|#define MERGE(w0, sh_1, w1, sh_2)  ({&t;&t;&t;&t;&t;&bslash;&n;&t;unsigned int _r;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;asm volatile (&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&quot;mtsar %3&bslash;n&quot;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&quot;shrpw %1, %2, %%sar, %0&bslash;n&quot;&t;&t;&t;&t;&t;&bslash;&n;&t;: &quot;=r&quot;(_r)&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;: &quot;r&quot;(w0), &quot;r&quot;(w1), &quot;r&quot;(sh_2)&t;&t;&t;&t;&t;&bslash;&n;&t;);&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;_r;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;})
DECL|macro|THRESHOLD
mdefine_line|#define THRESHOLD&t;16
macro_line|#ifdef DEBUG_MEMCPY
DECL|macro|DPRINTF
mdefine_line|#define DPRINTF(fmt, args...) do { printk(KERN_DEBUG &quot;%s:%d:%s &quot;, __FILE__, __LINE__, __FUNCTION__ ); printk(KERN_DEBUG fmt, ##args ); } while (0)
macro_line|#else
DECL|macro|DPRINTF
mdefine_line|#define DPRINTF(fmt, args...)
macro_line|#endif
macro_line|#ifndef __LP64__
DECL|macro|EXC_WORD
mdefine_line|#define EXC_WORD &quot;.word&quot;
macro_line|#else
DECL|macro|EXC_WORD
mdefine_line|#define EXC_WORD &quot;.dword&quot;
macro_line|#endif
DECL|macro|def_load_ai_insn
mdefine_line|#define def_load_ai_insn(_insn,_sz,_tt,_s,_a,_t,_e)&t;&bslash;&n;&t;__asm__ __volatile__ (&t;&t;&t;&t;&bslash;&n;&t;&quot;1:&bslash;t&quot; #_insn &quot;,ma &quot; #_sz &quot;(&quot; _s &quot;,%1), %0&bslash;n&quot; &t;&bslash;&n;&t;&quot;&bslash;t.section __ex_table,&bslash;&quot;aw&bslash;&quot;&bslash;n&quot;&t;&t;&bslash;&n;&t;&quot;&bslash;t&quot; EXC_WORD &quot;&bslash;t1b&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&quot;&bslash;t&quot; EXC_WORD &quot;&bslash;t&quot; #_e &quot;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&quot;&bslash;t.previous&bslash;n&quot;&t;&t;&t;&t;&t;&bslash;&n;&t;: _tt(_t), &quot;+r&quot;(_a)&t;&t;&t;&t;&bslash;&n;&t;: &quot;1&quot;(_a)&t;&t;&t;&t;&t;&bslash;&n;&t;: &quot;r8&quot;)
DECL|macro|def_store_ai_insn
mdefine_line|#define def_store_ai_insn(_insn,_sz,_tt,_s,_a,_t,_e) &t;&bslash;&n;&t;__asm__ __volatile__ (&t;&t;&t;&t;&bslash;&n;&t;&quot;1:&bslash;t&quot; #_insn &quot;,ma %1, &quot; #_sz &quot;(&quot; _s &quot;,%0)&bslash;n&quot; &t;&bslash;&n;&t;&quot;&bslash;t.section __ex_table,&bslash;&quot;aw&bslash;&quot;&bslash;n&quot;&t;&t;&bslash;&n;&t;&quot;&bslash;t&quot; EXC_WORD &quot;&bslash;t1b&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&quot;&bslash;t&quot; EXC_WORD &quot;&bslash;t&quot; #_e &quot;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&quot;&bslash;t.previous&bslash;n&quot;&t;&t;&t;&t;&t;&bslash;&n;&t;: &quot;+r&quot;(_a) &t;&t;&t;&t;&t;&bslash;&n;&t;: _tt(_t), &quot;0&quot;(_a)&t;&t;&t;&t;&bslash;&n;&t;: &quot;r8&quot;)
DECL|macro|ldbma
mdefine_line|#define ldbma(_s, _a, _t, _e) def_load_ai_insn(ldbs,1,&quot;=r&quot;,_s,_a,_t,_e)
DECL|macro|stbma
mdefine_line|#define stbma(_s, _t, _a, _e) def_store_ai_insn(stbs,1,&quot;r&quot;,_s,_a,_t,_e)
DECL|macro|ldwma
mdefine_line|#define ldwma(_s, _a, _t, _e) def_load_ai_insn(ldw,4,&quot;=r&quot;,_s,_a,_t,_e)
DECL|macro|stwma
mdefine_line|#define stwma(_s, _t, _a, _e) def_store_ai_insn(stw,4,&quot;r&quot;,_s,_a,_t,_e)
DECL|macro|flddma
mdefine_line|#define flddma(_s, _a, _t, _e) def_load_ai_insn(fldd,8,&quot;=f&quot;,_s,_a,_t,_e)
DECL|macro|fstdma
mdefine_line|#define fstdma(_s, _t, _a, _e) def_store_ai_insn(fstd,8,&quot;f&quot;,_s,_a,_t,_e)
DECL|macro|def_load_insn
mdefine_line|#define def_load_insn(_insn,_tt,_s,_o,_a,_t,_e) &t;&bslash;&n;&t;__asm__ __volatile__ (&t;&t;&t;&t;&bslash;&n;&t;&quot;1:&bslash;t&quot; #_insn &quot; &quot; #_o &quot;(&quot; _s &quot;,%1), %0&bslash;n&quot;&t;&bslash;&n;&t;&quot;&bslash;t.section __ex_table,&bslash;&quot;aw&bslash;&quot;&bslash;n&quot;&t;&t;&bslash;&n;&t;&quot;&bslash;t&quot; EXC_WORD &quot;&bslash;t1b&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&quot;&bslash;t&quot; EXC_WORD &quot;&bslash;t&quot; #_e &quot;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&quot;&bslash;t.previous&bslash;n&quot;&t;&t;&t;&t;&t;&bslash;&n;&t;: _tt(_t) &t;&t;&t;&t;&t;&bslash;&n;&t;: &quot;r&quot;(_a)&t;&t;&t;&t;&t;&bslash;&n;&t;: &quot;r8&quot;)
DECL|macro|def_store_insn
mdefine_line|#define def_store_insn(_insn,_tt,_s,_t,_o,_a,_e) &t;&bslash;&n;&t;__asm__ __volatile__ (&t;&t;&t;&t;&bslash;&n;&t;&quot;1:&bslash;t&quot; #_insn &quot; %0, &quot; #_o &quot;(&quot; _s &quot;,%1)&bslash;n&quot; &t;&bslash;&n;&t;&quot;&bslash;t.section __ex_table,&bslash;&quot;aw&bslash;&quot;&bslash;n&quot;&t;&t;&bslash;&n;&t;&quot;&bslash;t&quot; EXC_WORD &quot;&bslash;t1b&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&quot;&bslash;t&quot; EXC_WORD &quot;&bslash;t&quot; #_e &quot;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&quot;&bslash;t.previous&bslash;n&quot;&t;&t;&t;&t;&t;&bslash;&n;&t;: &t;&t;&t;&t;&t;&t;&bslash;&n;&t;: _tt(_t), &quot;r&quot;(_a)&t;&t;&t;&t;&bslash;&n;&t;: &quot;r8&quot;)
DECL|macro|ldw
mdefine_line|#define ldw(_s,_o,_a,_t,_e)&t;def_load_insn(ldw,&quot;=r&quot;,_s,_o,_a,_t,_e)
DECL|macro|stw
mdefine_line|#define stw(_s,_t,_o,_a,_e) &t;def_store_insn(stw,&quot;r&quot;,_s,_t,_o,_a,_e)
macro_line|#ifdef  CONFIG_PREFETCH
DECL|function|prefetch_src
r_extern
r_inline
r_void
id|prefetch_src
c_func
(paren
r_const
r_void
op_star
id|addr
)paren
(brace
id|__asm__
c_func
(paren
l_string|&quot;ldw 0(&quot;
id|s_space
l_string|&quot;,%0), %%r0&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|addr
)paren
)paren
suffix:semicolon
)brace
DECL|function|prefetch_dst
r_extern
r_inline
r_void
id|prefetch_dst
c_func
(paren
r_const
r_void
op_star
id|addr
)paren
(brace
id|__asm__
c_func
(paren
l_string|&quot;ldd 0(&quot;
id|d_space
l_string|&quot;,%0), %%r0&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|addr
)paren
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|macro|prefetch_src
mdefine_line|#define prefetch_src(addr)
DECL|macro|prefetch_dst
mdefine_line|#define prefetch_dst(addr)
macro_line|#endif
multiline_comment|/* Copy from a not-aligned src to an aligned dst, using shifts. Handles 4 words&n; * per loop.  This code is derived from glibc. &n; */
DECL|function|copy_dstaligned
r_static
r_inline
r_int
r_int
id|copy_dstaligned
c_func
(paren
r_int
r_int
id|dst
comma
r_int
r_int
id|src
comma
r_int
r_int
id|len
comma
r_int
r_int
id|o_dst
comma
r_int
r_int
id|o_src
comma
r_int
r_int
id|o_len
)paren
(brace
multiline_comment|/* gcc complains that a2 and a3 may be uninitialized, but actually&n;&t; * they cannot be.  Initialize a2/a3 to shut gcc up.&n;&t; */
r_register
r_int
r_int
id|a0
comma
id|a1
comma
id|a2
op_assign
l_int|0
comma
id|a3
op_assign
l_int|0
suffix:semicolon
r_int
id|sh_1
comma
id|sh_2
suffix:semicolon
r_struct
id|exception_data
op_star
id|d
suffix:semicolon
multiline_comment|/* prefetch_src((const void *)src); */
multiline_comment|/* Calculate how to shift a word read at the memory operation&n;&t;   aligned srcp to make it aligned for copy.  */
id|sh_1
op_assign
l_int|8
op_star
(paren
id|src
op_mod
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
id|sh_2
op_assign
l_int|8
op_star
r_sizeof
(paren
r_int
r_int
)paren
op_minus
id|sh_1
suffix:semicolon
multiline_comment|/* Make src aligned by rounding it down.  */
id|src
op_and_assign
op_minus
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|len
op_mod
l_int|4
)paren
(brace
r_case
l_int|2
suffix:colon
multiline_comment|/* a1 = ((unsigned int *) src)[0];&n;&t;&t;&t;   a2 = ((unsigned int *) src)[1]; */
id|ldw
c_func
(paren
id|s_space
comma
l_int|0
comma
id|src
comma
id|a1
comma
id|cda_ldw_exc
)paren
suffix:semicolon
id|ldw
c_func
(paren
id|s_space
comma
l_int|4
comma
id|src
comma
id|a2
comma
id|cda_ldw_exc
)paren
suffix:semicolon
id|src
op_sub_assign
l_int|1
op_star
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
id|dst
op_sub_assign
l_int|3
op_star
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
id|len
op_add_assign
l_int|2
suffix:semicolon
r_goto
id|do1
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* a0 = ((unsigned int *) src)[0];&n;&t;&t;&t;   a1 = ((unsigned int *) src)[1]; */
id|ldw
c_func
(paren
id|s_space
comma
l_int|0
comma
id|src
comma
id|a0
comma
id|cda_ldw_exc
)paren
suffix:semicolon
id|ldw
c_func
(paren
id|s_space
comma
l_int|4
comma
id|src
comma
id|a1
comma
id|cda_ldw_exc
)paren
suffix:semicolon
id|src
op_sub_assign
l_int|0
op_star
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
id|dst
op_sub_assign
l_int|2
op_star
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
id|len
op_add_assign
l_int|1
suffix:semicolon
r_goto
id|do2
suffix:semicolon
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* a3 = ((unsigned int *) src)[0];&n;&t;&t;&t;   a0 = ((unsigned int *) src)[1]; */
id|ldw
c_func
(paren
id|s_space
comma
l_int|0
comma
id|src
comma
id|a3
comma
id|cda_ldw_exc
)paren
suffix:semicolon
id|ldw
c_func
(paren
id|s_space
comma
l_int|4
comma
id|src
comma
id|a0
comma
id|cda_ldw_exc
)paren
suffix:semicolon
id|src
op_sub_assign
op_minus
l_int|1
op_star
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
id|dst
op_sub_assign
l_int|1
op_star
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
id|len
op_add_assign
l_int|0
suffix:semicolon
r_goto
id|do3
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* a2 = ((unsigned int *) src)[0];&n;&t;&t;&t;   a3 = ((unsigned int *) src)[1]; */
id|ldw
c_func
(paren
id|s_space
comma
l_int|0
comma
id|src
comma
id|a2
comma
id|cda_ldw_exc
)paren
suffix:semicolon
id|ldw
c_func
(paren
id|s_space
comma
l_int|4
comma
id|src
comma
id|a3
comma
id|cda_ldw_exc
)paren
suffix:semicolon
id|src
op_sub_assign
op_minus
l_int|2
op_star
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
id|dst
op_sub_assign
l_int|0
op_star
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
id|len
op_sub_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
r_goto
id|do0
suffix:semicolon
r_goto
id|do4
suffix:semicolon
multiline_comment|/* No-op.  */
)brace
r_do
(brace
multiline_comment|/* prefetch_src((const void *)(src + 4 * sizeof(unsigned int))); */
id|do4
suffix:colon
multiline_comment|/* a0 = ((unsigned int *) src)[0]; */
id|ldw
c_func
(paren
id|s_space
comma
l_int|0
comma
id|src
comma
id|a0
comma
id|cda_ldw_exc
)paren
suffix:semicolon
multiline_comment|/* ((unsigned int *) dst)[0] = MERGE (a2, sh_1, a3, sh_2); */
id|stw
c_func
(paren
id|d_space
comma
id|MERGE
(paren
id|a2
comma
id|sh_1
comma
id|a3
comma
id|sh_2
)paren
comma
l_int|0
comma
id|dst
comma
id|cda_stw_exc
)paren
suffix:semicolon
id|do3
suffix:colon
multiline_comment|/* a1 = ((unsigned int *) src)[1]; */
id|ldw
c_func
(paren
id|s_space
comma
l_int|4
comma
id|src
comma
id|a1
comma
id|cda_ldw_exc
)paren
suffix:semicolon
multiline_comment|/* ((unsigned int *) dst)[1] = MERGE (a3, sh_1, a0, sh_2); */
id|stw
c_func
(paren
id|d_space
comma
id|MERGE
(paren
id|a3
comma
id|sh_1
comma
id|a0
comma
id|sh_2
)paren
comma
l_int|4
comma
id|dst
comma
id|cda_stw_exc
)paren
suffix:semicolon
id|do2
suffix:colon
multiline_comment|/* a2 = ((unsigned int *) src)[2]; */
id|ldw
c_func
(paren
id|s_space
comma
l_int|8
comma
id|src
comma
id|a2
comma
id|cda_ldw_exc
)paren
suffix:semicolon
multiline_comment|/* ((unsigned int *) dst)[2] = MERGE (a0, sh_1, a1, sh_2); */
id|stw
c_func
(paren
id|d_space
comma
id|MERGE
(paren
id|a0
comma
id|sh_1
comma
id|a1
comma
id|sh_2
)paren
comma
l_int|8
comma
id|dst
comma
id|cda_stw_exc
)paren
suffix:semicolon
id|do1
suffix:colon
multiline_comment|/* a3 = ((unsigned int *) src)[3]; */
id|ldw
c_func
(paren
id|s_space
comma
l_int|12
comma
id|src
comma
id|a3
comma
id|cda_ldw_exc
)paren
suffix:semicolon
multiline_comment|/* ((unsigned int *) dst)[3] = MERGE (a1, sh_1, a2, sh_2); */
id|stw
c_func
(paren
id|d_space
comma
id|MERGE
(paren
id|a1
comma
id|sh_1
comma
id|a2
comma
id|sh_2
)paren
comma
l_int|12
comma
id|dst
comma
id|cda_stw_exc
)paren
suffix:semicolon
id|src
op_add_assign
l_int|4
op_star
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
id|dst
op_add_assign
l_int|4
op_star
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
id|len
op_sub_assign
l_int|4
suffix:semicolon
)brace
r_while
c_loop
(paren
id|len
op_ne
l_int|0
)paren
suffix:semicolon
id|do0
suffix:colon
multiline_comment|/* ((unsigned int *) dst)[0] = MERGE (a2, sh_1, a3, sh_2); */
id|stw
c_func
(paren
id|d_space
comma
id|MERGE
(paren
id|a2
comma
id|sh_1
comma
id|a3
comma
id|sh_2
)paren
comma
l_int|0
comma
id|dst
comma
id|cda_stw_exc
)paren
suffix:semicolon
id|preserve_branch
c_func
(paren
id|handle_load_error
)paren
suffix:semicolon
id|preserve_branch
c_func
(paren
id|handle_store_error
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|handle_load_error
suffix:colon
id|__asm__
id|__volatile__
(paren
l_string|&quot;cda_ldw_exc:&bslash;n&quot;
)paren
suffix:semicolon
id|d
op_assign
op_amp
id|__get_cpu_var
c_func
(paren
id|exception_data
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
l_string|&quot;cda_ldw_exc: o_len=%lu fault_addr=%lu o_src=%lu ret=%lu&bslash;n&quot;
comma
id|o_len
comma
id|d-&gt;fault_addr
comma
id|o_src
comma
id|o_len
op_minus
id|d-&gt;fault_addr
op_plus
id|o_src
)paren
suffix:semicolon
r_return
id|o_len
op_star
l_int|4
op_minus
id|d-&gt;fault_addr
op_plus
id|o_src
suffix:semicolon
id|handle_store_error
suffix:colon
id|__asm__
id|__volatile__
(paren
l_string|&quot;cda_stw_exc:&bslash;n&quot;
)paren
suffix:semicolon
id|d
op_assign
op_amp
id|__get_cpu_var
c_func
(paren
id|exception_data
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
l_string|&quot;cda_stw_exc: o_len=%lu fault_addr=%lu o_dst=%lu ret=%lu&bslash;n&quot;
comma
id|o_len
comma
id|d-&gt;fault_addr
comma
id|o_dst
comma
id|o_len
op_minus
id|d-&gt;fault_addr
op_plus
id|o_dst
)paren
suffix:semicolon
r_return
id|o_len
op_star
l_int|4
op_minus
id|d-&gt;fault_addr
op_plus
id|o_dst
suffix:semicolon
)brace
multiline_comment|/* Returns 0 for success, otherwise, returns number of bytes not transferred. */
DECL|function|pa_memcpy
r_int
r_int
id|pa_memcpy
c_func
(paren
r_void
op_star
id|dstp
comma
r_const
r_void
op_star
id|srcp
comma
r_int
r_int
id|len
)paren
(brace
r_register
r_int
r_int
id|src
comma
id|dst
comma
id|t1
comma
id|t2
comma
id|t3
suffix:semicolon
r_register
r_char
op_star
id|pcs
comma
op_star
id|pcd
suffix:semicolon
r_register
r_int
r_int
op_star
id|pws
comma
op_star
id|pwd
suffix:semicolon
r_register
r_float
op_star
id|pds
comma
op_star
id|pdd
suffix:semicolon
r_int
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|o_dst
comma
id|o_src
comma
id|o_len
suffix:semicolon
r_struct
id|exception_data
op_star
id|d
suffix:semicolon
id|src
op_assign
(paren
r_int
r_int
)paren
id|srcp
suffix:semicolon
id|dst
op_assign
(paren
r_int
r_int
)paren
id|dstp
suffix:semicolon
id|pcs
op_assign
(paren
r_int
r_char
op_star
)paren
id|srcp
suffix:semicolon
id|pcd
op_assign
(paren
r_int
r_char
op_star
)paren
id|dstp
suffix:semicolon
id|o_dst
op_assign
id|dst
suffix:semicolon
id|o_src
op_assign
id|src
suffix:semicolon
id|o_len
op_assign
id|len
suffix:semicolon
multiline_comment|/* prefetch_src((const void *)srcp); */
r_if
c_cond
(paren
id|len
OL
id|THRESHOLD
)paren
r_goto
id|byte_copy
suffix:semicolon
multiline_comment|/* Check alignment */
id|t1
op_assign
(paren
id|src
op_xor
id|dst
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|t1
op_amp
(paren
r_sizeof
(paren
r_float
)paren
op_minus
l_int|1
)paren
)paren
)paren
r_goto
id|unaligned_copy
suffix:semicolon
multiline_comment|/* src and dst have same alignment. */
multiline_comment|/* Copy bytes till we are double-aligned. */
id|t2
op_assign
id|src
op_amp
(paren
r_sizeof
(paren
r_float
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|t2
op_ne
l_int|0
)paren
)paren
(brace
id|t2
op_assign
r_sizeof
(paren
r_float
)paren
op_minus
id|t2
suffix:semicolon
r_while
c_loop
(paren
id|t2
op_logical_and
id|len
)paren
(brace
multiline_comment|/* *pcd++ = *pcs++; */
id|ldbma
c_func
(paren
id|s_space
comma
id|pcs
comma
id|t3
comma
id|pmc_load_exc
)paren
suffix:semicolon
id|len
op_decrement
suffix:semicolon
id|stbma
c_func
(paren
id|d_space
comma
id|t3
comma
id|pcd
comma
id|pmc_store_exc
)paren
suffix:semicolon
id|t2
op_decrement
suffix:semicolon
)brace
)brace
id|pds
op_assign
(paren
r_float
op_star
)paren
id|pcs
suffix:semicolon
id|pdd
op_assign
(paren
r_float
op_star
)paren
id|pcd
suffix:semicolon
multiline_comment|/* Copy 8 doubles at a time */
r_while
c_loop
(paren
id|len
op_ge
l_int|8
op_star
r_sizeof
(paren
r_float
)paren
)paren
(brace
r_register
r_float
id|r1
comma
id|r2
comma
id|r3
comma
id|r4
comma
id|r5
comma
id|r6
comma
id|r7
comma
id|r8
suffix:semicolon
multiline_comment|/* prefetch_src((char *)pds + L1_CACHE_BYTES); */
id|flddma
c_func
(paren
id|s_space
comma
id|pds
comma
id|r1
comma
id|pmc_load_exc
)paren
suffix:semicolon
id|flddma
c_func
(paren
id|s_space
comma
id|pds
comma
id|r2
comma
id|pmc_load_exc
)paren
suffix:semicolon
id|flddma
c_func
(paren
id|s_space
comma
id|pds
comma
id|r3
comma
id|pmc_load_exc
)paren
suffix:semicolon
id|flddma
c_func
(paren
id|s_space
comma
id|pds
comma
id|r4
comma
id|pmc_load_exc
)paren
suffix:semicolon
id|fstdma
c_func
(paren
id|d_space
comma
id|r1
comma
id|pdd
comma
id|pmc_store_exc
)paren
suffix:semicolon
id|fstdma
c_func
(paren
id|d_space
comma
id|r2
comma
id|pdd
comma
id|pmc_store_exc
)paren
suffix:semicolon
id|fstdma
c_func
(paren
id|d_space
comma
id|r3
comma
id|pdd
comma
id|pmc_store_exc
)paren
suffix:semicolon
id|fstdma
c_func
(paren
id|d_space
comma
id|r4
comma
id|pdd
comma
id|pmc_store_exc
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|L1_CACHE_BYTES
op_le
l_int|32
)paren
id|prefetch_src
c_func
(paren
(paren
r_char
op_star
)paren
id|pds
op_plus
id|L1_CACHE_BYTES
)paren
suffix:semicolon
macro_line|#endif
id|flddma
c_func
(paren
id|s_space
comma
id|pds
comma
id|r5
comma
id|pmc_load_exc
)paren
suffix:semicolon
id|flddma
c_func
(paren
id|s_space
comma
id|pds
comma
id|r6
comma
id|pmc_load_exc
)paren
suffix:semicolon
id|flddma
c_func
(paren
id|s_space
comma
id|pds
comma
id|r7
comma
id|pmc_load_exc
)paren
suffix:semicolon
id|flddma
c_func
(paren
id|s_space
comma
id|pds
comma
id|r8
comma
id|pmc_load_exc
)paren
suffix:semicolon
id|fstdma
c_func
(paren
id|d_space
comma
id|r5
comma
id|pdd
comma
id|pmc_store_exc
)paren
suffix:semicolon
id|fstdma
c_func
(paren
id|d_space
comma
id|r6
comma
id|pdd
comma
id|pmc_store_exc
)paren
suffix:semicolon
id|fstdma
c_func
(paren
id|d_space
comma
id|r7
comma
id|pdd
comma
id|pmc_store_exc
)paren
suffix:semicolon
id|fstdma
c_func
(paren
id|d_space
comma
id|r8
comma
id|pdd
comma
id|pmc_store_exc
)paren
suffix:semicolon
id|len
op_sub_assign
l_int|8
op_star
r_sizeof
(paren
r_float
)paren
suffix:semicolon
)brace
id|pws
op_assign
(paren
r_int
r_int
op_star
)paren
id|pds
suffix:semicolon
id|pwd
op_assign
(paren
r_int
r_int
op_star
)paren
id|pdd
suffix:semicolon
id|word_copy
suffix:colon
r_while
c_loop
(paren
id|len
op_ge
l_int|8
op_star
r_sizeof
(paren
r_int
r_int
)paren
)paren
(brace
r_register
r_int
r_int
id|r1
comma
id|r2
comma
id|r3
comma
id|r4
comma
id|r5
comma
id|r6
comma
id|r7
comma
id|r8
suffix:semicolon
multiline_comment|/* prefetch_src((char *)pws + L1_CACHE_BYTES); */
id|ldwma
c_func
(paren
id|s_space
comma
id|pws
comma
id|r1
comma
id|pmc_load_exc
)paren
suffix:semicolon
id|ldwma
c_func
(paren
id|s_space
comma
id|pws
comma
id|r2
comma
id|pmc_load_exc
)paren
suffix:semicolon
id|ldwma
c_func
(paren
id|s_space
comma
id|pws
comma
id|r3
comma
id|pmc_load_exc
)paren
suffix:semicolon
id|ldwma
c_func
(paren
id|s_space
comma
id|pws
comma
id|r4
comma
id|pmc_load_exc
)paren
suffix:semicolon
id|stwma
c_func
(paren
id|d_space
comma
id|r1
comma
id|pwd
comma
id|pmc_store_exc
)paren
suffix:semicolon
id|stwma
c_func
(paren
id|d_space
comma
id|r2
comma
id|pwd
comma
id|pmc_store_exc
)paren
suffix:semicolon
id|stwma
c_func
(paren
id|d_space
comma
id|r3
comma
id|pwd
comma
id|pmc_store_exc
)paren
suffix:semicolon
id|stwma
c_func
(paren
id|d_space
comma
id|r4
comma
id|pwd
comma
id|pmc_store_exc
)paren
suffix:semicolon
id|ldwma
c_func
(paren
id|s_space
comma
id|pws
comma
id|r5
comma
id|pmc_load_exc
)paren
suffix:semicolon
id|ldwma
c_func
(paren
id|s_space
comma
id|pws
comma
id|r6
comma
id|pmc_load_exc
)paren
suffix:semicolon
id|ldwma
c_func
(paren
id|s_space
comma
id|pws
comma
id|r7
comma
id|pmc_load_exc
)paren
suffix:semicolon
id|ldwma
c_func
(paren
id|s_space
comma
id|pws
comma
id|r8
comma
id|pmc_load_exc
)paren
suffix:semicolon
id|stwma
c_func
(paren
id|d_space
comma
id|r5
comma
id|pwd
comma
id|pmc_store_exc
)paren
suffix:semicolon
id|stwma
c_func
(paren
id|d_space
comma
id|r6
comma
id|pwd
comma
id|pmc_store_exc
)paren
suffix:semicolon
id|stwma
c_func
(paren
id|d_space
comma
id|r7
comma
id|pwd
comma
id|pmc_store_exc
)paren
suffix:semicolon
id|stwma
c_func
(paren
id|d_space
comma
id|r8
comma
id|pwd
comma
id|pmc_store_exc
)paren
suffix:semicolon
id|len
op_sub_assign
l_int|8
op_star
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|len
op_ge
l_int|4
op_star
r_sizeof
(paren
r_int
r_int
)paren
)paren
(brace
r_register
r_int
r_int
id|r1
comma
id|r2
comma
id|r3
comma
id|r4
suffix:semicolon
id|ldwma
c_func
(paren
id|s_space
comma
id|pws
comma
id|r1
comma
id|pmc_load_exc
)paren
suffix:semicolon
id|ldwma
c_func
(paren
id|s_space
comma
id|pws
comma
id|r2
comma
id|pmc_load_exc
)paren
suffix:semicolon
id|ldwma
c_func
(paren
id|s_space
comma
id|pws
comma
id|r3
comma
id|pmc_load_exc
)paren
suffix:semicolon
id|ldwma
c_func
(paren
id|s_space
comma
id|pws
comma
id|r4
comma
id|pmc_load_exc
)paren
suffix:semicolon
id|stwma
c_func
(paren
id|d_space
comma
id|r1
comma
id|pwd
comma
id|pmc_store_exc
)paren
suffix:semicolon
id|stwma
c_func
(paren
id|d_space
comma
id|r2
comma
id|pwd
comma
id|pmc_store_exc
)paren
suffix:semicolon
id|stwma
c_func
(paren
id|d_space
comma
id|r3
comma
id|pwd
comma
id|pmc_store_exc
)paren
suffix:semicolon
id|stwma
c_func
(paren
id|d_space
comma
id|r4
comma
id|pwd
comma
id|pmc_store_exc
)paren
suffix:semicolon
id|len
op_sub_assign
l_int|4
op_star
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
)brace
id|pcs
op_assign
(paren
r_int
r_char
op_star
)paren
id|pws
suffix:semicolon
id|pcd
op_assign
(paren
r_int
r_char
op_star
)paren
id|pwd
suffix:semicolon
id|byte_copy
suffix:colon
r_while
c_loop
(paren
id|len
)paren
(brace
multiline_comment|/* *pcd++ = *pcs++; */
id|ldbma
c_func
(paren
id|s_space
comma
id|pcs
comma
id|t3
comma
id|pmc_load_exc
)paren
suffix:semicolon
id|stbma
c_func
(paren
id|d_space
comma
id|t3
comma
id|pcd
comma
id|pmc_store_exc
)paren
suffix:semicolon
id|len
op_decrement
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|unaligned_copy
suffix:colon
multiline_comment|/* possibly we are aligned on a word, but not on a double... */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|t1
op_amp
(paren
r_sizeof
(paren
r_int
r_int
)paren
op_minus
l_int|1
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|t2
op_assign
id|src
op_amp
(paren
r_sizeof
(paren
r_int
r_int
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|t2
op_ne
l_int|0
)paren
)paren
(brace
id|t2
op_assign
r_sizeof
(paren
r_int
r_int
)paren
op_minus
id|t2
suffix:semicolon
r_while
c_loop
(paren
id|t2
)paren
(brace
multiline_comment|/* *pcd++ = *pcs++; */
id|ldbma
c_func
(paren
id|s_space
comma
id|pcs
comma
id|t3
comma
id|pmc_load_exc
)paren
suffix:semicolon
id|stbma
c_func
(paren
id|d_space
comma
id|t3
comma
id|pcd
comma
id|pmc_store_exc
)paren
suffix:semicolon
id|len
op_decrement
suffix:semicolon
id|t2
op_decrement
suffix:semicolon
)brace
)brace
id|pws
op_assign
(paren
r_int
r_int
op_star
)paren
id|pcs
suffix:semicolon
id|pwd
op_assign
(paren
r_int
r_int
op_star
)paren
id|pcd
suffix:semicolon
r_goto
id|word_copy
suffix:semicolon
)brace
multiline_comment|/* Align the destination.  */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
(paren
id|dst
op_amp
(paren
r_sizeof
(paren
r_int
r_int
)paren
op_minus
l_int|1
)paren
)paren
op_ne
l_int|0
)paren
)paren
(brace
id|t2
op_assign
r_sizeof
(paren
r_int
r_int
)paren
op_minus
(paren
id|dst
op_amp
(paren
r_sizeof
(paren
r_int
r_int
)paren
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|t2
)paren
(brace
multiline_comment|/* *pcd++ = *pcs++; */
id|ldbma
c_func
(paren
id|s_space
comma
id|pcs
comma
id|t3
comma
id|pmc_load_exc
)paren
suffix:semicolon
id|stbma
c_func
(paren
id|d_space
comma
id|t3
comma
id|pcd
comma
id|pmc_store_exc
)paren
suffix:semicolon
id|len
op_decrement
suffix:semicolon
id|t2
op_decrement
suffix:semicolon
)brace
id|dst
op_assign
(paren
r_int
r_int
)paren
id|pcd
suffix:semicolon
id|src
op_assign
(paren
r_int
r_int
)paren
id|pcs
suffix:semicolon
)brace
id|ret
op_assign
id|copy_dstaligned
c_func
(paren
id|dst
comma
id|src
comma
id|len
op_div
r_sizeof
(paren
r_int
r_int
)paren
comma
id|o_dst
comma
id|o_src
comma
id|o_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
id|pcs
op_add_assign
(paren
id|len
op_amp
op_minus
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
id|pcd
op_add_assign
(paren
id|len
op_amp
op_minus
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
id|len
op_mod_assign
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
id|preserve_branch
c_func
(paren
id|handle_load_error
)paren
suffix:semicolon
id|preserve_branch
c_func
(paren
id|handle_store_error
)paren
suffix:semicolon
r_goto
id|byte_copy
suffix:semicolon
id|handle_load_error
suffix:colon
id|__asm__
id|__volatile__
(paren
l_string|&quot;pmc_load_exc:&bslash;n&quot;
)paren
suffix:semicolon
id|d
op_assign
op_amp
id|__get_cpu_var
c_func
(paren
id|exception_data
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
l_string|&quot;pmc_load_exc: o_len=%lu fault_addr=%lu o_src=%lu ret=%lu&bslash;n&quot;
comma
id|o_len
comma
id|d-&gt;fault_addr
comma
id|o_src
comma
id|o_len
op_minus
id|d-&gt;fault_addr
op_plus
id|o_src
)paren
suffix:semicolon
r_return
id|o_len
op_minus
id|d-&gt;fault_addr
op_plus
id|o_src
suffix:semicolon
id|handle_store_error
suffix:colon
id|__asm__
id|__volatile__
(paren
l_string|&quot;pmc_store_exc:&bslash;n&quot;
)paren
suffix:semicolon
id|d
op_assign
op_amp
id|__get_cpu_var
c_func
(paren
id|exception_data
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
l_string|&quot;pmc_store_exc: o_len=%lu fault_addr=%lu o_dst=%lu ret=%lu&bslash;n&quot;
comma
id|o_len
comma
id|d-&gt;fault_addr
comma
id|o_dst
comma
id|o_len
op_minus
id|d-&gt;fault_addr
op_plus
id|o_dst
)paren
suffix:semicolon
r_return
id|o_len
op_minus
id|d-&gt;fault_addr
op_plus
id|o_dst
suffix:semicolon
)brace
macro_line|#ifdef __KERNEL__
DECL|function|copy_to_user
r_int
r_int
id|copy_to_user
c_func
(paren
r_void
id|__user
op_star
id|dst
comma
r_const
r_void
op_star
id|src
comma
r_int
r_int
id|len
)paren
(brace
id|mtsp
c_func
(paren
id|get_kernel_space
c_func
(paren
)paren
comma
l_int|1
)paren
suffix:semicolon
id|mtsp
c_func
(paren
id|get_user_space
c_func
(paren
)paren
comma
l_int|2
)paren
suffix:semicolon
r_return
id|pa_memcpy
c_func
(paren
(paren
r_void
id|__force
op_star
)paren
id|dst
comma
id|src
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|copy_from_user
r_int
r_int
id|copy_from_user
c_func
(paren
r_void
op_star
id|dst
comma
r_const
r_void
id|__user
op_star
id|src
comma
r_int
r_int
id|len
)paren
(brace
id|mtsp
c_func
(paren
id|get_user_space
c_func
(paren
)paren
comma
l_int|1
)paren
suffix:semicolon
id|mtsp
c_func
(paren
id|get_kernel_space
c_func
(paren
)paren
comma
l_int|2
)paren
suffix:semicolon
r_return
id|pa_memcpy
c_func
(paren
id|dst
comma
(paren
r_void
id|__force
op_star
)paren
id|src
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|copy_in_user
r_int
r_int
id|copy_in_user
c_func
(paren
r_void
id|__user
op_star
id|dst
comma
r_const
r_void
id|__user
op_star
id|src
comma
r_int
r_int
id|len
)paren
(brace
id|mtsp
c_func
(paren
id|get_user_space
c_func
(paren
)paren
comma
l_int|1
)paren
suffix:semicolon
id|mtsp
c_func
(paren
id|get_user_space
c_func
(paren
)paren
comma
l_int|2
)paren
suffix:semicolon
r_return
id|pa_memcpy
c_func
(paren
(paren
r_void
id|__force
op_star
)paren
id|dst
comma
(paren
r_void
id|__force
op_star
)paren
id|src
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|memcpy
r_void
op_star
id|memcpy
c_func
(paren
r_void
op_star
id|dst
comma
r_const
r_void
op_star
id|src
comma
r_int
id|count
)paren
(brace
id|mtsp
c_func
(paren
id|get_kernel_space
c_func
(paren
)paren
comma
l_int|1
)paren
suffix:semicolon
id|mtsp
c_func
(paren
id|get_kernel_space
c_func
(paren
)paren
comma
l_int|2
)paren
suffix:semicolon
id|pa_memcpy
c_func
(paren
id|dst
comma
id|src
comma
id|count
)paren
suffix:semicolon
r_return
id|dst
suffix:semicolon
)brace
DECL|variable|copy_to_user
id|EXPORT_SYMBOL
c_func
(paren
id|copy_to_user
)paren
suffix:semicolon
DECL|variable|copy_from_user
id|EXPORT_SYMBOL
c_func
(paren
id|copy_from_user
)paren
suffix:semicolon
DECL|variable|copy_in_user
id|EXPORT_SYMBOL
c_func
(paren
id|copy_in_user
)paren
suffix:semicolon
DECL|variable|memcpy
id|EXPORT_SYMBOL
c_func
(paren
id|memcpy
)paren
suffix:semicolon
macro_line|#endif
eof
