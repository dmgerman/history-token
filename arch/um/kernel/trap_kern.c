multiline_comment|/* &n; * Copyright (C) 2000, 2001 Jeff Dike (jdike@karaya.com)&n; * Licensed under the GPL&n; */
macro_line|#include &quot;linux/kernel.h&quot;
macro_line|#include &quot;asm/errno.h&quot;
macro_line|#include &quot;linux/sched.h&quot;
macro_line|#include &quot;linux/mm.h&quot;
macro_line|#include &quot;linux/spinlock.h&quot;
macro_line|#include &quot;linux/config.h&quot;
macro_line|#include &quot;linux/init.h&quot;
macro_line|#include &quot;linux/ptrace.h&quot;
macro_line|#include &quot;asm/semaphore.h&quot;
macro_line|#include &quot;asm/pgtable.h&quot;
macro_line|#include &quot;asm/pgalloc.h&quot;
macro_line|#include &quot;asm/tlbflush.h&quot;
macro_line|#include &quot;asm/a.out.h&quot;
macro_line|#include &quot;asm/current.h&quot;
macro_line|#include &quot;asm/irq.h&quot;
macro_line|#include &quot;user_util.h&quot;
macro_line|#include &quot;kern_util.h&quot;
macro_line|#include &quot;kern.h&quot;
macro_line|#include &quot;chan_kern.h&quot;
macro_line|#include &quot;mconsole_kern.h&quot;
macro_line|#include &quot;2_5compat.h&quot;
macro_line|#include &quot;mem.h&quot;
macro_line|#include &quot;mem_kern.h&quot;
DECL|function|handle_page_fault
r_int
id|handle_page_fault
c_func
(paren
r_int
r_int
id|address
comma
r_int
r_int
id|ip
comma
r_int
id|is_write
comma
r_int
id|is_user
comma
r_int
op_star
id|code_out
)paren
(brace
r_struct
id|mm_struct
op_star
id|mm
op_assign
id|current-&gt;mm
suffix:semicolon
r_struct
id|vm_area_struct
op_star
id|vma
suffix:semicolon
id|pgd_t
op_star
id|pgd
suffix:semicolon
id|pud_t
op_star
id|pud
suffix:semicolon
id|pmd_t
op_star
id|pmd
suffix:semicolon
id|pte_t
op_star
id|pte
suffix:semicolon
r_int
r_int
id|page
suffix:semicolon
r_int
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
op_star
id|code_out
op_assign
id|SEGV_MAPERR
suffix:semicolon
id|down_read
c_func
(paren
op_amp
id|mm-&gt;mmap_sem
)paren
suffix:semicolon
id|vma
op_assign
id|find_vma
c_func
(paren
id|mm
comma
id|address
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vma
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vma-&gt;vm_start
op_le
id|address
)paren
(brace
r_goto
id|good_area
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_GROWSDOWN
)paren
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|expand_stack
c_func
(paren
id|vma
comma
id|address
)paren
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|good_area
suffix:colon
op_star
id|code_out
op_assign
id|SEGV_ACCERR
suffix:semicolon
r_if
c_cond
(paren
id|is_write
op_logical_and
op_logical_neg
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_WRITE
)paren
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|page
op_assign
id|address
op_amp
id|PAGE_MASK
suffix:semicolon
id|pgd
op_assign
id|pgd_offset
c_func
(paren
id|mm
)paren
suffix:semicolon
id|pud
op_assign
id|pud_offset
c_func
(paren
id|pgd
comma
id|page
)paren
suffix:semicolon
id|pmd
op_assign
id|pmd_offset
c_func
(paren
id|pud
comma
id|page
)paren
suffix:semicolon
r_do
(brace
id|survive
suffix:colon
r_switch
c_cond
(paren
id|handle_mm_fault
c_func
(paren
id|mm
comma
id|vma
comma
id|address
comma
id|is_write
)paren
)paren
(brace
r_case
id|VM_FAULT_MINOR
suffix:colon
id|current-&gt;min_flt
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VM_FAULT_MAJOR
suffix:colon
id|current-&gt;maj_flt
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VM_FAULT_SIGBUS
suffix:colon
id|err
op_assign
op_minus
id|EACCES
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_case
id|VM_FAULT_OOM
suffix:colon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out_of_memory
suffix:semicolon
r_default
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|pte
op_assign
id|pte_offset_kernel
c_func
(paren
id|pmd
comma
id|page
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|pte_present
c_func
(paren
op_star
id|pte
)paren
)paren
(brace
suffix:semicolon
)brace
id|err
op_assign
l_int|0
suffix:semicolon
op_star
id|pte
op_assign
id|pte_mkyoung
c_func
(paren
op_star
id|pte
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pte_write
c_func
(paren
op_star
id|pte
)paren
)paren
(brace
op_star
id|pte
op_assign
id|pte_mkdirty
c_func
(paren
op_star
id|pte
)paren
suffix:semicolon
)brace
id|flush_tlb_page
c_func
(paren
id|vma
comma
id|page
)paren
suffix:semicolon
id|out
suffix:colon
id|up_read
c_func
(paren
op_amp
id|mm-&gt;mmap_sem
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
multiline_comment|/*&n; * We ran out of memory, or some other thing happened to us that made&n; * us unable to handle the page fault gracefully.&n; */
id|out_of_memory
suffix:colon
r_if
c_cond
(paren
id|current-&gt;pid
op_eq
l_int|1
)paren
(brace
id|up_read
c_func
(paren
op_amp
id|mm-&gt;mmap_sem
)paren
suffix:semicolon
id|yield
c_func
(paren
)paren
suffix:semicolon
id|down_read
c_func
(paren
op_amp
id|mm-&gt;mmap_sem
)paren
suffix:semicolon
r_goto
id|survive
suffix:semicolon
)brace
r_goto
id|out
suffix:semicolon
)brace
DECL|variable|physmem_remappers
id|LIST_HEAD
c_func
(paren
id|physmem_remappers
)paren
suffix:semicolon
DECL|function|register_remapper
r_void
id|register_remapper
c_func
(paren
r_struct
id|remapper
op_star
id|info
)paren
(brace
id|list_add
c_func
(paren
op_amp
id|info-&gt;list
comma
op_amp
id|physmem_remappers
)paren
suffix:semicolon
)brace
DECL|function|check_remapped_addr
r_static
r_int
id|check_remapped_addr
c_func
(paren
r_int
r_int
id|address
comma
r_int
id|is_write
)paren
(brace
r_struct
id|remapper
op_star
id|remapper
suffix:semicolon
r_struct
id|list_head
op_star
id|ele
suffix:semicolon
id|__u64
id|offset
suffix:semicolon
r_int
id|fd
suffix:semicolon
id|fd
op_assign
id|phys_mapping
c_func
(paren
id|__pa
c_func
(paren
id|address
)paren
comma
op_amp
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
op_eq
op_minus
l_int|1
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
(def_block
id|list_for_each
c_func
(paren
id|ele
comma
op_amp
id|physmem_remappers
)paren
(brace
id|remapper
op_assign
id|list_entry
c_func
(paren
id|ele
comma
r_struct
id|remapper
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|remapper-&gt;proc
)paren
(paren
id|fd
comma
id|address
comma
id|is_write
comma
id|offset
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
)def_block
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|segv
r_int
r_int
id|segv
c_func
(paren
r_int
r_int
id|address
comma
r_int
r_int
id|ip
comma
r_int
id|is_write
comma
r_int
id|is_user
comma
r_void
op_star
id|sc
)paren
(brace
r_struct
id|siginfo
id|si
suffix:semicolon
r_void
op_star
id|catcher
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_user
op_logical_and
(paren
id|address
op_ge
id|start_vm
)paren
op_logical_and
(paren
id|address
OL
id|end_vm
)paren
)paren
(brace
id|flush_tlb_kernel_vm
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|check_remapped_addr
c_func
(paren
id|address
op_amp
id|PAGE_MASK
comma
id|is_write
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|current-&gt;mm
op_eq
l_int|NULL
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Segfault with no mm&quot;
)paren
suffix:semicolon
)brace
id|err
op_assign
id|handle_page_fault
c_func
(paren
id|address
comma
id|ip
comma
id|is_write
comma
id|is_user
comma
op_amp
id|si.si_code
)paren
suffix:semicolon
id|catcher
op_assign
id|current-&gt;thread.fault_catcher
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|catcher
op_ne
l_int|NULL
)paren
(brace
id|current-&gt;thread.fault_addr
op_assign
(paren
r_void
op_star
)paren
id|address
suffix:semicolon
id|do_longjmp
c_func
(paren
id|catcher
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|current-&gt;thread.fault_addr
op_ne
l_int|NULL
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;fault_addr set but no fault catcher&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|arch_fixup
c_func
(paren
id|ip
comma
id|sc
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|is_user
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Kernel mode fault at addr 0x%lx, ip 0x%lx&quot;
comma
id|address
comma
id|ip
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
op_eq
op_minus
id|EACCES
)paren
(brace
id|si.si_signo
op_assign
id|SIGBUS
suffix:semicolon
id|si.si_errno
op_assign
l_int|0
suffix:semicolon
id|si.si_code
op_assign
id|BUS_ADRERR
suffix:semicolon
id|si.si_addr
op_assign
(paren
r_void
op_star
)paren
id|address
suffix:semicolon
id|force_sig_info
c_func
(paren
id|SIGBUS
comma
op_amp
id|si
comma
id|current
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|err
op_eq
op_minus
id|ENOMEM
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;VM: killing process %s&bslash;n&quot;
comma
id|current-&gt;comm
)paren
suffix:semicolon
id|do_exit
c_func
(paren
id|SIGKILL
)paren
suffix:semicolon
)brace
r_else
(brace
id|si.si_signo
op_assign
id|SIGSEGV
suffix:semicolon
id|si.si_addr
op_assign
(paren
r_void
op_star
)paren
id|address
suffix:semicolon
id|current-&gt;thread.cr2
op_assign
id|address
suffix:semicolon
id|current-&gt;thread.err
op_assign
id|is_write
suffix:semicolon
id|force_sig_info
c_func
(paren
id|SIGSEGV
comma
op_amp
id|si
comma
id|current
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bad_segv
r_void
id|bad_segv
c_func
(paren
r_int
r_int
id|address
comma
r_int
r_int
id|ip
comma
r_int
id|is_write
)paren
(brace
r_struct
id|siginfo
id|si
suffix:semicolon
id|si.si_signo
op_assign
id|SIGSEGV
suffix:semicolon
id|si.si_code
op_assign
id|SEGV_ACCERR
suffix:semicolon
id|si.si_addr
op_assign
(paren
r_void
op_star
)paren
id|address
suffix:semicolon
id|current-&gt;thread.cr2
op_assign
id|address
suffix:semicolon
id|current-&gt;thread.err
op_assign
id|is_write
suffix:semicolon
id|force_sig_info
c_func
(paren
id|SIGSEGV
comma
op_amp
id|si
comma
id|current
)paren
suffix:semicolon
)brace
DECL|function|relay_signal
r_void
id|relay_signal
c_func
(paren
r_int
id|sig
comma
r_union
id|uml_pt_regs
op_star
id|regs
)paren
(brace
r_if
c_cond
(paren
id|arch_handle_signal
c_func
(paren
id|sig
comma
id|regs
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|UPT_IS_USER
c_func
(paren
id|regs
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Kernel mode signal %d&quot;
comma
id|sig
)paren
suffix:semicolon
)brace
id|force_sig
c_func
(paren
id|sig
comma
id|current
)paren
suffix:semicolon
)brace
DECL|function|bus_handler
r_void
id|bus_handler
c_func
(paren
r_int
id|sig
comma
r_union
id|uml_pt_regs
op_star
id|regs
)paren
(brace
r_if
c_cond
(paren
id|current-&gt;thread.fault_catcher
op_ne
l_int|NULL
)paren
(brace
id|do_longjmp
c_func
(paren
id|current-&gt;thread.fault_catcher
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
id|relay_signal
c_func
(paren
id|sig
comma
id|regs
)paren
suffix:semicolon
)brace
DECL|function|winch
r_void
id|winch
c_func
(paren
r_int
id|sig
comma
r_union
id|uml_pt_regs
op_star
id|regs
)paren
(brace
id|do_IRQ
c_func
(paren
id|WINCH_IRQ
comma
id|regs
)paren
suffix:semicolon
)brace
DECL|function|trap_init
r_void
id|trap_init
c_func
(paren
r_void
)paren
(brace
)brace
DECL|variable|trap_lock
id|spinlock_t
id|trap_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|trap_index
r_static
r_int
id|trap_index
op_assign
l_int|0
suffix:semicolon
DECL|function|next_trap_index
r_int
id|next_trap_index
c_func
(paren
r_int
id|limit
)paren
(brace
r_int
id|ret
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|trap_lock
)paren
suffix:semicolon
id|ret
op_assign
id|trap_index
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|trap_index
op_eq
id|limit
)paren
(brace
id|trap_index
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|trap_lock
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-file-style: &quot;linux&quot;&n; * End:&n; */
eof
