multiline_comment|/* &n; * Copyright (C) 2002 Jeff Dike (jdike@karaya.com)&n; * Licensed under the GPL&n; */
macro_line|#include &lt;stdio.h&gt;
macro_line|#include &lt;stdlib.h&gt;
macro_line|#include &lt;errno.h&gt;
macro_line|#include &lt;string.h&gt;
macro_line|#include &lt;signal.h&gt;
macro_line|#include &lt;sys/ptrace.h&gt;
macro_line|#include &lt;sys/types.h&gt;
macro_line|#include &quot;uml-config.h&quot;
macro_line|#include &quot;kern_constants.h&quot;
macro_line|#include &quot;chan_user.h&quot;
macro_line|#include &quot;init.h&quot;
macro_line|#include &quot;user.h&quot;
macro_line|#include &quot;debug.h&quot;
macro_line|#include &quot;kern_util.h&quot;
macro_line|#include &quot;user_util.h&quot;
macro_line|#include &quot;tt.h&quot;
macro_line|#include &quot;sysdep/thread.h&quot;
r_extern
r_int
id|debugger_pid
suffix:semicolon
r_extern
r_int
id|debugger_fd
suffix:semicolon
r_extern
r_int
id|debugger_parent
suffix:semicolon
DECL|function|detach
r_int
id|detach
c_func
(paren
r_int
id|pid
comma
r_int
id|sig
)paren
(brace
r_return
id|ptrace
c_func
(paren
id|PTRACE_DETACH
comma
id|pid
comma
l_int|0
comma
id|sig
)paren
suffix:semicolon
)brace
DECL|function|attach
r_int
id|attach
c_func
(paren
r_int
id|pid
)paren
(brace
r_int
id|err
suffix:semicolon
id|err
op_assign
id|ptrace
c_func
(paren
id|PTRACE_ATTACH
comma
id|pid
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_return
op_minus
id|errno
suffix:semicolon
)brace
r_else
r_return
id|err
suffix:semicolon
)brace
DECL|function|cont
r_int
id|cont
c_func
(paren
r_int
id|pid
)paren
(brace
r_return
id|ptrace
c_func
(paren
id|PTRACE_CONT
comma
id|pid
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PT_PROXY
DECL|function|debugger_signal
r_int
id|debugger_signal
c_func
(paren
r_int
id|status
comma
id|pid_t
id|pid
)paren
(brace
r_return
id|debugger_proxy
c_func
(paren
id|status
comma
id|pid
)paren
suffix:semicolon
)brace
DECL|function|child_signal
r_void
id|child_signal
c_func
(paren
id|pid_t
id|pid
comma
r_int
id|status
)paren
(brace
id|child_proxy
c_func
(paren
id|pid
comma
id|status
)paren
suffix:semicolon
)brace
DECL|function|gdb_announce
r_static
r_void
id|gdb_announce
c_func
(paren
r_char
op_star
id|dev_name
comma
r_int
id|dev
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;gdb assigned device &squot;%s&squot;&bslash;n&quot;
comma
id|dev_name
)paren
suffix:semicolon
)brace
DECL|variable|opts
r_static
r_struct
id|chan_opts
id|opts
op_assign
(brace
id|announce
suffix:colon
id|gdb_announce
comma
id|xterm_title
suffix:colon
l_string|&quot;UML kernel debugger&quot;
comma
id|raw
suffix:colon
l_int|0
comma
id|tramp_stack
suffix:colon
l_int|0
comma
id|in_kernel
suffix:colon
l_int|0
comma
)brace
suffix:semicolon
multiline_comment|/* Accessed by the tracing thread, which automatically serializes access */
DECL|variable|xterm_data
r_static
r_void
op_star
id|xterm_data
suffix:semicolon
DECL|variable|xterm_fd
r_static
r_int
id|xterm_fd
suffix:semicolon
r_extern
r_void
op_star
id|xterm_init
c_func
(paren
r_char
op_star
comma
r_int
comma
r_struct
id|chan_opts
op_star
)paren
suffix:semicolon
r_extern
r_int
id|xterm_open
c_func
(paren
r_int
comma
r_int
comma
r_int
comma
r_void
op_star
comma
r_char
op_star
op_star
)paren
suffix:semicolon
r_extern
r_void
id|xterm_close
c_func
(paren
r_int
comma
r_void
op_star
)paren
suffix:semicolon
DECL|function|open_gdb_chan
r_int
id|open_gdb_chan
c_func
(paren
r_void
)paren
(brace
r_char
id|stack
(braket
id|UM_KERN_PAGE_SIZE
)braket
comma
op_star
id|dummy
suffix:semicolon
id|opts.tramp_stack
op_assign
(paren
r_int
r_int
)paren
id|stack
suffix:semicolon
id|xterm_data
op_assign
id|xterm_init
c_func
(paren
l_string|&quot;&quot;
comma
l_int|0
comma
op_amp
id|opts
)paren
suffix:semicolon
id|xterm_fd
op_assign
id|xterm_open
c_func
(paren
l_int|1
comma
l_int|1
comma
l_int|1
comma
id|xterm_data
comma
op_amp
id|dummy
)paren
suffix:semicolon
r_return
id|xterm_fd
suffix:semicolon
)brace
DECL|function|exit_debugger_cb
r_static
r_void
id|exit_debugger_cb
c_func
(paren
r_void
op_star
id|unused
)paren
(brace
r_if
c_cond
(paren
id|debugger_pid
op_ne
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|gdb_pid
op_ne
op_minus
l_int|1
)paren
(brace
id|fake_child_exit
c_func
(paren
)paren
suffix:semicolon
id|gdb_pid
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_else
id|kill_child_dead
c_func
(paren
id|debugger_pid
)paren
suffix:semicolon
id|debugger_pid
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|debugger_parent
op_ne
op_minus
l_int|1
)paren
(brace
id|detach
c_func
(paren
id|debugger_parent
comma
id|SIGINT
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|xterm_data
op_ne
l_int|NULL
)paren
(brace
id|xterm_close
c_func
(paren
id|xterm_fd
comma
id|xterm_data
)paren
suffix:semicolon
)brace
)brace
DECL|function|exit_debugger
r_static
r_void
id|exit_debugger
c_func
(paren
r_void
)paren
(brace
id|initial_thread_cb
c_func
(paren
id|exit_debugger_cb
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|exit_debugger
id|__uml_exitcall
c_func
(paren
id|exit_debugger
)paren
suffix:semicolon
DECL|struct|gdb_data
r_struct
id|gdb_data
(brace
DECL|member|str
r_char
op_star
id|str
suffix:semicolon
DECL|member|err
r_int
id|err
suffix:semicolon
)brace
suffix:semicolon
DECL|function|config_gdb_cb
r_static
r_void
id|config_gdb_cb
c_func
(paren
r_void
op_star
id|arg
)paren
(brace
r_struct
id|gdb_data
op_star
id|data
op_assign
id|arg
suffix:semicolon
r_void
op_star
id|task
suffix:semicolon
r_int
id|pid
suffix:semicolon
id|data-&gt;err
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|debugger_pid
op_ne
op_minus
l_int|1
)paren
(brace
id|exit_debugger_cb
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|data-&gt;str
comma
l_string|&quot;pid,&quot;
comma
id|strlen
c_func
(paren
l_string|&quot;pid,&quot;
)paren
)paren
)paren
(brace
id|data-&gt;str
op_add_assign
id|strlen
c_func
(paren
l_string|&quot;pid,&quot;
)paren
suffix:semicolon
id|pid
op_assign
id|strtoul
c_func
(paren
id|data-&gt;str
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|task
op_assign
id|cpu_tasks
(braket
l_int|0
)braket
dot
id|task
suffix:semicolon
id|debugger_pid
op_assign
id|attach_debugger
c_func
(paren
id|TASK_EXTERN_PID
c_func
(paren
id|task
)paren
comma
id|pid
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debugger_pid
op_ne
op_minus
l_int|1
)paren
(brace
id|data-&gt;err
op_assign
l_int|0
suffix:semicolon
id|gdb_pid
op_assign
id|pid
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
id|data-&gt;err
op_assign
l_int|0
suffix:semicolon
id|debugger_pid
op_assign
id|start_debugger
c_func
(paren
id|linux_prog
comma
l_int|0
comma
l_int|0
comma
op_amp
id|debugger_fd
)paren
suffix:semicolon
id|init_proxy
c_func
(paren
id|debugger_pid
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|gdb_config
r_int
id|gdb_config
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_struct
id|gdb_data
id|data
suffix:semicolon
r_if
c_cond
(paren
op_star
id|str
op_increment
op_ne
l_char|&squot;=&squot;
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|data.str
op_assign
id|str
suffix:semicolon
id|initial_thread_cb
c_func
(paren
id|config_gdb_cb
comma
op_amp
id|data
)paren
suffix:semicolon
r_return
id|data.err
suffix:semicolon
)brace
DECL|function|remove_gdb_cb
r_void
id|remove_gdb_cb
c_func
(paren
r_void
op_star
id|unused
)paren
(brace
id|exit_debugger_cb
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|gdb_remove
r_int
id|gdb_remove
c_func
(paren
r_char
op_star
id|unused
)paren
(brace
id|initial_thread_cb
c_func
(paren
id|remove_gdb_cb
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|signal_usr1
r_void
id|signal_usr1
c_func
(paren
r_int
id|sig
)paren
(brace
r_if
c_cond
(paren
id|debugger_pid
op_ne
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|UM_KERN_ERR
l_string|&quot;The debugger is already running&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|debugger_pid
op_assign
id|start_debugger
c_func
(paren
id|linux_prog
comma
l_int|0
comma
l_int|0
comma
op_amp
id|debugger_fd
)paren
suffix:semicolon
id|init_proxy
c_func
(paren
id|debugger_pid
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|init_ptrace_proxy
r_int
id|init_ptrace_proxy
c_func
(paren
r_int
id|idle_pid
comma
r_int
id|startup
comma
r_int
id|stop
)paren
(brace
r_int
id|pid
comma
id|status
suffix:semicolon
id|pid
op_assign
id|start_debugger
c_func
(paren
id|linux_prog
comma
id|startup
comma
id|stop
comma
op_amp
id|debugger_fd
)paren
suffix:semicolon
id|status
op_assign
id|wait_for_stop
c_func
(paren
id|idle_pid
comma
id|SIGSTOP
comma
id|PTRACE_CONT
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pid
OL
l_int|0
)paren
(brace
id|cont
c_func
(paren
id|idle_pid
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|init_proxy
c_func
(paren
id|pid
comma
l_int|1
comma
id|status
)paren
suffix:semicolon
r_return
id|pid
suffix:semicolon
)brace
DECL|function|attach_debugger
r_int
id|attach_debugger
c_func
(paren
r_int
id|idle_pid
comma
r_int
id|pid
comma
r_int
id|stop
)paren
(brace
r_int
id|status
op_assign
l_int|0
comma
id|err
suffix:semicolon
id|err
op_assign
id|attach
c_func
(paren
id|pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;Failed to attach pid %d, errno = %d&bslash;n&quot;
comma
id|pid
comma
op_minus
id|err
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stop
)paren
(brace
id|status
op_assign
id|wait_for_stop
c_func
(paren
id|idle_pid
comma
id|SIGSTOP
comma
id|PTRACE_CONT
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|init_proxy
c_func
(paren
id|pid
comma
l_int|1
comma
id|status
)paren
suffix:semicolon
r_return
id|pid
suffix:semicolon
)brace
macro_line|#ifdef notdef /* Put this back in when it does something useful */
DECL|function|uml_gdb_init_setup
r_static
r_int
id|__init
id|uml_gdb_init_setup
c_func
(paren
r_char
op_star
id|line
comma
r_int
op_star
id|add
)paren
(brace
id|gdb_init
op_assign
id|uml_strdup
c_func
(paren
id|line
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|__uml_setup
c_func
(paren
l_string|&quot;gdb=&quot;
comma
id|uml_gdb_init_setup
comma
l_string|&quot;gdb=&lt;channel description&gt;&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
DECL|function|uml_gdb_pid_setup
r_static
r_int
id|__init
id|uml_gdb_pid_setup
c_func
(paren
r_char
op_star
id|line
comma
r_int
op_star
id|add
)paren
(brace
id|gdb_pid
op_assign
id|strtoul
c_func
(paren
id|line
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
op_star
id|add
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|__uml_setup
c_func
(paren
l_string|&quot;gdb-pid=&quot;
comma
id|uml_gdb_pid_setup
comma
l_string|&quot;gdb-pid=&lt;pid&gt;&bslash;n&quot;
l_string|&quot;    gdb-pid is used to attach an external debugger to UML.  This may be&bslash;n&quot;
l_string|&quot;    an already-running gdb or a debugger-like process like strace.&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#else
DECL|function|debugger_signal
r_int
(def_block
id|debugger_signal
c_func
(paren
r_int
id|status
comma
id|pid_t
id|pid
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
)def_block
DECL|function|child_signal
r_void
(def_block
id|child_signal
c_func
(paren
id|pid_t
id|pid
comma
r_int
id|status
)paren
(brace
)brace
)def_block
DECL|function|init_ptrace_proxy
r_int
id|init_ptrace_proxy
c_func
(paren
r_int
id|idle_pid
comma
r_int
id|startup
comma
r_int
id|stop
)paren
(brace
id|printk
c_func
(paren
id|UM_KERN_ERR
l_string|&quot;debug requested when CONFIG_PT_PROXY is off&bslash;n&quot;
)paren
suffix:semicolon
id|kill_child_dead
c_func
(paren
id|idle_pid
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|signal_usr1
r_void
id|signal_usr1
c_func
(paren
r_int
id|sig
)paren
(brace
id|printk
c_func
(paren
id|UM_KERN_ERR
l_string|&quot;debug requested when CONFIG_PT_PROXY is off&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|attach_debugger
r_int
id|attach_debugger
c_func
(paren
r_int
id|idle_pid
comma
r_int
id|pid
comma
r_int
id|stop
)paren
(brace
id|printk
c_func
(paren
id|UM_KERN_ERR
l_string|&quot;attach_debugger called when CONFIG_PT_PROXY &quot;
l_string|&quot;is off&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|config_gdb
r_int
id|config_gdb
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|remove_gdb
r_int
id|remove_gdb
c_func
(paren
r_void
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|init_parent_proxy
r_int
id|init_parent_proxy
c_func
(paren
r_int
id|pid
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|debugger_parent_signal
r_void
id|debugger_parent_signal
c_func
(paren
r_int
id|status
comma
r_int
id|pid
)paren
(brace
)brace
macro_line|#endif
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-file-style: &quot;linux&quot;&n; * End:&n; */
eof
