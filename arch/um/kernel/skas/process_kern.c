multiline_comment|/* &n; * Copyright (C) 2002 Jeff Dike (jdike@karaya.com)&n; * Licensed under the GPL&n; */
macro_line|#include &quot;linux/sched.h&quot;
macro_line|#include &quot;linux/slab.h&quot;
macro_line|#include &quot;linux/ptrace.h&quot;
macro_line|#include &quot;linux/proc_fs.h&quot;
macro_line|#include &quot;linux/file.h&quot;
macro_line|#include &quot;linux/errno.h&quot;
macro_line|#include &quot;linux/init.h&quot;
macro_line|#include &quot;asm/uaccess.h&quot;
macro_line|#include &quot;asm/atomic.h&quot;
macro_line|#include &quot;kern_util.h&quot;
macro_line|#include &quot;time_user.h&quot;
macro_line|#include &quot;signal_user.h&quot;
macro_line|#include &quot;skas.h&quot;
macro_line|#include &quot;os.h&quot;
macro_line|#include &quot;user_util.h&quot;
macro_line|#include &quot;tlb.h&quot;
macro_line|#include &quot;frame.h&quot;
macro_line|#include &quot;kern.h&quot;
macro_line|#include &quot;mode.h&quot;
macro_line|#include &quot;proc_mm.h&quot;
DECL|variable|using_sysemu
r_static
id|atomic_t
id|using_sysemu
op_assign
id|ATOMIC_INIT
c_func
(paren
l_int|0
)paren
suffix:semicolon
DECL|variable|sysemu_supported
r_int
id|sysemu_supported
suffix:semicolon
DECL|function|set_using_sysemu
r_void
id|set_using_sysemu
c_func
(paren
r_int
id|value
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|using_sysemu
comma
id|sysemu_supported
op_logical_and
id|value
)paren
suffix:semicolon
)brace
DECL|function|get_using_sysemu
r_int
id|get_using_sysemu
c_func
(paren
r_void
)paren
(brace
r_return
id|atomic_read
c_func
(paren
op_amp
id|using_sysemu
)paren
suffix:semicolon
)brace
DECL|function|proc_read_sysemu
r_int
id|proc_read_sysemu
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|size
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_if
c_cond
(paren
id|snprintf
c_func
(paren
id|buf
comma
id|size
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|get_using_sysemu
c_func
(paren
)paren
)paren
OL
id|size
)paren
multiline_comment|/*No overflow*/
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_return
id|strlen
c_func
(paren
id|buf
)paren
suffix:semicolon
)brace
DECL|function|proc_write_sysemu
r_int
id|proc_write_sysemu
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_char
id|tmp
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|tmp
comma
id|buf
comma
l_int|1
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|tmp
(braket
l_int|0
)braket
op_eq
l_char|&squot;0&squot;
op_logical_or
id|tmp
(braket
l_int|0
)braket
op_eq
l_char|&squot;1&squot;
)paren
id|set_using_sysemu
c_func
(paren
id|tmp
(braket
l_int|0
)braket
op_minus
l_char|&squot;0&squot;
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
multiline_comment|/*We use the first char, but pretend to write everything*/
)brace
DECL|function|make_proc_sysemu
r_int
id|__init
id|make_proc_sysemu
c_func
(paren
r_void
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|ent
suffix:semicolon
r_if
c_cond
(paren
id|mode_tt
op_logical_or
op_logical_neg
id|sysemu_supported
)paren
r_return
l_int|0
suffix:semicolon
id|ent
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;sysemu&quot;
comma
l_int|0600
comma
op_amp
id|proc_root
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ent
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to register /proc/sysemu&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|ent-&gt;read_proc
op_assign
id|proc_read_sysemu
suffix:semicolon
id|ent-&gt;write_proc
op_assign
id|proc_write_sysemu
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|make_proc_sysemu
id|late_initcall
c_func
(paren
id|make_proc_sysemu
)paren
suffix:semicolon
DECL|function|singlestepping_skas
r_int
id|singlestepping_skas
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
op_assign
id|current-&gt;ptrace
op_amp
id|PT_DTRACE
suffix:semicolon
id|current-&gt;ptrace
op_and_assign
op_complement
id|PT_DTRACE
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|switch_to_skas
r_void
op_star
id|switch_to_skas
c_func
(paren
r_void
op_star
id|prev
comma
r_void
op_star
id|next
)paren
(brace
r_struct
id|task_struct
op_star
id|from
comma
op_star
id|to
suffix:semicolon
id|from
op_assign
id|prev
suffix:semicolon
id|to
op_assign
id|next
suffix:semicolon
multiline_comment|/* XXX need to check runqueues[cpu].idle */
r_if
c_cond
(paren
id|current-&gt;pid
op_eq
l_int|0
)paren
(brace
id|switch_timers
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|to-&gt;thread.prev_sched
op_assign
id|from
suffix:semicolon
id|set_current
c_func
(paren
id|to
)paren
suffix:semicolon
id|switch_threads
c_func
(paren
op_amp
id|from-&gt;thread.mode.skas.switch_buf
comma
id|to-&gt;thread.mode.skas.switch_buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;pid
op_eq
l_int|0
)paren
(brace
id|switch_timers
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
id|current-&gt;thread.prev_sched
suffix:semicolon
)brace
r_extern
r_void
id|schedule_tail
c_func
(paren
r_struct
id|task_struct
op_star
id|prev
)paren
suffix:semicolon
DECL|function|new_thread_handler
r_void
id|new_thread_handler
c_func
(paren
r_int
id|sig
)paren
(brace
r_int
(paren
op_star
id|fn
)paren
(paren
r_void
op_star
)paren
comma
id|n
suffix:semicolon
r_void
op_star
id|arg
suffix:semicolon
id|fn
op_assign
id|current-&gt;thread.request.u.thread.proc
suffix:semicolon
id|arg
op_assign
id|current-&gt;thread.request.u.thread.arg
suffix:semicolon
id|change_sig
c_func
(paren
id|SIGUSR1
comma
l_int|1
)paren
suffix:semicolon
id|thread_wait
c_func
(paren
op_amp
id|current-&gt;thread.mode.skas.switch_buf
comma
id|current-&gt;thread.mode.skas.fork_buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;thread.prev_sched
op_ne
l_int|NULL
)paren
(brace
id|schedule_tail
c_func
(paren
id|current-&gt;thread.prev_sched
)paren
suffix:semicolon
)brace
id|current-&gt;thread.prev_sched
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* The return value is 1 if the kernel thread execs a process,&n;&t; * 0 if it just exits&n;&t; */
id|n
op_assign
id|run_kernel_thread
c_func
(paren
id|fn
comma
id|arg
comma
op_amp
id|current-&gt;thread.exec_buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_eq
l_int|1
)paren
(brace
id|userspace
c_func
(paren
op_amp
id|current-&gt;thread.regs.regs
)paren
suffix:semicolon
)brace
r_else
id|do_exit
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|new_thread_proc
r_void
id|new_thread_proc
c_func
(paren
r_void
op_star
id|stack
comma
r_void
(paren
op_star
id|handler
)paren
(paren
r_int
id|sig
)paren
)paren
(brace
id|init_new_thread_stack
c_func
(paren
id|stack
comma
id|handler
)paren
suffix:semicolon
id|os_usr1_process
c_func
(paren
id|os_getpid
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|release_thread_skas
r_void
id|release_thread_skas
c_func
(paren
r_struct
id|task_struct
op_star
id|task
)paren
(brace
)brace
DECL|function|exit_thread_skas
r_void
id|exit_thread_skas
c_func
(paren
r_void
)paren
(brace
)brace
DECL|function|fork_handler
r_void
id|fork_handler
c_func
(paren
r_int
id|sig
)paren
(brace
id|change_sig
c_func
(paren
id|SIGUSR1
comma
l_int|1
)paren
suffix:semicolon
id|thread_wait
c_func
(paren
op_amp
id|current-&gt;thread.mode.skas.switch_buf
comma
id|current-&gt;thread.mode.skas.fork_buf
)paren
suffix:semicolon
id|force_flush_all
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;thread.prev_sched
op_eq
l_int|NULL
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;blech&quot;
)paren
suffix:semicolon
)brace
id|schedule_tail
c_func
(paren
id|current-&gt;thread.prev_sched
)paren
suffix:semicolon
id|current-&gt;thread.prev_sched
op_assign
l_int|NULL
suffix:semicolon
id|userspace
c_func
(paren
op_amp
id|current-&gt;thread.regs.regs
)paren
suffix:semicolon
)brace
DECL|function|copy_thread_skas
r_int
id|copy_thread_skas
c_func
(paren
r_int
id|nr
comma
r_int
r_int
id|clone_flags
comma
r_int
r_int
id|sp
comma
r_int
r_int
id|stack_top
comma
r_struct
id|task_struct
op_star
id|p
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_void
(paren
op_star
id|handler
)paren
(paren
r_int
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;thread.forking
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|p-&gt;thread.regs.regs.skas
comma
op_amp
id|current-&gt;thread.regs.regs.skas
comma
r_sizeof
(paren
id|p-&gt;thread.regs.regs.skas
)paren
)paren
suffix:semicolon
id|REGS_SET_SYSCALL_RETURN
c_func
(paren
id|p-&gt;thread.regs.regs.skas.regs
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp
op_ne
l_int|0
)paren
(brace
id|REGS_SP
c_func
(paren
id|p-&gt;thread.regs.regs.skas.regs
)paren
op_assign
id|sp
suffix:semicolon
)brace
id|handler
op_assign
id|fork_handler
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|p-&gt;thread.regs.regs.skas.regs
comma
id|exec_regs
comma
r_sizeof
(paren
id|p-&gt;thread.regs.regs.skas.regs
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|p-&gt;thread.regs.regs.skas.fp
comma
id|exec_fp_regs
comma
r_sizeof
(paren
id|p-&gt;thread.regs.regs.skas.fp
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|p-&gt;thread.regs.regs.skas.xfp
comma
id|exec_fpx_regs
comma
r_sizeof
(paren
id|p-&gt;thread.regs.regs.skas.xfp
)paren
)paren
suffix:semicolon
id|p-&gt;thread.request.u.thread
op_assign
id|current-&gt;thread.request.u.thread
suffix:semicolon
id|handler
op_assign
id|new_thread_handler
suffix:semicolon
)brace
id|new_thread
c_func
(paren
id|p-&gt;thread_info
comma
op_amp
id|p-&gt;thread.mode.skas.switch_buf
comma
op_amp
id|p-&gt;thread.mode.skas.fork_buf
comma
id|handler
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|new_mm
r_int
id|new_mm
c_func
(paren
r_int
id|from
)paren
(brace
r_struct
id|proc_mm_op
id|copy
suffix:semicolon
r_int
id|n
comma
id|fd
suffix:semicolon
id|fd
op_assign
id|os_open_file
c_func
(paren
l_string|&quot;/proc/mm&quot;
comma
id|of_cloexec
c_func
(paren
id|of_write
c_func
(paren
id|OPENFLAGS
c_func
(paren
)paren
)paren
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
OL
l_int|0
)paren
(brace
r_return
id|fd
suffix:semicolon
)brace
r_if
c_cond
(paren
id|from
op_ne
op_minus
l_int|1
)paren
(brace
id|copy
op_assign
(paren
(paren
r_struct
id|proc_mm_op
)paren
(brace
dot
id|op
op_assign
id|MM_COPY_SEGMENTS
comma
dot
id|u
op_assign
(brace
dot
id|copy_segments
op_assign
id|from
)brace
)brace
)paren
suffix:semicolon
id|n
op_assign
id|os_write_file
c_func
(paren
id|fd
comma
op_amp
id|copy
comma
r_sizeof
(paren
id|copy
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
r_sizeof
(paren
id|copy
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;new_mm : /proc/mm copy_segments failed, &quot;
l_string|&quot;err = %d&bslash;n&quot;
comma
op_minus
id|n
)paren
suffix:semicolon
)brace
)brace
r_return
id|fd
suffix:semicolon
)brace
DECL|function|init_idle_skas
r_void
id|init_idle_skas
c_func
(paren
r_void
)paren
(brace
id|cpu_tasks
(braket
id|current_thread-&gt;cpu
)braket
dot
id|pid
op_assign
id|os_getpid
c_func
(paren
)paren
suffix:semicolon
id|default_idle
c_func
(paren
)paren
suffix:semicolon
)brace
r_extern
r_void
id|start_kernel
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|function|start_kernel_proc
r_static
r_int
id|start_kernel_proc
c_func
(paren
r_void
op_star
id|unused
)paren
(brace
r_int
id|pid
suffix:semicolon
id|block_signals
c_func
(paren
)paren
suffix:semicolon
id|pid
op_assign
id|os_getpid
c_func
(paren
)paren
suffix:semicolon
id|cpu_tasks
(braket
l_int|0
)braket
dot
id|pid
op_assign
id|pid
suffix:semicolon
id|cpu_tasks
(braket
l_int|0
)braket
dot
id|task
op_assign
id|current
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
id|cpu_online_map
op_assign
id|cpumask_of_cpu
c_func
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|start_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|start_uml_skas
r_int
id|start_uml_skas
c_func
(paren
r_void
)paren
(brace
id|start_userspace
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|capture_signal_stack
c_func
(paren
)paren
suffix:semicolon
id|init_new_thread_signals
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|uml_idle_timer
c_func
(paren
)paren
suffix:semicolon
id|init_task.thread.request.u.thread.proc
op_assign
id|start_kernel_proc
suffix:semicolon
id|init_task.thread.request.u.thread.arg
op_assign
l_int|NULL
suffix:semicolon
r_return
id|start_idle_thread
c_func
(paren
id|init_task.thread_info
comma
op_amp
id|init_task.thread.mode.skas.switch_buf
comma
op_amp
id|init_task.thread.mode.skas.fork_buf
)paren
suffix:semicolon
)brace
DECL|function|external_pid_skas
r_int
id|external_pid_skas
c_func
(paren
r_struct
id|task_struct
op_star
id|task
)paren
(brace
macro_line|#warning Need to look up userspace_pid by cpu
r_return
id|userspace_pid
(braket
l_int|0
)braket
suffix:semicolon
)brace
DECL|function|thread_pid_skas
r_int
id|thread_pid_skas
c_func
(paren
r_struct
id|task_struct
op_star
id|task
)paren
(brace
macro_line|#warning Need to look up userspace_pid by cpu
r_return
id|userspace_pid
(braket
l_int|0
)braket
suffix:semicolon
)brace
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-file-style: &quot;linux&quot;&n; * End:&n; */
eof
