multiline_comment|/* &n; * Copyright (C) 2000 - 2003 Jeff Dike (jdike@addtoit.com)&n; * Licensed under the GPL&n; */
macro_line|#include &quot;linux/config.h&quot;
macro_line|#include &quot;linux/percpu.h&quot;
macro_line|#include &quot;asm/pgalloc.h&quot;
macro_line|#include &quot;asm/tlb.h&quot;
multiline_comment|/* For some reason, mmu_gathers are referenced when CONFIG_SMP is off. */
id|DEFINE_PER_CPU
c_func
(paren
r_struct
id|mmu_gather
comma
id|mmu_gathers
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
macro_line|#include &quot;linux/sched.h&quot;
macro_line|#include &quot;linux/module.h&quot;
macro_line|#include &quot;linux/threads.h&quot;
macro_line|#include &quot;linux/interrupt.h&quot;
macro_line|#include &quot;linux/err.h&quot;
macro_line|#include &quot;linux/hardirq.h&quot;
macro_line|#include &quot;asm/smp.h&quot;
macro_line|#include &quot;asm/processor.h&quot;
macro_line|#include &quot;asm/spinlock.h&quot;
macro_line|#include &quot;user_util.h&quot;
macro_line|#include &quot;kern_util.h&quot;
macro_line|#include &quot;kern.h&quot;
macro_line|#include &quot;irq_user.h&quot;
macro_line|#include &quot;os.h&quot;
multiline_comment|/* CPU online map, set by smp_boot_cpus */
DECL|variable|cpu_online_map
id|cpumask_t
id|cpu_online_map
op_assign
id|CPU_MASK_NONE
suffix:semicolon
DECL|variable|cpu_possible_map
id|cpumask_t
id|cpu_possible_map
op_assign
id|CPU_MASK_NONE
suffix:semicolon
DECL|variable|cpu_online_map
id|EXPORT_SYMBOL
c_func
(paren
id|cpu_online_map
)paren
suffix:semicolon
DECL|variable|cpu_possible_map
id|EXPORT_SYMBOL
c_func
(paren
id|cpu_possible_map
)paren
suffix:semicolon
multiline_comment|/* Per CPU bogomips and other parameters&n; * The only piece used here is the ipi pipe, which is set before SMP is&n; * started and never changed.&n; */
DECL|variable|cpu_data
r_struct
id|cpuinfo_um
id|cpu_data
(braket
id|NR_CPUS
)braket
suffix:semicolon
multiline_comment|/* Set when the idlers are all forked */
DECL|variable|smp_threads_ready
r_int
id|smp_threads_ready
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* A statistic, can be a little off */
DECL|variable|num_reschedules_sent
r_int
id|num_reschedules_sent
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Small, random number, never changed */
DECL|variable|cache_decay_ticks
r_int
r_int
id|cache_decay_ticks
op_assign
l_int|5
suffix:semicolon
multiline_comment|/* Not changed after boot */
DECL|variable|idle_threads
r_struct
id|task_struct
op_star
id|idle_threads
(braket
id|NR_CPUS
)braket
suffix:semicolon
DECL|function|smp_send_reschedule
r_void
id|smp_send_reschedule
c_func
(paren
r_int
id|cpu
)paren
(brace
id|os_write_file
c_func
(paren
id|cpu_data
(braket
id|cpu
)braket
dot
id|ipi_pipe
(braket
l_int|1
)braket
comma
l_string|&quot;R&quot;
comma
l_int|1
)paren
suffix:semicolon
id|num_reschedules_sent
op_increment
suffix:semicolon
)brace
DECL|function|smp_send_stop
r_void
id|smp_send_stop
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Stopping all CPUs...&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_online_cpus
c_func
(paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
id|current_thread-&gt;cpu
)paren
(brace
r_continue
suffix:semicolon
)brace
id|os_write_file
c_func
(paren
id|cpu_data
(braket
id|i
)braket
dot
id|ipi_pipe
(braket
l_int|1
)braket
comma
l_string|&quot;S&quot;
comma
l_int|1
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;done&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|variable|smp_commenced_mask
r_static
id|cpumask_t
id|smp_commenced_mask
op_assign
id|CPU_MASK_NONE
suffix:semicolon
DECL|variable|cpu_callin_map
r_static
id|cpumask_t
id|cpu_callin_map
op_assign
id|CPU_MASK_NONE
suffix:semicolon
DECL|function|idle_proc
r_static
r_int
id|idle_proc
c_func
(paren
r_void
op_star
id|cpup
)paren
(brace
r_int
id|cpu
op_assign
(paren
r_int
)paren
id|cpup
comma
id|err
suffix:semicolon
id|err
op_assign
id|os_pipe
c_func
(paren
id|cpu_data
(braket
id|cpu
)braket
dot
id|ipi_pipe
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;CPU#%d failed to create IPI pipe, err = %d&quot;
comma
id|cpu
comma
op_minus
id|err
)paren
suffix:semicolon
)brace
id|activate_ipi
c_func
(paren
id|cpu_data
(braket
id|cpu
)braket
dot
id|ipi_pipe
(braket
l_int|0
)braket
comma
id|current-&gt;thread.mode.tt.extern_pid
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpu_test_and_set
c_func
(paren
id|cpu
comma
id|cpu_callin_map
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;huh, CPU#%d already present??&bslash;n&quot;
comma
id|cpu
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|cpu_isset
c_func
(paren
id|cpu
comma
id|smp_commenced_mask
)paren
)paren
id|cpu_relax
c_func
(paren
)paren
suffix:semicolon
id|cpu_set
c_func
(paren
id|cpu
comma
id|cpu_online_map
)paren
suffix:semicolon
id|default_idle
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|idle_thread
r_static
r_struct
id|task_struct
op_star
id|idle_thread
c_func
(paren
r_int
id|cpu
)paren
(brace
r_struct
id|task_struct
op_star
id|new_task
suffix:semicolon
r_int
r_char
id|c
suffix:semicolon
id|current-&gt;thread.request.u.thread.proc
op_assign
id|idle_proc
suffix:semicolon
id|current-&gt;thread.request.u.thread.arg
op_assign
(paren
r_void
op_star
)paren
id|cpu
suffix:semicolon
id|new_task
op_assign
id|fork_idle
c_func
(paren
id|cpu
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|new_task
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;copy_process failed in idle_thread, error = %ld&quot;
comma
id|PTR_ERR
c_func
(paren
id|new_task
)paren
)paren
suffix:semicolon
)brace
id|cpu_tasks
(braket
id|cpu
)braket
op_assign
(paren
(paren
r_struct
id|cpu_task
)paren
(brace
dot
id|pid
op_assign
id|new_task-&gt;thread.mode.tt.extern_pid
comma
dot
id|task
op_assign
id|new_task
)brace
)paren
suffix:semicolon
id|idle_threads
(braket
id|cpu
)braket
op_assign
id|new_task
suffix:semicolon
id|CHOOSE_MODE
c_func
(paren
id|os_write_file
c_func
(paren
id|new_task-&gt;thread.mode.tt.switch_pipe
(braket
l_int|1
)braket
comma
op_amp
id|c
comma
r_sizeof
(paren
id|c
)paren
)paren
comma
(paren
(brace
id|panic
c_func
(paren
l_string|&quot;skas mode doesn&squot;t support SMP&quot;
)paren
suffix:semicolon
)brace
)paren
)paren
suffix:semicolon
r_return
id|new_task
suffix:semicolon
)brace
DECL|function|smp_prepare_cpus
r_void
id|smp_prepare_cpus
c_func
(paren
r_int
r_int
id|maxcpus
)paren
(brace
r_struct
id|task_struct
op_star
id|idle
suffix:semicolon
r_int
r_int
id|waittime
suffix:semicolon
r_int
id|err
comma
id|cpu
comma
id|me
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ncpus
suffix:semicolon
op_increment
id|i
)paren
id|cpu_set
c_func
(paren
id|i
comma
id|cpu_possible_map
)paren
suffix:semicolon
id|cpu_clear
c_func
(paren
id|me
comma
id|cpu_online_map
)paren
suffix:semicolon
id|cpu_set
c_func
(paren
id|me
comma
id|cpu_online_map
)paren
suffix:semicolon
id|cpu_set
c_func
(paren
id|me
comma
id|cpu_callin_map
)paren
suffix:semicolon
id|err
op_assign
id|os_pipe
c_func
(paren
id|cpu_data
(braket
id|me
)braket
dot
id|ipi_pipe
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;CPU#0 failed to create IPI pipe, errno = %d&quot;
comma
op_minus
id|err
)paren
suffix:semicolon
)brace
id|activate_ipi
c_func
(paren
id|cpu_data
(braket
id|me
)braket
dot
id|ipi_pipe
(braket
l_int|0
)braket
comma
id|current-&gt;thread.mode.tt.extern_pid
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cpu
op_assign
l_int|1
suffix:semicolon
id|cpu
OL
id|ncpus
suffix:semicolon
id|cpu
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Booting processor %d...&bslash;n&quot;
comma
id|cpu
)paren
suffix:semicolon
id|idle
op_assign
id|idle_thread
c_func
(paren
id|cpu
)paren
suffix:semicolon
id|init_idle
c_func
(paren
id|idle
comma
id|cpu
)paren
suffix:semicolon
id|unhash_process
c_func
(paren
id|idle
)paren
suffix:semicolon
id|waittime
op_assign
l_int|200000000
suffix:semicolon
r_while
c_loop
(paren
id|waittime
op_decrement
op_logical_and
op_logical_neg
id|cpu_isset
c_func
(paren
id|cpu
comma
id|cpu_callin_map
)paren
)paren
id|cpu_relax
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpu_isset
c_func
(paren
id|cpu
comma
id|cpu_callin_map
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;done&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;failed&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|smp_prepare_boot_cpu
r_void
id|smp_prepare_boot_cpu
c_func
(paren
r_void
)paren
(brace
id|cpu_set
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
id|cpu_online_map
)paren
suffix:semicolon
)brace
DECL|function|__cpu_up
r_int
id|__cpu_up
c_func
(paren
r_int
r_int
id|cpu
)paren
(brace
id|cpu_set
c_func
(paren
id|cpu
comma
id|smp_commenced_mask
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|cpu_isset
c_func
(paren
id|cpu
comma
id|cpu_online_map
)paren
)paren
id|mb
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|setup_profiling_timer
r_int
id|setup_profiling_timer
c_func
(paren
r_int
r_int
id|multiplier
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;setup_profiling_timer&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
id|smp_call_function_slave
c_func
(paren
r_int
id|cpu
)paren
suffix:semicolon
DECL|function|IPI_handler
r_void
id|IPI_handler
c_func
(paren
r_int
id|cpu
)paren
(brace
r_int
r_char
id|c
suffix:semicolon
r_int
id|fd
suffix:semicolon
id|fd
op_assign
id|cpu_data
(braket
id|cpu
)braket
dot
id|ipi_pipe
(braket
l_int|0
)braket
suffix:semicolon
r_while
c_loop
(paren
id|os_read_file
c_func
(paren
id|fd
comma
op_amp
id|c
comma
l_int|1
)paren
op_eq
l_int|1
)paren
(brace
r_switch
c_cond
(paren
id|c
)paren
(brace
r_case
l_char|&squot;C&squot;
suffix:colon
id|smp_call_function_slave
c_func
(paren
id|cpu
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;R&squot;
suffix:colon
id|set_tsk_need_resched
c_func
(paren
id|current
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;S&squot;
suffix:colon
id|printk
c_func
(paren
l_string|&quot;CPU#%d stopping&bslash;n&quot;
comma
id|cpu
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|pause
c_func
(paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;CPU#%d received unknown IPI [%c]!&bslash;n&quot;
comma
id|cpu
comma
id|c
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
DECL|function|hard_smp_processor_id
r_int
id|hard_smp_processor_id
c_func
(paren
r_void
)paren
(brace
r_return
id|pid_to_processor_id
c_func
(paren
id|os_getpid
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
r_static
id|DEFINE_SPINLOCK
c_func
(paren
id|call_lock
)paren
suffix:semicolon
DECL|variable|scf_started
r_static
id|atomic_t
id|scf_started
suffix:semicolon
DECL|variable|scf_finished
r_static
id|atomic_t
id|scf_finished
suffix:semicolon
DECL|variable|func
r_static
r_void
(paren
op_star
id|func
)paren
(paren
r_void
op_star
id|info
)paren
suffix:semicolon
DECL|variable|info
r_static
r_void
op_star
id|info
suffix:semicolon
DECL|function|smp_call_function_slave
r_void
id|smp_call_function_slave
c_func
(paren
r_int
id|cpu
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|scf_started
)paren
suffix:semicolon
(paren
op_star
id|func
)paren
(paren
id|info
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|scf_finished
)paren
suffix:semicolon
)brace
DECL|function|smp_call_function
r_int
id|smp_call_function
c_func
(paren
r_void
(paren
op_star
id|_func
)paren
(paren
r_void
op_star
id|info
)paren
comma
r_void
op_star
id|_info
comma
r_int
id|nonatomic
comma
r_int
id|wait
)paren
(brace
r_int
id|cpus
op_assign
id|num_online_cpus
c_func
(paren
)paren
op_minus
l_int|1
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpus
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Can deadlock when called with interrupts disabled */
id|WARN_ON
c_func
(paren
id|irqs_disabled
c_func
(paren
)paren
)paren
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|call_lock
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|scf_started
comma
l_int|0
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|scf_finished
comma
l_int|0
)paren
suffix:semicolon
id|func
op_assign
id|_func
suffix:semicolon
id|info
op_assign
id|_info
suffix:semicolon
id|for_each_online_cpu
c_func
(paren
id|i
)paren
id|os_write_file
c_func
(paren
id|cpu_data
(braket
id|i
)braket
dot
id|ipi_pipe
(braket
l_int|1
)braket
comma
l_string|&quot;C&quot;
comma
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|atomic_read
c_func
(paren
op_amp
id|scf_started
)paren
op_ne
id|cpus
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait
)paren
r_while
c_loop
(paren
id|atomic_read
c_func
(paren
op_amp
id|scf_finished
)paren
op_ne
id|cpus
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|call_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-file-style: &quot;linux&quot;&n; * End:&n; */
eof
