multiline_comment|/*&n; * Copyright (C) 2001 Lennert Buytenhek (buytenh@gnu.org) and &n; * James Leu (jleu@mindspring.net).&n; * Copyright (C) 2001 by various other people who didn&squot;t put their name here.&n; * Licensed under the GPL.&n; */
macro_line|#include &lt;errno.h&gt;
macro_line|#include &lt;unistd.h&gt;
macro_line|#include &lt;sys/socket.h&gt;
macro_line|#include &lt;sys/un.h&gt;
macro_line|#include &lt;sys/time.h&gt;
macro_line|#include &quot;net_user.h&quot;
macro_line|#include &quot;daemon.h&quot;
macro_line|#include &quot;kern_util.h&quot;
macro_line|#include &quot;user_util.h&quot;
macro_line|#include &quot;user.h&quot;
macro_line|#include &quot;os.h&quot;
DECL|macro|MAX_PACKET
mdefine_line|#define MAX_PACKET (ETH_MAX_PACKET + ETH_HEADER_OTHER)
DECL|enum|request_type
DECL|enumerator|REQ_NEW_CONTROL
r_enum
id|request_type
(brace
id|REQ_NEW_CONTROL
)brace
suffix:semicolon
DECL|macro|SWITCH_MAGIC
mdefine_line|#define SWITCH_MAGIC 0xfeedface
DECL|struct|request_v3
r_struct
id|request_v3
(brace
DECL|member|magic
r_int
r_int
id|magic
suffix:semicolon
DECL|member|version
r_int
id|version
suffix:semicolon
DECL|member|type
r_enum
id|request_type
id|type
suffix:semicolon
DECL|member|sock
r_struct
id|sockaddr_un
id|sock
suffix:semicolon
)brace
suffix:semicolon
DECL|function|new_addr
r_static
r_struct
id|sockaddr_un
op_star
id|new_addr
c_func
(paren
r_void
op_star
id|name
comma
r_int
id|len
)paren
(brace
r_struct
id|sockaddr_un
op_star
id|sun
suffix:semicolon
id|sun
op_assign
id|um_kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|sockaddr_un
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sun
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;new_addr: allocation of sockaddr_un failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|sun-&gt;sun_family
op_assign
id|AF_UNIX
suffix:semicolon
id|memcpy
c_func
(paren
id|sun-&gt;sun_path
comma
id|name
comma
id|len
)paren
suffix:semicolon
r_return
id|sun
suffix:semicolon
)brace
DECL|function|connect_to_switch
r_static
r_int
id|connect_to_switch
c_func
(paren
r_struct
id|daemon_data
op_star
id|pri
)paren
(brace
r_struct
id|sockaddr_un
op_star
id|ctl_addr
op_assign
id|pri-&gt;ctl_addr
suffix:semicolon
r_struct
id|sockaddr_un
op_star
id|local_addr
op_assign
id|pri-&gt;local_addr
suffix:semicolon
r_struct
id|sockaddr_un
op_star
id|sun
suffix:semicolon
r_struct
id|request_v3
id|req
suffix:semicolon
r_int
id|fd
comma
id|n
comma
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pri-&gt;control
op_assign
id|socket
c_func
(paren
id|AF_UNIX
comma
id|SOCK_STREAM
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;daemon_open : control socket failed, errno = %d&bslash;n&quot;
comma
id|errno
)paren
suffix:semicolon
r_return
op_minus
id|errno
suffix:semicolon
)brace
r_if
c_cond
(paren
id|connect
c_func
(paren
id|pri-&gt;control
comma
(paren
r_struct
id|sockaddr
op_star
)paren
id|ctl_addr
comma
r_sizeof
(paren
op_star
id|ctl_addr
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;daemon_open : control connect failed, errno = %d&bslash;n&quot;
comma
id|errno
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|errno
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|fd
op_assign
id|socket
c_func
(paren
id|AF_UNIX
comma
id|SOCK_DGRAM
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;daemon_open : data socket failed, errno = %d&bslash;n&quot;
comma
id|errno
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|errno
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bind
c_func
(paren
id|fd
comma
(paren
r_struct
id|sockaddr
op_star
)paren
id|local_addr
comma
r_sizeof
(paren
op_star
id|local_addr
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;daemon_open : data bind failed, errno = %d&bslash;n&quot;
comma
id|errno
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|errno
suffix:semicolon
r_goto
id|out_close
suffix:semicolon
)brace
id|sun
op_assign
id|um_kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|sockaddr_un
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sun
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;new_addr: allocation of sockaddr_un failed&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out_close
suffix:semicolon
)brace
id|req.magic
op_assign
id|SWITCH_MAGIC
suffix:semicolon
id|req.version
op_assign
id|SWITCH_VERSION
suffix:semicolon
id|req.type
op_assign
id|REQ_NEW_CONTROL
suffix:semicolon
id|req.sock
op_assign
op_star
id|local_addr
suffix:semicolon
id|n
op_assign
id|write
c_func
(paren
id|pri-&gt;control
comma
op_amp
id|req
comma
r_sizeof
(paren
id|req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
r_sizeof
(paren
id|req
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;daemon_open : control setup request returned %d, &quot;
l_string|&quot;errno = %d&bslash;n&quot;
comma
id|n
comma
id|errno
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOTCONN
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|n
op_assign
id|read
c_func
(paren
id|pri-&gt;control
comma
id|sun
comma
r_sizeof
(paren
op_star
id|sun
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
r_sizeof
(paren
op_star
id|sun
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;daemon_open : read of data socket returned %d, &quot;
l_string|&quot;errno = %d&bslash;n&quot;
comma
id|n
comma
id|errno
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOTCONN
suffix:semicolon
r_goto
id|out_close
suffix:semicolon
)brace
id|pri-&gt;data_addr
op_assign
id|sun
suffix:semicolon
r_return
id|fd
suffix:semicolon
id|out_close
suffix:colon
id|close
c_func
(paren
id|fd
)paren
suffix:semicolon
id|out
suffix:colon
id|close
c_func
(paren
id|pri-&gt;control
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|daemon_user_init
r_static
r_void
id|daemon_user_init
c_func
(paren
r_void
op_star
id|data
comma
r_void
op_star
id|dev
)paren
(brace
r_struct
id|daemon_data
op_star
id|pri
op_assign
id|data
suffix:semicolon
r_struct
id|timeval
id|tv
suffix:semicolon
r_struct
(brace
r_char
id|zero
suffix:semicolon
r_int
id|pid
suffix:semicolon
r_int
id|usecs
suffix:semicolon
)brace
id|name
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|pri-&gt;sock_type
comma
l_string|&quot;unix&quot;
)paren
)paren
(brace
id|pri-&gt;ctl_addr
op_assign
id|new_addr
c_func
(paren
id|pri-&gt;ctl_sock
comma
id|strlen
c_func
(paren
id|pri-&gt;ctl_sock
)paren
op_plus
l_int|1
)paren
suffix:semicolon
)brace
id|name.zero
op_assign
l_int|0
suffix:semicolon
id|name.pid
op_assign
id|os_getpid
c_func
(paren
)paren
suffix:semicolon
id|gettimeofday
c_func
(paren
op_amp
id|tv
comma
l_int|NULL
)paren
suffix:semicolon
id|name.usecs
op_assign
id|tv.tv_usec
suffix:semicolon
id|pri-&gt;local_addr
op_assign
id|new_addr
c_func
(paren
op_amp
id|name
comma
r_sizeof
(paren
id|name
)paren
)paren
suffix:semicolon
id|pri-&gt;dev
op_assign
id|dev
suffix:semicolon
id|pri-&gt;fd
op_assign
id|connect_to_switch
c_func
(paren
id|pri
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pri-&gt;fd
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|pri-&gt;local_addr
)paren
suffix:semicolon
id|pri-&gt;local_addr
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
DECL|function|daemon_open
r_static
r_int
id|daemon_open
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|daemon_data
op_star
id|pri
op_assign
id|data
suffix:semicolon
r_return
id|pri-&gt;fd
suffix:semicolon
)brace
DECL|function|daemon_remove
r_static
r_void
id|daemon_remove
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|daemon_data
op_star
id|pri
op_assign
id|data
suffix:semicolon
id|close
c_func
(paren
id|pri-&gt;fd
)paren
suffix:semicolon
id|close
c_func
(paren
id|pri-&gt;control
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pri-&gt;data_addr
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|pri-&gt;data_addr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pri-&gt;ctl_addr
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|pri-&gt;ctl_addr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pri-&gt;local_addr
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|pri-&gt;local_addr
)paren
suffix:semicolon
)brace
)brace
DECL|function|daemon_user_write
r_int
id|daemon_user_write
c_func
(paren
r_int
id|fd
comma
r_void
op_star
id|buf
comma
r_int
id|len
comma
r_struct
id|daemon_data
op_star
id|pri
)paren
(brace
r_struct
id|sockaddr_un
op_star
id|data_addr
op_assign
id|pri-&gt;data_addr
suffix:semicolon
r_return
id|net_sendto
c_func
(paren
id|fd
comma
id|buf
comma
id|len
comma
id|data_addr
comma
r_sizeof
(paren
op_star
id|data_addr
)paren
)paren
suffix:semicolon
)brace
DECL|function|daemon_set_mtu
r_static
r_int
id|daemon_set_mtu
c_func
(paren
r_int
id|mtu
comma
r_void
op_star
id|data
)paren
(brace
r_return
id|mtu
suffix:semicolon
)brace
DECL|variable|daemon_user_info
r_struct
id|net_user_info
id|daemon_user_info
op_assign
(brace
dot
id|init
op_assign
id|daemon_user_init
comma
dot
id|open
op_assign
id|daemon_open
comma
dot
id|close
op_assign
l_int|NULL
comma
dot
id|remove
op_assign
id|daemon_remove
comma
dot
id|set_mtu
op_assign
id|daemon_set_mtu
comma
dot
id|add_address
op_assign
l_int|NULL
comma
dot
id|delete_address
op_assign
l_int|NULL
comma
dot
id|max_packet
op_assign
id|MAX_PACKET
op_minus
id|ETH_HEADER_OTHER
)brace
suffix:semicolon
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-file-style: &quot;linux&quot;&n; * End:&n; */
eof
