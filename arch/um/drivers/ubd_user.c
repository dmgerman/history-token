multiline_comment|/* &n; * Copyright (C) 2000, 2001, 2002 Jeff Dike (jdike@karaya.com)&n; * Copyright (C) 2001 Ridgerun,Inc (glonnon@ridgerun.com)&n; * Licensed under the GPL&n; */
macro_line|#include &lt;stddef.h&gt;
macro_line|#include &lt;unistd.h&gt;
macro_line|#include &lt;errno.h&gt;
macro_line|#include &lt;sched.h&gt;
macro_line|#include &lt;signal.h&gt;
macro_line|#include &lt;string.h&gt;
macro_line|#include &lt;netinet/in.h&gt;
macro_line|#include &lt;sys/stat.h&gt;
macro_line|#include &lt;sys/time.h&gt;
macro_line|#include &lt;sys/fcntl.h&gt;
macro_line|#include &lt;sys/socket.h&gt;
macro_line|#include &lt;string.h&gt;
macro_line|#include &lt;sys/mman.h&gt;
macro_line|#include &lt;sys/param.h&gt;
macro_line|#include &quot;asm/types.h&quot;
macro_line|#include &quot;user_util.h&quot;
macro_line|#include &quot;kern_util.h&quot;
macro_line|#include &quot;user.h&quot;
macro_line|#include &quot;ubd_user.h&quot;
macro_line|#include &quot;os.h&quot;
macro_line|#include &lt;endian.h&gt;
macro_line|#include &lt;byteswap.h&gt;
macro_line|#if __BYTE_ORDER == __BIG_ENDIAN
DECL|macro|ntohll
macro_line|# define ntohll(x) (x)
DECL|macro|htonll
macro_line|# define htonll(x) (x)
macro_line|#elif __BYTE_ORDER == __LITTLE_ENDIAN
DECL|macro|ntohll
macro_line|# define ntohll(x)  bswap_64(x)
DECL|macro|htonll
macro_line|# define htonll(x)  bswap_64(x)
macro_line|#else
macro_line|#error &quot;__BYTE_ORDER not defined&quot;
macro_line|#endif
DECL|macro|PATH_LEN_V1
mdefine_line|#define PATH_LEN_V1 256
DECL|struct|cow_header_v1
r_struct
id|cow_header_v1
(brace
DECL|member|magic
r_int
id|magic
suffix:semicolon
DECL|member|version
r_int
id|version
suffix:semicolon
DECL|member|backing_file
r_char
id|backing_file
(braket
id|PATH_LEN_V1
)braket
suffix:semicolon
DECL|member|mtime
id|time_t
id|mtime
suffix:semicolon
DECL|member|size
id|__u64
id|size
suffix:semicolon
DECL|member|sectorsize
r_int
id|sectorsize
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|PATH_LEN_V2
mdefine_line|#define PATH_LEN_V2 MAXPATHLEN
DECL|struct|cow_header_v2
r_struct
id|cow_header_v2
(brace
DECL|member|magic
r_int
r_int
id|magic
suffix:semicolon
DECL|member|version
r_int
r_int
id|version
suffix:semicolon
DECL|member|backing_file
r_char
id|backing_file
(braket
id|PATH_LEN_V2
)braket
suffix:semicolon
DECL|member|mtime
id|time_t
id|mtime
suffix:semicolon
DECL|member|size
id|__u64
id|size
suffix:semicolon
DECL|member|sectorsize
r_int
id|sectorsize
suffix:semicolon
)brace
suffix:semicolon
DECL|union|cow_header
r_union
id|cow_header
(brace
DECL|member|v1
r_struct
id|cow_header_v1
id|v1
suffix:semicolon
DECL|member|v2
r_struct
id|cow_header_v2
id|v2
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|COW_MAGIC
mdefine_line|#define COW_MAGIC 0x4f4f4f4d  /* MOOO */
DECL|macro|COW_VERSION
mdefine_line|#define COW_VERSION 2
DECL|function|sizes
r_static
r_void
id|sizes
c_func
(paren
id|__u64
id|size
comma
r_int
id|sectorsize
comma
r_int
id|bitmap_offset
comma
r_int
r_int
op_star
id|bitmap_len_out
comma
r_int
op_star
id|data_offset_out
)paren
(brace
op_star
id|bitmap_len_out
op_assign
(paren
id|size
op_plus
id|sectorsize
op_minus
l_int|1
)paren
op_div
(paren
l_int|8
op_star
id|sectorsize
)paren
suffix:semicolon
op_star
id|data_offset_out
op_assign
id|bitmap_offset
op_plus
op_star
id|bitmap_len_out
suffix:semicolon
op_star
id|data_offset_out
op_assign
(paren
op_star
id|data_offset_out
op_plus
id|sectorsize
op_minus
l_int|1
)paren
op_div
id|sectorsize
suffix:semicolon
op_star
id|data_offset_out
op_mul_assign
id|sectorsize
suffix:semicolon
)brace
DECL|function|read_cow_header
r_static
r_int
id|read_cow_header
c_func
(paren
r_int
id|fd
comma
r_int
op_star
id|magic_out
comma
r_char
op_star
op_star
id|backing_file_out
comma
id|time_t
op_star
id|mtime_out
comma
id|__u64
op_star
id|size_out
comma
r_int
op_star
id|sectorsize_out
comma
r_int
op_star
id|bitmap_offset_out
)paren
(brace
r_union
id|cow_header
op_star
id|header
suffix:semicolon
r_char
op_star
id|file
suffix:semicolon
r_int
id|err
comma
id|n
suffix:semicolon
r_int
r_int
id|version
comma
id|magic
suffix:semicolon
id|header
op_assign
id|um_kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|header
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|header
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;read_cow_header - Failed to allocate header&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|n
op_assign
id|read
c_func
(paren
id|fd
comma
id|header
comma
r_sizeof
(paren
op_star
id|header
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
m_offsetof
(paren
id|typeof
c_func
(paren
id|header-&gt;v1
)paren
comma
id|backing_file
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;read_cow_header - short header&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|magic
op_assign
id|header-&gt;v1.magic
suffix:semicolon
r_if
c_cond
(paren
id|magic
op_eq
id|COW_MAGIC
)paren
(brace
id|version
op_assign
id|header-&gt;v1.version
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|magic
op_eq
id|ntohl
c_func
(paren
id|COW_MAGIC
)paren
)paren
(brace
id|version
op_assign
id|ntohl
c_func
(paren
id|header-&gt;v1.version
)paren
suffix:semicolon
)brace
r_else
r_goto
id|out
suffix:semicolon
op_star
id|magic_out
op_assign
id|COW_MAGIC
suffix:semicolon
r_if
c_cond
(paren
id|version
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|n
OL
r_sizeof
(paren
id|header-&gt;v1
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;read_cow_header - failed to read V1 header&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
op_star
id|mtime_out
op_assign
id|header-&gt;v1.mtime
suffix:semicolon
op_star
id|size_out
op_assign
id|header-&gt;v1.size
suffix:semicolon
op_star
id|sectorsize_out
op_assign
id|header-&gt;v1.sectorsize
suffix:semicolon
op_star
id|bitmap_offset_out
op_assign
r_sizeof
(paren
id|header-&gt;v1
)paren
suffix:semicolon
id|file
op_assign
id|header-&gt;v1.backing_file
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|version
op_eq
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|n
OL
r_sizeof
(paren
id|header-&gt;v2
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;read_cow_header - failed to read V2 header&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
op_star
id|mtime_out
op_assign
id|ntohl
c_func
(paren
id|header-&gt;v2.mtime
)paren
suffix:semicolon
op_star
id|size_out
op_assign
id|ntohll
c_func
(paren
id|header-&gt;v2.size
)paren
suffix:semicolon
op_star
id|sectorsize_out
op_assign
id|ntohl
c_func
(paren
id|header-&gt;v2.sectorsize
)paren
suffix:semicolon
op_star
id|bitmap_offset_out
op_assign
r_sizeof
(paren
id|header-&gt;v2
)paren
suffix:semicolon
id|file
op_assign
id|header-&gt;v2.backing_file
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;read_cow_header - invalid COW version&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
op_star
id|backing_file_out
op_assign
id|uml_strdup
c_func
(paren
id|file
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|backing_file_out
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;read_cow_header - failed to allocate backing file&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|err
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|kfree
c_func
(paren
id|header
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|same_backing_files
r_static
r_int
id|same_backing_files
c_func
(paren
r_char
op_star
id|from_cmdline
comma
r_char
op_star
id|from_cow
comma
r_char
op_star
id|cow
)paren
(brace
r_struct
id|stat
id|buf1
comma
id|buf2
suffix:semicolon
r_if
c_cond
(paren
id|from_cmdline
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|from_cmdline
comma
id|from_cow
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stat
c_func
(paren
id|from_cmdline
comma
op_amp
id|buf1
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Couldn&squot;t stat &squot;%s&squot;, errno = %d&bslash;n&quot;
comma
id|from_cmdline
comma
id|errno
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stat
c_func
(paren
id|from_cow
comma
op_amp
id|buf2
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Couldn&squot;t stat &squot;%s&squot;, errno = %d&bslash;n&quot;
comma
id|from_cow
comma
id|errno
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|buf1.st_dev
op_eq
id|buf2.st_dev
)paren
op_logical_and
(paren
id|buf1.st_ino
op_eq
id|buf2.st_ino
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;Backing file mismatch - &bslash;&quot;%s&bslash;&quot; requested,&bslash;n&quot;
l_string|&quot;&bslash;&quot;%s&bslash;&quot; specified in COW header of &bslash;&quot;%s&bslash;&quot;&bslash;n&quot;
comma
id|from_cmdline
comma
id|from_cow
comma
id|cow
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|backing_file_mismatch
r_static
r_int
id|backing_file_mismatch
c_func
(paren
r_char
op_star
id|file
comma
id|__u64
id|size
comma
id|time_t
id|mtime
)paren
(brace
r_struct
id|stat64
id|buf
suffix:semicolon
r_int
r_int
id|actual
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|stat64
c_func
(paren
id|file
comma
op_amp
id|buf
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to stat backing file &bslash;&quot;%s&bslash;&quot;, errno = %d&bslash;n&quot;
comma
id|file
comma
id|errno
)paren
suffix:semicolon
r_return
op_minus
id|errno
suffix:semicolon
)brace
id|err
op_assign
id|os_file_size
c_func
(paren
id|file
comma
op_amp
id|actual
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to get size of backing file &bslash;&quot;%s&bslash;&quot;, &quot;
l_string|&quot;errno = %d&bslash;n&quot;
comma
id|file
comma
op_minus
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|actual
op_ne
id|size
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Size mismatch (%ld vs %ld) of COW header vs backing &quot;
l_string|&quot;file&bslash;n&quot;
comma
id|size
comma
id|actual
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|buf.st_mtime
op_ne
id|mtime
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;mtime mismatch (%ld vs %ld) of COW header vs backing &quot;
l_string|&quot;file&bslash;n&quot;
comma
id|mtime
comma
id|buf.st_mtime
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|read_cow_bitmap
r_int
id|read_cow_bitmap
c_func
(paren
r_int
id|fd
comma
r_void
op_star
id|buf
comma
r_int
id|offset
comma
r_int
id|len
)paren
(brace
r_int
id|err
suffix:semicolon
id|err
op_assign
id|os_seek_file
c_func
(paren
id|fd
comma
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
l_int|0
)paren
(brace
r_return
op_minus
id|errno
suffix:semicolon
)brace
id|err
op_assign
id|read
c_func
(paren
id|fd
comma
id|buf
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_return
op_minus
id|errno
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|absolutize
r_static
r_int
id|absolutize
c_func
(paren
r_char
op_star
id|to
comma
r_int
id|size
comma
r_char
op_star
id|from
)paren
(brace
r_char
id|save_cwd
(braket
l_int|256
)braket
comma
op_star
id|slash
suffix:semicolon
r_int
id|remaining
suffix:semicolon
r_if
c_cond
(paren
id|getcwd
c_func
(paren
id|save_cwd
comma
r_sizeof
(paren
id|save_cwd
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;absolutize : unable to get cwd - errno = %d&bslash;n&quot;
comma
id|errno
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|slash
op_assign
id|strrchr
c_func
(paren
id|from
comma
l_char|&squot;/&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slash
op_ne
l_int|NULL
)paren
(brace
op_star
id|slash
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|chdir
c_func
(paren
id|from
)paren
)paren
(brace
op_star
id|slash
op_assign
l_char|&squot;/&squot;
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;absolutize : Can&squot;t cd to &squot;%s&squot; - errno = %d&bslash;n&quot;
comma
id|from
comma
id|errno
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
op_star
id|slash
op_assign
l_char|&squot;/&squot;
suffix:semicolon
r_if
c_cond
(paren
id|getcwd
c_func
(paren
id|to
comma
id|size
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;absolutize : unable to get cwd of &squot;%s&squot; - &quot;
l_string|&quot;errno = %d&bslash;n&quot;
comma
id|from
comma
id|errno
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|remaining
op_assign
id|size
op_minus
id|strlen
c_func
(paren
id|to
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|slash
)paren
op_plus
l_int|1
OG
id|remaining
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;absolutize : unable to fit &squot;%s&squot; into %d &quot;
l_string|&quot;chars&bslash;n&quot;
comma
id|from
comma
id|size
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|strcat
c_func
(paren
id|to
comma
id|slash
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|save_cwd
)paren
op_plus
l_int|1
op_plus
id|strlen
c_func
(paren
id|from
)paren
op_plus
l_int|1
OG
id|size
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;absolutize : unable to fit &squot;%s&squot; into %d &quot;
l_string|&quot;chars&bslash;n&quot;
comma
id|from
comma
id|size
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|to
comma
id|save_cwd
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|to
comma
l_string|&quot;/&quot;
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|to
comma
id|from
)paren
suffix:semicolon
)brace
id|chdir
c_func
(paren
id|save_cwd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|write_cow_header
r_static
r_int
id|write_cow_header
c_func
(paren
r_char
op_star
id|cow_file
comma
r_int
id|fd
comma
r_char
op_star
id|backing_file
comma
r_int
id|sectorsize
comma
r_int
r_int
op_star
id|size
)paren
(brace
r_struct
id|cow_header_v2
op_star
id|header
suffix:semicolon
r_struct
id|stat64
id|buf
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
id|os_seek_file
c_func
(paren
id|fd
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;write_cow_header - lseek failed, errno = %d&bslash;n&quot;
comma
id|errno
)paren
suffix:semicolon
r_return
op_minus
id|errno
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|header
op_assign
id|um_kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|header
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|header
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to allocate COW V2 header&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|header-&gt;magic
op_assign
id|htonl
c_func
(paren
id|COW_MAGIC
)paren
suffix:semicolon
id|header-&gt;version
op_assign
id|htonl
c_func
(paren
id|COW_VERSION
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|backing_file
)paren
OG
r_sizeof
(paren
id|header-&gt;backing_file
)paren
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Backing file name &bslash;&quot;%s&bslash;&quot; is too long - names are &quot;
l_string|&quot;limited to %d characters&bslash;n&quot;
comma
id|backing_file
comma
r_sizeof
(paren
id|header-&gt;backing_file
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
r_if
c_cond
(paren
id|absolutize
c_func
(paren
id|header-&gt;backing_file
comma
r_sizeof
(paren
id|header-&gt;backing_file
)paren
comma
id|backing_file
)paren
)paren
(brace
r_goto
id|out_free
suffix:semicolon
)brace
id|err
op_assign
id|stat64
c_func
(paren
id|header-&gt;backing_file
comma
op_amp
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Stat of backing file &squot;%s&squot; failed, errno = %d&bslash;n&quot;
comma
id|header-&gt;backing_file
comma
id|errno
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|errno
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
id|err
op_assign
id|os_file_size
c_func
(paren
id|header-&gt;backing_file
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Couldn&squot;t get size of backing file &squot;%s&squot;, errno = %d&bslash;n&quot;
comma
id|header-&gt;backing_file
comma
op_minus
op_star
id|size
)paren
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
id|header-&gt;mtime
op_assign
id|htonl
c_func
(paren
id|buf.st_mtime
)paren
suffix:semicolon
id|header-&gt;size
op_assign
id|htonll
c_func
(paren
op_star
id|size
)paren
suffix:semicolon
id|header-&gt;sectorsize
op_assign
id|htonl
c_func
(paren
id|sectorsize
)paren
suffix:semicolon
id|err
op_assign
id|write
c_func
(paren
id|fd
comma
id|header
comma
r_sizeof
(paren
op_star
id|header
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
r_sizeof
(paren
op_star
id|header
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Write of header to new COW file &squot;%s&squot; failed, &quot;
l_string|&quot;errno = %d&bslash;n&quot;
comma
id|cow_file
comma
id|errno
)paren
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
id|err
op_assign
l_int|0
suffix:semicolon
id|out_free
suffix:colon
id|kfree
c_func
(paren
id|header
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|function|open_ubd_file
r_int
id|open_ubd_file
c_func
(paren
r_char
op_star
id|file
comma
r_struct
id|openflags
op_star
id|openflags
comma
r_char
op_star
op_star
id|backing_file_out
comma
r_int
op_star
id|bitmap_offset_out
comma
r_int
r_int
op_star
id|bitmap_len_out
comma
r_int
op_star
id|data_offset_out
comma
r_int
op_star
id|create_cow_out
)paren
(brace
id|time_t
id|mtime
suffix:semicolon
id|__u64
id|size
suffix:semicolon
r_char
op_star
id|backing_file
suffix:semicolon
r_int
id|fd
comma
id|err
comma
id|sectorsize
comma
id|magic
comma
id|same
comma
id|mode
op_assign
l_int|0644
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fd
op_assign
id|os_open_file
c_func
(paren
id|file
comma
op_star
id|openflags
comma
id|mode
)paren
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|fd
op_eq
op_minus
id|ENOENT
)paren
op_logical_and
(paren
id|create_cow_out
op_ne
l_int|NULL
)paren
)paren
(brace
op_star
id|create_cow_out
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|openflags-&gt;w
op_logical_or
(paren
(paren
id|errno
op_ne
id|EROFS
)paren
op_logical_and
(paren
id|errno
op_ne
id|EACCES
)paren
)paren
)paren
(brace
r_return
op_minus
id|errno
suffix:semicolon
)brace
id|openflags-&gt;w
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fd
op_assign
id|os_open_file
c_func
(paren
id|file
comma
op_star
id|openflags
comma
id|mode
)paren
)paren
OL
l_int|0
)paren
(brace
r_return
id|fd
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|backing_file_out
op_eq
l_int|NULL
)paren
(brace
r_return
id|fd
suffix:semicolon
)brace
id|err
op_assign
id|read_cow_header
c_func
(paren
id|fd
comma
op_amp
id|magic
comma
op_amp
id|backing_file
comma
op_amp
id|mtime
comma
op_amp
id|size
comma
op_amp
id|sectorsize
comma
id|bitmap_offset_out
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_logical_and
(paren
op_star
id|backing_file_out
op_ne
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to read COW header from COW file &bslash;&quot;%s&bslash;&quot;, &quot;
l_string|&quot;errno = %d&bslash;n&quot;
comma
id|file
comma
id|err
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|fd
suffix:semicolon
)brace
r_if
c_cond
(paren
id|backing_file_out
op_eq
l_int|NULL
)paren
(brace
r_return
id|fd
suffix:semicolon
)brace
id|same
op_assign
id|same_backing_files
c_func
(paren
op_star
id|backing_file_out
comma
id|backing_file
comma
id|file
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|same
op_logical_and
op_logical_neg
id|backing_file_mismatch
c_func
(paren
op_star
id|backing_file_out
comma
id|size
comma
id|mtime
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Switching backing file to &squot;%s&squot;&bslash;n&quot;
comma
op_star
id|backing_file_out
)paren
suffix:semicolon
id|err
op_assign
id|write_cow_header
c_func
(paren
id|file
comma
id|fd
comma
op_star
id|backing_file_out
comma
id|sectorsize
comma
op_amp
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Switch failed, errno = %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
)brace
r_else
(brace
op_star
id|backing_file_out
op_assign
id|backing_file
suffix:semicolon
id|err
op_assign
id|backing_file_mismatch
c_func
(paren
op_star
id|backing_file_out
comma
id|size
comma
id|mtime
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_goto
id|error
suffix:semicolon
)brace
)brace
id|sizes
c_func
(paren
id|size
comma
id|sectorsize
comma
op_star
id|bitmap_offset_out
comma
id|bitmap_len_out
comma
id|data_offset_out
)paren
suffix:semicolon
r_return
id|fd
suffix:semicolon
id|error
suffix:colon
id|close
c_func
(paren
id|fd
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|create_cow_file
r_int
id|create_cow_file
c_func
(paren
r_char
op_star
id|cow_file
comma
r_char
op_star
id|backing_file
comma
r_struct
id|openflags
id|flags
comma
r_int
id|sectorsize
comma
r_int
op_star
id|bitmap_offset_out
comma
r_int
r_int
op_star
id|bitmap_len_out
comma
r_int
op_star
id|data_offset_out
)paren
(brace
id|__u64
id|blocks
suffix:semicolon
r_int
id|zero
suffix:semicolon
r_int
id|err
comma
id|fd
comma
id|i
suffix:semicolon
r_int
r_int
id|size
suffix:semicolon
id|flags.c
op_assign
l_int|1
suffix:semicolon
id|fd
op_assign
id|open_ubd_file
c_func
(paren
id|cow_file
comma
op_amp
id|flags
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
OL
l_int|0
)paren
(brace
id|err
op_assign
id|fd
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Open of COW file &squot;%s&squot; failed, errno = %d&bslash;n&quot;
comma
id|cow_file
comma
op_minus
id|err
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|err
op_assign
id|write_cow_header
c_func
(paren
id|cow_file
comma
id|fd
comma
id|backing_file
comma
id|sectorsize
comma
op_amp
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_goto
id|out_close
suffix:semicolon
)brace
id|blocks
op_assign
(paren
id|size
op_plus
id|sectorsize
op_minus
l_int|1
)paren
op_div
id|sectorsize
suffix:semicolon
id|blocks
op_assign
(paren
id|blocks
op_plus
r_sizeof
(paren
r_int
)paren
op_star
l_int|8
op_minus
l_int|1
)paren
op_div
(paren
r_sizeof
(paren
r_int
)paren
op_star
l_int|8
)paren
suffix:semicolon
id|zero
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|blocks
suffix:semicolon
id|i
op_increment
)paren
(brace
id|err
op_assign
id|write
c_func
(paren
id|fd
comma
op_amp
id|zero
comma
r_sizeof
(paren
id|zero
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
r_sizeof
(paren
id|zero
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Write of bitmap to new COW file &squot;%s&squot; failed, &quot;
l_string|&quot;errno = %d&bslash;n&quot;
comma
id|cow_file
comma
id|errno
)paren
suffix:semicolon
r_goto
id|out_close
suffix:semicolon
)brace
)brace
id|sizes
c_func
(paren
id|size
comma
id|sectorsize
comma
r_sizeof
(paren
r_struct
id|cow_header_v2
)paren
comma
id|bitmap_len_out
comma
id|data_offset_out
)paren
suffix:semicolon
op_star
id|bitmap_offset_out
op_assign
r_sizeof
(paren
r_struct
id|cow_header_v2
)paren
suffix:semicolon
r_return
id|fd
suffix:semicolon
id|out_close
suffix:colon
id|close
c_func
(paren
id|fd
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|function|read_ubd_fs
r_int
id|read_ubd_fs
c_func
(paren
r_int
id|fd
comma
r_void
op_star
id|buffer
comma
r_int
id|len
)paren
(brace
r_int
id|n
suffix:semicolon
id|n
op_assign
id|read
c_func
(paren
id|fd
comma
id|buffer
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
l_int|0
)paren
(brace
r_return
op_minus
id|errno
suffix:semicolon
)brace
r_else
r_return
id|n
suffix:semicolon
)brace
DECL|function|write_ubd_fs
r_int
id|write_ubd_fs
c_func
(paren
r_int
id|fd
comma
r_char
op_star
id|buffer
comma
r_int
id|len
)paren
(brace
r_int
id|n
suffix:semicolon
id|n
op_assign
id|write
c_func
(paren
id|fd
comma
id|buffer
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
l_int|0
)paren
(brace
r_return
op_minus
id|errno
suffix:semicolon
)brace
r_else
r_return
id|n
suffix:semicolon
)brace
DECL|function|ubd_is_dir
r_int
id|ubd_is_dir
c_func
(paren
r_char
op_star
id|file
)paren
(brace
r_struct
id|stat64
id|buf
suffix:semicolon
r_if
c_cond
(paren
id|stat64
c_func
(paren
id|file
comma
op_amp
id|buf
)paren
OL
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|S_ISDIR
c_func
(paren
id|buf.st_mode
)paren
suffix:semicolon
)brace
DECL|function|do_io
r_void
id|do_io
c_func
(paren
r_struct
id|io_thread_req
op_star
id|req
)paren
(brace
r_char
op_star
id|buf
suffix:semicolon
r_int
r_int
id|len
suffix:semicolon
r_int
id|n
comma
id|nsectors
comma
id|start
comma
id|end
comma
id|bit
suffix:semicolon
id|__u64
id|off
suffix:semicolon
id|nsectors
op_assign
id|req-&gt;length
op_div
id|req-&gt;sectorsize
suffix:semicolon
id|start
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|bit
op_assign
id|ubd_test_bit
c_func
(paren
id|start
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|req-&gt;sector_mask
)paren
suffix:semicolon
id|end
op_assign
id|start
suffix:semicolon
r_while
c_loop
(paren
(paren
id|end
OL
id|nsectors
)paren
op_logical_and
(paren
id|ubd_test_bit
c_func
(paren
id|end
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|req-&gt;sector_mask
)paren
op_eq
id|bit
)paren
)paren
(brace
id|end
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|end
op_ne
id|nsectors
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;end != nsectors&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|off
op_assign
id|req-&gt;offset
op_plus
id|req-&gt;offsets
(braket
id|bit
)braket
op_plus
id|start
op_star
id|req-&gt;sectorsize
suffix:semicolon
id|len
op_assign
(paren
id|end
op_minus
id|start
)paren
op_star
id|req-&gt;sectorsize
suffix:semicolon
id|buf
op_assign
op_amp
id|req-&gt;buffer
(braket
id|start
op_star
id|req-&gt;sectorsize
)braket
suffix:semicolon
r_if
c_cond
(paren
id|os_seek_file
c_func
(paren
id|req-&gt;fds
(braket
id|bit
)braket
comma
id|off
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;do_io - lseek failed : errno = %d&bslash;n&quot;
comma
id|errno
)paren
suffix:semicolon
id|req-&gt;error
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req-&gt;op
op_eq
id|UBD_READ
)paren
(brace
id|n
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|buf
op_assign
op_amp
id|buf
(braket
id|n
)braket
suffix:semicolon
id|len
op_sub_assign
id|n
suffix:semicolon
id|n
op_assign
id|read
c_func
(paren
id|req-&gt;fds
(braket
id|bit
)braket
comma
id|buf
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;do_io - read returned %d : &quot;
l_string|&quot;errno = %d fd = %d&bslash;n&quot;
comma
id|n
comma
id|errno
comma
id|req-&gt;fds
(braket
id|bit
)braket
)paren
suffix:semicolon
id|req-&gt;error
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
(paren
id|n
OL
id|len
)paren
op_logical_and
(paren
id|n
op_ne
l_int|0
)paren
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n
OL
id|len
)paren
id|memset
c_func
(paren
op_amp
id|buf
(braket
id|n
)braket
comma
l_int|0
comma
id|len
op_minus
id|n
)paren
suffix:semicolon
)brace
r_else
(brace
id|n
op_assign
id|write
c_func
(paren
id|req-&gt;fds
(braket
id|bit
)braket
comma
id|buf
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
id|len
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;do_io - write returned %d : &quot;
l_string|&quot;errno = %d fd = %d&bslash;n&quot;
comma
id|n
comma
id|errno
comma
id|req-&gt;fds
(braket
id|bit
)braket
)paren
suffix:semicolon
id|req-&gt;error
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|start
op_assign
id|end
suffix:semicolon
)brace
r_while
c_loop
(paren
id|start
OL
id|nsectors
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req-&gt;cow_offset
op_ne
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|os_seek_file
c_func
(paren
id|req-&gt;fds
(braket
l_int|1
)braket
comma
id|req-&gt;cow_offset
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;do_io - bitmap lseek failed : errno = %d&bslash;n&quot;
comma
id|errno
)paren
suffix:semicolon
id|req-&gt;error
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
id|n
op_assign
id|write
c_func
(paren
id|req-&gt;fds
(braket
l_int|1
)braket
comma
op_amp
id|req-&gt;bitmap_words
comma
r_sizeof
(paren
id|req-&gt;bitmap_words
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
r_sizeof
(paren
id|req-&gt;bitmap_words
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;do_io - bitmap update returned %d : &quot;
l_string|&quot;errno = %d fd = %d&bslash;n&quot;
comma
id|n
comma
id|errno
comma
id|req-&gt;fds
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|req-&gt;error
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|req-&gt;error
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Changed in start_io_thread, which is serialized by being called only&n; * from ubd_init, which is an initcall.&n; */
DECL|variable|kernel_fd
r_int
id|kernel_fd
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Only changed by the io thread */
DECL|variable|io_count
r_int
id|io_count
op_assign
l_int|0
suffix:semicolon
DECL|function|io_thread
r_int
id|io_thread
c_func
(paren
r_void
op_star
id|arg
)paren
(brace
r_struct
id|io_thread_req
id|req
suffix:semicolon
r_int
id|n
suffix:semicolon
id|signal
c_func
(paren
id|SIGWINCH
comma
id|SIG_IGN
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|n
op_assign
id|read
c_func
(paren
id|kernel_fd
comma
op_amp
id|req
comma
r_sizeof
(paren
id|req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;io_thread - read returned %d, errno = %d&bslash;n&quot;
comma
id|n
comma
id|errno
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|n
OL
r_sizeof
(paren
id|req
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;io_thread - short read : length = %d&bslash;n&quot;
comma
id|n
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|io_count
op_increment
suffix:semicolon
id|do_io
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
id|n
op_assign
id|write
c_func
(paren
id|kernel_fd
comma
op_amp
id|req
comma
r_sizeof
(paren
id|req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
r_sizeof
(paren
id|req
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;io_thread - write failed, errno = %d&bslash;n&quot;
comma
id|errno
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|start_io_thread
r_int
id|start_io_thread
c_func
(paren
r_int
r_int
id|sp
comma
r_int
op_star
id|fd_out
)paren
(brace
r_int
id|pid
comma
id|fds
(braket
l_int|2
)braket
comma
id|err
suffix:semicolon
id|err
op_assign
id|os_pipe
c_func
(paren
id|fds
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;start_io_thread - os_pipe failed, errno = %d&bslash;n&quot;
comma
op_minus
id|err
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|kernel_fd
op_assign
id|fds
(braket
l_int|0
)braket
suffix:semicolon
op_star
id|fd_out
op_assign
id|fds
(braket
l_int|1
)braket
suffix:semicolon
id|pid
op_assign
id|clone
c_func
(paren
id|io_thread
comma
(paren
r_void
op_star
)paren
id|sp
comma
id|CLONE_FILES
op_or
id|CLONE_VM
op_or
id|SIGCHLD
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pid
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;start_io_thread - clone failed : errno = %d&bslash;n&quot;
comma
id|errno
)paren
suffix:semicolon
r_return
op_minus
id|errno
suffix:semicolon
)brace
r_return
id|pid
suffix:semicolon
)brace
macro_line|#ifdef notdef
DECL|function|start_io_thread
r_int
id|start_io_thread
c_func
(paren
r_int
r_int
id|sp
comma
r_int
op_star
id|fd_out
)paren
(brace
r_int
id|pid
suffix:semicolon
r_if
c_cond
(paren
(paren
id|kernel_fd
op_assign
id|get_pty
c_func
(paren
)paren
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|raw
c_func
(paren
id|kernel_fd
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|fd_out
op_assign
id|open
c_func
(paren
id|ptsname
c_func
(paren
id|kernel_fd
)paren
comma
id|O_RDWR
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Couldn&squot;t open tty for IO&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|pid
op_assign
id|clone
c_func
(paren
id|io_thread
comma
(paren
r_void
op_star
)paren
id|sp
comma
id|CLONE_FILES
op_or
id|CLONE_VM
op_or
id|SIGCHLD
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pid
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;start_io_thread - clone failed : errno = %d&bslash;n&quot;
comma
id|errno
)paren
suffix:semicolon
r_return
op_minus
id|errno
suffix:semicolon
)brace
r_return
id|pid
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-file-style: &quot;linux&quot;&n; * End:&n; */
eof
