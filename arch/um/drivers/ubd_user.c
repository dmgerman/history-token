multiline_comment|/* &n; * Copyright (C) 2000, 2001, 2002 Jeff Dike (jdike@karaya.com)&n; * Copyright (C) 2001 Ridgerun,Inc (glonnon@ridgerun.com)&n; * Licensed under the GPL&n; */
macro_line|#include &lt;stddef.h&gt;
macro_line|#include &lt;unistd.h&gt;
macro_line|#include &lt;errno.h&gt;
macro_line|#include &lt;sched.h&gt;
macro_line|#include &lt;signal.h&gt;
macro_line|#include &lt;string.h&gt;
macro_line|#include &lt;netinet/in.h&gt;
macro_line|#include &lt;sys/time.h&gt;
macro_line|#include &lt;sys/socket.h&gt;
macro_line|#include &lt;sys/mman.h&gt;
macro_line|#include &lt;sys/param.h&gt;
macro_line|#include &quot;asm/types.h&quot;
macro_line|#include &quot;user_util.h&quot;
macro_line|#include &quot;kern_util.h&quot;
macro_line|#include &quot;user.h&quot;
macro_line|#include &quot;ubd_user.h&quot;
macro_line|#include &quot;os.h&quot;
macro_line|#include &quot;cow.h&quot;
macro_line|#include &lt;endian.h&gt;
macro_line|#include &lt;byteswap.h&gt;
DECL|function|same_backing_files
r_static
r_int
id|same_backing_files
c_func
(paren
r_char
op_star
id|from_cmdline
comma
r_char
op_star
id|from_cow
comma
r_char
op_star
id|cow
)paren
(brace
r_struct
id|uml_stat
id|buf1
comma
id|buf2
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|from_cmdline
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|from_cmdline
comma
id|from_cow
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|err
op_assign
id|os_stat_file
c_func
(paren
id|from_cmdline
comma
op_amp
id|buf1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Couldn&squot;t stat &squot;%s&squot;, err = %d&bslash;n&quot;
comma
id|from_cmdline
comma
op_minus
id|err
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|err
op_assign
id|os_stat_file
c_func
(paren
id|from_cow
comma
op_amp
id|buf2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Couldn&squot;t stat &squot;%s&squot;, err = %d&bslash;n&quot;
comma
id|from_cow
comma
op_minus
id|err
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|buf1.ust_dev
op_eq
id|buf2.ust_dev
)paren
op_logical_and
(paren
id|buf1.ust_ino
op_eq
id|buf2.ust_ino
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;Backing file mismatch - &bslash;&quot;%s&bslash;&quot; requested,&bslash;n&quot;
l_string|&quot;&bslash;&quot;%s&bslash;&quot; specified in COW header of &bslash;&quot;%s&bslash;&quot;&bslash;n&quot;
comma
id|from_cmdline
comma
id|from_cow
comma
id|cow
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|backing_file_mismatch
r_static
r_int
id|backing_file_mismatch
c_func
(paren
r_char
op_star
id|file
comma
id|__u64
id|size
comma
id|time_t
id|mtime
)paren
(brace
r_int
r_int
id|modtime
suffix:semicolon
r_int
r_int
id|actual
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
id|os_file_modtime
c_func
(paren
id|file
comma
op_amp
id|modtime
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to get modification time of backing file &quot;
l_string|&quot;&bslash;&quot;%s&bslash;&quot;, err = %d&bslash;n&quot;
comma
id|file
comma
op_minus
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|err
op_assign
id|os_file_size
c_func
(paren
id|file
comma
op_amp
id|actual
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to get size of backing file &bslash;&quot;%s&bslash;&quot;, &quot;
l_string|&quot;err = %d&bslash;n&quot;
comma
id|file
comma
op_minus
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|actual
op_ne
id|size
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Size mismatch (%ld vs %ld) of COW header vs backing &quot;
l_string|&quot;file&bslash;n&quot;
comma
id|size
comma
id|actual
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|modtime
op_ne
id|mtime
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;mtime mismatch (%ld vs %ld) of COW header vs backing &quot;
l_string|&quot;file&bslash;n&quot;
comma
id|mtime
comma
id|modtime
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|read_cow_bitmap
r_int
id|read_cow_bitmap
c_func
(paren
r_int
id|fd
comma
r_void
op_star
id|buf
comma
r_int
id|offset
comma
r_int
id|len
)paren
(brace
r_int
id|err
suffix:semicolon
id|err
op_assign
id|os_seek_file
c_func
(paren
id|fd
comma
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|err
op_assign
id|os_read_file
c_func
(paren
id|fd
comma
id|buf
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|open_ubd_file
r_int
id|open_ubd_file
c_func
(paren
r_char
op_star
id|file
comma
r_struct
id|openflags
op_star
id|openflags
comma
r_char
op_star
op_star
id|backing_file_out
comma
r_int
op_star
id|bitmap_offset_out
comma
r_int
r_int
op_star
id|bitmap_len_out
comma
r_int
op_star
id|data_offset_out
comma
r_int
op_star
id|create_cow_out
)paren
(brace
id|time_t
id|mtime
suffix:semicolon
r_int
r_int
r_int
id|size
suffix:semicolon
id|__u32
id|version
comma
id|align
suffix:semicolon
r_char
op_star
id|backing_file
suffix:semicolon
r_int
id|fd
comma
id|err
comma
id|sectorsize
comma
id|same
comma
id|mode
op_assign
l_int|0644
suffix:semicolon
id|fd
op_assign
id|os_open_file
c_func
(paren
id|file
comma
op_star
id|openflags
comma
id|mode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|fd
op_eq
op_minus
id|ENOENT
)paren
op_logical_and
(paren
id|create_cow_out
op_ne
l_int|NULL
)paren
)paren
(brace
op_star
id|create_cow_out
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|openflags-&gt;w
op_logical_or
(paren
(paren
id|errno
op_ne
id|EROFS
)paren
op_logical_and
(paren
id|errno
op_ne
id|EACCES
)paren
)paren
)paren
(brace
r_return
op_minus
id|errno
suffix:semicolon
)brace
id|openflags-&gt;w
op_assign
l_int|0
suffix:semicolon
id|fd
op_assign
id|os_open_file
c_func
(paren
id|file
comma
op_star
id|openflags
comma
id|mode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
OL
l_int|0
)paren
(brace
r_return
id|fd
suffix:semicolon
)brace
)brace
id|err
op_assign
id|os_lock_file
c_func
(paren
id|fd
comma
id|openflags-&gt;w
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to lock &squot;%s&squot;, err = %d&bslash;n&quot;
comma
id|file
comma
op_minus
id|err
)paren
suffix:semicolon
r_goto
id|out_close
suffix:semicolon
)brace
r_if
c_cond
(paren
id|backing_file_out
op_eq
l_int|NULL
)paren
(brace
r_return
id|fd
suffix:semicolon
)brace
id|err
op_assign
id|read_cow_header
c_func
(paren
id|file_reader
comma
op_amp
id|fd
comma
op_amp
id|version
comma
op_amp
id|backing_file
comma
op_amp
id|mtime
comma
op_amp
id|size
comma
op_amp
id|sectorsize
comma
op_amp
id|align
comma
id|bitmap_offset_out
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_logical_and
(paren
op_star
id|backing_file_out
op_ne
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to read COW header from COW file &bslash;&quot;%s&bslash;&quot;, &quot;
l_string|&quot;errno = %d&bslash;n&quot;
comma
id|file
comma
op_minus
id|err
)paren
suffix:semicolon
r_goto
id|out_close
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|fd
suffix:semicolon
)brace
r_if
c_cond
(paren
id|backing_file_out
op_eq
l_int|NULL
)paren
(brace
r_return
id|fd
suffix:semicolon
)brace
id|same
op_assign
id|same_backing_files
c_func
(paren
op_star
id|backing_file_out
comma
id|backing_file
comma
id|file
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|same
op_logical_and
op_logical_neg
id|backing_file_mismatch
c_func
(paren
op_star
id|backing_file_out
comma
id|size
comma
id|mtime
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Switching backing file to &squot;%s&squot;&bslash;n&quot;
comma
op_star
id|backing_file_out
)paren
suffix:semicolon
id|err
op_assign
id|write_cow_header
c_func
(paren
id|file
comma
id|fd
comma
op_star
id|backing_file_out
comma
id|sectorsize
comma
id|align
comma
op_amp
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Switch failed, errno = %d&bslash;n&quot;
comma
op_minus
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
)brace
r_else
(brace
op_star
id|backing_file_out
op_assign
id|backing_file
suffix:semicolon
id|err
op_assign
id|backing_file_mismatch
c_func
(paren
op_star
id|backing_file_out
comma
id|size
comma
id|mtime
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_goto
id|out_close
suffix:semicolon
)brace
)brace
id|cow_sizes
c_func
(paren
id|version
comma
id|size
comma
id|sectorsize
comma
id|align
comma
op_star
id|bitmap_offset_out
comma
id|bitmap_len_out
comma
id|data_offset_out
)paren
suffix:semicolon
r_return
id|fd
suffix:semicolon
id|out_close
suffix:colon
id|os_close_file
c_func
(paren
id|fd
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|create_cow_file
r_int
id|create_cow_file
c_func
(paren
r_char
op_star
id|cow_file
comma
r_char
op_star
id|backing_file
comma
r_struct
id|openflags
id|flags
comma
r_int
id|sectorsize
comma
r_int
id|alignment
comma
r_int
op_star
id|bitmap_offset_out
comma
r_int
r_int
op_star
id|bitmap_len_out
comma
r_int
op_star
id|data_offset_out
)paren
(brace
r_int
id|err
comma
id|fd
suffix:semicolon
id|flags.c
op_assign
l_int|1
suffix:semicolon
id|fd
op_assign
id|open_ubd_file
c_func
(paren
id|cow_file
comma
op_amp
id|flags
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
OL
l_int|0
)paren
(brace
id|err
op_assign
id|fd
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Open of COW file &squot;%s&squot; failed, errno = %d&bslash;n&quot;
comma
id|cow_file
comma
op_minus
id|err
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|err
op_assign
id|init_cow_file
c_func
(paren
id|fd
comma
id|cow_file
comma
id|backing_file
comma
id|sectorsize
comma
id|alignment
comma
id|bitmap_offset_out
comma
id|bitmap_len_out
comma
id|data_offset_out
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
r_return
id|fd
suffix:semicolon
)brace
id|os_close_file
c_func
(paren
id|fd
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* XXX Just trivial wrappers around os_read_file and os_write_file */
DECL|function|read_ubd_fs
r_int
id|read_ubd_fs
c_func
(paren
r_int
id|fd
comma
r_void
op_star
id|buffer
comma
r_int
id|len
)paren
(brace
r_return
id|os_read_file
c_func
(paren
id|fd
comma
id|buffer
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|write_ubd_fs
r_int
id|write_ubd_fs
c_func
(paren
r_int
id|fd
comma
r_char
op_star
id|buffer
comma
r_int
id|len
)paren
(brace
r_return
id|os_write_file
c_func
(paren
id|fd
comma
id|buffer
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|update_bitmap
r_static
r_int
id|update_bitmap
c_func
(paren
r_struct
id|io_thread_req
op_star
id|req
)paren
(brace
r_int
id|n
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;cow_offset
op_eq
op_minus
l_int|1
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|n
op_assign
id|os_seek_file
c_func
(paren
id|req-&gt;fds
(braket
l_int|1
)braket
comma
id|req-&gt;cow_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;do_io - bitmap lseek failed : err = %d&bslash;n&quot;
comma
op_minus
id|n
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|n
op_assign
id|os_write_file
c_func
(paren
id|req-&gt;fds
(braket
l_int|1
)braket
comma
op_amp
id|req-&gt;bitmap_words
comma
r_sizeof
(paren
id|req-&gt;bitmap_words
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
r_sizeof
(paren
id|req-&gt;bitmap_words
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;do_io - bitmap update failed, err = %d fd = %d&bslash;n&quot;
comma
op_minus
id|n
comma
id|req-&gt;fds
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|do_io
r_void
id|do_io
c_func
(paren
r_struct
id|io_thread_req
op_star
id|req
)paren
(brace
r_char
op_star
id|buf
suffix:semicolon
r_int
r_int
id|len
suffix:semicolon
r_int
id|n
comma
id|nsectors
comma
id|start
comma
id|end
comma
id|bit
suffix:semicolon
r_int
id|err
suffix:semicolon
id|__u64
id|off
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;op
op_eq
id|UBD_MMAP
)paren
(brace
multiline_comment|/* Touch the page to force the host to do any necessary IO to&n;&t;&t; * get it into memory&n;&t;&t; */
id|n
op_assign
op_star
(paren
(paren
r_volatile
r_int
op_star
)paren
id|req-&gt;buffer
)paren
suffix:semicolon
id|req-&gt;error
op_assign
id|update_bitmap
c_func
(paren
id|req
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|nsectors
op_assign
id|req-&gt;length
op_div
id|req-&gt;sectorsize
suffix:semicolon
id|start
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|bit
op_assign
id|ubd_test_bit
c_func
(paren
id|start
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|req-&gt;sector_mask
)paren
suffix:semicolon
id|end
op_assign
id|start
suffix:semicolon
r_while
c_loop
(paren
(paren
id|end
OL
id|nsectors
)paren
op_logical_and
(paren
id|ubd_test_bit
c_func
(paren
id|end
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|req-&gt;sector_mask
)paren
op_eq
id|bit
)paren
)paren
(brace
id|end
op_increment
suffix:semicolon
)brace
id|off
op_assign
id|req-&gt;offset
op_plus
id|req-&gt;offsets
(braket
id|bit
)braket
op_plus
id|start
op_star
id|req-&gt;sectorsize
suffix:semicolon
id|len
op_assign
(paren
id|end
op_minus
id|start
)paren
op_star
id|req-&gt;sectorsize
suffix:semicolon
id|buf
op_assign
op_amp
id|req-&gt;buffer
(braket
id|start
op_star
id|req-&gt;sectorsize
)braket
suffix:semicolon
id|err
op_assign
id|os_seek_file
c_func
(paren
id|req-&gt;fds
(braket
id|bit
)braket
comma
id|off
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;do_io - lseek failed : err = %d&bslash;n&quot;
comma
op_minus
id|err
)paren
suffix:semicolon
id|req-&gt;error
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req-&gt;op
op_eq
id|UBD_READ
)paren
(brace
id|n
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|buf
op_assign
op_amp
id|buf
(braket
id|n
)braket
suffix:semicolon
id|len
op_sub_assign
id|n
suffix:semicolon
id|n
op_assign
id|os_read_file
c_func
(paren
id|req-&gt;fds
(braket
id|bit
)braket
comma
id|buf
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;do_io - read failed, err = %d &quot;
l_string|&quot;fd = %d&bslash;n&quot;
comma
op_minus
id|n
comma
id|req-&gt;fds
(braket
id|bit
)braket
)paren
suffix:semicolon
id|req-&gt;error
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
(paren
id|n
OL
id|len
)paren
op_logical_and
(paren
id|n
op_ne
l_int|0
)paren
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n
OL
id|len
)paren
id|memset
c_func
(paren
op_amp
id|buf
(braket
id|n
)braket
comma
l_int|0
comma
id|len
op_minus
id|n
)paren
suffix:semicolon
)brace
r_else
(brace
id|n
op_assign
id|os_write_file
c_func
(paren
id|req-&gt;fds
(braket
id|bit
)braket
comma
id|buf
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
id|len
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;do_io - write failed err = %d &quot;
l_string|&quot;fd = %d&bslash;n&quot;
comma
op_minus
id|n
comma
id|req-&gt;fds
(braket
id|bit
)braket
)paren
suffix:semicolon
id|req-&gt;error
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|start
op_assign
id|end
suffix:semicolon
)brace
r_while
c_loop
(paren
id|start
OL
id|nsectors
)paren
(brace
suffix:semicolon
)brace
id|req-&gt;error
op_assign
id|update_bitmap
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
multiline_comment|/* Changed in start_io_thread, which is serialized by being called only&n; * from ubd_init, which is an initcall.&n; */
DECL|variable|kernel_fd
r_int
id|kernel_fd
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Only changed by the io thread */
DECL|variable|io_count
r_int
id|io_count
op_assign
l_int|0
suffix:semicolon
DECL|function|io_thread
r_int
id|io_thread
c_func
(paren
r_void
op_star
id|arg
)paren
(brace
r_struct
id|io_thread_req
id|req
suffix:semicolon
r_int
id|n
suffix:semicolon
id|signal
c_func
(paren
id|SIGWINCH
comma
id|SIG_IGN
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|n
op_assign
id|os_read_file
c_func
(paren
id|kernel_fd
comma
op_amp
id|req
comma
r_sizeof
(paren
id|req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
r_sizeof
(paren
id|req
)paren
)paren
(brace
r_if
c_cond
(paren
id|n
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;io_thread - read failed, fd = %d, &quot;
l_string|&quot;err = %d&bslash;n&quot;
comma
id|kernel_fd
comma
op_minus
id|n
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;io_thread - short read, fd = %d, &quot;
l_string|&quot;length = %d&bslash;n&quot;
comma
id|kernel_fd
comma
id|n
)paren
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
id|io_count
op_increment
suffix:semicolon
id|do_io
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
id|n
op_assign
id|os_write_file
c_func
(paren
id|kernel_fd
comma
op_amp
id|req
comma
r_sizeof
(paren
id|req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
r_sizeof
(paren
id|req
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;io_thread - write failed, fd = %d, err = %d&bslash;n&quot;
comma
id|kernel_fd
comma
op_minus
id|n
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|start_io_thread
r_int
id|start_io_thread
c_func
(paren
r_int
r_int
id|sp
comma
r_int
op_star
id|fd_out
)paren
(brace
r_int
id|pid
comma
id|fds
(braket
l_int|2
)braket
comma
id|err
suffix:semicolon
id|err
op_assign
id|os_pipe
c_func
(paren
id|fds
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;start_io_thread - os_pipe failed, err = %d&bslash;n&quot;
comma
op_minus
id|err
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|kernel_fd
op_assign
id|fds
(braket
l_int|0
)braket
suffix:semicolon
op_star
id|fd_out
op_assign
id|fds
(braket
l_int|1
)braket
suffix:semicolon
id|pid
op_assign
id|clone
c_func
(paren
id|io_thread
comma
(paren
r_void
op_star
)paren
id|sp
comma
id|CLONE_FILES
op_or
id|CLONE_VM
op_or
id|SIGCHLD
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pid
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;start_io_thread - clone failed : errno = %d&bslash;n&quot;
comma
id|errno
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|errno
suffix:semicolon
r_goto
id|out_close
suffix:semicolon
)brace
r_return
id|pid
suffix:semicolon
id|out_close
suffix:colon
id|os_close_file
c_func
(paren
id|fds
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|os_close_file
c_func
(paren
id|fds
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|kernel_fd
op_assign
op_minus
l_int|1
suffix:semicolon
op_star
id|fd_out
op_assign
op_minus
l_int|1
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-file-style: &quot;linux&quot;&n; * End:&n; */
eof
