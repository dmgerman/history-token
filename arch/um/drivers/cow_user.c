macro_line|#include &lt;stddef.h&gt;
macro_line|#include &lt;string.h&gt;
macro_line|#include &lt;errno.h&gt;
macro_line|#include &lt;unistd.h&gt;
macro_line|#include &lt;byteswap.h&gt;
macro_line|#include &lt;sys/time.h&gt;
macro_line|#include &lt;sys/param.h&gt;
macro_line|#include &lt;sys/user.h&gt;
macro_line|#include &lt;netinet/in.h&gt;
macro_line|#include &quot;os.h&quot;
macro_line|#include &quot;cow.h&quot;
macro_line|#include &quot;cow_sys.h&quot;
DECL|macro|PATH_LEN_V1
mdefine_line|#define PATH_LEN_V1 256
DECL|struct|cow_header_v1
r_struct
id|cow_header_v1
(brace
DECL|member|magic
r_int
id|magic
suffix:semicolon
DECL|member|version
r_int
id|version
suffix:semicolon
DECL|member|backing_file
r_char
id|backing_file
(braket
id|PATH_LEN_V1
)braket
suffix:semicolon
DECL|member|mtime
id|time_t
id|mtime
suffix:semicolon
DECL|member|size
id|__u64
id|size
suffix:semicolon
DECL|member|sectorsize
r_int
id|sectorsize
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|PATH_LEN_V2
mdefine_line|#define PATH_LEN_V2 MAXPATHLEN
DECL|struct|cow_header_v2
r_struct
id|cow_header_v2
(brace
DECL|member|magic
id|__u32
id|magic
suffix:semicolon
DECL|member|version
id|__u32
id|version
suffix:semicolon
DECL|member|backing_file
r_char
id|backing_file
(braket
id|PATH_LEN_V2
)braket
suffix:semicolon
DECL|member|mtime
id|time_t
id|mtime
suffix:semicolon
DECL|member|size
id|__u64
id|size
suffix:semicolon
DECL|member|sectorsize
r_int
id|sectorsize
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Define PATH_LEN_V3 as the usual value of MAXPATHLEN, just hard-code it in&n; * case other systems have different values for MAXPATHLEN&n; */
DECL|macro|PATH_LEN_V3
mdefine_line|#define PATH_LEN_V3 4096
multiline_comment|/* Changes from V2 -&n; *&t;PATH_LEN_V3 as described above&n; *&t;Explicitly specify field bit lengths for systems with different&n; *&t;&t;lengths for the usual C types.  Not sure whether char or&n; *&t;&t;time_t should be changed, this can be changed later without&n; *&t;&t;breaking compatibility&n; *&t;Add alignment field so that different alignments can be used for the&n; *&t;&t;bitmap and data&n; * &t;Add cow_format field to allow for the possibility of different ways&n; *&t;&t;of specifying the COW blocks.  For now, the only value is 0,&n; * &t;&t;for the traditional COW bitmap.&n; *&t;Move the backing_file field to the end of the header.  This allows&n; *&t;&t;for the possibility of expanding it into the padding required&n; *&t;&t;by the bitmap alignment.&n; * &t;The bitmap and data portions of the file will be aligned as specified&n; * &t;&t;by the alignment field.  This is to allow COW files to be&n; *&t;&t;put on devices with restrictions on access alignments, such as&n; *&t;&t;/dev/raw, with a 512 byte alignment restriction.  This also&n; *&t;&t;allows the data to be more aligned more strictly than on&n; *&t;&t;sector boundaries.  This is needed for ubd-mmap, which needs&n; *&t;&t;the data to be page aligned.&n; *&t;Fixed (finally!) the rounding bug&n; */
DECL|struct|cow_header_v3
r_struct
id|cow_header_v3
(brace
DECL|member|magic
id|__u32
id|magic
suffix:semicolon
DECL|member|version
id|__u32
id|version
suffix:semicolon
DECL|member|mtime
id|__u32
id|mtime
suffix:semicolon
DECL|member|size
id|__u64
id|size
suffix:semicolon
DECL|member|sectorsize
id|__u32
id|sectorsize
suffix:semicolon
DECL|member|alignment
id|__u32
id|alignment
suffix:semicolon
DECL|member|cow_format
id|__u32
id|cow_format
suffix:semicolon
DECL|member|backing_file
r_char
id|backing_file
(braket
id|PATH_LEN_V3
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* COW format definitions - for now, we have only the usual COW bitmap */
DECL|macro|COW_BITMAP
mdefine_line|#define COW_BITMAP 0
DECL|union|cow_header
r_union
id|cow_header
(brace
DECL|member|v1
r_struct
id|cow_header_v1
id|v1
suffix:semicolon
DECL|member|v2
r_struct
id|cow_header_v2
id|v2
suffix:semicolon
DECL|member|v3
r_struct
id|cow_header_v3
id|v3
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|COW_MAGIC
mdefine_line|#define COW_MAGIC 0x4f4f4f4d  /* MOOO */
DECL|macro|COW_VERSION
mdefine_line|#define COW_VERSION 3
DECL|macro|DIV_ROUND
mdefine_line|#define DIV_ROUND(x, len) (((x) + (len) - 1) / (len))
DECL|macro|ROUND_UP
mdefine_line|#define ROUND_UP(x, align) DIV_ROUND(x, align) * (align)
DECL|function|cow_sizes
r_void
id|cow_sizes
c_func
(paren
r_int
id|version
comma
id|__u64
id|size
comma
r_int
id|sectorsize
comma
r_int
id|align
comma
r_int
id|bitmap_offset
comma
r_int
r_int
op_star
id|bitmap_len_out
comma
r_int
op_star
id|data_offset_out
)paren
(brace
r_if
c_cond
(paren
id|version
OL
l_int|3
)paren
(brace
op_star
id|bitmap_len_out
op_assign
(paren
id|size
op_plus
id|sectorsize
op_minus
l_int|1
)paren
op_div
(paren
l_int|8
op_star
id|sectorsize
)paren
suffix:semicolon
op_star
id|data_offset_out
op_assign
id|bitmap_offset
op_plus
op_star
id|bitmap_len_out
suffix:semicolon
op_star
id|data_offset_out
op_assign
(paren
op_star
id|data_offset_out
op_plus
id|sectorsize
op_minus
l_int|1
)paren
op_div
id|sectorsize
suffix:semicolon
op_star
id|data_offset_out
op_mul_assign
id|sectorsize
suffix:semicolon
)brace
r_else
(brace
op_star
id|bitmap_len_out
op_assign
id|DIV_ROUND
c_func
(paren
id|size
comma
id|sectorsize
)paren
suffix:semicolon
op_star
id|bitmap_len_out
op_assign
id|DIV_ROUND
c_func
(paren
op_star
id|bitmap_len_out
comma
l_int|8
)paren
suffix:semicolon
op_star
id|data_offset_out
op_assign
id|bitmap_offset
op_plus
op_star
id|bitmap_len_out
suffix:semicolon
op_star
id|data_offset_out
op_assign
id|ROUND_UP
c_func
(paren
op_star
id|data_offset_out
comma
id|align
)paren
suffix:semicolon
)brace
)brace
DECL|function|absolutize
r_static
r_int
id|absolutize
c_func
(paren
r_char
op_star
id|to
comma
r_int
id|size
comma
r_char
op_star
id|from
)paren
(brace
r_char
id|save_cwd
(braket
l_int|256
)braket
comma
op_star
id|slash
suffix:semicolon
r_int
id|remaining
suffix:semicolon
r_if
c_cond
(paren
id|getcwd
c_func
(paren
id|save_cwd
comma
r_sizeof
(paren
id|save_cwd
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|cow_printf
c_func
(paren
l_string|&quot;absolutize : unable to get cwd - errno = %d&bslash;n&quot;
comma
id|errno
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|slash
op_assign
id|strrchr
c_func
(paren
id|from
comma
l_char|&squot;/&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slash
op_ne
l_int|NULL
)paren
(brace
op_star
id|slash
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|chdir
c_func
(paren
id|from
)paren
)paren
(brace
op_star
id|slash
op_assign
l_char|&squot;/&squot;
suffix:semicolon
id|cow_printf
c_func
(paren
l_string|&quot;absolutize : Can&squot;t cd to &squot;%s&squot; - &quot;
l_string|&quot;errno = %d&bslash;n&quot;
comma
id|from
comma
id|errno
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
op_star
id|slash
op_assign
l_char|&squot;/&squot;
suffix:semicolon
r_if
c_cond
(paren
id|getcwd
c_func
(paren
id|to
comma
id|size
)paren
op_eq
l_int|NULL
)paren
(brace
id|cow_printf
c_func
(paren
l_string|&quot;absolutize : unable to get cwd of &squot;%s&squot; - &quot;
l_string|&quot;errno = %d&bslash;n&quot;
comma
id|from
comma
id|errno
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|remaining
op_assign
id|size
op_minus
id|strlen
c_func
(paren
id|to
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|slash
)paren
op_plus
l_int|1
OG
id|remaining
)paren
(brace
id|cow_printf
c_func
(paren
l_string|&quot;absolutize : unable to fit &squot;%s&squot; into %d &quot;
l_string|&quot;chars&bslash;n&quot;
comma
id|from
comma
id|size
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|strcat
c_func
(paren
id|to
comma
id|slash
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|save_cwd
)paren
op_plus
l_int|1
op_plus
id|strlen
c_func
(paren
id|from
)paren
op_plus
l_int|1
OG
id|size
)paren
(brace
id|cow_printf
c_func
(paren
l_string|&quot;absolutize : unable to fit &squot;%s&squot; into %d &quot;
l_string|&quot;chars&bslash;n&quot;
comma
id|from
comma
id|size
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|to
comma
id|save_cwd
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|to
comma
l_string|&quot;/&quot;
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|to
comma
id|from
)paren
suffix:semicolon
)brace
id|chdir
c_func
(paren
id|save_cwd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|write_cow_header
r_int
id|write_cow_header
c_func
(paren
r_char
op_star
id|cow_file
comma
r_int
id|fd
comma
r_char
op_star
id|backing_file
comma
r_int
id|sectorsize
comma
r_int
id|alignment
comma
r_int
r_int
op_star
id|size
)paren
(brace
r_struct
id|cow_header_v3
op_star
id|header
suffix:semicolon
r_int
r_int
id|modtime
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
id|cow_seek_file
c_func
(paren
id|fd
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|cow_printf
c_func
(paren
l_string|&quot;write_cow_header - lseek failed, err = %d&bslash;n&quot;
comma
op_minus
id|err
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|header
op_assign
id|cow_malloc
c_func
(paren
r_sizeof
(paren
op_star
id|header
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|header
op_eq
l_int|NULL
)paren
(brace
id|cow_printf
c_func
(paren
l_string|&quot;Failed to allocate COW V3 header&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|header-&gt;magic
op_assign
id|htonl
c_func
(paren
id|COW_MAGIC
)paren
suffix:semicolon
id|header-&gt;version
op_assign
id|htonl
c_func
(paren
id|COW_VERSION
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|backing_file
)paren
OG
r_sizeof
(paren
id|header-&gt;backing_file
)paren
op_minus
l_int|1
)paren
(brace
id|cow_printf
c_func
(paren
l_string|&quot;Backing file name &bslash;&quot;%s&bslash;&quot; is too long - names are &quot;
l_string|&quot;limited to %d characters&bslash;n&quot;
comma
id|backing_file
comma
r_sizeof
(paren
id|header-&gt;backing_file
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
r_if
c_cond
(paren
id|absolutize
c_func
(paren
id|header-&gt;backing_file
comma
r_sizeof
(paren
id|header-&gt;backing_file
)paren
comma
id|backing_file
)paren
)paren
(brace
r_goto
id|out_free
suffix:semicolon
)brace
id|err
op_assign
id|os_file_modtime
c_func
(paren
id|header-&gt;backing_file
comma
op_amp
id|modtime
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|cow_printf
c_func
(paren
l_string|&quot;Backing file &squot;%s&squot; mtime request failed, &quot;
l_string|&quot;err = %d&bslash;n&quot;
comma
id|header-&gt;backing_file
comma
op_minus
id|err
)paren
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
id|err
op_assign
id|cow_file_size
c_func
(paren
id|header-&gt;backing_file
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|cow_printf
c_func
(paren
l_string|&quot;Couldn&squot;t get size of backing file &squot;%s&squot;, &quot;
l_string|&quot;err = %d&bslash;n&quot;
comma
id|header-&gt;backing_file
comma
op_minus
id|err
)paren
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
id|header-&gt;mtime
op_assign
id|htonl
c_func
(paren
id|modtime
)paren
suffix:semicolon
id|header-&gt;size
op_assign
id|htonll
c_func
(paren
op_star
id|size
)paren
suffix:semicolon
id|header-&gt;sectorsize
op_assign
id|htonl
c_func
(paren
id|sectorsize
)paren
suffix:semicolon
id|header-&gt;alignment
op_assign
id|htonl
c_func
(paren
id|alignment
)paren
suffix:semicolon
id|header-&gt;cow_format
op_assign
id|COW_BITMAP
suffix:semicolon
id|err
op_assign
id|os_write_file
c_func
(paren
id|fd
comma
id|header
comma
r_sizeof
(paren
op_star
id|header
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
r_sizeof
(paren
op_star
id|header
)paren
)paren
(brace
id|cow_printf
c_func
(paren
l_string|&quot;Write of header to new COW file &squot;%s&squot; failed, &quot;
l_string|&quot;err = %d&bslash;n&quot;
comma
id|cow_file
comma
op_minus
id|err
)paren
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
id|err
op_assign
l_int|0
suffix:semicolon
id|out_free
suffix:colon
id|cow_free
c_func
(paren
id|header
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|function|file_reader
r_int
id|file_reader
c_func
(paren
id|__u64
id|offset
comma
r_char
op_star
id|buf
comma
r_int
id|len
comma
r_void
op_star
id|arg
)paren
(brace
r_int
id|fd
op_assign
op_star
(paren
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
id|pread
c_func
(paren
id|fd
comma
id|buf
comma
id|len
comma
id|offset
)paren
suffix:semicolon
)brace
multiline_comment|/* XXX Need to sanity-check the values read from the header */
DECL|function|read_cow_header
r_int
id|read_cow_header
c_func
(paren
r_int
(paren
op_star
id|reader
)paren
(paren
id|__u64
comma
r_char
op_star
comma
r_int
comma
r_void
op_star
)paren
comma
r_void
op_star
id|arg
comma
id|__u32
op_star
id|version_out
comma
r_char
op_star
op_star
id|backing_file_out
comma
id|time_t
op_star
id|mtime_out
comma
id|__u64
op_star
id|size_out
comma
r_int
op_star
id|sectorsize_out
comma
id|__u32
op_star
id|align_out
comma
r_int
op_star
id|bitmap_offset_out
)paren
(brace
r_union
id|cow_header
op_star
id|header
suffix:semicolon
r_char
op_star
id|file
suffix:semicolon
r_int
id|err
comma
id|n
suffix:semicolon
r_int
r_int
id|version
comma
id|magic
suffix:semicolon
id|header
op_assign
id|cow_malloc
c_func
(paren
r_sizeof
(paren
op_star
id|header
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|header
op_eq
l_int|NULL
)paren
(brace
id|cow_printf
c_func
(paren
l_string|&quot;read_cow_header - Failed to allocate header&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|n
op_assign
(paren
op_star
id|reader
)paren
(paren
l_int|0
comma
(paren
r_char
op_star
)paren
id|header
comma
r_sizeof
(paren
op_star
id|header
)paren
comma
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
m_offsetof
(paren
id|typeof
c_func
(paren
id|header-&gt;v1
)paren
comma
id|backing_file
)paren
)paren
(brace
id|cow_printf
c_func
(paren
l_string|&quot;read_cow_header - short header&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|magic
op_assign
id|header-&gt;v1.magic
suffix:semicolon
r_if
c_cond
(paren
id|magic
op_eq
id|COW_MAGIC
)paren
(brace
id|version
op_assign
id|header-&gt;v1.version
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|magic
op_eq
id|ntohl
c_func
(paren
id|COW_MAGIC
)paren
)paren
(brace
id|version
op_assign
id|ntohl
c_func
(paren
id|header-&gt;v1.version
)paren
suffix:semicolon
)brace
multiline_comment|/* No error printed because the non-COW case comes through here */
r_else
r_goto
id|out
suffix:semicolon
op_star
id|version_out
op_assign
id|version
suffix:semicolon
r_if
c_cond
(paren
id|version
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|n
OL
r_sizeof
(paren
id|header-&gt;v1
)paren
)paren
(brace
id|cow_printf
c_func
(paren
l_string|&quot;read_cow_header - failed to read V1 &quot;
l_string|&quot;header&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
op_star
id|mtime_out
op_assign
id|header-&gt;v1.mtime
suffix:semicolon
op_star
id|size_out
op_assign
id|header-&gt;v1.size
suffix:semicolon
op_star
id|sectorsize_out
op_assign
id|header-&gt;v1.sectorsize
suffix:semicolon
op_star
id|bitmap_offset_out
op_assign
r_sizeof
(paren
id|header-&gt;v1
)paren
suffix:semicolon
op_star
id|align_out
op_assign
op_star
id|sectorsize_out
suffix:semicolon
id|file
op_assign
id|header-&gt;v1.backing_file
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|version
op_eq
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|n
OL
r_sizeof
(paren
id|header-&gt;v2
)paren
)paren
(brace
id|cow_printf
c_func
(paren
l_string|&quot;read_cow_header - failed to read V2 &quot;
l_string|&quot;header&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
op_star
id|mtime_out
op_assign
id|ntohl
c_func
(paren
id|header-&gt;v2.mtime
)paren
suffix:semicolon
op_star
id|size_out
op_assign
id|ntohll
c_func
(paren
id|header-&gt;v2.size
)paren
suffix:semicolon
op_star
id|sectorsize_out
op_assign
id|ntohl
c_func
(paren
id|header-&gt;v2.sectorsize
)paren
suffix:semicolon
op_star
id|bitmap_offset_out
op_assign
r_sizeof
(paren
id|header-&gt;v2
)paren
suffix:semicolon
op_star
id|align_out
op_assign
op_star
id|sectorsize_out
suffix:semicolon
id|file
op_assign
id|header-&gt;v2.backing_file
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|version
op_eq
l_int|3
)paren
(brace
r_if
c_cond
(paren
id|n
OL
r_sizeof
(paren
id|header-&gt;v3
)paren
)paren
(brace
id|cow_printf
c_func
(paren
l_string|&quot;read_cow_header - failed to read V2 &quot;
l_string|&quot;header&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
op_star
id|mtime_out
op_assign
id|ntohl
c_func
(paren
id|header-&gt;v3.mtime
)paren
suffix:semicolon
op_star
id|size_out
op_assign
id|ntohll
c_func
(paren
id|header-&gt;v3.size
)paren
suffix:semicolon
op_star
id|sectorsize_out
op_assign
id|ntohl
c_func
(paren
id|header-&gt;v3.sectorsize
)paren
suffix:semicolon
op_star
id|align_out
op_assign
id|ntohl
c_func
(paren
id|header-&gt;v3.alignment
)paren
suffix:semicolon
op_star
id|bitmap_offset_out
op_assign
id|ROUND_UP
c_func
(paren
r_sizeof
(paren
id|header-&gt;v3
)paren
comma
op_star
id|align_out
)paren
suffix:semicolon
id|file
op_assign
id|header-&gt;v3.backing_file
suffix:semicolon
)brace
r_else
(brace
id|cow_printf
c_func
(paren
l_string|&quot;read_cow_header - invalid COW version&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
op_star
id|backing_file_out
op_assign
id|cow_strdup
c_func
(paren
id|file
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|backing_file_out
op_eq
l_int|NULL
)paren
(brace
id|cow_printf
c_func
(paren
l_string|&quot;read_cow_header - failed to allocate backing &quot;
l_string|&quot;file&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|err
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|cow_free
c_func
(paren
id|header
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|init_cow_file
r_int
id|init_cow_file
c_func
(paren
r_int
id|fd
comma
r_char
op_star
id|cow_file
comma
r_char
op_star
id|backing_file
comma
r_int
id|sectorsize
comma
r_int
id|alignment
comma
r_int
op_star
id|bitmap_offset_out
comma
r_int
r_int
op_star
id|bitmap_len_out
comma
r_int
op_star
id|data_offset_out
)paren
(brace
id|__u64
id|size
comma
id|offset
suffix:semicolon
r_char
id|zero
op_assign
l_int|0
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
id|write_cow_header
c_func
(paren
id|cow_file
comma
id|fd
comma
id|backing_file
comma
id|sectorsize
comma
id|alignment
comma
op_amp
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
op_star
id|bitmap_offset_out
op_assign
id|ROUND_UP
c_func
(paren
r_sizeof
(paren
r_struct
id|cow_header_v3
)paren
comma
id|alignment
)paren
suffix:semicolon
id|cow_sizes
c_func
(paren
id|COW_VERSION
comma
id|size
comma
id|sectorsize
comma
id|alignment
comma
op_star
id|bitmap_offset_out
comma
id|bitmap_len_out
comma
id|data_offset_out
)paren
suffix:semicolon
id|offset
op_assign
op_star
id|data_offset_out
op_plus
id|size
op_minus
r_sizeof
(paren
id|zero
)paren
suffix:semicolon
id|err
op_assign
id|cow_seek_file
c_func
(paren
id|fd
comma
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|cow_printf
c_func
(paren
l_string|&quot;cow bitmap lseek failed : err = %d&bslash;n&quot;
comma
op_minus
id|err
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* does not really matter how much we write it is just to set EOF&n;&t; * this also sets the entire COW bitmap&n;&t; * to zero without having to allocate it&n;&t; */
id|err
op_assign
id|cow_write_file
c_func
(paren
id|fd
comma
op_amp
id|zero
comma
r_sizeof
(paren
id|zero
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
r_sizeof
(paren
id|zero
)paren
)paren
(brace
id|cow_printf
c_func
(paren
l_string|&quot;Write of bitmap to new COW file &squot;%s&squot; failed, &quot;
l_string|&quot;err = %d&bslash;n&quot;
comma
id|cow_file
comma
op_minus
id|err
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-file-style: &quot;linux&quot;&n; * End:&n; */
eof
