multiline_comment|/* &n; * Copyright (C) 2000 Jeff Dike (jdike@karaya.com)&n; * Licensed under the GPL&n; */
multiline_comment|/* 2001-09-28...2002-04-17&n; * Partition stuff by James_McMechan@hotmail.com&n; * old style ubd by setting UBD_SHIFT to 0&n; * 2002-09-27...2002-10-18 massive tinkering for 2.5&n; * partitions have changed in 2.5&n; * 2003-01-29 more tinkering for 2.5.59-1&n; * This should now address the sysfs problems and has&n; * the symlink for devfs to allow for booting with&n; * the common /dev/ubd/discX/... names rather than&n; * only /dev/ubdN/discN this version also has lots of&n; * clean ups preparing for ubd-many.&n; * James McMechan&n; */
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR UBD_MAJOR
DECL|macro|UBD_SHIFT
mdefine_line|#define UBD_SHIFT 4
macro_line|#include &quot;linux/config.h&quot;
macro_line|#include &quot;linux/module.h&quot;
macro_line|#include &quot;linux/blkdev.h&quot;
macro_line|#include &quot;linux/hdreg.h&quot;
macro_line|#include &quot;linux/init.h&quot;
macro_line|#include &quot;linux/devfs_fs_kernel.h&quot;
macro_line|#include &quot;linux/cdrom.h&quot;
macro_line|#include &quot;linux/proc_fs.h&quot;
macro_line|#include &quot;linux/ctype.h&quot;
macro_line|#include &quot;linux/capability.h&quot;
macro_line|#include &quot;linux/mm.h&quot;
macro_line|#include &quot;linux/vmalloc.h&quot;
macro_line|#include &quot;linux/blkpg.h&quot;
macro_line|#include &quot;linux/genhd.h&quot;
macro_line|#include &quot;linux/spinlock.h&quot;
macro_line|#include &quot;asm/segment.h&quot;
macro_line|#include &quot;asm/uaccess.h&quot;
macro_line|#include &quot;asm/irq.h&quot;
macro_line|#include &quot;asm/types.h&quot;
macro_line|#include &quot;asm/tlbflush.h&quot;
macro_line|#include &quot;user_util.h&quot;
macro_line|#include &quot;mem_user.h&quot;
macro_line|#include &quot;kern_util.h&quot;
macro_line|#include &quot;kern.h&quot;
macro_line|#include &quot;mconsole_kern.h&quot;
macro_line|#include &quot;init.h&quot;
macro_line|#include &quot;irq_user.h&quot;
macro_line|#include &quot;irq_kern.h&quot;
macro_line|#include &quot;ubd_user.h&quot;
macro_line|#include &quot;2_5compat.h&quot;
macro_line|#include &quot;os.h&quot;
macro_line|#include &quot;mem.h&quot;
macro_line|#include &quot;mem_kern.h&quot;
DECL|variable|ubd_io_lock
r_static
id|spinlock_t
id|ubd_io_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|ubd_lock
r_static
id|spinlock_t
id|ubd_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|do_ubd
r_static
r_void
(paren
op_star
id|do_ubd
)paren
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|ubd_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_int
id|ubd_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|ubd_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
DECL|macro|MAX_DEV
mdefine_line|#define MAX_DEV (8)
multiline_comment|/* Changed in early boot */
DECL|variable|ubd_do_mmap
r_static
r_int
id|ubd_do_mmap
op_assign
l_int|0
suffix:semicolon
DECL|macro|UBD_MMAP_BLOCK_SIZE
mdefine_line|#define UBD_MMAP_BLOCK_SIZE PAGE_SIZE
DECL|variable|ubd_blops
r_static
r_struct
id|block_device_operations
id|ubd_blops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|open
op_assign
id|ubd_open
comma
dot
id|release
op_assign
id|ubd_release
comma
dot
id|ioctl
op_assign
id|ubd_ioctl
comma
)brace
suffix:semicolon
multiline_comment|/* Protected by the queue_lock */
DECL|variable|ubd_queue
r_static
id|request_queue_t
op_star
id|ubd_queue
suffix:semicolon
multiline_comment|/* Protected by ubd_lock */
DECL|variable|fake_major
r_static
r_int
id|fake_major
op_assign
id|MAJOR_NR
suffix:semicolon
DECL|variable|ubd_gendisk
r_static
r_struct
id|gendisk
op_star
id|ubd_gendisk
(braket
id|MAX_DEV
)braket
suffix:semicolon
DECL|variable|fake_gendisk
r_static
r_struct
id|gendisk
op_star
id|fake_gendisk
(braket
id|MAX_DEV
)braket
suffix:semicolon
macro_line|#ifdef CONFIG_BLK_DEV_UBD_SYNC
DECL|macro|OPEN_FLAGS
mdefine_line|#define OPEN_FLAGS ((struct openflags) { .r = 1, .w = 1, .s = 1, .c = 0, &bslash;&n;&t;&t;&t;&t;&t; .cl = 1 })
macro_line|#else
DECL|macro|OPEN_FLAGS
mdefine_line|#define OPEN_FLAGS ((struct openflags) { .r = 1, .w = 1, .s = 0, .c = 0, &bslash;&n;&t;&t;&t;&t;&t; .cl = 1 })
macro_line|#endif
multiline_comment|/* Not protected - changed only in ubd_setup_common and then only to&n; * to enable O_SYNC.&n; */
DECL|variable|global_openflags
r_static
r_struct
id|openflags
id|global_openflags
op_assign
id|OPEN_FLAGS
suffix:semicolon
DECL|struct|cow
r_struct
id|cow
(brace
DECL|member|file
r_char
op_star
id|file
suffix:semicolon
DECL|member|fd
r_int
id|fd
suffix:semicolon
DECL|member|bitmap
r_int
r_int
op_star
id|bitmap
suffix:semicolon
DECL|member|bitmap_len
r_int
r_int
id|bitmap_len
suffix:semicolon
DECL|member|bitmap_offset
r_int
id|bitmap_offset
suffix:semicolon
DECL|member|data_offset
r_int
id|data_offset
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|ubd
r_struct
id|ubd
(brace
DECL|member|file
r_char
op_star
id|file
suffix:semicolon
DECL|member|count
r_int
id|count
suffix:semicolon
DECL|member|fd
r_int
id|fd
suffix:semicolon
DECL|member|size
id|__u64
id|size
suffix:semicolon
DECL|member|boot_openflags
r_struct
id|openflags
id|boot_openflags
suffix:semicolon
DECL|member|openflags
r_struct
id|openflags
id|openflags
suffix:semicolon
DECL|member|no_cow
r_int
id|no_cow
suffix:semicolon
DECL|member|cow
r_struct
id|cow
id|cow
suffix:semicolon
DECL|member|map_writes
r_int
id|map_writes
suffix:semicolon
DECL|member|map_reads
r_int
id|map_reads
suffix:semicolon
DECL|member|nomap_writes
r_int
id|nomap_writes
suffix:semicolon
DECL|member|nomap_reads
r_int
id|nomap_reads
suffix:semicolon
DECL|member|write_maps
r_int
id|write_maps
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|DEFAULT_COW
mdefine_line|#define DEFAULT_COW { &bslash;&n;&t;.file =&t;&t;&t;NULL, &bslash;&n;        .fd =&t;&t;&t;-1, &bslash;&n;        .bitmap =&t;&t;NULL, &bslash;&n;&t;.bitmap_offset =&t;0, &bslash;&n;        .data_offset =&t;&t;0, &bslash;&n;}
DECL|macro|DEFAULT_UBD
mdefine_line|#define DEFAULT_UBD { &bslash;&n;&t;.file = &t;&t;NULL, &bslash;&n;&t;.count =&t;&t;0, &bslash;&n;&t;.fd =&t;&t;&t;-1, &bslash;&n;&t;.size =&t;&t;&t;-1, &bslash;&n;&t;.boot_openflags =&t;OPEN_FLAGS, &bslash;&n;&t;.openflags =&t;&t;OPEN_FLAGS, &bslash;&n;        .no_cow =               0, &bslash;&n;        .cow =&t;&t;&t;DEFAULT_COW, &bslash;&n;&t;.map_writes&t;&t;= 0, &bslash;&n;&t;.map_reads&t;&t;= 0, &bslash;&n;&t;.nomap_writes&t;&t;= 0, &bslash;&n;&t;.nomap_reads&t;&t;= 0, &bslash;&n;&t;.write_maps&t;&t;= 0, &bslash;&n;}
DECL|variable|ubd_dev
r_struct
id|ubd
id|ubd_dev
(braket
id|MAX_DEV
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
id|MAX_DEV
op_minus
l_int|1
)braket
op_assign
id|DEFAULT_UBD
)brace
suffix:semicolon
DECL|function|ubd0_init
r_static
r_int
id|ubd0_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|ubd
op_star
id|dev
op_assign
op_amp
id|ubd_dev
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;file
op_eq
l_int|NULL
)paren
(brace
id|dev-&gt;file
op_assign
l_string|&quot;root_fs&quot;
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ubd0_init
id|__initcall
c_func
(paren
id|ubd0_init
)paren
suffix:semicolon
multiline_comment|/* Only changed by fake_ide_setup which is a setup */
DECL|variable|fake_ide
r_static
r_int
id|fake_ide
op_assign
l_int|0
suffix:semicolon
DECL|variable|proc_ide_root
r_static
r_struct
id|proc_dir_entry
op_star
id|proc_ide_root
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|proc_ide
r_static
r_struct
id|proc_dir_entry
op_star
id|proc_ide
op_assign
l_int|NULL
suffix:semicolon
DECL|function|make_proc_ide
r_static
r_void
id|make_proc_ide
c_func
(paren
r_void
)paren
(brace
id|proc_ide_root
op_assign
id|proc_mkdir
c_func
(paren
l_string|&quot;ide&quot;
comma
l_int|0
)paren
suffix:semicolon
id|proc_ide
op_assign
id|proc_mkdir
c_func
(paren
l_string|&quot;ide0&quot;
comma
id|proc_ide_root
)paren
suffix:semicolon
)brace
DECL|function|proc_ide_read_media
r_static
r_int
id|proc_ide_read_media
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|len
suffix:semicolon
id|strcpy
c_func
(paren
id|page
comma
l_string|&quot;disk&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_assign
id|strlen
c_func
(paren
l_string|&quot;disk&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_sub_assign
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|count
)paren
(brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|len
op_assign
id|count
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|make_ide_entries
r_static
r_void
id|make_ide_entries
c_func
(paren
r_char
op_star
id|dev_name
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|dir
comma
op_star
id|ent
suffix:semicolon
r_char
id|name
(braket
l_int|64
)braket
suffix:semicolon
r_if
c_cond
(paren
id|proc_ide_root
op_eq
l_int|NULL
)paren
(brace
id|make_proc_ide
c_func
(paren
)paren
suffix:semicolon
)brace
id|dir
op_assign
id|proc_mkdir
c_func
(paren
id|dev_name
comma
id|proc_ide
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dir
)paren
(brace
r_return
suffix:semicolon
)brace
id|ent
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;media&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ent
)paren
(brace
r_return
suffix:semicolon
)brace
id|ent-&gt;nlink
op_assign
l_int|1
suffix:semicolon
id|ent-&gt;data
op_assign
l_int|NULL
suffix:semicolon
id|ent-&gt;read_proc
op_assign
id|proc_ide_read_media
suffix:semicolon
id|ent-&gt;write_proc
op_assign
l_int|NULL
suffix:semicolon
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;ide0/%s&quot;
comma
id|dev_name
)paren
suffix:semicolon
id|proc_symlink
c_func
(paren
id|dev_name
comma
id|proc_ide_root
comma
id|name
)paren
suffix:semicolon
)brace
DECL|function|fake_ide_setup
r_static
r_int
id|fake_ide_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
id|fake_ide
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;fake_ide&quot;
comma
id|fake_ide_setup
)paren
suffix:semicolon
id|__uml_help
c_func
(paren
id|fake_ide_setup
comma
l_string|&quot;fake_ide&bslash;n&quot;
l_string|&quot;    Create ide0 entries that map onto ubd devices.&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
DECL|function|parse_unit
r_static
r_int
id|parse_unit
c_func
(paren
r_char
op_star
op_star
id|ptr
)paren
(brace
r_char
op_star
id|str
op_assign
op_star
id|ptr
comma
op_star
id|end
suffix:semicolon
r_int
id|n
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|isdigit
c_func
(paren
op_star
id|str
)paren
)paren
(brace
id|n
op_assign
id|simple_strtoul
c_func
(paren
id|str
comma
op_amp
id|end
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|end
op_eq
id|str
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
op_star
id|ptr
op_assign
id|end
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
l_char|&squot;a&squot;
op_le
op_star
id|str
)paren
op_logical_and
(paren
op_star
id|str
op_le
l_char|&squot;h&squot;
)paren
)paren
(brace
id|n
op_assign
op_star
id|str
op_minus
l_char|&squot;a&squot;
suffix:semicolon
id|str
op_increment
suffix:semicolon
op_star
id|ptr
op_assign
id|str
suffix:semicolon
)brace
r_return
id|n
suffix:semicolon
)brace
DECL|function|ubd_setup_common
r_static
r_int
id|ubd_setup_common
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|index_out
)paren
(brace
r_struct
id|ubd
op_star
id|dev
suffix:semicolon
r_struct
id|openflags
id|flags
op_assign
id|global_openflags
suffix:semicolon
r_char
op_star
id|backing_file
suffix:semicolon
r_int
id|n
comma
id|err
suffix:semicolon
r_if
c_cond
(paren
id|index_out
)paren
(brace
op_star
id|index_out
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|n
op_assign
op_star
id|str
suffix:semicolon
r_if
c_cond
(paren
id|n
op_eq
l_char|&squot;=&squot;
)paren
(brace
r_char
op_star
id|end
suffix:semicolon
r_int
id|major
suffix:semicolon
id|str
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|str
comma
l_string|&quot;mmap&quot;
)paren
)paren
(brace
id|CHOOSE_MODE
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;mmap not supported by the ubd &quot;
l_string|&quot;driver in tt mode&bslash;n&quot;
)paren
comma
id|ubd_do_mmap
op_assign
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|str
comma
l_string|&quot;sync&quot;
)paren
)paren
(brace
id|global_openflags.s
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|major
op_assign
id|simple_strtoul
c_func
(paren
id|str
comma
op_amp
id|end
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|end
op_ne
l_char|&squot;&bslash;0&squot;
)paren
op_logical_or
(paren
id|end
op_eq
id|str
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ubd_setup : didn&squot;t parse major number&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|err
op_assign
l_int|1
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|ubd_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fake_major
op_ne
id|MAJOR_NR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Can&squot;t assign a fake major twice&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out1
suffix:semicolon
)brace
id|fake_major
op_assign
id|major
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Setting extra ubd major number to %d&bslash;n&quot;
comma
id|major
)paren
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
id|out1
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|ubd_lock
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|n
op_assign
id|parse_unit
c_func
(paren
op_amp
id|str
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ubd_setup : couldn&squot;t parse unit number &quot;
l_string|&quot;&squot;%s&squot;&bslash;n&quot;
comma
id|str
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n
op_ge
id|MAX_DEV
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ubd_setup : index %d out of range &quot;
l_string|&quot;(%d devices)&bslash;n&quot;
comma
id|n
comma
id|MAX_DEV
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|err
op_assign
l_int|1
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|ubd_lock
)paren
suffix:semicolon
id|dev
op_assign
op_amp
id|ubd_dev
(braket
id|n
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;file
op_ne
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ubd_setup : device already configured&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|index_out
)paren
(brace
op_star
id|index_out
op_assign
id|n
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|str
op_eq
l_char|&squot;r&squot;
)paren
(brace
id|flags.w
op_assign
l_int|0
suffix:semicolon
id|str
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|str
op_eq
l_char|&squot;s&squot;
)paren
(brace
id|flags.s
op_assign
l_int|1
suffix:semicolon
id|str
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|str
op_eq
l_char|&squot;d&squot;
)paren
(brace
id|dev-&gt;no_cow
op_assign
l_int|1
suffix:semicolon
id|str
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|str
op_increment
op_ne
l_char|&squot;=&squot;
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ubd_setup : Expected &squot;=&squot;&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
id|err
op_assign
l_int|0
suffix:semicolon
id|backing_file
op_assign
id|strchr
c_func
(paren
id|str
comma
l_char|&squot;,&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|backing_file
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;no_cow
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Can&squot;t specify both &squot;d&squot; and a &quot;
l_string|&quot;cow file&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
op_star
id|backing_file
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|backing_file
op_increment
suffix:semicolon
)brace
)brace
id|dev-&gt;file
op_assign
id|str
suffix:semicolon
id|dev-&gt;cow.file
op_assign
id|backing_file
suffix:semicolon
id|dev-&gt;boot_openflags
op_assign
id|flags
suffix:semicolon
id|out2
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|ubd_lock
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|ubd_setup
r_static
r_int
id|ubd_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
id|ubd_setup_common
c_func
(paren
id|str
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;ubd&quot;
comma
id|ubd_setup
)paren
suffix:semicolon
id|__uml_help
c_func
(paren
id|ubd_setup
comma
l_string|&quot;ubd&lt;n&gt;=&lt;filename&gt;&bslash;n&quot;
l_string|&quot;    This is used to associate a device with a file in the underlying&bslash;n&quot;
l_string|&quot;    filesystem. Usually, there is a filesystem in the file, but &bslash;n&quot;
l_string|&quot;    that&squot;s not required. Swap devices containing swap files can be&bslash;n&quot;
l_string|&quot;    specified like this. Also, a file which doesn&squot;t contain a&bslash;n&quot;
l_string|&quot;    filesystem can have its contents read in the virtual &bslash;n&quot;
l_string|&quot;    machine by running dd on the device. n must be in the range&bslash;n&quot;
l_string|&quot;    0 to 7. Appending an &squot;r&squot; to the number will cause that device&bslash;n&quot;
l_string|&quot;    to be mounted read-only. For example ubd1r=./ext_fs. Appending&bslash;n&quot;
l_string|&quot;    an &squot;s&squot; (has to be _after_ &squot;r&squot;, if there is one) will cause data&bslash;n&quot;
l_string|&quot;    to be written to disk on the host immediately.&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
DECL|variable|fakehd_set
r_static
r_int
id|fakehd_set
op_assign
l_int|0
suffix:semicolon
DECL|function|fakehd
r_static
r_int
id|fakehd
c_func
(paren
r_char
op_star
id|str
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;fakehd : Changing ubd name to &bslash;&quot;hd&bslash;&quot;.&bslash;n&quot;
)paren
suffix:semicolon
id|fakehd_set
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;fakehd&quot;
comma
id|fakehd
)paren
suffix:semicolon
id|__uml_help
c_func
(paren
id|fakehd
comma
l_string|&quot;fakehd&bslash;n&quot;
l_string|&quot;    Change the ubd device name to &bslash;&quot;hd&bslash;&quot;.&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
r_static
r_void
id|do_ubd_request
c_func
(paren
id|request_queue_t
op_star
id|q
)paren
suffix:semicolon
multiline_comment|/* Only changed by ubd_init, which is an initcall. */
DECL|variable|thread_fd
r_int
id|thread_fd
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Changed by ubd_handler, which is serialized because interrupts only&n; * happen on CPU 0.&n; */
DECL|variable|intr_count
r_int
id|intr_count
op_assign
l_int|0
suffix:semicolon
DECL|function|ubd_finish
r_static
r_void
id|ubd_finish
c_func
(paren
r_struct
id|request
op_star
id|req
comma
r_int
id|error
)paren
(brace
r_int
id|nsect
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|ubd_io_lock
)paren
suffix:semicolon
id|end_request
c_func
(paren
id|req
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ubd_io_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|nsect
op_assign
id|req-&gt;current_nr_sectors
suffix:semicolon
id|req-&gt;sector
op_add_assign
id|nsect
suffix:semicolon
id|req-&gt;buffer
op_add_assign
id|nsect
op_lshift
l_int|9
suffix:semicolon
id|req-&gt;errors
op_assign
l_int|0
suffix:semicolon
id|req-&gt;nr_sectors
op_sub_assign
id|nsect
suffix:semicolon
id|req-&gt;current_nr_sectors
op_assign
l_int|0
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|ubd_io_lock
)paren
suffix:semicolon
id|end_request
c_func
(paren
id|req
comma
l_int|1
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ubd_io_lock
)paren
suffix:semicolon
)brace
DECL|function|ubd_handler
r_static
r_void
id|ubd_handler
c_func
(paren
r_void
)paren
(brace
r_struct
id|io_thread_req
id|req
suffix:semicolon
r_struct
id|request
op_star
id|rq
op_assign
id|elv_next_request
c_func
(paren
id|ubd_queue
)paren
suffix:semicolon
r_int
id|n
comma
id|err
suffix:semicolon
id|do_ubd
op_assign
l_int|NULL
suffix:semicolon
id|intr_count
op_increment
suffix:semicolon
id|n
op_assign
id|read_ubd_fs
c_func
(paren
id|thread_fd
comma
op_amp
id|req
comma
r_sizeof
(paren
id|req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
r_sizeof
(paren
id|req
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Pid %d - spurious interrupt in ubd_handler, &quot;
l_string|&quot;err = %d&bslash;n&quot;
comma
id|os_getpid
c_func
(paren
)paren
comma
op_minus
id|n
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|ubd_io_lock
)paren
suffix:semicolon
id|end_request
c_func
(paren
id|rq
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ubd_io_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|req.op
op_ne
id|UBD_MMAP
)paren
op_logical_and
(paren
(paren
id|req.offset
op_ne
(paren
(paren
id|__u64
)paren
(paren
id|rq-&gt;sector
)paren
)paren
op_lshift
l_int|9
)paren
op_logical_or
(paren
id|req.length
op_ne
(paren
id|rq-&gt;current_nr_sectors
)paren
op_lshift
l_int|9
)paren
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;I/O op mismatch&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req.map_fd
op_ne
op_minus
l_int|1
)paren
(brace
id|err
op_assign
id|physmem_subst_mapping
c_func
(paren
id|req.buffer
comma
id|req.map_fd
comma
id|req.map_offset
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ubd_handler - physmem_subst_mapping failed, &quot;
l_string|&quot;err = %d&bslash;n&quot;
comma
op_minus
id|err
)paren
suffix:semicolon
)brace
)brace
id|ubd_finish
c_func
(paren
id|rq
comma
id|req.error
)paren
suffix:semicolon
id|reactivate_fd
c_func
(paren
id|thread_fd
comma
id|UBD_IRQ
)paren
suffix:semicolon
id|do_ubd_request
c_func
(paren
id|ubd_queue
)paren
suffix:semicolon
)brace
DECL|function|ubd_intr
r_static
id|irqreturn_t
id|ubd_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev
comma
r_struct
id|pt_regs
op_star
id|unused
)paren
(brace
id|ubd_handler
c_func
(paren
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* Only changed by ubd_init, which is an initcall. */
DECL|variable|io_pid
r_static
r_int
id|io_pid
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|function|kill_io_thread
r_void
id|kill_io_thread
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|io_pid
op_ne
op_minus
l_int|1
)paren
(brace
id|os_kill_process
c_func
(paren
id|io_pid
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
DECL|variable|kill_io_thread
id|__uml_exitcall
c_func
(paren
id|kill_io_thread
)paren
suffix:semicolon
DECL|function|ubd_file_size
r_static
r_int
id|ubd_file_size
c_func
(paren
r_struct
id|ubd
op_star
id|dev
comma
id|__u64
op_star
id|size_out
)paren
(brace
r_char
op_star
id|file
suffix:semicolon
id|file
op_assign
id|dev-&gt;cow.file
ques
c_cond
id|dev-&gt;cow.file
suffix:colon
id|dev-&gt;file
suffix:semicolon
r_return
id|os_file_size
c_func
(paren
id|file
comma
id|size_out
)paren
suffix:semicolon
)brace
DECL|function|ubd_close
r_static
r_void
id|ubd_close
c_func
(paren
r_struct
id|ubd
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|ubd_do_mmap
)paren
(brace
id|physmem_forget_descriptor
c_func
(paren
id|dev-&gt;fd
)paren
suffix:semicolon
)brace
id|os_close_file
c_func
(paren
id|dev-&gt;fd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;cow.file
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ubd_do_mmap
)paren
(brace
id|physmem_forget_descriptor
c_func
(paren
id|dev-&gt;cow.fd
)paren
suffix:semicolon
)brace
id|os_close_file
c_func
(paren
id|dev-&gt;cow.fd
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|dev-&gt;cow.bitmap
)paren
suffix:semicolon
id|dev-&gt;cow.bitmap
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|ubd_open_dev
r_static
r_int
id|ubd_open_dev
c_func
(paren
r_struct
id|ubd
op_star
id|dev
)paren
(brace
r_struct
id|openflags
id|flags
suffix:semicolon
r_char
op_star
op_star
id|back_ptr
suffix:semicolon
r_int
id|err
comma
id|create_cow
comma
op_star
id|create_ptr
suffix:semicolon
id|dev-&gt;openflags
op_assign
id|dev-&gt;boot_openflags
suffix:semicolon
id|create_cow
op_assign
l_int|0
suffix:semicolon
id|create_ptr
op_assign
(paren
id|dev-&gt;cow.file
op_ne
l_int|NULL
)paren
ques
c_cond
op_amp
id|create_cow
suffix:colon
l_int|NULL
suffix:semicolon
id|back_ptr
op_assign
id|dev-&gt;no_cow
ques
c_cond
l_int|NULL
suffix:colon
op_amp
id|dev-&gt;cow.file
suffix:semicolon
id|dev-&gt;fd
op_assign
id|open_ubd_file
c_func
(paren
id|dev-&gt;file
comma
op_amp
id|dev-&gt;openflags
comma
id|back_ptr
comma
op_amp
id|dev-&gt;cow.bitmap_offset
comma
op_amp
id|dev-&gt;cow.bitmap_len
comma
op_amp
id|dev-&gt;cow.data_offset
comma
id|create_ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;fd
op_eq
op_minus
id|ENOENT
)paren
op_logical_and
id|create_cow
)paren
(brace
id|dev-&gt;fd
op_assign
id|create_cow_file
c_func
(paren
id|dev-&gt;file
comma
id|dev-&gt;cow.file
comma
id|dev-&gt;openflags
comma
l_int|1
op_lshift
l_int|9
comma
id|PAGE_SIZE
comma
op_amp
id|dev-&gt;cow.bitmap_offset
comma
op_amp
id|dev-&gt;cow.bitmap_len
comma
op_amp
id|dev-&gt;cow.data_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;fd
op_ge
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Creating &bslash;&quot;%s&bslash;&quot; as COW file for &quot;
l_string|&quot;&bslash;&quot;%s&bslash;&quot;&bslash;n&quot;
comma
id|dev-&gt;file
comma
id|dev-&gt;cow.file
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dev-&gt;fd
OL
l_int|0
)paren
(brace
r_return
id|dev-&gt;fd
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;cow.file
op_ne
l_int|NULL
)paren
(brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|dev-&gt;cow.bitmap
op_assign
(paren
r_void
op_star
)paren
id|vmalloc
c_func
(paren
id|dev-&gt;cow.bitmap_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;cow.bitmap
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Failed to vmalloc COW bitmap&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|flush_tlb_kernel_vm
c_func
(paren
)paren
suffix:semicolon
id|err
op_assign
id|read_cow_bitmap
c_func
(paren
id|dev-&gt;fd
comma
id|dev-&gt;cow.bitmap
comma
id|dev-&gt;cow.bitmap_offset
comma
id|dev-&gt;cow.bitmap_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_goto
id|error
suffix:semicolon
)brace
id|flags
op_assign
id|dev-&gt;openflags
suffix:semicolon
id|flags.w
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|open_ubd_file
c_func
(paren
id|dev-&gt;cow.file
comma
op_amp
id|flags
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_goto
id|error
suffix:semicolon
)brace
id|dev-&gt;cow.fd
op_assign
id|err
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
id|os_close_file
c_func
(paren
id|dev-&gt;fd
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|ubd_new_disk
r_static
r_int
id|ubd_new_disk
c_func
(paren
r_int
id|major
comma
id|u64
id|size
comma
r_int
id|unit
comma
r_struct
id|gendisk
op_star
op_star
id|disk_out
)paren
(brace
r_struct
id|gendisk
op_star
id|disk
suffix:semicolon
r_char
id|from
(braket
r_sizeof
(paren
l_string|&quot;ubd/nnnnn&bslash;0&quot;
)paren
)braket
comma
id|to
(braket
r_sizeof
(paren
l_string|&quot;discnnnnn/disc&bslash;0&quot;
)paren
)braket
suffix:semicolon
r_int
id|err
suffix:semicolon
id|disk
op_assign
id|alloc_disk
c_func
(paren
l_int|1
op_lshift
id|UBD_SHIFT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|disk
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|disk-&gt;major
op_assign
id|major
suffix:semicolon
id|disk-&gt;first_minor
op_assign
id|unit
op_lshift
id|UBD_SHIFT
suffix:semicolon
id|disk-&gt;fops
op_assign
op_amp
id|ubd_blops
suffix:semicolon
id|set_capacity
c_func
(paren
id|disk
comma
id|size
op_div
l_int|512
)paren
suffix:semicolon
r_if
c_cond
(paren
id|major
op_eq
id|MAJOR_NR
)paren
(brace
id|sprintf
c_func
(paren
id|disk-&gt;disk_name
comma
l_string|&quot;ubd%c&quot;
comma
l_char|&squot;a&squot;
op_plus
id|unit
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|disk-&gt;devfs_name
comma
l_string|&quot;ubd/disc%d&quot;
comma
id|unit
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|from
comma
l_string|&quot;ubd/%d&quot;
comma
id|unit
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|to
comma
l_string|&quot;disc%d/disc&quot;
comma
id|unit
)paren
suffix:semicolon
id|err
op_assign
id|devfs_mk_symlink
c_func
(paren
id|from
comma
id|to
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ubd_new_disk failed to make link from %s to &quot;
l_string|&quot;%s, error = %d&bslash;n&quot;
comma
id|from
comma
id|to
comma
id|err
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|sprintf
c_func
(paren
id|disk-&gt;disk_name
comma
l_string|&quot;ubd_fake%d&quot;
comma
id|unit
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|disk-&gt;devfs_name
comma
l_string|&quot;ubd_fake/disc%d&quot;
comma
id|unit
)paren
suffix:semicolon
)brace
id|disk-&gt;private_data
op_assign
op_amp
id|ubd_dev
(braket
id|unit
)braket
suffix:semicolon
id|disk-&gt;queue
op_assign
id|ubd_queue
suffix:semicolon
id|add_disk
c_func
(paren
id|disk
)paren
suffix:semicolon
op_star
id|disk_out
op_assign
id|disk
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ubd_add
r_static
r_int
id|ubd_add
c_func
(paren
r_int
id|n
)paren
(brace
r_struct
id|ubd
op_star
id|dev
op_assign
op_amp
id|ubd_dev
(braket
id|n
)braket
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;file
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ubd_open_dev
c_func
(paren
id|dev
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|err
op_assign
id|ubd_file_size
c_func
(paren
id|dev
comma
op_amp
id|dev-&gt;size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|err
op_assign
id|ubd_new_disk
c_func
(paren
id|MAJOR_NR
comma
id|dev-&gt;size
comma
id|n
comma
op_amp
id|ubd_gendisk
(braket
id|n
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fake_major
op_ne
id|MAJOR_NR
)paren
(brace
id|ubd_new_disk
c_func
(paren
id|fake_major
comma
id|dev-&gt;size
comma
id|n
comma
op_amp
id|fake_gendisk
(braket
id|n
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* perhaps this should also be under the &quot;if (fake_major)&quot; above */
multiline_comment|/* using the fake_disk-&gt;disk_name and also the fakehd_set name */
r_if
c_cond
(paren
id|fake_ide
)paren
id|make_ide_entries
c_func
(paren
id|ubd_gendisk
(braket
id|n
)braket
op_member_access_from_pointer
id|disk_name
)paren
suffix:semicolon
id|ubd_close
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ubd_config
r_static
r_int
id|ubd_config
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|n
comma
id|err
suffix:semicolon
id|str
op_assign
id|uml_strdup
c_func
(paren
id|str
)paren
suffix:semicolon
r_if
c_cond
(paren
id|str
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ubd_config failed to strdup string&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|err
op_assign
id|ubd_setup_common
c_func
(paren
id|str
comma
op_amp
id|n
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|kfree
c_func
(paren
id|str
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n
op_eq
op_minus
l_int|1
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|ubd_lock
)paren
suffix:semicolon
id|err
op_assign
id|ubd_add
c_func
(paren
id|n
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|ubd_dev
(braket
id|n
)braket
dot
id|file
op_assign
l_int|NULL
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|ubd_lock
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|ubd_get_config
r_static
r_int
id|ubd_get_config
c_func
(paren
r_char
op_star
id|name
comma
r_char
op_star
id|str
comma
r_int
id|size
comma
r_char
op_star
op_star
id|error_out
)paren
(brace
r_struct
id|ubd
op_star
id|dev
suffix:semicolon
r_char
op_star
id|end
suffix:semicolon
r_int
id|n
comma
id|len
op_assign
l_int|0
suffix:semicolon
id|n
op_assign
id|simple_strtoul
c_func
(paren
id|name
comma
op_amp
id|end
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|end
op_ne
l_char|&squot;&bslash;0&squot;
)paren
op_logical_or
(paren
id|end
op_eq
id|name
)paren
)paren
(brace
op_star
id|error_out
op_assign
l_string|&quot;ubd_get_config : didn&squot;t parse device number&quot;
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|n
op_ge
id|MAX_DEV
)paren
op_logical_or
(paren
id|n
OL
l_int|0
)paren
)paren
(brace
op_star
id|error_out
op_assign
l_string|&quot;ubd_get_config : device number out of range&quot;
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|dev
op_assign
op_amp
id|ubd_dev
(braket
id|n
)braket
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|ubd_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;file
op_eq
l_int|NULL
)paren
(brace
id|CONFIG_CHUNK
c_func
(paren
id|str
comma
id|size
comma
id|len
comma
l_string|&quot;&quot;
comma
l_int|1
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|CONFIG_CHUNK
c_func
(paren
id|str
comma
id|size
comma
id|len
comma
id|dev-&gt;file
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;cow.file
op_ne
l_int|NULL
)paren
(brace
id|CONFIG_CHUNK
c_func
(paren
id|str
comma
id|size
comma
id|len
comma
l_string|&quot;,&quot;
comma
l_int|0
)paren
suffix:semicolon
id|CONFIG_CHUNK
c_func
(paren
id|str
comma
id|size
comma
id|len
comma
id|dev-&gt;cow.file
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
id|CONFIG_CHUNK
c_func
(paren
id|str
comma
id|size
comma
id|len
comma
l_string|&quot;&quot;
comma
l_int|1
)paren
suffix:semicolon
id|out
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|ubd_lock
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|ubd_remove
r_static
r_int
id|ubd_remove
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_struct
id|ubd
op_star
id|dev
suffix:semicolon
r_int
id|n
comma
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|n
op_assign
id|parse_unit
c_func
(paren
op_amp
id|str
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|n
OL
l_int|0
)paren
op_logical_or
(paren
id|n
op_ge
id|MAX_DEV
)paren
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|dev
op_assign
op_amp
id|ubd_dev
(braket
id|n
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;count
OG
l_int|0
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* you cannot remove a open disk */
id|err
op_assign
l_int|0
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|ubd_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ubd_gendisk
(braket
id|n
)braket
op_eq
l_int|NULL
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|del_gendisk
c_func
(paren
id|ubd_gendisk
(braket
id|n
)braket
)paren
suffix:semicolon
id|put_disk
c_func
(paren
id|ubd_gendisk
(braket
id|n
)braket
)paren
suffix:semicolon
id|ubd_gendisk
(braket
id|n
)braket
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|fake_gendisk
(braket
id|n
)braket
op_ne
l_int|NULL
)paren
(brace
id|del_gendisk
c_func
(paren
id|fake_gendisk
(braket
id|n
)braket
)paren
suffix:semicolon
id|put_disk
c_func
(paren
id|fake_gendisk
(braket
id|n
)braket
)paren
suffix:semicolon
id|fake_gendisk
(braket
id|n
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
op_star
id|dev
op_assign
(paren
(paren
r_struct
id|ubd
)paren
id|DEFAULT_UBD
)paren
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|ubd_lock
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|variable|ubd_mc
r_static
r_struct
id|mc_device
id|ubd_mc
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;ubd&quot;
comma
dot
id|config
op_assign
id|ubd_config
comma
dot
id|get_config
op_assign
id|ubd_get_config
comma
dot
id|remove
op_assign
id|ubd_remove
comma
)brace
suffix:semicolon
DECL|function|ubd_mc_init
r_static
r_int
id|ubd_mc_init
c_func
(paren
r_void
)paren
(brace
id|mconsole_register_dev
c_func
(paren
op_amp
id|ubd_mc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ubd_mc_init
id|__initcall
c_func
(paren
id|ubd_mc_init
)paren
suffix:semicolon
DECL|function|ubd_init
r_int
id|ubd_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|devfs_mk_dir
c_func
(paren
l_string|&quot;ubd&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_blkdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;ubd&quot;
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|ubd_queue
op_assign
id|blk_init_queue
c_func
(paren
id|do_ubd_request
comma
op_amp
id|ubd_io_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ubd_queue
)paren
(brace
id|unregister_blkdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;ubd&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|elevator_init
c_func
(paren
id|ubd_queue
comma
op_amp
id|elevator_noop
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fake_major
op_ne
id|MAJOR_NR
)paren
(brace
r_char
id|name
(braket
r_sizeof
(paren
l_string|&quot;ubd_nnn&bslash;0&quot;
)paren
)braket
suffix:semicolon
id|snprintf
c_func
(paren
id|name
comma
r_sizeof
(paren
id|name
)paren
comma
l_string|&quot;ubd_%d&quot;
comma
id|fake_major
)paren
suffix:semicolon
id|devfs_mk_dir
c_func
(paren
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_blkdev
c_func
(paren
id|fake_major
comma
l_string|&quot;ubd&quot;
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_DEV
suffix:semicolon
id|i
op_increment
)paren
id|ubd_add
c_func
(paren
id|i
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ubd_init
id|late_initcall
c_func
(paren
id|ubd_init
)paren
suffix:semicolon
DECL|function|ubd_driver_init
r_int
(def_block
id|ubd_driver_init
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|stack
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|global_openflags.s
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ubd : Synchronous mode&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|stack
op_assign
id|alloc_stack
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|io_pid
op_assign
id|start_io_thread
c_func
(paren
id|stack
op_plus
id|PAGE_SIZE
op_minus
r_sizeof
(paren
r_void
op_star
)paren
comma
op_amp
id|thread_fd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|io_pid
OL
l_int|0
)paren
(brace
id|io_pid
op_assign
op_minus
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ubd : Failed to start I/O thread (errno = %d) - &quot;
l_string|&quot;falling back to synchronous I/O&bslash;n&quot;
comma
op_minus
id|io_pid
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|err
op_assign
id|um_request_irq
c_func
(paren
id|UBD_IRQ
comma
id|thread_fd
comma
id|IRQ_READ
comma
id|ubd_intr
comma
id|SA_INTERRUPT
comma
l_string|&quot;ubd&quot;
comma
id|ubd_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;um_request_irq failed - errno = %d&bslash;n&quot;
comma
op_minus
id|err
)paren
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
)def_block
DECL|variable|ubd_driver_init
id|device_initcall
c_func
(paren
id|ubd_driver_init
)paren
suffix:semicolon
DECL|function|ubd_open
r_static
r_int
id|ubd_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|gendisk
op_star
id|disk
op_assign
id|inode-&gt;i_bdev-&gt;bd_disk
suffix:semicolon
r_struct
id|ubd
op_star
id|dev
op_assign
id|disk-&gt;private_data
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;count
op_eq
l_int|0
)paren
(brace
id|err
op_assign
id|ubd_open_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Can&squot;t open &bslash;&quot;%s&bslash;&quot;: errno = %d&bslash;n&quot;
comma
id|disk-&gt;disk_name
comma
id|dev-&gt;file
comma
op_minus
id|err
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|dev-&gt;count
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|filp-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
op_logical_and
op_logical_neg
id|dev-&gt;openflags.w
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|dev-&gt;count
op_eq
l_int|0
)paren
(brace
id|ubd_close
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|EROFS
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|function|ubd_release
r_static
r_int
id|ubd_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|gendisk
op_star
id|disk
op_assign
id|inode-&gt;i_bdev-&gt;bd_disk
suffix:semicolon
r_struct
id|ubd
op_star
id|dev
op_assign
id|disk-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|dev-&gt;count
op_eq
l_int|0
)paren
(brace
id|ubd_close
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cowify_bitmap
r_static
r_void
id|cowify_bitmap
c_func
(paren
id|__u64
id|io_offset
comma
r_int
id|length
comma
r_int
r_int
op_star
id|cow_mask
comma
id|__u64
op_star
id|cow_offset
comma
r_int
r_int
op_star
id|bitmap
comma
id|__u64
id|bitmap_offset
comma
r_int
r_int
op_star
id|bitmap_words
comma
id|__u64
id|bitmap_len
)paren
(brace
id|__u64
id|sector
op_assign
id|io_offset
op_rshift
l_int|9
suffix:semicolon
r_int
id|i
comma
id|update_bitmap
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|length
op_rshift
l_int|9
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cow_mask
op_ne
l_int|NULL
)paren
(brace
id|ubd_set_bit
c_func
(paren
id|i
comma
(paren
r_int
r_char
op_star
)paren
id|cow_mask
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ubd_test_bit
c_func
(paren
id|sector
op_plus
id|i
comma
(paren
r_int
r_char
op_star
)paren
id|bitmap
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
id|update_bitmap
op_assign
l_int|1
suffix:semicolon
id|ubd_set_bit
c_func
(paren
id|sector
op_plus
id|i
comma
(paren
r_int
r_char
op_star
)paren
id|bitmap
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|update_bitmap
)paren
(brace
r_return
suffix:semicolon
)brace
op_star
id|cow_offset
op_assign
id|sector
op_div
(paren
r_sizeof
(paren
r_int
r_int
)paren
op_star
l_int|8
)paren
suffix:semicolon
multiline_comment|/* This takes care of the case where we&squot;re exactly at the end of the&n;&t; * device, and *cow_offset + 1 is off the end.  So, just back it up&n;&t; * by one word.  Thanks to Lynn Kerby for the fix and James McMechan&n;&t; * for the original diagnosis.&n;&t; */
r_if
c_cond
(paren
op_star
id|cow_offset
op_eq
(paren
(paren
id|bitmap_len
op_plus
r_sizeof
(paren
r_int
r_int
)paren
op_minus
l_int|1
)paren
op_div
r_sizeof
(paren
r_int
r_int
)paren
op_minus
l_int|1
)paren
)paren
(brace
(paren
op_star
id|cow_offset
)paren
op_decrement
suffix:semicolon
)brace
id|bitmap_words
(braket
l_int|0
)braket
op_assign
id|bitmap
(braket
op_star
id|cow_offset
)braket
suffix:semicolon
id|bitmap_words
(braket
l_int|1
)braket
op_assign
id|bitmap
(braket
op_star
id|cow_offset
op_plus
l_int|1
)braket
suffix:semicolon
op_star
id|cow_offset
op_mul_assign
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
op_star
id|cow_offset
op_add_assign
id|bitmap_offset
suffix:semicolon
)brace
DECL|function|cowify_req
r_static
r_void
id|cowify_req
c_func
(paren
r_struct
id|io_thread_req
op_star
id|req
comma
r_int
r_int
op_star
id|bitmap
comma
id|__u64
id|bitmap_offset
comma
id|__u64
id|bitmap_len
)paren
(brace
id|__u64
id|sector
op_assign
id|req-&gt;offset
op_rshift
l_int|9
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;length
OG
(paren
r_sizeof
(paren
id|req-&gt;sector_mask
)paren
op_star
l_int|8
)paren
op_lshift
l_int|9
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Operation too long&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req-&gt;op
op_eq
id|UBD_READ
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|req-&gt;length
op_rshift
l_int|9
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ubd_test_bit
c_func
(paren
id|sector
op_plus
id|i
comma
(paren
r_int
r_char
op_star
)paren
id|bitmap
)paren
)paren
(brace
id|ubd_set_bit
c_func
(paren
id|i
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|req-&gt;sector_mask
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
id|cowify_bitmap
c_func
(paren
id|req-&gt;offset
comma
id|req-&gt;length
comma
op_amp
id|req-&gt;sector_mask
comma
op_amp
id|req-&gt;cow_offset
comma
id|bitmap
comma
id|bitmap_offset
comma
id|req-&gt;bitmap_words
comma
id|bitmap_len
)paren
suffix:semicolon
)brace
DECL|function|mmap_fd
r_static
r_int
id|mmap_fd
c_func
(paren
r_struct
id|request
op_star
id|req
comma
r_struct
id|ubd
op_star
id|dev
comma
id|__u64
id|offset
)paren
(brace
id|__u64
id|sector
suffix:semicolon
r_int
r_char
op_star
id|bitmap
suffix:semicolon
r_int
id|bit
comma
id|i
suffix:semicolon
multiline_comment|/* mmap must have been requested on the command line */
r_if
c_cond
(paren
op_logical_neg
id|ubd_do_mmap
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* The buffer must be page aligned */
r_if
c_cond
(paren
(paren
(paren
r_int
r_int
)paren
id|req-&gt;buffer
op_mod
id|UBD_MMAP_BLOCK_SIZE
)paren
op_ne
l_int|0
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* The request must be a page long */
r_if
c_cond
(paren
(paren
id|req-&gt;current_nr_sectors
op_lshift
l_int|9
)paren
op_ne
id|PAGE_SIZE
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;cow.file
op_eq
l_int|NULL
)paren
(brace
r_return
id|dev-&gt;fd
suffix:semicolon
)brace
id|sector
op_assign
id|offset
op_rshift
l_int|9
suffix:semicolon
id|bitmap
op_assign
(paren
r_int
r_char
op_star
)paren
id|dev-&gt;cow.bitmap
suffix:semicolon
id|bit
op_assign
id|ubd_test_bit
c_func
(paren
id|sector
comma
id|bitmap
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|req-&gt;current_nr_sectors
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ubd_test_bit
c_func
(paren
id|sector
op_plus
id|i
comma
id|bitmap
)paren
op_ne
id|bit
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|bit
op_logical_or
(paren
id|rq_data_dir
c_func
(paren
id|req
)paren
op_eq
id|WRITE
)paren
)paren
(brace
id|offset
op_add_assign
id|dev-&gt;cow.data_offset
suffix:semicolon
)brace
multiline_comment|/* The data on disk must be page aligned */
r_if
c_cond
(paren
(paren
id|offset
op_mod
id|UBD_MMAP_BLOCK_SIZE
)paren
op_ne
l_int|0
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
id|bit
ques
c_cond
id|dev-&gt;fd
suffix:colon
id|dev-&gt;cow.fd
suffix:semicolon
)brace
DECL|function|prepare_mmap_request
r_static
r_int
id|prepare_mmap_request
c_func
(paren
r_struct
id|ubd
op_star
id|dev
comma
r_int
id|fd
comma
id|__u64
id|offset
comma
r_struct
id|request
op_star
id|req
comma
r_struct
id|io_thread_req
op_star
id|io_req
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|rq_data_dir
c_func
(paren
id|req
)paren
op_eq
id|WRITE
)paren
(brace
multiline_comment|/* Writes are almost no-ops since the new data is already in the&n;&t;&t; * host page cache&n;&t;&t; */
id|dev-&gt;map_writes
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;cow.file
op_ne
l_int|NULL
)paren
(brace
id|cowify_bitmap
c_func
(paren
id|io_req-&gt;offset
comma
id|io_req-&gt;length
comma
op_amp
id|io_req-&gt;sector_mask
comma
op_amp
id|io_req-&gt;cow_offset
comma
id|dev-&gt;cow.bitmap
comma
id|dev-&gt;cow.bitmap_offset
comma
id|io_req-&gt;bitmap_words
comma
id|dev-&gt;cow.bitmap_len
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_int
id|w
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;cow.file
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|fd
op_eq
id|dev-&gt;cow.fd
)paren
)paren
(brace
id|w
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|w
op_assign
id|dev-&gt;openflags.w
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;cow.file
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|fd
op_eq
id|dev-&gt;fd
)paren
)paren
(brace
id|offset
op_add_assign
id|dev-&gt;cow.data_offset
suffix:semicolon
)brace
id|err
op_assign
id|physmem_subst_mapping
c_func
(paren
id|req-&gt;buffer
comma
id|fd
comma
id|offset
comma
id|w
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;physmem_subst_mapping failed, err = %d&bslash;n&quot;
comma
op_minus
id|err
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|dev-&gt;map_reads
op_increment
suffix:semicolon
)brace
id|io_req-&gt;op
op_assign
id|UBD_MMAP
suffix:semicolon
id|io_req-&gt;buffer
op_assign
id|req-&gt;buffer
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|prepare_request
r_static
r_int
id|prepare_request
c_func
(paren
r_struct
id|request
op_star
id|req
comma
r_struct
id|io_thread_req
op_star
id|io_req
)paren
(brace
r_struct
id|gendisk
op_star
id|disk
op_assign
id|req-&gt;rq_disk
suffix:semicolon
r_struct
id|ubd
op_star
id|dev
op_assign
id|disk-&gt;private_data
suffix:semicolon
id|__u64
id|offset
suffix:semicolon
r_int
id|len
comma
id|fd
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;rq_status
op_eq
id|RQ_INACTIVE
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rq_data_dir
c_func
(paren
id|req
)paren
op_eq
id|WRITE
)paren
op_logical_and
op_logical_neg
id|dev-&gt;openflags.w
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Write attempted on readonly ubd device %s&bslash;n&quot;
comma
id|disk-&gt;disk_name
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|ubd_io_lock
)paren
suffix:semicolon
id|end_request
c_func
(paren
id|req
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ubd_io_lock
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|offset
op_assign
(paren
(paren
id|__u64
)paren
id|req-&gt;sector
)paren
op_lshift
l_int|9
suffix:semicolon
id|len
op_assign
id|req-&gt;current_nr_sectors
op_lshift
l_int|9
suffix:semicolon
id|io_req-&gt;fds
(braket
l_int|0
)braket
op_assign
(paren
id|dev-&gt;cow.file
op_ne
l_int|NULL
)paren
ques
c_cond
id|dev-&gt;cow.fd
suffix:colon
id|dev-&gt;fd
suffix:semicolon
id|io_req-&gt;fds
(braket
l_int|1
)braket
op_assign
id|dev-&gt;fd
suffix:semicolon
id|io_req-&gt;map_fd
op_assign
op_minus
l_int|1
suffix:semicolon
id|io_req-&gt;cow_offset
op_assign
op_minus
l_int|1
suffix:semicolon
id|io_req-&gt;offset
op_assign
id|offset
suffix:semicolon
id|io_req-&gt;length
op_assign
id|len
suffix:semicolon
id|io_req-&gt;error
op_assign
l_int|0
suffix:semicolon
id|io_req-&gt;sector_mask
op_assign
l_int|0
suffix:semicolon
id|fd
op_assign
id|mmap_fd
c_func
(paren
id|req
comma
id|dev
comma
id|io_req-&gt;offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
OG
l_int|0
)paren
(brace
multiline_comment|/* If mmapping is otherwise OK, but the first access to the&n;&t;&t; * page is a write, then it&squot;s not mapped in yet.  So we have&n;&t;&t; * to write the data to disk first, then we can map the disk&n;&t;&t; * page in and continue normally from there.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|rq_data_dir
c_func
(paren
id|req
)paren
op_eq
id|WRITE
)paren
op_logical_and
op_logical_neg
id|is_remapped
c_func
(paren
id|req-&gt;buffer
)paren
)paren
(brace
id|io_req-&gt;map_fd
op_assign
id|dev-&gt;fd
suffix:semicolon
id|io_req-&gt;map_offset
op_assign
id|io_req-&gt;offset
op_plus
id|dev-&gt;cow.data_offset
suffix:semicolon
id|dev-&gt;write_maps
op_increment
suffix:semicolon
)brace
r_else
r_return
id|prepare_mmap_request
c_func
(paren
id|dev
comma
id|fd
comma
id|io_req-&gt;offset
comma
id|req
comma
id|io_req
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rq_data_dir
c_func
(paren
id|req
)paren
op_eq
id|READ
)paren
(brace
id|dev-&gt;nomap_reads
op_increment
suffix:semicolon
)brace
r_else
id|dev-&gt;nomap_writes
op_increment
suffix:semicolon
id|io_req-&gt;op
op_assign
(paren
id|rq_data_dir
c_func
(paren
id|req
)paren
op_eq
id|READ
)paren
ques
c_cond
id|UBD_READ
suffix:colon
id|UBD_WRITE
suffix:semicolon
id|io_req-&gt;offsets
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|io_req-&gt;offsets
(braket
l_int|1
)braket
op_assign
id|dev-&gt;cow.data_offset
suffix:semicolon
id|io_req-&gt;buffer
op_assign
id|req-&gt;buffer
suffix:semicolon
id|io_req-&gt;sectorsize
op_assign
l_int|1
op_lshift
l_int|9
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;cow.file
op_ne
l_int|NULL
)paren
(brace
id|cowify_req
c_func
(paren
id|io_req
comma
id|dev-&gt;cow.bitmap
comma
id|dev-&gt;cow.bitmap_offset
comma
id|dev-&gt;cow.bitmap_len
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|do_ubd_request
r_static
r_void
id|do_ubd_request
c_func
(paren
id|request_queue_t
op_star
id|q
)paren
(brace
r_struct
id|io_thread_req
id|io_req
suffix:semicolon
r_struct
id|request
op_star
id|req
suffix:semicolon
r_int
id|err
comma
id|n
suffix:semicolon
r_if
c_cond
(paren
id|thread_fd
op_eq
op_minus
l_int|1
)paren
(brace
r_while
c_loop
(paren
(paren
id|req
op_assign
id|elv_next_request
c_func
(paren
id|q
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|err
op_assign
id|prepare_request
c_func
(paren
id|req
comma
op_amp
id|io_req
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|do_io
c_func
(paren
op_amp
id|io_req
)paren
suffix:semicolon
id|ubd_finish
c_func
(paren
id|req
comma
id|io_req.error
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|do_ubd
op_logical_or
(paren
id|req
op_assign
id|elv_next_request
c_func
(paren
id|q
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
id|err
op_assign
id|prepare_request
c_func
(paren
id|req
comma
op_amp
id|io_req
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|do_ubd
op_assign
id|ubd_handler
suffix:semicolon
id|n
op_assign
id|write_ubd_fs
c_func
(paren
id|thread_fd
comma
(paren
r_char
op_star
)paren
op_amp
id|io_req
comma
r_sizeof
(paren
id|io_req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
r_sizeof
(paren
id|io_req
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;write to io thread failed, &quot;
l_string|&quot;errno = %d&bslash;n&quot;
comma
op_minus
id|n
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|function|ubd_ioctl
r_static
r_int
id|ubd_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|hd_geometry
op_star
id|loc
op_assign
(paren
r_struct
id|hd_geometry
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|ubd
op_star
id|dev
op_assign
id|inode-&gt;i_bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
r_int
id|err
suffix:semicolon
r_struct
id|hd_driveid
id|ubd_id
op_assign
(brace
dot
id|cyls
op_assign
l_int|0
comma
dot
id|heads
op_assign
l_int|128
comma
dot
id|sectors
op_assign
l_int|32
comma
)brace
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_struct
id|hd_geometry
id|g
suffix:semicolon
r_struct
id|cdrom_volctrl
id|volume
suffix:semicolon
r_case
id|HDIO_GETGEO
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|loc
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|g.heads
op_assign
l_int|128
suffix:semicolon
id|g.sectors
op_assign
l_int|32
suffix:semicolon
id|g.cylinders
op_assign
id|dev-&gt;size
op_div
(paren
l_int|128
op_star
l_int|32
op_star
l_int|512
)paren
suffix:semicolon
id|g.start
op_assign
id|get_start_sect
c_func
(paren
id|inode-&gt;i_bdev
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
id|loc
comma
op_amp
id|g
comma
r_sizeof
(paren
id|g
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|HDIO_SET_UNMASKINTR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
r_return
op_minus
id|EACCES
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|arg
OG
l_int|1
)paren
op_logical_or
(paren
id|inode-&gt;i_bdev-&gt;bd_contains
op_ne
id|inode-&gt;i_bdev
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|HDIO_GET_UNMASKINTR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_int
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|HDIO_GET_MULTCOUNT
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_int
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|HDIO_SET_MULTCOUNT
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
r_return
op_minus
id|EACCES
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inode-&gt;i_bdev-&gt;bd_contains
op_ne
id|inode-&gt;i_bdev
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|HDIO_GET_IDENTITY
suffix:colon
id|ubd_id.cyls
op_assign
id|dev-&gt;size
op_div
(paren
l_int|128
op_star
l_int|32
op_star
l_int|512
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
(paren
r_char
op_star
)paren
op_amp
id|ubd_id
comma
r_sizeof
(paren
id|ubd_id
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|CDROMVOLREAD
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|volume
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|volume
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|volume.channel0
op_assign
l_int|255
suffix:semicolon
id|volume.channel1
op_assign
l_int|255
suffix:semicolon
id|volume.channel2
op_assign
l_int|255
suffix:semicolon
id|volume.channel3
op_assign
l_int|255
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
op_amp
id|volume
comma
r_sizeof
(paren
id|volume
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|ubd_check_remapped
r_static
r_int
id|ubd_check_remapped
c_func
(paren
r_int
id|fd
comma
r_int
r_int
id|address
comma
r_int
id|is_write
comma
id|__u64
id|offset
)paren
(brace
id|__u64
id|bitmap_offset
suffix:semicolon
r_int
r_int
id|new_bitmap
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|i
comma
id|err
comma
id|n
suffix:semicolon
multiline_comment|/* If it&squot;s not a write access, we can&squot;t do anything about it */
r_if
c_cond
(paren
op_logical_neg
id|is_write
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* We have a write */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|ubd_dev
)paren
op_div
r_sizeof
(paren
id|ubd_dev
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|ubd
op_star
id|dev
op_assign
op_amp
id|ubd_dev
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;fd
op_ne
id|fd
)paren
op_logical_and
(paren
id|dev-&gt;cow.fd
op_ne
id|fd
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* It&squot;s a write to a ubd device */
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;openflags.w
)paren
(brace
multiline_comment|/* It&squot;s a write access on a read-only device - probably&n;&t;&t;&t; * shouldn&squot;t happen.  If the kernel is trying to change&n;&t;&t;&t; * something with no intention of writing it back out,&n;&t;&t;&t; * then this message will clue us in that this needs&n;&t;&t;&t; * fixing&n;&t;&t;&t; */
id|printk
c_func
(paren
l_string|&quot;Write access to mapped page from readonly ubd &quot;
l_string|&quot;device %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* It&squot;s a write to a writeable ubd device - it must be COWed&n;&t;&t; * because, otherwise, the page would have been mapped in&n;&t;&t; * writeable&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;cow.file
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Write fault on writeable non-COW ubd device %d&quot;
comma
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/* It should also be an access to the backing file since the&n;&t;&t; * COW pages should be mapped in read-write&n;&t;&t; */
r_if
c_cond
(paren
id|fd
op_eq
id|dev-&gt;fd
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Write fault on a backing page of ubd &quot;
l_string|&quot;device %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/* So, we do the write, copying the backing data to the COW&n;&t;&t; * file...&n;&t;&t; */
id|err
op_assign
id|os_seek_file
c_func
(paren
id|dev-&gt;fd
comma
id|offset
op_plus
id|dev-&gt;cow.data_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Couldn&squot;t seek to %lld in COW file of ubd &quot;
l_string|&quot;device %d, err = %d&quot;
comma
id|offset
op_plus
id|dev-&gt;cow.data_offset
comma
id|i
comma
op_minus
id|err
)paren
suffix:semicolon
)brace
id|n
op_assign
id|os_write_file
c_func
(paren
id|dev-&gt;fd
comma
(paren
r_void
op_star
)paren
id|address
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
id|PAGE_SIZE
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Couldn&squot;t copy data to COW file of ubd &quot;
l_string|&quot;device %d, err = %d&quot;
comma
id|i
comma
op_minus
id|n
)paren
suffix:semicolon
)brace
multiline_comment|/* ... updating the COW bitmap... */
id|cowify_bitmap
c_func
(paren
id|offset
comma
id|PAGE_SIZE
comma
l_int|NULL
comma
op_amp
id|bitmap_offset
comma
id|dev-&gt;cow.bitmap
comma
id|dev-&gt;cow.bitmap_offset
comma
id|new_bitmap
comma
id|dev-&gt;cow.bitmap_len
)paren
suffix:semicolon
id|err
op_assign
id|os_seek_file
c_func
(paren
id|dev-&gt;fd
comma
id|bitmap_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Couldn&squot;t seek to %lld in COW file of ubd &quot;
l_string|&quot;device %d, err = %d&quot;
comma
id|bitmap_offset
comma
id|i
comma
op_minus
id|err
)paren
suffix:semicolon
)brace
id|n
op_assign
id|os_write_file
c_func
(paren
id|dev-&gt;fd
comma
id|new_bitmap
comma
r_sizeof
(paren
id|new_bitmap
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
r_sizeof
(paren
id|new_bitmap
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Couldn&squot;t update bitmap  of ubd device %d, &quot;
l_string|&quot;err = %d&quot;
comma
id|i
comma
op_minus
id|n
)paren
suffix:semicolon
)brace
multiline_comment|/* Maybe we can map the COW page in, and maybe we can&squot;t.  If&n;&t;&t; * it is a pre-V3 COW file, we can&squot;t, since the alignment will&n;&t;&t; * be wrong.  If it is a V3 or later COW file which has been&n;&t;&t; * moved to a system with a larger page size, then maybe we&n;&t;&t; * can&squot;t, depending on the exact location of the page.&n;&t;&t; */
id|offset
op_add_assign
id|dev-&gt;cow.data_offset
suffix:semicolon
multiline_comment|/* Remove the remapping, putting the original anonymous page&n;&t;&t; * back.  If the COW file can be mapped in, that is done.&n;&t;&t; * Otherwise, the COW page is read in.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|physmem_remove_mapping
c_func
(paren
(paren
r_void
op_star
)paren
id|address
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Address 0x%lx not remapped by ubd device %d&quot;
comma
id|address
comma
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|offset
op_mod
id|UBD_MMAP_BLOCK_SIZE
)paren
op_eq
l_int|0
)paren
(brace
id|physmem_subst_mapping
c_func
(paren
(paren
r_void
op_star
)paren
id|address
comma
id|dev-&gt;fd
comma
id|offset
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|err
op_assign
id|os_seek_file
c_func
(paren
id|dev-&gt;fd
comma
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Couldn&squot;t seek to %lld in COW file of &quot;
l_string|&quot;ubd device %d, err = %d&quot;
comma
id|offset
comma
id|i
comma
op_minus
id|err
)paren
suffix:semicolon
)brace
id|n
op_assign
id|os_read_file
c_func
(paren
id|dev-&gt;fd
comma
(paren
r_void
op_star
)paren
id|address
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
id|PAGE_SIZE
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Failed to read page from offset %llx of &quot;
l_string|&quot;COW file of ubd device %d, err = %d&quot;
comma
id|offset
comma
id|i
comma
op_minus
id|n
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* It&squot;s not a write on a ubd device */
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ubd_remapper
r_static
r_struct
id|remapper
id|ubd_remapper
op_assign
(brace
dot
id|list
op_assign
id|LIST_HEAD_INIT
c_func
(paren
id|ubd_remapper.list
)paren
comma
dot
id|proc
op_assign
id|ubd_check_remapped
comma
)brace
suffix:semicolon
DECL|function|ubd_remapper_setup
r_static
r_int
id|ubd_remapper_setup
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ubd_do_mmap
)paren
(brace
id|register_remapper
c_func
(paren
op_amp
id|ubd_remapper
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ubd_remapper_setup
id|__initcall
c_func
(paren
id|ubd_remapper_setup
)paren
suffix:semicolon
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-file-style: &quot;linux&quot;&n; * End:&n; */
eof
