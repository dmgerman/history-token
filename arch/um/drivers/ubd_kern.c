multiline_comment|/* &n; * Copyright (C) 2000 Jeff Dike (jdike@karaya.com)&n; * Licensed under the GPL&n; */
multiline_comment|/* 2001-09-28...2002-04-17&n; * Partition stuff by James_McMechan@hotmail.com&n; * old style ubd by setting UBD_SHIFT to 0&n; */
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR UBD_MAJOR
DECL|macro|UBD_SHIFT
mdefine_line|#define UBD_SHIFT 4
macro_line|#include &quot;linux/config.h&quot;
macro_line|#include &quot;linux/blk.h&quot;
macro_line|#include &quot;linux/blkdev.h&quot;
macro_line|#include &quot;linux/hdreg.h&quot;
macro_line|#include &quot;linux/init.h&quot;
macro_line|#include &quot;linux/devfs_fs_kernel.h&quot;
macro_line|#include &quot;linux/cdrom.h&quot;
macro_line|#include &quot;linux/proc_fs.h&quot;
macro_line|#include &quot;linux/ctype.h&quot;
macro_line|#include &quot;linux/capability.h&quot;
macro_line|#include &quot;linux/mm.h&quot;
macro_line|#include &quot;linux/vmalloc.h&quot;
macro_line|#include &quot;linux/blkpg.h&quot;
macro_line|#include &quot;linux/genhd.h&quot;
macro_line|#include &quot;asm/segment.h&quot;
macro_line|#include &quot;asm/uaccess.h&quot;
macro_line|#include &quot;asm/irq.h&quot;
macro_line|#include &quot;asm/types.h&quot;
macro_line|#include &quot;asm/tlbflush.h&quot;
macro_line|#include &quot;user_util.h&quot;
macro_line|#include &quot;mem_user.h&quot;
macro_line|#include &quot;kern_util.h&quot;
macro_line|#include &quot;kern.h&quot;
macro_line|#include &quot;mconsole_kern.h&quot;
macro_line|#include &quot;init.h&quot;
macro_line|#include &quot;irq_user.h&quot;
macro_line|#include &quot;ubd_user.h&quot;
macro_line|#include &quot;2_5compat.h&quot;
macro_line|#include &quot;os.h&quot;
DECL|variable|ubd_lock
r_static
id|spinlock_t
id|ubd_lock
suffix:semicolon
DECL|variable|do_ubd
r_static
r_void
(paren
op_star
id|do_ubd
)paren
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|ubd_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_int
id|ubd_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|ubd_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|ubd_revalidate
c_func
(paren
id|kdev_t
id|rdev
)paren
suffix:semicolon
DECL|macro|MAX_DEV
mdefine_line|#define MAX_DEV (8)
DECL|macro|MAX_MINOR
mdefine_line|#define MAX_MINOR (MAX_DEV &lt;&lt; UBD_SHIFT)
DECL|macro|DEVICE_NR
mdefine_line|#define DEVICE_NR(n) (minor(n) &gt;&gt; UBD_SHIFT)
DECL|variable|ubd_blops
r_static
r_struct
id|block_device_operations
id|ubd_blops
op_assign
(brace
id|open
suffix:colon
id|ubd_open
comma
id|release
suffix:colon
id|ubd_release
comma
id|ioctl
suffix:colon
id|ubd_ioctl
comma
id|revalidate
suffix:colon
id|ubd_revalidate
comma
)brace
suffix:semicolon
DECL|variable|ubd_queue
r_static
id|request_queue_t
op_star
id|ubd_queue
suffix:semicolon
DECL|variable|fake_major
r_static
r_int
id|fake_major
op_assign
l_int|0
suffix:semicolon
DECL|variable|ubd_gendisk
r_static
r_struct
id|gendisk
id|ubd_gendisk
(braket
id|MAX_DEV
)braket
suffix:semicolon
DECL|variable|fake_gendisk
r_static
r_struct
id|gendisk
id|fake_gendisk
(braket
id|MAX_DEV
)braket
suffix:semicolon
macro_line|#ifdef CONFIG_BLK_DEV_UBD_SYNC
DECL|macro|OPEN_FLAGS
mdefine_line|#define OPEN_FLAGS ((struct openflags) { r : 1, w : 1, s : 1, c : 0 })
macro_line|#else
DECL|macro|OPEN_FLAGS
mdefine_line|#define OPEN_FLAGS ((struct openflags) { r : 1, w : 1, s : 0, c : 0 })
macro_line|#endif
DECL|variable|global_openflags
r_static
r_struct
id|openflags
id|global_openflags
op_assign
id|OPEN_FLAGS
suffix:semicolon
DECL|struct|cow
r_struct
id|cow
(brace
DECL|member|file
r_char
op_star
id|file
suffix:semicolon
DECL|member|fd
r_int
id|fd
suffix:semicolon
DECL|member|bitmap
r_int
r_int
op_star
id|bitmap
suffix:semicolon
DECL|member|bitmap_len
r_int
r_int
id|bitmap_len
suffix:semicolon
DECL|member|bitmap_offset
r_int
id|bitmap_offset
suffix:semicolon
DECL|member|data_offset
r_int
id|data_offset
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|ubd
r_struct
id|ubd
(brace
DECL|member|file
r_char
op_star
id|file
suffix:semicolon
DECL|member|is_dir
r_int
id|is_dir
suffix:semicolon
DECL|member|count
r_int
id|count
suffix:semicolon
DECL|member|fd
r_int
id|fd
suffix:semicolon
DECL|member|size
id|__u64
id|size
suffix:semicolon
DECL|member|boot_openflags
r_struct
id|openflags
id|boot_openflags
suffix:semicolon
DECL|member|openflags
r_struct
id|openflags
id|openflags
suffix:semicolon
DECL|member|real
id|devfs_handle_t
id|real
suffix:semicolon
DECL|member|fake
id|devfs_handle_t
id|fake
suffix:semicolon
DECL|member|cow
r_struct
id|cow
id|cow
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|DEFAULT_COW
mdefine_line|#define DEFAULT_COW { &bslash;&n;&t;file:&t;&t;&t;NULL, &bslash;&n;        fd:&t;&t;&t;-1, &bslash;&n;        bitmap:&t;&t;&t;NULL, &bslash;&n;&t;bitmap_offset:&t;&t;0, &bslash;&n;        data_offset:&t;&t;0, &bslash;&n;}
DECL|macro|DEFAULT_UBD
mdefine_line|#define DEFAULT_UBD { &bslash;&n;&t;file: &t;&t;&t;NULL, &bslash;&n;&t;is_dir:&t;&t;&t;0, &bslash;&n;&t;count:&t;&t;&t;0, &bslash;&n;&t;fd:&t;&t;&t;-1, &bslash;&n;&t;size:&t;&t;&t;-1, &bslash;&n;&t;boot_openflags:&t;&t;OPEN_FLAGS, &bslash;&n;&t;openflags:&t;&t;OPEN_FLAGS, &bslash;&n;&t;real:&t;&t;&t;NULL, &bslash;&n;&t;fake:&t;&t;&t;NULL, &bslash;&n;        cow:&t;&t;&t;DEFAULT_COW, &bslash;&n;}
DECL|variable|ubd_dev
r_struct
id|ubd
id|ubd_dev
(braket
id|MAX_DEV
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
id|MAX_DEV
op_minus
l_int|1
)braket
op_assign
id|DEFAULT_UBD
)brace
suffix:semicolon
DECL|function|ubd0_init
r_static
r_int
id|ubd0_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ubd_dev
(braket
l_int|0
)braket
dot
id|file
op_eq
l_int|NULL
)paren
(brace
id|ubd_dev
(braket
l_int|0
)braket
dot
id|file
op_assign
l_string|&quot;root_fs&quot;
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ubd0_init
id|__initcall
c_func
(paren
id|ubd0_init
)paren
suffix:semicolon
DECL|variable|ubd_id
r_static
r_struct
id|hd_driveid
id|ubd_id
op_assign
(brace
id|cyls
suffix:colon
l_int|0
comma
id|heads
suffix:colon
l_int|128
comma
id|sectors
suffix:colon
l_int|32
comma
)brace
suffix:semicolon
DECL|variable|fake_ide
r_static
r_int
id|fake_ide
op_assign
l_int|0
suffix:semicolon
DECL|variable|proc_ide_root
r_static
r_struct
id|proc_dir_entry
op_star
id|proc_ide_root
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|proc_ide
r_static
r_struct
id|proc_dir_entry
op_star
id|proc_ide
op_assign
l_int|NULL
suffix:semicolon
DECL|function|make_proc_ide
r_static
r_void
id|make_proc_ide
c_func
(paren
r_void
)paren
(brace
id|proc_ide_root
op_assign
id|proc_mkdir
c_func
(paren
l_string|&quot;ide&quot;
comma
l_int|0
)paren
suffix:semicolon
id|proc_ide
op_assign
id|proc_mkdir
c_func
(paren
l_string|&quot;ide0&quot;
comma
id|proc_ide_root
)paren
suffix:semicolon
)brace
DECL|function|proc_ide_read_media
r_static
r_int
id|proc_ide_read_media
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|len
suffix:semicolon
id|strcpy
c_func
(paren
id|page
comma
l_string|&quot;disk&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_assign
id|strlen
c_func
(paren
l_string|&quot;disk&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_sub_assign
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|count
)paren
(brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|len
op_assign
id|count
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|make_ide_entries
r_static
r_void
id|make_ide_entries
c_func
(paren
r_char
op_star
id|dev_name
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|dir
comma
op_star
id|ent
suffix:semicolon
r_char
id|name
(braket
l_int|64
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fake_ide
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|proc_ide_root
op_eq
l_int|NULL
)paren
(brace
id|make_proc_ide
c_func
(paren
)paren
suffix:semicolon
)brace
id|dir
op_assign
id|proc_mkdir
c_func
(paren
id|dev_name
comma
id|proc_ide
)paren
suffix:semicolon
id|ent
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;media&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ent
)paren
(brace
r_return
suffix:semicolon
)brace
id|ent-&gt;nlink
op_assign
l_int|1
suffix:semicolon
id|ent-&gt;data
op_assign
l_int|NULL
suffix:semicolon
id|ent-&gt;read_proc
op_assign
id|proc_ide_read_media
suffix:semicolon
id|ent-&gt;write_proc
op_assign
l_int|NULL
suffix:semicolon
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;ide0/%s&quot;
comma
id|dev_name
)paren
suffix:semicolon
id|proc_symlink
c_func
(paren
id|dev_name
comma
id|proc_ide_root
comma
id|name
)paren
suffix:semicolon
)brace
DECL|function|fake_ide_setup
r_static
r_int
id|fake_ide_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
id|fake_ide
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;fake_ide&quot;
comma
id|fake_ide_setup
)paren
suffix:semicolon
id|__uml_help
c_func
(paren
id|fake_ide_setup
comma
l_string|&quot;fake_ide&bslash;n&quot;
l_string|&quot;    Create ide0 entries that map onto ubd devices.&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
DECL|function|ubd_setup_common
r_static
r_int
id|ubd_setup_common
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|index_out
)paren
(brace
r_struct
id|openflags
id|flags
op_assign
id|global_openflags
suffix:semicolon
r_char
op_star
id|backing_file
suffix:semicolon
r_int
id|i
comma
id|n
suffix:semicolon
r_if
c_cond
(paren
id|index_out
)paren
(brace
op_star
id|index_out
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|n
op_assign
op_star
id|str
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|n
op_eq
l_char|&squot;=&squot;
)paren
(brace
r_static
r_int
id|fake_major_allowed
op_assign
l_int|1
suffix:semicolon
r_char
op_star
id|end
suffix:semicolon
r_int
id|major
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|str
comma
l_string|&quot;sync&quot;
)paren
)paren
(brace
id|global_openflags.s
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|major
op_assign
id|simple_strtoul
c_func
(paren
id|str
comma
op_amp
id|end
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|end
op_ne
l_char|&squot;&bslash;0&squot;
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ubd_setup : didn&squot;t parse major number&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|fake_major_allowed
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Can&squot;t assign a fake major twice&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|fake_major
op_assign
id|major
suffix:semicolon
id|fake_major_allowed
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Setting extra ubd major number to %d&bslash;n&quot;
comma
id|major
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n
OL
l_char|&squot;0&squot;
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ubd_setup : index out of range&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|n
op_ge
l_char|&squot;0&squot;
)paren
op_logical_and
(paren
id|n
op_le
l_char|&squot;9&squot;
)paren
)paren
(brace
id|n
op_sub_assign
l_char|&squot;0&squot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|n
op_ge
l_char|&squot;a&squot;
)paren
op_logical_and
(paren
id|n
op_le
l_char|&squot;z&squot;
)paren
)paren
(brace
id|n
op_sub_assign
l_char|&squot;a&squot;
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ubd_setup : device syntax invalid&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n
op_ge
id|MAX_DEV
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ubd_setup : index out of range &quot;
l_string|&quot;(%d devices)&bslash;n&quot;
comma
id|MAX_DEV
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ubd_dev
(braket
id|n
)braket
dot
id|file
op_ne
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ubd_setup : device already configured&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|index_out
)paren
(brace
op_star
id|index_out
op_assign
id|n
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|str
op_eq
l_char|&squot;r&squot;
)paren
(brace
id|flags.w
op_assign
l_int|0
suffix:semicolon
id|str
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|str
op_eq
l_char|&squot;s&squot;
)paren
(brace
id|flags.s
op_assign
l_int|1
suffix:semicolon
id|str
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|str
op_increment
op_ne
l_char|&squot;=&squot;
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ubd_setup : Expected &squot;=&squot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|backing_file
op_assign
id|strchr
c_func
(paren
id|str
comma
l_char|&squot;,&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|backing_file
)paren
(brace
op_star
id|backing_file
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|backing_file
op_increment
suffix:semicolon
)brace
id|ubd_dev
(braket
id|n
)braket
dot
id|file
op_assign
id|str
suffix:semicolon
r_if
c_cond
(paren
id|ubd_is_dir
c_func
(paren
id|ubd_dev
(braket
id|n
)braket
dot
id|file
)paren
)paren
(brace
id|ubd_dev
(braket
id|n
)braket
dot
id|is_dir
op_assign
l_int|1
suffix:semicolon
)brace
id|ubd_dev
(braket
id|n
)braket
dot
id|cow.file
op_assign
id|backing_file
suffix:semicolon
id|ubd_dev
(braket
id|n
)braket
dot
id|boot_openflags
op_assign
id|flags
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ubd_setup
r_static
r_int
id|ubd_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
id|ubd_setup_common
c_func
(paren
id|str
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;ubd&quot;
comma
id|ubd_setup
)paren
suffix:semicolon
id|__uml_help
c_func
(paren
id|ubd_setup
comma
l_string|&quot;ubd&lt;n&gt;=&lt;filename&gt;&bslash;n&quot;
l_string|&quot;    This is used to associate a device with a file in the underlying&bslash;n&quot;
l_string|&quot;    filesystem. Usually, there is a filesystem in the file, but &bslash;n&quot;
l_string|&quot;    that&squot;s not required. Swap devices containing swap files can be&bslash;n&quot;
l_string|&quot;    specified like this. Also, a file which doesn&squot;t contain a&bslash;n&quot;
l_string|&quot;    filesystem can have its contents read in the virtual &bslash;n&quot;
l_string|&quot;    machine by running dd on the device. n must be in the range&bslash;n&quot;
l_string|&quot;    0 to 7. Appending an &squot;r&squot; to the number will cause that device&bslash;n&quot;
l_string|&quot;    to be mounted read-only. For example ubd1r=./ext_fs. Appending&bslash;n&quot;
l_string|&quot;    an &squot;s&squot; (has to be _after_ &squot;r&squot;, if there is one) will cause data&bslash;n&quot;
l_string|&quot;    to be written to disk on the host immediately.&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
DECL|variable|fakehd_set
r_static
r_int
id|fakehd_set
op_assign
l_int|0
suffix:semicolon
DECL|function|fakehd
r_static
r_int
id|fakehd
c_func
(paren
r_char
op_star
id|str
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;fakehd : Changing ubd name to &bslash;&quot;hd&bslash;&quot;.&bslash;n&quot;
)paren
suffix:semicolon
id|fakehd_set
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;fakehd&quot;
comma
id|fakehd
)paren
suffix:semicolon
id|__uml_help
c_func
(paren
id|fakehd
comma
l_string|&quot;fakehd&bslash;n&quot;
l_string|&quot;    Change the ubd device name to &bslash;&quot;hd&bslash;&quot;.&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
r_static
r_void
id|do_ubd_request
c_func
(paren
id|request_queue_t
op_star
id|q
)paren
suffix:semicolon
DECL|variable|thread_fd
r_int
id|thread_fd
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|intr_count
r_int
id|intr_count
op_assign
l_int|0
suffix:semicolon
DECL|function|ubd_finish
r_static
r_void
id|ubd_finish
c_func
(paren
r_int
id|error
)paren
(brace
r_int
id|nsect
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|end_request
c_func
(paren
id|CURRENT
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|nsect
op_assign
id|CURRENT-&gt;current_nr_sectors
suffix:semicolon
id|CURRENT-&gt;sector
op_add_assign
id|nsect
suffix:semicolon
id|CURRENT-&gt;buffer
op_add_assign
id|nsect
op_lshift
l_int|9
suffix:semicolon
id|CURRENT-&gt;errors
op_assign
l_int|0
suffix:semicolon
id|CURRENT-&gt;nr_sectors
op_sub_assign
id|nsect
suffix:semicolon
id|CURRENT-&gt;current_nr_sectors
op_assign
l_int|0
suffix:semicolon
id|end_request
c_func
(paren
id|CURRENT
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|ubd_handler
r_static
r_void
id|ubd_handler
c_func
(paren
r_void
)paren
(brace
r_struct
id|io_thread_req
id|req
suffix:semicolon
r_int
id|n
suffix:semicolon
id|do_ubd
op_assign
l_int|NULL
suffix:semicolon
id|intr_count
op_increment
suffix:semicolon
id|n
op_assign
id|read_ubd_fs
c_func
(paren
id|thread_fd
comma
op_amp
id|req
comma
r_sizeof
(paren
id|req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
r_sizeof
(paren
id|req
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Pid %d - spurious interrupt in ubd_handler, &quot;
l_string|&quot;errno = %d&bslash;n&quot;
comma
id|os_getpid
c_func
(paren
)paren
comma
op_minus
id|n
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|ubd_lock
)paren
suffix:semicolon
id|end_request
c_func
(paren
id|CURRENT
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ubd_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|req.offset
op_ne
(paren
(paren
id|__u64
)paren
(paren
id|CURRENT-&gt;sector
)paren
)paren
op_lshift
l_int|9
)paren
op_logical_or
(paren
id|req.length
op_ne
(paren
id|CURRENT-&gt;current_nr_sectors
)paren
op_lshift
l_int|9
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;I/O op mismatch&quot;
)paren
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|ubd_lock
)paren
suffix:semicolon
id|ubd_finish
c_func
(paren
id|req.error
)paren
suffix:semicolon
id|reactivate_fd
c_func
(paren
id|thread_fd
comma
id|UBD_IRQ
)paren
suffix:semicolon
id|do_ubd_request
c_func
(paren
id|ubd_queue
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ubd_lock
)paren
suffix:semicolon
)brace
DECL|function|ubd_intr
r_static
r_void
id|ubd_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev
comma
r_struct
id|pt_regs
op_star
id|unused
)paren
(brace
id|ubd_handler
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|variable|io_pid
r_static
r_int
id|io_pid
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|function|kill_io_thread
r_void
id|kill_io_thread
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|io_pid
op_ne
op_minus
l_int|1
)paren
(brace
id|kill
c_func
(paren
id|io_pid
comma
id|SIGKILL
)paren
suffix:semicolon
)brace
)brace
DECL|variable|kill_io_thread
id|__uml_exitcall
c_func
(paren
id|kill_io_thread
)paren
suffix:semicolon
DECL|variable|sync
r_int
id|sync
op_assign
l_int|0
suffix:semicolon
DECL|function|ubd_file_size
r_static
r_int
id|ubd_file_size
c_func
(paren
r_struct
id|ubd
op_star
id|dev
comma
id|__u64
op_star
id|size_out
)paren
(brace
r_char
op_star
id|file
suffix:semicolon
id|file
op_assign
id|dev-&gt;cow.file
ques
c_cond
id|dev-&gt;cow.file
suffix:colon
id|dev-&gt;file
suffix:semicolon
r_return
id|os_file_size
c_func
(paren
id|file
comma
id|size_out
)paren
suffix:semicolon
)brace
DECL|variable|ubd_dir_handle
id|devfs_handle_t
id|ubd_dir_handle
suffix:semicolon
DECL|variable|ubd_fake_dir_handle
id|devfs_handle_t
id|ubd_fake_dir_handle
suffix:semicolon
DECL|function|ubd_add
r_static
r_int
id|ubd_add
c_func
(paren
r_int
id|n
)paren
(brace
id|devfs_handle_t
id|real
comma
id|fake
suffix:semicolon
r_char
id|name
(braket
r_sizeof
(paren
l_string|&quot;nnnnnn&bslash;0&quot;
)paren
)braket
suffix:semicolon
r_struct
id|ubd
op_star
id|dev
op_assign
op_amp
id|ubd_dev
(braket
id|n
)braket
suffix:semicolon
id|u64
id|size
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;file
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|ubd_gendisk
(braket
id|n
)braket
dot
id|major
op_assign
id|MAJOR_NR
suffix:semicolon
id|ubd_gendisk
(braket
id|n
)braket
dot
id|first_minor
op_assign
id|n
op_lshift
id|UBD_SHIFT
suffix:semicolon
id|ubd_gendisk
(braket
id|n
)braket
dot
id|minor_shift
op_assign
id|UBD_SHIFT
suffix:semicolon
id|ubd_gendisk
(braket
id|n
)braket
dot
id|fops
op_assign
op_amp
id|ubd_fops
suffix:semicolon
r_if
c_cond
(paren
id|fakehd_set
)paren
id|sprintf
c_func
(paren
id|ubd_gendisk
(braket
id|n
)braket
dot
id|disk_name
comma
l_string|&quot;hd%c&quot;
comma
id|n
op_plus
l_char|&squot;a&squot;
)paren
suffix:semicolon
r_else
id|sprintf
c_func
(paren
id|ubd_gendisk
(braket
id|n
)braket
dot
id|disk_name
comma
l_string|&quot;ubd%d&quot;
comma
id|n
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fake_major
)paren
(brace
id|fake_gendisk
(braket
id|n
)braket
dot
id|major
op_assign
id|fake_major
suffix:semicolon
id|fake_gendisk
(braket
id|n
)braket
dot
id|first_minor
op_assign
id|n
op_lshift
id|UBD_SHIFT
suffix:semicolon
id|fake_gendisk
(braket
id|n
)braket
dot
id|minor_shift
op_assign
id|UBD_SHIFT
suffix:semicolon
id|fake_gendisk
(braket
id|n
)braket
dot
id|fops
op_assign
op_amp
id|ubd_fops
suffix:semicolon
id|sprintf
c_func
(paren
id|fake_gendisk
(braket
id|n
)braket
dot
id|disk_name
comma
l_string|&quot;ubd%d&quot;
comma
id|n
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;is_dir
op_logical_and
id|ubd_file_size
c_func
(paren
id|dev
comma
op_amp
id|size
)paren
op_eq
l_int|0
)paren
(brace
id|set_capacity
c_func
(paren
op_amp
id|ubd_gendisk
(braket
id|n
)braket
comma
id|size
op_div
l_int|512
)paren
suffix:semicolon
id|set_capacity
c_func
(paren
op_amp
id|fake_gendisk
(braket
id|n
)braket
comma
id|size
op_div
l_int|512
)paren
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;%d&quot;
comma
id|n
)paren
suffix:semicolon
id|real
op_assign
id|devfs_register
c_func
(paren
id|ubd_dir_handle
comma
id|name
comma
id|DEVFS_FL_REMOVABLE
comma
id|MAJOR_NR
comma
id|n
op_lshift
id|UBD_SHIFT
comma
id|S_IFBLK
op_or
id|S_IRUSR
op_or
id|S_IWUSR
op_or
id|S_IRGRP
op_or
id|S_IWGRP
comma
op_amp
id|ubd_blops
comma
l_int|NULL
)paren
suffix:semicolon
id|add_disk
c_func
(paren
op_amp
id|ubd_gendisk
(braket
id|n
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fake_major
)paren
(brace
id|fake
op_assign
id|devfs_register
c_func
(paren
id|ubd_fake_dir_handle
comma
id|name
comma
id|DEVFS_FL_REMOVABLE
comma
id|fake_major
comma
id|n
op_lshift
id|UBD_SHIFT
comma
id|S_IFBLK
op_or
id|S_IRUSR
op_or
id|S_IWUSR
op_or
id|S_IRGRP
op_or
id|S_IWGRP
comma
op_amp
id|ubd_blops
comma
l_int|NULL
)paren
suffix:semicolon
id|add_disk
c_func
(paren
op_amp
id|fake_gendisk
(braket
id|n
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fake
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|ubd_dev
(braket
id|n
)braket
dot
id|fake
op_assign
id|fake
suffix:semicolon
)brace
r_if
c_cond
(paren
id|real
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|ubd_dev
(braket
id|n
)braket
dot
id|real
op_assign
id|real
suffix:semicolon
id|make_ide_entries
c_func
(paren
id|ubd_gendisk
(braket
id|n
)braket
dot
id|name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ubd_config
r_static
r_int
id|ubd_config
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|n
comma
id|err
suffix:semicolon
id|str
op_assign
id|uml_strdup
c_func
(paren
id|str
)paren
suffix:semicolon
r_if
c_cond
(paren
id|str
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ubd_config failed to strdup string&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|err
op_assign
id|ubd_setup_common
c_func
(paren
id|str
comma
op_amp
id|n
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|kfree
c_func
(paren
id|str
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n
op_eq
op_minus
l_int|1
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|err
op_assign
id|ubd_add
c_func
(paren
id|n
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|ubd_dev
(braket
id|n
)braket
dot
id|file
op_assign
l_int|NULL
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ubd_remove
r_static
r_int
id|ubd_remove
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_struct
id|ubd
op_star
id|dev
suffix:semicolon
r_int
id|n
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|isdigit
c_func
(paren
op_star
id|str
)paren
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|n
op_assign
op_star
id|str
op_minus
l_char|&squot;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
id|MAX_DEV
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|dev
op_assign
op_amp
id|ubd_dev
(braket
id|n
)braket
suffix:semicolon
id|del_gendisk
c_func
(paren
op_amp
id|ubd_gendisk
(braket
id|n
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fake_major
)paren
id|del_gendisk
c_func
(paren
op_amp
id|fake_gendisk
(braket
id|n
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;file
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;count
OG
l_int|0
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;real
op_ne
l_int|NULL
)paren
(brace
id|devfs_unregister
c_func
(paren
id|dev-&gt;real
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;fake
op_ne
l_int|NULL
)paren
(brace
id|devfs_unregister
c_func
(paren
id|dev-&gt;fake
)paren
suffix:semicolon
)brace
op_star
id|dev
op_assign
(paren
(paren
r_struct
id|ubd
)paren
id|DEFAULT_UBD
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ubd_mc
r_static
r_struct
id|mc_device
id|ubd_mc
op_assign
(brace
id|name
suffix:colon
l_string|&quot;ubd&quot;
comma
id|config
suffix:colon
id|ubd_config
comma
id|remove
suffix:colon
id|ubd_remove
comma
)brace
suffix:semicolon
DECL|function|ubd_mc_init
r_static
r_int
id|ubd_mc_init
c_func
(paren
r_void
)paren
(brace
id|mconsole_register_dev
c_func
(paren
op_amp
id|ubd_mc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ubd_mc_init
id|__initcall
c_func
(paren
id|ubd_mc_init
)paren
suffix:semicolon
DECL|function|ubd_get_queue
r_static
id|request_queue_t
op_star
id|ubd_get_queue
c_func
(paren
id|kdev_t
id|device
)paren
(brace
r_return
id|ubd_queue
suffix:semicolon
)brace
DECL|function|ubd_init
r_int
id|ubd_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|ubd_dir_handle
op_assign
id|devfs_mk_dir
(paren
l_int|NULL
comma
l_string|&quot;ubd&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_blkdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;ubd&quot;
comma
op_amp
id|ubd_blops
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ubd: unable to get major %d&bslash;n&quot;
comma
id|MAJOR_NR
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|ubd_queue
op_assign
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|MAJOR_NR
)paren
suffix:semicolon
id|INIT_QUEUE
c_func
(paren
id|ubd_queue
comma
id|do_ubd_request
comma
op_amp
id|ubd_lock
)paren
suffix:semicolon
id|INIT_ELV
c_func
(paren
id|ubd_queue
comma
op_amp
id|ubd_queue-&gt;elevator
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fake_major
op_ne
l_int|0
)paren
(brace
r_char
id|name
(braket
r_sizeof
(paren
l_string|&quot;ubd_nnn&bslash;0&quot;
)paren
)braket
suffix:semicolon
id|snprintf
c_func
(paren
id|name
comma
r_sizeof
(paren
id|name
)paren
comma
l_string|&quot;ubd_%d&quot;
comma
id|fake_major
)paren
suffix:semicolon
id|ubd_fake_dir_handle
op_assign
id|devfs_mk_dir
c_func
(paren
l_int|NULL
comma
id|name
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_blkdev
c_func
(paren
id|fake_major
comma
l_string|&quot;ubd&quot;
comma
op_amp
id|ubd_blops
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ubd: unable to get major %d&bslash;n&quot;
comma
id|fake_major
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|blk_dev
(braket
id|fake_major
)braket
dot
id|queue
op_assign
id|ubd_get_queue
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_DEV
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ubd_add
c_func
(paren
id|i
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ubd_init
id|late_initcall
c_func
(paren
id|ubd_init
)paren
suffix:semicolon
DECL|function|ubd_driver_init
r_int
(def_block
id|ubd_driver_init
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|stack
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|sync
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ubd : Synchronous mode&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|stack
op_assign
id|alloc_stack
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|io_pid
op_assign
id|start_io_thread
c_func
(paren
id|stack
op_plus
id|PAGE_SIZE
op_minus
r_sizeof
(paren
r_void
op_star
)paren
comma
op_amp
id|thread_fd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|io_pid
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ubd : Failed to start I/O thread (errno = %d) - &quot;
l_string|&quot;falling back to synchronous I/O&bslash;n&quot;
comma
op_minus
id|io_pid
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|err
op_assign
id|um_request_irq
c_func
(paren
id|UBD_IRQ
comma
id|thread_fd
comma
id|IRQ_READ
comma
id|ubd_intr
comma
id|SA_INTERRUPT
comma
l_string|&quot;ubd&quot;
comma
id|ubd_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;um_request_irq failed - errno = %d&bslash;n&quot;
comma
op_minus
id|err
)paren
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
)def_block
DECL|variable|ubd_driver_init
id|device_initcall
c_func
(paren
id|ubd_driver_init
)paren
suffix:semicolon
DECL|function|ubd_close
r_static
r_void
id|ubd_close
c_func
(paren
r_struct
id|ubd
op_star
id|dev
)paren
(brace
id|close_fd
c_func
(paren
id|dev-&gt;fd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;cow.file
op_ne
l_int|NULL
)paren
(brace
id|close_fd
c_func
(paren
id|dev-&gt;cow.fd
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|dev-&gt;cow.bitmap
)paren
suffix:semicolon
id|dev-&gt;cow.bitmap
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
DECL|function|ubd_open_dev
r_static
r_int
id|ubd_open_dev
c_func
(paren
r_struct
id|ubd
op_star
id|dev
)paren
(brace
r_struct
id|openflags
id|flags
suffix:semicolon
r_int
id|err
comma
id|n
comma
id|create_cow
comma
op_star
id|create_ptr
suffix:semicolon
id|create_cow
op_assign
l_int|0
suffix:semicolon
id|create_ptr
op_assign
(paren
id|dev-&gt;cow.file
op_ne
l_int|NULL
)paren
ques
c_cond
op_amp
id|create_cow
suffix:colon
l_int|NULL
suffix:semicolon
id|dev-&gt;fd
op_assign
id|open_ubd_file
c_func
(paren
id|dev-&gt;file
comma
op_amp
id|dev-&gt;openflags
comma
op_amp
id|dev-&gt;cow.file
comma
op_amp
id|dev-&gt;cow.bitmap_offset
comma
op_amp
id|dev-&gt;cow.bitmap_len
comma
op_amp
id|dev-&gt;cow.data_offset
comma
id|create_ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;fd
op_eq
op_minus
id|ENOENT
)paren
op_logical_and
id|create_cow
)paren
(brace
id|n
op_assign
id|dev
op_minus
id|ubd_dev
suffix:semicolon
id|dev-&gt;fd
op_assign
id|create_cow_file
c_func
(paren
id|dev-&gt;file
comma
id|dev-&gt;cow.file
comma
id|dev-&gt;openflags
comma
l_int|1
op_lshift
l_int|9
comma
op_amp
id|dev-&gt;cow.bitmap_offset
comma
op_amp
id|dev-&gt;cow.bitmap_len
comma
op_amp
id|dev-&gt;cow.data_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;fd
op_ge
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Creating &bslash;&quot;%s&bslash;&quot; as COW file for &quot;
l_string|&quot;&bslash;&quot;%s&bslash;&quot;&bslash;n&quot;
comma
id|dev-&gt;file
comma
id|dev-&gt;cow.file
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dev-&gt;fd
OL
l_int|0
)paren
(brace
r_return
id|dev-&gt;fd
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;cow.file
op_ne
l_int|NULL
)paren
(brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|dev-&gt;cow.bitmap
op_assign
(paren
r_void
op_star
)paren
id|vmalloc
c_func
(paren
id|dev-&gt;cow.bitmap_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;cow.bitmap
op_eq
l_int|NULL
)paren
(brace
r_goto
id|error
suffix:semicolon
)brace
id|flush_tlb_kernel_vm
c_func
(paren
)paren
suffix:semicolon
id|err
op_assign
id|read_cow_bitmap
c_func
(paren
id|dev-&gt;fd
comma
id|dev-&gt;cow.bitmap
comma
id|dev-&gt;cow.bitmap_offset
comma
id|dev-&gt;cow.bitmap_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_goto
id|error
suffix:semicolon
)brace
id|flags
op_assign
id|dev-&gt;openflags
suffix:semicolon
id|flags.w
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|open_ubd_file
c_func
(paren
id|dev-&gt;cow.file
comma
op_amp
id|flags
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_goto
id|error
suffix:semicolon
)brace
id|dev-&gt;cow.fd
op_assign
id|err
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
id|close_fd
c_func
(paren
id|dev-&gt;fd
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|ubd_open
r_static
r_int
id|ubd_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|ubd
op_star
id|dev
suffix:semicolon
r_int
id|n
comma
id|offset
comma
id|err
suffix:semicolon
id|n
op_assign
id|DEVICE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
id|dev
op_assign
op_amp
id|ubd_dev
(braket
id|n
)braket
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
id|MAX_DEV
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|offset
op_assign
id|n
op_lshift
id|UBD_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;is_dir
op_eq
l_int|1
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;count
op_eq
l_int|0
)paren
(brace
id|dev-&gt;openflags
op_assign
id|dev-&gt;boot_openflags
suffix:semicolon
id|err
op_assign
id|ubd_open_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ubd%d: Can&squot;t open &bslash;&quot;%s&bslash;&quot;: &quot;
l_string|&quot;errno = %d&bslash;n&quot;
comma
id|n
comma
id|dev-&gt;file
comma
op_minus
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
)brace
id|dev-&gt;count
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|filp-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
op_logical_and
op_logical_neg
id|dev-&gt;openflags.w
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|dev-&gt;count
op_eq
l_int|0
)paren
(brace
id|ubd_close
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ubd_release
r_static
r_int
id|ubd_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|n
comma
id|offset
suffix:semicolon
id|n
op_assign
id|DEVICE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
id|offset
op_assign
id|n
op_lshift
id|UBD_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
id|MAX_DEV
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_decrement
id|ubd_dev
(braket
id|n
)braket
dot
id|count
op_eq
l_int|0
)paren
(brace
id|ubd_close
c_func
(paren
op_amp
id|ubd_dev
(braket
id|n
)braket
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|cow_read
r_int
id|cow_read
op_assign
l_int|0
suffix:semicolon
DECL|variable|cow_write
r_int
id|cow_write
op_assign
l_int|0
suffix:semicolon
DECL|function|cowify_req
r_void
id|cowify_req
c_func
(paren
r_struct
id|io_thread_req
op_star
id|req
comma
r_struct
id|ubd
op_star
id|dev
)paren
(brace
r_int
id|i
comma
id|update_bitmap
comma
id|sector
op_assign
id|req-&gt;offset
op_rshift
l_int|9
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;length
OG
(paren
r_sizeof
(paren
id|req-&gt;sector_mask
)paren
op_star
l_int|8
)paren
op_lshift
l_int|9
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Operation too long&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req-&gt;op
op_eq
id|UBD_READ
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|req-&gt;length
op_rshift
l_int|9
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ubd_test_bit
c_func
(paren
id|sector
op_plus
id|i
comma
(paren
r_int
r_char
op_star
)paren
id|dev-&gt;cow.bitmap
)paren
)paren
(brace
id|ubd_set_bit
c_func
(paren
id|i
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|req-&gt;sector_mask
)paren
suffix:semicolon
id|cow_read
op_increment
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|update_bitmap
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|req-&gt;length
op_rshift
l_int|9
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cow_write
op_increment
suffix:semicolon
id|ubd_set_bit
c_func
(paren
id|i
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|req-&gt;sector_mask
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ubd_test_bit
c_func
(paren
id|sector
op_plus
id|i
comma
(paren
r_int
r_char
op_star
)paren
id|dev-&gt;cow.bitmap
)paren
)paren
(brace
id|update_bitmap
op_assign
l_int|1
suffix:semicolon
)brace
id|ubd_set_bit
c_func
(paren
id|sector
op_plus
id|i
comma
(paren
r_int
r_char
op_star
)paren
id|dev-&gt;cow.bitmap
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|update_bitmap
)paren
(brace
id|req-&gt;cow_offset
op_assign
id|sector
op_div
(paren
r_sizeof
(paren
r_int
r_int
)paren
op_star
l_int|8
)paren
suffix:semicolon
id|req-&gt;bitmap_words
(braket
l_int|0
)braket
op_assign
id|dev-&gt;cow.bitmap
(braket
id|req-&gt;cow_offset
)braket
suffix:semicolon
id|req-&gt;bitmap_words
(braket
l_int|1
)braket
op_assign
id|dev-&gt;cow.bitmap
(braket
id|req-&gt;cow_offset
op_plus
l_int|1
)braket
suffix:semicolon
id|req-&gt;cow_offset
op_mul_assign
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
id|req-&gt;cow_offset
op_add_assign
id|dev-&gt;cow.bitmap_offset
suffix:semicolon
)brace
)brace
)brace
DECL|function|prepare_request
r_static
r_int
id|prepare_request
c_func
(paren
r_struct
id|request
op_star
id|req
comma
r_struct
id|io_thread_req
op_star
id|io_req
)paren
(brace
r_struct
id|ubd
op_star
id|dev
suffix:semicolon
id|__u64
id|block
suffix:semicolon
r_int
id|nsect
comma
id|min
comma
id|n
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;rq_status
op_eq
id|RQ_INACTIVE
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|min
op_assign
id|minor
c_func
(paren
id|req-&gt;rq_dev
)paren
suffix:semicolon
id|n
op_assign
id|min
op_rshift
id|UBD_SHIFT
suffix:semicolon
id|dev
op_assign
op_amp
id|ubd_dev
(braket
id|n
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;is_dir
)paren
(brace
id|strcpy
c_func
(paren
id|req-&gt;buffer
comma
l_string|&quot;HOSTFS:&quot;
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|req-&gt;buffer
comma
id|dev-&gt;file
)paren
suffix:semicolon
id|end_request
c_func
(paren
id|req
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rq_data_dir
c_func
(paren
id|req
)paren
op_eq
id|WRITE
)paren
op_logical_and
op_logical_neg
id|dev-&gt;openflags.w
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Write attempted on readonly ubd device %d&bslash;n&quot;
comma
id|n
)paren
suffix:semicolon
id|end_request
c_func
(paren
id|req
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|block
op_assign
id|req-&gt;sector
suffix:semicolon
id|nsect
op_assign
id|req-&gt;current_nr_sectors
suffix:semicolon
id|io_req-&gt;op
op_assign
id|rq_data_dir
c_func
(paren
id|req
)paren
op_eq
id|READ
ques
c_cond
id|UBD_READ
suffix:colon
id|UBD_WRITE
suffix:semicolon
id|io_req-&gt;fds
(braket
l_int|0
)braket
op_assign
(paren
id|dev-&gt;cow.file
op_ne
l_int|NULL
)paren
ques
c_cond
id|dev-&gt;cow.fd
suffix:colon
id|dev-&gt;fd
suffix:semicolon
id|io_req-&gt;fds
(braket
l_int|1
)braket
op_assign
id|dev-&gt;fd
suffix:semicolon
id|io_req-&gt;offsets
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|io_req-&gt;offsets
(braket
l_int|1
)braket
op_assign
id|dev-&gt;cow.data_offset
suffix:semicolon
id|io_req-&gt;offset
op_assign
(paren
(paren
id|__u64
)paren
id|block
)paren
op_lshift
l_int|9
suffix:semicolon
id|io_req-&gt;length
op_assign
id|nsect
op_lshift
l_int|9
suffix:semicolon
id|io_req-&gt;buffer
op_assign
id|req-&gt;buffer
suffix:semicolon
id|io_req-&gt;sectorsize
op_assign
l_int|1
op_lshift
l_int|9
suffix:semicolon
id|io_req-&gt;sector_mask
op_assign
l_int|0
suffix:semicolon
id|io_req-&gt;cow_offset
op_assign
op_minus
l_int|1
suffix:semicolon
id|io_req-&gt;error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;cow.file
op_ne
l_int|NULL
)paren
(brace
id|cowify_req
c_func
(paren
id|io_req
comma
id|dev
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|do_ubd_request
r_static
r_void
id|do_ubd_request
c_func
(paren
id|request_queue_t
op_star
id|q
)paren
(brace
r_struct
id|io_thread_req
id|io_req
suffix:semicolon
r_struct
id|request
op_star
id|req
suffix:semicolon
r_int
id|err
comma
id|n
suffix:semicolon
r_if
c_cond
(paren
id|thread_fd
op_eq
op_minus
l_int|1
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|q-&gt;queue_head
)paren
)paren
(brace
id|req
op_assign
id|elv_next_request
c_func
(paren
id|q
)paren
suffix:semicolon
id|err
op_assign
id|prepare_request
c_func
(paren
id|req
comma
op_amp
id|io_req
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|do_io
c_func
(paren
op_amp
id|io_req
)paren
suffix:semicolon
id|ubd_finish
c_func
(paren
id|io_req.error
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|do_ubd
op_logical_or
id|list_empty
c_func
(paren
op_amp
id|q-&gt;queue_head
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|req
op_assign
id|elv_next_request
c_func
(paren
id|q
)paren
suffix:semicolon
id|err
op_assign
id|prepare_request
c_func
(paren
id|req
comma
op_amp
id|io_req
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|do_ubd
op_assign
id|ubd_handler
suffix:semicolon
id|n
op_assign
id|write_ubd_fs
c_func
(paren
id|thread_fd
comma
(paren
r_char
op_star
)paren
op_amp
id|io_req
comma
r_sizeof
(paren
id|io_req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
r_sizeof
(paren
id|io_req
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;write to io thread failed, &quot;
l_string|&quot;errno = %d&bslash;n&quot;
comma
op_minus
id|n
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|function|ubd_ioctl
r_static
r_int
id|ubd_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|hd_geometry
op_star
id|loc
op_assign
(paren
r_struct
id|hd_geometry
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|ubd
op_star
id|dev
suffix:semicolon
r_int
id|n
comma
id|min
comma
id|err
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|min
op_assign
id|minor
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
id|n
op_assign
id|min
op_rshift
id|UBD_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
id|MAX_DEV
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|dev
op_assign
op_amp
id|ubd_dev
(braket
id|n
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_struct
id|hd_geometry
id|g
suffix:semicolon
r_struct
id|cdrom_volctrl
id|volume
suffix:semicolon
r_case
id|HDIO_GETGEO
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|loc
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|g.heads
op_assign
l_int|128
suffix:semicolon
id|g.sectors
op_assign
l_int|32
suffix:semicolon
id|g.cylinders
op_assign
id|dev-&gt;size
op_div
(paren
l_int|128
op_star
l_int|32
op_star
l_int|512
)paren
suffix:semicolon
id|g.start
op_assign
l_int|2
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
id|loc
comma
op_amp
id|g
comma
r_sizeof
(paren
id|g
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|HDIO_SET_UNMASKINTR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
r_return
op_minus
id|EACCES
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|arg
OG
l_int|1
)paren
op_logical_or
(paren
id|min
op_amp
(paren
(paren
l_int|1
op_lshift
id|UBD_SHIFT
)paren
op_minus
l_int|1
)paren
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|HDIO_GET_UNMASKINTR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_int
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|HDIO_GET_MULTCOUNT
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_int
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|HDIO_SET_MULTCOUNT
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
r_return
op_minus
id|EACCES
suffix:semicolon
)brace
r_if
c_cond
(paren
id|min
op_amp
(paren
(paren
l_int|1
op_lshift
id|UBD_SHIFT
)paren
op_minus
l_int|1
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|HDIO_GET_IDENTITY
suffix:colon
id|ubd_id.cyls
op_assign
id|dev-&gt;size
op_div
(paren
l_int|128
op_star
l_int|32
op_star
l_int|512
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
(paren
r_char
op_star
)paren
op_amp
id|ubd_id
comma
r_sizeof
(paren
id|ubd_id
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|CDROMVOLREAD
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|volume
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|volume
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|volume.channel0
op_assign
l_int|255
suffix:semicolon
id|volume.channel1
op_assign
l_int|255
suffix:semicolon
id|volume.channel2
op_assign
l_int|255
suffix:semicolon
id|volume.channel3
op_assign
l_int|255
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
op_amp
id|volume
comma
r_sizeof
(paren
id|volume
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|ubd_revalidate
r_static
r_int
id|ubd_revalidate
c_func
(paren
id|kdev_t
id|rdev
)paren
(brace
id|__u64
id|size
suffix:semicolon
r_int
id|n
comma
id|offset
comma
id|err
suffix:semicolon
r_struct
id|ubd
op_star
id|dev
suffix:semicolon
id|n
op_assign
id|minor
c_func
(paren
id|rdev
)paren
op_rshift
id|UBD_SHIFT
suffix:semicolon
id|dev
op_assign
op_amp
id|ubd_dev
(braket
id|n
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;is_dir
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|err
op_assign
id|ubd_file_size
c_func
(paren
id|dev
comma
op_amp
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|set_capacity
c_func
(paren
op_amp
id|ubd_gendisk
(braket
id|n
)braket
comma
id|size
op_div
l_int|512
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fake_major
op_ne
l_int|0
)paren
(brace
id|set_capacity
c_func
(paren
op_amp
id|fake_gendisk
(braket
id|n
)braket
comma
id|size
op_div
l_int|512
)paren
suffix:semicolon
)brace
id|dev-&gt;size
op_assign
id|size
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-file-style: &quot;linux&quot;&n; * End:&n; */
eof
