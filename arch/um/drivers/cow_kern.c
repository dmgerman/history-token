DECL|macro|COW_MAJOR
mdefine_line|#define COW_MAJOR 60
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR COW_MAJOR
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/genhd.h&gt;
macro_line|#include &lt;linux/devfs_fs.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;2_5compat.h&quot;
macro_line|#include &quot;cow.h&quot;
macro_line|#include &quot;ubd_user.h&quot;
DECL|macro|COW_SHIFT
mdefine_line|#define COW_SHIFT 4
DECL|struct|cow
r_struct
id|cow
(brace
DECL|member|count
r_int
id|count
suffix:semicolon
DECL|member|cow_path
r_char
op_star
id|cow_path
suffix:semicolon
DECL|member|cow_dev
id|dev_t
id|cow_dev
suffix:semicolon
DECL|member|cow_bdev
r_struct
id|block_device
op_star
id|cow_bdev
suffix:semicolon
DECL|member|backing_path
r_char
op_star
id|backing_path
suffix:semicolon
DECL|member|backing_dev
id|dev_t
id|backing_dev
suffix:semicolon
DECL|member|backing_bdev
r_struct
id|block_device
op_star
id|backing_bdev
suffix:semicolon
DECL|member|sectorsize
r_int
id|sectorsize
suffix:semicolon
DECL|member|bitmap
r_int
r_int
op_star
id|bitmap
suffix:semicolon
DECL|member|bitmap_len
r_int
r_int
id|bitmap_len
suffix:semicolon
DECL|member|bitmap_offset
r_int
id|bitmap_offset
suffix:semicolon
DECL|member|data_offset
r_int
id|data_offset
suffix:semicolon
DECL|member|devfs
id|devfs_handle_t
id|devfs
suffix:semicolon
DECL|member|sem
r_struct
id|semaphore
id|sem
suffix:semicolon
DECL|member|io_sem
r_struct
id|semaphore
id|io_sem
suffix:semicolon
DECL|member|working
id|atomic_t
id|working
suffix:semicolon
DECL|member|io_lock
id|spinlock_t
id|io_lock
suffix:semicolon
DECL|member|bh
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
DECL|member|bhtail
r_struct
id|buffer_head
op_star
id|bhtail
suffix:semicolon
DECL|member|end_io
r_void
op_star
id|end_io
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|DEFAULT_COW
mdefine_line|#define DEFAULT_COW { &bslash;&n;&t;.count&t;&t;&t;= 0, &bslash;&n;&t;.cow_path&t;&t;= NULL, &bslash;&n;&t;.cow_dev&t;&t;= 0, &bslash;&n;&t;.backing_path&t;&t;= NULL, &bslash;&n;&t;.backing_dev&t;&t;= 0, &bslash;&n;        .bitmap&t;&t;&t;= NULL, &bslash;&n;&t;.bitmap_len&t;&t;= 0, &bslash;&n;&t;.bitmap_offset&t;&t;= 0, &bslash;&n;        .data_offset&t;&t;= 0, &bslash;&n;&t;.devfs&t;&t;&t;= NULL, &bslash;&n;&t;.working&t;&t;= ATOMIC_INIT(0), &bslash;&n;&t;.io_lock&t;&t;= SPIN_LOCK_UNLOCKED, &bslash;&n;}
DECL|macro|MAX_DEV
mdefine_line|#define MAX_DEV (8)
DECL|macro|MAX_MINOR
mdefine_line|#define MAX_MINOR (MAX_DEV &lt;&lt; COW_SHIFT)
DECL|variable|cow_dev
r_struct
id|cow
id|cow_dev
(braket
id|MAX_DEV
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
id|MAX_DEV
op_minus
l_int|1
)braket
op_assign
id|DEFAULT_COW
)brace
suffix:semicolon
multiline_comment|/* Not modified by this driver */
DECL|variable|blk_sizes
r_static
r_int
id|blk_sizes
(braket
id|MAX_MINOR
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
id|MAX_MINOR
op_minus
l_int|1
)braket
op_assign
id|BLOCK_SIZE
)brace
suffix:semicolon
DECL|variable|hardsect_sizes
r_static
r_int
id|hardsect_sizes
(braket
id|MAX_MINOR
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
id|MAX_MINOR
op_minus
l_int|1
)braket
op_assign
l_int|512
)brace
suffix:semicolon
multiline_comment|/* Protected by cow_lock */
DECL|variable|sizes
r_static
r_int
id|sizes
(braket
id|MAX_MINOR
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
id|MAX_MINOR
op_minus
l_int|1
)braket
op_assign
l_int|0
)brace
suffix:semicolon
DECL|variable|cow_part
r_static
r_struct
id|hd_struct
id|cow_part
(braket
id|MAX_MINOR
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
id|MAX_MINOR
op_minus
l_int|1
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/* Protected by io_request_lock */
DECL|variable|cow_queue
r_static
id|request_queue_t
op_star
id|cow_queue
suffix:semicolon
r_static
r_int
id|cow_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_int
id|cow_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|cow_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|cow_revalidate
c_func
(paren
id|kdev_t
id|rdev
)paren
suffix:semicolon
DECL|variable|cow_blops
r_static
r_struct
id|block_device_operations
id|cow_blops
op_assign
(brace
dot
id|open
op_assign
id|cow_open
comma
dot
id|release
op_assign
id|cow_release
comma
dot
id|ioctl
op_assign
id|cow_ioctl
comma
dot
id|revalidate
op_assign
id|cow_revalidate
comma
)brace
suffix:semicolon
multiline_comment|/* Initialized in an initcall, and unchanged thereafter */
DECL|variable|cow_dir_handle
id|devfs_handle_t
id|cow_dir_handle
suffix:semicolon
DECL|macro|INIT_GENDISK
mdefine_line|#define INIT_GENDISK(maj, name, parts, shift, bsizes, max, blops) &bslash;&n;{ &bslash;&n;&t;.major &t;&t;= maj, &bslash;&n;&t;.major_name  &t;= name, &bslash;&n;&t;.minor_shift &t;= shift, &bslash;&n;&t;.max_p  &t;= 1 &lt;&lt; shift, &bslash;&n;&t;.part  &t;&t;= parts, &bslash;&n;&t;.sizes  &t;= bsizes, &bslash;&n;&t;.nr_real  &t;= max, &bslash;&n;&t;.real_devices  &t;= NULL, &bslash;&n;&t;.next  &t;&t;= NULL, &bslash;&n;&t;.fops  &t;&t;= blops, &bslash;&n;&t;.de_arr  &t;= NULL, &bslash;&n;&t;.flags  &t;= 0 &bslash;&n;}
DECL|variable|cow_lock
r_static
id|spinlock_t
id|cow_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|cow_gendisk
r_static
r_struct
id|gendisk
id|cow_gendisk
op_assign
id|INIT_GENDISK
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;cow&quot;
comma
id|cow_part
comma
id|COW_SHIFT
comma
id|sizes
comma
id|MAX_DEV
comma
op_amp
id|cow_blops
)paren
suffix:semicolon
DECL|function|cow_add
r_static
r_int
id|cow_add
c_func
(paren
r_int
id|n
)paren
(brace
r_struct
id|cow
op_star
id|dev
op_assign
op_amp
id|cow_dev
(braket
id|n
)braket
suffix:semicolon
r_char
id|name
(braket
r_sizeof
(paren
l_string|&quot;nnnnnn&bslash;0&quot;
)paren
)braket
suffix:semicolon
r_int
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;cow_path
op_eq
l_int|NULL
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;%d&quot;
comma
id|n
)paren
suffix:semicolon
id|dev-&gt;devfs
op_assign
id|devfs_register
c_func
(paren
id|cow_dir_handle
comma
id|name
comma
id|DEVFS_FL_REMOVABLE
comma
id|MAJOR_NR
comma
id|n
op_lshift
id|COW_SHIFT
comma
id|S_IFBLK
op_or
id|S_IRUSR
op_or
id|S_IWUSR
op_or
id|S_IRGRP
op_or
id|S_IWGRP
comma
op_amp
id|cow_blops
comma
l_int|NULL
)paren
suffix:semicolon
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
id|dev-&gt;sem
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|dev-&gt;io_sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * Add buffer_head to back of pending list&n; */
DECL|function|cow_add_bh
r_static
r_void
id|cow_add_bh
c_func
(paren
r_struct
id|cow
op_star
id|cow
comma
r_struct
id|buffer_head
op_star
id|bh
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|cow-&gt;io_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cow-&gt;bhtail
op_ne
l_int|NULL
)paren
(brace
id|cow-&gt;bhtail-&gt;b_reqnext
op_assign
id|bh
suffix:semicolon
id|cow-&gt;bhtail
op_assign
id|bh
suffix:semicolon
)brace
r_else
(brace
id|cow-&gt;bh
op_assign
id|bh
suffix:semicolon
id|cow-&gt;bhtail
op_assign
id|bh
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|cow-&gt;io_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;* Grab first pending buffer&n;*/
DECL|function|cow_get_bh
r_static
r_struct
id|buffer_head
op_star
id|cow_get_bh
c_func
(paren
r_struct
id|cow
op_star
id|cow
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|cow-&gt;io_lock
)paren
suffix:semicolon
id|bh
op_assign
id|cow-&gt;bh
suffix:semicolon
r_if
c_cond
(paren
id|bh
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|bh
op_eq
id|cow-&gt;bhtail
)paren
(brace
id|cow-&gt;bhtail
op_assign
l_int|NULL
suffix:semicolon
)brace
id|cow-&gt;bh
op_assign
id|bh-&gt;b_reqnext
suffix:semicolon
id|bh-&gt;b_reqnext
op_assign
l_int|NULL
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|cow-&gt;io_lock
)paren
suffix:semicolon
r_return
id|bh
suffix:semicolon
)brace
DECL|function|cow_handle_bh
r_static
r_void
id|cow_handle_bh
c_func
(paren
r_struct
id|cow
op_star
id|cow
comma
r_struct
id|buffer_head
op_star
id|bh
comma
r_struct
id|buffer_head
op_star
op_star
id|cow_bh
comma
r_int
id|ncow_bh
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|ncow_bh
OG
l_int|0
)paren
(brace
id|ll_rw_block
c_func
(paren
id|WRITE
comma
id|ncow_bh
comma
id|cow_bh
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ncow_bh
suffix:semicolon
id|i
op_increment
)paren
(brace
id|wait_on_buffer
c_func
(paren
id|cow_bh
(braket
id|i
)braket
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|cow_bh
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|ll_rw_block
c_func
(paren
id|WRITE
comma
l_int|1
comma
op_amp
id|bh
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
)brace
DECL|function|cow_new_bh
r_static
r_struct
id|buffer_head
op_star
id|cow_new_bh
c_func
(paren
r_struct
id|cow
op_star
id|dev
comma
r_int
id|sector
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
id|sector
op_assign
(paren
id|dev-&gt;bitmap_offset
op_plus
id|sector
op_div
l_int|8
)paren
op_div
id|dev-&gt;sectorsize
suffix:semicolon
id|bh
op_assign
id|getblk
c_func
(paren
id|dev-&gt;cow_dev
comma
id|sector
comma
id|dev-&gt;sectorsize
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|bh-&gt;b_data
comma
id|dev-&gt;bitmap
op_plus
id|sector
op_div
(paren
l_int|8
op_star
r_sizeof
(paren
id|dev-&gt;bitmap
(braket
l_int|0
)braket
)paren
)paren
comma
id|dev-&gt;sectorsize
)paren
suffix:semicolon
r_return
id|bh
suffix:semicolon
)brace
multiline_comment|/* Copied from loop.c, needed to avoid deadlocking in make_request. */
DECL|function|cow_thread
r_static
r_int
id|cow_thread
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|cow
op_star
id|dev
op_assign
id|data
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
id|daemonize
c_func
(paren
)paren
suffix:semicolon
id|exit_files
c_func
(paren
id|current
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|current-&gt;comm
comma
l_string|&quot;cow%d&quot;
comma
id|dev
op_minus
id|cow_dev
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|current-&gt;sigmask_lock
)paren
suffix:semicolon
id|sigfillset
c_func
(paren
op_amp
id|current-&gt;blocked
)paren
suffix:semicolon
id|flush_signals
c_func
(paren
id|current
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|current-&gt;sigmask_lock
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|dev-&gt;working
)paren
suffix:semicolon
id|current-&gt;policy
op_assign
id|SCHED_OTHER
suffix:semicolon
id|current-&gt;nice
op_assign
op_minus
l_int|20
suffix:semicolon
id|current-&gt;flags
op_or_assign
id|PF_NOIO
suffix:semicolon
multiline_comment|/*&n;&t; * up sem, we are running&n;&t; */
id|up
c_func
(paren
op_amp
id|dev-&gt;sem
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_int
id|start
comma
id|len
comma
id|nbh
comma
id|i
comma
id|update_bitmap
op_assign
l_int|0
suffix:semicolon
r_struct
id|buffer_head
op_star
id|cow_bh
(braket
l_int|2
)braket
suffix:semicolon
id|down_interruptible
c_func
(paren
op_amp
id|dev-&gt;io_sem
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * could be upped because of tear-down, not because of&n;&t;&t; * pending work&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|atomic_read
c_func
(paren
op_amp
id|dev-&gt;working
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
id|bh
op_assign
id|cow_get_bh
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bh
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cow: missing bh&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|start
op_assign
id|bh-&gt;b_blocknr
op_star
id|bh-&gt;b_size
op_div
id|dev-&gt;sectorsize
suffix:semicolon
id|len
op_assign
id|bh-&gt;b_size
op_div
id|dev-&gt;sectorsize
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ubd_test_bit
c_func
(paren
id|start
op_plus
id|i
comma
(paren
r_int
r_char
op_star
)paren
id|dev-&gt;bitmap
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
id|update_bitmap
op_assign
l_int|1
suffix:semicolon
id|ubd_set_bit
c_func
(paren
id|start
op_plus
id|i
comma
(paren
r_int
r_char
op_star
)paren
id|dev-&gt;bitmap
)paren
suffix:semicolon
)brace
id|cow_bh
(braket
l_int|0
)braket
op_assign
l_int|NULL
suffix:semicolon
id|cow_bh
(braket
l_int|1
)braket
op_assign
l_int|NULL
suffix:semicolon
id|nbh
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|update_bitmap
)paren
(brace
id|cow_bh
(braket
l_int|0
)braket
op_assign
id|cow_new_bh
c_func
(paren
id|dev
comma
id|start
)paren
suffix:semicolon
id|nbh
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|start
op_div
id|dev-&gt;sectorsize
op_ne
(paren
id|start
op_plus
id|len
)paren
op_div
id|dev-&gt;sectorsize
)paren
(brace
id|cow_bh
(braket
l_int|1
)braket
op_assign
id|cow_new_bh
c_func
(paren
id|dev
comma
id|start
op_plus
id|len
)paren
suffix:semicolon
id|nbh
op_increment
suffix:semicolon
)brace
)brace
id|bh-&gt;b_dev
op_assign
id|dev-&gt;cow_dev
suffix:semicolon
id|bh-&gt;b_blocknr
op_add_assign
id|dev-&gt;data_offset
op_div
id|dev-&gt;sectorsize
suffix:semicolon
id|cow_handle_bh
c_func
(paren
id|dev
comma
id|bh
comma
id|cow_bh
comma
id|nbh
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * upped both for pending work and tear-down, lo_pending&n;&t;&t; * will hit zero then&n;&t;&t; */
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|dev-&gt;working
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
id|up
c_func
(paren
op_amp
id|dev-&gt;sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cow_make_request
r_static
r_int
id|cow_make_request
c_func
(paren
id|request_queue_t
op_star
id|q
comma
r_int
id|rw
comma
r_struct
id|buffer_head
op_star
id|bh
)paren
(brace
r_struct
id|cow
op_star
id|dev
suffix:semicolon
r_int
id|n
comma
id|minor
suffix:semicolon
id|minor
op_assign
id|MINOR
c_func
(paren
id|bh-&gt;b_rdev
)paren
suffix:semicolon
id|n
op_assign
id|minor
op_rshift
id|COW_SHIFT
suffix:semicolon
id|dev
op_assign
op_amp
id|cow_dev
(braket
id|n
)braket
suffix:semicolon
id|dev-&gt;end_io
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ubd_test_bit
c_func
(paren
id|bh-&gt;b_rsector
comma
(paren
r_int
r_char
op_star
)paren
id|dev-&gt;bitmap
)paren
)paren
(brace
id|bh-&gt;b_rdev
op_assign
id|dev-&gt;cow_dev
suffix:semicolon
id|bh-&gt;b_rsector
op_add_assign
id|dev-&gt;data_offset
op_div
id|dev-&gt;sectorsize
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rw
op_eq
id|WRITE
)paren
(brace
id|bh-&gt;b_dev
op_assign
id|dev-&gt;cow_dev
suffix:semicolon
id|bh-&gt;b_blocknr
op_add_assign
id|dev-&gt;data_offset
op_div
id|dev-&gt;sectorsize
suffix:semicolon
id|cow_add_bh
c_func
(paren
id|dev
comma
id|bh
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dev-&gt;io_sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|bh-&gt;b_rdev
op_assign
id|dev-&gt;backing_dev
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|cow_init
r_int
id|cow_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|cow_dir_handle
op_assign
id|devfs_mk_dir
(paren
l_int|NULL
comma
l_string|&quot;cow&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devfs_register_blkdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;cow&quot;
comma
op_amp
id|cow_blops
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cow: unable to get major %d&bslash;n&quot;
comma
id|MAJOR_NR
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|read_ahead
(braket
id|MAJOR_NR
)braket
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* 8 sector (4kB) read-ahead */
id|blksize_size
(braket
id|MAJOR_NR
)braket
op_assign
id|blk_sizes
suffix:semicolon
id|blk_size
(braket
id|MAJOR_NR
)braket
op_assign
id|sizes
suffix:semicolon
id|INIT_HARDSECT
c_func
(paren
id|hardsect_size
comma
id|MAJOR_NR
comma
id|hardsect_sizes
)paren
suffix:semicolon
id|cow_queue
op_assign
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|MAJOR_NR
)paren
suffix:semicolon
id|blk_init_queue
c_func
(paren
id|cow_queue
comma
l_int|NULL
)paren
suffix:semicolon
id|INIT_ELV
c_func
(paren
id|cow_queue
comma
op_amp
id|cow_queue-&gt;elevator
)paren
suffix:semicolon
id|blk_queue_make_request
c_func
(paren
id|cow_queue
comma
id|cow_make_request
)paren
suffix:semicolon
id|add_gendisk
c_func
(paren
op_amp
id|cow_gendisk
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_DEV
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cow_add
c_func
(paren
id|i
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|cow_init
id|__initcall
c_func
(paren
id|cow_init
)paren
suffix:semicolon
DECL|function|reader
r_static
r_int
id|reader
c_func
(paren
id|__u64
id|start
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_void
op_star
id|arg
)paren
(brace
id|dev_t
id|dev
op_assign
op_star
(paren
(paren
id|dev_t
op_star
)paren
id|arg
)paren
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
id|__u64
id|block
suffix:semicolon
r_int
id|cur
comma
id|offset
comma
id|left
comma
id|n
comma
id|blocksize
op_assign
id|get_hardsect_size
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blocksize
op_eq
l_int|0
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Zero blocksize&quot;
)paren
suffix:semicolon
)brace
id|block
op_assign
id|start
op_div
id|blocksize
suffix:semicolon
id|offset
op_assign
id|start
op_mod
id|blocksize
suffix:semicolon
id|left
op_assign
id|count
suffix:semicolon
id|cur
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|left
OG
l_int|0
)paren
(brace
id|n
op_assign
(paren
id|left
OG
id|blocksize
)paren
ques
c_cond
id|blocksize
suffix:colon
id|left
suffix:semicolon
id|bh
op_assign
id|bread
c_func
(paren
id|dev
comma
id|block
comma
(paren
id|n
OL
l_int|512
)paren
ques
c_cond
l_int|512
suffix:colon
id|n
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bh
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|n
op_sub_assign
id|offset
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|buf
(braket
id|cur
)braket
comma
id|bh-&gt;b_data
op_plus
id|offset
comma
id|n
)paren
suffix:semicolon
id|block
op_increment
suffix:semicolon
id|left
op_sub_assign
id|n
suffix:semicolon
id|cur
op_add_assign
id|n
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
DECL|function|cow_open
r_static
r_int
id|cow_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
(paren
op_star
id|dev_ioctl
)paren
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
id|mm_segment_t
id|fs
suffix:semicolon
r_struct
id|cow
op_star
id|dev
suffix:semicolon
id|__u64
id|size
suffix:semicolon
id|__u32
id|version
comma
id|align
suffix:semicolon
id|time_t
id|mtime
suffix:semicolon
r_char
op_star
id|backing_file
suffix:semicolon
r_int
id|n
comma
id|offset
comma
id|err
op_assign
l_int|0
suffix:semicolon
id|n
op_assign
id|DEVICE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ge
id|MAX_DEV
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dev
op_assign
op_amp
id|cow_dev
(braket
id|n
)braket
suffix:semicolon
id|offset
op_assign
id|n
op_lshift
id|COW_SHIFT
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|cow_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;count
op_eq
l_int|0
)paren
(brace
id|dev-&gt;cow_dev
op_assign
id|name_to_kdev_t
c_func
(paren
id|dev-&gt;cow_path
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;cow_dev
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cow_open - name_to_kdev_t(&bslash;&quot;%s&bslash;&quot;) &quot;
l_string|&quot;failed&bslash;n&quot;
comma
id|dev-&gt;cow_path
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dev-&gt;backing_dev
op_assign
id|name_to_kdev_t
c_func
(paren
id|dev-&gt;backing_path
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;backing_dev
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cow_open - name_to_kdev_t(&bslash;&quot;%s&bslash;&quot;) &quot;
l_string|&quot;failed&bslash;n&quot;
comma
id|dev-&gt;backing_path
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|dev-&gt;cow_bdev
op_assign
id|bdget
c_func
(paren
id|dev-&gt;cow_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;cow_bdev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cow_open - bdget(&bslash;&quot;%s&bslash;&quot;) failed&bslash;n&quot;
comma
id|dev-&gt;cow_path
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|dev-&gt;backing_bdev
op_assign
id|bdget
c_func
(paren
id|dev-&gt;backing_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;backing_bdev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cow_open - bdget(&bslash;&quot;%s&bslash;&quot;) failed&bslash;n&quot;
comma
id|dev-&gt;backing_path
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|err
op_assign
id|blkdev_get
c_func
(paren
id|dev-&gt;cow_bdev
comma
id|FMODE_READ
op_or
id|FMODE_WRITE
comma
l_int|0
comma
id|BDEV_RAW
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cow_open - blkdev_get of COW device failed, &quot;
l_string|&quot;error = %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|err
op_assign
id|blkdev_get
c_func
(paren
id|dev-&gt;backing_bdev
comma
id|FMODE_READ
comma
l_int|0
comma
id|BDEV_RAW
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cow_open - blkdev_get of backing device &quot;
l_string|&quot;failed, error = %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|err
op_assign
id|read_cow_header
c_func
(paren
id|reader
comma
op_amp
id|dev-&gt;cow_dev
comma
op_amp
id|version
comma
op_amp
id|backing_file
comma
op_amp
id|mtime
comma
op_amp
id|size
comma
op_amp
id|dev-&gt;sectorsize
comma
op_amp
id|align
comma
op_amp
id|dev-&gt;bitmap_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cow_open - read_cow_header failed, &quot;
l_string|&quot;err = %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|cow_sizes
c_func
(paren
id|version
comma
id|size
comma
id|dev-&gt;sectorsize
comma
id|align
comma
id|dev-&gt;bitmap_offset
comma
op_amp
id|dev-&gt;bitmap_len
comma
op_amp
id|dev-&gt;data_offset
)paren
suffix:semicolon
id|dev-&gt;bitmap
op_assign
(paren
r_void
op_star
)paren
id|vmalloc
c_func
(paren
id|dev-&gt;bitmap_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;bitmap
op_eq
l_int|NULL
)paren
(brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Failed to vmalloc COW bitmap&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|flush_tlb_kernel_vm
c_func
(paren
)paren
suffix:semicolon
id|err
op_assign
id|reader
c_func
(paren
id|dev-&gt;bitmap_offset
comma
(paren
r_char
op_star
)paren
id|dev-&gt;bitmap
comma
id|dev-&gt;bitmap_len
comma
op_amp
id|dev-&gt;cow_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Failed to read COW bitmap&bslash;n&quot;
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|dev-&gt;bitmap
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|dev_ioctl
op_assign
id|dev-&gt;backing_bdev-&gt;bd_op-&gt;ioctl
suffix:semicolon
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
id|err
op_assign
(paren
op_star
id|dev_ioctl
)paren
(paren
id|inode
comma
id|filp
comma
id|BLKGETSIZE
comma
(paren
r_int
r_int
)paren
op_amp
id|sizes
(braket
id|offset
)braket
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cow_open - BLKGETSIZE failed, &quot;
l_string|&quot;error = %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|kernel_thread
c_func
(paren
id|cow_thread
comma
id|dev
comma
id|CLONE_FS
op_or
id|CLONE_FILES
op_or
id|CLONE_SIGHAND
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dev-&gt;sem
)paren
suffix:semicolon
)brace
id|dev-&gt;count
op_increment
suffix:semicolon
id|out
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|cow_lock
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|cow_release
r_static
r_int
id|cow_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|cow
op_star
id|dev
suffix:semicolon
r_int
id|n
comma
id|err
suffix:semicolon
id|n
op_assign
id|DEVICE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ge
id|MAX_DEV
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dev
op_assign
op_amp
id|cow_dev
(braket
id|n
)braket
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|cow_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|dev-&gt;count
OG
l_int|0
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|err
op_assign
id|blkdev_put
c_func
(paren
id|dev-&gt;cow_bdev
comma
id|BDEV_RAW
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cow_release - blkdev_put of cow device failed, &quot;
l_string|&quot;error = %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
)brace
id|bdput
c_func
(paren
id|dev-&gt;cow_bdev
)paren
suffix:semicolon
id|dev-&gt;cow_bdev
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|blkdev_put
c_func
(paren
id|dev-&gt;backing_bdev
comma
id|BDEV_RAW
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cow_release - blkdev_put of backing device failed, &quot;
l_string|&quot;error = %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
)brace
id|bdput
c_func
(paren
id|dev-&gt;backing_bdev
)paren
suffix:semicolon
id|dev-&gt;backing_bdev
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|cow_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cow_ioctl
r_static
r_int
id|cow_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|cow
op_star
id|dev
suffix:semicolon
r_int
(paren
op_star
id|dev_ioctl
)paren
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_int
id|n
suffix:semicolon
id|n
op_assign
id|DEVICE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ge
id|MAX_DEV
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dev
op_assign
op_amp
id|cow_dev
(braket
id|n
)braket
suffix:semicolon
id|dev_ioctl
op_assign
id|dev-&gt;backing_bdev-&gt;bd_op-&gt;ioctl
suffix:semicolon
r_return
(paren
op_star
id|dev_ioctl
)paren
(paren
id|inode
comma
id|file
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
DECL|function|cow_revalidate
r_static
r_int
id|cow_revalidate
c_func
(paren
id|kdev_t
id|rdev
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Need to implement cow_revalidate&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|parse_unit
r_static
r_int
id|parse_unit
c_func
(paren
r_char
op_star
op_star
id|ptr
)paren
(brace
r_char
op_star
id|str
op_assign
op_star
id|ptr
comma
op_star
id|end
suffix:semicolon
r_int
id|n
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|isdigit
c_func
(paren
op_star
id|str
)paren
)paren
(brace
id|n
op_assign
id|simple_strtoul
c_func
(paren
id|str
comma
op_amp
id|end
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|end
op_eq
id|str
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
op_star
id|ptr
op_assign
id|end
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
l_char|&squot;a&squot;
op_le
op_star
id|str
)paren
op_logical_and
(paren
op_star
id|str
op_le
l_char|&squot;h&squot;
)paren
)paren
(brace
id|n
op_assign
op_star
id|str
op_minus
l_char|&squot;a&squot;
suffix:semicolon
id|str
op_increment
suffix:semicolon
op_star
id|ptr
op_assign
id|str
suffix:semicolon
)brace
r_return
id|n
suffix:semicolon
)brace
DECL|function|cow_setup
r_static
r_int
id|cow_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_struct
id|cow
op_star
id|dev
suffix:semicolon
r_char
op_star
id|cow_name
comma
op_star
id|backing_name
suffix:semicolon
r_int
id|unit
suffix:semicolon
id|unit
op_assign
id|parse_unit
c_func
(paren
op_amp
id|str
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unit
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cow_setup - Couldn&squot;t parse unit number&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|str
op_ne
l_char|&squot;=&squot;
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cow_setup - Missing &squot;=&squot; after unit &quot;
l_string|&quot;number&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|str
op_increment
suffix:semicolon
id|cow_name
op_assign
id|str
suffix:semicolon
id|backing_name
op_assign
id|strchr
c_func
(paren
id|str
comma
l_char|&squot;,&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|backing_name
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cow_setup - missing backing device name&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|backing_name
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|backing_name
op_increment
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|cow_lock
)paren
suffix:semicolon
id|dev
op_assign
op_amp
id|cow_dev
(braket
id|unit
)braket
suffix:semicolon
id|dev-&gt;cow_path
op_assign
id|cow_name
suffix:semicolon
id|dev-&gt;backing_path
op_assign
id|backing_name
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|cow_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;cow&quot;
comma
id|cow_setup
)paren
suffix:semicolon
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-file-style: &quot;linux&quot;&n; * End:&n; */
eof
