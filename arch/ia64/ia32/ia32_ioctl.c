multiline_comment|/*&n; * IA32 Architecture-specific ioctl shim code&n; *&n; * Copyright (C) 2000 VA Linux Co&n; * Copyright (C) 2000 Don Dugger &lt;n0ano@valinux.com&gt;&n; * Copyright (C) 2001-2003 Hewlett-Packard Co&n; *&t;David Mosberger-Tang &lt;davidm@hpl.hp.com&gt;&n; */
macro_line|#include &lt;linux/signal.h&gt;&t;/* argh, msdos_fs.h isn&squot;t self-contained... */
macro_line|#include &quot;ia32priv.h&quot;
DECL|macro|INCLUDES
mdefine_line|#define&t;INCLUDES
macro_line|#include &quot;compat_ioctl.c&quot;
macro_line|#include &lt;asm/ioctl32.h&gt;
DECL|macro|IOCTL_NR
mdefine_line|#define IOCTL_NR(a)&t;((a) &amp; ~(_IOC_SIZEMASK &lt;&lt; _IOC_SIZESHIFT))
DECL|macro|DO_IOCTL
mdefine_line|#define DO_IOCTL(fd, cmd, arg) ({&t;&t;&t;&bslash;&n;&t;int _ret;&t;&t;&t;&t;&t;&bslash;&n;&t;mm_segment_t _old_fs = get_fs();&t;&t;&bslash;&n;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;set_fs(KERNEL_DS);&t;&t;&t;&t;&bslash;&n;&t;_ret = sys_ioctl(fd, cmd, (unsigned long)arg);&t;&bslash;&n;&t;set_fs(_old_fs);&t;&t;&t;&t;&bslash;&n;&t;_ret;&t;&t;&t;&t;&t;&t;&bslash;&n;})
DECL|macro|P
mdefine_line|#define P(i)&t;((void *)(unsigned long)(i))
id|asmlinkage
r_int
id|sys_ioctl
c_func
(paren
r_int
r_int
id|fd
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
DECL|macro|CODE
mdefine_line|#define CODE
macro_line|#include &quot;compat_ioctl.c&quot;
DECL|macro|VFAT_IOCTL_READDIR_BOTH32
mdefine_line|#define&t;VFAT_IOCTL_READDIR_BOTH32&t;_IOR(&squot;r&squot;, 1, struct linux32_dirent[2])
DECL|macro|VFAT_IOCTL_READDIR_SHORT32
mdefine_line|#define&t;VFAT_IOCTL_READDIR_SHORT32&t;_IOR(&squot;r&squot;, 2, struct linux32_dirent[2])
r_static
r_int
DECL|function|put_dirent32
id|put_dirent32
(paren
r_struct
id|dirent
op_star
id|d
comma
r_struct
id|linux32_dirent
op_star
id|d32
)paren
(brace
r_int
id|namelen
op_assign
id|strlen
c_func
(paren
id|d-&gt;d_name
)paren
suffix:semicolon
r_return
(paren
id|put_user
c_func
(paren
id|d-&gt;d_ino
comma
op_amp
id|d32-&gt;d_ino
)paren
op_logical_or
id|put_user
c_func
(paren
id|d-&gt;d_off
comma
op_amp
id|d32-&gt;d_off
)paren
op_logical_or
id|put_user
c_func
(paren
id|d-&gt;d_reclen
comma
op_amp
id|d32-&gt;d_reclen
)paren
op_logical_or
id|copy_to_user
c_func
(paren
id|d32-&gt;d_name
comma
id|d-&gt;d_name
comma
id|namelen
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
DECL|function|vfat_ioctl32
r_static
r_int
id|vfat_ioctl32
c_func
(paren
r_int
id|fd
comma
r_int
id|cmd
comma
r_void
op_star
id|ptr
)paren
(brace
r_int
id|ret
suffix:semicolon
id|mm_segment_t
id|oldfs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
r_struct
id|dirent
id|d
(braket
l_int|2
)braket
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
id|ret
op_assign
id|sys_ioctl
c_func
(paren
id|fd
comma
id|cmd
comma
(paren
r_int
r_int
)paren
op_amp
id|d
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|oldfs
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|ret
op_or_assign
id|put_dirent32
c_func
(paren
op_amp
id|d
(braket
l_int|0
)braket
comma
(paren
r_struct
id|linux32_dirent
op_star
)paren
id|ptr
)paren
suffix:semicolon
id|ret
op_or_assign
id|put_dirent32
c_func
(paren
op_amp
id|d
(braket
l_int|1
)braket
comma
(paren
(paren
r_struct
id|linux32_dirent
op_star
)paren
id|ptr
)paren
op_plus
l_int|1
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|typedef|ioctl32_handler_t
r_typedef
r_int
(paren
op_star
id|ioctl32_handler_t
)paren
(paren
r_int
r_int
comma
r_int
r_int
comma
r_int
r_int
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
DECL|macro|COMPATIBLE_IOCTL
mdefine_line|#define COMPATIBLE_IOCTL(cmd)&t;&t;HANDLE_IOCTL((cmd),sys_ioctl)
DECL|macro|HANDLE_IOCTL
mdefine_line|#define HANDLE_IOCTL(cmd,handler)&t;{ (cmd), (ioctl32_handler_t)(handler), NULL },
DECL|macro|IOCTL_TABLE_START
mdefine_line|#define IOCTL_TABLE_START &bslash;&n;&t;struct ioctl_trans ioctl_start[] = {
DECL|macro|IOCTL_TABLE_END
mdefine_line|#define IOCTL_TABLE_END &bslash;&n;&t;};
id|IOCTL_TABLE_START
id|HANDLE_IOCTL
c_func
(paren
id|VFAT_IOCTL_READDIR_BOTH32
comma
id|vfat_ioctl32
)paren
id|HANDLE_IOCTL
c_func
(paren
id|VFAT_IOCTL_READDIR_SHORT32
comma
id|vfat_ioctl32
)paren
DECL|macro|DECLARES
mdefine_line|#define DECLARES
macro_line|#include &quot;compat_ioctl.c&quot;
macro_line|#include &lt;linux/compat_ioctl.h&gt;
id|IOCTL_TABLE_END
r_int
id|ioctl_table_size
op_assign
id|ARRAY_SIZE
c_func
(paren
id|ioctl_start
)paren
suffix:semicolon
eof
