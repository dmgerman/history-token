multiline_comment|/*&n; * Instruction-patching support.&n; *&n; * Copyright (C) 2003 Hewlett-Packard Co&n; *&t;David Mosberger-Tang &lt;davidm@hpl.hp.com&gt;&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/patch.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/unistd.h&gt;
multiline_comment|/*&n; * This was adapted from code written by Tony Luck:&n; *&n; * The 64-bit value in a &quot;movl reg=value&quot; is scattered between the two words of the bundle&n; * like this:&n; *&n; * 6  6         5         4         3         2         1&n; * 3210987654321098765432109876543210987654321098765432109876543210&n; * ABBBBBBBBBBBBBBBBBBBBBBBCCCCCCCCCCCCCCCCCCDEEEEEFFFFFFFFFGGGGGGG&n; *&n; * CCCCCCCCCCCCCCCCCCxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&n; * xxxxAFFFFFFFFFEEEEEDxGGGGGGGxxxxxxxxxxxxxBBBBBBBBBBBBBBBBBBBBBBB&n; */
r_static
id|u64
DECL|function|get_imm64
id|get_imm64
(paren
id|u64
id|insn_addr
)paren
(brace
id|u64
op_star
id|p
op_assign
(paren
id|u64
op_star
)paren
(paren
id|insn_addr
op_amp
op_minus
l_int|16
)paren
suffix:semicolon
multiline_comment|/* mask out slot number */
r_return
(paren
(paren
id|p
(braket
l_int|1
)braket
op_amp
l_int|0x0800000000000000UL
)paren
op_lshift
l_int|4
)paren
op_or
multiline_comment|/*A*/
(paren
(paren
id|p
(braket
l_int|1
)braket
op_amp
l_int|0x00000000007fffffUL
)paren
op_lshift
l_int|40
)paren
op_or
multiline_comment|/*B*/
(paren
(paren
id|p
(braket
l_int|0
)braket
op_amp
l_int|0xffffc00000000000UL
)paren
op_rshift
l_int|24
)paren
op_or
multiline_comment|/*C*/
(paren
(paren
id|p
(braket
l_int|1
)braket
op_amp
l_int|0x0000100000000000UL
)paren
op_rshift
l_int|23
)paren
op_or
multiline_comment|/*D*/
(paren
(paren
id|p
(braket
l_int|1
)braket
op_amp
l_int|0x0003e00000000000UL
)paren
op_rshift
l_int|29
)paren
op_or
multiline_comment|/*E*/
(paren
(paren
id|p
(braket
l_int|1
)braket
op_amp
l_int|0x07fc000000000000UL
)paren
op_rshift
l_int|43
)paren
op_or
multiline_comment|/*F*/
(paren
(paren
id|p
(braket
l_int|1
)braket
op_amp
l_int|0x000007f000000000UL
)paren
op_rshift
l_int|36
)paren
suffix:semicolon
multiline_comment|/*G*/
)brace
multiline_comment|/* Patch instruction with &quot;val&quot; where &quot;mask&quot; has 1 bits. */
r_void
DECL|function|ia64_patch
id|ia64_patch
(paren
id|u64
id|insn_addr
comma
id|u64
id|mask
comma
id|u64
id|val
)paren
(brace
id|u64
id|m0
comma
id|m1
comma
id|v0
comma
id|v1
comma
id|b0
comma
id|b1
comma
op_star
id|b
op_assign
(paren
id|u64
op_star
)paren
(paren
id|insn_addr
op_amp
op_minus
l_int|16
)paren
suffix:semicolon
DECL|macro|insn_mask
macro_line|#&t;define insn_mask ((1UL &lt;&lt; 41) - 1)
r_int
r_int
id|shift
suffix:semicolon
id|b0
op_assign
id|b
(braket
l_int|0
)braket
suffix:semicolon
id|b1
op_assign
id|b
(braket
l_int|1
)braket
suffix:semicolon
id|shift
op_assign
l_int|5
op_plus
l_int|41
op_star
(paren
id|insn_addr
op_mod
l_int|16
)paren
suffix:semicolon
multiline_comment|/* 5 bits of template, then 3 x 41-bit instructions */
r_if
c_cond
(paren
id|shift
op_ge
l_int|64
)paren
(brace
id|m1
op_assign
id|mask
op_lshift
(paren
id|shift
op_minus
l_int|64
)paren
suffix:semicolon
id|v1
op_assign
id|val
op_lshift
(paren
id|shift
op_minus
l_int|64
)paren
suffix:semicolon
)brace
r_else
(brace
id|m0
op_assign
id|mask
op_lshift
id|shift
suffix:semicolon
id|m1
op_assign
id|mask
op_rshift
(paren
l_int|64
op_minus
id|shift
)paren
suffix:semicolon
id|v0
op_assign
id|val
op_lshift
id|shift
suffix:semicolon
id|v1
op_assign
id|val
op_rshift
(paren
l_int|64
op_minus
id|shift
)paren
suffix:semicolon
id|b
(braket
l_int|0
)braket
op_assign
(paren
id|b0
op_amp
op_complement
id|m0
)paren
op_or
(paren
id|v0
op_amp
id|m0
)paren
suffix:semicolon
)brace
id|b
(braket
l_int|1
)braket
op_assign
(paren
id|b1
op_amp
op_complement
id|m1
)paren
op_or
(paren
id|v1
op_amp
id|m1
)paren
suffix:semicolon
)brace
r_void
DECL|function|ia64_patch_imm64
id|ia64_patch_imm64
(paren
id|u64
id|insn_addr
comma
id|u64
id|val
)paren
(brace
id|ia64_patch
c_func
(paren
id|insn_addr
comma
l_int|0x01fffefe000
comma
(paren
(paren
(paren
id|val
op_amp
l_int|0x8000000000000000
)paren
op_rshift
l_int|27
)paren
multiline_comment|/* bit 63 -&gt; 36 */
op_or
(paren
(paren
id|val
op_amp
l_int|0x0000000000200000
)paren
op_lshift
l_int|0
)paren
multiline_comment|/* bit 21 -&gt; 21 */
op_or
(paren
(paren
id|val
op_amp
l_int|0x00000000001f0000
)paren
op_lshift
l_int|6
)paren
multiline_comment|/* bit 16 -&gt; 22 */
op_or
(paren
(paren
id|val
op_amp
l_int|0x000000000000ff80
)paren
op_lshift
l_int|20
)paren
multiline_comment|/* bit  7 -&gt; 27 */
op_or
(paren
(paren
id|val
op_amp
l_int|0x000000000000007f
)paren
op_lshift
l_int|13
)paren
multiline_comment|/* bit  0 -&gt; 13 */
)paren
)paren
suffix:semicolon
id|ia64_patch
c_func
(paren
id|insn_addr
op_minus
l_int|1
comma
l_int|0x1ffffffffff
comma
id|val
op_rshift
l_int|22
)paren
suffix:semicolon
)brace
r_void
DECL|function|ia64_patch_imm60
id|ia64_patch_imm60
(paren
id|u64
id|insn_addr
comma
id|u64
id|val
)paren
(brace
id|ia64_patch
c_func
(paren
id|insn_addr
comma
l_int|0x011ffffe000
comma
(paren
(paren
(paren
id|val
op_amp
l_int|0x1000000000000000
)paren
op_rshift
l_int|24
)paren
multiline_comment|/* bit 60 -&gt; 36 */
op_or
(paren
(paren
id|val
op_amp
l_int|0x00000000000fffff
)paren
op_lshift
l_int|13
)paren
multiline_comment|/* bit  0 -&gt; 13 */
)paren
)paren
suffix:semicolon
id|ia64_patch
c_func
(paren
id|insn_addr
op_minus
l_int|1
comma
l_int|0x1fffffffffc
comma
id|val
op_rshift
l_int|18
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * We need sometimes to load the physical address of a kernel&n; * object.  Often we can convert the virtual address to physical&n; * at execution time, but sometimes (either for performance reasons&n; * or during error recovery) we cannot to this.  Patch the marked&n; * bundles to load the physical address.&n; */
r_void
id|__init
DECL|function|ia64_patch_vtop
id|ia64_patch_vtop
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
id|s32
op_star
id|offp
op_assign
(paren
id|s32
op_star
)paren
id|start
suffix:semicolon
id|u64
id|ip
suffix:semicolon
r_while
c_loop
(paren
id|offp
OL
(paren
id|s32
op_star
)paren
id|end
)paren
(brace
id|ip
op_assign
(paren
id|u64
)paren
id|offp
op_plus
op_star
id|offp
suffix:semicolon
multiline_comment|/* replace virtual address with corresponding physical address: */
id|ia64_patch_imm64
c_func
(paren
id|ip
comma
id|ia64_tpa
c_func
(paren
id|get_imm64
c_func
(paren
id|ip
)paren
)paren
)paren
suffix:semicolon
id|ia64_fc
c_func
(paren
id|ip
)paren
suffix:semicolon
op_increment
id|offp
suffix:semicolon
)brace
id|ia64_insn_group_barrier
c_func
(paren
)paren
suffix:semicolon
id|ia64_sync_i
c_func
(paren
)paren
suffix:semicolon
id|ia64_insn_group_barrier
c_func
(paren
)paren
suffix:semicolon
id|ia64_srlz_i
c_func
(paren
)paren
suffix:semicolon
id|ia64_insn_group_barrier
c_func
(paren
)paren
suffix:semicolon
)brace
r_void
DECL|function|ia64_patch_mckinley_e9
id|ia64_patch_mckinley_e9
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
r_static
r_int
id|first_time
op_assign
l_int|1
suffix:semicolon
r_int
id|need_workaround
suffix:semicolon
id|s32
op_star
id|offp
op_assign
(paren
id|s32
op_star
)paren
id|start
suffix:semicolon
id|u64
op_star
id|wp
suffix:semicolon
id|need_workaround
op_assign
(paren
id|local_cpu_data-&gt;family
op_eq
l_int|0x1f
op_logical_and
id|local_cpu_data-&gt;model
op_eq
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|first_time
)paren
(brace
id|first_time
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|need_workaround
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Leaving McKinley Errata 9 workaround enabled&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;McKinley Errata 9 workaround not needed; &quot;
l_string|&quot;disabling it&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|need_workaround
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
id|offp
OL
(paren
id|s32
op_star
)paren
id|end
)paren
(brace
id|wp
op_assign
(paren
id|u64
op_star
)paren
id|ia64_imva
c_func
(paren
(paren
r_char
op_star
)paren
id|offp
op_plus
op_star
id|offp
)paren
suffix:semicolon
id|wp
(braket
l_int|0
)braket
op_assign
l_int|0x0000000100000000
suffix:semicolon
id|wp
(braket
l_int|1
)braket
op_assign
l_int|0x0004000000000200
suffix:semicolon
id|ia64_fc
c_func
(paren
id|wp
)paren
suffix:semicolon
op_increment
id|offp
suffix:semicolon
)brace
id|ia64_insn_group_barrier
c_func
(paren
)paren
suffix:semicolon
id|ia64_sync_i
c_func
(paren
)paren
suffix:semicolon
id|ia64_insn_group_barrier
c_func
(paren
)paren
suffix:semicolon
id|ia64_srlz_i
c_func
(paren
)paren
suffix:semicolon
id|ia64_insn_group_barrier
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|patch_fsyscall_table
id|patch_fsyscall_table
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
r_extern
r_int
r_int
id|fsyscall_table
(braket
id|NR_syscalls
)braket
suffix:semicolon
id|s32
op_star
id|offp
op_assign
(paren
id|s32
op_star
)paren
id|start
suffix:semicolon
r_while
c_loop
(paren
id|offp
OL
(paren
id|s32
op_star
)paren
id|end
)paren
(brace
id|ia64_patch_imm64
c_func
(paren
(paren
id|u64
)paren
id|ia64_imva
c_func
(paren
(paren
r_char
op_star
)paren
id|offp
op_plus
op_star
id|offp
)paren
comma
(paren
id|u64
)paren
id|fsyscall_table
)paren
suffix:semicolon
op_increment
id|offp
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|patch_brl_fsys_bubble_down
id|patch_brl_fsys_bubble_down
(paren
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
r_extern
r_char
id|fsys_bubble_down
(braket
)braket
suffix:semicolon
id|s32
op_star
id|offp
op_assign
(paren
id|s32
op_star
)paren
id|start
suffix:semicolon
id|u64
id|ip
suffix:semicolon
r_while
c_loop
(paren
id|offp
OL
(paren
id|s32
op_star
)paren
id|end
)paren
(brace
id|ip
op_assign
(paren
id|u64
)paren
id|offp
op_plus
op_star
id|offp
suffix:semicolon
id|ia64_patch_imm60
c_func
(paren
(paren
id|u64
)paren
id|ia64_imva
c_func
(paren
(paren
r_void
op_star
)paren
id|ip
)paren
comma
(paren
id|u64
)paren
(paren
id|fsys_bubble_down
op_minus
(paren
id|ip
op_amp
op_minus
l_int|16
)paren
)paren
op_div
l_int|16
)paren
suffix:semicolon
op_increment
id|offp
suffix:semicolon
)brace
)brace
r_void
DECL|function|ia64_patch_gate
id|ia64_patch_gate
(paren
id|Elf64_Ehdr
op_star
id|ehdr
)paren
(brace
id|Elf64_Shdr
op_star
id|shdr
comma
op_star
id|strsec
comma
op_star
id|sec
suffix:semicolon
id|Elf64_Half
id|i
suffix:semicolon
r_int
r_int
id|start
comma
id|end
suffix:semicolon
r_char
op_star
id|strtab
comma
op_star
id|name
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|ehdr-&gt;e_ident
comma
id|ELFMAG
comma
id|SELFMAG
)paren
op_ne
l_int|0
op_logical_or
id|ehdr-&gt;e_type
op_ne
id|ET_DYN
op_logical_or
op_logical_neg
id|elf_check_arch
c_func
(paren
id|ehdr
)paren
)paren
multiline_comment|/*&n;&t;&t; * Without the gate shared library, we can&squot;t do signal return or fast&n;&t;&t; * system calls.  In other words, the kernel will crash quickly anyhow, so&n;&t;&t; * we might just as well do it now...&n;&t;&t; */
id|panic
c_func
(paren
l_string|&quot;%s: gate shared library at %p not a valid ELF object!&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ehdr
)paren
suffix:semicolon
id|shdr
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|ehdr
op_plus
id|ehdr-&gt;e_shoff
)paren
suffix:semicolon
id|strsec
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|shdr
op_plus
id|ehdr-&gt;e_shstrndx
op_star
id|ehdr-&gt;e_shentsize
)paren
suffix:semicolon
id|strtab
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|ehdr
op_plus
id|strsec-&gt;sh_offset
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ehdr-&gt;e_shnum
suffix:semicolon
op_increment
id|i
)paren
(brace
id|sec
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|shdr
op_plus
id|i
op_star
id|ehdr-&gt;e_shentsize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|strtab
op_plus
id|sec-&gt;sh_name
comma
l_string|&quot;.data.patch.&quot;
comma
l_int|12
)paren
op_ne
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|sec-&gt;sh_size
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
id|name
op_assign
id|strtab
op_plus
id|sec-&gt;sh_name
op_plus
l_int|12
suffix:semicolon
id|start
op_assign
id|sec-&gt;sh_addr
suffix:semicolon
id|end
op_assign
id|start
op_plus
id|sec-&gt;sh_size
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|name
comma
l_string|&quot;fsyscall_table&quot;
)paren
op_eq
l_int|0
)paren
id|patch_fsyscall_table
c_func
(paren
id|start
comma
id|end
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|name
comma
l_string|&quot;brl_fsys_bubble_down&quot;
)paren
op_eq
l_int|0
)paren
id|patch_brl_fsys_bubble_down
c_func
(paren
id|start
comma
id|end
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|name
comma
l_string|&quot;top&quot;
)paren
op_eq
l_int|0
)paren
id|ia64_patch_vtop
c_func
(paren
id|start
comma
id|end
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|name
comma
l_string|&quot;mckinley_e9&quot;
)paren
op_eq
l_int|0
)paren
id|ia64_patch_mckinley_e9
c_func
(paren
id|start
comma
id|end
)paren
suffix:semicolon
r_else
id|panic
c_func
(paren
l_string|&quot;%s: found unknown patch-list `%s&squot;&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|name
)paren
suffix:semicolon
)brace
)brace
eof
