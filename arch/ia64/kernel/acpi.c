multiline_comment|/*&n; *  acpi.c - Architecture-Specific Low-Level ACPI Support&n; *&n; *  Copyright (C) 1999 VA Linux Systems&n; *  Copyright (C) 1999,2000 Walt Drummond &lt;drummond@valinux.com&gt;&n; *  Copyright (C) 2000 Hewlett-Packard Co.&n; *  Copyright (C) 2000 David Mosberger-Tang &lt;davidm@hpl.hp.com&gt;&n; *  Copyright (C) 2000 Intel Corp.&n; *  Copyright (C) 2000,2001 J.I. Lee &lt;jung-ik.lee@intel.com&gt;&n; *  Copyright (C) 2001 Paul Diefenbaugh &lt;paul.s.diefenbaugh@intel.com&gt;&n; *&n; * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA&n; *&n; * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/acpi.h&gt;
macro_line|#include &lt;asm/efi.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/iosapic.h&gt;
macro_line|#include &lt;asm/machvec.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/system.h&gt;
DECL|macro|PREFIX
mdefine_line|#define PREFIX&t;&t;&t;&quot;ACPI: &quot;
id|asm
(paren
l_string|&quot;.weak iosapic_register_irq&quot;
)paren
suffix:semicolon
id|asm
(paren
l_string|&quot;.weak iosapic_register_legacy_irq&quot;
)paren
suffix:semicolon
id|asm
(paren
l_string|&quot;.weak iosapic_register_platform_irq&quot;
)paren
suffix:semicolon
id|asm
(paren
l_string|&quot;.weak iosapic_init&quot;
)paren
suffix:semicolon
id|asm
(paren
l_string|&quot;.weak iosapic_version&quot;
)paren
suffix:semicolon
DECL|variable|pm_idle
r_void
(paren
op_star
id|pm_idle
)paren
(paren
r_void
)paren
suffix:semicolon
DECL|variable|pm_power_off
r_void
(paren
op_star
id|pm_power_off
)paren
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/*&n; * TBD: Should go away once we have an ACPI parser.&n; */
r_const
r_char
op_star
DECL|function|acpi_get_sysname
id|acpi_get_sysname
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_IA64_GENERIC
r_return
l_string|&quot;hpsim&quot;
suffix:semicolon
macro_line|#else
macro_line|# if defined (CONFIG_IA64_HP_SIM)
r_return
l_string|&quot;hpsim&quot;
suffix:semicolon
macro_line|# elif defined (CONFIG_IA64_SGI_SN1)
r_return
l_string|&quot;sn1&quot;
suffix:semicolon
macro_line|# elif defined (CONFIG_IA64_SGI_SN2)
r_return
l_string|&quot;sn2&quot;
suffix:semicolon
macro_line|# elif defined (CONFIG_IA64_DIG)
r_return
l_string|&quot;dig&quot;
suffix:semicolon
macro_line|# else
macro_line|#&t;error Unknown platform.  Fix acpi.c.
macro_line|# endif
macro_line|#endif
)brace
macro_line|#ifdef CONFIG_ACPI_BOOT
DECL|macro|ACPI_MAX_PLATFORM_IRQS
mdefine_line|#define ACPI_MAX_PLATFORM_IRQS&t;256
multiline_comment|/* Array to record platform interrupt vectors for generic interrupt routing. */
DECL|variable|platform_irq_list
r_int
id|platform_irq_list
(braket
id|ACPI_MAX_PLATFORM_IRQS
)braket
suffix:semicolon
multiline_comment|/*&n; * Interrupt routing API for device drivers.  Provides interrupt vector for&n; * a generic platform event.  Currently only CPEI is implemented.&n; */
r_int
DECL|function|acpi_request_vector
id|acpi_request_vector
(paren
id|u32
id|int_type
)paren
(brace
r_int
id|vector
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|int_type
OL
id|ACPI_MAX_PLATFORM_IRQS
)paren
(brace
multiline_comment|/* correctable platform error interrupt */
id|vector
op_assign
id|platform_irq_list
(braket
id|int_type
)braket
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;acpi_request_vector(): invalid interrupt type&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|vector
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;                            Boot-time Table Parsing&n;   -------------------------------------------------------------------------- */
DECL|variable|__initdata
r_static
r_int
id|total_cpus
id|__initdata
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|available_cpus
id|__initdata
suffix:semicolon
DECL|variable|__initdata
r_struct
id|acpi_table_madt
op_star
id|acpi_madt
id|__initdata
suffix:semicolon
r_static
r_int
id|__init
DECL|function|acpi_parse_lapic_addr_ovr
id|acpi_parse_lapic_addr_ovr
(paren
id|acpi_table_entry_header
op_star
id|header
)paren
(brace
r_struct
id|acpi_table_lapic_addr_ovr
op_star
id|lapic
op_assign
l_int|NULL
suffix:semicolon
id|lapic
op_assign
(paren
r_struct
id|acpi_table_lapic_addr_ovr
op_star
)paren
id|header
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lapic
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|acpi_table_print_madt_entry
c_func
(paren
id|header
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lapic-&gt;address
)paren
(brace
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|ipi_base_addr
)paren
suffix:semicolon
id|ipi_base_addr
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|lapic-&gt;address
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|acpi_parse_lsapic
id|acpi_parse_lsapic
(paren
id|acpi_table_entry_header
op_star
id|header
)paren
(brace
r_struct
id|acpi_table_lsapic
op_star
id|lsapic
op_assign
l_int|NULL
suffix:semicolon
id|lsapic
op_assign
(paren
r_struct
id|acpi_table_lsapic
op_star
)paren
id|header
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lsapic
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|acpi_table_print_madt_entry
c_func
(paren
id|header
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;CPU %d (0x%04x)&quot;
comma
id|total_cpus
comma
(paren
id|lsapic-&gt;id
op_lshift
l_int|8
)paren
op_or
id|lsapic-&gt;eid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lsapic-&gt;flags.enabled
)paren
(brace
id|available_cpus
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; enabled&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
id|smp_boot_data.cpu_phys_id
(braket
id|total_cpus
)braket
op_assign
(paren
id|lsapic-&gt;id
op_lshift
l_int|8
)paren
op_or
id|lsapic-&gt;eid
suffix:semicolon
r_if
c_cond
(paren
id|hard_smp_processor_id
c_func
(paren
)paren
op_eq
id|smp_boot_data.cpu_phys_id
(braket
id|total_cpus
)braket
)paren
id|printk
c_func
(paren
l_string|&quot; (BSP)&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot; disabled&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
id|smp_boot_data.cpu_phys_id
(braket
id|total_cpus
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#endif
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|total_cpus
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|acpi_parse_lapic_nmi
id|acpi_parse_lapic_nmi
(paren
id|acpi_table_entry_header
op_star
id|header
)paren
(brace
r_struct
id|acpi_table_lapic_nmi
op_star
id|lacpi_nmi
op_assign
l_int|NULL
suffix:semicolon
id|lacpi_nmi
op_assign
(paren
r_struct
id|acpi_table_lapic_nmi
op_star
)paren
id|header
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lacpi_nmi
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|acpi_table_print_madt_entry
c_func
(paren
id|header
)paren
suffix:semicolon
multiline_comment|/* TBD: Support lapic_nmi entries */
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|acpi_find_iosapic
id|acpi_find_iosapic
(paren
r_int
id|global_vector
comma
id|u32
op_star
id|irq_base
comma
r_char
op_star
op_star
id|iosapic_address
)paren
(brace
r_struct
id|acpi_table_iosapic
op_star
id|iosapic
op_assign
l_int|NULL
suffix:semicolon
r_int
id|ver
op_assign
l_int|0
suffix:semicolon
r_int
id|max_pin
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|p
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|end
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|irq_base
op_logical_or
op_logical_neg
id|iosapic_address
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|p
op_assign
(paren
r_char
op_star
)paren
(paren
id|acpi_madt
op_plus
l_int|1
)paren
suffix:semicolon
id|end
op_assign
id|p
op_plus
(paren
id|acpi_madt-&gt;header.length
op_minus
r_sizeof
(paren
r_struct
id|acpi_table_madt
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|p
OL
id|end
)paren
(brace
r_if
c_cond
(paren
op_star
id|p
op_eq
id|ACPI_MADT_IOSAPIC
)paren
(brace
id|iosapic
op_assign
(paren
r_struct
id|acpi_table_iosapic
op_star
)paren
id|p
suffix:semicolon
op_star
id|irq_base
op_assign
id|iosapic-&gt;global_irq_base
suffix:semicolon
op_star
id|iosapic_address
op_assign
id|ioremap
c_func
(paren
id|iosapic-&gt;address
comma
l_int|0
)paren
suffix:semicolon
id|ver
op_assign
id|iosapic_version
c_func
(paren
op_star
id|iosapic_address
)paren
suffix:semicolon
id|max_pin
op_assign
(paren
id|ver
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
(paren
id|global_vector
op_minus
op_star
id|irq_base
)paren
op_le
id|max_pin
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Found it! */
)brace
id|p
op_add_assign
id|p
(braket
l_int|1
)braket
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|acpi_parse_iosapic
id|acpi_parse_iosapic
(paren
id|acpi_table_entry_header
op_star
id|header
)paren
(brace
r_struct
id|acpi_table_iosapic
op_star
id|iosapic
suffix:semicolon
id|iosapic
op_assign
(paren
r_struct
id|acpi_table_iosapic
op_star
)paren
id|header
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iosapic
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|acpi_table_print_madt_entry
c_func
(paren
id|header
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iosapic_init
)paren
(brace
macro_line|#ifndef CONFIG_ITANIUM
multiline_comment|/* PCAT_COMPAT flag indicates dual-8259 setup */
id|iosapic_init
c_func
(paren
id|iosapic-&gt;address
comma
id|iosapic-&gt;global_irq_base
comma
id|acpi_madt-&gt;flags.pcat_compat
)paren
suffix:semicolon
macro_line|#else
multiline_comment|/* Firmware on old Itanium systems is broken */
id|iosapic_init
c_func
(paren
id|iosapic-&gt;address
comma
id|iosapic-&gt;global_irq_base
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|acpi_parse_plat_int_src
id|acpi_parse_plat_int_src
(paren
id|acpi_table_entry_header
op_star
id|header
)paren
(brace
r_struct
id|acpi_table_plat_int_src
op_star
id|plintsrc
op_assign
l_int|NULL
suffix:semicolon
r_int
id|vector
op_assign
l_int|0
suffix:semicolon
id|u32
id|irq_base
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|iosapic_address
op_assign
l_int|NULL
suffix:semicolon
id|plintsrc
op_assign
(paren
r_struct
id|acpi_table_plat_int_src
op_star
)paren
id|header
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|plintsrc
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|acpi_table_print_madt_entry
c_func
(paren
id|header
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iosapic_register_platform_irq
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;No ACPI platform IRQ support&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|0
op_ne
id|acpi_find_iosapic
c_func
(paren
id|plintsrc-&gt;global_irq
comma
op_amp
id|irq_base
comma
op_amp
id|iosapic_address
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;IOSAPIC not found&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Get vector assignment for this IRQ, set attributes, and program the&n;&t; * IOSAPIC routing table.&n;&t; */
id|vector
op_assign
id|iosapic_register_platform_irq
(paren
id|plintsrc-&gt;type
comma
id|plintsrc-&gt;global_irq
comma
id|plintsrc-&gt;iosapic_vector
comma
id|plintsrc-&gt;eid
comma
id|plintsrc-&gt;id
comma
(paren
id|plintsrc-&gt;flags.polarity
op_eq
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
(paren
id|plintsrc-&gt;flags.trigger
op_eq
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
id|irq_base
comma
id|iosapic_address
)paren
suffix:semicolon
id|platform_irq_list
(braket
id|plintsrc-&gt;type
)braket
op_assign
id|vector
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|acpi_parse_int_src_ovr
id|acpi_parse_int_src_ovr
(paren
id|acpi_table_entry_header
op_star
id|header
)paren
(brace
r_struct
id|acpi_table_int_src_ovr
op_star
id|p
op_assign
l_int|NULL
suffix:semicolon
id|p
op_assign
(paren
r_struct
id|acpi_table_int_src_ovr
op_star
)paren
id|header
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|acpi_table_print_madt_entry
c_func
(paren
id|header
)paren
suffix:semicolon
multiline_comment|/* Ignore if the platform doesn&squot;t support overrides */
r_if
c_cond
(paren
op_logical_neg
id|iosapic_register_legacy_irq
)paren
r_return
l_int|0
suffix:semicolon
id|iosapic_register_legacy_irq
c_func
(paren
id|p-&gt;bus_irq
comma
id|p-&gt;global_irq
comma
(paren
id|p-&gt;flags.polarity
op_eq
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
(paren
id|p-&gt;flags.trigger
op_eq
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|acpi_parse_nmi_src
id|acpi_parse_nmi_src
(paren
id|acpi_table_entry_header
op_star
id|header
)paren
(brace
r_struct
id|acpi_table_nmi_src
op_star
id|nmi_src
op_assign
l_int|NULL
suffix:semicolon
id|nmi_src
op_assign
(paren
r_struct
id|acpi_table_nmi_src
op_star
)paren
id|header
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nmi_src
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|acpi_table_print_madt_entry
c_func
(paren
id|header
)paren
suffix:semicolon
multiline_comment|/* TBD: Support nimsrc entries */
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|acpi_parse_madt
id|acpi_parse_madt
(paren
r_int
r_int
id|phys_addr
comma
r_int
r_int
id|size
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|phys_addr
op_logical_or
op_logical_neg
id|size
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|acpi_madt
op_assign
(paren
r_struct
id|acpi_table_madt
op_star
)paren
id|__va
c_func
(paren
id|phys_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acpi_madt
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;Unable to map MADT&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Initialize platform interrupt vector array */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ACPI_MAX_PLATFORM_IRQS
suffix:semicolon
id|i
op_increment
)paren
id|platform_irq_list
(braket
id|i
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Get base address of IPI Message Block */
r_if
c_cond
(paren
id|acpi_madt-&gt;lapic_address
)paren
id|ipi_base_addr
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|acpi_madt-&gt;lapic_address
comma
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PREFIX
l_string|&quot;Local APIC address 0x%lx&bslash;n&quot;
comma
id|ipi_base_addr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
id|__init
DECL|function|acpi_find_rsdp
id|acpi_find_rsdp
(paren
r_int
r_int
op_star
id|rsdp_phys
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|rsdp_phys
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|efi.acpi20
)paren
(brace
(paren
op_star
id|rsdp_phys
)paren
op_assign
id|__pa
c_func
(paren
id|efi.acpi20
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|efi.acpi
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;v1.0/r0.71 tables no longer supported&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SERIAL_ACPI
macro_line|#include &lt;linux/acpi_serial.h&gt;
r_static
r_int
id|__init
DECL|function|acpi_parse_spcr
id|acpi_parse_spcr
(paren
r_int
r_int
id|phys_addr
comma
r_int
r_int
id|size
)paren
(brace
id|acpi_ser_t
op_star
id|spcr
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|global_int
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|phys_addr
op_logical_or
op_logical_neg
id|size
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iosapic_register_irq
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/*&n;&t; * ACPI is able to describe serial ports that live at non-standard&n;&t; * memory addresses and use non-standard interrupts, either via&n;&t; * direct SAPIC mappings or via PCI interrupts.  We handle interrupt&n;&t; * routing for SAPIC-based (non-PCI) devices here.  Interrupt routing&n;&t; * for PCI devices will be handled when processing the PCI Interrupt&n;&t; * Routing Table (PRT).&n;&t; */
id|spcr
op_assign
(paren
id|acpi_ser_t
op_star
)paren
id|__va
c_func
(paren
id|phys_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|spcr
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;Unable to map SPCR&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|setup_serial_acpi
c_func
(paren
id|spcr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|spcr-&gt;length
OL
r_sizeof
(paren
id|acpi_ser_t
)paren
)paren
multiline_comment|/* Table not long enough for full info, thus no interrupt */
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|spcr-&gt;base_addr.space_id
op_ne
id|ACPI_SERIAL_PCICONF_SPACE
)paren
op_logical_and
(paren
id|spcr-&gt;int_type
op_eq
id|ACPI_SERIAL_INT_SAPIC
)paren
)paren
(brace
id|u32
id|irq_base
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|iosapic_address
op_assign
l_int|NULL
suffix:semicolon
r_int
id|vector
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* We have a UART in memory space with an SAPIC interrupt */
id|global_int
op_assign
(paren
(paren
id|spcr-&gt;global_int
(braket
l_int|3
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|spcr-&gt;global_int
(braket
l_int|2
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|spcr-&gt;global_int
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|spcr-&gt;global_int
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* Which iosapic does this IRQ belong to? */
r_if
c_cond
(paren
l_int|0
op_eq
id|acpi_find_iosapic
c_func
(paren
id|global_int
comma
op_amp
id|irq_base
comma
op_amp
id|iosapic_address
)paren
)paren
(brace
id|vector
op_assign
id|iosapic_register_irq
(paren
id|global_int
comma
l_int|1
comma
l_int|1
comma
id|irq_base
comma
id|iosapic_address
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /*CONFIG_SERIAL_ACPI*/
r_int
id|__init
DECL|function|acpi_boot_init
id|acpi_boot_init
(paren
r_char
op_star
id|cmdline
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Initialize the ACPI boot-time table parser */
id|result
op_assign
id|acpi_table_init
c_func
(paren
id|cmdline
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|result
)paren
r_return
id|result
suffix:semicolon
multiline_comment|/*&n;&t; * MADT&n;&t; * ----&n;&t; * Parse the Multiple APIC Description Table (MADT), if exists.&n;&t; * Note that this table provides platform SMP configuration&n;&t; * information -- the successor to MPS tables.&n;&t; */
id|result
op_assign
id|acpi_table_parse
c_func
(paren
id|ACPI_APIC
comma
id|acpi_parse_madt
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|1
OG
id|result
)paren
r_return
id|result
suffix:semicolon
multiline_comment|/* Local APIC */
id|result
op_assign
id|acpi_table_parse_madt
c_func
(paren
id|ACPI_MADT_LAPIC_ADDR_OVR
comma
id|acpi_parse_lapic_addr_ovr
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
OG
id|result
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PREFIX
l_string|&quot;Error parsing LAPIC address override entry&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|result
op_assign
id|acpi_table_parse_madt
c_func
(paren
id|ACPI_MADT_LSAPIC
comma
id|acpi_parse_lsapic
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|1
OG
id|result
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PREFIX
l_string|&quot;Error parsing MADT - no LAPIC entries!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|result
op_assign
id|acpi_table_parse_madt
c_func
(paren
id|ACPI_MADT_LAPIC_NMI
comma
id|acpi_parse_lapic_nmi
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
OG
id|result
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PREFIX
l_string|&quot;Error parsing LAPIC NMI entry&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* I/O APIC */
id|result
op_assign
id|acpi_table_parse_madt
c_func
(paren
id|ACPI_MADT_IOSAPIC
comma
id|acpi_parse_iosapic
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|1
OG
id|result
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PREFIX
l_string|&quot;Error parsing MADT - no IOAPIC entries!&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
(paren
id|result
op_eq
l_int|0
)paren
ques
c_cond
op_minus
id|ENODEV
suffix:colon
id|result
)paren
suffix:semicolon
)brace
multiline_comment|/* System-Level Interrupt Routing */
id|result
op_assign
id|acpi_table_parse_madt
c_func
(paren
id|ACPI_MADT_PLAT_INT_SRC
comma
id|acpi_parse_plat_int_src
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
OG
id|result
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PREFIX
l_string|&quot;Error parsing platform interrupt source entry&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|result
op_assign
id|acpi_table_parse_madt
c_func
(paren
id|ACPI_MADT_INT_SRC_OVR
comma
id|acpi_parse_int_src_ovr
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
OG
id|result
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PREFIX
l_string|&quot;Error parsing interrupt source overrides entry&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|result
op_assign
id|acpi_table_parse_madt
c_func
(paren
id|ACPI_MADT_NMI_SRC
comma
id|acpi_parse_nmi_src
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
OG
id|result
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PREFIX
l_string|&quot;Error parsing NMI SRC entry&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SERIAL_ACPI
multiline_comment|/*&n;&t; * TBD: Need phased approach to table parsing (only do those absolutely&n;&t; *      required during boot-up).  Recommend expanding concept of fix-&n;&t; *      feature devices (LDM) to include table-based devices such as&n;&t; *      serial ports, EC, SMBus, etc.&n;&t; */
id|acpi_table_parse
c_func
(paren
id|ACPI_SPCR
comma
id|acpi_parse_spcr
)paren
suffix:semicolon
macro_line|#endif /*CONFIG_SERIAL_ACPI*/
macro_line|#ifdef CONFIG_SMP
r_if
c_cond
(paren
id|available_cpus
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ACPI: Found 0 CPUS; assuming 1&bslash;n&quot;
)paren
suffix:semicolon
id|available_cpus
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* We&squot;ve got at least one of these, no? */
)brace
id|smp_boot_data.cpu_count
op_assign
id|total_cpus
suffix:semicolon
macro_line|#endif
multiline_comment|/* Make boot-up look pretty */
id|printk
c_func
(paren
l_string|&quot;%d CPUs available, %d CPUs total&bslash;n&quot;
comma
id|available_cpus
comma
id|total_cpus
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;                             PCI Interrupt Routing&n;   -------------------------------------------------------------------------- */
r_int
id|__init
DECL|function|acpi_get_prt
id|acpi_get_prt
(paren
r_struct
id|pci_vector_struct
op_star
op_star
id|vectors
comma
r_int
op_star
id|count
)paren
(brace
r_struct
id|pci_vector_struct
op_star
id|vector
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|list_head
op_star
id|node
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|acpi_prt_entry
op_star
id|entry
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vectors
op_logical_or
op_logical_neg
id|count
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
op_star
id|vectors
op_assign
l_int|NULL
suffix:semicolon
op_star
id|count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|acpi_prts.count
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PREFIX
l_string|&quot;No PCI IRQ routing entries&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Allocate vectors */
op_star
id|vectors
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pci_vector_struct
)paren
op_star
id|acpi_prts.count
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|vectors
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* Convert PRT entries to IOSAPIC PCI vectors */
id|vector
op_assign
op_star
id|vectors
suffix:semicolon
id|list_for_each
c_func
(paren
id|node
comma
op_amp
id|acpi_prts.entries
)paren
(brace
id|entry
op_assign
(paren
r_struct
id|acpi_prt_entry
op_star
)paren
id|node
suffix:semicolon
id|vector
(braket
id|i
)braket
dot
id|bus
op_assign
(paren
id|u16
)paren
id|entry-&gt;id.bus
suffix:semicolon
id|vector
(braket
id|i
)braket
dot
id|pci_id
op_assign
(paren
id|u32
)paren
id|entry-&gt;id.dev
op_lshift
l_int|16
op_or
l_int|0xffff
suffix:semicolon
id|vector
(braket
id|i
)braket
dot
id|pin
op_assign
(paren
id|u8
)paren
id|entry-&gt;id.pin
suffix:semicolon
id|vector
(braket
id|i
)braket
dot
id|irq
op_assign
(paren
id|u8
)paren
id|entry-&gt;source.index
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
op_star
id|count
op_assign
id|acpi_prts.count
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Assume IA64 always use I/O SAPIC */
r_int
id|__init
DECL|function|acpi_get_interrupt_model
id|acpi_get_interrupt_model
(paren
r_int
op_star
id|type
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|type
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
op_star
id|type
op_assign
id|ACPI_INT_MODEL_IOSAPIC
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ACPI_BOOT */
eof
