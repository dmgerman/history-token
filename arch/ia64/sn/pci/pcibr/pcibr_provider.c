multiline_comment|/*&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Copyright (C) 2001-2004 Silicon Graphics, Inc. All rights reserved.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/sn/sn_sal.h&gt;
macro_line|#include &quot;xtalk/xwidgetdev.h&quot;
macro_line|#include &lt;asm/sn/geo.h&gt;
macro_line|#include &quot;xtalk/hubdev.h&quot;
macro_line|#include &quot;pci/pcibus_provider_defs.h&quot;
macro_line|#include &quot;pci/pcidev.h&quot;
macro_line|#include &quot;pci/pcibr_provider.h&quot;
macro_line|#include &lt;asm/sn/addrs.h&gt;
DECL|function|sal_pcibr_error_interrupt
r_static
r_int
id|sal_pcibr_error_interrupt
c_func
(paren
r_struct
id|pcibus_info
op_star
id|soft
)paren
(brace
r_struct
id|ia64_sal_retval
id|ret_stuff
suffix:semicolon
r_uint64
id|busnum
suffix:semicolon
r_int
id|segment
suffix:semicolon
id|ret_stuff.status
op_assign
l_int|0
suffix:semicolon
id|ret_stuff.v0
op_assign
l_int|0
suffix:semicolon
id|segment
op_assign
l_int|0
suffix:semicolon
id|busnum
op_assign
id|soft-&gt;pbi_buscommon.bs_persist_busnum
suffix:semicolon
id|SAL_CALL_NOLOCK
c_func
(paren
id|ret_stuff
comma
(paren
id|u64
)paren
id|SN_SAL_IOIF_ERROR_INTERRUPT
comma
(paren
id|u64
)paren
id|segment
comma
(paren
id|u64
)paren
id|busnum
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
(paren
r_int
)paren
id|ret_stuff.v0
suffix:semicolon
)brace
multiline_comment|/* &n; * PCI Bridge Error interrupt handler.  Gets invoked whenever a PCI &n; * bridge sends an error interrupt.&n; */
r_static
id|irqreturn_t
DECL|function|pcibr_error_intr_handler
id|pcibr_error_intr_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|arg
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|pcibus_info
op_star
id|soft
op_assign
(paren
r_struct
id|pcibus_info
op_star
)paren
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|sal_pcibr_error_interrupt
c_func
(paren
id|soft
)paren
OL
l_int|0
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;pcibr_error_intr_handler(): Fatal Bridge Error&quot;
)paren
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_void
op_star
DECL|function|pcibr_bus_fixup
id|pcibr_bus_fixup
c_func
(paren
r_struct
id|pcibus_bussoft
op_star
id|prom_bussoft
)paren
(brace
r_int
id|nasid
comma
id|cnode
comma
id|j
suffix:semicolon
r_struct
id|hubdev_info
op_star
id|hubdev_info
suffix:semicolon
r_struct
id|pcibus_info
op_star
id|soft
suffix:semicolon
r_struct
id|sn_flush_device_list
op_star
id|sn_flush_device_list
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_PCI_BRIDGE_ASIC
c_func
(paren
id|prom_bussoft-&gt;bs_asic_type
)paren
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Allocate kernel bus soft and copy from prom.&n;&t; */
id|soft
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pcibus_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|soft
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|soft
comma
id|prom_bussoft
comma
r_sizeof
(paren
r_struct
id|pcibus_info
)paren
)paren
suffix:semicolon
id|soft-&gt;pbi_buscommon.bs_base
op_assign
(paren
(paren
(paren
id|u64
)paren
id|soft-&gt;pbi_buscommon
dot
id|bs_base
op_lshift
l_int|4
)paren
op_rshift
l_int|4
)paren
op_or
id|__IA64_UNCACHED_OFFSET
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|soft-&gt;pbi_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * register the bridge&squot;s error interrupt handler&n;&t; */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|SGI_PCIBR_ERROR
comma
(paren
r_void
op_star
)paren
id|pcibr_error_intr_handler
comma
id|SA_SHIRQ
comma
l_string|&quot;PCIBR error&quot;
comma
(paren
r_void
op_star
)paren
(paren
id|soft
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;pcibr cannot allocate interrupt for error handler&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* &n;&t; * Update the Bridge with the &quot;kernel&quot; pagesize &n;&t; */
r_if
c_cond
(paren
id|PAGE_SIZE
OL
l_int|16384
)paren
(brace
id|pcireg_control_bit_clr
c_func
(paren
id|soft
comma
id|PCIBR_CTRL_PAGE_SIZE
)paren
suffix:semicolon
)brace
r_else
(brace
id|pcireg_control_bit_set
c_func
(paren
id|soft
comma
id|PCIBR_CTRL_PAGE_SIZE
)paren
suffix:semicolon
)brace
id|nasid
op_assign
id|NASID_GET
c_func
(paren
id|soft-&gt;pbi_buscommon.bs_base
)paren
suffix:semicolon
id|cnode
op_assign
id|nasid_to_cnodeid
c_func
(paren
id|nasid
)paren
suffix:semicolon
id|hubdev_info
op_assign
(paren
r_struct
id|hubdev_info
op_star
)paren
(paren
id|NODEPDA
c_func
(paren
id|cnode
)paren
op_member_access_from_pointer
id|pdinfo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hubdev_info-&gt;hdi_flush_nasid_list.widget_p
)paren
(brace
id|sn_flush_device_list
op_assign
id|hubdev_info-&gt;hdi_flush_nasid_list
dot
id|widget_p
(braket
(paren
r_int
)paren
id|soft-&gt;pbi_buscommon.bs_xid
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sn_flush_device_list
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|DEV_PER_WIDGET
suffix:semicolon
id|j
op_increment
comma
id|sn_flush_device_list
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sn_flush_device_list-&gt;sfdl_slot
op_eq
op_minus
l_int|1
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|sn_flush_device_list
op_member_access_from_pointer
id|sfdl_persistent_busnum
op_eq
id|soft-&gt;pbi_buscommon.bs_persist_busnum
)paren
id|sn_flush_device_list-&gt;sfdl_pcibus_info
op_assign
id|soft
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Setup the PMU ATE map */
id|soft-&gt;pbi_int_ate_resource.lowest_free_index
op_assign
l_int|0
suffix:semicolon
id|soft-&gt;pbi_int_ate_resource.ate
op_assign
id|kmalloc
c_func
(paren
id|soft-&gt;pbi_int_ate_size
op_star
r_sizeof
(paren
r_uint64
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|memset
c_func
(paren
id|soft-&gt;pbi_int_ate_resource.ate
comma
l_int|0
comma
(paren
id|soft-&gt;pbi_int_ate_size
op_star
r_sizeof
(paren
r_uint64
)paren
)paren
)paren
suffix:semicolon
r_return
id|soft
suffix:semicolon
)brace
DECL|function|pcibr_force_interrupt
r_void
id|pcibr_force_interrupt
c_func
(paren
r_struct
id|sn_irq_info
op_star
id|sn_irq_info
)paren
(brace
r_struct
id|pcidev_info
op_star
id|pcidev_info
suffix:semicolon
r_struct
id|pcibus_info
op_star
id|pcibus_info
suffix:semicolon
r_int
id|bit
op_assign
id|sn_irq_info-&gt;irq_int_bit
suffix:semicolon
id|pcidev_info
op_assign
(paren
r_struct
id|pcidev_info
op_star
)paren
id|sn_irq_info-&gt;irq_pciioinfo
suffix:semicolon
r_if
c_cond
(paren
id|pcidev_info
)paren
(brace
id|pcibus_info
op_assign
(paren
r_struct
id|pcibus_info
op_star
)paren
id|pcidev_info-&gt;pdi_host_pcidev_info
op_member_access_from_pointer
id|pdi_pcibus_info
suffix:semicolon
id|pcireg_force_intr_set
c_func
(paren
id|pcibus_info
comma
id|bit
)paren
suffix:semicolon
)brace
)brace
DECL|function|pcibr_change_devices_irq
r_void
id|pcibr_change_devices_irq
c_func
(paren
r_struct
id|sn_irq_info
op_star
id|sn_irq_info
)paren
(brace
r_struct
id|pcidev_info
op_star
id|pcidev_info
suffix:semicolon
r_struct
id|pcibus_info
op_star
id|pcibus_info
suffix:semicolon
r_int
id|bit
op_assign
id|sn_irq_info-&gt;irq_int_bit
suffix:semicolon
r_uint64
id|xtalk_addr
op_assign
id|sn_irq_info-&gt;irq_xtalkaddr
suffix:semicolon
id|pcidev_info
op_assign
(paren
r_struct
id|pcidev_info
op_star
)paren
id|sn_irq_info-&gt;irq_pciioinfo
suffix:semicolon
r_if
c_cond
(paren
id|pcidev_info
)paren
(brace
id|pcibus_info
op_assign
(paren
r_struct
id|pcibus_info
op_star
)paren
id|pcidev_info-&gt;pdi_host_pcidev_info
op_member_access_from_pointer
id|pdi_pcibus_info
suffix:semicolon
multiline_comment|/* Disable the device&squot;s IRQ   */
id|pcireg_intr_enable_bit_clr
c_func
(paren
id|pcibus_info
comma
id|bit
)paren
suffix:semicolon
multiline_comment|/* Change the device&squot;s IRQ    */
id|pcireg_intr_addr_addr_set
c_func
(paren
id|pcibus_info
comma
id|bit
comma
id|xtalk_addr
)paren
suffix:semicolon
multiline_comment|/* Re-enable the device&squot;s IRQ */
id|pcireg_intr_enable_bit_set
c_func
(paren
id|pcibus_info
comma
id|bit
)paren
suffix:semicolon
id|pcibr_force_interrupt
c_func
(paren
id|sn_irq_info
)paren
suffix:semicolon
)brace
)brace
eof
