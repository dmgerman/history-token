multiline_comment|/*&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Copyright (C) 2001-2004 Silicon Graphics, Inc. All rights reserved.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;asm/sn/sn_sal.h&gt;
macro_line|#include &quot;pci/pcibus_provider_defs.h&quot;
macro_line|#include &quot;pci/pcidev.h&quot;
macro_line|#include &quot;pci/pcibr_provider.h&quot;
DECL|variable|pcibr_invalidate_ate
r_int
id|pcibr_invalidate_ate
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* by default don&squot;t invalidate ATE on free */
multiline_comment|/*&n; * mark_ate: Mark the ate as either free or inuse.&n; */
DECL|function|mark_ate
r_static
r_void
id|mark_ate
c_func
(paren
r_struct
id|ate_resource
op_star
id|ate_resource
comma
r_int
id|start
comma
r_int
id|number
comma
r_uint64
id|value
)paren
(brace
r_uint64
op_star
id|ate
op_assign
id|ate_resource-&gt;ate
suffix:semicolon
r_int
id|index
suffix:semicolon
r_int
id|length
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|index
op_assign
id|start
suffix:semicolon
id|length
OL
id|number
suffix:semicolon
id|index
op_increment
comma
id|length
op_increment
)paren
id|ate
(braket
id|index
)braket
op_assign
id|value
suffix:semicolon
)brace
multiline_comment|/*&n; * find_free_ate:  Find the first free ate index starting from the given&n; *&t;&t;   index for the desired consequtive count.&n; */
DECL|function|find_free_ate
r_static
r_int
id|find_free_ate
c_func
(paren
r_struct
id|ate_resource
op_star
id|ate_resource
comma
r_int
id|start
comma
r_int
id|count
)paren
(brace
r_uint64
op_star
id|ate
op_assign
id|ate_resource-&gt;ate
suffix:semicolon
r_int
id|index
suffix:semicolon
r_int
id|start_free
suffix:semicolon
r_for
c_loop
(paren
id|index
op_assign
id|start
suffix:semicolon
id|index
OL
id|ate_resource-&gt;num_ate
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ate
(braket
id|index
)braket
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|free
suffix:semicolon
id|free
op_assign
l_int|0
suffix:semicolon
id|start_free
op_assign
id|index
suffix:semicolon
multiline_comment|/* Found start free ate */
r_for
c_loop
(paren
id|i
op_assign
id|start_free
suffix:semicolon
id|i
OL
id|ate_resource-&gt;num_ate
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ate
(braket
id|i
)braket
)paren
(brace
multiline_comment|/* This is free */
r_if
c_cond
(paren
op_increment
id|free
op_eq
id|count
)paren
r_return
id|start_free
suffix:semicolon
)brace
r_else
(brace
id|index
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_else
id|index
op_increment
suffix:semicolon
multiline_comment|/* Try next ate */
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * free_ate_resource:  Free the requested number of ATEs.&n; */
DECL|function|free_ate_resource
r_static
r_inline
r_void
id|free_ate_resource
c_func
(paren
r_struct
id|ate_resource
op_star
id|ate_resource
comma
r_int
id|start
)paren
(brace
id|mark_ate
c_func
(paren
id|ate_resource
comma
id|start
comma
id|ate_resource-&gt;ate
(braket
id|start
)braket
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ate_resource-&gt;lowest_free_index
OG
id|start
)paren
op_logical_or
(paren
id|ate_resource-&gt;lowest_free_index
OL
l_int|0
)paren
)paren
id|ate_resource-&gt;lowest_free_index
op_assign
id|start
suffix:semicolon
)brace
multiline_comment|/*&n; * alloc_ate_resource:  Allocate the requested number of ATEs.&n; */
DECL|function|alloc_ate_resource
r_static
r_inline
r_int
id|alloc_ate_resource
c_func
(paren
r_struct
id|ate_resource
op_star
id|ate_resource
comma
r_int
id|ate_needed
)paren
(brace
r_int
id|start_index
suffix:semicolon
multiline_comment|/*&n;&t; * Check for ate exhaustion.&n;&t; */
r_if
c_cond
(paren
id|ate_resource-&gt;lowest_free_index
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Find the required number of free consequtive ates.&n;&t; */
id|start_index
op_assign
id|find_free_ate
c_func
(paren
id|ate_resource
comma
id|ate_resource-&gt;lowest_free_index
comma
id|ate_needed
)paren
suffix:semicolon
r_if
c_cond
(paren
id|start_index
op_ge
l_int|0
)paren
id|mark_ate
c_func
(paren
id|ate_resource
comma
id|start_index
comma
id|ate_needed
comma
id|ate_needed
)paren
suffix:semicolon
id|ate_resource-&gt;lowest_free_index
op_assign
id|find_free_ate
c_func
(paren
id|ate_resource
comma
id|ate_resource-&gt;lowest_free_index
comma
l_int|1
)paren
suffix:semicolon
r_return
id|start_index
suffix:semicolon
)brace
multiline_comment|/*&n; * Allocate &quot;count&quot; contiguous Bridge Address Translation Entries&n; * on the specified bridge to be used for PCI to XTALK mappings.&n; * Indices in rm map range from 1..num_entries.  Indicies returned&n; * to caller range from 0..num_entries-1.&n; *&n; * Return the start index on success, -1 on failure.&n; */
DECL|function|pcibr_ate_alloc
r_int
id|pcibr_ate_alloc
c_func
(paren
r_struct
id|pcibus_info
op_star
id|pcibus_info
comma
r_int
id|count
)paren
(brace
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_uint64
id|flag
suffix:semicolon
id|flag
op_assign
id|pcibr_lock
c_func
(paren
id|pcibus_info
)paren
suffix:semicolon
id|status
op_assign
id|alloc_ate_resource
c_func
(paren
op_amp
id|pcibus_info-&gt;pbi_int_ate_resource
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
(brace
multiline_comment|/* Failed to allocate */
id|pcibr_unlock
c_func
(paren
id|pcibus_info
comma
id|flag
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|pcibr_unlock
c_func
(paren
id|pcibus_info
comma
id|flag
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * Setup an Address Translation Entry as specified.  Use either the Bridge&n; * internal maps or the external map RAM, as appropriate.&n; */
DECL|function|pcibr_ate_addr
r_static
r_inline
r_uint64
op_star
id|pcibr_ate_addr
c_func
(paren
r_struct
id|pcibus_info
op_star
id|pcibus_info
comma
r_int
id|ate_index
)paren
(brace
r_if
c_cond
(paren
id|ate_index
OL
id|pcibus_info-&gt;pbi_int_ate_size
)paren
(brace
r_return
id|pcireg_int_ate_addr
c_func
(paren
id|pcibus_info
comma
id|ate_index
)paren
suffix:semicolon
)brace
id|panic
c_func
(paren
l_string|&quot;pcibr_ate_addr: invalid ate_index 0x%x&quot;
comma
id|ate_index
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Update the ate.&n; */
r_void
r_inline
DECL|function|ate_write
id|ate_write
c_func
(paren
r_struct
id|pcibus_info
op_star
id|pcibus_info
comma
r_int
id|ate_index
comma
r_int
id|count
comma
r_volatile
r_uint64
id|ate
)paren
(brace
r_while
c_loop
(paren
id|count
op_decrement
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ate_index
OL
id|pcibus_info-&gt;pbi_int_ate_size
)paren
(brace
id|pcireg_int_ate_set
c_func
(paren
id|pcibus_info
comma
id|ate_index
comma
id|ate
)paren
suffix:semicolon
)brace
r_else
(brace
id|panic
c_func
(paren
l_string|&quot;ate_write: invalid ate_index 0x%x&quot;
comma
id|ate_index
)paren
suffix:semicolon
)brace
id|ate_index
op_increment
suffix:semicolon
id|ate
op_add_assign
id|IOPGSIZE
suffix:semicolon
)brace
id|pcireg_tflush_get
c_func
(paren
id|pcibus_info
)paren
suffix:semicolon
multiline_comment|/* wait until Bridge PIO complete */
)brace
DECL|function|pcibr_ate_free
r_void
id|pcibr_ate_free
c_func
(paren
r_struct
id|pcibus_info
op_star
id|pcibus_info
comma
r_int
id|index
)paren
(brace
r_volatile
r_uint64
id|ate
suffix:semicolon
r_int
id|count
suffix:semicolon
r_uint64
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|pcibr_invalidate_ate
)paren
(brace
multiline_comment|/* For debugging purposes, clear the valid bit in the ATE */
id|ate
op_assign
op_star
id|pcibr_ate_addr
c_func
(paren
id|pcibus_info
comma
id|index
)paren
suffix:semicolon
id|count
op_assign
id|pcibus_info-&gt;pbi_int_ate_resource.ate
(braket
id|index
)braket
suffix:semicolon
id|ate_write
c_func
(paren
id|pcibus_info
comma
id|index
comma
id|count
comma
(paren
id|ate
op_amp
op_complement
id|PCI32_ATE_V
)paren
)paren
suffix:semicolon
)brace
id|flags
op_assign
id|pcibr_lock
c_func
(paren
id|pcibus_info
)paren
suffix:semicolon
id|free_ate_resource
c_func
(paren
op_amp
id|pcibus_info-&gt;pbi_int_ate_resource
comma
id|index
)paren
suffix:semicolon
id|pcibr_unlock
c_func
(paren
id|pcibus_info
comma
id|flags
)paren
suffix:semicolon
)brace
eof
