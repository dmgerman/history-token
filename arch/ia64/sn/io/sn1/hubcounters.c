multiline_comment|/* $Id:$&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Copyright (C) 1992 - 1997, 2000 - 2001 Silicon Graphics, Inc.&n; * All rights reserved.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;asm/types.h&gt;
macro_line|#include &lt;asm/sn/io.h&gt;
macro_line|#include &lt;asm/sn/nodepda.h&gt;
macro_line|#include &lt;asm/sn/iograph.h&gt;
macro_line|#include &lt;asm/sn/sn_cpuid.h&gt;
macro_line|#include &lt;asm/sn/router.h&gt;
macro_line|#include &lt;asm/sn/snconfig.h&gt;
macro_line|#include &lt;asm/sn/slotnum.h&gt;
macro_line|#include &lt;asm/sn/clksupport.h&gt;
macro_line|#include &lt;asm/sn/sndrv.h&gt;
r_extern
r_void
id|hubni_error_handler
c_func
(paren
r_char
op_star
comma
r_int
)paren
suffix:semicolon
multiline_comment|/* huberror.c */
r_static
r_int
id|hubstats_ioctl
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
DECL|variable|hub_mon_fops
r_struct
id|file_operations
id|hub_mon_fops
op_assign
(brace
id|ioctl
suffix:colon
id|hubstats_ioctl
comma
)brace
suffix:semicolon
DECL|macro|HUB_CAPTURE_TICKS
mdefine_line|#define HUB_CAPTURE_TICKS&t;(2 * HZ)
DECL|macro|HUB_ERR_THRESH
mdefine_line|#define HUB_ERR_THRESH&t;&t;500
DECL|macro|USEC_PER_SEC
mdefine_line|#define USEC_PER_SEC&t;&t;1000000
DECL|macro|NSEC_PER_SEC
mdefine_line|#define NSEC_PER_SEC&t;&t;USEC_PER_SEC*1000
DECL|variable|hub_print_usecs
r_volatile
r_int
id|hub_print_usecs
op_assign
l_int|600
op_star
id|USEC_PER_SEC
suffix:semicolon
multiline_comment|/* Return success if the hub&squot;s crosstalk link is working */
r_int
DECL|function|hub_xtalk_link_up
id|hub_xtalk_link_up
c_func
(paren
id|nasid_t
id|nasid
)paren
(brace
id|hubreg_t
id|llp_csr_reg
suffix:semicolon
multiline_comment|/* Read the IO LLP control status register */
id|llp_csr_reg
op_assign
id|REMOTE_HUB_L
c_func
(paren
id|nasid
comma
id|IIO_LLP_CSR
)paren
suffix:semicolon
multiline_comment|/* Check if the xtalk link is working */
r_if
c_cond
(paren
id|llp_csr_reg
op_amp
id|IIO_LLP_CSR_IS_UP
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|error_flag_to_type
r_static
r_char
op_star
id|error_flag_to_type
c_func
(paren
r_int
r_char
id|error_flag
)paren
(brace
r_switch
c_cond
(paren
id|error_flag
)paren
(brace
r_case
l_int|0x1
suffix:colon
r_return
(paren
l_string|&quot;NI retries&quot;
)paren
suffix:semicolon
r_case
l_int|0x2
suffix:colon
r_return
(paren
l_string|&quot;NI SN errors&quot;
)paren
suffix:semicolon
r_case
l_int|0x4
suffix:colon
r_return
(paren
l_string|&quot;NI CB errors&quot;
)paren
suffix:semicolon
r_case
l_int|0x8
suffix:colon
r_return
(paren
l_string|&quot;II CB errors&quot;
)paren
suffix:semicolon
r_case
l_int|0x10
suffix:colon
r_return
(paren
l_string|&quot;II SN errors&quot;
)paren
suffix:semicolon
r_default
suffix:colon
r_return
(paren
l_string|&quot;Errors&quot;
)paren
suffix:semicolon
)brace
)brace
r_int
DECL|function|print_hub_error
id|print_hub_error
c_func
(paren
id|hubstat_t
op_star
id|hsp
comma
id|hubreg_t
id|reg
comma
r_int64
id|delta
comma
r_int
r_char
id|error_flag
)paren
(brace
r_int64
id|rate
suffix:semicolon
id|reg
op_mul_assign
id|hsp-&gt;hs_per_minute
suffix:semicolon
multiline_comment|/* Convert to minutes */
id|rate
op_assign
id|reg
op_div
id|delta
suffix:semicolon
r_if
c_cond
(paren
id|rate
OG
id|HUB_ERR_THRESH
)paren
(brace
r_if
c_cond
(paren
id|hsp-&gt;hs_maint
op_amp
id|error_flag
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Excessive %s (%ld/min) on %s&quot;
comma
id|error_flag_to_type
c_func
(paren
id|error_flag
)paren
comma
id|rate
comma
id|hsp-&gt;hs_name
)paren
suffix:semicolon
)brace
r_else
(brace
id|hsp-&gt;hs_maint
op_or_assign
id|error_flag
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Excessive %s (%ld/min) on %s&quot;
comma
id|error_flag_to_type
c_func
(paren
id|error_flag
)paren
comma
id|rate
comma
id|hsp-&gt;hs_name
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_int
DECL|function|check_hub_error_rates
id|check_hub_error_rates
c_func
(paren
id|hubstat_t
op_star
id|hsp
)paren
(brace
r_int64
id|delta
op_assign
id|hsp-&gt;hs_timestamp
op_minus
id|hsp-&gt;hs_timebase
suffix:semicolon
r_int
id|printed
op_assign
l_int|0
suffix:semicolon
id|printed
op_add_assign
id|print_hub_error
c_func
(paren
id|hsp
comma
id|hsp-&gt;hs_ni_retry_errors
comma
id|delta
comma
l_int|0x1
)paren
suffix:semicolon
macro_line|#if 0
id|printed
op_add_assign
id|print_hub_error
c_func
(paren
id|hsp
comma
id|hsp-&gt;hs_ni_sn_errors
comma
id|delta
comma
l_int|0x2
)paren
suffix:semicolon
macro_line|#endif
id|printed
op_add_assign
id|print_hub_error
c_func
(paren
id|hsp
comma
id|hsp-&gt;hs_ni_cb_errors
comma
id|delta
comma
l_int|0x4
)paren
suffix:semicolon
multiline_comment|/* If the hub&squot;s xtalk link is not working there is &n;&t; * no need to print the &quot;Excessive...&quot; warning &n;&t; * messages&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|hub_xtalk_link_up
c_func
(paren
id|hsp-&gt;hs_nasid
)paren
)paren
r_return
id|printed
suffix:semicolon
id|printed
op_add_assign
id|print_hub_error
c_func
(paren
id|hsp
comma
id|hsp-&gt;hs_ii_cb_errors
comma
id|delta
comma
l_int|0x8
)paren
suffix:semicolon
id|printed
op_add_assign
id|print_hub_error
c_func
(paren
id|hsp
comma
id|hsp-&gt;hs_ii_sn_errors
comma
id|delta
comma
l_int|0x10
)paren
suffix:semicolon
r_return
id|printed
suffix:semicolon
)brace
r_void
DECL|function|capture_hub_stats
id|capture_hub_stats
c_func
(paren
id|cnodeid_t
id|cnodeid
comma
r_struct
id|nodepda_s
op_star
id|npda
)paren
(brace
id|nasid_t
id|nasid
suffix:semicolon
id|hubstat_t
op_star
id|hsp
op_assign
op_amp
(paren
id|npda-&gt;hubstats
)paren
suffix:semicolon
id|hubreg_t
id|port_error
suffix:semicolon
id|ii_illr_u_t
id|illr
suffix:semicolon
r_int
id|count
suffix:semicolon
r_int
id|overflow
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * If our link wasn&squot;t up at boot time, don&squot;t worry about error rates.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|hsp-&gt;hs_ni_port_status
op_amp
id|NPS_LINKUP_MASK
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;capture_hub_stats: cnode=%d hs_ni_port_status=0x%016lx : link is not up&bslash;n&quot;
comma
id|cnodeid
comma
id|hsp-&gt;hs_ni_port_status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|nasid
op_assign
id|COMPACT_TO_NASID_NODEID
c_func
(paren
id|cnodeid
)paren
suffix:semicolon
id|hsp-&gt;hs_timestamp
op_assign
id|GET_RTC_COUNTER
c_func
(paren
)paren
suffix:semicolon
id|port_error
op_assign
id|REMOTE_HUB_L
c_func
(paren
id|nasid
comma
id|NI_PORT_ERROR_CLEAR
)paren
suffix:semicolon
id|count
op_assign
(paren
(paren
id|port_error
op_amp
id|NPE_RETRYCOUNT_MASK
)paren
op_rshift
id|NPE_RETRYCOUNT_SHFT
)paren
suffix:semicolon
id|hsp-&gt;hs_ni_retry_errors
op_add_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
id|NPE_COUNT_MAX
)paren
id|overflow
op_assign
l_int|1
suffix:semicolon
id|count
op_assign
(paren
(paren
id|port_error
op_amp
id|NPE_SNERRCOUNT_MASK
)paren
op_rshift
id|NPE_SNERRCOUNT_SHFT
)paren
suffix:semicolon
id|hsp-&gt;hs_ni_sn_errors
op_add_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
id|NPE_COUNT_MAX
)paren
id|overflow
op_assign
l_int|1
suffix:semicolon
id|count
op_assign
(paren
(paren
id|port_error
op_amp
id|NPE_CBERRCOUNT_MASK
)paren
op_rshift
id|NPE_CBERRCOUNT_SHFT
)paren
suffix:semicolon
id|hsp-&gt;hs_ni_cb_errors
op_add_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|overflow
op_logical_or
id|count
op_eq
id|NPE_COUNT_MAX
)paren
id|hsp-&gt;hs_ni_overflows
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|port_error
op_amp
id|NPE_FATAL_ERRORS
)paren
(brace
macro_line|#ifdef ajm
id|hubni_error_handler
c_func
(paren
l_string|&quot;capture_hub_stats&quot;
comma
l_int|1
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
l_string|&quot;Error: hubni_error_handler in capture_hub_stats&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
id|illr.ii_illr_regval
op_assign
id|REMOTE_HUB_L
c_func
(paren
id|nasid
comma
id|IIO_LLP_LOG
)paren
suffix:semicolon
id|REMOTE_HUB_S
c_func
(paren
id|nasid
comma
id|IIO_LLP_LOG
comma
l_int|0
)paren
suffix:semicolon
id|hsp-&gt;hs_ii_sn_errors
op_add_assign
id|illr.ii_illr_fld_s.i_sn_cnt
suffix:semicolon
id|hsp-&gt;hs_ii_cb_errors
op_add_assign
id|illr.ii_illr_fld_s.i_cb_cnt
suffix:semicolon
r_if
c_cond
(paren
(paren
id|illr.ii_illr_fld_s.i_sn_cnt
op_eq
id|IIO_LLP_SN_MAX
)paren
op_logical_or
(paren
id|illr.ii_illr_fld_s.i_cb_cnt
op_eq
id|IIO_LLP_CB_MAX
)paren
)paren
id|hsp-&gt;hs_ii_overflows
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|hsp-&gt;hs_print
)paren
(brace
r_if
c_cond
(paren
id|check_hub_error_rates
c_func
(paren
id|hsp
)paren
)paren
(brace
id|hsp-&gt;hs_last_print
op_assign
id|GET_RTC_COUNTER
c_func
(paren
)paren
suffix:semicolon
id|hsp-&gt;hs_print
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|GET_RTC_COUNTER
c_func
(paren
)paren
op_minus
id|hsp-&gt;hs_last_print
)paren
OG
id|hub_print_usecs
)paren
id|hsp-&gt;hs_print
op_assign
l_int|1
suffix:semicolon
)brace
id|npda-&gt;hubticks
op_assign
id|HUB_CAPTURE_TICKS
suffix:semicolon
)brace
r_void
DECL|function|init_hub_stats
id|init_hub_stats
c_func
(paren
id|cnodeid_t
id|cnodeid
comma
r_struct
id|nodepda_s
op_star
id|npda
)paren
(brace
id|hubstat_t
op_star
id|hsp
op_assign
op_amp
(paren
id|npda-&gt;hubstats
)paren
suffix:semicolon
id|nasid_t
id|nasid
op_assign
id|cnodeid_to_nasid
c_func
(paren
id|cnodeid
)paren
suffix:semicolon
id|bzero
c_func
(paren
op_amp
(paren
id|npda-&gt;hubstats
)paren
comma
r_sizeof
(paren
id|hubstat_t
)paren
)paren
suffix:semicolon
id|hsp-&gt;hs_version
op_assign
id|HUBSTAT_VERSION
suffix:semicolon
id|hsp-&gt;hs_cnode
op_assign
id|cnodeid
suffix:semicolon
id|hsp-&gt;hs_nasid
op_assign
id|nasid
suffix:semicolon
id|hsp-&gt;hs_timebase
op_assign
id|GET_RTC_COUNTER
c_func
(paren
)paren
suffix:semicolon
id|hsp-&gt;hs_ni_port_status
op_assign
id|REMOTE_HUB_L
c_func
(paren
id|nasid
comma
id|NI_PORT_STATUS
)paren
suffix:semicolon
multiline_comment|/* Clear the II error counts. */
id|REMOTE_HUB_S
c_func
(paren
id|nasid
comma
id|IIO_LLP_LOG
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Clear the NI counts. */
id|REMOTE_HUB_L
c_func
(paren
id|nasid
comma
id|NI_PORT_ERROR_CLEAR
)paren
suffix:semicolon
id|hsp-&gt;hs_per_minute
op_assign
(paren
r_int
r_int
)paren
id|RTC_CYCLES_PER_SEC
op_star
l_int|60LL
suffix:semicolon
id|npda-&gt;hubticks
op_assign
id|HUB_CAPTURE_TICKS
suffix:semicolon
multiline_comment|/* XX should use kmem_alloc_node */
id|hsp-&gt;hs_name
op_assign
(paren
r_char
op_star
)paren
id|kmalloc
c_func
(paren
id|MAX_HUB_PATH
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|ASSERT_ALWAYS
c_func
(paren
id|hsp-&gt;hs_name
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|hsp-&gt;hs_name
comma
l_string|&quot;/dev/hw/&quot;
id|EDGE_LBL_MODULE
l_string|&quot;/%03d/&quot;
id|EDGE_LBL_NODE
l_string|&quot;/&quot;
id|EDGE_LBL_HUB
comma
id|npda-&gt;module_id
)paren
suffix:semicolon
id|hsp-&gt;hs_last_print
op_assign
l_int|0
suffix:semicolon
id|hsp-&gt;hs_print
op_assign
l_int|1
suffix:semicolon
id|hub_print_usecs
op_assign
id|hub_print_usecs
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;init_hub_stats: cnode=%d nasid=%d hs_version=%d hs_ni_port_status=0x%016lx&bslash;n&quot;
comma
id|cnodeid
comma
id|nasid
comma
id|hsp-&gt;hs_version
comma
id|hsp-&gt;hs_ni_port_status
)paren
suffix:semicolon
macro_line|#endif
)brace
r_static
r_int
DECL|function|hubstats_ioctl
id|hubstats_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|cnodeid_t
id|cnode
suffix:semicolon
id|nodepda_t
op_star
id|npdap
suffix:semicolon
r_uint64
id|longarg
suffix:semicolon
id|devfs_handle_t
id|d
suffix:semicolon
r_if
c_cond
(paren
(paren
id|d
op_assign
id|devfs_get_handle_from_inode
c_func
(paren
id|inode
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|cnode
op_assign
(paren
id|cnodeid_t
)paren
id|hwgraph_fastinfo_get
c_func
(paren
id|d
)paren
suffix:semicolon
id|npdap
op_assign
id|NODEPDA
c_func
(paren
id|cnode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|npdap-&gt;hubstats.hs_version
op_ne
id|HUBSTAT_VERSION
)paren
(brace
id|init_hub_stats
c_func
(paren
id|cnode
comma
id|npdap
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SNDRV_GET_INFOSIZE
suffix:colon
id|longarg
op_assign
r_sizeof
(paren
id|hubstat_t
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|longarg
comma
r_sizeof
(paren
id|longarg
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SNDRV_GET_HUBINFO
suffix:colon
multiline_comment|/* refresh npda-&gt;hubstats */
id|capture_hub_stats
c_func
(paren
id|cnode
comma
id|npdap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|npdap-&gt;hubstats
comma
r_sizeof
(paren
id|hubstat_t
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
