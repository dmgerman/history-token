multiline_comment|/* $Id$&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Copyright (C) 1992-1997, 2000-2002 Silicon Graphics, Inc.  All rights reserved.&n; */
multiline_comment|/*&n; * hubspc.c - Hub Memory Space Management Driver&n; * This driver implements the managers for the following&n; * memory resources:&n; * 1) reference counters&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;asm/sn/sgi.h&gt;
macro_line|#include &lt;asm/sn/io.h&gt;
macro_line|#include &lt;asm/sn/sn_cpuid.h&gt;
macro_line|#include &lt;linux/devfs_fs.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/sn/iograph.h&gt;
macro_line|#include &lt;asm/sn/invent.h&gt;
macro_line|#include &lt;asm/sn/hcl.h&gt;
macro_line|#include &lt;asm/sn/labelcl.h&gt;
macro_line|#include &lt;asm/sn/sn1/mem_refcnt.h&gt;
macro_line|#include &lt;asm/sn/addrs.h&gt;
macro_line|#include &lt;asm/sn/snconfig.h&gt;
macro_line|#include &lt;asm/sn/sn1/hubspc.h&gt;
macro_line|#include &lt;asm/sn/ksys/elsc.h&gt;
macro_line|#include &lt;asm/sn/simulator.h&gt;
multiline_comment|/* Uncomment the following line for tracing */
multiline_comment|/* #define HUBSPC_DEBUG 1 */
DECL|variable|hubspc_devflag
r_int
id|hubspc_devflag
op_assign
id|D_MP
suffix:semicolon
multiline_comment|/***********************************************************************/
multiline_comment|/* CPU Prom Space &t;&t;&t;&t;&t;&t;       */
multiline_comment|/***********************************************************************/
DECL|struct|cpuprom_info
r_typedef
r_struct
id|cpuprom_info
(brace
DECL|member|prom_dev
id|devfs_handle_t
id|prom_dev
suffix:semicolon
DECL|member|nodevrtx
id|devfs_handle_t
id|nodevrtx
suffix:semicolon
DECL|member|next
r_struct
id|cpuprom_info
op_star
id|next
suffix:semicolon
DECL|typedef|cpuprom_info_t
)brace
id|cpuprom_info_t
suffix:semicolon
DECL|variable|cpuprom_head
r_static
id|cpuprom_info_t
op_star
id|cpuprom_head
suffix:semicolon
DECL|variable|cpuprom_spinlock
id|spinlock_t
id|cpuprom_spinlock
suffix:semicolon
DECL|macro|PROM_LOCK
mdefine_line|#define&t;PROM_LOCK()&t;mutex_spinlock(&amp;cpuprom_spinlock)
DECL|macro|PROM_UNLOCK
mdefine_line|#define&t;PROM_UNLOCK(s)&t;mutex_spinunlock(&amp;cpuprom_spinlock, (s))
multiline_comment|/*&n; * Add prominfo to the linked list maintained.&n; */
r_void
DECL|function|prominfo_add
id|prominfo_add
c_func
(paren
id|devfs_handle_t
id|hub
comma
id|devfs_handle_t
id|prom
)paren
(brace
id|cpuprom_info_t
op_star
id|info
suffix:semicolon
r_int
r_int
id|s
suffix:semicolon
id|info
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|cpuprom_info_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;prom_dev
op_assign
id|prom
suffix:semicolon
id|info-&gt;nodevrtx
op_assign
id|hub
suffix:semicolon
id|s
op_assign
id|PROM_LOCK
c_func
(paren
)paren
suffix:semicolon
id|info-&gt;next
op_assign
id|cpuprom_head
suffix:semicolon
id|cpuprom_head
op_assign
id|info
suffix:semicolon
id|PROM_UNLOCK
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
r_void
DECL|function|prominfo_del
id|prominfo_del
c_func
(paren
id|devfs_handle_t
id|prom
)paren
(brace
r_int
r_int
id|s
suffix:semicolon
id|cpuprom_info_t
op_star
id|info
suffix:semicolon
id|cpuprom_info_t
op_star
op_star
id|prev
suffix:semicolon
id|s
op_assign
id|PROM_LOCK
c_func
(paren
)paren
suffix:semicolon
id|prev
op_assign
op_amp
id|cpuprom_head
suffix:semicolon
r_while
c_loop
(paren
(paren
id|info
op_assign
op_star
id|prev
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;prom_dev
op_eq
id|prom
)paren
(brace
op_star
id|prev
op_assign
id|info-&gt;next
suffix:semicolon
id|PROM_UNLOCK
c_func
(paren
id|s
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|prev
op_assign
op_amp
id|info-&gt;next
suffix:semicolon
)brace
id|PROM_UNLOCK
c_func
(paren
id|s
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|devfs_handle_t
DECL|function|prominfo_nodeget
id|prominfo_nodeget
c_func
(paren
id|devfs_handle_t
id|prom
)paren
(brace
r_int
r_int
id|s
suffix:semicolon
id|cpuprom_info_t
op_star
id|info
suffix:semicolon
id|s
op_assign
id|PROM_LOCK
c_func
(paren
)paren
suffix:semicolon
id|info
op_assign
id|cpuprom_head
suffix:semicolon
r_while
c_loop
(paren
id|info
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;prom_dev
op_eq
id|prom
)paren
(brace
id|PROM_UNLOCK
c_func
(paren
id|s
)paren
suffix:semicolon
r_return
id|info-&gt;nodevrtx
suffix:semicolon
)brace
id|info
op_assign
id|info-&gt;next
suffix:semicolon
)brace
id|PROM_UNLOCK
c_func
(paren
id|s
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if defined(CONFIG_IA64_SGI_SN1)
DECL|macro|SN_PROMVERSION
mdefine_line|#define&t;SN_PROMVERSION&t;&t;INV_IP35PROM
multiline_comment|/* Add &quot;detailed&quot; labelled inventory information to the&n; * prom vertex &n; */
r_void
DECL|function|cpuprom_detailed_inventory_info_add
id|cpuprom_detailed_inventory_info_add
c_func
(paren
id|devfs_handle_t
id|prom_dev
comma
id|devfs_handle_t
id|node
)paren
(brace
id|invent_miscinfo_t
op_star
id|cpuprom_inventory_info
suffix:semicolon
r_extern
id|invent_generic_t
op_star
id|klhwg_invent_alloc
c_func
(paren
id|cnodeid_t
id|cnode
comma
r_int
r_class
comma
r_int
id|size
)paren
suffix:semicolon
id|cnodeid_t
id|cnode
op_assign
id|hubdev_cnodeid_get
c_func
(paren
id|node
)paren
suffix:semicolon
multiline_comment|/* Allocate memory for the extra inventory information&n;&t; * for the  prom&n;&t; */
id|cpuprom_inventory_info
op_assign
(paren
id|invent_miscinfo_t
op_star
)paren
id|klhwg_invent_alloc
c_func
(paren
id|cnode
comma
id|INV_PROM
comma
r_sizeof
(paren
id|invent_miscinfo_t
)paren
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|cpuprom_inventory_info
)paren
suffix:semicolon
multiline_comment|/* Set the enabled flag so that the hinv interprets this&n;&t; * information&n;&t; */
id|cpuprom_inventory_info-&gt;im_gen.ig_flag
op_assign
id|INVENT_ENABLED
suffix:semicolon
id|cpuprom_inventory_info-&gt;im_type
op_assign
id|SN_PROMVERSION
suffix:semicolon
multiline_comment|/* Store prom revision into inventory information */
id|cpuprom_inventory_info-&gt;im_rev
op_assign
id|IP27CONFIG.pvers_rev
suffix:semicolon
id|cpuprom_inventory_info-&gt;im_version
op_assign
id|IP27CONFIG.pvers_vers
suffix:semicolon
multiline_comment|/* Store this info as labelled information hanging off the&n;&t; * prom device vertex&n;&t; */
id|hwgraph_info_add_LBL
c_func
(paren
id|prom_dev
comma
id|INFO_LBL_DETAIL_INVENT
comma
(paren
id|arbitrary_info_t
)paren
id|cpuprom_inventory_info
)paren
suffix:semicolon
multiline_comment|/* Export this information so that user programs can get to&n;&t; * this by using attr_get()&n;&t; */
id|hwgraph_info_export_LBL
c_func
(paren
id|prom_dev
comma
id|INFO_LBL_DETAIL_INVENT
comma
r_sizeof
(paren
id|invent_miscinfo_t
)paren
)paren
suffix:semicolon
)brace
DECL|macro|FPROM_CONFIG_ADDR
mdefine_line|#define FPROM_CONFIG_ADDR&t;MD_JUNK_BUS_TIMING
DECL|macro|FPROM_ENABLE_MASK
mdefine_line|#define FPROM_ENABLE_MASK&t;MJT_FPROM_ENABLE_MASK
DECL|macro|FPROM_ENABLE_SHFT
mdefine_line|#define FPROM_ENABLE_SHFT&t;MJT_FPROM_ENABLE_SHFT
DECL|macro|FPROM_SETUP_MASK
mdefine_line|#define FPROM_SETUP_MASK&t;MJT_FPROM_SETUP_MASK
DECL|macro|FPROM_SETUP_SHFT
mdefine_line|#define FPROM_SETUP_SHFT&t;MJT_FPROM_SETUP_SHFT
multiline_comment|/*ARGSUSED*/
r_int
DECL|function|cpuprom_map
id|cpuprom_map
c_func
(paren
id|devfs_handle_t
id|dev
comma
id|vhandl_t
op_star
id|vt
comma
id|off_t
id|addr
comma
r_int
id|len
)paren
(brace
r_int
id|errcode
op_assign
l_int|0
suffix:semicolon
id|caddr_t
id|kvaddr
suffix:semicolon
id|devfs_handle_t
id|node
suffix:semicolon
id|cnodeid_t
id|cnode
suffix:semicolon
id|node
op_assign
id|prominfo_nodeget
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
r_return
id|EIO
suffix:semicolon
id|kvaddr
op_assign
id|hubdev_prombase_get
c_func
(paren
id|node
)paren
suffix:semicolon
id|cnode
op_assign
id|hubdev_cnodeid_get
c_func
(paren
id|node
)paren
suffix:semicolon
macro_line|#ifdef&t;HUBSPC_DEBUG
id|printk
c_func
(paren
l_string|&quot;cpuprom_map: hubnode %d kvaddr 0x%x&bslash;n&quot;
comma
id|node
comma
id|kvaddr
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|len
OG
id|RBOOT_SIZE
)paren
id|len
op_assign
id|RBOOT_SIZE
suffix:semicolon
multiline_comment|/*&n;         * Map in the prom space&n;         */
id|errcode
op_assign
id|v_mapphys
c_func
(paren
id|vt
comma
id|kvaddr
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errcode
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t; * Set the MD configuration registers suitably.&n;&t;&t; */
id|nasid_t
id|nasid
suffix:semicolon
r_uint64
id|value
suffix:semicolon
r_volatile
id|hubreg_t
op_star
id|regaddr
suffix:semicolon
id|nasid
op_assign
id|COMPACT_TO_NASID_NODEID
c_func
(paren
id|cnode
)paren
suffix:semicolon
id|regaddr
op_assign
id|REMOTE_HUB_ADDR
c_func
(paren
id|nasid
comma
id|FPROM_CONFIG_ADDR
)paren
suffix:semicolon
id|value
op_assign
id|HUB_L
c_func
(paren
id|regaddr
)paren
suffix:semicolon
id|value
op_and_assign
op_complement
(paren
id|FPROM_SETUP_MASK
op_or
id|FPROM_ENABLE_MASK
)paren
suffix:semicolon
(brace
id|value
op_or_assign
(paren
(paren
(paren
r_int
)paren
id|CONFIG_FPROM_SETUP
op_lshift
id|FPROM_SETUP_SHFT
)paren
op_or
(paren
(paren
r_int
)paren
id|CONFIG_FPROM_ENABLE
op_lshift
id|FPROM_ENABLE_SHFT
)paren
)paren
suffix:semicolon
)brace
id|HUB_S
c_func
(paren
id|regaddr
comma
id|value
)paren
suffix:semicolon
)brace
r_return
(paren
id|errcode
)paren
suffix:semicolon
)brace
macro_line|#endif&t;/* CONFIG_IA64_SGI_SN1 */
multiline_comment|/*ARGSUSED*/
r_int
DECL|function|cpuprom_unmap
id|cpuprom_unmap
c_func
(paren
id|devfs_handle_t
id|dev
comma
id|vhandl_t
op_star
id|vt
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/***********************************************************************/
multiline_comment|/* Base Hub Space Driver                                               */
multiline_comment|/***********************************************************************/
multiline_comment|/*&n; * hubspc_init&n; * Registration of the hubspc devices with the hub manager&n; */
r_void
DECL|function|hubspc_init
id|hubspc_init
c_func
(paren
r_void
)paren
(brace
multiline_comment|/*&n;         * Register with the hub manager&n;         */
multiline_comment|/* The reference counters */
macro_line|#if defined(CONFIG_IA64_SGI_SN1)
id|hubdev_register
c_func
(paren
id|mem_refcnt_attach
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if defined(CONFIG_SERIAL_SGI_L1_PROTOCOL)
multiline_comment|/* L1 system controller link */
r_if
c_cond
(paren
op_logical_neg
id|IS_RUNNING_ON_SIMULATOR
c_func
(paren
)paren
)paren
(brace
multiline_comment|/* initialize the L1 link */
r_extern
r_void
id|l1_init
c_func
(paren
r_void
)paren
suffix:semicolon
id|l1_init
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef&t;HUBSPC_DEBUG
id|printk
c_func
(paren
l_string|&quot;hubspc_init: Completed&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif&t;/* HUBSPC_DEBUG */
multiline_comment|/* Initialize spinlocks */
id|mutex_spinlock_init
c_func
(paren
op_amp
id|cpuprom_spinlock
)paren
suffix:semicolon
)brace
multiline_comment|/* ARGSUSED */
r_int
DECL|function|hubspc_open
id|hubspc_open
c_func
(paren
id|devfs_handle_t
op_star
id|devp
comma
id|mode_t
id|oflag
comma
r_int
id|otyp
comma
id|cred_t
op_star
id|crp
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* ARGSUSED */
r_int
DECL|function|hubspc_close
id|hubspc_close
c_func
(paren
id|devfs_handle_t
id|dev
comma
r_int
id|oflag
comma
r_int
id|otyp
comma
id|cred_t
op_star
id|crp
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* ARGSUSED */
r_int
DECL|function|hubspc_map
id|hubspc_map
c_func
(paren
id|devfs_handle_t
id|dev
comma
id|vhandl_t
op_star
id|vt
comma
id|off_t
id|off
comma
r_int
id|len
comma
id|uint
id|prot
)paren
(brace
multiline_comment|/*REFERENCED*/
r_int
id|errcode
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* check validity of request */
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
(brace
r_return
id|ENXIO
suffix:semicolon
)brace
r_return
id|errcode
suffix:semicolon
)brace
multiline_comment|/* ARGSUSED */
r_int
DECL|function|hubspc_unmap
id|hubspc_unmap
c_func
(paren
id|devfs_handle_t
id|dev
comma
id|vhandl_t
op_star
id|vt
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* ARGSUSED */
r_int
DECL|function|hubspc_ioctl
id|hubspc_ioctl
c_func
(paren
id|devfs_handle_t
id|dev
comma
r_int
id|cmd
comma
r_void
op_star
id|arg
comma
r_int
id|mode
comma
id|cred_t
op_star
id|cred_p
comma
r_int
op_star
id|rvalp
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
eof
