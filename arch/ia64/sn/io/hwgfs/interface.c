multiline_comment|/*&n; * Copyright (c) 2003 Silicon Graphics, Inc.  All Rights Reserved.&n; *&n; *  Portions based on Adam Richter&squot;s smalldevfs and thus&n; *  Copyright 2002-2003  Yggdrasil Computing, Inc.&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of version 2 of the GNU General Public License as&n; * published by the Free Software Foundation.&n; *&n; * This program is distributed in the hope that it would be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.&n; *&n; * Further, this software is distributed without any warranty that it is&n; * free of the rightful claim of any third person regarding infringement&n; * or the like.  Any license provided herein, whether implied or&n; * otherwise, applies only to this software file.  Patent licenses, if&n; * any, provided herein do not apply to combinations of this program with&n; * other software, or any other product whatsoever.&n; *&n; * You should have received a copy of the GNU General Public License along&n; * with this program; if not, write the Free Software Foundation, Inc., 59&n; * Temple Place - Suite 330, Boston MA 02111-1307, USA.&n; *&n; * Contact information: Silicon Graphics, Inc., 1600 Amphitheatre Pkwy,&n; * Mountain View, CA  94043, or:&n; *&n; * http://www.sgi.com&n; *&n; * For further information regarding this notice, see:&n; *&n; * http://oss.sgi.com/projects/GenInfo/SGIGPLNoticeExplan/&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/mount.h&gt;
macro_line|#include &lt;linux/namei.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;asm/sn/hwgfs.h&gt;
r_extern
r_struct
id|vfsmount
op_star
id|hwgfs_vfsmount
suffix:semicolon
multiline_comment|/* TODO: Move this to some .h file or, more likely, use a slightly&n;   different interface from lookup_create. */
r_extern
r_struct
id|dentry
op_star
id|lookup_create
c_func
(paren
r_struct
id|nameidata
op_star
id|nd
comma
r_int
id|is_dir
)paren
suffix:semicolon
r_static
r_int
DECL|function|walk_parents_mkdir
id|walk_parents_mkdir
c_func
(paren
r_const
r_char
op_star
op_star
id|path
comma
r_struct
id|nameidata
op_star
id|nd
comma
r_int
id|is_dir
)paren
(brace
r_char
op_star
id|slash
suffix:semicolon
r_char
id|buf
(braket
id|strlen
c_func
(paren
op_star
id|path
)paren
op_plus
l_int|1
)braket
suffix:semicolon
r_int
id|error
suffix:semicolon
r_while
c_loop
(paren
(paren
id|slash
op_assign
id|strchr
c_func
(paren
op_star
id|path
comma
l_char|&squot;/&squot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_int
id|len
op_assign
id|slash
op_minus
op_star
id|path
suffix:semicolon
id|memcpy
c_func
(paren
id|buf
comma
op_star
id|path
comma
id|len
)paren
suffix:semicolon
id|buf
(braket
id|len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|error
op_assign
id|link_path_walk
c_func
(paren
id|buf
comma
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|error
)paren
)paren
r_return
id|error
suffix:semicolon
id|nd-&gt;dentry
op_assign
id|lookup_create
c_func
(paren
id|nd
comma
id|is_dir
)paren
suffix:semicolon
id|nd-&gt;flags
op_or_assign
id|LOOKUP_PARENT
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|IS_ERR
c_func
(paren
id|nd-&gt;dentry
)paren
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|nd-&gt;dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nd-&gt;dentry-&gt;d_inode
)paren
id|error
op_assign
id|vfs_mkdir
c_func
(paren
id|nd-&gt;dentry-&gt;d_parent-&gt;d_inode
comma
id|nd-&gt;dentry
comma
l_int|0755
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|nd-&gt;dentry-&gt;d_parent-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|error
)paren
)paren
r_return
id|error
suffix:semicolon
op_star
id|path
op_add_assign
id|len
op_plus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* On success, returns with parent_inode-&gt;i_sem taken. */
r_static
r_int
DECL|function|hwgfs_decode
id|hwgfs_decode
c_func
(paren
id|hwgfs_handle_t
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
id|is_dir
comma
r_struct
id|inode
op_star
op_star
id|parent_inode
comma
r_struct
id|dentry
op_star
op_star
id|dentry
)paren
(brace
r_struct
id|nameidata
id|nd
suffix:semicolon
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dir
)paren
id|dir
op_assign
id|hwgfs_vfsmount-&gt;mnt_sb-&gt;s_root
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|nd
comma
l_int|0
comma
r_sizeof
(paren
id|nd
)paren
)paren
suffix:semicolon
id|nd.flags
op_assign
id|LOOKUP_PARENT
suffix:semicolon
id|nd.mnt
op_assign
id|mntget
c_func
(paren
id|hwgfs_vfsmount
)paren
suffix:semicolon
id|nd.dentry
op_assign
id|dget
c_func
(paren
id|dir
)paren
suffix:semicolon
id|error
op_assign
id|walk_parents_mkdir
c_func
(paren
op_amp
id|name
comma
op_amp
id|nd
comma
id|is_dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|error
)paren
)paren
r_return
id|error
suffix:semicolon
id|error
op_assign
id|link_path_walk
c_func
(paren
id|name
comma
op_amp
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|error
)paren
)paren
r_return
id|error
suffix:semicolon
op_star
id|dentry
op_assign
id|lookup_create
c_func
(paren
op_amp
id|nd
comma
id|is_dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|IS_ERR
c_func
(paren
op_star
id|dentry
)paren
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
op_star
id|dentry
)paren
suffix:semicolon
op_star
id|parent_inode
op_assign
(paren
op_star
id|dentry
)paren
op_member_access_from_pointer
id|d_parent-&gt;d_inode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|path_len
id|path_len
c_func
(paren
r_struct
id|dentry
op_star
id|de
comma
r_struct
id|dentry
op_star
id|root
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|de
op_ne
id|root
)paren
(brace
id|len
op_add_assign
id|de-&gt;d_name.len
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* count the &squot;/&squot; */
id|de
op_assign
id|de-&gt;d_parent
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
multiline_comment|/* -1 because we omit the leading &squot;/&squot;,&n;&t;&t;&t;&t;   +1 because we include trailing &squot;&bslash;0&squot; */
)brace
r_int
DECL|function|hwgfs_generate_path
id|hwgfs_generate_path
c_func
(paren
id|hwgfs_handle_t
id|de
comma
r_char
op_star
id|path
comma
r_int
id|buflen
)paren
(brace
r_struct
id|dentry
op_star
id|hwgfs_root
suffix:semicolon
r_int
id|len
suffix:semicolon
r_char
op_star
id|path_orig
op_assign
id|path
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|de
op_eq
l_int|NULL
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|hwgfs_root
op_assign
id|hwgfs_vfsmount-&gt;mnt_sb-&gt;s_root
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|de
op_eq
id|hwgfs_root
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dcache_lock
)paren
suffix:semicolon
id|len
op_assign
id|path_len
c_func
(paren
id|de
comma
id|hwgfs_root
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|buflen
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|dcache_lock
)paren
suffix:semicolon
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
)brace
id|path
op_add_assign
id|len
op_minus
l_int|1
suffix:semicolon
op_star
id|path
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|path
op_sub_assign
id|de-&gt;d_name.len
suffix:semicolon
id|memcpy
c_func
(paren
id|path
comma
id|de-&gt;d_name.name
comma
id|de-&gt;d_name.len
)paren
suffix:semicolon
id|de
op_assign
id|de-&gt;d_parent
suffix:semicolon
r_if
c_cond
(paren
id|de
op_eq
id|hwgfs_root
)paren
r_break
suffix:semicolon
op_star
(paren
op_decrement
id|path
)paren
op_assign
l_char|&squot;/&squot;
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|dcache_lock
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|path
op_ne
id|path_orig
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|hwgfs_handle_t
DECL|function|hwgfs_register
id|hwgfs_register
c_func
(paren
id|hwgfs_handle_t
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
r_int
id|flags
comma
r_int
r_int
id|major
comma
r_int
r_int
id|minor
comma
id|umode_t
id|mode
comma
r_void
op_star
id|ops
comma
r_void
op_star
id|info
)paren
(brace
id|dev_t
id|devnum
op_assign
id|MKDEV
c_func
(paren
id|major
comma
id|minor
)paren
suffix:semicolon
r_struct
id|inode
op_star
id|parent_inode
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
r_int
id|error
suffix:semicolon
id|error
op_assign
id|hwgfs_decode
c_func
(paren
id|dir
comma
id|name
comma
l_int|0
comma
op_amp
id|parent_inode
comma
op_amp
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
op_logical_neg
id|error
)paren
)paren
(brace
id|error
op_assign
id|vfs_mknod
c_func
(paren
id|parent_inode
comma
id|dentry
comma
id|mode
comma
id|devnum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
op_logical_neg
id|error
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Do this inside parents i_sem to avoid racing&n;&t;&t;&t; * with lookups.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|S_ISCHR
c_func
(paren
id|mode
)paren
)paren
id|dentry-&gt;d_inode-&gt;i_fop
op_assign
id|ops
suffix:semicolon
id|dentry-&gt;d_fsdata
op_assign
id|info
suffix:semicolon
id|up
c_func
(paren
op_amp
id|parent_inode-&gt;i_sem
)paren
suffix:semicolon
)brace
r_else
(brace
id|up
c_func
(paren
op_amp
id|parent_inode-&gt;i_sem
)paren
suffix:semicolon
id|dput
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|dentry
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_return
id|dentry
suffix:semicolon
)brace
r_int
DECL|function|hwgfs_mk_symlink
id|hwgfs_mk_symlink
c_func
(paren
id|hwgfs_handle_t
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
r_int
id|flags
comma
r_const
r_char
op_star
id|link
comma
id|hwgfs_handle_t
op_star
id|handle
comma
r_void
op_star
id|info
)paren
(brace
r_struct
id|inode
op_star
id|parent_inode
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
r_int
id|error
suffix:semicolon
id|error
op_assign
id|hwgfs_decode
c_func
(paren
id|dir
comma
id|name
comma
l_int|0
comma
op_amp
id|parent_inode
comma
op_amp
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
op_logical_neg
id|error
)paren
)paren
(brace
id|error
op_assign
id|vfs_symlink
c_func
(paren
id|parent_inode
comma
id|dentry
comma
id|link
)paren
suffix:semicolon
id|dentry-&gt;d_fsdata
op_assign
id|info
suffix:semicolon
r_if
c_cond
(paren
id|handle
)paren
op_star
id|handle
op_assign
id|dentry
suffix:semicolon
id|up
c_func
(paren
op_amp
id|parent_inode-&gt;i_sem
)paren
suffix:semicolon
multiline_comment|/* dput(dentry); */
)brace
r_return
id|error
suffix:semicolon
)brace
id|hwgfs_handle_t
DECL|function|hwgfs_mk_dir
id|hwgfs_mk_dir
c_func
(paren
id|hwgfs_handle_t
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_void
op_star
id|info
)paren
(brace
r_struct
id|inode
op_star
id|parent_inode
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
r_int
id|error
suffix:semicolon
id|error
op_assign
id|hwgfs_decode
c_func
(paren
id|dir
comma
id|name
comma
l_int|1
comma
op_amp
id|parent_inode
comma
op_amp
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
op_logical_neg
id|error
)paren
)paren
(brace
id|error
op_assign
id|vfs_mkdir
c_func
(paren
id|parent_inode
comma
id|dentry
comma
l_int|0755
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|parent_inode-&gt;i_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|error
)paren
)paren
(brace
id|dput
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|dentry
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|dentry-&gt;d_fsdata
op_assign
id|info
suffix:semicolon
)brace
)brace
r_return
id|dentry
suffix:semicolon
)brace
r_void
DECL|function|hwgfs_unregister
id|hwgfs_unregister
c_func
(paren
id|hwgfs_handle_t
id|de
)paren
(brace
r_struct
id|inode
op_star
id|parent_inode
op_assign
id|de-&gt;d_parent-&gt;d_inode
suffix:semicolon
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|de-&gt;d_inode-&gt;i_mode
)paren
)paren
id|vfs_rmdir
c_func
(paren
id|parent_inode
comma
id|de
)paren
suffix:semicolon
r_else
id|vfs_unlink
c_func
(paren
id|parent_inode
comma
id|de
)paren
suffix:semicolon
)brace
multiline_comment|/* XXX: this function is utterly bogus.  Every use of it is racy and the&n;        prototype is stupid.  You have been warned.  --hch.  */
id|hwgfs_handle_t
DECL|function|hwgfs_find_handle
id|hwgfs_find_handle
c_func
(paren
id|hwgfs_handle_t
id|base
comma
r_const
r_char
op_star
id|name
comma
r_int
r_int
id|major
comma
multiline_comment|/* IGNORED */
r_int
r_int
id|minor
comma
multiline_comment|/* IGNORED */
r_char
id|type
comma
multiline_comment|/* IGNORED */
r_int
id|traverse_symlinks
)paren
(brace
r_struct
id|dentry
op_star
id|dentry
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|nameidata
id|nd
suffix:semicolon
r_int
id|error
suffix:semicolon
id|BUG_ON
c_func
(paren
op_star
id|name
op_eq
l_char|&squot;/&squot;
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|nd
comma
l_int|0
comma
r_sizeof
(paren
id|nd
)paren
)paren
suffix:semicolon
id|nd.mnt
op_assign
id|mntget
c_func
(paren
id|hwgfs_vfsmount
)paren
suffix:semicolon
id|nd.dentry
op_assign
id|dget
c_func
(paren
id|base
ques
c_cond
id|base
suffix:colon
id|hwgfs_vfsmount-&gt;mnt_sb-&gt;s_root
)paren
suffix:semicolon
r_if
c_cond
(paren
id|traverse_symlinks
)paren
id|nd.flags
op_assign
id|LOOKUP_FOLLOW
suffix:semicolon
id|error
op_assign
id|link_path_walk
c_func
(paren
id|name
comma
op_amp
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
op_logical_neg
id|error
)paren
)paren
(brace
id|dentry
op_assign
id|nd.dentry
suffix:semicolon
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
multiline_comment|/* stale data from here! */
)brace
r_return
id|dentry
suffix:semicolon
)brace
id|hwgfs_handle_t
DECL|function|hwgfs_get_parent
id|hwgfs_get_parent
c_func
(paren
id|hwgfs_handle_t
id|de
)paren
(brace
r_struct
id|dentry
op_star
id|parent
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|de-&gt;d_lock
)paren
suffix:semicolon
id|parent
op_assign
id|de-&gt;d_parent
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|de-&gt;d_lock
)paren
suffix:semicolon
r_return
id|parent
suffix:semicolon
)brace
r_int
DECL|function|hwgfs_set_info
id|hwgfs_set_info
c_func
(paren
id|hwgfs_handle_t
id|de
comma
r_void
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|de
op_eq
l_int|NULL
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|de-&gt;d_fsdata
op_assign
id|info
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
op_star
DECL|function|hwgfs_get_info
id|hwgfs_get_info
c_func
(paren
id|hwgfs_handle_t
id|de
)paren
(brace
r_return
id|de-&gt;d_fsdata
suffix:semicolon
)brace
DECL|variable|hwgfs_generate_path
id|EXPORT_SYMBOL
c_func
(paren
id|hwgfs_generate_path
)paren
suffix:semicolon
DECL|variable|hwgfs_register
id|EXPORT_SYMBOL
c_func
(paren
id|hwgfs_register
)paren
suffix:semicolon
DECL|variable|hwgfs_unregister
id|EXPORT_SYMBOL
c_func
(paren
id|hwgfs_unregister
)paren
suffix:semicolon
DECL|variable|hwgfs_mk_symlink
id|EXPORT_SYMBOL
c_func
(paren
id|hwgfs_mk_symlink
)paren
suffix:semicolon
DECL|variable|hwgfs_mk_dir
id|EXPORT_SYMBOL
c_func
(paren
id|hwgfs_mk_dir
)paren
suffix:semicolon
DECL|variable|hwgfs_find_handle
id|EXPORT_SYMBOL
c_func
(paren
id|hwgfs_find_handle
)paren
suffix:semicolon
DECL|variable|hwgfs_get_parent
id|EXPORT_SYMBOL
c_func
(paren
id|hwgfs_get_parent
)paren
suffix:semicolon
DECL|variable|hwgfs_set_info
id|EXPORT_SYMBOL
c_func
(paren
id|hwgfs_set_info
)paren
suffix:semicolon
DECL|variable|hwgfs_get_info
id|EXPORT_SYMBOL
c_func
(paren
id|hwgfs_get_info
)paren
suffix:semicolon
eof
