multiline_comment|/* $Id$&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Copyright (C) 1992-1997, 2000-2003 Silicon Graphics, Inc.  All Rights Reserved.&n; */
macro_line|#ident  &quot;$Revision: 1.167 $&quot;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/smp.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/hw_irq.h&gt;
macro_line|#include &lt;asm/sn/sgi.h&gt;
macro_line|#include &lt;asm/sn/iograph.h&gt;
macro_line|#include &lt;asm/sn/invent.h&gt;
macro_line|#include &lt;asm/sn/hcl.h&gt;
macro_line|#include &lt;asm/sn/labelcl.h&gt;
macro_line|#include &lt;asm/sn/io.h&gt;
macro_line|#include &lt;asm/sn/sn_private.h&gt;
macro_line|#include &lt;asm/sn/klconfig.h&gt;
macro_line|#include &lt;asm/sn/sn_cpuid.h&gt;
macro_line|#include &lt;asm/sn/pci/pciio.h&gt;
macro_line|#include &lt;asm/sn/pci/pcibr.h&gt;
macro_line|#include &lt;asm/sn/xtalk/xtalk.h&gt;
macro_line|#include &lt;asm/sn/pci/pcibr_private.h&gt;
macro_line|#include &lt;asm/sn/intr.h&gt;
macro_line|#include &lt;asm/sn/sn2/shub_mmr_t.h&gt;
macro_line|#include &lt;asm/sal.h&gt;
macro_line|#include &lt;asm/sn/sn_sal.h&gt;
macro_line|#include &lt;asm/sn/sndrv.h&gt;
multiline_comment|/*&n; * Shub WAR for Xbridge Little Endian problem:&n; *&t;Xbridge has to run in BIG ENDIAN even with Shub.&n; */
multiline_comment|/*&n; * io_sh_swapper: Turn on Shub byte swapping.&n; *&t;All data destined to and from Shub to XIO are byte-swapped.&n; */
r_void
DECL|function|io_sh_swapper
id|io_sh_swapper
c_func
(paren
id|nasid_t
id|nasid
comma
r_int
id|onoff
)paren
(brace
id|ii_iwc_u_t
id|ii_iwc
suffix:semicolon
id|ii_iwc.ii_iwc_regval
op_assign
id|REMOTE_HUB_L
c_func
(paren
id|nasid
comma
id|IIO_IWC
)paren
suffix:semicolon
id|ii_iwc.ii_iwc_fld_s.i_dma_byte_swap
op_assign
id|onoff
suffix:semicolon
id|REMOTE_HUB_S
c_func
(paren
id|nasid
comma
id|IIO_IWC
comma
id|ii_iwc.ii_iwc_regval
)paren
suffix:semicolon
id|ii_iwc.ii_iwc_regval
op_assign
id|REMOTE_HUB_L
c_func
(paren
id|nasid
comma
id|IIO_IWC
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * io_get_sh_swapper: Return current Swap mode.&n; *&t;1 = Swap on, 0 = Swap off.&n; */
r_int
DECL|function|io_get_sh_swapper
id|io_get_sh_swapper
c_func
(paren
id|nasid_t
id|nasid
)paren
(brace
id|ii_iwc_u_t
id|ii_iwc
suffix:semicolon
id|ii_iwc.ii_iwc_regval
op_assign
id|REMOTE_HUB_L
c_func
(paren
id|nasid
comma
id|IIO_IWC
)paren
suffix:semicolon
r_return
id|ii_iwc.ii_iwc_fld_s.i_dma_byte_swap
suffix:semicolon
)brace
DECL|macro|SHUB_NUM_ECF_REGISTERS
mdefine_line|#define SHUB_NUM_ECF_REGISTERS 8
DECL|variable|shub_perf_counts
r_static
r_uint32
id|shub_perf_counts
(braket
id|SHUB_NUM_ECF_REGISTERS
)braket
suffix:semicolon
DECL|variable|shub_perf_counts_regs
r_static
id|shubreg_t
id|shub_perf_counts_regs
(braket
id|SHUB_NUM_ECF_REGISTERS
)braket
op_assign
(brace
id|SH_PERFORMANCE_COUNTER0
comma
id|SH_PERFORMANCE_COUNTER1
comma
id|SH_PERFORMANCE_COUNTER2
comma
id|SH_PERFORMANCE_COUNTER3
comma
id|SH_PERFORMANCE_COUNTER4
comma
id|SH_PERFORMANCE_COUNTER5
comma
id|SH_PERFORMANCE_COUNTER6
comma
id|SH_PERFORMANCE_COUNTER7
)brace
suffix:semicolon
r_static
r_inline
r_void
DECL|function|shub_mmr_write
id|shub_mmr_write
c_func
(paren
id|cnodeid_t
id|cnode
comma
id|shubreg_t
id|reg
comma
r_uint64
id|val
)paren
(brace
r_int
id|nasid
op_assign
id|cnodeid_to_nasid
c_func
(paren
id|cnode
)paren
suffix:semicolon
r_volatile
r_uint64
op_star
id|addr
op_assign
(paren
r_uint64
op_star
)paren
(paren
id|GLOBAL_MMR_ADDR
c_func
(paren
id|nasid
comma
id|reg
)paren
)paren
suffix:semicolon
op_star
id|addr
op_assign
id|val
suffix:semicolon
id|__ia64_mf_a
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|shub_mmr_write32
id|shub_mmr_write32
c_func
(paren
id|cnodeid_t
id|cnode
comma
id|shubreg_t
id|reg
comma
r_uint32
id|val
)paren
(brace
r_int
id|nasid
op_assign
id|cnodeid_to_nasid
c_func
(paren
id|cnode
)paren
suffix:semicolon
r_volatile
r_uint32
op_star
id|addr
op_assign
(paren
r_uint32
op_star
)paren
(paren
id|GLOBAL_MMR_ADDR
c_func
(paren
id|nasid
comma
id|reg
)paren
)paren
suffix:semicolon
op_star
id|addr
op_assign
id|val
suffix:semicolon
id|__ia64_mf_a
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_inline
r_uint64
DECL|function|shub_mmr_read
id|shub_mmr_read
c_func
(paren
id|cnodeid_t
id|cnode
comma
id|shubreg_t
id|reg
)paren
(brace
r_int
id|nasid
op_assign
id|cnodeid_to_nasid
c_func
(paren
id|cnode
)paren
suffix:semicolon
r_volatile
r_uint64
id|val
suffix:semicolon
id|val
op_assign
op_star
(paren
r_uint64
op_star
)paren
(paren
id|GLOBAL_MMR_ADDR
c_func
(paren
id|nasid
comma
id|reg
)paren
)paren
suffix:semicolon
id|__ia64_mf_a
c_func
(paren
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
r_static
r_inline
r_uint32
DECL|function|shub_mmr_read32
id|shub_mmr_read32
c_func
(paren
id|cnodeid_t
id|cnode
comma
id|shubreg_t
id|reg
)paren
(brace
r_int
id|nasid
op_assign
id|cnodeid_to_nasid
c_func
(paren
id|cnode
)paren
suffix:semicolon
r_volatile
r_uint32
id|val
suffix:semicolon
id|val
op_assign
op_star
(paren
r_uint32
op_star
)paren
(paren
id|GLOBAL_MMR_ADDR
c_func
(paren
id|nasid
comma
id|reg
)paren
)paren
suffix:semicolon
id|__ia64_mf_a
c_func
(paren
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
r_static
r_int
DECL|function|reset_shub_stats
id|reset_shub_stats
c_func
(paren
id|cnodeid_t
id|cnode
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SHUB_NUM_ECF_REGISTERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|shub_perf_counts
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|shub_mmr_write32
c_func
(paren
id|cnode
comma
id|shub_perf_counts_regs
(braket
id|i
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|configure_shub_stats
id|configure_shub_stats
c_func
(paren
id|cnodeid_t
id|cnode
comma
r_int
r_int
id|arg
)paren
(brace
r_uint64
op_star
id|p
op_assign
(paren
r_uint64
op_star
)paren
id|arg
suffix:semicolon
r_uint64
id|i
suffix:semicolon
r_uint64
id|regcnt
suffix:semicolon
r_uint64
id|regval
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|regcnt
comma
id|p
comma
r_sizeof
(paren
id|regcnt
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_for
c_loop
(paren
id|p
op_increment
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|regcnt
suffix:semicolon
id|i
op_increment
comma
id|p
op_add_assign
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
id|regval
comma
(paren
r_void
op_star
)paren
id|p
comma
r_sizeof
(paren
id|regval
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|regval
(braket
l_int|0
)braket
op_amp
l_int|0x7
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Error: configure_shub_stats: unaligned address 0x%016lx&bslash;n&quot;
comma
id|regval
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|shub_mmr_write
c_func
(paren
id|cnode
comma
(paren
id|shubreg_t
)paren
id|regval
(braket
l_int|0
)braket
comma
id|regval
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|capture_shub_stats
id|capture_shub_stats
c_func
(paren
id|cnodeid_t
id|cnode
comma
r_uint32
op_star
id|counts
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SHUB_NUM_ECF_REGISTERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|counts
(braket
id|i
)braket
op_assign
id|shub_mmr_read32
c_func
(paren
id|cnode
comma
id|shub_perf_counts_regs
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|shubstats_ioctl
id|shubstats_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|cnodeid_t
id|cnode
suffix:semicolon
r_uint64
id|longarg
suffix:semicolon
id|devfs_handle_t
id|d
suffix:semicolon
r_int
id|nasid
suffix:semicolon
r_if
c_cond
(paren
(paren
id|d
op_assign
id|devfs_get_handle_from_inode
c_func
(paren
id|inode
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|cnode
op_assign
(paren
id|cnodeid_t
)paren
id|hwgraph_fastinfo_get
c_func
(paren
id|d
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SNDRV_SHUB_CONFIGURE
suffix:colon
r_return
id|configure_shub_stats
c_func
(paren
id|cnode
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_SHUB_RESETSTATS
suffix:colon
id|reset_shub_stats
c_func
(paren
id|cnode
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_SHUB_INFOSIZE
suffix:colon
id|longarg
op_assign
r_sizeof
(paren
id|shub_perf_counts
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|longarg
comma
r_sizeof
(paren
id|longarg
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SNDRV_SHUB_GETSTATS
suffix:colon
id|capture_shub_stats
c_func
(paren
id|cnode
comma
id|shub_perf_counts
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
id|shub_perf_counts
comma
r_sizeof
(paren
id|shub_perf_counts
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SNDRV_SHUB_GETNASID
suffix:colon
id|nasid
op_assign
id|cnodeid_to_nasid
c_func
(paren
id|cnode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|nasid
comma
r_sizeof
(paren
id|nasid
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|shub_mon_fops
r_struct
id|file_operations
id|shub_mon_fops
op_assign
(brace
id|ioctl
suffix:colon
id|shubstats_ioctl
comma
)brace
suffix:semicolon
eof
