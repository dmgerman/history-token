multiline_comment|/* $Id$&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Copyright (c) 1992-1997,2000-2003 Silicon Graphics, Inc. All rights reserved.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;asm/sn/sgi.h&gt;
macro_line|#include &lt;asm/sn/io.h&gt;
macro_line|#include &lt;asm/sn/iograph.h&gt;
macro_line|#include &lt;asm/sn/invent.h&gt;
macro_line|#include &lt;asm/sn/hcl.h&gt;
macro_line|#include &lt;asm/sn/hcl_util.h&gt;
macro_line|#include &lt;asm/sn/labelcl.h&gt;
macro_line|#include &lt;asm/sn/eeprom.h&gt;
macro_line|#include &lt;asm/sn/router.h&gt;
macro_line|#include &lt;asm/sn/module.h&gt;
macro_line|#include &lt;asm/sn/ksys/l1.h&gt;
macro_line|#include &lt;asm/sn/nodepda.h&gt;
macro_line|#include &lt;asm/sn/clksupport.h&gt;
macro_line|#include &lt;asm/sn/sn_cpuid.h&gt;
macro_line|#include &lt;asm/sn/sn_sal.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
DECL|macro|ELSC_TIMEOUT
mdefine_line|#define ELSC_TIMEOUT&t;1000000&t;&t;/* ELSC response timeout (usec) */
DECL|macro|LOCK_TIMEOUT
mdefine_line|#define LOCK_TIMEOUT&t;5000000&t;&t;/* Hub lock timeout (usec) */
DECL|macro|hub_cpu_get
mdefine_line|#define hub_cpu_get()&t;0
DECL|macro|LBYTE
mdefine_line|#define LBYTE(caddr)&t;(*(char *) caddr)
r_extern
r_char
op_star
id|bcopy
c_func
(paren
r_const
r_char
op_star
id|src
comma
r_char
op_star
id|dest
comma
r_int
id|count
)paren
suffix:semicolon
DECL|macro|LDEBUG
mdefine_line|#define LDEBUG&t;&t;0
multiline_comment|/*&n; * ELSC data is in NVRAM page 7 at the following offsets.&n; */
DECL|macro|NVRAM_MAGIC_AD
mdefine_line|#define NVRAM_MAGIC_AD&t;0x700&t;&t;/* magic number used for init */
DECL|macro|NVRAM_PASS_WD
mdefine_line|#define NVRAM_PASS_WD&t;0x701&t;&t;/* password (4 bytes in length) */
DECL|macro|NVRAM_DBG1
mdefine_line|#define NVRAM_DBG1&t;0x705&t;&t;/* virtual XOR debug switches */
DECL|macro|NVRAM_DBG2
mdefine_line|#define NVRAM_DBG2&t;0x706&t;&t;/* physical XOR debug switches */
DECL|macro|NVRAM_CFG
mdefine_line|#define NVRAM_CFG&t;0x707&t;&t;/* ELSC Configuration info */
DECL|macro|NVRAM_MODULE
mdefine_line|#define NVRAM_MODULE&t;0x708&t;&t;/* system module number */
DECL|macro|NVRAM_BIST_FLG
mdefine_line|#define NVRAM_BIST_FLG&t;0x709&t;&t;/* BIST flags (2 bits per nodeboard) */
DECL|macro|NVRAM_PARTITION
mdefine_line|#define NVRAM_PARTITION 0x70a&t;&t;/* module&squot;s partition id */
DECL|macro|NVRAM_DOMAIN
mdefine_line|#define&t;NVRAM_DOMAIN&t;0x70b&t;&t;/* module&squot;s domain id */
DECL|macro|NVRAM_CLUSTER
mdefine_line|#define&t;NVRAM_CLUSTER&t;0x70c&t;&t;/* module&squot;s cluster id */
DECL|macro|NVRAM_CELL
mdefine_line|#define&t;NVRAM_CELL&t;0x70d&t;&t;/* module&squot;s cellid */
DECL|macro|NVRAM_MAGIC_NO
mdefine_line|#define NVRAM_MAGIC_NO&t;0x37&t;&t;/* value of magic number */
DECL|macro|NVRAM_SIZE
mdefine_line|#define NVRAM_SIZE&t;16&t;&t;/* 16 bytes in nvram */
multiline_comment|/* elsc_display_line writes up to 12 characters to either the top or bottom&n; * line of the L1 display.  line points to a buffer containing the message&n; * to be displayed.  The zero-based line number is specified by lnum (so&n; * lnum == 0 specifies the top line and lnum == 1 specifies the bottom).&n; * Lines longer than 12 characters, or line numbers not less than&n; * L1_DISPLAY_LINES, cause elsc_display_line to return an error.&n; */
DECL|function|elsc_display_line
r_int
id|elsc_display_line
c_func
(paren
id|nasid_t
id|nasid
comma
r_char
op_star
id|line
comma
r_int
id|lnum
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * iobrick routines&n; */
multiline_comment|/* iobrick_rack_bay_type_get fills in the three int * arguments with the&n; * rack number, bay number and brick type of the L1 being addressed.  Note&n; * that if the L1 operation fails and this function returns an error value, &n; * garbage may be written to brick_type.&n; */
DECL|function|iobrick_rack_bay_type_get
r_int
id|iobrick_rack_bay_type_get
c_func
(paren
id|nasid_t
id|nasid
comma
id|uint
op_star
id|rack
comma
id|uint
op_star
id|bay
comma
id|uint
op_star
id|brick_type
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ia64_sn_sysctl_iobrick_module_get
c_func
(paren
id|nasid
comma
op_amp
id|result
)paren
)paren
r_return
id|ELSC_ERROR_CMD_SEND
suffix:semicolon
op_star
id|rack
op_assign
(paren
id|result
op_amp
id|L1_ADDR_RACK_MASK
)paren
op_rshift
id|L1_ADDR_RACK_SHFT
suffix:semicolon
op_star
id|bay
op_assign
(paren
id|result
op_amp
id|L1_ADDR_BAY_MASK
)paren
op_rshift
id|L1_ADDR_BAY_SHFT
suffix:semicolon
op_star
id|brick_type
op_assign
(paren
id|result
op_amp
id|L1_ADDR_TYPE_MASK
)paren
op_rshift
id|L1_ADDR_TYPE_SHFT
suffix:semicolon
op_star
id|brick_type
op_assign
id|toupper
c_func
(paren
op_star
id|brick_type
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|iomoduleid_get
r_int
id|iomoduleid_get
c_func
(paren
id|nasid_t
id|nasid
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ia64_sn_sysctl_iobrick_module_get
c_func
(paren
id|nasid
comma
op_amp
id|result
)paren
)paren
r_return
id|ELSC_ERROR_CMD_SEND
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|iobrick_module_get
r_int
id|iobrick_module_get
c_func
(paren
id|nasid_t
id|nasid
)paren
(brace
id|uint
id|rnum
comma
id|rack
comma
id|bay
comma
id|brick_type
comma
id|t
suffix:semicolon
r_int
id|ret
suffix:semicolon
multiline_comment|/* construct module ID from rack and slot info */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|iobrick_rack_bay_type_get
c_func
(paren
id|nasid
comma
op_amp
id|rnum
comma
op_amp
id|bay
comma
op_amp
id|brick_type
)paren
)paren
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|bay
OG
id|MODULE_BPOS_MASK
op_rshift
id|MODULE_BPOS_SHFT
)paren
r_return
id|ELSC_ERROR_MODULE
suffix:semicolon
multiline_comment|/* Build a moduleid_t-compatible rack number */
id|rack
op_assign
l_int|0
suffix:semicolon
id|t
op_assign
id|rnum
op_div
l_int|100
suffix:semicolon
multiline_comment|/* rack class (CPU/IO) */
r_if
c_cond
(paren
id|t
OG
id|RACK_CLASS_MASK
c_func
(paren
id|rack
)paren
op_rshift
id|RACK_CLASS_SHFT
c_func
(paren
id|rack
)paren
)paren
r_return
id|ELSC_ERROR_MODULE
suffix:semicolon
id|RACK_ADD_CLASS
c_func
(paren
id|rack
comma
id|t
)paren
suffix:semicolon
id|rnum
op_mod_assign
l_int|100
suffix:semicolon
id|t
op_assign
id|rnum
op_div
l_int|10
suffix:semicolon
multiline_comment|/* rack group */
r_if
c_cond
(paren
id|t
OG
id|RACK_GROUP_MASK
c_func
(paren
id|rack
)paren
op_rshift
id|RACK_GROUP_SHFT
c_func
(paren
id|rack
)paren
)paren
r_return
id|ELSC_ERROR_MODULE
suffix:semicolon
id|RACK_ADD_GROUP
c_func
(paren
id|rack
comma
id|t
)paren
suffix:semicolon
id|t
op_assign
id|rnum
op_mod
l_int|10
suffix:semicolon
multiline_comment|/* rack number (one-based) */
r_if
c_cond
(paren
id|t
op_minus
l_int|1
OG
id|RACK_NUM_MASK
c_func
(paren
id|rack
)paren
op_rshift
id|RACK_NUM_SHFT
c_func
(paren
id|rack
)paren
)paren
r_return
id|ELSC_ERROR_MODULE
suffix:semicolon
id|RACK_ADD_NUM
c_func
(paren
id|rack
comma
id|t
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|brick_type
)paren
(brace
r_case
l_char|&squot;I&squot;
suffix:colon
id|brick_type
op_assign
id|MODULE_IBRICK
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;P&squot;
suffix:colon
id|brick_type
op_assign
id|MODULE_PBRICK
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;X&squot;
suffix:colon
id|brick_type
op_assign
id|MODULE_XBRICK
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ret
op_assign
id|RBT_TO_MODULE
c_func
(paren
id|rack
comma
id|bay
comma
id|brick_type
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * iobrick_module_get_nasid() returns a module_id which has the brick&n; * type encoded in bits 15-12, but this is not the true brick type...&n; * The module_id returned by iobrick_module_get_nasid() is modified&n; * to make a PEBRICKs &amp; PXBRICKs look like a PBRICK.  So this routine&n; * iobrick_type_get_nasid() returns the true unmodified brick type.&n; */
r_int
DECL|function|iobrick_type_get_nasid
id|iobrick_type_get_nasid
c_func
(paren
id|nasid_t
id|nasid
)paren
(brace
id|uint
id|rack
comma
id|bay
comma
id|type
suffix:semicolon
r_int
id|t
comma
id|ret
suffix:semicolon
r_extern
r_char
id|brick_types
(braket
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|iobrick_rack_bay_type_get
c_func
(paren
id|nasid
comma
op_amp
id|rack
comma
op_amp
id|bay
comma
op_amp
id|type
)paren
)paren
OL
l_int|0
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* convert brick_type to lower case */
r_if
c_cond
(paren
(paren
id|type
op_ge
l_char|&squot;A&squot;
)paren
op_logical_and
(paren
id|type
op_le
l_char|&squot;Z&squot;
)paren
)paren
id|type
op_assign
id|type
op_minus
l_char|&squot;A&squot;
op_plus
l_char|&squot;a&squot;
suffix:semicolon
multiline_comment|/* convert to a module.h brick type */
r_for
c_loop
(paren
id|t
op_assign
l_int|0
suffix:semicolon
id|t
OL
id|MAX_BRICK_TYPES
suffix:semicolon
id|t
op_increment
)paren
(brace
r_if
c_cond
(paren
id|brick_types
(braket
id|t
)braket
op_eq
id|type
)paren
(brace
r_return
id|t
suffix:semicolon
)brace
)brace
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* unknown brick */
)brace
DECL|function|iobrick_module_get_nasid
r_int
id|iobrick_module_get_nasid
c_func
(paren
id|nasid_t
id|nasid
)paren
(brace
r_int
id|io_moduleid
suffix:semicolon
macro_line|#ifdef PIC_LATER
id|uint
id|rack
comma
id|bay
suffix:semicolon
r_if
c_cond
(paren
id|PEBRICK_NODE
c_func
(paren
id|nasid
)paren
)paren
(brace
r_if
c_cond
(paren
id|peer_iobrick_rack_bay_get
c_func
(paren
id|nasid
comma
op_amp
id|rack
comma
op_amp
id|bay
)paren
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;Could not read rack and bay location &quot;
l_string|&quot;of PEBrick at nasid %d&bslash;n&quot;
comma
id|nasid
)paren
suffix:semicolon
)brace
id|io_moduleid
op_assign
id|peer_iobrick_module_get
c_func
(paren
id|sc
comma
id|rack
comma
id|bay
)paren
suffix:semicolon
)brace
macro_line|#endif&t;/* PIC_LATER */
id|io_moduleid
op_assign
id|iobrick_module_get
c_func
(paren
id|nasid
)paren
suffix:semicolon
r_return
id|io_moduleid
suffix:semicolon
)brace
eof
