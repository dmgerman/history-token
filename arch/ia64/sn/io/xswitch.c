multiline_comment|/* $Id$&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Copyright (C) 1992 - 1997, 2000-2001 Silicon Graphics, Inc. All rights reserved.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;asm/sn/sgi.h&gt;
macro_line|#include &lt;asm/sn/driver.h&gt;
macro_line|#include &lt;asm/sn/iograph.h&gt;
macro_line|#include &lt;asm/sn/invent.h&gt;
macro_line|#include &lt;asm/sn/hcl.h&gt;
macro_line|#include &lt;asm/sn/labelcl.h&gt;
macro_line|#include &lt;asm/sn/xtalk/xtalk.h&gt;
macro_line|#include &lt;asm/sn/xtalk/xswitch.h&gt;
macro_line|#include &lt;asm/sn/xtalk/xwidget.h&gt;
macro_line|#include &lt;asm/sn/xtalk/xtalk_private.h&gt;
DECL|macro|NEW
mdefine_line|#define&t;NEW(ptr)&t;(ptr = kmalloc(sizeof (*(ptr)), GFP_KERNEL))
DECL|macro|DEL
mdefine_line|#define&t;DEL(ptr)&t;(kfree(ptr))
DECL|variable|xswitch_devflag
r_int
id|xswitch_devflag
op_assign
id|D_MP
suffix:semicolon
multiline_comment|/*&n; * This file provides generic support for Crosstalk&n; * Switches, in a way that insulates crosstalk providers&n; * from specifics about the switch chips being used.&n; */
macro_line|#include &lt;asm/sn/xtalk/xbow.h&gt;
DECL|macro|DEV_FUNC
mdefine_line|#define DEV_FUNC(dev,func)      xbow_##func
macro_line|#if !defined(DEV_FUNC)
multiline_comment|/*&n; * There is more than one possible provider&n; * for this platform. We need to examine the&n; * master vertex of the current vertex for&n; * a provider function structure, and indirect&n; * through the appropriately named member.&n; */
DECL|macro|DEV_FUNC
mdefine_line|#define&t;DEV_FUNC(dev,func)&t;xwidget_to_provider_fns(dev)-&gt;func
r_static
id|xswitch_provider_t
op_star
DECL|function|xwidget_to_provider_fns
id|xwidget_to_provider_fns
c_func
(paren
id|devfs_handle_t
id|xconn
)paren
(brace
id|devfs_handle_t
id|busv
suffix:semicolon
id|xswitch_info_t
id|xswitch_info
suffix:semicolon
id|xswitch_provider_t
id|provider_fns
suffix:semicolon
id|busv
op_assign
id|hwgraph_connectpt_get
c_func
(paren
id|xconn_vhdl
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|busv
op_ne
id|GRAPH_VERTEX_NONE
)paren
suffix:semicolon
id|xswitch_info
op_assign
id|xswitch_info_get
c_func
(paren
id|busv
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|xswitch_info
op_ne
l_int|NULL
)paren
suffix:semicolon
id|provider_fns
op_assign
id|xswitch_info-&gt;xswitch_fns
suffix:semicolon
id|ASSERT
c_func
(paren
id|provider_fns
op_ne
l_int|NULL
)paren
suffix:semicolon
r_return
id|provider_fns
suffix:semicolon
)brace
macro_line|#endif
DECL|macro|XSWITCH_CENSUS_BIT
mdefine_line|#define&t;XSWITCH_CENSUS_BIT(port)&t;&t;(1&lt;&lt;(port))
DECL|macro|XSWITCH_CENSUS_PORT_MIN
mdefine_line|#define&t;XSWITCH_CENSUS_PORT_MIN&t;&t;&t;(0x0)
DECL|macro|XSWITCH_CENSUS_PORT_MAX
mdefine_line|#define&t;XSWITCH_CENSUS_PORT_MAX&t;&t;&t;(0xF)
DECL|macro|XSWITCH_CENSUS_PORTS
mdefine_line|#define&t;XSWITCH_CENSUS_PORTS&t;&t;&t;(0x10)
DECL|macro|XSWITCH_WIDGET_PRESENT
mdefine_line|#define&t;XSWITCH_WIDGET_PRESENT(infop,port)&t;((infop)-&gt;census &amp; XSWITCH_CENSUS_BIT(port))
DECL|variable|xswitch_info_fingerprint
r_static
r_char
id|xswitch_info_fingerprint
(braket
)braket
op_assign
l_string|&quot;xswitch_info&quot;
suffix:semicolon
DECL|struct|xswitch_info_s
r_struct
id|xswitch_info_s
(brace
DECL|member|fingerprint
r_char
op_star
id|fingerprint
suffix:semicolon
DECL|member|census
r_int
id|census
suffix:semicolon
DECL|member|vhdl
id|devfs_handle_t
id|vhdl
(braket
id|XSWITCH_CENSUS_PORTS
)braket
suffix:semicolon
DECL|member|master_vhdl
id|devfs_handle_t
id|master_vhdl
(braket
id|XSWITCH_CENSUS_PORTS
)braket
suffix:semicolon
DECL|member|xswitch_fns
id|xswitch_provider_t
op_star
id|xswitch_fns
suffix:semicolon
)brace
suffix:semicolon
id|xswitch_info_t
DECL|function|xswitch_info_get
id|xswitch_info_get
c_func
(paren
id|devfs_handle_t
id|xwidget
)paren
(brace
id|xswitch_info_t
id|xswitch_info
suffix:semicolon
id|xswitch_info
op_assign
(paren
id|xswitch_info_t
)paren
id|hwgraph_fastinfo_get
c_func
(paren
id|xwidget
)paren
suffix:semicolon
macro_line|#ifdef&t;LATER
r_if
c_cond
(paren
(paren
id|xswitch_info
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|xswitch_info-&gt;fingerprint
op_ne
id|xswitch_info_fingerprint
)paren
)paren
macro_line|#ifdef SUPPORT_PRINTING_V_FORMAT
id|PRINT_PANIC
c_func
(paren
l_string|&quot;%v xswitch_info_get bad fingerprint&quot;
comma
id|xwidget
)paren
suffix:semicolon
macro_line|#else
id|PRINT_PANIC
c_func
(paren
l_string|&quot;%x xswitch_info_get bad fingerprint&quot;
comma
id|xwidget
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif&t;/* LATER */
r_return
(paren
id|xswitch_info
)paren
suffix:semicolon
)brace
r_void
DECL|function|xswitch_info_vhdl_set
id|xswitch_info_vhdl_set
c_func
(paren
id|xswitch_info_t
id|xswitch_info
comma
id|xwidgetnum_t
id|port
comma
id|devfs_handle_t
id|xwidget
)paren
(brace
macro_line|#if XSWITCH_CENSUS_PORT_MIN
r_if
c_cond
(paren
id|port
OL
id|XSWITCH_CENSUS_PORT_MIN
)paren
r_return
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|port
OG
id|XSWITCH_CENSUS_PORT_MAX
)paren
r_return
suffix:semicolon
id|xswitch_info-&gt;vhdl
(braket
id|port
op_minus
id|XSWITCH_CENSUS_PORT_MIN
)braket
op_assign
id|xwidget
suffix:semicolon
)brace
id|devfs_handle_t
DECL|function|xswitch_info_vhdl_get
id|xswitch_info_vhdl_get
c_func
(paren
id|xswitch_info_t
id|xswitch_info
comma
id|xwidgetnum_t
id|port
)paren
(brace
macro_line|#ifdef&t;LATER
r_if
c_cond
(paren
id|xswitch_info
op_eq
l_int|NULL
)paren
id|PRINT_PANIC
c_func
(paren
l_string|&quot;xswitch_info_vhdl_get: null xswitch_info&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if XSWITCH_CENSUS_PORT_MIN
r_if
c_cond
(paren
id|port
OL
id|XSWITCH_CENSUS_PORT_MIN
)paren
r_return
id|GRAPH_VERTEX_NONE
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|port
OG
id|XSWITCH_CENSUS_PORT_MAX
)paren
r_return
id|GRAPH_VERTEX_NONE
suffix:semicolon
r_return
id|xswitch_info-&gt;vhdl
(braket
id|port
op_minus
id|XSWITCH_CENSUS_PORT_MIN
)braket
suffix:semicolon
)brace
multiline_comment|/*&n; * Some systems may allow for multiple switch masters.  On such systems,&n; * we assign a master for each port on the switch.  These interfaces&n; * establish and retrieve that assignment.&n; */
r_void
DECL|function|xswitch_info_master_assignment_set
id|xswitch_info_master_assignment_set
c_func
(paren
id|xswitch_info_t
id|xswitch_info
comma
id|xwidgetnum_t
id|port
comma
id|devfs_handle_t
id|master_vhdl
)paren
(brace
macro_line|#if XSWITCH_CENSUS_PORT_MIN
r_if
c_cond
(paren
id|port
OL
id|XSWITCH_CENSUS_PORT_MIN
)paren
r_return
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|port
OG
id|XSWITCH_CENSUS_PORT_MAX
)paren
r_return
suffix:semicolon
id|xswitch_info-&gt;master_vhdl
(braket
id|port
op_minus
id|XSWITCH_CENSUS_PORT_MIN
)braket
op_assign
id|master_vhdl
suffix:semicolon
)brace
id|devfs_handle_t
DECL|function|xswitch_info_master_assignment_get
id|xswitch_info_master_assignment_get
c_func
(paren
id|xswitch_info_t
id|xswitch_info
comma
id|xwidgetnum_t
id|port
)paren
(brace
macro_line|#if XSWITCH_CENSUS_PORT_MIN
r_if
c_cond
(paren
id|port
OL
id|XSWITCH_CENSUS_PORT_MIN
)paren
r_return
id|GRAPH_VERTEX_NONE
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|port
OG
id|XSWITCH_CENSUS_PORT_MAX
)paren
r_return
id|GRAPH_VERTEX_NONE
suffix:semicolon
r_return
id|xswitch_info-&gt;master_vhdl
(braket
id|port
op_minus
id|XSWITCH_CENSUS_PORT_MIN
)braket
suffix:semicolon
)brace
r_void
DECL|function|xswitch_info_set
id|xswitch_info_set
c_func
(paren
id|devfs_handle_t
id|xwidget
comma
id|xswitch_info_t
id|xswitch_info
)paren
(brace
id|xswitch_info-&gt;fingerprint
op_assign
id|xswitch_info_fingerprint
suffix:semicolon
id|hwgraph_fastinfo_set
c_func
(paren
id|xwidget
comma
(paren
id|arbitrary_info_t
)paren
id|xswitch_info
)paren
suffix:semicolon
)brace
id|xswitch_info_t
DECL|function|xswitch_info_new
id|xswitch_info_new
c_func
(paren
id|devfs_handle_t
id|xwidget
)paren
(brace
id|xswitch_info_t
id|xswitch_info
suffix:semicolon
id|xswitch_info
op_assign
id|xswitch_info_get
c_func
(paren
id|xwidget
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xswitch_info
op_eq
l_int|NULL
)paren
(brace
r_int
id|port
suffix:semicolon
id|NEW
c_func
(paren
id|xswitch_info
)paren
suffix:semicolon
id|xswitch_info-&gt;census
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
id|XSWITCH_CENSUS_PORT_MIN
suffix:semicolon
id|port
op_le
id|XSWITCH_CENSUS_PORT_MAX
suffix:semicolon
id|port
op_increment
)paren
(brace
id|xswitch_info_vhdl_set
c_func
(paren
id|xswitch_info
comma
id|port
comma
id|GRAPH_VERTEX_NONE
)paren
suffix:semicolon
id|xswitch_info_master_assignment_set
c_func
(paren
id|xswitch_info
comma
id|port
comma
id|GRAPH_VERTEX_NONE
)paren
suffix:semicolon
)brace
id|xswitch_info_set
c_func
(paren
id|xwidget
comma
id|xswitch_info
)paren
suffix:semicolon
)brace
r_return
id|xswitch_info
suffix:semicolon
)brace
r_void
DECL|function|xswitch_provider_register
id|xswitch_provider_register
c_func
(paren
id|devfs_handle_t
id|busv
comma
id|xswitch_provider_t
op_star
id|xswitch_fns
)paren
(brace
id|xswitch_info_t
id|xswitch_info
op_assign
id|xswitch_info_get
c_func
(paren
id|busv
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|xswitch_info
)paren
suffix:semicolon
id|xswitch_info-&gt;xswitch_fns
op_assign
id|xswitch_fns
suffix:semicolon
)brace
r_void
DECL|function|xswitch_info_link_is_ok
id|xswitch_info_link_is_ok
c_func
(paren
id|xswitch_info_t
id|xswitch_info
comma
id|xwidgetnum_t
id|port
)paren
(brace
id|xswitch_info-&gt;census
op_or_assign
id|XSWITCH_CENSUS_BIT
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
r_int
DECL|function|xswitch_info_link_ok
id|xswitch_info_link_ok
c_func
(paren
id|xswitch_info_t
id|xswitch_info
comma
id|xwidgetnum_t
id|port
)paren
(brace
macro_line|#if XSWITCH_CENSUS_PORT_MIN
r_if
c_cond
(paren
id|port
OL
id|XSWITCH_CENSUS_PORT_MIN
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|port
OG
id|XSWITCH_CENSUS_PORT_MAX
)paren
r_return
l_int|0
suffix:semicolon
r_return
(paren
id|xswitch_info-&gt;census
op_amp
id|XSWITCH_CENSUS_BIT
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
r_int
DECL|function|xswitch_reset_link
id|xswitch_reset_link
c_func
(paren
id|devfs_handle_t
id|xconn_vhdl
)paren
(brace
r_return
id|DEV_FUNC
c_func
(paren
id|xconn_vhdl
comma
id|reset_link
)paren
(paren
id|xconn_vhdl
)paren
suffix:semicolon
)brace
multiline_comment|/* Given a vertex handle to the xswitch get its logical&n; * id.&n; */
r_int
DECL|function|xswitch_id_get
id|xswitch_id_get
c_func
(paren
id|devfs_handle_t
id|xconn_vhdl
)paren
(brace
id|arbitrary_info_t
id|xbow_num
suffix:semicolon
id|graph_error_t
id|rv
suffix:semicolon
id|rv
op_assign
id|hwgraph_info_get_LBL
c_func
(paren
id|xconn_vhdl
comma
id|INFO_LBL_XSWITCH_ID
comma
op_amp
id|xbow_num
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|rv
op_eq
id|GRAPH_SUCCESS
)paren
suffix:semicolon
r_return
id|xbow_num
suffix:semicolon
)brace
multiline_comment|/* Given a vertex handle to the xswitch set its logical&n; * id.&n; */
r_void
DECL|function|xswitch_id_set
id|xswitch_id_set
c_func
(paren
id|devfs_handle_t
id|xconn_vhdl
comma
r_int
id|xbow_num
)paren
(brace
id|graph_error_t
id|rv
suffix:semicolon
id|rv
op_assign
id|hwgraph_info_add_LBL
c_func
(paren
id|xconn_vhdl
comma
id|INFO_LBL_XSWITCH_ID
comma
(paren
id|arbitrary_info_t
)paren
id|xbow_num
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|rv
op_eq
id|GRAPH_SUCCESS
)paren
suffix:semicolon
)brace
eof
