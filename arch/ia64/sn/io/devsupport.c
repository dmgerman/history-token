DECL|macro|ilvt_t
mdefine_line|#define ilvt_t int
multiline_comment|/* $Id$&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Copyright (C) 1992 - 1997, 2000 Silicon Graphics, Inc.&n; * Copyright (C) 2000 by Colin Ngam&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;asm/sn/sgi.h&gt;
macro_line|#include &lt;asm/sn/invent.h&gt;
macro_line|#include &lt;asm/sn/hcl.h&gt;
macro_line|#include &lt;asm/sn/iobus.h&gt;
macro_line|#include &lt;asm/sn/iograph.h&gt;
multiline_comment|/* &n; * Interfaces in this file are all platform-independent AND IObus-independent.&n; * Be aware that there may be macro equivalents to each of these hiding in&n; * header files which supercede these functions.&n; */
multiline_comment|/* =====Generic iobus support===== */
multiline_comment|/* String table to hold names of interrupts. */
macro_line|#ifdef notyet
DECL|variable|device_desc_string_table
r_static
r_struct
id|string_table
id|device_desc_string_table
suffix:semicolon
macro_line|#endif
multiline_comment|/* One time initialization for device descriptor support. */
r_static
r_void
DECL|function|device_desc_init
id|device_desc_init
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef notyet
id|string_table_init
c_func
(paren
op_amp
id|device_desc_string_table
)paren
suffix:semicolon
macro_line|#endif
id|FIXME
c_func
(paren
l_string|&quot;device_desc_init&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Drivers use these interfaces to manage device descriptors */
r_static
id|device_desc_t
DECL|function|device_desc_alloc
id|device_desc_alloc
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef notyet
id|device_desc_t
id|device_desc
suffix:semicolon
id|device_desc
op_assign
(paren
id|device_desc_t
)paren
id|kmem_zalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|device_desc_s
)paren
comma
l_int|0
)paren
suffix:semicolon
id|device_desc-&gt;intr_target
op_assign
id|GRAPH_VERTEX_NONE
suffix:semicolon
id|ASSERT
c_func
(paren
id|device_desc-&gt;intr_policy
op_eq
l_int|0
)paren
suffix:semicolon
id|device_desc-&gt;intr_swlevel
op_assign
op_minus
l_int|1
suffix:semicolon
id|ASSERT
c_func
(paren
id|device_desc-&gt;intr_name
op_eq
l_int|NULL
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|device_desc-&gt;flags
op_eq
l_int|0
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
op_logical_neg
(paren
id|device_desc-&gt;flags
op_amp
id|D_IS_ASSOC
)paren
)paren
suffix:semicolon
r_return
id|device_desc
suffix:semicolon
macro_line|#else
id|FIXME
c_func
(paren
l_string|&quot;device_desc_alloc&quot;
)paren
suffix:semicolon
r_return
(paren
id|device_desc_t
)paren
l_int|0
suffix:semicolon
macro_line|#endif
)brace
r_void
DECL|function|device_desc_free
id|device_desc_free
c_func
(paren
id|device_desc_t
id|device_desc
)paren
(brace
macro_line|#ifdef notyet
r_if
c_cond
(paren
op_logical_neg
(paren
id|device_desc-&gt;flags
op_amp
id|D_IS_ASSOC
)paren
)paren
multiline_comment|/* sanity */
id|kfree
c_func
(paren
id|device_desc
)paren
suffix:semicolon
macro_line|#endif
id|FIXME
c_func
(paren
l_string|&quot;device_desc_free&quot;
)paren
suffix:semicolon
)brace
id|device_desc_t
DECL|function|device_desc_dup
id|device_desc_dup
c_func
(paren
id|devfs_handle_t
id|dev
)paren
(brace
macro_line|#ifdef notyet
id|device_desc_t
id|orig_device_desc
comma
id|new_device_desc
suffix:semicolon
id|new_device_desc
op_assign
id|device_desc_alloc
c_func
(paren
)paren
suffix:semicolon
id|orig_device_desc
op_assign
id|device_desc_default_get
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|orig_device_desc
)paren
op_star
id|new_device_desc
op_assign
op_star
id|orig_device_desc
suffix:semicolon
multiline_comment|/* small structure copy */
r_else
(brace
id|device_driver_t
id|driver
suffix:semicolon
id|ilvl_t
id|pri
suffix:semicolon
multiline_comment|/* &n;&t;&t; * Use the driver&squot;s thread priority in &n;&t;&t; * case the device thread priority has not&n;&t;&t; * been given.&n;&t;&t; */
r_if
c_cond
(paren
id|driver
op_assign
id|device_driver_getbydev
c_func
(paren
id|dev
)paren
)paren
(brace
id|pri
op_assign
id|device_driver_thread_pri_get
c_func
(paren
id|driver
)paren
suffix:semicolon
id|device_desc_intr_swlevel_set
c_func
(paren
id|new_device_desc
comma
id|pri
)paren
suffix:semicolon
)brace
)brace
id|new_device_desc-&gt;flags
op_and_assign
op_complement
id|D_IS_ASSOC
suffix:semicolon
r_return
id|new_device_desc
suffix:semicolon
macro_line|#else
id|FIXME
c_func
(paren
l_string|&quot;device_desc_dup&quot;
)paren
suffix:semicolon
r_return
(paren
id|device_desc_t
)paren
l_int|0
suffix:semicolon
macro_line|#endif
)brace
id|device_desc_t
DECL|function|device_desc_default_get
id|device_desc_default_get
c_func
(paren
id|devfs_handle_t
id|dev
)paren
(brace
macro_line|#ifdef notyet
id|graph_error_t
id|rc
suffix:semicolon
id|device_desc_t
id|device_desc
suffix:semicolon
id|rc
op_assign
id|hwgraph_info_get_LBL
c_func
(paren
id|dev
comma
id|INFO_LBL_DEVICE_DESC
comma
(paren
id|arbitrary_info_t
op_star
)paren
op_amp
id|device_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|GRAPH_SUCCESS
)paren
r_return
id|device_desc
suffix:semicolon
r_else
r_return
l_int|NULL
suffix:semicolon
macro_line|#else
id|FIXME
c_func
(paren
l_string|&quot;device_desc_default_get&quot;
)paren
suffix:semicolon
r_return
(paren
id|device_desc_t
)paren
l_int|0
suffix:semicolon
macro_line|#endif
)brace
r_void
DECL|function|device_desc_default_set
id|device_desc_default_set
c_func
(paren
id|devfs_handle_t
id|dev
comma
id|device_desc_t
id|new_device_desc
)paren
(brace
macro_line|#ifdef notyet
id|graph_error_t
id|rc
suffix:semicolon
id|device_desc_t
id|old_device_desc
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|new_device_desc
)paren
(brace
id|new_device_desc-&gt;flags
op_or_assign
id|D_IS_ASSOC
suffix:semicolon
id|rc
op_assign
id|hwgraph_info_add_LBL
c_func
(paren
id|dev
comma
id|INFO_LBL_DEVICE_DESC
comma
(paren
id|arbitrary_info_t
)paren
id|new_device_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|GRAPH_DUP
)paren
(brace
id|rc
op_assign
id|hwgraph_info_replace_LBL
c_func
(paren
id|dev
comma
id|INFO_LBL_DEVICE_DESC
comma
(paren
id|arbitrary_info_t
)paren
id|new_device_desc
comma
(paren
id|arbitrary_info_t
op_star
)paren
op_amp
id|old_device_desc
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|rc
op_eq
id|GRAPH_SUCCESS
)paren
suffix:semicolon
)brace
id|hwgraph_info_export_LBL
c_func
(paren
id|dev
comma
id|INFO_LBL_DEVICE_DESC
comma
r_sizeof
(paren
r_struct
id|device_desc_s
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
id|hwgraph_info_remove_LBL
c_func
(paren
id|dev
comma
id|INFO_LBL_DEVICE_DESC
comma
(paren
id|arbitrary_info_t
op_star
)paren
op_amp
id|old_device_desc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|old_device_desc
)paren
(brace
id|ASSERT
c_func
(paren
id|old_device_desc-&gt;flags
op_amp
id|D_IS_ASSOC
)paren
suffix:semicolon
id|old_device_desc-&gt;flags
op_and_assign
op_complement
id|D_IS_ASSOC
suffix:semicolon
id|device_desc_free
c_func
(paren
id|old_device_desc
)paren
suffix:semicolon
)brace
macro_line|#endif
id|FIXME
c_func
(paren
l_string|&quot;device_desc_default_set&quot;
)paren
suffix:semicolon
)brace
id|devfs_handle_t
DECL|function|device_desc_intr_target_get
id|device_desc_intr_target_get
c_func
(paren
id|device_desc_t
id|device_desc
)paren
(brace
macro_line|#ifdef notyet
r_return
id|device_desc-&gt;intr_target
suffix:semicolon
macro_line|#else
id|FIXME
c_func
(paren
l_string|&quot;device_desc_intr_target_get&quot;
)paren
suffix:semicolon
r_return
(paren
id|devfs_handle_t
)paren
l_int|0
suffix:semicolon
macro_line|#endif
)brace
r_int
DECL|function|device_desc_intr_policy_get
id|device_desc_intr_policy_get
c_func
(paren
id|device_desc_t
id|device_desc
)paren
(brace
macro_line|#ifdef notyet
r_return
id|device_desc-&gt;intr_policy
suffix:semicolon
macro_line|#else
id|FIXME
c_func
(paren
l_string|&quot;device_desc_intr_policy_get&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
id|ilvl_t
DECL|function|device_desc_intr_swlevel_get
id|device_desc_intr_swlevel_get
c_func
(paren
id|device_desc_t
id|device_desc
)paren
(brace
macro_line|#ifdef notyet
r_return
id|device_desc-&gt;intr_swlevel
suffix:semicolon
macro_line|#else
id|FIXME
c_func
(paren
l_string|&quot;device_desc_intr_swlevel_get&quot;
)paren
suffix:semicolon
r_return
(paren
id|ilvl_t
)paren
l_int|0
suffix:semicolon
macro_line|#endif
)brace
r_char
op_star
DECL|function|device_desc_intr_name_get
id|device_desc_intr_name_get
c_func
(paren
id|device_desc_t
id|device_desc
)paren
(brace
macro_line|#ifdef notyet
r_return
id|device_desc-&gt;intr_name
suffix:semicolon
macro_line|#else
id|FIXME
c_func
(paren
l_string|&quot;device_desc_intr_name_get&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
macro_line|#endif
)brace
r_int
DECL|function|device_desc_flags_get
id|device_desc_flags_get
c_func
(paren
id|device_desc_t
id|device_desc
)paren
(brace
macro_line|#ifdef notyet
r_return
id|device_desc-&gt;flags
suffix:semicolon
macro_line|#else
id|FIXME
c_func
(paren
l_string|&quot;device_desc_flags_get&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
r_void
DECL|function|device_desc_intr_target_set
id|device_desc_intr_target_set
c_func
(paren
id|device_desc_t
id|device_desc
comma
id|devfs_handle_t
id|target
)paren
(brace
r_if
c_cond
(paren
id|device_desc
op_ne
(paren
id|device_desc_t
)paren
l_int|0
)paren
id|device_desc-&gt;intr_target
op_assign
id|target
suffix:semicolon
)brace
r_void
DECL|function|device_desc_intr_policy_set
id|device_desc_intr_policy_set
c_func
(paren
id|device_desc_t
id|device_desc
comma
r_int
id|policy
)paren
(brace
r_if
c_cond
(paren
id|device_desc
op_ne
(paren
id|device_desc_t
)paren
l_int|0
)paren
id|device_desc-&gt;intr_policy
op_assign
id|policy
suffix:semicolon
)brace
r_void
DECL|function|device_desc_intr_swlevel_set
id|device_desc_intr_swlevel_set
c_func
(paren
id|device_desc_t
id|device_desc
comma
id|ilvl_t
id|swlevel
)paren
(brace
r_if
c_cond
(paren
id|device_desc
op_ne
(paren
id|device_desc_t
)paren
l_int|0
)paren
id|device_desc-&gt;intr_swlevel
op_assign
id|swlevel
suffix:semicolon
)brace
r_void
DECL|function|device_desc_intr_name_set
id|device_desc_intr_name_set
c_func
(paren
id|device_desc_t
id|device_desc
comma
r_char
op_star
id|name
)paren
(brace
macro_line|#ifdef notyet
r_if
c_cond
(paren
id|device_desc
op_ne
(paren
id|device_desc_t
)paren
l_int|0
)paren
id|device_desc-&gt;intr_name
op_assign
id|string_table_insert
c_func
(paren
op_amp
id|device_desc_string_table
comma
id|name
)paren
suffix:semicolon
macro_line|#else
id|FIXME
c_func
(paren
l_string|&quot;device_desc_intr_name_set&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
r_void
DECL|function|device_desc_flags_set
id|device_desc_flags_set
c_func
(paren
id|device_desc_t
id|device_desc
comma
r_int
id|flags
)paren
(brace
r_if
c_cond
(paren
id|device_desc
op_ne
(paren
id|device_desc_t
)paren
l_int|0
)paren
id|device_desc-&gt;flags
op_assign
id|flags
suffix:semicolon
)brace
multiline_comment|/*============= device admin registry routines ===================== */
multiline_comment|/* Linked list of &lt;admin-name,admin-val&gt; pairs */
DECL|struct|dev_admin_list_s
r_typedef
r_struct
id|dev_admin_list_s
(brace
DECL|member|admin_next
r_struct
id|dev_admin_list_s
op_star
id|admin_next
suffix:semicolon
multiline_comment|/* next entry in the&n;&t;&t;&t;&t;&t;&t;&t; * list &n;&t;&t;&t;&t;&t;&t;&t; */
DECL|member|admin_name
r_char
op_star
id|admin_name
suffix:semicolon
multiline_comment|/* info label */
DECL|member|admin_val
r_char
op_star
id|admin_val
suffix:semicolon
multiline_comment|/* actual info */
DECL|typedef|dev_admin_list_t
)brace
id|dev_admin_list_t
suffix:semicolon
multiline_comment|/* Device/Driver administration registry */
DECL|struct|dev_admin_registry_s
r_typedef
r_struct
id|dev_admin_registry_s
(brace
DECL|member|reg_lock
id|mrlock_t
id|reg_lock
suffix:semicolon
multiline_comment|/* To allow&n;&t;&t;&t;&t;&t;&t;&t; * exclusive&n;&t;&t;&t;&t;&t;&t;&t; * access&n;&t;&t;&t;&t;&t;&t;&t; */
DECL|member|reg_first
id|dev_admin_list_t
op_star
id|reg_first
suffix:semicolon
multiline_comment|/* first entry in &n;&t;&t;&t;&t;&t;&t;&t; * the list&n;&t;&t;&t;&t;&t;&t;&t; */
DECL|member|reg_last
id|dev_admin_list_t
op_star
op_star
id|reg_last
suffix:semicolon
multiline_comment|/* pointer to the&n;&t;&t;&t;&t;&t;&t;&t; * next to last entry&n;&t;&t;&t;&t;&t;&t;&t; * in the last which &n;&t;&t;&t;&t;&t;&t;&t; * is also the place&n;&t;&t;&t;&t;&t;&t;&t; * where the new&n;&t;&t;&t;&t;&t;&t;&t; * entry gets&n;&t;&t;&t;&t;&t;&t;&t; * inserted&n;&t;&t;&t;&t;&t;&t;&t; */
DECL|typedef|dev_admin_registry_t
)brace
id|dev_admin_registry_t
suffix:semicolon
multiline_comment|/*&n;** device_driver_s associates a device driver prefix with device switch entries.&n;*/
DECL|struct|device_driver_s
r_struct
id|device_driver_s
(brace
DECL|member|dd_next
r_struct
id|device_driver_s
op_star
id|dd_next
suffix:semicolon
multiline_comment|/* next element on hash chain */
DECL|member|dd_prev
r_struct
id|device_driver_s
op_star
id|dd_prev
suffix:semicolon
multiline_comment|/* previous element on hash chain */
DECL|member|dd_prefix
r_char
op_star
id|dd_prefix
suffix:semicolon
multiline_comment|/* driver prefix string */
DECL|member|dd_bdevsw
r_struct
id|bdevsw
op_star
id|dd_bdevsw
suffix:semicolon
multiline_comment|/* driver&squot;s bdevsw */
DECL|member|dd_cdevsw
r_struct
id|cdevsw
op_star
id|dd_cdevsw
suffix:semicolon
multiline_comment|/* driver&squot;s cdevsw */
multiline_comment|/* driver administration specific data structures need to&n;&t; * maintain the list of &lt;driver-paramater,value&gt; pairs&n;&t; */
DECL|member|dd_dev_admin_registry
id|dev_admin_registry_t
id|dd_dev_admin_registry
suffix:semicolon
DECL|member|dd_thread_pri
id|ilvl_t
id|dd_thread_pri
suffix:semicolon
multiline_comment|/* default thread priority for&n;&t;&t;&t;&t;&t;&t; *  all this driver&squot;s&n;&t;&t;&t;&t;&t;&t; * threads.&n;&t;&t;&t;&t;&t;&t; */
)brace
suffix:semicolon
DECL|macro|NEW
mdefine_line|#define&t;NEW(_p)&t;&t;(_p = kmalloc(sizeof(*_p), GFP_KERNEL))
DECL|macro|FREE
mdefine_line|#define FREE(_p)&t;(kmem_free(_p))
multiline_comment|/*&n; * helpful lock macros&n; */
DECL|macro|DEV_ADMIN_REGISTRY_INITLOCK
mdefine_line|#define DEV_ADMIN_REGISTRY_INITLOCK(lockp,name)&t;mrinit(lockp,name)
DECL|macro|DEV_ADMIN_REGISTRY_RDLOCK
mdefine_line|#define DEV_ADMIN_REGISTRY_RDLOCK(lockp)&t;mraccess(lockp)&t;       
DECL|macro|DEV_ADMIN_REGISTRY_WRLOCK
mdefine_line|#define DEV_ADMIN_REGISTRY_WRLOCK(lockp)&t;mrupdate(lockp)&t;       
DECL|macro|DEV_ADMIN_REGISTRY_UNLOCK
mdefine_line|#define DEV_ADMIN_REGISTRY_UNLOCK(lockp)&t;mrunlock(lockp)
multiline_comment|/* Initialize the registry &n; */
r_static
r_void
DECL|function|dev_admin_registry_init
id|dev_admin_registry_init
c_func
(paren
id|dev_admin_registry_t
op_star
id|registry
)paren
(brace
macro_line|#ifdef notyet
r_if
c_cond
(paren
id|registry
op_ne
(paren
id|dev_admin_registry_t
op_star
)paren
l_int|0
)paren
id|DEV_ADMIN_REGISTRY_INITLOCK
c_func
(paren
op_amp
id|registry-&gt;reg_lock
comma
l_string|&quot;dev_admin_registry_lock&quot;
)paren
suffix:semicolon
id|registry-&gt;reg_first
op_assign
l_int|NULL
suffix:semicolon
id|registry-&gt;reg_last
op_assign
op_amp
id|registry-&gt;reg_first
suffix:semicolon
)brace
macro_line|#else
id|FIXME
c_func
(paren
l_string|&quot;dev_admin_registry_init&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * add an &lt;name , value &gt; entry to the dev admin registry.&n; * if the name already exists in the registry then change the&n; * value iff the new value differs from the old value.&n; * if the name doesn&squot;t exist a new list entry is created and put&n; * at the end.&n; */
r_static
r_void
DECL|function|dev_admin_registry_add
id|dev_admin_registry_add
c_func
(paren
id|dev_admin_registry_t
op_star
id|registry
comma
r_char
op_star
id|name
comma
r_char
op_star
id|val
)paren
(brace
macro_line|#ifdef notyet
id|dev_admin_list_t
op_star
id|reg_entry
suffix:semicolon
id|dev_admin_list_t
op_star
id|scan
op_assign
l_int|0
suffix:semicolon
id|DEV_ADMIN_REGISTRY_WRLOCK
c_func
(paren
op_amp
id|registry-&gt;reg_lock
)paren
suffix:semicolon
multiline_comment|/* check if the name already exists in the registry */
id|scan
op_assign
id|registry-&gt;reg_first
suffix:semicolon
r_while
c_loop
(paren
id|scan
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|scan-&gt;admin_name
comma
id|name
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* name is there in the registry */
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|scan-&gt;admin_val
comma
id|val
)paren
)paren
(brace
multiline_comment|/* old value != new value &n;&t;&t;&t;&t; * reallocate  memory and copy the new value&n;&t;&t;&t;&t; */
id|FREE
c_func
(paren
id|scan-&gt;admin_val
)paren
suffix:semicolon
id|scan-&gt;admin_val
op_assign
(paren
r_char
op_star
)paren
id|kern_calloc
c_func
(paren
l_int|1
comma
id|strlen
c_func
(paren
id|val
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|scan-&gt;admin_val
comma
id|val
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_goto
id|out
suffix:semicolon
multiline_comment|/* old value == new value */
)brace
id|scan
op_assign
id|scan-&gt;admin_next
suffix:semicolon
)brace
multiline_comment|/* name is not there in the registry.&n;&t; * allocate memory for the new registry entry &n;&t; */
id|NEW
c_func
(paren
id|reg_entry
)paren
suffix:semicolon
id|reg_entry-&gt;admin_next
op_assign
l_int|0
suffix:semicolon
id|reg_entry-&gt;admin_name
op_assign
(paren
r_char
op_star
)paren
id|kern_calloc
c_func
(paren
l_int|1
comma
id|strlen
c_func
(paren
id|name
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|reg_entry-&gt;admin_name
comma
id|name
)paren
suffix:semicolon
id|reg_entry-&gt;admin_val
op_assign
(paren
r_char
op_star
)paren
id|kern_calloc
c_func
(paren
l_int|1
comma
id|strlen
c_func
(paren
id|val
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|reg_entry-&gt;admin_val
comma
id|val
)paren
suffix:semicolon
multiline_comment|/* add the entry at the end of the registry */
op_star
(paren
id|registry-&gt;reg_last
)paren
op_assign
id|reg_entry
suffix:semicolon
id|registry-&gt;reg_last
op_assign
op_amp
id|reg_entry-&gt;admin_next
suffix:semicolon
id|out
suffix:colon
id|DEV_ADMIN_REGISTRY_UNLOCK
c_func
(paren
op_amp
id|registry-&gt;reg_lock
)paren
suffix:semicolon
macro_line|#endif
id|FIXME
c_func
(paren
l_string|&quot;dev_admin_registry_add&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * check if there is an info corr. to a particular&n; * name starting from the cursor position in the &n; * registry&n; */
r_static
r_char
op_star
DECL|function|dev_admin_registry_find
id|dev_admin_registry_find
c_func
(paren
id|dev_admin_registry_t
op_star
id|registry
comma
r_char
op_star
id|name
)paren
(brace
macro_line|#ifdef notyet
id|dev_admin_list_t
op_star
id|scan
op_assign
l_int|0
suffix:semicolon
id|DEV_ADMIN_REGISTRY_RDLOCK
c_func
(paren
op_amp
id|registry-&gt;reg_lock
)paren
suffix:semicolon
id|scan
op_assign
id|registry-&gt;reg_first
suffix:semicolon
r_while
c_loop
(paren
id|scan
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|scan-&gt;admin_name
comma
id|name
)paren
op_eq
l_int|0
)paren
(brace
id|DEV_ADMIN_REGISTRY_UNLOCK
c_func
(paren
op_amp
id|registry-&gt;reg_lock
)paren
suffix:semicolon
r_return
id|scan-&gt;admin_val
suffix:semicolon
)brace
id|scan
op_assign
id|scan-&gt;admin_next
suffix:semicolon
)brace
id|DEV_ADMIN_REGISTRY_UNLOCK
c_func
(paren
op_amp
id|registry-&gt;reg_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#else
id|FIXME
c_func
(paren
l_string|&quot;dev_admin_registry_find&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*============= MAIN DEVICE/ DRIVER ADMINISTRATION INTERFACE================ */
multiline_comment|/*&n; * return any labelled info associated with a device.&n; * called by any kernel code including device drivers.&n; */
r_char
op_star
DECL|function|device_admin_info_get
id|device_admin_info_get
c_func
(paren
id|devfs_handle_t
id|dev_vhdl
comma
r_char
op_star
id|info_lbl
)paren
(brace
macro_line|#ifdef notyet
r_char
op_star
id|info
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* return value need not be GRAPH_SUCCESS as the labelled&n;&t; * info may not be present&n;&t; */
(paren
r_void
)paren
id|hwgraph_info_get_LBL
c_func
(paren
id|dev_vhdl
comma
id|info_lbl
comma
(paren
id|arbitrary_info_t
op_star
)paren
op_amp
id|info
)paren
suffix:semicolon
r_return
id|info
suffix:semicolon
macro_line|#else
id|FIXME
c_func
(paren
l_string|&quot;device_admin_info_get&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * set labelled info associated with a device.&n; * called by hwgraph infrastructure . may also be called&n; * by device drivers etc.&n; */
r_int
DECL|function|device_admin_info_set
id|device_admin_info_set
c_func
(paren
id|devfs_handle_t
id|dev_vhdl
comma
r_char
op_star
id|dev_info_lbl
comma
r_char
op_star
id|dev_info_val
)paren
(brace
macro_line|#ifdef notyet
id|graph_error_t
id|rv
suffix:semicolon
id|arbitrary_info_t
id|old_info
suffix:semicolon
multiline_comment|/* Handle the labelled info&n;&t; *&t;&t;intr_target&n;&t; *&t;&t;sw_level &n;&t; * in a special way. These are part of device_desc_t&n;&t; * Right now this is the only case where we have &n;&t; * a set of related device_admin attributes which &n;&t; * are grouped together.&n;&t; * In case there is a need for another set we need to&n;&t; * take a more generic approach to solving this.&n;&t; * Basically a registry should be implemented. This&n;&t; * registry is initialized with the callbacks for the&n;&t; * attributes which need to handled in a special way&n;&t; * For example:&n;&t; * Consider&n;&t; * &t;&t;device_desc&n;&t; *&t;&t;&t;intr_target&n;&t; *&t;&t;&t;intr_swlevel&n;&t; * register &quot;do_intr_target&quot; for intr_target&n;&t; * register &quot;do_intr_swlevel&quot; for intr_swlevel.&n;&t; * When the device_admin interface layer gets an &lt;attr,val&gt; pair&n;&t; * it looks in the registry to see if there is a function registered to&n;&t; * handle &quot;attr. If not follow the default path of setting the &lt;attr,val&gt;&n;&t; * as labelled information hanging off the vertex.&n;&t; * In the above example:&n;&t; * &quot;do_intr_target&quot; does what is being done below for the ADMIN_LBL_INTR_TARGET&n;&t; * case&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|dev_info_lbl
comma
id|ADMIN_LBL_INTR_TARGET
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|dev_info_lbl
comma
id|ADMIN_LBL_INTR_SWLEVEL
)paren
)paren
(brace
id|device_desc_t
id|device_desc
suffix:semicolon
multiline_comment|/* Check if there is a default device descriptor&n;&t;&t; * information for this vertex. If not dup one .&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|device_desc
op_assign
id|device_desc_default_get
c_func
(paren
id|dev_vhdl
)paren
)paren
)paren
(brace
id|device_desc
op_assign
id|device_desc_dup
c_func
(paren
id|dev_vhdl
)paren
suffix:semicolon
id|device_desc_default_set
c_func
(paren
id|dev_vhdl
comma
id|device_desc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|dev_info_lbl
comma
id|ADMIN_LBL_INTR_TARGET
)paren
)paren
(brace
multiline_comment|/* Check if a target cpu has been specified&n;&t;&t;&t; * for this device by a device administration&n;&t;&t;&t; * directive&n;&t;&t;&t; */
macro_line|#ifdef DEBUG&t;
id|printf
c_func
(paren
id|ADMIN_LBL_INTR_TARGET
l_string|&quot; dev = 0x%x &quot;
l_string|&quot;dev_admin_info = %s&quot;
l_string|&quot; target = 0x%x&bslash;n&quot;
comma
id|dev_vhdl
comma
id|dev_info_lbl
comma
id|hwgraph_path_to_vertex
c_func
(paren
id|dev_info_val
)paren
)paren
suffix:semicolon
macro_line|#endif&t;
id|device_desc-&gt;intr_target
op_assign
id|hwgraph_path_to_vertex
c_func
(paren
id|dev_info_val
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|dev_info_lbl
comma
id|ADMIN_LBL_INTR_SWLEVEL
)paren
)paren
(brace
multiline_comment|/* Check if the ithread priority level  has been &n;&t;&t;&t; * specified for this device by a device administration&n;&t;&t;&t; * directive&n;&t;&t;&t; */
macro_line|#ifdef DEBUG&t;
id|printf
c_func
(paren
id|ADMIN_LBL_INTR_SWLEVEL
l_string|&quot; dev = 0x%x &quot;
l_string|&quot;dev_admin_info = %s&quot;
l_string|&quot; sw level = 0x%x&bslash;n&quot;
comma
id|dev_vhdl
comma
id|dev_info_lbl
comma
id|atoi
c_func
(paren
id|dev_info_val
)paren
)paren
suffix:semicolon
macro_line|#endif&t;
id|device_desc-&gt;intr_swlevel
op_assign
id|atoi
c_func
(paren
id|dev_info_val
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev_info_val
)paren
id|rv
op_assign
id|hwgraph_info_remove_LBL
c_func
(paren
id|dev_vhdl
comma
id|dev_info_lbl
comma
op_amp
id|old_info
)paren
suffix:semicolon
r_else
(brace
id|rv
op_assign
id|hwgraph_info_add_LBL
c_func
(paren
id|dev_vhdl
comma
id|dev_info_lbl
comma
(paren
id|arbitrary_info_t
)paren
id|dev_info_val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
op_eq
id|GRAPH_DUP
)paren
(brace
id|rv
op_assign
id|hwgraph_info_replace_LBL
c_func
(paren
id|dev_vhdl
comma
id|dev_info_lbl
comma
(paren
id|arbitrary_info_t
)paren
id|dev_info_val
comma
op_amp
id|old_info
)paren
suffix:semicolon
)brace
)brace
id|ASSERT
c_func
(paren
id|rv
op_eq
id|GRAPH_SUCCESS
)paren
suffix:semicolon
macro_line|#endif
id|FIXME
c_func
(paren
l_string|&quot;device_admin_info_set&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * return labelled info associated with a device driver&n; * called by kernel code including device drivers&n; */
r_char
op_star
DECL|function|device_driver_admin_info_get
id|device_driver_admin_info_get
c_func
(paren
r_char
op_star
id|driver_prefix
comma
r_char
op_star
id|driver_info_lbl
)paren
(brace
macro_line|#ifdef notyet
id|device_driver_t
id|driver
suffix:semicolon
id|driver
op_assign
id|device_driver_get
c_func
(paren
id|driver_prefix
)paren
suffix:semicolon
r_return
(paren
id|dev_admin_registry_find
c_func
(paren
op_amp
id|driver-&gt;dd_dev_admin_registry
comma
id|driver_info_lbl
)paren
)paren
suffix:semicolon
macro_line|#else
id|FIXME
c_func
(paren
l_string|&quot;device_driver_admin_info_get&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * set labelled info associated with a device driver.&n; * called by hwgraph infrastructure . may also be called&n; * from drivers etc.&n; */
r_int
DECL|function|device_driver_admin_info_set
id|device_driver_admin_info_set
c_func
(paren
r_char
op_star
id|driver_prefix
comma
r_char
op_star
id|driver_info_lbl
comma
r_char
op_star
id|driver_info_val
)paren
(brace
macro_line|#ifdef notyet
id|device_driver_t
id|driver
suffix:semicolon
id|driver
op_assign
id|device_driver_get
c_func
(paren
id|driver_prefix
)paren
suffix:semicolon
id|dev_admin_registry_add
c_func
(paren
op_amp
id|driver-&gt;dd_dev_admin_registry
comma
id|driver_info_lbl
comma
id|driver_info_val
)paren
suffix:semicolon
macro_line|#endif
id|FIXME
c_func
(paren
l_string|&quot;device_driver_admin_info_set&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*================== device / driver  admin support routines================*/
multiline_comment|/* static tables created by lboot */
r_extern
id|dev_admin_info_t
id|dev_admin_table
(braket
)braket
suffix:semicolon
r_extern
id|dev_admin_info_t
id|drv_admin_table
(braket
)braket
suffix:semicolon
r_extern
r_int
id|dev_admin_table_size
suffix:semicolon
r_extern
r_int
id|drv_admin_table_size
suffix:semicolon
multiline_comment|/* Extend the device admin table to allow the kernel startup code to &n; * provide some device specific administrative hints&n; */
DECL|macro|ADMIN_TABLE_CHUNK
mdefine_line|#define ADMIN_TABLE_CHUNK&t;100
DECL|variable|extended_dev_admin_table
r_static
id|dev_admin_info_t
id|extended_dev_admin_table
(braket
id|ADMIN_TABLE_CHUNK
)braket
suffix:semicolon
DECL|variable|extended_dev_admin_table_size
r_static
r_int
id|extended_dev_admin_table_size
op_assign
l_int|0
suffix:semicolon
DECL|variable|extended_dev_admin_table_lock
r_static
id|mrlock_t
id|extended_dev_admin_table_lock
suffix:semicolon
multiline_comment|/* Initialize the extended device admin table */
r_void
DECL|function|device_admin_table_init
id|device_admin_table_init
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef notyet
id|extended_dev_admin_table_size
op_assign
l_int|0
suffix:semicolon
id|mrinit
c_func
(paren
op_amp
id|extended_dev_admin_table_lock
comma
l_string|&quot;extended_dev_admin_table_lock&quot;
)paren
suffix:semicolon
macro_line|#endif
id|FIXME
c_func
(paren
l_string|&quot;device_admin_table_init&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Add &lt;device-name , parameter-name , parameter-value&gt; triple to&n; * the extended device administration info table. This is helpful&n; * for kernel startup code to put some hints before the hwgraph&n; * is setup &n; */
r_void
DECL|function|device_admin_table_update
id|device_admin_table_update
c_func
(paren
r_char
op_star
id|name
comma
r_char
op_star
id|label
comma
r_char
op_star
id|value
)paren
(brace
macro_line|#ifdef notyet
id|dev_admin_info_t
op_star
id|p
suffix:semicolon
id|mrupdate
c_func
(paren
op_amp
id|extended_dev_admin_table_lock
)paren
suffix:semicolon
multiline_comment|/* Safety check that we haven&squot;t exceeded array limits */
id|ASSERT
c_func
(paren
id|extended_dev_admin_table_size
OL
id|ADMIN_TABLE_CHUNK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|extended_dev_admin_table_size
op_eq
id|ADMIN_TABLE_CHUNK
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Get the pointer to the entry in the table where we are&n;&t; * going to put the new information &n;&t; */
id|p
op_assign
op_amp
id|extended_dev_admin_table
(braket
id|extended_dev_admin_table_size
op_increment
)braket
suffix:semicolon
multiline_comment|/* Allocate memory for the strings and copy them in */
id|p-&gt;dai_name
op_assign
(paren
r_char
op_star
)paren
id|kern_calloc
c_func
(paren
l_int|1
comma
id|strlen
c_func
(paren
id|name
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|p-&gt;dai_name
comma
id|name
)paren
suffix:semicolon
id|p-&gt;dai_param_name
op_assign
(paren
r_char
op_star
)paren
id|kern_calloc
c_func
(paren
l_int|1
comma
id|strlen
c_func
(paren
id|label
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|p-&gt;dai_param_name
comma
id|label
)paren
suffix:semicolon
id|p-&gt;dai_param_val
op_assign
(paren
r_char
op_star
)paren
id|kern_calloc
c_func
(paren
l_int|1
comma
id|strlen
c_func
(paren
id|value
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|p-&gt;dai_param_val
comma
id|value
)paren
suffix:semicolon
id|out
suffix:colon
id|mrunlock
c_func
(paren
op_amp
id|extended_dev_admin_table_lock
)paren
suffix:semicolon
macro_line|#endif
id|FIXME
c_func
(paren
l_string|&quot;device_admin_table_update&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Extend the device driver  admin table to allow the kernel startup code to &n; * provide some device driver specific administrative hints&n; */
DECL|variable|extended_drv_admin_table
r_static
id|dev_admin_info_t
id|extended_drv_admin_table
(braket
id|ADMIN_TABLE_CHUNK
)braket
suffix:semicolon
DECL|variable|extended_drv_admin_table_size
r_static
r_int
id|extended_drv_admin_table_size
op_assign
l_int|0
suffix:semicolon
DECL|variable|extended_drv_admin_table_lock
id|mrlock_t
id|extended_drv_admin_table_lock
suffix:semicolon
multiline_comment|/* Initialize the extended device driver admin table */
r_void
DECL|function|device_driver_admin_table_init
id|device_driver_admin_table_init
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef notyet
id|extended_drv_admin_table_size
op_assign
l_int|0
suffix:semicolon
id|mrinit
c_func
(paren
op_amp
id|extended_drv_admin_table_lock
comma
l_string|&quot;extended_drv_admin_table_lock&quot;
)paren
suffix:semicolon
macro_line|#endif
id|FIXME
c_func
(paren
l_string|&quot;device_driver_admin_table_init&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Add &lt;device-driver prefix , parameter-name , parameter-value&gt; triple to&n; * the extended device administration info table. This is helpful&n; * for kernel startup code to put some hints before the hwgraph&n; * is setup &n; */
r_void
DECL|function|device_driver_admin_table_update
id|device_driver_admin_table_update
c_func
(paren
r_char
op_star
id|name
comma
r_char
op_star
id|label
comma
r_char
op_star
id|value
)paren
(brace
macro_line|#ifdef notyet
id|dev_admin_info_t
op_star
id|p
suffix:semicolon
id|mrupdate
c_func
(paren
op_amp
id|extended_dev_admin_table_lock
)paren
suffix:semicolon
multiline_comment|/* Safety check that we haven&squot;t exceeded array limits */
id|ASSERT
c_func
(paren
id|extended_drv_admin_table_size
OL
id|ADMIN_TABLE_CHUNK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|extended_drv_admin_table_size
op_eq
id|ADMIN_TABLE_CHUNK
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Get the pointer to the entry in the table where we are&n;&t; * going to put the new information &n;&t; */
id|p
op_assign
op_amp
id|extended_drv_admin_table
(braket
id|extended_drv_admin_table_size
op_increment
)braket
suffix:semicolon
multiline_comment|/* Allocate memory for the strings and copy them in */
id|p-&gt;dai_name
op_assign
(paren
r_char
op_star
)paren
id|kern_calloc
c_func
(paren
l_int|1
comma
id|strlen
c_func
(paren
id|name
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|p-&gt;dai_name
comma
id|name
)paren
suffix:semicolon
id|p-&gt;dai_param_name
op_assign
(paren
r_char
op_star
)paren
id|kern_calloc
c_func
(paren
l_int|1
comma
id|strlen
c_func
(paren
id|label
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|p-&gt;dai_param_name
comma
id|label
)paren
suffix:semicolon
id|p-&gt;dai_param_val
op_assign
(paren
r_char
op_star
)paren
id|kern_calloc
c_func
(paren
l_int|1
comma
id|strlen
c_func
(paren
id|value
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|p-&gt;dai_param_val
comma
id|value
)paren
suffix:semicolon
id|out
suffix:colon
id|mrunlock
c_func
(paren
op_amp
id|extended_drv_admin_table_lock
)paren
suffix:semicolon
macro_line|#endif
id|FIXME
c_func
(paren
l_string|&quot;device_driver_admin_table_update&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * keeps on adding the labelled info for each new (lbl,value) pair&n; * that it finds in the static dev admin table (  created by lboot)&n; * and the extended dev admin table ( created if at all by the kernel startup&n; *  code) corresponding to a device in the hardware graph.&n; */
r_void
DECL|function|device_admin_info_update
id|device_admin_info_update
c_func
(paren
id|devfs_handle_t
id|dev_vhdl
)paren
(brace
macro_line|#ifdef notyet
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|dev_admin_info_t
op_star
id|scan
suffix:semicolon
id|devfs_handle_t
id|scan_vhdl
suffix:semicolon
multiline_comment|/* Check the static device administration info table */
id|scan
op_assign
id|dev_admin_table
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
id|dev_admin_table_size
)paren
(brace
id|scan_vhdl
op_assign
id|hwgraph_path_to_dev
c_func
(paren
id|scan-&gt;dai_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scan_vhdl
op_eq
id|dev_vhdl
)paren
(brace
id|device_admin_info_set
c_func
(paren
id|dev_vhdl
comma
id|scan-&gt;dai_param_name
comma
id|scan-&gt;dai_param_val
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scan_vhdl
op_ne
id|NODEV
)paren
id|hwgraph_vertex_unref
c_func
(paren
id|scan_vhdl
)paren
suffix:semicolon
id|scan
op_increment
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
id|i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Check the extended device administration info table */
id|scan
op_assign
id|extended_dev_admin_table
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
id|extended_dev_admin_table_size
)paren
(brace
id|scan_vhdl
op_assign
id|hwgraph_path_to_dev
c_func
(paren
id|scan-&gt;dai_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scan_vhdl
op_eq
id|dev_vhdl
)paren
(brace
id|device_admin_info_set
c_func
(paren
id|dev_vhdl
comma
id|scan-&gt;dai_param_name
comma
id|scan-&gt;dai_param_val
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scan_vhdl
op_ne
id|NODEV
)paren
id|hwgraph_vertex_unref
c_func
(paren
id|scan_vhdl
)paren
suffix:semicolon
id|scan
op_increment
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
macro_line|#endif
id|FIXME
c_func
(paren
l_string|&quot;device_admin_info_update&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* looks up the static drv admin table ( created by the lboot) and the extended&n; * drv admin table (created if at all by the kernel startup code) &n; * for this driver specific administration info and adds it to the admin info &n; * associated with this device driver&squot;s object&n; */
r_void
DECL|function|device_driver_admin_info_update
id|device_driver_admin_info_update
c_func
(paren
id|device_driver_t
id|driver
)paren
(brace
macro_line|#ifdef notyet
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|dev_admin_info_t
op_star
id|scan
suffix:semicolon
multiline_comment|/* Check the static device driver administration info table */
id|scan
op_assign
id|drv_admin_table
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
id|drv_admin_table_size
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|scan-&gt;dai_name
comma
id|driver-&gt;dd_prefix
)paren
op_eq
l_int|0
)paren
(brace
id|dev_admin_registry_add
c_func
(paren
op_amp
id|driver-&gt;dd_dev_admin_registry
comma
id|scan-&gt;dai_param_name
comma
id|scan-&gt;dai_param_val
)paren
suffix:semicolon
)brace
id|scan
op_increment
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
id|i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Check the extended device driver administration info table */
id|scan
op_assign
id|extended_drv_admin_table
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
id|extended_drv_admin_table_size
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|scan-&gt;dai_name
comma
id|driver-&gt;dd_prefix
)paren
op_eq
l_int|0
)paren
(brace
id|dev_admin_registry_add
c_func
(paren
op_amp
id|driver-&gt;dd_dev_admin_registry
comma
id|scan-&gt;dai_param_name
comma
id|scan-&gt;dai_param_val
)paren
suffix:semicolon
)brace
id|scan
op_increment
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
macro_line|#endif
id|FIXME
c_func
(paren
l_string|&quot;device_driver_admin_info_update&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* =====Device Driver Support===== */
multiline_comment|/*&n;** Generic device driver support routines for use by kernel modules that&n;** deal with device drivers (but NOT for use by the drivers themselves).&n;** EVERY registered driver currently in the system -- static or loadable --&n;** has an entry in the device_driver_hash table.  A pointer to such an entry&n;** serves as a generic device driver handle.&n;*/
DECL|macro|DEVICE_DRIVER_HASH_SIZE
mdefine_line|#define DEVICE_DRIVER_HASH_SIZE 32
macro_line|#ifdef notyet
DECL|variable|device_driver_lock
id|lock_t
id|device_driver_lock
(braket
id|DEVICE_DRIVER_HASH_SIZE
)braket
suffix:semicolon
DECL|variable|device_driver_hash
id|device_driver_t
id|device_driver_hash
(braket
id|DEVICE_DRIVER_HASH_SIZE
)braket
suffix:semicolon
DECL|variable|driver_prefix_string_table
r_static
r_struct
id|string_table
id|driver_prefix_string_table
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;** Initialize device driver infrastructure.&n;*/
r_void
DECL|function|device_driver_init
id|device_driver_init
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef notyet
r_int
id|i
suffix:semicolon
r_extern
r_void
id|alenlist_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|hwgraph_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|device_desc_init
c_func
(paren
r_void
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|DEVICE_DRIVER_NONE
op_eq
l_int|NULL
)paren
suffix:semicolon
id|alenlist_init
c_func
(paren
)paren
suffix:semicolon
id|hwgraph_init
c_func
(paren
)paren
suffix:semicolon
id|device_desc_init
c_func
(paren
)paren
suffix:semicolon
id|string_table_init
c_func
(paren
op_amp
id|driver_prefix_string_table
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEVICE_DRIVER_HASH_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|spinlock_init
c_func
(paren
op_amp
id|device_driver_lock
(braket
id|i
)braket
comma
l_string|&quot;devdrv&quot;
)paren
suffix:semicolon
id|device_driver_hash
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Initialize static drivers from master.c table */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|static_devsw_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|device_driver_t
id|driver
suffix:semicolon
id|static_device_driver_desc_t
id|desc
suffix:semicolon
r_int
id|pri
suffix:semicolon
id|desc
op_assign
op_amp
id|static_device_driver_table
(braket
id|i
)braket
suffix:semicolon
id|driver
op_assign
id|device_driver_get
c_func
(paren
id|desc-&gt;sdd_prefix
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|driver
)paren
id|driver
op_assign
id|device_driver_alloc
c_func
(paren
id|desc-&gt;sdd_prefix
)paren
suffix:semicolon
id|pri
op_assign
id|device_driver_sysgen_thread_pri_get
c_func
(paren
id|desc-&gt;sdd_prefix
)paren
suffix:semicolon
id|device_driver_thread_pri_set
c_func
(paren
id|driver
comma
id|pri
)paren
suffix:semicolon
id|device_driver_devsw_put
c_func
(paren
id|driver
comma
id|desc-&gt;sdd_bdevsw
comma
id|desc-&gt;sdd_cdevsw
)paren
suffix:semicolon
)brace
macro_line|#endif
id|FIXME
c_func
(paren
l_string|&quot;device_driver_init&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;** Hash a prefix string into a hash table chain.&n;*/
r_static
r_int
DECL|function|driver_prefix_hash
id|driver_prefix_hash
c_func
(paren
r_char
op_star
id|prefix
)paren
(brace
macro_line|#ifdef notyet
r_int
id|accum
op_assign
l_int|0
suffix:semicolon
r_char
id|nextchar
suffix:semicolon
r_while
c_loop
(paren
id|nextchar
op_assign
op_star
id|prefix
op_increment
)paren
id|accum
op_assign
id|accum
op_xor
id|nextchar
suffix:semicolon
r_return
id|accum
op_mod
id|DEVICE_DRIVER_HASH_SIZE
suffix:semicolon
macro_line|#else
id|FIXME
c_func
(paren
l_string|&quot;driver_prefix_hash&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n;** Allocate a driver handle.&n;** Returns the driver handle, or NULL if the driver prefix &n;** already has a handle.&n;** &n;** Upper layers prevent races among device_driver_alloc,&n;** device_driver_free, and device_driver_get*.&n;*/
id|device_driver_t
DECL|function|device_driver_alloc
id|device_driver_alloc
c_func
(paren
r_char
op_star
id|prefix
)paren
(brace
macro_line|#ifdef notyet
r_int
id|which_hash
suffix:semicolon
id|device_driver_t
id|new_driver
suffix:semicolon
r_int
id|s
suffix:semicolon
id|which_hash
op_assign
id|driver_prefix_hash
c_func
(paren
id|prefix
)paren
suffix:semicolon
id|new_driver
op_assign
id|kern_calloc
c_func
(paren
l_int|1
comma
r_sizeof
(paren
op_star
id|new_driver
)paren
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|new_driver
op_ne
l_int|NULL
)paren
suffix:semicolon
id|new_driver-&gt;dd_prev
op_assign
l_int|NULL
suffix:semicolon
id|new_driver-&gt;dd_prefix
op_assign
id|string_table_insert
c_func
(paren
op_amp
id|driver_prefix_string_table
comma
id|prefix
)paren
suffix:semicolon
id|new_driver-&gt;dd_bdevsw
op_assign
l_int|NULL
suffix:semicolon
id|new_driver-&gt;dd_cdevsw
op_assign
l_int|NULL
suffix:semicolon
id|dev_admin_registry_init
c_func
(paren
op_amp
id|new_driver-&gt;dd_dev_admin_registry
)paren
suffix:semicolon
id|device_driver_admin_info_update
c_func
(paren
id|new_driver
)paren
suffix:semicolon
id|s
op_assign
id|mutex_spinlock
c_func
(paren
op_amp
id|device_driver_lock
(braket
id|which_hash
)braket
)paren
suffix:semicolon
macro_line|#if DEBUG
(brace
id|device_driver_t
id|drvscan
suffix:semicolon
multiline_comment|/* Make sure we haven&squot;t already added a driver with this prefix */
id|drvscan
op_assign
id|device_driver_hash
(braket
id|which_hash
)braket
suffix:semicolon
r_while
c_loop
(paren
id|drvscan
op_logical_and
id|strcmp
c_func
(paren
id|drvscan-&gt;dd_prefix
comma
id|prefix
)paren
)paren
(brace
id|drvscan
op_assign
id|drvscan-&gt;dd_next
suffix:semicolon
)brace
id|ASSERT
c_func
(paren
op_logical_neg
id|drvscan
)paren
suffix:semicolon
)brace
macro_line|#endif /* DEBUG */
multiline_comment|/* Add new_driver to front of hash chain. */
id|new_driver-&gt;dd_next
op_assign
id|device_driver_hash
(braket
id|which_hash
)braket
suffix:semicolon
r_if
c_cond
(paren
id|new_driver-&gt;dd_next
)paren
id|new_driver-&gt;dd_next-&gt;dd_prev
op_assign
id|new_driver
suffix:semicolon
id|device_driver_hash
(braket
id|which_hash
)braket
op_assign
id|new_driver
suffix:semicolon
id|mutex_spinunlock
c_func
(paren
op_amp
id|device_driver_lock
(braket
id|which_hash
)braket
comma
id|s
)paren
suffix:semicolon
r_return
id|new_driver
suffix:semicolon
macro_line|#else
id|FIXME
c_func
(paren
l_string|&quot;device_driver_alloc&quot;
)paren
suffix:semicolon
r_return
(paren
id|device_driver_t
)paren
l_int|0
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n;** Free a driver handle.&n;**&n;** Statically loaded drivers should never device_driver_free.&n;** Dynamically loaded drivers device_driver_free when either an&n;** unloaded driver is unregistered, or when an unregistered driver&n;** is unloaded.&n;*/
r_void
DECL|function|device_driver_free
id|device_driver_free
c_func
(paren
id|device_driver_t
id|driver
)paren
(brace
macro_line|#ifdef notyet
r_int
id|which_hash
suffix:semicolon
r_int
id|s
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|driver
)paren
r_return
suffix:semicolon
id|which_hash
op_assign
id|driver_prefix_hash
c_func
(paren
id|driver-&gt;dd_prefix
)paren
suffix:semicolon
id|s
op_assign
id|mutex_spinlock
c_func
(paren
op_amp
id|device_driver_lock
(braket
id|which_hash
)braket
)paren
suffix:semicolon
macro_line|#if DEBUG
(brace
id|device_driver_t
id|drvscan
suffix:semicolon
multiline_comment|/* Make sure we&squot;re dealing with the right list */
id|drvscan
op_assign
id|device_driver_hash
(braket
id|which_hash
)braket
suffix:semicolon
r_while
c_loop
(paren
id|drvscan
op_logical_and
(paren
id|drvscan
op_ne
id|driver
)paren
)paren
id|drvscan
op_assign
id|drvscan-&gt;dd_next
suffix:semicolon
id|ASSERT
c_func
(paren
id|drvscan
)paren
suffix:semicolon
)brace
macro_line|#endif /* DEBUG */
r_if
c_cond
(paren
id|driver-&gt;dd_next
)paren
id|driver-&gt;dd_next-&gt;dd_prev
op_assign
id|driver-&gt;dd_prev
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;dd_prev
)paren
id|driver-&gt;dd_prev-&gt;dd_next
op_assign
id|driver-&gt;dd_next
suffix:semicolon
r_else
id|device_driver_hash
(braket
id|which_hash
)braket
op_assign
id|driver-&gt;dd_next
suffix:semicolon
id|mutex_spinunlock
c_func
(paren
op_amp
id|device_driver_lock
(braket
id|which_hash
)braket
comma
id|s
)paren
suffix:semicolon
id|driver-&gt;dd_next
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* sanity */
id|driver-&gt;dd_prev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* sanity */
id|driver-&gt;dd_prefix
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* sanity */
r_if
c_cond
(paren
id|driver-&gt;dd_bdevsw
)paren
(brace
id|driver-&gt;dd_bdevsw-&gt;d_driver
op_assign
l_int|NULL
suffix:semicolon
id|driver-&gt;dd_bdevsw
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|driver-&gt;dd_cdevsw
)paren
(brace
r_if
c_cond
(paren
id|driver-&gt;dd_cdevsw-&gt;d_str
)paren
(brace
id|str_free_mux_node
c_func
(paren
id|driver
)paren
suffix:semicolon
)brace
id|driver-&gt;dd_cdevsw-&gt;d_driver
op_assign
l_int|NULL
suffix:semicolon
id|driver-&gt;dd_cdevsw
op_assign
l_int|NULL
suffix:semicolon
)brace
id|kern_free
c_func
(paren
id|driver
)paren
suffix:semicolon
macro_line|#endif
id|FIXME
c_func
(paren
l_string|&quot;device_driver_free&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;** Given a device driver prefix, return a handle to the caller.&n;*/
id|device_driver_t
DECL|function|device_driver_get
id|device_driver_get
c_func
(paren
r_char
op_star
id|prefix
)paren
(brace
macro_line|#ifdef notyet
r_int
id|which_hash
suffix:semicolon
id|device_driver_t
id|drvscan
suffix:semicolon
r_int
id|s
suffix:semicolon
r_if
c_cond
(paren
id|prefix
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|which_hash
op_assign
id|driver_prefix_hash
c_func
(paren
id|prefix
)paren
suffix:semicolon
id|s
op_assign
id|mutex_spinlock
c_func
(paren
op_amp
id|device_driver_lock
(braket
id|which_hash
)braket
)paren
suffix:semicolon
id|drvscan
op_assign
id|device_driver_hash
(braket
id|which_hash
)braket
suffix:semicolon
r_while
c_loop
(paren
id|drvscan
op_logical_and
id|strcmp
c_func
(paren
id|drvscan-&gt;dd_prefix
comma
id|prefix
)paren
)paren
id|drvscan
op_assign
id|drvscan-&gt;dd_next
suffix:semicolon
id|mutex_spinunlock
c_func
(paren
op_amp
id|device_driver_lock
(braket
id|which_hash
)braket
comma
id|s
)paren
suffix:semicolon
r_return
id|drvscan
suffix:semicolon
macro_line|#else
id|FIXME
c_func
(paren
l_string|&quot;device_driver_get&quot;
)paren
suffix:semicolon
r_return
(paren
id|device_driver_t
)paren
l_int|0
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n;** Given a block or char special file devfs_handle_t, find the &n;** device driver that controls it.&n;*/
id|device_driver_t
DECL|function|device_driver_getbydev
id|device_driver_getbydev
c_func
(paren
id|devfs_handle_t
id|device
)paren
(brace
macro_line|#ifdef notyet
r_struct
id|bdevsw
op_star
id|my_bdevsw
suffix:semicolon
r_struct
id|cdevsw
op_star
id|my_cdevsw
suffix:semicolon
id|my_cdevsw
op_assign
id|get_cdevsw
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|my_cdevsw
op_ne
l_int|NULL
)paren
r_return
id|my_cdevsw-&gt;d_driver
suffix:semicolon
id|my_bdevsw
op_assign
id|get_bdevsw
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|my_bdevsw
op_ne
l_int|NULL
)paren
r_return
id|my_bdevsw-&gt;d_driver
suffix:semicolon
macro_line|#endif
id|FIXME
c_func
(paren
l_string|&quot;device_driver_getbydev&quot;
)paren
suffix:semicolon
r_return
(paren
id|device_driver_t
)paren
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;** Associate a driver with bdevsw/cdevsw pointers.&n;**&n;** Statically loaded drivers are permanently and automatically associated&n;** with the proper bdevsw/cdevsw.  Dynamically loaded drivers associate&n;** themselves when the driver is registered, and disassociate when the&n;** driver unregisters.&n;**&n;** Returns 0 on success, -1 on failure (devsw already associated with driver)&n;*/
r_int
DECL|function|device_driver_devsw_put
id|device_driver_devsw_put
c_func
(paren
id|device_driver_t
id|driver
comma
r_struct
id|bdevsw
op_star
id|my_bdevsw
comma
r_struct
id|cdevsw
op_star
id|my_cdevsw
)paren
(brace
macro_line|#ifdef notyet
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|driver
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Trying to re-register data?  */
r_if
c_cond
(paren
(paren
(paren
id|my_bdevsw
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|driver-&gt;dd_bdevsw
op_ne
l_int|NULL
)paren
)paren
op_logical_or
(paren
(paren
id|my_cdevsw
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|driver-&gt;dd_cdevsw
op_ne
l_int|NULL
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|my_bdevsw
op_ne
l_int|NULL
)paren
(brace
id|driver-&gt;dd_bdevsw
op_assign
id|my_bdevsw
suffix:semicolon
id|my_bdevsw-&gt;d_driver
op_assign
id|driver
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|bdevmax
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|driver-&gt;dd_bdevsw-&gt;d_flags
op_eq
id|bdevsw
(braket
id|i
)braket
dot
id|d_flags
)paren
(brace
id|bdevsw
(braket
id|i
)braket
dot
id|d_driver
op_assign
id|driver
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|my_cdevsw
op_ne
l_int|NULL
)paren
(brace
id|driver-&gt;dd_cdevsw
op_assign
id|my_cdevsw
suffix:semicolon
id|my_cdevsw-&gt;d_driver
op_assign
id|driver
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cdevmax
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|driver-&gt;dd_cdevsw-&gt;d_flags
op_eq
id|cdevsw
(braket
id|i
)braket
dot
id|d_flags
)paren
(brace
id|cdevsw
(braket
id|i
)braket
dot
id|d_driver
op_assign
id|driver
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
id|FIXME
c_func
(paren
l_string|&quot;device_driver_devsw_put&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;** Given a driver, return the corresponding bdevsw and cdevsw pointers.&n;*/
r_void
DECL|function|device_driver_devsw_get
id|device_driver_devsw_get
c_func
(paren
id|device_driver_t
id|driver
comma
r_struct
id|bdevsw
op_star
op_star
id|bdevswp
comma
r_struct
id|cdevsw
op_star
op_star
id|cdevswp
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|driver
)paren
(brace
op_star
id|bdevswp
op_assign
l_int|NULL
suffix:semicolon
op_star
id|cdevswp
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
op_star
id|bdevswp
op_assign
id|driver-&gt;dd_bdevsw
suffix:semicolon
op_star
id|cdevswp
op_assign
id|driver-&gt;dd_cdevsw
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * device_driver_thread_pri_set&n; *&t;Given a driver try to set its thread priority.&n; *&t;Returns 0 on success , -1 on failure.&n; */
r_int
DECL|function|device_driver_thread_pri_set
id|device_driver_thread_pri_set
c_func
(paren
id|device_driver_t
id|driver
comma
id|ilvl_t
id|pri
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|driver
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|driver-&gt;dd_thread_pri
op_assign
id|pri
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * device_driver_thread_pri_get&n; * &t;Given a driver return the driver thread priority.&n; * &t;If the driver is NULL return invalid driver thread&n; * &t;priority.&n; */
id|ilvl_t
DECL|function|device_driver_thread_pri_get
id|device_driver_thread_pri_get
c_func
(paren
id|device_driver_t
id|driver
)paren
(brace
r_if
c_cond
(paren
id|driver
)paren
r_return
id|driver-&gt;dd_thread_pri
suffix:semicolon
r_else
r_return
id|DRIVER_THREAD_PRI_INVALID
suffix:semicolon
)brace
multiline_comment|/*&n;** Given a device driver, return it&squot;s handle (prefix).&n;*/
r_void
DECL|function|device_driver_name_get
id|device_driver_name_get
c_func
(paren
id|device_driver_t
id|driver
comma
r_char
op_star
id|buffer
comma
r_int
id|length
)paren
(brace
r_if
c_cond
(paren
id|driver
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|strncpy
c_func
(paren
id|buffer
comma
id|driver-&gt;dd_prefix
comma
id|length
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;** Associate a pointer-sized piece of information with a device.&n;*/
r_void
DECL|function|device_info_set
id|device_info_set
c_func
(paren
id|devfs_handle_t
id|device
comma
r_void
op_star
id|info
)paren
(brace
macro_line|#ifdef notyet
id|hwgraph_fastinfo_set
c_func
(paren
id|device
comma
(paren
id|arbitrary_info_t
)paren
id|info
)paren
suffix:semicolon
macro_line|#endif
id|FIXME
c_func
(paren
l_string|&quot;device_info_set&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;** Retrieve a pointer-sized piece of information associated with a device.&n;*/
r_void
op_star
DECL|function|device_info_get
id|device_info_get
c_func
(paren
id|devfs_handle_t
id|device
)paren
(brace
macro_line|#ifdef notyet
r_return
(paren
r_void
op_star
)paren
id|hwgraph_fastinfo_get
c_func
(paren
id|device
)paren
suffix:semicolon
macro_line|#else
id|FIXME
c_func
(paren
l_string|&quot;device_info_get&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * Find the thread priority for a device, from the various&n; * sysgen files.&n; */
r_int
DECL|function|device_driver_sysgen_thread_pri_get
id|device_driver_sysgen_thread_pri_get
c_func
(paren
r_char
op_star
id|dev_prefix
)paren
(brace
macro_line|#ifdef notyet
r_int
id|pri
suffix:semicolon
r_char
op_star
id|pri_s
suffix:semicolon
r_char
op_star
r_class
suffix:semicolon
r_extern
id|default_intr_pri
suffix:semicolon
r_extern
id|disk_intr_pri
suffix:semicolon
r_extern
id|serial_intr_pri
suffix:semicolon
r_extern
id|parallel_intr_pri
suffix:semicolon
r_extern
id|tape_intr_pri
suffix:semicolon
r_extern
id|graphics_intr_pri
suffix:semicolon
r_extern
id|network_intr_pri
suffix:semicolon
r_extern
id|scsi_intr_pri
suffix:semicolon
r_extern
id|audio_intr_pri
suffix:semicolon
r_extern
id|video_intr_pri
suffix:semicolon
r_extern
id|external_intr_pri
suffix:semicolon
r_extern
id|tserialio_intr_pri
suffix:semicolon
multiline_comment|/* Check if there is a thread priority specified for&n;&t; * this driver&squot;s thread thru admin hints. If so &n;&t; * use that value. Otherwise set it to its default&n;&t; * class value, otherwise set it to the default&n;&t; * value.&n;&t; */
r_if
c_cond
(paren
id|pri_s
op_assign
id|device_driver_admin_info_get
c_func
(paren
id|dev_prefix
comma
id|ADMIN_LBL_THREAD_PRI
)paren
)paren
(brace
id|pri
op_assign
id|atoi
c_func
(paren
id|pri_s
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
r_class
op_assign
id|device_driver_admin_info_get
c_func
(paren
id|dev_prefix
comma
id|ADMIN_LBL_THREAD_CLASS
)paren
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
r_class
comma
l_string|&quot;disk&quot;
)paren
op_eq
l_int|0
)paren
id|pri
op_assign
id|disk_intr_pri
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
r_class
comma
l_string|&quot;serial&quot;
)paren
op_eq
l_int|0
)paren
id|pri
op_assign
id|serial_intr_pri
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
r_class
comma
l_string|&quot;parallel&quot;
)paren
op_eq
l_int|0
)paren
id|pri
op_assign
id|parallel_intr_pri
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
r_class
comma
l_string|&quot;tape&quot;
)paren
op_eq
l_int|0
)paren
id|pri
op_assign
id|tape_intr_pri
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
r_class
comma
l_string|&quot;graphics&quot;
)paren
op_eq
l_int|0
)paren
id|pri
op_assign
id|graphics_intr_pri
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
r_class
comma
l_string|&quot;network&quot;
)paren
op_eq
l_int|0
)paren
id|pri
op_assign
id|network_intr_pri
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
r_class
comma
l_string|&quot;scsi&quot;
)paren
op_eq
l_int|0
)paren
id|pri
op_assign
id|scsi_intr_pri
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
r_class
comma
l_string|&quot;audio&quot;
)paren
op_eq
l_int|0
)paren
id|pri
op_assign
id|audio_intr_pri
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
r_class
comma
l_string|&quot;video&quot;
)paren
op_eq
l_int|0
)paren
id|pri
op_assign
id|video_intr_pri
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
r_class
comma
l_string|&quot;external&quot;
)paren
op_eq
l_int|0
)paren
id|pri
op_assign
id|external_intr_pri
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
r_class
comma
l_string|&quot;tserialio&quot;
)paren
op_eq
l_int|0
)paren
id|pri
op_assign
id|tserialio_intr_pri
suffix:semicolon
r_else
id|pri
op_assign
id|default_intr_pri
suffix:semicolon
)brace
r_else
id|pri
op_assign
id|default_intr_pri
suffix:semicolon
r_if
c_cond
(paren
id|pri
OG
l_int|255
)paren
id|pri
op_assign
l_int|255
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pri
OL
l_int|0
)paren
id|pri
op_assign
l_int|0
suffix:semicolon
r_return
id|pri
suffix:semicolon
macro_line|#else
id|FIXME
c_func
(paren
l_string|&quot;device_driver_sysgen_thread_pri_get&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
macro_line|#endif
)brace
eof
