multiline_comment|/*&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Copyright (C) 2001 Silicon Graphics, Inc.&n; * Copyright (C) 2001 by Ralf Baechle&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/efi.h&gt;
macro_line|#include &lt;asm/sn/klclock.h&gt;
multiline_comment|/*&n; * No locking necessary when this is called from efirtc which protects us&n; * from racing by efi_rtc_lock.&n; */
DECL|macro|__swizzle
mdefine_line|#define __swizzle(addr) ((u8 *)((unsigned long)(addr) ^ 3))
DECL|macro|read_io_port
mdefine_line|#define read_io_port(addr) (*(volatile u8 *) __swizzle(addr))
DECL|macro|write_io_port
mdefine_line|#define write_io_port(addr, data) (*(volatile u8 *) __swizzle(addr) = (data))
DECL|macro|TOD_SGS_M48T35
mdefine_line|#define TOD_SGS_M48T35&t;&t;1
DECL|macro|TOD_DALLAS_DS1386
mdefine_line|#define TOD_DALLAS_DS1386&t;2
DECL|variable|nvram_base
r_static
r_int
r_int
id|nvram_base
op_assign
l_int|0
suffix:semicolon
DECL|variable|tod_chip_type
r_static
r_int
id|tod_chip_type
suffix:semicolon
r_static
r_int
DECL|function|get_tod_chip_type
id|get_tod_chip_type
c_func
(paren
r_void
)paren
(brace
r_int
r_char
id|testval
suffix:semicolon
id|write_io_port
c_func
(paren
id|RTC_DAL_CONTROL_ADDR
comma
id|RTC_DAL_UPDATE_DISABLE
)paren
suffix:semicolon
id|write_io_port
c_func
(paren
id|RTC_DAL_DAY_ADDR
comma
l_int|0xff
)paren
suffix:semicolon
id|write_io_port
c_func
(paren
id|RTC_DAL_CONTROL_ADDR
comma
id|RTC_DAL_UPDATE_ENABLE
)paren
suffix:semicolon
id|testval
op_assign
id|read_io_port
c_func
(paren
id|RTC_DAL_DAY_ADDR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|testval
op_eq
l_int|0xff
)paren
r_return
id|TOD_SGS_M48T35
suffix:semicolon
r_return
id|TOD_DALLAS_DS1386
suffix:semicolon
)brace
id|efi_status_t
DECL|function|ioc3_get_time
id|ioc3_get_time
c_func
(paren
id|efi_time_t
op_star
id|time
comma
id|efi_time_cap_t
op_star
id|caps
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|nvram_base
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;nvram_base is zero&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|EFI_UNSUPPORTED
suffix:semicolon
)brace
id|memset
c_func
(paren
id|time
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|time
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|tod_chip_type
)paren
(brace
r_case
id|TOD_SGS_M48T35
suffix:colon
id|write_io_port
c_func
(paren
id|RTC_SGS_CONTROL_ADDR
comma
id|RTC_SGS_READ_PROTECT
)paren
suffix:semicolon
id|time-&gt;year
op_assign
id|BCD_TO_INT
c_func
(paren
id|read_io_port
c_func
(paren
id|RTC_SGS_YEAR_ADDR
)paren
)paren
op_plus
id|YRREF
suffix:semicolon
id|time-&gt;month
op_assign
id|BCD_TO_INT
c_func
(paren
id|read_io_port
c_func
(paren
id|RTC_SGS_MONTH_ADDR
)paren
)paren
suffix:semicolon
id|time-&gt;day
op_assign
id|BCD_TO_INT
c_func
(paren
id|read_io_port
c_func
(paren
id|RTC_SGS_DATE_ADDR
)paren
)paren
suffix:semicolon
id|time-&gt;hour
op_assign
id|BCD_TO_INT
c_func
(paren
id|read_io_port
c_func
(paren
id|RTC_SGS_HOUR_ADDR
)paren
)paren
suffix:semicolon
id|time-&gt;minute
op_assign
id|BCD_TO_INT
c_func
(paren
id|read_io_port
c_func
(paren
id|RTC_SGS_MIN_ADDR
)paren
)paren
suffix:semicolon
id|time-&gt;second
op_assign
id|BCD_TO_INT
c_func
(paren
id|read_io_port
c_func
(paren
id|RTC_SGS_SEC_ADDR
)paren
)paren
suffix:semicolon
id|time-&gt;nanosecond
op_assign
l_int|0
suffix:semicolon
id|write_io_port
c_func
(paren
id|RTC_SGS_CONTROL_ADDR
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TOD_DALLAS_DS1386
suffix:colon
id|write_io_port
c_func
(paren
id|RTC_DAL_CONTROL_ADDR
comma
id|RTC_DAL_UPDATE_DISABLE
)paren
suffix:semicolon
id|time-&gt;nanosecond
op_assign
l_int|0
suffix:semicolon
id|time-&gt;second
op_assign
id|BCD_TO_INT
c_func
(paren
id|read_io_port
c_func
(paren
id|RTC_DAL_SEC_ADDR
)paren
)paren
suffix:semicolon
id|time-&gt;minute
op_assign
id|BCD_TO_INT
c_func
(paren
id|read_io_port
c_func
(paren
id|RTC_DAL_MIN_ADDR
)paren
)paren
suffix:semicolon
id|time-&gt;hour
op_assign
id|BCD_TO_INT
c_func
(paren
id|read_io_port
c_func
(paren
id|RTC_DAL_HOUR_ADDR
)paren
)paren
suffix:semicolon
id|time-&gt;day
op_assign
id|BCD_TO_INT
c_func
(paren
id|read_io_port
c_func
(paren
id|RTC_DAL_DATE_ADDR
)paren
)paren
suffix:semicolon
id|time-&gt;month
op_assign
id|BCD_TO_INT
c_func
(paren
id|read_io_port
c_func
(paren
id|RTC_DAL_MONTH_ADDR
)paren
)paren
suffix:semicolon
id|time-&gt;year
op_assign
id|BCD_TO_INT
c_func
(paren
id|read_io_port
c_func
(paren
id|RTC_DAL_YEAR_ADDR
)paren
)paren
op_plus
id|YRREF
suffix:semicolon
id|write_io_port
c_func
(paren
id|RTC_DAL_CONTROL_ADDR
comma
id|RTC_DAL_UPDATE_ENABLE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|caps
)paren
(brace
id|caps-&gt;resolution
op_assign
l_int|50000000
suffix:semicolon
multiline_comment|/*  50PPM */
id|caps-&gt;accuracy
op_assign
l_int|1000
suffix:semicolon
multiline_comment|/*  1ms */
id|caps-&gt;sets_to_zero
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|EFI_SUCCESS
suffix:semicolon
)brace
DECL|function|ioc3_set_time
r_static
id|efi_status_t
id|ioc3_set_time
(paren
id|efi_time_t
op_star
id|t
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|nvram_base
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;nvram_base is zero&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|EFI_UNSUPPORTED
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|tod_chip_type
)paren
(brace
r_case
id|TOD_SGS_M48T35
suffix:colon
id|write_io_port
c_func
(paren
id|RTC_SGS_CONTROL_ADDR
comma
id|RTC_SGS_WRITE_ENABLE
)paren
suffix:semicolon
id|write_io_port
c_func
(paren
id|RTC_SGS_YEAR_ADDR
comma
id|INT_TO_BCD
c_func
(paren
(paren
id|t-&gt;year
op_minus
id|YRREF
)paren
)paren
)paren
suffix:semicolon
id|write_io_port
c_func
(paren
id|RTC_SGS_MONTH_ADDR
comma
id|INT_TO_BCD
c_func
(paren
id|t-&gt;month
)paren
)paren
suffix:semicolon
id|write_io_port
c_func
(paren
id|RTC_SGS_DATE_ADDR
comma
id|INT_TO_BCD
c_func
(paren
id|t-&gt;day
)paren
)paren
suffix:semicolon
id|write_io_port
c_func
(paren
id|RTC_SGS_HOUR_ADDR
comma
id|INT_TO_BCD
c_func
(paren
id|t-&gt;hour
)paren
)paren
suffix:semicolon
id|write_io_port
c_func
(paren
id|RTC_SGS_MIN_ADDR
comma
id|INT_TO_BCD
c_func
(paren
id|t-&gt;minute
)paren
)paren
suffix:semicolon
id|write_io_port
c_func
(paren
id|RTC_SGS_SEC_ADDR
comma
id|INT_TO_BCD
c_func
(paren
id|t-&gt;second
)paren
)paren
suffix:semicolon
id|write_io_port
c_func
(paren
id|RTC_SGS_CONTROL_ADDR
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TOD_DALLAS_DS1386
suffix:colon
id|write_io_port
c_func
(paren
id|RTC_DAL_CONTROL_ADDR
comma
id|RTC_DAL_UPDATE_DISABLE
)paren
suffix:semicolon
id|write_io_port
c_func
(paren
id|RTC_DAL_SEC_ADDR
comma
id|INT_TO_BCD
c_func
(paren
id|t-&gt;second
)paren
)paren
suffix:semicolon
id|write_io_port
c_func
(paren
id|RTC_DAL_MIN_ADDR
comma
id|INT_TO_BCD
c_func
(paren
id|t-&gt;minute
)paren
)paren
suffix:semicolon
id|write_io_port
c_func
(paren
id|RTC_DAL_HOUR_ADDR
comma
id|INT_TO_BCD
c_func
(paren
id|t-&gt;hour
)paren
)paren
suffix:semicolon
id|write_io_port
c_func
(paren
id|RTC_DAL_DATE_ADDR
comma
id|INT_TO_BCD
c_func
(paren
id|t-&gt;day
)paren
)paren
suffix:semicolon
id|write_io_port
c_func
(paren
id|RTC_DAL_MONTH_ADDR
comma
id|INT_TO_BCD
c_func
(paren
id|t-&gt;month
)paren
)paren
suffix:semicolon
id|write_io_port
c_func
(paren
id|RTC_DAL_YEAR_ADDR
comma
id|INT_TO_BCD
c_func
(paren
(paren
id|t-&gt;year
op_minus
id|YRREF
)paren
)paren
)paren
suffix:semicolon
id|write_io_port
c_func
(paren
id|RTC_DAL_CONTROL_ADDR
comma
id|RTC_DAL_UPDATE_ENABLE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
id|EFI_SUCCESS
suffix:semicolon
)brace
multiline_comment|/* The following two are not supported atm.  */
r_static
id|efi_status_t
DECL|function|ioc3_get_wakeup_time
id|ioc3_get_wakeup_time
(paren
id|efi_bool_t
op_star
id|enabled
comma
id|efi_bool_t
op_star
id|pending
comma
id|efi_time_t
op_star
id|tm
)paren
(brace
r_return
id|EFI_UNSUPPORTED
suffix:semicolon
)brace
r_static
id|efi_status_t
DECL|function|ioc3_set_wakeup_time
id|ioc3_set_wakeup_time
(paren
id|efi_bool_t
id|enabled
comma
id|efi_time_t
op_star
id|tm
)paren
(brace
r_return
id|EFI_UNSUPPORTED
suffix:semicolon
)brace
multiline_comment|/*&n; * It looks like the master IOC3 is usually on bus 0, device 4.  Hope&n; * that&squot;s right&n; */
DECL|function|efi_ioc3_time_init
r_static
id|__init
r_int
id|efi_ioc3_time_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
r_static
r_struct
id|ioc3
op_star
id|ioc3
suffix:semicolon
id|dev
op_assign
id|pci_find_slot
c_func
(paren
l_int|0
comma
id|PCI_DEVFN
c_func
(paren
l_int|4
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;Couldn&squot;t find master IOC3&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|ioc3
op_assign
id|ioremap
c_func
(paren
id|pci_resource_start
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|dev
comma
l_int|0
)paren
)paren
suffix:semicolon
id|nvram_base
op_assign
(paren
r_int
r_int
)paren
id|ioc3
op_plus
id|IOC3_BYTEBUS_DEV0
suffix:semicolon
id|tod_chip_type
op_assign
id|get_tod_chip_type
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tod_chip_type
op_eq
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;TOD type is SGS M48T35&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|tod_chip_type
op_eq
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;TOD type is Dallas DS1386&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;No or unknown TOD&bslash;n&quot;
)paren
suffix:semicolon
id|efi.get_time
op_assign
id|ioc3_get_time
suffix:semicolon
id|efi.set_time
op_assign
id|ioc3_set_time
suffix:semicolon
id|efi.get_wakeup_time
op_assign
id|ioc3_get_wakeup_time
suffix:semicolon
id|efi.set_wakeup_time
op_assign
id|ioc3_set_wakeup_time
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|efi_ioc3_time_init
id|module_init
c_func
(paren
id|efi_ioc3_time_init
)paren
suffix:semicolon
eof
