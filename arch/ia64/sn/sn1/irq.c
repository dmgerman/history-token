multiline_comment|/*&n; * Platform dependent support for SGI SN1&n; *&n; * Copyright (C) 2000   Silicon Graphics&n; * Copyright (C) 2000   Jack Steiner (steiner@sgi.com)&n; * Copyright (C) 2000   Alan Mayer (ajm@sgi.com)&n; * Copyright (C) 2000   Kanoj Sarcar (kanoj@sgi.com)&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;asm/current.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/sn/sgi.h&gt;
macro_line|#include &lt;asm/sn/iograph.h&gt;
macro_line|#include &lt;asm/sn/invent.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#include &lt;asm/sn/hcl.h&gt;
macro_line|#include &lt;asm/sn/types.h&gt;
macro_line|#include &lt;asm/sn/pci/bridge.h&gt;
macro_line|#include &lt;asm/sn/pci/pciio.h&gt;
macro_line|#include &lt;asm/sn/pci/pciio_private.h&gt;
macro_line|#include &lt;asm/sn/sn_cpuid.h&gt;
macro_line|#include &lt;asm/sn/sn1/bedrock.h&gt;
macro_line|#include &lt;asm/sn/intr.h&gt;
macro_line|#include &lt;asm/sn/addrs.h&gt;
macro_line|#include &lt;asm/sn/sn1/addrs.h&gt;
macro_line|#include &lt;asm/sn/iobus.h&gt;
macro_line|#include &lt;asm/sn/sn1/arch.h&gt;
macro_line|#include &lt;asm/sn/synergy.h&gt;
DECL|macro|IRQ_BIT_OFFSET
mdefine_line|#define IRQ_BIT_OFFSET 64
DECL|function|bit_pos_to_irq
r_int
id|bit_pos_to_irq
c_func
(paren
r_int
id|bit
)paren
(brace
r_if
c_cond
(paren
id|bit
OG
l_int|118
)paren
id|bit
op_assign
l_int|118
suffix:semicolon
r_return
(paren
id|bit
op_plus
id|IRQ_BIT_OFFSET
)paren
suffix:semicolon
)brace
DECL|function|irq_to_bit_pos
r_static
r_inline
r_int
id|irq_to_bit_pos
c_func
(paren
r_int
id|irq
)paren
(brace
r_int
id|bit
op_assign
id|irq
op_minus
id|IRQ_BIT_OFFSET
suffix:semicolon
r_if
c_cond
(paren
id|bit
OG
l_int|63
)paren
id|bit
op_sub_assign
l_int|64
suffix:semicolon
r_return
id|bit
suffix:semicolon
)brace
r_static
r_int
r_int
DECL|function|sn1_startup_irq
id|sn1_startup_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|sn1_shutdown_irq
id|sn1_shutdown_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
)brace
r_static
r_void
DECL|function|sn1_disable_irq
id|sn1_disable_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
)brace
r_static
r_void
DECL|function|sn1_enable_irq
id|sn1_enable_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
)brace
r_static
r_void
DECL|function|sn1_ack_irq
id|sn1_ack_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
)brace
r_static
r_void
DECL|function|sn1_end_irq
id|sn1_end_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
id|bit
suffix:semicolon
id|bit
op_assign
id|irq_to_bit_pos
c_func
(paren
id|irq
)paren
suffix:semicolon
id|LOCAL_HUB_CLR_INTR
c_func
(paren
id|bit
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|sn1_set_affinity_irq
id|sn1_set_affinity_irq
c_func
(paren
r_int
r_int
id|irq
comma
r_int
r_int
id|mask
)paren
(brace
)brace
DECL|variable|irq_type_sn1
r_struct
id|hw_interrupt_type
id|irq_type_sn1
op_assign
(brace
l_string|&quot;sn1_irq&quot;
comma
id|sn1_startup_irq
comma
id|sn1_shutdown_irq
comma
id|sn1_enable_irq
comma
id|sn1_disable_irq
comma
id|sn1_ack_irq
comma
id|sn1_end_irq
comma
id|sn1_set_affinity_irq
)brace
suffix:semicolon
r_void
DECL|function|sn1_irq_init
id|sn1_irq_init
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|NR_IRQS
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|idesc_from_vector
c_func
(paren
id|i
)paren
op_member_access_from_pointer
id|handler
op_eq
op_amp
id|no_irq_type
)paren
(brace
id|idesc_from_vector
c_func
(paren
id|i
)paren
op_member_access_from_pointer
id|handler
op_assign
op_amp
id|irq_type_sn1
suffix:semicolon
)brace
)brace
)brace
macro_line|#if !defined(CONFIG_IA64_SGI_SN1)
r_void
DECL|function|sn1_pci_fixup
id|sn1_pci_fixup
c_func
(paren
r_int
id|arg
)paren
(brace
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_PERCPU_IRQ
r_extern
id|irq_desc_t
id|irq_descX
(braket
id|NR_IRQS
)braket
suffix:semicolon
DECL|variable|irq_desc_ptr
id|irq_desc_t
op_star
id|irq_desc_ptr
(braket
id|NR_CPUS
)braket
op_assign
(brace
id|irq_descX
)brace
suffix:semicolon
multiline_comment|/*&n; * Each slave AP allocates its own irq table.&n; */
DECL|function|cpu_irq_init
r_int
id|__init
id|cpu_irq_init
c_func
(paren
r_void
)paren
(brace
id|irq_desc_ptr
(braket
id|smp_processor_id
c_func
(paren
)paren
)braket
op_assign
(paren
id|irq_desc_t
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|irq_descX
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq_desc_ptr
(braket
id|smp_processor_id
c_func
(paren
)paren
)braket
op_eq
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
id|irq_desc_ptr
(braket
id|smp_processor_id
c_func
(paren
)paren
)braket
comma
id|irq_desc_ptr
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|irq_descX
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This can also allocate the irq tables for the other cpus, specifically&n; * on their nodes.&n; */
DECL|function|master_irq_init
r_int
id|__init
id|master_irq_init
c_func
(paren
r_void
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * The input is an ivt level.&n; */
DECL|function|idesc_from_vector
id|irq_desc_t
op_star
id|idesc_from_vector
c_func
(paren
r_int
r_int
id|ivnum
)paren
(brace
r_return
id|irq_desc_ptr
(braket
id|smp_processor_id
c_func
(paren
)paren
)braket
op_plus
id|ivnum
suffix:semicolon
)brace
multiline_comment|/*&n; * The input is a &quot;soft&quot; level, that we encoded in.&n; */
DECL|function|idesc_from_irq
id|irq_desc_t
op_star
id|idesc_from_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_return
id|irq_desc_ptr
(braket
id|irq
op_rshift
l_int|8
)braket
op_plus
(paren
id|irq
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
DECL|function|ivector_from_irq
r_int
r_int
id|ivector_from_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_return
id|irq
op_amp
l_int|0xff
suffix:semicolon
)brace
multiline_comment|/*&n; * This should return the Linux irq # for the i/p vector on the&n; * i/p cpu. We currently do not track this.&n; */
DECL|function|irq_from_cpuvector
r_int
r_int
id|irq_from_cpuvector
c_func
(paren
r_int
id|cpunum
comma
r_int
r_int
id|vector
)paren
(brace
r_return
(paren
id|vector
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PERCPU_IRQ */
eof
