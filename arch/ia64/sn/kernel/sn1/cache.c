multiline_comment|/*&n; * &n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; * &n; * Copyright (C) 2001-2002 Silicon Graphics, Inc. All rights reserved.&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/pgalloc.h&gt;
macro_line|#include &lt;asm/sn/arch.h&gt;
macro_line|#include &lt;asm/sn/sn_cpuid.h&gt;
macro_line|#include &lt;asm/sn/sn1/synergy.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#ifndef MB
DECL|macro|MB
mdefine_line|#define&t;MB&t;(1024*1024)
macro_line|#endif
multiline_comment|/*&n; * Lock for protecting SYN_TAG_DISABLE_WAY.&n; * Consider making this a per-FSB lock. &n; */
DECL|variable|flush_lock
r_static
id|spinlock_t
id|flush_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/**&n; * sn_flush_all_caches - flush a range of addresses from all caches (incl. L4)&n; * @flush_addr: identity mapped region 7 address to start flushing&n; * @bytes: number of bytes to flush&n; *&n; * Flush a range of addresses from all caches including L4.  All addresses &n; * fully or partially contained within @flush_addr to @flush_addr + @bytes &n; * are flushed from the all caches.&n; */
r_void
DECL|function|sn_flush_all_caches
id|sn_flush_all_caches
c_func
(paren
r_int
id|flush_addr
comma
r_int
id|bytes
)paren
(brace
id|ulong
id|addr
comma
id|baddr
comma
id|eaddr
comma
id|bitbucket
suffix:semicolon
r_int
id|way
comma
id|alias
suffix:semicolon
multiline_comment|/*&n;&t; * Because of the way synergy implements &quot;fc&quot;, this flushes the&n;&t; * data from all caches on all cpus &amp; L4&squot;s on OTHER FSBs. It also&n;&t; * flushes both cpus on the local FSB. It does NOT flush it from &n;&t; * the local FSB.&n;&t; */
id|flush_icache_range
c_func
(paren
id|flush_addr
comma
id|flush_addr
op_plus
id|bytes
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Memory DIMMs are a minimum of 256MB and start on 256MB&n;&t; * boundaries. Convert the start address to an address&n;&t; * that is between +0MB &amp; +128 of the same DIMM. &n;&t; * Then add 8MB to skip the uncached MinState areas if the address&n;&t; * is on the master node.&n;&t; */
r_if
c_cond
(paren
id|bytes
OG
id|SYNERGY_L4_BYTES_PER_WAY
)paren
id|bytes
op_assign
id|SYNERGY_L4_BYTES_PER_WAY
suffix:semicolon
id|baddr
op_assign
id|TO_NODE
c_func
(paren
id|smp_physical_node_id
c_func
(paren
)paren
comma
id|PAGE_OFFSET
op_plus
(paren
id|flush_addr
op_amp
(paren
l_int|128
op_star
id|MB
op_minus
l_int|1
)paren
)paren
op_plus
l_int|8
op_star
id|MB
)paren
suffix:semicolon
id|eaddr
op_assign
(paren
id|baddr
op_plus
id|bytes
op_plus
id|SYNERGY_BLOCK_SIZE
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|SYNERGY_BLOCK_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|baddr
op_assign
id|baddr
op_amp
op_complement
(paren
id|SYNERGY_BLOCK_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Now flush the local synergy.&n;&t; */
id|spin_lock
c_func
(paren
op_amp
id|flush_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|way
op_assign
l_int|0
suffix:semicolon
id|way
OL
id|SYNERGY_L4_WAYS
suffix:semicolon
id|way
op_increment
)paren
(brace
id|WRITE_LOCAL_SYNERGY_REG
c_func
(paren
id|SYN_TAG_DISABLE_WAY
comma
l_int|0xffL
op_xor
(paren
l_int|1L
op_lshift
id|way
)paren
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|alias
op_assign
l_int|0
suffix:semicolon
id|alias
OL
l_int|9
suffix:semicolon
id|alias
op_increment
)paren
r_for
c_loop
(paren
id|addr
op_assign
id|baddr
suffix:semicolon
id|addr
OL
id|eaddr
suffix:semicolon
id|addr
op_add_assign
id|SYNERGY_BLOCK_SIZE
)paren
(brace
id|bitbucket
op_assign
op_star
(paren
r_volatile
id|ulong
op_star
)paren
(paren
id|addr
op_plus
id|alias
op_star
l_int|8
op_star
id|MB
)paren
suffix:semicolon
)brace
id|mb
c_func
(paren
)paren
suffix:semicolon
)brace
id|WRITE_LOCAL_SYNERGY_REG
c_func
(paren
id|SYN_TAG_DISABLE_WAY
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|flush_lock
)paren
suffix:semicolon
)brace
eof
