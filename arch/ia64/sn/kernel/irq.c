multiline_comment|/*&n; * Platform dependent support for SGI SN1&n; *&n; * Copyright (c) 2000-2002 Silicon Graphics, Inc.  All Rights Reserved.&n; * &n; * This program is free software; you can redistribute it and/or modify it &n; * under the terms of version 2 of the GNU General Public License &n; * as published by the Free Software Foundation.&n; * &n; * This program is distributed in the hope that it would be useful, but &n; * WITHOUT ANY WARRANTY; without even the implied warranty of &n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. &n; * &n; * Further, this software is distributed without any warranty that it is &n; * free of the rightful claim of any third person regarding infringement &n; * or the like.  Any license provided herein, whether implied or &n; * otherwise, applies only to this software file.  Patent licenses, if &n; * any, provided herein do not apply to combinations of this program with &n; * other software, or any other product whatsoever.&n; * &n; * You should have received a copy of the GNU General Public &n; * License along with this program; if not, write the Free Software &n; * Foundation, Inc., 59 Temple Place - Suite 330, Boston MA 02111-1307, USA.&n; * &n; * Contact information:  Silicon Graphics, Inc., 1600 Amphitheatre Pkwy, &n; * Mountain View, CA  94043, or:&n; * &n; * http://www.sgi.com &n; * &n; * For further information regarding this notice, see: &n; * &n; * http://oss.sgi.com/projects/GenInfo/NoticeExplan&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/current.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/sn/sgi.h&gt;
macro_line|#include &lt;asm/sn/iograph.h&gt;
macro_line|#include &lt;asm/sn/invent.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#include &lt;asm/sn/hcl.h&gt;
macro_line|#include &lt;asm/sn/types.h&gt;
macro_line|#include &lt;asm/sn/pci/bridge.h&gt;
macro_line|#include &lt;asm/sn/pci/pciio.h&gt;
macro_line|#include &lt;asm/sn/pci/pciio_private.h&gt;
macro_line|#ifdef ajmtestintr
macro_line|#include &lt;asm/sn/pci/pcibr.h&gt;
macro_line|#include &lt;asm/sn/pci/pcibr_private.h&gt;
macro_line|#endif /* ajmtestintr */
macro_line|#include &lt;asm/sn/sn_cpuid.h&gt;
macro_line|#include &lt;asm/sn/io.h&gt;
macro_line|#include &lt;asm/sn/intr.h&gt;
macro_line|#include &lt;asm/sn/addrs.h&gt;
macro_line|#include &lt;asm/sn/driver.h&gt;
macro_line|#include &lt;asm/sn/arch.h&gt;
r_int
id|irq_to_bit_pos
c_func
(paren
r_int
id|irq
)paren
suffix:semicolon
r_static
r_int
r_int
DECL|function|sn1_startup_irq
id|sn1_startup_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|sn1_shutdown_irq
id|sn1_shutdown_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
)brace
r_static
r_void
DECL|function|sn1_disable_irq
id|sn1_disable_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
)brace
r_static
r_void
DECL|function|sn1_enable_irq
id|sn1_enable_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
)brace
r_static
r_void
DECL|function|sn1_ack_irq
id|sn1_ack_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
macro_line|#ifdef CONFIG_IA64_SGI_SN1
r_int
id|bit
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
r_int
r_int
id|intpend_val
suffix:semicolon
r_int
id|subnode
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_IA64_SGI_SN2
r_int
r_int
id|event_occurred
comma
id|mask
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_int
id|nasid
suffix:semicolon
id|irq
op_assign
id|irq
op_amp
l_int|0xff
suffix:semicolon
id|nasid
op_assign
id|smp_physical_node_id
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IA64_SGI_SN1
id|subnode
op_assign
id|cpuid_to_subnode
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_eq
id|SGI_UART_IRQ
)paren
(brace
id|intpend_val
op_assign
id|REMOTE_HUB_PI_L
c_func
(paren
id|nasid
comma
id|subnode
comma
id|PI_INT_PEND0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intpend_val
op_amp
(paren
l_int|1L
op_lshift
id|GFX_INTR_A
)paren
)paren
(brace
id|bit
op_assign
id|GFX_INTR_A
suffix:semicolon
id|REMOTE_HUB_PI_CLR_INTR
c_func
(paren
id|nasid
comma
id|subnode
comma
id|bit
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intpend_val
op_amp
(paren
l_int|1L
op_lshift
id|GFX_INTR_B
)paren
)paren
(brace
id|bit
op_assign
id|GFX_INTR_B
suffix:semicolon
id|REMOTE_HUB_PI_CLR_INTR
c_func
(paren
id|nasid
comma
id|subnode
comma
id|bit
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intpend_val
op_amp
(paren
l_int|1L
op_lshift
id|PG_MIG_INTR
)paren
)paren
(brace
id|bit
op_assign
id|PG_MIG_INTR
suffix:semicolon
id|REMOTE_HUB_PI_CLR_INTR
c_func
(paren
id|nasid
comma
id|subnode
comma
id|bit
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intpend_val
op_amp
(paren
l_int|1L
op_lshift
id|CC_PEND_A
)paren
)paren
(brace
id|bit
op_assign
id|CC_PEND_A
suffix:semicolon
id|REMOTE_HUB_PI_CLR_INTR
c_func
(paren
id|nasid
comma
id|subnode
comma
id|bit
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intpend_val
op_amp
(paren
l_int|1L
op_lshift
id|CC_PEND_B
)paren
)paren
(brace
id|bit
op_assign
id|CC_PEND_B
suffix:semicolon
id|REMOTE_HUB_PI_CLR_INTR
c_func
(paren
id|nasid
comma
id|subnode
comma
id|bit
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
id|bit
op_assign
id|irq_to_bit_pos
c_func
(paren
id|irq
)paren
suffix:semicolon
id|REMOTE_HUB_PI_CLR_INTR
c_func
(paren
id|nasid
comma
id|subnode
comma
id|bit
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_IA64_SGI_SN2
id|event_occurred
op_assign
id|HUB_L
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|GLOBAL_MMR_ADDR
c_func
(paren
id|nasid
comma
id|SH_EVENT_OCCURRED
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|event_occurred
op_amp
id|SH_EVENT_OCCURRED_UART_INT_MASK
)paren
(brace
id|mask
op_or_assign
(paren
l_int|1
op_lshift
id|SH_EVENT_OCCURRED_UART_INT_SHFT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event_occurred
op_amp
id|SH_EVENT_OCCURRED_IPI_INT_MASK
)paren
(brace
id|mask
op_or_assign
(paren
l_int|1
op_lshift
id|SH_EVENT_OCCURRED_IPI_INT_SHFT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event_occurred
op_amp
id|SH_EVENT_OCCURRED_II_INT0_MASK
)paren
(brace
id|mask
op_or_assign
(paren
l_int|1
op_lshift
id|SH_EVENT_OCCURRED_II_INT0_SHFT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event_occurred
op_amp
id|SH_EVENT_OCCURRED_II_INT1_MASK
)paren
(brace
id|mask
op_or_assign
(paren
l_int|1
op_lshift
id|SH_EVENT_OCCURRED_II_INT1_SHFT
)paren
suffix:semicolon
)brace
id|HUB_S
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|GLOBAL_MMR_ADDR
c_func
(paren
id|nasid
comma
id|SH_EVENT_OCCURRED_ALIAS
)paren
comma
id|mask
)paren
suffix:semicolon
macro_line|#endif
)brace
r_static
r_void
DECL|function|sn1_end_irq
id|sn1_end_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
macro_line|#ifdef CONFIG_IA64_SGI_SN1
r_int
r_int
r_int
id|intpend_val
comma
id|mask
op_assign
l_int|0x70L
suffix:semicolon
r_int
id|subnode
suffix:semicolon
macro_line|#endif
r_int
id|nasid
suffix:semicolon
macro_line|#ifdef CONFIG_IA64_SGI_SN2
r_int
r_int
id|event_occurred
suffix:semicolon
macro_line|#endif
id|irq
op_assign
id|irq
op_amp
l_int|0xff
suffix:semicolon
macro_line|#ifdef CONFIG_IA64_SGI_SN1
r_if
c_cond
(paren
id|irq
op_eq
id|SGI_UART_IRQ
)paren
(brace
id|nasid
op_assign
id|smp_physical_node_id
c_func
(paren
)paren
suffix:semicolon
id|subnode
op_assign
id|cpuid_to_subnode
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
)paren
suffix:semicolon
id|intpend_val
op_assign
id|REMOTE_HUB_PI_L
c_func
(paren
id|nasid
comma
id|subnode
comma
id|PI_INT_PEND0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intpend_val
op_amp
id|mask
)paren
(brace
id|platform_send_ipi
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
id|SGI_UART_IRQ
comma
id|IA64_IPI_DM_INT
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_IA64_SGI_SN2
r_if
c_cond
(paren
id|irq
op_eq
id|SGI_UART_VECTOR
)paren
(brace
id|nasid
op_assign
id|smp_physical_node_id
c_func
(paren
)paren
suffix:semicolon
id|event_occurred
op_assign
id|HUB_L
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|GLOBAL_MMR_ADDR
c_func
(paren
id|nasid
comma
id|SH_EVENT_OCCURRED
)paren
)paren
suffix:semicolon
singleline_comment|// If the UART bit is set here, we may have received an interrupt from the
singleline_comment|// UART that the driver missed.  To make sure, we IPI ourselves to force us
singleline_comment|// to look again.
r_if
c_cond
(paren
id|event_occurred
op_amp
id|SH_EVENT_OCCURRED_UART_INT_MASK
)paren
(brace
id|platform_send_ipi
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
id|SGI_UART_VECTOR
comma
id|IA64_IPI_DM_INT
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
)brace
r_static
r_void
DECL|function|sn1_set_affinity_irq
id|sn1_set_affinity_irq
c_func
(paren
r_int
r_int
id|irq
comma
r_int
r_int
id|mask
)paren
(brace
)brace
DECL|variable|irq_type_iosapic_level
r_struct
id|hw_interrupt_type
id|irq_type_iosapic_level
op_assign
(brace
l_string|&quot;SN hub&quot;
comma
id|sn1_startup_irq
comma
id|sn1_shutdown_irq
comma
id|sn1_enable_irq
comma
id|sn1_disable_irq
comma
id|sn1_ack_irq
comma
id|sn1_end_irq
comma
id|sn1_set_affinity_irq
)brace
suffix:semicolon
DECL|macro|irq_type_sn1
mdefine_line|#define irq_type_sn1 irq_type_iosapic_level
DECL|variable|_sn1_irq_desc
r_struct
id|irq_desc
op_star
id|_sn1_irq_desc
(braket
id|NR_CPUS
)braket
suffix:semicolon
r_struct
id|irq_desc
op_star
DECL|function|sn1_irq_desc
id|sn1_irq_desc
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
id|cpu
op_assign
id|irq
op_rshift
l_int|8
suffix:semicolon
id|irq
op_assign
id|irq
op_amp
l_int|0xff
suffix:semicolon
r_return
id|_sn1_irq_desc
(braket
id|cpu
)braket
op_plus
id|irq
suffix:semicolon
)brace
id|u8
DECL|function|sn1_irq_to_vector
id|sn1_irq_to_vector
c_func
(paren
id|u8
id|irq
)paren
(brace
r_return
id|irq
op_amp
l_int|0xff
suffix:semicolon
)brace
r_int
r_int
DECL|function|sn1_local_vector_to_irq
id|sn1_local_vector_to_irq
c_func
(paren
id|u8
id|vector
)paren
(brace
r_return
(paren
(paren
id|smp_processor_id
c_func
(paren
)paren
op_lshift
l_int|8
)paren
op_plus
id|vector
)paren
suffix:semicolon
)brace
r_int
DECL|function|sn1_valid_irq
id|sn1_valid_irq
c_func
(paren
id|u8
id|irq
)paren
(brace
r_return
(paren
(paren
id|irq
op_amp
l_int|0xff
)paren
OL
id|NR_IRQS
)paren
op_logical_and
(paren
(paren
id|irq
op_rshift
l_int|8
)paren
OL
id|NR_CPUS
)paren
suffix:semicolon
)brace
r_void
op_star
id|kmalloc
c_func
(paren
r_int
comma
r_int
)paren
suffix:semicolon
r_void
DECL|function|sn1_irq_init
id|sn1_irq_init
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|irq_desc_t
op_star
id|base_desc
op_assign
id|_irq_desc
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|IA64_FIRST_DEVICE_VECTOR
suffix:semicolon
id|i
OL
id|NR_IRQS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|base_desc
(braket
id|i
)braket
dot
id|handler
op_eq
op_amp
id|no_irq_type
)paren
(brace
id|base_desc
(braket
id|i
)braket
dot
id|handler
op_assign
op_amp
id|irq_type_sn1
suffix:semicolon
)brace
)brace
)brace
r_void
DECL|function|sn1_init_irq_desc
id|sn1_init_irq_desc
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|irq_desc_t
op_star
id|base_desc
op_assign
id|_irq_desc
comma
op_star
id|p
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_CPUS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_assign
id|page_address
c_func
(paren
id|alloc_pages_node
c_func
(paren
id|local_cnodeid
c_func
(paren
)paren
comma
id|GFP_KERNEL
comma
id|get_order
c_func
(paren
r_sizeof
(paren
r_struct
id|irq_desc
)paren
op_star
id|NR_IRQS
)paren
)paren
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|p
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|p
comma
id|base_desc
comma
r_sizeof
(paren
r_struct
id|irq_desc
)paren
op_star
id|NR_IRQS
)paren
suffix:semicolon
id|_sn1_irq_desc
(braket
id|i
)braket
op_assign
id|p
suffix:semicolon
)brace
)brace
macro_line|#if !defined(CONFIG_IA64_SGI_SN)
r_void
DECL|function|sn1_pci_fixup
id|sn1_pci_fixup
c_func
(paren
r_void
)paren
(brace
)brace
macro_line|#endif
r_int
DECL|function|bit_pos_to_irq
id|bit_pos_to_irq
c_func
(paren
r_int
id|bit
)paren
(brace
DECL|macro|BIT_TO_IRQ
mdefine_line|#define BIT_TO_IRQ 64
r_if
c_cond
(paren
id|bit
OG
l_int|118
)paren
id|bit
op_assign
l_int|118
suffix:semicolon
macro_line|#ifdef CONFIG_IA64_SGI_SN1
r_if
c_cond
(paren
id|bit
op_ge
id|GFX_INTR_A
op_logical_and
id|bit
op_le
id|CC_PEND_B
)paren
(brace
r_return
id|SGI_UART_IRQ
suffix:semicolon
)brace
macro_line|#endif
r_return
id|bit
op_plus
id|BIT_TO_IRQ
suffix:semicolon
)brace
r_int
DECL|function|irq_to_bit_pos
id|irq_to_bit_pos
c_func
(paren
r_int
id|irq
)paren
(brace
DECL|macro|IRQ_TO_BIT
mdefine_line|#define IRQ_TO_BIT 64
r_int
id|bit
op_assign
id|irq
op_minus
id|IRQ_TO_BIT
suffix:semicolon
r_return
id|bit
suffix:semicolon
)brace
macro_line|#ifdef ajmtestintr
macro_line|#include &lt;linux/timer.h&gt;
DECL|variable|intr_test_timer
r_struct
id|timer_list
id|intr_test_timer
suffix:semicolon
DECL|variable|intr_test_icount
r_int
id|intr_test_icount
(braket
id|NR_IRQS
)braket
suffix:semicolon
DECL|struct|intr_test_reg_struct
r_struct
id|intr_test_reg_struct
(brace
DECL|member|pcibr_soft
id|pcibr_soft_t
id|pcibr_soft
suffix:semicolon
DECL|member|slot
r_int
id|slot
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|intr_test_registered
r_struct
id|intr_test_reg_struct
id|intr_test_registered
(braket
id|NR_IRQS
)braket
suffix:semicolon
r_void
DECL|function|intr_test_handle_timer
id|intr_test_handle_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_int
id|i
suffix:semicolon
id|bridge_t
op_star
id|bridge
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_IRQS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|intr_test_registered
(braket
id|i
)braket
dot
id|pcibr_soft
)paren
(brace
id|pcibr_soft_t
id|pcibr_soft
op_assign
id|intr_test_registered
(braket
id|i
)braket
dot
id|pcibr_soft
suffix:semicolon
id|xtalk_intr_t
id|intr
op_assign
id|pcibr_soft-&gt;bs_intr
(braket
id|intr_test_registered
(braket
id|i
)braket
dot
id|slot
)braket
dot
id|bsi_xtalk_intr
suffix:semicolon
multiline_comment|/* send interrupt */
id|bridge
op_assign
id|pcibr_soft-&gt;bs_base
suffix:semicolon
id|bridge-&gt;b_force_always
(braket
id|intr_test_registered
(braket
id|i
)braket
dot
id|slot
)braket
dot
id|intr
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|del_timer
c_func
(paren
op_amp
id|intr_test_timer
)paren
suffix:semicolon
id|intr_test_timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|100
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|intr_test_timer
)paren
suffix:semicolon
)brace
r_void
DECL|function|intr_test_set_timer
id|intr_test_set_timer
c_func
(paren
r_void
)paren
(brace
id|intr_test_timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|100
suffix:semicolon
id|intr_test_timer.function
op_assign
id|intr_test_handle_timer
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|intr_test_timer
)paren
suffix:semicolon
)brace
r_void
DECL|function|intr_test_register_irq
id|intr_test_register_irq
c_func
(paren
r_int
id|irq
comma
id|pcibr_soft_t
id|pcibr_soft
comma
r_int
id|slot
)paren
(brace
id|irq
op_assign
id|irq
op_amp
l_int|0xff
suffix:semicolon
id|intr_test_registered
(braket
id|irq
)braket
dot
id|pcibr_soft
op_assign
id|pcibr_soft
suffix:semicolon
id|intr_test_registered
(braket
id|irq
)braket
dot
id|slot
op_assign
id|slot
suffix:semicolon
)brace
r_void
DECL|function|intr_test_handle_intr
id|intr_test_handle_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|junk
comma
r_struct
id|pt_regs
op_star
id|morejunk
)paren
(brace
id|intr_test_icount
(braket
id|irq
)braket
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;RECEIVED %d INTERRUPTS ON IRQ %d&bslash;n&quot;
comma
id|intr_test_icount
(braket
id|irq
)braket
comma
id|irq
)paren
suffix:semicolon
)brace
macro_line|#endif /* ajmtestintr */
eof
