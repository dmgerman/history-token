multiline_comment|/*&n; * Copyright (c) 2004 Hewlett-Packard Development Company, L.P.&n; *   Contributed by David Mosberger-Tang &lt;davidm@hpl.hp.com&gt;&n; *&n; * This is a pseudo I/O MMU which dispatches to the hardware I/O MMU&n; * whenever possible.  We assume that the hardware I/O MMU requires&n; * full 32-bit addressability, as is the case, e.g., for HP zx1-based&n; * systems (there, the I/O MMU window is mapped at 3-4GB).  If a&n; * device doesn&squot;t provide full 32-bit addressability, we fall back on&n; * the sw I/O TLB.  This is good enough to let us support broken&n; * hardware such as soundcards which have a DMA engine that can&n; * address only 28 bits.&n; */
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;asm/machvec.h&gt;
multiline_comment|/* swiotlb declarations &amp; definitions: */
r_extern
r_void
id|swiotlb_init_with_default_size
(paren
r_int
id|size
)paren
suffix:semicolon
r_extern
id|ia64_mv_dma_alloc_coherent
id|swiotlb_alloc_coherent
suffix:semicolon
r_extern
id|ia64_mv_dma_free_coherent
id|swiotlb_free_coherent
suffix:semicolon
r_extern
id|ia64_mv_dma_map_single
id|swiotlb_map_single
suffix:semicolon
r_extern
id|ia64_mv_dma_unmap_single
id|swiotlb_unmap_single
suffix:semicolon
r_extern
id|ia64_mv_dma_map_sg
id|swiotlb_map_sg
suffix:semicolon
r_extern
id|ia64_mv_dma_unmap_sg
id|swiotlb_unmap_sg
suffix:semicolon
r_extern
id|ia64_mv_dma_supported
id|swiotlb_dma_supported
suffix:semicolon
r_extern
id|ia64_mv_dma_mapping_error
id|swiotlb_dma_mapping_error
suffix:semicolon
multiline_comment|/* hwiommu declarations &amp; definitions: */
r_extern
id|ia64_mv_dma_alloc_coherent
id|sba_alloc_coherent
suffix:semicolon
r_extern
id|ia64_mv_dma_free_coherent
id|sba_free_coherent
suffix:semicolon
r_extern
id|ia64_mv_dma_map_single
id|sba_map_single
suffix:semicolon
r_extern
id|ia64_mv_dma_unmap_single
id|sba_unmap_single
suffix:semicolon
r_extern
id|ia64_mv_dma_map_sg
id|sba_map_sg
suffix:semicolon
r_extern
id|ia64_mv_dma_unmap_sg
id|sba_unmap_sg
suffix:semicolon
r_extern
id|ia64_mv_dma_supported
id|sba_dma_supported
suffix:semicolon
r_extern
id|ia64_mv_dma_mapping_error
id|sba_dma_mapping_error
suffix:semicolon
DECL|macro|hwiommu_alloc_coherent
mdefine_line|#define hwiommu_alloc_coherent&t;&t;sba_alloc_coherent
DECL|macro|hwiommu_free_coherent
mdefine_line|#define hwiommu_free_coherent&t;&t;sba_free_coherent
DECL|macro|hwiommu_map_single
mdefine_line|#define hwiommu_map_single&t;&t;sba_map_single
DECL|macro|hwiommu_unmap_single
mdefine_line|#define hwiommu_unmap_single&t;&t;sba_unmap_single
DECL|macro|hwiommu_map_sg
mdefine_line|#define hwiommu_map_sg&t;&t;&t;sba_map_sg
DECL|macro|hwiommu_unmap_sg
mdefine_line|#define hwiommu_unmap_sg&t;&t;sba_unmap_sg
DECL|macro|hwiommu_dma_supported
mdefine_line|#define hwiommu_dma_supported&t;&t;sba_dma_supported
DECL|macro|hwiommu_dma_mapping_error
mdefine_line|#define hwiommu_dma_mapping_error&t;sba_dma_mapping_error
DECL|macro|hwiommu_sync_single_for_cpu
mdefine_line|#define hwiommu_sync_single_for_cpu&t;machvec_dma_sync_single
DECL|macro|hwiommu_sync_sg_for_cpu
mdefine_line|#define hwiommu_sync_sg_for_cpu&t;&t;machvec_dma_sync_sg
DECL|macro|hwiommu_sync_single_for_device
mdefine_line|#define hwiommu_sync_single_for_device&t;machvec_dma_sync_single
DECL|macro|hwiommu_sync_sg_for_device
mdefine_line|#define hwiommu_sync_sg_for_device&t;machvec_dma_sync_sg
multiline_comment|/*&n; * Note: we need to make the determination of whether or not to use&n; * the sw I/O TLB based purely on the device structure.  Anything else&n; * would be unreliable or would be too intrusive.&n; */
r_static
r_inline
r_int
DECL|function|use_swiotlb
id|use_swiotlb
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_return
id|dev
op_logical_and
id|dev-&gt;dma_mask
op_logical_and
op_logical_neg
id|hwiommu_dma_supported
c_func
(paren
id|dev
comma
op_star
id|dev-&gt;dma_mask
)paren
suffix:semicolon
)brace
r_void
DECL|function|hwsw_init
id|hwsw_init
(paren
r_void
)paren
(brace
multiline_comment|/* default to a smallish 2MB sw I/O TLB */
id|swiotlb_init_with_default_size
(paren
l_int|2
op_star
(paren
l_int|1
op_lshift
l_int|20
)paren
)paren
suffix:semicolon
)brace
r_void
op_star
DECL|function|hwsw_alloc_coherent
id|hwsw_alloc_coherent
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|size
comma
id|dma_addr_t
op_star
id|dma_handle
comma
r_int
id|flags
)paren
(brace
r_if
c_cond
(paren
id|use_swiotlb
c_func
(paren
id|dev
)paren
)paren
r_return
id|swiotlb_alloc_coherent
c_func
(paren
id|dev
comma
id|size
comma
id|dma_handle
comma
id|flags
)paren
suffix:semicolon
r_else
r_return
id|hwiommu_alloc_coherent
c_func
(paren
id|dev
comma
id|size
comma
id|dma_handle
comma
id|flags
)paren
suffix:semicolon
)brace
r_void
DECL|function|hwsw_free_coherent
id|hwsw_free_coherent
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|size
comma
r_void
op_star
id|vaddr
comma
id|dma_addr_t
id|dma_handle
)paren
(brace
r_if
c_cond
(paren
id|use_swiotlb
c_func
(paren
id|dev
)paren
)paren
id|swiotlb_free_coherent
c_func
(paren
id|dev
comma
id|size
comma
id|vaddr
comma
id|dma_handle
)paren
suffix:semicolon
r_else
id|hwiommu_free_coherent
c_func
(paren
id|dev
comma
id|size
comma
id|vaddr
comma
id|dma_handle
)paren
suffix:semicolon
)brace
id|dma_addr_t
DECL|function|hwsw_map_single
id|hwsw_map_single
(paren
r_struct
id|device
op_star
id|dev
comma
r_void
op_star
id|addr
comma
r_int
id|size
comma
r_int
id|dir
)paren
(brace
r_if
c_cond
(paren
id|use_swiotlb
c_func
(paren
id|dev
)paren
)paren
r_return
id|swiotlb_map_single
c_func
(paren
id|dev
comma
id|addr
comma
id|size
comma
id|dir
)paren
suffix:semicolon
r_else
r_return
id|hwiommu_map_single
c_func
(paren
id|dev
comma
id|addr
comma
id|size
comma
id|dir
)paren
suffix:semicolon
)brace
r_void
DECL|function|hwsw_unmap_single
id|hwsw_unmap_single
(paren
r_struct
id|device
op_star
id|dev
comma
id|dma_addr_t
id|iova
comma
r_int
id|size
comma
r_int
id|dir
)paren
(brace
r_if
c_cond
(paren
id|use_swiotlb
c_func
(paren
id|dev
)paren
)paren
r_return
id|swiotlb_unmap_single
c_func
(paren
id|dev
comma
id|iova
comma
id|size
comma
id|dir
)paren
suffix:semicolon
r_else
r_return
id|hwiommu_unmap_single
c_func
(paren
id|dev
comma
id|iova
comma
id|size
comma
id|dir
)paren
suffix:semicolon
)brace
r_int
DECL|function|hwsw_map_sg
id|hwsw_map_sg
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|scatterlist
op_star
id|sglist
comma
r_int
id|nents
comma
r_int
id|dir
)paren
(brace
r_if
c_cond
(paren
id|use_swiotlb
c_func
(paren
id|dev
)paren
)paren
r_return
id|swiotlb_map_sg
c_func
(paren
id|dev
comma
id|sglist
comma
id|nents
comma
id|dir
)paren
suffix:semicolon
r_else
r_return
id|hwiommu_map_sg
c_func
(paren
id|dev
comma
id|sglist
comma
id|nents
comma
id|dir
)paren
suffix:semicolon
)brace
r_void
DECL|function|hwsw_unmap_sg
id|hwsw_unmap_sg
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|scatterlist
op_star
id|sglist
comma
r_int
id|nents
comma
r_int
id|dir
)paren
(brace
r_if
c_cond
(paren
id|use_swiotlb
c_func
(paren
id|dev
)paren
)paren
r_return
id|swiotlb_unmap_sg
c_func
(paren
id|dev
comma
id|sglist
comma
id|nents
comma
id|dir
)paren
suffix:semicolon
r_else
r_return
id|hwiommu_unmap_sg
c_func
(paren
id|dev
comma
id|sglist
comma
id|nents
comma
id|dir
)paren
suffix:semicolon
)brace
r_void
DECL|function|hwsw_sync_single_for_cpu
id|hwsw_sync_single_for_cpu
(paren
r_struct
id|device
op_star
id|dev
comma
id|dma_addr_t
id|addr
comma
r_int
id|size
comma
r_int
id|dir
)paren
(brace
r_if
c_cond
(paren
id|use_swiotlb
c_func
(paren
id|dev
)paren
)paren
id|swiotlb_sync_single_for_cpu
c_func
(paren
id|dev
comma
id|addr
comma
id|size
comma
id|dir
)paren
suffix:semicolon
r_else
id|hwiommu_sync_single_for_cpu
c_func
(paren
id|dev
comma
id|addr
comma
id|size
comma
id|dir
)paren
suffix:semicolon
)brace
r_void
DECL|function|hwsw_sync_sg_for_cpu
id|hwsw_sync_sg_for_cpu
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
id|nelems
comma
r_int
id|dir
)paren
(brace
r_if
c_cond
(paren
id|use_swiotlb
c_func
(paren
id|dev
)paren
)paren
id|swiotlb_sync_sg_for_cpu
c_func
(paren
id|dev
comma
id|sg
comma
id|nelems
comma
id|dir
)paren
suffix:semicolon
r_else
id|hwiommu_sync_sg_for_cpu
c_func
(paren
id|dev
comma
id|sg
comma
id|nelems
comma
id|dir
)paren
suffix:semicolon
)brace
r_void
DECL|function|hwsw_sync_single_for_device
id|hwsw_sync_single_for_device
(paren
r_struct
id|device
op_star
id|dev
comma
id|dma_addr_t
id|addr
comma
r_int
id|size
comma
r_int
id|dir
)paren
(brace
r_if
c_cond
(paren
id|use_swiotlb
c_func
(paren
id|dev
)paren
)paren
id|swiotlb_sync_single_for_device
c_func
(paren
id|dev
comma
id|addr
comma
id|size
comma
id|dir
)paren
suffix:semicolon
r_else
id|hwiommu_sync_single_for_device
c_func
(paren
id|dev
comma
id|addr
comma
id|size
comma
id|dir
)paren
suffix:semicolon
)brace
r_void
DECL|function|hwsw_sync_sg_for_device
id|hwsw_sync_sg_for_device
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
id|nelems
comma
r_int
id|dir
)paren
(brace
r_if
c_cond
(paren
id|use_swiotlb
c_func
(paren
id|dev
)paren
)paren
id|swiotlb_sync_sg_for_device
c_func
(paren
id|dev
comma
id|sg
comma
id|nelems
comma
id|dir
)paren
suffix:semicolon
r_else
id|hwiommu_sync_sg_for_device
c_func
(paren
id|dev
comma
id|sg
comma
id|nelems
comma
id|dir
)paren
suffix:semicolon
)brace
r_int
DECL|function|hwsw_dma_supported
id|hwsw_dma_supported
(paren
r_struct
id|device
op_star
id|dev
comma
id|u64
id|mask
)paren
(brace
r_if
c_cond
(paren
id|hwiommu_dma_supported
c_func
(paren
id|dev
comma
id|mask
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_return
id|swiotlb_dma_supported
c_func
(paren
id|dev
comma
id|mask
)paren
suffix:semicolon
)brace
r_int
DECL|function|hwsw_dma_mapping_error
id|hwsw_dma_mapping_error
(paren
id|dma_addr_t
id|dma_addr
)paren
(brace
r_return
id|hwiommu_dma_mapping_error
(paren
id|dma_addr
)paren
op_logical_or
id|swiotlb_dma_mapping_error
c_func
(paren
id|dma_addr
)paren
suffix:semicolon
)brace
DECL|variable|hwsw_dma_mapping_error
id|EXPORT_SYMBOL
c_func
(paren
id|hwsw_dma_mapping_error
)paren
suffix:semicolon
DECL|variable|hwsw_map_single
id|EXPORT_SYMBOL
c_func
(paren
id|hwsw_map_single
)paren
suffix:semicolon
DECL|variable|hwsw_unmap_single
id|EXPORT_SYMBOL
c_func
(paren
id|hwsw_unmap_single
)paren
suffix:semicolon
DECL|variable|hwsw_map_sg
id|EXPORT_SYMBOL
c_func
(paren
id|hwsw_map_sg
)paren
suffix:semicolon
DECL|variable|hwsw_unmap_sg
id|EXPORT_SYMBOL
c_func
(paren
id|hwsw_unmap_sg
)paren
suffix:semicolon
DECL|variable|hwsw_dma_supported
id|EXPORT_SYMBOL
c_func
(paren
id|hwsw_dma_supported
)paren
suffix:semicolon
DECL|variable|hwsw_alloc_coherent
id|EXPORT_SYMBOL
c_func
(paren
id|hwsw_alloc_coherent
)paren
suffix:semicolon
DECL|variable|hwsw_free_coherent
id|EXPORT_SYMBOL
c_func
(paren
id|hwsw_free_coherent
)paren
suffix:semicolon
eof
