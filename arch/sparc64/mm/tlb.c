multiline_comment|/* arch/sparc64/mm/tlb.c&n; *&n; * Copyright (C) 2004 David S. Miller &lt;davem@redhat.com&gt;&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/percpu.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/swap.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/pgalloc.h&gt;
macro_line|#include &lt;asm/tlbflush.h&gt;
macro_line|#include &lt;asm/cacheflush.h&gt;
macro_line|#include &lt;asm/mmu_context.h&gt;
macro_line|#include &lt;asm/tlb.h&gt;
multiline_comment|/* Heavily inspired by the ppc64 code.  */
id|DEFINE_PER_CPU
c_func
(paren
r_struct
id|mmu_gather
comma
id|mmu_gathers
)paren
op_assign
(brace
l_int|NULL
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
(brace
l_int|0
)brace
comma
(brace
l_int|NULL
)brace
comma
)brace
suffix:semicolon
DECL|function|flush_tlb_pending
r_void
id|flush_tlb_pending
c_func
(paren
r_void
)paren
(brace
r_struct
id|mmu_gather
op_star
id|mp
op_assign
op_amp
id|__get_cpu_var
c_func
(paren
id|mmu_gathers
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;tlb_nr
)paren
(brace
r_int
r_int
id|context
op_assign
id|mp-&gt;mm-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|CTX_VALID
c_func
(paren
id|context
)paren
)paren
(brace
macro_line|#ifdef CONFIG_SMP
id|smp_flush_tlb_pending
c_func
(paren
id|mp-&gt;mm
comma
id|mp-&gt;tlb_nr
comma
op_amp
id|mp-&gt;vaddrs
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#else
id|__flush_tlb_pending
c_func
(paren
id|CTX_HWBITS
c_func
(paren
id|context
)paren
comma
id|mp-&gt;tlb_nr
comma
op_amp
id|mp-&gt;vaddrs
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
id|mp-&gt;tlb_nr
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|tlb_batch_add
r_void
id|tlb_batch_add
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|vaddr
comma
id|pte_t
op_star
id|ptep
comma
id|pte_t
id|orig
)paren
(brace
r_struct
id|mmu_gather
op_star
id|mp
op_assign
op_amp
id|__get_cpu_var
c_func
(paren
id|mmu_gathers
)paren
suffix:semicolon
r_int
r_int
id|nr
suffix:semicolon
id|vaddr
op_and_assign
id|PAGE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|pte_exec
c_func
(paren
id|orig
)paren
)paren
id|vaddr
op_or_assign
l_int|0x1UL
suffix:semicolon
r_if
c_cond
(paren
id|pte_dirty
c_func
(paren
id|orig
)paren
)paren
(brace
r_int
r_int
id|paddr
comma
id|pfn
op_assign
id|pte_pfn
c_func
(paren
id|orig
)paren
suffix:semicolon
r_struct
id|address_space
op_star
id|mapping
suffix:semicolon
r_struct
id|page
op_star
id|page
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pfn_valid
c_func
(paren
id|pfn
)paren
)paren
r_goto
id|no_cache_flush
suffix:semicolon
id|page
op_assign
id|pfn_to_page
c_func
(paren
id|pfn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|PageReserved
c_func
(paren
id|page
)paren
)paren
r_goto
id|no_cache_flush
suffix:semicolon
multiline_comment|/* A real file page? */
id|mapping
op_assign
id|page_mapping
c_func
(paren
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mapping
)paren
r_goto
id|no_cache_flush
suffix:semicolon
id|paddr
op_assign
(paren
r_int
r_int
)paren
id|page_address
c_func
(paren
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|paddr
op_xor
id|vaddr
)paren
op_amp
(paren
l_int|1
op_lshift
l_int|13
)paren
)paren
id|flush_dcache_page_all
c_func
(paren
id|mm
comma
id|page
)paren
suffix:semicolon
)brace
id|no_cache_flush
suffix:colon
r_if
c_cond
(paren
id|mp-&gt;tlb_frozen
)paren
r_return
suffix:semicolon
id|nr
op_assign
id|mp-&gt;tlb_nr
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|nr
op_ne
l_int|0
op_logical_and
id|mm
op_ne
id|mp-&gt;mm
)paren
)paren
(brace
id|flush_tlb_pending
c_func
(paren
)paren
suffix:semicolon
id|nr
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nr
op_eq
l_int|0
)paren
id|mp-&gt;mm
op_assign
id|mm
suffix:semicolon
id|mp-&gt;vaddrs
(braket
id|nr
)braket
op_assign
id|vaddr
suffix:semicolon
id|mp-&gt;tlb_nr
op_assign
op_increment
id|nr
suffix:semicolon
r_if
c_cond
(paren
id|nr
op_ge
id|TLB_BATCH_NR
)paren
id|flush_tlb_pending
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|flush_tlb_pgtables
r_void
id|flush_tlb_pgtables
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|start
comma
r_int
r_int
id|end
)paren
(brace
r_struct
id|mmu_gather
op_star
id|mp
op_assign
op_amp
id|__get_cpu_var
c_func
(paren
id|mmu_gathers
)paren
suffix:semicolon
r_int
r_int
id|nr
op_assign
id|mp-&gt;tlb_nr
suffix:semicolon
r_int
id|s
op_assign
id|start
comma
id|e
op_assign
id|end
comma
id|vpte_base
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;tlb_frozen
)paren
r_return
suffix:semicolon
multiline_comment|/* If start is greater than end, that is a real problem.  */
id|BUG_ON
c_func
(paren
id|start
OG
id|end
)paren
suffix:semicolon
multiline_comment|/* However, straddling the VA space hole is quite normal. */
id|s
op_and_assign
id|PMD_MASK
suffix:semicolon
id|e
op_assign
(paren
id|e
op_plus
id|PMD_SIZE
op_minus
l_int|1
)paren
op_amp
id|PMD_MASK
suffix:semicolon
id|vpte_base
op_assign
(paren
id|tlb_type
op_eq
id|spitfire
ques
c_cond
id|VPTE_BASE_SPITFIRE
suffix:colon
id|VPTE_BASE_CHEETAH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|nr
op_ne
l_int|0
op_logical_and
id|mm
op_ne
id|mp-&gt;mm
)paren
)paren
(brace
id|flush_tlb_pending
c_func
(paren
)paren
suffix:semicolon
id|nr
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nr
op_eq
l_int|0
)paren
id|mp-&gt;mm
op_assign
id|mm
suffix:semicolon
id|start
op_assign
id|vpte_base
op_plus
(paren
id|s
op_rshift
(paren
id|PAGE_SHIFT
op_minus
l_int|3
)paren
)paren
suffix:semicolon
id|end
op_assign
id|vpte_base
op_plus
(paren
id|e
op_rshift
(paren
id|PAGE_SHIFT
op_minus
l_int|3
)paren
)paren
suffix:semicolon
multiline_comment|/* If the request straddles the VA space hole, we&n;&t; * need to swap start and end.  The reason this&n;&t; * occurs is that &quot;vpte_base&quot; is the center of&n;&t; * the linear page table mapping area.  Thus,&n;&t; * high addresses with the sign bit set map to&n;&t; * addresses below vpte_base and non-sign bit&n;&t; * addresses map to addresses above vpte_base.&n;&t; */
r_if
c_cond
(paren
id|end
OL
id|start
)paren
(brace
r_int
r_int
id|tmp
op_assign
id|start
suffix:semicolon
id|start
op_assign
id|end
suffix:semicolon
id|end
op_assign
id|tmp
suffix:semicolon
)brace
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
id|mp-&gt;vaddrs
(braket
id|nr
)braket
op_assign
id|start
suffix:semicolon
id|mp-&gt;tlb_nr
op_assign
op_increment
id|nr
suffix:semicolon
r_if
c_cond
(paren
id|nr
op_ge
id|TLB_BATCH_NR
)paren
(brace
id|flush_tlb_pending
c_func
(paren
)paren
suffix:semicolon
id|nr
op_assign
l_int|0
suffix:semicolon
)brace
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nr
)paren
id|flush_tlb_pending
c_func
(paren
)paren
suffix:semicolon
)brace
eof
