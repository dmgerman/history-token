multiline_comment|/* $Id: semaphore.c,v 1.9 2001/11/18 00:12:56 davem Exp $&n; * semaphore.c: Sparc64 semaphore implementation.&n; *&n; * This is basically the PPC semaphore scheme ported to use&n; * the sparc64 atomic instructions, so see the PPC code for&n; * credits.&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
multiline_comment|/*&n; * Atomically update sem-&gt;count.&n; * This does the equivalent of the following:&n; *&n; *&t;old_count = sem-&gt;count;&n; *&t;tmp = MAX(old_count, 0) + incr;&n; *&t;sem-&gt;count = tmp;&n; *&t;return old_count;&n; */
DECL|function|__sem_update_count
r_static
id|__inline__
r_int
id|__sem_update_count
c_func
(paren
r_struct
id|semaphore
op_star
id|sem
comma
r_int
id|incr
)paren
(brace
r_int
id|old_count
comma
id|tmp
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;&bslash;n&quot;
l_string|&quot;&t;! __sem_update_count old_count(%0) tmp(%1) incr(%4) &amp;sem-&gt;count(%3)&bslash;n&quot;
l_string|&quot;1:&t;ldsw&t;[%3], %0&bslash;n&quot;
l_string|&quot;&t;mov&t;%0, %1&bslash;n&quot;
l_string|&quot;&t;cmp&t;%0, 0&bslash;n&quot;
l_string|&quot;&t;movl&t;%%icc, 0, %1&bslash;n&quot;
l_string|&quot;&t;add&t;%1, %4, %1&bslash;n&quot;
l_string|&quot;&t;cas&t;[%3], %0, %1&bslash;n&quot;
l_string|&quot;&t;cmp&t;%0, %1&bslash;n&quot;
l_string|&quot;&t;bne,pn&t;%%icc, 1b&bslash;n&quot;
l_string|&quot;&t; membar #StoreLoad | #StoreStore&bslash;n&quot;
suffix:colon
l_string|&quot;=&amp;r&quot;
(paren
id|old_count
)paren
comma
l_string|&quot;=&amp;r&quot;
(paren
id|tmp
)paren
comma
l_string|&quot;=m&quot;
(paren
id|sem-&gt;count
)paren
suffix:colon
l_string|&quot;r&quot;
(paren
op_amp
id|sem-&gt;count
)paren
comma
l_string|&quot;r&quot;
(paren
id|incr
)paren
comma
l_string|&quot;m&quot;
(paren
id|sem-&gt;count
)paren
suffix:colon
l_string|&quot;cc&quot;
)paren
suffix:semicolon
r_return
id|old_count
suffix:semicolon
)brace
DECL|function|__up
r_void
id|__up
c_func
(paren
r_struct
id|semaphore
op_star
id|sem
)paren
(brace
id|__sem_update_count
c_func
(paren
id|sem
comma
l_int|1
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|sem-&gt;wait
)paren
suffix:semicolon
)brace
DECL|function|__down
r_void
id|__down
c_func
(paren
r_struct
id|semaphore
op_star
id|sem
)paren
(brace
r_struct
id|task_struct
op_star
id|tsk
op_assign
id|current
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|tsk
)paren
suffix:semicolon
id|tsk-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
id|add_wait_queue_exclusive
c_func
(paren
op_amp
id|sem-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_while
c_loop
(paren
id|__sem_update_count
c_func
(paren
id|sem
comma
op_minus
l_int|1
)paren
op_le
l_int|0
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|tsk-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|sem-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|tsk-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|sem-&gt;wait
)paren
suffix:semicolon
)brace
DECL|function|__down_interruptible
r_int
id|__down_interruptible
c_func
(paren
r_struct
id|semaphore
op_star
id|sem
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|task_struct
op_star
id|tsk
op_assign
id|current
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|tsk
)paren
suffix:semicolon
id|tsk-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|add_wait_queue_exclusive
c_func
(paren
op_amp
id|sem-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_while
c_loop
(paren
id|__sem_update_count
c_func
(paren
id|sem
comma
op_minus
l_int|1
)paren
op_le
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|__sem_update_count
c_func
(paren
id|sem
comma
l_int|0
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EINTR
suffix:semicolon
r_break
suffix:semicolon
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|tsk-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
)brace
id|tsk-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|sem-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|sem-&gt;wait
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
eof
