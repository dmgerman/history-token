multiline_comment|/* $Id: pci_schizo.c,v 1.20 2001/08/12 13:18:23 davem Exp $&n; * pci_schizo.c: SCHIZO specific PCI controller support.&n; *&n; * Copyright (C) 2001 David S. Miller (davem@redhat.com)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;asm/pbm.h&gt;
macro_line|#include &lt;asm/iommu.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/upa.h&gt;
macro_line|#include &quot;pci_impl.h&quot;
multiline_comment|/* All SCHIZO registers are 64-bits.  The following accessor&n; * routines are how they are accessed.  The REG parameter&n; * is a physical address.&n; */
DECL|macro|schizo_read
mdefine_line|#define schizo_read(__reg) &bslash;&n;({&t;u64 __ret; &bslash;&n;&t;__asm__ __volatile__(&quot;ldxa [%1] %2, %0&quot; &bslash;&n;&t;&t;&t;     : &quot;=r&quot; (__ret) &bslash;&n;&t;&t;&t;     : &quot;r&quot; (__reg), &quot;i&quot; (ASI_PHYS_BYPASS_EC_E) &bslash;&n;&t;&t;&t;     : &quot;memory&quot;); &bslash;&n;&t;__ret; &bslash;&n;})
DECL|macro|schizo_write
mdefine_line|#define schizo_write(__reg, __val) &bslash;&n;&t;__asm__ __volatile__(&quot;stxa %0, [%1] %2&quot; &bslash;&n;&t;&t;&t;     : /* no outputs */ &bslash;&n;&t;&t;&t;     : &quot;r&quot; (__val), &quot;r&quot; (__reg), &bslash;&n;&t;&t;&t;       &quot;i&quot; (ASI_PHYS_BYPASS_EC_E))
multiline_comment|/* This is a convention that at least Excalibur and Merlin&n; * follow.  I suppose the SCHIZO used in Starcat and friends&n; * will do similar.&n; *&n; * The only way I could see this changing is if the newlink&n; * block requires more space in Schizo&squot;s address space than&n; * they predicted, thus requiring an address space reorg when&n; * the newer Schizo is taped out.&n; *&n; * These offsets look weird because I keep in p-&gt;controller_regs&n; * the second PROM register property minus 0x10000 which is the&n; * base of the Safari and UPA64S registers of SCHIZO.&n; */
DECL|macro|SCHIZO_PBM_A_REGS_OFF
mdefine_line|#define SCHIZO_PBM_A_REGS_OFF&t;(0x600000UL - 0x400000UL)
DECL|macro|SCHIZO_PBM_B_REGS_OFF
mdefine_line|#define SCHIZO_PBM_B_REGS_OFF&t;(0x700000UL - 0x400000UL)
multiline_comment|/* Streaming buffer control register. */
DECL|macro|SCHIZO_STRBUF_CTRL_LPTR
mdefine_line|#define SCHIZO_STRBUF_CTRL_LPTR    0x00000000000000f0UL /* LRU Lock Pointer */
DECL|macro|SCHIZO_STRBUF_CTRL_LENAB
mdefine_line|#define SCHIZO_STRBUF_CTRL_LENAB   0x0000000000000008UL /* LRU Lock Enable */
DECL|macro|SCHIZO_STRBUF_CTRL_RRDIS
mdefine_line|#define SCHIZO_STRBUF_CTRL_RRDIS   0x0000000000000004UL /* Rerun Disable */
DECL|macro|SCHIZO_STRBUF_CTRL_DENAB
mdefine_line|#define SCHIZO_STRBUF_CTRL_DENAB   0x0000000000000002UL /* Diagnostic Mode Enable */
DECL|macro|SCHIZO_STRBUF_CTRL_ENAB
mdefine_line|#define SCHIZO_STRBUF_CTRL_ENAB    0x0000000000000001UL /* Streaming Buffer Enable */
multiline_comment|/* IOMMU control register. */
DECL|macro|SCHIZO_IOMMU_CTRL_RESV
mdefine_line|#define SCHIZO_IOMMU_CTRL_RESV     0xfffffffff9000000 /* Reserved                      */
DECL|macro|SCHIZO_IOMMU_CTRL_XLTESTAT
mdefine_line|#define SCHIZO_IOMMU_CTRL_XLTESTAT 0x0000000006000000 /* Translation Error Status      */
DECL|macro|SCHIZO_IOMMU_CTRL_XLTEERR
mdefine_line|#define SCHIZO_IOMMU_CTRL_XLTEERR  0x0000000001000000 /* Translation Error encountered */
DECL|macro|SCHIZO_IOMMU_CTRL_LCKEN
mdefine_line|#define SCHIZO_IOMMU_CTRL_LCKEN    0x0000000000800000 /* Enable translation locking    */
DECL|macro|SCHIZO_IOMMU_CTRL_LCKPTR
mdefine_line|#define SCHIZO_IOMMU_CTRL_LCKPTR   0x0000000000780000 /* Translation lock pointer      */
DECL|macro|SCHIZO_IOMMU_CTRL_TSBSZ
mdefine_line|#define SCHIZO_IOMMU_CTRL_TSBSZ    0x0000000000070000 /* TSB Size                      */
DECL|macro|SCHIZO_IOMMU_TSBSZ_1K
mdefine_line|#define SCHIZO_IOMMU_TSBSZ_1K      0x0000000000000000 /* TSB Table 1024 8-byte entries */
DECL|macro|SCHIZO_IOMMU_TSBSZ_2K
mdefine_line|#define SCHIZO_IOMMU_TSBSZ_2K      0x0000000000010000 /* TSB Table 2048 8-byte entries */
DECL|macro|SCHIZO_IOMMU_TSBSZ_4K
mdefine_line|#define SCHIZO_IOMMU_TSBSZ_4K      0x0000000000020000 /* TSB Table 4096 8-byte entries */
DECL|macro|SCHIZO_IOMMU_TSBSZ_8K
mdefine_line|#define SCHIZO_IOMMU_TSBSZ_8K      0x0000000000030000 /* TSB Table 8192 8-byte entries */
DECL|macro|SCHIZO_IOMMU_TSBSZ_16K
mdefine_line|#define SCHIZO_IOMMU_TSBSZ_16K     0x0000000000040000 /* TSB Table 16k 8-byte entries  */
DECL|macro|SCHIZO_IOMMU_TSBSZ_32K
mdefine_line|#define SCHIZO_IOMMU_TSBSZ_32K     0x0000000000050000 /* TSB Table 32k 8-byte entries  */
DECL|macro|SCHIZO_IOMMU_TSBSZ_64K
mdefine_line|#define SCHIZO_IOMMU_TSBSZ_64K     0x0000000000060000 /* TSB Table 64k 8-byte entries  */
DECL|macro|SCHIZO_IOMMU_TSBSZ_128K
mdefine_line|#define SCHIZO_IOMMU_TSBSZ_128K    0x0000000000070000 /* TSB Table 128k 8-byte entries */
DECL|macro|SCHIZO_IOMMU_CTRL_RESV2
mdefine_line|#define SCHIZO_IOMMU_CTRL_RESV2    0x000000000000fff8 /* Reserved                      */
DECL|macro|SCHIZO_IOMMU_CTRL_TBWSZ
mdefine_line|#define SCHIZO_IOMMU_CTRL_TBWSZ    0x0000000000000004 /* Assumed page size, 0=8k 1=64k */
DECL|macro|SCHIZO_IOMMU_CTRL_DENAB
mdefine_line|#define SCHIZO_IOMMU_CTRL_DENAB    0x0000000000000002 /* Diagnostic mode enable        */
DECL|macro|SCHIZO_IOMMU_CTRL_ENAB
mdefine_line|#define SCHIZO_IOMMU_CTRL_ENAB     0x0000000000000001 /* IOMMU Enable                  */
multiline_comment|/* Schizo config space address format is nearly identical to&n; * that of PSYCHO:&n; *&n; *  32             24 23 16 15    11 10       8 7   2  1 0&n; * ---------------------------------------------------------&n; * |0 0 0 0 0 0 0 0 0| bus | device | function | reg | 0 0 |&n; * ---------------------------------------------------------&n; */
DECL|macro|SCHIZO_CONFIG_BASE
mdefine_line|#define SCHIZO_CONFIG_BASE(PBM)&t;((PBM)-&gt;config_space)
DECL|macro|SCHIZO_CONFIG_ENCODE
mdefine_line|#define SCHIZO_CONFIG_ENCODE(BUS, DEVFN, REG)&t;&bslash;&n;&t;(((unsigned long)(BUS)   &lt;&lt; 16) |&t;&bslash;&n;&t; ((unsigned long)(DEVFN) &lt;&lt; 8)  |&t;&bslash;&n;&t; ((unsigned long)(REG)))
DECL|function|schizo_pci_config_mkaddr
r_static
r_void
op_star
id|schizo_pci_config_mkaddr
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_int
r_char
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pbm
)paren
r_return
l_int|NULL
suffix:semicolon
r_return
(paren
r_void
op_star
)paren
(paren
id|SCHIZO_CONFIG_BASE
c_func
(paren
id|pbm
)paren
op_or
id|SCHIZO_CONFIG_ENCODE
c_func
(paren
id|bus
comma
id|devfn
comma
id|where
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* 4 slots on pbm A, and 6 slots on pbm B.  In both cases&n; * slot 0 is the SCHIZO host bridge itself.&n; */
DECL|function|schizo_out_of_range
r_static
r_int
id|schizo_out_of_range
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_int
r_char
id|bus
comma
r_int
r_char
id|devfn
)paren
(brace
r_return
(paren
(paren
id|pbm-&gt;parent
op_eq
l_int|0
)paren
op_logical_or
(paren
(paren
id|pbm
op_eq
op_amp
id|pbm-&gt;parent-&gt;pbm_B
)paren
op_logical_and
(paren
id|bus
op_eq
id|pbm-&gt;pci_first_busno
)paren
op_logical_and
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
OG
l_int|6
)paren
op_logical_or
(paren
(paren
id|pbm
op_eq
op_amp
id|pbm-&gt;parent-&gt;pbm_A
)paren
op_logical_and
(paren
id|bus
op_eq
id|pbm-&gt;pci_first_busno
)paren
op_logical_and
id|PCI_SLOT
c_func
(paren
id|devfn
)paren
OG
l_int|4
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* SCHIZO PCI configuration space accessors. */
DECL|function|schizo_read_byte
r_static
r_int
id|schizo_read_byte
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u8
op_star
id|value
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|pci_bus2pbm
(braket
id|dev-&gt;bus-&gt;number
)braket
suffix:semicolon
r_int
r_char
id|bus
op_assign
id|dev-&gt;bus-&gt;number
suffix:semicolon
r_int
r_int
id|devfn
op_assign
id|dev-&gt;devfn
suffix:semicolon
id|u8
op_star
id|addr
suffix:semicolon
op_star
id|value
op_assign
l_int|0xff
suffix:semicolon
id|addr
op_assign
id|schizo_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
comma
id|where
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|schizo_out_of_range
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
id|pci_config_read8
c_func
(paren
id|addr
comma
id|value
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|schizo_read_word
r_static
r_int
id|schizo_read_word
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u16
op_star
id|value
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|pci_bus2pbm
(braket
id|dev-&gt;bus-&gt;number
)braket
suffix:semicolon
r_int
r_char
id|bus
op_assign
id|dev-&gt;bus-&gt;number
suffix:semicolon
r_int
r_int
id|devfn
op_assign
id|dev-&gt;devfn
suffix:semicolon
id|u16
op_star
id|addr
suffix:semicolon
op_star
id|value
op_assign
l_int|0xffff
suffix:semicolon
id|addr
op_assign
id|schizo_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
comma
id|where
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|schizo_out_of_range
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|where
op_amp
l_int|0x01
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;pcibios_read_config_word: misaligned reg [%x]&bslash;n&quot;
comma
id|where
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
id|pci_config_read16
c_func
(paren
id|addr
comma
id|value
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|schizo_read_dword
r_static
r_int
id|schizo_read_dword
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u32
op_star
id|value
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|pci_bus2pbm
(braket
id|dev-&gt;bus-&gt;number
)braket
suffix:semicolon
r_int
r_char
id|bus
op_assign
id|dev-&gt;bus-&gt;number
suffix:semicolon
r_int
r_int
id|devfn
op_assign
id|dev-&gt;devfn
suffix:semicolon
id|u32
op_star
id|addr
suffix:semicolon
op_star
id|value
op_assign
l_int|0xffffffff
suffix:semicolon
id|addr
op_assign
id|schizo_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
comma
id|where
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|schizo_out_of_range
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|where
op_amp
l_int|0x03
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;pcibios_read_config_dword: misaligned reg [%x]&bslash;n&quot;
comma
id|where
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
id|pci_config_read32
c_func
(paren
id|addr
comma
id|value
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|schizo_write_byte
r_static
r_int
id|schizo_write_byte
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u8
id|value
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|pci_bus2pbm
(braket
id|dev-&gt;bus-&gt;number
)braket
suffix:semicolon
r_int
r_char
id|bus
op_assign
id|dev-&gt;bus-&gt;number
suffix:semicolon
r_int
r_int
id|devfn
op_assign
id|dev-&gt;devfn
suffix:semicolon
id|u8
op_star
id|addr
suffix:semicolon
id|addr
op_assign
id|schizo_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
comma
id|where
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|schizo_out_of_range
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
id|pci_config_write8
c_func
(paren
id|addr
comma
id|value
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|schizo_write_word
r_static
r_int
id|schizo_write_word
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u16
id|value
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|pci_bus2pbm
(braket
id|dev-&gt;bus-&gt;number
)braket
suffix:semicolon
r_int
r_char
id|bus
op_assign
id|dev-&gt;bus-&gt;number
suffix:semicolon
r_int
r_int
id|devfn
op_assign
id|dev-&gt;devfn
suffix:semicolon
id|u16
op_star
id|addr
suffix:semicolon
id|addr
op_assign
id|schizo_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
comma
id|where
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|schizo_out_of_range
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|where
op_amp
l_int|0x01
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;pcibios_write_config_word: misaligned reg [%x]&bslash;n&quot;
comma
id|where
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
id|pci_config_write16
c_func
(paren
id|addr
comma
id|value
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|schizo_write_dword
r_static
r_int
id|schizo_write_dword
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u32
id|value
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|pci_bus2pbm
(braket
id|dev-&gt;bus-&gt;number
)braket
suffix:semicolon
r_int
r_char
id|bus
op_assign
id|dev-&gt;bus-&gt;number
suffix:semicolon
r_int
r_int
id|devfn
op_assign
id|dev-&gt;devfn
suffix:semicolon
id|u32
op_star
id|addr
suffix:semicolon
id|addr
op_assign
id|schizo_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
comma
id|where
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|schizo_out_of_range
c_func
(paren
id|pbm
comma
id|bus
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
r_if
c_cond
(paren
id|where
op_amp
l_int|0x03
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;pcibios_write_config_dword: misaligned reg [%x]&bslash;n&quot;
comma
id|where
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
id|pci_config_write32
c_func
(paren
id|addr
comma
id|value
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|variable|schizo_ops
r_static
r_struct
id|pci_ops
id|schizo_ops
op_assign
(brace
id|schizo_read_byte
comma
id|schizo_read_word
comma
id|schizo_read_dword
comma
id|schizo_write_byte
comma
id|schizo_write_word
comma
id|schizo_write_dword
)brace
suffix:semicolon
multiline_comment|/* SCHIZO interrupt mapping support.  Unlike Psycho, for this controller the&n; * imap/iclr registers are per-PBM.&n; */
DECL|macro|SCHIZO_IMAP_BASE
mdefine_line|#define SCHIZO_IMAP_BASE&t;0x1000UL
DECL|macro|SCHIZO_ICLR_BASE
mdefine_line|#define SCHIZO_ICLR_BASE&t;0x1400UL
DECL|function|schizo_imap_offset
r_static
r_int
r_int
id|schizo_imap_offset
c_func
(paren
r_int
r_int
id|ino
)paren
(brace
r_return
id|SCHIZO_IMAP_BASE
op_plus
(paren
id|ino
op_star
l_int|8UL
)paren
suffix:semicolon
)brace
DECL|function|schizo_iclr_offset
r_static
r_int
r_int
id|schizo_iclr_offset
c_func
(paren
r_int
r_int
id|ino
)paren
(brace
r_return
id|SCHIZO_ICLR_BASE
op_plus
(paren
id|ino
op_star
l_int|8UL
)paren
suffix:semicolon
)brace
multiline_comment|/* PCI SCHIZO INO number to Sparc PIL level.  This table only matters for&n; * INOs which will not have an associated PCI device struct, ie. onboard&n; * EBUS devices and PCI controller internal error interrupts.&n; */
DECL|variable|schizo_pil_table
r_static
r_int
r_char
id|schizo_pil_table
(braket
)braket
op_assign
(brace
multiline_comment|/*0x00*/
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* PCI slot 0  Int A, B, C, D&t;*/
multiline_comment|/*0x04*/
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* PCI slot 1  Int A, B, C, D&t;*/
multiline_comment|/*0x08*/
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* PCI slot 2  Int A, B, C, D&t;*/
multiline_comment|/*0x0c*/
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* PCI slot 3  Int A, B, C, D&t;*/
multiline_comment|/*0x10*/
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* PCI slot 4  Int A, B, C, D&t;*/
multiline_comment|/*0x14*/
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* PCI slot 5  Int A, B, C, D&t;*/
multiline_comment|/*0x18*/
l_int|3
comma
multiline_comment|/* SCSI&t;&t;&t;&t;*/
multiline_comment|/*0x19*/
l_int|3
comma
multiline_comment|/* second SCSI&t;&t;&t;*/
multiline_comment|/*0x1a*/
l_int|0
comma
multiline_comment|/* UNKNOWN&t;&t;&t;*/
multiline_comment|/*0x1b*/
l_int|0
comma
multiline_comment|/* UNKNOWN&t;&t;&t;*/
multiline_comment|/*0x1c*/
l_int|8
comma
multiline_comment|/* Parallel&t;&t;&t;*/
multiline_comment|/*0x1d*/
l_int|5
comma
multiline_comment|/* Ethernet&t;&t;&t;*/
multiline_comment|/*0x1e*/
l_int|8
comma
multiline_comment|/* Firewire-1394&t;&t;*/
multiline_comment|/*0x1f*/
l_int|9
comma
multiline_comment|/* USB&t;&t;&t;&t;*/
multiline_comment|/*0x20*/
l_int|13
comma
multiline_comment|/* Audio Record&t;&t;&t;*/
multiline_comment|/*0x21*/
l_int|14
comma
multiline_comment|/* Audio Playback&t;&t;*/
multiline_comment|/*0x22*/
l_int|12
comma
multiline_comment|/* Serial&t;&t;&t;*/
multiline_comment|/*0x23*/
l_int|2
comma
multiline_comment|/* EBUS I2C &t;&t;&t;*/
multiline_comment|/*0x24*/
l_int|10
comma
multiline_comment|/* RTC Clock&t;&t;&t;*/
multiline_comment|/*0x25*/
l_int|11
comma
multiline_comment|/* Floppy&t;&t;&t;*/
multiline_comment|/*0x26*/
l_int|0
comma
multiline_comment|/* UNKNOWN&t;&t;&t;*/
multiline_comment|/*0x27*/
l_int|0
comma
multiline_comment|/* UNKNOWN&t;&t;&t;*/
multiline_comment|/*0x28*/
l_int|0
comma
multiline_comment|/* UNKNOWN&t;&t;&t;*/
multiline_comment|/*0x29*/
l_int|0
comma
multiline_comment|/* UNKNOWN&t;&t;&t;*/
multiline_comment|/*0x2a*/
l_int|10
comma
multiline_comment|/* UPA 1&t;&t;&t;*/
multiline_comment|/*0x2b*/
l_int|10
comma
multiline_comment|/* UPA 2&t;&t;&t;*/
multiline_comment|/*0x2c*/
l_int|0
comma
multiline_comment|/* UNKNOWN&t;&t;&t;*/
multiline_comment|/*0x2d*/
l_int|0
comma
multiline_comment|/* UNKNOWN&t;&t;&t;*/
multiline_comment|/*0x2e*/
l_int|0
comma
multiline_comment|/* UNKNOWN&t;&t;&t;*/
multiline_comment|/*0x2f*/
l_int|0
comma
multiline_comment|/* UNKNOWN&t;&t;&t;*/
multiline_comment|/*0x30*/
l_int|15
comma
multiline_comment|/* Uncorrectable ECC&t;&t;*/
multiline_comment|/*0x31*/
l_int|15
comma
multiline_comment|/* Correctable ECC&t;&t;*/
multiline_comment|/*0x32*/
l_int|15
comma
multiline_comment|/* PCI Bus A Error&t;&t;*/
multiline_comment|/*0x33*/
l_int|15
comma
multiline_comment|/* PCI Bus B Error&t;&t;*/
multiline_comment|/*0x34*/
l_int|15
comma
multiline_comment|/* Safari Bus Error&t;&t;*/
multiline_comment|/*0x35*/
l_int|0
comma
multiline_comment|/* Reserved&t;&t;&t;*/
multiline_comment|/*0x36*/
l_int|0
comma
multiline_comment|/* Reserved&t;&t;&t;*/
multiline_comment|/*0x37*/
l_int|0
comma
multiline_comment|/* Reserved&t;&t;&t;*/
multiline_comment|/*0x38*/
l_int|0
comma
multiline_comment|/* Reserved for NewLink&t;&t;*/
multiline_comment|/*0x39*/
l_int|0
comma
multiline_comment|/* Reserved for NewLink&t;&t;*/
multiline_comment|/*0x3a*/
l_int|0
comma
multiline_comment|/* Reserved for NewLink&t;&t;*/
multiline_comment|/*0x3b*/
l_int|0
comma
multiline_comment|/* Reserved for NewLink&t;&t;*/
multiline_comment|/*0x3c*/
l_int|0
comma
multiline_comment|/* Reserved for NewLink&t;&t;*/
multiline_comment|/*0x3d*/
l_int|0
comma
multiline_comment|/* Reserved for NewLink&t;&t;*/
multiline_comment|/*0x3e*/
l_int|0
comma
multiline_comment|/* Reserved for NewLink&t;&t;*/
multiline_comment|/*0x3f*/
l_int|0
comma
multiline_comment|/* Reserved for NewLink&t;&t;*/
)brace
suffix:semicolon
DECL|function|schizo_ino_to_pil
r_static
r_int
id|__init
id|schizo_ino_to_pil
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
r_int
id|ino
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|schizo_pil_table
(braket
id|ino
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
op_logical_and
id|pdev
op_eq
l_int|NULL
)paren
(brace
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
r_switch
c_cond
(paren
(paren
id|pdev
op_member_access_from_pointer
r_class
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
)paren
(brace
r_case
id|PCI_BASE_CLASS_STORAGE
suffix:colon
id|ret
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_BASE_CLASS_NETWORK
suffix:colon
id|ret
op_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_BASE_CLASS_DISPLAY
suffix:colon
id|ret
op_assign
l_int|9
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_BASE_CLASS_MULTIMEDIA
suffix:colon
r_case
id|PCI_BASE_CLASS_MEMORY
suffix:colon
r_case
id|PCI_BASE_CLASS_BRIDGE
suffix:colon
id|ret
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|schizo_irq_build
r_static
r_int
r_int
id|__init
id|schizo_irq_build
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
r_int
id|ino
)paren
(brace
r_struct
id|pci_controller_info
op_star
id|p
op_assign
id|pbm-&gt;parent
suffix:semicolon
r_struct
id|ino_bucket
op_star
id|bucket
suffix:semicolon
r_int
r_int
id|imap
comma
id|iclr
comma
id|pbm_off
suffix:semicolon
r_int
r_int
id|imap_off
comma
id|iclr_off
suffix:semicolon
r_int
id|pil
comma
id|inofixup
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pbm
op_eq
op_amp
id|p-&gt;pbm_A
)paren
id|pbm_off
op_assign
id|SCHIZO_PBM_A_REGS_OFF
suffix:semicolon
r_else
id|pbm_off
op_assign
id|SCHIZO_PBM_B_REGS_OFF
suffix:semicolon
id|ino
op_and_assign
id|PCI_IRQ_INO
suffix:semicolon
id|imap_off
op_assign
id|schizo_imap_offset
c_func
(paren
id|ino
)paren
suffix:semicolon
multiline_comment|/* Now build the IRQ bucket. */
id|pil
op_assign
id|schizo_ino_to_pil
c_func
(paren
id|pdev
comma
id|ino
)paren
suffix:semicolon
id|imap
op_assign
id|p-&gt;controller_regs
op_plus
id|pbm_off
op_plus
id|imap_off
suffix:semicolon
id|imap
op_add_assign
l_int|4
suffix:semicolon
id|iclr_off
op_assign
id|schizo_iclr_offset
c_func
(paren
id|ino
)paren
suffix:semicolon
id|iclr
op_assign
id|p-&gt;controller_regs
op_plus
id|pbm_off
op_plus
id|iclr_off
suffix:semicolon
id|iclr
op_add_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|ino
OL
l_int|0x18
)paren
id|inofixup
op_assign
id|ino
op_amp
l_int|0x03
suffix:semicolon
id|bucket
op_assign
id|__bucket
c_func
(paren
id|build_irq
c_func
(paren
id|pil
comma
id|inofixup
comma
id|iclr
comma
id|imap
)paren
)paren
suffix:semicolon
id|bucket-&gt;flags
op_or_assign
id|IBF_PCI
suffix:semicolon
r_return
id|__irq
c_func
(paren
id|bucket
)paren
suffix:semicolon
)brace
multiline_comment|/* SCHIZO error handling support. */
DECL|enum|schizo_error_type
r_enum
id|schizo_error_type
(brace
DECL|enumerator|UE_ERR
DECL|enumerator|CE_ERR
DECL|enumerator|PCI_ERR
DECL|enumerator|SAFARI_ERR
id|UE_ERR
comma
id|CE_ERR
comma
id|PCI_ERR
comma
id|SAFARI_ERR
)brace
suffix:semicolon
DECL|variable|stc_buf_lock
r_static
id|spinlock_t
id|stc_buf_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|stc_error_buf
r_static
r_int
r_int
id|stc_error_buf
(braket
l_int|128
)braket
suffix:semicolon
DECL|variable|stc_tag_buf
r_static
r_int
r_int
id|stc_tag_buf
(braket
l_int|16
)braket
suffix:semicolon
DECL|variable|stc_line_buf
r_static
r_int
r_int
id|stc_line_buf
(braket
l_int|16
)braket
suffix:semicolon
DECL|function|schizo_clear_other_err_intr
r_static
r_void
id|schizo_clear_other_err_intr
c_func
(paren
r_int
id|irq
)paren
(brace
r_struct
id|ino_bucket
op_star
id|bucket
op_assign
id|__bucket
c_func
(paren
id|irq
)paren
suffix:semicolon
r_int
r_int
id|iclr
op_assign
id|bucket-&gt;iclr
suffix:semicolon
id|iclr
op_add_assign
(paren
id|SCHIZO_PBM_B_REGS_OFF
op_minus
id|SCHIZO_PBM_A_REGS_OFF
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ICLR_IDLE
comma
id|iclr
)paren
suffix:semicolon
)brace
DECL|macro|SCHIZO_STC_ERR
mdefine_line|#define SCHIZO_STC_ERR&t;0xb800UL /* --&gt; 0xba00 */
DECL|macro|SCHIZO_STC_TAG
mdefine_line|#define SCHIZO_STC_TAG&t;0xba00UL /* --&gt; 0xba80 */
DECL|macro|SCHIZO_STC_LINE
mdefine_line|#define SCHIZO_STC_LINE&t;0xbb00UL /* --&gt; 0xbb80 */
DECL|macro|SCHIZO_STCERR_WRITE
mdefine_line|#define SCHIZO_STCERR_WRITE&t;0x2UL
DECL|macro|SCHIZO_STCERR_READ
mdefine_line|#define SCHIZO_STCERR_READ&t;0x1UL
DECL|macro|SCHIZO_STCTAG_PPN
mdefine_line|#define SCHIZO_STCTAG_PPN&t;0x3fffffff00000000UL
DECL|macro|SCHIZO_STCTAG_VPN
mdefine_line|#define SCHIZO_STCTAG_VPN&t;0x00000000ffffe000UL
DECL|macro|SCHIZO_STCTAG_VALID
mdefine_line|#define SCHIZO_STCTAG_VALID&t;0x8000000000000000UL
DECL|macro|SCHIZO_STCTAG_READ
mdefine_line|#define SCHIZO_STCTAG_READ&t;0x4000000000000000UL
DECL|macro|SCHIZO_STCLINE_LINDX
mdefine_line|#define SCHIZO_STCLINE_LINDX&t;0x0000000007800000UL
DECL|macro|SCHIZO_STCLINE_SPTR
mdefine_line|#define SCHIZO_STCLINE_SPTR&t;0x000000000007e000UL
DECL|macro|SCHIZO_STCLINE_LADDR
mdefine_line|#define SCHIZO_STCLINE_LADDR&t;0x0000000000001fc0UL
DECL|macro|SCHIZO_STCLINE_EPTR
mdefine_line|#define SCHIZO_STCLINE_EPTR&t;0x000000000000003fUL
DECL|macro|SCHIZO_STCLINE_VALID
mdefine_line|#define SCHIZO_STCLINE_VALID&t;0x0000000000600000UL
DECL|macro|SCHIZO_STCLINE_FOFN
mdefine_line|#define SCHIZO_STCLINE_FOFN&t;0x0000000000180000UL
DECL|function|__schizo_check_stc_error_pbm
r_static
r_void
id|__schizo_check_stc_error_pbm
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_enum
id|schizo_error_type
id|type
)paren
(brace
r_struct
id|pci_controller_info
op_star
id|p
op_assign
id|pbm-&gt;parent
suffix:semicolon
r_struct
id|pci_strbuf
op_star
id|strbuf
op_assign
op_amp
id|pbm-&gt;stc
suffix:semicolon
r_int
r_int
id|regbase
op_assign
id|p-&gt;controller_regs
suffix:semicolon
r_int
r_int
id|err_base
comma
id|tag_base
comma
id|line_base
suffix:semicolon
id|u64
id|control
suffix:semicolon
r_char
id|pbm_name
op_assign
(paren
id|pbm
op_eq
op_amp
id|p-&gt;pbm_A
ques
c_cond
l_char|&squot;A&squot;
suffix:colon
l_char|&squot;B&squot;
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|pbm
op_eq
op_amp
id|p-&gt;pbm_A
)paren
id|regbase
op_add_assign
id|SCHIZO_PBM_A_REGS_OFF
suffix:semicolon
r_else
id|regbase
op_add_assign
id|SCHIZO_PBM_B_REGS_OFF
suffix:semicolon
id|err_base
op_assign
id|regbase
op_plus
id|SCHIZO_STC_ERR
suffix:semicolon
id|tag_base
op_assign
id|regbase
op_plus
id|SCHIZO_STC_TAG
suffix:semicolon
id|line_base
op_assign
id|regbase
op_plus
id|SCHIZO_STC_LINE
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|stc_buf_lock
)paren
suffix:semicolon
multiline_comment|/* This is __REALLY__ dangerous.  When we put the&n;&t; * streaming buffer into diagnostic mode to probe&n;&t; * it&squot;s tags and error status, we _must_ clear all&n;&t; * of the line tag valid bits before re-enabling&n;&t; * the streaming buffer.  If any dirty data lives&n;&t; * in the STC when we do this, we will end up&n;&t; * invalidating it before it has a chance to reach&n;&t; * main memory.&n;&t; */
id|control
op_assign
id|schizo_read
c_func
(paren
id|strbuf-&gt;strbuf_control
)paren
suffix:semicolon
id|schizo_write
c_func
(paren
id|strbuf-&gt;strbuf_control
comma
(paren
id|control
op_or
id|SCHIZO_STRBUF_CTRL_DENAB
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|128
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|val
suffix:semicolon
id|val
op_assign
id|schizo_read
c_func
(paren
id|err_base
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
)paren
suffix:semicolon
id|schizo_write
c_func
(paren
id|err_base
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
comma
l_int|0UL
)paren
suffix:semicolon
id|stc_error_buf
(braket
id|i
)braket
op_assign
id|val
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|stc_tag_buf
(braket
id|i
)braket
op_assign
id|schizo_read
c_func
(paren
id|tag_base
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
)paren
suffix:semicolon
id|stc_line_buf
(braket
id|i
)braket
op_assign
id|schizo_read
c_func
(paren
id|line_base
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
)paren
suffix:semicolon
id|schizo_write
c_func
(paren
id|tag_base
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
comma
l_int|0UL
)paren
suffix:semicolon
id|schizo_write
c_func
(paren
id|line_base
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
comma
l_int|0UL
)paren
suffix:semicolon
)brace
multiline_comment|/* OK, state is logged, exit diagnostic mode. */
id|schizo_write
c_func
(paren
id|strbuf-&gt;strbuf_control
comma
id|control
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|j
comma
id|saw_error
comma
id|first
comma
id|last
suffix:semicolon
id|saw_error
op_assign
l_int|0
suffix:semicolon
id|first
op_assign
id|i
op_star
l_int|8
suffix:semicolon
id|last
op_assign
id|first
op_plus
l_int|8
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
id|first
suffix:semicolon
id|j
OL
id|last
suffix:semicolon
id|j
op_increment
)paren
(brace
r_int
r_int
id|errval
op_assign
id|stc_error_buf
(braket
id|j
)braket
suffix:semicolon
r_if
c_cond
(paren
id|errval
op_ne
l_int|0
)paren
(brace
id|saw_error
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCHIZO%d: PBM-%c STC_ERR(%d)[wr(%d)rd(%d)]&bslash;n&quot;
comma
id|p-&gt;index
comma
id|pbm_name
comma
id|j
comma
(paren
id|errval
op_amp
id|SCHIZO_STCERR_WRITE
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
(paren
id|errval
op_amp
id|SCHIZO_STCERR_READ
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|saw_error
op_ne
l_int|0
)paren
(brace
r_int
r_int
id|tagval
op_assign
id|stc_tag_buf
(braket
id|i
)braket
suffix:semicolon
r_int
r_int
id|lineval
op_assign
id|stc_line_buf
(braket
id|i
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCHIZO%d: PBM-%c STC_TAG(%d)[PA(%016lx)VA(%08lx)V(%d)R(%d)]&bslash;n&quot;
comma
id|p-&gt;index
comma
id|pbm_name
comma
id|i
comma
(paren
(paren
id|tagval
op_amp
id|SCHIZO_STCTAG_PPN
)paren
op_rshift
l_int|19UL
)paren
comma
(paren
id|tagval
op_amp
id|SCHIZO_STCTAG_VPN
)paren
comma
(paren
(paren
id|tagval
op_amp
id|SCHIZO_STCTAG_VALID
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
comma
(paren
(paren
id|tagval
op_amp
id|SCHIZO_STCTAG_READ
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* XXX Should spit out per-bank error information... -DaveM */
id|printk
c_func
(paren
l_string|&quot;SCHIZO%d: PBM-%c STC_LINE(%d)[LIDX(%lx)SP(%lx)LADDR(%lx)EP(%lx)&quot;
l_string|&quot;V(%d)FOFN(%d)]&bslash;n&quot;
comma
id|p-&gt;index
comma
id|pbm_name
comma
id|i
comma
(paren
(paren
id|lineval
op_amp
id|SCHIZO_STCLINE_LINDX
)paren
op_rshift
l_int|23UL
)paren
comma
(paren
(paren
id|lineval
op_amp
id|SCHIZO_STCLINE_SPTR
)paren
op_rshift
l_int|13UL
)paren
comma
(paren
(paren
id|lineval
op_amp
id|SCHIZO_STCLINE_LADDR
)paren
op_rshift
l_int|6UL
)paren
comma
(paren
(paren
id|lineval
op_amp
id|SCHIZO_STCLINE_EPTR
)paren
op_rshift
l_int|0UL
)paren
comma
(paren
(paren
id|lineval
op_amp
id|SCHIZO_STCLINE_VALID
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
comma
(paren
(paren
id|lineval
op_amp
id|SCHIZO_STCLINE_FOFN
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|stc_buf_lock
)paren
suffix:semicolon
)brace
multiline_comment|/* IOMMU is per-PBM in Schizo, so interrogate both for anonymous&n; * controller level errors.&n; */
DECL|macro|SCHIZO_IOMMU_TAG
mdefine_line|#define SCHIZO_IOMMU_TAG&t;0xa580UL
DECL|macro|SCHIZO_IOMMU_DATA
mdefine_line|#define SCHIZO_IOMMU_DATA&t;0xa600UL
DECL|macro|SCHIZO_IOMMU_TAG_CTXT
mdefine_line|#define SCHIZO_IOMMU_TAG_CTXT&t;0x0000001ffe000000UL
DECL|macro|SCHIZO_IOMMU_TAG_ERRSTS
mdefine_line|#define SCHIZO_IOMMU_TAG_ERRSTS&t;0x0000000001800000UL
DECL|macro|SCHIZO_IOMMU_TAG_ERR
mdefine_line|#define SCHIZO_IOMMU_TAG_ERR&t;0x0000000000400000UL
DECL|macro|SCHIZO_IOMMU_TAG_WRITE
mdefine_line|#define SCHIZO_IOMMU_TAG_WRITE&t;0x0000000000200000UL
DECL|macro|SCHIZO_IOMMU_TAG_STREAM
mdefine_line|#define SCHIZO_IOMMU_TAG_STREAM&t;0x0000000000100000UL
DECL|macro|SCHIZO_IOMMU_TAG_SIZE
mdefine_line|#define SCHIZO_IOMMU_TAG_SIZE&t;0x0000000000080000UL
DECL|macro|SCHIZO_IOMMU_TAG_VPAGE
mdefine_line|#define SCHIZO_IOMMU_TAG_VPAGE&t;0x000000000007ffffUL
DECL|macro|SCHIZO_IOMMU_DATA_VALID
mdefine_line|#define SCHIZO_IOMMU_DATA_VALID&t;0x0000000100000000UL
DECL|macro|SCHIZO_IOMMU_DATA_CACHE
mdefine_line|#define SCHIZO_IOMMU_DATA_CACHE&t;0x0000000040000000UL
DECL|macro|SCHIZO_IOMMU_DATA_PPAGE
mdefine_line|#define SCHIZO_IOMMU_DATA_PPAGE&t;0x000000003fffffffUL
DECL|function|schizo_check_iommu_error_pbm
r_static
r_void
id|schizo_check_iommu_error_pbm
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_enum
id|schizo_error_type
id|type
)paren
(brace
r_struct
id|pci_controller_info
op_star
id|p
op_assign
id|pbm-&gt;parent
suffix:semicolon
r_struct
id|pci_iommu
op_star
id|iommu
op_assign
id|pbm-&gt;iommu
suffix:semicolon
r_int
r_int
id|iommu_tag
(braket
l_int|16
)braket
suffix:semicolon
r_int
r_int
id|iommu_data
(braket
l_int|16
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u64
id|control
suffix:semicolon
r_char
id|pbm_name
op_assign
(paren
id|pbm
op_eq
op_amp
id|p-&gt;pbm_A
ques
c_cond
l_char|&squot;A&squot;
suffix:colon
l_char|&squot;B&squot;
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|control
op_assign
id|schizo_read
c_func
(paren
id|iommu-&gt;iommu_control
)paren
suffix:semicolon
r_if
c_cond
(paren
id|control
op_amp
id|SCHIZO_IOMMU_CTRL_XLTEERR
)paren
(brace
r_int
r_int
id|base
suffix:semicolon
r_char
op_star
id|type_string
suffix:semicolon
multiline_comment|/* Clear the error encountered bit. */
id|control
op_and_assign
op_complement
id|SCHIZO_IOMMU_CTRL_XLTEERR
suffix:semicolon
id|schizo_write
c_func
(paren
id|iommu-&gt;iommu_control
comma
id|control
)paren
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|control
op_amp
id|SCHIZO_IOMMU_CTRL_XLTESTAT
)paren
op_rshift
l_int|25UL
)paren
(brace
r_case
l_int|0
suffix:colon
id|type_string
op_assign
l_string|&quot;Protection Error&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|type_string
op_assign
l_string|&quot;Invalid Error&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|type_string
op_assign
l_string|&quot;TimeOut Error&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
r_default
suffix:colon
id|type_string
op_assign
l_string|&quot;ECC Error&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCHIZO%d: PBM-%c IOMMU Error, type[%s]&bslash;n&quot;
comma
id|p-&gt;index
comma
id|pbm_name
comma
id|type_string
)paren
suffix:semicolon
multiline_comment|/* Put the IOMMU into diagnostic mode and probe&n;&t;&t; * it&squot;s TLB for entries with error status.&n;&t;&t; *&n;&t;&t; * It is very possible for another DVMA to occur&n;&t;&t; * while we do this probe, and corrupt the system&n;&t;&t; * further.  But we are so screwed at this point&n;&t;&t; * that we are likely to crash hard anyways, so&n;&t;&t; * get as much diagnostic information to the&n;&t;&t; * console as we can.&n;&t;&t; */
id|schizo_write
c_func
(paren
id|iommu-&gt;iommu_control
comma
id|control
op_or
id|SCHIZO_IOMMU_CTRL_DENAB
)paren
suffix:semicolon
id|base
op_assign
id|p-&gt;controller_regs
suffix:semicolon
r_if
c_cond
(paren
id|pbm
op_eq
op_amp
id|p-&gt;pbm_A
)paren
id|base
op_add_assign
id|SCHIZO_PBM_A_REGS_OFF
suffix:semicolon
r_else
id|base
op_add_assign
id|SCHIZO_PBM_B_REGS_OFF
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|iommu_tag
(braket
id|i
)braket
op_assign
id|schizo_read
c_func
(paren
id|base
op_plus
id|SCHIZO_IOMMU_TAG
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
)paren
suffix:semicolon
id|iommu_data
(braket
id|i
)braket
op_assign
id|schizo_read
c_func
(paren
id|base
op_plus
id|SCHIZO_IOMMU_DATA
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
)paren
suffix:semicolon
multiline_comment|/* Now clear out the entry. */
id|schizo_write
c_func
(paren
id|base
op_plus
id|SCHIZO_IOMMU_TAG
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
comma
l_int|0
)paren
suffix:semicolon
id|schizo_write
c_func
(paren
id|base
op_plus
id|SCHIZO_IOMMU_DATA
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Leave diagnostic mode. */
id|schizo_write
c_func
(paren
id|iommu-&gt;iommu_control
comma
id|control
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|tag
comma
id|data
suffix:semicolon
id|tag
op_assign
id|iommu_tag
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tag
op_amp
id|SCHIZO_IOMMU_TAG_ERR
)paren
)paren
r_continue
suffix:semicolon
id|data
op_assign
id|iommu_data
(braket
id|i
)braket
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|tag
op_amp
id|SCHIZO_IOMMU_TAG_ERRSTS
)paren
op_rshift
l_int|23UL
)paren
(brace
r_case
l_int|0
suffix:colon
id|type_string
op_assign
l_string|&quot;Protection Error&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|type_string
op_assign
l_string|&quot;Invalid Error&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|type_string
op_assign
l_string|&quot;TimeOut Error&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
r_default
suffix:colon
id|type_string
op_assign
l_string|&quot;ECC Error&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCHIZO%d: PBM-%c IOMMU TAG(%d)[error(%s) ctx(%x) wr(%d) str(%d) &quot;
l_string|&quot;sz(%dK) vpg(%08lx)]&bslash;n&quot;
comma
id|p-&gt;index
comma
id|pbm_name
comma
id|i
comma
id|type_string
comma
(paren
r_int
)paren
(paren
(paren
id|tag
op_amp
id|SCHIZO_IOMMU_TAG_CTXT
)paren
op_rshift
l_int|25UL
)paren
comma
(paren
(paren
id|tag
op_amp
id|SCHIZO_IOMMU_TAG_WRITE
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
comma
(paren
(paren
id|tag
op_amp
id|SCHIZO_IOMMU_TAG_STREAM
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
comma
(paren
(paren
id|tag
op_amp
id|SCHIZO_IOMMU_TAG_SIZE
)paren
ques
c_cond
l_int|64
suffix:colon
l_int|8
)paren
comma
(paren
id|tag
op_amp
id|SCHIZO_IOMMU_TAG_VPAGE
)paren
op_lshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCHIZO%d: PBM-%c IOMMU DATA(%d)[valid(%d) cache(%d) ppg(%016lx)]&bslash;n&quot;
comma
id|p-&gt;index
comma
id|pbm_name
comma
id|i
comma
(paren
(paren
id|data
op_amp
id|SCHIZO_IOMMU_DATA_VALID
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
comma
(paren
(paren
id|data
op_amp
id|SCHIZO_IOMMU_DATA_CACHE
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
comma
(paren
id|data
op_amp
id|SCHIZO_IOMMU_DATA_PPAGE
)paren
op_lshift
id|PAGE_SHIFT
)paren
suffix:semicolon
)brace
)brace
id|__schizo_check_stc_error_pbm
c_func
(paren
id|pbm
comma
id|type
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iommu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|schizo_check_iommu_error
r_static
r_void
id|schizo_check_iommu_error
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_enum
id|schizo_error_type
id|type
)paren
(brace
id|schizo_check_iommu_error_pbm
c_func
(paren
op_amp
id|p-&gt;pbm_A
comma
id|type
)paren
suffix:semicolon
id|schizo_check_iommu_error_pbm
c_func
(paren
op_amp
id|p-&gt;pbm_B
comma
id|type
)paren
suffix:semicolon
)brace
multiline_comment|/* Uncorrectable ECC error status gathering. */
DECL|macro|SCHIZO_UE_AFSR
mdefine_line|#define SCHIZO_UE_AFSR&t;0x10030UL
DECL|macro|SCHIZO_UE_AFAR
mdefine_line|#define SCHIZO_UE_AFAR&t;0x10038UL
DECL|macro|SCHIZO_UEAFSR_PPIO
mdefine_line|#define SCHIZO_UEAFSR_PPIO&t;0x8000000000000000UL
DECL|macro|SCHIZO_UEAFSR_PDRD
mdefine_line|#define SCHIZO_UEAFSR_PDRD&t;0x4000000000000000UL
DECL|macro|SCHIZO_UEAFSR_PDWR
mdefine_line|#define SCHIZO_UEAFSR_PDWR&t;0x2000000000000000UL
DECL|macro|SCHIZO_UEAFSR_SPIO
mdefine_line|#define SCHIZO_UEAFSR_SPIO&t;0x1000000000000000UL
DECL|macro|SCHIZO_UEAFSR_SDMA
mdefine_line|#define SCHIZO_UEAFSR_SDMA&t;0x0800000000000000UL
DECL|macro|SCHIZO_UEAFSR_ERRPNDG
mdefine_line|#define SCHIZO_UEAFSR_ERRPNDG&t;0x0300000000000000UL
DECL|macro|SCHIZO_UEAFSR_BMSK
mdefine_line|#define SCHIZO_UEAFSR_BMSK&t;0x000003ff00000000UL
DECL|macro|SCHIZO_UEAFSR_QOFF
mdefine_line|#define SCHIZO_UEAFSR_QOFF&t;0x00000000c0000000UL
DECL|macro|SCHIZO_UEAFSR_AID
mdefine_line|#define SCHIZO_UEAFSR_AID&t;0x000000001f000000UL
DECL|macro|SCHIZO_UEAFSR_PARTIAL
mdefine_line|#define SCHIZO_UEAFSR_PARTIAL&t;0x0000000000800000UL
DECL|macro|SCHIZO_UEAFSR_OWNEDIN
mdefine_line|#define SCHIZO_UEAFSR_OWNEDIN&t;0x0000000000400000UL
DECL|macro|SCHIZO_UEAFSR_MTAGSYND
mdefine_line|#define SCHIZO_UEAFSR_MTAGSYND&t;0x00000000000f0000UL
DECL|macro|SCHIZO_UEAFSR_MTAG
mdefine_line|#define SCHIZO_UEAFSR_MTAG&t;0x000000000000e000UL
DECL|macro|SCHIZO_UEAFSR_ECCSYND
mdefine_line|#define SCHIZO_UEAFSR_ECCSYND&t;0x00000000000001ffUL
DECL|function|schizo_ue_intr
r_static
r_void
id|schizo_ue_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|pci_controller_info
op_star
id|p
op_assign
id|dev_id
suffix:semicolon
r_int
r_int
id|afsr_reg
op_assign
id|p-&gt;controller_regs
op_plus
id|SCHIZO_UE_AFSR
suffix:semicolon
r_int
r_int
id|afar_reg
op_assign
id|p-&gt;controller_regs
op_plus
id|SCHIZO_UE_AFAR
suffix:semicolon
r_int
r_int
id|afsr
comma
id|afar
comma
id|error_bits
suffix:semicolon
r_int
id|reported
comma
id|limit
suffix:semicolon
multiline_comment|/* Latch uncorrectable error status. */
id|afar
op_assign
id|schizo_read
c_func
(paren
id|afar_reg
)paren
suffix:semicolon
multiline_comment|/* If either of the error pending bits are set in the&n;&t; * AFSR, the error status is being actively updated by&n;&t; * the hardware and we must re-read to get a clean value.&n;&t; */
id|limit
op_assign
l_int|1000
suffix:semicolon
r_do
(brace
id|afsr
op_assign
id|schizo_read
c_func
(paren
id|afsr_reg
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|afsr
op_amp
id|SCHIZO_UEAFSR_ERRPNDG
)paren
op_ne
l_int|0
op_logical_and
op_decrement
id|limit
)paren
suffix:semicolon
multiline_comment|/* Clear the primary/secondary error status bits. */
id|error_bits
op_assign
id|afsr
op_amp
(paren
id|SCHIZO_UEAFSR_PPIO
op_or
id|SCHIZO_UEAFSR_PDRD
op_or
id|SCHIZO_UEAFSR_PDWR
op_or
id|SCHIZO_UEAFSR_SPIO
op_or
id|SCHIZO_UEAFSR_SDMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error_bits
)paren
r_return
suffix:semicolon
id|schizo_write
c_func
(paren
id|afsr_reg
comma
id|error_bits
)paren
suffix:semicolon
multiline_comment|/* Log the error. */
id|printk
c_func
(paren
l_string|&quot;SCHIZO%d: Uncorrectable Error, primary error type[%s]&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
(paren
(paren
id|error_bits
op_amp
id|SCHIZO_UEAFSR_PPIO
)paren
ques
c_cond
l_string|&quot;PIO&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|SCHIZO_UEAFSR_PDRD
)paren
ques
c_cond
l_string|&quot;DMA Read&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|SCHIZO_UEAFSR_PDWR
)paren
ques
c_cond
l_string|&quot;DMA Write&quot;
suffix:colon
l_string|&quot;???&quot;
)paren
)paren
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCHIZO%d: bytemask[%04lx] qword_offset[%lx] SAFARI_AID[%02lx]&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
id|afsr
op_amp
id|SCHIZO_UEAFSR_BMSK
)paren
op_rshift
l_int|32UL
comma
(paren
id|afsr
op_amp
id|SCHIZO_UEAFSR_QOFF
)paren
op_rshift
l_int|30UL
comma
(paren
id|afsr
op_amp
id|SCHIZO_UEAFSR_AID
)paren
op_rshift
l_int|24UL
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCHIZO%d: partial[%d] owned_in[%d] mtag[%lx] mtag_synd[%lx] ecc_sync[%lx]&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
id|afsr
op_amp
id|SCHIZO_UEAFSR_PARTIAL
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
(paren
id|afsr
op_amp
id|SCHIZO_UEAFSR_OWNEDIN
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
(paren
id|afsr
op_amp
id|SCHIZO_UEAFSR_MTAG
)paren
op_rshift
l_int|13UL
comma
(paren
id|afsr
op_amp
id|SCHIZO_UEAFSR_MTAGSYND
)paren
op_rshift
l_int|16UL
comma
(paren
id|afsr
op_amp
id|SCHIZO_UEAFSR_ECCSYND
)paren
op_rshift
l_int|0UL
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCHIZO%d: UE AFAR [%016lx]&bslash;n&quot;
comma
id|p-&gt;index
comma
id|afar
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCHIZO%d: UE Secondary errors [&quot;
comma
id|p-&gt;index
)paren
suffix:semicolon
id|reported
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|afsr
op_amp
id|SCHIZO_UEAFSR_SPIO
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(PIO)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|SCHIZO_UEAFSR_SDMA
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(DMA)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|reported
)paren
id|printk
c_func
(paren
l_string|&quot;(none)&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;]&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Interrogate IOMMU for error status. */
id|schizo_check_iommu_error
c_func
(paren
id|p
comma
id|UE_ERR
)paren
suffix:semicolon
id|schizo_clear_other_err_intr
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|macro|SCHIZO_CE_AFSR
mdefine_line|#define SCHIZO_CE_AFSR&t;0x10040UL
DECL|macro|SCHIZO_CE_AFAR
mdefine_line|#define SCHIZO_CE_AFAR&t;0x10048UL
DECL|macro|SCHIZO_CEAFSR_PPIO
mdefine_line|#define SCHIZO_CEAFSR_PPIO&t;0x8000000000000000UL
DECL|macro|SCHIZO_CEAFSR_PDRD
mdefine_line|#define SCHIZO_CEAFSR_PDRD&t;0x4000000000000000UL
DECL|macro|SCHIZO_CEAFSR_PDWR
mdefine_line|#define SCHIZO_CEAFSR_PDWR&t;0x2000000000000000UL
DECL|macro|SCHIZO_CEAFSR_SPIO
mdefine_line|#define SCHIZO_CEAFSR_SPIO&t;0x1000000000000000UL
DECL|macro|SCHIZO_CEAFSR_SDMA
mdefine_line|#define SCHIZO_CEAFSR_SDMA&t;0x0800000000000000UL
DECL|macro|SCHIZO_CEAFSR_ERRPNDG
mdefine_line|#define SCHIZO_CEAFSR_ERRPNDG&t;0x0300000000000000UL
DECL|macro|SCHIZO_CEAFSR_BMSK
mdefine_line|#define SCHIZO_CEAFSR_BMSK&t;0x000003ff00000000UL
DECL|macro|SCHIZO_CEAFSR_QOFF
mdefine_line|#define SCHIZO_CEAFSR_QOFF&t;0x00000000c0000000UL
DECL|macro|SCHIZO_CEAFSR_AID
mdefine_line|#define SCHIZO_CEAFSR_AID&t;0x000000001f000000UL
DECL|macro|SCHIZO_CEAFSR_PARTIAL
mdefine_line|#define SCHIZO_CEAFSR_PARTIAL&t;0x0000000000800000UL
DECL|macro|SCHIZO_CEAFSR_OWNEDIN
mdefine_line|#define SCHIZO_CEAFSR_OWNEDIN&t;0x0000000000400000UL
DECL|macro|SCHIZO_CEAFSR_MTAGSYND
mdefine_line|#define SCHIZO_CEAFSR_MTAGSYND&t;0x00000000000f0000UL
DECL|macro|SCHIZO_CEAFSR_MTAG
mdefine_line|#define SCHIZO_CEAFSR_MTAG&t;0x000000000000e000UL
DECL|macro|SCHIZO_CEAFSR_ECCSYND
mdefine_line|#define SCHIZO_CEAFSR_ECCSYND&t;0x00000000000001ffUL
DECL|function|schizo_ce_intr
r_static
r_void
id|schizo_ce_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|pci_controller_info
op_star
id|p
op_assign
id|dev_id
suffix:semicolon
r_int
r_int
id|afsr_reg
op_assign
id|p-&gt;controller_regs
op_plus
id|SCHIZO_CE_AFSR
suffix:semicolon
r_int
r_int
id|afar_reg
op_assign
id|p-&gt;controller_regs
op_plus
id|SCHIZO_CE_AFAR
suffix:semicolon
r_int
r_int
id|afsr
comma
id|afar
comma
id|error_bits
suffix:semicolon
r_int
id|reported
comma
id|limit
suffix:semicolon
multiline_comment|/* Latch error status. */
id|afar
op_assign
id|schizo_read
c_func
(paren
id|afar_reg
)paren
suffix:semicolon
multiline_comment|/* If either of the error pending bits are set in the&n;&t; * AFSR, the error status is being actively updated by&n;&t; * the hardware and we must re-read to get a clean value.&n;&t; */
id|limit
op_assign
l_int|1000
suffix:semicolon
r_do
(brace
id|afsr
op_assign
id|schizo_read
c_func
(paren
id|afsr_reg
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|afsr
op_amp
id|SCHIZO_UEAFSR_ERRPNDG
)paren
op_ne
l_int|0
op_logical_and
op_decrement
id|limit
)paren
suffix:semicolon
multiline_comment|/* Clear primary/secondary error status bits. */
id|error_bits
op_assign
id|afsr
op_amp
(paren
id|SCHIZO_CEAFSR_PPIO
op_or
id|SCHIZO_CEAFSR_PDRD
op_or
id|SCHIZO_CEAFSR_PDWR
op_or
id|SCHIZO_CEAFSR_SPIO
op_or
id|SCHIZO_CEAFSR_SDMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error_bits
)paren
r_return
suffix:semicolon
id|schizo_write
c_func
(paren
id|afsr_reg
comma
id|error_bits
)paren
suffix:semicolon
multiline_comment|/* Log the error. */
id|printk
c_func
(paren
l_string|&quot;SCHIZO%d: Correctable Error, primary error type[%s]&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
(paren
(paren
id|error_bits
op_amp
id|SCHIZO_CEAFSR_PPIO
)paren
ques
c_cond
l_string|&quot;PIO&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|SCHIZO_CEAFSR_PDRD
)paren
ques
c_cond
l_string|&quot;DMA Read&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|SCHIZO_CEAFSR_PDWR
)paren
ques
c_cond
l_string|&quot;DMA Write&quot;
suffix:colon
l_string|&quot;???&quot;
)paren
)paren
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* XXX Use syndrome and afar to print out module string just like&n;&t; * XXX UDB CE trap handler does... -DaveM&n;&t; */
id|printk
c_func
(paren
l_string|&quot;SCHIZO%d: bytemask[%04lx] qword_offset[%lx] SAFARI_AID[%02lx]&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
id|afsr
op_amp
id|SCHIZO_UEAFSR_BMSK
)paren
op_rshift
l_int|32UL
comma
(paren
id|afsr
op_amp
id|SCHIZO_UEAFSR_QOFF
)paren
op_rshift
l_int|30UL
comma
(paren
id|afsr
op_amp
id|SCHIZO_UEAFSR_AID
)paren
op_rshift
l_int|24UL
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCHIZO%d: partial[%d] owned_in[%d] mtag[%lx] mtag_synd[%lx] ecc_sync[%lx]&bslash;n&quot;
comma
id|p-&gt;index
comma
(paren
id|afsr
op_amp
id|SCHIZO_UEAFSR_PARTIAL
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
(paren
id|afsr
op_amp
id|SCHIZO_UEAFSR_OWNEDIN
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
(paren
id|afsr
op_amp
id|SCHIZO_UEAFSR_MTAG
)paren
op_rshift
l_int|13UL
comma
(paren
id|afsr
op_amp
id|SCHIZO_UEAFSR_MTAGSYND
)paren
op_rshift
l_int|16UL
comma
(paren
id|afsr
op_amp
id|SCHIZO_UEAFSR_ECCSYND
)paren
op_rshift
l_int|0UL
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCHIZO%d: CE AFAR [%016lx]&bslash;n&quot;
comma
id|p-&gt;index
comma
id|afar
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCHIZO%d: CE Secondary errors [&quot;
comma
id|p-&gt;index
)paren
suffix:semicolon
id|reported
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|afsr
op_amp
id|SCHIZO_CEAFSR_SPIO
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(PIO)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|SCHIZO_CEAFSR_SDMA
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(DMA)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|reported
)paren
id|printk
c_func
(paren
l_string|&quot;(none)&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;]&bslash;n&quot;
)paren
suffix:semicolon
id|schizo_clear_other_err_intr
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|macro|SCHIZO_PCI_AFSR
mdefine_line|#define SCHIZO_PCI_AFSR&t;0x2010UL
DECL|macro|SCHIZO_PCI_AFAR
mdefine_line|#define SCHIZO_PCI_AFAR&t;0x2018UL
DECL|macro|SCHIZO_PCIAFSR_PMA
mdefine_line|#define SCHIZO_PCIAFSR_PMA&t;0x8000000000000000UL
DECL|macro|SCHIZO_PCIAFSR_PTA
mdefine_line|#define SCHIZO_PCIAFSR_PTA&t;0x4000000000000000UL
DECL|macro|SCHIZO_PCIAFSR_PRTRY
mdefine_line|#define SCHIZO_PCIAFSR_PRTRY&t;0x2000000000000000UL
DECL|macro|SCHIZO_PCIAFSR_PPERR
mdefine_line|#define SCHIZO_PCIAFSR_PPERR&t;0x1000000000000000UL
DECL|macro|SCHIZO_PCIAFSR_PTTO
mdefine_line|#define SCHIZO_PCIAFSR_PTTO&t;0x0800000000000000UL
DECL|macro|SCHIZO_PCIAFSR_PUNUS
mdefine_line|#define SCHIZO_PCIAFSR_PUNUS&t;0x0400000000000000UL
DECL|macro|SCHIZO_PCIAFSR_SMA
mdefine_line|#define SCHIZO_PCIAFSR_SMA&t;0x0200000000000000UL
DECL|macro|SCHIZO_PCIAFSR_STA
mdefine_line|#define SCHIZO_PCIAFSR_STA&t;0x0100000000000000UL
DECL|macro|SCHIZO_PCIAFSR_SRTRY
mdefine_line|#define SCHIZO_PCIAFSR_SRTRY&t;0x0080000000000000UL
DECL|macro|SCHIZO_PCIAFSR_SPERR
mdefine_line|#define SCHIZO_PCIAFSR_SPERR&t;0x0040000000000000UL
DECL|macro|SCHIZO_PCIAFSR_STTO
mdefine_line|#define SCHIZO_PCIAFSR_STTO&t;0x0020000000000000UL
DECL|macro|SCHIZO_PCIAFSR_SUNUS
mdefine_line|#define SCHIZO_PCIAFSR_SUNUS&t;0x0010000000000000UL
DECL|macro|SCHIZO_PCIAFSR_BMSK
mdefine_line|#define SCHIZO_PCIAFSR_BMSK&t;0x000003ff00000000UL
DECL|macro|SCHIZO_PCIAFSR_BLK
mdefine_line|#define SCHIZO_PCIAFSR_BLK&t;0x0000000080000000UL
DECL|macro|SCHIZO_PCIAFSR_CFG
mdefine_line|#define SCHIZO_PCIAFSR_CFG&t;0x0000000040000000UL
DECL|macro|SCHIZO_PCIAFSR_MEM
mdefine_line|#define SCHIZO_PCIAFSR_MEM&t;0x0000000020000000UL
DECL|macro|SCHIZO_PCIAFSR_IO
mdefine_line|#define SCHIZO_PCIAFSR_IO&t;0x0000000010000000UL
DECL|function|schizo_pcierr_intr
r_static
r_void
id|schizo_pcierr_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|dev_id
suffix:semicolon
r_struct
id|pci_controller_info
op_star
id|p
op_assign
id|pbm-&gt;parent
suffix:semicolon
r_int
r_int
id|afsr_reg
comma
id|afar_reg
comma
id|base
suffix:semicolon
r_int
r_int
id|afsr
comma
id|afar
comma
id|error_bits
suffix:semicolon
r_int
id|reported
suffix:semicolon
r_char
id|pbm_name
suffix:semicolon
id|base
op_assign
id|p-&gt;controller_regs
suffix:semicolon
r_if
c_cond
(paren
id|pbm
op_eq
op_amp
id|pbm-&gt;parent-&gt;pbm_A
)paren
(brace
id|base
op_add_assign
id|SCHIZO_PBM_A_REGS_OFF
suffix:semicolon
id|pbm_name
op_assign
l_char|&squot;A&squot;
suffix:semicolon
)brace
r_else
(brace
id|base
op_add_assign
id|SCHIZO_PBM_B_REGS_OFF
suffix:semicolon
id|pbm_name
op_assign
l_char|&squot;B&squot;
suffix:semicolon
)brace
id|afsr_reg
op_assign
id|base
op_plus
id|SCHIZO_PCI_AFSR
suffix:semicolon
id|afar_reg
op_assign
id|base
op_plus
id|SCHIZO_PCI_AFAR
suffix:semicolon
multiline_comment|/* Latch error status. */
id|afar
op_assign
id|schizo_read
c_func
(paren
id|afar_reg
)paren
suffix:semicolon
id|afsr
op_assign
id|schizo_read
c_func
(paren
id|afsr_reg
)paren
suffix:semicolon
multiline_comment|/* Clear primary/secondary error status bits. */
id|error_bits
op_assign
id|afsr
op_amp
(paren
id|SCHIZO_PCIAFSR_PMA
op_or
id|SCHIZO_PCIAFSR_PTA
op_or
id|SCHIZO_PCIAFSR_PRTRY
op_or
id|SCHIZO_PCIAFSR_PPERR
op_or
id|SCHIZO_PCIAFSR_PTTO
op_or
id|SCHIZO_PCIAFSR_PUNUS
op_or
id|SCHIZO_PCIAFSR_SMA
op_or
id|SCHIZO_PCIAFSR_STA
op_or
id|SCHIZO_PCIAFSR_SRTRY
op_or
id|SCHIZO_PCIAFSR_SPERR
op_or
id|SCHIZO_PCIAFSR_STTO
op_or
id|SCHIZO_PCIAFSR_SUNUS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error_bits
)paren
r_return
suffix:semicolon
id|schizo_write
c_func
(paren
id|afsr_reg
comma
id|error_bits
)paren
suffix:semicolon
multiline_comment|/* Log the error. */
id|printk
c_func
(paren
l_string|&quot;SCHIZO%d: PBM-%c PCI Error, primary error type[%s]&bslash;n&quot;
comma
id|p-&gt;index
comma
id|pbm_name
comma
(paren
(paren
(paren
id|error_bits
op_amp
id|SCHIZO_PCIAFSR_PMA
)paren
ques
c_cond
l_string|&quot;Master Abort&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|SCHIZO_PCIAFSR_PTA
)paren
ques
c_cond
l_string|&quot;Target Abort&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|SCHIZO_PCIAFSR_PRTRY
)paren
ques
c_cond
l_string|&quot;Excessive Retries&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|SCHIZO_PCIAFSR_PPERR
)paren
ques
c_cond
l_string|&quot;Parity Error&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|SCHIZO_PCIAFSR_PTTO
)paren
ques
c_cond
l_string|&quot;Timeout&quot;
suffix:colon
(paren
(paren
id|error_bits
op_amp
id|SCHIZO_PCIAFSR_PUNUS
)paren
ques
c_cond
l_string|&quot;Bus Unusable&quot;
suffix:colon
l_string|&quot;???&quot;
)paren
)paren
)paren
)paren
)paren
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCHIZO%d: PBM-%c bytemask[%04lx] was_block(%d) space(%s)&bslash;n&quot;
comma
id|p-&gt;index
comma
id|pbm_name
comma
(paren
id|afsr
op_amp
id|SCHIZO_PCIAFSR_BMSK
)paren
op_rshift
l_int|32UL
comma
(paren
id|afsr
op_amp
id|SCHIZO_PCIAFSR_BLK
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
(paren
(paren
id|afsr
op_amp
id|SCHIZO_PCIAFSR_CFG
)paren
ques
c_cond
l_string|&quot;Config&quot;
suffix:colon
(paren
(paren
id|afsr
op_amp
id|SCHIZO_PCIAFSR_MEM
)paren
ques
c_cond
l_string|&quot;Memory&quot;
suffix:colon
(paren
(paren
id|afsr
op_amp
id|SCHIZO_PCIAFSR_IO
)paren
ques
c_cond
l_string|&quot;I/O&quot;
suffix:colon
l_string|&quot;???&quot;
)paren
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCHIZO%d: PBM-%c PCI AFAR [%016lx]&bslash;n&quot;
comma
id|p-&gt;index
comma
id|pbm_name
comma
id|afar
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCHIZO%d: PBM-%c PCI Secondary errors [&quot;
comma
id|p-&gt;index
comma
id|pbm_name
)paren
suffix:semicolon
id|reported
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|afsr
op_amp
id|SCHIZO_PCIAFSR_SMA
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(Master Abort)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|SCHIZO_PCIAFSR_STA
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(Target Abort)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|SCHIZO_PCIAFSR_SRTRY
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(Excessive Retries)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|SCHIZO_PCIAFSR_SPERR
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(Parity Error)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|SCHIZO_PCIAFSR_STTO
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(Timeout)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|afsr
op_amp
id|SCHIZO_PCIAFSR_SUNUS
)paren
(brace
id|reported
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(Bus Unusable)&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|reported
)paren
id|printk
c_func
(paren
l_string|&quot;(none)&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;]&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* For the error types shown, scan PBM&squot;s PCI bus for devices&n;&t; * which have logged that error type.&n;&t; */
multiline_comment|/* If we see a Target Abort, this could be the result of an&n;&t; * IOMMU translation error of some sort.  It is extremely&n;&t; * useful to log this information as usually it indicates&n;&t; * a bug in the IOMMU support code or a PCI device driver.&n;&t; */
r_if
c_cond
(paren
id|error_bits
op_amp
(paren
id|SCHIZO_PCIAFSR_PTA
op_or
id|SCHIZO_PCIAFSR_STA
)paren
)paren
(brace
id|schizo_check_iommu_error
c_func
(paren
id|p
comma
id|PCI_ERR
)paren
suffix:semicolon
id|pci_scan_for_target_abort
c_func
(paren
id|p
comma
id|pbm
comma
id|pbm-&gt;pci_bus
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error_bits
op_amp
(paren
id|SCHIZO_PCIAFSR_PMA
op_or
id|SCHIZO_PCIAFSR_SMA
)paren
)paren
id|pci_scan_for_master_abort
c_func
(paren
id|p
comma
id|pbm
comma
id|pbm-&gt;pci_bus
)paren
suffix:semicolon
multiline_comment|/* For excessive retries, PSYCHO/PBM will abort the device&n;&t; * and there is no way to specifically check for excessive&n;&t; * retries in the config space status registers.  So what&n;&t; * we hope is that we&squot;ll catch it via the master/target&n;&t; * abort events.&n;&t; */
r_if
c_cond
(paren
id|error_bits
op_amp
(paren
id|SCHIZO_PCIAFSR_PPERR
op_or
id|SCHIZO_PCIAFSR_SPERR
)paren
)paren
id|pci_scan_for_parity_error
c_func
(paren
id|p
comma
id|pbm
comma
id|pbm-&gt;pci_bus
)paren
suffix:semicolon
id|schizo_clear_other_err_intr
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|macro|SCHIZO_SAFARI_ERRLOG
mdefine_line|#define SCHIZO_SAFARI_ERRLOG&t;0x10018UL
DECL|macro|SAFARI_ERRLOG_ERROUT
mdefine_line|#define SAFARI_ERRLOG_ERROUT&t;0x8000000000000000UL
DECL|macro|SAFARI_ERROR_BADCMD
mdefine_line|#define SAFARI_ERROR_BADCMD&t;0x4000000000000000UL
DECL|macro|SAFARI_ERROR_SSMDIS
mdefine_line|#define SAFARI_ERROR_SSMDIS&t;0x2000000000000000UL
DECL|macro|SAFARI_ERROR_BADMA
mdefine_line|#define SAFARI_ERROR_BADMA&t;0x1000000000000000UL
DECL|macro|SAFARI_ERROR_BADMB
mdefine_line|#define SAFARI_ERROR_BADMB&t;0x0800000000000000UL
DECL|macro|SAFARI_ERROR_BADMC
mdefine_line|#define SAFARI_ERROR_BADMC&t;0x0400000000000000UL
DECL|macro|SAFARI_ERROR_CPU1PS
mdefine_line|#define SAFARI_ERROR_CPU1PS&t;0x0000000000002000UL
DECL|macro|SAFARI_ERROR_CPU1PB
mdefine_line|#define SAFARI_ERROR_CPU1PB&t;0x0000000000001000UL
DECL|macro|SAFARI_ERROR_CPU0PS
mdefine_line|#define SAFARI_ERROR_CPU0PS&t;0x0000000000000800UL
DECL|macro|SAFARI_ERROR_CPU0PB
mdefine_line|#define SAFARI_ERROR_CPU0PB&t;0x0000000000000400UL
DECL|macro|SAFARI_ERROR_CIQTO
mdefine_line|#define SAFARI_ERROR_CIQTO&t;0x0000000000000200UL
DECL|macro|SAFARI_ERROR_LPQTO
mdefine_line|#define SAFARI_ERROR_LPQTO&t;0x0000000000000100UL
DECL|macro|SAFARI_ERROR_SFPQTO
mdefine_line|#define SAFARI_ERROR_SFPQTO&t;0x0000000000000080UL
DECL|macro|SAFARI_ERROR_UFPQTO
mdefine_line|#define SAFARI_ERROR_UFPQTO&t;0x0000000000000040UL
DECL|macro|SAFARI_ERROR_APERR
mdefine_line|#define SAFARI_ERROR_APERR&t;0x0000000000000020UL
DECL|macro|SAFARI_ERROR_UNMAP
mdefine_line|#define SAFARI_ERROR_UNMAP&t;0x0000000000000010UL
DECL|macro|SAFARI_ERROR_BUSERR
mdefine_line|#define SAFARI_ERROR_BUSERR&t;0x0000000000000004UL
DECL|macro|SAFARI_ERROR_TIMEOUT
mdefine_line|#define SAFARI_ERROR_TIMEOUT&t;0x0000000000000002UL
DECL|macro|SAFARI_ERROR_ILL
mdefine_line|#define SAFARI_ERROR_ILL&t;0x0000000000000001UL
multiline_comment|/* We only expect UNMAP errors here.  The rest of the Safari errors&n; * are marked fatal and thus cause a system reset.&n; */
DECL|function|schizo_safarierr_intr
r_static
r_void
id|schizo_safarierr_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|pci_controller_info
op_star
id|p
op_assign
id|dev_id
suffix:semicolon
id|u64
id|errlog
suffix:semicolon
id|errlog
op_assign
id|schizo_read
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|SCHIZO_SAFARI_ERRLOG
)paren
suffix:semicolon
id|schizo_write
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|SCHIZO_SAFARI_ERRLOG
comma
id|errlog
op_amp
op_complement
(paren
id|SAFARI_ERRLOG_ERROUT
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|errlog
op_amp
id|SAFARI_ERROR_UNMAP
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SCHIZO%d: Unexpected Safari error interrupt, errlog[%016lx]&bslash;n&quot;
comma
id|p-&gt;index
comma
id|errlog
)paren
suffix:semicolon
id|schizo_clear_other_err_intr
c_func
(paren
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;SCHIZO%d: Safari interrupt, UNMAPPED error, interrogating IOMMUs.&bslash;n&quot;
comma
id|p-&gt;index
)paren
suffix:semicolon
id|schizo_check_iommu_error
c_func
(paren
id|p
comma
id|SAFARI_ERR
)paren
suffix:semicolon
id|schizo_clear_other_err_intr
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
multiline_comment|/* Nearly identical to PSYCHO equivalents... */
DECL|macro|SCHIZO_ECC_CTRL
mdefine_line|#define SCHIZO_ECC_CTRL&t;&t;0x10020UL
DECL|macro|SCHIZO_ECCCTRL_EE
mdefine_line|#define  SCHIZO_ECCCTRL_EE&t; 0x8000000000000000 /* Enable ECC Checking */
DECL|macro|SCHIZO_ECCCTRL_UE
mdefine_line|#define  SCHIZO_ECCCTRL_UE&t; 0x4000000000000000 /* Enable UE Interrupts */
DECL|macro|SCHIZO_ECCCTRL_CE
mdefine_line|#define  SCHIZO_ECCCTRL_CE&t; 0x2000000000000000 /* Enable CE INterrupts */
DECL|macro|SCHIZO_SAFARI_ERRCTRL
mdefine_line|#define SCHIZO_SAFARI_ERRCTRL&t;0x10008UL
DECL|macro|SCHIZO_SAFERRCTRL_EN
mdefine_line|#define  SCHIZO_SAFERRCTRL_EN&t; 0x8000000000000000UL
DECL|macro|SCHIZO_SAFARI_IRQCTRL
mdefine_line|#define SCHIZO_SAFARI_IRQCTRL&t;0x10010UL
DECL|macro|SCHIZO_SAFIRQCTRL_EN
mdefine_line|#define  SCHIZO_SAFIRQCTRL_EN&t; 0x8000000000000000UL
DECL|macro|SCHIZO_UE_INO
mdefine_line|#define SCHIZO_UE_INO&t;&t;0x30 /* Uncorrectable ECC error */
DECL|macro|SCHIZO_CE_INO
mdefine_line|#define SCHIZO_CE_INO&t;&t;0x31 /* Correctable ECC error */
DECL|macro|SCHIZO_PCIERR_A_INO
mdefine_line|#define SCHIZO_PCIERR_A_INO&t;0x32 /* PBM A PCI bus error */
DECL|macro|SCHIZO_PCIERR_B_INO
mdefine_line|#define SCHIZO_PCIERR_B_INO&t;0x33 /* PBM B PCI bus error */
DECL|macro|SCHIZO_SERR_INO
mdefine_line|#define SCHIZO_SERR_INO&t;&t;0x34 /* Safari interface error */
DECL|macro|SCHIZO_PCIA_CTRL
mdefine_line|#define SCHIZO_PCIA_CTRL&t;(SCHIZO_PBM_A_REGS_OFF + 0x2000UL)
DECL|macro|SCHIZO_PCIB_CTRL
mdefine_line|#define SCHIZO_PCIB_CTRL&t;(SCHIZO_PBM_B_REGS_OFF + 0x2000UL)
DECL|macro|SCHIZO_PCICTRL_BUNUS
mdefine_line|#define SCHIZO_PCICTRL_BUNUS&t;(1UL &lt;&lt; 63UL)
DECL|macro|SCHIZO_PCICTRL_ESLCK
mdefine_line|#define SCHIZO_PCICTRL_ESLCK&t;(1UL &lt;&lt; 51UL)
DECL|macro|SCHIZO_PCICTRL_TTO_ERR
mdefine_line|#define SCHIZO_PCICTRL_TTO_ERR&t;(1UL &lt;&lt; 38UL)
DECL|macro|SCHIZO_PCICTRL_RTRY_ERR
mdefine_line|#define SCHIZO_PCICTRL_RTRY_ERR&t;(1UL &lt;&lt; 37UL)
DECL|macro|SCHIZO_PCICTRL_DTO_ERR
mdefine_line|#define SCHIZO_PCICTRL_DTO_ERR&t;(1UL &lt;&lt; 36UL)
DECL|macro|SCHIZO_PCICTRL_SBH_ERR
mdefine_line|#define SCHIZO_PCICTRL_SBH_ERR&t;(1UL &lt;&lt; 35UL)
DECL|macro|SCHIZO_PCICTRL_SERR
mdefine_line|#define SCHIZO_PCICTRL_SERR&t;(1UL &lt;&lt; 34UL)
DECL|macro|SCHIZO_PCICTRL_SBH_INT
mdefine_line|#define SCHIZO_PCICTRL_SBH_INT&t;(1UL &lt;&lt; 18UL)
DECL|macro|SCHIZO_PCICTRL_EEN
mdefine_line|#define SCHIZO_PCICTRL_EEN&t;(1UL &lt;&lt; 17UL)
DECL|function|schizo_register_error_handlers
r_static
r_void
id|__init
id|schizo_register_error_handlers
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm_a
op_assign
op_amp
id|p-&gt;pbm_A
suffix:semicolon
r_struct
id|pci_pbm_info
op_star
id|pbm_b
op_assign
op_amp
id|p-&gt;pbm_B
suffix:semicolon
r_int
r_int
id|base
op_assign
id|p-&gt;controller_regs
suffix:semicolon
r_int
r_int
id|irq
comma
id|portid
op_assign
id|p-&gt;portid
suffix:semicolon
r_struct
id|ino_bucket
op_star
id|bucket
suffix:semicolon
id|u64
id|tmp
suffix:semicolon
multiline_comment|/* Build IRQs and register handlers. */
id|irq
op_assign
id|schizo_irq_build
c_func
(paren
id|pbm_a
comma
l_int|NULL
comma
(paren
id|portid
op_lshift
l_int|6
)paren
op_or
id|SCHIZO_UE_INO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|schizo_ue_intr
comma
id|SA_SHIRQ
comma
l_string|&quot;SCHIZO UE&quot;
comma
id|p
)paren
OL
l_int|0
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SCHIZO%d: Cannot register UE interrupt.&bslash;n&quot;
comma
id|p-&gt;index
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|bucket
op_assign
id|__bucket
c_func
(paren
id|irq
)paren
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
id|bucket-&gt;imap
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|tmp
comma
(paren
id|base
op_plus
id|SCHIZO_PBM_B_REGS_OFF
op_plus
id|schizo_imap_offset
c_func
(paren
id|SCHIZO_UE_INO
)paren
op_plus
l_int|4
)paren
)paren
suffix:semicolon
id|irq
op_assign
id|schizo_irq_build
c_func
(paren
id|pbm_a
comma
l_int|NULL
comma
(paren
id|portid
op_lshift
l_int|6
)paren
op_or
id|SCHIZO_CE_INO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|schizo_ce_intr
comma
id|SA_SHIRQ
comma
l_string|&quot;SCHIZO CE&quot;
comma
id|p
)paren
OL
l_int|0
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SCHIZO%d: Cannot register CE interrupt.&bslash;n&quot;
comma
id|p-&gt;index
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|bucket
op_assign
id|__bucket
c_func
(paren
id|irq
)paren
suffix:semicolon
id|tmp
op_assign
id|upa_readl
c_func
(paren
id|bucket-&gt;imap
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|tmp
comma
(paren
id|base
op_plus
id|SCHIZO_PBM_B_REGS_OFF
op_plus
id|schizo_imap_offset
c_func
(paren
id|SCHIZO_CE_INO
)paren
op_plus
l_int|4
)paren
)paren
suffix:semicolon
id|irq
op_assign
id|schizo_irq_build
c_func
(paren
id|pbm_a
comma
l_int|NULL
comma
(paren
id|portid
op_lshift
l_int|6
)paren
op_or
id|SCHIZO_PCIERR_A_INO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|schizo_pcierr_intr
comma
id|SA_SHIRQ
comma
l_string|&quot;SCHIZO PCIERR&quot;
comma
id|pbm_a
)paren
OL
l_int|0
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SCHIZO%d(PBMA): Cannot register PciERR interrupt.&bslash;n&quot;
comma
id|p-&gt;index
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|bucket
op_assign
id|__bucket
c_func
(paren
id|irq
)paren
suffix:semicolon
id|tmp
op_assign
id|upa_readl
c_func
(paren
id|bucket-&gt;imap
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|tmp
comma
(paren
id|base
op_plus
id|SCHIZO_PBM_B_REGS_OFF
op_plus
id|schizo_imap_offset
c_func
(paren
id|SCHIZO_PCIERR_A_INO
)paren
op_plus
l_int|4
)paren
)paren
suffix:semicolon
id|irq
op_assign
id|schizo_irq_build
c_func
(paren
id|pbm_a
comma
l_int|NULL
comma
(paren
id|portid
op_lshift
l_int|6
)paren
op_or
id|SCHIZO_PCIERR_B_INO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|schizo_pcierr_intr
comma
id|SA_SHIRQ
comma
l_string|&quot;SCHIZO PCIERR&quot;
comma
id|pbm_b
)paren
OL
l_int|0
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SCHIZO%d(PBMB): Cannot register PciERR interrupt.&bslash;n&quot;
comma
id|p-&gt;index
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|bucket
op_assign
id|__bucket
c_func
(paren
id|irq
)paren
suffix:semicolon
id|tmp
op_assign
id|upa_readl
c_func
(paren
id|bucket-&gt;imap
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|tmp
comma
(paren
id|base
op_plus
id|SCHIZO_PBM_B_REGS_OFF
op_plus
id|schizo_imap_offset
c_func
(paren
id|SCHIZO_PCIERR_B_INO
)paren
op_plus
l_int|4
)paren
)paren
suffix:semicolon
id|irq
op_assign
id|schizo_irq_build
c_func
(paren
id|pbm_a
comma
l_int|NULL
comma
(paren
id|portid
op_lshift
l_int|6
)paren
op_or
id|SCHIZO_SERR_INO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|schizo_safarierr_intr
comma
id|SA_SHIRQ
comma
l_string|&quot;SCHIZO SERR&quot;
comma
id|p
)paren
OL
l_int|0
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SCHIZO%d(PBMB): Cannot register SafariERR interrupt.&bslash;n&quot;
comma
id|p-&gt;index
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|bucket
op_assign
id|__bucket
c_func
(paren
id|irq
)paren
suffix:semicolon
id|tmp
op_assign
id|upa_readl
c_func
(paren
id|bucket-&gt;imap
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|tmp
comma
(paren
id|base
op_plus
id|SCHIZO_PBM_B_REGS_OFF
op_plus
id|schizo_imap_offset
c_func
(paren
id|SCHIZO_SERR_INO
)paren
op_plus
l_int|4
)paren
)paren
suffix:semicolon
multiline_comment|/* Enable UE and CE interrupts for controller. */
id|schizo_write
c_func
(paren
id|base
op_plus
id|SCHIZO_ECC_CTRL
comma
(paren
id|SCHIZO_ECCCTRL_EE
op_or
id|SCHIZO_ECCCTRL_UE
op_or
id|SCHIZO_ECCCTRL_CE
)paren
)paren
suffix:semicolon
multiline_comment|/* Enable PCI Error interrupts and clear error&n;&t; * bits for each PBM.&n;&t; */
id|tmp
op_assign
id|schizo_read
c_func
(paren
id|base
op_plus
id|SCHIZO_PCIA_CTRL
)paren
suffix:semicolon
id|tmp
op_or_assign
(paren
id|SCHIZO_PCICTRL_BUNUS
op_or
id|SCHIZO_PCICTRL_ESLCK
op_or
id|SCHIZO_PCICTRL_TTO_ERR
op_or
id|SCHIZO_PCICTRL_RTRY_ERR
op_or
id|SCHIZO_PCICTRL_DTO_ERR
op_or
id|SCHIZO_PCICTRL_SBH_ERR
op_or
id|SCHIZO_PCICTRL_SERR
op_or
id|SCHIZO_PCICTRL_SBH_INT
op_or
id|SCHIZO_PCICTRL_EEN
)paren
suffix:semicolon
id|schizo_write
c_func
(paren
id|base
op_plus
id|SCHIZO_PCIA_CTRL
comma
id|tmp
)paren
suffix:semicolon
id|tmp
op_assign
id|schizo_read
c_func
(paren
id|base
op_plus
id|SCHIZO_PCIB_CTRL
)paren
suffix:semicolon
id|tmp
op_or_assign
(paren
id|SCHIZO_PCICTRL_BUNUS
op_or
id|SCHIZO_PCICTRL_ESLCK
op_or
id|SCHIZO_PCICTRL_TTO_ERR
op_or
id|SCHIZO_PCICTRL_RTRY_ERR
op_or
id|SCHIZO_PCICTRL_DTO_ERR
op_or
id|SCHIZO_PCICTRL_SBH_ERR
op_or
id|SCHIZO_PCICTRL_SERR
op_or
id|SCHIZO_PCICTRL_SBH_INT
op_or
id|SCHIZO_PCICTRL_EEN
)paren
suffix:semicolon
id|schizo_write
c_func
(paren
id|base
op_plus
id|SCHIZO_PCIB_CTRL
comma
id|tmp
)paren
suffix:semicolon
id|schizo_write
c_func
(paren
id|base
op_plus
id|SCHIZO_PBM_A_REGS_OFF
op_plus
id|SCHIZO_PCI_AFSR
comma
(paren
id|SCHIZO_PCIAFSR_PMA
op_or
id|SCHIZO_PCIAFSR_PTA
op_or
id|SCHIZO_PCIAFSR_PRTRY
op_or
id|SCHIZO_PCIAFSR_PPERR
op_or
id|SCHIZO_PCIAFSR_PTTO
op_or
id|SCHIZO_PCIAFSR_PUNUS
op_or
id|SCHIZO_PCIAFSR_SMA
op_or
id|SCHIZO_PCIAFSR_STA
op_or
id|SCHIZO_PCIAFSR_SRTRY
op_or
id|SCHIZO_PCIAFSR_SPERR
op_or
id|SCHIZO_PCIAFSR_STTO
op_or
id|SCHIZO_PCIAFSR_SUNUS
)paren
)paren
suffix:semicolon
id|schizo_write
c_func
(paren
id|base
op_plus
id|SCHIZO_PBM_B_REGS_OFF
op_plus
id|SCHIZO_PCI_AFSR
comma
(paren
id|SCHIZO_PCIAFSR_PMA
op_or
id|SCHIZO_PCIAFSR_PTA
op_or
id|SCHIZO_PCIAFSR_PRTRY
op_or
id|SCHIZO_PCIAFSR_PPERR
op_or
id|SCHIZO_PCIAFSR_PTTO
op_or
id|SCHIZO_PCIAFSR_PUNUS
op_or
id|SCHIZO_PCIAFSR_SMA
op_or
id|SCHIZO_PCIAFSR_STA
op_or
id|SCHIZO_PCIAFSR_SRTRY
op_or
id|SCHIZO_PCIAFSR_SPERR
op_or
id|SCHIZO_PCIAFSR_STTO
op_or
id|SCHIZO_PCIAFSR_SUNUS
)paren
)paren
suffix:semicolon
multiline_comment|/* Make all Safari error conditions fatal except unmapped errors&n;&t; * which we make generate interrupts.&n;&t; */
macro_line|#if 1
multiline_comment|/* XXX Something wrong with some Excalibur systems&n;&t; * XXX Sun is shipping.  The behavior on a 2-cpu&n;&t; * XXX machine is that both CPU1 parity error bits&n;&t; * XXX are set and are immediately set again when&n;&t; * XXX their error status bits are cleared.  Just&n;&t; * XXX ignore them for now.  -DaveM&n;&t; */
id|schizo_write
c_func
(paren
id|base
op_plus
id|SCHIZO_SAFARI_ERRCTRL
comma
(paren
id|SCHIZO_SAFERRCTRL_EN
op_or
(paren
id|SAFARI_ERROR_BADCMD
op_or
id|SAFARI_ERROR_SSMDIS
op_or
id|SAFARI_ERROR_BADMA
op_or
id|SAFARI_ERROR_BADMB
op_or
id|SAFARI_ERROR_BADMC
op_or
id|SAFARI_ERROR_CIQTO
op_or
id|SAFARI_ERROR_LPQTO
op_or
id|SAFARI_ERROR_SFPQTO
op_or
id|SAFARI_ERROR_UFPQTO
op_or
id|SAFARI_ERROR_APERR
op_or
id|SAFARI_ERROR_BUSERR
op_or
id|SAFARI_ERROR_TIMEOUT
op_or
id|SAFARI_ERROR_ILL
)paren
)paren
)paren
suffix:semicolon
macro_line|#else
id|schizo_write
c_func
(paren
id|base
op_plus
id|SCHIZO_SAFARI_ERRCTRL
comma
(paren
id|SCHIZO_SAFERRCTRL_EN
op_or
(paren
id|SAFARI_ERROR_BADCMD
op_or
id|SAFARI_ERROR_SSMDIS
op_or
id|SAFARI_ERROR_BADMA
op_or
id|SAFARI_ERROR_BADMB
op_or
id|SAFARI_ERROR_BADMC
op_or
id|SAFARI_ERROR_CPU1PS
op_or
id|SAFARI_ERROR_CPU1PB
op_or
id|SAFARI_ERROR_CPU0PS
op_or
id|SAFARI_ERROR_CPU0PB
op_or
id|SAFARI_ERROR_CIQTO
op_or
id|SAFARI_ERROR_LPQTO
op_or
id|SAFARI_ERROR_SFPQTO
op_or
id|SAFARI_ERROR_UFPQTO
op_or
id|SAFARI_ERROR_APERR
op_or
id|SAFARI_ERROR_BUSERR
op_or
id|SAFARI_ERROR_TIMEOUT
op_or
id|SAFARI_ERROR_ILL
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
id|schizo_write
c_func
(paren
id|base
op_plus
id|SCHIZO_SAFARI_IRQCTRL
comma
(paren
id|SCHIZO_SAFIRQCTRL_EN
op_or
(paren
id|SAFARI_ERROR_UNMAP
)paren
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* We have to do the config space accesses by hand, thus... */
DECL|macro|PBM_BRIDGE_BUS
mdefine_line|#define PBM_BRIDGE_BUS&t;&t;0x40
DECL|macro|PBM_BRIDGE_SUBORDINATE
mdefine_line|#define PBM_BRIDGE_SUBORDINATE&t;0x41
DECL|function|pbm_renumber
r_static
r_void
id|__init
id|pbm_renumber
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
id|u8
id|orig_busno
)paren
(brace
id|u8
op_star
id|addr
comma
id|busno
suffix:semicolon
r_int
id|nbus
suffix:semicolon
id|busno
op_assign
id|pci_highest_busnum
suffix:semicolon
id|nbus
op_assign
id|pbm-&gt;pci_last_busno
op_minus
id|pbm-&gt;pci_first_busno
suffix:semicolon
id|addr
op_assign
id|schizo_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|orig_busno
comma
l_int|0
comma
id|PBM_BRIDGE_BUS
)paren
suffix:semicolon
id|pci_config_write8
c_func
(paren
id|addr
comma
id|busno
)paren
suffix:semicolon
id|addr
op_assign
id|schizo_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|busno
comma
l_int|0
comma
id|PBM_BRIDGE_SUBORDINATE
)paren
suffix:semicolon
id|pci_config_write8
c_func
(paren
id|addr
comma
id|busno
op_plus
id|nbus
)paren
suffix:semicolon
id|pbm-&gt;pci_first_busno
op_assign
id|busno
suffix:semicolon
id|pbm-&gt;pci_last_busno
op_assign
id|busno
op_plus
id|nbus
suffix:semicolon
id|pci_highest_busnum
op_assign
id|busno
op_plus
id|nbus
op_plus
l_int|1
suffix:semicolon
r_do
(brace
id|pci_bus2pbm
(braket
id|busno
op_increment
)braket
op_assign
id|pbm
suffix:semicolon
)brace
r_while
c_loop
(paren
id|nbus
op_decrement
)paren
suffix:semicolon
)brace
multiline_comment|/* We have to do the config space accesses by hand here since&n; * the pci_bus2pbm array is not ready yet.&n; */
DECL|function|pbm_pci_bridge_renumber
r_static
r_void
id|__init
id|pbm_pci_bridge_renumber
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
id|u8
id|busno
)paren
(brace
id|u32
id|devfn
comma
id|l
comma
r_class
suffix:semicolon
id|u8
id|hdr_type
suffix:semicolon
r_int
id|is_multi
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|devfn
op_assign
l_int|0
suffix:semicolon
id|devfn
OL
l_int|0xff
suffix:semicolon
op_increment
id|devfn
)paren
(brace
id|u32
op_star
id|dwaddr
suffix:semicolon
id|u8
op_star
id|baddr
suffix:semicolon
r_if
c_cond
(paren
id|PCI_FUNC
c_func
(paren
id|devfn
)paren
op_ne
l_int|0
op_logical_and
id|is_multi
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
multiline_comment|/* Anything there? */
id|dwaddr
op_assign
id|schizo_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|busno
comma
id|devfn
comma
id|PCI_VENDOR_ID
)paren
suffix:semicolon
id|l
op_assign
l_int|0xffffffff
suffix:semicolon
id|pci_config_read32
c_func
(paren
id|dwaddr
comma
op_amp
id|l
)paren
suffix:semicolon
r_if
c_cond
(paren
id|l
op_eq
l_int|0xffffffff
op_logical_or
id|l
op_eq
l_int|0x00000000
op_logical_or
id|l
op_eq
l_int|0x0000ffff
op_logical_or
id|l
op_eq
l_int|0xffff0000
)paren
(brace
id|is_multi
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|baddr
op_assign
id|schizo_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|busno
comma
id|devfn
comma
id|PCI_HEADER_TYPE
)paren
suffix:semicolon
id|pci_config_read8
c_func
(paren
id|baddr
comma
op_amp
id|hdr_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|PCI_FUNC
c_func
(paren
id|devfn
)paren
op_eq
l_int|0
)paren
id|is_multi
op_assign
id|hdr_type
op_amp
l_int|0x80
suffix:semicolon
id|dwaddr
op_assign
id|schizo_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|busno
comma
id|devfn
comma
id|PCI_CLASS_REVISION
)paren
suffix:semicolon
r_class
op_assign
l_int|0xffffffff
suffix:semicolon
id|pci_config_read32
c_func
(paren
id|dwaddr
comma
op_amp
r_class
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_class
op_rshift
l_int|16
)paren
op_eq
id|PCI_CLASS_BRIDGE_PCI
)paren
(brace
id|u32
id|buses
op_assign
l_int|0xffffffff
suffix:semicolon
id|dwaddr
op_assign
id|schizo_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|busno
comma
id|devfn
comma
id|PCI_PRIMARY_BUS
)paren
suffix:semicolon
id|pci_config_read32
c_func
(paren
id|dwaddr
comma
op_amp
id|buses
)paren
suffix:semicolon
id|pbm_pci_bridge_renumber
c_func
(paren
id|pbm
comma
(paren
id|buses
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|buses
op_and_assign
l_int|0xff000000
suffix:semicolon
id|pci_config_write32
c_func
(paren
id|dwaddr
comma
id|buses
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|pbm_bridge_reconfigure
r_static
r_void
id|__init
id|pbm_bridge_reconfigure
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
)paren
(brace
r_struct
id|pci_pbm_info
op_star
id|pbm
suffix:semicolon
id|u8
op_star
id|addr
suffix:semicolon
multiline_comment|/* Clear out primary/secondary/subordinate bus numbers on&n;&t; * all PCI-to-PCI bridges under each PBM.  The generic bus&n;&t; * probing will fix them up.&n;&t; */
id|pbm_pci_bridge_renumber
c_func
(paren
op_amp
id|p-&gt;pbm_B
comma
id|p-&gt;pbm_B.pci_first_busno
)paren
suffix:semicolon
id|pbm_pci_bridge_renumber
c_func
(paren
op_amp
id|p-&gt;pbm_A
comma
id|p-&gt;pbm_A.pci_first_busno
)paren
suffix:semicolon
multiline_comment|/* Move PBM A out of the way. */
id|pbm
op_assign
op_amp
id|p-&gt;pbm_A
suffix:semicolon
id|addr
op_assign
id|schizo_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|pbm-&gt;pci_first_busno
comma
l_int|0
comma
id|PBM_BRIDGE_BUS
)paren
suffix:semicolon
id|pci_config_write8
c_func
(paren
id|addr
comma
l_int|0xff
)paren
suffix:semicolon
id|addr
op_assign
id|schizo_pci_config_mkaddr
c_func
(paren
id|pbm
comma
l_int|0xff
comma
l_int|0
comma
id|PBM_BRIDGE_SUBORDINATE
)paren
suffix:semicolon
id|pci_config_write8
c_func
(paren
id|addr
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Now we can safely renumber both PBMs. */
id|pbm_renumber
c_func
(paren
op_amp
id|p-&gt;pbm_B
comma
id|p-&gt;pbm_B.pci_first_busno
)paren
suffix:semicolon
id|pbm_renumber
c_func
(paren
op_amp
id|p-&gt;pbm_A
comma
l_int|0xff
)paren
suffix:semicolon
)brace
DECL|function|pbm_config_busmastering
r_static
r_void
id|__init
id|pbm_config_busmastering
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
)paren
(brace
id|u8
op_star
id|addr
suffix:semicolon
multiline_comment|/* Set cache-line size to 64 bytes, this is actually&n;&t; * a nop but I do it for completeness.&n;&t; */
id|addr
op_assign
id|schizo_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|pbm-&gt;pci_first_busno
comma
l_int|0
comma
id|PCI_CACHE_LINE_SIZE
)paren
suffix:semicolon
id|pci_config_write8
c_func
(paren
id|addr
comma
l_int|64
op_div
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
multiline_comment|/* Set PBM latency timer to 64 PCI clocks. */
id|addr
op_assign
id|schizo_pci_config_mkaddr
c_func
(paren
id|pbm
comma
id|pbm-&gt;pci_first_busno
comma
l_int|0
comma
id|PCI_LATENCY_TIMER
)paren
suffix:semicolon
id|pci_config_write8
c_func
(paren
id|addr
comma
l_int|64
)paren
suffix:semicolon
)brace
DECL|function|pbm_scan_bus
r_static
r_void
id|__init
id|pbm_scan_bus
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_struct
id|pci_pbm_info
op_star
id|pbm
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|cookie
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|cookie
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cookie
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SCHIZO: Critical allocation failure.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* All we care about is the PBM. */
id|memset
c_func
(paren
id|cookie
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|cookie
)paren
)paren
suffix:semicolon
id|cookie-&gt;pbm
op_assign
id|pbm
suffix:semicolon
id|pbm-&gt;pci_bus
op_assign
id|pci_scan_bus
c_func
(paren
id|pbm-&gt;pci_first_busno
comma
id|p-&gt;pci_ops
comma
id|pbm
)paren
suffix:semicolon
id|pci_fixup_host_bridge_self
c_func
(paren
id|pbm-&gt;pci_bus
)paren
suffix:semicolon
id|pbm-&gt;pci_bus-&gt;self-&gt;sysdata
op_assign
id|cookie
suffix:semicolon
id|pci_fill_in_pbm_cookies
c_func
(paren
id|pbm-&gt;pci_bus
comma
id|pbm
comma
id|pbm-&gt;prom_node
)paren
suffix:semicolon
id|pci_record_assignments
c_func
(paren
id|pbm
comma
id|pbm-&gt;pci_bus
)paren
suffix:semicolon
id|pci_assign_unassigned
c_func
(paren
id|pbm
comma
id|pbm-&gt;pci_bus
)paren
suffix:semicolon
id|pci_fixup_irq
c_func
(paren
id|pbm
comma
id|pbm-&gt;pci_bus
)paren
suffix:semicolon
id|pci_determine_66mhz_disposition
c_func
(paren
id|pbm
comma
id|pbm-&gt;pci_bus
)paren
suffix:semicolon
id|pci_setup_busmastering
c_func
(paren
id|pbm
comma
id|pbm-&gt;pci_bus
)paren
suffix:semicolon
)brace
DECL|function|schizo_scan_bus
r_static
r_void
id|__init
id|schizo_scan_bus
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
)paren
(brace
id|pbm_bridge_reconfigure
c_func
(paren
id|p
)paren
suffix:semicolon
id|pbm_config_busmastering
c_func
(paren
op_amp
id|p-&gt;pbm_B
)paren
suffix:semicolon
id|p-&gt;pbm_B.is_66mhz_capable
op_assign
l_int|0
suffix:semicolon
id|pbm_config_busmastering
c_func
(paren
op_amp
id|p-&gt;pbm_A
)paren
suffix:semicolon
id|p-&gt;pbm_A.is_66mhz_capable
op_assign
l_int|1
suffix:semicolon
id|pbm_scan_bus
c_func
(paren
id|p
comma
op_amp
id|p-&gt;pbm_B
)paren
suffix:semicolon
id|pbm_scan_bus
c_func
(paren
id|p
comma
op_amp
id|p-&gt;pbm_A
)paren
suffix:semicolon
multiline_comment|/* After the PCI bus scan is complete, we can register&n;&t; * the error interrupt handlers.&n;&t; */
id|schizo_register_error_handlers
c_func
(paren
id|p
)paren
suffix:semicolon
)brace
DECL|function|schizo_base_address_update
r_static
r_void
id|__init
id|schizo_base_address_update
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
id|resource
)paren
(brace
r_struct
id|pcidev_cookie
op_star
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
r_struct
id|pci_pbm_info
op_star
id|pbm
op_assign
id|pcp-&gt;pbm
suffix:semicolon
r_struct
id|resource
op_star
id|res
comma
op_star
id|root
suffix:semicolon
id|u32
id|reg
suffix:semicolon
r_int
id|where
comma
id|size
comma
id|is_64bit
suffix:semicolon
id|res
op_assign
op_amp
id|pdev-&gt;resource
(braket
id|resource
)braket
suffix:semicolon
id|where
op_assign
id|PCI_BASE_ADDRESS_0
op_plus
(paren
id|resource
op_star
l_int|4
)paren
suffix:semicolon
id|is_64bit
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|res-&gt;flags
op_amp
id|IORESOURCE_IO
)paren
id|root
op_assign
op_amp
id|pbm-&gt;io_space
suffix:semicolon
r_else
(brace
id|root
op_assign
op_amp
id|pbm-&gt;mem_space
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res-&gt;flags
op_amp
id|PCI_BASE_ADDRESS_MEM_TYPE_MASK
)paren
op_eq
id|PCI_BASE_ADDRESS_MEM_TYPE_64
)paren
id|is_64bit
op_assign
l_int|1
suffix:semicolon
)brace
id|size
op_assign
id|res-&gt;end
op_minus
id|res-&gt;start
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|pdev
comma
id|where
comma
op_amp
id|reg
)paren
suffix:semicolon
id|reg
op_assign
(paren
(paren
id|reg
op_amp
id|size
)paren
op_or
(paren
(paren
(paren
id|u32
)paren
(paren
id|res-&gt;start
op_minus
id|root-&gt;start
)paren
)paren
op_amp
op_complement
id|size
)paren
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|pdev
comma
id|where
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* This knows that the upper 32-bits of the address&n;&t; * must be zero.  Our PCI common layer enforces this.&n;&t; */
r_if
c_cond
(paren
id|is_64bit
)paren
id|pci_write_config_dword
c_func
(paren
id|pdev
comma
id|where
op_plus
l_int|4
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|schizo_resource_adjust
r_static
r_void
id|__init
id|schizo_resource_adjust
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_struct
id|resource
op_star
id|res
comma
r_struct
id|resource
op_star
id|root
)paren
(brace
id|res-&gt;start
op_add_assign
id|root-&gt;start
suffix:semicolon
id|res-&gt;end
op_add_assign
id|root-&gt;start
suffix:semicolon
)brace
multiline_comment|/* Interrogate Safari match/mask registers to figure out where&n; * PCI MEM, I/O, and Config space are for this PCI bus module.&n; */
DECL|macro|SCHIZO_PCI_A_MEM_MATCH
mdefine_line|#define SCHIZO_PCI_A_MEM_MATCH&t;&t;0x00040UL
DECL|macro|SCHIZO_PCI_A_MEM_MASK
mdefine_line|#define SCHIZO_PCI_A_MEM_MASK&t;&t;0x00048UL
DECL|macro|SCHIZO_PCI_A_IO_MATCH
mdefine_line|#define SCHIZO_PCI_A_IO_MATCH&t;&t;0x00050UL
DECL|macro|SCHIZO_PCI_A_IO_MASK
mdefine_line|#define SCHIZO_PCI_A_IO_MASK&t;&t;0x00058UL
DECL|macro|SCHIZO_PCI_B_MEM_MATCH
mdefine_line|#define SCHIZO_PCI_B_MEM_MATCH&t;&t;0x00060UL
DECL|macro|SCHIZO_PCI_B_MEM_MASK
mdefine_line|#define SCHIZO_PCI_B_MEM_MASK&t;&t;0x00068UL
DECL|macro|SCHIZO_PCI_B_IO_MATCH
mdefine_line|#define SCHIZO_PCI_B_IO_MATCH&t;&t;0x00070UL
DECL|macro|SCHIZO_PCI_B_IO_MASK
mdefine_line|#define SCHIZO_PCI_B_IO_MASK&t;&t;0x00078UL
multiline_comment|/* VAL must be non-zero. */
DECL|function|strip_to_lowest_bit_set
r_static
r_int
r_int
id|strip_to_lowest_bit_set
c_func
(paren
r_int
r_int
id|val
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
id|tmp
op_assign
l_int|1UL
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|tmp
op_amp
id|val
)paren
)paren
id|tmp
op_lshift_assign
l_int|1UL
suffix:semicolon
r_return
id|tmp
suffix:semicolon
)brace
DECL|function|schizo_determine_mem_io_space
r_static
r_void
id|schizo_determine_mem_io_space
c_func
(paren
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_int
id|is_pbm_a
comma
r_int
r_int
id|reg_base
)paren
(brace
id|u64
id|mem_match
comma
id|mem_mask
suffix:semicolon
id|u64
id|io_match
suffix:semicolon
id|u64
r_int
id|a
comma
id|b
suffix:semicolon
r_if
c_cond
(paren
id|is_pbm_a
)paren
(brace
id|mem_match
op_assign
id|reg_base
op_plus
id|SCHIZO_PCI_A_MEM_MATCH
suffix:semicolon
id|io_match
op_assign
id|reg_base
op_plus
id|SCHIZO_PCI_A_IO_MATCH
suffix:semicolon
)brace
r_else
(brace
id|mem_match
op_assign
id|reg_base
op_plus
id|SCHIZO_PCI_B_MEM_MATCH
suffix:semicolon
id|io_match
op_assign
id|reg_base
op_plus
id|SCHIZO_PCI_B_IO_MATCH
suffix:semicolon
)brace
id|mem_mask
op_assign
id|mem_match
op_plus
l_int|0x8UL
suffix:semicolon
id|a
op_assign
id|schizo_read
c_func
(paren
id|mem_match
)paren
op_amp
op_complement
l_int|0x8000000000000000UL
suffix:semicolon
id|b
op_assign
id|strip_to_lowest_bit_set
c_func
(paren
id|schizo_read
c_func
(paren
id|mem_mask
)paren
)paren
suffix:semicolon
multiline_comment|/* It should be 2GB in size. */
id|pbm-&gt;mem_space.start
op_assign
id|a
suffix:semicolon
id|pbm-&gt;mem_space.end
op_assign
id|a
op_plus
(paren
id|b
op_minus
l_int|1UL
)paren
suffix:semicolon
id|pbm-&gt;mem_space.flags
op_assign
id|IORESOURCE_MEM
suffix:semicolon
multiline_comment|/* This 32MB area is divided into two pieces.  The first&n;&t; * 16MB is Config space, the next 16MB is I/O space.&n;&t; */
id|a
op_assign
id|schizo_read
c_func
(paren
id|io_match
)paren
op_amp
op_complement
l_int|0x8000000000000000UL
suffix:semicolon
id|pbm-&gt;config_space
op_assign
id|a
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCHIZO PBM%c: Local PCI config space at %016lx&bslash;n&quot;
comma
(paren
id|is_pbm_a
ques
c_cond
l_char|&squot;A&squot;
suffix:colon
l_char|&squot;B&squot;
)paren
comma
id|pbm-&gt;config_space
)paren
suffix:semicolon
id|a
op_add_assign
(paren
l_int|16UL
op_star
l_int|1024UL
op_star
l_int|1024UL
)paren
suffix:semicolon
id|pbm-&gt;io_space.start
op_assign
id|a
suffix:semicolon
id|pbm-&gt;io_space.end
op_assign
id|a
op_plus
(paren
(paren
l_int|16UL
op_star
l_int|1024UL
op_star
l_int|1024UL
)paren
op_minus
l_int|1UL
)paren
suffix:semicolon
id|pbm-&gt;io_space.flags
op_assign
id|IORESOURCE_IO
suffix:semicolon
)brace
DECL|function|pbm_register_toplevel_resources
r_static
r_void
id|__init
id|pbm_register_toplevel_resources
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_struct
id|pci_pbm_info
op_star
id|pbm
)paren
(brace
r_char
op_star
id|name
op_assign
id|pbm-&gt;name
suffix:semicolon
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;SCHIZO%d PBM%c&quot;
comma
id|p-&gt;index
comma
(paren
id|pbm
op_eq
op_amp
id|p-&gt;pbm_A
ques
c_cond
l_char|&squot;A&squot;
suffix:colon
l_char|&squot;B&squot;
)paren
)paren
suffix:semicolon
id|pbm-&gt;io_space.name
op_assign
id|pbm-&gt;mem_space.name
op_assign
id|name
suffix:semicolon
id|request_resource
c_func
(paren
op_amp
id|ioport_resource
comma
op_amp
id|pbm-&gt;io_space
)paren
suffix:semicolon
id|request_resource
c_func
(paren
op_amp
id|iomem_resource
comma
op_amp
id|pbm-&gt;mem_space
)paren
suffix:semicolon
id|pci_register_legacy_regions
c_func
(paren
op_amp
id|pbm-&gt;io_space
comma
op_amp
id|pbm-&gt;mem_space
)paren
suffix:semicolon
)brace
DECL|macro|SCHIZO_STRBUF_CONTROL_A
mdefine_line|#define SCHIZO_STRBUF_CONTROL_A&t;&t;(SCHIZO_PBM_A_REGS_OFF + 0x02800UL)
DECL|macro|SCHIZO_STRBUF_FLUSH_A
mdefine_line|#define SCHIZO_STRBUF_FLUSH_A&t;&t;(SCHIZO_PBM_A_REGS_OFF + 0x02808UL)
DECL|macro|SCHIZO_STRBUF_FSYNC_A
mdefine_line|#define SCHIZO_STRBUF_FSYNC_A&t;&t;(SCHIZO_PBM_A_REGS_OFF + 0x02810UL)
DECL|macro|SCHIZO_STRBUF_CTXFLUSH_A
mdefine_line|#define SCHIZO_STRBUF_CTXFLUSH_A&t;(SCHIZO_PBM_A_REGS_OFF + 0x02818UL)
DECL|macro|SCHIZO_STRBUF_CTXMATCH_A
mdefine_line|#define SCHIZO_STRBUF_CTXMATCH_A&t;(SCHIZO_PBM_A_REGS_OFF + 0x10000UL)
DECL|macro|SCHIZO_STRBUF_CONTROL_B
mdefine_line|#define SCHIZO_STRBUF_CONTROL_B&t;&t;(SCHIZO_PBM_B_REGS_OFF + 0x02800UL)
DECL|macro|SCHIZO_STRBUF_FLUSH_B
mdefine_line|#define SCHIZO_STRBUF_FLUSH_B&t;&t;(SCHIZO_PBM_B_REGS_OFF + 0x02808UL)
DECL|macro|SCHIZO_STRBUF_FSYNC_B
mdefine_line|#define SCHIZO_STRBUF_FSYNC_B&t;&t;(SCHIZO_PBM_B_REGS_OFF + 0x02810UL)
DECL|macro|SCHIZO_STRBUF_CTXFLUSH_B
mdefine_line|#define SCHIZO_STRBUF_CTXFLUSH_B&t;(SCHIZO_PBM_B_REGS_OFF + 0x02818UL)
DECL|macro|SCHIZO_STRBUF_CTXMATCH_B
mdefine_line|#define SCHIZO_STRBUF_CTXMATCH_B&t;(SCHIZO_PBM_B_REGS_OFF + 0x10000UL)
DECL|function|schizo_pbm_strbuf_init
r_static
r_void
id|schizo_pbm_strbuf_init
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_int
id|is_pbm_a
)paren
(brace
r_int
r_int
id|base
op_assign
id|p-&gt;controller_regs
suffix:semicolon
id|u64
id|control
suffix:semicolon
multiline_comment|/* SCHIZO has context flushing. */
r_if
c_cond
(paren
id|is_pbm_a
)paren
(brace
id|pbm-&gt;stc.strbuf_control
op_assign
id|base
op_plus
id|SCHIZO_STRBUF_CONTROL_A
suffix:semicolon
id|pbm-&gt;stc.strbuf_pflush
op_assign
id|base
op_plus
id|SCHIZO_STRBUF_FLUSH_A
suffix:semicolon
id|pbm-&gt;stc.strbuf_fsync
op_assign
id|base
op_plus
id|SCHIZO_STRBUF_FSYNC_A
suffix:semicolon
id|pbm-&gt;stc.strbuf_ctxflush
op_assign
id|base
op_plus
id|SCHIZO_STRBUF_CTXFLUSH_A
suffix:semicolon
id|pbm-&gt;stc.strbuf_ctxmatch_base
op_assign
id|base
op_plus
id|SCHIZO_STRBUF_CTXMATCH_A
suffix:semicolon
)brace
r_else
(brace
id|pbm-&gt;stc.strbuf_control
op_assign
id|base
op_plus
id|SCHIZO_STRBUF_CONTROL_B
suffix:semicolon
id|pbm-&gt;stc.strbuf_pflush
op_assign
id|base
op_plus
id|SCHIZO_STRBUF_FLUSH_B
suffix:semicolon
id|pbm-&gt;stc.strbuf_fsync
op_assign
id|base
op_plus
id|SCHIZO_STRBUF_FSYNC_B
suffix:semicolon
id|pbm-&gt;stc.strbuf_ctxflush
op_assign
id|base
op_plus
id|SCHIZO_STRBUF_CTXFLUSH_B
suffix:semicolon
id|pbm-&gt;stc.strbuf_ctxmatch_base
op_assign
id|base
op_plus
id|SCHIZO_STRBUF_CTXMATCH_B
suffix:semicolon
)brace
id|pbm-&gt;stc.strbuf_flushflag
op_assign
(paren
r_volatile
r_int
r_int
op_star
)paren
(paren
(paren
(paren
(paren
r_int
r_int
)paren
op_amp
id|pbm-&gt;stc.__flushflag_buf
(braket
l_int|0
)braket
)paren
op_plus
l_int|63UL
)paren
op_amp
op_complement
l_int|63UL
)paren
suffix:semicolon
id|pbm-&gt;stc.strbuf_flushflag_pa
op_assign
(paren
r_int
r_int
)paren
id|__pa
c_func
(paren
id|pbm-&gt;stc.strbuf_flushflag
)paren
suffix:semicolon
multiline_comment|/* Turn off LRU locking and diag mode, enable the&n;&t; * streaming buffer and leave the rerun-disable&n;&t; * setting however OBP set it.&n;&t; */
id|control
op_assign
id|schizo_read
c_func
(paren
id|pbm-&gt;stc.strbuf_control
)paren
suffix:semicolon
id|control
op_and_assign
op_complement
(paren
id|SCHIZO_STRBUF_CTRL_LPTR
op_or
id|SCHIZO_STRBUF_CTRL_LENAB
op_or
id|SCHIZO_STRBUF_CTRL_DENAB
)paren
suffix:semicolon
id|control
op_or_assign
id|SCHIZO_STRBUF_CTRL_ENAB
suffix:semicolon
id|schizo_write
c_func
(paren
id|pbm-&gt;stc.strbuf_control
comma
id|control
)paren
suffix:semicolon
id|pbm-&gt;stc.strbuf_enabled
op_assign
l_int|1
suffix:semicolon
)brace
DECL|macro|SCHIZO_IOMMU_CONTROL_A
mdefine_line|#define SCHIZO_IOMMU_CONTROL_A&t;&t;(SCHIZO_PBM_A_REGS_OFF + 0x00200UL)
DECL|macro|SCHIZO_IOMMU_TSBBASE_A
mdefine_line|#define SCHIZO_IOMMU_TSBBASE_A&t;&t;(SCHIZO_PBM_A_REGS_OFF + 0x00208UL)
DECL|macro|SCHIZO_IOMMU_FLUSH_A
mdefine_line|#define SCHIZO_IOMMU_FLUSH_A&t;&t;(SCHIZO_PBM_A_REGS_OFF + 0x00210UL)
DECL|macro|SCHIZO_IOMMU_CTXFLUSH_A
mdefine_line|#define SCHIZO_IOMMU_CTXFLUSH_A&t;&t;(SCHIZO_PBM_A_REGS_OFF + 0x00218UL)
DECL|macro|SCHIZO_IOMMU_TAG_A
mdefine_line|#define SCHIZO_IOMMU_TAG_A&t;&t;(SCHIZO_PBM_A_REGS_OFF + 0x0a580UL)
DECL|macro|SCHIZO_IOMMU_DATA_A
mdefine_line|#define SCHIZO_IOMMU_DATA_A&t;&t;(SCHIZO_PBM_A_REGS_OFF + 0x0a600UL)
DECL|macro|SCHIZO_IOMMU_CONTROL_B
mdefine_line|#define SCHIZO_IOMMU_CONTROL_B&t;&t;(SCHIZO_PBM_B_REGS_OFF + 0x00200UL)
DECL|macro|SCHIZO_IOMMU_TSBBASE_B
mdefine_line|#define SCHIZO_IOMMU_TSBBASE_B&t;&t;(SCHIZO_PBM_B_REGS_OFF + 0x00208UL)
DECL|macro|SCHIZO_IOMMU_FLUSH_B
mdefine_line|#define SCHIZO_IOMMU_FLUSH_B&t;&t;(SCHIZO_PBM_B_REGS_OFF + 0x00210UL)
DECL|macro|SCHIZO_IOMMU_CTXFLUSH_B
mdefine_line|#define SCHIZO_IOMMU_CTXFLUSH_B&t;&t;(SCHIZO_PBM_B_REGS_OFF + 0x00218UL)
DECL|macro|SCHIZO_IOMMU_TAG_B
mdefine_line|#define SCHIZO_IOMMU_TAG_B&t;&t;(SCHIZO_PBM_B_REGS_OFF + 0x0a580UL)
DECL|macro|SCHIZO_IOMMU_DATA_B
mdefine_line|#define SCHIZO_IOMMU_DATA_B&t;&t;(SCHIZO_PBM_B_REGS_OFF + 0x0a600UL)
DECL|function|schizo_pbm_iommu_init
r_static
r_void
id|schizo_pbm_iommu_init
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_struct
id|pci_pbm_info
op_star
id|pbm
comma
r_int
id|is_pbm_a
)paren
(brace
r_struct
id|pci_iommu
op_star
id|iommu
op_assign
id|pbm-&gt;iommu
suffix:semicolon
r_int
r_int
id|tsbbase
comma
id|i
comma
id|tagbase
comma
id|database
suffix:semicolon
id|u64
id|control
suffix:semicolon
multiline_comment|/* Setup initial software IOMMU state. */
id|spin_lock_init
c_func
(paren
op_amp
id|iommu-&gt;lock
)paren
suffix:semicolon
id|iommu-&gt;iommu_cur_ctx
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Register addresses, SCHIZO has iommu ctx flushing. */
r_if
c_cond
(paren
id|is_pbm_a
)paren
(brace
id|iommu-&gt;iommu_control
op_assign
id|p-&gt;controller_regs
op_plus
id|SCHIZO_IOMMU_CONTROL_A
suffix:semicolon
id|iommu-&gt;iommu_tsbbase
op_assign
id|p-&gt;controller_regs
op_plus
id|SCHIZO_IOMMU_TSBBASE_A
suffix:semicolon
id|iommu-&gt;iommu_flush
op_assign
id|p-&gt;controller_regs
op_plus
id|SCHIZO_IOMMU_FLUSH_A
suffix:semicolon
id|iommu-&gt;iommu_ctxflush
op_assign
id|p-&gt;controller_regs
op_plus
id|SCHIZO_IOMMU_CTXFLUSH_A
suffix:semicolon
)brace
r_else
(brace
id|iommu-&gt;iommu_control
op_assign
id|p-&gt;controller_regs
op_plus
id|SCHIZO_IOMMU_CONTROL_B
suffix:semicolon
id|iommu-&gt;iommu_tsbbase
op_assign
id|p-&gt;controller_regs
op_plus
id|SCHIZO_IOMMU_TSBBASE_B
suffix:semicolon
id|iommu-&gt;iommu_flush
op_assign
id|p-&gt;controller_regs
op_plus
id|SCHIZO_IOMMU_FLUSH_B
suffix:semicolon
id|iommu-&gt;iommu_ctxflush
op_assign
id|p-&gt;controller_regs
op_plus
id|SCHIZO_IOMMU_CTXFLUSH_B
suffix:semicolon
)brace
multiline_comment|/* We use the main control/status register of SCHIZO as the write&n;&t; * completion register.&n;&t; */
id|iommu-&gt;write_complete_reg
op_assign
id|p-&gt;controller_regs
op_plus
l_int|0x10000UL
suffix:semicolon
multiline_comment|/*&n;&t; * Invalidate TLB Entries.&n;&t; */
id|control
op_assign
id|schizo_read
c_func
(paren
id|iommu-&gt;iommu_control
)paren
suffix:semicolon
id|control
op_or_assign
id|SCHIZO_IOMMU_CTRL_DENAB
suffix:semicolon
id|schizo_write
c_func
(paren
id|iommu-&gt;iommu_control
comma
id|control
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_pbm_a
)paren
id|tagbase
op_assign
id|SCHIZO_IOMMU_TAG_A
comma
id|database
op_assign
id|SCHIZO_IOMMU_DATA_A
suffix:semicolon
r_else
id|tagbase
op_assign
id|SCHIZO_IOMMU_TAG_B
comma
id|database
op_assign
id|SCHIZO_IOMMU_DATA_B
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|schizo_write
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|tagbase
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
comma
l_int|0
)paren
suffix:semicolon
id|schizo_write
c_func
(paren
id|p-&gt;controller_regs
op_plus
id|database
op_plus
(paren
id|i
op_star
l_int|8UL
)paren
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Leave diag mode enabled for full-flushing done&n;&t; * in pci_iommu.c&n;&t; */
multiline_comment|/* Using assumed page size 8K with 128K entries we need 1MB iommu page&n;&t; * table (128K ioptes * 8 bytes per iopte).  This is&n;&t; * page order 7 on UltraSparc.&n;&t; */
id|tsbbase
op_assign
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tsbbase
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SCHIZO_IOMMU: Error, gfp(tsb) failed.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|iommu-&gt;page_table
op_assign
(paren
id|iopte_t
op_star
)paren
id|tsbbase
suffix:semicolon
id|iommu-&gt;page_table_sz_bits
op_assign
l_int|17
suffix:semicolon
id|iommu-&gt;page_table_map_base
op_assign
l_int|0xc0000000
suffix:semicolon
id|iommu-&gt;dma_addr_mask
op_assign
l_int|0xffffffff
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|tsbbase
comma
l_int|0
comma
id|PAGE_SIZE
op_lshift
l_int|7
)paren
suffix:semicolon
multiline_comment|/* We start with no consistent mappings. */
id|iommu-&gt;lowest_consistent_map
op_assign
l_int|1
op_lshift
(paren
id|iommu-&gt;page_table_sz_bits
op_minus
id|PBM_LOGCLUSTERS
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PBM_NCLUSTERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|iommu-&gt;alloc_info
(braket
id|i
)braket
dot
id|flush
op_assign
l_int|0
suffix:semicolon
id|iommu-&gt;alloc_info
(braket
id|i
)braket
dot
id|next
op_assign
l_int|0
suffix:semicolon
)brace
id|schizo_write
c_func
(paren
id|iommu-&gt;iommu_tsbbase
comma
id|__pa
c_func
(paren
id|tsbbase
)paren
)paren
suffix:semicolon
id|control
op_assign
id|schizo_read
c_func
(paren
id|iommu-&gt;iommu_control
)paren
suffix:semicolon
id|control
op_and_assign
op_complement
(paren
id|SCHIZO_IOMMU_CTRL_TSBSZ
op_or
id|SCHIZO_IOMMU_CTRL_TBWSZ
)paren
suffix:semicolon
id|control
op_or_assign
(paren
id|SCHIZO_IOMMU_TSBSZ_128K
op_or
id|SCHIZO_IOMMU_CTRL_ENAB
)paren
suffix:semicolon
id|schizo_write
c_func
(paren
id|iommu-&gt;iommu_control
comma
id|control
)paren
suffix:semicolon
)brace
DECL|function|schizo_pbm_init
r_static
r_void
id|schizo_pbm_init
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_int
id|prom_node
comma
r_int
id|is_pbm_a
)paren
(brace
r_int
r_int
id|busrange
(braket
l_int|2
)braket
suffix:semicolon
r_struct
id|pci_pbm_info
op_star
id|pbm
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|is_pbm_a
)paren
id|pbm
op_assign
op_amp
id|p-&gt;pbm_A
suffix:semicolon
r_else
id|pbm
op_assign
op_amp
id|p-&gt;pbm_B
suffix:semicolon
id|schizo_determine_mem_io_space
c_func
(paren
id|pbm
comma
id|is_pbm_a
comma
id|p-&gt;controller_regs
)paren
suffix:semicolon
id|pbm_register_toplevel_resources
c_func
(paren
id|p
comma
id|pbm
)paren
suffix:semicolon
id|pbm-&gt;parent
op_assign
id|p
suffix:semicolon
id|pbm-&gt;prom_node
op_assign
id|prom_node
suffix:semicolon
id|pbm-&gt;pci_first_slot
op_assign
l_int|1
suffix:semicolon
id|prom_getstring
c_func
(paren
id|prom_node
comma
l_string|&quot;name&quot;
comma
id|pbm-&gt;prom_name
comma
r_sizeof
(paren
id|pbm-&gt;prom_name
)paren
)paren
suffix:semicolon
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|prom_node
comma
l_string|&quot;ranges&quot;
comma
(paren
r_char
op_star
)paren
id|pbm-&gt;pbm_ranges
comma
r_sizeof
(paren
id|pbm-&gt;pbm_ranges
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
op_minus
l_int|1
)paren
id|pbm-&gt;num_pbm_ranges
op_assign
(paren
id|err
op_div
r_sizeof
(paren
r_struct
id|linux_prom_pci_ranges
)paren
)paren
suffix:semicolon
r_else
id|pbm-&gt;num_pbm_ranges
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|prom_node
comma
l_string|&quot;interrupt-map&quot;
comma
(paren
r_char
op_star
)paren
id|pbm-&gt;pbm_intmap
comma
r_sizeof
(paren
id|pbm-&gt;pbm_intmap
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
op_minus
l_int|1
)paren
(brace
id|pbm-&gt;num_pbm_intmap
op_assign
(paren
id|err
op_div
r_sizeof
(paren
r_struct
id|linux_prom_pci_intmap
)paren
)paren
suffix:semicolon
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|prom_node
comma
l_string|&quot;interrupt-map-mask&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|pbm-&gt;pbm_intmask
comma
r_sizeof
(paren
id|pbm-&gt;pbm_intmask
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SCHIZO-PBM: Fatal error, no &quot;
l_string|&quot;interrupt-map-mask.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|pbm-&gt;num_pbm_intmap
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|pbm-&gt;pbm_intmask
comma
l_int|0
comma
r_sizeof
(paren
id|pbm-&gt;pbm_intmask
)paren
)paren
suffix:semicolon
)brace
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|prom_node
comma
l_string|&quot;bus-range&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|busrange
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|busrange
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
op_logical_or
id|err
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SCHIZO-PBM: Fatal error, no bus-range.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|pbm-&gt;pci_first_busno
op_assign
id|busrange
(braket
l_int|0
)braket
suffix:semicolon
id|pbm-&gt;pci_last_busno
op_assign
id|busrange
(braket
l_int|1
)braket
suffix:semicolon
id|schizo_pbm_iommu_init
c_func
(paren
id|p
comma
id|pbm
comma
id|is_pbm_a
)paren
suffix:semicolon
id|schizo_pbm_strbuf_init
c_func
(paren
id|p
comma
id|pbm
comma
id|is_pbm_a
)paren
suffix:semicolon
)brace
DECL|function|schizo_controller_hwinit
r_static
r_void
id|schizo_controller_hwinit
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
)paren
(brace
r_int
r_int
id|pbm_a_base
comma
id|pbm_b_base
suffix:semicolon
id|u64
id|tmp
suffix:semicolon
id|pbm_a_base
op_assign
id|p-&gt;controller_regs
op_plus
id|SCHIZO_PBM_A_REGS_OFF
suffix:semicolon
id|pbm_b_base
op_assign
id|p-&gt;controller_regs
op_plus
id|SCHIZO_PBM_B_REGS_OFF
suffix:semicolon
multiline_comment|/* Set IRQ retry to infinity. */
id|schizo_write
c_func
(paren
id|pbm_a_base
op_plus
l_int|0x1a00UL
comma
l_int|0xff
)paren
suffix:semicolon
id|schizo_write
c_func
(paren
id|pbm_b_base
op_plus
l_int|0x1a00UL
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Enable arbiter for all PCI slots. */
id|tmp
op_assign
id|schizo_read
c_func
(paren
id|pbm_a_base
op_plus
l_int|0x2000UL
)paren
suffix:semicolon
id|tmp
op_or_assign
l_int|0x3fUL
suffix:semicolon
id|schizo_write
c_func
(paren
id|pbm_a_base
op_plus
l_int|0x2000UL
comma
id|tmp
)paren
suffix:semicolon
id|tmp
op_assign
id|schizo_read
c_func
(paren
id|pbm_b_base
op_plus
l_int|0x2000UL
)paren
suffix:semicolon
id|tmp
op_or_assign
l_int|0x3fUL
suffix:semicolon
id|schizo_write
c_func
(paren
id|pbm_b_base
op_plus
l_int|0x2000UL
comma
id|tmp
)paren
suffix:semicolon
)brace
DECL|function|schizo_init
r_void
id|__init
id|schizo_init
c_func
(paren
r_int
id|node
comma
r_char
op_star
id|model_name
)paren
(brace
r_struct
id|linux_prom64_registers
id|pr_regs
(braket
l_int|3
)braket
suffix:semicolon
r_struct
id|pci_controller_info
op_star
id|p
suffix:semicolon
r_struct
id|pci_iommu
op_star
id|iommu
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|portid
suffix:semicolon
r_int
id|is_pbm_a
comma
id|err
suffix:semicolon
id|portid
op_assign
id|prom_getintdefault
c_func
(paren
id|node
comma
l_string|&quot;portid&quot;
comma
l_int|0xff
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pci_controller_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|pci_controller_root
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;portid
op_eq
id|portid
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pci_controller_lock
comma
id|flags
)paren
suffix:semicolon
id|is_pbm_a
op_assign
(paren
id|p-&gt;pbm_A.prom_node
op_eq
l_int|0
)paren
suffix:semicolon
id|schizo_pbm_init
c_func
(paren
id|p
comma
id|node
comma
id|is_pbm_a
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pci_controller_lock
comma
id|flags
)paren
suffix:semicolon
id|p
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pci_controller_info
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SCHIZO: Fatal memory allocation error.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|p
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|p
)paren
)paren
suffix:semicolon
id|iommu
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pci_iommu
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iommu
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SCHIZO: Fatal memory allocation error.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|iommu
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|iommu
)paren
)paren
suffix:semicolon
id|p-&gt;pbm_A.iommu
op_assign
id|iommu
suffix:semicolon
id|iommu
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pci_iommu
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iommu
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SCHIZO: Fatal memory allocation error.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|iommu
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|iommu
)paren
)paren
suffix:semicolon
id|p-&gt;pbm_B.iommu
op_assign
id|iommu
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pci_controller_lock
comma
id|flags
)paren
suffix:semicolon
id|p-&gt;next
op_assign
id|pci_controller_root
suffix:semicolon
id|pci_controller_root
op_assign
id|p
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pci_controller_lock
comma
id|flags
)paren
suffix:semicolon
id|p-&gt;portid
op_assign
id|portid
suffix:semicolon
id|p-&gt;index
op_assign
id|pci_num_controllers
op_increment
suffix:semicolon
id|p-&gt;pbms_same_domain
op_assign
l_int|0
suffix:semicolon
id|p-&gt;scan_bus
op_assign
id|schizo_scan_bus
suffix:semicolon
id|p-&gt;irq_build
op_assign
id|schizo_irq_build
suffix:semicolon
id|p-&gt;base_address_update
op_assign
id|schizo_base_address_update
suffix:semicolon
id|p-&gt;resource_adjust
op_assign
id|schizo_resource_adjust
suffix:semicolon
id|p-&gt;pci_ops
op_assign
op_amp
id|schizo_ops
suffix:semicolon
multiline_comment|/* Three OBP regs:&n;&t; * 1) PBM controller regs&n;&t; * 2) Schizo front-end controller regs (same for both PBMs)&n;&t; * 3) PBM PCI config space&n;&t; */
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;reg&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|pr_regs
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|pr_regs
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
op_logical_or
id|err
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SCHIZO: Fatal error, no reg property.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|p-&gt;controller_regs
op_assign
id|pr_regs
(braket
l_int|1
)braket
dot
id|phys_addr
op_minus
l_int|0x10000UL
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI: Found SCHIZO, control regs at %016lx&bslash;n&quot;
comma
id|p-&gt;controller_regs
)paren
suffix:semicolon
multiline_comment|/* Like PSYCHO we have a 2GB aligned area for memory space. */
id|pci_memspace_mask
op_assign
l_int|0x7fffffffUL
suffix:semicolon
multiline_comment|/* Init core controller. */
id|schizo_controller_hwinit
c_func
(paren
id|p
)paren
suffix:semicolon
id|is_pbm_a
op_assign
(paren
(paren
id|pr_regs
(braket
l_int|0
)braket
dot
id|phys_addr
op_amp
l_int|0x00700000
)paren
op_eq
l_int|0x00600000
)paren
suffix:semicolon
id|schizo_pbm_init
c_func
(paren
id|p
comma
id|node
comma
id|is_pbm_a
)paren
suffix:semicolon
)brace
eof
