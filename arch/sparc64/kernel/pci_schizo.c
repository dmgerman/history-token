multiline_comment|/* $Id: pci_schizo.c,v 1.2 2001/01/12 02:43:30 davem Exp $&n; * pci_schizo.c: SCHIZO specific PCI controller support.&n; *&n; * Copyright (C) 2001 David S. Miller (davem@redhat.com)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;asm/pbm.h&gt;
macro_line|#include &lt;asm/iommu.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &quot;pci_impl.h&quot;
DECL|function|schizo_read_byte
r_static
r_int
id|schizo_read_byte
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u8
op_star
id|value
)paren
(brace
multiline_comment|/* IMPLEMENT ME */
)brace
DECL|function|schizo_read_word
r_static
r_int
id|schizo_read_word
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u16
op_star
id|value
)paren
(brace
multiline_comment|/* IMPLEMENT ME */
)brace
DECL|function|schizo_read_dword
r_static
r_int
id|schizo_read_dword
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u32
op_star
id|value
)paren
(brace
multiline_comment|/* IMPLEMENT ME */
)brace
DECL|function|schizo_write_byte
r_static
r_int
id|schizo_write_byte
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u8
id|value
)paren
(brace
multiline_comment|/* IMPLEMENT ME */
)brace
DECL|function|schizo_write_word
r_static
r_int
id|schizo_write_word
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u16
id|value
)paren
(brace
multiline_comment|/* IMPLEMENT ME */
)brace
DECL|function|schizo_write_dword
r_static
r_int
id|schizo_write_dword
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u32
id|value
)paren
(brace
multiline_comment|/* IMPLEMENT ME */
)brace
DECL|variable|schizo_ops
r_static
r_struct
id|pci_ops
id|schizo_ops
op_assign
(brace
id|schizo_read_byte
comma
id|schizo_read_word
comma
id|schizo_read_dword
comma
id|schizo_write_byte
comma
id|schizo_write_word
comma
id|schizo_write_dword
)brace
suffix:semicolon
DECL|function|schizo_scan_bus
r_static
r_void
id|__init
id|schizo_scan_bus
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
)paren
(brace
multiline_comment|/* IMPLEMENT ME */
)brace
DECL|function|schizo_irq_build
r_static
r_int
r_int
id|__init
id|schizo_irq_build
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
r_int
id|ino
)paren
(brace
multiline_comment|/* IMPLEMENT ME */
)brace
DECL|function|schizo_base_address_update
r_static
r_void
id|__init
id|schizo_base_address_update
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
id|resource
)paren
(brace
multiline_comment|/* IMPLEMENT ME */
)brace
DECL|function|schizo_resource_adjust
r_static
r_void
id|__init
id|schizo_resource_adjust
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_struct
id|resource
op_star
id|res
comma
r_struct
id|resource
op_star
id|root
)paren
(brace
multiline_comment|/* IMPLEMENT ME */
)brace
DECL|function|schizo_pbm_init
r_static
r_void
id|schizo_pbm_init
c_func
(paren
r_struct
id|pci_controller_info
op_star
id|p
comma
r_int
id|prom_node
comma
r_int
id|is_pbm_a
)paren
(brace
multiline_comment|/* IMPLEMENT ME */
)brace
DECL|function|schizo_init
r_void
id|__init
id|schizo_init
c_func
(paren
r_int
id|node
)paren
(brace
r_struct
id|linux_prom64_registers
id|pr_regs
(braket
l_int|3
)braket
suffix:semicolon
r_struct
id|pci_controller_info
op_star
id|p
suffix:semicolon
r_struct
id|pci_iommu
op_star
id|iommu
suffix:semicolon
id|u32
id|portid
suffix:semicolon
r_int
id|is_pbm_a
comma
id|err
suffix:semicolon
id|portid
op_assign
id|prom_getintdefault
c_func
(paren
id|node
comma
l_string|&quot;portid&quot;
comma
l_int|0xff
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pci_controller_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|pci_controller_root
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;portid
op_eq
id|portid
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pci_controller_lock
comma
id|flags
)paren
suffix:semicolon
id|is_pbm_a
op_assign
(paren
id|p-&gt;pbm_A.prom_node
op_eq
l_int|0
)paren
suffix:semicolon
id|schizo_pbm_init
c_func
(paren
id|p
comma
id|node
comma
id|is_pbm_a
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pci_controller_lock
comma
id|flags
)paren
suffix:semicolon
id|p
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pci_controller_info
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SCHIZO: Fatal memory allocation error.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|p
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|p
)paren
)paren
suffix:semicolon
id|iommu
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pci_iommu
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iommu
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SCHIZO: Fatal memory allocation error.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|iommu
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|iommu
)paren
)paren
suffix:semicolon
id|p-&gt;pbm_A.iommu
op_assign
id|iommu
suffix:semicolon
id|iommu
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pci_iommu
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iommu
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SCHIZO: Fatal memory allocation error.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|iommu
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|iommu
)paren
)paren
suffix:semicolon
id|p-&gt;pbm_B.iommu
op_assign
id|iommu
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pci_controller_lock
comma
id|flags
)paren
suffix:semicolon
id|p-&gt;next
op_assign
id|pci_controller_root
suffix:semicolon
id|pci_controller_root
op_assign
id|p
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pci_controller_lock
comma
id|flags
)paren
suffix:semicolon
id|p-&gt;portid
op_assign
id|portid
suffix:semicolon
id|p-&gt;index
op_assign
id|pci_num_controllers
op_increment
suffix:semicolon
id|p-&gt;scan_bus
op_assign
id|schizo_scan_bus
suffix:semicolon
id|p-&gt;irq_build
op_assign
id|schizo_irq_build
suffix:semicolon
id|p-&gt;base_address_update
op_assign
id|schizo_base_address_update
suffix:semicolon
id|p-&gt;resource_adjust
op_assign
id|schizo_resource_adjust
suffix:semicolon
id|p-&gt;pci_ops
op_assign
op_amp
id|schizo_ops
suffix:semicolon
id|pbm_init
suffix:colon
multiline_comment|/* Three OBP regs:&n;&t; * 1) PBM controller regs&n;&t; * 2) Schizo front-end controller regs (same for both PBMs)&n;&t; * 3) Unknown... (0x7ffec000000 and 0x7ffee000000 on Excalibur)&n;&t; */
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;reg&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|pr_regs
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|pr_regs
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
op_logical_or
id|err
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SCHIZO: Fatal error, no reg property.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* XXX Read REG base, record in controller/pbm structures. */
multiline_comment|/* XXX Report controller to console. */
multiline_comment|/* XXX Setup pci_memspace_mask */
multiline_comment|/* XXX Init core controller and IOMMU */
id|is_pbm_a
op_assign
id|XXX
suffix:semicolon
multiline_comment|/* Figure out this test */
id|schizo_pbm_init
c_func
(paren
id|p
comma
id|node
comma
id|is_pbm_a
)paren
suffix:semicolon
)brace
eof
