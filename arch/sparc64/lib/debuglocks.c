multiline_comment|/* $Id: debuglocks.c,v 1.9 2001/11/17 00:10:48 davem Exp $&n; * debuglocks.c: Debugging versions of SMP locking primitives.&n; *&n; * Copyright (C) 1998 David S. Miller (davem@redhat.com)&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#if defined(CONFIG_SMP) &amp;&amp; defined(CONFIG_DEBUG_SPINLOCK)
DECL|macro|GET_CALLER
mdefine_line|#define GET_CALLER(PC) __asm__ __volatile__(&quot;mov %%i7, %0&quot; : &quot;=r&quot; (PC))
DECL|function|show
r_static
r_inline
r_void
id|show
(paren
r_char
op_star
id|str
comma
id|spinlock_t
op_star
id|lock
comma
r_int
r_int
id|caller
)paren
(brace
r_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s(%p) CPU#%d stuck at %08x, owner PC(%08x):CPU(%x)&bslash;n&quot;
comma
id|str
comma
id|lock
comma
id|cpu
comma
(paren
r_int
r_int
)paren
id|caller
comma
id|lock-&gt;owner_pc
comma
id|lock-&gt;owner_cpu
)paren
suffix:semicolon
)brace
DECL|function|show_read
r_static
r_inline
r_void
id|show_read
(paren
r_char
op_star
id|str
comma
id|rwlock_t
op_star
id|lock
comma
r_int
r_int
id|caller
)paren
(brace
r_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s(%p) CPU#%d stuck at %08x, writer PC(%08x):CPU(%x)&bslash;n&quot;
comma
id|str
comma
id|lock
comma
id|cpu
comma
(paren
r_int
r_int
)paren
id|caller
comma
id|lock-&gt;writer_pc
comma
id|lock-&gt;writer_cpu
)paren
suffix:semicolon
)brace
DECL|function|show_write
r_static
r_inline
r_void
id|show_write
(paren
r_char
op_star
id|str
comma
id|rwlock_t
op_star
id|lock
comma
r_int
r_int
id|caller
)paren
(brace
r_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s(%p) CPU#%d stuck at %08x&bslash;n&quot;
comma
id|str
comma
id|lock
comma
id|cpu
comma
(paren
r_int
r_int
)paren
id|caller
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Writer: PC(%08x):CPU(%x)&bslash;n&quot;
comma
id|lock-&gt;writer_pc
comma
id|lock-&gt;writer_cpu
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Readers: 0[%08x] 1[%08x] 2[%08x] 4[%08x]&bslash;n&quot;
comma
id|lock-&gt;reader_pc
(braket
l_int|0
)braket
comma
id|lock-&gt;reader_pc
(braket
l_int|1
)braket
comma
id|lock-&gt;reader_pc
(braket
l_int|2
)braket
comma
id|lock-&gt;reader_pc
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
DECL|macro|INIT_STUCK
macro_line|#undef INIT_STUCK
DECL|macro|INIT_STUCK
mdefine_line|#define INIT_STUCK 100000000
DECL|function|_do_spin_lock
r_void
id|_do_spin_lock
c_func
(paren
id|spinlock_t
op_star
id|lock
comma
r_char
op_star
id|str
)paren
(brace
r_int
r_int
id|caller
comma
id|val
suffix:semicolon
r_int
id|stuck
op_assign
id|INIT_STUCK
suffix:semicolon
r_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_int
id|shown
op_assign
l_int|0
suffix:semicolon
id|GET_CALLER
c_func
(paren
id|caller
)paren
suffix:semicolon
id|again
suffix:colon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;ldstub [%1], %0&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|val
)paren
suffix:colon
l_string|&quot;r&quot;
(paren
op_amp
(paren
id|lock-&gt;lock
)paren
)paren
suffix:colon
l_string|&quot;memory&quot;
)paren
suffix:semicolon
id|membar
c_func
(paren
l_string|&quot;#StoreLoad | #StoreStore&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
(brace
r_while
c_loop
(paren
id|lock-&gt;lock
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|stuck
)paren
(brace
r_if
c_cond
(paren
id|shown
op_increment
op_le
l_int|2
)paren
id|show
c_func
(paren
id|str
comma
id|lock
comma
id|caller
)paren
suffix:semicolon
id|stuck
op_assign
id|INIT_STUCK
suffix:semicolon
)brace
id|membar
c_func
(paren
l_string|&quot;#LoadLoad&quot;
)paren
suffix:semicolon
)brace
r_goto
id|again
suffix:semicolon
)brace
id|lock-&gt;owner_pc
op_assign
(paren
(paren
r_int
r_int
)paren
id|caller
)paren
suffix:semicolon
id|lock-&gt;owner_cpu
op_assign
id|cpu
suffix:semicolon
id|current-&gt;thread.smp_lock_count
op_increment
suffix:semicolon
id|current-&gt;thread.smp_lock_pc
op_assign
(paren
(paren
r_int
r_int
)paren
id|caller
)paren
suffix:semicolon
)brace
DECL|function|_spin_trylock
r_int
id|_spin_trylock
c_func
(paren
id|spinlock_t
op_star
id|lock
)paren
(brace
r_int
r_int
id|val
comma
id|caller
suffix:semicolon
r_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
id|GET_CALLER
c_func
(paren
id|caller
)paren
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;ldstub [%1], %0&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|val
)paren
suffix:colon
l_string|&quot;r&quot;
(paren
op_amp
(paren
id|lock-&gt;lock
)paren
)paren
suffix:colon
l_string|&quot;memory&quot;
)paren
suffix:semicolon
id|membar
c_func
(paren
l_string|&quot;#StoreLoad | #StoreStore&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|val
)paren
(brace
id|lock-&gt;owner_pc
op_assign
(paren
(paren
r_int
r_int
)paren
id|caller
)paren
suffix:semicolon
id|lock-&gt;owner_cpu
op_assign
id|cpu
suffix:semicolon
id|current-&gt;thread.smp_lock_count
op_increment
suffix:semicolon
id|current-&gt;thread.smp_lock_pc
op_assign
(paren
(paren
r_int
r_int
)paren
id|caller
)paren
suffix:semicolon
)brace
r_return
id|val
op_eq
l_int|0
suffix:semicolon
)brace
DECL|function|_do_spin_unlock
r_void
id|_do_spin_unlock
c_func
(paren
id|spinlock_t
op_star
id|lock
)paren
(brace
id|lock-&gt;owner_pc
op_assign
l_int|0
suffix:semicolon
id|lock-&gt;owner_cpu
op_assign
id|NO_PROC_ID
suffix:semicolon
id|membar
c_func
(paren
l_string|&quot;#StoreStore | #LoadStore&quot;
)paren
suffix:semicolon
id|lock-&gt;lock
op_assign
l_int|0
suffix:semicolon
id|current-&gt;thread.smp_lock_count
op_decrement
suffix:semicolon
)brace
multiline_comment|/* Keep INIT_STUCK the same... */
DECL|function|_do_read_lock
r_void
id|_do_read_lock
(paren
id|rwlock_t
op_star
id|rw
comma
r_char
op_star
id|str
)paren
(brace
r_int
r_int
id|caller
comma
id|val
suffix:semicolon
r_int
id|stuck
op_assign
id|INIT_STUCK
suffix:semicolon
r_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_int
id|shown
op_assign
l_int|0
suffix:semicolon
id|GET_CALLER
c_func
(paren
id|caller
)paren
suffix:semicolon
id|wlock_again
suffix:colon
multiline_comment|/* Wait for any writer to go away.  */
r_while
c_loop
(paren
(paren
(paren
r_int
)paren
(paren
id|rw-&gt;lock
)paren
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|stuck
)paren
(brace
r_if
c_cond
(paren
id|shown
op_increment
op_le
l_int|2
)paren
id|show_read
c_func
(paren
id|str
comma
id|rw
comma
id|caller
)paren
suffix:semicolon
id|stuck
op_assign
id|INIT_STUCK
suffix:semicolon
)brace
id|membar
c_func
(paren
l_string|&quot;#LoadLoad&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Try once to increment the counter.  */
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;&t;ldx&t;&t;[%0], %%g5&bslash;n&quot;
l_string|&quot;&t;brlz,a,pn&t;%%g5, 2f&bslash;n&quot;
l_string|&quot;&t; mov&t;&t;1, %0&bslash;n&quot;
l_string|&quot;&t;add&t;&t;%%g5, 1, %%g7&bslash;n&quot;
l_string|&quot;&t;casx&t;&t;[%0], %%g5, %%g7&bslash;n&quot;
l_string|&quot;&t;sub&t;&t;%%g5, %%g7, %0&bslash;n&quot;
l_string|&quot;2:&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|val
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
op_amp
(paren
id|rw-&gt;lock
)paren
)paren
suffix:colon
l_string|&quot;g5&quot;
comma
l_string|&quot;g7&quot;
comma
l_string|&quot;memory&quot;
)paren
suffix:semicolon
id|membar
c_func
(paren
l_string|&quot;#StoreLoad | #StoreStore&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
r_goto
id|wlock_again
suffix:semicolon
id|rw-&gt;reader_pc
(braket
id|cpu
)braket
op_assign
(paren
(paren
r_int
r_int
)paren
id|caller
)paren
suffix:semicolon
id|current-&gt;thread.smp_lock_count
op_increment
suffix:semicolon
id|current-&gt;thread.smp_lock_pc
op_assign
(paren
(paren
r_int
r_int
)paren
id|caller
)paren
suffix:semicolon
)brace
DECL|function|_do_read_unlock
r_void
id|_do_read_unlock
(paren
id|rwlock_t
op_star
id|rw
comma
r_char
op_star
id|str
)paren
(brace
r_int
r_int
id|caller
comma
id|val
suffix:semicolon
r_int
id|stuck
op_assign
id|INIT_STUCK
suffix:semicolon
r_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_int
id|shown
op_assign
l_int|0
suffix:semicolon
id|GET_CALLER
c_func
(paren
id|caller
)paren
suffix:semicolon
multiline_comment|/* Drop our identity _first_. */
id|rw-&gt;reader_pc
(braket
id|cpu
)braket
op_assign
l_int|0
suffix:semicolon
id|current-&gt;thread.smp_lock_count
op_decrement
suffix:semicolon
id|runlock_again
suffix:colon
multiline_comment|/* Spin trying to decrement the counter using casx.  */
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;&t;ldx&t;[%0], %%g5&bslash;n&quot;
l_string|&quot;&t;sub&t;%%g5, 1, %%g7&bslash;n&quot;
l_string|&quot;&t;casx&t;[%0], %%g5, %%g7&bslash;n&quot;
l_string|&quot;&t;membar&t;#StoreLoad | #StoreStore&bslash;n&quot;
l_string|&quot;&t;sub&t;%%g5, %%g7, %0&bslash;n&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|val
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
op_amp
(paren
id|rw-&gt;lock
)paren
)paren
suffix:colon
l_string|&quot;g5&quot;
comma
l_string|&quot;g7&quot;
comma
l_string|&quot;memory&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|stuck
)paren
(brace
r_if
c_cond
(paren
id|shown
op_increment
op_le
l_int|2
)paren
id|show_read
c_func
(paren
id|str
comma
id|rw
comma
id|caller
)paren
suffix:semicolon
id|stuck
op_assign
id|INIT_STUCK
suffix:semicolon
)brace
r_goto
id|runlock_again
suffix:semicolon
)brace
)brace
DECL|function|_do_write_lock
r_void
id|_do_write_lock
(paren
id|rwlock_t
op_star
id|rw
comma
r_char
op_star
id|str
)paren
(brace
r_int
r_int
id|caller
comma
id|val
suffix:semicolon
r_int
id|stuck
op_assign
id|INIT_STUCK
suffix:semicolon
r_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_int
id|shown
op_assign
l_int|0
suffix:semicolon
id|GET_CALLER
c_func
(paren
id|caller
)paren
suffix:semicolon
id|wlock_again
suffix:colon
multiline_comment|/* Spin while there is another writer. */
r_while
c_loop
(paren
(paren
(paren
r_int
)paren
id|rw-&gt;lock
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|stuck
)paren
(brace
r_if
c_cond
(paren
id|shown
op_increment
op_le
l_int|2
)paren
id|show_write
c_func
(paren
id|str
comma
id|rw
comma
id|caller
)paren
suffix:semicolon
id|stuck
op_assign
id|INIT_STUCK
suffix:semicolon
)brace
id|membar
c_func
(paren
l_string|&quot;#LoadLoad&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Try to acuire the write bit.  */
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;&t;mov&t;1, %%g3&bslash;n&quot;
l_string|&quot;&t;sllx&t;%%g3, 63, %%g3&bslash;n&quot;
l_string|&quot;&t;ldx&t;[%0], %%g5&bslash;n&quot;
l_string|&quot;&t;brlz,pn&t;%%g5, 1f&bslash;n&quot;
l_string|&quot;&t; or&t;%%g5, %%g3, %%g7&bslash;n&quot;
l_string|&quot;&t;casx&t;[%0], %%g5, %%g7&bslash;n&quot;
l_string|&quot;&t;membar&t;#StoreLoad | #StoreStore&bslash;n&quot;
l_string|&quot;&t;ba,pt&t;%%xcc, 2f&bslash;n&quot;
l_string|&quot;&t; sub&t;%%g5, %%g7, %0&bslash;n&quot;
l_string|&quot;1:&t;mov&t;1, %0&bslash;n&quot;
l_string|&quot;2:&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|val
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
op_amp
(paren
id|rw-&gt;lock
)paren
)paren
suffix:colon
l_string|&quot;g3&quot;
comma
l_string|&quot;g5&quot;
comma
l_string|&quot;g7&quot;
comma
l_string|&quot;memory&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
(brace
multiline_comment|/* We couldn&squot;t get the write bit. */
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|stuck
)paren
(brace
r_if
c_cond
(paren
id|shown
op_increment
op_le
l_int|2
)paren
id|show_write
c_func
(paren
id|str
comma
id|rw
comma
id|caller
)paren
suffix:semicolon
id|stuck
op_assign
id|INIT_STUCK
suffix:semicolon
)brace
r_goto
id|wlock_again
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rw-&gt;lock
op_amp
(paren
(paren
l_int|1UL
op_lshift
l_int|63
)paren
op_minus
l_int|1UL
)paren
)paren
op_ne
l_int|0UL
)paren
(brace
multiline_comment|/* Readers still around, drop the write&n;&t;&t; * lock, spin, and try again.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|stuck
)paren
(brace
r_if
c_cond
(paren
id|shown
op_increment
op_le
l_int|2
)paren
id|show_write
c_func
(paren
id|str
comma
id|rw
comma
id|caller
)paren
suffix:semicolon
id|stuck
op_assign
id|INIT_STUCK
suffix:semicolon
)brace
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;&t;&t;mov&t;1, %%g3&bslash;n&quot;
l_string|&quot;&t;&t;sllx&t;%%g3, 63, %%g3&bslash;n&quot;
l_string|&quot;1:&t;&t;ldx&t;[%0], %%g5&bslash;n&quot;
l_string|&quot;&t;&t;andn&t;%%g5, %%g3, %%g7&bslash;n&quot;
l_string|&quot;&t;&t;casx&t;[%0], %%g5, %%g7&bslash;n&quot;
l_string|&quot;&t;&t;cmp&t;%%g5, %%g7&bslash;n&quot;
l_string|&quot;&t;&t;bne,pn&t;%%xcc, 1b&bslash;n&quot;
l_string|&quot;&t;&t; membar&t;#StoreLoad | #StoreStore&quot;
suffix:colon
multiline_comment|/* no outputs */
suffix:colon
l_string|&quot;r&quot;
(paren
op_amp
(paren
id|rw-&gt;lock
)paren
)paren
suffix:colon
l_string|&quot;g3&quot;
comma
l_string|&quot;g5&quot;
comma
l_string|&quot;g7&quot;
comma
l_string|&quot;cc&quot;
comma
l_string|&quot;memory&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|rw-&gt;lock
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|stuck
)paren
(brace
r_if
c_cond
(paren
id|shown
op_increment
op_le
l_int|2
)paren
id|show_write
c_func
(paren
id|str
comma
id|rw
comma
id|caller
)paren
suffix:semicolon
id|stuck
op_assign
id|INIT_STUCK
suffix:semicolon
)brace
id|membar
c_func
(paren
l_string|&quot;#LoadLoad&quot;
)paren
suffix:semicolon
)brace
r_goto
id|wlock_again
suffix:semicolon
)brace
multiline_comment|/* We have it, say who we are. */
id|rw-&gt;writer_pc
op_assign
(paren
(paren
r_int
r_int
)paren
id|caller
)paren
suffix:semicolon
id|rw-&gt;writer_cpu
op_assign
id|cpu
suffix:semicolon
id|current-&gt;thread.smp_lock_count
op_increment
suffix:semicolon
id|current-&gt;thread.smp_lock_pc
op_assign
(paren
(paren
r_int
r_int
)paren
id|caller
)paren
suffix:semicolon
)brace
DECL|function|_do_write_unlock
r_void
id|_do_write_unlock
c_func
(paren
id|rwlock_t
op_star
id|rw
)paren
(brace
r_int
r_int
id|caller
comma
id|val
suffix:semicolon
r_int
id|stuck
op_assign
id|INIT_STUCK
suffix:semicolon
r_int
id|shown
op_assign
l_int|0
suffix:semicolon
id|GET_CALLER
c_func
(paren
id|caller
)paren
suffix:semicolon
multiline_comment|/* Drop our identity _first_ */
id|rw-&gt;writer_pc
op_assign
l_int|0
suffix:semicolon
id|rw-&gt;writer_cpu
op_assign
id|NO_PROC_ID
suffix:semicolon
id|current-&gt;thread.smp_lock_count
op_decrement
suffix:semicolon
id|wlock_again
suffix:colon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;&t;mov&t;1, %%g3&bslash;n&quot;
l_string|&quot;&t;sllx&t;%%g3, 63, %%g3&bslash;n&quot;
l_string|&quot;&t;ldx&t;[%0], %%g5&bslash;n&quot;
l_string|&quot;&t;andn&t;%%g5, %%g3, %%g7&bslash;n&quot;
l_string|&quot;&t;casx&t;[%0], %%g5, %%g7&bslash;n&quot;
l_string|&quot;&t;membar&t;#StoreLoad | #StoreStore&bslash;n&quot;
l_string|&quot;&t;sub&t;%%g5, %%g7, %0&bslash;n&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|val
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
op_amp
(paren
id|rw-&gt;lock
)paren
)paren
suffix:colon
l_string|&quot;g3&quot;
comma
l_string|&quot;g5&quot;
comma
l_string|&quot;g7&quot;
comma
l_string|&quot;memory&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|stuck
)paren
(brace
r_if
c_cond
(paren
id|shown
op_increment
op_le
l_int|2
)paren
id|show_write
c_func
(paren
l_string|&quot;write_unlock&quot;
comma
id|rw
comma
id|caller
)paren
suffix:semicolon
id|stuck
op_assign
id|INIT_STUCK
suffix:semicolon
)brace
r_goto
id|wlock_again
suffix:semicolon
)brace
)brace
DECL|function|atomic_dec_and_lock
r_int
id|atomic_dec_and_lock
c_func
(paren
id|atomic_t
op_star
id|atomic
comma
id|spinlock_t
op_star
id|lock
)paren
(brace
id|spin_lock
c_func
(paren
id|lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
id|atomic
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|spin_unlock
c_func
(paren
id|lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_SMP &amp;&amp; CONFIG_DEBUG_SPINLOCK */
eof
