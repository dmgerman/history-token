multiline_comment|/*&n; * arch/sh/boards/superh/microdev/setup.c&n; *&n; * Copyright (C) 2003 Sean McGoogan (Sean.McGoogan@superh.com)&n; * Copyright (C) 2003, 2004 SuperH, Inc.&n; * Copyright (C) 2004 Paul Mundt&n; *&n; * SuperH SH4-202 MicroDev board support.&n; *&n; * May be copied or modified under the terms of the GNU General Public&n; * License.  See linux/COPYING for more information.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/mach/irq.h&gt;
macro_line|#include &lt;asm/mach/io.h&gt;
macro_line|#include &lt;asm/machvec.h&gt;
macro_line|#include &lt;asm/machvec_init.h&gt;
r_extern
r_void
id|microdev_heartbeat
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/*&n; * The Machine Vector&n; */
DECL|variable|__initmv
r_struct
id|sh_machine_vector
id|mv_sh4202_microdev
id|__initmv
op_assign
(brace
dot
id|mv_nr_irqs
op_assign
l_int|72
comma
multiline_comment|/* QQQ need to check this - use the MACRO */
dot
id|mv_inb
op_assign
id|microdev_inb
comma
dot
id|mv_inw
op_assign
id|microdev_inw
comma
dot
id|mv_inl
op_assign
id|microdev_inl
comma
dot
id|mv_outb
op_assign
id|microdev_outb
comma
dot
id|mv_outw
op_assign
id|microdev_outw
comma
dot
id|mv_outl
op_assign
id|microdev_outl
comma
dot
id|mv_inb_p
op_assign
id|microdev_inb_p
comma
dot
id|mv_inw_p
op_assign
id|microdev_inw_p
comma
dot
id|mv_inl_p
op_assign
id|microdev_inl_p
comma
dot
id|mv_outb_p
op_assign
id|microdev_outb_p
comma
dot
id|mv_outw_p
op_assign
id|microdev_outw_p
comma
dot
id|mv_outl_p
op_assign
id|microdev_outl_p
comma
dot
id|mv_insb
op_assign
id|microdev_insb
comma
dot
id|mv_insw
op_assign
id|microdev_insw
comma
dot
id|mv_insl
op_assign
id|microdev_insl
comma
dot
id|mv_outsb
op_assign
id|microdev_outsb
comma
dot
id|mv_outsw
op_assign
id|microdev_outsw
comma
dot
id|mv_outsl
op_assign
id|microdev_outsl
comma
dot
id|mv_isa_port2addr
op_assign
id|microdev_isa_port2addr
comma
dot
id|mv_init_irq
op_assign
id|init_microdev_irq
comma
macro_line|#ifdef CONFIG_HEARTBEAT
dot
id|mv_heartbeat
op_assign
id|microdev_heartbeat
comma
macro_line|#endif
)brace
suffix:semicolon
id|ALIAS_MV
c_func
(paren
id|sh4202_microdev
)paren
multiline_comment|/****************************************************************************/
multiline_comment|/*&n;&t; * Setup for the SMSC FDC37C93xAPM&n;&t; */
DECL|macro|SMSC_CONFIG_PORT_ADDR
mdefine_line|#define SMSC_CONFIG_PORT_ADDR&t; (0x3F0)
DECL|macro|SMSC_INDEX_PORT_ADDR
mdefine_line|#define SMSC_INDEX_PORT_ADDR&t; SMSC_CONFIG_PORT_ADDR
DECL|macro|SMSC_DATA_PORT_ADDR
mdefine_line|#define SMSC_DATA_PORT_ADDR&t; (SMSC_INDEX_PORT_ADDR + 1)
DECL|macro|SMSC_ENTER_CONFIG_KEY
mdefine_line|#define SMSC_ENTER_CONFIG_KEY&t; 0x55
DECL|macro|SMSC_EXIT_CONFIG_KEY
mdefine_line|#define SMSC_EXIT_CONFIG_KEY&t; 0xaa
DECL|macro|SMCS_LOGICAL_DEV_INDEX
mdefine_line|#define SMCS_LOGICAL_DEV_INDEX &t; 0x07&t;/* Logical Device Number */
DECL|macro|SMSC_DEVICE_ID_INDEX
mdefine_line|#define SMSC_DEVICE_ID_INDEX&t; 0x20&t;/* Device ID */
DECL|macro|SMSC_DEVICE_REV_INDEX
mdefine_line|#define SMSC_DEVICE_REV_INDEX&t; 0x21&t;/* Device Revision */
DECL|macro|SMSC_ACTIVATE_INDEX
mdefine_line|#define SMSC_ACTIVATE_INDEX&t; 0x30&t;/* Activate */
DECL|macro|SMSC_PRIMARY_BASE_INDEX
mdefine_line|#define SMSC_PRIMARY_BASE_INDEX&t; 0x60&t;/* Primary Base Address */
DECL|macro|SMSC_SECONDARY_BASE_INDEX
mdefine_line|#define SMSC_SECONDARY_BASE_INDEX 0x62&t;/* Secondary Base Address */
DECL|macro|SMSC_PRIMARY_INT_INDEX
mdefine_line|#define SMSC_PRIMARY_INT_INDEX&t; 0x70&t;/* Primary Interrupt Select */
DECL|macro|SMSC_SECONDARY_INT_INDEX
mdefine_line|#define SMSC_SECONDARY_INT_INDEX 0x72&t;/* Secondary Interrupt Select */
DECL|macro|SMSC_HDCS0_INDEX
mdefine_line|#define SMSC_HDCS0_INDEX&t; 0xf0&t;/* HDCS0 Address Decoder */
DECL|macro|SMSC_HDCS1_INDEX
mdefine_line|#define SMSC_HDCS1_INDEX&t; 0xf1&t;/* HDCS1 Address Decoder */
DECL|macro|SMSC_IDE1_DEVICE
mdefine_line|#define SMSC_IDE1_DEVICE&t;1&t;/* IDE #1 logical device */
DECL|macro|SMSC_IDE2_DEVICE
mdefine_line|#define SMSC_IDE2_DEVICE&t;2&t;/* IDE #2 logical device */
DECL|macro|SMSC_PARALLEL_DEVICE
mdefine_line|#define SMSC_PARALLEL_DEVICE&t;3&t;/* Parallel Port logical device */
DECL|macro|SMSC_SERIAL1_DEVICE
mdefine_line|#define SMSC_SERIAL1_DEVICE&t;4&t;/* Serial #1 logical device */
DECL|macro|SMSC_SERIAL2_DEVICE
mdefine_line|#define SMSC_SERIAL2_DEVICE&t;5&t;/* Serial #2 logical device */
DECL|macro|SMSC_KEYBOARD_DEVICE
mdefine_line|#define SMSC_KEYBOARD_DEVICE&t;7&t;/* Keyboard logical device */
DECL|macro|SMSC_CONFIG_REGISTERS
mdefine_line|#define SMSC_CONFIG_REGISTERS&t;8&t;/* Configuration Registers (Aux I/O) */
DECL|macro|SMSC_READ_INDEXED
mdefine_line|#define SMSC_READ_INDEXED(index) ({ &bslash;&n;&t;outb((index), SMSC_INDEX_PORT_ADDR); &bslash;&n;&t;inb(SMSC_DATA_PORT_ADDR); })
DECL|macro|SMSC_WRITE_INDEXED
mdefine_line|#define SMSC_WRITE_INDEXED(val, index) ({ &bslash;&n;&t;outb((index), SMSC_INDEX_PORT_ADDR); &bslash;&n;&t;outb((val),   SMSC_DATA_PORT_ADDR); })
DECL|macro|IDE1_PRIMARY_BASE
mdefine_line|#define&t;IDE1_PRIMARY_BASE&t;0x01f0&t;/* Task File Registe base for IDE #1 */
DECL|macro|IDE1_SECONDARY_BASE
mdefine_line|#define&t;IDE1_SECONDARY_BASE&t;0x03f6&t;/* Miscellaneous AT registers for IDE #1 */
DECL|macro|IDE2_PRIMARY_BASE
mdefine_line|#define&t;IDE2_PRIMARY_BASE&t;0x0170&t;/* Task File Registe base for IDE #2 */
DECL|macro|IDE2_SECONDARY_BASE
mdefine_line|#define&t;IDE2_SECONDARY_BASE&t;0x0376&t;/* Miscellaneous AT registers for IDE #2 */
DECL|macro|SERIAL1_PRIMARY_BASE
mdefine_line|#define SERIAL1_PRIMARY_BASE&t;0x03f8
DECL|macro|SERIAL2_PRIMARY_BASE
mdefine_line|#define SERIAL2_PRIMARY_BASE&t;0x02f8
DECL|macro|MSB
mdefine_line|#define&t;MSB(x)&t;&t;( (x) &gt;&gt; 8 )
DECL|macro|LSB
mdefine_line|#define&t;LSB(x)&t;&t;( (x) &amp; 0xff )
multiline_comment|/* General-Purpose base address on CPU-board FPGA */
DECL|macro|MICRODEV_FPGA_GP_BASE
mdefine_line|#define&t;MICRODEV_FPGA_GP_BASE&t;&t;0xa6100000ul
multiline_comment|/* assume a Keyboard Controller is present */
r_int
id|microdev_kbd_controller_present
op_assign
l_int|1
suffix:semicolon
DECL|function|get_system_type
r_const
r_char
op_star
id|get_system_type
c_func
(paren
r_void
)paren
(brace
r_return
l_string|&quot;SH4-202 MicroDev&quot;
suffix:semicolon
)brace
DECL|variable|smc91x_resources
r_static
r_struct
id|resource
id|smc91x_resources
(braket
)braket
op_assign
(brace
(braket
l_int|0
)braket
op_assign
(brace
dot
id|start
op_assign
l_int|0x300
comma
dot
id|end
op_assign
l_int|0x300
op_plus
l_int|0x0001000
op_minus
l_int|1
comma
dot
id|flags
op_assign
id|IORESOURCE_MEM
comma
)brace
comma
(braket
l_int|1
)braket
op_assign
(brace
dot
id|start
op_assign
id|MICRODEV_LINUX_IRQ_ETHERNET
comma
dot
id|end
op_assign
id|MICRODEV_LINUX_IRQ_ETHERNET
comma
dot
id|flags
op_assign
id|IORESOURCE_IRQ
comma
)brace
comma
)brace
suffix:semicolon
DECL|variable|smc91x_device
r_static
r_struct
id|platform_device
id|smc91x_device
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;smc91x&quot;
comma
dot
id|id
op_assign
op_minus
l_int|1
comma
dot
id|num_resources
op_assign
id|ARRAY_SIZE
c_func
(paren
id|smc91x_resources
)paren
comma
dot
id|resource
op_assign
id|smc91x_resources
comma
)brace
suffix:semicolon
DECL|function|smc91x_setup
r_static
r_int
id|__init
id|smc91x_setup
c_func
(paren
r_void
)paren
(brace
r_return
id|platform_device_register
c_func
(paren
op_amp
id|smc91x_device
)paren
suffix:semicolon
)brace
DECL|variable|smc91x_setup
id|__initcall
c_func
(paren
id|smc91x_setup
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Initialize the board&n;&t; */
DECL|function|platform_setup
r_void
id|__init
id|platform_setup
c_func
(paren
r_void
)paren
(brace
r_int
op_star
r_const
id|fpgaRevisionRegister
op_assign
(paren
r_int
op_star
)paren
(paren
id|MICRODEV_FPGA_GP_BASE
op_plus
l_int|0x8ul
)paren
suffix:semicolon
r_const
r_int
id|fpgaRevision
op_assign
op_star
id|fpgaRevisionRegister
suffix:semicolon
r_int
op_star
r_const
id|CacheControlRegister
op_assign
(paren
r_int
op_star
)paren
id|CCR
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SuperH %s board (FPGA rev: 0x%0x, CCR: 0x%0x)&bslash;n&quot;
comma
id|get_system_type
c_func
(paren
)paren
comma
id|fpgaRevision
comma
op_star
id|CacheControlRegister
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*&n;&t; * Setup for the SMSC FDC37C93xAPM&n;&t; */
DECL|function|smsc_superio_setup
r_static
r_int
id|__init
id|smsc_superio_setup
c_func
(paren
r_void
)paren
(brace
r_int
r_char
id|devid
comma
id|devrev
suffix:semicolon
multiline_comment|/* Initially the chip is in run state */
multiline_comment|/* Put it into configuration state */
id|outb
c_func
(paren
id|SMSC_ENTER_CONFIG_KEY
comma
id|SMSC_CONFIG_PORT_ADDR
)paren
suffix:semicolon
multiline_comment|/* Read device ID info */
id|devid
op_assign
id|SMSC_READ_INDEXED
c_func
(paren
id|SMSC_DEVICE_ID_INDEX
)paren
suffix:semicolon
id|devrev
op_assign
id|SMSC_READ_INDEXED
c_func
(paren
id|SMSC_DEVICE_REV_INDEX
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|devid
op_eq
l_int|0x30
)paren
op_logical_and
(paren
id|devrev
op_eq
l_int|0x01
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SMSC FDC37C93xAPM SuperIO device detected&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* not the device identity we expected */
id|printk
c_func
(paren
l_string|&quot;Not detected a SMSC FDC37C93xAPM SuperIO device (devid=0x%02x, rev=0x%02x)&bslash;n&quot;
comma
id|devid
comma
id|devrev
)paren
suffix:semicolon
multiline_comment|/* inform the keyboard driver that we have no keyboard controller */
id|microdev_kbd_controller_present
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* little point in doing anything else in this functon */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Select the keyboard device */
id|SMSC_WRITE_INDEXED
c_func
(paren
id|SMSC_KEYBOARD_DEVICE
comma
id|SMCS_LOGICAL_DEV_INDEX
)paren
suffix:semicolon
multiline_comment|/* enable it */
id|SMSC_WRITE_INDEXED
c_func
(paren
l_int|1
comma
id|SMSC_ACTIVATE_INDEX
)paren
suffix:semicolon
multiline_comment|/* enable the interrupts */
id|SMSC_WRITE_INDEXED
c_func
(paren
id|MICRODEV_FPGA_IRQ_KEYBOARD
comma
id|SMSC_PRIMARY_INT_INDEX
)paren
suffix:semicolon
id|SMSC_WRITE_INDEXED
c_func
(paren
id|MICRODEV_FPGA_IRQ_MOUSE
comma
id|SMSC_SECONDARY_INT_INDEX
)paren
suffix:semicolon
multiline_comment|/* Select the Serial #1 device */
id|SMSC_WRITE_INDEXED
c_func
(paren
id|SMSC_SERIAL1_DEVICE
comma
id|SMCS_LOGICAL_DEV_INDEX
)paren
suffix:semicolon
multiline_comment|/* enable it */
id|SMSC_WRITE_INDEXED
c_func
(paren
l_int|1
comma
id|SMSC_ACTIVATE_INDEX
)paren
suffix:semicolon
multiline_comment|/* program with port addresses */
id|SMSC_WRITE_INDEXED
c_func
(paren
id|MSB
c_func
(paren
id|SERIAL1_PRIMARY_BASE
)paren
comma
id|SMSC_PRIMARY_BASE_INDEX
op_plus
l_int|0
)paren
suffix:semicolon
id|SMSC_WRITE_INDEXED
c_func
(paren
id|LSB
c_func
(paren
id|SERIAL1_PRIMARY_BASE
)paren
comma
id|SMSC_PRIMARY_BASE_INDEX
op_plus
l_int|1
)paren
suffix:semicolon
id|SMSC_WRITE_INDEXED
c_func
(paren
l_int|0x00
comma
id|SMSC_HDCS0_INDEX
)paren
suffix:semicolon
multiline_comment|/* enable the interrupts */
id|SMSC_WRITE_INDEXED
c_func
(paren
id|MICRODEV_FPGA_IRQ_SERIAL1
comma
id|SMSC_PRIMARY_INT_INDEX
)paren
suffix:semicolon
multiline_comment|/* Select the Serial #2 device */
id|SMSC_WRITE_INDEXED
c_func
(paren
id|SMSC_SERIAL2_DEVICE
comma
id|SMCS_LOGICAL_DEV_INDEX
)paren
suffix:semicolon
multiline_comment|/* enable it */
id|SMSC_WRITE_INDEXED
c_func
(paren
l_int|1
comma
id|SMSC_ACTIVATE_INDEX
)paren
suffix:semicolon
multiline_comment|/* program with port addresses */
id|SMSC_WRITE_INDEXED
c_func
(paren
id|MSB
c_func
(paren
id|SERIAL2_PRIMARY_BASE
)paren
comma
id|SMSC_PRIMARY_BASE_INDEX
op_plus
l_int|0
)paren
suffix:semicolon
id|SMSC_WRITE_INDEXED
c_func
(paren
id|LSB
c_func
(paren
id|SERIAL2_PRIMARY_BASE
)paren
comma
id|SMSC_PRIMARY_BASE_INDEX
op_plus
l_int|1
)paren
suffix:semicolon
id|SMSC_WRITE_INDEXED
c_func
(paren
l_int|0x00
comma
id|SMSC_HDCS0_INDEX
)paren
suffix:semicolon
multiline_comment|/* enable the interrupts */
id|SMSC_WRITE_INDEXED
c_func
(paren
id|MICRODEV_FPGA_IRQ_SERIAL2
comma
id|SMSC_PRIMARY_INT_INDEX
)paren
suffix:semicolon
multiline_comment|/* Select the IDE#1 device */
id|SMSC_WRITE_INDEXED
c_func
(paren
id|SMSC_IDE1_DEVICE
comma
id|SMCS_LOGICAL_DEV_INDEX
)paren
suffix:semicolon
multiline_comment|/* enable it */
id|SMSC_WRITE_INDEXED
c_func
(paren
l_int|1
comma
id|SMSC_ACTIVATE_INDEX
)paren
suffix:semicolon
multiline_comment|/* program with port addresses */
id|SMSC_WRITE_INDEXED
c_func
(paren
id|MSB
c_func
(paren
id|IDE1_PRIMARY_BASE
)paren
comma
id|SMSC_PRIMARY_BASE_INDEX
op_plus
l_int|0
)paren
suffix:semicolon
id|SMSC_WRITE_INDEXED
c_func
(paren
id|LSB
c_func
(paren
id|IDE1_PRIMARY_BASE
)paren
comma
id|SMSC_PRIMARY_BASE_INDEX
op_plus
l_int|1
)paren
suffix:semicolon
id|SMSC_WRITE_INDEXED
c_func
(paren
id|MSB
c_func
(paren
id|IDE1_SECONDARY_BASE
)paren
comma
id|SMSC_SECONDARY_BASE_INDEX
op_plus
l_int|0
)paren
suffix:semicolon
id|SMSC_WRITE_INDEXED
c_func
(paren
id|LSB
c_func
(paren
id|IDE1_SECONDARY_BASE
)paren
comma
id|SMSC_SECONDARY_BASE_INDEX
op_plus
l_int|1
)paren
suffix:semicolon
id|SMSC_WRITE_INDEXED
c_func
(paren
l_int|0x0c
comma
id|SMSC_HDCS0_INDEX
)paren
suffix:semicolon
id|SMSC_WRITE_INDEXED
c_func
(paren
l_int|0x00
comma
id|SMSC_HDCS1_INDEX
)paren
suffix:semicolon
multiline_comment|/* select the interrupt */
id|SMSC_WRITE_INDEXED
c_func
(paren
id|MICRODEV_FPGA_IRQ_IDE1
comma
id|SMSC_PRIMARY_INT_INDEX
)paren
suffix:semicolon
multiline_comment|/* Select the IDE#2 device */
id|SMSC_WRITE_INDEXED
c_func
(paren
id|SMSC_IDE2_DEVICE
comma
id|SMCS_LOGICAL_DEV_INDEX
)paren
suffix:semicolon
multiline_comment|/* enable it */
id|SMSC_WRITE_INDEXED
c_func
(paren
l_int|1
comma
id|SMSC_ACTIVATE_INDEX
)paren
suffix:semicolon
multiline_comment|/* program with port addresses */
id|SMSC_WRITE_INDEXED
c_func
(paren
id|MSB
c_func
(paren
id|IDE2_PRIMARY_BASE
)paren
comma
id|SMSC_PRIMARY_BASE_INDEX
op_plus
l_int|0
)paren
suffix:semicolon
id|SMSC_WRITE_INDEXED
c_func
(paren
id|LSB
c_func
(paren
id|IDE2_PRIMARY_BASE
)paren
comma
id|SMSC_PRIMARY_BASE_INDEX
op_plus
l_int|1
)paren
suffix:semicolon
id|SMSC_WRITE_INDEXED
c_func
(paren
id|MSB
c_func
(paren
id|IDE2_SECONDARY_BASE
)paren
comma
id|SMSC_SECONDARY_BASE_INDEX
op_plus
l_int|0
)paren
suffix:semicolon
id|SMSC_WRITE_INDEXED
c_func
(paren
id|LSB
c_func
(paren
id|IDE2_SECONDARY_BASE
)paren
comma
id|SMSC_SECONDARY_BASE_INDEX
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* select the interrupt */
id|SMSC_WRITE_INDEXED
c_func
(paren
id|MICRODEV_FPGA_IRQ_IDE2
comma
id|SMSC_PRIMARY_INT_INDEX
)paren
suffix:semicolon
multiline_comment|/* Select the configuration registers */
id|SMSC_WRITE_INDEXED
c_func
(paren
id|SMSC_CONFIG_REGISTERS
comma
id|SMCS_LOGICAL_DEV_INDEX
)paren
suffix:semicolon
multiline_comment|/* enable the appropriate GPIO pins for IDE functionality:&n;&t;&t; * bit[0]   In/Out&t;&t;1==input;  0==output&n;&t;&t; * bit[1]   Polarity&t;&t;1==invert; 0==no invert&n;&t;&t; * bit[2]   Int Enb #1&t;&t;1==Enable Combined IRQ #1; 0==disable&n;&t;&t; * bit[3:4] Function Select&t;00==original; 01==Alternate Function #1&n;&t;&t; */
id|SMSC_WRITE_INDEXED
c_func
(paren
l_int|0x00
comma
l_int|0xc2
)paren
suffix:semicolon
multiline_comment|/* GP42 = nIDE1_OE */
id|SMSC_WRITE_INDEXED
c_func
(paren
l_int|0x01
comma
l_int|0xc5
)paren
suffix:semicolon
multiline_comment|/* GP45 = IDE1_IRQ */
id|SMSC_WRITE_INDEXED
c_func
(paren
l_int|0x00
comma
l_int|0xc6
)paren
suffix:semicolon
multiline_comment|/* GP46 = nIOROP */
id|SMSC_WRITE_INDEXED
c_func
(paren
l_int|0x00
comma
l_int|0xc7
)paren
suffix:semicolon
multiline_comment|/* GP47 = nIOWOP */
id|SMSC_WRITE_INDEXED
c_func
(paren
l_int|0x08
comma
l_int|0xe8
)paren
suffix:semicolon
multiline_comment|/* GP20 = nIDE2_OE */
multiline_comment|/* Exit the configuraton state */
id|outb
c_func
(paren
id|SMSC_EXIT_CONFIG_KEY
comma
id|SMSC_CONFIG_PORT_ADDR
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This is grotty, but, because kernel is always referenced on the link line&n; * before any devices, this is safe.&n; */
DECL|variable|smsc_superio_setup
id|__initcall
c_func
(paren
id|smsc_superio_setup
)paren
suffix:semicolon
eof
