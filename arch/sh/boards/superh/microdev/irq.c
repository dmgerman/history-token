multiline_comment|/*&n; * arch/sh/boards/superh/microdev/irq.c&n; *&n; * Copyright (C) 2003 Sean McGoogan (Sean.McGoogan@superh.com)&n; *&n; * SuperH SH4-202 MicroDev board support.&n; *&n; * May be copied or modified under the terms of the GNU General Public&n; * License.  See linux/COPYING for more information.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/mach/irq.h&gt;
DECL|macro|NUM_EXTERNAL_IRQS
mdefine_line|#define NUM_EXTERNAL_IRQS 16&t;/* IRL0 .. IRL15 */
r_static
r_const
r_struct
(brace
DECL|member|fpgaIrq
r_int
r_char
id|fpgaIrq
suffix:semicolon
DECL|member|mapped
r_int
r_char
id|mapped
suffix:semicolon
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|variable|fpgaIrqTable
)brace
id|fpgaIrqTable
(braket
id|NUM_EXTERNAL_IRQS
)braket
op_assign
(brace
(brace
l_int|0
comma
l_int|0
comma
l_string|&quot;unused&quot;
)brace
comma
multiline_comment|/* IRQ #0&t;IRL=15&t;0x200  */
(brace
id|MICRODEV_FPGA_IRQ_KEYBOARD
comma
l_int|1
comma
l_string|&quot;keyboard&quot;
)brace
comma
multiline_comment|/* IRQ #1&t;IRL=14&t;0x220  */
(brace
id|MICRODEV_FPGA_IRQ_SERIAL1
comma
l_int|1
comma
l_string|&quot;Serial #1&quot;
)brace
comma
multiline_comment|/* IRQ #2&t;IRL=13&t;0x240  */
(brace
id|MICRODEV_FPGA_IRQ_ETHERNET
comma
l_int|1
comma
l_string|&quot;Ethernet&quot;
)brace
comma
multiline_comment|/* IRQ #3&t;IRL=12&t;0x260  */
(brace
id|MICRODEV_FPGA_IRQ_SERIAL2
comma
l_int|0
comma
l_string|&quot;Serial #2&quot;
)brace
comma
multiline_comment|/* IRQ #4&t;IRL=11&t;0x280  */
(brace
l_int|0
comma
l_int|0
comma
l_string|&quot;unused&quot;
)brace
comma
multiline_comment|/* IRQ #5&t;IRL=10&t;0x2a0  */
(brace
l_int|0
comma
l_int|0
comma
l_string|&quot;unused&quot;
)brace
comma
multiline_comment|/* IRQ #6&t;IRL=9&t;0x2c0  */
(brace
id|MICRODEV_FPGA_IRQ_USB_HC
comma
l_int|1
comma
l_string|&quot;USB&quot;
)brace
comma
multiline_comment|/* IRQ #7&t;IRL=8&t;0x2e0  */
(brace
id|MICRODEV_IRQ_PCI_INTA
comma
l_int|1
comma
l_string|&quot;PCI INTA&quot;
)brace
comma
multiline_comment|/* IRQ #8&t;IRL=7&t;0x300  */
(brace
id|MICRODEV_IRQ_PCI_INTB
comma
l_int|1
comma
l_string|&quot;PCI INTB&quot;
)brace
comma
multiline_comment|/* IRQ #9&t;IRL=6&t;0x320  */
(brace
id|MICRODEV_IRQ_PCI_INTC
comma
l_int|1
comma
l_string|&quot;PCI INTC&quot;
)brace
comma
multiline_comment|/* IRQ #10&t;IRL=5&t;0x340  */
(brace
id|MICRODEV_IRQ_PCI_INTD
comma
l_int|1
comma
l_string|&quot;PCI INTD&quot;
)brace
comma
multiline_comment|/* IRQ #11&t;IRL=4&t;0x360  */
(brace
id|MICRODEV_FPGA_IRQ_MOUSE
comma
l_int|1
comma
l_string|&quot;mouse&quot;
)brace
comma
multiline_comment|/* IRQ #12&t;IRL=3&t;0x380  */
(brace
id|MICRODEV_FPGA_IRQ_IDE2
comma
l_int|1
comma
l_string|&quot;IDE #2&quot;
)brace
comma
multiline_comment|/* IRQ #13&t;IRL=2&t;0x3a0  */
(brace
id|MICRODEV_FPGA_IRQ_IDE1
comma
l_int|1
comma
l_string|&quot;IDE #1&quot;
)brace
comma
multiline_comment|/* IRQ #14&t;IRL=1&t;0x3c0  */
(brace
l_int|0
comma
l_int|0
comma
l_string|&quot;unused&quot;
)brace
comma
multiline_comment|/* IRQ #15&t;IRL=0&t;0x3e0  */
)brace
suffix:semicolon
macro_line|#if (MICRODEV_LINUX_IRQ_KEYBOARD != 1)
macro_line|#  error Inconsistancy in defining the IRQ# for Keyboard!
macro_line|#endif
macro_line|#if (MICRODEV_LINUX_IRQ_ETHERNET != 3)
macro_line|#  error Inconsistancy in defining the IRQ# for Ethernet!
macro_line|#endif
macro_line|#if (MICRODEV_LINUX_IRQ_USB_HC != 7)
macro_line|#  error Inconsistancy in defining the IRQ# for USB!
macro_line|#endif
macro_line|#if (MICRODEV_LINUX_IRQ_MOUSE != 12)
macro_line|#  error Inconsistancy in defining the IRQ# for PS/2 Mouse!
macro_line|#endif
macro_line|#if (MICRODEV_LINUX_IRQ_IDE2 != 13)
macro_line|#  error Inconsistancy in defining the IRQ# for secondary IDE!
macro_line|#endif
macro_line|#if (MICRODEV_LINUX_IRQ_IDE1 != 14)
macro_line|#  error Inconsistancy in defining the IRQ# for primary IDE!
macro_line|#endif
r_static
r_void
id|enable_microdev_irq
c_func
(paren
r_int
r_int
id|irq
)paren
suffix:semicolon
r_static
r_void
id|disable_microdev_irq
c_func
(paren
r_int
r_int
id|irq
)paren
suffix:semicolon
multiline_comment|/* shutdown is same as &quot;disable&quot; */
DECL|macro|shutdown_microdev_irq
mdefine_line|#define shutdown_microdev_irq disable_microdev_irq
r_static
r_void
id|mask_and_ack_microdev
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|end_microdev_irq
c_func
(paren
r_int
r_int
id|irq
)paren
suffix:semicolon
DECL|function|startup_microdev_irq
r_static
r_int
r_int
id|startup_microdev_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|enable_microdev_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* never anything pending */
)brace
DECL|variable|microdev_irq_type
r_static
r_struct
id|hw_interrupt_type
id|microdev_irq_type
op_assign
(brace
l_string|&quot;MicroDev-IRQ&quot;
comma
id|startup_microdev_irq
comma
id|shutdown_microdev_irq
comma
id|enable_microdev_irq
comma
id|disable_microdev_irq
comma
id|mask_and_ack_microdev
comma
id|end_microdev_irq
)brace
suffix:semicolon
DECL|function|disable_microdev_irq
r_static
r_void
id|disable_microdev_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|fpgaIrq
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_ge
id|NUM_EXTERNAL_IRQS
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fpgaIrqTable
(braket
id|irq
)braket
dot
id|mapped
)paren
r_return
suffix:semicolon
id|fpgaIrq
op_assign
id|fpgaIrqTable
(braket
id|irq
)braket
dot
id|fpgaIrq
suffix:semicolon
multiline_comment|/* disable interrupts */
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* disable interupts on the FPGA INTC register */
id|ctrl_outl
c_func
(paren
id|MICRODEV_FPGA_INTC_MASK
c_func
(paren
id|fpgaIrq
)paren
comma
id|MICRODEV_FPGA_INTDSB_REG
)paren
suffix:semicolon
multiline_comment|/* restore interrupts */
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|enable_microdev_irq
r_static
r_void
id|enable_microdev_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_int
id|priorityReg
comma
id|priorities
comma
id|pri
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|fpgaIrq
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_ge
id|NUM_EXTERNAL_IRQS
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fpgaIrqTable
(braket
id|irq
)braket
dot
id|mapped
)paren
r_return
suffix:semicolon
id|pri
op_assign
l_int|15
op_minus
id|irq
suffix:semicolon
id|fpgaIrq
op_assign
id|fpgaIrqTable
(braket
id|irq
)braket
dot
id|fpgaIrq
suffix:semicolon
id|priorityReg
op_assign
id|MICRODEV_FPGA_INTPRI_REG
c_func
(paren
id|fpgaIrq
)paren
suffix:semicolon
multiline_comment|/* disable interrupts */
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* set priority for the interrupt */
id|priorities
op_assign
id|ctrl_inl
c_func
(paren
id|priorityReg
)paren
suffix:semicolon
id|priorities
op_and_assign
op_complement
id|MICRODEV_FPGA_INTPRI_MASK
c_func
(paren
id|fpgaIrq
)paren
suffix:semicolon
id|priorities
op_or_assign
id|MICRODEV_FPGA_INTPRI_LEVEL
c_func
(paren
id|fpgaIrq
comma
id|pri
)paren
suffix:semicolon
id|ctrl_outl
c_func
(paren
id|priorities
comma
id|priorityReg
)paren
suffix:semicolon
multiline_comment|/* enable interupts on the FPGA INTC register */
id|ctrl_outl
c_func
(paren
id|MICRODEV_FPGA_INTC_MASK
c_func
(paren
id|fpgaIrq
)paren
comma
id|MICRODEV_FPGA_INTENB_REG
)paren
suffix:semicolon
multiline_comment|/* restore interrupts */
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* This functions sets the desired irq handler to be a MicroDev type */
DECL|function|make_microdev_irq
r_static
r_void
id|__init
id|make_microdev_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|disable_irq_nosync
c_func
(paren
id|irq
)paren
suffix:semicolon
id|irq_desc
(braket
id|irq
)braket
dot
id|handler
op_assign
op_amp
id|microdev_irq_type
suffix:semicolon
id|disable_microdev_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|mask_and_ack_microdev
r_static
r_void
id|mask_and_ack_microdev
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|disable_microdev_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|end_microdev_irq
r_static
r_void
id|end_microdev_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|irq_desc
(braket
id|irq
)braket
dot
id|status
op_amp
(paren
id|IRQ_DISABLED
op_or
id|IRQ_INPROGRESS
)paren
)paren
)paren
(brace
id|enable_microdev_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
)brace
DECL|function|init_microdev_irq
r_extern
r_void
id|__init
id|init_microdev_irq
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* disable interupts on the FPGA INTC register */
id|ctrl_outl
c_func
(paren
op_complement
l_int|0ul
comma
id|MICRODEV_FPGA_INTDSB_REG
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_EXTERNAL_IRQS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|make_microdev_irq
c_func
(paren
id|i
)paren
suffix:semicolon
)brace
)brace
DECL|function|microdev_print_fpga_intc_status
r_extern
r_void
id|microdev_print_fpga_intc_status
c_func
(paren
r_void
)paren
(brace
r_volatile
r_int
r_int
op_star
r_const
id|intenb
op_assign
(paren
r_int
r_int
op_star
)paren
id|MICRODEV_FPGA_INTENB_REG
suffix:semicolon
r_volatile
r_int
r_int
op_star
r_const
id|intdsb
op_assign
(paren
r_int
r_int
op_star
)paren
id|MICRODEV_FPGA_INTDSB_REG
suffix:semicolon
r_volatile
r_int
r_int
op_star
r_const
id|intpria
op_assign
(paren
r_int
r_int
op_star
)paren
id|MICRODEV_FPGA_INTPRI_REG
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_volatile
r_int
r_int
op_star
r_const
id|intprib
op_assign
(paren
r_int
r_int
op_star
)paren
id|MICRODEV_FPGA_INTPRI_REG
c_func
(paren
l_int|8
)paren
suffix:semicolon
r_volatile
r_int
r_int
op_star
r_const
id|intpric
op_assign
(paren
r_int
r_int
op_star
)paren
id|MICRODEV_FPGA_INTPRI_REG
c_func
(paren
l_int|16
)paren
suffix:semicolon
r_volatile
r_int
r_int
op_star
r_const
id|intprid
op_assign
(paren
r_int
r_int
op_star
)paren
id|MICRODEV_FPGA_INTPRI_REG
c_func
(paren
l_int|24
)paren
suffix:semicolon
r_volatile
r_int
r_int
op_star
r_const
id|intsrc
op_assign
(paren
r_int
r_int
op_star
)paren
id|MICRODEV_FPGA_INTSRC_REG
suffix:semicolon
r_volatile
r_int
r_int
op_star
r_const
id|intreq
op_assign
(paren
r_int
r_int
op_star
)paren
id|MICRODEV_FPGA_INTREQ_REG
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;-------------------------- microdev_print_fpga_intc_status() ------------------&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;FPGA_INTENB = 0x%08x&bslash;n&quot;
comma
op_star
id|intenb
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;FPGA_INTDSB = 0x%08x&bslash;n&quot;
comma
op_star
id|intdsb
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;FPGA_INTSRC = 0x%08x&bslash;n&quot;
comma
op_star
id|intsrc
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;FPGA_INTREQ = 0x%08x&bslash;n&quot;
comma
op_star
id|intreq
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;FPGA_INTPRI[3..0] = %08x:%08x:%08x:%08x&bslash;n&quot;
comma
op_star
id|intprid
comma
op_star
id|intpric
comma
op_star
id|intprib
comma
op_star
id|intpria
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;-------------------------------------------------------------------------------&bslash;n&quot;
)paren
suffix:semicolon
)brace
eof
