multiline_comment|/*&n; * linux/arch/sh/boards/ec3104/irq.c&n; * EC3104 companion chip support&n; *&n; * Copyright (C) 2000 Philipp Rumpf &lt;prumpf@tux.org&gt;&n; *&n; */
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/ec3104/ec3104.h&gt;
multiline_comment|/* This is for debugging mostly;  here&squot;s the table that I intend to keep&n; * in here:&n; *&n; *   index      function        base addr       power           interrupt bit&n; *       0      power           b0ec0000        ---             00000001 (unused)&n; *       1      irqs            b0ec1000        ---             00000002 (unused)&n; *       2      ??              b0ec2000        b0ec0008        00000004&n; *       3      PS2 (1)         b0ec3000        b0ec000c        00000008&n; *       4      PS2 (2)         b0ec4000        b0ec0010        00000010&n; *       5      ??              b0ec5000        b0ec0014        00000020&n; *       6      I2C             b0ec6000        b0ec0018        00000040&n; *       7      serial (1)      b0ec7000        b0ec001c        00000080&n; *       8      serial (2)      b0ec8000        b0ec0020        00000100&n; *       9      serial (3)      b0ec9000        b0ec0024        00000200&n; *      10      serial (4)      b0eca000        b0ec0028        00000400&n; *      12      GPIO (1)        b0ecc000        b0ec0030&n; *      13      GPIO (2)        b0ecc000        b0ec0030&n; *      16      pcmcia (1)      b0ed0000        b0ec0040        00010000&n; *      17      pcmcia (2)      b0ed1000        b0ec0044        00020000&n; */
multiline_comment|/* I used the register names from another interrupt controller I worked with,&n; * since it seems to be identical to the ec3104 except that all bits are&n; * inverted:&n; *&n; * IRR: Interrupt Request Register (pending and enabled interrupts)&n; * IMR: Interrupt Mask Register (which interrupts are enabled)&n; * IPR: Interrupt Pending Register (pending interrupts, even disabled ones)&n; *&n; * 0 bits mean pending or enabled, 1 bits mean not pending or disabled.  all&n; * IRQs seem to be level-triggered.&n; */
DECL|macro|EC3104_IRR
mdefine_line|#define EC3104_IRR (EC3104_BASE + 0x1000)
DECL|macro|EC3104_IMR
mdefine_line|#define EC3104_IMR (EC3104_BASE + 0x1004)
DECL|macro|EC3104_IPR
mdefine_line|#define EC3104_IPR (EC3104_BASE + 0x1008)
DECL|macro|ctrl_readl
mdefine_line|#define ctrl_readl(addr) (*(volatile u32 *)(addr))
DECL|macro|ctrl_writel
mdefine_line|#define ctrl_writel(data,addr) (*(volatile u32 *)(addr) = (data))
DECL|macro|ctrl_readb
mdefine_line|#define ctrl_readb(addr) (*(volatile u8 *)(addr))
DECL|function|ec3104_name
r_static
r_char
op_star
id|ec3104_name
c_func
(paren
r_int
id|index
)paren
(brace
r_switch
c_cond
(paren
id|index
)paren
(brace
r_case
l_int|0
suffix:colon
r_return
l_string|&quot;power management&quot;
suffix:semicolon
r_case
l_int|1
suffix:colon
r_return
l_string|&quot;interrupts&quot;
suffix:semicolon
r_case
l_int|3
suffix:colon
r_return
l_string|&quot;PS2 (1)&quot;
suffix:semicolon
r_case
l_int|4
suffix:colon
r_return
l_string|&quot;PS2 (2)&quot;
suffix:semicolon
r_case
l_int|5
suffix:colon
r_return
l_string|&quot;I2C (1)&quot;
suffix:semicolon
r_case
l_int|6
suffix:colon
r_return
l_string|&quot;I2C (2)&quot;
suffix:semicolon
r_case
l_int|7
suffix:colon
r_return
l_string|&quot;serial (1)&quot;
suffix:semicolon
r_case
l_int|8
suffix:colon
r_return
l_string|&quot;serial (2)&quot;
suffix:semicolon
r_case
l_int|9
suffix:colon
r_return
l_string|&quot;serial (3)&quot;
suffix:semicolon
r_case
l_int|10
suffix:colon
r_return
l_string|&quot;serial (4)&quot;
suffix:semicolon
r_case
l_int|16
suffix:colon
r_return
l_string|&quot;pcmcia (1)&quot;
suffix:semicolon
r_case
l_int|17
suffix:colon
r_return
l_string|&quot;pcmcia (2)&quot;
suffix:semicolon
r_default
suffix:colon
(brace
)brace
(brace
r_static
r_char
id|buf
(braket
l_int|32
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;unknown (%d)&quot;
comma
id|index
)paren
suffix:semicolon
r_return
id|buf
suffix:semicolon
)brace
)brace
)brace
DECL|function|get_pending_interrupts
r_int
id|get_pending_interrupts
c_func
(paren
r_char
op_star
id|buf
)paren
(brace
id|u32
id|ipr
suffix:semicolon
id|u32
id|bit
suffix:semicolon
r_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;pending: (&quot;
)paren
suffix:semicolon
id|ipr
op_assign
id|ctrl_inl
c_func
(paren
id|EC3104_IPR
)paren
suffix:semicolon
r_for
c_loop
(paren
id|bit
op_assign
l_int|1
suffix:semicolon
id|bit
OL
l_int|32
suffix:semicolon
id|bit
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|ipr
op_amp
(paren
l_int|1
op_lshift
id|bit
)paren
)paren
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%s &quot;
comma
id|ec3104_name
c_func
(paren
id|bit
)paren
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;)&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|p
op_minus
id|buf
suffix:semicolon
)brace
DECL|function|ec3104_irq2mask
r_static
r_inline
id|u32
id|ec3104_irq2mask
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_return
(paren
l_int|1
op_lshift
(paren
id|irq
op_minus
id|EC3104_IRQBASE
)paren
)paren
suffix:semicolon
)brace
DECL|function|mask_ec3104_irq
r_static
r_inline
r_void
id|mask_ec3104_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|u32
id|mask
suffix:semicolon
id|mask
op_assign
id|ctrl_readl
c_func
(paren
id|EC3104_IMR
)paren
suffix:semicolon
id|mask
op_or_assign
id|ec3104_irq2mask
c_func
(paren
id|irq
)paren
suffix:semicolon
id|ctrl_writel
c_func
(paren
id|mask
comma
id|EC3104_IMR
)paren
suffix:semicolon
)brace
DECL|function|unmask_ec3104_irq
r_static
r_inline
r_void
id|unmask_ec3104_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|u32
id|mask
suffix:semicolon
id|mask
op_assign
id|ctrl_readl
c_func
(paren
id|EC3104_IMR
)paren
suffix:semicolon
id|mask
op_and_assign
op_complement
id|ec3104_irq2mask
c_func
(paren
id|irq
)paren
suffix:semicolon
id|ctrl_writel
c_func
(paren
id|mask
comma
id|EC3104_IMR
)paren
suffix:semicolon
)brace
DECL|function|disable_ec3104_irq
r_static
r_void
id|disable_ec3104_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|mask_ec3104_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|enable_ec3104_irq
r_static
r_void
id|enable_ec3104_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|unmask_ec3104_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|mask_and_ack_ec3104_irq
r_static
r_void
id|mask_and_ack_ec3104_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|mask_ec3104_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|end_ec3104_irq
r_static
r_void
id|end_ec3104_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|irq_desc
(braket
id|irq
)braket
dot
id|status
op_amp
(paren
id|IRQ_DISABLED
op_or
id|IRQ_INPROGRESS
)paren
)paren
)paren
id|unmask_ec3104_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|startup_ec3104_irq
r_static
r_int
r_int
id|startup_ec3104_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|unmask_ec3104_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|shutdown_ec3104_irq
r_static
r_void
id|shutdown_ec3104_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|mask_ec3104_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|variable|ec3104_int
r_static
r_struct
id|hw_interrupt_type
id|ec3104_int
op_assign
(brace
r_typename
suffix:colon
l_string|&quot;EC3104&quot;
comma
id|enable
suffix:colon
id|enable_ec3104_irq
comma
id|disable
suffix:colon
id|disable_ec3104_irq
comma
id|ack
suffix:colon
id|mask_and_ack_ec3104_irq
comma
id|end
suffix:colon
id|end_ec3104_irq
comma
id|startup
suffix:colon
id|startup_ec3104_irq
comma
id|shutdown
suffix:colon
id|shutdown_ec3104_irq
comma
)brace
suffix:semicolon
multiline_comment|/* Yuck.  the _demux API is ugly */
DECL|function|ec3104_irq_demux
r_int
id|ec3104_irq_demux
c_func
(paren
r_int
id|irq
)paren
(brace
r_if
c_cond
(paren
id|irq
op_eq
id|EC3104_IRQ
)paren
(brace
r_int
r_int
id|mask
suffix:semicolon
id|mask
op_assign
id|ctrl_readl
c_func
(paren
id|EC3104_IRR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_eq
l_int|0xffffffff
)paren
r_return
id|EC3104_IRQ
suffix:semicolon
r_else
r_return
id|EC3104_IRQBASE
op_plus
id|ffz
c_func
(paren
id|mask
)paren
suffix:semicolon
)brace
r_return
id|irq
suffix:semicolon
)brace
eof
