multiline_comment|/* &n; * Copyright (C) 2000 David J. Mckay (david.mckay@st.com)&n; *&n; * May be copied or modified under the terms of the GNU General Public&n; * License.  See linux/COPYING for more information.                            &n; *&n; * This file contains the PCI routines required for the Galileo GT6411 &n; * PCI bridge as used on the Orion and Overdrive boards.&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/overdrive/overdrive.h&gt;
macro_line|#include &lt;asm/overdrive/gt64111.h&gt;
multiline_comment|/* After boot, we shift the Galileo registers so that they appear &n; * in BANK6, along with IO space. This means we can have one contingous&n; * lump of PCI address space without these registers appearing in the &n; * middle of them &n; */
DECL|macro|GT64111_BASE_ADDRESS
mdefine_line|#define GT64111_BASE_ADDRESS  0xbb000000
DECL|macro|GT64111_IO_BASE_ADDRESS
mdefine_line|#define GT64111_IO_BASE_ADDRESS  0x1000
multiline_comment|/* The GT64111 registers appear at this address to the SH4 after reset */
DECL|macro|RESET_GT64111_BASE_ADDRESS
mdefine_line|#define RESET_GT64111_BASE_ADDRESS           0xb4000000
multiline_comment|/* Macros used to access the Galileo registers */
DECL|macro|RESET_GT64111_REG
mdefine_line|#define RESET_GT64111_REG(x) (RESET_GT64111_BASE_ADDRESS+x)
DECL|macro|GT64111_REG
mdefine_line|#define GT64111_REG(x) (GT64111_BASE_ADDRESS+x)
DECL|macro|RESET_GT_WRITE
mdefine_line|#define RESET_GT_WRITE(x,v) writel((v),RESET_GT64111_REG(x))
DECL|macro|RESET_GT_READ
mdefine_line|#define RESET_GT_READ(x) readl(RESET_GT64111_REG(x))
DECL|macro|GT_WRITE
mdefine_line|#define GT_WRITE(x,v) writel((v),GT64111_REG(x))
DECL|macro|GT_WRITE_BYTE
mdefine_line|#define GT_WRITE_BYTE(x,v) writeb((v),GT64111_REG(x))
DECL|macro|GT_WRITE_SHORT
mdefine_line|#define GT_WRITE_SHORT(x,v) writew((v),GT64111_REG(x))
DECL|macro|GT_READ
mdefine_line|#define GT_READ(x)    readl(GT64111_REG(x))
DECL|macro|GT_READ_BYTE
mdefine_line|#define GT_READ_BYTE(x)  readb(GT64111_REG(x))
DECL|macro|GT_READ_SHORT
mdefine_line|#define GT_READ_SHORT(x) readw(GT64111_REG(x))
multiline_comment|/* Where the various SH banks start at */
DECL|macro|SH_BANK4_ADR
mdefine_line|#define SH_BANK4_ADR 0xb0000000
DECL|macro|SH_BANK5_ADR
mdefine_line|#define SH_BANK5_ADR 0xb4000000
DECL|macro|SH_BANK6_ADR
mdefine_line|#define SH_BANK6_ADR 0xb8000000
multiline_comment|/* Masks out everything but lines 28,27,26 */
DECL|macro|BANK_SELECT_MASK
mdefine_line|#define BANK_SELECT_MASK 0x1c000000
DECL|macro|SH4_TO_BANK
mdefine_line|#define SH4_TO_BANK(x) ( (x) &amp; BANK_SELECT_MASK)
multiline_comment|/* &n; * Masks used for address conversaion. Bank 6 is used for IO and &n; * has all the address bits zeroed by the FPGA. Special case this&n; */
DECL|macro|MEMORY_BANK_MASK
mdefine_line|#define MEMORY_BANK_MASK 0x1fffffff
DECL|macro|IO_BANK_MASK
mdefine_line|#define IO_BANK_MASK  0x03ffffff
multiline_comment|/* Mark bank 6 as the bank used for IO. You can change this in the FPGA code&n; * if you want &n; */
DECL|macro|IO_BANK_ADR
mdefine_line|#define IO_BANK_ADR PCI_GTIO_BASE
multiline_comment|/* Will select the correct mask to apply depending on the SH$ address */
DECL|macro|SELECT_BANK_MASK
mdefine_line|#define SELECT_BANK_MASK(x) &bslash;&n;   ( (SH4_TO_BANK(x)==SH4_TO_BANK(IO_BANK_ADR)) ? IO_BANK_MASK : MEMORY_BANK_MASK)
multiline_comment|/* Converts between PCI space and P2 region */
DECL|macro|SH4_TO_PCI
mdefine_line|#define SH4_TO_PCI(x) ((x)&amp;SELECT_BANK_MASK(x))
multiline_comment|/* Various macros for figuring out what to stick in the Galileo registers. &n; * You *really* don&squot;t want to figure this stuff out by hand, you always get&n; * it wrong&n; */
DECL|macro|GT_MEM_LO_ADR
mdefine_line|#define GT_MEM_LO_ADR(x) ((((unsigned)((x)&amp;SELECT_BANK_MASK(x)))&gt;&gt;21)&amp;0x7ff)
DECL|macro|GT_MEM_HI_ADR
mdefine_line|#define GT_MEM_HI_ADR(x) ((((unsigned)((x)&amp;SELECT_BANK_MASK(x)))&gt;&gt;21)&amp;0x7f)
DECL|macro|GT_MEM_SUB_ADR
mdefine_line|#define GT_MEM_SUB_ADR(x) ((((unsigned)((x)&amp;SELECT_BANK_MASK(x)))&gt;&gt;20)&amp;0xff)
DECL|macro|PROGRAM_HI_LO
mdefine_line|#define PROGRAM_HI_LO(block,a,s) &bslash;&n;    GT_WRITE(block##_LO_DEC_ADR,GT_MEM_LO_ADR(a));&bslash;&n;    GT_WRITE(block##_HI_DEC_ADR,GT_MEM_HI_ADR(a+s-1))
DECL|macro|PROGRAM_SUB_HI_LO
mdefine_line|#define PROGRAM_SUB_HI_LO(block,a,s) &bslash;&n;    GT_WRITE(block##_LO_DEC_ADR,GT_MEM_SUB_ADR(a));&bslash;&n;    GT_WRITE(block##_HI_DEC_ADR,GT_MEM_SUB_ADR(a+s-1))
multiline_comment|/* We need to set the size, and the offset register */
DECL|macro|GT_BAR_MASK
mdefine_line|#define GT_BAR_MASK(x) ((x)&amp;~0xfff)
multiline_comment|/* Macro to set up the BAR in the Galileo. Essentially used for the DRAM */
DECL|macro|PROGRAM_GT_BAR
mdefine_line|#define PROGRAM_GT_BAR(block,a,s) &bslash;&n;  GT_WRITE(PCI_##block##_BANK_SIZE,GT_BAR_MASK((s-1)));&bslash;&n;  write_config_to_galileo(PCI_CONFIG_##block##_BASE_ADR,&bslash;&n;&t;&t;&t;     GT_BAR_MASK(a))
DECL|macro|DISABLE_GT_BAR
mdefine_line|#define DISABLE_GT_BAR(block) &bslash;&n;  GT_WRITE(PCI_##block##_BANK_SIZE,0),&bslash;&n;  GT_CONFIG_WRITE(PCI_CONFIG_##block##_BASE_ADR,&bslash;&n;    0x80000000)
multiline_comment|/* Macros to disable things we are not going to use */
DECL|macro|DISABLE_DECODE
mdefine_line|#define DISABLE_DECODE(x) GT_WRITE(x##_LO_DEC_ADR,0x7ff);&bslash;&n;                          GT_WRITE(x##_HI_DEC_ADR,0x00)
DECL|macro|DISABLE_SUB_DECODE
mdefine_line|#define DISABLE_SUB_DECODE(x) GT_WRITE(x##_LO_DEC_ADR,0xff);&bslash;&n;                              GT_WRITE(x##_HI_DEC_ADR,0x00)
DECL|function|reset_pci
r_static
r_void
id|__init
id|reset_pci
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Set RESET_PCI bit high */
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|OVERDRIVE_CTRL
)paren
op_or
id|ENABLE_PCI_BIT
comma
id|OVERDRIVE_CTRL
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
multiline_comment|/* Set RESET_PCI bit low */
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|OVERDRIVE_CTRL
)paren
op_amp
id|RESET_PCI_MASK
comma
id|OVERDRIVE_CTRL
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|OVERDRIVE_CTRL
)paren
op_or
id|ENABLE_PCI_BIT
comma
id|OVERDRIVE_CTRL
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
)brace
r_static
r_int
id|write_config_to_galileo
c_func
(paren
r_int
id|where
comma
id|u32
id|val
)paren
suffix:semicolon
DECL|macro|GT_CONFIG_WRITE
mdefine_line|#define GT_CONFIG_WRITE(where,val) write_config_to_galileo(where,val)
DECL|macro|ENABLE_PCI_DRAM
mdefine_line|#define ENABLE_PCI_DRAM
macro_line|#ifdef TEST_DRAM
multiline_comment|/* Test function to check out if the PCI DRAM is working OK */
DECL|function|test_dram
r_static
r_int
multiline_comment|/* __init */
id|test_dram
c_func
(paren
r_int
op_star
id|base
comma
r_int
id|size
)paren
(brace
r_int
op_star
id|p
op_assign
id|base
suffix:semicolon
r_int
op_star
id|end
op_assign
(paren
r_int
op_star
)paren
(paren
(paren
(paren
r_int
)paren
id|base
)paren
op_plus
id|size
)paren
suffix:semicolon
r_int
id|w
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|base
suffix:semicolon
id|p
OL
id|end
suffix:semicolon
id|p
op_increment
)paren
(brace
op_star
id|p
op_assign
l_int|0xffffffff
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_ne
l_int|0xffffffff
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;AAARGH -write failed!!! at %p is %x&bslash;n&quot;
comma
id|p
comma
op_star
id|p
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|p
op_assign
l_int|0x0
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_ne
l_int|0x0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;AAARGH -write failed!!!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|p
op_assign
id|base
suffix:semicolon
id|p
OL
id|end
suffix:semicolon
id|p
op_increment
)paren
(brace
op_star
id|p
op_assign
(paren
r_int
)paren
id|p
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_ne
(paren
r_int
)paren
id|p
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed at 0x%p, actually is 0x%x&bslash;n&quot;
comma
id|p
comma
op_star
id|p
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|p
op_assign
id|base
suffix:semicolon
id|p
OL
id|end
suffix:semicolon
id|p
op_increment
)paren
(brace
id|w
op_assign
(paren
(paren
r_int
)paren
id|p
op_amp
l_int|0xffff0000
)paren
suffix:semicolon
op_star
id|p
op_assign
id|w
op_or
(paren
id|w
op_rshift
l_int|16
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|p
op_assign
id|base
suffix:semicolon
id|p
OL
id|end
suffix:semicolon
id|p
op_increment
)paren
(brace
id|w
op_assign
(paren
(paren
r_int
)paren
id|p
op_amp
l_int|0xffff0000
)paren
suffix:semicolon
id|w
op_or_assign
(paren
id|w
op_rshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_ne
id|w
)paren
(brace
id|printk
(paren
l_string|&quot;Failed at 0x%p, should be 0x%x actually is 0x%x&bslash;n&quot;
comma
id|p
comma
id|w
comma
op_star
id|p
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Function to set up and initialise the galileo. This sets up the BARS,&n; * maps the DRAM into the address space etc,etc&n; */
DECL|function|galileo_init
r_int
id|__init
id|galileo_init
c_func
(paren
r_void
)paren
(brace
id|reset_pci
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Now shift the galileo regs into this block */
id|RESET_GT_WRITE
c_func
(paren
id|INTERNAL_SPACE_DEC
comma
id|GT_MEM_LO_ADR
c_func
(paren
id|GT64111_BASE_ADDRESS
)paren
)paren
suffix:semicolon
multiline_comment|/* Should have a sanity check here, that you can read back  at the new&n;&t; * address what you just wrote &n;&t; */
multiline_comment|/* Disable decode for all regions */
id|DISABLE_DECODE
c_func
(paren
id|RAS10
)paren
suffix:semicolon
id|DISABLE_DECODE
c_func
(paren
id|RAS32
)paren
suffix:semicolon
id|DISABLE_DECODE
c_func
(paren
id|CS20
)paren
suffix:semicolon
id|DISABLE_DECODE
c_func
(paren
id|CS3
)paren
suffix:semicolon
id|DISABLE_DECODE
c_func
(paren
id|PCI_IO
)paren
suffix:semicolon
id|DISABLE_DECODE
c_func
(paren
id|PCI_MEM0
)paren
suffix:semicolon
id|DISABLE_DECODE
c_func
(paren
id|PCI_MEM1
)paren
suffix:semicolon
multiline_comment|/* Disable all BARS */
id|GT_WRITE
c_func
(paren
id|BAR_ENABLE_ADR
comma
l_int|0x1ff
)paren
suffix:semicolon
id|DISABLE_GT_BAR
c_func
(paren
id|RAS10
)paren
suffix:semicolon
id|DISABLE_GT_BAR
c_func
(paren
id|RAS32
)paren
suffix:semicolon
id|DISABLE_GT_BAR
c_func
(paren
id|CS20
)paren
suffix:semicolon
id|DISABLE_GT_BAR
c_func
(paren
id|CS3
)paren
suffix:semicolon
multiline_comment|/* Tell the BAR where the IO registers now are */
id|GT_CONFIG_WRITE
c_func
(paren
id|PCI_CONFIG_INT_REG_IO_ADR
comma
id|GT_BAR_MASK
c_func
(paren
(paren
id|GT64111_IO_BASE_ADDRESS
op_amp
id|IO_BANK_MASK
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* set up a 112 Mb decode */
id|PROGRAM_HI_LO
c_func
(paren
id|PCI_MEM0
comma
id|SH_BANK4_ADR
comma
l_int|112
op_star
l_int|1024
op_star
l_int|1024
)paren
suffix:semicolon
multiline_comment|/* Set up a 32 MB io space decode */
id|PROGRAM_HI_LO
c_func
(paren
id|PCI_IO
comma
id|IO_BANK_ADR
comma
l_int|32
op_star
l_int|1024
op_star
l_int|1024
)paren
suffix:semicolon
macro_line|#ifdef ENABLE_PCI_DRAM
multiline_comment|/* Program up the DRAM configuration - there is DRAM only in bank 0 */
multiline_comment|/* Now set up the DRAM decode */
id|PROGRAM_HI_LO
c_func
(paren
id|RAS10
comma
id|PCI_DRAM_BASE
comma
id|PCI_DRAM_SIZE
)paren
suffix:semicolon
multiline_comment|/* And the sub decode */
id|PROGRAM_SUB_HI_LO
c_func
(paren
id|RAS0
comma
id|PCI_DRAM_BASE
comma
id|PCI_DRAM_SIZE
)paren
suffix:semicolon
id|DISABLE_SUB_DECODE
c_func
(paren
id|RAS1
)paren
suffix:semicolon
multiline_comment|/* Set refresh rate */
id|GT_WRITE
c_func
(paren
id|DRAM_BANK0_PARMS
comma
l_int|0x3f
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|DRAM_CFG
comma
l_int|0x100
)paren
suffix:semicolon
multiline_comment|/* we have to lob off the top bits rememeber!! */
id|PROGRAM_GT_BAR
c_func
(paren
id|RAS10
comma
id|SH4_TO_PCI
c_func
(paren
id|PCI_DRAM_BASE
)paren
comma
id|PCI_DRAM_SIZE
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* We are only interested in decoding RAS10 and the Galileo&squot;s internal &n;&t; * registers (as IO) on the PCI bus&n;&t; */
macro_line|#ifdef ENABLE_PCI_DRAM
id|GT_WRITE
c_func
(paren
id|BAR_ENABLE_ADR
comma
(paren
op_complement
(paren
(paren
l_int|1
op_lshift
l_int|8
)paren
op_or
(paren
l_int|1
op_lshift
l_int|3
)paren
)paren
)paren
op_amp
l_int|0x1ff
)paren
suffix:semicolon
macro_line|#else
id|GT_WRITE
c_func
(paren
id|BAR_ENABLE_ADR
comma
(paren
op_complement
(paren
l_int|1
op_lshift
l_int|3
)paren
)paren
op_amp
l_int|0x1ff
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Change the class code to host bridge, it actually powers up &n;&t; * as a memory controller&n;         */
id|GT_CONFIG_WRITE
c_func
(paren
l_int|8
comma
l_int|0x06000011
)paren
suffix:semicolon
multiline_comment|/* Allow the galileo to master the PCI bus */
id|GT_CONFIG_WRITE
c_func
(paren
id|PCI_COMMAND
comma
id|PCI_COMMAND_MEMORY
op_or
id|PCI_COMMAND_MASTER
op_or
id|PCI_COMMAND_IO
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;Testing PCI DRAM - &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_dram
c_func
(paren
id|PCI_DRAM_BASE
comma
id|PCI_DRAM_SIZE
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Passed&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;FAILED&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|SET_CONFIG_BITS
mdefine_line|#define SET_CONFIG_BITS(bus,devfn,where)&bslash;&n;  ((1&lt;&lt;31) | ((bus) &lt;&lt; 16) | ((devfn) &lt;&lt; 8) | ((where) &amp; ~3))
DECL|macro|CONFIG_CMD
mdefine_line|#define CONFIG_CMD(dev, where) SET_CONFIG_BITS((dev)-&gt;bus-&gt;number,(dev)-&gt;devfn,where)
multiline_comment|/* This write to the galileo config registers, unlike the functions below, can&n; * be used before the PCI subsystem has started up&n; */
DECL|function|write_config_to_galileo
r_static
r_int
id|__init
id|write_config_to_galileo
c_func
(paren
r_int
id|where
comma
id|u32
id|val
)paren
(brace
id|GT_WRITE
c_func
(paren
id|PCI_CFG_ADR
comma
id|SET_CONFIG_BITS
c_func
(paren
l_int|0
comma
l_int|0
comma
id|where
)paren
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|PCI_CFG_DATA
comma
id|val
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* We exclude the galileo and slot 31, the galileo because I don&squot;t know how to stop&n; * the setup code shagging up the setup I have done on it, and 31 because the whole&n; * thing locks up if you try to access that slot (which doesn&squot;t exist of course anyway&n; */
DECL|macro|EXCLUDED_DEV
mdefine_line|#define EXCLUDED_DEV(dev) ((dev-&gt;bus-&gt;number==0) &amp;&amp; ((PCI_SLOT(dev-&gt;devfn)==0) || (PCI_SLOT(dev-&gt;devfn) == 31)))
DECL|function|galileo_read_config_byte
r_static
r_int
id|galileo_read_config_byte
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u8
op_star
id|val
)paren
(brace
multiline_comment|/* I suspect this doesn&squot;t work because this drives a special cycle ? */
r_if
c_cond
(paren
id|EXCLUDED_DEV
c_func
(paren
id|dev
)paren
)paren
(brace
op_star
id|val
op_assign
l_int|0xff
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
multiline_comment|/* Start the config cycle */
id|GT_WRITE
c_func
(paren
id|PCI_CFG_ADR
comma
id|CONFIG_CMD
c_func
(paren
id|dev
comma
id|where
)paren
)paren
suffix:semicolon
multiline_comment|/* Read back the result */
op_star
id|val
op_assign
id|GT_READ_BYTE
c_func
(paren
id|PCI_CFG_DATA
op_plus
(paren
id|where
op_amp
l_int|3
)paren
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|galileo_read_config_word
r_static
r_int
id|galileo_read_config_word
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u16
op_star
id|val
)paren
(brace
r_if
c_cond
(paren
id|EXCLUDED_DEV
c_func
(paren
id|dev
)paren
)paren
(brace
op_star
id|val
op_assign
l_int|0xffff
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
id|GT_WRITE
c_func
(paren
id|PCI_CFG_ADR
comma
id|CONFIG_CMD
c_func
(paren
id|dev
comma
id|where
)paren
)paren
suffix:semicolon
op_star
id|val
op_assign
id|GT_READ_SHORT
c_func
(paren
id|PCI_CFG_DATA
op_plus
(paren
id|where
op_amp
l_int|2
)paren
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|galileo_read_config_dword
r_static
r_int
id|galileo_read_config_dword
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u32
op_star
id|val
)paren
(brace
r_if
c_cond
(paren
id|EXCLUDED_DEV
c_func
(paren
id|dev
)paren
)paren
(brace
op_star
id|val
op_assign
l_int|0xffffffff
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
id|GT_WRITE
c_func
(paren
id|PCI_CFG_ADR
comma
id|CONFIG_CMD
c_func
(paren
id|dev
comma
id|where
)paren
)paren
suffix:semicolon
op_star
id|val
op_assign
id|GT_READ
c_func
(paren
id|PCI_CFG_DATA
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|galileo_write_config_byte
r_static
r_int
id|galileo_write_config_byte
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u8
id|val
)paren
(brace
id|GT_WRITE
c_func
(paren
id|PCI_CFG_ADR
comma
id|CONFIG_CMD
c_func
(paren
id|dev
comma
id|where
)paren
)paren
suffix:semicolon
id|GT_WRITE_BYTE
c_func
(paren
id|PCI_CFG_DATA
op_plus
(paren
id|where
op_amp
l_int|3
)paren
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|galileo_write_config_word
r_static
r_int
id|galileo_write_config_word
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u16
id|val
)paren
(brace
id|GT_WRITE
c_func
(paren
id|PCI_CFG_ADR
comma
id|CONFIG_CMD
c_func
(paren
id|dev
comma
id|where
)paren
)paren
suffix:semicolon
id|GT_WRITE_SHORT
c_func
(paren
id|PCI_CFG_DATA
op_plus
(paren
id|where
op_amp
l_int|2
)paren
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|galileo_write_config_dword
r_static
r_int
id|galileo_write_config_dword
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u32
id|val
)paren
(brace
id|GT_WRITE
c_func
(paren
id|PCI_CFG_ADR
comma
id|CONFIG_CMD
c_func
(paren
id|dev
comma
id|where
)paren
)paren
suffix:semicolon
id|GT_WRITE
c_func
(paren
id|PCI_CFG_DATA
comma
id|val
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|variable|pci_config_ops
r_static
r_struct
id|pci_ops
id|pci_config_ops
op_assign
(brace
id|galileo_read_config_byte
comma
id|galileo_read_config_word
comma
id|galileo_read_config_dword
comma
id|galileo_write_config_byte
comma
id|galileo_write_config_word
comma
id|galileo_write_config_dword
)brace
suffix:semicolon
multiline_comment|/* Everything hangs off this */
DECL|variable|pci_root_bus
r_static
r_struct
id|pci_bus
op_star
id|pci_root_bus
suffix:semicolon
DECL|function|no_swizzle
r_static
id|u8
id|__init
id|no_swizzle
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
id|u8
op_star
id|pin
)paren
(brace
r_return
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
suffix:semicolon
)brace
DECL|function|map_od_irq
r_static
r_int
id|__init
id|map_od_irq
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
id|u8
id|slot
comma
id|u8
id|pin
)paren
(brace
multiline_comment|/* Slot 1: Galileo &n;&t; * Slot 2: PCI Slot 1&n;&t; * Slot 3: PCI Slot 2&n;&t; * Slot 4: ESS&n;&t; */
r_switch
c_cond
(paren
id|slot
)paren
(brace
r_case
l_int|2
suffix:colon
r_return
id|OVERDRIVE_PCI_IRQ1
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* Note this assumes you have a hacked card in slot 2 */
r_return
id|OVERDRIVE_PCI_IRQ2
suffix:semicolon
r_case
l_int|4
suffix:colon
r_return
id|OVERDRIVE_ESS_IRQ
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* printk(&quot;PCI: Unexpected IRQ mapping request for slot %d&bslash;n&quot;, slot); */
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_void
id|__init
DECL|function|pcibios_fixup_pbus_ranges
id|pcibios_fixup_pbus_ranges
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_struct
id|pbus_set_ranges_data
op_star
id|ranges
)paren
(brace
id|ranges-&gt;io_start
op_sub_assign
id|bus-&gt;resource
(braket
l_int|0
)braket
op_member_access_from_pointer
id|start
suffix:semicolon
id|ranges-&gt;io_end
op_sub_assign
id|bus-&gt;resource
(braket
l_int|0
)braket
op_member_access_from_pointer
id|start
suffix:semicolon
id|ranges-&gt;mem_start
op_sub_assign
id|bus-&gt;resource
(braket
l_int|1
)braket
op_member_access_from_pointer
id|start
suffix:semicolon
id|ranges-&gt;mem_end
op_sub_assign
id|bus-&gt;resource
(braket
l_int|1
)braket
op_member_access_from_pointer
id|start
suffix:semicolon
)brace
DECL|function|pci_fixup_ide_bases
r_static
r_void
id|__init
id|pci_fixup_ide_bases
c_func
(paren
r_struct
id|pci_dev
op_star
id|d
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * PCI IDE controllers use non-standard I/O port decoding, respect it.&n;&t; */
r_if
c_cond
(paren
(paren
id|d
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_ne
id|PCI_CLASS_STORAGE_IDE
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI: IDE base address fixup for %s&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|d
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|resource
op_star
id|r
op_assign
op_amp
id|d-&gt;resource
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r-&gt;start
op_amp
op_complement
l_int|0x80
)paren
op_eq
l_int|0x374
)paren
(brace
id|r-&gt;start
op_or_assign
l_int|2
suffix:semicolon
id|r-&gt;end
op_assign
id|r-&gt;start
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Add future fixups here... */
DECL|variable|pcibios_fixups
r_struct
id|pci_fixup
id|pcibios_fixups
(braket
)braket
op_assign
(brace
(brace
id|PCI_FIXUP_HEADER
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|pci_fixup_ide_bases
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
DECL|function|pcibios_init
r_void
id|__init
id|pcibios_init
c_func
(paren
r_void
)paren
(brace
r_static
r_struct
id|resource
id|galio
comma
id|galmem
suffix:semicolon
multiline_comment|/* Allocate the registers used by the Galileo */
id|galio.flags
op_assign
id|IORESOURCE_IO
suffix:semicolon
id|galio.name
op_assign
l_string|&quot;Galileo GT64011&quot;
suffix:semicolon
id|galmem.flags
op_assign
id|IORESOURCE_MEM
op_or
id|IORESOURCE_PREFETCH
suffix:semicolon
id|galmem.name
op_assign
l_string|&quot;Galileo GT64011 DRAM&quot;
suffix:semicolon
id|allocate_resource
c_func
(paren
op_amp
id|ioport_resource
comma
op_amp
id|galio
comma
l_int|256
comma
id|GT64111_IO_BASE_ADDRESS
comma
id|GT64111_IO_BASE_ADDRESS
op_plus
l_int|256
comma
l_int|256
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
id|allocate_resource
c_func
(paren
op_amp
id|iomem_resource
comma
op_amp
id|galmem
comma
id|PCI_DRAM_SIZE
comma
id|PHYSADDR
c_func
(paren
id|PCI_DRAM_BASE
)paren
comma
id|PHYSADDR
c_func
(paren
id|PCI_DRAM_BASE
)paren
op_plus
id|PCI_DRAM_SIZE
comma
id|PCI_DRAM_SIZE
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* ok, do the scan man */
id|pci_root_bus
op_assign
id|pci_scan_bus
c_func
(paren
l_int|0
comma
op_amp
id|pci_config_ops
comma
l_int|NULL
)paren
suffix:semicolon
id|pci_assign_unassigned_resources
c_func
(paren
)paren
suffix:semicolon
id|pci_fixup_irqs
c_func
(paren
id|no_swizzle
comma
id|map_od_irq
)paren
suffix:semicolon
macro_line|#ifdef TEST_DRAM
id|printk
c_func
(paren
l_string|&quot;Testing PCI DRAM - &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_dram
c_func
(paren
id|PCI_DRAM_BASE
comma
id|PCI_DRAM_SIZE
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Passed&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;FAILED&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
DECL|function|pcibios_setup
r_char
op_star
id|__init
id|pcibios_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_return
id|str
suffix:semicolon
)brace
DECL|function|pcibios_enable_device
r_int
id|pcibios_enable_device
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|u16
id|cmd
comma
id|old_cmd
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_struct
id|resource
op_star
id|r
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|old_cmd
op_assign
id|cmd
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
l_int|6
suffix:semicolon
id|idx
op_increment
)paren
(brace
id|r
op_assign
id|dev-&gt;resource
op_plus
id|idx
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|r-&gt;start
op_logical_and
id|r-&gt;end
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PCI: Device %s not available because&quot;
l_string|&quot; of resource collisions&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|r-&gt;flags
op_amp
id|IORESOURCE_IO
)paren
id|cmd
op_or_assign
id|PCI_COMMAND_IO
suffix:semicolon
r_if
c_cond
(paren
id|r-&gt;flags
op_amp
id|IORESOURCE_MEM
)paren
id|cmd
op_or_assign
id|PCI_COMMAND_MEMORY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_ne
id|old_cmd
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: enabling device %s (%04x -&gt; %04x)&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|dev
)paren
comma
id|old_cmd
comma
id|cmd
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
id|cmd
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* We should do some optimisation work here I think. Ok for now though */
DECL|function|pcibios_fixup_bus
r_void
id|__init
id|pcibios_fixup_bus
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
)paren
(brace
)brace
DECL|function|pcibios_align_resource
r_void
id|pcibios_align_resource
c_func
(paren
r_void
op_star
id|data
comma
r_struct
id|resource
op_star
id|res
comma
r_int
r_int
id|size
)paren
(brace
)brace
DECL|function|pcibios_update_resource
r_void
id|__init
id|pcibios_update_resource
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_struct
id|resource
op_star
id|root
comma
r_struct
id|resource
op_star
id|res
comma
r_int
id|resource
)paren
(brace
r_int
r_int
id|where
comma
id|size
suffix:semicolon
id|u32
id|reg
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI: Assigning %3s %08lx to %s&bslash;n&quot;
comma
id|res-&gt;flags
op_amp
id|IORESOURCE_IO
ques
c_cond
l_string|&quot;IO&quot;
suffix:colon
l_string|&quot;MEM&quot;
comma
id|res-&gt;start
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|where
op_assign
id|PCI_BASE_ADDRESS_0
op_plus
id|resource
op_star
l_int|4
suffix:semicolon
id|size
op_assign
id|res-&gt;end
op_minus
id|res-&gt;start
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|dev
comma
id|where
comma
op_amp
id|reg
)paren
suffix:semicolon
id|reg
op_assign
(paren
id|reg
op_amp
id|size
)paren
op_or
(paren
(paren
(paren
id|u32
)paren
(paren
id|res-&gt;start
op_minus
id|root-&gt;start
)paren
)paren
op_amp
op_complement
id|size
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|dev
comma
id|where
comma
id|reg
)paren
suffix:semicolon
)brace
DECL|function|pcibios_update_irq
r_void
id|__init
id|pcibios_update_irq
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|irq
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: Assigning IRQ %02d to %s&bslash;n&quot;
comma
id|irq
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|PCI_INTERRUPT_LINE
comma
id|irq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  If we set up a device for bus mastering, we need to check the latency&n; *  timer as certain crappy BIOSes forget to set it properly.&n; */
DECL|variable|pcibios_max_latency
r_int
r_int
id|pcibios_max_latency
op_assign
l_int|255
suffix:semicolon
DECL|function|pcibios_set_master
r_void
id|pcibios_set_master
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|u8
id|lat
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|PCI_LATENCY_TIMER
comma
op_amp
id|lat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lat
OL
l_int|16
)paren
id|lat
op_assign
(paren
l_int|64
op_le
id|pcibios_max_latency
)paren
ques
c_cond
l_int|64
suffix:colon
id|pcibios_max_latency
suffix:semicolon
r_else
r_if
c_cond
(paren
id|lat
OG
id|pcibios_max_latency
)paren
id|lat
op_assign
id|pcibios_max_latency
suffix:semicolon
r_else
r_return
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI: Setting latency timer of device %s to %d&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|dev
)paren
comma
id|lat
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|PCI_LATENCY_TIMER
comma
id|lat
)paren
suffix:semicolon
)brace
eof
