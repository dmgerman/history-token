multiline_comment|/* &n; * Copyright (C) 2000 David J. Mckay (david.mckay@st.com)&n; *&n; * May be copied or modified under the terms of the GNU General Public&n; * License.  See linux/COPYING for more information.                            &n; *&n; * This file handles programming up the Altera Flex10K that interfaces to&n; * the Galileo, and does the PS/2 keyboard and mouse&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/overdriver/gt64111.h&gt;
macro_line|#include &lt;asm/overdrive/overdrive.h&gt;
macro_line|#include &lt;asm/overdrive/fpga.h&gt;
DECL|macro|FPGA_NotConfigHigh
mdefine_line|#define FPGA_NotConfigHigh()  (*FPGA_ControlReg) = (*FPGA_ControlReg) | ENABLE_FPGA_BIT
DECL|macro|FPGA_NotConfigLow
mdefine_line|#define FPGA_NotConfigLow()   (*FPGA_ControlReg) = (*FPGA_ControlReg) &amp; RESET_FPGA_MASK
multiline_comment|/* I need to find out what (if any) the real delay factor here is */
multiline_comment|/* The delay is definately not critical */
DECL|macro|long_delay
mdefine_line|#define long_delay() {int i;for(i=0;i&lt;10000;i++);}
DECL|macro|short_delay
mdefine_line|#define short_delay() {int i;for(i=0;i&lt;100;i++);}
DECL|function|program_overdrive_fpga
r_static
r_void
id|__init
id|program_overdrive_fpga
c_func
(paren
r_const
r_int
r_char
op_star
id|fpgacode
comma
r_int
id|size
)paren
(brace
r_int
id|timeout
op_assign
l_int|0
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_int
r_char
id|b
suffix:semicolon
r_static
r_volatile
r_int
r_char
op_star
id|FPGA_ControlReg
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
(paren
id|OVERDRIVE_CTRL
)paren
suffix:semicolon
r_static
r_volatile
r_int
r_char
op_star
id|FPGA_ProgramReg
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
(paren
id|FPGA_DCLK_ADDRESS
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;FPGA:  Commencing FPGA Programming&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* The PCI reset but MUST be low when programming the FPGA !!! */
id|b
op_assign
(paren
op_star
id|FPGA_ControlReg
)paren
op_amp
id|RESET_PCI_MASK
suffix:semicolon
(paren
op_star
id|FPGA_ControlReg
)paren
op_assign
id|b
suffix:semicolon
multiline_comment|/* Prepare FPGA to program */
id|FPGA_NotConfigHigh
c_func
(paren
)paren
suffix:semicolon
id|long_delay
c_func
(paren
)paren
suffix:semicolon
id|FPGA_NotConfigLow
c_func
(paren
)paren
suffix:semicolon
id|short_delay
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
op_star
id|FPGA_ProgramReg
op_amp
id|FPGA_NOT_STATUS
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;FPGA:  Waiting for NotStatus to go Low ... &bslash;n&quot;
)paren
suffix:semicolon
)brace
id|FPGA_NotConfigHigh
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Wait for FPGA &quot;ready to be programmed&quot; signal */
id|printk
c_func
(paren
l_string|&quot;FPGA:  Waiting for NotStatus to go high (FPGA ready)... &bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|timeout
op_assign
l_int|0
suffix:semicolon
(paren
(paren
(paren
op_star
id|FPGA_ProgramReg
op_amp
id|FPGA_NOT_STATUS
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|timeout
OL
id|FPGA_TIMEOUT
)paren
)paren
suffix:semicolon
id|timeout
op_increment
)paren
suffix:semicolon
multiline_comment|/* Check if timeout condition occured - i.e. an error */
r_if
c_cond
(paren
id|timeout
op_eq
id|FPGA_TIMEOUT
)paren
(brace
id|printk
(paren
l_string|&quot;FPGA:  Failed to program - Timeout waiting for notSTATUS to go high&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;FPGA:  Copying data to FPGA ... %d bytes&bslash;n&quot;
comma
id|size
)paren
suffix:semicolon
multiline_comment|/* Copy array to FPGA - bit at a time */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
(brace
r_volatile
r_int
id|w
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
(brace
op_star
id|FPGA_ProgramReg
op_assign
(paren
id|fpgacode
(braket
id|i
)braket
op_rshift
id|j
)paren
op_amp
l_int|0x01
suffix:semicolon
id|short_delay
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|i
op_amp
l_int|0x3ff
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;.&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Waiting for CONFDONE to go high - means the program is complete  */
r_for
c_loop
(paren
id|timeout
op_assign
l_int|0
suffix:semicolon
(paren
(paren
(paren
op_star
id|FPGA_ProgramReg
op_amp
id|FPGA_CONFDONE
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|timeout
OL
id|FPGA_TIMEOUT
)paren
)paren
suffix:semicolon
id|timeout
op_increment
)paren
(brace
op_star
id|FPGA_ProgramReg
op_assign
l_int|0x0
suffix:semicolon
id|long_delay
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|timeout
op_eq
id|FPGA_TIMEOUT
)paren
(brace
id|printk
(paren
l_string|&quot;FPGA:  Failed to program - Timeout waiting for CONFDONE to go high&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Clock another 10 times - gets the device into a working state      */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|FPGA_ProgramReg
op_assign
l_int|0x0
suffix:semicolon
id|short_delay
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;FPGA:  Programming complete&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|variable|fpgacode
r_static
r_const
r_int
r_char
id|__init
id|fpgacode
(braket
)braket
op_assign
(brace
macro_line|#include &quot;./overdrive.ttf&quot;&t;/* Code from maxplus2 compiler */
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|function|init_overdrive_fpga
r_int
id|__init
id|init_overdrive_fpga
c_func
(paren
r_void
)paren
(brace
id|program_overdrive_fpga
c_func
(paren
id|fpgacode
comma
r_sizeof
(paren
id|fpgacode
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
