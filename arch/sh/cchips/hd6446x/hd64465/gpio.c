multiline_comment|/*&n; * $Id: gpio.c,v 1.4 2003/05/19 22:24:18 lethal Exp $&n; * by Greg Banks &lt;gbanks@pocketpenguins.com&gt;&n; * (c) 2000 PocketPenguins Inc&n; *&n; * GPIO pin support for HD64465 companion chip.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/hd64465/gpio.h&gt;
DECL|macro|_PORTOF
mdefine_line|#define _PORTOF(portpin)    (((portpin)&gt;&gt;3)&amp;0x7)
DECL|macro|_PINOF
mdefine_line|#define _PINOF(portpin)     ((portpin)&amp;0x7)
multiline_comment|/* Register addresses parametrised on port */
DECL|macro|GPIO_CR
mdefine_line|#define GPIO_CR(port)&t;    (HD64465_REG_GPACR+((port)&lt;&lt;1))
DECL|macro|GPIO_DR
mdefine_line|#define GPIO_DR(port)&t;    (HD64465_REG_GPADR+((port)&lt;&lt;1))
DECL|macro|GPIO_ICR
mdefine_line|#define GPIO_ICR(port)&t;    (HD64465_REG_GPAICR+((port)&lt;&lt;1))
DECL|macro|GPIO_ISR
mdefine_line|#define GPIO_ISR(port)&t;    (HD64465_REG_GPAISR+((port)&lt;&lt;1))
DECL|macro|GPIO_NPORTS
mdefine_line|#define GPIO_NPORTS 5
DECL|macro|MODNAME
mdefine_line|#define MODNAME &quot;hd64465_gpio&quot;
DECL|variable|hd64465_gpio_configure
id|EXPORT_SYMBOL
c_func
(paren
id|hd64465_gpio_configure
)paren
suffix:semicolon
DECL|variable|hd64465_gpio_get_pin
id|EXPORT_SYMBOL
c_func
(paren
id|hd64465_gpio_get_pin
)paren
suffix:semicolon
DECL|variable|hd64465_gpio_get_port
id|EXPORT_SYMBOL
c_func
(paren
id|hd64465_gpio_get_port
)paren
suffix:semicolon
DECL|variable|hd64465_gpio_register_irq
id|EXPORT_SYMBOL
c_func
(paren
id|hd64465_gpio_register_irq
)paren
suffix:semicolon
DECL|variable|hd64465_gpio_set_pin
id|EXPORT_SYMBOL
c_func
(paren
id|hd64465_gpio_set_pin
)paren
suffix:semicolon
DECL|variable|hd64465_gpio_set_port
id|EXPORT_SYMBOL
c_func
(paren
id|hd64465_gpio_set_port
)paren
suffix:semicolon
DECL|variable|hd64465_gpio_unregister_irq
id|EXPORT_SYMBOL
c_func
(paren
id|hd64465_gpio_unregister_irq
)paren
suffix:semicolon
multiline_comment|/* TODO: each port should be protected with a spinlock */
DECL|function|hd64465_gpio_configure
r_void
id|hd64465_gpio_configure
c_func
(paren
r_int
id|portpin
comma
r_int
id|direction
)paren
(brace
r_int
r_int
id|cr
suffix:semicolon
r_int
r_int
id|shift
op_assign
(paren
id|_PINOF
c_func
(paren
id|portpin
)paren
op_lshift
l_int|1
)paren
suffix:semicolon
id|cr
op_assign
id|inw
c_func
(paren
id|GPIO_CR
c_func
(paren
id|_PORTOF
c_func
(paren
id|portpin
)paren
)paren
)paren
suffix:semicolon
id|cr
op_and_assign
op_complement
(paren
l_int|3
op_lshift
id|shift
)paren
suffix:semicolon
id|cr
op_or_assign
id|direction
op_lshift
id|shift
suffix:semicolon
id|outw
c_func
(paren
id|cr
comma
id|GPIO_CR
c_func
(paren
id|_PORTOF
c_func
(paren
id|portpin
)paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|hd64465_gpio_set_pin
r_void
id|hd64465_gpio_set_pin
c_func
(paren
r_int
id|portpin
comma
r_int
r_int
id|value
)paren
(brace
r_int
r_int
id|d
suffix:semicolon
r_int
r_int
id|mask
op_assign
l_int|1
op_lshift
(paren
id|_PINOF
c_func
(paren
id|portpin
)paren
)paren
suffix:semicolon
id|d
op_assign
id|inw
c_func
(paren
id|GPIO_DR
c_func
(paren
id|_PORTOF
c_func
(paren
id|portpin
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
id|d
op_or_assign
id|mask
suffix:semicolon
r_else
id|d
op_and_assign
op_complement
id|mask
suffix:semicolon
id|outw
c_func
(paren
id|d
comma
id|GPIO_DR
c_func
(paren
id|_PORTOF
c_func
(paren
id|portpin
)paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|hd64465_gpio_get_pin
r_int
r_int
id|hd64465_gpio_get_pin
c_func
(paren
r_int
id|portpin
)paren
(brace
r_return
id|inw
c_func
(paren
id|GPIO_DR
c_func
(paren
id|_PORTOF
c_func
(paren
id|portpin
)paren
)paren
)paren
op_amp
(paren
l_int|1
op_lshift
(paren
id|_PINOF
c_func
(paren
id|portpin
)paren
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* TODO: for cleaner atomicity semantics, add a mask to this routine */
DECL|function|hd64465_gpio_set_port
r_void
id|hd64465_gpio_set_port
c_func
(paren
r_int
id|port
comma
r_int
r_int
id|value
)paren
(brace
id|outw
c_func
(paren
id|value
comma
id|GPIO_DR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
DECL|function|hd64465_gpio_get_port
r_int
r_int
id|hd64465_gpio_get_port
c_func
(paren
r_int
id|port
)paren
(brace
r_return
id|inw
c_func
(paren
id|GPIO_DR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
r_static
r_struct
(brace
DECL|member|func
r_void
(paren
op_star
id|func
)paren
(paren
r_int
id|portpin
comma
r_void
op_star
id|dev
)paren
suffix:semicolon
DECL|member|dev
r_void
op_star
id|dev
suffix:semicolon
DECL|variable|handlers
)brace
id|handlers
(braket
id|GPIO_NPORTS
op_star
l_int|8
)braket
suffix:semicolon
DECL|function|hd64465_gpio_interrupt
r_static
id|irqreturn_t
id|hd64465_gpio_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|port
comma
id|pin
comma
id|isr
comma
id|mask
comma
id|portpin
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
l_int|0
suffix:semicolon
id|port
OL
id|GPIO_NPORTS
suffix:semicolon
id|port
op_increment
)paren
(brace
id|isr
op_assign
id|inw
c_func
(paren
id|GPIO_ISR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pin
op_assign
l_int|0
suffix:semicolon
id|pin
OL
l_int|8
suffix:semicolon
id|pin
op_increment
)paren
(brace
id|mask
op_assign
l_int|1
op_lshift
id|pin
suffix:semicolon
r_if
c_cond
(paren
id|isr
op_amp
id|mask
)paren
(brace
id|portpin
op_assign
(paren
id|port
op_lshift
l_int|3
)paren
op_or
id|pin
suffix:semicolon
r_if
c_cond
(paren
id|handlers
(braket
id|portpin
)braket
dot
id|func
op_ne
l_int|0
)paren
id|handlers
(braket
id|portpin
)braket
dot
id|func
c_func
(paren
id|portpin
comma
id|handlers
(braket
id|portpin
)braket
dot
id|dev
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;unexpected GPIO interrupt, pin %c%d&bslash;n&quot;
comma
id|port
op_plus
l_char|&squot;A&squot;
comma
(paren
r_int
)paren
id|pin
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Write 1s back to ISR to clear it?  That&squot;s what the manual says.. */
id|outw
c_func
(paren
id|isr
comma
id|GPIO_ISR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|hd64465_gpio_register_irq
r_void
id|hd64465_gpio_register_irq
c_func
(paren
r_int
id|portpin
comma
r_int
id|mode
comma
r_void
(paren
op_star
id|handler
)paren
(paren
r_int
id|portpin
comma
r_void
op_star
id|dev
)paren
comma
r_void
op_star
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|icr
comma
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|handler
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|handlers
(braket
id|portpin
)braket
dot
id|func
op_assign
id|handler
suffix:semicolon
id|handlers
(braket
id|portpin
)braket
dot
id|dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/*&n;&t; * Configure Interrupt Control Register&n;&t; */
id|icr
op_assign
id|inw
c_func
(paren
id|GPIO_ICR
c_func
(paren
id|_PORTOF
c_func
(paren
id|portpin
)paren
)paren
)paren
suffix:semicolon
id|mask
op_assign
(paren
l_int|1
op_lshift
id|_PINOF
c_func
(paren
id|portpin
)paren
)paren
suffix:semicolon
multiline_comment|/* unmask interrupt */
id|icr
op_and_assign
op_complement
id|mask
suffix:semicolon
multiline_comment|/* set TS bit */
id|mask
op_lshift_assign
l_int|8
suffix:semicolon
id|icr
op_and_assign
op_complement
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|HD64465_GPIO_RISING
)paren
id|icr
op_or_assign
id|mask
suffix:semicolon
id|outw
c_func
(paren
id|icr
comma
id|GPIO_ICR
c_func
(paren
id|_PORTOF
c_func
(paren
id|portpin
)paren
)paren
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|hd64465_gpio_unregister_irq
r_void
id|hd64465_gpio_unregister_irq
c_func
(paren
r_int
id|portpin
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|icr
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Configure Interrupt Control Register&n;&t; */
id|icr
op_assign
id|inw
c_func
(paren
id|GPIO_ICR
c_func
(paren
id|_PORTOF
c_func
(paren
id|portpin
)paren
)paren
)paren
suffix:semicolon
id|icr
op_or_assign
(paren
l_int|1
op_lshift
id|_PINOF
c_func
(paren
id|portpin
)paren
)paren
suffix:semicolon
multiline_comment|/* mask interrupt */
id|outw
c_func
(paren
id|icr
comma
id|GPIO_ICR
c_func
(paren
id|_PORTOF
c_func
(paren
id|portpin
)paren
)paren
)paren
suffix:semicolon
id|handlers
(braket
id|portpin
)braket
dot
id|func
op_assign
l_int|0
suffix:semicolon
id|handlers
(braket
id|portpin
)braket
dot
id|dev
op_assign
l_int|0
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|hd64465_gpio_init
r_static
r_int
id|__init
id|hd64465_gpio_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|HD64465_REG_GPACR
comma
l_int|0x1000
comma
id|MODNAME
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|HD64465_IRQ_GPIO
comma
id|hd64465_gpio_interrupt
comma
id|SA_INTERRUPT
comma
id|MODNAME
comma
l_int|0
)paren
)paren
r_goto
id|out_irqfailed
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;HD64465 GPIO layer on irq %d&bslash;n&quot;
comma
id|HD64465_IRQ_GPIO
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_irqfailed
suffix:colon
id|release_region
c_func
(paren
id|HD64465_REG_GPACR
comma
l_int|0x1000
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|hd64465_gpio_exit
r_static
r_void
id|__exit
id|hd64465_gpio_exit
c_func
(paren
r_void
)paren
(brace
id|release_region
c_func
(paren
id|HD64465_REG_GPACR
comma
l_int|0x1000
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|HD64465_IRQ_GPIO
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|variable|hd64465_gpio_init
id|module_init
c_func
(paren
id|hd64465_gpio_init
)paren
suffix:semicolon
DECL|variable|hd64465_gpio_exit
id|module_exit
c_func
(paren
id|hd64465_gpio_exit
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
