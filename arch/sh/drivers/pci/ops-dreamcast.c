multiline_comment|/*&n; * arch/sh/pci/ops-dreamcast.c&n; *&n; * PCI operations for the Sega Dreamcast&n; *&n; * Copyright (C) 2001, 2002  M. R. Brown&n; * Copyright (C) 2002, 2003  Paul Mundt&n; *&n; * This file originally bore the message (with enclosed-$):&n; *&t;Id: pci.c,v 1.3 2003/05/04 19:29:46 lethal Exp&n; *&t;Dreamcast PCI: Supports SEGA Broadband Adaptor only.&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/param.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/mach/pci.h&gt;
DECL|variable|gapspci_io_resource
r_static
r_struct
id|resource
id|gapspci_io_resource
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;GAPSPCI IO&quot;
comma
dot
id|start
op_assign
id|GAPSPCI_BBA_CONFIG
comma
dot
id|end
op_assign
id|GAPSPCI_BBA_CONFIG
op_plus
id|GAPSPCI_BBA_CONFIG_SIZE
op_minus
l_int|1
comma
dot
id|flags
op_assign
id|IORESOURCE_IO
comma
)brace
suffix:semicolon
DECL|variable|gapspci_mem_resource
r_static
r_struct
id|resource
id|gapspci_mem_resource
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;GAPSPCI mem&quot;
comma
dot
id|start
op_assign
id|GAPSPCI_DMA_BASE
comma
dot
id|end
op_assign
id|GAPSPCI_DMA_BASE
op_plus
id|GAPSPCI_DMA_SIZE
op_minus
l_int|1
comma
dot
id|flags
op_assign
id|IORESOURCE_MEM
comma
)brace
suffix:semicolon
DECL|variable|gapspci_pci_ops
r_static
r_struct
id|pci_ops
id|gapspci_pci_ops
suffix:semicolon
DECL|variable|board_pci_channels
r_struct
id|pci_channel
id|board_pci_channels
(braket
)braket
op_assign
(brace
(brace
op_amp
id|gapspci_pci_ops
comma
op_amp
id|gapspci_io_resource
comma
op_amp
id|gapspci_mem_resource
comma
l_int|0
comma
l_int|1
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; * The !gapspci_config_access case really shouldn&squot;t happen, ever, unless&n; * someone implicitly messes around with the last devfn value.. otherwise we&n; * only support a single device anyways, and if we didn&squot;t have a BBA, we&n; * wouldn&squot;t make it terribly far through the PCI setup anyways.&n; *&n; * Also, we could very easily support both Type 0 and Type 1 configurations&n; * here, but since it doesn&squot;t seem that there is any such implementation in&n; * existance, we don&squot;t bother.&n; *&n; * I suppose if someone actually gets around to ripping the chip out of&n; * the BBA and hanging some more devices off of it, then this might be&n; * something to take into consideration. However, due to the cost of the BBA,&n; * and the general lack of activity by DC hardware hackers, this doesn&squot;t seem&n; * likely to happen anytime soon.&n; */
DECL|function|gapspci_config_access
r_static
r_int
id|gapspci_config_access
c_func
(paren
r_int
r_char
id|bus
comma
r_int
r_int
id|devfn
)paren
(brace
r_return
(paren
id|bus
op_eq
l_int|0
)paren
op_logical_and
(paren
id|devfn
op_eq
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * We can also actually read and write in b/w/l sizes! Thankfully this part&n; * was at least done right, and we don&squot;t have to do the stupid masking and&n; * shifting that we do on the 7751! Small wonders never cease to amaze.&n; */
DECL|function|gapspci_read
r_static
r_int
id|gapspci_read
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
op_star
id|val
)paren
(brace
op_star
id|val
op_assign
l_int|0xffffffff
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|gapspci_config_access
c_func
(paren
id|bus-&gt;number
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
l_int|1
suffix:colon
op_star
id|val
op_assign
id|inb
c_func
(paren
id|GAPSPCI_BBA_CONFIG
op_plus
id|where
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
op_star
id|val
op_assign
id|inw
c_func
(paren
id|GAPSPCI_BBA_CONFIG
op_plus
id|where
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
op_star
id|val
op_assign
id|inl
c_func
(paren
id|GAPSPCI_BBA_CONFIG
op_plus
id|where
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|gapspci_write
r_static
r_int
id|gapspci_write
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
id|val
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|gapspci_config_access
c_func
(paren
id|bus-&gt;number
comma
id|devfn
)paren
)paren
r_return
id|PCIBIOS_DEVICE_NOT_FOUND
suffix:semicolon
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
l_int|1
suffix:colon
id|outb
c_func
(paren
(paren
id|u8
)paren
id|val
comma
id|GAPSPCI_BBA_CONFIG
op_plus
id|where
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|outw
c_func
(paren
(paren
id|u16
)paren
id|val
comma
id|GAPSPCI_BBA_CONFIG
op_plus
id|where
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|outl
c_func
(paren
(paren
id|u32
)paren
id|val
comma
id|GAPSPCI_BBA_CONFIG
op_plus
id|where
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|variable|gapspci_pci_ops
r_static
r_struct
id|pci_ops
id|gapspci_pci_ops
op_assign
(brace
dot
id|read
op_assign
id|gapspci_read
comma
dot
id|write
op_assign
id|gapspci_write
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * gapspci init&n; */
DECL|function|gapspci_init
r_int
id|__init
id|gapspci_init
c_func
(paren
r_void
)paren
(brace
r_char
id|idbuf
(braket
l_int|16
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * FIXME: All of this wants documenting to some degree,&n;&t; * even some basic register definitions would be nice.&n;&t; *&n;&t; * I haven&squot;t seen anything this ugly since.. maple.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|idbuf
(braket
id|i
)braket
op_assign
id|inb
c_func
(paren
id|GAPSPCI_REGS
op_plus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|idbuf
comma
l_string|&quot;GAPSPCI_BRIDGE_2&quot;
comma
l_int|16
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|outl
c_func
(paren
l_int|0x5a14a501
comma
id|GAPSPCI_REGS
op_plus
l_int|0x18
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000000
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inl
c_func
(paren
id|GAPSPCI_REGS
op_plus
l_int|0x18
)paren
op_ne
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|outl
c_func
(paren
l_int|0x01000000
comma
id|GAPSPCI_REGS
op_plus
l_int|0x20
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x01000000
comma
id|GAPSPCI_REGS
op_plus
l_int|0x24
)paren
suffix:semicolon
id|outl
c_func
(paren
id|GAPSPCI_DMA_BASE
comma
id|GAPSPCI_REGS
op_plus
l_int|0x28
)paren
suffix:semicolon
id|outl
c_func
(paren
id|GAPSPCI_DMA_BASE
op_plus
id|GAPSPCI_DMA_SIZE
comma
id|GAPSPCI_REGS
op_plus
l_int|0x2c
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|1
comma
id|GAPSPCI_REGS
op_plus
l_int|0x14
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|1
comma
id|GAPSPCI_REGS
op_plus
l_int|0x34
)paren
suffix:semicolon
multiline_comment|/* Setting Broadband Adapter */
id|outw
c_func
(paren
l_int|0xf900
comma
id|GAPSPCI_BBA_CONFIG
op_plus
l_int|0x06
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x00000000
comma
id|GAPSPCI_BBA_CONFIG
op_plus
l_int|0x30
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|GAPSPCI_BBA_CONFIG
op_plus
l_int|0x3c
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xf0
comma
id|GAPSPCI_BBA_CONFIG
op_plus
l_int|0x0d
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0006
comma
id|GAPSPCI_BBA_CONFIG
op_plus
l_int|0x04
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x00002001
comma
id|GAPSPCI_BBA_CONFIG
op_plus
l_int|0x10
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x01000000
comma
id|GAPSPCI_BBA_CONFIG
op_plus
l_int|0x14
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Haven&squot;t done anything here as yet */
DECL|function|pcibios_setup
r_char
op_star
id|__devinit
id|pcibios_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_return
id|str
suffix:semicolon
)brace
eof
