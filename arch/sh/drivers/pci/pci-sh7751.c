multiline_comment|/*&n; *&t;Low-Level PCI Support for the SH7751&n; *&n; *  Dustin McIntire (dustin@sensoria.com)&n; *&t;Derived from arch/i386/kernel/pci-*.c which bore the message:&n; *&t;(c) 1999--2000 Martin Mares &lt;mj@ucw.cz&gt;&n; *&n; *  Ported to the new API by Paul Mundt &lt;lethal@linux-sh.org&gt;&n; *  With cleanup by Paul van Gool &lt;pvangool@mimotech.com&gt;&n; *&n; *  May be copied or modified under the terms of the GNU General Public&n; *  License.  See linux/COPYING for more information.&n; *&n; */
DECL|macro|DEBUG
macro_line|#undef DEBUG
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/machvec.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;pci-sh7751.h&quot;
DECL|variable|pci_probe
r_static
r_int
r_int
id|pci_probe
op_assign
id|PCI_PROBE_CONF1
suffix:semicolon
r_extern
r_int
id|pci_fixup_pcic
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/*&n; * Direct access to PCI hardware...&n; */
DECL|macro|CONFIG_CMD
mdefine_line|#define CONFIG_CMD(bus, devfn, where) (0x80000000 | (bus-&gt;number &lt;&lt; 16) | (devfn &lt;&lt; 8) | (where &amp; ~3))
multiline_comment|/*&n; * Functions for accessing PCI configuration space with type 1 accesses&n; */
DECL|function|sh7751_pci_read
r_static
r_int
id|sh7751_pci_read
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
op_star
id|val
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|data
suffix:semicolon
multiline_comment|/* &n;&t; * PCIPDR may only be accessed as 32 bit words, &n;&t; * so we must do byte alignment by hand &n;&t; */
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|outl
c_func
(paren
id|CONFIG_CMD
c_func
(paren
id|bus
comma
id|devfn
comma
id|where
)paren
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCIPAR
)paren
)paren
suffix:semicolon
id|data
op_assign
id|inl
c_func
(paren
id|PCI_REG
c_func
(paren
id|SH7751_PCIPDR
)paren
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
l_int|1
suffix:colon
op_star
id|val
op_assign
(paren
id|data
op_rshift
(paren
(paren
id|where
op_amp
l_int|3
)paren
op_lshift
l_int|3
)paren
)paren
op_amp
l_int|0xff
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
op_star
id|val
op_assign
(paren
id|data
op_rshift
(paren
(paren
id|where
op_amp
l_int|2
)paren
op_lshift
l_int|3
)paren
)paren
op_amp
l_int|0xffff
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
op_star
id|val
op_assign
id|data
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|PCIBIOS_FUNC_NOT_SUPPORTED
suffix:semicolon
)brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
multiline_comment|/* &n; * Since SH7751 only does 32bit access we&squot;ll have to do a read,&n; * mask,write operation.&n; * We&squot;ll allow an odd byte offset, though it should be illegal.&n; */
DECL|function|sh7751_pci_write
r_static
r_int
id|sh7751_pci_write
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
id|val
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|shift
suffix:semicolon
id|u32
id|data
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|outl
c_func
(paren
id|CONFIG_CMD
c_func
(paren
id|bus
comma
id|devfn
comma
id|where
)paren
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCIPAR
)paren
)paren
suffix:semicolon
id|data
op_assign
id|inl
c_func
(paren
id|PCI_REG
c_func
(paren
id|SH7751_PCIPDR
)paren
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
l_int|1
suffix:colon
id|shift
op_assign
(paren
id|where
op_amp
l_int|3
)paren
op_lshift
l_int|3
suffix:semicolon
id|data
op_and_assign
op_complement
(paren
l_int|0xff
op_lshift
id|shift
)paren
suffix:semicolon
id|data
op_or_assign
(paren
(paren
id|val
op_amp
l_int|0xff
)paren
op_lshift
id|shift
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|shift
op_assign
(paren
id|where
op_amp
l_int|2
)paren
op_lshift
l_int|3
suffix:semicolon
id|data
op_and_assign
op_complement
(paren
l_int|0xffff
op_lshift
id|shift
)paren
suffix:semicolon
id|data
op_or_assign
(paren
(paren
id|val
op_amp
l_int|0xffff
)paren
op_lshift
id|shift
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|data
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|PCIBIOS_FUNC_NOT_SUPPORTED
suffix:semicolon
)brace
id|outl
c_func
(paren
id|data
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCIPDR
)paren
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|macro|CONFIG_CMD
macro_line|#undef CONFIG_CMD
DECL|variable|sh7751_pci_ops
r_struct
id|pci_ops
id|sh7751_pci_ops
op_assign
(brace
dot
id|read
op_assign
id|sh7751_pci_read
comma
dot
id|write
op_assign
id|sh7751_pci_write
comma
)brace
suffix:semicolon
DECL|function|pci_check_direct
r_static
r_int
id|__init
id|pci_check_direct
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|tmp
comma
id|id
suffix:semicolon
multiline_comment|/* check for SH7751/SH7751R hardware */
id|id
op_assign
id|inl
c_func
(paren
id|SH7751_PCIREG_BASE
op_plus
id|SH7751_PCICONF0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|id
op_ne
(paren
(paren
id|SH7751_DEVICE_ID
op_lshift
l_int|16
)paren
op_or
id|SH7751_VENDOR_ID
)paren
op_logical_and
id|id
op_ne
(paren
(paren
id|SH7751R_DEVICE_ID
op_lshift
l_int|16
)paren
op_or
id|SH7751_VENDOR_ID
)paren
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;PCI: This is not an SH7751(R) (%x)&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Check if configuration works.&n;&t; */
r_if
c_cond
(paren
id|pci_probe
op_amp
id|PCI_PROBE_CONF1
)paren
(brace
id|tmp
op_assign
id|inl
(paren
id|PCI_REG
c_func
(paren
id|SH7751_PCIPAR
)paren
)paren
suffix:semicolon
id|outl
(paren
l_int|0x80000000
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCIPAR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inl
(paren
id|PCI_REG
c_func
(paren
id|SH7751_PCIPAR
)paren
)paren
op_eq
l_int|0x80000000
)paren
(brace
id|outl
(paren
id|tmp
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCIPAR
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PCI: Using configuration type 1&bslash;n&quot;
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|PCI_REG
c_func
(paren
id|SH7751_PCIPAR
)paren
comma
l_int|8
comma
l_string|&quot;PCI conf1&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|outl
(paren
id|tmp
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCIPAR
)paren
)paren
suffix:semicolon
)brace
id|pr_debug
c_func
(paren
l_string|&quot;PCI: pci_check_direct failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/***************************************************************************************/
multiline_comment|/*&n; *  Handle bus scanning and fixups ....&n; */
macro_line|#if !defined(CONFIG_SH_HS7751RVOIP) &amp;&amp; !defined(CONFIG_SH_RTS7751R2D)
DECL|function|pci_fixup_ide_bases
r_static
r_void
id|__init
id|pci_fixup_ide_bases
c_func
(paren
r_struct
id|pci_dev
op_star
id|d
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * PCI IDE controllers use non-standard I/O port decoding, respect it.&n;&t; */
r_if
c_cond
(paren
(paren
id|d
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_ne
id|PCI_CLASS_STORAGE_IDE
)paren
r_return
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;PCI: IDE base address fixup for %s&bslash;n&quot;
comma
id|d-&gt;slot_name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|resource
op_star
id|r
op_assign
op_amp
id|d-&gt;resource
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r-&gt;start
op_amp
op_complement
l_int|0x80
)paren
op_eq
l_int|0x374
)paren
(brace
id|r-&gt;start
op_or_assign
l_int|2
suffix:semicolon
id|r-&gt;end
op_assign
id|r-&gt;start
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
multiline_comment|/* Add future fixups here... */
DECL|variable|pcibios_fixups
r_struct
id|pci_fixup
id|pcibios_fixups
(braket
)braket
op_assign
(brace
macro_line|#if !defined(CONFIG_SH_HS7751RVOIP) &amp;&amp; !defined(CONFIG_SH_RTS7751R2D)
(brace
id|PCI_FIXUP_HEADER
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|pci_fixup_ide_bases
)brace
comma
macro_line|#endif
(brace
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; *  Called after each bus is probed, but before its children&n; *  are examined.&n; */
DECL|function|pcibios_fixup_bus
r_void
id|__init
id|pcibios_fixup_bus
c_func
(paren
r_struct
id|pci_bus
op_star
id|b
)paren
(brace
id|pci_read_bridge_bases
c_func
(paren
id|b
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialization. Try all known PCI access methods. Note that we support&n; * using both PCI BIOS and direct access: in such cases, we use I/O ports&n; * to access config space.&n; * &n; * Note that the platform specific initialization (BSC registers, and memory&n; * space mapping) will be called via the machine vectors (sh_mv.mv_pci_init()) if it&n; * exitst and via the platform defined function pcibios_init_platform().  &n; * See pci_bigsur.c for implementation;&n; * &n; * The BIOS version of the pci functions is not yet implemented but it is left&n; * in for completeness.  Currently an error will be genereated at compile time. &n; */
DECL|function|sh7751_pci_init
r_static
r_int
id|__init
id|sh7751_pci_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;PCI: Starting intialization.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|pci_check_direct
c_func
(paren
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_return
id|pcibios_init_platform
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|variable|sh7751_pci_init
id|subsys_initcall
c_func
(paren
id|sh7751_pci_init
)paren
suffix:semicolon
DECL|function|__area_sdram_check
r_static
r_int
id|__init
id|__area_sdram_check
c_func
(paren
r_int
r_int
id|area
)paren
(brace
id|u32
id|word
suffix:semicolon
id|word
op_assign
id|inl
c_func
(paren
id|SH7751_BCR1
)paren
suffix:semicolon
multiline_comment|/* check BCR for SDRAM in area */
r_if
c_cond
(paren
(paren
(paren
id|word
op_rshift
id|area
)paren
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: Area %d is not configured for SDRAM. BCR1=0x%x&bslash;n&quot;
comma
id|area
comma
id|word
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCIBCR1
)paren
)paren
suffix:semicolon
id|word
op_assign
(paren
id|u16
)paren
id|inw
c_func
(paren
id|SH7751_BCR2
)paren
suffix:semicolon
multiline_comment|/* check BCR2 for 32bit SDRAM interface*/
r_if
c_cond
(paren
(paren
(paren
id|word
op_rshift
(paren
id|area
op_lshift
l_int|1
)paren
)paren
op_amp
l_int|0x3
)paren
op_ne
l_int|0x3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: Area %d is not 32 bit SDRAM. BCR2=0x%x&bslash;n&quot;
comma
id|area
comma
id|word
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCIBCR2
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sh7751_pcic_init
r_int
id|__init
id|sh7751_pcic_init
c_func
(paren
r_struct
id|sh7751_pci_address_map
op_star
id|map
)paren
(brace
id|u32
id|reg
suffix:semicolon
id|u32
id|word
suffix:semicolon
multiline_comment|/* Set the BCR&squot;s to enable PCI access */
id|reg
op_assign
id|inl
c_func
(paren
id|SH7751_BCR1
)paren
suffix:semicolon
id|reg
op_or_assign
l_int|0x80000
suffix:semicolon
id|outl
c_func
(paren
id|reg
comma
id|SH7751_BCR1
)paren
suffix:semicolon
multiline_comment|/* Turn the clocks back on (not done in reset)*/
id|outl
c_func
(paren
l_int|0
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCICLKR
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear Powerdown IRQ&squot;s (not done in reset) */
id|word
op_assign
id|SH7751_PCIPINT_D3
op_or
id|SH7751_PCIPINT_D0
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCICLKR
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * This code is unused for some boards as it is done in the&n;&t; * bootloader and doing it here means the MAC addresses loaded&n;&t; * by the bootloader get lost.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|map-&gt;flags
op_amp
id|SH7751_PCIC_NO_RESET
)paren
)paren
(brace
multiline_comment|/* toggle PCI reset pin */
id|word
op_assign
id|SH7751_PCICR_PREFIX
op_or
id|SH7751_PCICR_PRST
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCICR
)paren
)paren
suffix:semicolon
multiline_comment|/* Wait for a long time... not 1 sec. but long enough */
id|mdelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|word
op_assign
id|SH7751_PCICR_PREFIX
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCICR
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* set the command/status bits to:&n;&t; * Wait Cycle Control + Parity Enable + Bus Master +&n;&t; * Mem space enable&n;&t; */
id|word
op_assign
id|SH7751_PCICONF1_WCC
op_or
id|SH7751_PCICONF1_PER
op_or
id|SH7751_PCICONF1_BUM
op_or
id|SH7751_PCICONF1_MES
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCICONF1
)paren
)paren
suffix:semicolon
multiline_comment|/* define this host as the host bridge */
id|word
op_assign
id|SH7751_PCI_HOST_BRIDGE
op_lshift
l_int|24
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCICONF2
)paren
)paren
suffix:semicolon
multiline_comment|/* Set IO and Mem windows to local address &n;&t; * Make PCI and local address the same for easy 1 to 1 mapping &n;&t; * Window0 = map-&gt;window0.size @ non-cached area base = SDRAM&n;&t; * Window1 = map-&gt;window1.size @ cached area base = SDRAM &n;&t; */
id|word
op_assign
id|map-&gt;window0.size
op_minus
l_int|1
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCILSR0
)paren
)paren
suffix:semicolon
id|word
op_assign
id|map-&gt;window1.size
op_minus
l_int|1
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCILSR1
)paren
)paren
suffix:semicolon
multiline_comment|/* Set the values on window 0 PCI config registers */
id|word
op_assign
id|P2SEGADDR
c_func
(paren
id|map-&gt;window0.base
)paren
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCILAR0
)paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCICONF5
)paren
)paren
suffix:semicolon
multiline_comment|/* Set the values on window 1 PCI config registers */
id|word
op_assign
id|PHYSADDR
c_func
(paren
id|map-&gt;window1.base
)paren
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCILAR1
)paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCICONF6
)paren
)paren
suffix:semicolon
multiline_comment|/* Set the local 16MB PCI memory space window to &n;&t; * the lowest PCI mapped address&n;&t; */
id|word
op_assign
id|PCIBIOS_MIN_MEM
op_amp
id|SH7751_PCIMBR_MASK
suffix:semicolon
id|PCIDBG
c_func
(paren
l_int|2
comma
l_string|&quot;PCI: Setting upper bits of Memory window to 0x%x&bslash;n&quot;
comma
id|word
)paren
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCIMBR
)paren
)paren
suffix:semicolon
multiline_comment|/* Map IO space into PCI IO window&n;&t; * The IO window is 64K-PCIBIOS_MIN_IO in size&n;&t; * IO addresses will be translated to the &n;&t; * PCI IO window base address&n;&t; */
id|PCIDBG
c_func
(paren
l_int|3
comma
l_string|&quot;PCI: Mapping IO address 0x%x - 0x%x to base 0x%x&bslash;n&quot;
comma
id|PCIBIOS_MIN_IO
comma
(paren
l_int|64
op_star
l_int|1024
)paren
comma
id|SH7751_PCI_IO_BASE
op_plus
id|PCIBIOS_MIN_IO
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * XXX: For now, leave this board-specific. In the event we have other&n;&t; * boards that need to do similar work, this can be wrapped.&n;&t; */
macro_line|#ifdef CONFIG_SH_BIGSUR
id|bigsur_port_map
c_func
(paren
id|PCIBIOS_MIN_IO
comma
(paren
l_int|64
op_star
l_int|1024
)paren
comma
id|SH7751_PCI_IO_BASE
op_plus
id|PCIBIOS_MIN_IO
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Make sure the MSB&squot;s of IO window are set to access PCI space correctly */
id|word
op_assign
id|PCIBIOS_MIN_IO
op_amp
id|SH7751_PCIIOBR_MASK
suffix:semicolon
id|PCIDBG
c_func
(paren
l_int|2
comma
l_string|&quot;PCI: Setting upper bits of IO window to 0x%x&bslash;n&quot;
comma
id|word
)paren
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCIIOBR
)paren
)paren
suffix:semicolon
multiline_comment|/* Set PCI WCRx, BCRx&squot;s, copy from BSC locations */
multiline_comment|/* check BCR for SDRAM in specified area */
r_switch
c_cond
(paren
id|map-&gt;window0.base
)paren
(brace
r_case
id|SH7751_CS0_BASE_ADDR
suffix:colon
id|word
op_assign
id|__area_sdram_check
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SH7751_CS1_BASE_ADDR
suffix:colon
id|word
op_assign
id|__area_sdram_check
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SH7751_CS2_BASE_ADDR
suffix:colon
id|word
op_assign
id|__area_sdram_check
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SH7751_CS3_BASE_ADDR
suffix:colon
id|word
op_assign
id|__area_sdram_check
c_func
(paren
l_int|3
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SH7751_CS4_BASE_ADDR
suffix:colon
id|word
op_assign
id|__area_sdram_check
c_func
(paren
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SH7751_CS5_BASE_ADDR
suffix:colon
id|word
op_assign
id|__area_sdram_check
c_func
(paren
l_int|5
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SH7751_CS6_BASE_ADDR
suffix:colon
id|word
op_assign
id|__area_sdram_check
c_func
(paren
l_int|6
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|word
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* configure the wait control registers */
id|word
op_assign
id|inl
c_func
(paren
id|SH7751_WCR1
)paren
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCIWCR1
)paren
)paren
suffix:semicolon
id|word
op_assign
id|inl
c_func
(paren
id|SH7751_WCR2
)paren
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCIWCR2
)paren
)paren
suffix:semicolon
id|word
op_assign
id|inl
c_func
(paren
id|SH7751_WCR3
)paren
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCIWCR3
)paren
)paren
suffix:semicolon
id|word
op_assign
id|inl
c_func
(paren
id|SH7751_MCR
)paren
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCIMCR
)paren
)paren
suffix:semicolon
multiline_comment|/* NOTE: I&squot;m ignoring the PCI error IRQs for now..&n;&t; * TODO: add support for the internal error interrupts and&n;&t; * DMA interrupts...&n;&t; */
macro_line|#ifdef CONFIG_SH_RTS7751R2D
id|pci_fixup_pcic
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* SH7751 init done, set central function init complete */
multiline_comment|/* use round robin mode to stop a device starving/overruning */
id|word
op_assign
id|SH7751_PCICR_PREFIX
op_or
id|SH7751_PCICR_CFIN
op_or
id|SH7751_PCICR_ARBM
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCICR
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|pcibios_setup
r_char
op_star
id|__init
id|pcibios_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|str
comma
l_string|&quot;off&quot;
)paren
)paren
(brace
id|pci_probe
op_assign
l_int|0
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|str
suffix:semicolon
)brace
multiline_comment|/* &n; * &t;IRQ functions &n; */
DECL|function|sh7751_no_swizzle
r_static
id|u8
id|__init
id|sh7751_no_swizzle
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
id|u8
op_star
id|pin
)paren
(brace
multiline_comment|/* no swizzling */
r_return
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
suffix:semicolon
)brace
DECL|function|sh7751_pci_lookup_irq
r_static
r_int
id|sh7751_pci_lookup_irq
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
id|u8
id|slot
comma
id|u8
id|pin
)paren
(brace
r_int
id|irq
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* now lookup the actual IRQ on a platform specific basis (pci-&squot;platform&squot;.c) */
id|irq
op_assign
id|pcibios_map_platform_irq
c_func
(paren
id|slot
comma
id|pin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq
OL
l_int|0
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;PCI: Error mapping IRQ on device %s&bslash;n&quot;
comma
id|dev-&gt;slot_name
)paren
suffix:semicolon
r_return
id|irq
suffix:semicolon
)brace
id|pr_debug
c_func
(paren
l_string|&quot;Setting IRQ for slot %s to %d&bslash;n&quot;
comma
id|dev-&gt;slot_name
comma
id|irq
)paren
suffix:semicolon
r_return
id|irq
suffix:semicolon
)brace
DECL|function|pcibios_fixup_irqs
r_void
id|__init
id|pcibios_fixup_irqs
c_func
(paren
r_void
)paren
(brace
id|pci_fixup_irqs
c_func
(paren
id|sh7751_no_swizzle
comma
id|sh7751_pci_lookup_irq
)paren
suffix:semicolon
)brace
eof
