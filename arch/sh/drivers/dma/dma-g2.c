multiline_comment|/*&n; * arch/sh/drivers/dma/dma-g2.c&n; *&n; * G2 bus DMA support&n; *&n; * Copyright (C) 2003  Paul Mundt&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/mach/sysasic.h&gt;
macro_line|#include &lt;asm/mach/dma.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
DECL|struct|g2_channel
r_struct
id|g2_channel
(brace
DECL|member|g2_addr
r_int
r_int
id|g2_addr
suffix:semicolon
multiline_comment|/* G2 bus address */
DECL|member|root_addr
r_int
r_int
id|root_addr
suffix:semicolon
multiline_comment|/* Root bus (SH-4) address */
DECL|member|size
r_int
r_int
id|size
suffix:semicolon
multiline_comment|/* Size (in bytes), 32-byte aligned */
DECL|member|direction
r_int
r_int
id|direction
suffix:semicolon
multiline_comment|/* Transfer direction */
DECL|member|ctrl
r_int
r_int
id|ctrl
suffix:semicolon
multiline_comment|/* Transfer control */
DECL|member|chan_enable
r_int
r_int
id|chan_enable
suffix:semicolon
multiline_comment|/* Channel enable */
DECL|member|xfer_enable
r_int
r_int
id|xfer_enable
suffix:semicolon
multiline_comment|/* Transfer enable */
DECL|member|xfer_stat
r_int
r_int
id|xfer_stat
suffix:semicolon
multiline_comment|/* Transfer status */
)brace
id|__attribute__
(paren
(paren
id|aligned
c_func
(paren
l_int|32
)paren
)paren
)paren
suffix:semicolon
DECL|struct|g2_status
r_struct
id|g2_status
(brace
DECL|member|g2_addr
r_int
r_int
id|g2_addr
suffix:semicolon
DECL|member|root_addr
r_int
r_int
id|root_addr
suffix:semicolon
DECL|member|size
r_int
r_int
id|size
suffix:semicolon
DECL|member|status
r_int
r_int
id|status
suffix:semicolon
)brace
id|__attribute__
(paren
(paren
id|aligned
c_func
(paren
l_int|16
)paren
)paren
)paren
suffix:semicolon
DECL|struct|g2_dma_info
r_struct
id|g2_dma_info
(brace
DECL|member|channel
r_struct
id|g2_channel
id|channel
(braket
id|G2_NR_DMA_CHANNELS
)braket
suffix:semicolon
DECL|member|pad1
r_int
r_int
id|pad1
(braket
id|G2_NR_DMA_CHANNELS
)braket
suffix:semicolon
DECL|member|wait_state
r_int
r_int
id|wait_state
suffix:semicolon
DECL|member|pad2
r_int
r_int
id|pad2
(braket
l_int|10
)braket
suffix:semicolon
DECL|member|magic
r_int
r_int
id|magic
suffix:semicolon
DECL|member|status
r_struct
id|g2_status
id|status
(braket
id|G2_NR_DMA_CHANNELS
)braket
suffix:semicolon
)brace
id|__attribute__
(paren
(paren
id|aligned
c_func
(paren
l_int|256
)paren
)paren
)paren
suffix:semicolon
DECL|variable|g2_dma
r_static
r_volatile
r_struct
id|g2_dma_info
op_star
id|g2_dma
op_assign
(paren
r_volatile
r_struct
id|g2_dma_info
op_star
)paren
l_int|0xa05f7800
suffix:semicolon
DECL|function|g2_dma_interrupt
r_static
id|irqreturn_t
id|g2_dma_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
multiline_comment|/* FIXME: Do some meaningful completion work here.. */
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|variable|g2_dma_irq
r_static
r_struct
id|irqaction
id|g2_dma_irq
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;g2 DMA handler&quot;
comma
dot
id|handler
op_assign
id|g2_dma_interrupt
comma
dot
id|flags
op_assign
id|SA_INTERRUPT
comma
)brace
suffix:semicolon
DECL|function|g2_enable_dma
r_static
r_int
id|g2_enable_dma
c_func
(paren
r_struct
id|dma_info
op_star
id|info
)paren
(brace
r_int
r_int
id|chan
op_assign
id|info-&gt;chan
suffix:semicolon
id|g2_dma-&gt;channel
(braket
id|chan
)braket
dot
id|chan_enable
op_assign
l_int|1
suffix:semicolon
id|g2_dma-&gt;channel
(braket
id|chan
)braket
dot
id|xfer_enable
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|g2_disable_dma
r_static
r_int
id|g2_disable_dma
c_func
(paren
r_struct
id|dma_info
op_star
id|info
)paren
(brace
r_int
r_int
id|chan
op_assign
id|info-&gt;chan
suffix:semicolon
id|g2_dma-&gt;channel
(braket
id|chan
)braket
dot
id|chan_enable
op_assign
l_int|0
suffix:semicolon
id|g2_dma-&gt;channel
(braket
id|chan
)braket
dot
id|xfer_enable
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|g2_xfer_dma
r_static
r_int
id|g2_xfer_dma
c_func
(paren
r_struct
id|dma_info
op_star
id|info
)paren
(brace
r_int
r_int
id|chan
op_assign
id|info-&gt;chan
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;sar
op_amp
l_int|31
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;g2dma: unaligned source 0x%lx&bslash;n&quot;
comma
id|info-&gt;sar
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;dar
op_amp
l_int|31
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;g2dma: unaligned dest 0x%lx&bslash;n&quot;
comma
id|info-&gt;dar
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Align the count */
r_if
c_cond
(paren
id|info-&gt;count
op_amp
l_int|31
)paren
id|info-&gt;count
op_assign
(paren
id|info-&gt;count
op_plus
(paren
l_int|32
op_minus
l_int|1
)paren
)paren
op_amp
op_complement
(paren
l_int|32
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Fixup destination */
id|info-&gt;dar
op_add_assign
l_int|0xa0800000
suffix:semicolon
multiline_comment|/* Fixup direction */
id|info-&gt;mode
op_assign
op_logical_neg
id|info-&gt;mode
suffix:semicolon
id|flush_icache_range
c_func
(paren
(paren
r_int
r_int
)paren
id|info-&gt;sar
comma
id|info-&gt;count
)paren
suffix:semicolon
id|g2_disable_dma
c_func
(paren
id|info
)paren
suffix:semicolon
id|g2_dma-&gt;channel
(braket
id|chan
)braket
dot
id|g2_addr
op_assign
id|info-&gt;dar
op_amp
l_int|0x1fffffe0
suffix:semicolon
id|g2_dma-&gt;channel
(braket
id|chan
)braket
dot
id|root_addr
op_assign
id|info-&gt;sar
op_amp
l_int|0x1fffffe0
suffix:semicolon
id|g2_dma-&gt;channel
(braket
id|chan
)braket
dot
id|size
op_assign
(paren
id|info-&gt;count
op_amp
op_complement
l_int|31
)paren
op_or
l_int|0x80000000
suffix:semicolon
id|g2_dma-&gt;channel
(braket
id|chan
)braket
dot
id|direction
op_assign
id|info-&gt;mode
suffix:semicolon
multiline_comment|/*&n;&t; * bit 0 - ???&n;&t; * bit 1 - if set, generate a hardware event on transfer completion&n;&t; * bit 2 - ??? something to do with suspend?&n;&t; */
id|g2_dma-&gt;channel
(braket
id|chan
)braket
dot
id|ctrl
op_assign
l_int|5
suffix:semicolon
multiline_comment|/* ?? */
id|g2_enable_dma
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/* debug cruft */
id|pr_debug
c_func
(paren
l_string|&quot;count, sar, dar, mode, ctrl, chan, xfer: %ld, 0x%08lx, &quot;
l_string|&quot;0x%08lx, %ld, %ld, %ld, %ld&bslash;n&quot;
comma
id|g2_dma-&gt;channel
(braket
id|chan
)braket
dot
id|size
comma
id|g2_dma-&gt;channel
(braket
id|chan
)braket
dot
id|root_addr
comma
id|g2_dma-&gt;channel
(braket
id|chan
)braket
dot
id|g2_addr
comma
id|g2_dma-&gt;channel
(braket
id|chan
)braket
dot
id|direction
comma
id|g2_dma-&gt;channel
(braket
id|chan
)braket
dot
id|ctrl
comma
id|g2_dma-&gt;channel
(braket
id|chan
)braket
dot
id|chan_enable
comma
id|g2_dma-&gt;channel
(braket
id|chan
)braket
dot
id|xfer_enable
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|g2_dma_ops
r_static
r_struct
id|dma_ops
id|g2_dma_ops
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;G2 DMA&quot;
comma
dot
id|xfer
op_assign
id|g2_xfer_dma
comma
)brace
suffix:semicolon
DECL|function|g2_dma_init
r_static
r_int
id|__init
id|g2_dma_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|base
suffix:semicolon
id|setup_irq
c_func
(paren
id|HW_EVENT_G2_DMA
comma
op_amp
id|g2_dma_irq
)paren
suffix:semicolon
multiline_comment|/* Magic */
id|g2_dma-&gt;wait_state
op_assign
l_int|27
suffix:semicolon
id|g2_dma-&gt;magic
op_assign
l_int|0x4659404f
suffix:semicolon
multiline_comment|/* G2 channels come after on-chip and pvr2 */
id|base
op_assign
id|ONCHIP_NR_DMA_CHANNELS
op_plus
id|PVR2_NR_DMA_CHANNELS
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|G2_NR_DMA_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
id|dma_info
(braket
id|base
op_plus
id|i
)braket
dot
id|ops
op_assign
op_amp
id|g2_dma_ops
suffix:semicolon
r_return
id|register_dmac
c_func
(paren
op_amp
id|g2_dma_ops
)paren
suffix:semicolon
)brace
DECL|function|g2_dma_exit
r_static
r_void
id|__exit
id|g2_dma_exit
c_func
(paren
r_void
)paren
(brace
id|free_irq
c_func
(paren
id|HW_EVENT_G2_DMA
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|variable|g2_dma_init
id|subsys_initcall
c_func
(paren
id|g2_dma_init
)paren
suffix:semicolon
DECL|variable|g2_dma_exit
id|module_exit
c_func
(paren
id|g2_dma_exit
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Paul Mundt &lt;lethal@linux-sh.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;G2 bus DMA driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
