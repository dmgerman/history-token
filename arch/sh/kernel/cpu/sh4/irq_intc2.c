multiline_comment|/*&n; * linux/arch/sh/kernel/irq_intc2.c&n; *&n; * Copyright (C) 2001 David J. Mckay (david.mckay@st.com)&n; *&n; * May be copied or modified under the terms of the GNU General Public&n; * License.  See linux/COPYING for more information.                            &n; *&n; * Interrupt handling for INTC2-based IRQ.&n; *&n; * These are the &quot;new Hitachi style&quot; interrupts, as present on the &n; * Hitachi 7751 and the STM ST40 STB1.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/machvec.h&gt;
DECL|struct|intc2_data
r_struct
id|intc2_data
(brace
DECL|member|msk_offset
r_int
r_char
id|msk_offset
suffix:semicolon
DECL|member|msk_shift
r_int
r_char
id|msk_shift
suffix:semicolon
macro_line|#ifdef CONFIG_CPU_SUBTYPE_ST40
DECL|member|clear_irq
r_int
(paren
op_star
id|clear_irq
)paren
(paren
r_int
)paren
suffix:semicolon
macro_line|#endif
)brace
suffix:semicolon
DECL|variable|intc2_data
r_static
r_struct
id|intc2_data
id|intc2_data
(braket
id|NR_INTC2_IRQS
)braket
suffix:semicolon
r_static
r_void
id|enable_intc2_irq
c_func
(paren
r_int
r_int
id|irq
)paren
suffix:semicolon
r_static
r_void
id|disable_intc2_irq
c_func
(paren
r_int
r_int
id|irq
)paren
suffix:semicolon
multiline_comment|/* shutdown is same as &quot;disable&quot; */
DECL|macro|shutdown_intc2_irq
mdefine_line|#define shutdown_intc2_irq disable_intc2_irq
r_static
r_void
id|mask_and_ack_intc2
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|end_intc2_irq
c_func
(paren
r_int
r_int
id|irq
)paren
suffix:semicolon
DECL|function|startup_intc2_irq
r_static
r_int
r_int
id|startup_intc2_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|enable_intc2_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* never anything pending */
)brace
DECL|variable|intc2_irq_type
r_static
r_struct
id|hw_interrupt_type
id|intc2_irq_type
op_assign
(brace
l_string|&quot;INTC2-IRQ&quot;
comma
id|startup_intc2_irq
comma
id|shutdown_intc2_irq
comma
id|enable_intc2_irq
comma
id|disable_intc2_irq
comma
id|mask_and_ack_intc2
comma
id|end_intc2_irq
)brace
suffix:semicolon
DECL|function|disable_intc2_irq
r_static
r_void
id|disable_intc2_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
id|irq_offset
op_assign
id|irq
op_minus
id|INTC2_FIRST_IRQ
suffix:semicolon
r_int
id|msk_shift
comma
id|msk_offset
suffix:semicolon
singleline_comment|// Sanity check
r_if
c_cond
(paren
(paren
id|irq_offset
OL
l_int|0
)paren
op_logical_or
(paren
id|irq_offset
op_ge
id|NR_INTC2_IRQS
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|msk_shift
op_assign
id|intc2_data
(braket
id|irq_offset
)braket
dot
id|msk_shift
suffix:semicolon
id|msk_offset
op_assign
id|intc2_data
(braket
id|irq_offset
)braket
dot
id|msk_offset
suffix:semicolon
id|ctrl_outl
c_func
(paren
l_int|1
op_lshift
id|msk_shift
comma
id|INTC2_BASE
op_plus
id|INTC2_INTMSK_OFFSET
op_plus
id|msk_offset
)paren
suffix:semicolon
)brace
DECL|function|enable_intc2_irq
r_static
r_void
id|enable_intc2_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
id|irq_offset
op_assign
id|irq
op_minus
id|INTC2_FIRST_IRQ
suffix:semicolon
r_int
id|msk_shift
comma
id|msk_offset
suffix:semicolon
multiline_comment|/* Sanity check */
r_if
c_cond
(paren
(paren
id|irq_offset
OL
l_int|0
)paren
op_logical_or
(paren
id|irq_offset
op_ge
id|NR_INTC2_IRQS
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|msk_shift
op_assign
id|intc2_data
(braket
id|irq_offset
)braket
dot
id|msk_shift
suffix:semicolon
id|msk_offset
op_assign
id|intc2_data
(braket
id|irq_offset
)braket
dot
id|msk_offset
suffix:semicolon
id|ctrl_outl
c_func
(paren
l_int|1
op_lshift
id|msk_shift
comma
id|INTC2_BASE
op_plus
id|INTC2_INTMSKCLR_OFFSET
op_plus
id|msk_offset
)paren
suffix:semicolon
)brace
DECL|function|mask_and_ack_intc2
r_static
r_void
id|mask_and_ack_intc2
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|disable_intc2_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|end_intc2_irq
r_static
r_void
id|end_intc2_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|irq_desc
(braket
id|irq
)braket
dot
id|status
op_amp
(paren
id|IRQ_DISABLED
op_or
id|IRQ_INPROGRESS
)paren
)paren
)paren
id|enable_intc2_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_CPU_SUBTYPE_ST40
r_if
c_cond
(paren
id|intc2_data
(braket
id|irq
op_minus
id|INTC2_FIRST_IRQ
)braket
dot
id|clear_irq
)paren
id|intc2_data
(braket
id|irq
op_minus
id|INTC2_FIRST_IRQ
)braket
dot
id|clear_irq
(paren
id|irq
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * Setup an INTC2 style interrupt.&n; * NOTE: Unlike IPR interrupts, parameters are not shifted by this code,&n; * allowing the use of the numbers straight out of the datasheet.&n; * For example:&n; *    PIO1 which is INTPRI00[19,16] and INTMSK00[13]&n; * would be:               ^     ^             ^  ^&n; *                         |     |             |  |&n; *    make_intc2_irq(84,   0,   16,            0, 13);&n; */
DECL|function|make_intc2_irq
r_void
id|make_intc2_irq
c_func
(paren
r_int
r_int
id|irq
comma
r_int
r_int
id|ipr_offset
comma
r_int
r_int
id|ipr_shift
comma
r_int
r_int
id|msk_offset
comma
r_int
r_int
id|msk_shift
comma
r_int
r_int
id|priority
)paren
(brace
r_int
id|irq_offset
op_assign
id|irq
op_minus
id|INTC2_FIRST_IRQ
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|ipr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|irq_offset
OL
l_int|0
)paren
op_logical_or
(paren
id|irq_offset
op_ge
id|NR_INTC2_IRQS
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|disable_irq_nosync
c_func
(paren
id|irq
)paren
suffix:semicolon
multiline_comment|/* Fill the data we need */
id|intc2_data
(braket
id|irq_offset
)braket
dot
id|msk_offset
op_assign
id|msk_offset
suffix:semicolon
id|intc2_data
(braket
id|irq_offset
)braket
dot
id|msk_shift
op_assign
id|msk_shift
suffix:semicolon
macro_line|#ifdef CONFIG_CPU_SUBTYPE_ST40
id|intc2_data
(braket
id|irq_offset
)braket
dot
id|clear_irq
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
multiline_comment|/* Set the priority level */
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ipr
op_assign
id|ctrl_inl
c_func
(paren
id|INTC2_BASE
op_plus
id|INTC2_INTPRI_OFFSET
op_plus
id|ipr_offset
)paren
suffix:semicolon
id|ipr
op_and_assign
op_complement
(paren
l_int|0xf
op_lshift
id|ipr_shift
)paren
suffix:semicolon
id|ipr
op_or_assign
(paren
id|priority
)paren
op_lshift
id|ipr_shift
suffix:semicolon
id|ctrl_outl
c_func
(paren
id|ipr
comma
id|INTC2_BASE
op_plus
id|INTC2_INTPRI_OFFSET
op_plus
id|ipr_offset
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
id|irq_desc
(braket
id|irq
)braket
dot
id|handler
op_assign
op_amp
id|intc2_irq_type
suffix:semicolon
id|disable_intc2_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_CPU_SUBTYPE_ST40
DECL|struct|intc2_init
r_struct
id|intc2_init
(brace
DECL|member|irq
r_int
r_int
id|irq
suffix:semicolon
DECL|member|ipr_offset
DECL|member|ipr_shift
r_int
r_char
id|ipr_offset
comma
id|ipr_shift
suffix:semicolon
DECL|member|msk_offset
DECL|member|msk_shift
r_int
r_char
id|msk_offset
comma
id|msk_shift
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|intc2_init
id|intc2_init_data
(braket
)braket
id|__initdata
op_assign
(brace
(brace
l_int|64
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* PCI serr */
(brace
l_int|65
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
l_int|1
)brace
comma
multiline_comment|/* PCI err */
(brace
l_int|66
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
l_int|2
)brace
comma
multiline_comment|/* PCI ad */
(brace
l_int|67
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
l_int|3
)brace
comma
multiline_comment|/* PCI pwd down */
(brace
l_int|72
comma
l_int|0
comma
l_int|8
comma
l_int|0
comma
l_int|5
)brace
comma
multiline_comment|/* DMAC INT0 */
(brace
l_int|73
comma
l_int|0
comma
l_int|8
comma
l_int|0
comma
l_int|6
)brace
comma
multiline_comment|/* DMAC INT1 */
(brace
l_int|74
comma
l_int|0
comma
l_int|8
comma
l_int|0
comma
l_int|7
)brace
comma
multiline_comment|/* DMAC INT2 */
(brace
l_int|75
comma
l_int|0
comma
l_int|8
comma
l_int|0
comma
l_int|8
)brace
comma
multiline_comment|/* DMAC INT3 */
(brace
l_int|76
comma
l_int|0
comma
l_int|8
comma
l_int|0
comma
l_int|9
)brace
comma
multiline_comment|/* DMAC INT4 */
(brace
l_int|78
comma
l_int|0
comma
l_int|8
comma
l_int|0
comma
l_int|11
)brace
comma
multiline_comment|/* DMAC ERR */
(brace
l_int|80
comma
l_int|0
comma
l_int|12
comma
l_int|0
comma
l_int|12
)brace
comma
multiline_comment|/* PIO0 */
(brace
l_int|84
comma
l_int|0
comma
l_int|16
comma
l_int|0
comma
l_int|13
)brace
comma
multiline_comment|/* PIO1 */
(brace
l_int|88
comma
l_int|0
comma
l_int|20
comma
l_int|0
comma
l_int|14
)brace
comma
multiline_comment|/* PIO2 */
(brace
l_int|112
comma
l_int|4
comma
l_int|0
comma
l_int|4
comma
l_int|0
)brace
comma
multiline_comment|/* Mailbox */
macro_line|#ifdef CONFIG_CPU_SUBTYPE_ST40GX1
(brace
l_int|116
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
)brace
comma
multiline_comment|/* SSC0 */
(brace
l_int|120
comma
l_int|4
comma
l_int|8
comma
l_int|4
comma
l_int|8
)brace
comma
multiline_comment|/* IR Blaster */
(brace
l_int|124
comma
l_int|4
comma
l_int|12
comma
l_int|4
comma
l_int|12
)brace
comma
multiline_comment|/* USB host */
(brace
l_int|128
comma
l_int|4
comma
l_int|16
comma
l_int|4
comma
l_int|16
)brace
comma
multiline_comment|/* Video processor BLITTER */
(brace
l_int|132
comma
l_int|4
comma
l_int|20
comma
l_int|4
comma
l_int|20
)brace
comma
multiline_comment|/* UART0 */
(brace
l_int|134
comma
l_int|4
comma
l_int|20
comma
l_int|4
comma
l_int|22
)brace
comma
multiline_comment|/* UART2 */
(brace
l_int|136
comma
l_int|4
comma
l_int|24
comma
l_int|4
comma
l_int|24
)brace
comma
multiline_comment|/* IO_PIO0 */
(brace
l_int|140
comma
l_int|4
comma
l_int|28
comma
l_int|4
comma
l_int|28
)brace
comma
multiline_comment|/* EMPI */
(brace
l_int|144
comma
l_int|8
comma
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
multiline_comment|/* MAFE */
(brace
l_int|148
comma
l_int|8
comma
l_int|4
comma
l_int|8
comma
l_int|4
)brace
comma
multiline_comment|/* PWM */
(brace
l_int|152
comma
l_int|8
comma
l_int|8
comma
l_int|8
comma
l_int|8
)brace
comma
multiline_comment|/* SSC1 */
(brace
l_int|156
comma
l_int|8
comma
l_int|12
comma
l_int|8
comma
l_int|12
)brace
comma
multiline_comment|/* IO_PIO1 */
(brace
l_int|160
comma
l_int|8
comma
l_int|16
comma
l_int|8
comma
l_int|16
)brace
comma
multiline_comment|/* USB target */
(brace
l_int|164
comma
l_int|8
comma
l_int|20
comma
l_int|8
comma
l_int|20
)brace
comma
multiline_comment|/* UART1 */
(brace
l_int|168
comma
l_int|8
comma
l_int|24
comma
l_int|8
comma
l_int|24
)brace
comma
multiline_comment|/* Teletext */
(brace
l_int|172
comma
l_int|8
comma
l_int|28
comma
l_int|8
comma
l_int|28
)brace
comma
multiline_comment|/* VideoSync VTG */
(brace
l_int|173
comma
l_int|8
comma
l_int|28
comma
l_int|8
comma
l_int|29
)brace
comma
multiline_comment|/* VideoSync DVP0 */
(brace
l_int|174
comma
l_int|8
comma
l_int|28
comma
l_int|8
comma
l_int|30
)brace
comma
multiline_comment|/* VideoSync DVP1 */
macro_line|#endif
)brace
suffix:semicolon
DECL|function|init_IRQ_intc2
r_void
id|__init
id|init_IRQ_intc2
c_func
(paren
r_void
)paren
(brace
r_struct
id|intc2_init
op_star
id|p
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;init_IRQ_intc2&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|intc2_init_data
suffix:semicolon
id|p
OL
id|intc2_init_data
op_plus
id|ARRAY_SIZE
c_func
(paren
id|intc2_init_data
)paren
suffix:semicolon
id|p
op_increment
)paren
(brace
id|make_intc2_irq
c_func
(paren
id|p-&gt;irq
comma
id|p-&gt;ipr_offset
comma
id|p-&gt;ipr_shift
comma
id|p
op_member_access_from_pointer
id|msk_offset
comma
id|p-&gt;msk_shift
comma
l_int|13
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Adds a termination callback to the interrupt */
DECL|function|intc2_add_clear_irq
r_void
id|intc2_add_clear_irq
c_func
(paren
r_int
id|irq
comma
r_int
(paren
op_star
id|fn
)paren
(paren
r_int
)paren
)paren
(brace
r_if
c_cond
(paren
id|irq
OL
id|INTC2_FIRST_IRQ
)paren
r_return
suffix:semicolon
id|intc2_data
(braket
id|irq
op_minus
id|INTC2_FIRST_IRQ
)braket
dot
id|clear_irq
op_assign
id|fn
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_CPU_SUBTYPE_ST40 */
eof
