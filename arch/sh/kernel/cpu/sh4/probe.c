multiline_comment|/*&n; * arch/sh/kernel/cpu/sh4/probe.c&n; *&n; * CPU Subtype Probing for SH-4.&n; *&n; * Copyright (C) 2001, 2002, 2003, 2004  Paul Mundt&n; * Copyright (C) 2003  Richard Curnow&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/cache.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|function|detect_cpu_and_cache_system
r_int
id|__init
id|detect_cpu_and_cache_system
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|pvr
comma
id|prr
comma
id|cvr
suffix:semicolon
r_int
r_int
id|size
suffix:semicolon
r_static
r_int
r_int
id|sizes
(braket
l_int|16
)braket
op_assign
(brace
(braket
l_int|1
)braket
op_assign
(paren
l_int|1
op_lshift
l_int|12
)paren
comma
(braket
l_int|2
)braket
op_assign
(paren
l_int|1
op_lshift
l_int|13
)paren
comma
(braket
l_int|4
)braket
op_assign
(paren
l_int|1
op_lshift
l_int|14
)paren
comma
(braket
l_int|8
)braket
op_assign
(paren
l_int|1
op_lshift
l_int|15
)paren
comma
(braket
l_int|9
)braket
op_assign
(paren
l_int|1
op_lshift
l_int|16
)paren
)brace
suffix:semicolon
id|pvr
op_assign
(paren
id|ctrl_inl
c_func
(paren
id|CCN_PVR
)paren
op_rshift
l_int|8
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|prr
op_assign
(paren
id|ctrl_inl
c_func
(paren
id|CCN_PRR
)paren
op_rshift
l_int|4
)paren
op_amp
l_int|0xff
suffix:semicolon
id|cvr
op_assign
(paren
id|ctrl_inl
c_func
(paren
id|CCN_CVR
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Setup some sane SH-4 defaults for the icache&n;&t; */
id|cpu_data-&gt;icache.way_incr
op_assign
(paren
l_int|1
op_lshift
l_int|13
)paren
suffix:semicolon
id|cpu_data-&gt;icache.entry_shift
op_assign
l_int|5
suffix:semicolon
id|cpu_data-&gt;icache.entry_mask
op_assign
l_int|0x1fe0
suffix:semicolon
id|cpu_data-&gt;icache.sets
op_assign
l_int|256
suffix:semicolon
id|cpu_data-&gt;icache.ways
op_assign
l_int|1
suffix:semicolon
id|cpu_data-&gt;icache.linesz
op_assign
id|L1_CACHE_BYTES
suffix:semicolon
multiline_comment|/*&n;&t; * And again for the dcache ..&n;&t; */
id|cpu_data-&gt;dcache.way_incr
op_assign
(paren
l_int|1
op_lshift
l_int|14
)paren
suffix:semicolon
id|cpu_data-&gt;dcache.entry_shift
op_assign
l_int|5
suffix:semicolon
id|cpu_data-&gt;dcache.entry_mask
op_assign
l_int|0x3fe0
suffix:semicolon
id|cpu_data-&gt;dcache.sets
op_assign
l_int|512
suffix:semicolon
id|cpu_data-&gt;dcache.ways
op_assign
l_int|1
suffix:semicolon
id|cpu_data-&gt;dcache.linesz
op_assign
id|L1_CACHE_BYTES
suffix:semicolon
multiline_comment|/* Set the FPU flag, virtually all SH-4&squot;s have one */
id|cpu_data-&gt;flags
op_or_assign
id|CPU_HAS_FPU
suffix:semicolon
multiline_comment|/*&n;&t; * Probe the underlying processor version/revision and&n;&t; * adjust cpu_data setup accordingly.&n;&t; */
r_switch
c_cond
(paren
id|pvr
)paren
(brace
r_case
l_int|0x205
suffix:colon
id|cpu_data-&gt;type
op_assign
id|CPU_SH7750
suffix:semicolon
id|cpu_data-&gt;flags
op_or_assign
id|CPU_HAS_P2_FLUSH_BUG
op_or
id|CPU_HAS_PERF_COUNTER
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x206
suffix:colon
id|cpu_data-&gt;type
op_assign
id|CPU_SH7750S
suffix:semicolon
id|cpu_data-&gt;flags
op_or_assign
id|CPU_HAS_P2_FLUSH_BUG
op_or
id|CPU_HAS_PERF_COUNTER
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x1100
suffix:colon
id|cpu_data-&gt;type
op_assign
id|CPU_SH7751
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x2000
suffix:colon
id|cpu_data-&gt;type
op_assign
id|CPU_SH73180
suffix:semicolon
id|cpu_data-&gt;icache.ways
op_assign
l_int|4
suffix:semicolon
id|cpu_data-&gt;dcache.ways
op_assign
l_int|4
suffix:semicolon
id|cpu_data-&gt;flags
op_and_assign
op_complement
id|CPU_HAS_FPU
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x8000
suffix:colon
id|cpu_data-&gt;type
op_assign
id|CPU_ST40RA
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x8100
suffix:colon
id|cpu_data-&gt;type
op_assign
id|CPU_ST40GX1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x700
suffix:colon
id|cpu_data-&gt;type
op_assign
id|CPU_SH4_501
suffix:semicolon
id|cpu_data-&gt;icache.ways
op_assign
l_int|2
suffix:semicolon
id|cpu_data-&gt;dcache.ways
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* No FPU on the SH4-500 series.. */
id|cpu_data-&gt;flags
op_and_assign
op_complement
id|CPU_HAS_FPU
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x600
suffix:colon
id|cpu_data-&gt;type
op_assign
id|CPU_SH4_202
suffix:semicolon
id|cpu_data-&gt;icache.ways
op_assign
l_int|2
suffix:semicolon
id|cpu_data-&gt;dcache.ways
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x500
dot
dot
dot
l_int|0x501
suffix:colon
r_switch
c_cond
(paren
id|prr
)paren
(brace
r_case
l_int|0x10
suffix:colon
id|cpu_data-&gt;type
op_assign
id|CPU_SH7750R
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x11
suffix:colon
id|cpu_data-&gt;type
op_assign
id|CPU_SH7751R
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x50
suffix:colon
id|cpu_data-&gt;type
op_assign
id|CPU_SH7760
suffix:semicolon
r_break
suffix:semicolon
)brace
id|cpu_data-&gt;icache.ways
op_assign
l_int|2
suffix:semicolon
id|cpu_data-&gt;dcache.ways
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|cpu_data-&gt;type
op_assign
id|CPU_SH_NONE
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * On anything that&squot;s not a direct-mapped cache, look to the CVR&n;&t; * for I/D-cache specifics.&n;&t; */
r_if
c_cond
(paren
id|cpu_data-&gt;icache.ways
OG
l_int|1
)paren
(brace
id|size
op_assign
id|sizes
(braket
(paren
id|cvr
op_rshift
l_int|20
)paren
op_amp
l_int|0xf
)braket
suffix:semicolon
id|cpu_data-&gt;icache.way_incr
op_assign
(paren
id|size
op_rshift
l_int|1
)paren
suffix:semicolon
id|cpu_data-&gt;icache.sets
op_assign
(paren
id|size
op_rshift
l_int|6
)paren
suffix:semicolon
id|cpu_data-&gt;icache.entry_mask
op_assign
(paren
id|cpu_data-&gt;icache.way_incr
op_minus
(paren
l_int|1
op_lshift
l_int|5
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cpu_data-&gt;dcache.ways
OG
l_int|1
)paren
(brace
id|size
op_assign
id|sizes
(braket
(paren
id|cvr
op_rshift
l_int|16
)paren
op_amp
l_int|0xf
)braket
suffix:semicolon
id|cpu_data-&gt;dcache.way_incr
op_assign
(paren
id|size
op_rshift
l_int|1
)paren
suffix:semicolon
id|cpu_data-&gt;dcache.sets
op_assign
(paren
id|size
op_rshift
l_int|6
)paren
suffix:semicolon
id|cpu_data-&gt;dcache.entry_mask
op_assign
(paren
id|cpu_data-&gt;dcache.way_incr
op_minus
(paren
l_int|1
op_lshift
l_int|5
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
