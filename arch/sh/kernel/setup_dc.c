multiline_comment|/*&n; *&t;$Id: setup_dc.c,v 1.1 2001/04/01 15:02:00 yaegashi Exp $&n; *&t;SEGA Dreamcast support&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/param.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
DECL|macro|GAPSPCI_REGS
mdefine_line|#define&t;GAPSPCI_REGS&t;&t;0x01001400
DECL|macro|GAPSPCI_DMA_BASE
mdefine_line|#define GAPSPCI_DMA_BASE&t;0x01840000
DECL|macro|GAPSPCI_DMA_SIZE
mdefine_line|#define GAPSPCI_DMA_SIZE&t;32768
DECL|macro|GAPSPCI_BBA_CONFIG
mdefine_line|#define GAPSPCI_BBA_CONFIG&t;0x01001600
DECL|macro|GAPSPCI_IRQ
mdefine_line|#define&t;GAPSPCI_IRQ&t;&t;11
DECL|macro|GAPSPCI_INTC
mdefine_line|#define&t;GAPSPCI_INTC&t;&t;0x005f6924
DECL|variable|gapspci_dma_used
r_static
r_int
id|gapspci_dma_used
suffix:semicolon
DECL|variable|pci_root_bus
r_static
r_struct
id|pci_bus
op_star
id|pci_root_bus
suffix:semicolon
DECL|function|disable_gapspci_irq
r_static
r_void
id|disable_gapspci_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|intc
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|intc
op_assign
id|inl
c_func
(paren
id|GAPSPCI_INTC
)paren
suffix:semicolon
id|intc
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|3
)paren
suffix:semicolon
id|outl
c_func
(paren
id|intc
comma
id|GAPSPCI_INTC
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|enable_gapspci_irq
r_static
r_void
id|enable_gapspci_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|intc
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|intc
op_assign
id|inl
c_func
(paren
id|GAPSPCI_INTC
)paren
suffix:semicolon
id|intc
op_or_assign
(paren
l_int|1
op_lshift
l_int|3
)paren
suffix:semicolon
id|outl
c_func
(paren
id|intc
comma
id|GAPSPCI_INTC
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|mask_and_ack_gapspci_irq
r_static
r_void
id|mask_and_ack_gapspci_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|intc
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|intc
op_assign
id|inl
c_func
(paren
id|GAPSPCI_INTC
)paren
suffix:semicolon
id|intc
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|3
)paren
suffix:semicolon
id|outl
c_func
(paren
id|intc
comma
id|GAPSPCI_INTC
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|end_gapspci_irq
r_static
r_void
id|end_gapspci_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|enable_gapspci_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|startup_gapspci_irq
r_static
r_int
r_int
id|startup_gapspci_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|enable_gapspci_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|shutdown_gapspci_irq
r_static
r_void
id|shutdown_gapspci_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|disable_gapspci_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|variable|gapspci_irq_type
r_static
r_struct
id|hw_interrupt_type
id|gapspci_irq_type
op_assign
(brace
l_string|&quot;GAPSPCI-IRQ&quot;
comma
id|startup_gapspci_irq
comma
id|shutdown_gapspci_irq
comma
id|enable_gapspci_irq
comma
id|disable_gapspci_irq
comma
id|mask_and_ack_gapspci_irq
comma
id|end_gapspci_irq
)brace
suffix:semicolon
DECL|function|no_swizzle
r_static
id|u8
id|__init
id|no_swizzle
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
id|u8
op_star
id|pin
)paren
(brace
r_return
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
suffix:semicolon
)brace
DECL|function|map_od_irq
r_static
r_int
id|__init
id|map_od_irq
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
id|u8
id|slot
comma
id|u8
id|pin
)paren
(brace
r_return
id|GAPSPCI_IRQ
suffix:semicolon
)brace
DECL|function|setup_dreamcast
r_int
id|__init
id|setup_dreamcast
c_func
(paren
r_void
)paren
(brace
id|gapspci_init
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;SEGA Dreamcast support.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;BCR1: 0x%08x&bslash;n&quot;
comma
id|ctrl_inl
c_func
(paren
l_int|0xff800000
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;BCR2: 0x%08x&bslash;n&quot;
comma
id|ctrl_inw
c_func
(paren
l_int|0xff800004
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;WCR1: 0x%08x&bslash;n&quot;
comma
id|ctrl_inl
c_func
(paren
l_int|0xff800008
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;WCR2: 0x%08x&bslash;n&quot;
comma
id|ctrl_inl
c_func
(paren
l_int|0xff80000c
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;WCR3: 0x%08x&bslash;n&quot;
comma
id|ctrl_inl
c_func
(paren
l_int|0xff800010
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;MCR: 0x%08x&bslash;n&quot;
comma
id|ctrl_inl
c_func
(paren
l_int|0xff800014
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PCR: 0x%08x&bslash;n&quot;
comma
id|ctrl_inw
c_func
(paren
l_int|0xff800018
)paren
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;BCR1: 0xa3020008&n; *&t;BCR2: 0x0001&n; *&t;WCR1: 0x01110111&n; *&t;WCR2: 0x618066d8&n; *&t;WCR3: 0x07777777&n; *&t;MCR: 0xc00a0e24&n; *&t;PCR: 0x0000&n; */
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Dreamcast PCI: Supports SEGA Broadband Adaptor only.&n; */
DECL|macro|BBA_SELECTED
mdefine_line|#define BBA_SELECTED(dev) (dev-&gt;bus-&gt;number==0 &amp;&amp; dev-&gt;devfn==0)
DECL|function|gapspci_read_config_byte
r_static
r_int
id|gapspci_read_config_byte
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u8
op_star
id|val
)paren
(brace
r_if
c_cond
(paren
id|BBA_SELECTED
c_func
(paren
id|dev
)paren
)paren
op_star
id|val
op_assign
id|inb
c_func
(paren
id|GAPSPCI_BBA_CONFIG
op_plus
id|where
)paren
suffix:semicolon
r_else
op_star
id|val
op_assign
l_int|0xff
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|gapspci_read_config_word
r_static
r_int
id|gapspci_read_config_word
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u16
op_star
id|val
)paren
(brace
r_if
c_cond
(paren
id|BBA_SELECTED
c_func
(paren
id|dev
)paren
)paren
op_star
id|val
op_assign
id|inw
c_func
(paren
id|GAPSPCI_BBA_CONFIG
op_plus
id|where
)paren
suffix:semicolon
r_else
op_star
id|val
op_assign
l_int|0xffff
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|gapspci_read_config_dword
r_static
r_int
id|gapspci_read_config_dword
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u32
op_star
id|val
)paren
(brace
r_if
c_cond
(paren
id|BBA_SELECTED
c_func
(paren
id|dev
)paren
)paren
op_star
id|val
op_assign
id|inl
c_func
(paren
id|GAPSPCI_BBA_CONFIG
op_plus
id|where
)paren
suffix:semicolon
r_else
op_star
id|val
op_assign
l_int|0xffffffff
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|gapspci_write_config_byte
r_static
r_int
id|gapspci_write_config_byte
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u8
id|val
)paren
(brace
r_if
c_cond
(paren
id|BBA_SELECTED
c_func
(paren
id|dev
)paren
)paren
id|outb
c_func
(paren
id|val
comma
id|GAPSPCI_BBA_CONFIG
op_plus
id|where
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|gapspci_write_config_word
r_static
r_int
id|gapspci_write_config_word
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u16
id|val
)paren
(brace
r_if
c_cond
(paren
id|BBA_SELECTED
c_func
(paren
id|dev
)paren
)paren
id|outw
c_func
(paren
id|val
comma
id|GAPSPCI_BBA_CONFIG
op_plus
id|where
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|gapspci_write_config_dword
r_static
r_int
id|gapspci_write_config_dword
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|where
comma
id|u32
id|val
)paren
(brace
r_if
c_cond
(paren
id|BBA_SELECTED
c_func
(paren
id|dev
)paren
)paren
id|outl
c_func
(paren
id|val
comma
id|GAPSPCI_BBA_CONFIG
op_plus
id|where
)paren
suffix:semicolon
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|variable|pci_config_ops
r_static
r_struct
id|pci_ops
id|pci_config_ops
op_assign
(brace
id|gapspci_read_config_byte
comma
id|gapspci_read_config_word
comma
id|gapspci_read_config_dword
comma
id|gapspci_write_config_byte
comma
id|gapspci_write_config_word
comma
id|gapspci_write_config_dword
)brace
suffix:semicolon
DECL|function|pcibios_align_resource
r_void
id|pcibios_align_resource
c_func
(paren
r_void
op_star
id|data
comma
r_struct
id|resource
op_star
id|res
comma
r_int
r_int
id|size
)paren
(brace
)brace
DECL|function|pcibios_update_irq
r_void
id|__init
id|pcibios_update_irq
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|irq
)paren
(brace
)brace
DECL|function|pcibios_update_resource
r_void
id|__init
id|pcibios_update_resource
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_struct
id|resource
op_star
id|root
comma
r_struct
id|resource
op_star
id|res
comma
r_int
id|resource
)paren
(brace
)brace
DECL|function|pcibios_enable_device
r_int
id|pcibios_enable_device
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|u16
id|cmd
comma
id|old_cmd
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_struct
id|resource
op_star
id|r
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|old_cmd
op_assign
id|cmd
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
l_int|6
suffix:semicolon
id|idx
op_increment
)paren
(brace
id|r
op_assign
id|dev-&gt;resource
op_plus
id|idx
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|r-&gt;start
op_logical_and
id|r-&gt;end
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PCI: Device %s not available because&quot;
l_string|&quot; of resource collisions&bslash;n&quot;
comma
id|dev-&gt;slot_name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|r-&gt;flags
op_amp
id|IORESOURCE_IO
)paren
id|cmd
op_or_assign
id|PCI_COMMAND_IO
suffix:semicolon
r_if
c_cond
(paren
id|r-&gt;flags
op_amp
id|IORESOURCE_MEM
)paren
id|cmd
op_or_assign
id|PCI_COMMAND_MEMORY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_ne
id|old_cmd
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: enabling device %s (%04x -&gt; %04x)&bslash;n&quot;
comma
id|dev-&gt;slot_name
comma
id|old_cmd
comma
id|cmd
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
id|cmd
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pci_alloc_consistent
r_void
op_star
id|pci_alloc_consistent
c_func
(paren
r_struct
id|pci_dev
op_star
id|hwdev
comma
r_int
id|size
comma
id|dma_addr_t
op_star
id|dma_handle
)paren
(brace
r_int
r_int
id|buf
suffix:semicolon
r_if
c_cond
(paren
id|gapspci_dma_used
op_plus
id|size
OG
id|GAPSPCI_DMA_SIZE
)paren
r_return
l_int|NULL
suffix:semicolon
id|buf
op_assign
id|GAPSPCI_DMA_BASE
op_plus
id|gapspci_dma_used
suffix:semicolon
id|gapspci_dma_used
op_assign
id|PAGE_ALIGN
c_func
(paren
id|gapspci_dma_used
op_plus
id|size
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;pci_alloc_consistent: %d bytes at 0x%08x&bslash;n&quot;
comma
id|size
comma
id|buf
)paren
suffix:semicolon
op_star
id|dma_handle
op_assign
(paren
id|dma_addr_t
)paren
id|buf
suffix:semicolon
r_return
(paren
r_void
op_star
)paren
id|P2SEGADDR
c_func
(paren
id|buf
)paren
suffix:semicolon
)brace
DECL|function|pci_free_consistent
r_void
id|pci_free_consistent
c_func
(paren
r_struct
id|pci_dev
op_star
id|hwdev
comma
r_int
id|size
comma
r_void
op_star
id|vaddr
comma
id|dma_addr_t
id|dma_handle
)paren
(brace
)brace
r_void
id|__init
DECL|function|pcibios_fixup_pbus_ranges
id|pcibios_fixup_pbus_ranges
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_struct
id|pbus_set_ranges_data
op_star
id|ranges
)paren
(brace
)brace
DECL|function|pcibios_fixup_bus
r_void
id|__init
id|pcibios_fixup_bus
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
)paren
(brace
r_struct
id|list_head
op_star
id|ln
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
r_for
c_loop
(paren
id|ln
op_assign
id|bus-&gt;devices.next
suffix:semicolon
id|ln
op_ne
op_amp
id|bus-&gt;devices
suffix:semicolon
id|ln
op_assign
id|ln-&gt;next
)paren
(brace
id|dev
op_assign
id|pci_dev_b
c_func
(paren
id|ln
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|BBA_SELECTED
c_func
(paren
id|dev
)paren
)paren
r_continue
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI: MMIO fixup to %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;resource
(braket
l_int|1
)braket
dot
id|start
op_assign
l_int|0x01001700
suffix:semicolon
id|dev-&gt;resource
(braket
l_int|1
)braket
dot
id|end
op_assign
l_int|0x010017ff
suffix:semicolon
)brace
)brace
DECL|function|dreamcast_pcibios_init
r_void
id|__init
id|dreamcast_pcibios_init
c_func
(paren
r_void
)paren
(brace
id|pci_root_bus
op_assign
id|pci_scan_bus
c_func
(paren
l_int|0
comma
op_amp
id|pci_config_ops
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* pci_assign_unassigned_resources(); */
id|pci_fixup_irqs
c_func
(paren
id|no_swizzle
comma
id|map_od_irq
)paren
suffix:semicolon
)brace
DECL|function|gapspci_init
r_static
id|__init
r_int
id|gapspci_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_char
id|idbuf
(braket
l_int|16
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|idbuf
(braket
id|i
)braket
op_assign
id|inb
c_func
(paren
id|GAPSPCI_REGS
op_plus
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|idbuf
comma
l_string|&quot;GAPSPCI_BRIDGE_2&quot;
comma
l_int|16
)paren
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|outl
c_func
(paren
l_int|0x5a14a501
comma
id|GAPSPCI_REGS
op_plus
l_int|0x18
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000000
suffix:semicolon
id|i
op_increment
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inl
c_func
(paren
id|GAPSPCI_REGS
op_plus
l_int|0x18
)paren
op_ne
l_int|1
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|outl
c_func
(paren
l_int|0x01000000
comma
id|GAPSPCI_REGS
op_plus
l_int|0x20
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x01000000
comma
id|GAPSPCI_REGS
op_plus
l_int|0x24
)paren
suffix:semicolon
id|outl
c_func
(paren
id|GAPSPCI_DMA_BASE
comma
id|GAPSPCI_REGS
op_plus
l_int|0x28
)paren
suffix:semicolon
id|outl
c_func
(paren
id|GAPSPCI_DMA_BASE
op_plus
id|GAPSPCI_DMA_SIZE
comma
id|GAPSPCI_REGS
op_plus
l_int|0x2c
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|1
comma
id|GAPSPCI_REGS
op_plus
l_int|0x14
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|1
comma
id|GAPSPCI_REGS
op_plus
l_int|0x34
)paren
suffix:semicolon
id|gapspci_dma_used
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*  */
id|irq_desc
(braket
id|GAPSPCI_IRQ
)braket
dot
id|handler
op_assign
op_amp
id|gapspci_irq_type
suffix:semicolon
multiline_comment|/* Setting Broadband Adapter */
id|outw
c_func
(paren
l_int|0xf900
comma
id|GAPSPCI_BBA_CONFIG
op_plus
l_int|0x06
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x00000000
comma
id|GAPSPCI_BBA_CONFIG
op_plus
l_int|0x30
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|GAPSPCI_BBA_CONFIG
op_plus
l_int|0x3c
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xf0
comma
id|GAPSPCI_BBA_CONFIG
op_plus
l_int|0x0d
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0006
comma
id|GAPSPCI_BBA_CONFIG
op_plus
l_int|0x04
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x00002001
comma
id|GAPSPCI_BBA_CONFIG
op_plus
l_int|0x10
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x01000000
comma
id|GAPSPCI_BBA_CONFIG
op_plus
l_int|0x14
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
