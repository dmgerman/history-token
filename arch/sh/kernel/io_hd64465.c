multiline_comment|/*&n; * $Id: io_hd64465.c,v 1.7 2001/05/09 07:39:36 gniibe Exp $&n; * by Greg Banks &lt;gbanks@pocketpenguins.com&gt;&n; * (c) 2000 PocketPenguins Inc&n; *&n; * Derived from io_hd64461.c, which bore the message:&n; * Copyright (C) 2000 YAEGASHI Takeshi&n; *&n; * Typical I/O routines for HD64465 system.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/hd64465.h&gt;
DECL|macro|HD64465_DEBUG
mdefine_line|#define HD64465_DEBUG 0
macro_line|#if HD64465_DEBUG
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(args...)&t;printk(args)
DECL|macro|DIPRINTK
mdefine_line|#define DIPRINTK(n, args...)&t;if (hd64465_io_debug&gt;(n)) printk(args)
macro_line|#else
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(args...)
DECL|macro|DIPRINTK
mdefine_line|#define DIPRINTK(n, args...)
macro_line|#endif
multiline_comment|/* This is a hack suitable only for debugging IO port problems */
DECL|variable|hd64465_io_debug
r_int
id|hd64465_io_debug
suffix:semicolon
DECL|variable|hd64465_io_debug
id|EXPORT_SYMBOL
c_func
(paren
id|hd64465_io_debug
)paren
suffix:semicolon
multiline_comment|/* Low iomap maps port 0-1K to addresses in 8byte chunks */
DECL|macro|HD64465_IOMAP_LO_THRESH
mdefine_line|#define HD64465_IOMAP_LO_THRESH 0x400
DECL|macro|HD64465_IOMAP_LO_SHIFT
mdefine_line|#define HD64465_IOMAP_LO_SHIFT&t;3
DECL|macro|HD64465_IOMAP_LO_MASK
mdefine_line|#define HD64465_IOMAP_LO_MASK&t;((1&lt;&lt;HD64465_IOMAP_LO_SHIFT)-1)
DECL|macro|HD64465_IOMAP_LO_NMAP
mdefine_line|#define HD64465_IOMAP_LO_NMAP&t;(HD64465_IOMAP_LO_THRESH&gt;&gt;HD64465_IOMAP_LO_SHIFT)
DECL|variable|hd64465_iomap_lo
r_static
r_int
r_int
id|hd64465_iomap_lo
(braket
id|HD64465_IOMAP_LO_NMAP
)braket
suffix:semicolon
DECL|variable|hd64465_iomap_lo_shift
r_static
r_int
r_char
id|hd64465_iomap_lo_shift
(braket
id|HD64465_IOMAP_LO_NMAP
)braket
suffix:semicolon
multiline_comment|/* High iomap maps port 1K-64K to addresses in 1K chunks */
DECL|macro|HD64465_IOMAP_HI_THRESH
mdefine_line|#define HD64465_IOMAP_HI_THRESH 0x10000
DECL|macro|HD64465_IOMAP_HI_SHIFT
mdefine_line|#define HD64465_IOMAP_HI_SHIFT&t;10
DECL|macro|HD64465_IOMAP_HI_MASK
mdefine_line|#define HD64465_IOMAP_HI_MASK&t;((1&lt;&lt;HD64465_IOMAP_HI_SHIFT)-1)
DECL|macro|HD64465_IOMAP_HI_NMAP
mdefine_line|#define HD64465_IOMAP_HI_NMAP&t;(HD64465_IOMAP_HI_THRESH&gt;&gt;HD64465_IOMAP_HI_SHIFT)
DECL|variable|hd64465_iomap_hi
r_static
r_int
r_int
id|hd64465_iomap_hi
(braket
id|HD64465_IOMAP_HI_NMAP
)braket
suffix:semicolon
DECL|variable|hd64465_iomap_hi_shift
r_static
r_int
r_char
id|hd64465_iomap_hi_shift
(braket
id|HD64465_IOMAP_HI_NMAP
)braket
suffix:semicolon
macro_line|#ifndef MAX
DECL|macro|MAX
mdefine_line|#define MAX(a,b)    ((a)&gt;(b)?(a):(b))
macro_line|#endif
DECL|macro|PORT2ADDR
mdefine_line|#define PORT2ADDR(x) (sh_mv.mv_isa_port2addr(x))
DECL|function|hd64465_port_map
r_void
id|hd64465_port_map
c_func
(paren
r_int
r_int
id|baseport
comma
r_int
r_int
id|nports
comma
r_int
r_int
id|addr
comma
r_int
r_char
id|shift
)paren
(brace
r_int
r_int
id|port
comma
id|endport
op_assign
id|baseport
op_plus
id|nports
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;hd64465_port_map(base=0x%04hx, n=0x%04hx, addr=0x%08lx,endport=0x%04x)&bslash;n&quot;
comma
id|baseport
comma
id|nports
comma
id|addr
comma
id|endport
)paren
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
id|baseport
suffix:semicolon
id|port
OL
id|endport
op_logical_and
id|port
OL
id|HD64465_IOMAP_LO_THRESH
suffix:semicolon
id|port
op_add_assign
(paren
l_int|1
op_lshift
id|HD64465_IOMAP_LO_SHIFT
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;    maplo[0x%x] = 0x%08lx&bslash;n&quot;
comma
id|port
comma
id|addr
)paren
suffix:semicolon
id|hd64465_iomap_lo
(braket
id|port
op_rshift
id|HD64465_IOMAP_LO_SHIFT
)braket
op_assign
id|addr
suffix:semicolon
id|hd64465_iomap_lo_shift
(braket
id|port
op_rshift
id|HD64465_IOMAP_LO_SHIFT
)braket
op_assign
id|shift
suffix:semicolon
id|addr
op_add_assign
(paren
l_int|1
op_lshift
(paren
id|HD64465_IOMAP_LO_SHIFT
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|port
op_assign
id|MAX
c_func
(paren
id|baseport
comma
id|HD64465_IOMAP_LO_THRESH
)paren
suffix:semicolon
id|port
OL
id|endport
op_logical_and
id|port
OL
id|HD64465_IOMAP_HI_THRESH
suffix:semicolon
id|port
op_add_assign
(paren
l_int|1
op_lshift
id|HD64465_IOMAP_HI_SHIFT
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;    maphi[0x%x] = 0x%08lx&bslash;n&quot;
comma
id|port
comma
id|addr
)paren
suffix:semicolon
id|hd64465_iomap_hi
(braket
id|port
op_rshift
id|HD64465_IOMAP_HI_SHIFT
)braket
op_assign
id|addr
suffix:semicolon
id|hd64465_iomap_hi_shift
(braket
id|port
op_rshift
id|HD64465_IOMAP_HI_SHIFT
)braket
op_assign
id|shift
suffix:semicolon
id|addr
op_add_assign
(paren
l_int|1
op_lshift
(paren
id|HD64465_IOMAP_HI_SHIFT
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|variable|hd64465_port_map
id|EXPORT_SYMBOL
c_func
(paren
id|hd64465_port_map
)paren
suffix:semicolon
DECL|function|hd64465_port_unmap
r_void
id|hd64465_port_unmap
c_func
(paren
r_int
r_int
id|baseport
comma
r_int
r_int
id|nports
)paren
(brace
r_int
r_int
id|port
comma
id|endport
op_assign
id|baseport
op_plus
id|nports
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;hd64465_port_unmap(base=0x%04hx, n=0x%04hx)&bslash;n&quot;
comma
id|baseport
comma
id|nports
)paren
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
id|baseport
suffix:semicolon
id|port
OL
id|endport
op_logical_and
id|port
OL
id|HD64465_IOMAP_LO_THRESH
suffix:semicolon
id|port
op_add_assign
(paren
l_int|1
op_lshift
id|HD64465_IOMAP_LO_SHIFT
)paren
)paren
(brace
id|hd64465_iomap_lo
(braket
id|port
op_rshift
id|HD64465_IOMAP_LO_SHIFT
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|port
op_assign
id|MAX
c_func
(paren
id|baseport
comma
id|HD64465_IOMAP_LO_THRESH
)paren
suffix:semicolon
id|port
OL
id|endport
op_logical_and
id|port
OL
id|HD64465_IOMAP_HI_THRESH
suffix:semicolon
id|port
op_add_assign
(paren
l_int|1
op_lshift
id|HD64465_IOMAP_HI_SHIFT
)paren
)paren
(brace
id|hd64465_iomap_hi
(braket
id|port
op_rshift
id|HD64465_IOMAP_HI_SHIFT
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|variable|hd64465_port_unmap
id|EXPORT_SYMBOL
c_func
(paren
id|hd64465_port_unmap
)paren
suffix:semicolon
DECL|function|hd64465_isa_port2addr
r_int
r_int
id|hd64465_isa_port2addr
c_func
(paren
r_int
r_int
id|port
)paren
(brace
r_int
r_int
id|addr
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|shift
suffix:semicolon
multiline_comment|/* handle remapping of low IO ports */
r_if
c_cond
(paren
id|port
OL
id|HD64465_IOMAP_LO_THRESH
)paren
(brace
id|addr
op_assign
id|hd64465_iomap_lo
(braket
id|port
op_rshift
id|HD64465_IOMAP_LO_SHIFT
)braket
suffix:semicolon
id|shift
op_assign
id|hd64465_iomap_lo_shift
(braket
id|port
op_rshift
id|HD64465_IOMAP_LO_SHIFT
)braket
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_ne
l_int|0
)paren
id|addr
op_add_assign
(paren
id|port
op_amp
id|HD64465_IOMAP_LO_MASK
)paren
op_lshift
id|shift
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;io_hd64465: access to un-mapped port %lx&bslash;n&quot;
comma
id|port
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|port
OL
id|HD64465_IOMAP_HI_THRESH
)paren
(brace
id|addr
op_assign
id|hd64465_iomap_hi
(braket
id|port
op_rshift
id|HD64465_IOMAP_HI_SHIFT
)braket
suffix:semicolon
id|shift
op_assign
id|hd64465_iomap_hi_shift
(braket
id|port
op_rshift
id|HD64465_IOMAP_HI_SHIFT
)braket
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_ne
l_int|0
)paren
id|addr
op_add_assign
(paren
id|port
op_amp
id|HD64465_IOMAP_HI_MASK
)paren
op_lshift
id|shift
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;io_hd64465: access to un-mapped port %lx&bslash;n&quot;
comma
id|port
)paren
suffix:semicolon
)brace
multiline_comment|/* HD64465 internal devices (0xb0000000) */
r_else
r_if
c_cond
(paren
id|port
OL
l_int|0x20000
)paren
id|addr
op_assign
id|CONFIG_HD64465_IOBASE
op_plus
id|port
op_minus
l_int|0x10000
suffix:semicolon
multiline_comment|/* Whole physical address space (0xa0000000) */
r_else
id|addr
op_assign
id|P2SEGADDR
c_func
(paren
id|port
)paren
suffix:semicolon
id|DIPRINTK
c_func
(paren
l_int|2
comma
l_string|&quot;PORT2ADDR(0x%08lx) = 0x%08lx&bslash;n&quot;
comma
id|port
comma
id|addr
)paren
suffix:semicolon
r_return
id|addr
suffix:semicolon
)brace
DECL|function|delay
r_static
r_inline
r_void
id|delay
c_func
(paren
r_void
)paren
(brace
id|ctrl_inw
c_func
(paren
l_int|0xa0000000
)paren
suffix:semicolon
)brace
DECL|function|hd64465_inb
r_int
r_char
id|hd64465_inb
c_func
(paren
r_int
r_int
id|port
)paren
(brace
r_int
r_int
id|addr
op_assign
id|PORT2ADDR
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_int
id|b
op_assign
(paren
id|addr
op_eq
l_int|0
ques
c_cond
l_int|0
suffix:colon
op_star
(paren
r_volatile
r_int
r_char
op_star
)paren
id|addr
)paren
suffix:semicolon
id|DIPRINTK
c_func
(paren
l_int|0
comma
l_string|&quot;inb(%08lx) = %02x&bslash;n&quot;
comma
id|addr
comma
(paren
r_int
)paren
id|b
)paren
suffix:semicolon
r_return
id|b
suffix:semicolon
)brace
DECL|function|hd64465_inb_p
r_int
r_char
id|hd64465_inb_p
c_func
(paren
r_int
r_int
id|port
)paren
(brace
r_int
r_int
id|v
suffix:semicolon
r_int
r_int
id|addr
op_assign
id|PORT2ADDR
c_func
(paren
id|port
)paren
suffix:semicolon
id|v
op_assign
(paren
id|addr
op_eq
l_int|0
ques
c_cond
l_int|0
suffix:colon
op_star
(paren
r_volatile
r_int
r_char
op_star
)paren
id|addr
)paren
suffix:semicolon
id|delay
c_func
(paren
)paren
suffix:semicolon
id|DIPRINTK
c_func
(paren
l_int|0
comma
l_string|&quot;inb_p(%08lx) = %02x&bslash;n&quot;
comma
id|addr
comma
(paren
r_int
)paren
id|v
)paren
suffix:semicolon
r_return
id|v
suffix:semicolon
)brace
DECL|function|hd64465_inw
r_int
r_int
id|hd64465_inw
c_func
(paren
r_int
r_int
id|port
)paren
(brace
r_int
r_int
id|addr
op_assign
id|PORT2ADDR
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_int
id|b
op_assign
(paren
id|addr
op_eq
l_int|0
ques
c_cond
l_int|0
suffix:colon
op_star
(paren
r_volatile
r_int
r_int
op_star
)paren
id|addr
)paren
suffix:semicolon
id|DIPRINTK
c_func
(paren
l_int|0
comma
l_string|&quot;inw(%08lx) = %04lx&bslash;n&quot;
comma
id|addr
comma
id|b
)paren
suffix:semicolon
r_return
id|b
suffix:semicolon
)brace
DECL|function|hd64465_inl
r_int
r_int
id|hd64465_inl
c_func
(paren
r_int
r_int
id|port
)paren
(brace
r_int
r_int
id|addr
op_assign
id|PORT2ADDR
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_int
id|b
op_assign
(paren
id|addr
op_eq
l_int|0
ques
c_cond
l_int|0
suffix:colon
op_star
(paren
r_volatile
r_int
r_int
op_star
)paren
id|addr
)paren
suffix:semicolon
id|DIPRINTK
c_func
(paren
l_int|0
comma
l_string|&quot;inl(%08lx) = %08x&bslash;n&quot;
comma
id|addr
comma
id|b
)paren
suffix:semicolon
r_return
id|b
suffix:semicolon
)brace
DECL|function|hd64465_insb
r_void
id|hd64465_insb
c_func
(paren
r_int
r_int
id|port
comma
r_void
op_star
id|buffer
comma
r_int
r_int
id|count
)paren
(brace
r_int
r_char
op_star
id|buf
op_assign
id|buffer
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
)paren
(brace
op_star
id|buf
op_increment
op_assign
id|inb
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
)brace
DECL|function|hd64465_insw
r_void
id|hd64465_insw
c_func
(paren
r_int
r_int
id|port
comma
r_void
op_star
id|buffer
comma
r_int
r_int
id|count
)paren
(brace
r_int
r_int
op_star
id|buf
op_assign
id|buffer
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
)paren
(brace
op_star
id|buf
op_increment
op_assign
id|inw
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
)brace
DECL|function|hd64465_insl
r_void
id|hd64465_insl
c_func
(paren
r_int
r_int
id|port
comma
r_void
op_star
id|buffer
comma
r_int
r_int
id|count
)paren
(brace
r_int
r_int
op_star
id|buf
op_assign
id|buffer
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
)paren
(brace
op_star
id|buf
op_increment
op_assign
id|inl
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
)brace
DECL|function|hd64465_outb
r_void
id|hd64465_outb
c_func
(paren
r_int
r_char
id|b
comma
r_int
r_int
id|port
)paren
(brace
r_int
r_int
id|addr
op_assign
id|PORT2ADDR
c_func
(paren
id|port
)paren
suffix:semicolon
id|DIPRINTK
c_func
(paren
l_int|0
comma
l_string|&quot;outb(%02x, %08lx)&bslash;n&quot;
comma
(paren
r_int
)paren
id|b
comma
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_ne
l_int|0
)paren
op_star
(paren
r_volatile
r_int
r_char
op_star
)paren
id|addr
op_assign
id|b
suffix:semicolon
)brace
DECL|function|hd64465_outb_p
r_void
id|hd64465_outb_p
c_func
(paren
r_int
r_char
id|b
comma
r_int
r_int
id|port
)paren
(brace
r_int
r_int
id|addr
op_assign
id|PORT2ADDR
c_func
(paren
id|port
)paren
suffix:semicolon
id|DIPRINTK
c_func
(paren
l_int|0
comma
l_string|&quot;outb_p(%02x, %08lx)&bslash;n&quot;
comma
(paren
r_int
)paren
id|b
comma
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_ne
l_int|0
)paren
op_star
(paren
r_volatile
r_int
r_char
op_star
)paren
id|addr
op_assign
id|b
suffix:semicolon
id|delay
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|hd64465_outw
r_void
id|hd64465_outw
c_func
(paren
r_int
r_int
id|b
comma
r_int
r_int
id|port
)paren
(brace
r_int
r_int
id|addr
op_assign
id|PORT2ADDR
c_func
(paren
id|port
)paren
suffix:semicolon
id|DIPRINTK
c_func
(paren
l_int|0
comma
l_string|&quot;outw(%04x, %08lx)&bslash;n&quot;
comma
(paren
r_int
)paren
id|b
comma
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_ne
l_int|0
)paren
op_star
(paren
r_volatile
r_int
r_int
op_star
)paren
id|addr
op_assign
id|b
suffix:semicolon
)brace
DECL|function|hd64465_outl
r_void
id|hd64465_outl
c_func
(paren
r_int
r_int
id|b
comma
r_int
r_int
id|port
)paren
(brace
r_int
r_int
id|addr
op_assign
id|PORT2ADDR
c_func
(paren
id|port
)paren
suffix:semicolon
id|DIPRINTK
c_func
(paren
l_int|0
comma
l_string|&quot;outl(%08x, %08lx)&bslash;n&quot;
comma
id|b
comma
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_ne
l_int|0
)paren
op_star
(paren
r_volatile
r_int
r_int
op_star
)paren
id|addr
op_assign
id|b
suffix:semicolon
)brace
DECL|function|hd64465_outsb
r_void
id|hd64465_outsb
c_func
(paren
r_int
r_int
id|port
comma
r_const
r_void
op_star
id|buffer
comma
r_int
r_int
id|count
)paren
(brace
r_const
r_int
r_char
op_star
id|buf
op_assign
id|buffer
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
)paren
(brace
id|outb
c_func
(paren
op_star
id|buf
op_increment
comma
id|port
)paren
suffix:semicolon
)brace
)brace
DECL|function|hd64465_outsw
r_void
id|hd64465_outsw
c_func
(paren
r_int
r_int
id|port
comma
r_const
r_void
op_star
id|buffer
comma
r_int
r_int
id|count
)paren
(brace
r_const
r_int
r_int
op_star
id|buf
op_assign
id|buffer
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
)paren
(brace
id|outw
c_func
(paren
op_star
id|buf
op_increment
comma
id|port
)paren
suffix:semicolon
)brace
)brace
DECL|function|hd64465_outsl
r_void
id|hd64465_outsl
c_func
(paren
r_int
r_int
id|port
comma
r_const
r_void
op_star
id|buffer
comma
r_int
r_int
id|count
)paren
(brace
r_const
r_int
r_int
op_star
id|buf
op_assign
id|buffer
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
)paren
(brace
id|outl
c_func
(paren
op_star
id|buf
op_increment
comma
id|port
)paren
suffix:semicolon
)brace
)brace
eof
