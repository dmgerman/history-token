multiline_comment|/*&n; * linux/arch/sh/kernel/pci-bigsur.c&n; *&n; * By Dustin McIntire (dustin@sensoria.com) (c)2001&n;&n; * May be copied or modified under the terms of the GNU General Public&n; * License.  See linux/COPYING for more information.&n; *&n; * PCI initialization for the Hitachi Big Sur Evaluation Board&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pci-sh7751.h&gt;
macro_line|#include &lt;asm/bigsur.h&gt;
DECL|macro|PCI_REG
mdefine_line|#define PCI_REG(reg)        (SH7751_PCIREG_BASE+reg)
multiline_comment|/*&n; * Initialize the Big Sur PCI interface &n; * Setup hardware to be Central Funtion&n; * Copy the BSR regs to the PCI interface&n; * Setup PCI windows into local RAM&n; */
DECL|function|pcibios_init_platform
r_int
id|__init
id|pcibios_init_platform
c_func
(paren
r_void
)paren
(brace
id|u32
id|reg
suffix:semicolon
id|u32
id|word
suffix:semicolon
id|PCIDBG
c_func
(paren
l_int|1
comma
l_string|&quot;PCI: bigsur_pci_init called&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Set the BCR&squot;s to enable PCI access */
id|reg
op_assign
id|inl
c_func
(paren
id|SH7751_BCR1
)paren
suffix:semicolon
id|reg
op_or_assign
l_int|0x80000
suffix:semicolon
id|outl
c_func
(paren
id|reg
comma
id|SH7751_BCR1
)paren
suffix:semicolon
multiline_comment|/* Setup the host hardware */
r_if
c_cond
(paren
id|inl
c_func
(paren
id|PCI_REG
c_func
(paren
id|SH7751_PCICONF0
)paren
)paren
op_ne
(paren
id|u32
)paren
(paren
(paren
id|SH7751_DEVICE_ID
op_lshift
l_int|16
)paren
op_or
(paren
id|SH7751_VENDOR_ID
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: Unkown PCI host bridge.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;PCI: SH7751 PCI host bridge found.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Turn the clocks back on (not done in reset)*/
id|outl
c_func
(paren
l_int|0
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCICLKR
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear Powerdown IRQ&squot;s (not done in reset) */
id|word
op_assign
id|SH7751_PCIPINT_D3
op_or
id|SH7751_PCIPINT_D0
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCICLKR
)paren
)paren
suffix:semicolon
multiline_comment|/* toggle PCI reset pin */
id|word
op_assign
id|SH7751_PCICR_PREFIX
op_or
id|SH7751_PCICR_PRST
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCICR
)paren
)paren
suffix:semicolon
multiline_comment|/* Wait for a long time... not 1 sec. but long enough */
id|mdelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|word
op_assign
id|SH7751_PCICR_PREFIX
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCICR
)paren
)paren
suffix:semicolon
multiline_comment|/* set the command/status bits to:&n;     * Wait Cycle Control + Parity Enable + Bus Master +&n;     * Mem space enable&n;     */
id|word
op_assign
id|SH7751_PCICONF1_WCC
op_or
id|SH7751_PCICONF1_PER
op_or
id|SH7751_PCICONF1_BUM
op_or
id|SH7751_PCICONF1_MES
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCICONF1
)paren
)paren
suffix:semicolon
multiline_comment|/* define this host as the host bridge */
id|word
op_assign
id|SH7751_PCI_HOST_BRIDGE
op_lshift
l_int|24
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCICONF2
)paren
)paren
suffix:semicolon
multiline_comment|/* Set IO and Mem windows to local address &n;&t; * Make PCI and local address the same for easy 1 to 1 mapping &n;&t; * Window0 = BIGSUR_LSR0_SIZE @ non-cached CS3 base = SDRAM&n;&t; * Window1 = BIGSUR_LSR1_SIZE @ cached CS3 base = SDRAM &n;&t; */
id|word
op_assign
id|BIGSUR_LSR0_SIZE
op_minus
l_int|1
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCILSR0
)paren
)paren
suffix:semicolon
id|word
op_assign
id|BIGSUR_LSR1_SIZE
op_minus
l_int|1
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCILSR1
)paren
)paren
suffix:semicolon
multiline_comment|/* Set the values on window 0 PCI config registers */
id|word
op_assign
id|P2SEGADDR
c_func
(paren
id|SH7751_CS3_BASE_ADDR
)paren
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCILAR0
)paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCICONF5
)paren
)paren
suffix:semicolon
multiline_comment|/* Set the values on window 1 PCI config registers */
id|word
op_assign
id|PHYSADDR
c_func
(paren
id|SH7751_CS3_BASE_ADDR
)paren
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCILAR1
)paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCICONF6
)paren
)paren
suffix:semicolon
multiline_comment|/* Set the local 16MB PCI memory space window to &n;&t; * the lowest PCI mapped address&n;&t; */
id|word
op_assign
id|PCIBIOS_MIN_MEM
op_amp
id|SH7751_PCIMBR_MASK
suffix:semicolon
id|PCIDBG
c_func
(paren
l_int|2
comma
l_string|&quot;PCI: Setting upper bits of Memory window to 0x%x&bslash;n&quot;
comma
id|word
)paren
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCIMBR
)paren
)paren
suffix:semicolon
multiline_comment|/* Map IO space into PCI IO window&n;&t; * The IO window is 64K-PCIBIOS_MIN_IO in size&n;&t; * IO addresses will be translated to the &n;&t; * PCI IO window base address&n;&t; */
id|PCIDBG
c_func
(paren
l_int|3
comma
l_string|&quot;PCI: Mapping IO address 0x%x - 0x%x to base 0x%x&bslash;n&quot;
comma
id|PCIBIOS_MIN_IO
comma
(paren
l_int|64
op_star
l_int|1024
)paren
comma
id|SH7751_PCI_IO_BASE
op_plus
id|PCIBIOS_MIN_IO
)paren
suffix:semicolon
id|bigsur_port_map
c_func
(paren
id|PCIBIOS_MIN_IO
comma
(paren
l_int|64
op_star
l_int|1024
)paren
comma
id|SH7751_PCI_IO_BASE
op_plus
id|PCIBIOS_MIN_IO
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Make sure the MSB&squot;s of IO window are set to access PCI space correctly */
id|word
op_assign
id|PCIBIOS_MIN_IO
op_amp
id|SH7751_PCIIOBR_MASK
suffix:semicolon
id|PCIDBG
c_func
(paren
l_int|2
comma
l_string|&quot;PCI: Setting upper bits of IO window to 0x%x&bslash;n&quot;
comma
id|word
)paren
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCIIOBR
)paren
)paren
suffix:semicolon
multiline_comment|/* Set PCI WCRx, BCRx&squot;s, copy from BSC locations */
id|word
op_assign
id|inl
c_func
(paren
id|SH7751_BCR1
)paren
suffix:semicolon
multiline_comment|/* check BCR for SDRAM in area 3 */
r_if
c_cond
(paren
(paren
(paren
id|word
op_rshift
l_int|3
)paren
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: Area 3 is not configured for SDRAM. BCR1=0x%x&bslash;n&quot;
comma
id|word
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCIBCR1
)paren
)paren
suffix:semicolon
id|word
op_assign
(paren
id|u16
)paren
id|inw
c_func
(paren
id|SH7751_BCR2
)paren
suffix:semicolon
multiline_comment|/* check BCR2 for 32bit SDRAM interface*/
r_if
c_cond
(paren
(paren
(paren
id|word
op_rshift
l_int|6
)paren
op_amp
l_int|0x3
)paren
op_ne
l_int|0x3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: Area 3 is not 32 bit SDRAM. BCR2=0x%x&bslash;n&quot;
comma
id|word
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCIBCR2
)paren
)paren
suffix:semicolon
multiline_comment|/* configure the wait control registers */
id|word
op_assign
id|inl
c_func
(paren
id|SH7751_WCR1
)paren
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCIWCR1
)paren
)paren
suffix:semicolon
id|word
op_assign
id|inl
c_func
(paren
id|SH7751_WCR2
)paren
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCIWCR2
)paren
)paren
suffix:semicolon
id|word
op_assign
id|inl
c_func
(paren
id|SH7751_WCR3
)paren
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCIWCR3
)paren
)paren
suffix:semicolon
id|word
op_assign
id|inl
c_func
(paren
id|SH7751_MCR
)paren
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCIMCR
)paren
)paren
suffix:semicolon
multiline_comment|/* NOTE: I&squot;m ignoring the PCI error IRQs for now..&n;&t; * TODO: add support for the internal error interrupts and&n;&t; * DMA interrupts...&n;&t; */
multiline_comment|/* SH7751 init done, set central function init complete */
id|word
op_assign
id|SH7751_PCICR_PREFIX
op_or
id|SH7751_PCICR_CFIN
suffix:semicolon
id|outl
c_func
(paren
id|word
comma
id|PCI_REG
c_func
(paren
id|SH7751_PCICR
)paren
)paren
suffix:semicolon
id|PCIDBG
c_func
(paren
l_int|2
comma
l_string|&quot;PCI: bigsur_pci_init finished&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|pcibios_map_platform_irq
r_int
id|pcibios_map_platform_irq
c_func
(paren
id|u8
id|slot
comma
id|u8
id|pin
)paren
(brace
multiline_comment|/* The Big Sur can be used in a CPCI chassis, but the SH7751 PCI interface is on the&n;     * wrong end of the board so that it can also support a V320 CPI interface chip...&n;     * Therefor the IRQ mapping is somewhat use dependent... I&squot;l assume a linear map for&n;     * now, i.e. INTA=slot0,pin0... INTD=slot3,pin0...&n;     */
r_int
id|irq
op_assign
(paren
id|slot
op_plus
id|pin
op_minus
l_int|1
)paren
op_mod
l_int|4
op_plus
id|BIGSUR_SH7751_PCI_IRQ_BASE
suffix:semicolon
id|PCIDBG
c_func
(paren
l_int|2
comma
l_string|&quot;PCI: Mapping Big Sur IRQ for slot %d, pin %c to irq %d&bslash;n&quot;
comma
id|slot
comma
id|pin
op_minus
l_int|1
op_plus
l_char|&squot;A&squot;
comma
id|irq
)paren
suffix:semicolon
r_return
id|irq
suffix:semicolon
)brace
eof
