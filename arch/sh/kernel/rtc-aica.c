multiline_comment|/* arch/sh/kernel/rtc-aica.c&n; *&n; * Dreamcast AICA RTC routines.&n; *&n; * Copyright (c) 2001 M. R. Brown &lt;mrbrown@0xd6.org&gt;&n; *&n; * Released under the terms of the GNU GPL v2.0.&n; *&n; */
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;asm/io.h&gt;
multiline_comment|/* The AICA RTC has an Epoch of 1/1/1950, so we must subtract 20 years (in&n;   seconds to get the standard Unix Epoch when getting the time, and add 20&n;   years when setting the time. */
DECL|macro|TWENTY_YEARS
mdefine_line|#define TWENTY_YEARS ((20 * 365LU + 5) * 86400)
multiline_comment|/* The AICA RTC is represented by a 32-bit seconds counter stored in 2 16-bit&n;   registers.*/
DECL|macro|AICA_RTC_SECS_H
mdefine_line|#define AICA_RTC_SECS_H&t;&t;0xa0710000
DECL|macro|AICA_RTC_SECS_L
mdefine_line|#define AICA_RTC_SECS_L&t;&t;0xa0710004
multiline_comment|/**&n; * aica_rtc_gettimeofday - Get the time from the AICA RTC&n; * @tv: pointer to resulting timeval&n; *&n; * Grabs the current RTC seconds counter and adjusts it to the Unix Epoch.&n; */
DECL|function|aica_rtc_gettimeofday
r_void
id|aica_rtc_gettimeofday
c_func
(paren
r_struct
id|timeval
op_star
id|tv
)paren
(brace
r_int
r_int
id|val1
comma
id|val2
suffix:semicolon
r_do
(brace
id|val1
op_assign
(paren
(paren
id|ctrl_inl
c_func
(paren
id|AICA_RTC_SECS_H
)paren
op_amp
l_int|0xffff
)paren
op_lshift
l_int|16
)paren
op_or
(paren
id|ctrl_inl
c_func
(paren
id|AICA_RTC_SECS_L
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|val2
op_assign
(paren
(paren
id|ctrl_inl
c_func
(paren
id|AICA_RTC_SECS_H
)paren
op_amp
l_int|0xffff
)paren
op_lshift
l_int|16
)paren
op_or
(paren
id|ctrl_inl
c_func
(paren
id|AICA_RTC_SECS_L
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|val1
op_ne
id|val2
)paren
suffix:semicolon
id|tv-&gt;tv_sec
op_assign
id|val1
op_minus
id|TWENTY_YEARS
suffix:semicolon
multiline_comment|/* Can&squot;t get microseconds with just a seconds counter. */
id|tv-&gt;tv_usec
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * aica_rtc_settimeofday - Set the AICA RTC to the current time&n; * @tv: contains the timeval to set&n; *&n; * Adjusts the given @tv to the AICA Epoch and sets the RTC seconds counter.&n; */
DECL|function|aica_rtc_settimeofday
r_int
id|aica_rtc_settimeofday
c_func
(paren
r_const
r_struct
id|timeval
op_star
id|tv
)paren
(brace
r_int
r_int
id|val1
comma
id|val2
suffix:semicolon
r_int
r_int
id|secs
op_assign
id|tv-&gt;tv_sec
op_plus
id|TWENTY_YEARS
suffix:semicolon
r_do
(brace
id|ctrl_outl
c_func
(paren
(paren
id|secs
op_amp
l_int|0xffff0000
)paren
op_rshift
l_int|16
comma
id|AICA_RTC_SECS_H
)paren
suffix:semicolon
id|ctrl_outl
c_func
(paren
(paren
id|secs
op_amp
l_int|0xffff
)paren
comma
id|AICA_RTC_SECS_L
)paren
suffix:semicolon
id|val1
op_assign
(paren
(paren
id|ctrl_inl
c_func
(paren
id|AICA_RTC_SECS_H
)paren
op_amp
l_int|0xffff
)paren
op_lshift
l_int|16
)paren
op_or
(paren
id|ctrl_inl
c_func
(paren
id|AICA_RTC_SECS_L
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|val2
op_assign
(paren
(paren
id|ctrl_inl
c_func
(paren
id|AICA_RTC_SECS_H
)paren
op_amp
l_int|0xffff
)paren
op_lshift
l_int|16
)paren
op_or
(paren
id|ctrl_inl
c_func
(paren
id|AICA_RTC_SECS_L
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|val1
op_ne
id|val2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
