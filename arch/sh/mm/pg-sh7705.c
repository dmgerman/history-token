multiline_comment|/*&n; * arch/sh/mm/pg-sh7705.c&n; *&n; * Copyright (C) 1999, 2000  Niibe Yutaka&n; * Copyright (C) 2004  Alex Song&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/mman.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/threads.h&gt;
macro_line|#include &lt;asm/addrspace.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/cache.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/pgalloc.h&gt;
macro_line|#include &lt;asm/mmu_context.h&gt;
macro_line|#include &lt;asm/cacheflush.h&gt;
DECL|function|__flush_purge_virtual_region
r_static
r_inline
r_void
id|__flush_purge_virtual_region
c_func
(paren
r_void
op_star
id|p1
comma
r_void
op_star
id|virt
comma
r_int
id|size
)paren
(brace
r_int
r_int
id|v
suffix:semicolon
r_int
r_int
id|begin
comma
id|end
suffix:semicolon
r_int
r_int
id|p1_begin
suffix:semicolon
id|begin
op_assign
id|L1_CACHE_ALIGN
c_func
(paren
(paren
r_int
r_int
)paren
id|virt
)paren
suffix:semicolon
id|end
op_assign
id|L1_CACHE_ALIGN
c_func
(paren
(paren
r_int
r_int
)paren
id|virt
op_plus
id|size
)paren
suffix:semicolon
id|p1_begin
op_assign
(paren
r_int
r_int
)paren
id|p1
op_amp
op_complement
(paren
id|L1_CACHE_BYTES
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* do this the slow way as we may not have TLB entries&n;&t; * for virt yet. */
r_for
c_loop
(paren
id|v
op_assign
id|begin
suffix:semicolon
id|v
OL
id|end
suffix:semicolon
id|v
op_add_assign
id|L1_CACHE_BYTES
)paren
(brace
r_int
r_int
id|p
suffix:semicolon
r_int
r_int
id|ways
comma
id|addr
suffix:semicolon
id|p
op_assign
id|__pa
c_func
(paren
id|p1_begin
)paren
suffix:semicolon
id|ways
op_assign
id|cpu_data-&gt;dcache.ways
suffix:semicolon
id|addr
op_assign
id|CACHE_OC_ADDRESS_ARRAY
suffix:semicolon
r_do
(brace
r_int
r_int
id|data
suffix:semicolon
id|addr
op_or_assign
(paren
id|v
op_amp
id|cpu_data-&gt;dcache.entry_mask
)paren
suffix:semicolon
id|data
op_assign
id|ctrl_inl
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data
op_amp
id|CACHE_PHYSADDR_MASK
)paren
op_eq
(paren
id|p
op_amp
id|CACHE_PHYSADDR_MASK
)paren
)paren
(brace
id|data
op_and_assign
op_complement
(paren
id|SH_CACHE_UPDATED
op_or
id|SH_CACHE_VALID
)paren
suffix:semicolon
id|ctrl_outl
c_func
(paren
id|data
comma
id|addr
)paren
suffix:semicolon
)brace
id|addr
op_add_assign
id|cpu_data-&gt;dcache.way_incr
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|ways
)paren
suffix:semicolon
id|p1_begin
op_add_assign
id|L1_CACHE_BYTES
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * clear_user_page&n; * @to: P1 address&n; * @address: U0 address to be mapped&n; */
DECL|function|clear_user_page
r_void
id|clear_user_page
c_func
(paren
r_void
op_star
id|to
comma
r_int
r_int
id|address
comma
r_struct
id|page
op_star
id|pg
)paren
(brace
r_struct
id|page
op_star
id|page
op_assign
id|virt_to_page
c_func
(paren
id|to
)paren
suffix:semicolon
id|__set_bit
c_func
(paren
id|PG_mapped
comma
op_amp
id|page-&gt;flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|address
op_xor
(paren
r_int
r_int
)paren
id|to
)paren
op_amp
id|CACHE_ALIAS
)paren
op_eq
l_int|0
)paren
(brace
id|clear_page
c_func
(paren
id|to
)paren
suffix:semicolon
id|__flush_wback_region
c_func
(paren
id|to
comma
id|PAGE_SIZE
)paren
suffix:semicolon
)brace
r_else
(brace
id|__flush_purge_virtual_region
c_func
(paren
id|to
comma
(paren
r_void
op_star
)paren
(paren
id|address
op_amp
l_int|0xfffff000
)paren
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|clear_page
c_func
(paren
id|to
)paren
suffix:semicolon
id|__flush_wback_region
c_func
(paren
id|to
comma
id|PAGE_SIZE
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * copy_user_page&n; * @to: P1 address&n; * @from: P1 address&n; * @address: U0 address to be mapped&n; */
DECL|function|copy_user_page
r_void
id|copy_user_page
c_func
(paren
r_void
op_star
id|to
comma
r_void
op_star
id|from
comma
r_int
r_int
id|address
comma
r_struct
id|page
op_star
id|pg
)paren
(brace
r_struct
id|page
op_star
id|page
op_assign
id|virt_to_page
c_func
(paren
id|to
)paren
suffix:semicolon
id|__set_bit
c_func
(paren
id|PG_mapped
comma
op_amp
id|page-&gt;flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|address
op_xor
(paren
r_int
r_int
)paren
id|to
)paren
op_amp
id|CACHE_ALIAS
)paren
op_eq
l_int|0
)paren
(brace
id|copy_page
c_func
(paren
id|to
comma
id|from
)paren
suffix:semicolon
id|__flush_wback_region
c_func
(paren
id|to
comma
id|PAGE_SIZE
)paren
suffix:semicolon
)brace
r_else
(brace
id|__flush_purge_virtual_region
c_func
(paren
id|to
comma
(paren
r_void
op_star
)paren
(paren
id|address
op_amp
l_int|0xfffff000
)paren
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|copy_page
c_func
(paren
id|to
comma
id|from
)paren
suffix:semicolon
id|__flush_wback_region
c_func
(paren
id|to
comma
id|PAGE_SIZE
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * For SH7705, we have our own implementation for ptep_get_and_clear&n; * Copied from pg-sh4.c&n; */
DECL|function|ptep_get_and_clear
r_inline
id|pte_t
id|ptep_get_and_clear
c_func
(paren
id|pte_t
op_star
id|ptep
)paren
(brace
id|pte_t
id|pte
op_assign
op_star
id|ptep
suffix:semicolon
id|pte_clear
c_func
(paren
id|ptep
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pte_not_present
c_func
(paren
id|pte
)paren
)paren
(brace
r_int
r_int
id|pfn
op_assign
id|pte_pfn
c_func
(paren
id|pte
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pfn_valid
c_func
(paren
id|pfn
)paren
)paren
(brace
r_struct
id|page
op_star
id|page
op_assign
id|pfn_to_page
c_func
(paren
id|pfn
)paren
suffix:semicolon
r_struct
id|address_space
op_star
id|mapping
op_assign
id|page_mapping
c_func
(paren
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mapping
op_logical_or
op_logical_neg
id|mapping_writably_mapped
c_func
(paren
id|mapping
)paren
)paren
id|__clear_bit
c_func
(paren
id|PG_mapped
comma
op_amp
id|page-&gt;flags
)paren
suffix:semicolon
)brace
)brace
r_return
id|pte
suffix:semicolon
)brace
eof
