multiline_comment|/* Copyright 2002,2003 Andi Kleen, SuSE Labs */
multiline_comment|/* vsyscall handling for 32bit processes. Map a stub page into it &n;   on demand because 32bit cannot reach the kernel&squot;s fixmaps */
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/gfp.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/stringify.h&gt;
macro_line|#include &lt;asm/proto.h&gt;
macro_line|#include &lt;asm/tlbflush.h&gt;
macro_line|#include &lt;asm/ia32_unistd.h&gt;
multiline_comment|/* 32bit VDSOs mapped into user space. */
id|asm
c_func
(paren
l_string|&quot;.section &bslash;&quot;.init.data&bslash;&quot;,&bslash;&quot;aw&bslash;&quot;&bslash;n&quot;
l_string|&quot;syscall32_syscall:&bslash;n&quot;
l_string|&quot;.incbin &bslash;&quot;arch/x86_64/ia32/vsyscall-syscall.so&bslash;&quot;&bslash;n&quot;
l_string|&quot;syscall32_syscall_end:&bslash;n&quot;
l_string|&quot;syscall32_sysenter:&bslash;n&quot;
l_string|&quot;.incbin &bslash;&quot;arch/x86_64/ia32/vsyscall-sysenter.so&bslash;&quot;&bslash;n&quot;
l_string|&quot;syscall32_sysenter_end:&bslash;n&quot;
l_string|&quot;.previous&quot;
)paren
suffix:semicolon
r_extern
r_int
r_char
id|syscall32_syscall
(braket
)braket
comma
id|syscall32_syscall_end
(braket
)braket
suffix:semicolon
r_extern
r_int
r_char
id|syscall32_sysenter
(braket
)braket
comma
id|syscall32_sysenter_end
(braket
)braket
suffix:semicolon
r_extern
r_int
id|sysctl_vsyscall32
suffix:semicolon
DECL|variable|syscall32_page
r_char
op_star
id|syscall32_page
suffix:semicolon
DECL|variable|use_sysenter
r_static
r_int
id|use_sysenter
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n; * Map the 32bit vsyscall page on demand.&n; *&n; * RED-PEN: This knows too much about high level VM.&n; *&n; * Alternative would be to generate a vma with appropriate backing options&n; * and let it be handled by generic VM.&n; */
DECL|function|__map_syscall32
r_int
id|__map_syscall32
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|address
)paren
(brace
id|pgd_t
op_star
id|pgd
suffix:semicolon
id|pgd_t
op_star
id|pud
suffix:semicolon
id|pte_t
op_star
id|pte
suffix:semicolon
id|pmd_t
op_star
id|pmd
suffix:semicolon
r_int
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|mm-&gt;page_table_lock
)paren
suffix:semicolon
id|pgd
op_assign
id|pgd_offset
c_func
(paren
id|mm
comma
id|address
)paren
suffix:semicolon
id|pud
op_assign
id|pud_alloc
c_func
(paren
id|mm
comma
id|pgd
comma
id|address
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pud
)paren
(brace
id|pmd
op_assign
id|pmd_alloc
c_func
(paren
id|mm
comma
id|pud
comma
id|address
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmd
op_logical_and
(paren
id|pte
op_assign
id|pte_alloc_map
c_func
(paren
id|mm
comma
id|pmd
comma
id|address
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|pte_none
c_func
(paren
op_star
id|pte
)paren
)paren
(brace
id|set_pte
c_func
(paren
id|pte
comma
id|mk_pte
c_func
(paren
id|virt_to_page
c_func
(paren
id|syscall32_page
)paren
comma
id|PAGE_KERNEL_VSYSCALL
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Flush only the local CPU. Other CPUs taking a fault&n; &t;&t;&t;   will just end up here again&n;&t;&t;&t;   This probably not needed and just paranoia. */
id|__flush_tlb_one
c_func
(paren
id|address
)paren
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|mm-&gt;page_table_lock
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|map_syscall32
r_int
id|map_syscall32
c_func
(paren
r_struct
id|mm_struct
op_star
id|mm
comma
r_int
r_int
id|address
)paren
(brace
r_int
id|err
suffix:semicolon
id|down_read
c_func
(paren
op_amp
id|mm-&gt;mmap_sem
)paren
suffix:semicolon
id|err
op_assign
id|__map_syscall32
c_func
(paren
id|mm
comma
id|address
)paren
suffix:semicolon
id|up_read
c_func
(paren
op_amp
id|mm-&gt;mmap_sem
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|init_syscall32
r_static
r_int
id|__init
id|init_syscall32
c_func
(paren
r_void
)paren
(brace
id|syscall32_page
op_assign
(paren
r_void
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|syscall32_page
)paren
id|panic
c_func
(paren
l_string|&quot;Cannot allocate syscall32 page&quot;
)paren
suffix:semicolon
id|SetPageReserved
c_func
(paren
id|virt_to_page
c_func
(paren
id|syscall32_page
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|use_sysenter
OG
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
id|syscall32_page
comma
id|syscall32_sysenter
comma
id|syscall32_sysenter_end
op_minus
id|syscall32_sysenter
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|syscall32_page
comma
id|syscall32_syscall
comma
id|syscall32_syscall_end
op_minus
id|syscall32_syscall
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|init_syscall32
id|__initcall
c_func
(paren
id|init_syscall32
)paren
suffix:semicolon
multiline_comment|/* May not be __init: called during resume */
DECL|function|syscall32_cpu_init
r_void
id|syscall32_cpu_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|use_sysenter
OL
l_int|0
)paren
id|use_sysenter
op_assign
(paren
id|boot_cpu_data.x86_vendor
op_eq
id|X86_VENDOR_INTEL
)paren
suffix:semicolon
multiline_comment|/* Load these always in case some future AMD CPU supports&n;&t;   SYSENTER from compat mode too. */
id|checking_wrmsrl
c_func
(paren
id|MSR_IA32_SYSENTER_CS
comma
(paren
id|u64
)paren
id|__KERNEL_CS
)paren
suffix:semicolon
id|checking_wrmsrl
c_func
(paren
id|MSR_IA32_SYSENTER_ESP
comma
l_int|0ULL
)paren
suffix:semicolon
id|checking_wrmsrl
c_func
(paren
id|MSR_IA32_SYSENTER_EIP
comma
(paren
id|u64
)paren
id|ia32_sysenter_target
)paren
suffix:semicolon
id|wrmsrl
c_func
(paren
id|MSR_CSTAR
comma
id|ia32_cstar_target
)paren
suffix:semicolon
)brace
eof
