multiline_comment|/* &n; * Copyright 2002 Andi Kleen, SuSE Labs.&n; * FXSAVE&lt;-&gt;i387 conversion support. Based on code by Gareth Hughes.&n; * This is used for ptrace, signals and coredumps in 32bit emulation.&n; * $Id: fpu32.c,v 1.1 2002/03/21 14:16:32 ak Exp $&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/sigcontext32.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/i387.h&gt;
DECL|function|twd_i387_to_fxsr
r_static
r_inline
r_int
r_int
id|twd_i387_to_fxsr
c_func
(paren
r_int
r_int
id|twd
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
multiline_comment|/* to avoid 16 bit prefixes in the code */
multiline_comment|/* Transform each pair of bits into 01 (valid) or 00 (empty) */
id|tmp
op_assign
op_complement
id|twd
suffix:semicolon
id|tmp
op_assign
(paren
id|tmp
op_or
(paren
id|tmp
op_rshift
l_int|1
)paren
)paren
op_amp
l_int|0x5555
suffix:semicolon
multiline_comment|/* 0V0V0V0V0V0V0V0V */
multiline_comment|/* and move the valid bits to the lower byte. */
id|tmp
op_assign
(paren
id|tmp
op_or
(paren
id|tmp
op_rshift
l_int|1
)paren
)paren
op_amp
l_int|0x3333
suffix:semicolon
multiline_comment|/* 00VV00VV00VV00VV */
id|tmp
op_assign
(paren
id|tmp
op_or
(paren
id|tmp
op_rshift
l_int|2
)paren
)paren
op_amp
l_int|0x0f0f
suffix:semicolon
multiline_comment|/* 0000VVVV0000VVVV */
id|tmp
op_assign
(paren
id|tmp
op_or
(paren
id|tmp
op_rshift
l_int|4
)paren
)paren
op_amp
l_int|0x00ff
suffix:semicolon
multiline_comment|/* 00000000VVVVVVVV */
r_return
id|tmp
suffix:semicolon
)brace
DECL|function|twd_fxsr_to_i387
r_static
r_inline
r_int
r_int
id|twd_fxsr_to_i387
c_func
(paren
r_struct
id|i387_fxsave_struct
op_star
id|fxsave
)paren
(brace
r_struct
id|_fpxreg
op_star
id|st
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|tos
op_assign
(paren
id|fxsave-&gt;swd
op_rshift
l_int|11
)paren
op_amp
l_int|7
suffix:semicolon
r_int
r_int
id|twd
op_assign
(paren
r_int
r_int
)paren
id|fxsave-&gt;twd
suffix:semicolon
r_int
r_int
id|tag
suffix:semicolon
r_int
r_int
id|ret
op_assign
l_int|0xffff0000
suffix:semicolon
r_int
id|i
suffix:semicolon
DECL|macro|FPREG_ADDR
mdefine_line|#define FPREG_ADDR(f, n)&t;((void *)&amp;(f)-&gt;st_space + (n) * 16);
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|twd
op_amp
l_int|0x1
)paren
(brace
id|st
op_assign
id|FPREG_ADDR
c_func
(paren
id|fxsave
comma
(paren
id|i
op_minus
id|tos
)paren
op_amp
l_int|7
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|st-&gt;exponent
op_amp
l_int|0x7fff
)paren
(brace
r_case
l_int|0x7fff
suffix:colon
id|tag
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Special */
r_break
suffix:semicolon
r_case
l_int|0x0000
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|st-&gt;significand
(braket
l_int|0
)braket
op_logical_and
op_logical_neg
id|st-&gt;significand
(braket
l_int|1
)braket
op_logical_and
op_logical_neg
id|st-&gt;significand
(braket
l_int|2
)braket
op_logical_and
op_logical_neg
id|st-&gt;significand
(braket
l_int|3
)braket
)paren
(brace
id|tag
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Zero */
)brace
r_else
(brace
id|tag
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Special */
)brace
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|st-&gt;significand
(braket
l_int|3
)braket
op_amp
l_int|0x8000
)paren
(brace
id|tag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Valid */
)brace
r_else
(brace
id|tag
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Special */
)brace
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
id|tag
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* Empty */
)brace
id|ret
op_or_assign
(paren
id|tag
op_lshift
(paren
l_int|2
op_star
id|i
)paren
)paren
suffix:semicolon
id|twd
op_assign
id|twd
op_rshift
l_int|1
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|convert_fxsr_from_user
r_static
r_inline
r_int
id|convert_fxsr_from_user
c_func
(paren
r_struct
id|i387_fxsave_struct
op_star
id|fxsave
comma
r_struct
id|_fpstate_ia32
id|__user
op_star
id|buf
)paren
(brace
r_struct
id|_fpxreg
op_star
id|to
suffix:semicolon
r_struct
id|_fpreg
id|__user
op_star
id|from
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
id|v
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
DECL|macro|G
mdefine_line|#define G(num,val) err |= __get_user(val, num + (u32 __user *)buf)
id|G
c_func
(paren
l_int|0
comma
id|fxsave-&gt;cwd
)paren
suffix:semicolon
id|G
c_func
(paren
l_int|1
comma
id|fxsave-&gt;swd
)paren
suffix:semicolon
id|G
c_func
(paren
l_int|2
comma
id|fxsave-&gt;twd
)paren
suffix:semicolon
id|fxsave-&gt;twd
op_assign
id|twd_i387_to_fxsr
c_func
(paren
id|fxsave-&gt;twd
)paren
suffix:semicolon
id|G
c_func
(paren
l_int|3
comma
id|fxsave-&gt;rip
)paren
suffix:semicolon
id|G
c_func
(paren
l_int|4
comma
id|v
)paren
suffix:semicolon
id|fxsave-&gt;fop
op_assign
id|v
op_rshift
l_int|16
suffix:semicolon
multiline_comment|/* cs ignored */
id|G
c_func
(paren
l_int|5
comma
id|fxsave-&gt;rdp
)paren
suffix:semicolon
multiline_comment|/* 6: ds ignored */
DECL|macro|G
macro_line|#undef G
r_if
c_cond
(paren
id|err
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|to
op_assign
(paren
r_struct
id|_fpxreg
op_star
)paren
op_amp
id|fxsave-&gt;st_space
(braket
l_int|0
)braket
suffix:semicolon
id|from
op_assign
op_amp
id|buf-&gt;_st
(braket
l_int|0
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
comma
id|to
op_increment
comma
id|from
op_increment
)paren
(brace
r_if
c_cond
(paren
id|__copy_from_user
c_func
(paren
id|to
comma
id|from
comma
r_sizeof
(paren
op_star
id|from
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|convert_fxsr_to_user
r_static
r_inline
r_int
id|convert_fxsr_to_user
c_func
(paren
r_struct
id|_fpstate_ia32
id|__user
op_star
id|buf
comma
r_struct
id|i387_fxsave_struct
op_star
id|fxsave
comma
r_struct
id|pt_regs
op_star
id|regs
comma
r_struct
id|task_struct
op_star
id|tsk
)paren
(brace
r_struct
id|_fpreg
id|__user
op_star
id|to
suffix:semicolon
r_struct
id|_fpxreg
op_star
id|from
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u16
id|cs
comma
id|ds
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tsk
op_eq
id|current
)paren
(brace
multiline_comment|/* should be actually ds/cs at fpu exception time,&n;&t;&t;   but that information is not available in 64bit mode. */
id|asm
c_func
(paren
l_string|&quot;movw %%ds,%0 &quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|ds
)paren
)paren
suffix:semicolon
id|asm
c_func
(paren
l_string|&quot;movw %%cs,%0 &quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|cs
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* ptrace. task has stopped. */
id|ds
op_assign
id|tsk-&gt;thread.ds
suffix:semicolon
id|cs
op_assign
id|regs-&gt;cs
suffix:semicolon
)brace
DECL|macro|P
mdefine_line|#define P(num,val) err |= __put_user(val, num + (u32 __user *)buf)
id|P
c_func
(paren
l_int|0
comma
(paren
id|u32
)paren
id|fxsave-&gt;cwd
op_or
l_int|0xffff0000
)paren
suffix:semicolon
id|P
c_func
(paren
l_int|1
comma
(paren
id|u32
)paren
id|fxsave-&gt;swd
op_or
l_int|0xffff0000
)paren
suffix:semicolon
id|P
c_func
(paren
l_int|2
comma
id|twd_fxsr_to_i387
c_func
(paren
id|fxsave
)paren
)paren
suffix:semicolon
id|P
c_func
(paren
l_int|3
comma
(paren
id|u32
)paren
id|fxsave-&gt;rip
)paren
suffix:semicolon
id|P
c_func
(paren
l_int|4
comma
id|cs
op_or
(paren
(paren
id|u32
)paren
id|fxsave-&gt;fop
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|P
c_func
(paren
l_int|5
comma
id|fxsave-&gt;rdp
)paren
suffix:semicolon
id|P
c_func
(paren
l_int|6
comma
l_int|0xffff0000
op_or
id|ds
)paren
suffix:semicolon
DECL|macro|P
macro_line|#undef P
r_if
c_cond
(paren
id|err
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|to
op_assign
op_amp
id|buf-&gt;_st
(braket
l_int|0
)braket
suffix:semicolon
id|from
op_assign
(paren
r_struct
id|_fpxreg
op_star
)paren
op_amp
id|fxsave-&gt;st_space
(braket
l_int|0
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
comma
id|to
op_increment
comma
id|from
op_increment
)paren
(brace
r_if
c_cond
(paren
id|__copy_to_user
c_func
(paren
id|to
comma
id|from
comma
r_sizeof
(paren
op_star
id|to
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|restore_i387_ia32
r_int
id|restore_i387_ia32
c_func
(paren
r_struct
id|task_struct
op_star
id|tsk
comma
r_struct
id|_fpstate_ia32
id|__user
op_star
id|buf
comma
r_int
id|fsave
)paren
(brace
id|clear_fpu
c_func
(paren
id|tsk
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fsave
)paren
(brace
r_if
c_cond
(paren
id|__copy_from_user
c_func
(paren
op_amp
id|tsk-&gt;thread.i387.fxsave
comma
op_amp
id|buf-&gt;_fxsr_env
(braket
l_int|0
)braket
comma
r_sizeof
(paren
r_struct
id|i387_fxsave_struct
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|tsk-&gt;thread.i387.fxsave.mxcsr
op_and_assign
id|mxcsr_feature_mask
suffix:semicolon
id|set_stopped_child_used_math
c_func
(paren
id|tsk
)paren
suffix:semicolon
)brace
r_return
id|convert_fxsr_from_user
c_func
(paren
op_amp
id|tsk-&gt;thread.i387.fxsave
comma
id|buf
)paren
suffix:semicolon
)brace
DECL|function|save_i387_ia32
r_int
id|save_i387_ia32
c_func
(paren
r_struct
id|task_struct
op_star
id|tsk
comma
r_struct
id|_fpstate_ia32
id|__user
op_star
id|buf
comma
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|fsave
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|init_fpu
c_func
(paren
id|tsk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|convert_fxsr_to_user
c_func
(paren
id|buf
comma
op_amp
id|tsk-&gt;thread.i387.fxsave
comma
id|regs
comma
id|tsk
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|fsave
)paren
r_return
l_int|0
suffix:semicolon
id|err
op_or_assign
id|__put_user
c_func
(paren
id|tsk-&gt;thread.i387.fxsave.swd
comma
op_amp
id|buf-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fsave
)paren
r_return
id|err
ques
c_cond
op_minus
l_int|1
suffix:colon
l_int|1
suffix:semicolon
id|err
op_or_assign
id|__put_user
c_func
(paren
id|X86_FXSR_MAGIC
comma
op_amp
id|buf-&gt;magic
)paren
suffix:semicolon
id|err
op_or_assign
id|__copy_to_user
c_func
(paren
op_amp
id|buf-&gt;_fxsr_env
(braket
l_int|0
)braket
comma
op_amp
id|tsk-&gt;thread.i387.fxsave
comma
r_sizeof
(paren
r_struct
id|i387_fxsave_struct
)paren
)paren
suffix:semicolon
r_return
id|err
ques
c_cond
op_minus
l_int|1
suffix:colon
l_int|1
suffix:semicolon
)brace
eof
