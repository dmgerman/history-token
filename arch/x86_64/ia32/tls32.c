macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/user.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/desc.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/ldt.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/proto.h&gt;
multiline_comment|/*&n; * sys_alloc_thread_area: get a yet unused TLS descriptor index.&n; */
DECL|function|get_free_idx
r_static
r_int
id|get_free_idx
c_func
(paren
r_void
)paren
(brace
r_struct
id|thread_struct
op_star
id|t
op_assign
op_amp
id|current-&gt;thread
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|GDT_ENTRY_TLS_ENTRIES
suffix:semicolon
id|idx
op_increment
)paren
r_if
c_cond
(paren
id|desc_empty
c_func
(paren
(paren
r_struct
id|n_desc_struct
op_star
)paren
(paren
id|t-&gt;tls_array
)paren
op_plus
id|idx
)paren
)paren
r_return
id|idx
op_plus
id|GDT_ENTRY_TLS_MIN
suffix:semicolon
r_return
op_minus
id|ESRCH
suffix:semicolon
)brace
multiline_comment|/*&n; * Set a given TLS descriptor:&n; * When you want addresses &gt; 32bit use arch_prctl() &n; */
DECL|function|do_set_thread_area
r_int
id|do_set_thread_area
c_func
(paren
r_struct
id|thread_struct
op_star
id|t
comma
r_struct
id|user_desc
op_star
id|u_info
)paren
(brace
r_struct
id|user_desc
id|info
suffix:semicolon
r_struct
id|n_desc_struct
op_star
id|desc
suffix:semicolon
r_int
id|cpu
comma
id|idx
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info
comma
id|u_info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|idx
op_assign
id|info.entry_number
suffix:semicolon
multiline_comment|/*&n;&t; * index -1 means the kernel should try to find and&n;&t; * allocate an empty descriptor:&n;&t; */
r_if
c_cond
(paren
id|idx
op_eq
op_minus
l_int|1
)paren
(brace
id|idx
op_assign
id|get_free_idx
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idx
OL
l_int|0
)paren
r_return
id|idx
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|idx
comma
op_amp
id|u_info-&gt;entry_number
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|idx
template_param
id|GDT_ENTRY_TLS_MAX
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|desc
op_assign
(paren
(paren
r_struct
id|n_desc_struct
op_star
)paren
id|t-&gt;tls_array
)paren
op_plus
id|idx
op_minus
id|GDT_ENTRY_TLS_MIN
suffix:semicolon
multiline_comment|/*&n;&t; * We must not get preempted while modifying the TLS.&n;&t; */
id|cpu
op_assign
id|get_cpu
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|LDT_empty
c_func
(paren
op_amp
id|info
)paren
)paren
(brace
id|desc-&gt;a
op_assign
l_int|0
suffix:semicolon
id|desc-&gt;b
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|desc-&gt;a
op_assign
id|LDT_entry_a
c_func
(paren
op_amp
id|info
)paren
suffix:semicolon
id|desc-&gt;b
op_assign
id|LDT_entry_b
c_func
(paren
op_amp
id|info
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|t
op_eq
op_amp
id|current-&gt;thread
)paren
id|load_TLS
c_func
(paren
id|t
comma
id|cpu
)paren
suffix:semicolon
id|put_cpu
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sys32_set_thread_area
id|asmlinkage
r_int
id|sys32_set_thread_area
c_func
(paren
r_struct
id|user_desc
op_star
id|u_info
)paren
(brace
r_return
id|do_set_thread_area
c_func
(paren
op_amp
id|current-&gt;thread
comma
id|u_info
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Get the current Thread-Local Storage area:&n; */
DECL|macro|GET_BASE
mdefine_line|#define GET_BASE(desc) ( &bslash;&n;&t;(((desc)-&gt;a &gt;&gt; 16) &amp; 0x0000ffff) | &bslash;&n;&t;(((desc)-&gt;b &lt;&lt; 16) &amp; 0x00ff0000) | &bslash;&n;&t;( (desc)-&gt;b        &amp; 0xff000000)   )
DECL|macro|GET_LIMIT
mdefine_line|#define GET_LIMIT(desc) ( &bslash;&n;&t;((desc)-&gt;a &amp; 0x0ffff) | &bslash;&n;&t; ((desc)-&gt;b &amp; 0xf0000) )
DECL|macro|GET_32BIT
mdefine_line|#define GET_32BIT(desc)&t;&t;(((desc)-&gt;b &gt;&gt; 23) &amp; 1)
DECL|macro|GET_CONTENTS
mdefine_line|#define GET_CONTENTS(desc)&t;(((desc)-&gt;b &gt;&gt; 10) &amp; 3)
DECL|macro|GET_WRITABLE
mdefine_line|#define GET_WRITABLE(desc)&t;(((desc)-&gt;b &gt;&gt;  9) &amp; 1)
DECL|macro|GET_LIMIT_PAGES
mdefine_line|#define GET_LIMIT_PAGES(desc)&t;(((desc)-&gt;b &gt;&gt; 23) &amp; 1)
DECL|macro|GET_PRESENT
mdefine_line|#define GET_PRESENT(desc)&t;(((desc)-&gt;b &gt;&gt; 15) &amp; 1)
DECL|macro|GET_USEABLE
mdefine_line|#define GET_USEABLE(desc)&t;(((desc)-&gt;b &gt;&gt; 20) &amp; 1)
DECL|macro|GET_LONGMODE
mdefine_line|#define GET_LONGMODE(desc)&t;(((desc)-&gt;b &gt;&gt; 21) &amp; 1)
DECL|function|do_get_thread_area
r_int
id|do_get_thread_area
c_func
(paren
r_struct
id|thread_struct
op_star
id|t
comma
r_struct
id|user_desc
op_star
id|u_info
)paren
(brace
r_struct
id|user_desc
id|info
suffix:semicolon
r_struct
id|n_desc_struct
op_star
id|desc
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|idx
comma
op_amp
id|u_info-&gt;entry_number
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|idx
template_param
id|GDT_ENTRY_TLS_MAX
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|desc
op_assign
(paren
(paren
r_struct
id|n_desc_struct
op_star
)paren
id|t-&gt;tls_array
)paren
op_plus
id|idx
op_minus
id|GDT_ENTRY_TLS_MIN
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|user_desc
)paren
)paren
suffix:semicolon
id|info.entry_number
op_assign
id|idx
suffix:semicolon
id|info.base_addr
op_assign
id|GET_BASE
c_func
(paren
id|desc
)paren
suffix:semicolon
id|info.limit
op_assign
id|GET_LIMIT
c_func
(paren
id|desc
)paren
suffix:semicolon
id|info.seg_32bit
op_assign
id|GET_32BIT
c_func
(paren
id|desc
)paren
suffix:semicolon
id|info.contents
op_assign
id|GET_CONTENTS
c_func
(paren
id|desc
)paren
suffix:semicolon
id|info.read_exec_only
op_assign
op_logical_neg
id|GET_WRITABLE
c_func
(paren
id|desc
)paren
suffix:semicolon
id|info.limit_in_pages
op_assign
id|GET_LIMIT_PAGES
c_func
(paren
id|desc
)paren
suffix:semicolon
id|info.seg_not_present
op_assign
op_logical_neg
id|GET_PRESENT
c_func
(paren
id|desc
)paren
suffix:semicolon
id|info.useable
op_assign
id|GET_USEABLE
c_func
(paren
id|desc
)paren
suffix:semicolon
id|info.lm
op_assign
id|GET_LONGMODE
c_func
(paren
id|desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|u_info
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sys32_get_thread_area
id|asmlinkage
r_int
id|sys32_get_thread_area
c_func
(paren
r_struct
id|user_desc
op_star
id|u_info
)paren
(brace
r_return
id|do_get_thread_area
c_func
(paren
op_amp
id|current-&gt;thread
comma
id|u_info
)paren
suffix:semicolon
)brace
DECL|function|ia32_child_tls
r_int
id|ia32_child_tls
c_func
(paren
r_struct
id|task_struct
op_star
id|p
comma
r_struct
id|pt_regs
op_star
id|childregs
)paren
(brace
r_struct
id|n_desc_struct
op_star
id|desc
suffix:semicolon
r_struct
id|user_desc
id|info
comma
op_star
id|cp
suffix:semicolon
r_int
id|idx
suffix:semicolon
id|cp
op_assign
(paren
r_void
op_star
)paren
id|childregs-&gt;rsi
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info
comma
id|cp
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|LDT_empty
c_func
(paren
op_amp
id|info
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|idx
op_assign
id|info.entry_number
suffix:semicolon
r_if
c_cond
(paren
id|idx
template_param
id|GDT_ENTRY_TLS_MAX
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|desc
op_assign
(paren
r_struct
id|n_desc_struct
op_star
)paren
(paren
id|p-&gt;thread.tls_array
)paren
op_plus
id|idx
op_minus
id|GDT_ENTRY_TLS_MIN
suffix:semicolon
id|desc-&gt;a
op_assign
id|LDT_entry_a
c_func
(paren
op_amp
id|info
)paren
suffix:semicolon
id|desc-&gt;b
op_assign
id|LDT_entry_b
c_func
(paren
op_amp
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
