multiline_comment|/* Various gunk just to reboot the machine. */
macro_line|#include &lt;linux/reboot.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/kdebug.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;asm/hw_irq.h&gt;
multiline_comment|/*&n; * Power off function, if any&n; */
DECL|variable|pm_power_off
r_void
(paren
op_star
id|pm_power_off
)paren
(paren
r_void
)paren
suffix:semicolon
DECL|variable|no_idt
r_static
r_int
id|no_idt
(braket
l_int|3
)braket
suffix:semicolon
DECL|variable|reboot_mode
r_static
r_int
id|reboot_mode
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
DECL|variable|reboot_smp
r_int
id|reboot_smp
op_assign
l_int|0
suffix:semicolon
DECL|variable|reboot_cpu
r_static
r_int
id|reboot_cpu
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#endif
DECL|function|reboot_setup
r_static
r_int
id|__init
id|reboot_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_switch
c_cond
(paren
op_star
id|str
)paren
(brace
r_case
l_char|&squot;w&squot;
suffix:colon
multiline_comment|/* &quot;warm&quot; reboot (no memory testing etc) */
id|reboot_mode
op_assign
l_int|0x1234
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;c&squot;
suffix:colon
multiline_comment|/* &quot;cold&quot; reboot (with memory testing etc) */
id|reboot_mode
op_assign
l_int|0x0
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_SMP
r_case
l_char|&squot;s&squot;
suffix:colon
multiline_comment|/* &quot;smp&quot; reboot by executing reset on BSP or other CPU*/
id|reboot_smp
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|isdigit
c_func
(paren
id|str
(braket
l_int|1
)braket
)paren
)paren
id|sscanf
c_func
(paren
id|str
op_plus
l_int|1
comma
l_string|&quot;%d&quot;
comma
op_amp
id|reboot_cpu
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|str
comma
l_string|&quot;smp&quot;
comma
l_int|3
)paren
)paren
id|sscanf
c_func
(paren
id|str
op_plus
l_int|3
comma
l_string|&quot;%d&quot;
comma
op_amp
id|reboot_cpu
)paren
suffix:semicolon
multiline_comment|/* we will leave sorting out the final value &n;&t;&t;&t;&t;when we are ready to reboot, since we might not&n; &t;&t;&t;&t;have set up boot_cpu_id or smp_num_cpu */
r_break
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
(paren
id|str
op_assign
id|strchr
c_func
(paren
id|str
comma
l_char|&squot;,&squot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|str
op_increment
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;reboot=&quot;
comma
id|reboot_setup
)paren
suffix:semicolon
DECL|function|kb_wait
r_static
r_inline
r_void
id|kb_wait
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x10000
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|inb_p
c_func
(paren
l_int|0x64
)paren
op_amp
l_int|0x02
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
DECL|function|machine_restart
r_void
id|machine_restart
c_func
(paren
r_char
op_star
id|__unused
)paren
(brace
macro_line|#if CONFIG_SMP
r_int
id|cpuid
suffix:semicolon
id|cpuid
op_assign
id|GET_APIC_ID
c_func
(paren
id|apic_read
c_func
(paren
id|APIC_ID
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reboot_smp
)paren
(brace
multiline_comment|/* check to see if reboot_cpu is valid &n;&t;&t;   if its not, default to the BSP */
r_if
c_cond
(paren
(paren
id|reboot_cpu
op_eq
op_minus
l_int|1
)paren
op_logical_or
(paren
id|reboot_cpu
OG
(paren
id|NR_CPUS
op_minus
l_int|1
)paren
)paren
op_logical_or
op_logical_neg
(paren
id|phys_cpu_present_map
op_amp
(paren
l_int|1
op_lshift
id|cpuid
)paren
)paren
)paren
id|reboot_cpu
op_assign
id|boot_cpu_id
suffix:semicolon
id|reboot_smp
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* use this as a flag to only go through this once*/
multiline_comment|/* re-run this function on the other CPUs&n;&t;&t;   it will fall though this section since we have &n;&t;&t;   cleared reboot_smp, and do the reboot if it is the&n;&t;&t;   correct CPU, otherwise it halts. */
r_if
c_cond
(paren
id|reboot_cpu
op_ne
id|cpuid
)paren
id|smp_call_function
c_func
(paren
(paren
r_void
op_star
)paren
id|machine_restart
comma
l_int|NULL
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* if reboot_cpu is still -1, then we want a tradional reboot, &n;&t;   and if we are not running on the reboot_cpu,, halt */
r_if
c_cond
(paren
(paren
id|reboot_cpu
op_ne
op_minus
l_int|1
)paren
op_logical_and
(paren
id|cpuid
op_ne
id|reboot_cpu
)paren
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
id|__asm__
id|__volatile__
(paren
l_string|&quot;hlt&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Stop all CPUs and turn off local APICs and the IO-APIC, so&n;&t; * other OSs see a clean IRQ state.&n;&t; */
id|smp_send_stop
c_func
(paren
)paren
suffix:semicolon
id|disable_IO_APIC
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* rebooting needs to touch the page at absolute addr 0 */
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|__va
c_func
(paren
l_int|0x472
)paren
)paren
op_assign
id|reboot_mode
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* First fondle with the keyboard controller. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100
suffix:semicolon
id|i
op_increment
)paren
(brace
id|kb_wait
c_func
(paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xfe
comma
l_int|0x64
)paren
suffix:semicolon
multiline_comment|/* pulse reset low */
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
)brace
multiline_comment|/* Could do reset through the northbridge of Hammer here. */
multiline_comment|/* That didn&squot;t work - force a triple fault.. */
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;lidt %0&quot;
suffix:colon
suffix:colon
l_string|&quot;m&quot;
(paren
id|no_idt
)paren
)paren
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;int3&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|machine_halt
r_void
id|machine_halt
c_func
(paren
r_void
)paren
(brace
)brace
DECL|function|machine_power_off
r_void
id|machine_power_off
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|pm_power_off
)paren
id|pm_power_off
c_func
(paren
)paren
suffix:semicolon
)brace
eof
