multiline_comment|/* &n; * Firmware replacement code.&n; * &n; * Work around broken BIOSes that don&squot;t set an aperture. &n; * The IOMMU code needs an aperture even who no AGP is present in the system.&n; * Map the aperture over some low memory.  This is cheaper than doing bounce &n; * buffering. The memory is lost. This is done at early boot because only&n; * the bootmem allocator can allocate 32+MB. &n; * &n; * Copyright 2002 Andi Kleen, SuSE Labs.&n; * $Id: aperture.c,v 1.2 2002/09/19 19:25:32 ak Exp $&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;linux/mmzone.h&gt;
macro_line|#include &lt;linux/pci_ids.h&gt;
macro_line|#include &lt;asm/e820.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/proto.h&gt;
macro_line|#include &lt;asm/pci-direct.h&gt;
DECL|variable|__initdata
r_int
id|fallback_aper_order
id|__initdata
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* 64MB */
DECL|variable|__initdata
r_int
id|fallback_aper_force
id|__initdata
op_assign
l_int|0
suffix:semicolon
r_extern
r_int
id|no_iommu
comma
id|force_mmu
suffix:semicolon
multiline_comment|/* This code runs before the PCI subsystem is initialized, so just &n;   access the northbridge directly. */
DECL|macro|NB_ID_3
mdefine_line|#define NB_ID_3 (PCI_VENDOR_ID_AMD | (0x1103&lt;&lt;16))
DECL|function|allocate_aperture
r_static
id|u32
id|__init
id|allocate_aperture
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_DISCONTIGMEM
id|pg_data_t
op_star
id|nd0
op_assign
id|NODE_DATA
c_func
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#else
id|pg_data_t
op_star
id|nd0
op_assign
op_amp
id|contig_page_data
suffix:semicolon
macro_line|#endif&t;
id|u32
id|aper_size
suffix:semicolon
r_void
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|fallback_aper_order
OG
l_int|7
)paren
id|fallback_aper_order
op_assign
l_int|7
suffix:semicolon
id|aper_size
op_assign
(paren
l_int|32
op_star
l_int|1024
op_star
l_int|1024
)paren
op_lshift
id|fallback_aper_order
suffix:semicolon
multiline_comment|/* &n;         * Aperture has to be naturally aligned it seems. This means an&n;&t; * 2GB aperture won&squot;t have much changes to succeed in the lower 4GB of &n;&t; * memory. Unfortunately we cannot move it up because that would make&n;&t; * the IOMMU useless.&n;&t; */
id|p
op_assign
id|__alloc_bootmem_node
c_func
(paren
id|nd0
comma
id|aper_size
comma
id|aper_size
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
op_logical_or
id|__pa
c_func
(paren
id|p
)paren
op_plus
id|aper_size
OG
l_int|0xffffffff
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Cannot allocate aperture memory hole (%p,%uK)&bslash;n&quot;
comma
id|p
comma
id|aper_size
op_rshift
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
id|free_bootmem_node
c_func
(paren
id|nd0
comma
(paren
r_int
r_int
)paren
id|p
comma
id|aper_size
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;Mapping aperture over %d KB of RAM @ %lx&bslash;n&quot;
comma
id|aper_size
op_rshift
l_int|10
comma
id|__pa
c_func
(paren
id|p
)paren
)paren
suffix:semicolon
r_return
(paren
id|u32
)paren
id|__pa
c_func
(paren
id|p
)paren
suffix:semicolon
)brace
DECL|function|iommu_hole_init
r_void
id|__init
id|iommu_hole_init
c_func
(paren
r_void
)paren
(brace
r_int
id|fix
comma
id|num
suffix:semicolon
id|u32
id|aper_size
comma
id|aper_alloc
comma
id|aper_order
suffix:semicolon
id|u64
id|aper_base
suffix:semicolon
r_if
c_cond
(paren
id|no_iommu
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|end_pfn
OL
(paren
l_int|0xffffffff
op_rshift
id|PAGE_SHIFT
)paren
op_logical_and
op_logical_neg
id|force_mmu
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Checking aperture...&bslash;n&quot;
)paren
suffix:semicolon
id|fix
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|num
op_assign
l_int|24
suffix:semicolon
id|num
OL
l_int|32
suffix:semicolon
id|num
op_increment
)paren
(brace
r_if
c_cond
(paren
id|read_pci_config
c_func
(paren
l_int|0
comma
id|num
comma
l_int|3
comma
l_int|0x00
)paren
op_ne
id|NB_ID_3
)paren
r_continue
suffix:semicolon
id|aper_order
op_assign
(paren
id|read_pci_config
c_func
(paren
l_int|0
comma
id|num
comma
l_int|3
comma
l_int|0x90
)paren
op_rshift
l_int|1
)paren
op_amp
l_int|7
suffix:semicolon
id|aper_size
op_assign
(paren
l_int|32
op_star
l_int|1024
op_star
l_int|1024
)paren
op_lshift
id|aper_order
suffix:semicolon
id|aper_base
op_assign
id|read_pci_config
c_func
(paren
l_int|0
comma
id|num
comma
l_int|3
comma
l_int|0x94
)paren
op_amp
l_int|0x7fff
suffix:semicolon
id|aper_base
op_lshift_assign
l_int|25
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;CPU %d: aperture @ %Lx size %u KB&bslash;n&quot;
comma
id|num
op_minus
l_int|24
comma
id|aper_base
comma
id|aper_size
op_rshift
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|aper_base
op_logical_or
id|aper_base
op_plus
id|aper_size
op_ge
l_int|0xffffffff
)paren
(brace
id|fix
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|e820_mapped
c_func
(paren
id|aper_base
comma
id|aper_base
op_plus
id|aper_size
comma
id|E820_RAM
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Aperture pointing to e820 RAM. Ignoring.&bslash;n&quot;
)paren
suffix:semicolon
id|fix
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|fix
op_logical_and
op_logical_neg
id|fallback_aper_force
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Your BIOS is broken and doesn&squot;t leave a aperture memory hole&bslash;n&quot;
)paren
suffix:semicolon
id|aper_alloc
op_assign
id|allocate_aperture
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|aper_alloc
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|num
op_assign
l_int|24
suffix:semicolon
id|num
OL
l_int|32
suffix:semicolon
id|num
op_increment
)paren
(brace
r_if
c_cond
(paren
id|read_pci_config
c_func
(paren
l_int|0
comma
id|num
comma
l_int|3
comma
l_int|0x00
)paren
op_ne
id|NB_ID_3
)paren
r_continue
suffix:semicolon
multiline_comment|/* Don&squot;t enable translation yet. That is done later. &n;&t;&t;   Assume this BIOS didn&squot;t initialise the GART so &n;&t;&t;   just overwrite all previous bits */
id|write_pci_config
c_func
(paren
l_int|0
comma
id|num
comma
l_int|3
comma
l_int|0x90
comma
id|fallback_aper_order
op_lshift
l_int|1
)paren
suffix:semicolon
id|write_pci_config
c_func
(paren
l_int|0
comma
id|num
comma
l_int|3
comma
l_int|0x94
comma
id|aper_alloc
op_rshift
l_int|25
)paren
suffix:semicolon
)brace
)brace
eof
