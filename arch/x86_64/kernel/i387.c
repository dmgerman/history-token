multiline_comment|/*&n; *  linux/arch/x86_64/kernel/i387.c&n; *&n; *  Copyright (C) 1994 Linus Torvalds&n; *  Copyright (C) 2002 Andi Kleen, SuSE Labs&n; *&n; *  Pentium III FXSR, SSE support&n; *  General FPU state handling cleanups&n; *&t;Gareth Hughes &lt;gareth@valinux.com&gt;, May 2000&n; * &n; *  x86-64 rework 2002 Andi Kleen. &n; *  Does direct fxsave in and out of user space now for signal handlers.&n; *  All the FSAVE&lt;-&gt;FXSAVE conversion code has been moved to the 32bit emulation,&n; *  the 64bit user space sees a FXSAVE frame directly. &n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/i387.h&gt;
macro_line|#include &lt;asm/sigcontext.h&gt;
macro_line|#include &lt;asm/user.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|variable|init_fpu_env
r_static
r_struct
id|i387_fxsave_struct
id|init_fpu_env
suffix:semicolon
multiline_comment|/*&n; * Called at bootup to set up the initial FPU state that is later cloned&n; * into all processes.&n; */
DECL|function|fpu_init
r_void
id|__init
id|fpu_init
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|oldcr0
op_assign
id|read_cr0
c_func
(paren
)paren
suffix:semicolon
r_extern
r_void
id|__bad_fxsave_alignment
c_func
(paren
r_void
)paren
suffix:semicolon
r_if
c_cond
(paren
m_offsetof
(paren
r_struct
id|task_struct
comma
id|thread.i387.fxsave
)paren
op_amp
l_int|15
)paren
id|__bad_fxsave_alignment
c_func
(paren
)paren
suffix:semicolon
id|set_in_cr4
c_func
(paren
id|X86_CR4_OSFXSR
)paren
suffix:semicolon
id|set_in_cr4
c_func
(paren
id|X86_CR4_OSXMMEXCPT
)paren
suffix:semicolon
id|write_cr0
c_func
(paren
id|oldcr0
op_amp
op_complement
(paren
(paren
l_int|1UL
op_lshift
l_int|3
)paren
op_or
(paren
l_int|1UL
op_lshift
l_int|2
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* clear TS and EM */
id|asm
c_func
(paren
l_string|&quot;fninit&quot;
)paren
suffix:semicolon
id|load_mxcsr
c_func
(paren
l_int|0x1f80
)paren
suffix:semicolon
multiline_comment|/* initialize MMX state. normally this will be covered by fninit, but the &n;&t;   architecture doesn&squot;t guarantee it so do it explicitely. */
id|asm
r_volatile
(paren
l_string|&quot;movq %0,%%mm0&bslash;n&bslash;t&quot;
l_string|&quot;movq %%mm0,%%mm1&bslash;n&bslash;t&quot;
l_string|&quot;movq %%mm0,%%mm2&bslash;n&bslash;t&quot;
l_string|&quot;movq %%mm0,%%mm3&bslash;n&bslash;t&quot;
l_string|&quot;movq %%mm0,%%mm4&bslash;n&bslash;t&quot;
l_string|&quot;movq %%mm0,%%mm5&bslash;n&bslash;t&quot;
l_string|&quot;movq %%mm0,%%mm6&bslash;n&bslash;t&quot;
l_string|&quot;movq %%mm0,%%mm7&bslash;n&bslash;t&quot;
op_scope_resolution
l_string|&quot;m&quot;
(paren
l_int|0ULL
)paren
)paren
suffix:semicolon
id|asm
c_func
(paren
l_string|&quot;emms&quot;
)paren
suffix:semicolon
multiline_comment|/* initialize XMM state */
id|asm
c_func
(paren
l_string|&quot;xorpd %xmm0,%xmm0&quot;
)paren
suffix:semicolon
id|asm
c_func
(paren
l_string|&quot;xorpd %xmm1,%xmm1&quot;
)paren
suffix:semicolon
id|asm
c_func
(paren
l_string|&quot;xorpd %xmm2,%xmm2&quot;
)paren
suffix:semicolon
id|asm
c_func
(paren
l_string|&quot;xorpd %xmm3,%xmm3&quot;
)paren
suffix:semicolon
id|asm
c_func
(paren
l_string|&quot;xorpd %xmm4,%xmm4&quot;
)paren
suffix:semicolon
id|asm
c_func
(paren
l_string|&quot;xorpd %xmm5,%xmm5&quot;
)paren
suffix:semicolon
id|asm
c_func
(paren
l_string|&quot;xorpd %xmm6,%xmm6&quot;
)paren
suffix:semicolon
id|asm
c_func
(paren
l_string|&quot;xorpd %xmm7,%xmm7&quot;
)paren
suffix:semicolon
id|asm
c_func
(paren
l_string|&quot;xorpd %xmm8,%xmm8&quot;
)paren
suffix:semicolon
id|asm
c_func
(paren
l_string|&quot;xorpd %xmm9,%xmm9&quot;
)paren
suffix:semicolon
id|asm
c_func
(paren
l_string|&quot;xorpd %xmm10,%xmm10&quot;
)paren
suffix:semicolon
id|asm
c_func
(paren
l_string|&quot;xorpd %xmm11,%xmm11&quot;
)paren
suffix:semicolon
id|asm
c_func
(paren
l_string|&quot;xorpd %xmm12,%xmm12&quot;
)paren
suffix:semicolon
id|asm
c_func
(paren
l_string|&quot;xorpd %xmm13,%xmm13&quot;
)paren
suffix:semicolon
id|asm
c_func
(paren
l_string|&quot;xorpd %xmm14,%xmm14&quot;
)paren
suffix:semicolon
id|asm
c_func
(paren
l_string|&quot;xorpd %xmm15,%xmm15&quot;
)paren
suffix:semicolon
id|load_mxcsr
c_func
(paren
l_int|0x1f80
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;fxsave %0&quot;
suffix:colon
l_string|&quot;=m&quot;
(paren
id|init_fpu_env
)paren
)paren
suffix:semicolon
multiline_comment|/* clean state in init */
id|stts
c_func
(paren
)paren
suffix:semicolon
id|clear_thread_flag
c_func
(paren
id|TIF_USEDFPU
)paren
suffix:semicolon
id|current-&gt;used_math
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * The _current_ task is using the FPU for the first time&n; * so initialize it and set the mxcsr to its default.&n; * remeber the current task has used the FPU.&n; */
DECL|function|init_fpu
r_void
id|init_fpu
c_func
(paren
r_void
)paren
(brace
macro_line|#if 0
id|asm
c_func
(paren
l_string|&quot;fninit&quot;
)paren
suffix:semicolon
id|load_mxcsr
c_func
(paren
l_int|0x1f80
)paren
suffix:semicolon
macro_line|#else
id|asm
r_volatile
(paren
l_string|&quot;fxrstor %0&quot;
op_scope_resolution
l_string|&quot;m&quot;
(paren
id|init_fpu_env
)paren
)paren
suffix:semicolon
macro_line|#endif
id|current-&gt;used_math
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Signal frame handlers.&n; */
DECL|function|save_i387
r_int
id|save_i387
c_func
(paren
r_struct
id|_fpstate
op_star
id|buf
)paren
(brace
r_struct
id|task_struct
op_star
id|tsk
op_assign
id|current
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
(brace
r_extern
r_void
id|bad_user_i387_struct
c_func
(paren
r_void
)paren
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
r_struct
id|user_i387_struct
)paren
op_ne
r_sizeof
(paren
id|tsk-&gt;thread.i387.fxsave
)paren
)paren
id|bad_user_i387_struct
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|tsk-&gt;used_math
)paren
r_return
l_int|0
suffix:semicolon
id|tsk-&gt;used_math
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* trigger finit */
r_if
c_cond
(paren
id|test_thread_flag
c_func
(paren
id|TIF_USEDFPU
)paren
)paren
(brace
id|err
op_assign
id|save_i387_checking
c_func
(paren
(paren
r_struct
id|i387_fxsave_struct
op_star
)paren
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|stts
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|__copy_to_user
c_func
(paren
id|buf
comma
op_amp
id|tsk-&gt;thread.i387.fxsave
comma
r_sizeof
(paren
r_struct
id|i387_fxsave_struct
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * ptrace request handlers.&n; */
DECL|function|get_fpregs
r_int
id|get_fpregs
c_func
(paren
r_struct
id|user_i387_struct
op_star
id|buf
comma
r_struct
id|task_struct
op_star
id|tsk
)paren
(brace
id|empty_fpu
c_func
(paren
id|tsk
)paren
suffix:semicolon
r_return
id|__copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|buf
comma
op_amp
id|tsk-&gt;thread.i387.fxsave
comma
r_sizeof
(paren
r_struct
id|user_i387_struct
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|set_fpregs
r_int
id|set_fpregs
c_func
(paren
r_struct
id|task_struct
op_star
id|tsk
comma
r_struct
id|user_i387_struct
op_star
id|buf
)paren
(brace
r_if
c_cond
(paren
id|__copy_from_user
c_func
(paren
op_amp
id|tsk-&gt;thread.i387.fxsave
comma
id|buf
comma
r_sizeof
(paren
r_struct
id|user_i387_struct
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * FPU state for core dumps.&n; */
DECL|function|dump_fpu
r_int
id|dump_fpu
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
r_struct
id|user_i387_struct
op_star
id|fpu
)paren
(brace
r_struct
id|task_struct
op_star
id|tsk
op_assign
id|current
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tsk-&gt;used_math
)paren
r_return
l_int|0
suffix:semicolon
id|unlazy_fpu
c_func
(paren
id|tsk
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|fpu
comma
op_amp
id|tsk-&gt;thread.i387.fxsave
comma
r_sizeof
(paren
r_struct
id|user_i387_struct
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
eof
