multiline_comment|/*&n; * Intel specific MCE features.&n; * Copyright 2004 Zwane Mwaikambo &lt;zwane@linuxpower.ca&gt;&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/percpu.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/msr.h&gt;
macro_line|#include &lt;asm/mce.h&gt;
macro_line|#include &lt;asm/hw_irq.h&gt;
r_static
id|DEFINE_PER_CPU
c_func
(paren
r_int
r_int
comma
id|next_check
)paren
suffix:semicolon
DECL|function|smp_thermal_interrupt
id|asmlinkage
r_void
id|smp_thermal_interrupt
c_func
(paren
r_void
)paren
(brace
r_struct
id|mce
id|m
suffix:semicolon
id|ack_APIC_irq
c_func
(paren
)paren
suffix:semicolon
id|irq_enter
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_before
c_func
(paren
id|jiffies
comma
id|__get_cpu_var
c_func
(paren
id|next_check
)paren
)paren
)paren
r_goto
id|done
suffix:semicolon
id|__get_cpu_var
c_func
(paren
id|next_check
)paren
op_assign
id|jiffies
op_plus
id|HZ
op_star
l_int|300
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|m
comma
l_int|0
comma
r_sizeof
(paren
id|m
)paren
)paren
suffix:semicolon
id|m.cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
id|m.bank
op_assign
id|MCE_THERMAL_BANK
suffix:semicolon
id|rdtscll
c_func
(paren
id|m.tsc
)paren
suffix:semicolon
id|rdmsrl
c_func
(paren
id|MSR_IA32_THERM_STATUS
comma
id|m.status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m.status
op_amp
l_int|0x1
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;CPU%d: Temperature above threshold, cpu clock throttled&bslash;n&quot;
comma
id|m.cpu
)paren
suffix:semicolon
id|add_taint
c_func
(paren
id|TAINT_MACHINE_CHECK
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;CPU%d: Temperature/speed normal&bslash;n&quot;
comma
id|m.cpu
)paren
suffix:semicolon
)brace
id|mce_log
c_func
(paren
op_amp
id|m
)paren
suffix:semicolon
id|done
suffix:colon
id|irq_exit
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|intel_init_thermal
r_static
r_void
id|__init
id|intel_init_thermal
c_func
(paren
r_struct
id|cpuinfo_x86
op_star
id|c
)paren
(brace
id|u32
id|l
comma
id|h
suffix:semicolon
r_int
id|tm2
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpu_has
c_func
(paren
id|c
comma
id|X86_FEATURE_ACPI
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpu_has
c_func
(paren
id|c
comma
id|X86_FEATURE_ACC
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* first check if TM1 is already enabled by the BIOS, in which&n;&t; * case there might be some SMM goo which handles it, so we can&squot;t even&n;&t; * put a handler since it might be delivered via SMI already.&n;&t; */
id|rdmsr
c_func
(paren
id|MSR_IA32_MISC_ENABLE
comma
id|l
comma
id|h
)paren
suffix:semicolon
id|h
op_assign
id|apic_read
c_func
(paren
id|APIC_LVTTHMR
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|l
op_amp
(paren
l_int|1
op_lshift
l_int|3
)paren
)paren
op_logical_and
(paren
id|h
op_amp
id|APIC_DM_SMI
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;CPU%d: Thermal monitoring handled by SMI&bslash;n&quot;
comma
id|cpu
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cpu_has
c_func
(paren
id|c
comma
id|X86_FEATURE_TM2
)paren
op_logical_and
(paren
id|l
op_amp
(paren
l_int|1
op_lshift
l_int|13
)paren
)paren
)paren
id|tm2
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|h
op_amp
id|APIC_VECTOR_MASK
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;CPU%d: Thermal LVT vector (%#x) already &quot;
l_string|&quot;installed&bslash;n&quot;
comma
id|cpu
comma
(paren
id|h
op_amp
id|APIC_VECTOR_MASK
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|h
op_assign
id|THERMAL_APIC_VECTOR
suffix:semicolon
id|h
op_or_assign
(paren
id|APIC_DM_FIXED
op_or
id|APIC_LVT_MASKED
)paren
suffix:semicolon
id|apic_write_around
c_func
(paren
id|APIC_LVTTHMR
comma
id|h
)paren
suffix:semicolon
id|rdmsr
c_func
(paren
id|MSR_IA32_THERM_INTERRUPT
comma
id|l
comma
id|h
)paren
suffix:semicolon
id|wrmsr
c_func
(paren
id|MSR_IA32_THERM_INTERRUPT
comma
id|l
op_or
l_int|0x03
comma
id|h
)paren
suffix:semicolon
id|rdmsr
c_func
(paren
id|MSR_IA32_MISC_ENABLE
comma
id|l
comma
id|h
)paren
suffix:semicolon
id|wrmsr
c_func
(paren
id|MSR_IA32_MISC_ENABLE
comma
id|l
op_or
(paren
l_int|1
op_lshift
l_int|3
)paren
comma
id|h
)paren
suffix:semicolon
id|l
op_assign
id|apic_read
c_func
(paren
id|APIC_LVTTHMR
)paren
suffix:semicolon
id|apic_write_around
c_func
(paren
id|APIC_LVTTHMR
comma
id|l
op_amp
op_complement
id|APIC_LVT_MASKED
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;CPU%d: Thermal monitoring enabled (%s)&bslash;n&quot;
comma
id|cpu
comma
id|tm2
ques
c_cond
l_string|&quot;TM2&quot;
suffix:colon
l_string|&quot;TM1&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|mce_intel_feature_init
r_void
id|__init
id|mce_intel_feature_init
c_func
(paren
r_struct
id|cpuinfo_x86
op_star
id|c
)paren
(brace
id|intel_init_thermal
c_func
(paren
id|c
)paren
suffix:semicolon
)brace
eof
