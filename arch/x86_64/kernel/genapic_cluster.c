multiline_comment|/*&n; * Copyright 2004 James Cleverdon, IBM.&n; * Subject to the GNU Public License, v.2&n; *&n; * Clustered APIC subarch code.  Up to 255 CPUs, physical delivery.&n; * (A more realistic maximum is around 230 CPUs.)&n; *&n; * Hacked for x86-64 by James Cleverdon from i386 architecture code by&n; * Martin Bligh, Andi Kleen, James Bottomley, John Stultz, and&n; * James Cleverdon.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/threads.h&gt;
macro_line|#include &lt;linux/cpumask.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/smp.h&gt;
macro_line|#include &lt;asm/ipi.h&gt;
multiline_comment|/*&n; * Set up the logical destination ID.&n; *&n; * Intel recommends to set DFR, LDR and TPR before enabling&n; * an APIC.  See e.g. &quot;AP-388 82489DX User&squot;s Manual&quot; (Intel&n; * document number 292116).  So here it goes...&n; */
DECL|function|cluster_init_apic_ldr
r_static
r_void
id|cluster_init_apic_ldr
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|val
comma
id|id
suffix:semicolon
r_int
id|i
comma
id|count
suffix:semicolon
id|u8
id|lid
suffix:semicolon
id|u8
id|my_id
op_assign
id|hard_smp_processor_id
c_func
(paren
)paren
suffix:semicolon
id|u8
id|my_cluster
op_assign
id|APIC_CLUSTER
c_func
(paren
id|my_id
)paren
suffix:semicolon
multiline_comment|/* Create logical APIC IDs by counting CPUs already in cluster. */
r_for
c_loop
(paren
id|count
op_assign
l_int|0
comma
id|i
op_assign
id|NR_CPUS
suffix:semicolon
op_decrement
id|i
op_ge
l_int|0
suffix:semicolon
)paren
(brace
id|lid
op_assign
id|x86_cpu_to_log_apicid
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|lid
op_ne
id|BAD_APICID
op_logical_and
id|APIC_CLUSTER
c_func
(paren
id|lid
)paren
op_eq
id|my_cluster
)paren
op_increment
id|count
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * We only have a 4 wide bitmap in cluster mode.  There&squot;s no way&n;&t; * to get above 60 CPUs and still give each one it&squot;s own bit.&n;&t; * But, we&squot;re using physical IRQ delivery, so we don&squot;t care.&n;&t; * Use bit 3 for the 4th through Nth CPU in each cluster.&n;&t; */
r_if
c_cond
(paren
id|count
op_ge
id|XAPIC_DEST_CPUS_SHIFT
)paren
id|count
op_assign
l_int|3
suffix:semicolon
id|id
op_assign
id|my_cluster
op_or
(paren
l_int|1UL
op_lshift
id|count
)paren
suffix:semicolon
id|x86_cpu_to_log_apicid
(braket
id|smp_processor_id
c_func
(paren
)paren
)braket
op_assign
id|id
suffix:semicolon
id|apic_write_around
c_func
(paren
id|APIC_DFR
comma
id|APIC_DFR_CLUSTER
)paren
suffix:semicolon
id|val
op_assign
id|apic_read
c_func
(paren
id|APIC_LDR
)paren
op_amp
op_complement
id|APIC_LDR_MASK
suffix:semicolon
id|val
op_or_assign
id|SET_APIC_LOGICAL_ID
c_func
(paren
id|id
)paren
suffix:semicolon
id|apic_write_around
c_func
(paren
id|APIC_LDR
comma
id|val
)paren
suffix:semicolon
)brace
multiline_comment|/* Start with all IRQs pointing to boot CPU.  IRQ balancing will shift them. */
DECL|function|cluster_target_cpus
r_static
id|cpumask_t
id|cluster_target_cpus
c_func
(paren
r_void
)paren
(brace
r_return
id|cpumask_of_cpu
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|cluster_send_IPI_mask
r_static
r_void
id|cluster_send_IPI_mask
c_func
(paren
id|cpumask_t
id|mask
comma
r_int
id|vector
)paren
(brace
id|send_IPI_mask_sequence
c_func
(paren
id|mask
comma
id|vector
)paren
suffix:semicolon
)brace
DECL|function|cluster_send_IPI_allbutself
r_static
r_void
id|cluster_send_IPI_allbutself
c_func
(paren
r_int
id|vector
)paren
(brace
id|cpumask_t
id|mask
op_assign
id|cpu_online_map
suffix:semicolon
id|cpu_clear
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
id|mask
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpus_empty
c_func
(paren
id|mask
)paren
)paren
id|cluster_send_IPI_mask
c_func
(paren
id|mask
comma
id|vector
)paren
suffix:semicolon
)brace
DECL|function|cluster_send_IPI_all
r_static
r_void
id|cluster_send_IPI_all
c_func
(paren
r_int
id|vector
)paren
(brace
id|cluster_send_IPI_mask
c_func
(paren
id|cpu_online_map
comma
id|vector
)paren
suffix:semicolon
)brace
DECL|function|cluster_apic_id_registered
r_static
r_int
id|cluster_apic_id_registered
c_func
(paren
r_void
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|cluster_cpu_mask_to_apicid
r_static
r_int
r_int
id|cluster_cpu_mask_to_apicid
c_func
(paren
id|cpumask_t
id|cpumask
)paren
(brace
r_int
id|cpu
suffix:semicolon
multiline_comment|/*&n;&t; * We&squot;re using fixed IRQ delivery, can only return one phys APIC ID.&n;&t; * May as well be the first.&n;&t; */
id|cpu
op_assign
id|first_cpu
c_func
(paren
id|cpumask
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|cpu
OL
id|NR_CPUS
)paren
r_return
id|x86_cpu_to_apicid
(braket
id|cpu
)braket
suffix:semicolon
r_else
r_return
id|BAD_APICID
suffix:semicolon
)brace
multiline_comment|/* cpuid returns the value latched in the HW at reset, not the APIC ID&n; * register&squot;s value.  For any box whose BIOS changes APIC IDs, like&n; * clustered APIC systems, we must use hard_smp_processor_id.&n; *&n; * See Intel&squot;s IA-32 SW Dev&squot;s Manual Vol2 under CPUID.&n; */
DECL|function|phys_pkg_id
r_static
r_int
r_int
id|phys_pkg_id
c_func
(paren
r_int
id|index_msb
)paren
(brace
r_return
id|hard_smp_processor_id
c_func
(paren
)paren
op_rshift
id|index_msb
suffix:semicolon
)brace
DECL|variable|apic_cluster
r_struct
id|genapic
id|apic_cluster
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;clustered&quot;
comma
dot
id|int_delivery_mode
op_assign
id|dest_Fixed
comma
dot
id|int_dest_mode
op_assign
(paren
id|APIC_DEST_PHYSICAL
op_ne
l_int|0
)paren
comma
dot
id|int_delivery_dest
op_assign
id|APIC_DEST_PHYSICAL
op_or
id|APIC_DM_FIXED
comma
dot
id|target_cpus
op_assign
id|cluster_target_cpus
comma
dot
id|apic_id_registered
op_assign
id|cluster_apic_id_registered
comma
dot
id|init_apic_ldr
op_assign
id|cluster_init_apic_ldr
comma
dot
id|send_IPI_all
op_assign
id|cluster_send_IPI_all
comma
dot
id|send_IPI_allbutself
op_assign
id|cluster_send_IPI_allbutself
comma
dot
id|send_IPI_mask
op_assign
id|cluster_send_IPI_mask
comma
dot
id|cpu_mask_to_apicid
op_assign
id|cluster_cpu_mask_to_apicid
comma
dot
id|phys_pkg_id
op_assign
id|phys_pkg_id
comma
)brace
suffix:semicolon
eof
