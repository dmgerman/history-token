multiline_comment|/*&n; * linux/arch/h8300/platform/h8sh/ints.c&n; *&n; * Yoshinori Sato &lt;ysato@users.sourceforge.jp&gt;&n; *&n; * Based on linux/arch/$(ARCH)/platform/$(PLATFORM)/ints.c&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file COPYING in the main directory of this archive&n; * for more details.&n; *&n; * Copyright 1996 Roman Zippel&n; * Copyright 1999 D. Jeff Dionne &lt;jeff@rt-control.com&gt;&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel_stat.h&gt;
macro_line|#include &lt;linux/seq_file.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/traps.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/setup.h&gt;
macro_line|#include &lt;asm/gpio.h&gt;
macro_line|#include &lt;asm/hardirq.h&gt;
macro_line|#include &lt;asm/regs267x.h&gt;
macro_line|#include &lt;asm/errno.h&gt;
DECL|macro|EXT_IRQ0
mdefine_line|#define EXT_IRQ0 16
DECL|macro|EXT_IRQ1
mdefine_line|#define EXT_IRQ1 17
DECL|macro|EXT_IRQ2
mdefine_line|#define EXT_IRQ2 18
DECL|macro|EXT_IRQ3
mdefine_line|#define EXT_IRQ3 19
DECL|macro|EXT_IRQ4
mdefine_line|#define EXT_IRQ4 20
DECL|macro|EXT_IRQ5
mdefine_line|#define EXT_IRQ5 21
DECL|macro|EXT_IRQ6
mdefine_line|#define EXT_IRQ6 22
DECL|macro|EXT_IRQ7
mdefine_line|#define EXT_IRQ7 23
DECL|macro|EXT_IRQ8
mdefine_line|#define EXT_IRQ8 24
DECL|macro|EXT_IRQ9
mdefine_line|#define EXT_IRQ9 25
DECL|macro|EXT_IRQ10
mdefine_line|#define EXT_IRQ10 26
DECL|macro|EXT_IRQ11
mdefine_line|#define EXT_IRQ11 27
DECL|macro|EXT_IRQ12
mdefine_line|#define EXT_IRQ12 28
DECL|macro|EXT_IRQ13
mdefine_line|#define EXT_IRQ13 29
DECL|macro|EXT_IRQ14
mdefine_line|#define EXT_IRQ14 30
DECL|macro|EXT_IRQ15
mdefine_line|#define EXT_IRQ15 31
multiline_comment|/*&n; * This structure has only 4 elements for speed reasons&n; */
DECL|struct|irq_handler
r_typedef
r_struct
id|irq_handler
(brace
DECL|member|handler
id|irqreturn_t
(paren
op_star
id|handler
)paren
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
DECL|member|flags
r_int
id|flags
suffix:semicolon
DECL|member|count
r_int
id|count
suffix:semicolon
DECL|member|dev_id
r_void
op_star
id|dev_id
suffix:semicolon
DECL|member|devname
r_const
r_char
op_star
id|devname
suffix:semicolon
DECL|typedef|irq_handler_t
)brace
id|irq_handler_t
suffix:semicolon
DECL|variable|irq_list
r_static
id|irq_handler_t
op_star
id|irq_list
(braket
id|NR_IRQS
)braket
suffix:semicolon
multiline_comment|/* IRQ pin assignment */
DECL|struct|irq_pins
r_struct
id|irq_pins
(brace
DECL|member|port_no
r_int
r_char
id|port_no
suffix:semicolon
DECL|member|bit_no
r_int
r_char
id|bit_no
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* ISTR = 0 */
DECL|variable|irq_assign_table0
r_const
r_static
r_struct
id|irq_pins
id|irq_assign_table0
(braket
l_int|16
)braket
op_assign
initialization_block
suffix:semicolon
multiline_comment|/* ISTR = 1 */
DECL|variable|irq_assign_table1
r_const
r_static
r_struct
id|irq_pins
id|irq_assign_table1
(braket
l_int|16
)braket
op_assign
initialization_block
suffix:semicolon
DECL|variable|use_kmalloc
r_static
r_int
id|use_kmalloc
suffix:semicolon
r_extern
r_int
r_int
op_star
id|interrupt_redirect_table
suffix:semicolon
DECL|macro|CPU_VECTOR
mdefine_line|#define CPU_VECTOR ((unsigned long *)0x000000)
DECL|macro|ADDR_MASK
mdefine_line|#define ADDR_MASK (0xffffff)
DECL|function|get_vector_address
r_static
r_inline
r_int
r_int
op_star
id|get_vector_address
c_func
(paren
r_void
)paren
(brace
r_volatile
r_int
r_int
op_star
id|rom_vector
op_assign
id|CPU_VECTOR
suffix:semicolon
r_int
r_int
id|base
comma
id|tmp
suffix:semicolon
r_int
id|vec_no
suffix:semicolon
id|base
op_assign
id|rom_vector
(braket
id|EXT_IRQ0
)braket
op_amp
id|ADDR_MASK
suffix:semicolon
multiline_comment|/* check romvector format */
r_for
c_loop
(paren
id|vec_no
op_assign
id|EXT_IRQ1
suffix:semicolon
id|vec_no
op_le
id|EXT_IRQ15
suffix:semicolon
id|vec_no
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|base
op_plus
(paren
id|vec_no
op_minus
id|EXT_IRQ0
)paren
op_star
l_int|4
)paren
op_ne
(paren
id|rom_vector
(braket
id|vec_no
)braket
op_amp
id|ADDR_MASK
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* ramvector base address */
id|base
op_sub_assign
id|EXT_IRQ0
op_star
l_int|4
suffix:semicolon
multiline_comment|/* writerble check */
id|tmp
op_assign
op_complement
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|base
)paren
suffix:semicolon
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|base
)paren
op_assign
id|tmp
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|base
)paren
op_ne
id|tmp
)paren
r_return
l_int|NULL
suffix:semicolon
r_return
(paren
r_int
r_int
op_star
)paren
id|base
suffix:semicolon
)brace
DECL|function|init_IRQ
r_void
id|__init
id|init_IRQ
c_func
(paren
r_void
)paren
(brace
macro_line|#if defined(CONFIG_RAMKERNEL)
r_int
id|i
suffix:semicolon
r_int
r_int
op_star
id|ramvec
comma
op_star
id|ramvec_p
suffix:semicolon
r_int
r_int
id|break_vec
suffix:semicolon
id|ramvec
op_assign
id|get_vector_address
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ramvec
op_eq
l_int|NULL
)paren
id|panic
c_func
(paren
l_string|&quot;interrupt vector serup failed.&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;virtual vector at 0x%08lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|ramvec
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_GDB_DEBUG)
multiline_comment|/* save orignal break vector */
id|break_vec
op_assign
id|ramvec
(braket
id|TRAP3_VEC
)braket
suffix:semicolon
macro_line|#else
id|break_vec
op_assign
id|VECTOR
c_func
(paren
id|trace_break
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* create redirect table */
r_for
c_loop
(paren
id|ramvec_p
op_assign
id|ramvec
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_IRQS
suffix:semicolon
id|i
op_increment
)paren
op_star
id|ramvec_p
op_increment
op_assign
id|REDIRECT
c_func
(paren
id|interrupt_entry
)paren
suffix:semicolon
multiline_comment|/* set special vector */
id|ramvec
(braket
id|TRAP0_VEC
)braket
op_assign
id|VECTOR
c_func
(paren
id|system_call
)paren
suffix:semicolon
id|ramvec
(braket
id|TRAP3_VEC
)braket
op_assign
id|break_vec
suffix:semicolon
id|interrupt_redirect_table
op_assign
id|ramvec
suffix:semicolon
macro_line|#ifdef DUMP_VECTOR
id|ramvec_p
op_assign
id|ramvec
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_IRQS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_mod
l_int|8
)paren
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n%p: &quot;
comma
id|ramvec_p
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%p &quot;
comma
op_star
id|ramvec_p
)paren
suffix:semicolon
id|ramvec_p
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
)brace
DECL|function|request_irq
r_int
id|request_irq
c_func
(paren
r_int
r_int
id|irq
comma
id|irqreturn_t
(paren
op_star
id|handler
)paren
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
comma
r_int
r_int
id|flags
comma
r_const
r_char
op_star
id|devname
comma
r_void
op_star
id|dev_id
)paren
(brace
r_int
r_int
id|ptn
op_assign
l_int|1
op_lshift
(paren
id|irq
op_minus
id|EXT_IRQ0
)paren
suffix:semicolon
id|irq_handler_t
op_star
id|irq_handle
suffix:semicolon
r_if
c_cond
(paren
id|irq
OL
l_int|0
op_logical_or
id|irq
op_ge
id|NR_IRQS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Incorrect IRQ %d from %s&bslash;n&quot;
comma
id|irq
comma
id|devname
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irq_list
(braket
id|irq
)braket
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* already used */
r_if
c_cond
(paren
id|irq
op_ge
id|EXT_IRQ0
op_logical_and
id|irq
op_le
id|EXT_IRQ15
)paren
(brace
multiline_comment|/* initialize IRQ pin */
r_int
r_int
id|port_no
comma
id|bit_no
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
r_volatile
r_int
r_int
op_star
)paren
id|ITSR
op_amp
id|ptn
)paren
(brace
id|port_no
op_assign
id|irq_assign_table1
(braket
id|irq
op_minus
id|EXT_IRQ0
)braket
dot
id|port_no
suffix:semicolon
id|bit_no
op_assign
id|irq_assign_table1
(braket
id|irq
op_minus
id|EXT_IRQ0
)braket
dot
id|bit_no
suffix:semicolon
)brace
r_else
(brace
id|port_no
op_assign
id|irq_assign_table0
(braket
id|irq
op_minus
id|EXT_IRQ0
)braket
dot
id|port_no
suffix:semicolon
id|bit_no
op_assign
id|irq_assign_table0
(braket
id|irq
op_minus
id|EXT_IRQ0
)braket
dot
id|bit_no
suffix:semicolon
)brace
r_if
c_cond
(paren
id|H8300_GPIO_RESERVE
c_func
(paren
id|port_no
comma
id|bit_no
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* pin already use */
id|H8300_GPIO_DDR
c_func
(paren
id|port_no
comma
id|bit_no
comma
id|H8300_GPIO_INPUT
)paren
suffix:semicolon
op_star
(paren
r_volatile
r_int
r_int
op_star
)paren
id|ISR
op_and_assign
op_complement
id|ptn
suffix:semicolon
multiline_comment|/* ISR clear */
)brace
r_if
c_cond
(paren
id|use_kmalloc
)paren
id|irq_handle
op_assign
(paren
id|irq_handler_t
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|irq_handler_t
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_else
(brace
id|irq_handle
op_assign
id|alloc_bootmem
c_func
(paren
r_sizeof
(paren
id|irq_handler_t
)paren
)paren
suffix:semicolon
(paren
r_int
r_int
)paren
id|irq_handle
op_or_assign
l_int|0x80000000
suffix:semicolon
multiline_comment|/* bootmem allocater */
)brace
r_if
c_cond
(paren
id|irq_handle
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|irq_handle-&gt;handler
op_assign
id|handler
suffix:semicolon
id|irq_handle-&gt;flags
op_assign
id|flags
suffix:semicolon
id|irq_handle-&gt;count
op_assign
l_int|0
suffix:semicolon
id|irq_handle-&gt;dev_id
op_assign
id|dev_id
suffix:semicolon
id|irq_handle-&gt;devname
op_assign
id|devname
suffix:semicolon
id|irq_list
(braket
id|irq
)braket
op_assign
id|irq_handle
suffix:semicolon
r_if
c_cond
(paren
id|irq_handle-&gt;flags
op_amp
id|SA_SAMPLE_RANDOM
)paren
id|rand_initialize_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
multiline_comment|/* enable interrupt */
multiline_comment|/* compatible i386  */
r_if
c_cond
(paren
id|irq
op_ge
id|EXT_IRQ0
op_logical_and
id|irq
op_le
id|EXT_IRQ15
)paren
op_star
(paren
r_volatile
r_int
r_int
op_star
)paren
id|IER
op_or_assign
id|ptn
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|free_irq
r_void
id|free_irq
c_func
(paren
r_int
r_int
id|irq
comma
r_void
op_star
id|dev_id
)paren
(brace
r_if
c_cond
(paren
id|irq
op_ge
id|NR_IRQS
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|irq_list
(braket
id|irq
)braket
op_member_access_from_pointer
id|dev_id
op_ne
id|dev_id
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Removing probably wrong IRQ %d from %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|irq
comma
id|irq_list
(braket
id|irq
)braket
op_member_access_from_pointer
id|devname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_ge
id|EXT_IRQ0
op_logical_and
id|irq
op_le
id|EXT_IRQ15
)paren
(brace
multiline_comment|/* disable interrupt &amp; release IRQ pin */
r_int
r_int
id|port_no
comma
id|bit_no
suffix:semicolon
op_star
(paren
r_volatile
r_int
r_int
op_star
)paren
id|ISR
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|irq
op_minus
id|EXT_IRQ0
)paren
)paren
suffix:semicolon
op_star
(paren
r_volatile
r_int
r_int
op_star
)paren
id|IER
op_or_assign
l_int|1
op_lshift
(paren
id|irq
op_minus
id|EXT_IRQ0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
r_volatile
r_int
r_int
op_star
)paren
id|ITSR
op_amp
(paren
l_int|1
op_lshift
(paren
id|irq
op_minus
id|EXT_IRQ0
)paren
)paren
)paren
(brace
id|port_no
op_assign
id|irq_assign_table1
(braket
id|irq
op_minus
id|EXT_IRQ0
)braket
dot
id|port_no
suffix:semicolon
id|bit_no
op_assign
id|irq_assign_table1
(braket
id|irq
op_minus
id|EXT_IRQ0
)braket
dot
id|bit_no
suffix:semicolon
)brace
r_else
(brace
id|port_no
op_assign
id|irq_assign_table0
(braket
id|irq
op_minus
id|EXT_IRQ0
)braket
dot
id|port_no
suffix:semicolon
id|bit_no
op_assign
id|irq_assign_table0
(braket
id|irq
op_minus
id|EXT_IRQ0
)braket
dot
id|bit_no
suffix:semicolon
)brace
id|H8300_GPIO_FREE
c_func
(paren
id|port_no
comma
id|bit_no
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
r_int
r_int
)paren
id|irq_list
(braket
id|irq
)braket
op_amp
l_int|0x80000000
)paren
op_eq
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|irq_list
(braket
id|irq
)braket
)paren
suffix:semicolon
id|irq_list
(braket
id|irq
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
DECL|function|probe_irq_on
r_int
r_int
id|probe_irq_on
(paren
r_void
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|probe_irq_off
r_int
id|probe_irq_off
(paren
r_int
r_int
id|irqs
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|enable_irq
r_void
id|enable_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_if
c_cond
(paren
id|irq
op_ge
id|EXT_IRQ0
op_logical_and
id|irq
op_le
id|EXT_IRQ15
)paren
op_star
(paren
r_volatile
r_int
r_int
op_star
)paren
id|IER
op_or_assign
l_int|1
op_lshift
(paren
id|irq
op_minus
id|EXT_IRQ0
)paren
suffix:semicolon
)brace
DECL|function|disable_irq
r_void
id|disable_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_if
c_cond
(paren
id|irq
op_ge
id|EXT_IRQ0
op_logical_and
id|irq
op_le
id|EXT_IRQ15
)paren
op_star
(paren
r_volatile
r_int
r_int
op_star
)paren
id|IER
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|irq
op_minus
id|EXT_IRQ0
)paren
)paren
suffix:semicolon
)brace
DECL|function|process_int
id|asmlinkage
r_void
id|process_int
c_func
(paren
r_int
r_int
id|vec
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
(brace
id|irq_enter
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* ISR clear       */
multiline_comment|/* compatible i386 */
r_if
c_cond
(paren
id|vec
op_ge
id|EXT_IRQ0
op_logical_and
id|vec
op_le
id|EXT_IRQ15
)paren
op_star
(paren
r_volatile
r_int
r_int
op_star
)paren
id|ISR
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|vec
op_minus
id|EXT_IRQ0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vec
OL
id|NR_IRQS
)paren
(brace
r_if
c_cond
(paren
id|irq_list
(braket
id|vec
)braket
)paren
(brace
id|irq_list
(braket
id|vec
)braket
op_member_access_from_pointer
id|handler
c_func
(paren
id|vec
comma
id|irq_list
(braket
id|vec
)braket
op_member_access_from_pointer
id|dev_id
comma
id|fp
)paren
suffix:semicolon
id|irq_list
(braket
id|vec
)braket
op_member_access_from_pointer
id|count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|irq_list
(braket
id|vec
)braket
op_member_access_from_pointer
id|flags
op_amp
id|SA_SAMPLE_RANDOM
)paren
id|add_interrupt_randomness
c_func
(paren
id|vec
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|irq_exit
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|show_interrupts
r_int
id|show_interrupts
c_func
(paren
r_struct
id|seq_file
op_star
id|p
comma
r_void
op_star
id|v
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_IRQS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|irq_list
(braket
id|i
)braket
)paren
(brace
id|seq_printf
c_func
(paren
id|p
comma
l_string|&quot;%3d: %10u &quot;
comma
id|i
comma
id|irq_list
(braket
id|i
)braket
op_member_access_from_pointer
id|count
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|p
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|irq_list
(braket
id|i
)braket
op_member_access_from_pointer
id|devname
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|init_irq_proc
r_void
id|init_irq_proc
c_func
(paren
r_void
)paren
(brace
)brace
DECL|function|enable_kmalloc
r_static
r_int
id|__init
id|enable_kmalloc
c_func
(paren
r_void
)paren
(brace
id|use_kmalloc
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|enable_kmalloc
id|__initcall
c_func
(paren
id|enable_kmalloc
)paren
suffix:semicolon
eof
