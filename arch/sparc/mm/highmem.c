multiline_comment|/*&n; *  highmem.c: virtual kernel memory mappings for high memory&n; *&n; *  Provides kernel-static versions of atomic kmap functions originally&n; *  found as inlines in include/asm-sparc/highmem.h.  These became&n; *  needed as kmap_atomic() and kunmap_atomic() started getting&n; *  called from within modules.&n; *  -- Tomas Szepe &lt;szepe@pinerecords.com&gt;, September 2002&n; *&n; *  But kmap_atomic() and kunmap_atomic() cannot be inlined in&n; *  modules because they are loaded with btfixup-ped functions.&n; */
multiline_comment|/*&n; * The use of kmap_atomic/kunmap_atomic is discouraged - kmap/kunmap&n; * gives a more generic (and caching) interface. But kmap_atomic can&n; * be used in IRQ contexts, so in some (very limited) cases we need it.&n; *&n; * XXX This is an old text. Actually, it&squot;s good to use atomic kmaps,&n; * provided you remember that they are atomic and not try to sleep&n; * with a kmap taken, much like a spinlock. Non-atomic kmaps are&n; * shared by CPUs, and so precious, and establishing them requires IPI.&n; * Atomic kmaps are lightweight and we may have NCPUS more of them.&n; */
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/highmem.h&gt;
macro_line|#include &lt;asm/pgalloc.h&gt;
macro_line|#include &lt;asm/cacheflush.h&gt;
macro_line|#include &lt;asm/tlbflush.h&gt;
macro_line|#include &lt;asm/fixmap.h&gt;
DECL|function|kmap_atomic
r_void
op_star
id|kmap_atomic
c_func
(paren
r_struct
id|page
op_star
id|page
comma
r_enum
id|km_type
id|type
)paren
(brace
r_int
r_int
id|idx
suffix:semicolon
r_int
r_int
id|vaddr
suffix:semicolon
multiline_comment|/* even !CONFIG_PREEMPT needs this, for in_atomic in do_page_fault */
id|inc_preempt_count
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|PageHighMem
c_func
(paren
id|page
)paren
)paren
r_return
id|page_address
c_func
(paren
id|page
)paren
suffix:semicolon
id|idx
op_assign
id|type
op_plus
id|KM_TYPE_NR
op_star
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
id|vaddr
op_assign
id|__fix_to_virt
c_func
(paren
id|FIX_KMAP_BEGIN
op_plus
id|idx
)paren
suffix:semicolon
multiline_comment|/* XXX Fix - Anton */
macro_line|#if 0
id|__flush_cache_one
c_func
(paren
id|vaddr
)paren
suffix:semicolon
macro_line|#else
id|flush_cache_all
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_DEBUG_HIGHMEM
id|BUG_ON
c_func
(paren
op_logical_neg
id|pte_none
c_func
(paren
op_star
(paren
id|kmap_pte
op_minus
id|idx
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
id|set_pte
c_func
(paren
id|kmap_pte
op_minus
id|idx
comma
id|mk_pte
c_func
(paren
id|page
comma
id|kmap_prot
)paren
)paren
suffix:semicolon
multiline_comment|/* XXX Fix - Anton */
macro_line|#if 0
id|__flush_tlb_one
c_func
(paren
id|vaddr
)paren
suffix:semicolon
macro_line|#else
id|flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
r_void
op_star
)paren
id|vaddr
suffix:semicolon
)brace
DECL|function|kunmap_atomic
r_void
id|kunmap_atomic
c_func
(paren
r_void
op_star
id|kvaddr
comma
r_enum
id|km_type
id|type
)paren
(brace
macro_line|#ifdef CONFIG_DEBUG_HIGHMEM
r_int
r_int
id|vaddr
op_assign
(paren
r_int
r_int
)paren
id|kvaddr
op_amp
id|PAGE_MASK
suffix:semicolon
r_int
r_int
id|idx
op_assign
id|type
op_plus
id|KM_TYPE_NR
op_star
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vaddr
OL
id|FIXADDR_START
)paren
(brace
singleline_comment|// FIXME
id|dec_preempt_count
c_func
(paren
)paren
suffix:semicolon
id|preempt_check_resched
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|BUG_ON
c_func
(paren
id|vaddr
op_ne
id|__fix_to_virt
c_func
(paren
id|FIX_KMAP_BEGIN
op_plus
id|idx
)paren
)paren
suffix:semicolon
multiline_comment|/* XXX Fix - Anton */
macro_line|#if 0
id|__flush_cache_one
c_func
(paren
id|vaddr
)paren
suffix:semicolon
macro_line|#else
id|flush_cache_all
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * force other mappings to Oops if they&squot;ll try to access&n;&t; * this pte without first remap it&n;&t; */
id|pte_clear
c_func
(paren
id|kmap_pte
op_minus
id|idx
)paren
suffix:semicolon
multiline_comment|/* XXX Fix - Anton */
macro_line|#if 0
id|__flush_tlb_one
c_func
(paren
id|vaddr
)paren
suffix:semicolon
macro_line|#else
id|flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
id|dec_preempt_count
c_func
(paren
)paren
suffix:semicolon
id|preempt_check_resched
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* We may be fed a pagetable here by ptep_to_xxx and others. */
DECL|function|kmap_atomic_to_page
r_struct
id|page
op_star
id|kmap_atomic_to_page
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_int
r_int
id|idx
comma
id|vaddr
op_assign
(paren
r_int
r_int
)paren
id|ptr
suffix:semicolon
id|pte_t
op_star
id|pte
suffix:semicolon
r_if
c_cond
(paren
id|vaddr
OL
id|SRMMU_NOCACHE_VADDR
)paren
r_return
id|virt_to_page
c_func
(paren
id|ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vaddr
OL
id|PKMAP_BASE
)paren
r_return
id|pfn_to_page
c_func
(paren
id|__nocache_pa
c_func
(paren
id|vaddr
)paren
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|vaddr
OL
id|FIXADDR_START
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|vaddr
OG
id|FIXADDR_TOP
)paren
suffix:semicolon
id|idx
op_assign
id|virt_to_fix
c_func
(paren
id|vaddr
)paren
suffix:semicolon
id|pte
op_assign
id|kmap_pte
op_minus
(paren
id|idx
op_minus
id|FIX_KMAP_BEGIN
)paren
suffix:semicolon
r_return
id|pte_page
c_func
(paren
op_star
id|pte
)paren
suffix:semicolon
)brace
eof
