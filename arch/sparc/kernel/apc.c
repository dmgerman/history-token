multiline_comment|/* apc - Driver implementation for power management functions&n; * of Aurora Personality Chip (APC) on SPARCstation-4/5 and&n; * derivatives.&n; *&n; * Copyright (c) 2002 Eric Brower (ebrower@usa.net)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/auxio.h&gt;
macro_line|#include &lt;asm/apc.h&gt;
multiline_comment|/* Debugging&n; * &n; * #define APC_DEBUG_LED&n; * #define APC_NO_IDLE&n; */
DECL|macro|APC_MINOR
mdefine_line|#define APC_MINOR&t;MISC_DYNAMIC_MINOR
DECL|macro|APC_OBPNAME
mdefine_line|#define APC_OBPNAME&t;&quot;power-management&quot;
DECL|macro|APC_DEVNAME
mdefine_line|#define APC_DEVNAME &quot;apc&quot;
DECL|variable|regs
r_volatile
r_static
id|u8
op_star
id|regs
suffix:semicolon
DECL|variable|apc_regsize
r_static
r_int
id|apc_regsize
suffix:semicolon
DECL|macro|apc_readb
mdefine_line|#define apc_readb(offs)&t;&t;&t;(sbus_readb(regs+offs))
DECL|macro|apc_writeb
mdefine_line|#define apc_writeb(val, offs) &t;(sbus_writeb(val, regs+offs))
multiline_comment|/* &n; * CPU idle callback function&n; * See .../arch/sparc/kernel/process.c&n; */
DECL|function|apc_swift_idle
r_void
id|apc_swift_idle
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef APC_DEBUG_LED
id|set_auxio
c_func
(paren
l_int|0x00
comma
id|AUXIO_LED
)paren
suffix:semicolon
macro_line|#endif
id|apc_writeb
c_func
(paren
id|apc_readb
c_func
(paren
id|APC_IDLE_REG
)paren
op_or
id|APC_IDLE_ON
comma
id|APC_IDLE_REG
)paren
suffix:semicolon
macro_line|#ifdef APC_DEBUG_LED
id|set_auxio
c_func
(paren
id|AUXIO_LED
comma
l_int|0x00
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|apc_free
r_static
r_inline
r_void
id|apc_free
c_func
(paren
r_void
)paren
(brace
id|sbus_iounmap
c_func
(paren
(paren
r_int
r_int
)paren
id|regs
comma
id|apc_regsize
)paren
suffix:semicolon
)brace
DECL|function|apc_open
r_static
r_int
id|apc_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|f
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|apc_release
r_static
r_int
id|apc_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|f
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|apc_ioctl
r_static
r_int
id|apc_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|f
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|__u8
id|inarg
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|APCIOCGFANCTL
suffix:colon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|apc_readb
c_func
(paren
id|APC_FANCTL_REG
)paren
op_amp
id|APC_REGMASK
comma
(paren
id|__u8
op_star
)paren
id|arg
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|APCIOCGCPWR
suffix:colon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|apc_readb
c_func
(paren
id|APC_CPOWER_REG
)paren
op_amp
id|APC_REGMASK
comma
(paren
id|__u8
op_star
)paren
id|arg
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|APCIOCGBPORT
suffix:colon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|apc_readb
c_func
(paren
id|APC_BPORT_REG
)paren
op_amp
id|APC_BPMASK
comma
(paren
id|__u8
op_star
)paren
id|arg
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|APCIOCSFANCTL
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|inarg
comma
(paren
id|__u8
op_star
)paren
id|arg
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|apc_writeb
c_func
(paren
id|inarg
op_amp
id|APC_REGMASK
comma
id|APC_FANCTL_REG
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|APCIOCSCPWR
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|inarg
comma
(paren
id|__u8
op_star
)paren
id|arg
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|apc_writeb
c_func
(paren
id|inarg
op_amp
id|APC_REGMASK
comma
id|APC_CPOWER_REG
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|APCIOCSBPORT
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|inarg
comma
(paren
id|__u8
op_star
)paren
id|arg
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|apc_writeb
c_func
(paren
id|inarg
op_amp
id|APC_BPMASK
comma
id|APC_BPORT_REG
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|apc_fops
r_static
r_struct
id|file_operations
id|apc_fops
op_assign
(brace
id|ioctl
suffix:colon
id|apc_ioctl
comma
id|open
suffix:colon
id|apc_open
comma
id|release
suffix:colon
id|apc_release
comma
)brace
suffix:semicolon
DECL|variable|apc_miscdev
r_static
r_struct
id|miscdevice
id|apc_miscdev
op_assign
(brace
id|APC_MINOR
comma
id|APC_DEVNAME
comma
op_amp
id|apc_fops
)brace
suffix:semicolon
DECL|function|apc_probe
r_static
r_int
id|__init
id|apc_probe
c_func
(paren
r_void
)paren
(brace
r_struct
id|sbus_bus
op_star
id|sbus
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sbus_dev
op_star
id|sdev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|iTmp
op_assign
l_int|0
suffix:semicolon
id|for_each_sbus
c_func
(paren
id|sbus
)paren
(brace
id|for_each_sbusdev
c_func
(paren
id|sdev
comma
id|sbus
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|sdev-&gt;prom_name
comma
id|APC_OBPNAME
)paren
)paren
(brace
r_goto
id|sbus_done
suffix:semicolon
)brace
)brace
)brace
id|sbus_done
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|sdev
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|apc_regsize
op_assign
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|reg_size
suffix:semicolon
id|regs
op_assign
(paren
id|u8
op_star
)paren
id|sbus_ioremap
c_func
(paren
op_amp
id|sdev-&gt;resource
(braket
l_int|0
)braket
comma
l_int|0
comma
id|apc_regsize
comma
id|APC_OBPNAME
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|regs
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to map registers&bslash;n&quot;
comma
id|APC_DEVNAME
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|iTmp
op_assign
id|misc_register
c_func
(paren
op_amp
id|apc_miscdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iTmp
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to register device&bslash;n&quot;
comma
id|APC_DEVNAME
)paren
suffix:semicolon
id|apc_free
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#ifndef APC_NO_IDLE&t;
multiline_comment|/* Assign power management IDLE handler */
id|pm_idle
op_assign
id|apc_swift_idle
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: power management initialized&bslash;n&quot;
comma
id|APC_DEVNAME
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This driver is not critical to the boot process&n; * and is easiest to ioremap when SBus is already&n; * initialized, so we install ourselves thusly:&n; */
DECL|variable|apc_probe
id|__initcall
c_func
(paren
id|apc_probe
)paren
suffix:semicolon
eof
