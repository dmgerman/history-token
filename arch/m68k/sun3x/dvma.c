multiline_comment|/*&n; * Virtual DMA allocation&n; *&n; * (C) 1999 Thomas Bogendoerfer (tsbogend@alpha.franken.de) &n; *&n; * 11/26/2000 -- disabled the existing code because it didn&squot;t work for &n; * me in 2.4.  Replaced with a significantly more primitive version &n; * similar to the sun3 code.  the old functionality was probably more &n; * desirable, but....   -- Sam Creasey (sammy@oh.verio.com)&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;asm/sun3x.h&gt;
macro_line|#include &lt;asm/dvma.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/pgalloc.h&gt;
multiline_comment|/* IOMMU support */
DECL|macro|IOMMU_ADDR_MASK
mdefine_line|#define IOMMU_ADDR_MASK            0x03ffe000
DECL|macro|IOMMU_CACHE_INHIBIT
mdefine_line|#define IOMMU_CACHE_INHIBIT        0x00000040
DECL|macro|IOMMU_FULL_BLOCK
mdefine_line|#define IOMMU_FULL_BLOCK           0x00000020
DECL|macro|IOMMU_MODIFIED
mdefine_line|#define IOMMU_MODIFIED             0x00000010
DECL|macro|IOMMU_USED
mdefine_line|#define IOMMU_USED                 0x00000008
DECL|macro|IOMMU_WRITE_PROTECT
mdefine_line|#define IOMMU_WRITE_PROTECT        0x00000004
DECL|macro|IOMMU_DT_MASK
mdefine_line|#define IOMMU_DT_MASK              0x00000003
DECL|macro|IOMMU_DT_INVALID
mdefine_line|#define IOMMU_DT_INVALID           0x00000000
DECL|macro|IOMMU_DT_VALID
mdefine_line|#define IOMMU_DT_VALID             0x00000001
DECL|macro|IOMMU_DT_BAD
mdefine_line|#define IOMMU_DT_BAD               0x00000002
DECL|variable|iommu_pte
r_static
r_volatile
r_int
r_int
op_star
id|iommu_pte
op_assign
(paren
r_int
r_int
op_star
)paren
id|SUN3X_IOMMU
suffix:semicolon
DECL|macro|dvma_entry_paddr
mdefine_line|#define dvma_entry_paddr(index) &t;(iommu_pte[index] &amp; IOMMU_ADDR_MASK)
DECL|macro|dvma_entry_vaddr
mdefine_line|#define dvma_entry_vaddr(index,paddr) &t;((index &lt;&lt; DVMA_PAGE_SHIFT) |  &bslash;&n;&t;&t;&t;&t;&t; (paddr &amp; (DVMA_PAGE_SIZE-1)))
macro_line|#if 0
mdefine_line|#define dvma_entry_set(index,addr)&t;(iommu_pte[index] =            &bslash;&n;&t;&t;&t;&t;&t;    (addr &amp; IOMMU_ADDR_MASK) | &bslash;&n;&t;&t;&t;&t;             IOMMU_DT_VALID | IOMMU_CACHE_INHIBIT)
macro_line|#else
DECL|macro|dvma_entry_set
mdefine_line|#define dvma_entry_set(index,addr)&t;(iommu_pte[index] =            &bslash;&n;&t;&t;&t;&t;&t;    (addr &amp; IOMMU_ADDR_MASK) | &bslash;&n;&t;&t;&t;&t;             IOMMU_DT_VALID)
macro_line|#endif
DECL|macro|dvma_entry_clr
mdefine_line|#define dvma_entry_clr(index)&t;&t;(iommu_pte[index] = IOMMU_DT_INVALID)
DECL|macro|dvma_entry_hash
mdefine_line|#define dvma_entry_hash(addr)&t;&t;((addr &gt;&gt; DVMA_PAGE_SHIFT) ^ &bslash;&n;&t;&t;&t;&t;&t; ((addr &amp; 0x03c00000) &gt;&gt;     &bslash;&n;&t;&t;&t;&t;&t;&t;(DVMA_PAGE_SHIFT+4)))
DECL|macro|DEBUG
macro_line|#undef DEBUG
macro_line|#ifdef DEBUG
multiline_comment|/* code to print out a dvma mapping for debugging purposes */
DECL|function|dvma_print
r_void
id|dvma_print
(paren
r_int
r_int
id|dvma_addr
)paren
(brace
r_int
r_int
id|index
suffix:semicolon
id|index
op_assign
id|dvma_addr
op_rshift
id|DVMA_PAGE_SHIFT
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;idx %lx dvma_addr %08lx paddr %08lx&bslash;n&quot;
comma
id|index
comma
id|dvma_addr
comma
id|dvma_entry_paddr
c_func
(paren
id|index
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* create a virtual mapping for a page assigned within the IOMMU&n;   so that the cpu can reach it easily */
DECL|function|dvma_map_cpu
r_inline
r_int
id|dvma_map_cpu
c_func
(paren
r_int
r_int
id|kaddr
comma
r_int
r_int
id|vaddr
comma
r_int
id|len
)paren
(brace
id|pgd_t
op_star
id|pgd
suffix:semicolon
r_int
r_int
id|end
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|kaddr
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|vaddr
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|end
op_assign
id|PAGE_ALIGN
c_func
(paren
id|vaddr
op_plus
id|len
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;dvma: mapping kern %08lx to virt %08lx&bslash;n&quot;
comma
id|kaddr
comma
id|vaddr
)paren
suffix:semicolon
macro_line|#endif
id|pgd
op_assign
id|pgd_offset_k
c_func
(paren
id|vaddr
)paren
suffix:semicolon
r_do
(brace
id|pmd_t
op_star
id|pmd
suffix:semicolon
r_int
r_int
id|end2
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pmd
op_assign
id|pmd_alloc_kernel
c_func
(paren
id|pgd
comma
id|vaddr
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|end
op_amp
id|PGDIR_MASK
)paren
OG
(paren
id|vaddr
op_amp
id|PGDIR_MASK
)paren
)paren
(brace
id|end2
op_assign
(paren
id|vaddr
op_plus
(paren
id|PGDIR_SIZE
op_minus
l_int|1
)paren
)paren
op_amp
id|PGDIR_MASK
suffix:semicolon
)brace
r_else
id|end2
op_assign
id|end
suffix:semicolon
r_do
(brace
id|pte_t
op_star
id|pte
suffix:semicolon
r_int
r_int
id|end3
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pte
op_assign
id|pte_alloc_kernel
c_func
(paren
id|pmd
comma
id|vaddr
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|end2
op_amp
id|PMD_MASK
)paren
OG
(paren
id|vaddr
op_amp
id|PMD_MASK
)paren
)paren
(brace
id|end3
op_assign
(paren
id|vaddr
op_plus
(paren
id|PMD_SIZE
op_minus
l_int|1
)paren
)paren
op_amp
id|PMD_MASK
suffix:semicolon
)brace
r_else
id|end3
op_assign
id|end2
suffix:semicolon
r_do
(brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;mapping %08lx phys to %08lx&bslash;n&quot;
comma
id|__pa
c_func
(paren
id|kaddr
)paren
comma
id|vaddr
)paren
suffix:semicolon
macro_line|#endif
id|set_pte
c_func
(paren
id|pte
comma
id|__mk_pte
c_func
(paren
id|kaddr
comma
id|PAGE_KERNEL
)paren
)paren
suffix:semicolon
id|pte
op_increment
suffix:semicolon
id|kaddr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|vaddr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
r_while
c_loop
(paren
id|vaddr
OL
id|end3
)paren
(brace
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|vaddr
OL
id|end2
)paren
(brace
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|vaddr
OL
id|end
)paren
(brace
suffix:semicolon
)brace
id|flush_tlb_all
c_func
(paren
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|dvma_map_iommu
r_inline
r_int
id|dvma_map_iommu
c_func
(paren
r_int
r_int
id|kaddr
comma
r_int
r_int
id|baddr
comma
r_int
id|len
)paren
(brace
r_int
r_int
id|end
comma
id|index
suffix:semicolon
id|index
op_assign
id|baddr
op_rshift
id|DVMA_PAGE_SHIFT
suffix:semicolon
id|end
op_assign
(paren
(paren
id|baddr
op_plus
id|len
)paren
op_rshift
id|DVMA_PAGE_SHIFT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_amp
op_complement
id|DVMA_PAGE_MASK
)paren
(brace
id|end
op_increment
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|index
OL
id|end
suffix:semicolon
id|index
op_increment
)paren
(brace
singleline_comment|//&t;&t;if(dvma_entry_use(index))
singleline_comment|//&t;&t;&t;BUG();
singleline_comment|//&t;&t;printk(&quot;mapping pa %lx to ba %lx&bslash;n&quot;, __pa(kaddr), index &lt;&lt; DVMA_PAGE_SHIFT);
id|dvma_entry_set
c_func
(paren
id|index
comma
id|__pa
c_func
(paren
id|kaddr
)paren
)paren
suffix:semicolon
id|iommu_pte
(braket
id|index
)braket
op_or_assign
id|IOMMU_FULL_BLOCK
suffix:semicolon
singleline_comment|//&t;&t;dvma_entry_inc(index);
id|kaddr
op_add_assign
id|DVMA_PAGE_SIZE
suffix:semicolon
)brace
macro_line|#ifdef DEBUG&t;
r_for
c_loop
(paren
id|index
op_assign
(paren
id|baddr
op_rshift
id|DVMA_PAGE_SHIFT
)paren
suffix:semicolon
id|index
OL
id|end
suffix:semicolon
id|index
op_increment
)paren
(brace
id|dvma_print
c_func
(paren
id|index
op_lshift
id|DVMA_PAGE_SHIFT
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dvma_unmap_iommu
r_void
id|dvma_unmap_iommu
c_func
(paren
r_int
r_int
id|baddr
comma
r_int
id|len
)paren
(brace
r_int
id|index
comma
id|end
suffix:semicolon
id|index
op_assign
id|baddr
op_rshift
id|DVMA_PAGE_SHIFT
suffix:semicolon
id|end
op_assign
(paren
id|DVMA_PAGE_ALIGN
c_func
(paren
id|baddr
op_plus
id|len
)paren
op_rshift
id|DVMA_PAGE_SHIFT
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|index
OL
id|end
suffix:semicolon
id|index
op_increment
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;freeing bus mapping %08x&bslash;n&quot;
comma
id|index
op_lshift
id|DVMA_PAGE_SHIFT
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if 0
r_if
c_cond
(paren
op_logical_neg
id|dvma_entry_use
c_func
(paren
id|index
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dvma_unmap freeing unused entry %04x&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
)brace
r_else
id|dvma_entry_dec
c_func
(paren
id|index
)paren
suffix:semicolon
macro_line|#endif
id|dvma_entry_clr
c_func
(paren
id|index
)paren
suffix:semicolon
)brace
)brace
eof
