multiline_comment|/*&n; * linux/arch/m68k/mm/sun3dvma.c&n; *&n; * Copyright (C) 2000 Sam Creasey&n; *&n; * Contains common routines for sun3/sun3x DVMA management.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/dvma.h&gt;
DECL|macro|DVMA_DEBUG
macro_line|#undef DVMA_DEBUG
macro_line|#ifdef CONFIG_SUN3X
r_extern
r_void
id|dvma_unmap_iommu
c_func
(paren
r_int
r_int
id|baddr
comma
r_int
id|len
)paren
suffix:semicolon
macro_line|#else
DECL|function|dvma_unmap_iommu
r_static
r_inline
r_void
id|dvma_unmap_iommu
c_func
(paren
r_int
r_int
id|a
comma
r_int
id|b
)paren
(brace
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_SUN3
r_extern
r_void
id|sun3_dvma_init
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|iommu_use
r_int
r_int
id|iommu_use
(braket
id|IOMMU_TOTAL_ENTRIES
)braket
suffix:semicolon
DECL|macro|dvma_index
mdefine_line|#define dvma_index(baddr) ((baddr - DVMA_START) &gt;&gt; DVMA_PAGE_SHIFT)
DECL|macro|dvma_entry_use
mdefine_line|#define dvma_entry_use(baddr)&t;&t;(iommu_use[dvma_index(baddr)])
DECL|struct|hole
r_struct
id|hole
(brace
DECL|member|start
r_int
r_int
id|start
suffix:semicolon
DECL|member|end
r_int
r_int
id|end
suffix:semicolon
DECL|member|size
r_int
r_int
id|size
suffix:semicolon
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|hole_list
r_static
r_struct
id|list_head
id|hole_list
suffix:semicolon
DECL|variable|hole_cache
r_static
r_struct
id|list_head
id|hole_cache
suffix:semicolon
DECL|variable|initholes
r_static
r_struct
id|hole
id|initholes
(braket
l_int|64
)braket
suffix:semicolon
macro_line|#ifdef DVMA_DEBUG
DECL|variable|dvma_allocs
r_static
r_int
r_int
id|dvma_allocs
suffix:semicolon
DECL|variable|dvma_frees
r_static
r_int
r_int
id|dvma_frees
suffix:semicolon
DECL|variable|dvma_alloc_bytes
r_static
r_int
r_int
r_int
id|dvma_alloc_bytes
suffix:semicolon
DECL|variable|dvma_free_bytes
r_static
r_int
r_int
r_int
id|dvma_free_bytes
suffix:semicolon
DECL|function|print_use
r_static
r_void
id|print_use
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|j
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;dvma entry usage:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IOMMU_TOTAL_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|iommu_use
(braket
id|i
)braket
)paren
(brace
r_continue
suffix:semicolon
)brace
id|j
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;dvma entry: %08lx len %08lx&bslash;n&quot;
comma
(paren
id|i
op_lshift
id|DVMA_PAGE_SHIFT
)paren
op_plus
id|DVMA_START
comma
id|iommu_use
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%d entries in use total&bslash;n&quot;
comma
id|j
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;allocation/free calls: %lu/%lu&bslash;n&quot;
comma
id|dvma_allocs
comma
id|dvma_frees
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;allocation/free bytes: %Lx/%Lx&bslash;n&quot;
comma
id|dvma_alloc_bytes
comma
id|dvma_free_bytes
)paren
suffix:semicolon
)brace
DECL|function|print_holes
r_static
r_void
id|print_holes
c_func
(paren
r_struct
id|list_head
op_star
id|holes
)paren
(brace
r_struct
id|list_head
op_star
id|cur
suffix:semicolon
r_struct
id|hole
op_star
id|hole
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;listing dvma holes&bslash;n&quot;
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|cur
comma
id|holes
)paren
(brace
id|hole
op_assign
id|list_entry
c_func
(paren
id|cur
comma
r_struct
id|hole
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hole-&gt;start
op_eq
l_int|0
)paren
op_logical_and
(paren
id|hole-&gt;end
op_eq
l_int|0
)paren
op_logical_and
(paren
id|hole-&gt;size
op_eq
l_int|0
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;hole: start %08lx end %08lx size %08lx&bslash;n&quot;
comma
id|hole-&gt;start
comma
id|hole-&gt;end
comma
id|hole-&gt;size
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;end of hole listing...&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* DVMA_DEBUG */
DECL|function|refill
r_static
r_inline
r_int
id|refill
c_func
(paren
r_void
)paren
(brace
r_struct
id|hole
op_star
id|hole
suffix:semicolon
r_struct
id|hole
op_star
id|prev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|list_head
op_star
id|cur
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|list_for_each
c_func
(paren
id|cur
comma
op_amp
id|hole_list
)paren
(brace
id|hole
op_assign
id|list_entry
c_func
(paren
id|cur
comma
r_struct
id|hole
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|prev
)paren
(brace
id|prev
op_assign
id|hole
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hole-&gt;end
op_eq
id|prev-&gt;start
)paren
(brace
id|hole-&gt;size
op_add_assign
id|prev-&gt;size
suffix:semicolon
id|hole-&gt;end
op_assign
id|prev-&gt;end
suffix:semicolon
id|list_del
c_func
(paren
op_amp
(paren
id|prev-&gt;list
)paren
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
(paren
id|prev-&gt;list
)paren
comma
op_amp
id|hole_cache
)paren
suffix:semicolon
id|ret
op_increment
suffix:semicolon
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|rmcache
r_static
r_inline
r_struct
id|hole
op_star
id|rmcache
c_func
(paren
r_void
)paren
(brace
r_struct
id|hole
op_star
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|hole_cache
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|refill
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;out of dvma hole cache!&bslash;n&quot;
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
id|ret
op_assign
id|list_entry
c_func
(paren
id|hole_cache.next
comma
r_struct
id|hole
comma
id|list
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
(paren
id|ret-&gt;list
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|get_baddr
r_static
r_inline
r_int
r_int
id|get_baddr
c_func
(paren
r_int
id|len
comma
r_int
r_int
id|align
)paren
(brace
r_struct
id|list_head
op_star
id|cur
suffix:semicolon
r_struct
id|hole
op_star
id|hole
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|hole_list
)paren
)paren
(brace
macro_line|#ifdef DVMA_DEBUG
id|printk
c_func
(paren
l_string|&quot;out of dvma holes! (printing hole cache)&bslash;n&quot;
)paren
suffix:semicolon
id|print_holes
c_func
(paren
op_amp
id|hole_cache
)paren
suffix:semicolon
id|print_use
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|list_for_each
c_func
(paren
id|cur
comma
op_amp
id|hole_list
)paren
(brace
r_int
r_int
id|newlen
suffix:semicolon
id|hole
op_assign
id|list_entry
c_func
(paren
id|cur
comma
r_struct
id|hole
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|align
OG
id|DVMA_PAGE_SIZE
)paren
(brace
id|newlen
op_assign
id|len
op_plus
(paren
(paren
id|hole-&gt;end
op_minus
id|len
)paren
op_amp
(paren
id|align
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
r_else
id|newlen
op_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|hole-&gt;size
OG
id|newlen
)paren
(brace
id|hole-&gt;end
op_sub_assign
id|newlen
suffix:semicolon
id|hole-&gt;size
op_sub_assign
id|newlen
suffix:semicolon
id|dvma_entry_use
c_func
(paren
id|hole-&gt;end
)paren
op_assign
id|newlen
suffix:semicolon
macro_line|#ifdef DVMA_DEBUG
id|dvma_allocs
op_increment
suffix:semicolon
id|dvma_alloc_bytes
op_add_assign
id|newlen
suffix:semicolon
macro_line|#endif
r_return
id|hole-&gt;end
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hole-&gt;size
op_eq
id|newlen
)paren
(brace
id|list_del
c_func
(paren
op_amp
(paren
id|hole-&gt;list
)paren
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
(paren
id|hole-&gt;list
)paren
comma
op_amp
id|hole_cache
)paren
suffix:semicolon
id|dvma_entry_use
c_func
(paren
id|hole-&gt;start
)paren
op_assign
id|newlen
suffix:semicolon
macro_line|#ifdef DVMA_DEBUG
id|dvma_allocs
op_increment
suffix:semicolon
id|dvma_alloc_bytes
op_add_assign
id|newlen
suffix:semicolon
macro_line|#endif
r_return
id|hole-&gt;start
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;unable to find dvma hole!&bslash;n&quot;
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|free_baddr
r_static
r_inline
r_int
id|free_baddr
c_func
(paren
r_int
r_int
id|baddr
)paren
(brace
r_int
r_int
id|len
suffix:semicolon
r_struct
id|hole
op_star
id|hole
suffix:semicolon
r_struct
id|list_head
op_star
id|cur
suffix:semicolon
r_int
r_int
id|orig_baddr
suffix:semicolon
id|orig_baddr
op_assign
id|baddr
suffix:semicolon
id|len
op_assign
id|dvma_entry_use
c_func
(paren
id|baddr
)paren
suffix:semicolon
id|dvma_entry_use
c_func
(paren
id|baddr
)paren
op_assign
l_int|0
suffix:semicolon
id|baddr
op_and_assign
id|DVMA_PAGE_MASK
suffix:semicolon
id|dvma_unmap_iommu
c_func
(paren
id|baddr
comma
id|len
)paren
suffix:semicolon
macro_line|#ifdef DVMA_DEBUG
id|dvma_frees
op_increment
suffix:semicolon
id|dvma_free_bytes
op_add_assign
id|len
suffix:semicolon
macro_line|#endif
id|list_for_each
c_func
(paren
id|cur
comma
op_amp
id|hole_list
)paren
(brace
id|hole
op_assign
id|list_entry
c_func
(paren
id|cur
comma
r_struct
id|hole
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hole-&gt;end
op_eq
id|baddr
)paren
(brace
id|hole-&gt;end
op_add_assign
id|len
suffix:semicolon
id|hole-&gt;size
op_add_assign
id|len
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hole-&gt;start
op_eq
(paren
id|baddr
op_plus
id|len
)paren
)paren
(brace
id|hole-&gt;start
op_assign
id|baddr
suffix:semicolon
id|hole-&gt;size
op_add_assign
id|len
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|hole
op_assign
id|rmcache
c_func
(paren
)paren
suffix:semicolon
id|hole-&gt;start
op_assign
id|baddr
suffix:semicolon
id|hole-&gt;end
op_assign
id|baddr
op_plus
id|len
suffix:semicolon
id|hole-&gt;size
op_assign
id|len
suffix:semicolon
singleline_comment|//&t;list_add_tail(&amp;(hole-&gt;list), cur);
id|list_add
c_func
(paren
op_amp
(paren
id|hole-&gt;list
)paren
comma
id|cur
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dvma_init
r_void
id|dvma_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|hole
op_star
id|hole
suffix:semicolon
r_int
id|i
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|hole_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|hole_cache
)paren
suffix:semicolon
multiline_comment|/* prepare the hole cache */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
(brace
id|list_add
c_func
(paren
op_amp
(paren
id|initholes
(braket
id|i
)braket
dot
id|list
)paren
comma
op_amp
id|hole_cache
)paren
suffix:semicolon
)brace
id|hole
op_assign
id|rmcache
c_func
(paren
)paren
suffix:semicolon
id|hole-&gt;start
op_assign
id|DVMA_START
suffix:semicolon
id|hole-&gt;end
op_assign
id|DVMA_END
suffix:semicolon
id|hole-&gt;size
op_assign
id|DVMA_SIZE
suffix:semicolon
id|list_add
c_func
(paren
op_amp
(paren
id|hole-&gt;list
)paren
comma
op_amp
id|hole_list
)paren
suffix:semicolon
id|memset
c_func
(paren
id|iommu_use
comma
l_int|0
comma
r_sizeof
(paren
id|iommu_use
)paren
)paren
suffix:semicolon
id|dvma_unmap_iommu
c_func
(paren
id|DVMA_START
comma
id|DVMA_SIZE
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SUN3
id|sun3_dvma_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|dvma_map_align
r_inline
r_int
r_int
id|dvma_map_align
c_func
(paren
r_int
r_int
id|kaddr
comma
r_int
id|len
comma
r_int
id|align
)paren
(brace
r_int
r_int
id|baddr
suffix:semicolon
r_int
r_int
id|off
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
(brace
id|len
op_assign
l_int|0x800
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|kaddr
op_logical_or
op_logical_neg
id|len
)paren
(brace
singleline_comment|//&t;&t;printk(&quot;error: kaddr %lx len %x&bslash;n&quot;, kaddr, len);
singleline_comment|//&t;&t;*(int *)4 = 0;
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;dvma_map request %08lx bytes from %08lx&bslash;n&quot;
comma
id|len
comma
id|kaddr
)paren
suffix:semicolon
macro_line|#endif
id|off
op_assign
id|kaddr
op_amp
op_complement
id|DVMA_PAGE_MASK
suffix:semicolon
id|kaddr
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|len
op_add_assign
id|off
suffix:semicolon
id|len
op_assign
(paren
(paren
id|len
op_plus
(paren
id|DVMA_PAGE_SIZE
op_minus
l_int|1
)paren
)paren
op_amp
id|DVMA_PAGE_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|align
op_eq
l_int|0
)paren
(brace
id|align
op_assign
id|DVMA_PAGE_SIZE
suffix:semicolon
)brace
r_else
id|align
op_assign
(paren
(paren
id|align
op_plus
(paren
id|DVMA_PAGE_SIZE
op_minus
l_int|1
)paren
)paren
op_amp
id|DVMA_PAGE_MASK
)paren
suffix:semicolon
id|baddr
op_assign
id|get_baddr
c_func
(paren
id|len
comma
id|align
)paren
suffix:semicolon
singleline_comment|//&t;printk(&quot;using baddr %lx&bslash;n&quot;, baddr);
r_if
c_cond
(paren
op_logical_neg
id|dvma_map_iommu
c_func
(paren
id|kaddr
comma
id|baddr
comma
id|len
)paren
)paren
(brace
r_return
(paren
id|baddr
op_plus
id|off
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;dvma_map failed kaddr %lx baddr %lx len %x&bslash;n&quot;
comma
id|kaddr
comma
id|baddr
comma
id|len
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dvma_unmap
r_void
id|dvma_unmap
c_func
(paren
r_void
op_star
id|baddr
)paren
(brace
r_int
r_int
id|addr
suffix:semicolon
id|addr
op_assign
(paren
r_int
r_int
)paren
id|baddr
suffix:semicolon
multiline_comment|/* check if this is a vme mapping */
r_if
c_cond
(paren
op_logical_neg
(paren
id|addr
op_amp
l_int|0x00f00000
)paren
)paren
(brace
id|addr
op_or_assign
l_int|0xf00000
suffix:semicolon
)brace
id|free_baddr
c_func
(paren
id|addr
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|dvma_malloc_align
r_void
op_star
id|dvma_malloc_align
c_func
(paren
r_int
r_int
id|len
comma
r_int
r_int
id|align
)paren
(brace
r_int
r_int
id|kaddr
suffix:semicolon
r_int
r_int
id|baddr
suffix:semicolon
r_int
r_int
id|vaddr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;dvma_malloc request %lx bytes&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
id|len
op_assign
(paren
(paren
id|len
op_plus
(paren
id|DVMA_PAGE_SIZE
op_minus
l_int|1
)paren
)paren
op_amp
id|DVMA_PAGE_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|kaddr
op_assign
id|__get_free_pages
c_func
(paren
id|GFP_ATOMIC
comma
id|get_order
c_func
(paren
id|len
)paren
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|baddr
op_assign
(paren
r_int
r_int
)paren
id|dvma_map_align
c_func
(paren
id|kaddr
comma
id|len
comma
id|align
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|free_pages
c_func
(paren
id|kaddr
comma
id|get_order
c_func
(paren
id|len
)paren
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|vaddr
op_assign
id|dvma_btov
c_func
(paren
id|baddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dvma_map_cpu
c_func
(paren
id|kaddr
comma
id|vaddr
comma
id|len
)paren
OL
l_int|0
)paren
(brace
id|dvma_unmap
c_func
(paren
(paren
r_void
op_star
)paren
id|baddr
)paren
suffix:semicolon
id|free_pages
c_func
(paren
id|kaddr
comma
id|get_order
c_func
(paren
id|len
)paren
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;mapped %08lx bytes %08lx kern -&gt; %08lx bus&bslash;n&quot;
comma
id|len
comma
id|kaddr
comma
id|baddr
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
r_void
op_star
)paren
id|vaddr
suffix:semicolon
)brace
DECL|function|dvma_free
r_void
id|dvma_free
c_func
(paren
r_void
op_star
id|vaddr
)paren
(brace
r_return
suffix:semicolon
)brace
eof
