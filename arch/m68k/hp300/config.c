multiline_comment|/*&n; *  linux/arch/m68k/hp300/config.c&n; *&n; *  Copyright (C) 1998 Philip Blundell &lt;philb@gnu.org&gt;&n; *&n; *  This file contains the HP300-specific initialisation code.  It gets&n; *  called by setup.c.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/blinken.h&gt;
macro_line|#include &lt;asm/io.h&gt;                               /* readb() and writeb() */
macro_line|#include &lt;asm/hp300hw.h&gt;
macro_line|#include &lt;asm/rtc.h&gt;
macro_line|#include &quot;ints.h&quot;
macro_line|#include &quot;time.h&quot;
DECL|variable|hp300_model
r_int
r_int
id|hp300_model
suffix:semicolon
DECL|variable|hp300_uart_scode
r_int
r_int
id|hp300_uart_scode
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|ledstate
r_int
r_char
id|ledstate
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|s_hp330
(braket
)braket
id|__initdata
op_assign
l_string|&quot;330&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|s_hp340
(braket
)braket
id|__initdata
op_assign
l_string|&quot;340&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|s_hp345
(braket
)braket
id|__initdata
op_assign
l_string|&quot;345&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|s_hp360
(braket
)braket
id|__initdata
op_assign
l_string|&quot;360&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|s_hp370
(braket
)braket
id|__initdata
op_assign
l_string|&quot;370&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|s_hp375
(braket
)braket
id|__initdata
op_assign
l_string|&quot;375&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|s_hp380
(braket
)braket
id|__initdata
op_assign
l_string|&quot;380&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|s_hp385
(braket
)braket
id|__initdata
op_assign
l_string|&quot;385&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|s_hp400
(braket
)braket
id|__initdata
op_assign
l_string|&quot;400&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|s_hp425t
(braket
)braket
id|__initdata
op_assign
l_string|&quot;425t&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|s_hp425s
(braket
)braket
id|__initdata
op_assign
l_string|&quot;425s&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|s_hp425e
(braket
)braket
id|__initdata
op_assign
l_string|&quot;425e&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|s_hp433t
(braket
)braket
id|__initdata
op_assign
l_string|&quot;433t&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|s_hp433s
(braket
)braket
id|__initdata
op_assign
l_string|&quot;433s&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
op_star
id|hp300_models
(braket
)braket
id|__initdata
op_assign
(brace
(braket
id|HP_320
)braket
op_assign
l_int|NULL
comma
(braket
id|HP_330
)braket
op_assign
id|s_hp330
comma
(braket
id|HP_340
)braket
op_assign
id|s_hp340
comma
(braket
id|HP_345
)braket
op_assign
id|s_hp345
comma
(braket
id|HP_350
)braket
op_assign
l_int|NULL
comma
(braket
id|HP_360
)braket
op_assign
id|s_hp360
comma
(braket
id|HP_370
)braket
op_assign
id|s_hp370
comma
(braket
id|HP_375
)braket
op_assign
id|s_hp375
comma
(braket
id|HP_380
)braket
op_assign
id|s_hp380
comma
(braket
id|HP_385
)braket
op_assign
id|s_hp385
comma
(braket
id|HP_400
)braket
op_assign
id|s_hp400
comma
(braket
id|HP_425T
)braket
op_assign
id|s_hp425t
comma
(braket
id|HP_425S
)braket
op_assign
id|s_hp425s
comma
(braket
id|HP_425E
)braket
op_assign
id|s_hp425e
comma
(braket
id|HP_433T
)braket
op_assign
id|s_hp433t
comma
(braket
id|HP_433S
)braket
op_assign
id|s_hp433s
comma
)brace
suffix:semicolon
DECL|variable|hp300_model_name
r_static
r_char
id|hp300_model_name
(braket
l_int|13
)braket
op_assign
l_string|&quot;HP9000/&quot;
suffix:semicolon
r_extern
r_void
id|hp300_reset
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
id|irqreturn_t
(paren
op_star
id|hp300_default_handler
(braket
)braket
)paren
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_extern
r_int
id|show_hp300_interrupts
c_func
(paren
r_struct
id|seq_file
op_star
comma
r_void
op_star
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SERIAL_8250_CONSOLE
r_extern
r_int
id|hp300_setup_serial_console
c_func
(paren
r_void
)paren
id|__init
suffix:semicolon
macro_line|#endif
DECL|function|hp300_parse_bootinfo
r_int
id|__init
id|hp300_parse_bootinfo
c_func
(paren
r_const
r_struct
id|bi_record
op_star
id|record
)paren
(brace
r_int
id|unknown
op_assign
l_int|0
suffix:semicolon
r_const
r_int
r_int
op_star
id|data
op_assign
id|record-&gt;data
suffix:semicolon
r_switch
c_cond
(paren
id|record-&gt;tag
)paren
(brace
r_case
id|BI_HP300_MODEL
suffix:colon
id|hp300_model
op_assign
op_star
id|data
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BI_HP300_UART_SCODE
suffix:colon
id|hp300_uart_scode
op_assign
op_star
id|data
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BI_HP300_UART_ADDR
suffix:colon
multiline_comment|/* serial port address: ignored here */
r_break
suffix:semicolon
r_default
suffix:colon
id|unknown
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|unknown
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_HEARTBEAT
DECL|function|hp300_pulse
r_static
r_void
id|hp300_pulse
c_func
(paren
r_int
id|x
)paren
(brace
r_if
c_cond
(paren
id|x
)paren
id|blinken_leds
c_func
(paren
l_int|0x10
comma
l_int|0
)paren
suffix:semicolon
r_else
id|blinken_leds
c_func
(paren
l_int|0
comma
l_int|0x10
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|hp300_get_model
r_static
r_void
id|hp300_get_model
c_func
(paren
r_char
op_star
id|model
)paren
(brace
id|strcpy
c_func
(paren
id|model
comma
id|hp300_model_name
)paren
suffix:semicolon
)brace
DECL|macro|RTCBASE
mdefine_line|#define RTCBASE&t;&t;&t;0xf0420000
DECL|macro|RTC_DATA
mdefine_line|#define RTC_DATA&t;&t;0x1
DECL|macro|RTC_CMD
mdefine_line|#define RTC_CMD&t;&t;&t;0x3
DECL|macro|RTC_BUSY
mdefine_line|#define&t;RTC_BUSY&t;&t;0x02
DECL|macro|RTC_DATA_RDY
mdefine_line|#define&t;RTC_DATA_RDY&t;&t;0x01
DECL|macro|rtc_busy
mdefine_line|#define rtc_busy()&t;&t;(in_8(RTCBASE + RTC_CMD) &amp; RTC_BUSY)
DECL|macro|rtc_data_available
mdefine_line|#define rtc_data_available()&t;(in_8(RTCBASE + RTC_CMD) &amp; RTC_DATA_RDY)
DECL|macro|rtc_status
mdefine_line|#define rtc_status()&t;&t;(in_8(RTCBASE + RTC_CMD))
DECL|macro|rtc_command
mdefine_line|#define rtc_command(x)&t;&t;out_8(RTCBASE + RTC_CMD, (x))
DECL|macro|rtc_read_data
mdefine_line|#define rtc_read_data()&t;&t;(in_8(RTCBASE + RTC_DATA))
DECL|macro|rtc_write_data
mdefine_line|#define rtc_write_data(x)&t;out_8(RTCBASE + RTC_DATA, (x))
DECL|macro|RTC_SETREG
mdefine_line|#define RTC_SETREG&t;0xe0
DECL|macro|RTC_WRITEREG
mdefine_line|#define RTC_WRITEREG&t;0xc2
DECL|macro|RTC_READREG
mdefine_line|#define RTC_READREG&t;0xc3
DECL|macro|RTC_REG_SEC2
mdefine_line|#define RTC_REG_SEC2&t;0
DECL|macro|RTC_REG_SEC1
mdefine_line|#define RTC_REG_SEC1&t;1
DECL|macro|RTC_REG_MIN2
mdefine_line|#define RTC_REG_MIN2&t;2
DECL|macro|RTC_REG_MIN1
mdefine_line|#define RTC_REG_MIN1&t;3
DECL|macro|RTC_REG_HOUR2
mdefine_line|#define RTC_REG_HOUR2&t;4
DECL|macro|RTC_REG_HOUR1
mdefine_line|#define RTC_REG_HOUR1&t;5
DECL|macro|RTC_REG_WDAY
mdefine_line|#define RTC_REG_WDAY&t;6
DECL|macro|RTC_REG_DAY2
mdefine_line|#define RTC_REG_DAY2&t;7
DECL|macro|RTC_REG_DAY1
mdefine_line|#define RTC_REG_DAY1&t;8
DECL|macro|RTC_REG_MON2
mdefine_line|#define RTC_REG_MON2&t;9
DECL|macro|RTC_REG_MON1
mdefine_line|#define RTC_REG_MON1&t;10
DECL|macro|RTC_REG_YEAR2
mdefine_line|#define RTC_REG_YEAR2&t;11
DECL|macro|RTC_REG_YEAR1
mdefine_line|#define RTC_REG_YEAR1&t;12
DECL|macro|RTC_HOUR1_24HMODE
mdefine_line|#define RTC_HOUR1_24HMODE 0x8
DECL|macro|RTC_STAT_MASK
mdefine_line|#define RTC_STAT_MASK&t;0xf0
DECL|macro|RTC_STAT_RDY
mdefine_line|#define RTC_STAT_RDY&t;0x40
DECL|function|hp300_rtc_read
r_static
r_inline
r_int
r_char
id|hp300_rtc_read
c_func
(paren
r_int
r_char
id|reg
)paren
(brace
r_int
r_char
id|s
comma
id|ret
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|rtc_busy
c_func
(paren
)paren
)paren
suffix:semicolon
id|rtc_command
c_func
(paren
id|RTC_SETREG
)paren
suffix:semicolon
r_while
c_loop
(paren
id|rtc_busy
c_func
(paren
)paren
)paren
suffix:semicolon
id|rtc_write_data
c_func
(paren
id|reg
)paren
suffix:semicolon
r_while
c_loop
(paren
id|rtc_busy
c_func
(paren
)paren
)paren
suffix:semicolon
id|rtc_command
c_func
(paren
id|RTC_READREG
)paren
suffix:semicolon
r_do
(brace
r_while
c_loop
(paren
op_logical_neg
id|rtc_data_available
c_func
(paren
)paren
)paren
suffix:semicolon
id|s
op_assign
id|rtc_status
c_func
(paren
)paren
suffix:semicolon
id|ret
op_assign
id|rtc_read_data
c_func
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|s
op_amp
id|RTC_STAT_MASK
)paren
op_ne
id|RTC_STAT_RDY
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|hp300_rtc_write
r_static
r_inline
r_int
r_char
id|hp300_rtc_write
c_func
(paren
r_int
r_char
id|reg
comma
r_int
r_char
id|val
)paren
(brace
r_int
r_char
id|s
comma
id|ret
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|rtc_busy
c_func
(paren
)paren
)paren
suffix:semicolon
id|rtc_command
c_func
(paren
id|RTC_SETREG
)paren
suffix:semicolon
r_while
c_loop
(paren
id|rtc_busy
c_func
(paren
)paren
)paren
suffix:semicolon
id|rtc_write_data
c_func
(paren
(paren
id|val
op_lshift
l_int|4
)paren
op_or
id|reg
)paren
suffix:semicolon
r_while
c_loop
(paren
id|rtc_busy
c_func
(paren
)paren
)paren
suffix:semicolon
id|rtc_command
c_func
(paren
id|RTC_WRITEREG
)paren
suffix:semicolon
r_while
c_loop
(paren
id|rtc_busy
c_func
(paren
)paren
)paren
suffix:semicolon
id|rtc_command
c_func
(paren
id|RTC_READREG
)paren
suffix:semicolon
r_do
(brace
r_while
c_loop
(paren
op_logical_neg
id|rtc_data_available
c_func
(paren
)paren
)paren
suffix:semicolon
id|s
op_assign
id|rtc_status
c_func
(paren
)paren
suffix:semicolon
id|ret
op_assign
id|rtc_read_data
c_func
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|s
op_amp
id|RTC_STAT_MASK
)paren
op_ne
id|RTC_STAT_RDY
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|hp300_hwclk
r_static
r_int
id|hp300_hwclk
c_func
(paren
r_int
id|op
comma
r_struct
id|rtc_time
op_star
id|t
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|op
)paren
(brace
multiline_comment|/* read */
id|t-&gt;tm_sec
op_assign
id|hp300_rtc_read
c_func
(paren
id|RTC_REG_SEC1
)paren
op_star
l_int|10
op_plus
id|hp300_rtc_read
c_func
(paren
id|RTC_REG_SEC2
)paren
suffix:semicolon
id|t-&gt;tm_min
op_assign
id|hp300_rtc_read
c_func
(paren
id|RTC_REG_MIN1
)paren
op_star
l_int|10
op_plus
id|hp300_rtc_read
c_func
(paren
id|RTC_REG_MIN2
)paren
suffix:semicolon
id|t-&gt;tm_hour
op_assign
(paren
id|hp300_rtc_read
c_func
(paren
id|RTC_REG_HOUR1
)paren
op_amp
l_int|3
)paren
op_star
l_int|10
op_plus
id|hp300_rtc_read
c_func
(paren
id|RTC_REG_HOUR2
)paren
suffix:semicolon
id|t-&gt;tm_wday
op_assign
op_minus
l_int|1
suffix:semicolon
id|t-&gt;tm_mday
op_assign
id|hp300_rtc_read
c_func
(paren
id|RTC_REG_DAY1
)paren
op_star
l_int|10
op_plus
id|hp300_rtc_read
c_func
(paren
id|RTC_REG_DAY2
)paren
suffix:semicolon
id|t-&gt;tm_mon
op_assign
id|hp300_rtc_read
c_func
(paren
id|RTC_REG_MON1
)paren
op_star
l_int|10
op_plus
id|hp300_rtc_read
c_func
(paren
id|RTC_REG_MON2
)paren
op_minus
l_int|1
suffix:semicolon
id|t-&gt;tm_year
op_assign
id|hp300_rtc_read
c_func
(paren
id|RTC_REG_YEAR1
)paren
op_star
l_int|10
op_plus
id|hp300_rtc_read
c_func
(paren
id|RTC_REG_YEAR2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|t-&gt;tm_year
op_le
l_int|69
)paren
id|t-&gt;tm_year
op_add_assign
l_int|100
suffix:semicolon
)brace
r_else
(brace
id|hp300_rtc_write
c_func
(paren
id|RTC_REG_SEC1
comma
id|t-&gt;tm_sec
op_div
l_int|10
)paren
suffix:semicolon
id|hp300_rtc_write
c_func
(paren
id|RTC_REG_SEC2
comma
id|t-&gt;tm_sec
op_mod
l_int|10
)paren
suffix:semicolon
id|hp300_rtc_write
c_func
(paren
id|RTC_REG_MIN1
comma
id|t-&gt;tm_min
op_div
l_int|10
)paren
suffix:semicolon
id|hp300_rtc_write
c_func
(paren
id|RTC_REG_MIN2
comma
id|t-&gt;tm_min
op_mod
l_int|10
)paren
suffix:semicolon
id|hp300_rtc_write
c_func
(paren
id|RTC_REG_HOUR1
comma
(paren
(paren
id|t-&gt;tm_hour
op_div
l_int|10
)paren
op_amp
l_int|3
)paren
op_or
id|RTC_HOUR1_24HMODE
)paren
suffix:semicolon
id|hp300_rtc_write
c_func
(paren
id|RTC_REG_HOUR2
comma
id|t-&gt;tm_hour
op_mod
l_int|10
)paren
suffix:semicolon
id|hp300_rtc_write
c_func
(paren
id|RTC_REG_DAY1
comma
id|t-&gt;tm_mday
op_div
l_int|10
)paren
suffix:semicolon
id|hp300_rtc_write
c_func
(paren
id|RTC_REG_DAY2
comma
id|t-&gt;tm_mday
op_mod
l_int|10
)paren
suffix:semicolon
id|hp300_rtc_write
c_func
(paren
id|RTC_REG_MON1
comma
(paren
id|t-&gt;tm_mon
op_plus
l_int|1
)paren
op_div
l_int|10
)paren
suffix:semicolon
id|hp300_rtc_write
c_func
(paren
id|RTC_REG_MON2
comma
(paren
id|t-&gt;tm_mon
op_plus
l_int|1
)paren
op_mod
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|t-&gt;tm_year
op_ge
l_int|100
)paren
id|t-&gt;tm_year
op_sub_assign
l_int|100
suffix:semicolon
id|hp300_rtc_write
c_func
(paren
id|RTC_REG_YEAR1
comma
id|t-&gt;tm_year
op_div
l_int|10
)paren
suffix:semicolon
id|hp300_rtc_write
c_func
(paren
id|RTC_REG_YEAR2
comma
id|t-&gt;tm_year
op_mod
l_int|10
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hp300_get_ss
r_static
r_int
r_int
id|hp300_get_ss
c_func
(paren
r_void
)paren
(brace
r_return
id|hp300_rtc_read
c_func
(paren
id|RTC_REG_SEC1
)paren
op_star
l_int|10
op_plus
id|hp300_rtc_read
c_func
(paren
id|RTC_REG_SEC2
)paren
suffix:semicolon
)brace
DECL|function|config_hp300
r_void
id|__init
id|config_hp300
c_func
(paren
r_void
)paren
(brace
id|mach_sched_init
op_assign
id|hp300_sched_init
suffix:semicolon
id|mach_init_IRQ
op_assign
id|hp300_init_IRQ
suffix:semicolon
id|mach_request_irq
op_assign
id|hp300_request_irq
suffix:semicolon
id|mach_free_irq
op_assign
id|hp300_free_irq
suffix:semicolon
id|mach_get_model
op_assign
id|hp300_get_model
suffix:semicolon
id|mach_get_irq_list
op_assign
id|show_hp300_interrupts
suffix:semicolon
id|mach_gettimeoffset
op_assign
id|hp300_gettimeoffset
suffix:semicolon
id|mach_default_handler
op_assign
op_amp
id|hp300_default_handler
suffix:semicolon
id|mach_hwclk
op_assign
id|hp300_hwclk
suffix:semicolon
id|mach_get_ss
op_assign
id|hp300_get_ss
suffix:semicolon
id|mach_reset
op_assign
id|hp300_reset
suffix:semicolon
macro_line|#ifdef CONFIG_HEARTBEAT
id|mach_heartbeat
op_assign
id|hp300_pulse
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_DUMMY_CONSOLE
id|conswitchp
op_assign
op_amp
id|dummy_con
suffix:semicolon
macro_line|#endif
id|mach_max_dma_address
op_assign
l_int|0xffffffff
suffix:semicolon
r_if
c_cond
(paren
id|hp300_model
op_ge
id|HP_330
op_logical_and
id|hp300_model
op_le
id|HP_433S
op_logical_and
id|hp300_model
op_ne
id|HP_350
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Detected HP9000 model %s&bslash;n&quot;
comma
id|hp300_models
(braket
id|hp300_model
op_minus
id|HP_320
)braket
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|hp300_model_name
comma
id|hp300_models
(braket
id|hp300_model
op_minus
id|HP_320
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|panic
c_func
(paren
l_string|&quot;Unknown HP9000 Model&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SERIAL_8250_CONSOLE
id|hp300_setup_serial_console
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
eof
