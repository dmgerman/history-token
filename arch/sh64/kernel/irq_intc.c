multiline_comment|/*&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * arch/sh64/kernel/irq_intc.c&n; *&n; * Copyright (C) 2000, 2001  Paolo Alberelli&n; * Copyright (C) 2003  Paul Mundt&n; *&n; * Interrupt Controller support for SH5 INTC.&n; * Per-interrupt selective. IRLM=0 (Fixed priority) is not&n; * supported being useless without a cascaded interrupt&n; * controller.&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/platform.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;&t;&t;/* this includes also &lt;asm/registers.h */
multiline_comment|/* which is required to remap register */
multiline_comment|/* names used into __asm__ blocks...   */
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
multiline_comment|/*&n; * Maybe the generic Peripheral block could move to a more&n; * generic include file. INTC Block will be defined here&n; * and only here to make INTC self-contained in a single&n; * file.&n; */
DECL|macro|INTC_BLOCK_OFFSET
mdefine_line|#define&t;INTC_BLOCK_OFFSET&t;0x01000000
multiline_comment|/* Base */
DECL|macro|INTC_BASE
mdefine_line|#define INTC_BASE&t;&t;PHYS_PERIPHERAL_BLOCK + &bslash;&n;&t;&t;&t;&t;INTC_BLOCK_OFFSET
multiline_comment|/* Address */
DECL|macro|INTC_ICR_SET
mdefine_line|#define INTC_ICR_SET&t;&t;(intc_virt + 0x0)
DECL|macro|INTC_ICR_CLEAR
mdefine_line|#define INTC_ICR_CLEAR&t;&t;(intc_virt + 0x8)
DECL|macro|INTC_INTPRI_0
mdefine_line|#define INTC_INTPRI_0&t;&t;(intc_virt + 0x10)
DECL|macro|INTC_INTSRC_0
mdefine_line|#define INTC_INTSRC_0&t;&t;(intc_virt + 0x50)
DECL|macro|INTC_INTSRC_1
mdefine_line|#define INTC_INTSRC_1&t;&t;(intc_virt + 0x58)
DECL|macro|INTC_INTREQ_0
mdefine_line|#define INTC_INTREQ_0&t;&t;(intc_virt + 0x60)
DECL|macro|INTC_INTREQ_1
mdefine_line|#define INTC_INTREQ_1&t;&t;(intc_virt + 0x68)
DECL|macro|INTC_INTENB_0
mdefine_line|#define INTC_INTENB_0&t;&t;(intc_virt + 0x70)
DECL|macro|INTC_INTENB_1
mdefine_line|#define INTC_INTENB_1&t;&t;(intc_virt + 0x78)
DECL|macro|INTC_INTDSB_0
mdefine_line|#define INTC_INTDSB_0&t;&t;(intc_virt + 0x80)
DECL|macro|INTC_INTDSB_1
mdefine_line|#define INTC_INTDSB_1&t;&t;(intc_virt + 0x88)
DECL|macro|INTC_ICR_IRLM
mdefine_line|#define INTC_ICR_IRLM&t;&t;0x1
DECL|macro|INTC_INTPRI_PREGS
mdefine_line|#define&t;INTC_INTPRI_PREGS&t;8&t;&t;/* 8 Priority Registers */
DECL|macro|INTC_INTPRI_PPREG
mdefine_line|#define&t;INTC_INTPRI_PPREG&t;8&t;&t;/* 8 Priorities per Register */
multiline_comment|/*&n; * Mapper between the vector ordinal and the IRQ number&n; * passed to kernel/device drivers.&n; */
DECL|variable|intc_evt_to_irq
r_int
id|intc_evt_to_irq
(braket
(paren
l_int|0xE20
op_div
l_int|0x20
)paren
op_plus
l_int|1
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
multiline_comment|/* 0x000 - 0x0E0 */
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
multiline_comment|/* 0x100 - 0x1E0 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 0x200 - 0x2E0 */
l_int|2
comma
l_int|0
comma
l_int|0
comma
l_int|3
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
multiline_comment|/* 0x300 - 0x3E0 */
l_int|32
comma
l_int|33
comma
l_int|34
comma
l_int|35
comma
l_int|36
comma
l_int|37
comma
l_int|38
comma
op_minus
l_int|1
comma
multiline_comment|/* 0x400 - 0x4E0 */
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|63
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
multiline_comment|/* 0x500 - 0x5E0 */
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|18
comma
l_int|19
comma
l_int|20
comma
l_int|21
comma
l_int|22
comma
op_minus
l_int|1
comma
multiline_comment|/* 0x600 - 0x6E0 */
l_int|39
comma
l_int|40
comma
l_int|41
comma
l_int|42
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
multiline_comment|/* 0x700 - 0x7E0 */
l_int|4
comma
l_int|5
comma
l_int|6
comma
l_int|7
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
multiline_comment|/* 0x800 - 0x8E0 */
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
multiline_comment|/* 0x900 - 0x9E0 */
l_int|12
comma
l_int|13
comma
l_int|14
comma
l_int|15
comma
l_int|16
comma
l_int|17
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
multiline_comment|/* 0xA00 - 0xAE0 */
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
multiline_comment|/* 0xB00 - 0xBE0 */
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
multiline_comment|/* 0xC00 - 0xCE0 */
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
multiline_comment|/* 0xD00 - 0xDE0 */
op_minus
l_int|1
comma
op_minus
l_int|1
multiline_comment|/* 0xE00 - 0xE20 */
)brace
suffix:semicolon
multiline_comment|/*&n; * Opposite mapper.&n; */
DECL|variable|IRQ_to_vectorN
r_static
r_int
id|IRQ_to_vectorN
(braket
id|NR_INTC_IRQS
)braket
op_assign
(brace
l_int|0x12
comma
l_int|0x15
comma
l_int|0x18
comma
l_int|0x1B
comma
l_int|0x40
comma
l_int|0x41
comma
l_int|0x42
comma
l_int|0x43
comma
multiline_comment|/*  0- 7 */
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0x50
comma
l_int|0x51
comma
l_int|0x52
comma
l_int|0x53
comma
multiline_comment|/*  8-15 */
l_int|0x54
comma
l_int|0x55
comma
l_int|0x32
comma
l_int|0x33
comma
l_int|0x34
comma
l_int|0x35
comma
l_int|0x36
comma
op_minus
l_int|1
comma
multiline_comment|/* 16-23 */
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
multiline_comment|/* 24-31 */
l_int|0x20
comma
l_int|0x21
comma
l_int|0x22
comma
l_int|0x23
comma
l_int|0x24
comma
l_int|0x25
comma
l_int|0x26
comma
l_int|0x38
comma
multiline_comment|/* 32-39 */
l_int|0x39
comma
l_int|0x3A
comma
l_int|0x3B
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
multiline_comment|/* 40-47 */
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
multiline_comment|/* 48-55 */
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0x2B
comma
multiline_comment|/* 56-63 */
)brace
suffix:semicolon
DECL|variable|intc_virt
r_static
r_int
r_int
id|intc_virt
suffix:semicolon
r_static
r_int
r_int
id|startup_intc_irq
c_func
(paren
r_int
r_int
id|irq
)paren
suffix:semicolon
r_static
r_void
id|shutdown_intc_irq
c_func
(paren
r_int
r_int
id|irq
)paren
suffix:semicolon
r_static
r_void
id|enable_intc_irq
c_func
(paren
r_int
r_int
id|irq
)paren
suffix:semicolon
r_static
r_void
id|disable_intc_irq
c_func
(paren
r_int
r_int
id|irq
)paren
suffix:semicolon
r_static
r_void
id|mask_and_ack_intc
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|end_intc_irq
c_func
(paren
r_int
r_int
id|irq
)paren
suffix:semicolon
DECL|variable|intc_irq_type
r_static
r_struct
id|hw_interrupt_type
id|intc_irq_type
op_assign
(brace
l_string|&quot;INTC&quot;
comma
id|startup_intc_irq
comma
id|shutdown_intc_irq
comma
id|enable_intc_irq
comma
id|disable_intc_irq
comma
id|mask_and_ack_intc
comma
id|end_intc_irq
)brace
suffix:semicolon
DECL|variable|irlm
r_static
r_int
id|irlm
suffix:semicolon
multiline_comment|/* IRL mode */
DECL|function|startup_intc_irq
r_static
r_int
r_int
id|startup_intc_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|enable_intc_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* never anything pending */
)brace
DECL|function|shutdown_intc_irq
r_static
r_void
id|shutdown_intc_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|disable_intc_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|enable_intc_irq
r_static
r_void
id|enable_intc_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_int
id|reg
suffix:semicolon
r_int
r_int
id|bitmask
suffix:semicolon
r_if
c_cond
(paren
(paren
id|irq
op_le
id|IRQ_IRL3
)paren
op_logical_and
(paren
id|irlm
op_eq
id|NO_PRIORITY
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;Trying to use straight IRL0-3 with an encoding platform.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq
OL
l_int|32
)paren
(brace
id|reg
op_assign
id|INTC_INTENB_0
suffix:semicolon
id|bitmask
op_assign
l_int|1
op_lshift
id|irq
suffix:semicolon
)brace
r_else
(brace
id|reg
op_assign
id|INTC_INTENB_1
suffix:semicolon
id|bitmask
op_assign
l_int|1
op_lshift
(paren
id|irq
op_minus
l_int|32
)paren
suffix:semicolon
)brace
id|ctrl_outl
c_func
(paren
id|bitmask
comma
id|reg
)paren
suffix:semicolon
)brace
DECL|function|disable_intc_irq
r_static
r_void
id|disable_intc_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_int
id|reg
suffix:semicolon
r_int
r_int
id|bitmask
suffix:semicolon
r_if
c_cond
(paren
id|irq
OL
l_int|32
)paren
(brace
id|reg
op_assign
id|INTC_INTDSB_0
suffix:semicolon
id|bitmask
op_assign
l_int|1
op_lshift
id|irq
suffix:semicolon
)brace
r_else
(brace
id|reg
op_assign
id|INTC_INTDSB_1
suffix:semicolon
id|bitmask
op_assign
l_int|1
op_lshift
(paren
id|irq
op_minus
l_int|32
)paren
suffix:semicolon
)brace
id|ctrl_outl
c_func
(paren
id|bitmask
comma
id|reg
)paren
suffix:semicolon
)brace
DECL|function|mask_and_ack_intc
r_static
r_void
id|mask_and_ack_intc
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|disable_intc_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|end_intc_irq
r_static
r_void
id|end_intc_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|enable_intc_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
multiline_comment|/* For future use, if we ever support IRLM=0) */
DECL|function|make_intc_irq
r_void
id|make_intc_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|disable_irq_nosync
c_func
(paren
id|irq
)paren
suffix:semicolon
id|irq_desc
(braket
id|irq
)braket
dot
id|handler
op_assign
op_amp
id|intc_irq_type
suffix:semicolon
id|disable_intc_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
macro_line|#if defined(CONFIG_PROC_FS) &amp;&amp; defined(CONFIG_SYSCTL)
DECL|function|intc_irq_describe
r_int
id|intc_irq_describe
c_func
(paren
r_char
op_star
id|p
comma
r_int
id|irq
)paren
(brace
r_if
c_cond
(paren
id|irq
OL
id|NR_INTC_IRQS
)paren
r_return
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;(0x%3x)&quot;
comma
id|IRQ_to_vectorN
(braket
id|irq
)braket
op_star
l_int|0x20
)paren
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|init_IRQ
r_void
id|__init
id|init_IRQ
c_func
(paren
r_void
)paren
(brace
r_int
r_int
r_int
id|__dummy0
comma
id|__dummy1
op_assign
op_complement
l_int|0x00000000100000f0
suffix:semicolon
r_int
r_int
id|reg
suffix:semicolon
r_int
r_int
id|data
suffix:semicolon
r_int
id|i
suffix:semicolon
id|intc_virt
op_assign
id|onchip_remap
c_func
(paren
id|INTC_BASE
comma
l_int|1024
comma
l_string|&quot;INTC&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intc_virt
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Unable to remap INTC&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Set default: per-line enable/disable, priority driven ack/eoi */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_INTC_IRQS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|platform_int_priority
(braket
id|i
)braket
op_ne
id|NO_PRIORITY
)paren
(brace
id|irq_desc
(braket
id|i
)braket
dot
id|handler
op_assign
op_amp
id|intc_irq_type
suffix:semicolon
)brace
)brace
multiline_comment|/* Disable all interrupts and set all priorities to 0 to avoid trouble */
id|ctrl_outl
c_func
(paren
op_minus
l_int|1
comma
id|INTC_INTDSB_0
)paren
suffix:semicolon
id|ctrl_outl
c_func
(paren
op_minus
l_int|1
comma
id|INTC_INTDSB_1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|reg
op_assign
id|INTC_INTPRI_0
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|INTC_INTPRI_PREGS
suffix:semicolon
id|i
op_increment
comma
id|reg
op_add_assign
l_int|8
)paren
id|ctrl_outl
c_func
(paren
id|NO_PRIORITY
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* Set IRLM */
multiline_comment|/* If all the priorities are set to &squot;no priority&squot;, then&n;&t; * assume we are using encoded mode.&n;&t; */
id|irlm
op_assign
id|platform_int_priority
(braket
id|IRQ_IRL0
)braket
op_plus
id|platform_int_priority
(braket
id|IRQ_IRL1
)braket
op_plus
"&bslash;"
id|platform_int_priority
(braket
id|IRQ_IRL2
)braket
op_plus
id|platform_int_priority
(braket
id|IRQ_IRL3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|irlm
op_eq
id|NO_PRIORITY
)paren
(brace
multiline_comment|/* IRLM = 0 */
id|reg
op_assign
id|INTC_ICR_CLEAR
suffix:semicolon
id|i
op_assign
id|IRQ_INTA
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Trying to use encoded IRL0-3. IRLs unsupported.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* IRLM = 1 */
id|reg
op_assign
id|INTC_ICR_SET
suffix:semicolon
id|i
op_assign
id|IRQ_IRL0
suffix:semicolon
)brace
id|ctrl_outl
c_func
(paren
id|INTC_ICR_IRLM
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* Set interrupt priorities according to platform description */
r_for
c_loop
(paren
id|data
op_assign
l_int|0
comma
id|reg
op_assign
id|INTC_INTPRI_0
suffix:semicolon
id|i
OL
id|NR_INTC_IRQS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|data
op_or_assign
id|platform_int_priority
(braket
id|i
)braket
op_lshift
(paren
(paren
id|i
op_mod
id|INTC_INTPRI_PPREG
)paren
op_star
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_mod
id|INTC_INTPRI_PPREG
)paren
op_eq
(paren
id|INTC_INTPRI_PPREG
op_minus
l_int|1
)paren
)paren
(brace
multiline_comment|/* Upon the 7th, set Priority Register */
id|ctrl_outl
c_func
(paren
id|data
comma
id|reg
)paren
suffix:semicolon
id|data
op_assign
l_int|0
suffix:semicolon
id|reg
op_add_assign
l_int|8
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_SH_CAYMAN
(brace
r_extern
r_void
id|init_cayman_irq
c_func
(paren
r_void
)paren
suffix:semicolon
id|init_cayman_irq
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t; * And now let interrupts come in.&n;&t; * sti() is not enough, we need to&n;&t; * lower priority, too.&n;&t; */
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;getcon    &quot;
id|__SR
l_string|&quot;, %0&bslash;n&bslash;t&quot;
l_string|&quot;and       %0, %1, %0&bslash;n&bslash;t&quot;
l_string|&quot;putcon    %0, &quot;
id|__SR
l_string|&quot;&bslash;n&bslash;t&quot;
suffix:colon
l_string|&quot;=&amp;r&quot;
(paren
id|__dummy0
)paren
suffix:colon
l_string|&quot;r&quot;
(paren
id|__dummy1
)paren
)paren
suffix:semicolon
)brace
eof
