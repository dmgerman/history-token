multiline_comment|/*&n; * Copyright (C) 2001 David J. Mckay (david.mckay@st.com)&n; * Copyright (C) 2003, 2004 Paul Mundt&n; * Copyright (C) 2004 Richard Curnow&n; *&n; * May be copied or modified under the terms of the GNU General Public&n; * License.  See linux/COPYING for more information.&n; *&n; * Support functions for the SH5 PCI hardware.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/rwsem.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;asm/pci.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &quot;pci_sh5.h&quot;
DECL|variable|pcicr_virt
r_static
r_int
r_int
id|pcicr_virt
suffix:semicolon
DECL|variable|pciio_virt
r_int
r_int
id|pciio_virt
suffix:semicolon
DECL|function|pci_fixup_ide_bases
r_static
r_void
id|__init
id|pci_fixup_ide_bases
c_func
(paren
r_struct
id|pci_dev
op_star
id|d
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * PCI IDE controllers use non-standard I/O port decoding, respect it.&n;&t; */
r_if
c_cond
(paren
(paren
id|d
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_ne
id|PCI_CLASS_STORAGE_IDE
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI: IDE base address fixup for %s&bslash;n&quot;
comma
id|d-&gt;slot_name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|resource
op_star
id|r
op_assign
op_amp
id|d-&gt;resource
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r-&gt;start
op_amp
op_complement
l_int|0x80
)paren
op_eq
l_int|0x374
)paren
(brace
id|r-&gt;start
op_or_assign
l_int|2
suffix:semicolon
id|r-&gt;end
op_assign
id|r-&gt;start
suffix:semicolon
)brace
)brace
)brace
id|DECLARE_PCI_FIXUP_HEADER
c_func
(paren
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|pci_fixup_ide_bases
)paren
suffix:semicolon
DECL|function|pcibios_setup
r_char
op_star
id|__init
id|pcibios_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_return
id|str
suffix:semicolon
)brace
multiline_comment|/* Rounds a number UP to the nearest power of two. Used for&n; * sizing the PCI window.&n; */
DECL|function|r2p2
r_static
id|u32
id|__init
id|r2p2
c_func
(paren
id|u32
id|num
)paren
(brace
r_int
id|i
op_assign
l_int|31
suffix:semicolon
id|u32
id|tmp
op_assign
id|num
suffix:semicolon
r_if
c_cond
(paren
id|num
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|tmp
op_amp
(paren
l_int|1
op_lshift
l_int|31
)paren
)paren
r_break
suffix:semicolon
id|i
op_decrement
suffix:semicolon
id|tmp
op_lshift_assign
l_int|1
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
op_ge
l_int|0
)paren
suffix:semicolon
id|tmp
op_assign
l_int|1
op_lshift
id|i
suffix:semicolon
multiline_comment|/* If the original number isn&squot;t a power of 2, round it up */
r_if
c_cond
(paren
id|tmp
op_ne
id|num
)paren
id|tmp
op_lshift_assign
l_int|1
suffix:semicolon
r_return
id|tmp
suffix:semicolon
)brace
r_extern
r_int
r_int
r_int
id|memory_start
comma
id|memory_end
suffix:semicolon
DECL|function|sh5pci_init
r_int
id|__init
id|sh5pci_init
c_func
(paren
r_int
id|memStart
comma
r_int
id|memSize
)paren
(brace
id|u32
id|lsr0
suffix:semicolon
id|u32
id|uval
suffix:semicolon
id|pcicr_virt
op_assign
id|onchip_remap
c_func
(paren
id|SH5PCI_ICR_BASE
comma
l_int|1024
comma
l_string|&quot;PCICR&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pcicr_virt
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Unable to remap PCICR&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|pciio_virt
op_assign
id|onchip_remap
c_func
(paren
id|SH5PCI_IO_BASE
comma
l_int|0x10000
comma
l_string|&quot;PCIIO&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pciio_virt
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;Unable to remap PCIIO&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|pr_debug
c_func
(paren
l_string|&quot;Register base addres is 0x%08lx&bslash;n&quot;
comma
id|pcicr_virt
)paren
suffix:semicolon
multiline_comment|/* Clear snoop registers */
id|SH5PCI_WRITE
c_func
(paren
id|CSCR0
comma
l_int|0
)paren
suffix:semicolon
id|SH5PCI_WRITE
c_func
(paren
id|CSCR1
comma
l_int|0
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;Wrote to reg&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Switch off interrupts */
id|SH5PCI_WRITE
c_func
(paren
id|INTM
comma
l_int|0
)paren
suffix:semicolon
id|SH5PCI_WRITE
c_func
(paren
id|AINTM
comma
l_int|0
)paren
suffix:semicolon
id|SH5PCI_WRITE
c_func
(paren
id|PINTM
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set bus active, take it out of reset */
id|uval
op_assign
id|SH5PCI_READ
c_func
(paren
id|CR
)paren
suffix:semicolon
multiline_comment|/* Set command Register */
id|SH5PCI_WRITE
c_func
(paren
id|CR
comma
id|uval
op_or
id|CR_LOCK_MASK
op_or
id|CR_CFINT
op_or
id|CR_FTO
op_or
id|CR_PFE
op_or
id|CR_PFCS
op_or
id|CR_BMAM
)paren
suffix:semicolon
id|uval
op_assign
id|SH5PCI_READ
c_func
(paren
id|CR
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;CR is actually 0x%08x&bslash;n&quot;
comma
id|uval
)paren
suffix:semicolon
multiline_comment|/* Allow it to be a master */
multiline_comment|/* NB - WE DISABLE I/O ACCESS to stop overlap */
multiline_comment|/* set WAIT bit to enable stepping, an attempt to improve stability */
id|SH5PCI_WRITE_SHORT
c_func
(paren
id|CSR_CMD
comma
id|PCI_COMMAND_MEMORY
op_or
id|PCI_COMMAND_MASTER
op_or
id|PCI_COMMAND_WAIT
)paren
suffix:semicolon
multiline_comment|/*&n;        ** Set translation mapping memory in order to convert the address&n;        ** used for the main bus, to the PCI internal address.&n;        */
id|SH5PCI_WRITE
c_func
(paren
id|MBR
comma
l_int|0x40000000
)paren
suffix:semicolon
multiline_comment|/* Always set the max size 512M */
id|SH5PCI_WRITE
c_func
(paren
id|MBMR
comma
id|PCISH5_MEM_SIZCONV
c_func
(paren
l_int|512
op_star
l_int|1024
op_star
l_int|1024
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;        ** I/O addresses are mapped at internal PCI specific address&n;        ** as is described into the configuration bridge table.&n;        ** These are changed to 0, to allow cards that have legacy&n;        ** io such as vga to function correctly. We set the SH5 IOBAR to&n;        ** 256K, which is a bit big as we can only have 64K of address space&n;        */
id|SH5PCI_WRITE
c_func
(paren
id|IOBR
comma
l_int|0x0
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;PCI:Writing 0x%08x to IOBR&bslash;n&quot;
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set up a 256K window. Totally pointless waste  of address space */
id|SH5PCI_WRITE
c_func
(paren
id|IOBMR
comma
l_int|0
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;PCI:Writing 0x%08x to IOBMR&bslash;n&quot;
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* The SH5 has a HUGE 256K I/O region, which breaks the PCI spec. Ideally,&n;         * we would want to map the I/O region somewhere, but it is so big this is not&n;         * that easy!&n;         */
id|SH5PCI_WRITE
c_func
(paren
id|CSR_IBAR0
comma
op_complement
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set memory size value */
id|memSize
op_assign
id|memory_end
op_minus
id|memory_start
suffix:semicolon
multiline_comment|/* Now we set up the mbars so the PCI bus can see the memory of the machine */
r_if
c_cond
(paren
id|memSize
OL
(paren
l_int|1024
op_star
l_int|1024
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PCISH5: Ridiculous memory size of 0x%x?&bslash;n&quot;
comma
id|memSize
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Set LSR 0 */
id|lsr0
op_assign
(paren
id|memSize
OG
(paren
l_int|512
op_star
l_int|1024
op_star
l_int|1024
)paren
)paren
ques
c_cond
l_int|0x1ff00001
suffix:colon
(paren
(paren
id|r2p2
c_func
(paren
id|memSize
)paren
op_minus
l_int|0x100000
)paren
op_or
l_int|0x1
)paren
suffix:semicolon
id|SH5PCI_WRITE
c_func
(paren
id|LSR0
comma
id|lsr0
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;PCI:Writing 0x%08x to LSR0&bslash;n&quot;
comma
id|lsr0
)paren
suffix:semicolon
multiline_comment|/* Set MBAR 0 */
id|SH5PCI_WRITE
c_func
(paren
id|CSR_MBAR0
comma
id|memory_start
)paren
suffix:semicolon
id|SH5PCI_WRITE
c_func
(paren
id|LAR0
comma
id|memory_start
)paren
suffix:semicolon
id|SH5PCI_WRITE
c_func
(paren
id|CSR_MBAR1
comma
l_int|0
)paren
suffix:semicolon
id|SH5PCI_WRITE
c_func
(paren
id|LAR1
comma
l_int|0
)paren
suffix:semicolon
id|SH5PCI_WRITE
c_func
(paren
id|LSR1
comma
l_int|0
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;PCI:Writing 0x%08llx to CSR_MBAR0&bslash;n&quot;
comma
id|memory_start
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;PCI:Writing 0x%08llx to LAR0&bslash;n&quot;
comma
id|memory_start
)paren
suffix:semicolon
multiline_comment|/* Enable the PCI interrupts on the device */
id|SH5PCI_WRITE
c_func
(paren
id|INTM
comma
op_complement
l_int|0
)paren
suffix:semicolon
id|SH5PCI_WRITE
c_func
(paren
id|AINTM
comma
op_complement
l_int|0
)paren
suffix:semicolon
id|SH5PCI_WRITE
c_func
(paren
id|PINTM
comma
op_complement
l_int|0
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;Switching on all error interrupts&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sh5pci_read
r_static
r_int
id|sh5pci_read
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
op_star
id|val
)paren
(brace
id|SH5PCI_WRITE
c_func
(paren
id|PAR
comma
id|CONFIG_CMD
c_func
(paren
id|bus
comma
id|devfn
comma
id|where
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
l_int|1
suffix:colon
op_star
id|val
op_assign
(paren
id|u8
)paren
id|SH5PCI_READ_BYTE
c_func
(paren
id|PDR
op_plus
(paren
id|where
op_amp
l_int|3
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
op_star
id|val
op_assign
(paren
id|u16
)paren
id|SH5PCI_READ_SHORT
c_func
(paren
id|PDR
op_plus
(paren
id|where
op_amp
l_int|2
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
op_star
id|val
op_assign
id|SH5PCI_READ
c_func
(paren
id|PDR
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|function|sh5pci_write
r_static
r_int
id|sh5pci_write
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_int
r_int
id|devfn
comma
r_int
id|where
comma
r_int
id|size
comma
id|u32
id|val
)paren
(brace
id|SH5PCI_WRITE
c_func
(paren
id|PAR
comma
id|CONFIG_CMD
c_func
(paren
id|bus
comma
id|devfn
comma
id|where
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
l_int|1
suffix:colon
id|SH5PCI_WRITE_BYTE
c_func
(paren
id|PDR
op_plus
(paren
id|where
op_amp
l_int|3
)paren
comma
(paren
id|u8
)paren
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|SH5PCI_WRITE_SHORT
c_func
(paren
id|PDR
op_plus
(paren
id|where
op_amp
l_int|2
)paren
comma
(paren
id|u16
)paren
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|SH5PCI_WRITE
c_func
(paren
id|PDR
comma
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
)brace
DECL|variable|pci_config_ops
r_static
r_struct
id|pci_ops
id|pci_config_ops
op_assign
(brace
dot
id|read
op_assign
id|sh5pci_read
comma
dot
id|write
op_assign
id|sh5pci_write
comma
)brace
suffix:semicolon
multiline_comment|/* Everything hangs off this */
DECL|variable|pci_root_bus
r_static
r_struct
id|pci_bus
op_star
id|pci_root_bus
suffix:semicolon
DECL|function|no_swizzle
r_static
id|u8
id|__init
id|no_swizzle
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
id|u8
op_star
id|pin
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;swizzle for dev %d on bus %d slot %d pin is %d&bslash;n&quot;
comma
id|dev-&gt;devfn
comma
id|dev-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
comma
op_star
id|pin
)paren
suffix:semicolon
r_return
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
suffix:semicolon
)brace
DECL|function|bridge_swizzle
r_static
r_inline
id|u8
id|bridge_swizzle
c_func
(paren
id|u8
id|pin
comma
id|u8
id|slot
)paren
(brace
r_return
(paren
(paren
(paren
id|pin
op_minus
l_int|1
)paren
op_plus
id|slot
)paren
op_mod
l_int|4
)paren
op_plus
l_int|1
suffix:semicolon
)brace
DECL|function|common_swizzle
id|u8
id|__init
id|common_swizzle
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
id|u8
op_star
id|pinp
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;bus-&gt;number
op_ne
l_int|0
)paren
(brace
id|u8
id|pin
op_assign
op_star
id|pinp
suffix:semicolon
r_do
(brace
id|pin
op_assign
id|bridge_swizzle
c_func
(paren
id|pin
comma
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
)paren
suffix:semicolon
multiline_comment|/* Move up the chain of bridges. */
id|dev
op_assign
id|dev-&gt;bus-&gt;self
suffix:semicolon
)brace
r_while
c_loop
(paren
id|dev-&gt;bus-&gt;self
)paren
suffix:semicolon
op_star
id|pinp
op_assign
id|pin
suffix:semicolon
multiline_comment|/* The slot is the slot of the last bridge. */
)brace
r_return
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
suffix:semicolon
)brace
multiline_comment|/* This needs to be shunted out of here into the board specific bit */
DECL|function|map_cayman_irq
r_static
r_int
id|__init
id|map_cayman_irq
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
id|u8
id|slot
comma
id|u8
id|pin
)paren
(brace
r_int
id|result
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* The complication here is that the PCI IRQ lines from the Cayman&squot;s 2&n;&t;   5V slots get into the CPU via a different path from the IRQ lines&n;&t;   from the 3 3.3V slots.  Thus, we have to detect whether the card&squot;s&n;&t;   interrupts go via the 5V or 3.3V path, i.e. the &squot;bridge swizzling&squot;&n;&t;   at the point where we cross from 5V to 3.3V is not the normal case.&n;&n;&t;   The added complication is that we don&squot;t know that the 5V slots are&n;&t;   always bus 2, because a card containing a PCI-PCI bridge may be&n;&t;   plugged into a 3.3V slot, and this changes the bus numbering.&n;&n;&t;   Also, the Cayman has an intermediate PCI bus that goes a custom&n;&t;   expansion board header (and to the secondary bridge).  This bus has&n;&t;   never been used in practice.&n;&n;&t;   The 1ary onboard PCI-PCI bridge is device 3 on bus 0&n;&t;   The 2ary onboard PCI-PCI bridge is device 0 on the 2ary bus of the 1ary bridge.&n;&t;   */
r_struct
id|slot_pin
(brace
r_int
id|slot
suffix:semicolon
r_int
id|pin
suffix:semicolon
)brace
id|path
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|dev-&gt;bus-&gt;number
OG
l_int|0
)paren
(brace
id|slot
op_assign
id|path
(braket
id|i
)braket
dot
id|slot
op_assign
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
suffix:semicolon
id|pin
op_assign
id|path
(braket
id|i
)braket
dot
id|pin
op_assign
id|bridge_swizzle
c_func
(paren
id|pin
comma
id|slot
)paren
suffix:semicolon
id|dev
op_assign
id|dev-&gt;bus-&gt;self
suffix:semicolon
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|3
)paren
id|panic
c_func
(paren
l_string|&quot;PCI path to root bus too long!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|slot
op_assign
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
suffix:semicolon
multiline_comment|/* This is the slot on bus 0 through which the device is eventually&n;&t;   reachable. */
multiline_comment|/* Now work back up. */
r_if
c_cond
(paren
(paren
id|slot
OL
l_int|3
)paren
op_logical_or
(paren
id|i
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/* Bus 0 (incl. PCI-PCI bridge itself) : perform the final&n;&t;&t;   swizzle now. */
id|result
op_assign
id|IRQ_INTA
op_plus
id|bridge_swizzle
c_func
(paren
id|pin
comma
id|slot
)paren
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|i
op_decrement
suffix:semicolon
id|slot
op_assign
id|path
(braket
id|i
)braket
dot
id|slot
suffix:semicolon
id|pin
op_assign
id|path
(braket
id|i
)braket
dot
id|pin
suffix:semicolon
r_if
c_cond
(paren
id|slot
OG
l_int|0
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;PCI expansion bus device found - not handled!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|i
OG
l_int|0
)paren
(brace
multiline_comment|/* 5V slots */
id|i
op_decrement
suffix:semicolon
id|slot
op_assign
id|path
(braket
id|i
)braket
dot
id|slot
suffix:semicolon
id|pin
op_assign
id|path
(braket
id|i
)braket
dot
id|pin
suffix:semicolon
multiline_comment|/* &squot;pin&squot; was swizzled earlier wrt slot, don&squot;t do it again. */
id|result
op_assign
id|IRQ_P2INTA
op_plus
(paren
id|pin
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* IRQ for 2ary PCI-PCI bridge : unused */
id|result
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_return
id|result
suffix:semicolon
)brace
DECL|function|pcish5_err_irq
id|irqreturn_t
id|pcish5_err_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|pci_int
comma
id|pci_air
comma
id|pci_cir
comma
id|pci_aint
suffix:semicolon
id|pci_int
op_assign
id|SH5PCI_READ
c_func
(paren
id|INT
)paren
suffix:semicolon
id|pci_cir
op_assign
id|SH5PCI_READ
c_func
(paren
id|CIR
)paren
suffix:semicolon
id|pci_air
op_assign
id|SH5PCI_READ
c_func
(paren
id|AIR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_int
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI INTERRUPT (at %08llx)!&bslash;n&quot;
comma
id|regs-&gt;pc
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI INT -&gt; 0x%x&bslash;n&quot;
comma
id|pci_int
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI AIR -&gt; 0x%x&bslash;n&quot;
comma
id|pci_air
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI CIR -&gt; 0x%x&bslash;n&quot;
comma
id|pci_cir
)paren
suffix:semicolon
id|SH5PCI_WRITE
c_func
(paren
id|INT
comma
op_complement
l_int|0
)paren
suffix:semicolon
)brace
id|pci_aint
op_assign
id|SH5PCI_READ
c_func
(paren
id|AINT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_aint
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI ARB INTERRUPT!&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI AINT -&gt; 0x%x&bslash;n&quot;
comma
id|pci_aint
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI AIR -&gt; 0x%x&bslash;n&quot;
comma
id|pci_air
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI CIR -&gt; 0x%x&bslash;n&quot;
comma
id|pci_cir
)paren
suffix:semicolon
id|SH5PCI_WRITE
c_func
(paren
id|AINT
comma
op_complement
l_int|0
)paren
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|pcish5_serr_irq
id|irqreturn_t
id|pcish5_serr_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SERR IRQ&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
DECL|macro|ROUND_UP
mdefine_line|#define ROUND_UP(x, a)&t;&t;(((x) + (a) - 1) &amp; ~((a) - 1))
r_static
r_void
id|__init
DECL|function|pcibios_size_bridge
id|pcibios_size_bridge
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_struct
id|resource
op_star
id|ior
comma
r_struct
id|resource
op_star
id|memr
)paren
(brace
r_struct
id|resource
id|io_res
comma
id|mem_res
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
r_struct
id|pci_dev
op_star
id|bridge
op_assign
id|bus-&gt;self
suffix:semicolon
r_struct
id|list_head
op_star
id|ln
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bridge
)paren
r_return
suffix:semicolon
multiline_comment|/* host bridge, nothing to do */
multiline_comment|/* set reasonable default locations for pcibios_align_resource */
id|io_res.start
op_assign
id|PCIBIOS_MIN_IO
suffix:semicolon
id|mem_res.start
op_assign
id|PCIBIOS_MIN_MEM
suffix:semicolon
id|io_res.end
op_assign
id|io_res.start
suffix:semicolon
id|mem_res.end
op_assign
id|mem_res.start
suffix:semicolon
multiline_comment|/* Collect information about how our direct children are layed out. */
r_for
c_loop
(paren
id|ln
op_assign
id|bus-&gt;devices.next
suffix:semicolon
id|ln
op_ne
op_amp
id|bus-&gt;devices
suffix:semicolon
id|ln
op_assign
id|ln-&gt;next
)paren
(brace
r_int
id|i
suffix:semicolon
id|dev
op_assign
id|pci_dev_b
c_func
(paren
id|ln
)paren
suffix:semicolon
multiline_comment|/* Skip bridges for now */
r_if
c_cond
(paren
id|dev
op_member_access_from_pointer
r_class
op_rshift
l_int|8
op_eq
id|PCI_CLASS_BRIDGE_PCI
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PCI_NUM_RESOURCES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|resource
id|res
suffix:semicolon
r_int
r_int
id|size
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|res
comma
op_amp
id|dev-&gt;resource
(braket
id|i
)braket
comma
r_sizeof
(paren
id|res
)paren
)paren
suffix:semicolon
id|size
op_assign
id|res.end
op_minus
id|res.start
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|res.flags
op_amp
id|IORESOURCE_IO
)paren
(brace
id|res.start
op_assign
id|io_res.end
suffix:semicolon
id|pcibios_align_resource
c_func
(paren
id|dev
comma
op_amp
id|res
comma
id|size
comma
l_int|0
)paren
suffix:semicolon
id|io_res.end
op_assign
id|res.start
op_plus
id|size
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|res.flags
op_amp
id|IORESOURCE_MEM
)paren
(brace
id|res.start
op_assign
id|mem_res.end
suffix:semicolon
id|pcibios_align_resource
c_func
(paren
id|dev
comma
op_amp
id|res
comma
id|size
comma
l_int|0
)paren
suffix:semicolon
id|mem_res.end
op_assign
id|res.start
op_plus
id|size
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* And for all of the subordinate busses. */
r_for
c_loop
(paren
id|ln
op_assign
id|bus-&gt;children.next
suffix:semicolon
id|ln
op_ne
op_amp
id|bus-&gt;children
suffix:semicolon
id|ln
op_assign
id|ln-&gt;next
)paren
id|pcibios_size_bridge
c_func
(paren
id|pci_bus_b
c_func
(paren
id|ln
)paren
comma
op_amp
id|io_res
comma
op_amp
id|mem_res
)paren
suffix:semicolon
multiline_comment|/* turn the ending locations into sizes (subtract start) */
id|io_res.end
op_sub_assign
id|io_res.start
suffix:semicolon
id|mem_res.end
op_sub_assign
id|mem_res.start
suffix:semicolon
multiline_comment|/* Align the sizes up by bridge rules */
id|io_res.end
op_assign
id|ROUND_UP
c_func
(paren
id|io_res.end
comma
l_int|4
op_star
l_int|1024
)paren
op_minus
l_int|1
suffix:semicolon
id|mem_res.end
op_assign
id|ROUND_UP
c_func
(paren
id|mem_res.end
comma
l_int|1
op_star
l_int|1024
op_star
l_int|1024
)paren
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Adjust the bridge&squot;s allocation requirements */
id|bridge-&gt;resource
(braket
l_int|0
)braket
dot
id|end
op_assign
id|bridge-&gt;resource
(braket
l_int|0
)braket
dot
id|start
op_plus
id|io_res.end
suffix:semicolon
id|bridge-&gt;resource
(braket
l_int|1
)braket
dot
id|end
op_assign
id|bridge-&gt;resource
(braket
l_int|1
)braket
dot
id|start
op_plus
id|mem_res.end
suffix:semicolon
id|bridge-&gt;resource
(braket
id|PCI_BRIDGE_RESOURCES
)braket
dot
id|end
op_assign
id|bridge-&gt;resource
(braket
id|PCI_BRIDGE_RESOURCES
)braket
dot
id|start
op_plus
id|io_res.end
suffix:semicolon
id|bridge-&gt;resource
(braket
id|PCI_BRIDGE_RESOURCES
op_plus
l_int|1
)braket
dot
id|end
op_assign
id|bridge-&gt;resource
(braket
id|PCI_BRIDGE_RESOURCES
op_plus
l_int|1
)braket
dot
id|start
op_plus
id|mem_res.end
suffix:semicolon
multiline_comment|/* adjust parent&squot;s resource requirements */
r_if
c_cond
(paren
id|ior
)paren
(brace
id|ior-&gt;end
op_assign
id|ROUND_UP
c_func
(paren
id|ior-&gt;end
comma
l_int|4
op_star
l_int|1024
)paren
suffix:semicolon
id|ior-&gt;end
op_add_assign
id|io_res.end
suffix:semicolon
)brace
r_if
c_cond
(paren
id|memr
)paren
(brace
id|memr-&gt;end
op_assign
id|ROUND_UP
c_func
(paren
id|memr-&gt;end
comma
l_int|1
op_star
l_int|1024
op_star
l_int|1024
)paren
suffix:semicolon
id|memr-&gt;end
op_add_assign
id|mem_res.end
suffix:semicolon
)brace
)brace
DECL|macro|ROUND_UP
macro_line|#undef ROUND_UP
DECL|function|pcibios_size_bridges
r_static
r_void
id|__init
id|pcibios_size_bridges
c_func
(paren
r_void
)paren
(brace
r_struct
id|resource
id|io_res
comma
id|mem_res
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|io_res
comma
l_int|0
comma
r_sizeof
(paren
id|io_res
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mem_res
comma
l_int|0
comma
r_sizeof
(paren
id|mem_res
)paren
)paren
suffix:semicolon
id|pcibios_size_bridge
c_func
(paren
id|pci_root_bus
comma
op_amp
id|io_res
comma
op_amp
id|mem_res
)paren
suffix:semicolon
)brace
DECL|function|pcibios_init
r_static
r_int
id|__init
id|pcibios_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|IRQ_ERR
comma
id|pcish5_err_irq
comma
id|SA_INTERRUPT
comma
l_string|&quot;PCI Error&quot;
comma
l_int|NULL
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PCISH5: Cannot hook PCI_PERR interrupt&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|IRQ_SERR
comma
id|pcish5_serr_irq
comma
id|SA_INTERRUPT
comma
l_string|&quot;PCI SERR interrupt&quot;
comma
l_int|NULL
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PCISH5: Cannot hook PCI_SERR interrupt&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* The pci subsytem needs to know where memory is and how much&n;&t; * of it there is. I&squot;ve simply made these globals. A better mechanism&n;&t; * is probably needed.&n;&t; */
id|sh5pci_init
c_func
(paren
id|__pa
c_func
(paren
id|memory_start
)paren
comma
id|__pa
c_func
(paren
id|memory_end
)paren
op_minus
id|__pa
c_func
(paren
id|memory_start
)paren
)paren
suffix:semicolon
id|pci_root_bus
op_assign
id|pci_scan_bus
c_func
(paren
l_int|0
comma
op_amp
id|pci_config_ops
comma
l_int|NULL
)paren
suffix:semicolon
id|pcibios_size_bridges
c_func
(paren
)paren
suffix:semicolon
id|pci_assign_unassigned_resources
c_func
(paren
)paren
suffix:semicolon
id|pci_fixup_irqs
c_func
(paren
id|no_swizzle
comma
id|map_cayman_irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|pcibios_init
id|subsys_initcall
c_func
(paren
id|pcibios_init
)paren
suffix:semicolon
DECL|function|pcibios_fixup_bus
r_void
id|__init
id|pcibios_fixup_bus
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
op_assign
id|bus-&gt;self
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#if 1
r_if
c_cond
(paren
id|dev
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|bus-&gt;resource
(braket
id|i
)braket
op_assign
op_amp
id|dev-&gt;resource
(braket
id|PCI_BRIDGE_RESOURCES
op_plus
id|i
)braket
suffix:semicolon
id|bus-&gt;resource
(braket
id|i
)braket
op_member_access_from_pointer
id|name
op_assign
id|bus-&gt;name
suffix:semicolon
)brace
id|bus-&gt;resource
(braket
l_int|0
)braket
op_member_access_from_pointer
id|flags
op_or_assign
id|IORESOURCE_IO
suffix:semicolon
id|bus-&gt;resource
(braket
l_int|1
)braket
op_member_access_from_pointer
id|flags
op_or_assign
id|IORESOURCE_MEM
suffix:semicolon
multiline_comment|/* For now, propagate host limits to the bus;&n;&t;&t; * we&squot;ll adjust them later. */
macro_line|#if 1
id|bus-&gt;resource
(braket
l_int|0
)braket
op_member_access_from_pointer
id|end
op_assign
l_int|64
op_star
l_int|1024
op_minus
l_int|1
suffix:semicolon
id|bus-&gt;resource
(braket
l_int|1
)braket
op_member_access_from_pointer
id|end
op_assign
id|PCIBIOS_MIN_MEM
op_plus
(paren
l_int|256
op_star
l_int|1024
op_star
l_int|1024
)paren
op_minus
l_int|1
suffix:semicolon
id|bus-&gt;resource
(braket
l_int|0
)braket
op_member_access_from_pointer
id|start
op_assign
id|PCIBIOS_MIN_IO
suffix:semicolon
id|bus-&gt;resource
(braket
l_int|1
)braket
op_member_access_from_pointer
id|start
op_assign
id|PCIBIOS_MIN_MEM
suffix:semicolon
macro_line|#else
id|bus-&gt;resource
(braket
l_int|0
)braket
op_member_access_from_pointer
id|end
op_assign
l_int|0
id|bus-&gt;resource
(braket
l_int|1
)braket
op_member_access_from_pointer
id|end
op_assign
l_int|0
id|bus-&gt;resource
(braket
l_int|0
)braket
op_member_access_from_pointer
id|start
op_assign
l_int|0
id|bus-&gt;resource
(braket
l_int|1
)braket
op_member_access_from_pointer
id|start
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/* Turn off downstream PF memory address range by default */
id|bus-&gt;resource
(braket
l_int|2
)braket
op_member_access_from_pointer
id|start
op_assign
l_int|1024
op_star
l_int|1024
suffix:semicolon
id|bus-&gt;resource
(braket
l_int|2
)braket
op_member_access_from_pointer
id|end
op_assign
id|bus-&gt;resource
(braket
l_int|2
)braket
op_member_access_from_pointer
id|start
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#endif
)brace
eof
