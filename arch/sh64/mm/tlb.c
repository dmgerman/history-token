multiline_comment|/*&n; * arch/sh64/mm/tlb.c&n; *&n; * Copyright (C) 2003  Paul Mundt &lt;lethal@linux-sh.org&gt;&n; * Copyright (C) 2003  Richard Curnow &lt;richard.curnow@superh.com&gt;&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; */
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/tlb.h&gt;
macro_line|#include &lt;asm/mmu_context.h&gt;
multiline_comment|/**&n; * sh64_tlb_init&n; *&n; * Perform initial setup for the DTLB and ITLB.&n; */
DECL|function|sh64_tlb_init
r_int
id|__init
id|sh64_tlb_init
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Assign some sane DTLB defaults */
id|cpu_data-&gt;dtlb.entries
op_assign
l_int|64
suffix:semicolon
id|cpu_data-&gt;dtlb.step
op_assign
l_int|0x10
suffix:semicolon
id|cpu_data-&gt;dtlb.first
op_assign
id|DTLB_FIXED
op_or
id|cpu_data-&gt;dtlb.step
suffix:semicolon
id|cpu_data-&gt;dtlb.next
op_assign
id|cpu_data-&gt;dtlb.first
suffix:semicolon
id|cpu_data-&gt;dtlb.last
op_assign
id|DTLB_FIXED
op_or
(paren
(paren
id|cpu_data-&gt;dtlb.entries
op_minus
l_int|1
)paren
op_star
id|cpu_data-&gt;dtlb.step
)paren
suffix:semicolon
multiline_comment|/* And again for the ITLB */
id|cpu_data-&gt;itlb.entries
op_assign
l_int|64
suffix:semicolon
id|cpu_data-&gt;itlb.step
op_assign
l_int|0x10
suffix:semicolon
id|cpu_data-&gt;itlb.first
op_assign
id|ITLB_FIXED
op_or
id|cpu_data-&gt;itlb.step
suffix:semicolon
id|cpu_data-&gt;itlb.next
op_assign
id|cpu_data-&gt;itlb.first
suffix:semicolon
id|cpu_data-&gt;itlb.last
op_assign
id|ITLB_FIXED
op_or
(paren
(paren
id|cpu_data-&gt;itlb.entries
op_minus
l_int|1
)paren
op_star
id|cpu_data-&gt;itlb.step
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * sh64_next_free_dtlb_entry&n; *&n; * Find the next available DTLB entry&n; */
DECL|function|sh64_next_free_dtlb_entry
r_int
r_int
r_int
id|sh64_next_free_dtlb_entry
c_func
(paren
r_void
)paren
(brace
r_return
id|cpu_data-&gt;dtlb.next
suffix:semicolon
)brace
multiline_comment|/**&n; * sh64_get_wired_dtlb_entry&n; *&n; * Allocate a wired (locked-in) entry in the DTLB&n; */
DECL|function|sh64_get_wired_dtlb_entry
r_int
r_int
r_int
id|sh64_get_wired_dtlb_entry
c_func
(paren
r_void
)paren
(brace
r_int
r_int
r_int
id|entry
op_assign
id|sh64_next_free_dtlb_entry
c_func
(paren
)paren
suffix:semicolon
id|cpu_data-&gt;dtlb.first
op_add_assign
id|cpu_data-&gt;dtlb.step
suffix:semicolon
id|cpu_data-&gt;dtlb.next
op_add_assign
id|cpu_data-&gt;dtlb.step
suffix:semicolon
r_return
id|entry
suffix:semicolon
)brace
multiline_comment|/**&n; * sh64_put_wired_dtlb_entry&n; *&n; * @entry:&t;Address of TLB slot.&n; *&n; * Free a wired (locked-in) entry in the DTLB.&n; *&n; * Works like a stack, last one to allocate must be first one to free.&n; */
DECL|function|sh64_put_wired_dtlb_entry
r_int
id|sh64_put_wired_dtlb_entry
c_func
(paren
r_int
r_int
r_int
id|entry
)paren
(brace
id|__flush_tlb_slot
c_func
(paren
id|entry
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We don&squot;t do any particularly useful tracking of wired entries,&n;&t; * so this approach works like a stack .. last one to be allocated&n;&t; * has to be the first one to be freed.&n;&t; *&n;&t; * We could potentially load wired entries into a list and work on&n;&t; * rebalancing the list periodically (which also entails moving the&n;&t; * contents of a TLB entry) .. though I have a feeling that this is&n;&t; * more trouble than it&squot;s worth.&n;&t; */
multiline_comment|/*&n;&t; * Entry must be valid .. we don&squot;t want any ITLB addresses!&n;&t; */
r_if
c_cond
(paren
id|entry
op_le
id|DTLB_FIXED
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;&t; * Next, check if we&squot;re within range to be freed. (ie, must be the&n;&t; * entry beneath the first &squot;free&squot; entry!&n;&t; */
r_if
c_cond
(paren
id|entry
OL
(paren
id|cpu_data-&gt;dtlb.first
op_minus
id|cpu_data-&gt;dtlb.step
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* If we are, then bring this entry back into the list */
id|cpu_data-&gt;dtlb.first
op_sub_assign
id|cpu_data-&gt;dtlb.step
suffix:semicolon
id|cpu_data-&gt;dtlb.next
op_assign
id|entry
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * sh64_setup_tlb_slot&n; *&n; * @config_addr:&t;Address of TLB slot.&n; * @eaddr:&t;&t;Virtual address.&n; * @asid:&t;&t;Address Space Identifier.&n; * @paddr:&t;&t;Physical address.&n; *&n; * Load up a virtual&lt;-&gt;physical translation for @eaddr&lt;-&gt;@paddr in the&n; * pre-allocated TLB slot @config_addr (see sh64_get_wired_dtlb_entry).&n; */
DECL|function|sh64_setup_tlb_slot
r_inline
r_void
id|sh64_setup_tlb_slot
c_func
(paren
r_int
r_int
r_int
id|config_addr
comma
r_int
r_int
id|eaddr
comma
r_int
r_int
id|asid
comma
r_int
r_int
id|paddr
)paren
(brace
r_int
r_int
r_int
id|pteh
comma
id|ptel
suffix:semicolon
multiline_comment|/* Sign extension */
macro_line|#if (NEFF == 32)
id|pteh
op_assign
(paren
r_int
r_int
r_int
)paren
(paren
r_int
r_int
r_int
)paren
(paren
r_int
r_int
)paren
id|eaddr
suffix:semicolon
macro_line|#else
macro_line|#error &quot;Can&squot;t sign extend more than 32 bits yet&quot;
macro_line|#endif
id|pteh
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|pteh
op_or_assign
(paren
id|asid
op_lshift
id|PTEH_ASID_SHIFT
)paren
op_or
id|PTEH_VALID
suffix:semicolon
macro_line|#if (NEFF == 32)
id|ptel
op_assign
(paren
r_int
r_int
r_int
)paren
(paren
r_int
r_int
r_int
)paren
(paren
r_int
r_int
)paren
id|paddr
suffix:semicolon
macro_line|#else
macro_line|#error &quot;Can&squot;t sign extend more than 32 bits yet&quot;
macro_line|#endif
id|ptel
op_and_assign
id|PAGE_MASK
suffix:semicolon
id|ptel
op_or_assign
(paren
id|_PAGE_CACHABLE
op_or
id|_PAGE_READ
op_or
id|_PAGE_WRITE
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;putcfg %0, 1, %1&bslash;n&bslash;t&quot;
l_string|&quot;putcfg %0, 0, %2&bslash;n&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|config_addr
)paren
comma
l_string|&quot;r&quot;
(paren
id|ptel
)paren
comma
l_string|&quot;r&quot;
(paren
id|pteh
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * sh64_teardown_tlb_slot&n; *&n; * @config_addr:&t;Address of TLB slot.&n; *&n; * Teardown any existing mapping in the TLB slot @config_addr.&n; */
r_inline
r_void
id|sh64_teardown_tlb_slot
c_func
(paren
r_int
r_int
r_int
id|config_addr
)paren
id|__attribute__
(paren
(paren
id|alias
c_func
(paren
l_string|&quot;__flush_tlb_slot&quot;
)paren
)paren
)paren
suffix:semicolon
eof
