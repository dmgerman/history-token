multiline_comment|/*&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * arch/sh64/kernel/irq_cayman.c&n; *&n; * SH-5 Cayman Interrupt Support&n; *&n; * This file handles the board specific parts of the Cayman interrupt system&n; *&n; * Copyright (C) 2002 Stuart Menefy&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;asm/cayman.h&gt;
DECL|variable|epld_virt
r_int
r_int
id|epld_virt
suffix:semicolon
DECL|macro|EPLD_BASE
mdefine_line|#define EPLD_BASE        0x04002000
DECL|macro|EPLD_STATUS_BASE
mdefine_line|#define EPLD_STATUS_BASE (epld_virt + 0x10)
DECL|macro|EPLD_MASK_BASE
mdefine_line|#define EPLD_MASK_BASE   (epld_virt + 0x20)
multiline_comment|/* Note the SMSC SuperIO chip and SMSC LAN chip interrupts are all muxed onto&n;   the same SH-5 interrupt */
DECL|function|cayman_interrupt_smsc
r_static
id|irqreturn_t
id|cayman_interrupt_smsc
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;CAYMAN: spurious SMSC interrupt&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
DECL|function|cayman_interrupt_pci2
r_static
id|irqreturn_t
id|cayman_interrupt_pci2
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;CAYMAN: spurious PCI interrupt, IRQ %d&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
DECL|variable|cayman_action_smsc
r_static
r_struct
id|irqaction
id|cayman_action_smsc
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;Cayman SMSC Mux&quot;
comma
dot
id|handler
op_assign
id|cayman_interrupt_smsc
comma
dot
id|flags
op_assign
id|SA_INTERRUPT
comma
)brace
suffix:semicolon
DECL|variable|cayman_action_pci2
r_static
r_struct
id|irqaction
id|cayman_action_pci2
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;Cayman PCI2 Mux&quot;
comma
dot
id|handler
op_assign
id|cayman_interrupt_pci2
comma
dot
id|flags
op_assign
id|SA_INTERRUPT
comma
)brace
suffix:semicolon
DECL|function|enable_cayman_irq
r_static
r_void
id|enable_cayman_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|mask
suffix:semicolon
r_int
r_int
id|reg
suffix:semicolon
r_int
r_char
id|bit
suffix:semicolon
id|irq
op_sub_assign
id|START_EXT_IRQS
suffix:semicolon
id|reg
op_assign
id|EPLD_MASK_BASE
op_plus
(paren
(paren
id|irq
op_div
l_int|8
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
id|bit
op_assign
l_int|1
op_lshift
(paren
id|irq
op_mod
l_int|8
)paren
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mask
op_assign
id|ctrl_inl
c_func
(paren
id|reg
)paren
suffix:semicolon
id|mask
op_or_assign
id|bit
suffix:semicolon
id|ctrl_outl
c_func
(paren
id|mask
comma
id|reg
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|disable_cayman_irq
r_void
id|disable_cayman_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|mask
suffix:semicolon
r_int
r_int
id|reg
suffix:semicolon
r_int
r_char
id|bit
suffix:semicolon
id|irq
op_sub_assign
id|START_EXT_IRQS
suffix:semicolon
id|reg
op_assign
id|EPLD_MASK_BASE
op_plus
(paren
(paren
id|irq
op_div
l_int|8
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
id|bit
op_assign
l_int|1
op_lshift
(paren
id|irq
op_mod
l_int|8
)paren
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mask
op_assign
id|ctrl_inl
c_func
(paren
id|reg
)paren
suffix:semicolon
id|mask
op_and_assign
op_complement
id|bit
suffix:semicolon
id|ctrl_outl
c_func
(paren
id|mask
comma
id|reg
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ack_cayman_irq
r_static
r_void
id|ack_cayman_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|disable_cayman_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|end_cayman_irq
r_static
r_void
id|end_cayman_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|irq_desc
(braket
id|irq
)braket
dot
id|status
op_amp
(paren
id|IRQ_DISABLED
op_or
id|IRQ_INPROGRESS
)paren
)paren
)paren
id|enable_cayman_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|startup_cayman_irq
r_static
r_int
r_int
id|startup_cayman_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|enable_cayman_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* never anything pending */
)brace
DECL|function|shutdown_cayman_irq
r_static
r_void
id|shutdown_cayman_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|disable_cayman_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|variable|cayman_irq_type
r_struct
id|hw_interrupt_type
id|cayman_irq_type
op_assign
(brace
dot
r_typename
op_assign
l_string|&quot;Cayman-IRQ&quot;
comma
dot
id|startup
op_assign
id|startup_cayman_irq
comma
dot
id|shutdown
op_assign
id|shutdown_cayman_irq
comma
dot
id|enable
op_assign
id|enable_cayman_irq
comma
dot
id|disable
op_assign
id|disable_cayman_irq
comma
dot
id|ack
op_assign
id|ack_cayman_irq
comma
dot
id|end
op_assign
id|end_cayman_irq
comma
)brace
suffix:semicolon
DECL|function|cayman_irq_demux
r_int
id|cayman_irq_demux
c_func
(paren
r_int
id|evt
)paren
(brace
r_int
id|irq
op_assign
id|intc_evt_to_irq
(braket
id|evt
)braket
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_eq
id|SMSC_IRQ
)paren
(brace
r_int
r_int
id|status
suffix:semicolon
r_int
id|i
suffix:semicolon
id|status
op_assign
id|ctrl_inl
c_func
(paren
id|EPLD_STATUS_BASE
)paren
op_amp
id|ctrl_inl
c_func
(paren
id|EPLD_MASK_BASE
)paren
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
(brace
id|irq
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
r_break
suffix:semicolon
)brace
id|irq
op_assign
id|START_EXT_IRQS
op_plus
id|i
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|irq
op_eq
id|PCI2_IRQ
)paren
(brace
r_int
r_int
id|status
suffix:semicolon
r_int
id|i
suffix:semicolon
id|status
op_assign
id|ctrl_inl
c_func
(paren
id|EPLD_STATUS_BASE
op_plus
l_int|3
op_star
r_sizeof
(paren
id|u32
)paren
)paren
op_amp
id|ctrl_inl
c_func
(paren
id|EPLD_MASK_BASE
op_plus
l_int|3
op_star
r_sizeof
(paren
id|u32
)paren
)paren
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
(brace
id|irq
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
r_break
suffix:semicolon
)brace
id|irq
op_assign
id|START_EXT_IRQS
op_plus
(paren
l_int|3
op_star
l_int|8
)paren
op_plus
id|i
suffix:semicolon
)brace
)brace
r_return
id|irq
suffix:semicolon
)brace
macro_line|#if defined(CONFIG_PROC_FS) &amp;&amp; defined(CONFIG_SYSCTL)
DECL|function|cayman_irq_describe
r_int
id|cayman_irq_describe
c_func
(paren
r_char
op_star
id|p
comma
r_int
id|irq
)paren
(brace
r_if
c_cond
(paren
id|irq
OL
id|NR_INTC_IRQS
)paren
(brace
r_return
id|intc_irq_describe
c_func
(paren
id|p
comma
id|irq
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|irq
OL
id|NR_INTC_IRQS
op_plus
l_int|8
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;(SMSC %d)&quot;
comma
id|irq
op_minus
id|NR_INTC_IRQS
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|irq
op_ge
id|NR_INTC_IRQS
op_plus
l_int|24
)paren
op_logical_and
(paren
id|irq
OL
id|NR_INTC_IRQS
op_plus
l_int|32
)paren
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;(PCI2 %d)&quot;
comma
id|irq
op_minus
(paren
id|NR_INTC_IRQS
op_plus
l_int|24
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|init_cayman_irq
r_void
id|init_cayman_irq
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|epld_virt
op_assign
id|onchip_remap
c_func
(paren
id|EPLD_BASE
comma
l_int|1024
comma
l_string|&quot;EPLD&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|epld_virt
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Cayman IRQ: Unable to remap EPLD&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_EXT_IRQS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|irq_desc
(braket
id|START_EXT_IRQS
op_plus
id|i
)braket
dot
id|handler
op_assign
op_amp
id|cayman_irq_type
suffix:semicolon
)brace
multiline_comment|/* Setup the SMSC interrupt */
id|setup_irq
c_func
(paren
id|SMSC_IRQ
comma
op_amp
id|cayman_action_smsc
)paren
suffix:semicolon
id|setup_irq
c_func
(paren
id|PCI2_IRQ
comma
op_amp
id|cayman_action_pci2
)paren
suffix:semicolon
)brace
eof
