multiline_comment|/* Mode: C;&n; * ifenslave.c: Configure network interfaces for parallel routing.&n; *&n; *&t;This program controls the Linux implementation of running multiple&n; *&t;network interfaces in parallel.&n; *&n; * Usage:&t;ifenslave [-v] master-interface &lt; slave-interface [metric &lt;N&gt;] &gt; ...&n; *&n; * Author:&t;Donald Becker &lt;becker@cesdis.gsfc.nasa.gov&gt;&n; *&t;&t;Copyright 1994-1996 Donald Becker&n; *&n; *&t;&t;This program is free software; you can redistribute it&n; *&t;&t;and/or modify it under the terms of the GNU General Public&n; *&t;&t;License as published by the Free Software Foundation.&n; *&n; *&t;The author may be reached as becker@CESDIS.gsfc.nasa.gov, or C/O&n; *&t;Center of Excellence in Space Data and Information Sciences&n; *&t;   Code 930.5, Goddard Space Flight Center, Greenbelt MD 20771&n; *&n; *  Changes :&n; *    - 2000/10/02 Willy Tarreau &lt;willy at meta-x.org&gt; :&n; *       - few fixes. Master&squot;s MAC address is now correctly taken from&n; *         the first device when not previously set ;&n; *       - detach support : call BOND_RELEASE to detach an enslaved interface.&n; *       - give a mini-howto from command-line help : # ifenslave -h&n; *&n; *    - 2001/02/16 Chad N. Tindel &lt;ctindel at ieee dot org&gt; :&n; *       - Master is now brought down before setting the MAC address.  In&n; *         the 2.4 kernel you can&squot;t change the MAC address while the device is&n; *         up because you get EBUSY.  &n; *&n; *    - 2001/09/13 Takao Indoh &lt;indou dot takao at jp dot fujitsu dot com&gt;&n; *       - Added the ability to change the active interface on a mode 1 bond&n; *         at runtime.&n; *&n; *    - 2001/10/23 Chad N. Tindel &lt;ctindel at ieee dot org&gt; :&n; *       - No longer set the MAC address of the master.  The bond device will&n; *         take care of this itself&n; *       - Try the SIOC*** versions of the bonding ioctls before using the&n; *         old versions&n; *    - 2002/02/18 Erik Habbinga &lt;erik_habbinga @ hp dot com&gt; :&n; *       - ifr2.ifr_flags was not initialized in the hwaddr_notset case,&n; *         SIOCGIFFLAGS now called before hwaddr_notset test&n; *&n; *    - 2002/10/31 Tony Cureington &lt;tony.cureington * hp_com&gt; :&n; *       - If the master does not have a hardware address when the first slave&n; *         is enslaved, the master is assigned the hardware address of that &n; *         slave - there is a comment in bonding.c stating &quot;ifenslave takes &n; *         care of this now.&quot; This corrects the problem of slaves having &n; *         different hardware addresses in active-backup mode when &n; *         multiple interfaces are specified on a single ifenslave command&n; *         (ifenslave bond0 eth0 eth1).&n; *&n; */
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
l_string|&quot;ifenslave.c:v0.07 9/9/97  Donald Becker (becker@cesdis.gsfc.nasa.gov).&bslash;n&quot;
l_string|&quot;detach support added on 2000/10/02 by Willy Tarreau (willy at meta-x.org).&bslash;n&quot;
l_string|&quot;2.4 kernel support added on 2001/02/16 by Chad N. Tindel (ctindel at ieee dot org.&bslash;n&quot;
suffix:semicolon
DECL|variable|usage_msg
r_static
r_const
r_char
op_star
id|usage_msg
op_assign
l_string|&quot;Usage: ifenslave [-adfrvVh] &lt;master-interface&gt; &lt; &lt;slave-if&gt; [metric &lt;N&gt;] &gt; ...&bslash;n&quot;
l_string|&quot;       ifenslave -c master-interface slave-if&bslash;n&quot;
suffix:semicolon
DECL|variable|howto_msg
r_static
r_const
r_char
op_star
id|howto_msg
op_assign
l_string|&quot;Usage: ifenslave [-adfrvVh] &lt;master-interface&gt; &lt; &lt;slave-if&gt; [metric &lt;N&gt;] &gt; ...&bslash;n&quot;
l_string|&quot;       ifenslave -c master-interface slave-if&bslash;n&quot;
l_string|&quot;&bslash;n&quot;
l_string|&quot;       To create a bond device, simply follow these three steps :&bslash;n&quot;
l_string|&quot;       - ensure that the required drivers are properly loaded :&bslash;n&quot;
l_string|&quot;         # modprobe bonding ; modprobe &lt;3c59x|eepro100|pcnet32|tulip|...&gt;&bslash;n&quot;
l_string|&quot;       - assign an IP address to the bond device :&bslash;n&quot;
l_string|&quot;         # ifconfig bond0 &lt;addr&gt; netmask &lt;mask&gt; broadcast &lt;bcast&gt;&bslash;n&quot;
l_string|&quot;       - attach all the interfaces you need to the bond device :&bslash;n&quot;
l_string|&quot;         # ifenslave bond0 eth0 eth1 eth2&bslash;n&quot;
l_string|&quot;         If bond0 didn&squot;t have a MAC address, it will take eth0&squot;s. Then, all&bslash;n&quot;
l_string|&quot;         interfaces attached AFTER this assignment will get the same MAC addr.&bslash;n&quot;
l_string|&quot;&bslash;n&quot;
l_string|&quot;       To detach a dead interface without setting the bond device down :&bslash;n&quot;
l_string|&quot;         # ifenslave -d bond0 eth1&bslash;n&quot;
l_string|&quot;&bslash;n&quot;
l_string|&quot;       To set the bond device down and automatically release all the slaves :&bslash;n&quot;
l_string|&quot;         # ifconfig bond0 down&bslash;n&quot;
l_string|&quot;&bslash;n&quot;
l_string|&quot;       To change active slave :&bslash;n&quot;
l_string|&quot;         # ifenslave -c bond0 eth0&bslash;n&quot;
l_string|&quot;&bslash;n&quot;
suffix:semicolon
macro_line|#include &lt;unistd.h&gt;
macro_line|#include &lt;stdlib.h&gt;
macro_line|#include &lt;stdio.h&gt;
macro_line|#include &lt;ctype.h&gt;
macro_line|#include &lt;string.h&gt;
macro_line|#include &lt;errno.h&gt;
macro_line|#include &lt;fcntl.h&gt;
macro_line|#include &lt;getopt.h&gt;
macro_line|#include &lt;sys/types.h&gt;
macro_line|#include &lt;sys/socket.h&gt;
macro_line|#include &lt;sys/ioctl.h&gt;
macro_line|#include &lt;linux/if.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/if_ether.h&gt;
macro_line|#include &lt;linux/if_bonding.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
DECL|variable|longopts
r_struct
id|option
id|longopts
(braket
)braket
op_assign
(brace
multiline_comment|/* { name  has_arg  *flag  val } */
(brace
l_string|&quot;all-interfaces&quot;
comma
l_int|0
comma
l_int|0
comma
l_char|&squot;a&squot;
)brace
comma
multiline_comment|/* Show all interfaces. */
(brace
l_string|&quot;force&quot;
comma
l_int|0
comma
l_int|0
comma
l_char|&squot;f&squot;
)brace
comma
multiline_comment|/* Force the operation. */
(brace
l_string|&quot;help&quot;
comma
l_int|0
comma
l_int|0
comma
l_char|&squot;?&squot;
)brace
comma
multiline_comment|/* Give help */
(brace
l_string|&quot;howto&quot;
comma
l_int|0
comma
l_int|0
comma
l_char|&squot;h&squot;
)brace
comma
multiline_comment|/* Give some more help */
(brace
l_string|&quot;receive-slave&quot;
comma
l_int|0
comma
l_int|0
comma
l_char|&squot;r&squot;
)brace
comma
multiline_comment|/* Make a receive-only slave.  */
(brace
l_string|&quot;verbose&quot;
comma
l_int|0
comma
l_int|0
comma
l_char|&squot;v&squot;
)brace
comma
multiline_comment|/* Report each action taken.  */
(brace
l_string|&quot;version&quot;
comma
l_int|0
comma
l_int|0
comma
l_char|&squot;V&squot;
)brace
comma
multiline_comment|/* Emit version information.  */
(brace
l_string|&quot;detach&quot;
comma
l_int|0
comma
l_int|0
comma
l_char|&squot;d&squot;
)brace
comma
multiline_comment|/* Detach a slave interface. */
(brace
l_string|&quot;change-active&quot;
comma
l_int|0
comma
l_int|0
comma
l_char|&squot;c&squot;
)brace
comma
multiline_comment|/* Change the active slave.  */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/* Command-line flags. */
r_int
r_int
DECL|variable|opt_a
id|opt_a
op_assign
l_int|0
comma
multiline_comment|/* Show-all-interfaces flag. */
DECL|variable|opt_f
id|opt_f
op_assign
l_int|0
comma
multiline_comment|/* Force the operation. */
DECL|variable|opt_r
id|opt_r
op_assign
l_int|0
comma
multiline_comment|/* Set up a Rx-only slave. */
DECL|variable|opt_d
id|opt_d
op_assign
l_int|0
comma
multiline_comment|/* detach a slave interface. */
DECL|variable|opt_c
id|opt_c
op_assign
l_int|0
comma
multiline_comment|/* change-active-slave flag. */
DECL|variable|verbose
id|verbose
op_assign
l_int|0
comma
multiline_comment|/* Verbose flag. */
DECL|variable|opt_version
id|opt_version
op_assign
l_int|0
comma
DECL|variable|opt_howto
id|opt_howto
op_assign
l_int|0
suffix:semicolon
DECL|variable|skfd
r_int
id|skfd
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* AF_INET socket for ioctl() calls.&t;*/
r_static
r_void
id|if_print
c_func
(paren
r_char
op_star
id|ifname
)paren
suffix:semicolon
r_int
DECL|function|main
id|main
c_func
(paren
r_int
id|argc
comma
r_char
op_star
op_star
id|argv
)paren
(brace
r_struct
id|ifreq
id|ifr2
comma
id|if_hwaddr
comma
id|if_ipaddr
comma
id|if_metric
comma
id|if_mtu
comma
id|if_dstaddr
suffix:semicolon
r_struct
id|ifreq
id|if_netmask
comma
id|if_brdaddr
comma
id|if_flags
suffix:semicolon
r_int
id|goterr
op_assign
l_int|0
suffix:semicolon
r_int
id|c
comma
id|errflag
op_assign
l_int|0
suffix:semicolon
id|sa_family_t
id|master_family
suffix:semicolon
r_char
op_star
op_star
id|spp
comma
op_star
id|master_ifname
comma
op_star
id|slave_ifname
suffix:semicolon
r_int
id|hwaddr_notset
suffix:semicolon
r_int
id|master_up
suffix:semicolon
r_while
c_loop
(paren
(paren
id|c
op_assign
id|getopt_long
c_func
(paren
id|argc
comma
id|argv
comma
l_string|&quot;acdfrvV?h&quot;
comma
id|longopts
comma
l_int|0
)paren
)paren
op_ne
id|EOF
)paren
r_switch
c_cond
(paren
id|c
)paren
(brace
r_case
l_char|&squot;a&squot;
suffix:colon
id|opt_a
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;f&squot;
suffix:colon
id|opt_f
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;r&squot;
suffix:colon
id|opt_r
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;d&squot;
suffix:colon
id|opt_d
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;c&squot;
suffix:colon
id|opt_c
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;v&squot;
suffix:colon
id|verbose
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;V&squot;
suffix:colon
id|opt_version
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;h&squot;
suffix:colon
id|opt_howto
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;?&squot;
suffix:colon
id|errflag
op_increment
suffix:semicolon
)brace
multiline_comment|/* option check */
r_if
c_cond
(paren
id|opt_c
)paren
r_if
c_cond
(paren
id|opt_a
op_logical_or
id|opt_f
op_logical_or
id|opt_r
op_logical_or
id|opt_d
op_logical_or
id|verbose
op_logical_or
id|opt_version
op_logical_or
id|opt_howto
op_logical_or
id|errflag
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
id|usage_msg
)paren
suffix:semicolon
r_return
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|errflag
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
id|usage_msg
)paren
suffix:semicolon
r_return
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|opt_howto
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
id|howto_msg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|verbose
op_logical_or
id|opt_version
)paren
(brace
id|printf
c_func
(paren
id|version
)paren
suffix:semicolon
r_if
c_cond
(paren
id|opt_version
)paren
m_exit
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Open a basic socket. */
r_if
c_cond
(paren
(paren
id|skfd
op_assign
id|socket
c_func
(paren
id|AF_INET
comma
id|SOCK_DGRAM
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
id|perror
c_func
(paren
l_string|&quot;socket&quot;
)paren
suffix:semicolon
m_exit
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|verbose
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;DEBUG: argc=%d, optind=%d and argv[optind] is %s.&bslash;n&quot;
comma
id|argc
comma
id|optind
comma
id|argv
(braket
id|optind
)braket
)paren
suffix:semicolon
multiline_comment|/* No remaining args means show all interfaces. */
r_if
c_cond
(paren
id|optind
op_eq
id|argc
)paren
(brace
id|if_print
c_func
(paren
(paren
r_char
op_star
)paren
l_int|NULL
)paren
suffix:semicolon
(paren
r_void
)paren
id|close
c_func
(paren
id|skfd
)paren
suffix:semicolon
m_exit
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Copy the interface name. */
id|spp
op_assign
id|argv
op_plus
id|optind
suffix:semicolon
id|master_ifname
op_assign
op_star
id|spp
op_increment
suffix:semicolon
id|slave_ifname
op_assign
op_star
id|spp
op_increment
suffix:semicolon
multiline_comment|/* Check command line. */
r_if
c_cond
(paren
id|opt_c
)paren
(brace
r_char
op_star
op_star
id|tempp
op_assign
id|spp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|master_ifname
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|slave_ifname
op_eq
l_int|NULL
)paren
op_logical_or
(paren
op_star
id|tempp
op_increment
op_ne
l_int|NULL
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
id|usage_msg
)paren
suffix:semicolon
r_return
l_int|2
suffix:semicolon
)brace
)brace
multiline_comment|/* A single args means show the configuration for this interface. */
r_if
c_cond
(paren
id|slave_ifname
op_eq
l_int|NULL
)paren
(brace
id|if_print
c_func
(paren
id|master_ifname
)paren
suffix:semicolon
(paren
r_void
)paren
id|close
c_func
(paren
id|skfd
)paren
suffix:semicolon
m_exit
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Get the vitals from the master interface. */
(brace
r_struct
id|ifreq
op_star
id|ifra
(braket
l_int|7
)braket
op_assign
(brace
op_amp
id|if_ipaddr
comma
op_amp
id|if_mtu
comma
op_amp
id|if_dstaddr
comma
op_amp
id|if_brdaddr
comma
op_amp
id|if_netmask
comma
op_amp
id|if_flags
comma
op_amp
id|if_hwaddr
)brace
suffix:semicolon
r_const
r_char
op_star
id|req_name
(braket
l_int|7
)braket
op_assign
(brace
l_string|&quot;IP address&quot;
comma
l_string|&quot;MTU&quot;
comma
l_string|&quot;destination address&quot;
comma
l_string|&quot;broadcast address&quot;
comma
l_string|&quot;netmask&quot;
comma
l_string|&quot;status flags&quot;
comma
l_string|&quot;hardware address&quot;
)brace
suffix:semicolon
r_const
r_int
id|ioctl_req_type
(braket
l_int|7
)braket
op_assign
(brace
id|SIOCGIFADDR
comma
id|SIOCGIFMTU
comma
id|SIOCGIFDSTADDR
comma
id|SIOCGIFBRDADDR
comma
id|SIOCGIFNETMASK
comma
id|SIOCGIFFLAGS
comma
id|SIOCGIFHWADDR
)brace
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
(brace
id|strncpy
c_func
(paren
id|ifra
(braket
id|i
)braket
op_member_access_from_pointer
id|ifr_name
comma
id|master_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|ioctl_req_type
(braket
id|i
)braket
comma
id|ifra
(braket
id|i
)braket
)paren
OL
l_int|0
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Something broke getting the master&squot;s %s: %s.&bslash;n&quot;
comma
id|req_name
(braket
id|i
)braket
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
)brace
)brace
id|hwaddr_notset
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* assume master&squot;s address not set yet */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|hwaddr_notset
op_logical_and
(paren
id|i
OL
l_int|6
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hwaddr_notset
op_and_assign
(paren
(paren
r_int
r_char
op_star
)paren
id|if_hwaddr.ifr_hwaddr.sa_data
)paren
(braket
id|i
)braket
op_eq
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The family &squot;1&squot; is ARPHRD_ETHER for ethernet. */
r_if
c_cond
(paren
id|if_hwaddr.ifr_hwaddr.sa_family
op_ne
l_int|1
op_logical_and
op_logical_neg
id|opt_f
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;The specified master interface &squot;%s&squot; is not&quot;
l_string|&quot; ethernet-like.&bslash;n  This program is designed to work&quot;
l_string|&quot; with ethernet-like network interfaces.&bslash;n&quot;
l_string|&quot; Use the &squot;-f&squot; option to force the operation.&bslash;n&quot;
comma
id|master_ifname
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|master_family
op_assign
id|if_hwaddr.ifr_hwaddr.sa_family
suffix:semicolon
r_if
c_cond
(paren
id|verbose
)paren
(brace
r_int
r_char
op_star
id|hwaddr
op_assign
(paren
r_int
r_char
op_star
)paren
id|if_hwaddr.ifr_hwaddr.sa_data
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;The current hardware address (SIOCGIFHWADDR) of %s is type %d  &quot;
l_string|&quot;%2.2x:%2.2x:%2.2x:%2.2x:%2.2x:%2.2x.&bslash;n&quot;
comma
id|master_ifname
comma
id|if_hwaddr.ifr_hwaddr.sa_family
comma
id|hwaddr
(braket
l_int|0
)braket
comma
id|hwaddr
(braket
l_int|1
)braket
comma
id|hwaddr
(braket
l_int|2
)braket
comma
id|hwaddr
(braket
l_int|3
)braket
comma
id|hwaddr
(braket
l_int|4
)braket
comma
id|hwaddr
(braket
l_int|5
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* do this when enslaving interfaces */
r_do
(brace
r_if
c_cond
(paren
id|opt_d
)paren
(brace
multiline_comment|/* detach a slave interface from the master */
id|strncpy
c_func
(paren
id|if_flags.ifr_name
comma
id|master_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|if_flags.ifr_slave
comma
id|slave_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCBONDRELEASE
comma
op_amp
id|if_flags
)paren
OL
l_int|0
)paren
op_logical_and
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|BOND_RELEASE_OLD
comma
op_amp
id|if_flags
)paren
OL
l_int|0
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;SIOCBONDRELEASE: cannot detach %s from %s. errno=%s.&bslash;n&quot;
comma
id|slave_ifname
comma
id|master_ifname
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* we&squot;ll set the interface down to avoid any conflicts due to&n;&t;&t;&t;&t;&t;   same IP/MAC */
id|strncpy
c_func
(paren
id|ifr2.ifr_name
comma
id|slave_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCGIFFLAGS
comma
op_amp
id|ifr2
)paren
OL
l_int|0
)paren
(brace
r_int
id|saved_errno
op_assign
id|errno
suffix:semicolon
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;SIOCGIFFLAGS on %s failed: %s&bslash;n&quot;
comma
id|slave_ifname
comma
id|strerror
c_func
(paren
id|saved_errno
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|ifr2.ifr_flags
op_and_assign
op_complement
(paren
id|IFF_UP
op_or
id|IFF_RUNNING
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCSIFFLAGS
comma
op_amp
id|ifr2
)paren
OL
l_int|0
)paren
(brace
r_int
id|saved_errno
op_assign
id|errno
suffix:semicolon
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Shutting down interface %s failed: %s&bslash;n&quot;
comma
id|slave_ifname
comma
id|strerror
c_func
(paren
id|saved_errno
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* attach a slave interface to the master */
multiline_comment|/* two possibilities :&n;&t;&t;&t;   - if hwaddr_notset, do nothing.  The bond will assign the&n;&t;&t;&t;     hwaddr from it&squot;s first slave.&n;&t;&t;&t;   - if !hwaddr_notset, assign the master&squot;s hwaddr to each slave&n;&t;&t;&t;*/
id|strncpy
c_func
(paren
id|ifr2.ifr_name
comma
id|slave_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCGIFFLAGS
comma
op_amp
id|ifr2
)paren
OL
l_int|0
)paren
(brace
r_int
id|saved_errno
op_assign
id|errno
suffix:semicolon
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;SIOCGIFFLAGS on %s failed: %s&bslash;n&quot;
comma
id|slave_ifname
comma
id|strerror
c_func
(paren
id|saved_errno
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hwaddr_notset
)paren
(brace
multiline_comment|/* assign the slave hw address to the &n;&t;&t;&t;&t; * master since it currently does not &n;&t;&t;&t;&t; * have one; otherwise, slaves may&n;&t;&t;&t;&t; * have different hw addresses in &n;&t;&t;&t;&t; * active-backup mode as seen when enslaving &n;&t;&t;&t;&t; * using &quot;ifenslave bond0 eth0 eth1&quot; because&n;&t;&t;&t;&t; * hwaddr_notset is set outside this loop.&n;&t;&t;&t;&t; * TODO: put this and the &quot;else&quot; portion in&n;&t;&t;&t;&t; *       a function.&n;&t;&t;&t;&t; */
id|goterr
op_assign
l_int|0
suffix:semicolon
id|master_up
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|if_flags.ifr_flags
op_amp
id|IFF_UP
)paren
(brace
id|if_flags.ifr_flags
op_and_assign
op_complement
id|IFF_UP
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCSIFFLAGS
comma
op_amp
id|if_flags
)paren
OL
l_int|0
)paren
(brace
id|goterr
op_assign
l_int|1
suffix:semicolon
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Shutting down &quot;
l_string|&quot;interface %s failed: &quot;
l_string|&quot;%s&bslash;n&quot;
comma
id|master_ifname
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* we took the master down, &n;&t;&t;&t;&t;&t;&t; * so we must bring it up &n;&t;&t;&t;&t;&t;&t; */
id|master_up
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|goterr
)paren
(brace
multiline_comment|/* get the slaves MAC address */
id|strncpy
c_func
(paren
id|if_hwaddr.ifr_name
comma
id|slave_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCGIFHWADDR
comma
op_amp
id|if_hwaddr
)paren
OL
l_int|0
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Could not get MAC &quot;
l_string|&quot;address of %s: %s&bslash;n&quot;
comma
id|slave_ifname
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|if_hwaddr.ifr_name
comma
id|master_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
id|goterr
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|goterr
)paren
(brace
id|strncpy
c_func
(paren
id|if_hwaddr.ifr_name
comma
id|master_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCSIFHWADDR
comma
op_amp
id|if_hwaddr
)paren
OL
l_int|0
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Could not set MAC &quot;
l_string|&quot;address of %s: %s&bslash;n&quot;
comma
id|master_ifname
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
id|goterr
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|hwaddr_notset
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|master_up
)paren
(brace
id|if_flags.ifr_flags
op_or_assign
id|IFF_UP
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCSIFFLAGS
comma
op_amp
id|if_flags
)paren
OL
l_int|0
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Bringing up interface &quot;
l_string|&quot;%s failed: %s&bslash;n&quot;
comma
id|master_ifname
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* we&squot;ll assign master&squot;s hwaddr to this slave */
r_if
c_cond
(paren
id|ifr2.ifr_flags
op_amp
id|IFF_UP
)paren
(brace
id|ifr2.ifr_flags
op_and_assign
op_complement
id|IFF_UP
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCSIFFLAGS
comma
op_amp
id|ifr2
)paren
OL
l_int|0
)paren
(brace
r_int
id|saved_errno
op_assign
id|errno
suffix:semicolon
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Shutting down interface %s failed: %s&bslash;n&quot;
comma
id|slave_ifname
comma
id|strerror
c_func
(paren
id|saved_errno
)paren
)paren
suffix:semicolon
)brace
)brace
id|strncpy
c_func
(paren
id|if_hwaddr.ifr_name
comma
id|slave_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCSIFHWADDR
comma
op_amp
id|if_hwaddr
)paren
OL
l_int|0
)paren
(brace
r_int
id|saved_errno
op_assign
id|errno
suffix:semicolon
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;SIOCSIFHWADDR on %s failed: %s&bslash;n&quot;
comma
id|if_hwaddr.ifr_name
comma
id|strerror
c_func
(paren
id|saved_errno
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saved_errno
op_eq
id|EBUSY
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;  The slave device %s is busy: it must be&quot;
l_string|&quot; idle before running this command.&bslash;n&quot;
comma
id|slave_ifname
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|saved_errno
op_eq
id|EOPNOTSUPP
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;  The slave device you specified does not support&quot;
l_string|&quot; setting the MAC address.&bslash;n  Your kernel likely does not&quot;
l_string|&quot; support slave devices.&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|saved_errno
op_eq
id|EINVAL
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;  The slave device&squot;s address type does not match&quot;
l_string|&quot; the master&squot;s address type.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|verbose
)paren
(brace
r_int
r_char
op_star
id|hwaddr
op_assign
id|if_hwaddr.ifr_hwaddr.sa_data
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;Slave&squot;s (%s) hardware address set to &quot;
l_string|&quot;%2.2x:%2.2x:%2.2x:%2.2x:%2.2x:%2.2x.&bslash;n&quot;
comma
id|slave_ifname
comma
id|hwaddr
(braket
l_int|0
)braket
comma
id|hwaddr
(braket
l_int|1
)braket
comma
id|hwaddr
(braket
l_int|2
)braket
comma
id|hwaddr
(braket
l_int|3
)braket
comma
id|hwaddr
(braket
l_int|4
)braket
comma
id|hwaddr
(braket
l_int|5
)braket
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_star
id|spp
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
op_star
id|spp
comma
l_string|&quot;metric&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_star
op_increment
id|spp
op_eq
l_int|NULL
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
id|usage_msg
)paren
suffix:semicolon
m_exit
(paren
l_int|2
)paren
suffix:semicolon
)brace
id|if_metric.ifr_metric
op_assign
id|atoi
c_func
(paren
op_star
id|spp
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|if_metric.ifr_name
comma
id|slave_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCSIFMETRIC
comma
op_amp
id|if_metric
)paren
OL
l_int|0
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;SIOCSIFMETRIC on %s: %s&bslash;n&quot;
comma
id|slave_ifname
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
id|goterr
op_assign
l_int|1
suffix:semicolon
)brace
id|spp
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strncpy
c_func
(paren
id|if_ipaddr.ifr_name
comma
id|slave_ifname
comma
id|IFNAMSIZ
)paren
op_le
l_int|0
op_logical_or
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCSIFADDR
comma
op_amp
id|if_ipaddr
)paren
OL
l_int|0
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Something broke setting the slave&squot;s address: %s.&bslash;n&quot;
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|verbose
)paren
(brace
r_int
r_char
op_star
id|ipaddr
op_assign
id|if_ipaddr.ifr_addr.sa_data
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;Set the slave&squot;s (%s) IP address to %d.%d.%d.%d.&bslash;n&quot;
comma
id|slave_ifname
comma
id|ipaddr
(braket
l_int|0
)braket
comma
id|ipaddr
(braket
l_int|1
)braket
comma
id|ipaddr
(braket
l_int|2
)braket
comma
id|ipaddr
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|strncpy
c_func
(paren
id|if_mtu.ifr_name
comma
id|slave_ifname
comma
id|IFNAMSIZ
)paren
op_le
l_int|0
op_logical_or
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCSIFMTU
comma
op_amp
id|if_mtu
)paren
OL
l_int|0
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Something broke setting the slave MTU: %s.&bslash;n&quot;
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|verbose
)paren
id|printf
c_func
(paren
l_string|&quot;Set the slave&squot;s (%s) MTU to %d.&bslash;n&quot;
comma
id|slave_ifname
comma
id|if_mtu.ifr_mtu
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strncpy
c_func
(paren
id|if_dstaddr.ifr_name
comma
id|slave_ifname
comma
id|IFNAMSIZ
)paren
op_le
l_int|0
op_logical_or
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCSIFDSTADDR
comma
op_amp
id|if_dstaddr
)paren
OL
l_int|0
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Error setting the slave (%s) with SIOCSIFDSTADDR: %s.&bslash;n&quot;
comma
id|slave_ifname
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|verbose
)paren
(brace
r_int
r_char
op_star
id|ipaddr
op_assign
id|if_dstaddr.ifr_dstaddr.sa_data
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;Set the slave&squot;s (%s) destination address to %d.%d.%d.%d.&bslash;n&quot;
comma
id|slave_ifname
comma
id|ipaddr
(braket
l_int|0
)braket
comma
id|ipaddr
(braket
l_int|1
)braket
comma
id|ipaddr
(braket
l_int|2
)braket
comma
id|ipaddr
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|strncpy
c_func
(paren
id|if_brdaddr.ifr_name
comma
id|slave_ifname
comma
id|IFNAMSIZ
)paren
op_le
l_int|0
op_logical_or
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCSIFBRDADDR
comma
op_amp
id|if_brdaddr
)paren
OL
l_int|0
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Something broke setting the slave (%s) broadcast address: %s.&bslash;n&quot;
comma
id|slave_ifname
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|verbose
)paren
(brace
r_int
r_char
op_star
id|ipaddr
op_assign
id|if_brdaddr.ifr_broadaddr.sa_data
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;Set the slave&squot;s (%s) broadcast address to %d.%d.%d.%d.&bslash;n&quot;
comma
id|slave_ifname
comma
id|ipaddr
(braket
l_int|0
)braket
comma
id|ipaddr
(braket
l_int|1
)braket
comma
id|ipaddr
(braket
l_int|2
)braket
comma
id|ipaddr
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|strncpy
c_func
(paren
id|if_netmask.ifr_name
comma
id|slave_ifname
comma
id|IFNAMSIZ
)paren
op_le
l_int|0
op_logical_or
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCSIFNETMASK
comma
op_amp
id|if_netmask
)paren
OL
l_int|0
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Something broke setting the slave (%s) netmask: %s.&bslash;n&quot;
comma
id|slave_ifname
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|verbose
)paren
(brace
r_int
r_char
op_star
id|ipaddr
op_assign
id|if_netmask.ifr_netmask.sa_data
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;Set the slave&squot;s (%s) netmask to %d.%d.%d.%d.&bslash;n&quot;
comma
id|slave_ifname
comma
id|ipaddr
(braket
l_int|0
)braket
comma
id|ipaddr
(braket
l_int|1
)braket
comma
id|ipaddr
(braket
l_int|2
)braket
comma
id|ipaddr
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
)brace
id|ifr2.ifr_flags
op_or_assign
id|IFF_UP
suffix:semicolon
multiline_comment|/* the interface will need to be up to be bonded */
r_if
c_cond
(paren
(paren
id|ifr2.ifr_flags
op_and_assign
op_complement
(paren
id|IFF_SLAVE
op_or
id|IFF_MASTER
)paren
)paren
op_eq
l_int|0
op_logical_or
id|strncpy
c_func
(paren
id|ifr2.ifr_name
comma
id|slave_ifname
comma
id|IFNAMSIZ
)paren
op_le
l_int|0
op_logical_or
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCSIFFLAGS
comma
op_amp
id|ifr2
)paren
OL
l_int|0
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Something broke setting the slave (%s) flags: %s.&bslash;n&quot;
comma
id|slave_ifname
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|verbose
)paren
id|printf
c_func
(paren
l_string|&quot;Set the slave&squot;s (%s) flags %4.4x.&bslash;n&quot;
comma
id|slave_ifname
comma
id|if_flags.ifr_flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Do the real thing */
r_if
c_cond
(paren
op_logical_neg
id|opt_r
)paren
(brace
id|strncpy
c_func
(paren
id|if_flags.ifr_name
comma
id|master_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|if_flags.ifr_slave
comma
id|slave_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|opt_c
)paren
(brace
r_if
c_cond
(paren
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCBONDENSLAVE
comma
op_amp
id|if_flags
)paren
OL
l_int|0
)paren
op_logical_and
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|BOND_ENSLAVE_OLD
comma
op_amp
id|if_flags
)paren
OL
l_int|0
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;SIOCBONDENSLAVE: %s.&bslash;n&quot;
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCBONDCHANGEACTIVE
comma
op_amp
id|if_flags
)paren
OL
l_int|0
)paren
op_logical_and
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|BOND_CHANGE_ACTIVE_OLD
comma
op_amp
id|if_flags
)paren
OL
l_int|0
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;SIOCBONDCHANGEACTIVE: %s.&bslash;n&quot;
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
r_while
c_loop
(paren
(paren
id|slave_ifname
op_assign
op_star
id|spp
op_increment
)paren
op_ne
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Close the socket. */
(paren
r_void
)paren
id|close
c_func
(paren
id|skfd
)paren
suffix:semicolon
r_return
id|goterr
suffix:semicolon
)brace
DECL|variable|mif_flags
r_static
r_int
id|mif_flags
suffix:semicolon
multiline_comment|/* Get the inteface configuration from the kernel. */
DECL|function|if_getconfig
r_static
r_int
id|if_getconfig
c_func
(paren
r_char
op_star
id|ifname
)paren
(brace
r_struct
id|ifreq
id|ifr
suffix:semicolon
r_int
id|metric
comma
id|mtu
suffix:semicolon
multiline_comment|/* Parameters of the master interface. */
r_struct
id|sockaddr
id|dstaddr
comma
id|broadaddr
comma
id|netmask
suffix:semicolon
id|strcpy
c_func
(paren
id|ifr.ifr_name
comma
id|ifname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCGIFFLAGS
comma
op_amp
id|ifr
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|mif_flags
op_assign
id|ifr.ifr_flags
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;The result of SIOCGIFFLAGS on %s is %x.&bslash;n&quot;
comma
id|ifname
comma
id|ifr.ifr_flags
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|ifr.ifr_name
comma
id|ifname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCGIFADDR
comma
op_amp
id|ifr
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;The result of SIOCGIFADDR is %2.2x.%2.2x.%2.2x.%2.2x.&bslash;n&quot;
comma
id|ifr.ifr_addr.sa_data
(braket
l_int|0
)braket
comma
id|ifr.ifr_addr.sa_data
(braket
l_int|1
)braket
comma
id|ifr.ifr_addr.sa_data
(braket
l_int|2
)braket
comma
id|ifr.ifr_addr.sa_data
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|ifr.ifr_name
comma
id|ifname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCGIFHWADDR
comma
op_amp
id|ifr
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
(brace
multiline_comment|/* Gotta convert from &squot;char&squot; to unsigned for printf().  */
r_int
r_char
op_star
id|hwaddr
op_assign
(paren
r_int
r_char
op_star
)paren
id|ifr.ifr_hwaddr.sa_data
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;The result of SIOCGIFHWADDR is type %d  &quot;
l_string|&quot;%2.2x:%2.2x:%2.2x:%2.2x:%2.2x:%2.2x.&bslash;n&quot;
comma
id|ifr.ifr_hwaddr.sa_family
comma
id|hwaddr
(braket
l_int|0
)braket
comma
id|hwaddr
(braket
l_int|1
)braket
comma
id|hwaddr
(braket
l_int|2
)braket
comma
id|hwaddr
(braket
l_int|3
)braket
comma
id|hwaddr
(braket
l_int|4
)braket
comma
id|hwaddr
(braket
l_int|5
)braket
)paren
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|ifr.ifr_name
comma
id|ifname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCGIFMETRIC
comma
op_amp
id|ifr
)paren
OL
l_int|0
)paren
(brace
id|metric
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|metric
op_assign
id|ifr.ifr_metric
suffix:semicolon
id|strcpy
c_func
(paren
id|ifr.ifr_name
comma
id|ifname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCGIFMTU
comma
op_amp
id|ifr
)paren
OL
l_int|0
)paren
id|mtu
op_assign
l_int|0
suffix:semicolon
r_else
id|mtu
op_assign
id|ifr.ifr_mtu
suffix:semicolon
id|strcpy
c_func
(paren
id|ifr.ifr_name
comma
id|ifname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCGIFDSTADDR
comma
op_amp
id|ifr
)paren
OL
l_int|0
)paren
(brace
id|memset
c_func
(paren
op_amp
id|dstaddr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sockaddr
)paren
)paren
suffix:semicolon
)brace
r_else
id|dstaddr
op_assign
id|ifr.ifr_dstaddr
suffix:semicolon
id|strcpy
c_func
(paren
id|ifr.ifr_name
comma
id|ifname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCGIFBRDADDR
comma
op_amp
id|ifr
)paren
OL
l_int|0
)paren
(brace
id|memset
c_func
(paren
op_amp
id|broadaddr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sockaddr
)paren
)paren
suffix:semicolon
)brace
r_else
id|broadaddr
op_assign
id|ifr.ifr_broadaddr
suffix:semicolon
id|strcpy
c_func
(paren
id|ifr.ifr_name
comma
id|ifname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCGIFNETMASK
comma
op_amp
id|ifr
)paren
OL
l_int|0
)paren
(brace
id|memset
c_func
(paren
op_amp
id|netmask
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sockaddr
)paren
)paren
suffix:semicolon
)brace
r_else
id|netmask
op_assign
id|ifr.ifr_netmask
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|if_print
r_static
r_void
id|if_print
c_func
(paren
r_char
op_star
id|ifname
)paren
(brace
r_char
id|buff
(braket
l_int|1024
)braket
suffix:semicolon
r_struct
id|ifconf
id|ifc
suffix:semicolon
r_struct
id|ifreq
op_star
id|ifr
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|ifname
op_eq
(paren
r_char
op_star
)paren
l_int|NULL
)paren
(brace
id|ifc.ifc_len
op_assign
r_sizeof
(paren
id|buff
)paren
suffix:semicolon
id|ifc.ifc_buf
op_assign
id|buff
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCGIFCONF
comma
op_amp
id|ifc
)paren
OL
l_int|0
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;SIOCGIFCONF: %s&bslash;n&quot;
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ifr
op_assign
id|ifc.ifc_req
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|ifc.ifc_len
op_div
r_sizeof
(paren
r_struct
id|ifreq
)paren
suffix:semicolon
op_decrement
id|i
op_ge
l_int|0
suffix:semicolon
id|ifr
op_increment
)paren
(brace
r_if
c_cond
(paren
id|if_getconfig
c_func
(paren
id|ifr-&gt;ifr_name
)paren
OL
l_int|0
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: unknown interface.&bslash;n&quot;
comma
id|ifr-&gt;ifr_name
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|mif_flags
op_amp
id|IFF_UP
)paren
op_eq
l_int|0
)paren
op_logical_and
op_logical_neg
id|opt_a
)paren
r_continue
suffix:semicolon
multiline_comment|/*ife_print(&amp;ife);*/
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|if_getconfig
c_func
(paren
id|ifname
)paren
OL
l_int|0
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: unknown interface.&bslash;n&quot;
comma
id|ifname
)paren
suffix:semicolon
)brace
)brace
"&f;"
multiline_comment|/*&n; * Local variables:&n; *  version-control: t&n; *  kept-new-versions: 5&n; *  c-indent-level: 4&n; *  c-basic-offset: 4&n; *  tab-width: 4&n; *  compile-command: &quot;gcc -Wall -Wstrict-prototypes -O -I/usr/src/linux/include ifenslave.c -o ifenslave&quot;&n; * End:&n; */
eof
