multiline_comment|/* Mode: C;&n; * ifenslave.c: Configure network interfaces for parallel routing.&n; *&n; *&t;This program controls the Linux implementation of running multiple&n; *&t;network interfaces in parallel.&n; *&n; * Author:&t;Donald Becker &lt;becker@cesdis.gsfc.nasa.gov&gt;&n; *&t;&t;Copyright 1994-1996 Donald Becker&n; *&n; *&t;&t;This program is free software; you can redistribute it&n; *&t;&t;and/or modify it under the terms of the GNU General Public&n; *&t;&t;License as published by the Free Software Foundation.&n; *&n; *&t;The author may be reached as becker@CESDIS.gsfc.nasa.gov, or C/O&n; *&t;Center of Excellence in Space Data and Information Sciences&n; *&t;   Code 930.5, Goddard Space Flight Center, Greenbelt MD 20771&n; *&n; *  Changes :&n; *    - 2000/10/02 Willy Tarreau &lt;willy at meta-x.org&gt; :&n; *       - few fixes. Master&squot;s MAC address is now correctly taken from&n; *         the first device when not previously set ;&n; *       - detach support : call BOND_RELEASE to detach an enslaved interface.&n; *       - give a mini-howto from command-line help : # ifenslave -h&n; *&n; *    - 2001/02/16 Chad N. Tindel &lt;ctindel at ieee dot org&gt; :&n; *       - Master is now brought down before setting the MAC address.  In&n; *         the 2.4 kernel you can&squot;t change the MAC address while the device is&n; *         up because you get EBUSY.&n; *&n; *    - 2001/09/13 Takao Indoh &lt;indou dot takao at jp dot fujitsu dot com&gt;&n; *       - Added the ability to change the active interface on a mode 1 bond&n; *         at runtime.&n; *&n; *    - 2001/10/23 Chad N. Tindel &lt;ctindel at ieee dot org&gt; :&n; *       - No longer set the MAC address of the master.  The bond device will&n; *         take care of this itself&n; *       - Try the SIOC*** versions of the bonding ioctls before using the&n; *         old versions&n; *    - 2002/02/18 Erik Habbinga &lt;erik_habbinga @ hp dot com&gt; :&n; *       - ifr2.ifr_flags was not initialized in the hwaddr_notset case,&n; *         SIOCGIFFLAGS now called before hwaddr_notset test&n; *&n; *    - 2002/10/31 Tony Cureington &lt;tony.cureington * hp_com&gt; :&n; *       - If the master does not have a hardware address when the first slave&n; *         is enslaved, the master is assigned the hardware address of that&n; *         slave - there is a comment in bonding.c stating &quot;ifenslave takes&n; *         care of this now.&quot; This corrects the problem of slaves having&n; *         different hardware addresses in active-backup mode when&n; *         multiple interfaces are specified on a single ifenslave command&n; *         (ifenslave bond0 eth0 eth1).&n; *&n; *    - 2003/03/18 - Tsippy Mendelson &lt;tsippy.mendelson at intel dot com&gt; and&n; *                   Shmulik Hen &lt;shmulik.hen at intel dot com&gt;&n; *       - Moved setting the slave&squot;s mac address and openning it, from&n; *         the application to the driver. This enables support of modes&n; *         that need to use the unique mac address of each slave.&n; *         The driver also takes care of closing the slave and restoring its&n; *         original mac address upon release.&n; *         In addition, block possibility of enslaving before the master is up.&n; *         This prevents putting the system in an undefined state.&n; *&n; *    - 2003/05/01 - Amir Noam &lt;amir.noam at intel dot com&gt;&n; *       - Added ABI version control to restore compatibility between&n; *         new/old ifenslave and new/old bonding.&n; *       - Prevent adding an adapter that is already a slave.&n; *         Fixes the problem of stalling the transmission and leaving&n; *         the slave in a down state.&n; *&n; *    - 2003/05/01 - Shmulik Hen &lt;shmulik.hen at intel dot com&gt;&n; *       - Prevent enslaving if the bond device is down.&n; *         Fixes the problem of leaving the system in unstable state and&n; *         halting when trying to remove the module.&n; *       - Close socket on all abnormal exists.&n; *       - Add versioning scheme that follows that of the bonding driver.&n; *         current version is 1.0.0 as a base line.&n; *&n; *    - 2003/05/22 - Jay Vosburgh &lt;fubar at us dot ibm dot com&gt;&n; *&t; - ifenslave -c was broken; it&squot;s now fixed&n; *&t; - Fixed problem with routes vanishing from master during enslave&n; *&t;   processing.&n; *&n; *    - 2003/05/27 - Amir Noam &lt;amir.noam at intel dot com&gt;&n; *&t; - Fix backward compatibility issues:&n; *&t;   For drivers not using ABI versions, slave was set down while&n; *&t;   it should be left up before enslaving.&n; *&t;   Also, master was not set down and the default set_mac_address()&n; *&t;   would fail and generate an error message in the system log.&n; * &t; - For opt_c: slave should not be set to the master&squot;s setting&n; *&t;   while it is running. It was already set during enslave. To&n; *&t;   simplify things, it is now handeled separately.&n; *&n; *    - 2003/09/24 - Shmulik Hen &lt;shmulik.hen at intel dot com&gt;&n; *&t; - Code cleanup and style changes&n; *&t;   set version to 1.1.0&n; */
DECL|macro|APP_VERSION
mdefine_line|#define APP_VERSION&t;&quot;1.1.0&quot;
DECL|macro|APP_RELDATE
mdefine_line|#define APP_RELDATE&t;&quot;Septemer 24, 2003&quot;
DECL|macro|APP_NAME
mdefine_line|#define APP_NAME&t;&quot;ifenslave&quot;
DECL|variable|version
r_static
r_char
op_star
id|version
op_assign
id|APP_NAME
l_string|&quot;.c:v&quot;
id|APP_VERSION
l_string|&quot; (&quot;
id|APP_RELDATE
l_string|&quot;)&bslash;n&quot;
l_string|&quot;o Donald Becker (becker@cesdis.gsfc.nasa.gov).&bslash;n&quot;
l_string|&quot;o Detach support added on 2000/10/02 by Willy Tarreau (willy at meta-x.org).&bslash;n&quot;
l_string|&quot;o 2.4 kernel support added on 2001/02/16 by Chad N. Tindel&bslash;n&quot;
l_string|&quot;  (ctindel at ieee dot org).&bslash;n&quot;
suffix:semicolon
DECL|variable|usage_msg
r_static
r_const
r_char
op_star
id|usage_msg
op_assign
l_string|&quot;Usage: ifenslave [-f] &lt;master-if&gt; &lt;slave-if&gt; [&lt;slave-if&gt;...]&bslash;n&quot;
l_string|&quot;       ifenslave -d   &lt;master-if&gt; &lt;slave-if&gt; [&lt;slave-if&gt;...]&bslash;n&quot;
l_string|&quot;       ifenslave -c   &lt;master-if&gt; &lt;slave-if&gt;&bslash;n&quot;
l_string|&quot;       ifenslave --help&bslash;n&quot;
suffix:semicolon
DECL|variable|help_msg
r_static
r_const
r_char
op_star
id|help_msg
op_assign
l_string|&quot;&bslash;n&quot;
l_string|&quot;       To create a bond device, simply follow these three steps :&bslash;n&quot;
l_string|&quot;       - ensure that the required drivers are properly loaded :&bslash;n&quot;
l_string|&quot;         # modprobe bonding ; modprobe &lt;3c59x|eepro100|pcnet32|tulip|...&gt;&bslash;n&quot;
l_string|&quot;       - assign an IP address to the bond device :&bslash;n&quot;
l_string|&quot;         # ifconfig bond0 &lt;addr&gt; netmask &lt;mask&gt; broadcast &lt;bcast&gt;&bslash;n&quot;
l_string|&quot;       - attach all the interfaces you need to the bond device :&bslash;n&quot;
l_string|&quot;         # ifenslave [{-f|--force}] bond0 eth0 [eth1 [eth2]...]&bslash;n&quot;
l_string|&quot;         If bond0 didn&squot;t have a MAC address, it will take eth0&squot;s. Then, all&bslash;n&quot;
l_string|&quot;         interfaces attached AFTER this assignment will get the same MAC addr.&bslash;n&quot;
l_string|&quot;         (except for ALB/TLB modes)&bslash;n&quot;
l_string|&quot;&bslash;n&quot;
l_string|&quot;       To set the bond device down and automatically release all the slaves :&bslash;n&quot;
l_string|&quot;         # ifconfig bond0 down&bslash;n&quot;
l_string|&quot;&bslash;n&quot;
l_string|&quot;       To detach a dead interface without setting the bond device down :&bslash;n&quot;
l_string|&quot;         # ifenslave {-d|--detach} bond0 eth0 [eth1 [eth2]...]&bslash;n&quot;
l_string|&quot;&bslash;n&quot;
l_string|&quot;       To change active slave :&bslash;n&quot;
l_string|&quot;         # ifenslave {-c|--change-active} bond0 eth0&bslash;n&quot;
l_string|&quot;&bslash;n&quot;
l_string|&quot;       To show master interface info&bslash;n&quot;
l_string|&quot;         # ifenslave bond0&bslash;n&quot;
l_string|&quot;&bslash;n&quot;
l_string|&quot;       To show all interfaces info&bslash;n&quot;
l_string|&quot;       # ifenslave {-a|--all-interfaces}&bslash;n&quot;
l_string|&quot;&bslash;n&quot;
l_string|&quot;       To be more verbose&bslash;n&quot;
l_string|&quot;       # ifenslave {-v|--verbose} ...&bslash;n&quot;
l_string|&quot;&bslash;n&quot;
l_string|&quot;       # ifenslave {-u|--usage}   Show usage&bslash;n&quot;
l_string|&quot;       # ifenslave {-V|--version} Show version&bslash;n&quot;
l_string|&quot;       # ifenslave {-h|--help}    This message&bslash;n&quot;
l_string|&quot;&bslash;n&quot;
suffix:semicolon
macro_line|#include &lt;unistd.h&gt;
macro_line|#include &lt;stdlib.h&gt;
macro_line|#include &lt;stdio.h&gt;
macro_line|#include &lt;ctype.h&gt;
macro_line|#include &lt;string.h&gt;
macro_line|#include &lt;errno.h&gt;
macro_line|#include &lt;fcntl.h&gt;
macro_line|#include &lt;getopt.h&gt;
macro_line|#include &lt;sys/types.h&gt;
macro_line|#include &lt;sys/socket.h&gt;
macro_line|#include &lt;sys/ioctl.h&gt;
macro_line|#include &lt;linux/if.h&gt;
macro_line|#include &lt;net/if_arp.h&gt;
macro_line|#include &lt;linux/if_ether.h&gt;
macro_line|#include &lt;linux/if_bonding.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
DECL|typedef|u64
r_typedef
r_int
r_int
r_int
id|u64
suffix:semicolon
multiline_comment|/* hack, so we may include kernel&squot;s ethtool.h */
DECL|typedef|u32
r_typedef
id|__uint32_t
id|u32
suffix:semicolon
multiline_comment|/* ditto */
DECL|typedef|u16
r_typedef
id|__uint16_t
id|u16
suffix:semicolon
multiline_comment|/* ditto */
DECL|typedef|u8
r_typedef
id|__uint8_t
id|u8
suffix:semicolon
multiline_comment|/* ditto */
macro_line|#include &lt;linux/ethtool.h&gt;
DECL|variable|longopts
r_struct
id|option
id|longopts
(braket
)braket
op_assign
(brace
multiline_comment|/* { name  has_arg  *flag  val } */
(brace
l_string|&quot;all-interfaces&quot;
comma
l_int|0
comma
l_int|0
comma
l_char|&squot;a&squot;
)brace
comma
multiline_comment|/* Show all interfaces. */
(brace
l_string|&quot;change-active&quot;
comma
l_int|0
comma
l_int|0
comma
l_char|&squot;c&squot;
)brace
comma
multiline_comment|/* Change the active slave.  */
(brace
l_string|&quot;detach&quot;
comma
l_int|0
comma
l_int|0
comma
l_char|&squot;d&squot;
)brace
comma
multiline_comment|/* Detach a slave interface. */
(brace
l_string|&quot;force&quot;
comma
l_int|0
comma
l_int|0
comma
l_char|&squot;f&squot;
)brace
comma
multiline_comment|/* Force the operation. */
(brace
l_string|&quot;help&quot;
comma
l_int|0
comma
l_int|0
comma
l_char|&squot;h&squot;
)brace
comma
multiline_comment|/* Give help */
(brace
l_string|&quot;usage&quot;
comma
l_int|0
comma
l_int|0
comma
l_char|&squot;u&squot;
)brace
comma
multiline_comment|/* Give usage */
(brace
l_string|&quot;verbose&quot;
comma
l_int|0
comma
l_int|0
comma
l_char|&squot;v&squot;
)brace
comma
multiline_comment|/* Report each action taken. */
(brace
l_string|&quot;version&quot;
comma
l_int|0
comma
l_int|0
comma
l_char|&squot;V&squot;
)brace
comma
multiline_comment|/* Emit version information. */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/* Command-line flags. */
r_int
r_int
DECL|variable|opt_a
id|opt_a
op_assign
l_int|0
comma
multiline_comment|/* Show-all-interfaces flag. */
DECL|variable|opt_c
id|opt_c
op_assign
l_int|0
comma
multiline_comment|/* Change-active-slave flag. */
DECL|variable|opt_d
id|opt_d
op_assign
l_int|0
comma
multiline_comment|/* Detach a slave interface. */
DECL|variable|opt_f
id|opt_f
op_assign
l_int|0
comma
multiline_comment|/* Force the operation. */
DECL|variable|opt_h
id|opt_h
op_assign
l_int|0
comma
multiline_comment|/* Help */
DECL|variable|opt_u
id|opt_u
op_assign
l_int|0
comma
multiline_comment|/* Usage */
DECL|variable|opt_v
id|opt_v
op_assign
l_int|0
comma
multiline_comment|/* Verbose flag. */
DECL|variable|opt_V
id|opt_V
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Version */
DECL|variable|skfd
r_int
id|skfd
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* AF_INET socket for ioctl() calls.*/
DECL|variable|abi_ver
r_int
id|abi_ver
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* userland - kernel ABI version */
DECL|variable|hwaddr_set
r_int
id|hwaddr_set
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Master&squot;s hwaddr is set */
DECL|variable|saved_errno
r_int
id|saved_errno
suffix:semicolon
DECL|variable|master_mtu
DECL|variable|master_flags
DECL|variable|master_hwaddr
r_struct
id|ifreq
id|master_mtu
comma
id|master_flags
comma
id|master_hwaddr
suffix:semicolon
DECL|variable|slave_mtu
DECL|variable|slave_flags
DECL|variable|slave_hwaddr
r_struct
id|ifreq
id|slave_mtu
comma
id|slave_flags
comma
id|slave_hwaddr
suffix:semicolon
DECL|struct|dev_ifr
r_struct
id|dev_ifr
(brace
DECL|member|req_ifr
r_struct
id|ifreq
op_star
id|req_ifr
suffix:semicolon
DECL|member|req_name
r_char
op_star
id|req_name
suffix:semicolon
DECL|member|req_type
r_int
id|req_type
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|master_ifra
r_struct
id|dev_ifr
id|master_ifra
(braket
)braket
op_assign
(brace
(brace
op_amp
id|master_mtu
comma
l_string|&quot;SIOCGIFMTU&quot;
comma
id|SIOCGIFMTU
)brace
comma
(brace
op_amp
id|master_flags
comma
l_string|&quot;SIOCGIFFLAGS&quot;
comma
id|SIOCGIFFLAGS
)brace
comma
(brace
op_amp
id|master_hwaddr
comma
l_string|&quot;SIOCGIFHWADDR&quot;
comma
id|SIOCGIFHWADDR
)brace
comma
(brace
l_int|NULL
comma
l_string|&quot;&quot;
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|slave_ifra
r_struct
id|dev_ifr
id|slave_ifra
(braket
)braket
op_assign
(brace
(brace
op_amp
id|slave_mtu
comma
l_string|&quot;SIOCGIFMTU&quot;
comma
id|SIOCGIFMTU
)brace
comma
(brace
op_amp
id|slave_flags
comma
l_string|&quot;SIOCGIFFLAGS&quot;
comma
id|SIOCGIFFLAGS
)brace
comma
(brace
op_amp
id|slave_hwaddr
comma
l_string|&quot;SIOCGIFHWADDR&quot;
comma
id|SIOCGIFHWADDR
)brace
comma
(brace
l_int|NULL
comma
l_string|&quot;&quot;
comma
l_int|0
)brace
)brace
suffix:semicolon
r_static
r_void
id|if_print
c_func
(paren
r_char
op_star
id|ifname
)paren
suffix:semicolon
r_static
r_int
id|get_drv_info
c_func
(paren
r_char
op_star
id|master_ifname
)paren
suffix:semicolon
r_static
r_int
id|get_if_settings
c_func
(paren
r_char
op_star
id|ifname
comma
r_struct
id|dev_ifr
id|ifra
(braket
)braket
)paren
suffix:semicolon
r_static
r_int
id|get_slave_flags
c_func
(paren
r_char
op_star
id|slave_ifname
)paren
suffix:semicolon
r_static
r_int
id|set_master_hwaddr
c_func
(paren
r_char
op_star
id|master_ifname
comma
r_struct
id|sockaddr
op_star
id|hwaddr
)paren
suffix:semicolon
r_static
r_int
id|set_slave_hwaddr
c_func
(paren
r_char
op_star
id|slave_ifname
comma
r_struct
id|sockaddr
op_star
id|hwaddr
)paren
suffix:semicolon
r_static
r_int
id|set_slave_mtu
c_func
(paren
r_char
op_star
id|slave_ifname
comma
r_int
id|mtu
)paren
suffix:semicolon
r_static
r_int
id|set_if_flags
c_func
(paren
r_char
op_star
id|ifname
comma
r_int
id|flags
)paren
suffix:semicolon
r_static
r_int
id|set_if_up
c_func
(paren
r_char
op_star
id|ifname
comma
r_int
id|flags
)paren
suffix:semicolon
r_static
r_int
id|set_if_down
c_func
(paren
r_char
op_star
id|ifname
comma
r_int
id|flags
)paren
suffix:semicolon
r_static
r_int
id|clear_if_addr
c_func
(paren
r_char
op_star
id|ifname
)paren
suffix:semicolon
r_static
r_int
id|set_if_addr
c_func
(paren
r_char
op_star
id|master_ifname
comma
r_char
op_star
id|slave_ifname
)paren
suffix:semicolon
r_static
r_int
id|change_active
c_func
(paren
r_char
op_star
id|master_ifname
comma
r_char
op_star
id|slave_ifname
)paren
suffix:semicolon
r_static
r_int
id|enslave
c_func
(paren
r_char
op_star
id|master_ifname
comma
r_char
op_star
id|slave_ifname
)paren
suffix:semicolon
r_static
r_int
id|release
c_func
(paren
r_char
op_star
id|master_ifname
comma
r_char
op_star
id|slave_ifname
)paren
suffix:semicolon
DECL|macro|v_print
mdefine_line|#define v_print(fmt, args...)&t;&bslash;&n;&t;if (opt_v)&t;&t;&bslash;&n;&t;&t;fprintf(stderr, fmt, ## args )
DECL|function|main
r_int
id|main
c_func
(paren
r_int
id|argc
comma
r_char
op_star
id|argv
(braket
)braket
)paren
(brace
r_char
op_star
op_star
id|spp
comma
op_star
id|master_ifname
comma
op_star
id|slave_ifname
suffix:semicolon
r_int
id|c
comma
id|i
comma
id|rv
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
r_int
id|exclusive
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|c
op_assign
id|getopt_long
c_func
(paren
id|argc
comma
id|argv
comma
l_string|&quot;acdfhuvV&quot;
comma
id|longopts
comma
l_int|0
)paren
)paren
op_ne
id|EOF
)paren
(brace
r_switch
c_cond
(paren
id|c
)paren
(brace
r_case
l_char|&squot;a&squot;
suffix:colon
id|opt_a
op_increment
suffix:semicolon
id|exclusive
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;c&squot;
suffix:colon
id|opt_c
op_increment
suffix:semicolon
id|exclusive
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;d&squot;
suffix:colon
id|opt_d
op_increment
suffix:semicolon
id|exclusive
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;f&squot;
suffix:colon
id|opt_f
op_increment
suffix:semicolon
id|exclusive
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;h&squot;
suffix:colon
id|opt_h
op_increment
suffix:semicolon
id|exclusive
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;u&squot;
suffix:colon
id|opt_u
op_increment
suffix:semicolon
id|exclusive
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;v&squot;
suffix:colon
id|opt_v
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;V&squot;
suffix:colon
id|opt_V
op_increment
suffix:semicolon
id|exclusive
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;?&squot;
suffix:colon
id|fprintf
c_func
(paren
id|stderr
comma
id|usage_msg
)paren
suffix:semicolon
id|res
op_assign
l_int|2
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
multiline_comment|/* options check */
r_if
c_cond
(paren
id|exclusive
OG
l_int|1
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
id|usage_msg
)paren
suffix:semicolon
id|res
op_assign
l_int|2
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|opt_v
op_logical_or
id|opt_V
)paren
(brace
id|printf
c_func
(paren
id|version
)paren
suffix:semicolon
r_if
c_cond
(paren
id|opt_V
)paren
(brace
id|res
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|opt_u
)paren
(brace
id|printf
c_func
(paren
id|usage_msg
)paren
suffix:semicolon
id|res
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|opt_h
)paren
(brace
id|printf
c_func
(paren
id|usage_msg
)paren
suffix:semicolon
id|printf
c_func
(paren
id|help_msg
)paren
suffix:semicolon
id|res
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Open a basic socket */
r_if
c_cond
(paren
(paren
id|skfd
op_assign
id|socket
c_func
(paren
id|AF_INET
comma
id|SOCK_DGRAM
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
id|perror
c_func
(paren
l_string|&quot;socket&quot;
)paren
suffix:semicolon
id|res
op_assign
l_int|1
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|opt_a
)paren
(brace
r_if
c_cond
(paren
id|optind
op_eq
id|argc
)paren
(brace
multiline_comment|/* No remaining args */
multiline_comment|/* show all interfaces */
id|if_print
c_func
(paren
(paren
r_char
op_star
)paren
l_int|NULL
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Just show usage */
id|fprintf
c_func
(paren
id|stderr
comma
id|usage_msg
)paren
suffix:semicolon
id|res
op_assign
l_int|2
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
multiline_comment|/* Copy the interface name */
id|spp
op_assign
id|argv
op_plus
id|optind
suffix:semicolon
id|master_ifname
op_assign
op_star
id|spp
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|master_ifname
op_eq
l_int|NULL
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
id|usage_msg
)paren
suffix:semicolon
id|res
op_assign
l_int|2
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* exchange abi version with bonding module */
id|res
op_assign
id|get_drv_info
c_func
(paren
id|master_ifname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Master &squot;%s&squot;: Error: handshake with driver failed. &quot;
l_string|&quot;Aborting&bslash;n&quot;
comma
id|master_ifname
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|slave_ifname
op_assign
op_star
id|spp
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|slave_ifname
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|opt_d
op_logical_or
id|opt_c
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
id|usage_msg
)paren
suffix:semicolon
id|res
op_assign
l_int|2
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* A single arg means show the&n;&t;&t; * configuration for this interface&n;&t;&t; */
id|if_print
c_func
(paren
id|master_ifname
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|res
op_assign
id|get_if_settings
c_func
(paren
id|master_ifname
comma
id|master_ifra
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
multiline_comment|/* Probably a good reason not to go on */
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Master &squot;%s&squot;: Error: get settings failed: %s. &quot;
l_string|&quot;Aborting&bslash;n&quot;
comma
id|master_ifname
comma
id|strerror
c_func
(paren
id|res
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* check if master is indeed a master;&n;&t; * if not then fail any operation&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|master_flags.ifr_flags
op_amp
id|IFF_MASTER
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Illegal operation; the specified interface &squot;%s&squot; &quot;
l_string|&quot;is not a master. Aborting&bslash;n&quot;
comma
id|master_ifname
)paren
suffix:semicolon
id|res
op_assign
l_int|1
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* check if master is up; if not then fail any operation */
r_if
c_cond
(paren
op_logical_neg
(paren
id|master_flags.ifr_flags
op_amp
id|IFF_UP
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Illegal operation; the specified master interface &quot;
l_string|&quot;&squot;%s&squot; is not up.&bslash;n&quot;
comma
id|master_ifname
)paren
suffix:semicolon
id|res
op_assign
l_int|1
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Only for enslaving */
r_if
c_cond
(paren
op_logical_neg
id|opt_c
op_logical_and
op_logical_neg
id|opt_d
)paren
(brace
id|sa_family_t
id|master_family
op_assign
id|master_hwaddr.ifr_hwaddr.sa_family
suffix:semicolon
r_int
r_char
op_star
id|hwaddr
op_assign
(paren
r_int
r_char
op_star
)paren
id|master_hwaddr.ifr_hwaddr.sa_data
suffix:semicolon
multiline_comment|/* The family &squot;1&squot; is ARPHRD_ETHER for ethernet. */
r_if
c_cond
(paren
id|master_family
op_ne
l_int|1
op_logical_and
op_logical_neg
id|opt_f
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Illegal operation: The specified master &quot;
l_string|&quot;interface &squot;%s&squot; is not ethernet-like.&bslash;n &quot;
l_string|&quot;This program is designed to work with &quot;
l_string|&quot;ethernet-like network interfaces.&bslash;n &quot;
l_string|&quot;Use the &squot;-f&squot; option to force the &quot;
l_string|&quot;operation.&bslash;n&quot;
comma
id|master_ifname
)paren
suffix:semicolon
id|res
op_assign
l_int|1
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Check master&squot;s hw addr */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|hwaddr
(braket
id|i
)braket
op_ne
l_int|0
)paren
(brace
id|hwaddr_set
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|hwaddr_set
)paren
(brace
id|v_print
c_func
(paren
l_string|&quot;current hardware address of master &squot;%s&squot; &quot;
l_string|&quot;is %2.2x:%2.2x:%2.2x:%2.2x:%2.2x:%2.2x, &quot;
l_string|&quot;type %d&bslash;n&quot;
comma
id|master_ifname
comma
id|hwaddr
(braket
l_int|0
)braket
comma
id|hwaddr
(braket
l_int|1
)braket
comma
id|hwaddr
(braket
l_int|2
)braket
comma
id|hwaddr
(braket
l_int|3
)braket
comma
id|hwaddr
(braket
l_int|4
)braket
comma
id|hwaddr
(braket
l_int|5
)braket
comma
id|master_family
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Accepts only one slave */
r_if
c_cond
(paren
id|opt_c
)paren
(brace
multiline_comment|/* change active slave */
id|res
op_assign
id|get_slave_flags
c_func
(paren
id|slave_ifname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Slave &squot;%s&squot;: Error: get flags failed. &quot;
l_string|&quot;Aborting&bslash;n&quot;
comma
id|slave_ifname
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|res
op_assign
id|change_active
c_func
(paren
id|master_ifname
comma
id|slave_ifname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Master &squot;%s&squot;, Slave &squot;%s&squot;: Error: &quot;
l_string|&quot;Change active failed&bslash;n&quot;
comma
id|master_ifname
comma
id|slave_ifname
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Accept multiple slaves */
r_do
(brace
r_if
c_cond
(paren
id|opt_d
)paren
(brace
multiline_comment|/* detach a slave interface from the master */
id|rv
op_assign
id|get_slave_flags
c_func
(paren
id|slave_ifname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
)paren
(brace
multiline_comment|/* Can&squot;t work with this slave. */
multiline_comment|/* remember the error and skip it*/
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Slave &squot;%s&squot;: Error: get flags &quot;
l_string|&quot;failed. Skipping&bslash;n&quot;
comma
id|slave_ifname
)paren
suffix:semicolon
id|res
op_assign
id|rv
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|rv
op_assign
id|release
c_func
(paren
id|master_ifname
comma
id|slave_ifname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Master &squot;%s&squot;, Slave &squot;%s&squot;: Error: &quot;
l_string|&quot;Release failed&bslash;n&quot;
comma
id|master_ifname
comma
id|slave_ifname
)paren
suffix:semicolon
id|res
op_assign
id|rv
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* attach a slave interface to the master */
id|rv
op_assign
id|get_if_settings
c_func
(paren
id|slave_ifname
comma
id|slave_ifra
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
)paren
(brace
multiline_comment|/* Can&squot;t work with this slave. */
multiline_comment|/* remember the error and skip it*/
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Slave &squot;%s&squot;: Error: get &quot;
l_string|&quot;settings failed: %s. &quot;
l_string|&quot;Skipping&bslash;n&quot;
comma
id|slave_ifname
comma
id|strerror
c_func
(paren
id|rv
)paren
)paren
suffix:semicolon
id|res
op_assign
id|rv
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|rv
op_assign
id|enslave
c_func
(paren
id|master_ifname
comma
id|slave_ifname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Master &squot;%s&squot;, Slave &squot;%s&squot;: Error: &quot;
l_string|&quot;Enslave failed&bslash;n&quot;
comma
id|master_ifname
comma
id|slave_ifname
)paren
suffix:semicolon
id|res
op_assign
id|rv
suffix:semicolon
)brace
)brace
)brace
r_while
c_loop
(paren
(paren
id|slave_ifname
op_assign
op_star
id|spp
op_increment
)paren
op_ne
l_int|NULL
)paren
suffix:semicolon
)brace
id|out
suffix:colon
r_if
c_cond
(paren
id|skfd
op_ge
l_int|0
)paren
(brace
id|close
c_func
(paren
id|skfd
)paren
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
DECL|variable|mif_flags
r_static
r_int
id|mif_flags
suffix:semicolon
multiline_comment|/* Get the inteface configuration from the kernel. */
DECL|function|if_getconfig
r_static
r_int
id|if_getconfig
c_func
(paren
r_char
op_star
id|ifname
)paren
(brace
r_struct
id|ifreq
id|ifr
suffix:semicolon
r_int
id|metric
comma
id|mtu
suffix:semicolon
multiline_comment|/* Parameters of the master interface. */
r_struct
id|sockaddr
id|dstaddr
comma
id|broadaddr
comma
id|netmask
suffix:semicolon
r_int
r_char
op_star
id|hwaddr
suffix:semicolon
id|strcpy
c_func
(paren
id|ifr.ifr_name
comma
id|ifname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCGIFFLAGS
comma
op_amp
id|ifr
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|mif_flags
op_assign
id|ifr.ifr_flags
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;The result of SIOCGIFFLAGS on %s is %x.&bslash;n&quot;
comma
id|ifname
comma
id|ifr.ifr_flags
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|ifr.ifr_name
comma
id|ifname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCGIFADDR
comma
op_amp
id|ifr
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;The result of SIOCGIFADDR is %2.2x.%2.2x.%2.2x.%2.2x.&bslash;n&quot;
comma
id|ifr.ifr_addr.sa_data
(braket
l_int|0
)braket
comma
id|ifr.ifr_addr.sa_data
(braket
l_int|1
)braket
comma
id|ifr.ifr_addr.sa_data
(braket
l_int|2
)braket
comma
id|ifr.ifr_addr.sa_data
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|ifr.ifr_name
comma
id|ifname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCGIFHWADDR
comma
op_amp
id|ifr
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Gotta convert from &squot;char&squot; to unsigned for printf(). */
id|hwaddr
op_assign
(paren
r_int
r_char
op_star
)paren
id|ifr.ifr_hwaddr.sa_data
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;The result of SIOCGIFHWADDR is type %d  &quot;
l_string|&quot;%2.2x:%2.2x:%2.2x:%2.2x:%2.2x:%2.2x.&bslash;n&quot;
comma
id|ifr.ifr_hwaddr.sa_family
comma
id|hwaddr
(braket
l_int|0
)braket
comma
id|hwaddr
(braket
l_int|1
)braket
comma
id|hwaddr
(braket
l_int|2
)braket
comma
id|hwaddr
(braket
l_int|3
)braket
comma
id|hwaddr
(braket
l_int|4
)braket
comma
id|hwaddr
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|ifr.ifr_name
comma
id|ifname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCGIFMETRIC
comma
op_amp
id|ifr
)paren
OL
l_int|0
)paren
(brace
id|metric
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|metric
op_assign
id|ifr.ifr_metric
suffix:semicolon
id|strcpy
c_func
(paren
id|ifr.ifr_name
comma
id|ifname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCGIFMTU
comma
op_amp
id|ifr
)paren
OL
l_int|0
)paren
id|mtu
op_assign
l_int|0
suffix:semicolon
r_else
id|mtu
op_assign
id|ifr.ifr_mtu
suffix:semicolon
id|strcpy
c_func
(paren
id|ifr.ifr_name
comma
id|ifname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCGIFDSTADDR
comma
op_amp
id|ifr
)paren
OL
l_int|0
)paren
(brace
id|memset
c_func
(paren
op_amp
id|dstaddr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sockaddr
)paren
)paren
suffix:semicolon
)brace
r_else
id|dstaddr
op_assign
id|ifr.ifr_dstaddr
suffix:semicolon
id|strcpy
c_func
(paren
id|ifr.ifr_name
comma
id|ifname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCGIFBRDADDR
comma
op_amp
id|ifr
)paren
OL
l_int|0
)paren
(brace
id|memset
c_func
(paren
op_amp
id|broadaddr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sockaddr
)paren
)paren
suffix:semicolon
)brace
r_else
id|broadaddr
op_assign
id|ifr.ifr_broadaddr
suffix:semicolon
id|strcpy
c_func
(paren
id|ifr.ifr_name
comma
id|ifname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCGIFNETMASK
comma
op_amp
id|ifr
)paren
OL
l_int|0
)paren
(brace
id|memset
c_func
(paren
op_amp
id|netmask
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sockaddr
)paren
)paren
suffix:semicolon
)brace
r_else
id|netmask
op_assign
id|ifr.ifr_netmask
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|if_print
r_static
r_void
id|if_print
c_func
(paren
r_char
op_star
id|ifname
)paren
(brace
r_char
id|buff
(braket
l_int|1024
)braket
suffix:semicolon
r_struct
id|ifconf
id|ifc
suffix:semicolon
r_struct
id|ifreq
op_star
id|ifr
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|ifname
op_eq
(paren
r_char
op_star
)paren
l_int|NULL
)paren
(brace
id|ifc.ifc_len
op_assign
r_sizeof
(paren
id|buff
)paren
suffix:semicolon
id|ifc.ifc_buf
op_assign
id|buff
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCGIFCONF
comma
op_amp
id|ifc
)paren
OL
l_int|0
)paren
(brace
id|perror
c_func
(paren
l_string|&quot;SIOCGIFCONF failed&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ifr
op_assign
id|ifc.ifc_req
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|ifc.ifc_len
op_div
r_sizeof
(paren
r_struct
id|ifreq
)paren
suffix:semicolon
op_decrement
id|i
op_ge
l_int|0
suffix:semicolon
id|ifr
op_increment
)paren
(brace
r_if
c_cond
(paren
id|if_getconfig
c_func
(paren
id|ifr-&gt;ifr_name
)paren
OL
l_int|0
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: unknown interface.&bslash;n&quot;
comma
id|ifr-&gt;ifr_name
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|mif_flags
op_amp
id|IFF_UP
)paren
op_eq
l_int|0
)paren
op_logical_and
op_logical_neg
id|opt_a
)paren
r_continue
suffix:semicolon
multiline_comment|/*ife_print(&amp;ife);*/
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|if_getconfig
c_func
(paren
id|ifname
)paren
OL
l_int|0
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: unknown interface.&bslash;n&quot;
comma
id|ifname
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|get_drv_info
r_static
r_int
id|get_drv_info
c_func
(paren
r_char
op_star
id|master_ifname
)paren
(brace
r_struct
id|ifreq
id|ifr
suffix:semicolon
r_struct
id|ethtool_drvinfo
id|info
suffix:semicolon
r_char
op_star
id|endptr
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|ifr
comma
l_int|0
comma
r_sizeof
(paren
id|ifr
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ifr.ifr_name
comma
id|master_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
id|ifr.ifr_data
op_assign
(paren
id|caddr_t
)paren
op_amp
id|info
suffix:semicolon
id|info.cmd
op_assign
id|ETHTOOL_GDRVINFO
suffix:semicolon
id|strncpy
c_func
(paren
id|info.driver
comma
l_string|&quot;ifenslave&quot;
comma
l_int|32
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|info.fw_version
comma
l_int|32
comma
l_string|&quot;%d&quot;
comma
id|BOND_ABI_VERSION
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCETHTOOL
comma
op_amp
id|ifr
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|errno
op_eq
id|EOPNOTSUPP
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|saved_errno
op_assign
id|errno
suffix:semicolon
id|v_print
c_func
(paren
l_string|&quot;Master &squot;%s&squot;: Error: get bonding info failed %s&bslash;n&quot;
comma
id|master_ifname
comma
id|strerror
c_func
(paren
id|saved_errno
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|abi_ver
op_assign
id|strtoul
c_func
(paren
id|info.fw_version
comma
op_amp
id|endptr
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|endptr
)paren
(brace
id|v_print
c_func
(paren
l_string|&quot;Master &squot;%s&squot;: Error: got invalid string as an ABI &quot;
l_string|&quot;version from the bonding module&bslash;n&quot;
comma
id|master_ifname
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|out
suffix:colon
id|v_print
c_func
(paren
l_string|&quot;ABI ver is %d&bslash;n&quot;
comma
id|abi_ver
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|change_active
r_static
r_int
id|change_active
c_func
(paren
r_char
op_star
id|master_ifname
comma
r_char
op_star
id|slave_ifname
)paren
(brace
r_struct
id|ifreq
id|ifr
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|slave_flags.ifr_flags
op_amp
id|IFF_SLAVE
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Illegal operation: The specified slave interface &quot;
l_string|&quot;&squot;%s&squot; is not a slave&bslash;n&quot;
comma
id|slave_ifname
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|strncpy
c_func
(paren
id|ifr.ifr_name
comma
id|master_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ifr.ifr_slave
comma
id|slave_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCBONDCHANGEACTIVE
comma
op_amp
id|ifr
)paren
OL
l_int|0
)paren
op_logical_and
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|BOND_CHANGE_ACTIVE_OLD
comma
op_amp
id|ifr
)paren
OL
l_int|0
)paren
)paren
(brace
id|saved_errno
op_assign
id|errno
suffix:semicolon
id|v_print
c_func
(paren
l_string|&quot;Master &squot;%s&squot;: Error: SIOCBONDCHANGEACTIVE failed: &quot;
l_string|&quot;%s&bslash;n&quot;
comma
id|master_ifname
comma
id|strerror
c_func
(paren
id|saved_errno
)paren
)paren
suffix:semicolon
id|res
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
DECL|function|enslave
r_static
r_int
id|enslave
c_func
(paren
r_char
op_star
id|master_ifname
comma
r_char
op_star
id|slave_ifname
)paren
(brace
r_struct
id|ifreq
id|ifr
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|slave_flags.ifr_flags
op_amp
id|IFF_SLAVE
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Illegal operation: The specified slave interface &quot;
l_string|&quot;&squot;%s&squot; is already a slave&bslash;n&quot;
comma
id|slave_ifname
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|res
op_assign
id|set_if_down
c_func
(paren
id|slave_ifname
comma
id|slave_flags.ifr_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Slave &squot;%s&squot;: Error: bring interface down failed&bslash;n&quot;
comma
id|slave_ifname
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_if
c_cond
(paren
id|abi_ver
OL
l_int|2
)paren
(brace
multiline_comment|/* Older bonding versions would panic if the slave has no IP&n;&t;&t; * address, so get the IP setting from the master.&n;&t;&t; */
id|res
op_assign
id|set_if_addr
c_func
(paren
id|master_ifname
comma
id|slave_ifname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Slave &squot;%s&squot;: Error: set address failed&bslash;n&quot;
comma
id|slave_ifname
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
)brace
r_else
(brace
id|res
op_assign
id|clear_if_addr
c_func
(paren
id|slave_ifname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Slave &squot;%s&squot;: Error: clear address failed&bslash;n&quot;
comma
id|slave_ifname
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|master_mtu.ifr_mtu
op_ne
id|slave_mtu.ifr_mtu
)paren
(brace
id|res
op_assign
id|set_slave_mtu
c_func
(paren
id|slave_ifname
comma
id|master_mtu.ifr_mtu
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Slave &squot;%s&squot;: Error: set MTU failed&bslash;n&quot;
comma
id|slave_ifname
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|hwaddr_set
)paren
(brace
multiline_comment|/* Master already has an hwaddr&n;&t;&t; * so set it&squot;s hwaddr to the slave&n;&t;&t; */
r_if
c_cond
(paren
id|abi_ver
OL
l_int|1
)paren
(brace
multiline_comment|/* The driver is using an old ABI, so&n;&t;&t;&t; * the application sets the slave&squot;s&n;&t;&t;&t; * hwaddr&n;&t;&t;&t; */
id|res
op_assign
id|set_slave_hwaddr
c_func
(paren
id|slave_ifname
comma
op_amp
(paren
id|master_hwaddr.ifr_hwaddr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Slave &squot;%s&squot;: Error: set hw address &quot;
l_string|&quot;failed&bslash;n&quot;
comma
id|slave_ifname
)paren
suffix:semicolon
r_goto
id|undo_mtu
suffix:semicolon
)brace
multiline_comment|/* For old ABI the application needs to bring the&n;&t;&t;&t; * slave back up&n;&t;&t;&t; */
id|res
op_assign
id|set_if_up
c_func
(paren
id|slave_ifname
comma
id|slave_flags.ifr_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Slave &squot;%s&squot;: Error: bring interface &quot;
l_string|&quot;down failed&bslash;n&quot;
comma
id|slave_ifname
)paren
suffix:semicolon
r_goto
id|undo_slave_mac
suffix:semicolon
)brace
)brace
multiline_comment|/* The driver is using a new ABI,&n;&t;&t; * so the driver takes care of setting&n;&t;&t; * the slave&squot;s hwaddr and bringing&n;&t;&t; * it up again&n;&t;&t; */
)brace
r_else
(brace
multiline_comment|/* No hwaddr for master yet, so&n;&t;&t; * set the slave&squot;s hwaddr to it&n;&t;&t; */
r_if
c_cond
(paren
id|abi_ver
OL
l_int|1
)paren
(brace
multiline_comment|/* For old ABI, the master needs to be&n;&t;&t;&t; * down before setting it&squot;s hwaddr&n;&t;&t;&t; */
id|res
op_assign
id|set_if_down
c_func
(paren
id|master_ifname
comma
id|master_flags.ifr_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Master &squot;%s&squot;: Error: bring interface &quot;
l_string|&quot;down failed&bslash;n&quot;
comma
id|master_ifname
)paren
suffix:semicolon
r_goto
id|undo_mtu
suffix:semicolon
)brace
)brace
id|res
op_assign
id|set_master_hwaddr
c_func
(paren
id|master_ifname
comma
op_amp
(paren
id|slave_hwaddr.ifr_hwaddr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Master &squot;%s&squot;: Error: set hw address &quot;
l_string|&quot;failed&bslash;n&quot;
comma
id|master_ifname
)paren
suffix:semicolon
r_goto
id|undo_mtu
suffix:semicolon
)brace
r_if
c_cond
(paren
id|abi_ver
OL
l_int|1
)paren
(brace
multiline_comment|/* For old ABI, bring the master&n;&t;&t;&t; * back up&n;&t;&t;&t; */
id|res
op_assign
id|set_if_up
c_func
(paren
id|master_ifname
comma
id|master_flags.ifr_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Master &squot;%s&squot;: Error: bring interface &quot;
l_string|&quot;up failed&bslash;n&quot;
comma
id|master_ifname
)paren
suffix:semicolon
r_goto
id|undo_master_mac
suffix:semicolon
)brace
)brace
id|hwaddr_set
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Do the real thing */
id|strncpy
c_func
(paren
id|ifr.ifr_name
comma
id|master_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ifr.ifr_slave
comma
id|slave_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCBONDENSLAVE
comma
op_amp
id|ifr
)paren
OL
l_int|0
)paren
op_logical_and
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|BOND_ENSLAVE_OLD
comma
op_amp
id|ifr
)paren
OL
l_int|0
)paren
)paren
(brace
id|saved_errno
op_assign
id|errno
suffix:semicolon
id|v_print
c_func
(paren
l_string|&quot;Master &squot;%s&squot;: Error: SIOCBONDENSLAVE failed: %s&bslash;n&quot;
comma
id|master_ifname
comma
id|strerror
c_func
(paren
id|saved_errno
)paren
)paren
suffix:semicolon
id|res
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|res
)paren
(brace
r_goto
id|undo_master_mac
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* rollback (best effort) */
id|undo_master_mac
suffix:colon
id|set_master_hwaddr
c_func
(paren
id|master_ifname
comma
op_amp
(paren
id|master_hwaddr.ifr_hwaddr
)paren
)paren
suffix:semicolon
id|hwaddr_set
op_assign
l_int|0
suffix:semicolon
r_goto
id|undo_mtu
suffix:semicolon
id|undo_slave_mac
suffix:colon
id|set_slave_hwaddr
c_func
(paren
id|slave_ifname
comma
op_amp
(paren
id|slave_hwaddr.ifr_hwaddr
)paren
)paren
suffix:semicolon
id|undo_mtu
suffix:colon
id|set_slave_mtu
c_func
(paren
id|slave_ifname
comma
id|slave_mtu.ifr_mtu
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|release
r_static
r_int
id|release
c_func
(paren
r_char
op_star
id|master_ifname
comma
r_char
op_star
id|slave_ifname
)paren
(brace
r_struct
id|ifreq
id|ifr
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|slave_flags.ifr_flags
op_amp
id|IFF_SLAVE
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Illegal operation: The specified slave interface &quot;
l_string|&quot;&squot;%s&squot; is not a slave&bslash;n&quot;
comma
id|slave_ifname
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|strncpy
c_func
(paren
id|ifr.ifr_name
comma
id|master_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ifr.ifr_slave
comma
id|slave_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCBONDRELEASE
comma
op_amp
id|ifr
)paren
OL
l_int|0
)paren
op_logical_and
(paren
id|ioctl
c_func
(paren
id|skfd
comma
id|BOND_RELEASE_OLD
comma
op_amp
id|ifr
)paren
OL
l_int|0
)paren
)paren
(brace
id|saved_errno
op_assign
id|errno
suffix:semicolon
id|v_print
c_func
(paren
l_string|&quot;Master &squot;%s&squot;: Error: SIOCBONDRELEASE failed: %s&bslash;n&quot;
comma
id|master_ifname
comma
id|strerror
c_func
(paren
id|saved_errno
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|abi_ver
OL
l_int|1
)paren
(brace
multiline_comment|/* The driver is using an old ABI, so we&squot;ll set the interface&n;&t;&t; * down to avoid any conflicts due to same MAC/IP&n;&t;&t; */
id|res
op_assign
id|set_if_down
c_func
(paren
id|slave_ifname
comma
id|slave_flags.ifr_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Slave &squot;%s&squot;: Error: bring interface &quot;
l_string|&quot;down failed&bslash;n&quot;
comma
id|slave_ifname
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* set to default mtu */
id|set_slave_mtu
c_func
(paren
id|slave_ifname
comma
l_int|1500
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|get_if_settings
r_static
r_int
id|get_if_settings
c_func
(paren
r_char
op_star
id|ifname
comma
r_struct
id|dev_ifr
id|ifra
(braket
)braket
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|ifra
(braket
id|i
)braket
dot
id|req_ifr
suffix:semicolon
id|i
op_increment
)paren
(brace
id|strncpy
c_func
(paren
id|ifra
(braket
id|i
)braket
dot
id|req_ifr-&gt;ifr_name
comma
id|ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
id|res
op_assign
id|ioctl
c_func
(paren
id|skfd
comma
id|ifra
(braket
id|i
)braket
dot
id|req_type
comma
id|ifra
(braket
id|i
)braket
dot
id|req_ifr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
(brace
id|saved_errno
op_assign
id|errno
suffix:semicolon
id|v_print
c_func
(paren
l_string|&quot;Interface &squot;%s&squot;: Error: %s failed: %s&bslash;n&quot;
comma
id|ifname
comma
id|ifra
(braket
id|i
)braket
dot
id|req_name
comma
id|strerror
c_func
(paren
id|saved_errno
)paren
)paren
suffix:semicolon
r_return
id|saved_errno
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_slave_flags
r_static
r_int
id|get_slave_flags
c_func
(paren
r_char
op_star
id|slave_ifname
)paren
(brace
r_int
id|res
op_assign
l_int|0
suffix:semicolon
id|strncpy
c_func
(paren
id|slave_flags.ifr_name
comma
id|slave_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
id|res
op_assign
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCGIFFLAGS
comma
op_amp
id|slave_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
(brace
id|saved_errno
op_assign
id|errno
suffix:semicolon
id|v_print
c_func
(paren
l_string|&quot;Slave &squot;%s&squot;: Error: SIOCGIFFLAGS failed: %s&bslash;n&quot;
comma
id|slave_ifname
comma
id|strerror
c_func
(paren
id|saved_errno
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|v_print
c_func
(paren
l_string|&quot;Slave %s: flags %04X.&bslash;n&quot;
comma
id|slave_ifname
comma
id|slave_flags.ifr_flags
)paren
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
DECL|function|set_master_hwaddr
r_static
r_int
id|set_master_hwaddr
c_func
(paren
r_char
op_star
id|master_ifname
comma
r_struct
id|sockaddr
op_star
id|hwaddr
)paren
(brace
r_int
r_char
op_star
id|addr
op_assign
(paren
r_int
r_char
op_star
)paren
id|hwaddr-&gt;sa_data
suffix:semicolon
r_struct
id|ifreq
id|ifr
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
id|strncpy
c_func
(paren
id|ifr.ifr_name
comma
id|master_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
(paren
id|ifr.ifr_hwaddr
)paren
comma
id|hwaddr
comma
r_sizeof
(paren
r_struct
id|sockaddr
)paren
)paren
suffix:semicolon
id|res
op_assign
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCSIFHWADDR
comma
op_amp
id|ifr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
(brace
id|saved_errno
op_assign
id|errno
suffix:semicolon
id|v_print
c_func
(paren
l_string|&quot;Master &squot;%s&squot;: Error: SIOCSIFHWADDR failed: %s&bslash;n&quot;
comma
id|master_ifname
comma
id|strerror
c_func
(paren
id|saved_errno
)paren
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_else
(brace
id|v_print
c_func
(paren
l_string|&quot;Master &squot;%s&squot;: hardware address set to &quot;
l_string|&quot;%2.2x:%2.2x:%2.2x:%2.2x:%2.2x:%2.2x.&bslash;n&quot;
comma
id|master_ifname
comma
id|addr
(braket
l_int|0
)braket
comma
id|addr
(braket
l_int|1
)braket
comma
id|addr
(braket
l_int|2
)braket
comma
id|addr
(braket
l_int|3
)braket
comma
id|addr
(braket
l_int|4
)braket
comma
id|addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
DECL|function|set_slave_hwaddr
r_static
r_int
id|set_slave_hwaddr
c_func
(paren
r_char
op_star
id|slave_ifname
comma
r_struct
id|sockaddr
op_star
id|hwaddr
)paren
(brace
r_int
r_char
op_star
id|addr
op_assign
(paren
r_int
r_char
op_star
)paren
id|hwaddr-&gt;sa_data
suffix:semicolon
r_struct
id|ifreq
id|ifr
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
id|strncpy
c_func
(paren
id|ifr.ifr_name
comma
id|slave_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
(paren
id|ifr.ifr_hwaddr
)paren
comma
id|hwaddr
comma
r_sizeof
(paren
r_struct
id|sockaddr
)paren
)paren
suffix:semicolon
id|res
op_assign
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCSIFHWADDR
comma
op_amp
id|ifr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
(brace
id|saved_errno
op_assign
id|errno
suffix:semicolon
id|v_print
c_func
(paren
l_string|&quot;Slave &squot;%s&squot;: Error: SIOCSIFHWADDR failed: %s&bslash;n&quot;
comma
id|slave_ifname
comma
id|strerror
c_func
(paren
id|saved_errno
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|saved_errno
op_eq
id|EBUSY
)paren
(brace
id|v_print
c_func
(paren
l_string|&quot;  The device is busy: it must be idle &quot;
l_string|&quot;before running this command.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|saved_errno
op_eq
id|EOPNOTSUPP
)paren
(brace
id|v_print
c_func
(paren
l_string|&quot;  The device does not support setting &quot;
l_string|&quot;the MAC address.&bslash;n&quot;
l_string|&quot;  Your kernel likely does not support slave &quot;
l_string|&quot;devices.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|saved_errno
op_eq
id|EINVAL
)paren
(brace
id|v_print
c_func
(paren
l_string|&quot;  The device&squot;s address type does not match &quot;
l_string|&quot;the master&squot;s address type.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
r_else
(brace
id|v_print
c_func
(paren
l_string|&quot;Slave &squot;%s&squot;: hardware address set to &quot;
l_string|&quot;%2.2x:%2.2x:%2.2x:%2.2x:%2.2x:%2.2x.&bslash;n&quot;
comma
id|slave_ifname
comma
id|addr
(braket
l_int|0
)braket
comma
id|addr
(braket
l_int|1
)braket
comma
id|addr
(braket
l_int|2
)braket
comma
id|addr
(braket
l_int|3
)braket
comma
id|addr
(braket
l_int|4
)braket
comma
id|addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
DECL|function|set_slave_mtu
r_static
r_int
id|set_slave_mtu
c_func
(paren
r_char
op_star
id|slave_ifname
comma
r_int
id|mtu
)paren
(brace
r_struct
id|ifreq
id|ifr
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
id|ifr.ifr_mtu
op_assign
id|mtu
suffix:semicolon
id|strncpy
c_func
(paren
id|ifr.ifr_name
comma
id|slave_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
id|res
op_assign
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCSIFMTU
comma
op_amp
id|ifr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
(brace
id|saved_errno
op_assign
id|errno
suffix:semicolon
id|v_print
c_func
(paren
l_string|&quot;Slave &squot;%s&squot;: Error: SIOCSIFMTU failed: %s&bslash;n&quot;
comma
id|slave_ifname
comma
id|strerror
c_func
(paren
id|saved_errno
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|v_print
c_func
(paren
l_string|&quot;Slave &squot;%s&squot;: MTU set to %d.&bslash;n&quot;
comma
id|slave_ifname
comma
id|mtu
)paren
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
DECL|function|set_if_flags
r_static
r_int
id|set_if_flags
c_func
(paren
r_char
op_star
id|ifname
comma
r_int
id|flags
)paren
(brace
r_struct
id|ifreq
id|ifr
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
id|ifr.ifr_flags
op_assign
id|flags
suffix:semicolon
id|strncpy
c_func
(paren
id|ifr.ifr_name
comma
id|ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
id|res
op_assign
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCSIFFLAGS
comma
op_amp
id|ifr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
(brace
id|saved_errno
op_assign
id|errno
suffix:semicolon
id|v_print
c_func
(paren
l_string|&quot;Interface &squot;%s&squot;: Error: SIOCSIFFLAGS failed: %s&bslash;n&quot;
comma
id|ifname
comma
id|strerror
c_func
(paren
id|saved_errno
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|v_print
c_func
(paren
l_string|&quot;Interface &squot;%s&squot;: flags set to %04X.&bslash;n&quot;
comma
id|ifname
comma
id|flags
)paren
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
DECL|function|set_if_up
r_static
r_int
id|set_if_up
c_func
(paren
r_char
op_star
id|ifname
comma
r_int
id|flags
)paren
(brace
r_return
id|set_if_flags
c_func
(paren
id|ifname
comma
id|flags
op_or
id|IFF_UP
)paren
suffix:semicolon
)brace
DECL|function|set_if_down
r_static
r_int
id|set_if_down
c_func
(paren
r_char
op_star
id|ifname
comma
r_int
id|flags
)paren
(brace
r_return
id|set_if_flags
c_func
(paren
id|ifname
comma
id|flags
op_amp
op_complement
id|IFF_UP
)paren
suffix:semicolon
)brace
DECL|function|clear_if_addr
r_static
r_int
id|clear_if_addr
c_func
(paren
r_char
op_star
id|ifname
)paren
(brace
r_struct
id|ifreq
id|ifr
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
id|strncpy
c_func
(paren
id|ifr.ifr_name
comma
id|ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
id|ifr.ifr_addr.sa_family
op_assign
id|AF_INET
suffix:semicolon
id|memset
c_func
(paren
id|ifr.ifr_addr.sa_data
comma
l_int|0
comma
r_sizeof
(paren
id|ifr.ifr_addr.sa_data
)paren
)paren
suffix:semicolon
id|res
op_assign
id|ioctl
c_func
(paren
id|skfd
comma
id|SIOCSIFADDR
comma
op_amp
id|ifr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
(brace
id|saved_errno
op_assign
id|errno
suffix:semicolon
id|v_print
c_func
(paren
l_string|&quot;Interface &squot;%s&squot;: Error: SIOCSIFADDR failed: %s&bslash;n&quot;
comma
id|ifname
comma
id|strerror
c_func
(paren
id|saved_errno
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|v_print
c_func
(paren
l_string|&quot;Interface &squot;%s&squot;: address cleared&bslash;n&quot;
comma
id|ifname
)paren
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
DECL|function|set_if_addr
r_static
r_int
id|set_if_addr
c_func
(paren
r_char
op_star
id|master_ifname
comma
r_char
op_star
id|slave_ifname
)paren
(brace
r_struct
id|ifreq
id|ifr
suffix:semicolon
r_int
id|res
suffix:semicolon
r_int
r_char
op_star
id|ipaddr
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
(brace
r_char
op_star
id|req_name
suffix:semicolon
r_char
op_star
id|desc
suffix:semicolon
r_int
id|g_ioctl
suffix:semicolon
r_int
id|s_ioctl
suffix:semicolon
)brace
id|ifra
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;IFADDR&quot;
comma
l_string|&quot;addr&quot;
comma
id|SIOCGIFADDR
comma
id|SIOCSIFADDR
)brace
comma
(brace
l_string|&quot;DSTADDR&quot;
comma
l_string|&quot;destination addr&quot;
comma
id|SIOCGIFDSTADDR
comma
id|SIOCSIFDSTADDR
)brace
comma
(brace
l_string|&quot;BRDADDR&quot;
comma
l_string|&quot;broadcast addr&quot;
comma
id|SIOCGIFBRDADDR
comma
id|SIOCSIFBRDADDR
)brace
comma
(brace
l_string|&quot;NETMASK&quot;
comma
l_string|&quot;netmask&quot;
comma
id|SIOCGIFNETMASK
comma
id|SIOCSIFNETMASK
)brace
comma
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|0
comma
l_int|0
)brace
comma
)brace
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|ifra
(braket
id|i
)braket
dot
id|req_name
suffix:semicolon
id|i
op_increment
)paren
(brace
id|strncpy
c_func
(paren
id|ifr.ifr_name
comma
id|master_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
id|res
op_assign
id|ioctl
c_func
(paren
id|skfd
comma
id|ifra
(braket
id|i
)braket
dot
id|g_ioctl
comma
op_amp
id|ifr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
(brace
r_int
id|saved_errno
op_assign
id|errno
suffix:semicolon
id|v_print
c_func
(paren
l_string|&quot;Interface &squot;%s&squot;: Error: SIOCG%s failed: %s&bslash;n&quot;
comma
id|master_ifname
comma
id|ifra
(braket
id|i
)braket
dot
id|req_name
comma
id|strerror
c_func
(paren
id|saved_errno
)paren
)paren
suffix:semicolon
id|ifr.ifr_addr.sa_family
op_assign
id|AF_INET
suffix:semicolon
id|memset
c_func
(paren
id|ifr.ifr_addr.sa_data
comma
l_int|0
comma
r_sizeof
(paren
id|ifr.ifr_addr.sa_data
)paren
)paren
suffix:semicolon
)brace
id|strncpy
c_func
(paren
id|ifr.ifr_name
comma
id|slave_ifname
comma
id|IFNAMSIZ
)paren
suffix:semicolon
id|res
op_assign
id|ioctl
c_func
(paren
id|skfd
comma
id|ifra
(braket
id|i
)braket
dot
id|s_ioctl
comma
op_amp
id|ifr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
(brace
r_int
id|saved_errno
op_assign
id|errno
suffix:semicolon
id|v_print
c_func
(paren
l_string|&quot;Interface &squot;%s&squot;: Error: SIOCS%s failed: %s&bslash;n&quot;
comma
id|slave_ifname
comma
id|ifra
(braket
id|i
)braket
dot
id|req_name
comma
id|strerror
c_func
(paren
id|saved_errno
)paren
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
id|ipaddr
op_assign
id|ifr.ifr_addr.sa_data
suffix:semicolon
id|v_print
c_func
(paren
l_string|&quot;Interface &squot;%s&squot;: set IP %s to %d.%d.%d.%d&bslash;n&quot;
comma
id|slave_ifname
comma
id|ifra
(braket
id|i
)braket
dot
id|desc
comma
id|ipaddr
(braket
l_int|0
)braket
comma
id|ipaddr
(braket
l_int|1
)braket
comma
id|ipaddr
(braket
l_int|2
)braket
comma
id|ipaddr
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Local variables:&n; *  version-control: t&n; *  kept-new-versions: 5&n; *  c-indent-level: 4&n; *  c-basic-offset: 4&n; *  tab-width: 4&n; *  compile-command: &quot;gcc -Wall -Wstrict-prototypes -O -I/usr/src/linux/include ifenslave.c -o ifenslave&quot;&n; * End:&n; */
eof
