multiline_comment|/*&n; * firmware_sample_driver.c -&n; *&n; * Copyright (c) 2003 Manuel Estrada Sainz &lt;ranty@debian.org&gt;&n; *&n; * Sample code on how to use request_firmware() from drivers.&n; *&n; * Note that register_firmware() is currently useless.&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &quot;linux/firmware.h&quot;
DECL|macro|WE_CAN_NEED_FIRMWARE_BEFORE_USERSPACE_IS_AVAILABLE
mdefine_line|#define WE_CAN_NEED_FIRMWARE_BEFORE_USERSPACE_IS_AVAILABLE
macro_line|#ifdef WE_CAN_NEED_FIRMWARE_BEFORE_USERSPACE_IS_AVAILABLE
DECL|variable|inkernel_firmware
r_char
id|__init
id|inkernel_firmware
(braket
)braket
op_assign
l_string|&quot;let&squot;s say that this is firmware&bslash;n&quot;
suffix:semicolon
macro_line|#endif
DECL|variable|ghost_device
r_static
r_struct
id|device
id|ghost_device
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;Ghost Device&quot;
comma
dot
id|bus_id
op_assign
l_string|&quot;ghost0&quot;
comma
)brace
suffix:semicolon
DECL|function|sample_firmware_load
r_static
r_void
id|sample_firmware_load
c_func
(paren
r_char
op_star
id|firmware
comma
r_int
id|size
)paren
(brace
id|u8
id|buf
(braket
id|size
op_plus
l_int|1
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|buf
comma
id|firmware
comma
id|size
)paren
suffix:semicolon
id|buf
(braket
id|size
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;firmware_sample_driver: firmware: %s&bslash;n&quot;
comma
id|buf
)paren
suffix:semicolon
)brace
DECL|function|sample_probe_default
r_static
r_void
id|sample_probe_default
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* uses the default method to get the firmware */
r_const
r_struct
id|firmware
op_star
id|fw_entry
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;firmware_sample_driver: a ghost device got inserted :)&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_firmware
c_func
(paren
op_amp
id|fw_entry
comma
l_string|&quot;sample_driver_fw&quot;
comma
op_amp
id|ghost_device
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;firmware_sample_driver: Firmware not available&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sample_firmware_load
c_func
(paren
id|fw_entry-&gt;data
comma
id|fw_entry-&gt;size
)paren
suffix:semicolon
id|release_firmware
c_func
(paren
id|fw_entry
)paren
suffix:semicolon
multiline_comment|/* finish setting up the device */
)brace
DECL|function|sample_probe_specific
r_static
r_void
id|sample_probe_specific
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Uses some specific hotplug support to get the firmware from&n;&t; * userspace  directly into the hardware, or via some sysfs file */
multiline_comment|/* NOTE: This currently doesn&squot;t work */
id|printk
c_func
(paren
l_string|&quot;firmware_sample_driver: a ghost device got inserted :)&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_firmware
c_func
(paren
l_int|NULL
comma
l_string|&quot;sample_driver_fw&quot;
comma
op_amp
id|ghost_device
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;firmware_sample_driver: Firmware load failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* request_firmware blocks until userspace finished, so at&n;&t; * this point the firmware should be already in the device */
multiline_comment|/* finish setting up the device */
)brace
DECL|function|sample_probe_async_cont
r_static
r_void
id|sample_probe_async_cont
c_func
(paren
r_const
r_struct
id|firmware
op_star
id|fw
comma
r_void
op_star
id|context
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|fw
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;firmware_sample_driver: firmware load failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;firmware_sample_driver: device pointer &bslash;&quot;%s&bslash;&quot;&bslash;n&quot;
comma
(paren
r_char
op_star
)paren
id|context
)paren
suffix:semicolon
id|sample_firmware_load
c_func
(paren
id|fw-&gt;data
comma
id|fw-&gt;size
)paren
suffix:semicolon
)brace
DECL|function|sample_probe_async
r_static
r_void
id|sample_probe_async
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Let&squot;s say that I can&squot;t sleep */
r_int
id|error
suffix:semicolon
id|error
op_assign
id|request_firmware_nowait
(paren
id|THIS_MODULE
comma
l_string|&quot;sample_driver_fw&quot;
comma
op_amp
id|ghost_device
comma
l_string|&quot;my device pointer&quot;
comma
id|sample_probe_async_cont
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;firmware_sample_driver:&quot;
l_string|&quot; request_firmware_nowait failed&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|sample_init
r_static
r_int
id|sample_init
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef WE_CAN_NEED_FIRMWARE_BEFORE_USERSPACE_IS_AVAILABLE
id|register_firmware
c_func
(paren
l_string|&quot;sample_driver_fw&quot;
comma
id|inkernel_firmware
comma
r_sizeof
(paren
id|inkernel_firmware
)paren
)paren
suffix:semicolon
macro_line|#endif
id|device_initialize
c_func
(paren
op_amp
id|ghost_device
)paren
suffix:semicolon
multiline_comment|/* since there is no real hardware insertion I just call the&n;&t; * sample probe functions here */
id|sample_probe_specific
c_func
(paren
)paren
suffix:semicolon
id|sample_probe_default
c_func
(paren
)paren
suffix:semicolon
id|sample_probe_async
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sample_exit
r_static
r_void
id|__exit
id|sample_exit
c_func
(paren
r_void
)paren
(brace
)brace
DECL|variable|sample_init
id|module_init
(paren
id|sample_init
)paren
suffix:semicolon
DECL|variable|sample_exit
id|module_exit
(paren
id|sample_exit
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
