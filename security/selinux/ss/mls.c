multiline_comment|/*&n; * Implementation of the multi-level security (MLS) policy.&n; *&n; * Author : Stephen Smalley, &lt;sds@epoch.ncsc.mil&gt;&n; */
multiline_comment|/*&n; * Updated: Trusted Computer Solutions, Inc. &lt;dgoeddel@trustedcs.com&gt;&n; *&n; *&t;Support for enhanced MLS infrastructure.&n; *&n; * Copyright (C) 2004-2005 Trusted Computer Solutions, Inc.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &quot;mls.h&quot;
macro_line|#include &quot;policydb.h&quot;
macro_line|#include &quot;services.h&quot;
multiline_comment|/*&n; * Return the length in bytes for the MLS fields of the&n; * security context string representation of `context&squot;.&n; */
DECL|function|mls_compute_context_len
r_int
id|mls_compute_context_len
c_func
(paren
r_struct
id|context
op_star
id|context
)paren
(brace
r_int
id|i
comma
id|l
comma
id|len
comma
id|range
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|selinux_mls_enabled
)paren
r_return
l_int|0
suffix:semicolon
id|len
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* for the beginning &quot;:&quot; */
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|2
suffix:semicolon
id|l
op_increment
)paren
(brace
id|range
op_assign
l_int|0
suffix:semicolon
id|len
op_add_assign
id|strlen
c_func
(paren
id|policydb.p_sens_val_to_name
(braket
id|context-&gt;range.level
(braket
id|l
)braket
dot
id|sens
op_minus
l_int|1
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
id|ebitmap_length
c_func
(paren
op_amp
id|context-&gt;range.level
(braket
id|l
)braket
dot
id|cat
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ebitmap_get_bit
c_func
(paren
op_amp
id|context-&gt;range.level
(braket
id|l
)braket
dot
id|cat
comma
id|i
op_minus
l_int|1
)paren
)paren
(brace
r_if
c_cond
(paren
id|range
)paren
(brace
id|range
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|len
op_add_assign
id|strlen
c_func
(paren
id|policydb.p_cat_val_to_name
(braket
id|i
op_minus
l_int|1
)braket
)paren
op_plus
l_int|1
suffix:semicolon
id|range
op_increment
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|range
OG
l_int|1
)paren
id|len
op_add_assign
id|strlen
c_func
(paren
id|policydb.p_cat_val_to_name
(braket
id|i
op_minus
l_int|2
)braket
)paren
op_plus
l_int|1
suffix:semicolon
id|range
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Handle case where last category is the end of range */
r_if
c_cond
(paren
id|range
OG
l_int|1
)paren
id|len
op_add_assign
id|strlen
c_func
(paren
id|policydb.p_cat_val_to_name
(braket
id|i
op_minus
l_int|2
)braket
)paren
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|l
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|mls_level_eq
c_func
(paren
op_amp
id|context-&gt;range.level
(braket
l_int|0
)braket
comma
op_amp
id|context-&gt;range.level
(braket
l_int|1
)braket
)paren
)paren
r_break
suffix:semicolon
r_else
id|len
op_increment
suffix:semicolon
)brace
)brace
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * Write the security context string representation of&n; * the MLS fields of `context&squot; into the string `*scontext&squot;.&n; * Update `*scontext&squot; to point to the end of the MLS fields.&n; */
DECL|function|mls_sid_to_context
r_void
id|mls_sid_to_context
c_func
(paren
r_struct
id|context
op_star
id|context
comma
r_char
op_star
op_star
id|scontext
)paren
(brace
r_char
op_star
id|scontextp
suffix:semicolon
r_int
id|i
comma
id|l
comma
id|range
comma
id|wrote_sep
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|selinux_mls_enabled
)paren
r_return
suffix:semicolon
id|scontextp
op_assign
op_star
id|scontext
suffix:semicolon
op_star
id|scontextp
op_assign
l_char|&squot;:&squot;
suffix:semicolon
id|scontextp
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|2
suffix:semicolon
id|l
op_increment
)paren
(brace
id|range
op_assign
l_int|0
suffix:semicolon
id|wrote_sep
op_assign
l_int|0
suffix:semicolon
id|strcpy
c_func
(paren
id|scontextp
comma
id|policydb.p_sens_val_to_name
(braket
id|context-&gt;range.level
(braket
id|l
)braket
dot
id|sens
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|scontextp
op_add_assign
id|strlen
c_func
(paren
id|policydb.p_sens_val_to_name
(braket
id|context-&gt;range.level
(braket
id|l
)braket
dot
id|sens
op_minus
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* categories */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
id|ebitmap_length
c_func
(paren
op_amp
id|context-&gt;range.level
(braket
id|l
)braket
dot
id|cat
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ebitmap_get_bit
c_func
(paren
op_amp
id|context-&gt;range.level
(braket
id|l
)braket
dot
id|cat
comma
id|i
op_minus
l_int|1
)paren
)paren
(brace
r_if
c_cond
(paren
id|range
)paren
(brace
id|range
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|wrote_sep
)paren
(brace
op_star
id|scontextp
op_increment
op_assign
l_char|&squot;:&squot;
suffix:semicolon
id|wrote_sep
op_assign
l_int|1
suffix:semicolon
)brace
r_else
op_star
id|scontextp
op_increment
op_assign
l_char|&squot;,&squot;
suffix:semicolon
id|strcpy
c_func
(paren
id|scontextp
comma
id|policydb.p_cat_val_to_name
(braket
id|i
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|scontextp
op_add_assign
id|strlen
c_func
(paren
id|policydb.p_cat_val_to_name
(braket
id|i
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|range
op_increment
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|range
OG
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|range
OG
l_int|2
)paren
op_star
id|scontextp
op_increment
op_assign
l_char|&squot;.&squot;
suffix:semicolon
r_else
op_star
id|scontextp
op_increment
op_assign
l_char|&squot;,&squot;
suffix:semicolon
id|strcpy
c_func
(paren
id|scontextp
comma
id|policydb.p_cat_val_to_name
(braket
id|i
op_minus
l_int|2
)braket
)paren
suffix:semicolon
id|scontextp
op_add_assign
id|strlen
c_func
(paren
id|policydb.p_cat_val_to_name
(braket
id|i
op_minus
l_int|2
)braket
)paren
suffix:semicolon
)brace
id|range
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Handle case where last category is the end of range */
r_if
c_cond
(paren
id|range
OG
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|range
OG
l_int|2
)paren
op_star
id|scontextp
op_increment
op_assign
l_char|&squot;.&squot;
suffix:semicolon
r_else
op_star
id|scontextp
op_increment
op_assign
l_char|&squot;,&squot;
suffix:semicolon
id|strcpy
c_func
(paren
id|scontextp
comma
id|policydb.p_cat_val_to_name
(braket
id|i
op_minus
l_int|2
)braket
)paren
suffix:semicolon
id|scontextp
op_add_assign
id|strlen
c_func
(paren
id|policydb.p_cat_val_to_name
(braket
id|i
op_minus
l_int|2
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|l
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|mls_level_eq
c_func
(paren
op_amp
id|context-&gt;range.level
(braket
l_int|0
)braket
comma
op_amp
id|context-&gt;range.level
(braket
l_int|1
)braket
)paren
)paren
r_break
suffix:semicolon
r_else
(brace
op_star
id|scontextp
op_assign
l_char|&squot;-&squot;
suffix:semicolon
id|scontextp
op_increment
suffix:semicolon
)brace
)brace
)brace
op_star
id|scontext
op_assign
id|scontextp
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Return 1 if the MLS fields in the security context&n; * structure `c&squot; are valid.  Return 0 otherwise.&n; */
DECL|function|mls_context_isvalid
r_int
id|mls_context_isvalid
c_func
(paren
r_struct
id|policydb
op_star
id|p
comma
r_struct
id|context
op_star
id|c
)paren
(brace
r_struct
id|level_datum
op_star
id|levdatum
suffix:semicolon
r_struct
id|user_datum
op_star
id|usrdatum
suffix:semicolon
r_int
id|i
comma
id|l
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|selinux_mls_enabled
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * MLS range validity checks: high must dominate low, low level must&n;&t; * be valid (category set &lt;-&gt; sensitivity check), and high level must&n;&t; * be valid (category set &lt;-&gt; sensitivity check)&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|mls_level_dom
c_func
(paren
op_amp
id|c-&gt;range.level
(braket
l_int|1
)braket
comma
op_amp
id|c-&gt;range.level
(braket
l_int|0
)braket
)paren
)paren
multiline_comment|/* High does not dominate low. */
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|2
suffix:semicolon
id|l
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|c-&gt;range.level
(braket
id|l
)braket
dot
id|sens
op_logical_or
id|c-&gt;range.level
(braket
id|l
)braket
dot
id|sens
OG
id|p-&gt;p_levels.nprim
)paren
r_return
l_int|0
suffix:semicolon
id|levdatum
op_assign
id|hashtab_search
c_func
(paren
id|p-&gt;p_levels.table
comma
id|p-&gt;p_sens_val_to_name
(braket
id|c-&gt;range.level
(braket
id|l
)braket
dot
id|sens
op_minus
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|levdatum
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
id|ebitmap_length
c_func
(paren
op_amp
id|c-&gt;range.level
(braket
id|l
)braket
dot
id|cat
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ebitmap_get_bit
c_func
(paren
op_amp
id|c-&gt;range.level
(braket
id|l
)braket
dot
id|cat
comma
id|i
op_minus
l_int|1
)paren
)paren
(brace
r_if
c_cond
(paren
id|i
OG
id|p-&gt;p_cats.nprim
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ebitmap_get_bit
c_func
(paren
op_amp
id|levdatum-&gt;level-&gt;cat
comma
id|i
op_minus
l_int|1
)paren
)paren
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Category may not be associated with&n;&t;&t;&t;&t;&t; * sensitivity in low level.&n;&t;&t;&t;&t;&t; */
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|c-&gt;role
op_eq
id|OBJECT_R_VAL
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * User must be authorized for the MLS range.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|c-&gt;user
op_logical_or
id|c-&gt;user
OG
id|p-&gt;p_users.nprim
)paren
r_return
l_int|0
suffix:semicolon
id|usrdatum
op_assign
id|p-&gt;user_val_to_struct
(braket
id|c-&gt;user
op_minus
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mls_range_contains
c_func
(paren
id|usrdatum-&gt;range
comma
id|c-&gt;range
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* user may not be associated with range */
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Set the MLS fields in the security context structure&n; * `context&squot; based on the string representation in&n; * the string `*scontext&squot;.  Update `*scontext&squot; to&n; * point to the end of the string representation of&n; * the MLS fields.&n; *&n; * This function modifies the string in place, inserting&n; * NULL characters to terminate the MLS fields.&n; */
DECL|function|mls_context_to_sid
r_int
id|mls_context_to_sid
c_func
(paren
r_char
id|oldc
comma
r_char
op_star
op_star
id|scontext
comma
r_struct
id|context
op_star
id|context
)paren
(brace
r_char
id|delim
suffix:semicolon
r_char
op_star
id|scontextp
comma
op_star
id|p
comma
op_star
id|rngptr
suffix:semicolon
r_struct
id|level_datum
op_star
id|levdatum
suffix:semicolon
r_struct
id|cat_datum
op_star
id|catdatum
comma
op_star
id|rngdatum
suffix:semicolon
r_int
id|l
comma
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|selinux_mls_enabled
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* No MLS component to the security context. */
r_if
c_cond
(paren
op_logical_neg
id|oldc
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Extract low sensitivity. */
id|scontextp
op_assign
id|p
op_assign
op_star
id|scontext
suffix:semicolon
r_while
c_loop
(paren
op_star
id|p
op_logical_and
op_star
id|p
op_ne
l_char|&squot;:&squot;
op_logical_and
op_star
id|p
op_ne
l_char|&squot;-&squot;
)paren
id|p
op_increment
suffix:semicolon
id|delim
op_assign
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|delim
op_ne
l_int|0
)paren
op_star
id|p
op_increment
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|2
suffix:semicolon
id|l
op_increment
)paren
(brace
id|levdatum
op_assign
id|hashtab_search
c_func
(paren
id|policydb.p_levels.table
comma
id|scontextp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|levdatum
)paren
(brace
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|context-&gt;range.level
(braket
id|l
)braket
dot
id|sens
op_assign
id|levdatum-&gt;level-&gt;sens
suffix:semicolon
r_if
c_cond
(paren
id|delim
op_eq
l_char|&squot;:&squot;
)paren
(brace
multiline_comment|/* Extract category set. */
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|scontextp
op_assign
id|p
suffix:semicolon
r_while
c_loop
(paren
op_star
id|p
op_logical_and
op_star
id|p
op_ne
l_char|&squot;,&squot;
op_logical_and
op_star
id|p
op_ne
l_char|&squot;-&squot;
)paren
id|p
op_increment
suffix:semicolon
id|delim
op_assign
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|delim
op_ne
l_int|0
)paren
op_star
id|p
op_increment
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Separate into range if exists */
r_if
c_cond
(paren
(paren
id|rngptr
op_assign
id|strchr
c_func
(paren
id|scontextp
comma
l_char|&squot;.&squot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* Remove &squot;.&squot; */
op_star
id|rngptr
op_increment
op_assign
l_int|0
suffix:semicolon
)brace
id|catdatum
op_assign
id|hashtab_search
c_func
(paren
id|policydb.p_cats.table
comma
id|scontextp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|catdatum
)paren
(brace
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|rc
op_assign
id|ebitmap_set_bit
c_func
(paren
op_amp
id|context-&gt;range.level
(braket
id|l
)braket
dot
id|cat
comma
id|catdatum-&gt;value
op_minus
l_int|1
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* If range, set all categories in range */
r_if
c_cond
(paren
id|rngptr
)paren
(brace
r_int
id|i
suffix:semicolon
id|rngdatum
op_assign
id|hashtab_search
c_func
(paren
id|policydb.p_cats.table
comma
id|rngptr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rngdatum
)paren
(brace
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|catdatum-&gt;value
op_ge
id|rngdatum-&gt;value
)paren
(brace
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|catdatum-&gt;value
suffix:semicolon
id|i
OL
id|rngdatum-&gt;value
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rc
op_assign
id|ebitmap_set_bit
c_func
(paren
op_amp
id|context-&gt;range.level
(braket
id|l
)braket
dot
id|cat
comma
id|i
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|out
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|delim
op_ne
l_char|&squot;,&squot;
)paren
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|delim
op_eq
l_char|&squot;-&squot;
)paren
(brace
multiline_comment|/* Extract high sensitivity. */
id|scontextp
op_assign
id|p
suffix:semicolon
r_while
c_loop
(paren
op_star
id|p
op_logical_and
op_star
id|p
op_ne
l_char|&squot;:&squot;
)paren
id|p
op_increment
suffix:semicolon
id|delim
op_assign
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|delim
op_ne
l_int|0
)paren
op_star
id|p
op_increment
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|l
op_eq
l_int|0
)paren
(brace
id|context-&gt;range.level
(braket
l_int|1
)braket
dot
id|sens
op_assign
id|context-&gt;range.level
(braket
l_int|0
)braket
dot
id|sens
suffix:semicolon
id|rc
op_assign
id|ebitmap_cpy
c_func
(paren
op_amp
id|context-&gt;range.level
(braket
l_int|1
)braket
dot
id|cat
comma
op_amp
id|context-&gt;range.level
(braket
l_int|0
)braket
dot
id|cat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|out
suffix:semicolon
)brace
op_star
id|scontext
op_assign
op_increment
id|p
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Copies the MLS range from `src&squot; into `dst&squot;.&n; */
DECL|function|mls_copy_context
r_static
r_inline
r_int
id|mls_copy_context
c_func
(paren
r_struct
id|context
op_star
id|dst
comma
r_struct
id|context
op_star
id|src
)paren
(brace
r_int
id|l
comma
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Copy the MLS range from the source context */
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|2
suffix:semicolon
id|l
op_increment
)paren
(brace
id|dst-&gt;range.level
(braket
id|l
)braket
dot
id|sens
op_assign
id|src-&gt;range.level
(braket
id|l
)braket
dot
id|sens
suffix:semicolon
id|rc
op_assign
id|ebitmap_cpy
c_func
(paren
op_amp
id|dst-&gt;range.level
(braket
id|l
)braket
dot
id|cat
comma
op_amp
id|src-&gt;range.level
(braket
id|l
)braket
dot
id|cat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_break
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Copies the effective MLS range from `src&squot; into `dst&squot;.&n; */
DECL|function|mls_scopy_context
r_static
r_inline
r_int
id|mls_scopy_context
c_func
(paren
r_struct
id|context
op_star
id|dst
comma
r_struct
id|context
op_star
id|src
)paren
(brace
r_int
id|l
comma
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Copy the MLS range from the source context */
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|2
suffix:semicolon
id|l
op_increment
)paren
(brace
id|dst-&gt;range.level
(braket
id|l
)braket
dot
id|sens
op_assign
id|src-&gt;range.level
(braket
l_int|0
)braket
dot
id|sens
suffix:semicolon
id|rc
op_assign
id|ebitmap_cpy
c_func
(paren
op_amp
id|dst-&gt;range.level
(braket
id|l
)braket
dot
id|cat
comma
op_amp
id|src-&gt;range.level
(braket
l_int|0
)braket
dot
id|cat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_break
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Copies the MLS range `range&squot; into `context&squot;.&n; */
DECL|function|mls_range_set
r_static
r_inline
r_int
id|mls_range_set
c_func
(paren
r_struct
id|context
op_star
id|context
comma
r_struct
id|mls_range
op_star
id|range
)paren
(brace
r_int
id|l
comma
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Copy the MLS range into the  context */
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|2
suffix:semicolon
id|l
op_increment
)paren
(brace
id|context-&gt;range.level
(braket
id|l
)braket
dot
id|sens
op_assign
id|range-&gt;level
(braket
id|l
)braket
dot
id|sens
suffix:semicolon
id|rc
op_assign
id|ebitmap_cpy
c_func
(paren
op_amp
id|context-&gt;range.level
(braket
id|l
)braket
dot
id|cat
comma
op_amp
id|range-&gt;level
(braket
id|l
)braket
dot
id|cat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_break
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
DECL|function|mls_setup_user_range
r_int
id|mls_setup_user_range
c_func
(paren
r_struct
id|context
op_star
id|fromcon
comma
r_struct
id|user_datum
op_star
id|user
comma
r_struct
id|context
op_star
id|usercon
)paren
(brace
r_if
c_cond
(paren
id|selinux_mls_enabled
)paren
(brace
r_struct
id|mls_level
op_star
id|fromcon_sen
op_assign
op_amp
(paren
id|fromcon-&gt;range.level
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_struct
id|mls_level
op_star
id|fromcon_clr
op_assign
op_amp
(paren
id|fromcon-&gt;range.level
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_struct
id|mls_level
op_star
id|user_low
op_assign
op_amp
(paren
id|user-&gt;range.level
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_struct
id|mls_level
op_star
id|user_clr
op_assign
op_amp
(paren
id|user-&gt;range.level
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_struct
id|mls_level
op_star
id|user_def
op_assign
op_amp
(paren
id|user-&gt;dfltlevel
)paren
suffix:semicolon
r_struct
id|mls_level
op_star
id|usercon_sen
op_assign
op_amp
(paren
id|usercon-&gt;range.level
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_struct
id|mls_level
op_star
id|usercon_clr
op_assign
op_amp
(paren
id|usercon-&gt;range.level
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* Honor the user&squot;s default level if we can */
r_if
c_cond
(paren
id|mls_level_between
c_func
(paren
id|user_def
comma
id|fromcon_sen
comma
id|fromcon_clr
)paren
)paren
(brace
op_star
id|usercon_sen
op_assign
op_star
id|user_def
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mls_level_between
c_func
(paren
id|fromcon_sen
comma
id|user_def
comma
id|user_clr
)paren
)paren
(brace
op_star
id|usercon_sen
op_assign
op_star
id|fromcon_sen
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mls_level_between
c_func
(paren
id|fromcon_clr
comma
id|user_low
comma
id|user_def
)paren
)paren
(brace
op_star
id|usercon_sen
op_assign
op_star
id|user_low
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Lower the clearance of available contexts&n;&t;&t;   if the clearance of &quot;fromcon&quot; is lower than&n;&t;&t;   that of the user&squot;s default clearance (but&n;&t;&t;   only if the &quot;fromcon&quot; clearance dominates&n;&t;&t;   the user&squot;s computed sensitivity level) */
r_if
c_cond
(paren
id|mls_level_dom
c_func
(paren
id|user_clr
comma
id|fromcon_clr
)paren
)paren
(brace
op_star
id|usercon_clr
op_assign
op_star
id|fromcon_clr
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mls_level_dom
c_func
(paren
id|fromcon_clr
comma
id|user_clr
)paren
)paren
(brace
op_star
id|usercon_clr
op_assign
op_star
id|user_clr
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Convert the MLS fields in the security context&n; * structure `c&squot; from the values specified in the&n; * policy `oldp&squot; to the values specified in the policy `newp&squot;.&n; */
DECL|function|mls_convert_context
r_int
id|mls_convert_context
c_func
(paren
r_struct
id|policydb
op_star
id|oldp
comma
r_struct
id|policydb
op_star
id|newp
comma
r_struct
id|context
op_star
id|c
)paren
(brace
r_struct
id|level_datum
op_star
id|levdatum
suffix:semicolon
r_struct
id|cat_datum
op_star
id|catdatum
suffix:semicolon
r_struct
id|ebitmap
id|bitmap
suffix:semicolon
r_int
id|l
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|selinux_mls_enabled
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|2
suffix:semicolon
id|l
op_increment
)paren
(brace
id|levdatum
op_assign
id|hashtab_search
c_func
(paren
id|newp-&gt;p_levels.table
comma
id|oldp-&gt;p_sens_val_to_name
(braket
id|c-&gt;range.level
(braket
id|l
)braket
dot
id|sens
op_minus
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|levdatum
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|c-&gt;range.level
(braket
id|l
)braket
dot
id|sens
op_assign
id|levdatum-&gt;level-&gt;sens
suffix:semicolon
id|ebitmap_init
c_func
(paren
op_amp
id|bitmap
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
id|ebitmap_length
c_func
(paren
op_amp
id|c-&gt;range.level
(braket
id|l
)braket
dot
id|cat
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ebitmap_get_bit
c_func
(paren
op_amp
id|c-&gt;range.level
(braket
id|l
)braket
dot
id|cat
comma
id|i
op_minus
l_int|1
)paren
)paren
(brace
r_int
id|rc
suffix:semicolon
id|catdatum
op_assign
id|hashtab_search
c_func
(paren
id|newp-&gt;p_cats.table
comma
id|oldp-&gt;p_cat_val_to_name
(braket
id|i
op_minus
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|catdatum
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|rc
op_assign
id|ebitmap_set_bit
c_func
(paren
op_amp
id|bitmap
comma
id|catdatum-&gt;value
op_minus
l_int|1
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
)brace
)brace
id|ebitmap_destroy
c_func
(paren
op_amp
id|c-&gt;range.level
(braket
id|l
)braket
dot
id|cat
)paren
suffix:semicolon
id|c-&gt;range.level
(braket
id|l
)braket
dot
id|cat
op_assign
id|bitmap
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mls_compute_sid
r_int
id|mls_compute_sid
c_func
(paren
r_struct
id|context
op_star
id|scontext
comma
r_struct
id|context
op_star
id|tcontext
comma
id|u16
id|tclass
comma
id|u32
id|specified
comma
r_struct
id|context
op_star
id|newcontext
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|selinux_mls_enabled
)paren
r_return
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|specified
)paren
(brace
r_case
id|AVTAB_TRANSITION
suffix:colon
r_if
c_cond
(paren
id|tclass
op_eq
id|SECCLASS_PROCESS
)paren
(brace
r_struct
id|range_trans
op_star
id|rangetr
suffix:semicolon
multiline_comment|/* Look for a range transition rule. */
r_for
c_loop
(paren
id|rangetr
op_assign
id|policydb.range_tr
suffix:semicolon
id|rangetr
suffix:semicolon
id|rangetr
op_assign
id|rangetr-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|rangetr-&gt;dom
op_eq
id|scontext-&gt;type
op_logical_and
id|rangetr-&gt;type
op_eq
id|tcontext-&gt;type
)paren
(brace
multiline_comment|/* Set the range from the rule */
r_return
id|mls_range_set
c_func
(paren
id|newcontext
comma
op_amp
id|rangetr-&gt;range
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Fallthrough */
r_case
id|AVTAB_CHANGE
suffix:colon
r_if
c_cond
(paren
id|tclass
op_eq
id|SECCLASS_PROCESS
)paren
multiline_comment|/* Use the process MLS attributes. */
r_return
id|mls_copy_context
c_func
(paren
id|newcontext
comma
id|scontext
)paren
suffix:semicolon
r_else
multiline_comment|/* Use the process effective MLS attributes. */
r_return
id|mls_scopy_context
c_func
(paren
id|newcontext
comma
id|scontext
)paren
suffix:semicolon
r_case
id|AVTAB_MEMBER
suffix:colon
multiline_comment|/* Only polyinstantiate the MLS attributes if&n;&t;&t;   the type is being polyinstantiated */
r_if
c_cond
(paren
id|newcontext-&gt;type
op_ne
id|tcontext-&gt;type
)paren
(brace
multiline_comment|/* Use the process effective MLS attributes. */
r_return
id|mls_scopy_context
c_func
(paren
id|newcontext
comma
id|scontext
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Use the related object MLS attributes. */
r_return
id|mls_copy_context
c_func
(paren
id|newcontext
comma
id|tcontext
)paren
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
eof
