multiline_comment|/*&n; * Network interface table.&n; *&n; * Network interfaces (devices) do not have a security field, so we&n; * maintain a table associating each interface with a SID.&n; *&n; * Author: James Morris &lt;jmorris@redhat.com&gt;&n; *&n; * Copyright (C) 2003 Red Hat, Inc., James Morris &lt;jmorris@redhat.com&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2,&n; * as published by the Free Software Foundation.&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/notifier.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/rcupdate.h&gt;
macro_line|#include &quot;security.h&quot;
macro_line|#include &quot;objsec.h&quot;
macro_line|#include &quot;netif.h&quot;
DECL|macro|SEL_NETIF_HASH_SIZE
mdefine_line|#define SEL_NETIF_HASH_SIZE&t;64
DECL|macro|SEL_NETIF_HASH_MAX
mdefine_line|#define SEL_NETIF_HASH_MAX&t;1024
DECL|macro|DEBUG
macro_line|#undef DEBUG
macro_line|#ifdef DEBUG
DECL|macro|DEBUGP
mdefine_line|#define DEBUGP printk
macro_line|#else
DECL|macro|DEBUGP
mdefine_line|#define DEBUGP(format, args...)
macro_line|#endif
DECL|struct|sel_netif
r_struct
id|sel_netif
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|nsec
r_struct
id|netif_security_struct
id|nsec
suffix:semicolon
DECL|member|rcu_head
r_struct
id|rcu_head
id|rcu_head
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|sel_netif_total
r_static
id|u32
id|sel_netif_total
suffix:semicolon
r_static
id|LIST_HEAD
c_func
(paren
id|sel_netif_list
)paren
suffix:semicolon
DECL|variable|sel_netif_lock
r_static
id|spinlock_t
id|sel_netif_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|sel_netif_hash
r_static
r_struct
id|list_head
id|sel_netif_hash
(braket
id|SEL_NETIF_HASH_SIZE
)braket
suffix:semicolon
DECL|function|sel_netif_hasfn
r_static
r_inline
id|u32
id|sel_netif_hasfn
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
(paren
id|dev-&gt;ifindex
op_amp
(paren
id|SEL_NETIF_HASH_SIZE
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * All of the devices should normally fit in the hash, so we optimize&n; * for that case.&n; */
DECL|function|sel_netif_find
r_static
r_inline
r_struct
id|sel_netif
op_star
id|sel_netif_find
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|list_head
op_star
id|pos
suffix:semicolon
r_int
id|idx
op_assign
id|sel_netif_hasfn
c_func
(paren
id|dev
)paren
suffix:semicolon
id|__list_for_each_rcu
c_func
(paren
id|pos
comma
op_amp
id|sel_netif_hash
(braket
id|idx
)braket
)paren
(brace
r_struct
id|sel_netif
op_star
id|netif
op_assign
id|list_entry
c_func
(paren
id|pos
comma
r_struct
id|sel_netif
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|netif-&gt;nsec.dev
op_eq
id|dev
)paren
)paren
r_return
id|netif
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|sel_netif_insert
r_static
r_int
id|sel_netif_insert
c_func
(paren
r_struct
id|sel_netif
op_star
id|netif
)paren
(brace
r_int
id|idx
comma
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sel_netif_total
op_ge
id|SEL_NETIF_HASH_MAX
)paren
(brace
id|ret
op_assign
op_minus
id|ENOSPC
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|idx
op_assign
id|sel_netif_hasfn
c_func
(paren
id|netif-&gt;nsec.dev
)paren
suffix:semicolon
id|list_add_rcu
c_func
(paren
op_amp
id|netif-&gt;list
comma
op_amp
id|sel_netif_hash
(braket
id|idx
)braket
)paren
suffix:semicolon
id|sel_netif_total
op_increment
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sel_netif_free
r_static
r_void
id|sel_netif_free
c_func
(paren
r_struct
id|rcu_head
op_star
id|p
)paren
(brace
r_struct
id|sel_netif
op_star
id|netif
op_assign
id|container_of
c_func
(paren
id|p
comma
r_struct
id|sel_netif
comma
id|rcu_head
)paren
suffix:semicolon
id|DEBUGP
c_func
(paren
l_string|&quot;%s: %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|netif-&gt;nsec.dev-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|netif
)paren
suffix:semicolon
)brace
DECL|function|sel_netif_destroy
r_static
r_void
id|sel_netif_destroy
c_func
(paren
r_struct
id|sel_netif
op_star
id|netif
)paren
(brace
id|DEBUGP
c_func
(paren
l_string|&quot;%s: %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|netif-&gt;nsec.dev-&gt;name
)paren
suffix:semicolon
id|list_del_rcu
c_func
(paren
op_amp
id|netif-&gt;list
)paren
suffix:semicolon
id|sel_netif_total
op_decrement
suffix:semicolon
id|call_rcu
c_func
(paren
op_amp
id|netif-&gt;rcu_head
comma
id|sel_netif_free
)paren
suffix:semicolon
)brace
DECL|function|sel_netif_lookup
r_static
r_struct
id|sel_netif
op_star
id|sel_netif_lookup
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ret
suffix:semicolon
r_struct
id|sel_netif
op_star
id|netif
comma
op_star
r_new
suffix:semicolon
r_struct
id|netif_security_struct
op_star
id|nsec
suffix:semicolon
id|netif
op_assign
id|sel_netif_find
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|netif
op_ne
l_int|NULL
)paren
)paren
r_goto
id|out
suffix:semicolon
r_new
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
r_new
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
r_new
)paren
(brace
id|netif
op_assign
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memset
c_func
(paren
r_new
comma
l_int|0
comma
r_sizeof
(paren
op_star
r_new
)paren
)paren
suffix:semicolon
id|nsec
op_assign
op_amp
r_new
op_member_access_from_pointer
id|nsec
suffix:semicolon
id|ret
op_assign
id|security_netif_sid
c_func
(paren
id|dev-&gt;name
comma
op_amp
id|nsec-&gt;if_sid
comma
op_amp
id|nsec-&gt;msg_sid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
r_new
)paren
suffix:semicolon
id|netif
op_assign
id|ERR_PTR
c_func
(paren
id|ret
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|nsec-&gt;dev
op_assign
id|dev
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|sel_netif_lock
)paren
suffix:semicolon
id|netif
op_assign
id|sel_netif_find
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif
)paren
(brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|sel_netif_lock
)paren
suffix:semicolon
id|kfree
c_func
(paren
r_new
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ret
op_assign
id|sel_netif_insert
c_func
(paren
r_new
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|sel_netif_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|kfree
c_func
(paren
r_new
)paren
suffix:semicolon
id|netif
op_assign
id|ERR_PTR
c_func
(paren
id|ret
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|netif
op_assign
r_new
suffix:semicolon
id|DEBUGP
c_func
(paren
l_string|&quot;new: ifindex=%u name=%s if_sid=%u msg_sid=%u&bslash;n&quot;
comma
id|dev-&gt;ifindex
comma
id|dev-&gt;name
comma
id|nsec-&gt;if_sid
comma
id|nsec-&gt;msg_sid
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|netif
suffix:semicolon
)brace
DECL|function|sel_netif_assign_sids
r_static
r_void
id|sel_netif_assign_sids
c_func
(paren
id|u32
id|if_sid_in
comma
id|u32
id|msg_sid_in
comma
id|u32
op_star
id|if_sid_out
comma
id|u32
op_star
id|msg_sid_out
)paren
(brace
r_if
c_cond
(paren
id|if_sid_out
)paren
op_star
id|if_sid_out
op_assign
id|if_sid_in
suffix:semicolon
r_if
c_cond
(paren
id|msg_sid_out
)paren
op_star
id|msg_sid_out
op_assign
id|msg_sid_in
suffix:semicolon
)brace
DECL|function|sel_netif_sids_slow
r_static
r_int
id|sel_netif_sids_slow
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
op_star
id|if_sid
comma
id|u32
op_star
id|msg_sid
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|u32
id|tmp_if_sid
comma
id|tmp_msg_sid
suffix:semicolon
id|ret
op_assign
id|security_netif_sid
c_func
(paren
id|dev-&gt;name
comma
op_amp
id|tmp_if_sid
comma
op_amp
id|tmp_msg_sid
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|sel_netif_assign_sids
c_func
(paren
id|tmp_if_sid
comma
id|tmp_msg_sid
comma
id|if_sid
comma
id|msg_sid
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sel_netif_sids
r_int
id|sel_netif_sids
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
op_star
id|if_sid
comma
id|u32
op_star
id|msg_sid
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|sel_netif
op_star
id|netif
suffix:semicolon
id|rcu_read_lock
c_func
(paren
)paren
suffix:semicolon
id|netif
op_assign
id|sel_netif_lookup
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|netif
)paren
)paren
(brace
id|rcu_read_unlock
c_func
(paren
)paren
suffix:semicolon
id|ret
op_assign
id|sel_netif_sids_slow
c_func
(paren
id|dev
comma
id|if_sid
comma
id|msg_sid
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|sel_netif_assign_sids
c_func
(paren
id|netif-&gt;nsec.if_sid
comma
id|netif-&gt;nsec.msg_sid
comma
id|if_sid
comma
id|msg_sid
)paren
suffix:semicolon
id|rcu_read_unlock
c_func
(paren
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sel_netif_kill
r_static
r_void
id|sel_netif_kill
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sel_netif
op_star
id|netif
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|sel_netif_lock
)paren
suffix:semicolon
id|netif
op_assign
id|sel_netif_find
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif
)paren
id|sel_netif_destroy
c_func
(paren
id|netif
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|sel_netif_lock
)paren
suffix:semicolon
)brace
DECL|function|sel_netif_flush
r_static
r_void
id|sel_netif_flush
c_func
(paren
r_void
)paren
(brace
r_int
id|idx
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|sel_netif_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|SEL_NETIF_HASH_SIZE
suffix:semicolon
id|idx
op_increment
)paren
(brace
r_struct
id|sel_netif
op_star
id|netif
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|netif
comma
op_amp
id|sel_netif_hash
(braket
id|idx
)braket
comma
id|list
)paren
id|sel_netif_destroy
c_func
(paren
id|netif
)paren
suffix:semicolon
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|sel_netif_lock
)paren
suffix:semicolon
)brace
DECL|function|sel_netif_avc_callback
r_static
r_int
id|sel_netif_avc_callback
c_func
(paren
id|u32
id|event
comma
id|u32
id|ssid
comma
id|u32
id|tsid
comma
id|u16
r_class
comma
id|u32
id|perms
comma
id|u32
op_star
id|retained
)paren
(brace
r_if
c_cond
(paren
id|event
op_eq
id|AVC_CALLBACK_RESET
)paren
(brace
id|sel_netif_flush
c_func
(paren
)paren
suffix:semicolon
id|synchronize_net
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sel_netif_netdev_notifier_handler
r_static
r_int
id|sel_netif_netdev_notifier_handler
c_func
(paren
r_struct
id|notifier_block
op_star
id|this
comma
r_int
r_int
id|event
comma
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|ptr
suffix:semicolon
r_if
c_cond
(paren
id|event
op_eq
id|NETDEV_DOWN
)paren
id|sel_netif_kill
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
DECL|variable|sel_netif_netdev_notifier
r_static
r_struct
id|notifier_block
id|sel_netif_netdev_notifier
op_assign
(brace
dot
id|notifier_call
op_assign
id|sel_netif_netdev_notifier_handler
comma
)brace
suffix:semicolon
DECL|function|sel_netif_init
r_static
id|__init
r_int
id|sel_netif_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|selinux_enabled
)paren
r_goto
id|out
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SEL_NETIF_HASH_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|sel_netif_hash
(braket
id|i
)braket
)paren
suffix:semicolon
id|register_netdevice_notifier
c_func
(paren
op_amp
id|sel_netif_netdev_notifier
)paren
suffix:semicolon
id|err
op_assign
id|avc_add_callback
c_func
(paren
id|sel_netif_avc_callback
comma
id|AVC_CALLBACK_RESET
comma
id|SECSID_NULL
comma
id|SECSID_NULL
comma
id|SECCLASS_NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|panic
c_func
(paren
l_string|&quot;avc_add_callback() failed, error %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|variable|sel_netif_init
id|__initcall
c_func
(paren
id|sel_netif_init
)paren
suffix:semicolon
eof
