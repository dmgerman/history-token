multiline_comment|/* Updated: Karl MacMillan &lt;kmacmillan@tresys.com&gt;&n; *&n; * &t;Added conditional policy language extensions&n; *&n; * Copyright (C) 2003 - 2004 Tresys Technology, LLC&n; *&t;This program is free software; you can redistribute it and/or modify&n; *  &t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation, version 2.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/security.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
multiline_comment|/* selinuxfs pseudo filesystem for exporting the security policy API.&n;   Based on the proc code and the fs/nfsd/nfsctl.c code. */
macro_line|#include &quot;flask.h&quot;
macro_line|#include &quot;avc.h&quot;
macro_line|#include &quot;avc_ss.h&quot;
macro_line|#include &quot;security.h&quot;
macro_line|#include &quot;objsec.h&quot;
macro_line|#include &quot;conditional.h&quot;
r_static
id|DECLARE_MUTEX
c_func
(paren
id|sel_sem
)paren
suffix:semicolon
multiline_comment|/* global data for booleans */
DECL|variable|bool_dir
r_static
r_struct
id|dentry
op_star
id|bool_dir
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|bool_num
r_static
r_int
id|bool_num
op_assign
l_int|0
suffix:semicolon
DECL|variable|bool_pending_values
r_static
r_int
op_star
id|bool_pending_values
op_assign
l_int|NULL
suffix:semicolon
r_extern
r_void
id|selnl_notify_setenforce
c_func
(paren
r_int
id|val
)paren
suffix:semicolon
multiline_comment|/* Check whether a task is allowed to use a security operation. */
DECL|function|task_has_security
r_int
id|task_has_security
c_func
(paren
r_struct
id|task_struct
op_star
id|tsk
comma
id|u32
id|perms
)paren
(brace
r_struct
id|task_security_struct
op_star
id|tsec
suffix:semicolon
id|tsec
op_assign
id|tsk-&gt;security
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tsec
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_return
id|avc_has_perm
c_func
(paren
id|tsec-&gt;sid
comma
id|SECINITSID_SECURITY
comma
id|SECCLASS_SECURITY
comma
id|perms
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|enum|sel_inos
r_enum
id|sel_inos
(brace
DECL|enumerator|SEL_ROOT_INO
id|SEL_ROOT_INO
op_assign
l_int|2
comma
DECL|enumerator|SEL_LOAD
id|SEL_LOAD
comma
multiline_comment|/* load policy */
DECL|enumerator|SEL_ENFORCE
id|SEL_ENFORCE
comma
multiline_comment|/* get or set enforcing status */
DECL|enumerator|SEL_CONTEXT
id|SEL_CONTEXT
comma
multiline_comment|/* validate context */
DECL|enumerator|SEL_ACCESS
id|SEL_ACCESS
comma
multiline_comment|/* compute access decision */
DECL|enumerator|SEL_CREATE
id|SEL_CREATE
comma
multiline_comment|/* compute create labeling decision */
DECL|enumerator|SEL_RELABEL
id|SEL_RELABEL
comma
multiline_comment|/* compute relabeling decision */
DECL|enumerator|SEL_USER
id|SEL_USER
comma
multiline_comment|/* compute reachable user contexts */
DECL|enumerator|SEL_POLICYVERS
id|SEL_POLICYVERS
comma
multiline_comment|/* return policy version for this kernel */
DECL|enumerator|SEL_COMMIT_BOOLS
id|SEL_COMMIT_BOOLS
comma
multiline_comment|/* commit new boolean values */
DECL|enumerator|SEL_MLS
id|SEL_MLS
comma
multiline_comment|/* return if MLS policy is enabled */
DECL|enumerator|SEL_DISABLE
id|SEL_DISABLE
multiline_comment|/* disable SELinux until next reboot */
)brace
suffix:semicolon
DECL|macro|TMPBUFLEN
mdefine_line|#define TMPBUFLEN&t;12
DECL|function|sel_read_enforce
r_static
id|ssize_t
id|sel_read_enforce
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_char
id|tmpbuf
(braket
id|TMPBUFLEN
)braket
suffix:semicolon
id|ssize_t
id|length
suffix:semicolon
id|length
op_assign
id|scnprintf
c_func
(paren
id|tmpbuf
comma
id|TMPBUFLEN
comma
l_string|&quot;%d&quot;
comma
id|selinux_enforcing
)paren
suffix:semicolon
r_return
id|simple_read_from_buffer
c_func
(paren
id|buf
comma
id|count
comma
id|ppos
comma
id|tmpbuf
comma
id|length
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SECURITY_SELINUX_DEVELOP
DECL|function|sel_write_enforce
r_static
id|ssize_t
id|sel_write_enforce
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_char
op_star
id|page
suffix:semicolon
id|ssize_t
id|length
suffix:semicolon
r_int
id|new_value
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
l_int|0
op_logical_or
id|count
op_ge
id|PAGE_SIZE
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_star
id|ppos
op_ne
l_int|0
)paren
(brace
multiline_comment|/* No partial writes. */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|page
op_assign
(paren
r_char
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|length
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|page
comma
id|buf
comma
id|count
)paren
)paren
r_goto
id|out
suffix:semicolon
id|length
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|sscanf
c_func
(paren
id|page
comma
l_string|&quot;%d&quot;
comma
op_amp
id|new_value
)paren
op_ne
l_int|1
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|new_value
op_ne
id|selinux_enforcing
)paren
(brace
id|length
op_assign
id|task_has_security
c_func
(paren
id|current
comma
id|SECURITY__SETENFORCE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
)paren
r_goto
id|out
suffix:semicolon
id|selinux_enforcing
op_assign
id|new_value
suffix:semicolon
r_if
c_cond
(paren
id|selinux_enforcing
)paren
id|avc_ss_reset
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|selnl_notify_setenforce
c_func
(paren
id|selinux_enforcing
)paren
suffix:semicolon
)brace
id|length
op_assign
id|count
suffix:semicolon
id|out
suffix:colon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_return
id|length
suffix:semicolon
)brace
macro_line|#else
DECL|macro|sel_write_enforce
mdefine_line|#define sel_write_enforce NULL
macro_line|#endif
DECL|variable|sel_enforce_ops
r_static
r_struct
id|file_operations
id|sel_enforce_ops
op_assign
(brace
dot
id|read
op_assign
id|sel_read_enforce
comma
dot
id|write
op_assign
id|sel_write_enforce
comma
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_SECURITY_SELINUX_DISABLE
DECL|function|sel_write_disable
r_static
id|ssize_t
id|sel_write_disable
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_char
op_star
id|page
suffix:semicolon
id|ssize_t
id|length
suffix:semicolon
r_int
id|new_value
suffix:semicolon
r_extern
r_int
id|selinux_disable
c_func
(paren
r_void
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
l_int|0
op_logical_or
id|count
op_ge
id|PAGE_SIZE
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_star
id|ppos
op_ne
l_int|0
)paren
(brace
multiline_comment|/* No partial writes. */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|page
op_assign
(paren
r_char
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|length
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|page
comma
id|buf
comma
id|count
)paren
)paren
r_goto
id|out
suffix:semicolon
id|length
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|sscanf
c_func
(paren
id|page
comma
l_string|&quot;%d&quot;
comma
op_amp
id|new_value
)paren
op_ne
l_int|1
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|new_value
)paren
(brace
id|length
op_assign
id|selinux_disable
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
)brace
id|length
op_assign
id|count
suffix:semicolon
id|out
suffix:colon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_return
id|length
suffix:semicolon
)brace
macro_line|#else
DECL|macro|sel_write_disable
mdefine_line|#define sel_write_disable NULL
macro_line|#endif
DECL|variable|sel_disable_ops
r_static
r_struct
id|file_operations
id|sel_disable_ops
op_assign
(brace
dot
id|write
op_assign
id|sel_write_disable
comma
)brace
suffix:semicolon
DECL|function|sel_read_policyvers
r_static
id|ssize_t
id|sel_read_policyvers
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_char
id|tmpbuf
(braket
id|TMPBUFLEN
)braket
suffix:semicolon
id|ssize_t
id|length
suffix:semicolon
id|length
op_assign
id|scnprintf
c_func
(paren
id|tmpbuf
comma
id|TMPBUFLEN
comma
l_string|&quot;%u&quot;
comma
id|POLICYDB_VERSION_MAX
)paren
suffix:semicolon
r_return
id|simple_read_from_buffer
c_func
(paren
id|buf
comma
id|count
comma
id|ppos
comma
id|tmpbuf
comma
id|length
)paren
suffix:semicolon
)brace
DECL|variable|sel_policyvers_ops
r_static
r_struct
id|file_operations
id|sel_policyvers_ops
op_assign
(brace
dot
id|read
op_assign
id|sel_read_policyvers
comma
)brace
suffix:semicolon
multiline_comment|/* declaration for sel_write_load */
r_static
r_int
id|sel_make_bools
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|function|sel_read_mls
r_static
id|ssize_t
id|sel_read_mls
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_char
id|tmpbuf
(braket
id|TMPBUFLEN
)braket
suffix:semicolon
id|ssize_t
id|length
suffix:semicolon
id|length
op_assign
id|scnprintf
c_func
(paren
id|tmpbuf
comma
id|TMPBUFLEN
comma
l_string|&quot;%d&quot;
comma
id|selinux_mls_enabled
)paren
suffix:semicolon
r_return
id|simple_read_from_buffer
c_func
(paren
id|buf
comma
id|count
comma
id|ppos
comma
id|tmpbuf
comma
id|length
)paren
suffix:semicolon
)brace
DECL|variable|sel_mls_ops
r_static
r_struct
id|file_operations
id|sel_mls_ops
op_assign
(brace
dot
id|read
op_assign
id|sel_read_mls
comma
)brace
suffix:semicolon
DECL|function|sel_write_load
r_static
id|ssize_t
id|sel_write_load
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ssize_t
id|length
suffix:semicolon
r_void
op_star
id|data
op_assign
l_int|NULL
suffix:semicolon
id|down
c_func
(paren
op_amp
id|sel_sem
)paren
suffix:semicolon
id|length
op_assign
id|task_has_security
c_func
(paren
id|current
comma
id|SECURITY__LOAD_POLICY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_star
id|ppos
op_ne
l_int|0
)paren
(brace
multiline_comment|/* No partial writes. */
id|length
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|count
OL
l_int|0
)paren
op_logical_or
(paren
id|count
OG
l_int|64
op_star
l_int|1024
op_star
l_int|1024
)paren
op_logical_or
(paren
id|data
op_assign
id|vmalloc
c_func
(paren
id|count
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|length
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|length
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|data
comma
id|buf
comma
id|count
)paren
op_ne
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|length
op_assign
id|security_load_policy
c_func
(paren
id|data
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
)paren
r_goto
id|out
suffix:semicolon
id|ret
op_assign
id|sel_make_bools
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|length
op_assign
id|ret
suffix:semicolon
r_else
id|length
op_assign
id|count
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|sel_sem
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|data
)paren
suffix:semicolon
r_return
id|length
suffix:semicolon
)brace
DECL|variable|sel_load_ops
r_static
r_struct
id|file_operations
id|sel_load_ops
op_assign
(brace
dot
id|write
op_assign
id|sel_write_load
comma
)brace
suffix:semicolon
DECL|function|sel_write_context
r_static
id|ssize_t
id|sel_write_context
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_char
op_star
id|page
suffix:semicolon
id|u32
id|sid
suffix:semicolon
id|ssize_t
id|length
suffix:semicolon
id|length
op_assign
id|task_has_security
c_func
(paren
id|current
comma
id|SECURITY__CHECK_CONTEXT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
)paren
r_return
id|length
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
l_int|0
op_logical_or
id|count
op_ge
id|PAGE_SIZE
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_star
id|ppos
op_ne
l_int|0
)paren
(brace
multiline_comment|/* No partial writes. */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|page
op_assign
(paren
r_char
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|length
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|page
comma
id|buf
comma
id|count
)paren
)paren
r_goto
id|out
suffix:semicolon
id|length
op_assign
id|security_context_to_sid
c_func
(paren
id|page
comma
id|count
comma
op_amp
id|sid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|length
op_assign
id|count
suffix:semicolon
id|out
suffix:colon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_return
id|length
suffix:semicolon
)brace
DECL|variable|sel_context_ops
r_static
r_struct
id|file_operations
id|sel_context_ops
op_assign
(brace
dot
id|write
op_assign
id|sel_write_context
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Remaining nodes use transaction based IO methods like nfsd/nfsctl.c&n; */
r_static
id|ssize_t
id|sel_write_access
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|size
)paren
suffix:semicolon
r_static
id|ssize_t
id|sel_write_create
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|size
)paren
suffix:semicolon
r_static
id|ssize_t
id|sel_write_relabel
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|size
)paren
suffix:semicolon
r_static
id|ssize_t
id|sel_write_user
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|size
)paren
suffix:semicolon
DECL|variable|write_op
r_static
id|ssize_t
(paren
op_star
id|write_op
(braket
)braket
)paren
(paren
r_struct
id|file
op_star
comma
r_char
op_star
comma
r_int
)paren
op_assign
(brace
(braket
id|SEL_ACCESS
)braket
op_assign
id|sel_write_access
comma
(braket
id|SEL_CREATE
)braket
op_assign
id|sel_write_create
comma
(braket
id|SEL_RELABEL
)braket
op_assign
id|sel_write_relabel
comma
(braket
id|SEL_USER
)braket
op_assign
id|sel_write_user
comma
)brace
suffix:semicolon
DECL|function|selinux_transaction_write
r_static
id|ssize_t
id|selinux_transaction_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|size
comma
id|loff_t
op_star
id|pos
)paren
(brace
id|ino_t
id|ino
op_assign
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_ino
suffix:semicolon
r_char
op_star
id|data
suffix:semicolon
id|ssize_t
id|rv
suffix:semicolon
r_if
c_cond
(paren
id|ino
op_ge
r_sizeof
(paren
id|write_op
)paren
op_div
r_sizeof
(paren
id|write_op
(braket
l_int|0
)braket
)paren
op_logical_or
op_logical_neg
id|write_op
(braket
id|ino
)braket
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|data
op_assign
id|simple_transaction_get
c_func
(paren
id|file
comma
id|buf
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|data
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|data
)paren
suffix:semicolon
id|rv
op_assign
id|write_op
(braket
id|ino
)braket
(paren
id|file
comma
id|data
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
OG
l_int|0
)paren
(brace
id|simple_transaction_set
c_func
(paren
id|file
comma
id|rv
)paren
suffix:semicolon
id|rv
op_assign
id|size
suffix:semicolon
)brace
r_return
id|rv
suffix:semicolon
)brace
DECL|variable|transaction_ops
r_static
r_struct
id|file_operations
id|transaction_ops
op_assign
(brace
dot
id|write
op_assign
id|selinux_transaction_write
comma
dot
id|read
op_assign
id|simple_transaction_read
comma
dot
id|release
op_assign
id|simple_transaction_release
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * payload - write methods&n; * If the method has a response, the response should be put in buf,&n; * and the length returned.  Otherwise return 0 or and -error.&n; */
DECL|function|sel_write_access
r_static
id|ssize_t
id|sel_write_access
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|size
)paren
(brace
r_char
op_star
id|scon
comma
op_star
id|tcon
suffix:semicolon
id|u32
id|ssid
comma
id|tsid
suffix:semicolon
id|u16
id|tclass
suffix:semicolon
id|u32
id|req
suffix:semicolon
r_struct
id|av_decision
id|avd
suffix:semicolon
id|ssize_t
id|length
suffix:semicolon
id|length
op_assign
id|task_has_security
c_func
(paren
id|current
comma
id|SECURITY__COMPUTE_AV
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
)paren
r_return
id|length
suffix:semicolon
id|length
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|scon
op_assign
id|kmalloc
c_func
(paren
id|size
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scon
)paren
r_return
id|length
suffix:semicolon
id|memset
c_func
(paren
id|scon
comma
l_int|0
comma
id|size
op_plus
l_int|1
)paren
suffix:semicolon
id|tcon
op_assign
id|kmalloc
c_func
(paren
id|size
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tcon
)paren
r_goto
id|out
suffix:semicolon
id|memset
c_func
(paren
id|tcon
comma
l_int|0
comma
id|size
op_plus
l_int|1
)paren
suffix:semicolon
id|length
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|sscanf
c_func
(paren
id|buf
comma
l_string|&quot;%s %s %hu %x&quot;
comma
id|scon
comma
id|tcon
comma
op_amp
id|tclass
comma
op_amp
id|req
)paren
op_ne
l_int|4
)paren
r_goto
id|out2
suffix:semicolon
id|length
op_assign
id|security_context_to_sid
c_func
(paren
id|scon
comma
id|strlen
c_func
(paren
id|scon
)paren
op_plus
l_int|1
comma
op_amp
id|ssid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OL
l_int|0
)paren
r_goto
id|out2
suffix:semicolon
id|length
op_assign
id|security_context_to_sid
c_func
(paren
id|tcon
comma
id|strlen
c_func
(paren
id|tcon
)paren
op_plus
l_int|1
comma
op_amp
id|tsid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OL
l_int|0
)paren
r_goto
id|out2
suffix:semicolon
id|length
op_assign
id|security_compute_av
c_func
(paren
id|ssid
comma
id|tsid
comma
id|tclass
comma
id|req
comma
op_amp
id|avd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OL
l_int|0
)paren
r_goto
id|out2
suffix:semicolon
id|length
op_assign
id|scnprintf
c_func
(paren
id|buf
comma
id|SIMPLE_TRANSACTION_LIMIT
comma
l_string|&quot;%x %x %x %x %u&quot;
comma
id|avd.allowed
comma
id|avd.decided
comma
id|avd.auditallow
comma
id|avd.auditdeny
comma
id|avd.seqno
)paren
suffix:semicolon
id|out2
suffix:colon
id|kfree
c_func
(paren
id|tcon
)paren
suffix:semicolon
id|out
suffix:colon
id|kfree
c_func
(paren
id|scon
)paren
suffix:semicolon
r_return
id|length
suffix:semicolon
)brace
DECL|function|sel_write_create
r_static
id|ssize_t
id|sel_write_create
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|size
)paren
(brace
r_char
op_star
id|scon
comma
op_star
id|tcon
suffix:semicolon
id|u32
id|ssid
comma
id|tsid
comma
id|newsid
suffix:semicolon
id|u16
id|tclass
suffix:semicolon
id|ssize_t
id|length
suffix:semicolon
r_char
op_star
id|newcon
suffix:semicolon
id|u32
id|len
suffix:semicolon
id|length
op_assign
id|task_has_security
c_func
(paren
id|current
comma
id|SECURITY__COMPUTE_CREATE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
)paren
r_return
id|length
suffix:semicolon
id|length
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|scon
op_assign
id|kmalloc
c_func
(paren
id|size
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scon
)paren
r_return
id|length
suffix:semicolon
id|memset
c_func
(paren
id|scon
comma
l_int|0
comma
id|size
op_plus
l_int|1
)paren
suffix:semicolon
id|tcon
op_assign
id|kmalloc
c_func
(paren
id|size
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tcon
)paren
r_goto
id|out
suffix:semicolon
id|memset
c_func
(paren
id|tcon
comma
l_int|0
comma
id|size
op_plus
l_int|1
)paren
suffix:semicolon
id|length
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|sscanf
c_func
(paren
id|buf
comma
l_string|&quot;%s %s %hu&quot;
comma
id|scon
comma
id|tcon
comma
op_amp
id|tclass
)paren
op_ne
l_int|3
)paren
r_goto
id|out2
suffix:semicolon
id|length
op_assign
id|security_context_to_sid
c_func
(paren
id|scon
comma
id|strlen
c_func
(paren
id|scon
)paren
op_plus
l_int|1
comma
op_amp
id|ssid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OL
l_int|0
)paren
r_goto
id|out2
suffix:semicolon
id|length
op_assign
id|security_context_to_sid
c_func
(paren
id|tcon
comma
id|strlen
c_func
(paren
id|tcon
)paren
op_plus
l_int|1
comma
op_amp
id|tsid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OL
l_int|0
)paren
r_goto
id|out2
suffix:semicolon
id|length
op_assign
id|security_transition_sid
c_func
(paren
id|ssid
comma
id|tsid
comma
id|tclass
comma
op_amp
id|newsid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OL
l_int|0
)paren
r_goto
id|out2
suffix:semicolon
id|length
op_assign
id|security_sid_to_context
c_func
(paren
id|newsid
comma
op_amp
id|newcon
comma
op_amp
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OL
l_int|0
)paren
r_goto
id|out2
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|SIMPLE_TRANSACTION_LIMIT
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s:  context size (%u) exceeds payload &quot;
l_string|&quot;max&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|len
)paren
suffix:semicolon
id|length
op_assign
op_minus
id|ERANGE
suffix:semicolon
r_goto
id|out3
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|buf
comma
id|newcon
comma
id|len
)paren
suffix:semicolon
id|length
op_assign
id|len
suffix:semicolon
id|out3
suffix:colon
id|kfree
c_func
(paren
id|newcon
)paren
suffix:semicolon
id|out2
suffix:colon
id|kfree
c_func
(paren
id|tcon
)paren
suffix:semicolon
id|out
suffix:colon
id|kfree
c_func
(paren
id|scon
)paren
suffix:semicolon
r_return
id|length
suffix:semicolon
)brace
DECL|function|sel_write_relabel
r_static
id|ssize_t
id|sel_write_relabel
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|size
)paren
(brace
r_char
op_star
id|scon
comma
op_star
id|tcon
suffix:semicolon
id|u32
id|ssid
comma
id|tsid
comma
id|newsid
suffix:semicolon
id|u16
id|tclass
suffix:semicolon
id|ssize_t
id|length
suffix:semicolon
r_char
op_star
id|newcon
suffix:semicolon
id|u32
id|len
suffix:semicolon
id|length
op_assign
id|task_has_security
c_func
(paren
id|current
comma
id|SECURITY__COMPUTE_RELABEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
)paren
r_return
id|length
suffix:semicolon
id|length
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|scon
op_assign
id|kmalloc
c_func
(paren
id|size
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scon
)paren
r_return
id|length
suffix:semicolon
id|memset
c_func
(paren
id|scon
comma
l_int|0
comma
id|size
op_plus
l_int|1
)paren
suffix:semicolon
id|tcon
op_assign
id|kmalloc
c_func
(paren
id|size
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tcon
)paren
r_goto
id|out
suffix:semicolon
id|memset
c_func
(paren
id|tcon
comma
l_int|0
comma
id|size
op_plus
l_int|1
)paren
suffix:semicolon
id|length
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|sscanf
c_func
(paren
id|buf
comma
l_string|&quot;%s %s %hu&quot;
comma
id|scon
comma
id|tcon
comma
op_amp
id|tclass
)paren
op_ne
l_int|3
)paren
r_goto
id|out2
suffix:semicolon
id|length
op_assign
id|security_context_to_sid
c_func
(paren
id|scon
comma
id|strlen
c_func
(paren
id|scon
)paren
op_plus
l_int|1
comma
op_amp
id|ssid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OL
l_int|0
)paren
r_goto
id|out2
suffix:semicolon
id|length
op_assign
id|security_context_to_sid
c_func
(paren
id|tcon
comma
id|strlen
c_func
(paren
id|tcon
)paren
op_plus
l_int|1
comma
op_amp
id|tsid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OL
l_int|0
)paren
r_goto
id|out2
suffix:semicolon
id|length
op_assign
id|security_change_sid
c_func
(paren
id|ssid
comma
id|tsid
comma
id|tclass
comma
op_amp
id|newsid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OL
l_int|0
)paren
r_goto
id|out2
suffix:semicolon
id|length
op_assign
id|security_sid_to_context
c_func
(paren
id|newsid
comma
op_amp
id|newcon
comma
op_amp
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OL
l_int|0
)paren
r_goto
id|out2
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|SIMPLE_TRANSACTION_LIMIT
)paren
(brace
id|length
op_assign
op_minus
id|ERANGE
suffix:semicolon
r_goto
id|out3
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|buf
comma
id|newcon
comma
id|len
)paren
suffix:semicolon
id|length
op_assign
id|len
suffix:semicolon
id|out3
suffix:colon
id|kfree
c_func
(paren
id|newcon
)paren
suffix:semicolon
id|out2
suffix:colon
id|kfree
c_func
(paren
id|tcon
)paren
suffix:semicolon
id|out
suffix:colon
id|kfree
c_func
(paren
id|scon
)paren
suffix:semicolon
r_return
id|length
suffix:semicolon
)brace
DECL|function|sel_write_user
r_static
id|ssize_t
id|sel_write_user
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|size
)paren
(brace
r_char
op_star
id|con
comma
op_star
id|user
comma
op_star
id|ptr
suffix:semicolon
id|u32
id|sid
comma
op_star
id|sids
suffix:semicolon
id|ssize_t
id|length
suffix:semicolon
r_char
op_star
id|newcon
suffix:semicolon
r_int
id|i
comma
id|rc
suffix:semicolon
id|u32
id|len
comma
id|nsids
suffix:semicolon
id|length
op_assign
id|task_has_security
c_func
(paren
id|current
comma
id|SECURITY__COMPUTE_USER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
)paren
r_return
id|length
suffix:semicolon
id|length
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|con
op_assign
id|kmalloc
c_func
(paren
id|size
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|con
)paren
r_return
id|length
suffix:semicolon
id|memset
c_func
(paren
id|con
comma
l_int|0
comma
id|size
op_plus
l_int|1
)paren
suffix:semicolon
id|user
op_assign
id|kmalloc
c_func
(paren
id|size
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|user
)paren
r_goto
id|out
suffix:semicolon
id|memset
c_func
(paren
id|user
comma
l_int|0
comma
id|size
op_plus
l_int|1
)paren
suffix:semicolon
id|length
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|sscanf
c_func
(paren
id|buf
comma
l_string|&quot;%s %s&quot;
comma
id|con
comma
id|user
)paren
op_ne
l_int|2
)paren
r_goto
id|out2
suffix:semicolon
id|length
op_assign
id|security_context_to_sid
c_func
(paren
id|con
comma
id|strlen
c_func
(paren
id|con
)paren
op_plus
l_int|1
comma
op_amp
id|sid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OL
l_int|0
)paren
r_goto
id|out2
suffix:semicolon
id|length
op_assign
id|security_get_user_sids
c_func
(paren
id|sid
comma
id|user
comma
op_amp
id|sids
comma
op_amp
id|nsids
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OL
l_int|0
)paren
r_goto
id|out2
suffix:semicolon
id|length
op_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%u&quot;
comma
id|nsids
)paren
op_plus
l_int|1
suffix:semicolon
id|ptr
op_assign
id|buf
op_plus
id|length
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nsids
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rc
op_assign
id|security_sid_to_context
c_func
(paren
id|sids
(braket
id|i
)braket
comma
op_amp
id|newcon
comma
op_amp
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|length
op_assign
id|rc
suffix:semicolon
r_goto
id|out3
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|length
op_plus
id|len
)paren
op_ge
id|SIMPLE_TRANSACTION_LIMIT
)paren
(brace
id|kfree
c_func
(paren
id|newcon
)paren
suffix:semicolon
id|length
op_assign
op_minus
id|ERANGE
suffix:semicolon
r_goto
id|out3
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|ptr
comma
id|newcon
comma
id|len
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|newcon
)paren
suffix:semicolon
id|ptr
op_add_assign
id|len
suffix:semicolon
id|length
op_add_assign
id|len
suffix:semicolon
)brace
id|out3
suffix:colon
id|kfree
c_func
(paren
id|sids
)paren
suffix:semicolon
id|out2
suffix:colon
id|kfree
c_func
(paren
id|user
)paren
suffix:semicolon
id|out
suffix:colon
id|kfree
c_func
(paren
id|con
)paren
suffix:semicolon
r_return
id|length
suffix:semicolon
)brace
DECL|function|sel_make_inode
r_static
r_struct
id|inode
op_star
id|sel_make_inode
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
id|mode
)paren
(brace
r_struct
id|inode
op_star
id|ret
op_assign
id|new_inode
c_func
(paren
id|sb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|ret-&gt;i_mode
op_assign
id|mode
suffix:semicolon
id|ret-&gt;i_uid
op_assign
id|ret-&gt;i_gid
op_assign
l_int|0
suffix:semicolon
id|ret-&gt;i_blksize
op_assign
id|PAGE_CACHE_SIZE
suffix:semicolon
id|ret-&gt;i_blocks
op_assign
l_int|0
suffix:semicolon
id|ret-&gt;i_atime
op_assign
id|ret-&gt;i_mtime
op_assign
id|ret-&gt;i_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|macro|BOOL_INO_OFFSET
mdefine_line|#define BOOL_INO_OFFSET 30
DECL|function|sel_read_bool
r_static
id|ssize_t
id|sel_read_bool
c_func
(paren
r_struct
id|file
op_star
id|filep
comma
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_char
op_star
id|page
op_assign
l_int|NULL
suffix:semicolon
id|ssize_t
id|length
suffix:semicolon
id|ssize_t
id|end
suffix:semicolon
id|ssize_t
id|ret
suffix:semicolon
r_int
id|cur_enforcing
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
id|down
c_func
(paren
op_amp
id|sel_sem
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* check to see if this file has been deleted */
r_if
c_cond
(paren
op_logical_neg
id|filep-&gt;f_op
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|count
template_param
id|PAGE_SIZE
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|page
op_assign
(paren
r_char
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|inode
op_assign
id|filep-&gt;f_dentry-&gt;d_inode
suffix:semicolon
id|cur_enforcing
op_assign
id|security_get_bool_value
c_func
(paren
id|inode-&gt;i_ino
op_minus
id|BOOL_INO_OFFSET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cur_enforcing
OL
l_int|0
)paren
(brace
id|ret
op_assign
id|cur_enforcing
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|length
op_assign
id|scnprintf
c_func
(paren
id|page
comma
id|PAGE_SIZE
comma
l_string|&quot;%d %d&quot;
comma
id|cur_enforcing
comma
id|bool_pending_values
(braket
id|inode-&gt;i_ino
op_minus
id|BOOL_INO_OFFSET
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OL
l_int|0
)paren
(brace
id|ret
op_assign
id|length
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|ppos
op_ge
id|length
)paren
(brace
id|ret
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_plus
op_star
id|ppos
OG
id|length
)paren
id|count
op_assign
id|length
op_minus
op_star
id|ppos
suffix:semicolon
id|end
op_assign
id|count
op_plus
op_star
id|ppos
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buf
comma
(paren
r_char
op_star
)paren
id|page
op_plus
op_star
id|ppos
comma
id|count
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
op_star
id|ppos
op_assign
id|end
suffix:semicolon
id|ret
op_assign
id|count
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|sel_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page
)paren
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sel_write_bool
r_static
id|ssize_t
id|sel_write_bool
c_func
(paren
r_struct
id|file
op_star
id|filep
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_char
op_star
id|page
op_assign
l_int|NULL
suffix:semicolon
id|ssize_t
id|length
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_int
id|new_value
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
id|down
c_func
(paren
op_amp
id|sel_sem
)paren
suffix:semicolon
id|length
op_assign
id|task_has_security
c_func
(paren
id|current
comma
id|SECURITY__SETBOOL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* check to see if this file has been deleted */
r_if
c_cond
(paren
op_logical_neg
id|filep-&gt;f_op
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
l_int|0
op_logical_or
id|count
op_ge
id|PAGE_SIZE
)paren
(brace
id|length
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|ppos
op_ne
l_int|0
)paren
(brace
multiline_comment|/* No partial writes. */
r_goto
id|out
suffix:semicolon
)brace
id|page
op_assign
(paren
r_char
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
(brace
id|length
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|page
comma
id|buf
comma
id|count
)paren
)paren
r_goto
id|out
suffix:semicolon
id|length
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|sscanf
c_func
(paren
id|page
comma
l_string|&quot;%d&quot;
comma
op_amp
id|new_value
)paren
op_ne
l_int|1
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|new_value
)paren
id|new_value
op_assign
l_int|1
suffix:semicolon
id|inode
op_assign
id|filep-&gt;f_dentry-&gt;d_inode
suffix:semicolon
id|bool_pending_values
(braket
id|inode-&gt;i_ino
op_minus
id|BOOL_INO_OFFSET
)braket
op_assign
id|new_value
suffix:semicolon
id|length
op_assign
id|count
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|sel_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page
)paren
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_return
id|length
suffix:semicolon
)brace
DECL|variable|sel_bool_ops
r_static
r_struct
id|file_operations
id|sel_bool_ops
op_assign
(brace
dot
id|read
op_assign
id|sel_read_bool
comma
dot
id|write
op_assign
id|sel_write_bool
comma
)brace
suffix:semicolon
DECL|function|sel_commit_bools_write
r_static
id|ssize_t
id|sel_commit_bools_write
c_func
(paren
r_struct
id|file
op_star
id|filep
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_char
op_star
id|page
op_assign
l_int|NULL
suffix:semicolon
id|ssize_t
id|length
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_int
id|new_value
suffix:semicolon
id|down
c_func
(paren
op_amp
id|sel_sem
)paren
suffix:semicolon
id|length
op_assign
id|task_has_security
c_func
(paren
id|current
comma
id|SECURITY__SETBOOL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* check to see if this file has been deleted */
r_if
c_cond
(paren
op_logical_neg
id|filep-&gt;f_op
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
l_int|0
op_logical_or
id|count
op_ge
id|PAGE_SIZE
)paren
(brace
id|length
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|ppos
op_ne
l_int|0
)paren
(brace
multiline_comment|/* No partial writes. */
r_goto
id|out
suffix:semicolon
)brace
id|page
op_assign
(paren
r_char
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
(brace
id|length
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|page
comma
id|buf
comma
id|count
)paren
)paren
r_goto
id|out
suffix:semicolon
id|length
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|sscanf
c_func
(paren
id|page
comma
l_string|&quot;%d&quot;
comma
op_amp
id|new_value
)paren
op_ne
l_int|1
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|new_value
)paren
(brace
id|security_set_bools
c_func
(paren
id|bool_num
comma
id|bool_pending_values
)paren
suffix:semicolon
)brace
id|length
op_assign
id|count
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|sel_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page
)paren
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_return
id|length
suffix:semicolon
)brace
DECL|variable|sel_commit_bools_ops
r_static
r_struct
id|file_operations
id|sel_commit_bools_ops
op_assign
(brace
dot
id|write
op_assign
id|sel_commit_bools_write
comma
)brace
suffix:semicolon
multiline_comment|/* delete booleans - partial revoke() from&n; * fs/proc/generic.c proc_kill_inodes */
DECL|function|sel_remove_bools
r_static
r_void
id|sel_remove_bools
c_func
(paren
r_struct
id|dentry
op_star
id|de
)paren
(brace
r_struct
id|list_head
op_star
id|p
comma
op_star
id|node
suffix:semicolon
r_struct
id|super_block
op_star
id|sb
op_assign
id|de-&gt;d_sb
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dcache_lock
)paren
suffix:semicolon
id|node
op_assign
id|de-&gt;d_subdirs.next
suffix:semicolon
r_while
c_loop
(paren
id|node
op_ne
op_amp
id|de-&gt;d_subdirs
)paren
(brace
r_struct
id|dentry
op_star
id|d
op_assign
id|list_entry
c_func
(paren
id|node
comma
r_struct
id|dentry
comma
id|d_child
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;d_inode
)paren
(brace
id|d
op_assign
id|dget_locked
c_func
(paren
id|d
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|dcache_lock
)paren
suffix:semicolon
id|d_delete
c_func
(paren
id|d
)paren
suffix:semicolon
id|simple_unlink
c_func
(paren
id|de-&gt;d_inode
comma
id|d
)paren
suffix:semicolon
id|dput
c_func
(paren
id|d
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dcache_lock
)paren
suffix:semicolon
)brace
id|node
op_assign
id|de-&gt;d_subdirs.next
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|dcache_lock
)paren
suffix:semicolon
id|file_list_lock
c_func
(paren
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|sb-&gt;s_files
)paren
(brace
r_struct
id|file
op_star
id|filp
op_assign
id|list_entry
c_func
(paren
id|p
comma
r_struct
id|file
comma
id|f_list
)paren
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
op_assign
id|filp-&gt;f_dentry
suffix:semicolon
r_if
c_cond
(paren
id|dentry-&gt;d_parent
op_ne
id|de
)paren
(brace
r_continue
suffix:semicolon
)brace
id|filp-&gt;f_op
op_assign
l_int|NULL
suffix:semicolon
)brace
id|file_list_unlock
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|macro|BOOL_DIR_NAME
mdefine_line|#define BOOL_DIR_NAME &quot;booleans&quot;
DECL|function|sel_make_bools
r_static
r_int
id|sel_make_bools
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|ret
op_assign
l_int|0
suffix:semicolon
id|ssize_t
id|len
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|dentry
op_star
id|dir
op_assign
id|bool_dir
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|inode_security_struct
op_star
id|isec
suffix:semicolon
r_char
op_star
op_star
id|names
op_assign
l_int|NULL
comma
op_star
id|page
suffix:semicolon
r_int
id|num
suffix:semicolon
r_int
op_star
id|values
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|sid
suffix:semicolon
multiline_comment|/* remove any existing files */
r_if
c_cond
(paren
id|bool_pending_values
)paren
id|kfree
c_func
(paren
id|bool_pending_values
)paren
suffix:semicolon
id|sel_remove_bools
c_func
(paren
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|page
op_assign
(paren
r_char
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|ret
op_assign
id|security_get_bools
c_func
(paren
op_amp
id|num
comma
op_amp
id|names
comma
op_amp
id|values
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
r_goto
id|out
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dentry
op_assign
id|d_alloc_name
c_func
(paren
id|dir
comma
id|names
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dentry
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|inode
op_assign
id|sel_make_inode
c_func
(paren
id|dir-&gt;d_sb
comma
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|len
op_assign
id|snprintf
c_func
(paren
id|page
comma
id|PAGE_SIZE
comma
l_string|&quot;/%s/%s&quot;
comma
id|BOOL_DIR_NAME
comma
id|names
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|len
op_ge
id|PAGE_SIZE
)paren
(brace
id|ret
op_assign
op_minus
id|ENAMETOOLONG
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|isec
op_assign
(paren
r_struct
id|inode_security_struct
op_star
)paren
id|inode-&gt;i_security
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|security_genfs_sid
c_func
(paren
l_string|&quot;selinuxfs&quot;
comma
id|page
comma
id|SECCLASS_FILE
comma
op_amp
id|sid
)paren
)paren
)paren
r_goto
id|err
suffix:semicolon
id|isec-&gt;sid
op_assign
id|sid
suffix:semicolon
id|isec-&gt;initialized
op_assign
l_int|1
suffix:semicolon
id|inode-&gt;i_fop
op_assign
op_amp
id|sel_bool_ops
suffix:semicolon
id|inode-&gt;i_ino
op_assign
id|i
op_plus
id|BOOL_INO_OFFSET
suffix:semicolon
id|d_add
c_func
(paren
id|dentry
comma
id|inode
)paren
suffix:semicolon
)brace
id|bool_num
op_assign
id|num
suffix:semicolon
id|bool_pending_values
op_assign
id|values
suffix:semicolon
id|out
suffix:colon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|names
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|names
(braket
id|i
)braket
)paren
id|kfree
c_func
(paren
id|names
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|names
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
id|err
suffix:colon
id|d_genocide
c_func
(paren
id|dir
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
DECL|macro|NULL_FILE_NAME
mdefine_line|#define NULL_FILE_NAME &quot;null&quot;
DECL|variable|selinux_null
r_struct
id|dentry
op_star
id|selinux_null
op_assign
l_int|NULL
suffix:semicolon
DECL|function|sel_fill_super
r_static
r_int
id|sel_fill_super
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_void
op_star
id|data
comma
r_int
id|silent
)paren
(brace
r_int
id|ret
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|inode_security_struct
op_star
id|isec
suffix:semicolon
r_static
r_struct
id|tree_descr
id|selinux_files
(braket
)braket
op_assign
(brace
(braket
id|SEL_LOAD
)braket
op_assign
(brace
l_string|&quot;load&quot;
comma
op_amp
id|sel_load_ops
comma
id|S_IRUSR
op_or
id|S_IWUSR
)brace
comma
(braket
id|SEL_ENFORCE
)braket
op_assign
(brace
l_string|&quot;enforce&quot;
comma
op_amp
id|sel_enforce_ops
comma
id|S_IRUGO
op_or
id|S_IWUSR
)brace
comma
(braket
id|SEL_CONTEXT
)braket
op_assign
(brace
l_string|&quot;context&quot;
comma
op_amp
id|sel_context_ops
comma
id|S_IRUGO
op_or
id|S_IWUGO
)brace
comma
(braket
id|SEL_ACCESS
)braket
op_assign
(brace
l_string|&quot;access&quot;
comma
op_amp
id|transaction_ops
comma
id|S_IRUGO
op_or
id|S_IWUGO
)brace
comma
(braket
id|SEL_CREATE
)braket
op_assign
(brace
l_string|&quot;create&quot;
comma
op_amp
id|transaction_ops
comma
id|S_IRUGO
op_or
id|S_IWUGO
)brace
comma
(braket
id|SEL_RELABEL
)braket
op_assign
(brace
l_string|&quot;relabel&quot;
comma
op_amp
id|transaction_ops
comma
id|S_IRUGO
op_or
id|S_IWUGO
)brace
comma
(braket
id|SEL_USER
)braket
op_assign
(brace
l_string|&quot;user&quot;
comma
op_amp
id|transaction_ops
comma
id|S_IRUGO
op_or
id|S_IWUGO
)brace
comma
(braket
id|SEL_POLICYVERS
)braket
op_assign
(brace
l_string|&quot;policyvers&quot;
comma
op_amp
id|sel_policyvers_ops
comma
id|S_IRUGO
)brace
comma
(braket
id|SEL_COMMIT_BOOLS
)braket
op_assign
(brace
l_string|&quot;commit_pending_bools&quot;
comma
op_amp
id|sel_commit_bools_ops
comma
id|S_IWUSR
)brace
comma
(braket
id|SEL_MLS
)braket
op_assign
(brace
l_string|&quot;mls&quot;
comma
op_amp
id|sel_mls_ops
comma
id|S_IRUGO
)brace
comma
(braket
id|SEL_DISABLE
)braket
op_assign
(brace
l_string|&quot;disable&quot;
comma
op_amp
id|sel_disable_ops
comma
id|S_IWUSR
)brace
comma
multiline_comment|/* last one */
(brace
l_string|&quot;&quot;
)brace
)brace
suffix:semicolon
id|ret
op_assign
id|simple_fill_super
c_func
(paren
id|sb
comma
id|SELINUX_MAGIC
comma
id|selinux_files
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
id|dentry
op_assign
id|d_alloc_name
c_func
(paren
id|sb-&gt;s_root
comma
id|BOOL_DIR_NAME
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dentry
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|inode
op_assign
id|sel_make_inode
c_func
(paren
id|sb
comma
id|S_IFDIR
op_or
id|S_IRUGO
op_or
id|S_IXUGO
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
r_goto
id|out
suffix:semicolon
id|inode-&gt;i_op
op_assign
op_amp
id|simple_dir_inode_operations
suffix:semicolon
id|inode-&gt;i_fop
op_assign
op_amp
id|simple_dir_operations
suffix:semicolon
id|d_add
c_func
(paren
id|dentry
comma
id|inode
)paren
suffix:semicolon
id|bool_dir
op_assign
id|dentry
suffix:semicolon
id|ret
op_assign
id|sel_make_bools
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|out
suffix:semicolon
id|dentry
op_assign
id|d_alloc_name
c_func
(paren
id|sb-&gt;s_root
comma
id|NULL_FILE_NAME
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dentry
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|inode
op_assign
id|sel_make_inode
c_func
(paren
id|sb
comma
id|S_IFCHR
op_or
id|S_IRUGO
op_or
id|S_IWUGO
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
r_goto
id|out
suffix:semicolon
id|isec
op_assign
(paren
r_struct
id|inode_security_struct
op_star
)paren
id|inode-&gt;i_security
suffix:semicolon
id|isec-&gt;sid
op_assign
id|SECINITSID_DEVNULL
suffix:semicolon
id|isec-&gt;sclass
op_assign
id|SECCLASS_CHR_FILE
suffix:semicolon
id|isec-&gt;initialized
op_assign
l_int|1
suffix:semicolon
id|init_special_inode
c_func
(paren
id|inode
comma
id|S_IFCHR
op_or
id|S_IRUGO
op_or
id|S_IWUGO
comma
id|MKDEV
c_func
(paren
id|MEM_MAJOR
comma
l_int|3
)paren
)paren
suffix:semicolon
id|d_add
c_func
(paren
id|dentry
comma
id|inode
)paren
suffix:semicolon
id|selinux_null
op_assign
id|dentry
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out
suffix:colon
id|dput
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s:  failed while creating inodes&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
DECL|function|sel_get_sb
r_static
r_struct
id|super_block
op_star
id|sel_get_sb
c_func
(paren
r_struct
id|file_system_type
op_star
id|fs_type
comma
r_int
id|flags
comma
r_const
r_char
op_star
id|dev_name
comma
r_void
op_star
id|data
)paren
(brace
r_return
id|get_sb_single
c_func
(paren
id|fs_type
comma
id|flags
comma
id|data
comma
id|sel_fill_super
)paren
suffix:semicolon
)brace
DECL|variable|sel_fs_type
r_static
r_struct
id|file_system_type
id|sel_fs_type
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;selinuxfs&quot;
comma
dot
id|get_sb
op_assign
id|sel_get_sb
comma
dot
id|kill_sb
op_assign
id|kill_litter_super
comma
)brace
suffix:semicolon
DECL|variable|selinuxfs_mount
r_struct
id|vfsmount
op_star
id|selinuxfs_mount
suffix:semicolon
DECL|function|init_sel_fs
r_static
r_int
id|__init
id|init_sel_fs
c_func
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|selinux_enabled
)paren
r_return
l_int|0
suffix:semicolon
id|err
op_assign
id|register_filesystem
c_func
(paren
op_amp
id|sel_fs_type
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|selinuxfs_mount
op_assign
id|kern_mount
c_func
(paren
op_amp
id|sel_fs_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|selinuxfs_mount
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;selinuxfs:  could not mount!&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
id|PTR_ERR
c_func
(paren
id|selinuxfs_mount
)paren
suffix:semicolon
id|selinuxfs_mount
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_return
id|err
suffix:semicolon
)brace
DECL|variable|init_sel_fs
id|__initcall
c_func
(paren
id|init_sel_fs
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SECURITY_SELINUX_DISABLE
DECL|function|exit_sel_fs
r_void
id|exit_sel_fs
c_func
(paren
r_void
)paren
(brace
id|unregister_filesystem
c_func
(paren
op_amp
id|sel_fs_type
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
