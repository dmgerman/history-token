multiline_comment|/*&n; * Implementation of the kernel access vector cache (AVC).&n; *&n; * Authors:  Stephen Smalley, &lt;sds@epoch.ncsc.mil&gt;&n; *           James Morris &lt;jmorris@redhat.com&gt;&n; *&n; * Copyright (C) 2003 Red Hat, Inc., James Morris &lt;jmorris@redhat.com&gt;&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License version 2,&n; *      as published by the Free Software Foundation.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/dcache.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;linux/un.h&gt;
macro_line|#include &lt;net/af_unix.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;linux/audit.h&gt;
macro_line|#include &lt;linux/ipv6.h&gt;
macro_line|#include &lt;net/ipv6.h&gt;
macro_line|#include &quot;avc.h&quot;
macro_line|#include &quot;avc_ss.h&quot;
macro_line|#ifdef CONFIG_AUDIT
macro_line|#include &quot;class_to_string.h&quot;
macro_line|#endif
macro_line|#include &quot;common_perm_to_string.h&quot;
macro_line|#include &quot;av_inherit.h&quot;
macro_line|#include &quot;av_perm_to_string.h&quot;
macro_line|#include &quot;objsec.h&quot;
DECL|macro|AVC_CACHE_SLOTS
mdefine_line|#define AVC_CACHE_SLOTS&t;&t;512
DECL|macro|AVC_CACHE_MAXNODES
mdefine_line|#define AVC_CACHE_MAXNODES&t;410
DECL|struct|avc_entry
r_struct
id|avc_entry
(brace
DECL|member|ssid
id|u32
id|ssid
suffix:semicolon
DECL|member|tsid
id|u32
id|tsid
suffix:semicolon
DECL|member|tclass
id|u16
id|tclass
suffix:semicolon
DECL|member|avd
r_struct
id|av_decision
id|avd
suffix:semicolon
DECL|member|used
r_int
id|used
suffix:semicolon
multiline_comment|/* used recently */
)brace
suffix:semicolon
DECL|struct|avc_node
r_struct
id|avc_node
(brace
DECL|member|ae
r_struct
id|avc_entry
id|ae
suffix:semicolon
DECL|member|next
r_struct
id|avc_node
op_star
id|next
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|avc_cache
r_struct
id|avc_cache
(brace
DECL|member|slots
r_struct
id|avc_node
op_star
id|slots
(braket
id|AVC_CACHE_SLOTS
)braket
suffix:semicolon
DECL|member|lru_hint
id|u32
id|lru_hint
suffix:semicolon
multiline_comment|/* LRU hint for reclaim scan */
DECL|member|active_nodes
id|u32
id|active_nodes
suffix:semicolon
DECL|member|latest_notif
id|u32
id|latest_notif
suffix:semicolon
multiline_comment|/* latest revocation notification */
)brace
suffix:semicolon
DECL|struct|avc_callback_node
r_struct
id|avc_callback_node
(brace
DECL|member|callback
r_int
(paren
op_star
id|callback
)paren
(paren
id|u32
id|event
comma
id|u32
id|ssid
comma
id|u32
id|tsid
comma
id|u16
id|tclass
comma
id|u32
id|perms
comma
id|u32
op_star
id|out_retained
)paren
suffix:semicolon
DECL|member|events
id|u32
id|events
suffix:semicolon
DECL|member|ssid
id|u32
id|ssid
suffix:semicolon
DECL|member|tsid
id|u32
id|tsid
suffix:semicolon
DECL|member|tclass
id|u16
id|tclass
suffix:semicolon
DECL|member|perms
id|u32
id|perms
suffix:semicolon
DECL|member|next
r_struct
id|avc_callback_node
op_star
id|next
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|avc_lock
r_static
id|spinlock_t
id|avc_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|avc_node_freelist
r_static
r_struct
id|avc_node
op_star
id|avc_node_freelist
suffix:semicolon
DECL|variable|avc_cache
r_static
r_struct
id|avc_cache
id|avc_cache
suffix:semicolon
DECL|variable|avc_cache_stats
r_static
r_int
id|avc_cache_stats
(braket
id|AVC_NSTATS
)braket
suffix:semicolon
DECL|variable|avc_callbacks
r_static
r_struct
id|avc_callback_node
op_star
id|avc_callbacks
suffix:semicolon
DECL|function|avc_hash
r_static
r_inline
r_int
id|avc_hash
c_func
(paren
id|u32
id|ssid
comma
id|u32
id|tsid
comma
id|u16
id|tclass
)paren
(brace
r_return
(paren
id|ssid
op_xor
(paren
id|tsid
op_lshift
l_int|2
)paren
op_xor
(paren
id|tclass
op_lshift
l_int|4
)paren
)paren
op_amp
(paren
id|AVC_CACHE_SLOTS
op_minus
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#ifdef AVC_CACHE_STATS
DECL|function|avc_cache_stats_incr
r_static
r_inline
r_void
id|avc_cache_stats_incr
c_func
(paren
r_int
id|type
)paren
(brace
id|avc_cache_stats
(braket
id|type
)braket
op_increment
suffix:semicolon
)brace
DECL|function|avc_cache_stats_add
r_static
r_inline
r_void
id|avc_cache_stats_add
c_func
(paren
r_int
id|type
comma
r_int
id|val
)paren
(brace
id|avc_cache_stats
(braket
id|type
)braket
op_add_assign
id|val
suffix:semicolon
)brace
macro_line|#else
DECL|function|avc_cache_stats_incr
r_static
r_inline
r_void
id|avc_cache_stats_incr
c_func
(paren
r_int
id|type
)paren
(brace
)brace
DECL|function|avc_cache_stats_add
r_static
r_inline
r_void
id|avc_cache_stats_add
c_func
(paren
r_int
id|type
comma
r_int
id|val
)paren
(brace
)brace
macro_line|#endif
multiline_comment|/**&n; * avc_dump_av - Display an access vector in human-readable form.&n; * @tclass: target security class&n; * @av: access vector&n; */
DECL|function|avc_dump_av
r_void
id|avc_dump_av
c_func
(paren
r_struct
id|audit_buffer
op_star
id|ab
comma
id|u16
id|tclass
comma
id|u32
id|av
)paren
(brace
r_char
op_star
op_star
id|common_pts
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|common_base
op_assign
l_int|0
suffix:semicolon
r_int
id|i
comma
id|i2
comma
id|perm
suffix:semicolon
r_if
c_cond
(paren
id|av
op_eq
l_int|0
)paren
(brace
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot; null&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|av_inherit
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|av_inherit
(braket
id|i
)braket
dot
id|tclass
op_eq
id|tclass
)paren
(brace
id|common_pts
op_assign
id|av_inherit
(braket
id|i
)braket
dot
id|common_pts
suffix:semicolon
id|common_base
op_assign
id|av_inherit
(braket
id|i
)braket
dot
id|common_base
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot; {&quot;
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
id|perm
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|perm
OL
id|common_base
)paren
(brace
r_if
c_cond
(paren
id|perm
op_amp
id|av
)paren
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot; %s&quot;
comma
id|common_pts
(braket
id|i
)braket
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
id|perm
op_lshift_assign
l_int|1
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
OL
r_sizeof
(paren
id|av
)paren
op_star
l_int|8
)paren
(brace
r_if
c_cond
(paren
id|perm
op_amp
id|av
)paren
(brace
r_for
c_loop
(paren
id|i2
op_assign
l_int|0
suffix:semicolon
id|i2
OL
id|ARRAY_SIZE
c_func
(paren
id|av_perm_to_string
)paren
suffix:semicolon
id|i2
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|av_perm_to_string
(braket
id|i2
)braket
dot
id|tclass
op_eq
id|tclass
)paren
op_logical_and
(paren
id|av_perm_to_string
(braket
id|i2
)braket
dot
id|value
op_eq
id|perm
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i2
OL
id|ARRAY_SIZE
c_func
(paren
id|av_perm_to_string
)paren
)paren
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot; %s&quot;
comma
id|av_perm_to_string
(braket
id|i2
)braket
dot
id|name
)paren
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
id|perm
op_lshift_assign
l_int|1
suffix:semicolon
)brace
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot; }&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * avc_dump_query - Display a SID pair and a class in human-readable form.&n; * @ssid: source security identifier&n; * @tsid: target security identifier&n; * @tclass: target security class&n; */
DECL|function|avc_dump_query
r_void
id|avc_dump_query
c_func
(paren
r_struct
id|audit_buffer
op_star
id|ab
comma
id|u32
id|ssid
comma
id|u32
id|tsid
comma
id|u16
id|tclass
)paren
(brace
r_int
id|rc
suffix:semicolon
r_char
op_star
id|scontext
suffix:semicolon
id|u32
id|scontext_len
suffix:semicolon
id|rc
op_assign
id|security_sid_to_context
c_func
(paren
id|ssid
comma
op_amp
id|scontext
comma
op_amp
id|scontext_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot;ssid=%d&quot;
comma
id|ssid
)paren
suffix:semicolon
r_else
(brace
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot;scontext=%s&quot;
comma
id|scontext
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|scontext
)paren
suffix:semicolon
)brace
id|rc
op_assign
id|security_sid_to_context
c_func
(paren
id|tsid
comma
op_amp
id|scontext
comma
op_amp
id|scontext_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot; tsid=%d&quot;
comma
id|tsid
)paren
suffix:semicolon
r_else
(brace
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot; tcontext=%s&quot;
comma
id|scontext
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|scontext
)paren
suffix:semicolon
)brace
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot; tclass=%s&quot;
comma
id|class_to_string
(braket
id|tclass
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * avc_init - Initialize the AVC.&n; *&n; * Initialize the access vector cache.&n; */
DECL|function|avc_init
r_void
id|__init
id|avc_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|avc_node
op_star
r_new
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|AVC_CACHE_MAXNODES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_new
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
r_new
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
r_new
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;avc:  only able to allocate &quot;
l_string|&quot;%d entries&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|memset
c_func
(paren
r_new
comma
l_int|0
comma
r_sizeof
(paren
op_star
r_new
)paren
)paren
suffix:semicolon
r_new
op_member_access_from_pointer
id|next
op_assign
id|avc_node_freelist
suffix:semicolon
id|avc_node_freelist
op_assign
r_new
suffix:semicolon
)brace
id|audit_log
c_func
(paren
id|current-&gt;audit_context
comma
l_string|&quot;AVC INITIALIZED&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_static
r_void
id|avc_hash_eval
c_func
(paren
r_char
op_star
id|tag
)paren
(brace
r_int
id|i
comma
id|chain_len
comma
id|max_chain_len
comma
id|slots_used
suffix:semicolon
r_struct
id|avc_node
op_star
id|node
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|avc_lock
comma
id|flags
)paren
suffix:semicolon
id|slots_used
op_assign
l_int|0
suffix:semicolon
id|max_chain_len
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|AVC_CACHE_SLOTS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|node
op_assign
id|avc_cache.slots
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|node
)paren
(brace
id|slots_used
op_increment
suffix:semicolon
id|chain_len
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|node
)paren
(brace
id|chain_len
op_increment
suffix:semicolon
id|node
op_assign
id|node-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chain_len
OG
id|max_chain_len
)paren
id|max_chain_len
op_assign
id|chain_len
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|avc_lock
comma
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s avc:  %d entries and %d/%d buckets used, longest &quot;
l_string|&quot;chain length %d&bslash;n&quot;
comma
id|tag
comma
id|avc_cache.active_nodes
comma
id|slots_used
comma
id|AVC_CACHE_SLOTS
comma
id|max_chain_len
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|function|avc_hash_eval
r_static
r_inline
r_void
id|avc_hash_eval
c_func
(paren
r_char
op_star
id|tag
)paren
(brace
)brace
macro_line|#endif
DECL|function|avc_reclaim_node
r_static
r_inline
r_struct
id|avc_node
op_star
id|avc_reclaim_node
c_func
(paren
r_void
)paren
(brace
r_struct
id|avc_node
op_star
id|prev
comma
op_star
id|cur
suffix:semicolon
r_int
id|hvalue
comma
r_try
suffix:semicolon
id|hvalue
op_assign
id|avc_cache.lru_hint
suffix:semicolon
r_for
c_loop
(paren
r_try
op_assign
l_int|0
suffix:semicolon
r_try
OL
l_int|2
suffix:semicolon
r_try
op_increment
)paren
(brace
r_do
(brace
id|prev
op_assign
l_int|NULL
suffix:semicolon
id|cur
op_assign
id|avc_cache.slots
(braket
id|hvalue
)braket
suffix:semicolon
r_while
c_loop
(paren
id|cur
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|cur-&gt;ae.used
)paren
r_goto
id|found
suffix:semicolon
id|cur-&gt;ae.used
op_assign
l_int|0
suffix:semicolon
id|prev
op_assign
id|cur
suffix:semicolon
id|cur
op_assign
id|cur-&gt;next
suffix:semicolon
)brace
id|hvalue
op_assign
(paren
id|hvalue
op_plus
l_int|1
)paren
op_amp
(paren
id|AVC_CACHE_SLOTS
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|hvalue
op_ne
id|avc_cache.lru_hint
)paren
suffix:semicolon
)brace
id|panic
c_func
(paren
l_string|&quot;avc_reclaim_node&quot;
)paren
suffix:semicolon
id|found
suffix:colon
id|avc_cache.lru_hint
op_assign
id|hvalue
suffix:semicolon
r_if
c_cond
(paren
id|prev
op_eq
l_int|NULL
)paren
id|avc_cache.slots
(braket
id|hvalue
)braket
op_assign
id|cur-&gt;next
suffix:semicolon
r_else
id|prev-&gt;next
op_assign
id|cur-&gt;next
suffix:semicolon
r_return
id|cur
suffix:semicolon
)brace
DECL|function|avc_claim_node
r_static
r_inline
r_struct
id|avc_node
op_star
id|avc_claim_node
c_func
(paren
id|u32
id|ssid
comma
id|u32
id|tsid
comma
id|u16
id|tclass
)paren
(brace
r_struct
id|avc_node
op_star
r_new
suffix:semicolon
r_int
id|hvalue
suffix:semicolon
id|hvalue
op_assign
id|avc_hash
c_func
(paren
id|ssid
comma
id|tsid
comma
id|tclass
)paren
suffix:semicolon
r_if
c_cond
(paren
id|avc_node_freelist
)paren
(brace
r_new
op_assign
id|avc_node_freelist
suffix:semicolon
id|avc_node_freelist
op_assign
id|avc_node_freelist-&gt;next
suffix:semicolon
id|avc_cache.active_nodes
op_increment
suffix:semicolon
)brace
r_else
(brace
r_new
op_assign
id|avc_reclaim_node
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
r_new
)paren
r_goto
id|out
suffix:semicolon
)brace
r_new
op_member_access_from_pointer
id|ae.used
op_assign
l_int|1
suffix:semicolon
r_new
op_member_access_from_pointer
id|ae.ssid
op_assign
id|ssid
suffix:semicolon
r_new
op_member_access_from_pointer
id|ae.tsid
op_assign
id|tsid
suffix:semicolon
r_new
op_member_access_from_pointer
id|ae.tclass
op_assign
id|tclass
suffix:semicolon
r_new
op_member_access_from_pointer
id|next
op_assign
id|avc_cache.slots
(braket
id|hvalue
)braket
suffix:semicolon
id|avc_cache.slots
(braket
id|hvalue
)braket
op_assign
r_new
suffix:semicolon
id|out
suffix:colon
r_return
r_new
suffix:semicolon
)brace
DECL|function|avc_search_node
r_static
r_inline
r_struct
id|avc_node
op_star
id|avc_search_node
c_func
(paren
id|u32
id|ssid
comma
id|u32
id|tsid
comma
id|u16
id|tclass
comma
r_int
op_star
id|probes
)paren
(brace
r_struct
id|avc_node
op_star
id|cur
suffix:semicolon
r_int
id|hvalue
suffix:semicolon
r_int
id|tprobes
op_assign
l_int|1
suffix:semicolon
id|hvalue
op_assign
id|avc_hash
c_func
(paren
id|ssid
comma
id|tsid
comma
id|tclass
)paren
suffix:semicolon
id|cur
op_assign
id|avc_cache.slots
(braket
id|hvalue
)braket
suffix:semicolon
r_while
c_loop
(paren
id|cur
op_ne
l_int|NULL
op_logical_and
(paren
id|ssid
op_ne
id|cur-&gt;ae.ssid
op_logical_or
id|tclass
op_ne
id|cur-&gt;ae.tclass
op_logical_or
id|tsid
op_ne
id|cur-&gt;ae.tsid
)paren
)paren
(brace
id|tprobes
op_increment
suffix:semicolon
id|cur
op_assign
id|cur-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cur
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* cache miss */
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* cache hit */
r_if
c_cond
(paren
id|probes
)paren
op_star
id|probes
op_assign
id|tprobes
suffix:semicolon
id|cur-&gt;ae.used
op_assign
l_int|1
suffix:semicolon
id|out
suffix:colon
r_return
id|cur
suffix:semicolon
)brace
multiline_comment|/**&n; * avc_lookup - Look up an AVC entry.&n; * @ssid: source security identifier&n; * @tsid: target security identifier&n; * @tclass: target security class&n; * @requested: requested permissions, interpreted based on @tclass&n; * @aeref:  AVC entry reference&n; *&n; * Look up an AVC entry that is valid for the&n; * @requested permissions between the SID pair&n; * (@ssid, @tsid), interpreting the permissions&n; * based on @tclass.  If a valid AVC entry exists,&n; * then this function updates @aeref to refer to the&n; * entry and returns %0. Otherwise, this function&n; * returns -%ENOENT.&n; */
DECL|function|avc_lookup
r_int
id|avc_lookup
c_func
(paren
id|u32
id|ssid
comma
id|u32
id|tsid
comma
id|u16
id|tclass
comma
id|u32
id|requested
comma
r_struct
id|avc_entry_ref
op_star
id|aeref
)paren
(brace
r_struct
id|avc_node
op_star
id|node
suffix:semicolon
r_int
id|probes
comma
id|rc
op_assign
l_int|0
suffix:semicolon
id|avc_cache_stats_incr
c_func
(paren
id|AVC_CAV_LOOKUPS
)paren
suffix:semicolon
id|node
op_assign
id|avc_search_node
c_func
(paren
id|ssid
comma
id|tsid
comma
id|tclass
comma
op_amp
id|probes
)paren
suffix:semicolon
r_if
c_cond
(paren
id|node
op_logical_and
(paren
(paren
id|node-&gt;ae.avd.decided
op_amp
id|requested
)paren
op_eq
id|requested
)paren
)paren
(brace
id|avc_cache_stats_incr
c_func
(paren
id|AVC_CAV_HITS
)paren
suffix:semicolon
id|avc_cache_stats_add
c_func
(paren
id|AVC_CAV_PROBES
comma
id|probes
)paren
suffix:semicolon
id|aeref-&gt;ae
op_assign
op_amp
id|node-&gt;ae
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|avc_cache_stats_incr
c_func
(paren
id|AVC_CAV_MISSES
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOENT
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * avc_insert - Insert an AVC entry.&n; * @ssid: source security identifier&n; * @tsid: target security identifier&n; * @tclass: target security class&n; * @ae: AVC entry&n; * @aeref:  AVC entry reference&n; *&n; * Insert an AVC entry for the SID pair&n; * (@ssid, @tsid) and class @tclass.&n; * The access vectors and the sequence number are&n; * normally provided by the security server in&n; * response to a security_compute_av() call.  If the&n; * sequence number @ae-&gt;avd.seqno is not less than the latest&n; * revocation notification, then the function copies&n; * the access vectors into a cache entry, updates&n; * @aeref to refer to the entry, and returns %0.&n; * Otherwise, this function returns -%EAGAIN.&n; */
DECL|function|avc_insert
r_int
id|avc_insert
c_func
(paren
id|u32
id|ssid
comma
id|u32
id|tsid
comma
id|u16
id|tclass
comma
r_struct
id|avc_entry
op_star
id|ae
comma
r_struct
id|avc_entry_ref
op_star
id|aeref
)paren
(brace
r_struct
id|avc_node
op_star
id|node
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ae-&gt;avd.seqno
OL
id|avc_cache.latest_notif
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;avc:  seqno %d &lt; latest_notif %d&bslash;n&quot;
comma
id|ae-&gt;avd.seqno
comma
id|avc_cache.latest_notif
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|node
op_assign
id|avc_claim_node
c_func
(paren
id|ssid
comma
id|tsid
comma
id|tclass
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|node-&gt;ae.avd.allowed
op_assign
id|ae-&gt;avd.allowed
suffix:semicolon
id|node-&gt;ae.avd.decided
op_assign
id|ae-&gt;avd.decided
suffix:semicolon
id|node-&gt;ae.avd.auditallow
op_assign
id|ae-&gt;avd.auditallow
suffix:semicolon
id|node-&gt;ae.avd.auditdeny
op_assign
id|ae-&gt;avd.auditdeny
suffix:semicolon
id|node-&gt;ae.avd.seqno
op_assign
id|ae-&gt;avd.seqno
suffix:semicolon
id|aeref-&gt;ae
op_assign
op_amp
id|node-&gt;ae
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|avc_print_ipv6_addr
r_static
r_inline
r_void
id|avc_print_ipv6_addr
c_func
(paren
r_struct
id|audit_buffer
op_star
id|ab
comma
r_struct
id|in6_addr
op_star
id|addr
comma
id|u16
id|port
comma
r_char
op_star
id|name1
comma
r_char
op_star
id|name2
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ipv6_addr_any
c_func
(paren
id|addr
)paren
)paren
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot; %s=%04x:%04x:%04x:%04x:%04x:&quot;
l_string|&quot;%04x:%04x:%04x&quot;
comma
id|name1
comma
id|NIP6
c_func
(paren
op_star
id|addr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port
)paren
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot; %s=%d&quot;
comma
id|name2
comma
id|ntohs
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
DECL|function|avc_print_ipv4_addr
r_static
r_inline
r_void
id|avc_print_ipv4_addr
c_func
(paren
r_struct
id|audit_buffer
op_star
id|ab
comma
id|u32
id|addr
comma
id|u16
id|port
comma
r_char
op_star
id|name1
comma
r_char
op_star
id|name2
)paren
(brace
r_if
c_cond
(paren
id|addr
)paren
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot; %s=%d.%d.%d.%d&quot;
comma
id|name1
comma
id|NIPQUAD
c_func
(paren
id|addr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port
)paren
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot; %s=%d&quot;
comma
id|name2
comma
id|ntohs
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * avc_audit - Audit the granting or denial of permissions.&n; * @ssid: source security identifier&n; * @tsid: target security identifier&n; * @tclass: target security class&n; * @requested: requested permissions&n; * @avd: access vector decisions&n; * @result: result from avc_has_perm_noaudit&n; * @a:  auxiliary audit data&n; *&n; * Audit the granting or denial of permissions in accordance&n; * with the policy.  This function is typically called by&n; * avc_has_perm() after a permission check, but can also be&n; * called directly by callers who use avc_has_perm_noaudit()&n; * in order to separate the permission check from the auditing.&n; * For example, this separation is useful when the permission check must&n; * be performed under a lock, to allow the lock to be released&n; * before calling the auditing code.&n; */
DECL|function|avc_audit
r_void
id|avc_audit
c_func
(paren
id|u32
id|ssid
comma
id|u32
id|tsid
comma
id|u16
id|tclass
comma
id|u32
id|requested
comma
r_struct
id|av_decision
op_star
id|avd
comma
r_int
id|result
comma
r_struct
id|avc_audit_data
op_star
id|a
)paren
(brace
r_struct
id|task_struct
op_star
id|tsk
op_assign
id|current
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|denied
comma
id|audited
suffix:semicolon
r_struct
id|audit_buffer
op_star
id|ab
suffix:semicolon
id|denied
op_assign
id|requested
op_amp
op_complement
id|avd-&gt;allowed
suffix:semicolon
r_if
c_cond
(paren
id|denied
)paren
(brace
id|audited
op_assign
id|denied
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|audited
op_amp
id|avd-&gt;auditdeny
)paren
)paren
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|result
)paren
(brace
id|audited
op_assign
id|denied
op_assign
id|requested
suffix:semicolon
)brace
r_else
(brace
id|audited
op_assign
id|requested
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|audited
op_amp
id|avd-&gt;auditallow
)paren
)paren
r_return
suffix:semicolon
)brace
id|ab
op_assign
id|audit_log_start
c_func
(paren
id|current-&gt;audit_context
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ab
)paren
r_return
suffix:semicolon
multiline_comment|/* audit_panic has been called */
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot;avc:  %s &quot;
comma
id|denied
ques
c_cond
l_string|&quot;denied&quot;
suffix:colon
l_string|&quot;granted&quot;
)paren
suffix:semicolon
id|avc_dump_av
c_func
(paren
id|ab
comma
id|tclass
comma
id|audited
)paren
suffix:semicolon
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot; for &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a
op_logical_and
id|a-&gt;tsk
)paren
id|tsk
op_assign
id|a-&gt;tsk
suffix:semicolon
r_if
c_cond
(paren
id|tsk
op_logical_and
id|tsk-&gt;pid
)paren
(brace
r_struct
id|mm_struct
op_star
id|mm
suffix:semicolon
r_struct
id|vm_area_struct
op_star
id|vma
suffix:semicolon
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot; pid=%d&quot;
comma
id|tsk-&gt;pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tsk
op_eq
id|current
)paren
id|mm
op_assign
id|current-&gt;mm
suffix:semicolon
r_else
id|mm
op_assign
id|get_task_mm
c_func
(paren
id|tsk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mm
)paren
(brace
r_if
c_cond
(paren
id|down_read_trylock
c_func
(paren
op_amp
id|mm-&gt;mmap_sem
)paren
)paren
(brace
id|vma
op_assign
id|mm-&gt;mmap
suffix:semicolon
r_while
c_loop
(paren
id|vma
)paren
(brace
r_if
c_cond
(paren
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_EXECUTABLE
)paren
op_logical_and
id|vma-&gt;vm_file
)paren
(brace
id|audit_log_d_path
c_func
(paren
id|ab
comma
l_string|&quot;exe=&quot;
comma
id|vma-&gt;vm_file-&gt;f_dentry
comma
id|vma-&gt;vm_file-&gt;f_vfsmnt
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|vma
op_assign
id|vma-&gt;vm_next
suffix:semicolon
)brace
id|up_read
c_func
(paren
op_amp
id|mm-&gt;mmap_sem
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tsk
op_ne
id|current
)paren
id|mmput
c_func
(paren
id|mm
)paren
suffix:semicolon
)brace
r_else
(brace
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot; comm=%s&quot;
comma
id|tsk-&gt;comm
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|a
)paren
(brace
r_switch
c_cond
(paren
id|a-&gt;type
)paren
(brace
r_case
id|AVC_AUDIT_DATA_IPC
suffix:colon
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot; key=%d&quot;
comma
id|a-&gt;u.ipc_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AVC_AUDIT_DATA_CAP
suffix:colon
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot; capability=%d&quot;
comma
id|a-&gt;u.cap
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AVC_AUDIT_DATA_FS
suffix:colon
r_if
c_cond
(paren
id|a-&gt;u.fs.dentry
)paren
(brace
r_struct
id|dentry
op_star
id|dentry
op_assign
id|a-&gt;u.fs.dentry
suffix:semicolon
r_if
c_cond
(paren
id|a-&gt;u.fs.mnt
)paren
(brace
id|audit_log_d_path
c_func
(paren
id|ab
comma
l_string|&quot;path=&quot;
comma
id|dentry
comma
id|a-&gt;u.fs.mnt
)paren
suffix:semicolon
)brace
r_else
(brace
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot; name=%s&quot;
comma
id|dentry-&gt;d_name.name
)paren
suffix:semicolon
)brace
id|inode
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|a-&gt;u.fs.inode
)paren
(brace
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
id|inode
op_assign
id|a-&gt;u.fs.inode
suffix:semicolon
id|dentry
op_assign
id|d_find_alias
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dentry
)paren
(brace
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot; name=%s&quot;
comma
id|dentry-&gt;d_name.name
)paren
suffix:semicolon
id|dput
c_func
(paren
id|dentry
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|inode
)paren
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot; dev=%s ino=%ld&quot;
comma
id|inode-&gt;i_sb-&gt;s_id
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AVC_AUDIT_DATA_NET
suffix:colon
r_if
c_cond
(paren
id|a-&gt;u.net.sk
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|a-&gt;u.net.sk
suffix:semicolon
r_struct
id|unix_sock
op_star
id|u
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|p
op_assign
l_int|NULL
suffix:semicolon
r_switch
c_cond
(paren
id|sk-&gt;sk_family
)paren
(brace
r_case
id|AF_INET
suffix:colon
(brace
r_struct
id|inet_sock
op_star
id|inet
op_assign
id|inet_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
id|avc_print_ipv4_addr
c_func
(paren
id|ab
comma
id|inet-&gt;rcv_saddr
comma
id|inet-&gt;sport
comma
l_string|&quot;laddr&quot;
comma
l_string|&quot;lport&quot;
)paren
suffix:semicolon
id|avc_print_ipv4_addr
c_func
(paren
id|ab
comma
id|inet-&gt;daddr
comma
id|inet-&gt;dport
comma
l_string|&quot;faddr&quot;
comma
l_string|&quot;fport&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|AF_INET6
suffix:colon
(brace
r_struct
id|inet_sock
op_star
id|inet
op_assign
id|inet_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|ipv6_pinfo
op_star
id|inet6
op_assign
id|inet6_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
id|avc_print_ipv6_addr
c_func
(paren
id|ab
comma
op_amp
id|inet6-&gt;rcv_saddr
comma
id|inet-&gt;sport
comma
l_string|&quot;laddr&quot;
comma
l_string|&quot;lport&quot;
)paren
suffix:semicolon
id|avc_print_ipv6_addr
c_func
(paren
id|ab
comma
op_amp
id|inet6-&gt;daddr
comma
id|inet-&gt;dport
comma
l_string|&quot;faddr&quot;
comma
l_string|&quot;fport&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|AF_UNIX
suffix:colon
id|u
op_assign
id|unix_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|u-&gt;dentry
)paren
(brace
id|audit_log_d_path
c_func
(paren
id|ab
comma
l_string|&quot;path=&quot;
comma
id|u-&gt;dentry
comma
id|u-&gt;mnt
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|u-&gt;addr
)paren
r_break
suffix:semicolon
id|len
op_assign
id|u-&gt;addr-&gt;len
op_minus
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|p
op_assign
op_amp
id|u-&gt;addr-&gt;name-&gt;sun_path
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
)paren
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot;path=%*.*s&quot;
comma
id|len
comma
id|len
comma
id|p
)paren
suffix:semicolon
r_else
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot;path=@%*.*s&quot;
comma
id|len
op_minus
l_int|1
comma
id|len
op_minus
l_int|1
comma
id|p
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_switch
c_cond
(paren
id|a-&gt;u.net.family
)paren
(brace
r_case
id|AF_INET
suffix:colon
id|avc_print_ipv4_addr
c_func
(paren
id|ab
comma
id|a-&gt;u.net.v4info.saddr
comma
id|a-&gt;u.net.sport
comma
l_string|&quot;saddr&quot;
comma
l_string|&quot;src&quot;
)paren
suffix:semicolon
id|avc_print_ipv4_addr
c_func
(paren
id|ab
comma
id|a-&gt;u.net.v4info.daddr
comma
id|a-&gt;u.net.dport
comma
l_string|&quot;daddr&quot;
comma
l_string|&quot;dest&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AF_INET6
suffix:colon
id|avc_print_ipv6_addr
c_func
(paren
id|ab
comma
op_amp
id|a-&gt;u.net.v6info.saddr
comma
id|a-&gt;u.net.sport
comma
l_string|&quot;saddr&quot;
comma
l_string|&quot;src&quot;
)paren
suffix:semicolon
id|avc_print_ipv6_addr
c_func
(paren
id|ab
comma
op_amp
id|a-&gt;u.net.v6info.daddr
comma
id|a-&gt;u.net.dport
comma
l_string|&quot;daddr&quot;
comma
l_string|&quot;dest&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|a-&gt;u.net.netif
)paren
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot; netif=%s&quot;
comma
id|a-&gt;u.net.netif
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|audit_log_format
c_func
(paren
id|ab
comma
l_string|&quot; &quot;
)paren
suffix:semicolon
id|avc_dump_query
c_func
(paren
id|ab
comma
id|ssid
comma
id|tsid
comma
id|tclass
)paren
suffix:semicolon
id|audit_log_end
c_func
(paren
id|ab
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * avc_add_callback - Register a callback for security events.&n; * @callback: callback function&n; * @events: security events&n; * @ssid: source security identifier or %SECSID_WILD&n; * @tsid: target security identifier or %SECSID_WILD&n; * @tclass: target security class&n; * @perms: permissions&n; *&n; * Register a callback function for events in the set @events&n; * related to the SID pair (@ssid, @tsid) and&n; * and the permissions @perms, interpreting&n; * @perms based on @tclass.  Returns %0 on success or&n; * -%ENOMEM if insufficient memory exists to add the callback.&n; */
DECL|function|avc_add_callback
r_int
id|avc_add_callback
c_func
(paren
r_int
(paren
op_star
id|callback
)paren
(paren
id|u32
id|event
comma
id|u32
id|ssid
comma
id|u32
id|tsid
comma
id|u16
id|tclass
comma
id|u32
id|perms
comma
id|u32
op_star
id|out_retained
)paren
comma
id|u32
id|events
comma
id|u32
id|ssid
comma
id|u32
id|tsid
comma
id|u16
id|tclass
comma
id|u32
id|perms
)paren
(brace
r_struct
id|avc_callback_node
op_star
id|c
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|c
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|c
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|c-&gt;callback
op_assign
id|callback
suffix:semicolon
id|c-&gt;events
op_assign
id|events
suffix:semicolon
id|c-&gt;ssid
op_assign
id|ssid
suffix:semicolon
id|c-&gt;tsid
op_assign
id|tsid
suffix:semicolon
id|c-&gt;perms
op_assign
id|perms
suffix:semicolon
id|c-&gt;next
op_assign
id|avc_callbacks
suffix:semicolon
id|avc_callbacks
op_assign
id|c
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|avc_sidcmp
r_static
r_inline
r_int
id|avc_sidcmp
c_func
(paren
id|u32
id|x
comma
id|u32
id|y
)paren
(brace
r_return
(paren
id|x
op_eq
id|y
op_logical_or
id|x
op_eq
id|SECSID_WILD
op_logical_or
id|y
op_eq
id|SECSID_WILD
)paren
suffix:semicolon
)brace
DECL|function|avc_update_node
r_static
r_inline
r_void
id|avc_update_node
c_func
(paren
id|u32
id|event
comma
r_struct
id|avc_node
op_star
id|node
comma
id|u32
id|perms
)paren
(brace
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|AVC_CALLBACK_GRANT
suffix:colon
id|node-&gt;ae.avd.allowed
op_or_assign
id|perms
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AVC_CALLBACK_TRY_REVOKE
suffix:colon
r_case
id|AVC_CALLBACK_REVOKE
suffix:colon
id|node-&gt;ae.avd.allowed
op_and_assign
op_complement
id|perms
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AVC_CALLBACK_AUDITALLOW_ENABLE
suffix:colon
id|node-&gt;ae.avd.auditallow
op_or_assign
id|perms
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AVC_CALLBACK_AUDITALLOW_DISABLE
suffix:colon
id|node-&gt;ae.avd.auditallow
op_and_assign
op_complement
id|perms
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AVC_CALLBACK_AUDITDENY_ENABLE
suffix:colon
id|node-&gt;ae.avd.auditdeny
op_or_assign
id|perms
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AVC_CALLBACK_AUDITDENY_DISABLE
suffix:colon
id|node-&gt;ae.avd.auditdeny
op_and_assign
op_complement
id|perms
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|avc_update_cache
r_static
r_int
id|avc_update_cache
c_func
(paren
id|u32
id|event
comma
id|u32
id|ssid
comma
id|u32
id|tsid
comma
id|u16
id|tclass
comma
id|u32
id|perms
)paren
(brace
r_struct
id|avc_node
op_star
id|node
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|avc_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ssid
op_eq
id|SECSID_WILD
op_logical_or
id|tsid
op_eq
id|SECSID_WILD
)paren
(brace
multiline_comment|/* apply to all matching nodes */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|AVC_CACHE_SLOTS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|node
op_assign
id|avc_cache.slots
(braket
id|i
)braket
suffix:semicolon
id|node
suffix:semicolon
id|node
op_assign
id|node-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|avc_sidcmp
c_func
(paren
id|ssid
comma
id|node-&gt;ae.ssid
)paren
op_logical_and
id|avc_sidcmp
c_func
(paren
id|tsid
comma
id|node-&gt;ae.tsid
)paren
op_logical_and
id|tclass
op_eq
id|node-&gt;ae.tclass
)paren
(brace
id|avc_update_node
c_func
(paren
id|event
comma
id|node
comma
id|perms
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* apply to one node */
id|node
op_assign
id|avc_search_node
c_func
(paren
id|ssid
comma
id|tsid
comma
id|tclass
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|node
)paren
(brace
id|avc_update_node
c_func
(paren
id|event
comma
id|node
comma
id|perms
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|avc_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|avc_control
r_static
r_int
id|avc_control
c_func
(paren
id|u32
id|event
comma
id|u32
id|ssid
comma
id|u32
id|tsid
comma
id|u16
id|tclass
comma
id|u32
id|perms
comma
id|u32
id|seqno
comma
id|u32
op_star
id|out_retained
)paren
(brace
r_struct
id|avc_callback_node
op_star
id|c
suffix:semicolon
id|u32
id|tretained
op_assign
l_int|0
comma
id|cretained
op_assign
l_int|0
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/*&n;&t; * try_revoke only removes permissions from the cache&n;&t; * state if they are not retained by the object manager.&n;&t; * Hence, try_revoke must wait until after the callbacks have&n;&t; * been invoked to update the cache state.&n;&t; */
r_if
c_cond
(paren
id|event
op_ne
id|AVC_CALLBACK_TRY_REVOKE
)paren
id|avc_update_cache
c_func
(paren
id|event
comma
id|ssid
comma
id|tsid
comma
id|tclass
comma
id|perms
)paren
suffix:semicolon
r_for
c_loop
(paren
id|c
op_assign
id|avc_callbacks
suffix:semicolon
id|c
suffix:semicolon
id|c
op_assign
id|c-&gt;next
)paren
(brace
r_if
c_cond
(paren
(paren
id|c-&gt;events
op_amp
id|event
)paren
op_logical_and
id|avc_sidcmp
c_func
(paren
id|c-&gt;ssid
comma
id|ssid
)paren
op_logical_and
id|avc_sidcmp
c_func
(paren
id|c-&gt;tsid
comma
id|tsid
)paren
op_logical_and
id|c-&gt;tclass
op_eq
id|tclass
op_logical_and
(paren
id|c-&gt;perms
op_amp
id|perms
)paren
)paren
(brace
id|cretained
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|c
op_member_access_from_pointer
id|callback
c_func
(paren
id|event
comma
id|ssid
comma
id|tsid
comma
id|tclass
comma
(paren
id|c-&gt;perms
op_amp
id|perms
)paren
comma
op_amp
id|cretained
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|out
suffix:semicolon
id|tretained
op_or_assign
id|cretained
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|event
op_eq
id|AVC_CALLBACK_TRY_REVOKE
)paren
(brace
multiline_comment|/* revoke any unretained permissions */
id|perms
op_and_assign
op_complement
id|tretained
suffix:semicolon
id|avc_update_cache
c_func
(paren
id|event
comma
id|ssid
comma
id|tsid
comma
id|tclass
comma
id|perms
)paren
suffix:semicolon
op_star
id|out_retained
op_assign
id|tretained
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|avc_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|seqno
OG
id|avc_cache.latest_notif
)paren
id|avc_cache.latest_notif
op_assign
id|seqno
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|avc_lock
comma
id|flags
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * avc_ss_grant - Grant previously denied permissions.&n; * @ssid: source security identifier or %SECSID_WILD&n; * @tsid: target security identifier or %SECSID_WILD&n; * @tclass: target security class&n; * @perms: permissions to grant&n; * @seqno: policy sequence number&n; */
DECL|function|avc_ss_grant
r_int
id|avc_ss_grant
c_func
(paren
id|u32
id|ssid
comma
id|u32
id|tsid
comma
id|u16
id|tclass
comma
id|u32
id|perms
comma
id|u32
id|seqno
)paren
(brace
r_return
id|avc_control
c_func
(paren
id|AVC_CALLBACK_GRANT
comma
id|ssid
comma
id|tsid
comma
id|tclass
comma
id|perms
comma
id|seqno
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * avc_ss_try_revoke - Try to revoke previously granted permissions.&n; * @ssid: source security identifier or %SECSID_WILD&n; * @tsid: target security identifier or %SECSID_WILD&n; * @tclass: target security class&n; * @perms: permissions to grant&n; * @seqno: policy sequence number&n; * @out_retained: subset of @perms that are retained&n; *&n; * Try to revoke previously granted permissions, but&n; * only if they are not retained as migrated permissions.&n; * Return the subset of permissions that are retained via @out_retained.&n; */
DECL|function|avc_ss_try_revoke
r_int
id|avc_ss_try_revoke
c_func
(paren
id|u32
id|ssid
comma
id|u32
id|tsid
comma
id|u16
id|tclass
comma
id|u32
id|perms
comma
id|u32
id|seqno
comma
id|u32
op_star
id|out_retained
)paren
(brace
r_return
id|avc_control
c_func
(paren
id|AVC_CALLBACK_TRY_REVOKE
comma
id|ssid
comma
id|tsid
comma
id|tclass
comma
id|perms
comma
id|seqno
comma
id|out_retained
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * avc_ss_revoke - Revoke previously granted permissions.&n; * @ssid: source security identifier or %SECSID_WILD&n; * @tsid: target security identifier or %SECSID_WILD&n; * @tclass: target security class&n; * @perms: permissions to grant&n; * @seqno: policy sequence number&n; *&n; * Revoke previously granted permissions, even if&n; * they are retained as migrated permissions.&n; */
DECL|function|avc_ss_revoke
r_int
id|avc_ss_revoke
c_func
(paren
id|u32
id|ssid
comma
id|u32
id|tsid
comma
id|u16
id|tclass
comma
id|u32
id|perms
comma
id|u32
id|seqno
)paren
(brace
r_return
id|avc_control
c_func
(paren
id|AVC_CALLBACK_REVOKE
comma
id|ssid
comma
id|tsid
comma
id|tclass
comma
id|perms
comma
id|seqno
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * avc_ss_reset - Flush the cache and revalidate migrated permissions.&n; * @seqno: policy sequence number&n; */
DECL|function|avc_ss_reset
r_int
id|avc_ss_reset
c_func
(paren
id|u32
id|seqno
)paren
(brace
r_struct
id|avc_callback_node
op_star
id|c
suffix:semicolon
r_int
id|i
comma
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|avc_node
op_star
id|node
comma
op_star
id|tmp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|avc_hash_eval
c_func
(paren
l_string|&quot;reset&quot;
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|avc_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|AVC_CACHE_SLOTS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|node
op_assign
id|avc_cache.slots
(braket
id|i
)braket
suffix:semicolon
r_while
c_loop
(paren
id|node
)paren
(brace
id|tmp
op_assign
id|node
suffix:semicolon
id|node
op_assign
id|node-&gt;next
suffix:semicolon
id|tmp-&gt;ae.ssid
op_assign
id|tmp-&gt;ae.tsid
op_assign
id|SECSID_NULL
suffix:semicolon
id|tmp-&gt;ae.tclass
op_assign
id|SECCLASS_NULL
suffix:semicolon
id|tmp-&gt;ae.avd.allowed
op_assign
id|tmp-&gt;ae.avd.decided
op_assign
l_int|0
suffix:semicolon
id|tmp-&gt;ae.avd.auditallow
op_assign
id|tmp-&gt;ae.avd.auditdeny
op_assign
l_int|0
suffix:semicolon
id|tmp-&gt;ae.used
op_assign
l_int|0
suffix:semicolon
id|tmp-&gt;next
op_assign
id|avc_node_freelist
suffix:semicolon
id|avc_node_freelist
op_assign
id|tmp
suffix:semicolon
id|avc_cache.active_nodes
op_decrement
suffix:semicolon
)brace
id|avc_cache.slots
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|avc_cache.lru_hint
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|avc_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|AVC_NSTATS
suffix:semicolon
id|i
op_increment
)paren
id|avc_cache_stats
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|c
op_assign
id|avc_callbacks
suffix:semicolon
id|c
suffix:semicolon
id|c
op_assign
id|c-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|c-&gt;events
op_amp
id|AVC_CALLBACK_RESET
)paren
(brace
id|rc
op_assign
id|c
op_member_access_from_pointer
id|callback
c_func
(paren
id|AVC_CALLBACK_RESET
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|out
suffix:semicolon
)brace
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|avc_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|seqno
OG
id|avc_cache.latest_notif
)paren
id|avc_cache.latest_notif
op_assign
id|seqno
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|avc_lock
comma
id|flags
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * avc_ss_set_auditallow - Enable or disable auditing of granted permissions.&n; * @ssid: source security identifier or %SECSID_WILD&n; * @tsid: target security identifier or %SECSID_WILD&n; * @tclass: target security class&n; * @perms: permissions to grant&n; * @seqno: policy sequence number&n; * @enable: enable flag.&n; */
DECL|function|avc_ss_set_auditallow
r_int
id|avc_ss_set_auditallow
c_func
(paren
id|u32
id|ssid
comma
id|u32
id|tsid
comma
id|u16
id|tclass
comma
id|u32
id|perms
comma
id|u32
id|seqno
comma
id|u32
id|enable
)paren
(brace
r_if
c_cond
(paren
id|enable
)paren
r_return
id|avc_control
c_func
(paren
id|AVC_CALLBACK_AUDITALLOW_ENABLE
comma
id|ssid
comma
id|tsid
comma
id|tclass
comma
id|perms
comma
id|seqno
comma
l_int|NULL
)paren
suffix:semicolon
r_else
r_return
id|avc_control
c_func
(paren
id|AVC_CALLBACK_AUDITALLOW_DISABLE
comma
id|ssid
comma
id|tsid
comma
id|tclass
comma
id|perms
comma
id|seqno
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * avc_ss_set_auditdeny - Enable or disable auditing of denied permissions.&n; * @ssid: source security identifier or %SECSID_WILD&n; * @tsid: target security identifier or %SECSID_WILD&n; * @tclass: target security class&n; * @perms: permissions to grant&n; * @seqno: policy sequence number&n; * @enable: enable flag.&n; */
DECL|function|avc_ss_set_auditdeny
r_int
id|avc_ss_set_auditdeny
c_func
(paren
id|u32
id|ssid
comma
id|u32
id|tsid
comma
id|u16
id|tclass
comma
id|u32
id|perms
comma
id|u32
id|seqno
comma
id|u32
id|enable
)paren
(brace
r_if
c_cond
(paren
id|enable
)paren
r_return
id|avc_control
c_func
(paren
id|AVC_CALLBACK_AUDITDENY_ENABLE
comma
id|ssid
comma
id|tsid
comma
id|tclass
comma
id|perms
comma
id|seqno
comma
l_int|NULL
)paren
suffix:semicolon
r_else
r_return
id|avc_control
c_func
(paren
id|AVC_CALLBACK_AUDITDENY_DISABLE
comma
id|ssid
comma
id|tsid
comma
id|tclass
comma
id|perms
comma
id|seqno
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * avc_has_perm_noaudit - Check permissions but perform no auditing.&n; * @ssid: source security identifier&n; * @tsid: target security identifier&n; * @tclass: target security class&n; * @requested: requested permissions, interpreted based on @tclass&n; * @aeref:  AVC entry reference&n; * @avd: access vector decisions&n; *&n; * Check the AVC to determine whether the @requested permissions are granted&n; * for the SID pair (@ssid, @tsid), interpreting the permissions&n; * based on @tclass, and call the security server on a cache miss to obtain&n; * a new decision and add it to the cache.  Update @aeref to refer to an AVC&n; * entry with the resulting decisions, and return a copy of the decisions&n; * in @avd.  Return %0 if all @requested permissions are granted,&n; * -%EACCES if any permissions are denied, or another -errno upon&n; * other errors.  This function is typically called by avc_has_perm(),&n; * but may also be called directly to separate permission checking from&n; * auditing, e.g. in cases where a lock must be held for the check but&n; * should be released for the auditing.&n; */
DECL|function|avc_has_perm_noaudit
r_int
id|avc_has_perm_noaudit
c_func
(paren
id|u32
id|ssid
comma
id|u32
id|tsid
comma
id|u16
id|tclass
comma
id|u32
id|requested
comma
r_struct
id|avc_entry_ref
op_star
id|aeref
comma
r_struct
id|av_decision
op_star
id|avd
)paren
(brace
r_struct
id|avc_entry
op_star
id|ae
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|avc_entry
id|entry
suffix:semicolon
id|u32
id|denied
suffix:semicolon
r_struct
id|avc_entry_ref
id|ref
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|aeref
)paren
(brace
id|avc_entry_ref_init
c_func
(paren
op_amp
id|ref
)paren
suffix:semicolon
id|aeref
op_assign
op_amp
id|ref
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|avc_lock
comma
id|flags
)paren
suffix:semicolon
id|avc_cache_stats_incr
c_func
(paren
id|AVC_ENTRY_LOOKUPS
)paren
suffix:semicolon
id|ae
op_assign
id|aeref-&gt;ae
suffix:semicolon
r_if
c_cond
(paren
id|ae
)paren
(brace
r_if
c_cond
(paren
id|ae-&gt;ssid
op_eq
id|ssid
op_logical_and
id|ae-&gt;tsid
op_eq
id|tsid
op_logical_and
id|ae-&gt;tclass
op_eq
id|tclass
op_logical_and
(paren
(paren
id|ae-&gt;avd.decided
op_amp
id|requested
)paren
op_eq
id|requested
)paren
)paren
(brace
id|avc_cache_stats_incr
c_func
(paren
id|AVC_ENTRY_HITS
)paren
suffix:semicolon
id|ae-&gt;used
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|avc_cache_stats_incr
c_func
(paren
id|AVC_ENTRY_DISCARDS
)paren
suffix:semicolon
id|ae
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|ae
)paren
(brace
id|avc_cache_stats_incr
c_func
(paren
id|AVC_ENTRY_MISSES
)paren
suffix:semicolon
id|rc
op_assign
id|avc_lookup
c_func
(paren
id|ssid
comma
id|tsid
comma
id|tclass
comma
id|requested
comma
id|aeref
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|avc_lock
comma
id|flags
)paren
suffix:semicolon
id|rc
op_assign
id|security_compute_av
c_func
(paren
id|ssid
comma
id|tsid
comma
id|tclass
comma
id|requested
comma
op_amp
id|entry.avd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|out
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|avc_lock
comma
id|flags
)paren
suffix:semicolon
id|rc
op_assign
id|avc_insert
c_func
(paren
id|ssid
comma
id|tsid
comma
id|tclass
comma
op_amp
id|entry
comma
id|aeref
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|avc_lock
comma
id|flags
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|ae
op_assign
id|aeref-&gt;ae
suffix:semicolon
)brace
r_if
c_cond
(paren
id|avd
)paren
id|memcpy
c_func
(paren
id|avd
comma
op_amp
id|ae-&gt;avd
comma
r_sizeof
(paren
op_star
id|avd
)paren
)paren
suffix:semicolon
id|denied
op_assign
id|requested
op_amp
op_complement
(paren
id|ae-&gt;avd.allowed
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|requested
op_logical_or
id|denied
)paren
(brace
r_if
c_cond
(paren
id|selinux_enforcing
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|avc_lock
comma
id|flags
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EACCES
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_else
(brace
id|ae-&gt;avd.allowed
op_or_assign
id|requested
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|avc_lock
comma
id|flags
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|avc_lock
comma
id|flags
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * avc_has_perm - Check permissions and perform any appropriate auditing.&n; * @ssid: source security identifier&n; * @tsid: target security identifier&n; * @tclass: target security class&n; * @requested: requested permissions, interpreted based on @tclass&n; * @aeref:  AVC entry reference&n; * @auditdata: auxiliary audit data&n; *&n; * Check the AVC to determine whether the @requested permissions are granted&n; * for the SID pair (@ssid, @tsid), interpreting the permissions&n; * based on @tclass, and call the security server on a cache miss to obtain&n; * a new decision and add it to the cache.  Update @aeref to refer to an AVC&n; * entry with the resulting decisions.  Audit the granting or denial of&n; * permissions in accordance with the policy.  Return %0 if all @requested&n; * permissions are granted, -%EACCES if any permissions are denied, or&n; * another -errno upon other errors.&n; */
DECL|function|avc_has_perm
r_int
id|avc_has_perm
c_func
(paren
id|u32
id|ssid
comma
id|u32
id|tsid
comma
id|u16
id|tclass
comma
id|u32
id|requested
comma
r_struct
id|avc_entry_ref
op_star
id|aeref
comma
r_struct
id|avc_audit_data
op_star
id|auditdata
)paren
(brace
r_struct
id|av_decision
id|avd
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|avc_has_perm_noaudit
c_func
(paren
id|ssid
comma
id|tsid
comma
id|tclass
comma
id|requested
comma
id|aeref
comma
op_amp
id|avd
)paren
suffix:semicolon
id|avc_audit
c_func
(paren
id|ssid
comma
id|tsid
comma
id|tclass
comma
id|requested
comma
op_amp
id|avd
comma
id|rc
comma
id|auditdata
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
eof
