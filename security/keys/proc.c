multiline_comment|/* proc.c: proc files for key database enumeration&n; *&n; * Copyright (C) 2004 Red Hat, Inc. All Rights Reserved.&n; * Written by David Howells (dhowells@redhat.com)&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/seq_file.h&gt;
macro_line|#include &lt;asm/errno.h&gt;
macro_line|#include &quot;internal.h&quot;
macro_line|#ifdef CONFIG_KEYS_DEBUG_PROC_KEYS
r_static
r_int
id|proc_keys_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_void
op_star
id|proc_keys_start
c_func
(paren
r_struct
id|seq_file
op_star
id|p
comma
id|loff_t
op_star
id|_pos
)paren
suffix:semicolon
r_static
r_void
op_star
id|proc_keys_next
c_func
(paren
r_struct
id|seq_file
op_star
id|p
comma
r_void
op_star
id|v
comma
id|loff_t
op_star
id|_pos
)paren
suffix:semicolon
r_static
r_void
id|proc_keys_stop
c_func
(paren
r_struct
id|seq_file
op_star
id|p
comma
r_void
op_star
id|v
)paren
suffix:semicolon
r_static
r_int
id|proc_keys_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
suffix:semicolon
DECL|variable|proc_keys_ops
r_static
r_struct
id|seq_operations
id|proc_keys_ops
op_assign
(brace
dot
id|start
op_assign
id|proc_keys_start
comma
dot
id|next
op_assign
id|proc_keys_next
comma
dot
id|stop
op_assign
id|proc_keys_stop
comma
dot
id|show
op_assign
id|proc_keys_show
comma
)brace
suffix:semicolon
DECL|variable|proc_keys_fops
r_static
r_struct
id|file_operations
id|proc_keys_fops
op_assign
(brace
dot
id|open
op_assign
id|proc_keys_open
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|release
op_assign
id|seq_release
comma
)brace
suffix:semicolon
macro_line|#endif
r_static
r_int
id|proc_key_users_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_void
op_star
id|proc_key_users_start
c_func
(paren
r_struct
id|seq_file
op_star
id|p
comma
id|loff_t
op_star
id|_pos
)paren
suffix:semicolon
r_static
r_void
op_star
id|proc_key_users_next
c_func
(paren
r_struct
id|seq_file
op_star
id|p
comma
r_void
op_star
id|v
comma
id|loff_t
op_star
id|_pos
)paren
suffix:semicolon
r_static
r_void
id|proc_key_users_stop
c_func
(paren
r_struct
id|seq_file
op_star
id|p
comma
r_void
op_star
id|v
)paren
suffix:semicolon
r_static
r_int
id|proc_key_users_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
suffix:semicolon
DECL|variable|proc_key_users_ops
r_static
r_struct
id|seq_operations
id|proc_key_users_ops
op_assign
(brace
dot
id|start
op_assign
id|proc_key_users_start
comma
dot
id|next
op_assign
id|proc_key_users_next
comma
dot
id|stop
op_assign
id|proc_key_users_stop
comma
dot
id|show
op_assign
id|proc_key_users_show
comma
)brace
suffix:semicolon
DECL|variable|proc_key_users_fops
r_static
r_struct
id|file_operations
id|proc_key_users_fops
op_assign
(brace
dot
id|open
op_assign
id|proc_key_users_open
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|release
op_assign
id|seq_release
comma
)brace
suffix:semicolon
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * declare the /proc files&n; */
DECL|function|key_proc_init
r_static
r_int
id|__init
id|key_proc_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|p
suffix:semicolon
macro_line|#ifdef CONFIG_KEYS_DEBUG_PROC_KEYS
id|p
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;keys&quot;
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
id|panic
c_func
(paren
l_string|&quot;Cannot create /proc/keys&bslash;n&quot;
)paren
suffix:semicolon
id|p-&gt;proc_fops
op_assign
op_amp
id|proc_keys_fops
suffix:semicolon
macro_line|#endif
id|p
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;key-users&quot;
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
id|panic
c_func
(paren
l_string|&quot;Cannot create /proc/key-users&bslash;n&quot;
)paren
suffix:semicolon
id|p-&gt;proc_fops
op_assign
op_amp
id|proc_key_users_fops
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* end key_proc_init() */
DECL|variable|key_proc_init
id|__initcall
c_func
(paren
id|key_proc_init
)paren
suffix:semicolon
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * implement &quot;/proc/keys&quot; to provides a list of the keys on the system&n; */
macro_line|#ifdef CONFIG_KEYS_DEBUG_PROC_KEYS
DECL|function|proc_keys_open
r_static
r_int
id|proc_keys_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|seq_open
c_func
(paren
id|file
comma
op_amp
id|proc_keys_ops
)paren
suffix:semicolon
)brace
DECL|function|proc_keys_start
r_static
r_void
op_star
id|proc_keys_start
c_func
(paren
r_struct
id|seq_file
op_star
id|p
comma
id|loff_t
op_star
id|_pos
)paren
(brace
r_struct
id|rb_node
op_star
id|_p
suffix:semicolon
id|loff_t
id|pos
op_assign
op_star
id|_pos
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|key_serial_lock
)paren
suffix:semicolon
id|_p
op_assign
id|rb_first
c_func
(paren
op_amp
id|key_serial_tree
)paren
suffix:semicolon
r_while
c_loop
(paren
id|pos
OG
l_int|0
op_logical_and
id|_p
)paren
(brace
id|pos
op_decrement
suffix:semicolon
id|_p
op_assign
id|rb_next
c_func
(paren
id|_p
)paren
suffix:semicolon
)brace
r_return
id|_p
suffix:semicolon
)brace
DECL|function|proc_keys_next
r_static
r_void
op_star
id|proc_keys_next
c_func
(paren
r_struct
id|seq_file
op_star
id|p
comma
r_void
op_star
id|v
comma
id|loff_t
op_star
id|_pos
)paren
(brace
(paren
op_star
id|_pos
)paren
op_increment
suffix:semicolon
r_return
id|rb_next
c_func
(paren
(paren
r_struct
id|rb_node
op_star
)paren
id|v
)paren
suffix:semicolon
)brace
DECL|function|proc_keys_stop
r_static
r_void
id|proc_keys_stop
c_func
(paren
r_struct
id|seq_file
op_star
id|p
comma
r_void
op_star
id|v
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|key_serial_lock
)paren
suffix:semicolon
)brace
DECL|function|proc_keys_show
r_static
r_int
id|proc_keys_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
(brace
r_struct
id|rb_node
op_star
id|_p
op_assign
id|v
suffix:semicolon
r_struct
id|key
op_star
id|key
op_assign
id|rb_entry
c_func
(paren
id|_p
comma
r_struct
id|key
comma
id|serial_node
)paren
suffix:semicolon
r_struct
id|timespec
id|now
suffix:semicolon
r_int
r_int
id|timo
suffix:semicolon
r_char
id|xbuf
(braket
l_int|12
)braket
suffix:semicolon
id|now
op_assign
id|current_kernel_time
c_func
(paren
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|key-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* come up with a suitable timeout value */
r_if
c_cond
(paren
id|key-&gt;expiry
op_eq
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
id|xbuf
comma
l_string|&quot;perm&quot;
comma
l_int|5
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|now.tv_sec
op_ge
id|key-&gt;expiry
)paren
(brace
id|memcpy
c_func
(paren
id|xbuf
comma
l_string|&quot;expd&quot;
comma
l_int|5
)paren
suffix:semicolon
)brace
r_else
(brace
id|timo
op_assign
id|key-&gt;expiry
op_minus
id|now.tv_sec
suffix:semicolon
r_if
c_cond
(paren
id|timo
OL
l_int|60
)paren
id|sprintf
c_func
(paren
id|xbuf
comma
l_string|&quot;%lus&quot;
comma
id|timo
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|timo
OL
l_int|60
op_star
l_int|60
)paren
id|sprintf
c_func
(paren
id|xbuf
comma
l_string|&quot;%lum&quot;
comma
id|timo
op_div
l_int|60
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|timo
OL
l_int|60
op_star
l_int|60
op_star
l_int|24
)paren
id|sprintf
c_func
(paren
id|xbuf
comma
l_string|&quot;%luh&quot;
comma
id|timo
op_div
(paren
l_int|60
op_star
l_int|60
)paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|timo
OL
l_int|60
op_star
l_int|60
op_star
l_int|24
op_star
l_int|7
)paren
id|sprintf
c_func
(paren
id|xbuf
comma
l_string|&quot;%lud&quot;
comma
id|timo
op_div
(paren
l_int|60
op_star
l_int|60
op_star
l_int|24
)paren
)paren
suffix:semicolon
r_else
id|sprintf
c_func
(paren
id|xbuf
comma
l_string|&quot;%luw&quot;
comma
id|timo
op_div
(paren
l_int|60
op_star
l_int|60
op_star
l_int|24
op_star
l_int|7
)paren
)paren
suffix:semicolon
)brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%08x %c%c%c%c%c%c %5d %4s %06x %5d %5d %-9.9s &quot;
comma
id|key-&gt;serial
comma
id|key-&gt;flags
op_amp
id|KEY_FLAG_INSTANTIATED
ques
c_cond
l_char|&squot;I&squot;
suffix:colon
l_char|&squot;-&squot;
comma
id|key-&gt;flags
op_amp
id|KEY_FLAG_REVOKED
ques
c_cond
l_char|&squot;R&squot;
suffix:colon
l_char|&squot;-&squot;
comma
id|key-&gt;flags
op_amp
id|KEY_FLAG_DEAD
ques
c_cond
l_char|&squot;D&squot;
suffix:colon
l_char|&squot;-&squot;
comma
id|key-&gt;flags
op_amp
id|KEY_FLAG_IN_QUOTA
ques
c_cond
l_char|&squot;Q&squot;
suffix:colon
l_char|&squot;-&squot;
comma
id|key-&gt;flags
op_amp
id|KEY_FLAG_USER_CONSTRUCT
ques
c_cond
l_char|&squot;U&squot;
suffix:colon
l_char|&squot;-&squot;
comma
id|key-&gt;flags
op_amp
id|KEY_FLAG_NEGATIVE
ques
c_cond
l_char|&squot;N&squot;
suffix:colon
l_char|&squot;-&squot;
comma
id|atomic_read
c_func
(paren
op_amp
id|key-&gt;usage
)paren
comma
id|xbuf
comma
id|key-&gt;perm
comma
id|key-&gt;uid
comma
id|key-&gt;gid
comma
id|key-&gt;type-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|key-&gt;type-&gt;describe
)paren
id|key-&gt;type
op_member_access_from_pointer
id|describe
c_func
(paren
id|key
comma
id|m
)paren
suffix:semicolon
id|seq_putc
c_func
(paren
id|m
comma
l_char|&squot;&bslash;n&squot;
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|key-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_KEYS_DEBUG_PROC_KEYS */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * implement &quot;/proc/key-users&quot; to provides a list of the key users&n; */
DECL|function|proc_key_users_open
r_static
r_int
id|proc_key_users_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|seq_open
c_func
(paren
id|file
comma
op_amp
id|proc_key_users_ops
)paren
suffix:semicolon
)brace
DECL|function|proc_key_users_start
r_static
r_void
op_star
id|proc_key_users_start
c_func
(paren
r_struct
id|seq_file
op_star
id|p
comma
id|loff_t
op_star
id|_pos
)paren
(brace
r_struct
id|rb_node
op_star
id|_p
suffix:semicolon
id|loff_t
id|pos
op_assign
op_star
id|_pos
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|key_user_lock
)paren
suffix:semicolon
id|_p
op_assign
id|rb_first
c_func
(paren
op_amp
id|key_user_tree
)paren
suffix:semicolon
r_while
c_loop
(paren
id|pos
OG
l_int|0
op_logical_and
id|_p
)paren
(brace
id|pos
op_decrement
suffix:semicolon
id|_p
op_assign
id|rb_next
c_func
(paren
id|_p
)paren
suffix:semicolon
)brace
r_return
id|_p
suffix:semicolon
)brace
DECL|function|proc_key_users_next
r_static
r_void
op_star
id|proc_key_users_next
c_func
(paren
r_struct
id|seq_file
op_star
id|p
comma
r_void
op_star
id|v
comma
id|loff_t
op_star
id|_pos
)paren
(brace
(paren
op_star
id|_pos
)paren
op_increment
suffix:semicolon
r_return
id|rb_next
c_func
(paren
(paren
r_struct
id|rb_node
op_star
)paren
id|v
)paren
suffix:semicolon
)brace
DECL|function|proc_key_users_stop
r_static
r_void
id|proc_key_users_stop
c_func
(paren
r_struct
id|seq_file
op_star
id|p
comma
r_void
op_star
id|v
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|key_user_lock
)paren
suffix:semicolon
)brace
DECL|function|proc_key_users_show
r_static
r_int
id|proc_key_users_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
(brace
r_struct
id|rb_node
op_star
id|_p
op_assign
id|v
suffix:semicolon
r_struct
id|key_user
op_star
id|user
op_assign
id|rb_entry
c_func
(paren
id|_p
comma
r_struct
id|key_user
comma
id|node
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%5u: %5d %d/%d %d/%d %d/%d&bslash;n&quot;
comma
id|user-&gt;uid
comma
id|atomic_read
c_func
(paren
op_amp
id|user-&gt;usage
)paren
comma
id|atomic_read
c_func
(paren
op_amp
id|user-&gt;nkeys
)paren
comma
id|atomic_read
c_func
(paren
op_amp
id|user-&gt;nikeys
)paren
comma
id|user-&gt;qnkeys
comma
id|KEYQUOTA_MAX_KEYS
comma
id|user-&gt;qnbytes
comma
id|KEYQUOTA_MAX_BYTES
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
