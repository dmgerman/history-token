macro_line|#include &lt;stdio.h&gt;
macro_line|#include &lt;stdlib.h&gt;
macro_line|#include &lt;sys/types.h&gt;
macro_line|#include &lt;sys/stat.h&gt;
macro_line|#include &lt;string.h&gt;
macro_line|#include &lt;unistd.h&gt;
macro_line|#include &lt;time.h&gt;
macro_line|#include &lt;fcntl.h&gt;
macro_line|#include &lt;errno.h&gt;
macro_line|#include &lt;ctype.h&gt;
macro_line|#include &lt;limits.h&gt;
multiline_comment|/*&n; * Original work by Jeff Garzik&n; *&n; * External file lists, symlink, pipe and fifo support by Thayne Harbaugh&n; */
DECL|macro|xstr
mdefine_line|#define xstr(s) #s
DECL|macro|str
mdefine_line|#define str(s) xstr(s)
DECL|variable|offset
r_static
r_int
r_int
id|offset
suffix:semicolon
DECL|variable|ino
r_static
r_int
r_int
id|ino
op_assign
l_int|721
suffix:semicolon
DECL|struct|file_handler
r_struct
id|file_handler
(brace
DECL|member|type
r_const
r_char
op_star
id|type
suffix:semicolon
DECL|member|handler
r_int
(paren
op_star
id|handler
)paren
(paren
r_const
r_char
op_star
id|line
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|function|push_string
r_static
r_void
id|push_string
c_func
(paren
r_const
r_char
op_star
id|name
)paren
(brace
r_int
r_int
id|name_len
op_assign
id|strlen
c_func
(paren
id|name
)paren
op_plus
l_int|1
suffix:semicolon
id|fputs
c_func
(paren
id|name
comma
id|stdout
)paren
suffix:semicolon
id|putchar
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|offset
op_add_assign
id|name_len
suffix:semicolon
)brace
DECL|function|push_pad
r_static
r_void
id|push_pad
(paren
r_void
)paren
(brace
r_while
c_loop
(paren
id|offset
op_amp
l_int|3
)paren
(brace
id|putchar
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|offset
op_increment
suffix:semicolon
)brace
)brace
DECL|function|push_rest
r_static
r_void
id|push_rest
c_func
(paren
r_const
r_char
op_star
id|name
)paren
(brace
r_int
r_int
id|name_len
op_assign
id|strlen
c_func
(paren
id|name
)paren
op_plus
l_int|1
suffix:semicolon
r_int
r_int
id|tmp_ofs
suffix:semicolon
id|fputs
c_func
(paren
id|name
comma
id|stdout
)paren
suffix:semicolon
id|putchar
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|offset
op_add_assign
id|name_len
suffix:semicolon
id|tmp_ofs
op_assign
id|name_len
op_plus
l_int|110
suffix:semicolon
r_while
c_loop
(paren
id|tmp_ofs
op_amp
l_int|3
)paren
(brace
id|putchar
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|offset
op_increment
suffix:semicolon
id|tmp_ofs
op_increment
suffix:semicolon
)brace
)brace
DECL|function|push_hdr
r_static
r_void
id|push_hdr
c_func
(paren
r_const
r_char
op_star
id|s
)paren
(brace
id|fputs
c_func
(paren
id|s
comma
id|stdout
)paren
suffix:semicolon
id|offset
op_add_assign
l_int|110
suffix:semicolon
)brace
DECL|function|cpio_trailer
r_static
r_void
id|cpio_trailer
c_func
(paren
r_void
)paren
(brace
r_char
id|s
(braket
l_int|256
)braket
suffix:semicolon
r_const
r_char
id|name
(braket
)braket
op_assign
l_string|&quot;TRAILER!!!&quot;
suffix:semicolon
id|sprintf
c_func
(paren
id|s
comma
l_string|&quot;%s%08X%08X%08lX%08lX%08X%08lX&quot;
l_string|&quot;%08X%08X%08X%08X%08X%08X%08X&quot;
comma
l_string|&quot;070701&quot;
comma
multiline_comment|/* magic */
l_int|0
comma
multiline_comment|/* ino */
l_int|0
comma
multiline_comment|/* mode */
(paren
r_int
)paren
l_int|0
comma
multiline_comment|/* uid */
(paren
r_int
)paren
l_int|0
comma
multiline_comment|/* gid */
l_int|1
comma
multiline_comment|/* nlink */
(paren
r_int
)paren
l_int|0
comma
multiline_comment|/* mtime */
l_int|0
comma
multiline_comment|/* filesize */
l_int|0
comma
multiline_comment|/* major */
l_int|0
comma
multiline_comment|/* minor */
l_int|0
comma
multiline_comment|/* rmajor */
l_int|0
comma
multiline_comment|/* rminor */
(paren
r_int
)paren
id|strlen
c_func
(paren
id|name
)paren
op_plus
l_int|1
comma
multiline_comment|/* namesize */
l_int|0
)paren
suffix:semicolon
multiline_comment|/* chksum */
id|push_hdr
c_func
(paren
id|s
)paren
suffix:semicolon
id|push_rest
c_func
(paren
id|name
)paren
suffix:semicolon
r_while
c_loop
(paren
id|offset
op_mod
l_int|512
)paren
(brace
id|putchar
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|offset
op_increment
suffix:semicolon
)brace
)brace
DECL|function|cpio_mkslink
r_static
r_int
id|cpio_mkslink
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_const
r_char
op_star
id|target
comma
r_int
r_int
id|mode
comma
id|uid_t
id|uid
comma
id|gid_t
id|gid
)paren
(brace
r_char
id|s
(braket
l_int|256
)braket
suffix:semicolon
id|time_t
id|mtime
op_assign
id|time
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|s
comma
l_string|&quot;%s%08X%08X%08lX%08lX%08X%08lX&quot;
l_string|&quot;%08X%08X%08X%08X%08X%08X%08X&quot;
comma
l_string|&quot;070701&quot;
comma
multiline_comment|/* magic */
id|ino
op_increment
comma
multiline_comment|/* ino */
id|S_IFLNK
op_or
id|mode
comma
multiline_comment|/* mode */
(paren
r_int
)paren
id|uid
comma
multiline_comment|/* uid */
(paren
r_int
)paren
id|gid
comma
multiline_comment|/* gid */
l_int|1
comma
multiline_comment|/* nlink */
(paren
r_int
)paren
id|mtime
comma
multiline_comment|/* mtime */
(paren
r_int
)paren
id|strlen
c_func
(paren
id|target
)paren
op_plus
l_int|1
comma
multiline_comment|/* filesize */
l_int|3
comma
multiline_comment|/* major */
l_int|1
comma
multiline_comment|/* minor */
l_int|0
comma
multiline_comment|/* rmajor */
l_int|0
comma
multiline_comment|/* rminor */
(paren
r_int
)paren
id|strlen
c_func
(paren
id|name
)paren
op_plus
l_int|1
comma
multiline_comment|/* namesize */
l_int|0
)paren
suffix:semicolon
multiline_comment|/* chksum */
id|push_hdr
c_func
(paren
id|s
)paren
suffix:semicolon
id|push_string
c_func
(paren
id|name
)paren
suffix:semicolon
id|push_pad
c_func
(paren
)paren
suffix:semicolon
id|push_string
c_func
(paren
id|target
)paren
suffix:semicolon
id|push_pad
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cpio_mkslink_line
r_static
r_int
id|cpio_mkslink_line
c_func
(paren
r_const
r_char
op_star
id|line
)paren
(brace
r_char
id|name
(braket
id|PATH_MAX
op_plus
l_int|1
)braket
suffix:semicolon
r_char
id|target
(braket
id|PATH_MAX
op_plus
l_int|1
)braket
suffix:semicolon
r_int
r_int
id|mode
suffix:semicolon
r_int
id|uid
suffix:semicolon
r_int
id|gid
suffix:semicolon
r_int
id|rc
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
l_int|5
op_ne
id|sscanf
c_func
(paren
id|line
comma
l_string|&quot;%&quot;
id|str
c_func
(paren
id|PATH_MAX
)paren
l_string|&quot;s %&quot;
id|str
c_func
(paren
id|PATH_MAX
)paren
l_string|&quot;s %o %d %d&quot;
comma
id|name
comma
id|target
comma
op_amp
id|mode
comma
op_amp
id|uid
comma
op_amp
id|gid
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Unrecognized dir format &squot;%s&squot;&quot;
comma
id|line
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|rc
op_assign
id|cpio_mkslink
c_func
(paren
id|name
comma
id|target
comma
id|mode
comma
id|uid
comma
id|gid
)paren
suffix:semicolon
id|fail
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|cpio_mkgeneric
r_static
r_int
id|cpio_mkgeneric
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_int
r_int
id|mode
comma
id|uid_t
id|uid
comma
id|gid_t
id|gid
)paren
(brace
r_char
id|s
(braket
l_int|256
)braket
suffix:semicolon
id|time_t
id|mtime
op_assign
id|time
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|s
comma
l_string|&quot;%s%08X%08X%08lX%08lX%08X%08lX&quot;
l_string|&quot;%08X%08X%08X%08X%08X%08X%08X&quot;
comma
l_string|&quot;070701&quot;
comma
multiline_comment|/* magic */
id|ino
op_increment
comma
multiline_comment|/* ino */
id|mode
comma
multiline_comment|/* mode */
(paren
r_int
)paren
id|uid
comma
multiline_comment|/* uid */
(paren
r_int
)paren
id|gid
comma
multiline_comment|/* gid */
l_int|2
comma
multiline_comment|/* nlink */
(paren
r_int
)paren
id|mtime
comma
multiline_comment|/* mtime */
l_int|0
comma
multiline_comment|/* filesize */
l_int|3
comma
multiline_comment|/* major */
l_int|1
comma
multiline_comment|/* minor */
l_int|0
comma
multiline_comment|/* rmajor */
l_int|0
comma
multiline_comment|/* rminor */
(paren
r_int
)paren
id|strlen
c_func
(paren
id|name
)paren
op_plus
l_int|1
comma
multiline_comment|/* namesize */
l_int|0
)paren
suffix:semicolon
multiline_comment|/* chksum */
id|push_hdr
c_func
(paren
id|s
)paren
suffix:semicolon
id|push_rest
c_func
(paren
id|name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|enum|generic_types
r_enum
id|generic_types
(brace
DECL|enumerator|GT_DIR
id|GT_DIR
comma
DECL|enumerator|GT_PIPE
id|GT_PIPE
comma
DECL|enumerator|GT_SOCK
id|GT_SOCK
)brace
suffix:semicolon
DECL|struct|generic_type
r_struct
id|generic_type
(brace
DECL|member|type
r_const
r_char
op_star
id|type
suffix:semicolon
DECL|member|mode
id|mode_t
id|mode
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|generic_type_table
r_static
r_struct
id|generic_type
id|generic_type_table
(braket
)braket
op_assign
(brace
(braket
id|GT_DIR
)braket
op_assign
(brace
dot
id|type
op_assign
l_string|&quot;dir&quot;
comma
dot
id|mode
op_assign
id|S_IFDIR
)brace
comma
(braket
id|GT_PIPE
)braket
op_assign
(brace
dot
id|type
op_assign
l_string|&quot;pipe&quot;
comma
dot
id|mode
op_assign
id|S_IFIFO
)brace
comma
(braket
id|GT_SOCK
)braket
op_assign
(brace
dot
id|type
op_assign
l_string|&quot;sock&quot;
comma
dot
id|mode
op_assign
id|S_IFSOCK
)brace
)brace
suffix:semicolon
DECL|function|cpio_mkgeneric_line
r_static
r_int
id|cpio_mkgeneric_line
c_func
(paren
r_const
r_char
op_star
id|line
comma
r_enum
id|generic_types
id|gt
)paren
(brace
r_char
id|name
(braket
id|PATH_MAX
op_plus
l_int|1
)braket
suffix:semicolon
r_int
r_int
id|mode
suffix:semicolon
r_int
id|uid
suffix:semicolon
r_int
id|gid
suffix:semicolon
r_int
id|rc
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
l_int|4
op_ne
id|sscanf
c_func
(paren
id|line
comma
l_string|&quot;%&quot;
id|str
c_func
(paren
id|PATH_MAX
)paren
l_string|&quot;s %o %d %d&quot;
comma
id|name
comma
op_amp
id|mode
comma
op_amp
id|uid
comma
op_amp
id|gid
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Unrecognized %s format &squot;%s&squot;&quot;
comma
id|line
comma
id|generic_type_table
(braket
id|gt
)braket
dot
id|type
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|mode
op_or_assign
id|generic_type_table
(braket
id|gt
)braket
dot
id|mode
suffix:semicolon
id|rc
op_assign
id|cpio_mkgeneric
c_func
(paren
id|name
comma
id|mode
comma
id|uid
comma
id|gid
)paren
suffix:semicolon
id|fail
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|cpio_mkdir_line
r_static
r_int
id|cpio_mkdir_line
c_func
(paren
r_const
r_char
op_star
id|line
)paren
(brace
r_return
id|cpio_mkgeneric_line
c_func
(paren
id|line
comma
id|GT_DIR
)paren
suffix:semicolon
)brace
DECL|function|cpio_mkpipe_line
r_static
r_int
id|cpio_mkpipe_line
c_func
(paren
r_const
r_char
op_star
id|line
)paren
(brace
r_return
id|cpio_mkgeneric_line
c_func
(paren
id|line
comma
id|GT_PIPE
)paren
suffix:semicolon
)brace
DECL|function|cpio_mksock_line
r_static
r_int
id|cpio_mksock_line
c_func
(paren
r_const
r_char
op_star
id|line
)paren
(brace
r_return
id|cpio_mkgeneric_line
c_func
(paren
id|line
comma
id|GT_SOCK
)paren
suffix:semicolon
)brace
DECL|function|cpio_mknod
r_static
r_int
id|cpio_mknod
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_int
r_int
id|mode
comma
id|uid_t
id|uid
comma
id|gid_t
id|gid
comma
r_char
id|dev_type
comma
r_int
r_int
id|maj
comma
r_int
r_int
id|min
)paren
(brace
r_char
id|s
(braket
l_int|256
)braket
suffix:semicolon
id|time_t
id|mtime
op_assign
id|time
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_type
op_eq
l_char|&squot;b&squot;
)paren
id|mode
op_or_assign
id|S_IFBLK
suffix:semicolon
r_else
id|mode
op_or_assign
id|S_IFCHR
suffix:semicolon
id|sprintf
c_func
(paren
id|s
comma
l_string|&quot;%s%08X%08X%08lX%08lX%08X%08lX&quot;
l_string|&quot;%08X%08X%08X%08X%08X%08X%08X&quot;
comma
l_string|&quot;070701&quot;
comma
multiline_comment|/* magic */
id|ino
op_increment
comma
multiline_comment|/* ino */
id|mode
comma
multiline_comment|/* mode */
(paren
r_int
)paren
id|uid
comma
multiline_comment|/* uid */
(paren
r_int
)paren
id|gid
comma
multiline_comment|/* gid */
l_int|1
comma
multiline_comment|/* nlink */
(paren
r_int
)paren
id|mtime
comma
multiline_comment|/* mtime */
l_int|0
comma
multiline_comment|/* filesize */
l_int|3
comma
multiline_comment|/* major */
l_int|1
comma
multiline_comment|/* minor */
id|maj
comma
multiline_comment|/* rmajor */
id|min
comma
multiline_comment|/* rminor */
(paren
r_int
)paren
id|strlen
c_func
(paren
id|name
)paren
op_plus
l_int|1
comma
multiline_comment|/* namesize */
l_int|0
)paren
suffix:semicolon
multiline_comment|/* chksum */
id|push_hdr
c_func
(paren
id|s
)paren
suffix:semicolon
id|push_rest
c_func
(paren
id|name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cpio_mknod_line
r_static
r_int
id|cpio_mknod_line
c_func
(paren
r_const
r_char
op_star
id|line
)paren
(brace
r_char
id|name
(braket
id|PATH_MAX
op_plus
l_int|1
)braket
suffix:semicolon
r_int
r_int
id|mode
suffix:semicolon
r_int
id|uid
suffix:semicolon
r_int
id|gid
suffix:semicolon
r_char
id|dev_type
suffix:semicolon
r_int
r_int
id|maj
suffix:semicolon
r_int
r_int
id|min
suffix:semicolon
r_int
id|rc
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
l_int|7
op_ne
id|sscanf
c_func
(paren
id|line
comma
l_string|&quot;%&quot;
id|str
c_func
(paren
id|PATH_MAX
)paren
l_string|&quot;s %o %d %d %c %u %u&quot;
comma
id|name
comma
op_amp
id|mode
comma
op_amp
id|uid
comma
op_amp
id|gid
comma
op_amp
id|dev_type
comma
op_amp
id|maj
comma
op_amp
id|min
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Unrecognized nod format &squot;%s&squot;&quot;
comma
id|line
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|rc
op_assign
id|cpio_mknod
c_func
(paren
id|name
comma
id|mode
comma
id|uid
comma
id|gid
comma
id|dev_type
comma
id|maj
comma
id|min
)paren
suffix:semicolon
id|fail
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Not marked static to keep the compiler quiet, as no one uses this yet... */
DECL|function|cpio_mkfile
r_static
r_int
id|cpio_mkfile
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_const
r_char
op_star
id|location
comma
r_int
r_int
id|mode
comma
id|uid_t
id|uid
comma
id|gid_t
id|gid
)paren
(brace
r_char
id|s
(braket
l_int|256
)braket
suffix:semicolon
r_char
op_star
id|filebuf
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|stat
id|buf
suffix:semicolon
r_int
id|file
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_int
id|rc
op_assign
op_minus
l_int|1
suffix:semicolon
id|mode
op_or_assign
id|S_IFREG
suffix:semicolon
id|retval
op_assign
id|stat
(paren
id|location
comma
op_amp
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|fprintf
(paren
id|stderr
comma
l_string|&quot;File %s could not be located&bslash;n&quot;
comma
id|location
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|file
op_assign
id|open
(paren
id|location
comma
id|O_RDONLY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file
OL
l_int|0
)paren
(brace
id|fprintf
(paren
id|stderr
comma
l_string|&quot;File %s could not be opened for reading&bslash;n&quot;
comma
id|location
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|filebuf
op_assign
id|malloc
c_func
(paren
id|buf.st_size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|filebuf
)paren
(brace
id|fprintf
(paren
id|stderr
comma
l_string|&quot;out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|retval
op_assign
id|read
(paren
id|file
comma
id|filebuf
comma
id|buf.st_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|fprintf
(paren
id|stderr
comma
l_string|&quot;Can not read %s file&bslash;n&quot;
comma
id|location
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|s
comma
l_string|&quot;%s%08X%08X%08lX%08lX%08X%08lX&quot;
l_string|&quot;%08X%08X%08X%08X%08X%08X%08X&quot;
comma
l_string|&quot;070701&quot;
comma
multiline_comment|/* magic */
id|ino
op_increment
comma
multiline_comment|/* ino */
id|mode
comma
multiline_comment|/* mode */
(paren
r_int
)paren
id|uid
comma
multiline_comment|/* uid */
(paren
r_int
)paren
id|gid
comma
multiline_comment|/* gid */
l_int|1
comma
multiline_comment|/* nlink */
(paren
r_int
)paren
id|buf.st_mtime
comma
multiline_comment|/* mtime */
(paren
r_int
)paren
id|buf.st_size
comma
multiline_comment|/* filesize */
l_int|3
comma
multiline_comment|/* major */
l_int|1
comma
multiline_comment|/* minor */
l_int|0
comma
multiline_comment|/* rmajor */
l_int|0
comma
multiline_comment|/* rminor */
(paren
r_int
)paren
id|strlen
c_func
(paren
id|name
)paren
op_plus
l_int|1
comma
multiline_comment|/* namesize */
l_int|0
)paren
suffix:semicolon
multiline_comment|/* chksum */
id|push_hdr
c_func
(paren
id|s
)paren
suffix:semicolon
id|push_string
c_func
(paren
id|name
)paren
suffix:semicolon
id|push_pad
c_func
(paren
)paren
suffix:semicolon
id|fwrite
c_func
(paren
id|filebuf
comma
id|buf.st_size
comma
l_int|1
comma
id|stdout
)paren
suffix:semicolon
id|offset
op_add_assign
id|buf.st_size
suffix:semicolon
id|push_pad
c_func
(paren
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
id|error
suffix:colon
r_if
c_cond
(paren
id|filebuf
)paren
id|free
c_func
(paren
id|filebuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file
op_ge
l_int|0
)paren
id|close
c_func
(paren
id|file
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|cpio_mkfile_line
r_static
r_int
id|cpio_mkfile_line
c_func
(paren
r_const
r_char
op_star
id|line
)paren
(brace
r_char
id|name
(braket
id|PATH_MAX
op_plus
l_int|1
)braket
suffix:semicolon
r_char
id|location
(braket
id|PATH_MAX
op_plus
l_int|1
)braket
suffix:semicolon
r_int
r_int
id|mode
suffix:semicolon
r_int
id|uid
suffix:semicolon
r_int
id|gid
suffix:semicolon
r_int
id|rc
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
l_int|5
op_ne
id|sscanf
c_func
(paren
id|line
comma
l_string|&quot;%&quot;
id|str
c_func
(paren
id|PATH_MAX
)paren
l_string|&quot;s %&quot;
id|str
c_func
(paren
id|PATH_MAX
)paren
l_string|&quot;s %o %d %d&quot;
comma
id|name
comma
id|location
comma
op_amp
id|mode
comma
op_amp
id|uid
comma
op_amp
id|gid
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Unrecognized file format &squot;%s&squot;&quot;
comma
id|line
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|rc
op_assign
id|cpio_mkfile
c_func
(paren
id|name
comma
id|location
comma
id|mode
comma
id|uid
comma
id|gid
)paren
suffix:semicolon
id|fail
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|usage
r_void
id|usage
c_func
(paren
r_const
r_char
op_star
id|prog
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Usage:&bslash;n&quot;
l_string|&quot;&bslash;t%s &lt;cpio_list&gt;&bslash;n&quot;
l_string|&quot;&bslash;n&quot;
l_string|&quot;&lt;cpio_list&gt; is a file containing newline separated entries that&bslash;n&quot;
l_string|&quot;describe the files to be included in the initramfs archive:&bslash;n&quot;
l_string|&quot;&bslash;n&quot;
l_string|&quot;# a comment&bslash;n&quot;
l_string|&quot;file &lt;name&gt; &lt;location&gt; &lt;mode&gt; &lt;uid&gt; &lt;gid&gt;&bslash;n&quot;
l_string|&quot;dir &lt;name&gt; &lt;mode&gt; &lt;uid&gt; &lt;gid&gt;&bslash;n&quot;
l_string|&quot;nod &lt;name&gt; &lt;mode&gt; &lt;uid&gt; &lt;gid&gt; &lt;dev_type&gt; &lt;maj&gt; &lt;min&gt;&bslash;n&quot;
l_string|&quot;slink &lt;name&gt; &lt;target&gt; &lt;mode&gt; &lt;uid&gt; &lt;gid&gt;&bslash;n&quot;
l_string|&quot;pipe &lt;name&gt; &lt;mode&gt; &lt;uid&gt; &lt;gid&gt;&bslash;n&quot;
l_string|&quot;sock &lt;name&gt; &lt;mode&gt; &lt;uid&gt; &lt;gid&gt;&bslash;n&quot;
l_string|&quot;&bslash;n&quot;
l_string|&quot;&lt;name&gt;      name of the file/dir/nod/etc in the archive&bslash;n&quot;
l_string|&quot;&lt;location&gt;  location of the file in the current filesystem&bslash;n&quot;
l_string|&quot;&lt;target&gt;    link target&bslash;n&quot;
l_string|&quot;&lt;mode&gt;      mode/permissions of the file&bslash;n&quot;
l_string|&quot;&lt;uid&gt;       user id (0=root)&bslash;n&quot;
l_string|&quot;&lt;gid&gt;       group id (0=root)&bslash;n&quot;
l_string|&quot;&lt;dev_type&gt;  device type (b=block, c=character)&bslash;n&quot;
l_string|&quot;&lt;maj&gt;       major number of nod&bslash;n&quot;
l_string|&quot;&lt;min&gt;       minor number of nod&bslash;n&quot;
l_string|&quot;&bslash;n&quot;
l_string|&quot;example:&bslash;n&quot;
l_string|&quot;# A simple initramfs&bslash;n&quot;
l_string|&quot;dir /dev 0755 0 0&bslash;n&quot;
l_string|&quot;nod /dev/console 0600 0 0 c 5 1&bslash;n&quot;
l_string|&quot;dir /root 0700 0 0&bslash;n&quot;
l_string|&quot;dir /sbin 0755 0 0&bslash;n&quot;
l_string|&quot;file /sbin/kinit /usr/src/klibc/kinit/kinit 0755 0 0&bslash;n&quot;
comma
id|prog
)paren
suffix:semicolon
)brace
DECL|variable|file_handler_table
r_struct
id|file_handler
id|file_handler_table
(braket
)braket
op_assign
(brace
(brace
dot
id|type
op_assign
l_string|&quot;file&quot;
comma
dot
id|handler
op_assign
id|cpio_mkfile_line
comma
)brace
comma
(brace
dot
id|type
op_assign
l_string|&quot;nod&quot;
comma
dot
id|handler
op_assign
id|cpio_mknod_line
comma
)brace
comma
(brace
dot
id|type
op_assign
l_string|&quot;dir&quot;
comma
dot
id|handler
op_assign
id|cpio_mkdir_line
comma
)brace
comma
(brace
dot
id|type
op_assign
l_string|&quot;slink&quot;
comma
dot
id|handler
op_assign
id|cpio_mkslink_line
comma
)brace
comma
(brace
dot
id|type
op_assign
l_string|&quot;pipe&quot;
comma
dot
id|handler
op_assign
id|cpio_mkpipe_line
comma
)brace
comma
(brace
dot
id|type
op_assign
l_string|&quot;sock&quot;
comma
dot
id|handler
op_assign
id|cpio_mksock_line
comma
)brace
comma
(brace
dot
id|type
op_assign
l_int|NULL
comma
dot
id|handler
op_assign
l_int|NULL
comma
)brace
)brace
suffix:semicolon
DECL|macro|LINE_SIZE
mdefine_line|#define LINE_SIZE (2 * PATH_MAX + 50)
DECL|function|main
r_int
id|main
(paren
r_int
id|argc
comma
r_char
op_star
id|argv
(braket
)braket
)paren
(brace
id|FILE
op_star
id|cpio_list
suffix:semicolon
r_char
id|line
(braket
id|LINE_SIZE
)braket
suffix:semicolon
r_char
op_star
id|args
comma
op_star
id|type
suffix:semicolon
r_int
id|ec
op_assign
l_int|0
suffix:semicolon
r_int
id|line_nr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
l_int|2
op_ne
id|argc
)paren
(brace
id|usage
c_func
(paren
id|argv
(braket
l_int|0
)braket
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|cpio_list
op_assign
id|fopen
c_func
(paren
id|argv
(braket
l_int|1
)braket
comma
l_string|&quot;r&quot;
)paren
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;ERROR: unable to open &squot;%s&squot;: %s&bslash;n&bslash;n&quot;
comma
id|argv
(braket
l_int|1
)braket
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
id|usage
c_func
(paren
id|argv
(braket
l_int|0
)braket
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|fgets
c_func
(paren
id|line
comma
id|LINE_SIZE
comma
id|cpio_list
)paren
)paren
(brace
r_int
id|type_idx
suffix:semicolon
r_int
id|slen
op_assign
id|strlen
c_func
(paren
id|line
)paren
suffix:semicolon
id|line_nr
op_increment
suffix:semicolon
r_if
c_cond
(paren
l_char|&squot;#&squot;
op_eq
op_star
id|line
)paren
(brace
multiline_comment|/* comment - skip to next line */
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|type
op_assign
id|strtok
c_func
(paren
id|line
comma
l_string|&quot; &bslash;t&quot;
)paren
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;ERROR: incorrect format, could not locate file type line %d: &squot;%s&squot;&bslash;n&quot;
comma
id|line_nr
comma
id|line
)paren
suffix:semicolon
id|ec
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
l_char|&squot;&bslash;n&squot;
op_eq
op_star
id|type
)paren
(brace
multiline_comment|/* a blank line */
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slen
op_eq
id|strlen
c_func
(paren
id|type
)paren
)paren
(brace
multiline_comment|/* must be an empty line */
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|args
op_assign
id|strtok
c_func
(paren
l_int|NULL
comma
l_string|&quot;&bslash;n&quot;
)paren
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;ERROR: incorrect format, newline required line %d: &squot;%s&squot;&bslash;n&quot;
comma
id|line_nr
comma
id|line
)paren
suffix:semicolon
id|ec
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|type_idx
op_assign
l_int|0
suffix:semicolon
id|file_handler_table
(braket
id|type_idx
)braket
dot
id|type
suffix:semicolon
id|type_idx
op_increment
)paren
(brace
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|line
comma
id|file_handler_table
(braket
id|type_idx
)braket
dot
id|type
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|file_handler_table
(braket
id|type_idx
)braket
dot
id|handler
c_func
(paren
id|args
)paren
)paren
)paren
(brace
id|ec
op_assign
id|rc
suffix:semicolon
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot; line %d&bslash;n&quot;
comma
id|line_nr
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
l_int|NULL
op_eq
id|file_handler_table
(braket
id|type_idx
)braket
dot
id|type
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;unknown file type line %d: &squot;%s&squot;&bslash;n&quot;
comma
id|line_nr
comma
id|line
)paren
suffix:semicolon
)brace
)brace
id|cpio_trailer
c_func
(paren
)paren
suffix:semicolon
m_exit
(paren
id|ec
)paren
suffix:semicolon
)brace
eof
